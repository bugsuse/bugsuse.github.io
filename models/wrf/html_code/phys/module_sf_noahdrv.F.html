<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_NOAHDRV'><A href='../../html_code/phys/module_sf_noahdrv.F.html#MODULE_SF_NOAHDRV' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_noahdrv</font> <A href='../../call_to/MODULE_SF_NOAHDRV.html' TARGET='index'>2</A><a name='3'>
<a name='4'>
<font color=#447700>!-------------------------------<a name='5'></font>
  USE <A href='../../html_code/phys/module_sf_noahlsm.F.html#MODULE_SF_NOAHLSM'>module_sf_noahlsm</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#module_sf_noahdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHLSM_4">,  only: SFLX, XLF, XLV, CP, R_D, RHOWATER, NATURAL, SHDTBL, LUTYPE, SLTYPE, STBOLT, &amp;<a name='6'>
      &amp;                         KARMAN, LUCATS, NROTBL, RSTBL, RGLTBL, HSTBL, SNUPTBL, MAXALB, LAIMINTBL,   &amp;<a name='7'>
      &amp;                         LAIMAXTBL, Z0MINTBL, Z0MAXTBL, ALBEDOMINTBL, ALBEDOMAXTBL, EMISSMINTBL,     &amp;<a name='8'>
      &amp;                         EMISSMAXTBL, TOPT_DATA, CMCMAX_DATA, CFACTR_DATA, RSMAX_DATA, BARE, NLUS,   &amp;<a name='9'>
      &amp;                         SLCATS, BB, DRYSMC, F11, MAXSMC, REFSMC, SATPSI, SATDK, SATDW, WLTSMC, QTZ, &amp;<a name='10'>
      &amp;                         NSLTYPE, SLPCATS, SLOPE_DATA, SBETA_DATA, FXEXP_DATA, CSOIL_DATA,           &amp;<a name='11'>
      &amp;                         SALP_DATA, REFDK_DATA, REFKDT_DATA, FRZK_DATA, ZBOT_DATA, CZIL_DATA,        &amp;<a name='12'>
      &amp;                         SMLOW_DATA, SMHIGH_DATA, LVCOEF_DATA, NSLOPE, &amp;<a name='13'>
      &amp;                         FRH2O,ZTOPVTBL,ZBOTVTBL, &amp;<a name='14'>
      &amp;                         LOW_DENSITY_RESIDENTIAL, HIGH_DENSITY_RESIDENTIAL, HIGH_INTENSITY_INDUSTRIAL<a name='15'>
<a name='16'>
  USE <A href='../../html_code/phys/module_sf_urban.F.html#MODULE_SF_URBAN'>module_sf_urban</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#module_sf_noahdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_URBAN_5">,    only: urban, oasis, IRI_SCHEME<a name='17'>
  USE <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#MODULE_SF_NOAHLSM_GLACIAL_ONLY'>module_sf_noahlsm_glacial_only</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#module_sf_noahdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHLSM_GLACIAL_ONLY_1">, only: sflx_glacial<a name='18'>
  USE <A href='../../html_code/phys/module_sf_bep.F.html#MODULE_SF_BEP'>module_sf_bep</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#module_sf_noahdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_BEP_2">,      only: bep<a name='19'>
  USE <A href='../../html_code/phys/module_sf_bep_bem.F.html#MODULE_SF_BEP_BEM'>module_sf_bep_bem</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#module_sf_noahdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_BEP_BEM_2">,  only: bep_bem<a name='20'>
  USE <A href='../../html_code/phys/module_ra_gfdleta.F.html#MODULE_RA_GFDLETA'>module_ra_gfdleta</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#module_sf_noahdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_GFDLETA_6">,  only: cal_mon_day<a name='21'>
#if ( WRF_CHEM == 1 )<a name='22'>
  USE <A href='../../html_code/phys/module_data_gocart_dust.F.html#MODULE_DATA_GOCART_DUST'>module_data_gocart_dust</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#module_sf_noahdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATA_GOCART_DUST_1"><a name='23'>
#endif<a name='24'>
<font color=#447700>!-------------------------------<a name='25'></font>
<a name='26'>
<font color=#447700>!<a name='27'></font>
CONTAINS<a name='28'>
<font color=#447700>!<a name='29'></font>
<font color=#447700>!----------------------------------------------------------------<a name='30'></font>
<font color=#447700>! Urban related variable are added to arguments - urban<a name='31'></font>
<font color=#447700>!----------------------------------------------------------------<a name='32'></font>
<A NAME='LSM'><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='33'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>lsm</font>(DZ8W,QV3D,P8W3D,T3D,TSK,                      &amp; <A href='../../call_to/LSM.html' TARGET='index'>1</A>,<A href='../../call_from/LSM.html' TARGET='index'>9</A><a name='34'>
                  HFX,QFX,LH,GRDFLX, QGH,GSW,SWDOWN,GLW,SMSTAV,SMSTOT, &amp;<a name='35'>
                  SFCRUNOFF, UDRUNOFF,IVGTYP,ISLTYP,ISURBAN,ISICE,VEGFRA,    &amp;<a name='36'>
                  ALBEDO,ALBBCK,ZNT,Z0,TMN,XLAND,XICE,EMISS,EMBCK,   &amp;<a name='37'>
                  SNOWC,QSFC,RAINBL,MMINLU,                     &amp;<a name='38'>
                  num_soil_layers,DT,DZS,ITIMESTEP,             &amp;<a name='39'>
                  SMOIS,TSLB,SNOW,CANWAT,                       &amp;<a name='40'>
                  CHS,CHS2,CQS2,CPM,ROVCP,SR,chklowq,lai,qz0,   &amp; <font color=#447700>!H<a name='41'></font>
                  myj,frpcpn,                                   &amp;<a name='42'>
                  SH2O,SNOWH,                                   &amp; <font color=#447700>!H<a name='43'></font>
                  U_PHY,V_PHY,                                  &amp; <font color=#447700>!I<a name='44'></font>
                  SNOALB,SHDMIN,SHDMAX,                         &amp; <font color=#447700>!I<a name='45'></font>
                  SNOTIME,                                      &amp; <font color=#447700>!?<a name='46'></font>
                  ACSNOM,ACSNOW,                                &amp; <font color=#447700>!O<a name='47'></font>
                  SNOPCX,                                       &amp; <font color=#447700>!O<a name='48'></font>
                  POTEVP,                                       &amp; <font color=#447700>!O<a name='49'></font>
                  SMCREL,                                       &amp; <font color=#447700>!O<a name='50'></font>
                  XICE_THRESHOLD,                               &amp;<a name='51'>
                  RDLAI2D,USEMONALB,                            &amp;<a name='52'>
                  RIB,                                          &amp; <font color=#447700>!?<a name='53'></font>
                  NOAHRES,opt_thcnd,                            &amp;<a name='54'>
<font color=#447700>! Noah UA changes<a name='55'></font>
                  ua_phys,flx4_2d,fvb_2d,fbur_2d,fgsn_2d,       &amp;<a name='56'>
                  ids,ide, jds,jde, kds,kde,                    &amp;<a name='57'>
                  ims,ime, jms,jme, kms,kme,                    &amp;<a name='58'>
                  its,ite, jts,jte, kts,kte,                    &amp;<a name='59'>
                  sf_urban_physics,                             &amp;<a name='60'>
                  CMR_SFCDIF,CHR_SFCDIF,CMC_SFCDIF,CHC_SFCDIF,  &amp;<a name='61'>
                  CMGR_SFCDIF,CHGR_SFCDIF,                      &amp;<a name='62'>
<font color=#447700>!Optional Urban<a name='63'></font>
                  TR_URB2D,TB_URB2D,TG_URB2D,TC_URB2D,QC_URB2D, &amp; <font color=#447700>!H urban<a name='64'></font>
                  UC_URB2D,                                     &amp; <font color=#447700>!H urban<a name='65'></font>
                  XXXR_URB2D,XXXB_URB2D,XXXG_URB2D,XXXC_URB2D,  &amp; <font color=#447700>!H urban<a name='66'></font>
                  TRL_URB3D,TBL_URB3D,TGL_URB3D,                &amp; <font color=#447700>!H urban<a name='67'></font>
                  SH_URB2D,LH_URB2D,G_URB2D,RN_URB2D,TS_URB2D,  &amp; <font color=#447700>!H urban<a name='68'></font>
                  PSIM_URB2D,PSIH_URB2D,U10_URB2D,V10_URB2D,    &amp; <font color=#447700>!O urban<a name='69'></font>
                  GZ1OZ0_URB2D,  AKMS_URB2D,                    &amp; <font color=#447700>!O urban<a name='70'></font>
                  TH2_URB2D,Q2_URB2D, UST_URB2D,                &amp; <font color=#447700>!O urban<a name='71'></font>
                  DECLIN_URB,COSZ_URB2D,OMG_URB2D,              &amp; <font color=#447700>!I urban<a name='72'></font>
                  XLAT_URB2D,                                   &amp; <font color=#447700>!I urban<a name='73'></font>
                  num_roof_layers, num_wall_layers,             &amp; <font color=#447700>!I urban<a name='74'></font>
                  num_road_layers, DZR, DZB, DZG,               &amp; <font color=#447700>!I urban<a name='75'></font>
                  CMCR_URB2D,TGR_URB2D,TGRL_URB3D,SMR_URB3D,    &amp; <font color=#447700>!H urban<a name='76'></font>
                  DRELR_URB2D,DRELB_URB2D,DRELG_URB2D,          &amp; <font color=#447700>!H urban<a name='77'></font>
                  FLXHUMR_URB2D,FLXHUMB_URB2D,FLXHUMG_URB2D,    &amp; <font color=#447700>!H urban<a name='78'></font>
                  julian, julyr,                                &amp; <font color=#447700>!H urban<a name='79'></font>
                  FRC_URB2D,UTYPE_URB2D,                        &amp; <font color=#447700>!O<a name='80'></font>
                  num_urban_layers,                             &amp; <font color=#447700>!I multi-layer urban<a name='81'></font>
                  num_urban_hi,                                 &amp; <font color=#447700>!I multi-layer urban<a name='82'></font>
                  trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,      &amp; <font color=#447700>!H multi-layer urban<a name='83'></font>
                  tlev_urb3d,qlev_urb3d,                        &amp; <font color=#447700>!H multi-layer urban<a name='84'></font>
                  tw1lev_urb3d,tw2lev_urb3d,                    &amp; <font color=#447700>!H multi-layer urban<a name='85'></font>
                  tglev_urb3d,tflev_urb3d,                      &amp; <font color=#447700>!H multi-layer urban<a name='86'></font>
                  sf_ac_urb3d,lf_ac_urb3d,cm_ac_urb3d,          &amp; <font color=#447700>!H multi-layer urban<a name='87'></font>
                  sfvent_urb3d,lfvent_urb3d,                    &amp; <font color=#447700>!H multi-layer urban<a name='88'></font>
                  sfwin1_urb3d,sfwin2_urb3d,                    &amp; <font color=#447700>!H multi-layer urban<a name='89'></font>
                  sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,    &amp; <font color=#447700>!H multi-layer urban<a name='90'></font>
                  lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,         &amp; <font color=#447700>!H multi-layer urban<a name='91'></font>
                  mh_urb2d,stdh_urb2d,lf_urb2d,                 &amp; <font color=#447700>!SLUCM<a name='92'></font>
                  th_phy,rho,p_phy,ust,                         &amp; <font color=#447700>!I multi-layer urban<a name='93'></font>
                  gmt,julday,xlong,xlat,                        &amp; <font color=#447700>!I multi-layer urban<a name='94'></font>
                  a_u_bep,a_v_bep,a_t_bep,a_q_bep,              &amp; <font color=#447700>!O multi-layer urban<a name='95'></font>
                  a_e_bep,b_u_bep,b_v_bep,                      &amp; <font color=#447700>!O multi-layer urban<a name='96'></font>
                  b_t_bep,b_q_bep,b_e_bep,dlg_bep,              &amp; <font color=#447700>!O multi-layer urban<a name='97'></font>
                  dl_u_bep,sf_bep,vl_bep,sfcheadrt,INFXSRT, soldrain      &amp;   <font color=#447700>!O multi-layer urban         <a name='98'></font>
                 ,SDA_HFX, SDA_QFX, HFX_BOTH, QFX_BOTH, QNORM, fasdas     &amp;   <font color=#447700>!fasdas<a name='99'></font>
                  )   <font color=#447700>!O multi-layer urban         <a name='100'></font>
<a name='101'>
<font color=#447700>!----------------------------------------------------------------<a name='102'></font>
    IMPLICIT NONE<a name='103'>
<font color=#447700>!----------------------------------------------------------------<a name='104'></font>
<font color=#447700>!----------------------------------------------------------------<a name='105'></font>
<font color=#447700>! --- atmospheric (WRF generic) variables<a name='106'></font>
<font color=#447700>!-- DT          time step (seconds)<a name='107'></font>
<font color=#447700>!-- DZ8W        thickness of layers (m)<a name='108'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='109'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='110'></font>
<font color=#447700>!-- P3D         3D pressure (Pa)<a name='111'></font>
<font color=#447700>!-- FLHC        exchange coefficient for heat (m/s)<a name='112'></font>
<font color=#447700>!-- FLQC        exchange coefficient for moisture (m/s)<a name='113'></font>
<font color=#447700>!-- PSFC        surface pressure (Pa)<a name='114'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='115'></font>
<font color=#447700>!-- QGH         saturated mixing ratio at 2 meter<a name='116'></font>
<font color=#447700>!-- GSW         downward short wave flux at ground surface (W/m^2)<a name='117'></font>
<font color=#447700>!-- GLW         downward long wave flux at ground surface (W/m^2)<a name='118'></font>
<font color=#447700>!-- History variables<a name='119'></font>
<font color=#447700>!-- CANWAT      canopy moisture content (mm)<a name='120'></font>
<font color=#447700>!-- TSK         surface temperature (K)<a name='121'></font>
<font color=#447700>!-- TSLB        soil temp (k)<a name='122'></font>
<font color=#447700>!-- SMOIS       total soil moisture content (volumetric fraction)<a name='123'></font>
<font color=#447700>!-- SH2O        unfrozen soil moisture content (volumetric fraction)<a name='124'></font>
<font color=#447700>!                note: frozen soil moisture (i.e., soil ice) = SMOIS - SH2O<a name='125'></font>
<font color=#447700>!-- SNOWH       actual snow depth (m)<a name='126'></font>
<font color=#447700>!-- SNOW        liquid water-equivalent snow depth (m)<a name='127'></font>
<font color=#447700>!-- ALBEDO      time-varying surface albedo including snow effect (unitless fraction)<a name='128'></font>
<font color=#447700>!-- ALBBCK      background surface albedo (unitless fraction)<a name='129'></font>
<font color=#447700>!-- CHS          surface exchange coefficient for heat and moisture (m s-1);<a name='130'></font>
<font color=#447700>!-- CHS2        2m surface exchange coefficient for heat  (m s-1);<a name='131'></font>
<font color=#447700>!-- CQS2        2m surface exchange coefficient for moisture (m s-1);<a name='132'></font>
<font color=#447700>! --- soil variables<a name='133'></font>
<font color=#447700>!-- num_soil_layers   the number of soil layers<a name='134'></font>
<font color=#447700>!-- ZS          depths of centers of soil layers   (m)<a name='135'></font>
<font color=#447700>!-- DZS         thicknesses of soil layers (m)<a name='136'></font>
<font color=#447700>!-- SLDPTH      thickness of each soil layer (m, same as DZS)<a name='137'></font>
<font color=#447700>!-- TMN         soil temperature at lower boundary (K)<a name='138'></font>
<font color=#447700>!-- SMCWLT      wilting point (volumetric)<a name='139'></font>
<font color=#447700>!-- SMCDRY      dry soil moisture threshold where direct evap from<a name='140'></font>
<font color=#447700>!               top soil layer ends (volumetric)<a name='141'></font>
<font color=#447700>!-- SMCREF      soil moisture threshold below which transpiration begins to<a name='142'></font>
<font color=#447700>!                   stress (volumetric)<a name='143'></font>
<font color=#447700>!-- SMCMAX      porosity, i.e. saturated value of soil moisture (volumetric)<a name='144'></font>
<font color=#447700>!-- NROOT       number of root layers, a function of veg type, determined<a name='145'></font>
<font color=#447700>!               in subroutine redprm.<a name='146'></font>
<font color=#447700>!-- SMSTAV      Soil moisture availability for evapotranspiration (<a name='147'></font>
<font color=#447700>!                   fraction between SMCWLT and SMCMXA)<a name='148'></font>
<font color=#447700>!-- SMSTOT      Total soil moisture content frozen+unfrozen) in the soil column (mm)<a name='149'></font>
<font color=#447700>! --- snow variables<a name='150'></font>
<font color=#447700>!-- SNOWC       fraction snow coverage (0-1.0)<a name='151'></font>
<font color=#447700>! --- vegetation variables<a name='152'></font>
<font color=#447700>!-- SNOALB      upper bound on maximum albedo over deep snow<a name='153'></font>
<font color=#447700>!-- SHDMIN      minimum areal fractional coverage of annual green vegetation<a name='154'></font>
<font color=#447700>!-- SHDMAX      maximum areal fractional coverage of annual green vegetation<a name='155'></font>
<font color=#447700>!-- XLAI        leaf area index (dimensionless)<a name='156'></font>
<font color=#447700>!-- Z0BRD       Background fixed roughness length (M)<a name='157'></font>
<font color=#447700>!-- Z0          Background vroughness length (M) as function<a name='158'></font>
<font color=#447700>!-- ZNT         Time varying roughness length (M) as function<a name='159'></font>
<font color=#447700>!-- ALBD(IVGTPK,ISN) background albedo reading from a table<a name='160'></font>
<font color=#447700>! --- LSM output<a name='161'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='162'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='163'></font>
<font color=#447700>!-- LH          upward moisture flux at the surface (W m-2)<a name='164'></font>
<font color=#447700>!-- GRDFLX(I,J) ground heat flux (W m-2)<a name='165'></font>
<font color=#447700>!-- FDOWN       radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN<a name='166'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='167'></font>
<font color=#447700>!-- EC          canopy water evaporation ((W m-2)<a name='168'></font>
<font color=#447700>!-- EDIR        direct soil evaporation (W m-2)<a name='169'></font>
<font color=#447700>!-- ET          plant transpiration from a particular root layer (W m-2)<a name='170'></font>
<font color=#447700>!-- ETT         total plant transpiration (W m-2)<a name='171'></font>
<font color=#447700>!-- ESNOW       sublimation from (or deposition to if &lt;0) snowpack (W m-2)<a name='172'></font>
<font color=#447700>!-- DRIP        through-fall of precip and/or dew in excess of canopy<a name='173'></font>
<font color=#447700>!                 water-holding capacity (m)<a name='174'></font>
<font color=#447700>!-- DEW         dewfall (or frostfall for t&lt;273.15) (M)<a name='175'></font>
<font color=#447700>!-- SMAV        Soil Moisture Availability for each layer, as a fraction<a name='176'></font>
<font color=#447700>!                 between SMCWLT and SMCMAX (dimensionless fraction)<a name='177'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='178'></font>
<font color=#447700>!-- BETA        ratio of actual/potential evap (dimensionless)<a name='179'></font>
<font color=#447700>!-- ETP         potential evaporation (W m-2)<a name='180'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='181'></font>
<font color=#447700>!-- FLX1        precip-snow sfc (W m-2)<a name='182'></font>
<font color=#447700>!-- FLX2        freezing rain latent heat flux (W m-2)<a name='183'></font>
<font color=#447700>!-- FLX3        phase-change heat flux from snowmelt (W m-2)<a name='184'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='185'></font>
<font color=#447700>!-- ACSNOM      snow melt (mm) (water equivalent)<a name='186'></font>
<font color=#447700>!-- ACSNOW      accumulated snow fall (mm) (water equivalent)<a name='187'></font>
<font color=#447700>!-- SNOPCX      snow phase change heat flux (W/m^2)<a name='188'></font>
<font color=#447700>!-- POTEVP      accumulated potential evaporation (m)<a name='189'></font>
<font color=#447700>!-- RIB         Documentation needed!!!<a name='190'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='191'></font>
<font color=#447700>!-- RUNOFF1     surface runoff (m s-1), not infiltrating the surface<a name='192'></font>
<font color=#447700>!-- RUNOFF2     subsurface runoff (m s-1), drainage out bottom of last<a name='193'></font>
<font color=#447700>!                  soil layer (baseflow)<a name='194'></font>
<font color=#447700>!  important note: here RUNOFF2 is actually the sum of RUNOFF2 and RUNOFF3<a name='195'></font>
<font color=#447700>!-- RUNOFF3     numerical trunctation in excess of porosity (smcmax)<a name='196'></font>
<font color=#447700>!                  for a given soil layer at the end of a time step (m s-1).<a name='197'></font>
<font color=#447700>!SFCRUNOFF     Surface Runoff (mm)<a name='198'></font>
<font color=#447700>!UDRUNOFF      Total Underground Runoff (mm), which is the sum of RUNOFF2 and RUNOFF3<a name='199'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='200'></font>
<font color=#447700>!-- RC          canopy resistance (s m-1)<a name='201'></font>
<font color=#447700>!-- PC          plant coefficient (unitless fraction, 0-1) where PC*ETP = actual transp<a name='202'></font>
<font color=#447700>!-- RSMIN       minimum canopy resistance (s m-1)<a name='203'></font>
<font color=#447700>!-- RCS         incoming solar rc factor (dimensionless)<a name='204'></font>
<font color=#447700>!-- RCT         air temperature rc factor (dimensionless)<a name='205'></font>
<font color=#447700>!-- RCQ         atmos vapor pressure deficit rc factor (dimensionless)<a name='206'></font>
<font color=#447700>!-- RCSOIL      soil moisture rc factor (dimensionless)<a name='207'></font>
<a name='208'>
<font color=#447700>!-- EMISS       surface emissivity (between 0 and 1)<a name='209'></font>
<font color=#447700>!-- EMBCK       Background surface emissivity (between 0 and 1)<a name='210'></font>
<a name='211'>
<font color=#447700>!-- ROVCP       R/CP<a name='212'></font>
<font color=#447700>!               (R_d/R_v) (dimensionless)<a name='213'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='214'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='215'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='216'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='217'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='218'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='219'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='220'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='221'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='222'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='223'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='224'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='225'></font>
<font color=#447700>!-- its         start index for i in tile<a name='226'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='227'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='228'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='229'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='230'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='231'></font>
<font color=#447700>!<a name='232'></font>
<font color=#447700>!-- SR          fraction of frozen precip (0.0 to 1.0)<a name='233'></font>
<font color=#447700>!----------------------------------------------------------------<a name='234'></font>
<a name='235'>
<font color=#447700>! IN only<a name='236'></font>
<a name='237'>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='238'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='239'>
                                    its,ite, jts,jte, kts,kte<a name='240'>
<a name='241'>
   INTEGER,  INTENT(IN   )   ::  sf_urban_physics               <font color=#447700>!urban<a name='242'></font>
   INTEGER,  INTENT(IN   )   ::  isurban<a name='243'>
   INTEGER,  INTENT(IN   )   ::  isice<a name='244'>
   INTEGER,  INTENT(IN   )   ::  julian, julyr                  <font color=#447700>!urban<a name='245'></font>
<a name='246'>
<font color=#447700>!added by Wei Yu  for routing<a name='247'></font>
    REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='248'>
             INTENT(INOUT)  :: sfcheadrt,INFXSRT,soldrain <a name='249'>
    real :: etpnd1<a name='250'>
<font color=#447700>!end added<a name='251'></font>
<a name='252'>
<a name='253'>
<a name='254'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='255'>
            INTENT(IN   )    ::                            TMN, &amp;<a name='256'>
                                                         XLAND, &amp;<a name='257'>
                                                          XICE, &amp;<a name='258'>
                                                        VEGFRA, &amp;<a name='259'>
                                                        SHDMIN, &amp;<a name='260'>
                                                        SHDMAX, &amp;<a name='261'>
                                                        SNOALB, &amp;<a name='262'>
                                                           GSW, &amp;<a name='263'>
                                                        SWDOWN, &amp; <font color=#447700>!added 10 jan 2007<a name='264'></font>
                                                           GLW, &amp;<a name='265'>
                                                        RAINBL, &amp;<a name='266'>
                                                        EMBCK,  &amp;<a name='267'>
                                                        SR<a name='268'>
<a name='269'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='270'>
            INTENT(INOUT)    ::                         ALBBCK, &amp;<a name='271'>
                                                            Z0<a name='272'>
   CHARACTER(LEN=*), INTENT(IN   )    ::                 MMINLU<a name='273'>
<a name='274'>
   REAL,    DIMENSION( ims:ime, kms:kme, jms:jme )            , &amp;<a name='275'>
            INTENT(IN   )    ::                           QV3D, &amp;<a name='276'>
                                                         p8w3D, &amp;<a name='277'>
                                                          DZ8W, &amp;<a name='278'>
                                                          T3D<a name='279'>
   REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='280'>
             INTENT(IN   )               ::               QGH,  &amp;<a name='281'>
                                                          CPM<a name='282'>
<a name='283'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='284'>
            INTENT(IN   )    ::                         IVGTYP, &amp;<a name='285'>
                                                        ISLTYP<a name='286'>
<a name='287'>
   INTEGER, INTENT(IN)       ::     num_soil_layers,ITIMESTEP<a name='288'>
<a name='289'>
   REAL,     INTENT(IN   )   ::     DT,ROVCP<a name='290'>
<a name='291'>
   REAL,     DIMENSION(1:num_soil_layers), INTENT(IN)::DZS<a name='292'>
<a name='293'>
<font color=#447700>! IN and OUT<a name='294'></font>
<a name='295'>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;<a name='296'>
             INTENT(INOUT)   ::                          SMOIS, &amp; <font color=#447700>! total soil moisture<a name='297'></font>
                                                         SH2O,  &amp; <font color=#447700>! new soil liquid<a name='298'></font>
                                                         TSLB     <font color=#447700>! TSLB     STEMP<a name='299'></font>
<a name='300'>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;<a name='301'>
             INTENT(OUT)     ::                         SMCREL<a name='302'>
<a name='303'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='304'>
            INTENT(INOUT)    ::                            TSK, &amp; <font color=#447700>!was TGB (temperature)<a name='305'></font>
                                                           HFX, &amp;<a name='306'>
                                                           QFX, &amp;<a name='307'>
                                                            LH, &amp;<a name='308'>
                                                        GRDFLX, &amp;<a name='309'>
                                                          QSFC,&amp;<a name='310'>
                                                          CQS2,&amp;<a name='311'>
                                                          CHS,   &amp;<a name='312'>
                                                          CHS2,&amp;<a name='313'>
                                                          SNOW, &amp;<a name='314'>
                                                         SNOWC, &amp;<a name='315'>
                                                         SNOWH, &amp; <font color=#447700>!new<a name='316'></font>
                                                        CANWAT, &amp;<a name='317'>
                                                        SMSTAV, &amp;<a name='318'>
                                                        SMSTOT, &amp;<a name='319'>
                                                     SFCRUNOFF, &amp;<a name='320'>
                                                      UDRUNOFF, &amp;<a name='321'>
                                                        ACSNOM, &amp;<a name='322'>
                                                        ACSNOW, &amp;<a name='323'>
                                                       SNOTIME, &amp;<a name='324'>
                                                        SNOPCX, &amp;<a name='325'>
                                                        EMISS,  &amp;<a name='326'>
                                                          RIB,  &amp;<a name='327'>
                                                        POTEVP, &amp;<a name='328'>
                                                        ALBEDO, &amp;<a name='329'>
                                                           ZNT<a name='330'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='331'>
            INTENT(OUT)      ::                         NOAHRES<a name='332'>
   INTEGER, INTENT(IN)       ::                         OPT_THCND<a name='333'>
<a name='334'>
<font color=#447700>! Noah UA changes<a name='335'></font>
   LOGICAL,                                INTENT(IN)  :: UA_PHYS<a name='336'>
   REAL,    DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: FLX4_2D,FVB_2D,FBUR_2D,FGSN_2D<a name='337'>
   REAL                                                :: FLX4,FVB,FBUR,FGSN<a name='338'>
<a name='339'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='340'>
               INTENT(OUT)    ::                        CHKLOWQ<a name='341'>
   REAL,    DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LAI<a name='342'>
   REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) ::        QZ0<a name='343'>
<a name='344'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMR_SFCDIF<a name='345'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHR_SFCDIF<a name='346'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMGR_SFCDIF<a name='347'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHGR_SFCDIF<a name='348'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMC_SFCDIF<a name='349'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHC_SFCDIF<a name='350'>
<font color=#447700>! Local variables (moved here from driver to make routine thread safe, 20031007 jm)<a name='351'></font>
<a name='352'>
      REAL, DIMENSION(1:num_soil_layers) ::  ET<a name='353'>
<a name='354'>
      REAL, DIMENSION(1:num_soil_layers) ::  SMAV<a name='355'>
<a name='356'>
      REAL  ::  BETA, ETP, SSOIL,EC, EDIR, ESNOW, ETT,        &amp;<a name='357'>
                FLX1,FLX2,FLX3, DRIP,DEW,FDOWN,RC,PC,RSMIN,XLAI,  &amp;<a name='358'>
<font color=#447700>!                RCS,RCT,RCQ,RCSOIL<a name='359'></font>
                RCS,RCT,RCQ,RCSOIL,FFROZP<a name='360'>
<a name='361'>
    LOGICAL,    INTENT(IN   )    ::     myj,frpcpn<a name='362'>
<a name='363'>
<font color=#447700>! DECLARATIONS - LOGICAL<a name='364'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='365'></font>
      LOGICAL, PARAMETER :: LOCAL=.false.<a name='366'>
      LOGICAL :: FRZGRA, SNOWNG<a name='367'>
<a name='368'>
      LOGICAL :: IPRINT<a name='369'>
<a name='370'>
<font color=#447700>! ----------------------------------------------------------------------<a name='371'></font>
<font color=#447700>! DECLARATIONS - INTEGER<a name='372'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='373'></font>
      INTEGER :: I,J, ICE,NSOIL,SLOPETYP,SOILTYP,VEGTYP<a name='374'>
      INTEGER :: NROOT<a name='375'>
      INTEGER :: KZ ,K<a name='376'>
      INTEGER :: NS<a name='377'>
<font color=#447700>! ----------------------------------------------------------------------<a name='378'></font>
<font color=#447700>! DECLARATIONS - REAL<a name='379'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='380'></font>
<a name='381'>
      REAL  :: SHMIN,SHMAX,DQSDT2,LWDN,PRCP,PRCPRAIN,                    &amp;<a name='382'>
               Q2SAT,Q2SATI,SFCPRS,SFCSPD,SFCTMP,SHDFAC,SNOALB1,         &amp;<a name='383'>
               SOLDN,TBOT,ZLVL, Q2K,ALBBRD, ALBEDOK, ETA, ETA_KINEMATIC, &amp;<a name='384'>
               EMBRD,                                                    &amp;<a name='385'>
               Z0K,RUNOFF1,RUNOFF2,RUNOFF3,SHEAT,SOLNET,E2SAT,SFCTSNO,   &amp;<a name='386'>
<font color=#447700>! mek, WRF testing, expanded diagnostics<a name='387'></font>
               SOLUP,LWUP,RNET,RES,Q1SFC,TAIRV,SATFLG<a name='388'>
<font color=#447700>! MEK MAY 2007<a name='389'></font>
      REAL ::  FDTLIW<a name='390'>
<font color=#447700>! MEK JUL2007 for pot. evap.<a name='391'></font>
      REAL :: RIBB<a name='392'>
      REAL ::  FDTW<a name='393'>
<a name='394'>
      REAL  :: EMISSI<a name='395'>
<a name='396'>
      REAL  :: SNCOVR,SNEQV,SNOWHK,CMC, CHK,TH2<a name='397'>
<a name='398'>
      REAL  :: SMCDRY,SMCMAX,SMCREF,SMCWLT,SNOMLT,SOILM,SOILW,Q1,T1<a name='399'>
      REAL  :: SNOTIME1    <font color=#447700>! LSTSNW1 INITIAL NUMBER OF TIMESTEPS SINCE LAST SNOWFALL<a name='400'></font>
<a name='401'>
      REAL  :: DUMMY,Z0BRD<a name='402'>
<font color=#447700>!<a name='403'></font>
      REAL  :: COSZ, SOLARDIRECT<a name='404'>
<font color=#447700>!<a name='405'></font>
      REAL, DIMENSION(1:num_soil_layers)::  SLDPTH, STC,SMC,SWC<a name='406'>
<font color=#447700>!<a name='407'></font>
      REAL, DIMENSION(1:num_soil_layers) ::     ZSOIL, RTDIS<a name='408'>
      REAL, PARAMETER  :: TRESH=.95E0, A2=17.67,A3=273.15,A4=29.65,   &amp;<a name='409'>
                          T0=273.16E0, ELWV=2.50E6,  A23M4=A2*(A3-A4)<a name='410'>
<font color=#447700>! MEK MAY 2007<a name='411'></font>
      REAL, PARAMETER  :: ROW=1.E3,ELIW=XLF,ROWLIW=ROW*ELIW<a name='412'>
<a name='413'>
<font color=#447700>! ----------------------------------------------------------------------<a name='414'></font>
<font color=#447700>! DECLARATIONS START - urban<a name='415'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='416'></font>
<a name='417'>
<font color=#447700>! input variables surface_driver --&gt; lsm<a name='418'></font>
     INTEGER, INTENT(IN) :: num_roof_layers<a name='419'>
     INTEGER, INTENT(IN) :: num_wall_layers<a name='420'>
     INTEGER, INTENT(IN) :: num_road_layers<a name='421'>
     REAL, OPTIONAL, DIMENSION(1:num_roof_layers), INTENT(IN) :: DZR<a name='422'>
     REAL, OPTIONAL, DIMENSION(1:num_wall_layers), INTENT(IN) :: DZB<a name='423'>
     REAL, OPTIONAL, DIMENSION(1:num_road_layers), INTENT(IN) :: DZG<a name='424'>
     REAL, OPTIONAL, INTENT(IN) :: DECLIN_URB<a name='425'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: COSZ_URB2D<a name='426'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: OMG_URB2D<a name='427'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: XLAT_URB2D<a name='428'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: U_PHY<a name='429'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: V_PHY<a name='430'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: TH_PHY<a name='431'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: P_PHY<a name='432'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: RHO<a name='433'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: UST<a name='434'>
<a name='435'>
     LOGICAL, intent(in) :: rdlai2d<a name='436'>
     LOGICAL, intent(in) :: USEMONALB<a name='437'>
<a name='438'>
<font color=#447700>! input variables lsm --&gt; urban<a name='439'></font>
     INTEGER :: UTYPE_URB <font color=#447700>! urban type [urban=1, suburban=2, rural=3]<a name='440'></font>
     REAL :: TA_URB       <font color=#447700>! potential temp at 1st atmospheric level [K]<a name='441'></font>
     REAL :: QA_URB       <font color=#447700>! mixing ratio at 1st atmospheric level  [kg/kg]<a name='442'></font>
     REAL :: UA_URB       <font color=#447700>! wind speed at 1st atmospheric level    [m/s]<a name='443'></font>
     REAL :: U1_URB       <font color=#447700>! u at 1st atmospheric level             [m/s]<a name='444'></font>
     REAL :: V1_URB       <font color=#447700>! v at 1st atmospheric level             [m/s]<a name='445'></font>
     REAL :: SSG_URB      <font color=#447700>! downward total short wave radiation    [W/m/m]<a name='446'></font>
     REAL :: LLG_URB      <font color=#447700>! downward long wave radiation           [W/m/m]<a name='447'></font>
     REAL :: RAIN_URB     <font color=#447700>! precipitation                          [mm/h]<a name='448'></font>
     REAL :: RHOO_URB     <font color=#447700>! air density                            [kg/m^3]<a name='449'></font>
     REAL :: ZA_URB       <font color=#447700>! first atmospheric level                [m]<a name='450'></font>
     REAL :: DELT_URB     <font color=#447700>! time step                              [s]<a name='451'></font>
     REAL :: SSGD_URB     <font color=#447700>! downward direct short wave radiation   [W/m/m]<a name='452'></font>
     REAL :: SSGQ_URB     <font color=#447700>! downward diffuse short wave radiation  [W/m/m]<a name='453'></font>
     REAL :: XLAT_URB     <font color=#447700>! latitude                               [deg]<a name='454'></font>
     REAL :: COSZ_URB     <font color=#447700>! cosz<a name='455'></font>
     REAL :: OMG_URB      <font color=#447700>! hour angle<a name='456'></font>
     REAL :: ZNT_URB      <font color=#447700>! roughness length                       [m]<a name='457'></font>
     REAL :: TR_URB<a name='458'>
     REAL :: TB_URB<a name='459'>
     REAL :: TG_URB<a name='460'>
     REAL :: TC_URB<a name='461'>
     REAL :: QC_URB<a name='462'>
     REAL :: UC_URB<a name='463'>
     REAL :: XXXR_URB<a name='464'>
     REAL :: XXXB_URB<a name='465'>
     REAL :: XXXG_URB<a name='466'>
     REAL :: XXXC_URB<a name='467'>
     REAL, DIMENSION(1:num_roof_layers) :: TRL_URB  <font color=#447700>! roof layer temp [K]<a name='468'></font>
     REAL, DIMENSION(1:num_wall_layers) :: TBL_URB  <font color=#447700>! wall layer temp [K]<a name='469'></font>
     REAL, DIMENSION(1:num_road_layers) :: TGL_URB  <font color=#447700>! road layer temp [K]<a name='470'></font>
     LOGICAL  :: LSOLAR_URB<a name='471'>
<a name='472'>
<font color=#447700>!===Yang,2014/10/08,hydrological variable for single layer UCM===<a name='473'></font>
     INTEGER :: jmonth, jday, tloc<a name='474'>
     INTEGER :: IRIOPTION, USOIL, DSOIL<a name='475'>
     REAL :: AOASIS, OMG<a name='476'>
     REAL :: DRELR_URB<a name='477'>
     REAL :: DRELB_URB<a name='478'>
     REAL :: DRELG_URB<a name='479'>
     REAL :: FLXHUMR_URB<a name='480'>
     REAL :: FLXHUMB_URB<a name='481'>
     REAL :: FLXHUMG_URB<a name='482'>
     REAL :: CMCR_URB<a name='483'>
     REAL :: TGR_URB<a name='484'>
     REAL, DIMENSION(1:num_roof_layers) :: SMR_URB  <font color=#447700>! green roof layer moisture<a name='485'></font>
     REAL, DIMENSION(1:num_roof_layers) :: TGRL_URB <font color=#447700>! green roof layer temp [K]<a name='486'></font>
<a name='487'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELR_URB2D<a name='488'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELB_URB2D<a name='489'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELG_URB2D<a name='490'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMR_URB2D<a name='491'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMB_URB2D<a name='492'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMG_URB2D<a name='493'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMCR_URB2D<a name='494'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TGR_URB2D<a name='495'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: TGRL_URB3D<a name='496'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: SMR_URB3D<a name='497'>
<a name='498'>
<a name='499'>
<font color=#447700>! state variable surface_driver &lt;--&gt; lsm &lt;--&gt; urban<a name='500'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TR_URB2D<a name='501'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TB_URB2D<a name='502'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TG_URB2D<a name='503'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TC_URB2D<a name='504'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: QC_URB2D<a name='505'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: UC_URB2D<a name='506'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXR_URB2D<a name='507'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXB_URB2D<a name='508'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXG_URB2D<a name='509'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXC_URB2D<a name='510'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: SH_URB2D<a name='511'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LH_URB2D<a name='512'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: G_URB2D<a name='513'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: RN_URB2D<a name='514'>
<font color=#447700>!<a name='515'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TS_URB2D<a name='516'>
<a name='517'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: TRL_URB3D<a name='518'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_wall_layers, jms:jme ), INTENT(INOUT) :: TBL_URB3D<a name='519'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_road_layers, jms:jme ), INTENT(INOUT) :: TGL_URB3D<a name='520'>
<a name='521'>
<font color=#447700>! output variable lsm --&gt; surface_driver<a name='522'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: PSIM_URB2D<a name='523'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: PSIH_URB2D<a name='524'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: GZ1OZ0_URB2D<a name='525'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: U10_URB2D<a name='526'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: V10_URB2D<a name='527'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: TH2_URB2D<a name='528'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: Q2_URB2D<a name='529'>
<font color=#447700>!<a name='530'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: AKMS_URB2D<a name='531'>
<font color=#447700>!<a name='532'></font>
     REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: UST_URB2D<a name='533'>
     REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: FRC_URB2D<a name='534'>
     INTEGER, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: UTYPE_URB2D<a name='535'>
<a name='536'>
<a name='537'>
<font color=#447700>! output variables urban --&gt; lsm<a name='538'></font>
     REAL :: TS_URB     <font color=#447700>! surface radiative temperature    [K]<a name='539'></font>
     REAL :: QS_URB     <font color=#447700>! surface humidity                 [-]<a name='540'></font>
     REAL :: SH_URB     <font color=#447700>! sensible heat flux               [W/m/m]<a name='541'></font>
     REAL :: LH_URB     <font color=#447700>! latent heat flux                 [W/m/m]<a name='542'></font>
     REAL :: LH_KINEMATIC_URB <font color=#447700>! latent heat flux, kinetic  [kg/m/m/s]<a name='543'></font>
     REAL :: SW_URB     <font color=#447700>! upward short wave radiation flux [W/m/m]<a name='544'></font>
     REAL :: ALB_URB    <font color=#447700>! time-varying albedo            [fraction]<a name='545'></font>
     REAL :: LW_URB     <font color=#447700>! upward long wave radiation flux  [W/m/m]<a name='546'></font>
     REAL :: G_URB      <font color=#447700>! heat flux into the ground        [W/m/m]<a name='547'></font>
     REAL :: RN_URB     <font color=#447700>! net radiation                    [W/m/m]<a name='548'></font>
     REAL :: PSIM_URB   <font color=#447700>! shear f for momentum             [-]<a name='549'></font>
     REAL :: PSIH_URB   <font color=#447700>! shear f for heat                 [-]<a name='550'></font>
     REAL :: GZ1OZ0_URB   <font color=#447700>! shear f for heat                 [-]<a name='551'></font>
     REAL :: U10_URB    <font color=#447700>! wind u component at 10 m         [m/s]<a name='552'></font>
     REAL :: V10_URB    <font color=#447700>! wind v component at 10 m         [m/s]<a name='553'></font>
     REAL :: TH2_URB    <font color=#447700>! potential temperature at 2 m     [K]<a name='554'></font>
     REAL :: Q2_URB     <font color=#447700>! humidity at 2 m                  [-]<a name='555'></font>
     REAL :: CHS_URB<a name='556'>
     REAL :: CHS2_URB<a name='557'>
     REAL :: UST_URB<a name='558'>
<font color=#447700>! NUDAPT Parameters urban --&gt; lam<a name='559'></font>
     REAL :: mh_urb<a name='560'>
     REAL :: stdh_urb<a name='561'>
     REAL :: lp_urb<a name='562'>
     REAL :: hgt_urb<a name='563'>
     REAL, DIMENSION(4) :: lf_urb<a name='564'>
<font color=#447700>! Variables for multi-layer UCM (Martilli et al. 2002)<a name='565'></font>
   REAL, OPTIONAL, INTENT(IN  )   ::                                   GMT <a name='566'>
   INTEGER, OPTIONAL, INTENT(IN  ) ::                               JULDAY<a name='567'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   )        ::XLAT, XLONG<a name='568'>
   INTEGER, INTENT(IN  ) ::                               NUM_URBAN_LAYERS<a name='569'>
   INTEGER, INTENT(IN  ) ::                               NUM_URBAN_HI<a name='570'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: trb_urb4d<a name='571'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1_urb4d<a name='572'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2_urb4d<a name='573'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tgb_urb4d<a name='574'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tlev_urb3d<a name='575'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: qlev_urb3d<a name='576'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1lev_urb3d<a name='577'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2lev_urb3d<a name='578'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tglev_urb3d<a name='579'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tflev_urb3d<a name='580'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: lf_ac_urb3d<a name='581'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: sf_ac_urb3d<a name='582'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: cm_ac_urb3d<a name='583'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: sfvent_urb3d<a name='584'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: lfvent_urb3d<a name='585'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin1_urb3d<a name='586'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin2_urb3d<a name='587'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw1_urb3d<a name='588'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw2_urb3d<a name='589'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfr_urb3d<a name='590'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfg_urb3d<a name='591'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_hi, jms:jme ), INTENT(IN) :: hi_urb2d<a name='592'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: lp_urb2d<a name='593'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: lb_urb2d<a name='594'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: hgt_urb2d<a name='595'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: mh_urb2d<a name='596'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: stdh_urb2d<a name='597'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 4, jms:jme ), INTENT(IN) :: lf_urb2d<a name='598'>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_u_bep   <font color=#447700>!Implicit momemtum component X-direction<a name='599'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_v_bep   <font color=#447700>!Implicit momemtum component Y-direction<a name='600'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_t_bep   <font color=#447700>!Implicit component pot. temperature<a name='601'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_q_bep   <font color=#447700>!Implicit momemtum component X-direction<a name='602'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_e_bep   <font color=#447700>!Implicit component TKE<a name='603'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_u_bep   <font color=#447700>!Explicit momentum component X-direction<a name='604'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_v_bep   <font color=#447700>!Explicit momentum component Y-direction<a name='605'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_t_bep   <font color=#447700>!Explicit component pot. temperature<a name='606'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_q_bep   <font color=#447700>!Implicit momemtum component Y-direction<a name='607'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_e_bep   <font color=#447700>!Explicit component TKE<a name='608'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::vl_bep    <font color=#447700>!Fraction air volume in grid cell<a name='609'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::dlg_bep   <font color=#447700>!Height above ground<a name='610'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::sf_bep  <font color=#447700>!Fraction air at the face of grid cell<a name='611'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::dl_u_bep  <font color=#447700>!Length scale<a name='612'></font>
<a name='613'>
<font color=#447700>! Local variables for multi-layer UCM (Martilli et al. 2002)<a name='614'></font>
   REAL,    DIMENSION( its:ite, jts:jte ) :: HFX_RURAL,LH_RURAL,GRDFLX_RURAL <font color=#447700>! ,RN_RURAL<a name='615'></font>
   REAL,    DIMENSION( its:ite, jts:jte ) :: QFX_RURAL <font color=#447700>! ,QSFC_RURAL,UMOM_RURAL,VMOM_RURAL<a name='616'></font>
   REAL,    DIMENSION( its:ite, jts:jte ) :: ALB_RURAL,EMISS_RURAL,TSK_RURAL <font color=#447700>! ,UST_RURAL<a name='617'></font>
<font color=#447700>!   REAL,    DIMENSION( ims:ime, jms:jme ) :: QSFC_URB<a name='618'></font>
   REAL,    DIMENSION( its:ite, jts:jte ) :: HFX_URB,UMOM_URB,VMOM_URB<a name='619'>
   REAL,    DIMENSION( its:ite, jts:jte ) :: QFX_URB<a name='620'>
<font color=#447700>!   REAL,    DIMENSION( ims:ime, jms:jme ) :: ALBEDO_URB,EMISS_URB,UMOM,VMOM,UST<a name='621'></font>
   REAL, DIMENSION(its:ite,jts:jte) ::EMISS_URB<a name='622'>
   REAL, DIMENSION(its:ite,jts:jte) :: RL_UP_URB<a name='623'>
   REAL, DIMENSION(its:ite,jts:jte) ::RS_ABS_URB<a name='624'>
   REAL, DIMENSION(its:ite,jts:jte) ::GRDFLX_URB<a name='625'>
   REAL :: SIGMA_SB,RL_UP_RURAL,RL_UP_TOT,RS_ABS_TOT,UMOM,VMOM<a name='626'>
   REAL :: r1,r2,r3<a name='627'>
   REAL :: CMR_URB, CHR_URB, CMC_URB, CHC_URB, CMGR_URB, CHGR_URB<a name='628'>
   REAL :: frc_urb,lb_urb<a name='629'>
   REAL :: check <a name='630'>
<font color=#447700>! ----------------------------------------------------------------------<a name='631'></font>
<font color=#447700>! DECLARATIONS END - urban<a name='632'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='633'></font>
<a name='634'>
  REAL, PARAMETER  :: CAPA=R_D/CP<a name='635'>
  REAL :: APELM,APES,SFCTH2,PSFC<a name='636'>
  real, intent(in) :: xice_threshold<a name='637'>
  character(len=80) :: message_text<a name='638'>
<font color=#447700>!<a name='639'></font>
<font color=#447700>!  FASDAS<a name='640'></font>
<font color=#447700>!<a name='641'></font>
   REAL,    DIMENSION( ims:ime, jms:jme ),  OPTIONAL,                     &amp;<a name='642'>
            INTENT(INOUT)  ::   SDA_HFX, SDA_QFX, HFX_BOTH, QFX_BOTH, QNORM<a name='643'>
   INTEGER, INTENT(IN   )  ::  fasdas<a name='644'>
<font color=#447700>!  local vars<a name='645'></font>
   REAL                    ::  XSDA_HFX, XSDA_QFX, XQNORM<a name='646'>
   REAL                    ::  HFX_PHY, QFX_PHY<a name='647'>
   REAL                    ::  DZQ<a name='648'>
   REAL                    ::  HCPCT_FASDAS<a name='649'>
<a name='650'>
   HFX_PHY = 0.0   <font color=#447700>! initialize<a name='651'></font>
   QFX_PHY = 0.0<a name='652'>
   XQNORM  = 0.0<a name='653'>
   XSDA_HFX = 0.0<a name='654'>
   XSDA_QFX = 0.0<a name='655'>
<font color=#447700>!<a name='656'></font>
<font color=#447700>!  END FASDAS<a name='657'></font>
<font color=#447700>!<a name='658'></font>
  FLX4  = 0.0 <font color=#447700>!BSINGH - Initialized to 0.0<a name='659'></font>
  FVB   = 0.0 <font color=#447700>!BSINGH - Initialized to 0.0<a name='660'></font>
  FBUR  = 0.0 <font color=#447700>!BSINGH - Initialized to 0.0<a name='661'></font>
  FGSN  = 0.0 <font color=#447700>!BSINGH - Initialized to 0.0<a name='662'></font>
  SOILW = 0.0 <font color=#447700>!BSINGH - Initialized to 0.0<a name='663'></font>
<a name='664'>
<font color=#447700>! MEK MAY 2007<a name='665'></font>
      FDTLIW=DT/ROWLIW<a name='666'>
<font color=#447700>! MEK JUL2007<a name='667'></font>
      FDTW=DT/(XLV*RHOWATER)<a name='668'>
<font color=#447700>! debug printout<a name='669'></font>
         IPRINT=.false.<a name='670'>
<a name='671'>
<font color=#447700>!      SLOPETYP=2<a name='672'></font>
      SLOPETYP=1<a name='673'>
<font color=#447700>!      SHDMIN=0.00<a name='674'></font>
<a name='675'>
<a name='676'>
      NSOIL=num_soil_layers<a name='677'>
<a name='678'>
     DO NS=1,NSOIL<a name='679'>
     SLDPTH(NS)=DZS(NS)<a name='680'>
     ENDDO<a name='681'>
<a name='682'>
     JLOOP : DO J=jts,jte<a name='683'>
<a name='684'>
      IF(ITIMESTEP.EQ.1)THEN<a name='685'>
        DO 50 I=its,ite<a name='686'>
<font color=#447700>!*** initialize soil conditions for IHOP 31 May case<a name='687'></font>
<font color=#447700>!         IF((XLAND(I,J)-1.5) &lt; 0.)THEN<a name='688'></font>
<font color=#447700>!            if (I==108.and.j==85) then<a name='689'></font>
<font color=#447700>!                  DO NS=1,NSOIL<a name='690'></font>
<font color=#447700>!                      SMOIS(I,NS,J)=0.10<a name='691'></font>
<font color=#447700>!                      SH2O(I,NS,J)=0.10<a name='692'></font>
<font color=#447700>!                  enddo<a name='693'></font>
<font color=#447700>!             endif<a name='694'></font>
<font color=#447700>!         ENDIF<a name='695'></font>
<a name='696'>
<font color=#447700>!*** SET ZERO-VALUE FOR SOME OUTPUT DIAGNOSTIC ARRAYS<a name='697'></font>
          IF((XLAND(I,J)-1.5).GE.0.)THEN<a name='698'>
<font color=#447700>! check sea-ice point<a name='699'></font>
#if 0<a name='700'>
            IF( XICE(I,J).GE. XICE_THRESHOLD .and. IPRINT ) PRINT*, ' sea-ice at water point, I=',I,'J=',J<a name='701'>
#endif<a name='702'>
<font color=#447700>!***   Open Water Case<a name='703'></font>
            SMSTAV(I,J)=1.0<a name='704'>
            SMSTOT(I,J)=1.0<a name='705'>
            DO NS=1,NSOIL<a name='706'>
              SMOIS(I,NS,J)=1.0<a name='707'>
              TSLB(I,NS,J)=273.16                                          <font color=#447700>!STEMP<a name='708'></font>
              SMCREL(I,NS,J)=1.0<a name='709'>
            ENDDO<a name='710'>
          ELSE<a name='711'>
            IF ( XICE(I,J) .GE. XICE_THRESHOLD ) THEN<a name='712'>
<font color=#447700>!***        SEA-ICE CASE<a name='713'></font>
              SMSTAV(I,J)=1.0<a name='714'>
              SMSTOT(I,J)=1.0<a name='715'>
              DO NS=1,NSOIL<a name='716'>
                SMOIS(I,NS,J)=1.0<a name='717'>
                SMCREL(I,NS,J)=1.0<a name='718'>
              ENDDO<a name='719'>
            ENDIF<a name='720'>
          ENDIF<a name='721'>
<font color=#447700>!<a name='722'></font>
   50   CONTINUE<a name='723'>
      ENDIF                                                               <font color=#447700>! end of initialization over ocean<a name='724'></font>
<a name='725'>
<font color=#447700>!-----------------------------------------------------------------------<a name='726'></font>
      ILOOP : DO I=its,ite<a name='727'>
<font color=#447700>! surface pressure<a name='728'></font>
        PSFC=P8w3D(i,1,j)<a name='729'>
<font color=#447700>! pressure in middle of lowest layer<a name='730'></font>
        SFCPRS=(P8W3D(I,KTS+1,j)+P8W3D(i,KTS,j))*0.5<a name='731'>
<font color=#447700>! convert from mixing ratio to specific humidity<a name='732'></font>
         Q2K=QV3D(i,1,j)/(1.0+QV3D(i,1,j))<a name='733'>
<font color=#447700>!<a name='734'></font>
<font color=#447700>!         Q2SAT=QGH(I,j)<a name='735'></font>
         Q2SAT=QGH(I,J)/(1.0+QGH(I,J))        <font color=#447700>! Q2SAT is sp humidity<a name='736'></font>
<font color=#447700>! add check on myj=.true.<a name='737'></font>
<font color=#447700>!        IF((Q2K.GE.Q2SAT*TRESH).AND.Q2K.LT.QZ0(I,J))THEN<a name='738'></font>
        IF((myj).AND.(Q2K.GE.Q2SAT*TRESH).AND.Q2K.LT.QZ0(I,J))THEN<a name='739'>
          SATFLG=0.<a name='740'>
          CHKLOWQ(I,J)=0.<a name='741'>
        ELSE<a name='742'>
          SATFLG=1.0<a name='743'>
          CHKLOWQ(I,J)=1.<a name='744'>
        ENDIF<a name='745'>
<a name='746'>
        SFCTMP=T3D(i,1,j)<a name='747'>
        ZLVL=0.5*DZ8W(i,1,j)<a name='748'>
<a name='749'>
<font color=#447700>!        TH2=SFCTMP+(0.0097545*ZLVL)<a name='750'></font>
<font color=#447700>! calculate SFCTH2 via Exner function vs lapse-rate (above)<a name='751'></font>
         APES=(1.E5/PSFC)**CAPA<a name='752'>
         APELM=(1.E5/SFCPRS)**CAPA<a name='753'>
         SFCTH2=SFCTMP*APELM<a name='754'>
         TH2=SFCTH2/APES<a name='755'>
<font color=#447700>!<a name='756'></font>
         EMISSI = EMISS(I,J)<a name='757'>
         LWDN=GLW(I,J)*EMISSI<a name='758'>
<font color=#447700>! SOLDN is total incoming solar<a name='759'></font>
        SOLDN=SWDOWN(I,J)<a name='760'>
<font color=#447700>! GSW is net downward solar<a name='761'></font>
<font color=#447700>!        SOLNET=GSW(I,J)<a name='762'></font>
<font color=#447700>! use mid-day albedo to determine net downward solar (no solar zenith angle correction)<a name='763'></font>
        SOLNET=SOLDN*(1.-ALBEDO(I,J))<a name='764'>
        PRCP=RAINBL(i,j)/DT<a name='765'>
        VEGTYP=IVGTYP(I,J)<a name='766'>
        SOILTYP=ISLTYP(I,J)<a name='767'>
        SHDFAC=VEGFRA(I,J)/100.<a name='768'>
        T1=TSK(I,J)<a name='769'>
        CHK=CHS(I,J)<a name='770'>
        SHMIN=SHDMIN(I,J)/100. <font color=#447700>!NEW<a name='771'></font>
        SHMAX=SHDMAX(I,J)/100. <font color=#447700>!NEW<a name='772'></font>
<font color=#447700>! convert snow water equivalent from mm to meter<a name='773'></font>
        SNEQV=SNOW(I,J)*0.001<a name='774'>
<font color=#447700>! snow depth in meters<a name='775'></font>
        SNOWHK=SNOWH(I,J)<a name='776'>
        SNCOVR=SNOWC(I,J)<a name='777'>
<a name='778'>
<font color=#447700>! if "SR" present, set frac of frozen precip ("FFROZP") = snow-ratio ("SR", range:0-1)<a name='779'></font>
<font color=#447700>! SR from e.g. Ferrier microphysics<a name='780'></font>
<font color=#447700>! otherwise define from 1st atmos level temperature<a name='781'></font>
       IF(FRPCPN) THEN<a name='782'>
          FFROZP=SR(I,J)<a name='783'>
        ELSE<a name='784'>
          IF (SFCTMP &lt;=  273.15) THEN<a name='785'>
            FFROZP = 1.0<a name='786'>
	  ELSE<a name='787'>
	    FFROZP = 0.0<a name='788'>
	  ENDIF<a name='789'>
        ENDIF<a name='790'>
<font color=#447700>!***<a name='791'></font>
        IF((XLAND(I,J)-1.5).GE.0.)THEN                                  <font color=#447700>! begining of land/sea if block<a name='792'></font>
<font color=#447700>! Open water points<a name='793'></font>
          TSK_RURAL(I,J)=TSK(I,J)<a name='794'>
          HFX_RURAL(I,J)=HFX(I,J)<a name='795'>
          QFX_RURAL(I,J)=QFX(I,J)<a name='796'>
          LH_RURAL(I,J)=LH(I,J)<a name='797'>
          EMISS_RURAL(I,J)=EMISS(I,J)<a name='798'>
          GRDFLX_RURAL(I,J)=GRDFLX(I,J)<a name='799'>
<a name='800'>
        ELSE<a name='801'>
<font color=#447700>! Land or sea-ice case<a name='802'></font>
<a name='803'>
          IF (XICE(I,J) &gt;= XICE_THRESHOLD) THEN<a name='804'>
             <font color=#447700>! Sea-ice point<a name='805'></font>
             ICE = 1<a name='806'>
          ELSE IF ( VEGTYP == ISICE ) THEN<a name='807'>
             <font color=#447700>! Land-ice point<a name='808'></font>
             ICE = -1<a name='809'>
          ELSE<a name='810'>
             <font color=#447700>! Neither sea ice or land ice.<a name='811'></font>
             ICE=0<a name='812'>
          ENDIF<a name='813'>
          DQSDT2=Q2SAT*A23M4/(SFCTMP-A4)**2<a name='814'>
<a name='815'>
          IF(SNOW(I,J).GT.0.0)THEN<a name='816'>
<font color=#447700>! snow on surface (use ice saturation properties)<a name='817'></font>
            SFCTSNO=SFCTMP<a name='818'>
            E2SAT=611.2*EXP(6174.*(1./273.15 - 1./SFCTSNO))<a name='819'>
            Q2SATI=0.622*E2SAT/(SFCPRS-E2SAT)<a name='820'>
            Q2SATI=Q2SATI/(1.0+Q2SATI)    <font color=#447700>! spec. hum.<a name='821'></font>
            IF (T1 .GT. 273.14) THEN<a name='822'>
<font color=#447700>! warm ground temps, weight the saturation between ice and water according to SNOWC<a name='823'></font>
              Q2SAT=Q2SAT*(1.-SNOWC(I,J)) + Q2SATI*SNOWC(I,J)<a name='824'>
              DQSDT2=DQSDT2*(1.-SNOWC(I,J)) + Q2SATI*6174./(SFCTSNO**2)*SNOWC(I,J)<a name='825'>
            ELSE<a name='826'>
<font color=#447700>! cold ground temps, use ice saturation only<a name='827'></font>
              Q2SAT=Q2SATI<a name='828'>
              DQSDT2=Q2SATI*6174./(SFCTSNO**2)<a name='829'>
            ENDIF<a name='830'>
<font color=#447700>! for snow cover fraction at 0 C, ground temp will not change, so DQSDT2 effectively zero<a name='831'></font>
<font color=#447700>! V3.8 add condition for SWDOWN to restrict condition to positive forcing (JD)<a name='832'></font>
            IF(T1 .GT. 273. .AND. SNOWC(I,J) .GT. 0. .AND. SWDOWN(I,J) .GT. 10.)DQSDT2=DQSDT2*(1.-SNOWC(I,J))<a name='833'>
          ENDIF<a name='834'>
<a name='835'>
          <font color=#447700>! Land-ice or land points use the usual deep-soil temperature.<a name='836'></font>
          TBOT=TMN(I,J)<a name='837'>
<a name='838'>
          IF(ISURBAN.EQ.1) THEN<a name='839'>
<font color=#447700>! assumes these only need to be set for USGS land data<a name='840'></font>
          IF(VEGTYP.EQ.25) SHDFAC=0.0000<a name='841'>
          IF(VEGTYP.EQ.26) SHDFAC=0.0000<a name='842'>
          IF(VEGTYP.EQ.27) SHDFAC=0.0000<a name='843'>
          ENDIF<a name='844'>
          IF(SOILTYP.EQ.14.AND.XICE(I,J).EQ.0.)THEN<a name='845'>
#if 0<a name='846'>
         IF(IPRINT)PRINT*,' SOIL TYPE FOUND TO BE WATER AT A LAND-POINT'<a name='847'>
         IF(IPRINT)PRINT*,i,j,'RESET SOIL in surfce.F'<a name='848'>
#endif<a name='849'>
            SOILTYP=7<a name='850'>
          ENDIF<a name='851'>
          SNOALB1 = SNOALB(I,J)<a name='852'>
          CMC=CANWAT(I,J)<a name='853'>
<a name='854'>
<font color=#447700>!-------------------------------------------<a name='855'></font>
<font color=#447700>!*** convert snow depth from mm to meter<a name='856'></font>
<font color=#447700>!<a name='857'></font>
<font color=#447700>!          IF(RDMAXALB) THEN<a name='858'></font>
<font color=#447700>!           SNOALB=ALBMAX(I,J)*0.01<a name='859'></font>
<font color=#447700>!         ELSE<a name='860'></font>
<font color=#447700>!           SNOALB=MAXALB(IVGTPK)*0.01<a name='861'></font>
<font color=#447700>!         ENDIF<a name='862'></font>
<a name='863'>
<font color=#447700>!        SNOALB1=0.80<a name='864'></font>
<font color=#447700>!        SHMIN=0.00<a name='865'></font>
        ALBBRD=ALBBCK(I,J)<a name='866'>
        Z0BRD=Z0(I,J)<a name='867'>
        EMBRD=EMBCK(I,J)<a name='868'>
        SNOTIME1 = SNOTIME(I,J)<a name='869'>
        RIBB=RIB(I,J)<a name='870'>
<font color=#447700>!FEI: temporaray arrays above need to be changed later by using SI<a name='871'></font>
<a name='872'>
          DO NS=1,NSOIL<a name='873'>
            SMC(NS)=SMOIS(I,NS,J)<a name='874'>
            STC(NS)=TSLB(I,NS,J)                                          <font color=#447700>!STEMP<a name='875'></font>
            SWC(NS)=SH2O(I,NS,J)<a name='876'>
          ENDDO<a name='877'>
<font color=#447700>!<a name='878'></font>
          if ( (SNEQV.ne.0..AND.SNOWHK.eq.0.).or.(SNOWHK.le.SNEQV) )THEN<a name='879'>
            SNOWHK= 5.*SNEQV<a name='880'>
          endif<a name='881'>
<font color=#447700>!<a name='882'></font>
<a name='883'>
<font color=#447700>!Fei: urban. for urban surface, if calling UCM, redefine the natural surface in cities as<a name='884'></font>
<font color=#447700>! the "NATURAL" category in the VEGPARM.TBL<a name='885'></font>
	<a name='886'>
	   IF(SF_URBAN_PHYSICS == 1.OR. SF_URBAN_PHYSICS==2.OR.SF_URBAN_PHYSICS==3 ) THEN<a name='887'>
                IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='888'>
                  IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='889'>
		 VEGTYP = NATURAL<a name='890'>
                 SHDFAC = SHDTBL(NATURAL)<a name='891'>
                 ALBEDOK =0.2         <font color=#447700>!  0.2<a name='892'></font>
                 ALBBRD  =0.2         <font color=#447700>!0.2<a name='893'></font>
                 EMISSI = 0.98                                 <font color=#447700>!for VEGTYP=5<a name='894'></font>
		 IF ( FRC_URB2D(I,J) &lt; 0.99 ) THEN<a name='895'>
                   if(sf_urban_physics.eq.1)then<a name='896'>
           T1= ( TSK(I,J) -FRC_URB2D(I,J) * TS_URB2D (I,J) )/ (1-FRC_URB2D(I,J))<a name='897'>
                   elseif((sf_urban_physics.eq.2).OR.(sf_urban_physics.eq.3))then<a name='898'>
                r1= (tsk(i,j)**4.)<a name='899'>
                r2= frc_urb2d(i,j)*(ts_urb2d(i,j)**4.)<a name='900'>
                r3= (1.-frc_urb2d(i,j))<a name='901'>
                t1= ((r1-r2)/r3)**.25<a name='902'>
                   endif<a name='903'>
	         ELSE<a name='904'>
		 T1 = TSK(I,J)<a name='905'>
                 ENDIF<a name='906'>
                ENDIF<a name='907'>
           ELSE<a name='908'>
                 IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='909'>
                  IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='910'>
                  VEGTYP = ISURBAN<a name='911'>
           	 ENDIF<a name='912'>
           ENDIF<a name='913'>
<a name='914'>
<font color=#447700>!===Yang, 2014/10/08, hydrological processes for urban vegetation in single layer UCM===<a name='915'></font>
           AOASIS = 1.0<a name='916'>
           USOIL = 1<a name='917'>
           DSOIL = 2<a name='918'>
           IRIOPTION=IRI_SCHEME<a name='919'>
	  IF(SF_URBAN_PHYSICS == 1) THEN<a name='920'>
           OMG= OMG_URB2D(I,J)   <a name='921'>
           tloc=mod(int(OMG/3.14159*180./15.+12.+0.5 ),24)<a name='922'>
           if (tloc.lt.0) tloc=tloc+24<a name='923'>
           if (tloc==0) tloc=24<a name='924'>
           CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>cal_mon_day</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_6">(julian,julyr,jmonth,jday) <a name='925'>
           IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='926'>
                IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='927'>
            AOASIS = oasis  <font color=#447700>! urban oasis effect<a name='928'></font>
                   IF (IRIOPTION ==1) THEN<a name='929'>
                   IF (tloc==21 .or. tloc==22) THEN  <font color=#447700>!irrigation on vegetaion in urban area, MAY-SEP, 9-10pm<a name='930'></font>
                   IF (jmonth==5 .or. jmonth==6 .or. jmonth==7 .or. jmonth==8 .or. jmonth==9) THEN<a name='931'>
<font color=#447700>!                      IF (SMC(USOIL) .LT. SMCREF) SMC(USOIL)= SMCREF<a name='932'></font>
<font color=#447700>!                      IF (SMC(DSOIL) .LT. SMCREF) SMC(DSOIL)= SMCREF<a name='933'></font>
                      IF (SMC(USOIL) .LT. SMCREF) SMC(USOIL)= REFSMC(ISLTYP(I,J))                      <a name='934'>
                      IF (SMC(DSOIL) .LT. SMCREF) SMC(DSOIL)= REFSMC(ISLTYP(I,J))                    <a name='935'>
                   ENDIF<a name='936'>
                   ENDIF<a name='937'>
                   ENDIF<a name='938'>
                ENDIF<a name='939'>
           ENDIF<a name='940'>
<a name='941'>
	  IF(SF_URBAN_PHYSICS == 2 .or. SF_URBAN_PHYSICS == 3) THEN<a name='942'>
          IF(AOASIS &gt; 1.0) THEN<a name='943'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1154">('Urban oasis option is for SF_URBAN_PHYSICS == 1 only')<a name='944'>
          ENDIF<a name='945'>
          IF(IRIOPTION == 1) THEN<a name='946'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1155">('Urban irrigation option is for SF_URBAN_PHYSICS == 1 only')<a name='947'>
          ENDIF<a name='948'>
          ENDIF<a name='949'>
<a name='950'>
#if 0<a name='951'>
          IF(IPRINT) THEN<a name='952'>
<font color=#447700>!<a name='953'></font>
       print*, 'BEFORE SFLX, in Noahlsm_driver'<a name='954'>
       print*, 'ICE', ICE, 'DT',DT, 'ZLVL',ZLVL, 'NSOIL', NSOIL,   &amp;<a name='955'>
       'SLDPTH', SLDPTH, 'LOCAL',LOCAL, 'LUTYPE',&amp;<a name='956'>
        LUTYPE, 'SLTYPE',SLTYPE, 'LWDN',LWDN, 'SOLDN',SOLDN,      &amp;<a name='957'>
        'SFCPRS',SFCPRS, 'PRCP',PRCP,'SFCTMP',SFCTMP,'Q2K',Q2K,   &amp;<a name='958'>
         'TH2',TH2,'Q2SAT',Q2SAT,'DQSDT2',DQSDT2,'VEGTYP', VEGTYP,&amp;<a name='959'>
         'SOILTYP',SOILTYP, 'SLOPETYP',SLOPETYP, 'SHDFAC',SHDFAC,&amp;<a name='960'>
         'SHMIN',SHMIN, 'ALBBRD',ALBBRD,'SNOALB1',SNOALB1,'TBOT',&amp;<a name='961'>
          TBOT, 'Z0BRD',Z0BRD, 'Z0K',Z0K, 'CMC',CMC, 'T1',T1,'STC',&amp;<a name='962'>
          STC, 'SMC',SMC, 'SWC',SWC,'SNOWHK',SNOWHK,'SNEQV',SNEQV,&amp;<a name='963'>
          'ALBEDOK',ALBEDOK,'CHK',CHK,'ETA',ETA,'SHEAT',SHEAT,      &amp;<a name='964'>
          'ETA_KINEMATIC',ETA_KINEMATIC, 'FDOWN',FDOWN,'EC',EC,   &amp;<a name='965'>
          'EDIR',EDIR,'ET',ET,'ETT',ETT,'ESNOW',ESNOW,'DRIP',DRIP,&amp;<a name='966'>
          'DEW',DEW,'BETA',BETA,'ETP',ETP,'SSOIL',SSOIL,'FLX1',FLX1,&amp;<a name='967'>
          'FLX2',FLX2,'FLX3',FLX3,'SNOMLT',SNOMLT,'SNCOVR',SNCOVR,&amp;<a name='968'>
          'RUNOFF1',RUNOFF1,'RUNOFF2',RUNOFF2,'RUNOFF3',RUNOFF3, &amp;<a name='969'>
          'RC',RC, 'PC',PC,'RSMIN',RSMIN,'XLAI',XLAI,'RCS',RCS,  &amp;<a name='970'>
          'RCT',RCT,'RCQ',RCQ,'RCSOIL',RCSOIL,'SOILW',SOILW,     &amp;<a name='971'>
          'SOILM',SOILM,'Q1',Q1,'SMCWLT',SMCWLT,'SMCDRY',SMCDRY,&amp;<a name='972'>
          'SMCREF',SMCREF,'SMCMAX',SMCMAX,'NROOT',NROOT<a name='973'>
           endif<a name='974'>
#endif<a name='975'>
<a name='976'>
          IF (rdlai2d) THEN<a name='977'>
             xlai = lai(i,j)<a name='978'>
          endif<a name='979'>
<a name='980'>
    IF ( ICE == 1 ) THEN<a name='981'>
<a name='982'>
       <font color=#447700>! Sea-ice case<a name='983'></font>
<a name='984'>
       DO NS = 1, NSOIL<a name='985'>
          SH2O(I,NS,J) = 1.0<a name='986'>
       ENDDO<a name='987'>
       LAI(I,J) = 0.01<a name='988'>
<a name='989'>
       CYCLE ILOOP<a name='990'>
<a name='991'>
    ELSEIF (ICE == 0) THEN<a name='992'>
<a name='993'>
       <font color=#447700>! Non-glacial land<a name='994'></font>
<font color=#447700>!<a name='995'></font>
<font color=#447700>!  FASDAS<a name='996'></font>
<font color=#447700>!<a name='997'></font>
       IF( fasdas == 1 ) THEN<a name='998'>
<a name='999'>
         DZQ = DZ8W(I,1,J)<a name='1000'>
         XSDA_HFX= SDA_HFX(I,J)*RHO(I,1,J)*CPM(I,J)*DZQ  <font color=#447700>! W/m^2<a name='1001'></font>
         <font color=#447700>! TWG2015 Bugfix remove factor of 1000.0 for correct units<a name='1002'></font>
         XSDA_QFX= SDA_QFX(I,J)*RHO(I,1,J)*DZQ          <font color=#447700>! Kg/m2/s of water<a name='1003'></font>
         XQNORM = QNORM(I,J)<a name='1004'>
<a name='1005'>
       ENDIF<a name='1006'>
<font color=#447700>!<a name='1007'></font>
<font color=#447700>!  END FASDAS<a name='1008'></font>
<font color=#447700>!<a name='1009'></font>
       CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX'>SFLX</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFLX_1"> (I,J,FFROZP, ISURBAN, DT,ZLVL,NSOIL,SLDPTH,       &amp;    <font color=#447700>!C<a name='1010'></font>
                 LOCAL,                                            &amp;    <font color=#447700>!L<a name='1011'></font>
                 LUTYPE, SLTYPE,                                   &amp;    <font color=#447700>!CL<a name='1012'></font>
                 LWDN,SOLDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2K,DUMMY,   &amp;    <font color=#447700>!F<a name='1013'></font>
                 DUMMY,DUMMY, DUMMY,                               &amp;    <font color=#447700>!F PRCPRAIN not used<a name='1014'></font>
                 TH2,Q2SAT,DQSDT2,                                 &amp;    <font color=#447700>!I<a name='1015'></font>
                 VEGTYP,SOILTYP,SLOPETYP,SHDFAC,SHMIN,SHMAX,       &amp;    <font color=#447700>!I<a name='1016'></font>
                 ALBBRD, SNOALB1,TBOT, Z0BRD, Z0K, EMISSI, EMBRD,  &amp;    <font color=#447700>!S<a name='1017'></font>
                 CMC,T1,STC,SMC,SWC,SNOWHK,SNEQV,ALBEDOK,CHK,dummy,&amp;    <font color=#447700>!H<a name='1018'></font>
                 ETA,SHEAT, ETA_KINEMATIC,FDOWN,                   &amp;    <font color=#447700>!O<a name='1019'></font>
                 EC,EDIR,ET,ETT,ESNOW,DRIP,DEW,                    &amp;    <font color=#447700>!O<a name='1020'></font>
                 BETA,ETP,SSOIL,                                   &amp;    <font color=#447700>!O<a name='1021'></font>
                 FLX1,FLX2,FLX3,                                   &amp;    <font color=#447700>!O<a name='1022'></font>
		 FLX4,FVB,FBUR,FGSN,UA_PHYS,                       &amp;    <font color=#447700>!UA <a name='1023'></font>
                 SNOMLT,SNCOVR,                                    &amp;    <font color=#447700>!O<a name='1024'></font>
                 RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;    <font color=#447700>!O<a name='1025'></font>
                 RC,PC,RSMIN,XLAI,RCS,RCT,RCQ,RCSOIL,              &amp;    <font color=#447700>!O<a name='1026'></font>
                 SOILW,SOILM,Q1,SMAV,                              &amp;    <font color=#447700>!D<a name='1027'></font>
                 RDLAI2D,USEMONALB,                                &amp;<a name='1028'>
                 SNOTIME1,                                         &amp;<a name='1029'>
                 RIBB,                                             &amp;<a name='1030'>
                 SMCWLT,SMCDRY,SMCREF,SMCMAX,NROOT,                &amp;<a name='1031'>
                 sfcheadrt(i,j),                                   &amp;    <font color=#447700>!I<a name='1032'></font>
                 INFXSRT(i,j),ETPND1,OPT_THCND,AOASIS              &amp;    <font color=#447700>!O<a name='1033'></font>
                ,XSDA_QFX, HFX_PHY, QFX_PHY, XQNORM, fasdas, HCPCT_FASDAS    &amp;   <font color=#447700>! fasdas<a name='1034'></font>
                 )<a name='1035'>
<a name='1036'>
<a name='1037'>
#ifdef WRF_HYDRO<a name='1038'>
                 soldrain(i,j) = RUNOFF2*DT*1000.0<a name='1039'>
#endif<a name='1040'>
    ELSEIF (ICE == -1) THEN<a name='1041'>
<a name='1042'>
       <font color=#447700>!<a name='1043'></font>
       <font color=#447700>! Set values that the LSM is expected to update,<a name='1044'></font>
       <font color=#447700>! but don't get updated for glacial points.<a name='1045'></font>
       <font color=#447700>!<a name='1046'></font>
       SOILM = 0.0 <font color=#447700>!BSINGH(PNNL)- SOILM is undefined for this case, it is used for diagnostics so setting it to zero<a name='1047'></font>
       XLAI = 0.01 <font color=#447700>! KWM Should this be Zero over land ice?  Does this value matter?<a name='1048'></font>
       RUNOFF2 = 0.0<a name='1049'>
       RUNOFF3 = 0.0<a name='1050'>
       DO NS = 1, NSOIL<a name='1051'>
          SWC(NS) = 1.0<a name='1052'>
          SMC(NS) = 1.0<a name='1053'>
          SMAV(NS) = 1.0<a name='1054'>
       ENDDO<a name='1055'>
<font color=#447700>!<a name='1056'></font>
<font color=#447700>!  FASDAS<a name='1057'></font>
<font color=#447700>!<a name='1058'></font>
       IF( fasdas == 1 ) THEN<a name='1059'>
<a name='1060'>
         DZQ = DZ8W(I,1,J)<a name='1061'>
         XSDA_HFX= SDA_HFX(I,J)*RHO(I,1,J)*CPM(I,J)*DZQ  <font color=#447700>! W/m^2<a name='1062'></font>
         XSDA_QFX= 0.0          <font color=#447700>! Kg/m2/s of water<a name='1063'></font>
         XQNORM = 0.0<a name='1064'>
<a name='1065'>
       ENDIF<a name='1066'>
<font color=#447700>!<a name='1067'></font>
<font color=#447700>!  END FASDAS<a name='1068'></font>
<font color=#447700>!<a name='1069'></font>
<a name='1070'>
       CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL'>SFLX_GLACIAL</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFLX_GLACIAL_1">(I,J,ISICE,FFROZP,DT,ZLVL,NSOIL,SLDPTH,   &amp;    <font color=#447700>!C<a name='1071'></font>
            &amp;    LWDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2K,              &amp;    <font color=#447700>!F<a name='1072'></font>
            &amp;    TH2,Q2SAT,DQSDT2,                                &amp;    <font color=#447700>!I<a name='1073'></font>
            &amp;    ALBBRD, SNOALB1,TBOT, Z0BRD, Z0K, EMISSI, EMBRD, &amp;    <font color=#447700>!S<a name='1074'></font>
            &amp;    T1,STC(1:NSOIL),SNOWHK,SNEQV,ALBEDOK,CHK,        &amp;    <font color=#447700>!H<a name='1075'></font>
            &amp;    ETA,SHEAT,ETA_KINEMATIC,FDOWN,                   &amp;    <font color=#447700>!O<a name='1076'></font>
            &amp;    ESNOW,DEW,                                       &amp;    <font color=#447700>!O<a name='1077'></font>
            &amp;    ETP,SSOIL,                                       &amp;    <font color=#447700>!O<a name='1078'></font>
            &amp;    FLX1,FLX2,FLX3,                                  &amp;    <font color=#447700>!O<a name='1079'></font>
            &amp;    SNOMLT,SNCOVR,                                   &amp;    <font color=#447700>!O<a name='1080'></font>
            &amp;    RUNOFF1,                                         &amp;    <font color=#447700>!O<a name='1081'></font>
            &amp;    Q1,                                              &amp;    <font color=#447700>!D<a name='1082'></font>
            &amp;    SNOTIME1,                                        &amp;<a name='1083'>
            &amp;    RIBB)<a name='1084'>
<a name='1085'>
    ENDIF<a name='1086'>
<a name='1087'>
       lai(i,j) = xlai<a name='1088'>
<a name='1089'>
#if 0<a name='1090'>
          IF(IPRINT) THEN<a name='1091'>
<a name='1092'>
       print*, 'AFTER SFLX, in Noahlsm_driver'<a name='1093'>
       print*, 'ICE', ICE, 'DT',DT, 'ZLVL',ZLVL, 'NSOIL', NSOIL,   &amp;<a name='1094'>
       'SLDPTH', SLDPTH, 'LOCAL',LOCAL, 'LUTYPE',&amp;<a name='1095'>
        LUTYPE, 'SLTYPE',SLTYPE, 'LWDN',LWDN, 'SOLDN',SOLDN,      &amp;<a name='1096'>
        'SFCPRS',SFCPRS, 'PRCP',PRCP,'SFCTMP',SFCTMP,'Q2K',Q2K,   &amp;<a name='1097'>
         'TH2',TH2,'Q2SAT',Q2SAT,'DQSDT2',DQSDT2,'VEGTYP', VEGTYP,&amp;<a name='1098'>
          'SOILTYP',SOILTYP, 'SLOPETYP',SLOPETYP, 'SHDFAC',SHDFAC,&amp;<a name='1099'>
         'SHDMIN',SHMIN, 'ALBBRD',ALBBRD,'SNOALB',SNOALB1,'TBOT',&amp;<a name='1100'>
          TBOT, 'Z0BRD',Z0BRD, 'Z0K',Z0K, 'CMC',CMC, 'T1',T1,'STC',&amp;<a name='1101'>
          STC, 'SMC',SMC, 'SWc',SWC,'SNOWHK',SNOWHK,'SNEQV',SNEQV,&amp;<a name='1102'>
          'ALBEDOK',ALBEDOK,'CHK',CHK,'ETA',ETA,'SHEAT',SHEAT,      &amp;<a name='1103'>
          'ETA_KINEMATIC',ETA_KINEMATIC, 'FDOWN',FDOWN,'EC',EC,   &amp;<a name='1104'>
          'EDIR',EDIR,'ET',ET,'ETT',ETT,'ESNOW',ESNOW,'DRIP',DRIP,&amp;<a name='1105'>
          'DEW',DEW,'BETA',BETA,'ETP',ETP,'SSOIL',SSOIL,'FLX1',FLX1,&amp;<a name='1106'>
          'FLX2',FLX2,'FLX3',FLX3,'SNOMLT',SNOMLT,'SNCOVR',SNCOVR,&amp;<a name='1107'>
          'RUNOFF1',RUNOFF1,'RUNOFF2',RUNOFF2,'RUNOFF3',RUNOFF3, &amp;<a name='1108'>
          'RC',RC, 'PC',PC,'RSMIN',RSMIN,'XLAI',XLAI,'RCS',RCS,  &amp;<a name='1109'>
          'RCT',RCT,'RCQ',RCQ,'RCSOIL',RCSOIL,'SOILW',SOILW,     &amp;<a name='1110'>
          'SOILM',SOILM,'Q1',Q1,'SMCWLT',SMCWLT,'SMCDRY',SMCDRY,&amp;<a name='1111'>
          'SMCREF',SMCREF,'SMCMAX',SMCMAX,'NROOT',NROOT<a name='1112'>
           endif<a name='1113'>
#endif<a name='1114'>
<a name='1115'>
<font color=#447700>!***  UPDATE STATE VARIABLES<a name='1116'></font>
          CANWAT(I,J)=CMC<a name='1117'>
          SNOW(I,J)=SNEQV*1000.<a name='1118'>
<font color=#447700>!          SNOWH(I,J)=SNOWHK*1000.<a name='1119'></font>
          SNOWH(I,J)=SNOWHK                   <font color=#447700>! SNOWHK in meters<a name='1120'></font>
          ALBEDO(I,J)=ALBEDOK<a name='1121'>
          ALB_RURAL(I,J)=ALBEDOK<a name='1122'>
          ALBBCK(I,J)=ALBBRD<a name='1123'>
          Z0(I,J)=Z0BRD<a name='1124'>
          EMISS(I,J) = EMISSI<a name='1125'>
          EMISS_RURAL(I,J) = EMISSI<a name='1126'>
<font color=#447700>! Noah: activate time-varying roughness length (V3.3 Feb 2011)<a name='1127'></font>
          ZNT(I,J)=Z0K<a name='1128'>
<font color=#447700>!<a name='1129'></font>
<font color=#447700>! FASDAS<a name='1130'></font>
<font color=#447700>!<a name='1131'></font>
<font color=#447700>! Update Skin Temperature<a name='1132'></font>
       IF( fasdas == 1 ) THEN<a name='1133'>
           XSDA_QFX= XSDA_QFX*ELWV*XQNORM<a name='1134'>
<a name='1135'>
        <font color=#447700>!TWG2015 Bugfix to multiply Heat Capacity by Soil Depth for correct<a name='1136'></font>
        <font color=#447700>!units <a name='1137'></font>
<a name='1138'>
           T1 = T1 + (XSDA_HFX-XSDA_QFX)*DT/(HCPCT_FASDAS*DZS(1))<a name='1139'>
<a name='1140'>
       END IF<a name='1141'>
<font color=#447700>!<a name='1142'></font>
<font color=#447700>! END FASDAS<a name='1143'></font>
<font color=#447700>!<a name='1144'></font>
          TSK(I,J)=T1<a name='1145'>
          TSK_RURAL(I,J)=T1<a name='1146'>
          HFX(I,J)=SHEAT<a name='1147'>
          HFX_RURAL(I,J)=SHEAT<a name='1148'>
<font color=#447700>! MEk Jul07 add potential evap accum<a name='1149'></font>
        POTEVP(I,J)=POTEVP(I,J)+ETP*FDTW<a name='1150'>
          QFX(I,J)=ETA_KINEMATIC<a name='1151'>
          QFX_RURAL(I,J)=ETA_KINEMATIC<a name='1152'>
<a name='1153'>
#ifdef WRF_HYDRO<a name='1154'>
<font color=#447700>!added by Wei Yu<a name='1155'></font>
<font color=#447700>!         QFX(I,J) = QFX(I,J) + ETPND1<a name='1156'></font>
<font color=#447700>!         ETA = ETA + ETPND1/2.501E6*dt<a name='1157'></font>
<font color=#447700>!end added by Wei Yu<a name='1158'></font>
#endif<a name='1159'>
<a name='1160'>
<a name='1161'>
          LH(I,J)=ETA<a name='1162'>
          LH_RURAL(I,J)=ETA<a name='1163'>
          GRDFLX(I,J)=SSOIL<a name='1164'>
          GRDFLX_RURAL(I,J)=SSOIL<a name='1165'>
          SNOWC(I,J)=SNCOVR<a name='1166'>
          CHS2(I,J)=CQS2(I,J)<a name='1167'>
          SNOTIME(I,J) = SNOTIME1<a name='1168'>
<font color=#447700>!      prevent diagnostic ground q (q1) from being greater than qsat(tsk)<a name='1169'></font>
<font color=#447700>!      as happens over snow cover where the cqs2 value also becomes irrelevant<a name='1170'></font>
<font color=#447700>!      by setting cqs2=chs in this situation the 2m q should become just qv(k=1)<a name='1171'></font>
<font color=#447700>! ww: comment out this change to avoid Q2 drop due to change of radiative flux<a name='1172'></font>
<font color=#447700>!         IF (Q1 .GT. QSFC(I,J)) THEN<a name='1173'></font>
<font color=#447700>!           CQS2(I,J) = CHS(I,J)<a name='1174'></font>
<font color=#447700>!         ENDIF<a name='1175'></font>
<font color=#447700>!          QSFC(I,J)=Q1<a name='1176'></font>
<font color=#447700>! Convert QSFC back to mixing ratio<a name='1177'></font>
           QSFC(I,J)= Q1/(1.0-Q1)<a name='1178'>
<font color=#447700>!<a name='1179'></font>
           <font color=#447700>! QSFC_RURAL(I,J)= Q1/(1.0-Q1)<a name='1180'></font>
<font color=#447700>! Calculate momentum flux from rural surface for use with multi-layer UCM (Martilli et al. 2002)<a name='1181'></font>
<a name='1182'>
          DO 80 NS=1,NSOIL<a name='1183'>
           SMOIS(I,NS,J)=SMC(NS)<a name='1184'>
           TSLB(I,NS,J)=STC(NS)                                        <font color=#447700>!  STEMP<a name='1185'></font>
           SH2O(I,NS,J)=SWC(NS)<a name='1186'>
   80     CONTINUE<a name='1187'>
<font color=#447700>!       ENDIF<a name='1188'></font>
<a name='1189'>
        FLX4_2D(I,J)  = FLX4<a name='1190'>
	FVB_2D(I,J)   = FVB<a name='1191'>
	FBUR_2D(I,J)  = FBUR<a name='1192'>
	FGSN_2D(I,J)  = FGSN<a name='1193'>
<a name='1194'>
     <font color=#447700>!<a name='1195'></font>
     <font color=#447700>! Residual of surface energy balance equation terms<a name='1196'></font>
     <font color=#447700>!<a name='1197'></font>
<a name='1198'>
     IF ( UA_PHYS ) THEN<a name='1199'>
         noahres(i,j) = ( solnet + lwdn ) - sheat + ssoil - eta &amp;<a name='1200'>
              - ( emissi * STBOLT * (t1**4) ) - flx1 - flx2 - flx3 - flx4<a name='1201'>
<a name='1202'>
     ELSE<a name='1203'>
         noahres(i,j) = ( solnet + lwdn ) - sheat + ssoil - eta &amp;<a name='1204'>
              - ( emissi * STBOLT * (t1**4) ) - flx1 - flx2 - flx3<a name='1205'>
     ENDIF<a name='1206'>
<a name='1207'>
<a name='1208'>
        IF (SF_URBAN_PHYSICS == 1 ) THEN                                              <font color=#447700>! Beginning of UCM CALL if block<a name='1209'></font>
<font color=#447700>!--------------------------------------<a name='1210'></font>
<font color=#447700>! URBAN CANOPY MODEL START - urban<a name='1211'></font>
<font color=#447700>!--------------------------------------<a name='1212'></font>
<font color=#447700>! Input variables lsm --&gt; urban<a name='1213'></font>
<a name='1214'>
<a name='1215'>
          IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='1216'>
              IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL ) THEN<a name='1217'>
<a name='1218'>
<font color=#447700>! Call urban<a name='1219'></font>
<a name='1220'>
<font color=#447700>!<a name='1221'></font>
            UTYPE_URB = UTYPE_URB2D(I,J) <font color=#447700>!urban type (low, high or industrial)<a name='1222'></font>
<a name='1223'>
            TA_URB    = SFCTMP           <font color=#447700>! [K]<a name='1224'></font>
            QA_URB    = Q2K              <font color=#447700>! [kg/kg]<a name='1225'></font>
            UA_URB    = SQRT(U_PHY(I,1,J)**2.+V_PHY(I,1,J)**2.)<a name='1226'>
            U1_URB    = U_PHY(I,1,J)<a name='1227'>
            V1_URB    = V_PHY(I,1,J)<a name='1228'>
            IF(UA_URB &lt; 1.) UA_URB=1.    <font color=#447700>! [m/s]<a name='1229'></font>
            SSG_URB   = SOLDN            <font color=#447700>! [W/m/m]<a name='1230'></font>
            SSGD_URB  = 0.8*SOLDN        <font color=#447700>! [W/m/m]<a name='1231'></font>
            SSGQ_URB  = SSG_URB-SSGD_URB <font color=#447700>! [W/m/m]<a name='1232'></font>
            LLG_URB   = GLW(I,J)         <font color=#447700>! [W/m/m]<a name='1233'></font>
            RAIN_URB  = RAINBL(I,J)      <font color=#447700>! [mm]<a name='1234'></font>
            RHOO_URB  = SFCPRS / (287.04 * SFCTMP * (1.0+ 0.61 * Q2K)) <font color=#447700>![kg/m/m/m]<a name='1235'></font>
            ZA_URB    = ZLVL             <font color=#447700>! [m]<a name='1236'></font>
            DELT_URB  = DT               <font color=#447700>! [sec]<a name='1237'></font>
            XLAT_URB  = XLAT_URB2D(I,J)  <font color=#447700>! [deg]<a name='1238'></font>
            COSZ_URB  = COSZ_URB2D(I,J)  <font color=#447700>!<a name='1239'></font>
            OMG_URB   = OMG_URB2D(I,J)   <font color=#447700>!<a name='1240'></font>
            ZNT_URB   = ZNT(I,J)<a name='1241'>
<a name='1242'>
            LSOLAR_URB = .FALSE.<a name='1243'>
<a name='1244'>
            TR_URB = TR_URB2D(I,J)<a name='1245'>
            TB_URB = TB_URB2D(I,J)<a name='1246'>
            TG_URB = TG_URB2D(I,J)<a name='1247'>
            TC_URB = TC_URB2D(I,J)<a name='1248'>
            QC_URB = QC_URB2D(I,J)<a name='1249'>
            UC_URB = UC_URB2D(I,J)<a name='1250'>
<a name='1251'>
            TGR_URB   = TGR_URB2D(I,J)<a name='1252'>
            CMCR_URB  = CMCR_URB2D(I,J)<a name='1253'>
            FLXHUMR_URB = FLXHUMR_URB2D(I,J)<a name='1254'>
            FLXHUMB_URB = FLXHUMB_URB2D(I,J)<a name='1255'>
            FLXHUMG_URB = FLXHUMG_URB2D(I,J)<a name='1256'>
            DRELR_URB = DRELR_URB2D(I,J)<a name='1257'>
            DRELB_URB = DRELB_URB2D(I,J)<a name='1258'>
            DRELG_URB = DRELG_URB2D(I,J)<a name='1259'>
<a name='1260'>
            DO K = 1,num_roof_layers<a name='1261'>
              TRL_URB(K) = TRL_URB3D(I,K,J)<a name='1262'>
              SMR_URB(K) = SMR_URB3D(I,K,J)<a name='1263'>
              TGRL_URB(K)= TGRL_URB3D(I,K,J)<a name='1264'>
            END DO<a name='1265'>
            DO K = 1,num_wall_layers<a name='1266'>
              TBL_URB(K) = TBL_URB3D(I,K,J)<a name='1267'>
            END DO<a name='1268'>
            DO K = 1,num_road_layers<a name='1269'>
              TGL_URB(K) = TGL_URB3D(I,K,J)<a name='1270'>
            END DO<a name='1271'>
<a name='1272'>
            XXXR_URB = XXXR_URB2D(I,J)<a name='1273'>
            XXXB_URB = XXXB_URB2D(I,J)<a name='1274'>
            XXXG_URB = XXXG_URB2D(I,J)<a name='1275'>
            XXXC_URB = XXXC_URB2D(I,J)<a name='1276'>
<font color=#447700>!<a name='1277'></font>
<font color=#447700>!<a name='1278'></font>
<font color=#447700>!      Limits to avoid dividing by small number<a name='1279'></font>
            if (CHS(I,J) &lt; 1.0E-02) then<a name='1280'>
               CHS(I,J)  = 1.0E-02<a name='1281'>
            endif<a name='1282'>
            if (CHS2(I,J) &lt; 1.0E-02) then<a name='1283'>
               CHS2(I,J)  = 1.0E-02<a name='1284'>
            endif<a name='1285'>
            if (CQS2(I,J) &lt; 1.0E-02) then<a name='1286'>
               CQS2(I,J)  = 1.0E-02<a name='1287'>
            endif<a name='1288'>
<font color=#447700>!<a name='1289'></font>
            CHS_URB  = CHS(I,J)<a name='1290'>
            CHS2_URB = CHS2(I,J)<a name='1291'>
            IF (PRESENT(CMR_SFCDIF)) THEN<a name='1292'>
               CMR_URB = CMR_SFCDIF(I,J)<a name='1293'>
               CHR_URB = CHR_SFCDIF(I,J)<a name='1294'>
               CMGR_URB = CMGR_SFCDIF(I,J)<a name='1295'>
               CHGR_URB = CHGR_SFCDIF(I,J)<a name='1296'>
               CMC_URB = CMC_SFCDIF(I,J)<a name='1297'>
               CHC_URB = CHC_SFCDIF(I,J)<a name='1298'>
            ENDIF<a name='1299'>
<a name='1300'>
<font color=#447700>! NUDAPT for SLUCM<a name='1301'></font>
            mh_urb = mh_urb2d(I,J)<a name='1302'>
            stdh_urb = stdh_urb2d(I,J)<a name='1303'>
            lp_urb = lp_urb2d(I,J)<a name='1304'>
            hgt_urb = hgt_urb2d(I,J)<a name='1305'>
            lf_urb = 0.0<a name='1306'>
            DO K = 1,4<a name='1307'>
              lf_urb(K)=lf_urb2d(I,K,J)<a name='1308'>
            ENDDO<a name='1309'>
            frc_urb = frc_urb2d(I,J)<a name='1310'>
            lb_urb = lb_urb2d(I,J)<a name='1311'>
            check = 0<a name='1312'>
            if (I.eq.73.and.J.eq.125)THEN<a name='1313'>
               check = 1<a name='1314'>
            end if<a name='1315'>
<font color=#447700>!<a name='1316'></font>
<font color=#447700>! Call urban<a name='1317'></font>
            CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>cal_mon_day</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_7">(julian,julyr,jmonth,jday)<a name='1318'>
            CALL <A href='../../html_code/phys/module_sf_urban.F.html#URBAN'>urban</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="URBAN_2">(LSOLAR_URB,                                      &amp; <font color=#447700>! I<a name='1319'></font>
                       num_roof_layers,num_wall_layers,num_road_layers, &amp; <font color=#447700>! C<a name='1320'></font>
                       DZR,DZB,DZG,                                     &amp; <font color=#447700>! C<a name='1321'></font>
                       UTYPE_URB,TA_URB,QA_URB,UA_URB,U1_URB,V1_URB,SSG_URB, &amp; <font color=#447700>! I<a name='1322'></font>
                       SSGD_URB,SSGQ_URB,LLG_URB,RAIN_URB,RHOO_URB,     &amp; <font color=#447700>! I<a name='1323'></font>
                       ZA_URB,DECLIN_URB,COSZ_URB,OMG_URB,              &amp; <font color=#447700>! I<a name='1324'></font>
                       XLAT_URB,DELT_URB,ZNT_URB,                       &amp; <font color=#447700>! I<a name='1325'></font>
                       CHS_URB, CHS2_URB,                               &amp; <font color=#447700>! I<a name='1326'></font>
                       TR_URB, TB_URB, TG_URB, TC_URB, QC_URB,UC_URB,   &amp; <font color=#447700>! H<a name='1327'></font>
                       TRL_URB,TBL_URB,TGL_URB,                         &amp; <font color=#447700>! H<a name='1328'></font>
                       XXXR_URB, XXXB_URB, XXXG_URB, XXXC_URB,          &amp; <font color=#447700>! H<a name='1329'></font>
                       TS_URB,QS_URB,SH_URB,LH_URB,LH_KINEMATIC_URB,    &amp; <font color=#447700>! O<a name='1330'></font>
                       SW_URB,ALB_URB,LW_URB,G_URB,RN_URB,PSIM_URB,PSIH_URB, &amp; <font color=#447700>! O<a name='1331'></font>
                       GZ1OZ0_URB,                                      &amp; <font color=#447700>!O<a name='1332'></font>
                       CMR_URB, CHR_URB, CMC_URB, CHC_URB,              &amp;<a name='1333'>
                       U10_URB, V10_URB, TH2_URB, Q2_URB,               &amp; <font color=#447700>! O<a name='1334'></font>
                       UST_URB,mh_urb, stdh_urb, lf_urb, lp_urb,        &amp; <font color=#447700>! 0<a name='1335'></font>
                       hgt_urb,frc_urb,lb_urb, check,CMCR_URB,TGR_URB,  &amp; <font color=#447700>! H<a name='1336'></font>
                       TGRL_URB,SMR_URB,CMGR_URB,CHGR_URB,jmonth,       &amp; <font color=#447700>! H<a name='1337'></font>
                       DRELR_URB,DRELB_URB,                             &amp; <font color=#447700>! H<a name='1338'></font>
                       DRELG_URB,FLXHUMR_URB,FLXHUMB_URB,FLXHUMG_URB)                            <a name='1339'>
<a name='1340'>
#if 0<a name='1341'>
          IF(IPRINT) THEN<a name='1342'>
<a name='1343'>
       print*, 'AFTER CALL URBAN'<a name='1344'>
       print*,'num_roof_layers',num_roof_layers, 'num_wall_layers',  &amp;<a name='1345'>
        num_wall_layers,                                             &amp;<a name='1346'>
       'DZR',DZR,'DZB',DZB,'DZG',DZG,'UTYPE_URB',UTYPE_URB,'TA_URB', &amp;<a name='1347'>
        TA_URB,                                                      &amp;<a name='1348'>
        'QA_URB',QA_URB,'UA_URB',UA_URB,'U1_URB',U1_URB,'V1_URB',    &amp;<a name='1349'>
         V1_URB,                                                     &amp;<a name='1350'>
         'SSG_URB',SSG_URB,'SSGD_URB',SSGD_URB,'SSGQ_URB',SSGQ_URB,  &amp;<a name='1351'>
        'LLG_URB',LLG_URB,'RAIN_URB',RAIN_URB,'RHOO_URB',RHOO_URB,   &amp;<a name='1352'>
        'ZA_URB',ZA_URB, 'DECLIN_URB',DECLIN_URB,'COSZ_URB',COSZ_URB,&amp;<a name='1353'>
        'OMG_URB',OMG_URB,'XLAT_URB',XLAT_URB,'DELT_URB',DELT_URB,   &amp;<a name='1354'>
         'ZNT_URB',ZNT_URB,'TR_URB',TR_URB, 'TB_URB',TB_URB,'TG_URB',&amp;<a name='1355'>
         TG_URB,'TC_URB',TC_URB,'QC_URB',QC_URB,'TRL_URB',TRL_URB,   &amp;<a name='1356'>
          'TBL_URB',TBL_URB,'TGL_URB',TGL_URB,'XXXR_URB',XXXR_URB,   &amp;<a name='1357'>
         'XXXB_URB',XXXB_URB,'XXXG_URB',XXXG_URB,'XXXC_URB',XXXC_URB,&amp;<a name='1358'>
         'TS_URB',TS_URB,'QS_URB',QS_URB,'SH_URB',SH_URB,'LH_URB',   &amp;<a name='1359'>
         LH_URB, 'LH_KINEMATIC_URB',LH_KINEMATIC_URB,'SW_URB',SW_URB,&amp;<a name='1360'>
         'ALB_URB',ALB_URB,'LW_URB',LW_URB,'G_URB',G_URB,'RN_URB',   &amp;<a name='1361'>
          RN_URB, 'PSIM_URB',PSIM_URB,'PSIH_URB',PSIH_URB,          &amp;<a name='1362'>
         'U10_URB',U10_URB,'V10_URB',V10_URB,'TH2_URB',TH2_URB,      &amp;<a name='1363'>
          'Q2_URB',Q2_URB,'CHS_URB',CHS_URB,'CHS2_URB',CHS2_URB<a name='1364'>
           endif<a name='1365'>
#endif<a name='1366'>
<a name='1367'>
            TS_URB2D(I,J) = TS_URB<a name='1368'>
<a name='1369'>
            ALBEDO(I,J) = FRC_URB2D(I,J)*ALB_URB+(1-FRC_URB2D(I,J))*ALBEDOK   <font color=#447700>![-]<a name='1370'></font>
            HFX(I,J) = FRC_URB2D(I,J)*SH_URB+(1-FRC_URB2D(I,J))*SHEAT         <font color=#447700>![W/m/m]<a name='1371'></font>
            QFX(I,J) = FRC_URB2D(I,J)*LH_KINEMATIC_URB &amp;<a name='1372'>
                     + (1-FRC_URB2D(I,J))*ETA_KINEMATIC                <font color=#447700>![kg/m/m/s]<a name='1373'></font>
            LH(I,J) = FRC_URB2D(I,J)*LH_URB+(1-FRC_URB2D(I,J))*ETA            <font color=#447700>![W/m/m]<a name='1374'></font>
            GRDFLX(I,J) = FRC_URB2D(I,J)*G_URB+(1-FRC_URB2D(I,J))*SSOIL       <font color=#447700>![W/m/m]<a name='1375'></font>
            TSK(I,J) = FRC_URB2D(I,J)*TS_URB+(1-FRC_URB2D(I,J))*T1            <font color=#447700>![K]<a name='1376'></font>
            Q1 = FRC_URB2D(I,J)*QS_URB+(1-FRC_URB2D(I,J))*Q1            <font color=#447700>![-]<a name='1377'></font>
<font color=#447700>! Convert QSFC back to mixing ratio<a name='1378'></font>
            QSFC(I,J)= Q1/(1.0-Q1)<a name='1379'>
            UST(I,J)= FRC_URB2D(I,J)*UST_URB+(1-FRC_URB2D(I,J))*UST(I,J)      <font color=#447700>![m/s]<a name='1380'></font>
<a name='1381'>
#if 0<a name='1382'>
    IF(IPRINT)THEN<a name='1383'>
<a name='1384'>
    print*, ' FRC_URB2D', FRC_URB2D,                        &amp;<a name='1385'>
    'ALB_URB',ALB_URB, 'ALBEDOK',ALBEDOK, &amp;<a name='1386'>
    'ALBEDO(I,J)',  ALBEDO(I,J),                  &amp;<a name='1387'>
    'SH_URB',SH_URB,'SHEAT',SHEAT, 'HFX(I,J)',HFX(I,J),  &amp;<a name='1388'>
    'LH_KINEMATIC_URB',LH_KINEMATIC_URB,'ETA_KINEMATIC',  &amp;<a name='1389'>
     ETA_KINEMATIC, 'QFX(I,J)',QFX(I,J),                  &amp;<a name='1390'>
    'LH_URB',LH_URB, 'ETA',ETA, 'LH(I,J)',LH(I,J),        &amp;<a name='1391'>
    'G_URB',G_URB,'SSOIL',SSOIL,'GRDFLX(I,J)', GRDFLX(I,J),&amp;<a name='1392'>
    'TS_URB',TS_URB,'T1',T1,'TSK(I,J)',TSK(I,J),          &amp;<a name='1393'>
    'QS_URB',QS_URB,'Q1',Q1,'QSFC(I,J)',QSFC(I,J)<a name='1394'>
     endif<a name='1395'>
#endif<a name='1396'>
<a name='1397'>
<a name='1398'>
<a name='1399'>
<font color=#447700>! Renew Urban State Varialbes<a name='1400'></font>
<a name='1401'>
            TR_URB2D(I,J) = TR_URB<a name='1402'>
            TB_URB2D(I,J) = TB_URB<a name='1403'>
            TG_URB2D(I,J) = TG_URB<a name='1404'>
            TC_URB2D(I,J) = TC_URB<a name='1405'>
            QC_URB2D(I,J) = QC_URB<a name='1406'>
            UC_URB2D(I,J) = UC_URB<a name='1407'>
<a name='1408'>
            TGR_URB2D(I,J) =TGR_URB <a name='1409'>
            CMCR_URB2D(I,J)=CMCR_URB<a name='1410'>
            FLXHUMR_URB2D(I,J)=FLXHUMR_URB <a name='1411'>
            FLXHUMB_URB2D(I,J)=FLXHUMB_URB<a name='1412'>
            FLXHUMG_URB2D(I,J)=FLXHUMG_URB<a name='1413'>
            DRELR_URB2D(I,J) = DRELR_URB <a name='1414'>
            DRELB_URB2D(I,J) = DRELB_URB <a name='1415'>
            DRELG_URB2D(I,J) = DRELG_URB<a name='1416'>
<a name='1417'>
            DO K = 1,num_roof_layers<a name='1418'>
              TRL_URB3D(I,K,J) = TRL_URB(K)<a name='1419'>
              SMR_URB3D(I,K,J) = SMR_URB(K)<a name='1420'>
              TGRL_URB3D(I,K,J)= TGRL_URB(K)<a name='1421'>
            END DO<a name='1422'>
            DO K = 1,num_wall_layers<a name='1423'>
              TBL_URB3D(I,K,J) = TBL_URB(K)<a name='1424'>
            END DO<a name='1425'>
            DO K = 1,num_road_layers<a name='1426'>
              TGL_URB3D(I,K,J) = TGL_URB(K)<a name='1427'>
            END DO<a name='1428'>
            XXXR_URB2D(I,J) = XXXR_URB<a name='1429'>
            XXXB_URB2D(I,J) = XXXB_URB<a name='1430'>
            XXXG_URB2D(I,J) = XXXG_URB<a name='1431'>
            XXXC_URB2D(I,J) = XXXC_URB<a name='1432'>
<a name='1433'>
            SH_URB2D(I,J)    = SH_URB<a name='1434'>
            LH_URB2D(I,J)    = LH_URB<a name='1435'>
            G_URB2D(I,J)     = G_URB<a name='1436'>
            RN_URB2D(I,J)    = RN_URB<a name='1437'>
            PSIM_URB2D(I,J)  = PSIM_URB<a name='1438'>
            PSIH_URB2D(I,J)  = PSIH_URB<a name='1439'>
            GZ1OZ0_URB2D(I,J)= GZ1OZ0_URB<a name='1440'>
            U10_URB2D(I,J)   = U10_URB<a name='1441'>
            V10_URB2D(I,J)   = V10_URB<a name='1442'>
            TH2_URB2D(I,J)   = TH2_URB<a name='1443'>
            Q2_URB2D(I,J)    = Q2_URB<a name='1444'>
            UST_URB2D(I,J)   = UST_URB<a name='1445'>
            AKMS_URB2D(I,J)  = KARMAN * UST_URB2D(I,J)/(GZ1OZ0_URB2D(I,J)-PSIM_URB2D(I,J))<a name='1446'>
            IF (PRESENT(CMR_SFCDIF)) THEN<a name='1447'>
               CMR_SFCDIF(I,J) = CMR_URB<a name='1448'>
               CHR_SFCDIF(I,J) = CHR_URB<a name='1449'>
               CMGR_SFCDIF(I,J) = CMGR_URB<a name='1450'>
               CHGR_SFCDIF(I,J) = CHGR_URB<a name='1451'>
               CMC_SFCDIF(I,J) = CMC_URB<a name='1452'>
               CHC_SFCDIF(I,J) = CHC_URB<a name='1453'>
            ENDIF<a name='1454'>
          END IF<a name='1455'>
<a name='1456'>
         ENDIF                                   <font color=#447700>! end of UCM CALL if block<a name='1457'></font>
<font color=#447700>!--------------------------------------<a name='1458'></font>
<font color=#447700>! Urban Part End - urban<a name='1459'></font>
<font color=#447700>!--------------------------------------<a name='1460'></font>
<a name='1461'>
<font color=#447700>!***  DIAGNOSTICS<a name='1462'></font>
          SMSTAV(I,J)=SOILW<a name='1463'>
          SMSTOT(I,J)=SOILM*1000.<a name='1464'>
          DO NS=1,NSOIL<a name='1465'>
          SMCREL(I,NS,J)=SMAV(NS)<a name='1466'>
          ENDDO<a name='1467'>
<a name='1468'>
<a name='1469'>
<font color=#447700>!         Convert the water unit into mm<a name='1470'></font>
          SFCRUNOFF(I,J)=SFCRUNOFF(I,J)+RUNOFF1*DT*1000.0<a name='1471'>
          UDRUNOFF(I,J)=UDRUNOFF(I,J)+RUNOFF2*DT*1000.0<a name='1472'>
<font color=#447700>! snow defined when fraction of frozen precip (FFROZP) &gt; 0.5,<a name='1473'></font>
          IF(FFROZP.GT.0.5)THEN<a name='1474'>
            ACSNOW(I,J)=ACSNOW(I,J)+PRCP*DT<a name='1475'>
          ENDIF<a name='1476'>
          IF(SNOW(I,J).GT.0.)THEN<a name='1477'>
            ACSNOM(I,J)=ACSNOM(I,J)+SNOMLT*1000.<a name='1478'>
<font color=#447700>! accumulated snow-melt energy<a name='1479'></font>
            SNOPCX(I,J)=SNOPCX(I,J)-SNOMLT/FDTLIW<a name='1480'>
          ENDIF<a name='1481'>
<a name='1482'>
        ENDIF                                                           <font color=#447700>! endif of land-sea test<a name='1483'></font>
<a name='1484'>
      ENDDO ILOOP                                                       <font color=#447700>! of I loop<a name='1485'></font>
   ENDDO JLOOP                                                          <font color=#447700>! of J loop<a name='1486'></font>
<a name='1487'>
      IF (SF_URBAN_PHYSICS == 2) THEN<a name='1488'>
<a name='1489'>
<a name='1490'>
         do j=jts,jte<a name='1491'>
         do i=its,ite<a name='1492'>
            EMISS_URB(i,j)=0.<a name='1493'>
            RL_UP_URB(i,j)=0.<a name='1494'>
            RS_ABS_URB(i,j)=0.<a name='1495'>
            GRDFLX_URB(i,j)=0.<a name='1496'>
            b_q_bep(i,kts:kte,j)=0.<a name='1497'>
         end do<a name='1498'>
         end do<a name='1499'>
       CALL <A href='../../html_code/phys/module_sf_bep.F.html#BEP'>BEP</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BEP_1">(frc_urb2d,utype_urb2d,itimestep,dz8w,dt,u_phy,v_phy,   &amp;<a name='1500'>
                th_phy,rho,p_phy,swdown,glw,                           &amp;<a name='1501'>
                gmt,julday,xlong,xlat,declin_urb,cosz_urb2d,omg_urb2d, &amp;<a name='1502'>
                num_urban_layers,num_urban_hi,                         &amp;<a name='1503'>
                trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,               &amp;<a name='1504'>
                sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,             &amp;<a name='1505'>
                lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,                  &amp;<a name='1506'>
                a_u_bep,a_v_bep,a_t_bep,                               &amp;<a name='1507'>
                a_e_bep,b_u_bep,b_v_bep,                               &amp;<a name='1508'>
                b_t_bep,b_e_bep,b_q_bep,dlg_bep,                       &amp;<a name='1509'>
                dl_u_bep,sf_bep,vl_bep,                                &amp;<a name='1510'>
                rl_up_urb,rs_abs_urb,emiss_urb,grdflx_urb,             &amp;<a name='1511'>
                ids,ide, jds,jde, kds,kde,                             &amp;<a name='1512'>
                ims,ime, jms,jme, kms,kme,                             &amp;<a name='1513'>
                its,ite, jts,jte, kts,kte )<a name='1514'>
<a name='1515'>
       ENDIF<a name='1516'>
<a name='1517'>
       <a name='1518'>
       IF (SF_URBAN_PHYSICS == 3) THEN<a name='1519'>
<a name='1520'>
<a name='1521'>
         do j=jts,jte<a name='1522'>
         do i=its,ite<a name='1523'>
            EMISS_URB(i,j)=0.<a name='1524'>
            RL_UP_URB(i,j)=0.<a name='1525'>
            RS_ABS_URB(i,j)=0.<a name='1526'>
            GRDFLX_URB(i,j)=0.<a name='1527'>
            b_q_bep(i,kts:kte,j)=0.<a name='1528'>
         end do<a name='1529'>
         end do<a name='1530'>
        <a name='1531'>
<a name='1532'>
       CALL <A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM'>BEP_BEM</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BEP_BEM_1">(frc_urb2d,utype_urb2d,itimestep,dz8w,dt,u_phy,v_phy, &amp;<a name='1533'>
                th_phy,rho,p_phy,swdown,glw,                           &amp;<a name='1534'>
                gmt,julday,xlong,xlat,declin_urb,cosz_urb2d,omg_urb2d, &amp;<a name='1535'>
                num_urban_layers,num_urban_hi,                         &amp;<a name='1536'>
                trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,               &amp;<a name='1537'>
                tlev_urb3d,qlev_urb3d,tw1lev_urb3d,tw2lev_urb3d,       &amp;<a name='1538'>
                tglev_urb3d,tflev_urb3d,sf_ac_urb3d,lf_ac_urb3d,       &amp;<a name='1539'>
                cm_ac_urb3d,sfvent_urb3d,lfvent_urb3d,                 &amp;<a name='1540'>
                sfwin1_urb3d,sfwin2_urb3d,                             &amp;<a name='1541'>
                sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,             &amp;<a name='1542'>
                lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,                  &amp;<a name='1543'>
                a_u_bep,a_v_bep,a_t_bep,                               &amp;<a name='1544'>
                a_e_bep,b_u_bep,b_v_bep,                               &amp;<a name='1545'>
                b_t_bep,b_e_bep,b_q_bep,dlg_bep,                       &amp;<a name='1546'>
                dl_u_bep,sf_bep,vl_bep,                                &amp;<a name='1547'>
                rl_up_urb,rs_abs_urb,emiss_urb,grdflx_urb,qv3d,        &amp;<a name='1548'>
                ids,ide, jds,jde, kds,kde,                             &amp;<a name='1549'>
                ims,ime, jms,jme, kms,kme,                             &amp;<a name='1550'>
                its,ite, jts,jte, kts,kte )<a name='1551'>
<a name='1552'>
       ENDIF<a name='1553'>
<a name='1554'>
    if((sf_urban_physics.eq.2).OR.(sf_urban_physics.eq.3))then         <font color=#447700>!Bep begin<a name='1555'></font>
<font color=#447700>! fix the value of the Stefan-Boltzmann constant<a name='1556'></font>
         sigma_sb=5.67e-08<a name='1557'>
         do j=jts,jte<a name='1558'>
         do i=its,ite<a name='1559'>
            UMOM_URB(I,J)=0.<a name='1560'>
            VMOM_URB(I,J)=0.<a name='1561'>
            HFX_URB(I,J)=0.<a name='1562'>
            QFX_URB(I,J)=0.<a name='1563'>
         do k=kts,kte<a name='1564'>
            a_u_bep(i,k,j)=a_u_bep(i,k,j)*frc_urb2d(i,j)<a name='1565'>
            a_v_bep(i,k,j)=a_v_bep(i,k,j)*frc_urb2d(i,j)<a name='1566'>
            a_t_bep(i,k,j)=a_t_bep(i,k,j)*frc_urb2d(i,j)<a name='1567'>
            a_q_bep(i,k,j)=0.        <a name='1568'>
            a_e_bep(i,k,j)=0.<a name='1569'>
            b_u_bep(i,k,j)=b_u_bep(i,k,j)*frc_urb2d(i,j)<a name='1570'>
            b_v_bep(i,k,j)=b_v_bep(i,k,j)*frc_urb2d(i,j)<a name='1571'>
            b_t_bep(i,k,j)=b_t_bep(i,k,j)*frc_urb2d(i,j)<a name='1572'>
            b_q_bep(i,k,j)=b_q_bep(i,k,j)*frc_urb2d(i,j)<a name='1573'>
            b_e_bep(i,k,j)=b_e_bep(i,k,j)*frc_urb2d(i,j)<a name='1574'>
            HFX_URB(I,J)=HFX_URB(I,J)+B_T_BEP(I,K,J)*RHO(I,K,J)*CP*                &amp;<a name='1575'>
                          DZ8W(I,K,J)*VL_BEP(I,K,J)<a name='1576'>
            QFX_URB(I,J)=QFX_URB(I,J)+B_Q_BEP(I,K,J)*               &amp;<a name='1577'>
                          DZ8W(I,K,J)*VL_BEP(I,K,J)<a name='1578'>
            UMOM_URB(I,J)=UMOM_URB(I,J)+ (A_U_BEP(I,K,J)*U_PHY(I,K,J)+             &amp;<a name='1579'>
                          B_U_BEP(I,K,J))*DZ8W(I,K,J)*VL_BEP(I,K,J)<a name='1580'>
            VMOM_URB(I,J)=VMOM_URB(I,J)+ (A_V_BEP(I,K,J)*V_PHY(I,K,J)+             &amp;<a name='1581'>
                          B_V_BEP(I,K,J))*DZ8W(I,K,J)*VL_BEP(I,K,J)<a name='1582'>
            vl_bep(i,k,j)=(1.-frc_urb2d(i,j))+vl_bep(i,k,j)*frc_urb2d(i,j)<a name='1583'>
            sf_bep(i,k,j)=(1.-frc_urb2d(i,j))+sf_bep(i,k,j)*frc_urb2d(i,j)<a name='1584'>
         end do<a name='1585'>
            a_u_bep(i,1,j)=(1.-frc_urb2d(i,j))*(-ust(I,J)*ust(I,J))/dz8w(i,1,j)/   &amp;<a name='1586'>
                           ((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)+a_u_bep(i,1,j)<a name='1587'>
            a_v_bep(i,1,j)=(1.-frc_urb2d(i,j))*(-ust(I,J)*ust(I,J))/dz8w(i,1,j)/   &amp;<a name='1588'>
                           ((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)+a_v_bep(i,1,j)<a name='1589'>
            b_t_bep(i,1,j)=(1.-frc_urb2d(i,j))*hfx_rural(i,j)/dz8w(i,1,j)/rho(i,1,j)/CP+ &amp;<a name='1590'>
                            b_t_bep(i,1,j)<a name='1591'>
            b_q_bep(i,1,j)=(1.-frc_urb2d(i,j))*qfx_rural(i,j)/dz8w(i,1,j)/rho(i,1,j)+b_q_bep(i,1,j)<a name='1592'>
            umom=(1.-frc_urb2d(i,j))*ust(i,j)*ust(i,j)*u_phy(i,1,j)/               &amp;<a name='1593'>
                         ((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)+umom_urb(i,j)<a name='1594'>
            vmom=(1.-frc_urb2d(i,j))*ust(i,j)*ust(i,j)*v_phy(i,1,j)/               &amp;<a name='1595'>
                         ((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)+vmom_urb(i,j)<a name='1596'>
            sf_bep(i,1,j)=1.<a name='1597'>
           <a name='1598'>
<font color=#447700>! compute upward longwave radiation from the rural part and total<a name='1599'></font>
<font color=#447700>!           rl_up_rural=-emiss_rural(i,j)*sigma_sb*(tsk_rural(i,j)**4.)-(1.-emiss_rural(i,j))*glw(i,j)<a name='1600'></font>
<font color=#447700>!           rl_up_tot=(1.-frc_urb2d(i,j))*rl_up_rural+frc_urb2d(i,j)*rl_up_urb(i,j)   <a name='1601'></font>
<font color=#447700>!           emiss(i,j)=(1.-frc_urb2d(i,j))*emiss_rural(i,j)+frc_urb2d(i,j)*emiss_urb(i,j)<a name='1602'></font>
<font color=#447700>! using the emissivity and the total longwave upward radiation estimate the averaged skin temperature<a name='1603'></font>
           IF (FRC_URB2D(I,J).GT.0.) THEN<a name='1604'>
              rl_up_rural=-emiss_rural(i,j)*sigma_sb*(tsk_rural(i,j)**4.)-(1.-emiss_rural(i,j))*glw(i,j)<a name='1605'>
              rl_up_tot=(1.-frc_urb2d(i,j))*rl_up_rural+frc_urb2d(i,j)*rl_up_urb(i,j)   <a name='1606'>
              emiss(i,j)=(1.-frc_urb2d(i,j))*emiss_rural(i,j)+frc_urb2d(i,j)*emiss_urb(i,j)<a name='1607'>
              ts_urb2d(i,j)=(max(0.,(-rl_up_urb(i,j)-(1.-emiss_urb(i,j))*glw(i,j))/emiss_urb(i,j)/sigma_sb))**0.25<a name='1608'>
              tsk(i,j)=(max(0., (-1.*rl_up_tot-(1.-emiss(i,j))*glw(i,j) )/emiss(i,j)/sigma_sb))**.25<a name='1609'>
           rs_abs_tot=(1.-frc_urb2d(i,j))*swdown(i,j)*(1.-albedo(i,j))+frc_urb2d(i,j)*rs_abs_urb(i,j)  <a name='1610'>
          if(swdown(i,j).gt.0.)then<a name='1611'>
           albedo(i,j)=1.-rs_abs_tot/swdown(i,j)<a name='1612'>
          else<a name='1613'>
           albedo(i,j)=alb_rural(i,j)<a name='1614'>
          endif<a name='1615'>
<font color=#447700>! rename *_urb to sh_urb2d,lh_urb2d,g_urb2d,rn_urb2d<a name='1616'></font>
         grdflx(i,j)= (1.-frc_urb2d(i,j))*grdflx_rural(i,j)+frc_urb2d(i,j)*grdflx_urb(i,j) <a name='1617'>
         qfx(i,j)=(1.-frc_urb2d(i,j))*qfx_rural(i,j)+qfx_urb(i,j)<a name='1618'>
<font color=#447700>!        lh(i,j)=(1.-frc_urb2d(i,j))*qfx_rural(i,j)*xlv<a name='1619'></font>
         lh(i,j)=qfx(i,j)*xlv<a name='1620'>
         HFX(I,J) = HFX_URB(I,J)+(1-FRC_URB2D(I,J))*HFX_RURAL(I,J)         <font color=#447700>![W/m/m]<a name='1621'></font>
            SH_URB2D(I,J)    = HFX_URB(I,J)/FRC_URB2D(I,J)<a name='1622'>
            LH_URB2D(I,J)    = qfx_urb(i,j)*xlv<a name='1623'>
            G_URB2D(I,J)     = grdflx_urb(i,j)<a name='1624'>
            RN_URB2D(I,J)    = rs_abs_urb(i,j)+emiss_urb(i,j)*glw(i,j)-rl_up_urb(i,j)<a name='1625'>
            ust(i,j)=(umom**2.+vmom**2.)**.25<a name='1626'>
<font color=#447700>!          if(tsk(i,j).gt.350)write(*,*)'tsk too big!',i,j,tsk(i,j)<a name='1627'></font>
<font color=#447700>!          if(tsk(i,j).lt.260)write(*,*)'tsk too small!',i,j,tsk(i,j),rl_up_tot,rl_up_urb(i,j),rl_up_rural<a name='1628'></font>
<font color=#447700>!                    print*,'ivgtyp,i,j,sigma_sb',ivgtyp(i,j),i,j,sigma_sb<a name='1629'></font>
<font color=#447700>!                    print*,'hfx,lh,qfx,grdflx,ts_urb2d',hfx(i,j),lh(i,j),qfx(i,j),grdflx(i,j),ts_urb2d(i,j)<a name='1630'></font>
<font color=#447700>!                    print*,'tsk,albedo,emiss',tsk(i,j),albedo(i,j),emiss(i,j)<a name='1631'></font>
<font color=#447700>!                if(i.eq.56.and.j.eq.29)then<a name='1632'></font>
<font color=#447700>!                    print*,'ivgtyp, qfx, hfx',ivgtyp(i,j),hfx_rural(i,j),qfx_rural(i,j)<a name='1633'></font>
<font color=#447700>!                    print*,'emiss_rural,emiss_urb',emiss_rural(i,j),emiss_urb(i,j)<a name='1634'></font>
<font color=#447700>!                    print*,'rl_up_rural,rl_up_urb(i,j)',rl_up_rural,rl_up_urb(i,j)<a name='1635'></font>
<font color=#447700>!                    print*,'tsk_rural,ts_urb2d(i,j),tsk',tsk_rural(i,j),ts_urb2d(i,j),tsk(i,j)<a name='1636'></font>
<font color=#447700>!                    print*,'reconstruction fei',((emiss(i,j)*tsk(i,j)**4.-frc_urb2d(i,j)*emiss_urb(i,j)*ts_urb2d(i,j)**4.)/(emiss_rural(i,j)*(1.-frc_urb2d(i,j))))**.25<a name='1637'></font>
<font color=#447700>!                    print*,'ivgtyp,hfx,hfx_urb,hfx_rural',hfx(i,j),hfx_urb(i,j),hfx_rural(i,j)<a name='1638'></font>
<font color=#447700>!                    print*,'lh,lh_rural',lh(i,j),lh_rural(i,j)<a name='1639'></font>
<font color=#447700>!                    print*,'qfx',qfx(i,j)<a name='1640'></font>
<font color=#447700>!                    print*,'ts_urb2d',ts_urb2d(i,j)<a name='1641'></font>
<font color=#447700>!                    print*,'ust',ust(i,j)<a name='1642'></font>
<font color=#447700>!                    print*,'swdown,glw',swdown(i,j),glw(i,j)<a name='1643'></font>
<font color=#447700>!                endif<a name='1644'></font>
            else<a name='1645'>
              SH_URB2D(I,J)    = 0.<a name='1646'>
              LH_URB2D(I,J)    = 0.<a name='1647'>
              G_URB2D(I,J)     = 0.<a name='1648'>
              RN_URB2D(I,J)    = 0.<a name='1649'>
            endif<a name='1650'>
<font color=#447700>!          IF( IVGTYP(I,J) == 1 .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='1651'></font>
<font color=#447700>!                  IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='1652'></font>
<font color=#447700>!                    print*,'ivgtyp, qfx, hfx',ivgtyp(i,j),hfx_rural(i,j),qfx_rural(i,j)<a name='1653'></font>
<font color=#447700>!                    print*,'ivgtyp,hfx,hfx_urb,hfx_rural',hfx(i,j),hfx_urb(i,j),hfx_rural(i,j)<a name='1654'></font>
<font color=#447700>!                    print*,'lh,lh_rural',lh(i,j),lh_rural(i,j)<a name='1655'></font>
<font color=#447700>!                    print*,'qfx',qfx(i,j)<a name='1656'></font>
<font color=#447700>!                    print*,'ts_urb2d',ts_urb2d(i,j)<a name='1657'></font>
<font color=#447700>!                    print*,'ust',ust(i,j)<a name='1658'></font>
<font color=#447700>!          endif<a name='1659'></font>
        enddo<a name='1660'>
        enddo<a name='1661'>
<a name='1662'>
<a name='1663'>
       endif                                                           <font color=#447700>!Bep end<a name='1664'></font>
<a name='1665'>
<font color=#447700>!------------------------------------------------------<a name='1666'></font>
   END SUBROUTINE lsm<a name='1667'>
<font color=#447700>!------------------------------------------------------<a name='1668'></font>
<a name='1669'>
<A NAME='LSMINIT'><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSMINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1670'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>LSMINIT</font>(VEGFRA,SNOW,SNOWC,SNOWH,CANWAT,SMSTAV,    &amp; <A href='../../call_to/LSMINIT.html' TARGET='index'>2</A>,<A href='../../call_from/LSMINIT.html' TARGET='index'>7</A><a name='1671'>
                     SMSTOT, SFCRUNOFF,UDRUNOFF,ACSNOW,        &amp;<a name='1672'>
                     ACSNOM,IVGTYP,ISLTYP,TSLB,SMOIS,SH2O,ZS,DZS, &amp;<a name='1673'>
                     MMINLU,                                   &amp;<a name='1674'>
                     SNOALB, FNDSOILW, FNDSNOWH, RDMAXALB,     &amp;<a name='1675'>
                     num_soil_layers, restart,                 &amp;<a name='1676'>
                     allowed_to_read ,                         &amp;<a name='1677'>
                     ids,ide, jds,jde, kds,kde,                &amp;<a name='1678'>
                     ims,ime, jms,jme, kms,kme,                &amp;<a name='1679'>
                     its,ite, jts,jte, kts,kte                 )<a name='1680'>
<a name='1681'>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='1682'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='1683'>
                                    its,ite, jts,jte, kts,kte<a name='1684'>
<a name='1685'>
   INTEGER, INTENT(IN)       ::     num_soil_layers<a name='1686'>
<a name='1687'>
   LOGICAL , INTENT(IN) :: restart , allowed_to_read<a name='1688'>
<a name='1689'>
   REAL,    DIMENSION( num_soil_layers), INTENT(INOUT) :: ZS, DZS<a name='1690'>
<a name='1691'>
   REAL,    DIMENSION( ims:ime, num_soil_layers, jms:jme )    , &amp;<a name='1692'>
            INTENT(INOUT)    ::                          SMOIS, &amp;  <font color=#447700>!Total soil moisture<a name='1693'></font>
                                                         SH2O,  &amp;  <font color=#447700>!liquid soil moisture<a name='1694'></font>
                                                         TSLB      <font color=#447700>!STEMP<a name='1695'></font>
<a name='1696'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='1697'>
            INTENT(INOUT)    ::                           SNOW, &amp;<a name='1698'>
                                                         SNOWH, &amp;<a name='1699'>
                                                         SNOWC, &amp;<a name='1700'>
                                                        SNOALB, &amp;<a name='1701'>
                                                        CANWAT, &amp;<a name='1702'>
                                                        SMSTAV, &amp;<a name='1703'>
                                                        SMSTOT, &amp;<a name='1704'>
                                                     SFCRUNOFF, &amp;<a name='1705'>
                                                      UDRUNOFF, &amp;<a name='1706'>
                                                        ACSNOW, &amp;<a name='1707'>
                                                        VEGFRA, &amp;<a name='1708'>
                                                        ACSNOM<a name='1709'>
<a name='1710'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='1711'>
            INTENT(IN)       ::                         IVGTYP, &amp;<a name='1712'>
                                                        ISLTYP<a name='1713'>
   CHARACTER(LEN=*),  INTENT(IN)      ::                MMINLU<a name='1714'>
<a name='1715'>
   LOGICAL, INTENT(IN)       ::                      FNDSOILW , &amp;<a name='1716'>
                                                     FNDSNOWH<a name='1717'>
   LOGICAL, INTENT(IN)       ::                      RDMAXALB<a name='1718'>
<a name='1719'>
<a name='1720'>
   INTEGER                   :: L<a name='1721'>
   REAL                      :: BX, SMCMAX, PSISAT, FREE<a name='1722'>
   REAL, PARAMETER           :: BLIM = 5.5, HLICE = 3.335E5,    &amp;<a name='1723'>
                                GRAV = 9.81, T0 = 273.15<a name='1724'>
   INTEGER                   :: errflag<a name='1725'>
   CHARACTER(LEN=80)         :: err_message<a name='1726'>
<a name='1727'>
   character*256 :: MMINSL<a name='1728'>
        MMINSL='STAS'<a name='1729'>
<font color=#447700>!<a name='1730'></font>
<a name='1731'>
<font color=#447700>! initialize three Noah LSM related tables<a name='1732'></font>
   IF ( allowed_to_read ) THEN<a name='1733'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_911">( 'INITIALIZE THREE Noah LSM RELATED TABLES' )<a name='1734'>
     CALL  <A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM'>SOIL_VEG_GEN_PARM</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_VEG_GEN_PARM_1">( MMINLU, MMINSL )<a name='1735'>
   ENDIF<a name='1736'>
<a name='1737'>
<font color=#447700>! GAC--&gt;<a name='1738'></font>
<font color=#447700>! 20130219 - No longer need these - see module_data_gocart_dust<a name='1739'></font>
<font color=#447700>!#if ( WRF_CHEM == 1 )<a name='1740'></font>
<font color=#447700>!!<a name='1741'></font>
<font color=#447700>!! need this parameter for dust parameterization in wrf/chem<a name='1742'></font>
<font color=#447700>!!<a name='1743'></font>
<font color=#447700>!   do I=1,NSLTYPE<a name='1744'></font>
<font color=#447700>!      porosity(i)=maxsmc(i)<a name='1745'></font>
<font color=#447700>!      drypoint(i)=drysmc(i)<a name='1746'></font>
<font color=#447700>!   enddo<a name='1747'></font>
<font color=#447700>!#endif<a name='1748'></font>
<font color=#447700>! &lt;--GAC<a name='1749'></font>
<a name='1750'>
   IF(.not.restart)THEN<a name='1751'>
<a name='1752'>
   itf=min0(ite,ide-1)<a name='1753'>
   jtf=min0(jte,jde-1)<a name='1754'>
<a name='1755'>
   errflag = 0<a name='1756'>
   DO j = jts,jtf<a name='1757'>
     DO i = its,itf<a name='1758'>
       IF ( ISLTYP( i,j ) .LT. 1 ) THEN<a name='1759'>
         errflag = 1<a name='1760'>
         WRITE(err_message,*)"module_sf_noahdrv.F: lsminit: out of range ISLTYP ",i,j,ISLTYP( i,j )<a name='1761'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_912">(err_message)<a name='1762'>
       ENDIF<a name='1763'>
       IF(.not.RDMAXALB) THEN<a name='1764'>
          SNOALB(i,j)=MAXALB(IVGTYP(i,j))*0.01<a name='1765'>
       ENDIF<a name='1766'>
     ENDDO<a name='1767'>
   ENDDO<a name='1768'>
   IF ( errflag .EQ. 1 ) THEN<a name='1769'>
#if ( HWRF == 1 ) <a name='1770'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_913">( "WARNING: message only; was fatal. module_sf_noahdrv.F: lsminit: out of range value "// &amp;<a name='1771'>
                            "of ISLTYP. Is this field in the input?" )<a name='1772'>
#else<a name='1773'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1156">( "module_sf_noahdrv.F: lsminit: out of range value "// &amp;<a name='1774'>
                            "of ISLTYP. Is this field in the input?" )<a name='1775'>
#endif<a name='1776'>
   ENDIF<a name='1777'>
<a name='1778'>
<font color=#447700>! initialize soil liquid water content SH2O<a name='1779'></font>
<a name='1780'>
<font color=#447700>!  IF(.NOT.FNDSOILW) THEN<a name='1781'></font>
<a name='1782'>
<font color=#447700>! If no SWC, do the following<a name='1783'></font>
<font color=#447700>!         PRINT *,'SOIL WATER NOT FOUND - VALUE SET IN LSMINIT'<a name='1784'></font>
        DO J = jts,jtf<a name='1785'>
        DO I = its,itf<a name='1786'>
          BX = BB(ISLTYP(I,J))<a name='1787'>
          SMCMAX = MAXSMC(ISLTYP(I,J))<a name='1788'>
          PSISAT = SATPSI(ISLTYP(I,J))<a name='1789'>
         if ((bx &gt; 0.0).and.(smcmax &gt; 0.0).and.(psisat &gt; 0.0)) then<a name='1790'>
          DO NS=1, num_soil_layers<a name='1791'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1792'></font>
<font color=#447700>!SH2O  &lt;= SMOIS for T &lt; 273.149K (-0.001C)<a name='1793'></font>
             IF (TSLB(I,NS,J) &lt; 273.149) THEN<a name='1794'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1795'></font>
<font color=#447700>! first guess following explicit solution for Flerchinger Eqn from Koren<a name='1796'></font>
<font color=#447700>! et al, JGR, 1999, Eqn 17 (KCOUNT=0 in FUNCTION FRH2O).<a name='1797'></font>
<font color=#447700>! ISLTPK is soil type<a name='1798'></font>
              BX = BB(ISLTYP(I,J))<a name='1799'>
              SMCMAX = MAXSMC(ISLTYP(I,J))<a name='1800'>
              PSISAT = SATPSI(ISLTYP(I,J))<a name='1801'>
              IF ( BX &gt;  BLIM ) BX = BLIM<a name='1802'>
              FK=(( (HLICE/(GRAV*(-PSISAT))) *                              &amp;<a name='1803'>
                 ((TSLB(I,NS,J)-T0)/TSLB(I,NS,J)) )**(-1/BX) )*SMCMAX<a name='1804'>
              IF (FK &lt; 0.02) FK = 0.02<a name='1805'>
              SH2O(I,NS,J) = MIN( FK, SMOIS(I,NS,J) )<a name='1806'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1807'></font>
<font color=#447700>! now use iterative solution for liquid soil water content using<a name='1808'></font>
<font color=#447700>! FUNCTION FRH2O with the initial guess for SH2O from above explicit<a name='1809'></font>
<font color=#447700>! first guess.<a name='1810'></font>
              CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#FRH2O'>FRH2O</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FRH2O_1"> (FREE,TSLB(I,NS,J),SMOIS(I,NS,J),SH2O(I,NS,J),    &amp;<a name='1811'>
                 SMCMAX,BX,PSISAT)<a name='1812'>
              SH2O(I,NS,J) = FREE<a name='1813'>
             ELSE             <font color=#447700>! of IF (TSLB(I,NS,J)<a name='1814'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1815'></font>
<font color=#447700>! SH2O = SMOIS ( for T =&gt; 273.149K (-0.001C)<a name='1816'></font>
              SH2O(I,NS,J)=SMOIS(I,NS,J)<a name='1817'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1818'></font>
             ENDIF            <font color=#447700>! of IF (TSLB(I,NS,J)<a name='1819'></font>
          END DO              <font color=#447700>! of DO NS=1, num_soil_layers<a name='1820'></font>
         else                 <font color=#447700>! of if ((bx &gt; 0.0)<a name='1821'></font>
          DO NS=1, num_soil_layers<a name='1822'>
           SH2O(I,NS,J)=SMOIS(I,NS,J)<a name='1823'>
          END DO<a name='1824'>
         endif                <font color=#447700>! of if ((bx &gt; 0.0)<a name='1825'></font>
        ENDDO                 <font color=#447700>! DO I = its,itf<a name='1826'></font>
        ENDDO                 <font color=#447700>! DO J = jts,jtf<a name='1827'></font>
<font color=#447700>!  ENDIF                       ! of IF(.NOT.FNDSOILW)THEN<a name='1828'></font>
<a name='1829'>
<font color=#447700>! initialize physical snow height SNOWH<a name='1830'></font>
<a name='1831'>
        IF(.NOT.FNDSNOWH)THEN<a name='1832'>
<font color=#447700>! If no SNOWH do the following<a name='1833'></font>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSMINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_914">( 'SNOW HEIGHT NOT FOUND - VALUE DEFINED IN LSMINIT' )<a name='1834'>
          DO J = jts,jtf<a name='1835'>
          DO I = its,itf<a name='1836'>
            SNOWH(I,J)=SNOW(I,J)*0.005               <font color=#447700>! SNOW in mm and SNOWH in m<a name='1837'></font>
          ENDDO<a name='1838'>
          ENDDO<a name='1839'>
        ENDIF<a name='1840'>
<a name='1841'>
<font color=#447700>! initialize canopy water to ZERO<a name='1842'></font>
<a name='1843'>
<font color=#447700>!          GO TO 110<a name='1844'></font>
<font color=#447700>!         print*,'Note that canopy water content (CANWAT) is set to ZERO in LSMINIT'<a name='1845'></font>
          DO J = jts,jtf<a name='1846'>
          DO I = its,itf<a name='1847'>
            CANWAT(I,J)=0.0<a name='1848'>
          ENDDO<a name='1849'>
          ENDDO<a name='1850'>
 110      CONTINUE<a name='1851'>
<a name='1852'>
   ENDIF<a name='1853'>
<font color=#447700>!------------------------------------------------------------------------------<a name='1854'></font>
  END SUBROUTINE lsminit<a name='1855'>
<font color=#447700>!------------------------------------------------------------------------------<a name='1856'></font>
<a name='1857'>
<a name='1858'>
<a name='1859'>
<font color=#447700>!-----------------------------------------------------------------<a name='1860'></font>
<A NAME='SOIL_VEG_GEN_PARM'><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1861'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>SOIL_VEG_GEN_PARM</font>( MMINLU, MMINSL) <A href='../../call_to/SOIL_VEG_GEN_PARM.html' TARGET='index'>1</A>,<A href='../../call_from/SOIL_VEG_GEN_PARM.html' TARGET='index'>78</A><a name='1862'>
<font color=#447700>!-----------------------------------------------------------------<a name='1863'></font>
<a name='1864'>
        USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_88"><a name='1865'>
        IMPLICIT NONE<a name='1866'>
<a name='1867'>
        CHARACTER(LEN=*), INTENT(IN) :: MMINLU, MMINSL<a name='1868'>
        integer :: LUMATCH, IINDEX, LC, NUM_SLOPE<a name='1869'>
        integer :: ierr<a name='1870'>
        INTEGER , PARAMETER :: OPEN_OK = 0<a name='1871'>
<a name='1872'>
        character*128 :: mess , message<a name='1873'>
        character*256 :: a_string<a name='1874'>
        logical, external :: wrf_dm_on_monitor<a name='1875'>
        integer , parameter :: loop_max   = 10<a name='1876'>
        integer             :: loop_count<a name='1877'>
<a name='1878'>
<a name='1879'>
<font color=#447700>!-----SPECIFY VEGETATION RELATED CHARACTERISTICS :<a name='1880'></font>
<font color=#447700>!             ALBBCK: SFC albedo (in percentage)<a name='1881'></font>
<font color=#447700>!                 Z0: Roughness length (m)<a name='1882'></font>
<font color=#447700>!             SHDFAC: Green vegetation fraction (in percentage)<a name='1883'></font>
<font color=#447700>!  Note: The ALBEDO, Z0, and SHDFAC values read from the following table<a name='1884'></font>
<font color=#447700>!          ALBEDO, amd Z0 are specified in LAND-USE TABLE; and SHDFAC is<a name='1885'></font>
<font color=#447700>!          the monthly green vegetation data<a name='1886'></font>
<font color=#447700>!             CMXTBL: MAX CNPY Capacity (m)<a name='1887'></font>
<font color=#447700>!             NROTBL: Rooting depth (layer)<a name='1888'></font>
<font color=#447700>!              RSMIN: Mimimum stomatal resistance (s m-1)<a name='1889'></font>
<font color=#447700>!              RSMAX: Max. stomatal resistance (s m-1)<a name='1890'></font>
<font color=#447700>!                RGL: Parameters used in radiation stress function<a name='1891'></font>
<font color=#447700>!                 HS: Parameter used in vapor pressure deficit functio<a name='1892'></font>
<font color=#447700>!               TOPT: Optimum transpiration air temperature. (K)<a name='1893'></font>
<font color=#447700>!             CMCMAX: Maximum canopy water capacity<a name='1894'></font>
<font color=#447700>!             CFACTR: Parameter used in the canopy inteception calculati<a name='1895'></font>
<font color=#447700>!               SNUP: Threshold snow depth (in water equivalent m) that<a name='1896'></font>
<font color=#447700>!                     implies 100% snow cover<a name='1897'></font>
<font color=#447700>!                LAI: Leaf area index (dimensionless)<a name='1898'></font>
<font color=#447700>!             MAXALB: Upper bound on maximum albedo over deep snow<a name='1899'></font>
<font color=#447700>!<a name='1900'></font>
<font color=#447700>!-----READ IN VEGETAION PROPERTIES FROM VEGPARM.TBL<a name='1901'></font>
<font color=#447700>!<a name='1902'></font>
<a name='1903'>
       IF ( wrf_dm_on_monitor() ) THEN<a name='1904'>
<a name='1905'>
        OPEN(19, FILE='VEGPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)<a name='1906'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='1907'>
          WRITE(message,FMT='(A)') &amp;<a name='1908'>
          'module_sf_noahlsm.F: soil_veg_gen_parm: failure opening VEGPARM.TBL'<a name='1909'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1157"> ( message )<a name='1910'>
        END IF<a name='1911'>
<a name='1912'>
<a name='1913'>
        LUMATCH=0<a name='1914'>
<a name='1915'>
        loop_count = 0<a name='1916'>
        READ (19,FMT='(A)',END=2002) a_string<a name='1917'>
        FIND_LUTYPE : DO WHILE (LUMATCH == 0)<a name='1918'>
           READ (19,*,END=2002)LUTYPE<a name='1919'>
           READ (19,*)LUCATS,IINDEX<a name='1920'>
<a name='1921'>
           IF(LUTYPE.EQ.MMINLU)THEN<a name='1922'>
              WRITE( mess , * ) 'LANDUSE TYPE = ' // TRIM ( LUTYPE ) // ' FOUND', LUCATS,' CATEGORIES'<a name='1923'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_915">( mess )<a name='1924'>
              LUMATCH=1<a name='1925'>
           ELSE<a name='1926'>
              loop_count = loop_count+1<a name='1927'>
              call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_916"> ( "Skipping over LUTYPE = " // TRIM ( LUTYPE ) )<a name='1928'>
              FIND_VEGETATION_PARAMETER_FLAG : DO<a name='1929'>
                 READ (19,FMT='(A)', END=2002) a_string<a name='1930'>
                 IF ( a_string(1:21) .EQ. 'Vegetation Parameters' ) THEN<a name='1931'>
                    EXIT FIND_VEGETATION_PARAMETER_FLAG<a name='1932'>
                 ELSE IF ( loop_count .GE. loop_max ) THEN<a name='1933'>
                    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1158"> ( 'Too many loops in VEGPARM.TBL')<a name='1934'>
                 ENDIF<a name='1935'>
              ENDDO FIND_VEGETATION_PARAMETER_FLAG<a name='1936'>
           ENDIF<a name='1937'>
        ENDDO FIND_LUTYPE<a name='1938'>
<font color=#447700>! prevent possible array overwrite, Bill Bovermann, IBM, May 6, 2008<a name='1939'></font>
        IF ( SIZE(SHDTBL)       &lt; LUCATS .OR. &amp;<a name='1940'>
             SIZE(NROTBL)       &lt; LUCATS .OR. &amp;<a name='1941'>
             SIZE(RSTBL)        &lt; LUCATS .OR. &amp;<a name='1942'>
             SIZE(RGLTBL)       &lt; LUCATS .OR. &amp;<a name='1943'>
             SIZE(HSTBL)        &lt; LUCATS .OR. &amp;<a name='1944'>
             SIZE(SNUPTBL)      &lt; LUCATS .OR. &amp;<a name='1945'>
             SIZE(MAXALB)       &lt; LUCATS .OR. &amp;<a name='1946'>
             SIZE(LAIMINTBL)    &lt; LUCATS .OR. &amp;<a name='1947'>
             SIZE(LAIMAXTBL)    &lt; LUCATS .OR. &amp;<a name='1948'>
             SIZE(Z0MINTBL)     &lt; LUCATS .OR. &amp;<a name='1949'>
             SIZE(Z0MAXTBL)     &lt; LUCATS .OR. &amp;<a name='1950'>
             SIZE(ALBEDOMINTBL) &lt; LUCATS .OR. &amp;<a name='1951'>
             SIZE(ALBEDOMAXTBL) &lt; LUCATS .OR. &amp;<a name='1952'>
             SIZE(ZTOPVTBL) &lt; LUCATS .OR. &amp;<a name='1953'>
             SIZE(ZBOTVTBL) &lt; LUCATS .OR. &amp;<a name='1954'>
             SIZE(EMISSMINTBL ) &lt; LUCATS .OR. &amp;<a name='1955'>
             SIZE(EMISSMAXTBL ) &lt; LUCATS ) THEN<a name='1956'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1159">('Table sizes too small for value of LUCATS in module_sf_noahdrv.F')<a name='1957'>
        ENDIF<a name='1958'>
<a name='1959'>
        IF(LUTYPE.EQ.MMINLU)THEN<a name='1960'>
          DO LC=1,LUCATS<a name='1961'>
              READ (19,*)IINDEX,SHDTBL(LC),                        &amp;<a name='1962'>
                        NROTBL(LC),RSTBL(LC),RGLTBL(LC),HSTBL(LC), &amp;<a name='1963'>
                        SNUPTBL(LC),MAXALB(LC), LAIMINTBL(LC),     &amp;<a name='1964'>
                        LAIMAXTBL(LC),EMISSMINTBL(LC),             &amp;<a name='1965'>
                        EMISSMAXTBL(LC), ALBEDOMINTBL(LC),         &amp;<a name='1966'>
                        ALBEDOMAXTBL(LC), Z0MINTBL(LC), Z0MAXTBL(LC),&amp;<a name='1967'>
			ZTOPVTBL(LC), ZBOTVTBL(LC)<a name='1968'>
          ENDDO<a name='1969'>
<font color=#447700>!<a name='1970'></font>
          READ (19,*)<a name='1971'>
          READ (19,*)TOPT_DATA<a name='1972'>
          READ (19,*)<a name='1973'>
          READ (19,*)CMCMAX_DATA<a name='1974'>
          READ (19,*)<a name='1975'>
          READ (19,*)CFACTR_DATA<a name='1976'>
          READ (19,*)<a name='1977'>
          READ (19,*)RSMAX_DATA<a name='1978'>
          READ (19,*)<a name='1979'>
          READ (19,*)BARE<a name='1980'>
          READ (19,*)<a name='1981'>
          READ (19,*)NATURAL<a name='1982'>
          READ (19,*)<a name='1983'>
          READ (19,*)<a name='1984'>
          READ (19,FMT='(A)') a_string<a name='1985'>
          IF ( a_string(1:21) .EQ. 'Vegetation Parameters' ) THEN<a name='1986'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_917">     ("Expected low and high density residential, and high density industrial information in VEGPARM.TBL")<a name='1987'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1160"> ("This could be caused by using an older VEGPARM.TBL file with a newer WRF source code.")<a name='1988'>
          ENDIF<a name='1989'>
          READ (19,*)LOW_DENSITY_RESIDENTIAL<a name='1990'>
          READ (19,*)<a name='1991'>
          READ (19,*)HIGH_DENSITY_RESIDENTIAL<a name='1992'>
          READ (19,*)<a name='1993'>
          READ (19,*)HIGH_INTENSITY_INDUSTRIAL<a name='1994'>
        ENDIF<a name='1995'>
<font color=#447700>!<a name='1996'></font>
 2002   CONTINUE<a name='1997'>
<a name='1998'>
        CLOSE (19)<a name='1999'>
        IF (LUMATCH == 0) then<a name='2000'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1161"> ("Land Use Dataset '"//MMINLU//"' not found in VEGPARM.TBL.")<a name='2001'>
        ENDIF<a name='2002'>
      ENDIF<a name='2003'>
<a name='2004'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_13">  ( LUTYPE  , 4 )<a name='2005'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_37"> ( LUCATS  , 1 )<a name='2006'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_38"> ( IINDEX  , 1 )<a name='2007'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_39"> ( LUMATCH , 1 )<a name='2008'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_61">    ( SHDTBL  , NLUS )<a name='2009'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_62">    ( NROTBL  , NLUS )<a name='2010'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_63">    ( RSTBL   , NLUS )<a name='2011'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_64">    ( RGLTBL  , NLUS )<a name='2012'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_65">    ( HSTBL   , NLUS )<a name='2013'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_66">    ( SNUPTBL , NLUS )<a name='2014'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_67">    ( LAIMINTBL    , NLUS )<a name='2015'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_68">    ( LAIMAXTBL    , NLUS )<a name='2016'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_69">    ( Z0MINTBL     , NLUS )<a name='2017'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_70">    ( Z0MAXTBL     , NLUS )<a name='2018'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_71">    ( EMISSMINTBL  , NLUS )<a name='2019'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_72">    ( EMISSMAXTBL  , NLUS )<a name='2020'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_73">    ( ALBEDOMINTBL , NLUS )<a name='2021'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_74">    ( ALBEDOMAXTBL , NLUS )<a name='2022'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_75">    ( ZTOPVTBL , NLUS )<a name='2023'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_76">    ( ZBOTVTBL , NLUS )<a name='2024'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_77">    ( MAXALB  , NLUS )<a name='2025'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_78">    ( TOPT_DATA    , 1 )<a name='2026'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_79">    ( CMCMAX_DATA  , 1 )<a name='2027'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_80">    ( CFACTR_DATA  , 1 )<a name='2028'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_81">    ( RSMAX_DATA  , 1 )<a name='2029'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_40"> ( BARE    , 1 )<a name='2030'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_41"> ( NATURAL , 1 )<a name='2031'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_42"> ( LOW_DENSITY_RESIDENTIAL , 1 )<a name='2032'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_43"> ( HIGH_DENSITY_RESIDENTIAL , 1 )<a name='2033'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_44"> ( HIGH_INTENSITY_INDUSTRIAL , 1 )<a name='2034'>
<a name='2035'>
<font color=#447700>!<a name='2036'></font>
<font color=#447700>!-----READ IN SOIL PROPERTIES FROM SOILPARM.TBL<a name='2037'></font>
<font color=#447700>!<a name='2038'></font>
      IF ( wrf_dm_on_monitor() ) THEN<a name='2039'>
        OPEN(19, FILE='SOILPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)<a name='2040'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='2041'>
          WRITE(message,FMT='(A)') &amp;<a name='2042'>
          'module_sf_noahlsm.F: soil_veg_gen_parm: failure opening SOILPARM.TBL'<a name='2043'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1162"> ( message )<a name='2044'>
        END IF<a name='2045'>
<a name='2046'>
        WRITE(mess,*) 'INPUT SOIL TEXTURE CLASSIFICATION = ', TRIM ( MMINSL )<a name='2047'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_918">( mess )<a name='2048'>
<a name='2049'>
        LUMATCH=0<a name='2050'>
<a name='2051'>
        READ (19,*)<a name='2052'>
        READ (19,2000,END=2003)SLTYPE<a name='2053'>
 2000   FORMAT (A4)<a name='2054'>
        READ (19,*)SLCATS,IINDEX<a name='2055'>
        IF(SLTYPE.EQ.MMINSL)THEN<a name='2056'>
            WRITE( mess , * ) 'SOIL TEXTURE CLASSIFICATION = ', TRIM ( SLTYPE ) , ' FOUND', &amp;<a name='2057'>
                  SLCATS,' CATEGORIES'<a name='2058'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_919"> ( mess )<a name='2059'>
          LUMATCH=1<a name='2060'>
        ENDIF<a name='2061'>
<font color=#447700>! prevent possible array overwrite, Bill Bovermann, IBM, May 6, 2008<a name='2062'></font>
        IF ( SIZE(BB    ) &lt; SLCATS .OR. &amp;<a name='2063'>
             SIZE(DRYSMC) &lt; SLCATS .OR. &amp;<a name='2064'>
             SIZE(F11   ) &lt; SLCATS .OR. &amp;<a name='2065'>
             SIZE(MAXSMC) &lt; SLCATS .OR. &amp;<a name='2066'>
             SIZE(REFSMC) &lt; SLCATS .OR. &amp;<a name='2067'>
             SIZE(SATPSI) &lt; SLCATS .OR. &amp;<a name='2068'>
             SIZE(SATDK ) &lt; SLCATS .OR. &amp;<a name='2069'>
             SIZE(SATDW ) &lt; SLCATS .OR. &amp;<a name='2070'>
             SIZE(WLTSMC) &lt; SLCATS .OR. &amp;<a name='2071'>
             SIZE(QTZ   ) &lt; SLCATS  ) THEN<a name='2072'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1163">('Table sizes too small for value of SLCATS in module_sf_noahdrv.F')<a name='2073'>
        ENDIF<a name='2074'>
        IF(SLTYPE.EQ.MMINSL)THEN<a name='2075'>
          DO LC=1,SLCATS<a name='2076'>
              READ (19,*) IINDEX,BB(LC),DRYSMC(LC),F11(LC),MAXSMC(LC),&amp;<a name='2077'>
                        REFSMC(LC),SATPSI(LC),SATDK(LC), SATDW(LC),   &amp;<a name='2078'>
                        WLTSMC(LC), QTZ(LC)<a name='2079'>
          ENDDO<a name='2080'>
        ENDIF<a name='2081'>
<a name='2082'>
 2003   CONTINUE<a name='2083'>
<a name='2084'>
        CLOSE (19)<a name='2085'>
      ENDIF<a name='2086'>
<a name='2087'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_45"> ( LUMATCH , 1 )<a name='2088'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_14">  ( SLTYPE  , 4 )<a name='2089'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING'>wrf_dm_bcast_string</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_STRING_15">  ( MMINSL  , 4 )  <font color=#447700>! since this is reset above, see oct2 ^<a name='2090'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_46"> ( SLCATS  , 1 )<a name='2091'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_47"> ( IINDEX  , 1 )<a name='2092'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_82">    ( BB      , NSLTYPE )<a name='2093'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_83">    ( DRYSMC  , NSLTYPE )<a name='2094'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_84">    ( F11     , NSLTYPE )<a name='2095'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_85">    ( MAXSMC  , NSLTYPE )<a name='2096'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_86">    ( REFSMC  , NSLTYPE )<a name='2097'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_87">    ( SATPSI  , NSLTYPE )<a name='2098'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_88">    ( SATDK   , NSLTYPE )<a name='2099'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_89">    ( SATDW   , NSLTYPE )<a name='2100'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_90">    ( WLTSMC  , NSLTYPE )<a name='2101'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_91">    ( QTZ     , NSLTYPE )<a name='2102'>
<a name='2103'>
      IF(LUMATCH.EQ.0)THEN<a name='2104'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_920">( 'SOIl TEXTURE IN INPUT FILE DOES NOT ' )<a name='2105'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_921">( 'MATCH SOILPARM TABLE'                 )<a name='2106'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1164"> ( 'INCONSISTENT OR MISSING SOILPARM FILE' )<a name='2107'>
      ENDIF<a name='2108'>
<a name='2109'>
<font color=#447700>!<a name='2110'></font>
<font color=#447700>!-----READ IN GENERAL PARAMETERS FROM GENPARM.TBL<a name='2111'></font>
<font color=#447700>!<a name='2112'></font>
      IF ( wrf_dm_on_monitor() ) THEN<a name='2113'>
        OPEN(19, FILE='GENPARM.TBL',FORM='FORMATTED',STATUS='OLD',IOSTAT=ierr)<a name='2114'>
        IF(ierr .NE. OPEN_OK ) THEN<a name='2115'>
          WRITE(message,FMT='(A)') &amp;<a name='2116'>
          'module_sf_noahlsm.F: soil_veg_gen_parm: failure opening GENPARM.TBL'<a name='2117'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1165"> ( message )<a name='2118'>
        END IF<a name='2119'>
<a name='2120'>
        READ (19,*)<a name='2121'>
        READ (19,*)<a name='2122'>
        READ (19,*) NUM_SLOPE<a name='2123'>
<a name='2124'>
          SLPCATS=NUM_SLOPE<a name='2125'>
<font color=#447700>! prevent possible array overwrite, Bill Bovermann, IBM, May 6, 2008<a name='2126'></font>
          IF ( SIZE(slope_data) &lt; NUM_SLOPE ) THEN<a name='2127'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1166">('NUM_SLOPE too large for slope_data array in module_sf_noahdrv')<a name='2128'>
          ENDIF<a name='2129'>
<a name='2130'>
          DO LC=1,SLPCATS<a name='2131'>
              READ (19,*)SLOPE_DATA(LC)<a name='2132'>
          ENDDO<a name='2133'>
<a name='2134'>
          READ (19,*)<a name='2135'>
          READ (19,*)SBETA_DATA<a name='2136'>
          READ (19,*)<a name='2137'>
          READ (19,*)FXEXP_DATA<a name='2138'>
          READ (19,*)<a name='2139'>
          READ (19,*)CSOIL_DATA<a name='2140'>
          READ (19,*)<a name='2141'>
          READ (19,*)SALP_DATA<a name='2142'>
          READ (19,*)<a name='2143'>
          READ (19,*)REFDK_DATA<a name='2144'>
          READ (19,*)<a name='2145'>
          READ (19,*)REFKDT_DATA<a name='2146'>
          READ (19,*)<a name='2147'>
          READ (19,*)FRZK_DATA<a name='2148'>
          READ (19,*)<a name='2149'>
          READ (19,*)ZBOT_DATA<a name='2150'>
          READ (19,*)<a name='2151'>
          READ (19,*)CZIL_DATA<a name='2152'>
          READ (19,*)<a name='2153'>
          READ (19,*)SMLOW_DATA<a name='2154'>
          READ (19,*)<a name='2155'>
          READ (19,*)SMHIGH_DATA<a name='2156'>
          READ (19,*)<a name='2157'>
          READ (19,*)LVCOEF_DATA<a name='2158'>
        CLOSE (19)<a name='2159'>
      ENDIF<a name='2160'>
<a name='2161'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_48"> ( NUM_SLOPE    ,  1 )<a name='2162'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_49"> ( SLPCATS      ,  1 )<a name='2163'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_92">    ( SLOPE_DATA   ,  NSLOPE )<a name='2164'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_93">    ( SBETA_DATA   ,  1 )<a name='2165'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_94">    ( FXEXP_DATA   ,  1 )<a name='2166'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_95">    ( CSOIL_DATA   ,  1 )<a name='2167'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_96">    ( SALP_DATA    ,  1 )<a name='2168'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_97">    ( REFDK_DATA   ,  1 )<a name='2169'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_98">    ( REFKDT_DATA  ,  1 )<a name='2170'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_99">    ( FRZK_DATA    ,  1 )<a name='2171'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_100">    ( ZBOT_DATA    ,  1 )<a name='2172'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_101">    ( CZIL_DATA    ,  1 )<a name='2173'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_102">    ( SMLOW_DATA   ,  1 )<a name='2174'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_103">    ( SMHIGH_DATA  ,  1 )<a name='2175'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#SOIL_VEG_GEN_PARM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_104">    ( LVCOEF_DATA  ,  1 )<a name='2176'>
<a name='2177'>
<a name='2178'>
<font color=#447700>!-----------------------------------------------------------------<a name='2179'></font>
      END SUBROUTINE SOIL_VEG_GEN_PARM<a name='2180'>
<font color=#447700>!-----------------------------------------------------------------<a name='2181'></font>
<a name='2182'>
<font color=#447700>!===========================================================================<a name='2183'></font>
<font color=#447700>!<a name='2184'></font>
<font color=#447700>! subroutine lsm_mosaic: a tiling approach for Noah LSM<a name='2185'></font>
<font color=#447700>!<a name='2186'></font>
<font color=#447700>!=========================================================================== <a name='2187'></font>
<a name='2188'>
<A NAME='LSM_MOSAIC'><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2189'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>lsm_mosaic</font>(DZ8W,QV3D,P8W3D,T3D,TSK,                      &amp; <A href='../../call_to/LSM_MOSAIC.html' TARGET='index'>1</A>,<A href='../../call_from/LSM_MOSAIC.html' TARGET='index'>14</A><a name='2190'>
                  HFX,QFX,LH,GRDFLX, QGH,GSW,SWDOWN,GLW,SMSTAV,SMSTOT, &amp;<a name='2191'>
                  SFCRUNOFF, UDRUNOFF,IVGTYP,ISLTYP,ISURBAN,ISICE,VEGFRA,    &amp;<a name='2192'>
                  ALBEDO,ALBBCK,ZNT,Z0,TMN,XLAND,XICE,EMISS,EMBCK,   &amp;<a name='2193'>
                  SNOWC,QSFC,RAINBL,MMINLU,                     &amp;<a name='2194'>
                  num_soil_layers,DT,DZS,ITIMESTEP,             &amp;<a name='2195'>
                  SMOIS,TSLB,SNOW,CANWAT,                       &amp;<a name='2196'>
                  CHS,CHS2,CQS2,CPM,ROVCP,SR,chklowq,lai,qz0,   &amp; <font color=#447700>!H<a name='2197'></font>
                  myj,frpcpn,                                   &amp;<a name='2198'>
                  SH2O,SNOWH,                                   &amp; <font color=#447700>!H<a name='2199'></font>
                  U_PHY,V_PHY,                                  &amp; <font color=#447700>!I<a name='2200'></font>
                  SNOALB,SHDMIN,SHDMAX,                         &amp; <font color=#447700>!I<a name='2201'></font>
                  SNOTIME,                                      &amp; <font color=#447700>!?<a name='2202'></font>
                  ACSNOM,ACSNOW,                                &amp; <font color=#447700>!O<a name='2203'></font>
                  SNOPCX,                                       &amp; <font color=#447700>!O<a name='2204'></font>
                  POTEVP,                                       &amp; <font color=#447700>!O<a name='2205'></font>
                  SMCREL,                                       &amp; <font color=#447700>!O<a name='2206'></font>
                  XICE_THRESHOLD,                               &amp;<a name='2207'>
                  RDLAI2D,USEMONALB,                            &amp;<a name='2208'>
                  RIB,                                          &amp; <font color=#447700>!?<a name='2209'></font>
                  NOAHRES,OPT_THCND,                            &amp;<a name='2210'>
                 NLCAT,landusef,landusef2,                       &amp; <font color=#447700>! danli mosaic<a name='2211'></font>
                 sf_surface_mosaic,mosaic_cat,mosaic_cat_index,  &amp; <font color=#447700>! danli mosaic <a name='2212'></font>
                 TSK_mosaic,QSFC_mosaic,                         &amp; <font color=#447700>! danli mosaic <a name='2213'></font>
                 TSLB_mosaic,SMOIS_mosaic,SH2O_mosaic,           &amp; <font color=#447700>! danli mosaic <a name='2214'></font>
                 CANWAT_mosaic,SNOW_mosaic,                      &amp; <font color=#447700>! danli mosaic<a name='2215'></font>
                 SNOWH_mosaic,SNOWC_mosaic,                      &amp; <font color=#447700>! danli mosaic <a name='2216'></font>
                 ALBEDO_mosaic,ALBBCK_mosaic,                    &amp; <font color=#447700>! danli mosaic<a name='2217'></font>
                 EMISS_mosaic, EMBCK_mosaic,                     &amp; <font color=#447700>! danli mosaic<a name='2218'></font>
                 ZNT_mosaic, Z0_mosaic,                          &amp; <font color=#447700>! danli mosaic <a name='2219'></font>
                 HFX_mosaic,QFX_mosaic,                          &amp; <font color=#447700>! danli mosaic<a name='2220'></font>
                 LH_mosaic, GRDFLX_mosaic, SNOTIME_mosaic,       &amp; <font color=#447700>! danli mosaic                   <a name='2221'></font>
<font color=#447700>! Noah UA changes<a name='2222'></font>
                  ua_phys,flx4_2d,fvb_2d,fbur_2d,fgsn_2d,       &amp;<a name='2223'>
                  ids,ide, jds,jde, kds,kde,                    &amp;<a name='2224'>
                  ims,ime, jms,jme, kms,kme,                    &amp;<a name='2225'>
                  its,ite, jts,jte, kts,kte,                    &amp;<a name='2226'>
                  sf_urban_physics,                             &amp;<a name='2227'>
                  CMR_SFCDIF,CHR_SFCDIF,CMC_SFCDIF,CHC_SFCDIF,  &amp;<a name='2228'>
                  CMGR_SFCDIF,CHGR_SFCDIF,                      &amp;<a name='2229'>
<font color=#447700>!Optional Urban<a name='2230'></font>
                  TR_URB2D,TB_URB2D,TG_URB2D,TC_URB2D,QC_URB2D, &amp; <font color=#447700>!H urban<a name='2231'></font>
                  UC_URB2D,                                     &amp; <font color=#447700>!H urban<a name='2232'></font>
                  XXXR_URB2D,XXXB_URB2D,XXXG_URB2D,XXXC_URB2D,  &amp; <font color=#447700>!H urban<a name='2233'></font>
                  TRL_URB3D,TBL_URB3D,TGL_URB3D,                &amp; <font color=#447700>!H urban<a name='2234'></font>
                  SH_URB2D,LH_URB2D,G_URB2D,RN_URB2D,TS_URB2D,  &amp; <font color=#447700>!H urban<a name='2235'></font>
                  TR_URB2D_mosaic,TB_URB2D_mosaic,              &amp; <font color=#447700>!H urban  danli mosaic<a name='2236'></font>
                  TG_URB2D_mosaic,TC_URB2D_mosaic,              &amp; <font color=#447700>!H urban  danli mosaic<a name='2237'></font>
                  QC_URB2D_mosaic,UC_URB2D_mosaic,              &amp; <font color=#447700>!H urban  danli mosaic                  <a name='2238'></font>
                  TRL_URB3D_mosaic,TBL_URB3D_mosaic,            &amp; <font color=#447700>!H urban  danli mosaic<a name='2239'></font>
                  TGL_URB3D_mosaic,                             &amp; <font color=#447700>!H urban  danli mosaic<a name='2240'></font>
                  SH_URB2D_mosaic,LH_URB2D_mosaic,              &amp; <font color=#447700>!H urban  danli mosaic<a name='2241'></font>
                  G_URB2D_mosaic,RN_URB2D_mosaic,               &amp; <font color=#447700>!H urban  danli mosaic<a name='2242'></font>
                  TS_URB2D_mosaic,                              &amp; <font color=#447700>!H urban  danli mosaic<a name='2243'></font>
                  TS_RUL2D_mosaic,                              &amp; <font color=#447700>!H urban  danli mosaic                  <a name='2244'></font>
                  PSIM_URB2D,PSIH_URB2D,U10_URB2D,V10_URB2D,    &amp; <font color=#447700>!O urban<a name='2245'></font>
                  GZ1OZ0_URB2D,  AKMS_URB2D,                    &amp; <font color=#447700>!O urban<a name='2246'></font>
                  TH2_URB2D,Q2_URB2D, UST_URB2D,                &amp; <font color=#447700>!O urban<a name='2247'></font>
                  DECLIN_URB,COSZ_URB2D,OMG_URB2D,              &amp; <font color=#447700>!I urban<a name='2248'></font>
                  XLAT_URB2D,                                   &amp; <font color=#447700>!I urban<a name='2249'></font>
                  num_roof_layers, num_wall_layers,             &amp; <font color=#447700>!I urban<a name='2250'></font>
                  num_road_layers, DZR, DZB, DZG,               &amp; <font color=#447700>!I urban<a name='2251'></font>
                  CMCR_URB2D,TGR_URB2D,TGRL_URB3D,SMR_URB3D,    &amp; <font color=#447700>!H urban<a name='2252'></font>
                  julian,julyr,                                 &amp; <font color=#447700>!H urban<a name='2253'></font>
                  DRELR_URB2D,DRELB_URB2D,DRELG_URB2D,          &amp; <font color=#447700>!H urban<a name='2254'></font>
                  FLXHUMR_URB2D,FLXHUMB_URB2D,FLXHUMG_URB2D,    &amp; <font color=#447700>!H urban<a name='2255'></font>
                  FRC_URB2D,UTYPE_URB2D,                        &amp; <font color=#447700>!O<a name='2256'></font>
                  num_urban_layers,                             &amp; <font color=#447700>!I multi-layer urban<a name='2257'></font>
                  num_urban_hi,                                 &amp; <font color=#447700>!I multi-layer urban<a name='2258'></font>
                  trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,      &amp; <font color=#447700>!H multi-layer urban<a name='2259'></font>
                  tlev_urb3d,qlev_urb3d,                        &amp; <font color=#447700>!H multi-layer urban<a name='2260'></font>
                  tw1lev_urb3d,tw2lev_urb3d,                    &amp; <font color=#447700>!H multi-layer urban<a name='2261'></font>
                  tglev_urb3d,tflev_urb3d,                      &amp; <font color=#447700>!H multi-layer urban<a name='2262'></font>
                  sf_ac_urb3d,lf_ac_urb3d,cm_ac_urb3d,          &amp; <font color=#447700>!H multi-layer urban<a name='2263'></font>
                  sfvent_urb3d,lfvent_urb3d,                    &amp; <font color=#447700>!H multi-layer urban<a name='2264'></font>
                  sfwin1_urb3d,sfwin2_urb3d,                    &amp; <font color=#447700>!H multi-layer urban<a name='2265'></font>
                  sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,    &amp; <font color=#447700>!H multi-layer urban<a name='2266'></font>
                  lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,         &amp; <font color=#447700>!H multi-layer urban<a name='2267'></font>
                  mh_urb2d,stdh_urb2d,lf_urb2d,                 &amp; <font color=#447700>!SLUCM<a name='2268'></font>
                  th_phy,rho,p_phy,ust,                         &amp; <font color=#447700>!I multi-layer urban<a name='2269'></font>
                  gmt,julday,xlong,xlat,                        &amp; <font color=#447700>!I multi-layer urban<a name='2270'></font>
                  a_u_bep,a_v_bep,a_t_bep,a_q_bep,              &amp; <font color=#447700>!O multi-layer urban<a name='2271'></font>
                  a_e_bep,b_u_bep,b_v_bep,                      &amp; <font color=#447700>!O multi-layer urban<a name='2272'></font>
                  b_t_bep,b_q_bep,b_e_bep,dlg_bep,              &amp; <font color=#447700>!O multi-layer urban<a name='2273'></font>
                  dl_u_bep,sf_bep,vl_bep                        &amp; <font color=#447700>!O multi-layer urban<a name='2274'></font>
                 ,sfcheadrt,INFXSRT, soldrain                   &amp; <font color=#447700>!hydro<a name='2275'></font>
                 ,SDA_HFX, SDA_QFX, HFX_BOTH, QFX_BOTH, QNORM, fasdas     &amp;   <font color=#447700>!fasdas<a name='2276'></font>
                  )<a name='2277'>
<a name='2278'>
<font color=#447700>!----------------------------------------------------------------<a name='2279'></font>
    IMPLICIT NONE<a name='2280'>
<font color=#447700>!----------------------------------------------------------------<a name='2281'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2282'></font>
<font color=#447700>! --- atmospheric (WRF generic) variables<a name='2283'></font>
<font color=#447700>!-- DT          time step (seconds)<a name='2284'></font>
<font color=#447700>!-- DZ8W        thickness of layers (m)<a name='2285'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='2286'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='2287'></font>
<font color=#447700>!-- P3D         3D pressure (Pa)<a name='2288'></font>
<font color=#447700>!-- FLHC        exchange coefficient for heat (m/s)<a name='2289'></font>
<font color=#447700>!-- FLQC        exchange coefficient for moisture (m/s)<a name='2290'></font>
<font color=#447700>!-- PSFC        surface pressure (Pa)<a name='2291'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='2292'></font>
<font color=#447700>!-- QGH         saturated mixing ratio at 2 meter<a name='2293'></font>
<font color=#447700>!-- GSW         downward short wave flux at ground surface (W/m^2)<a name='2294'></font>
<font color=#447700>!-- GLW         downward long wave flux at ground surface (W/m^2)<a name='2295'></font>
<font color=#447700>!-- History variables<a name='2296'></font>
<font color=#447700>!-- CANWAT      canopy moisture content (mm)<a name='2297'></font>
<font color=#447700>!-- TSK         surface temperature (K)<a name='2298'></font>
<font color=#447700>!-- TSLB        soil temp (k)<a name='2299'></font>
<font color=#447700>!-- SMOIS       total soil moisture content (volumetric fraction)<a name='2300'></font>
<font color=#447700>!-- SH2O        unfrozen soil moisture content (volumetric fraction)<a name='2301'></font>
<font color=#447700>!                note: frozen soil moisture (i.e., soil ice) = SMOIS - SH2O<a name='2302'></font>
<font color=#447700>!-- SNOWH       actual snow depth (m)<a name='2303'></font>
<font color=#447700>!-- SNOW        liquid water-equivalent snow depth (m)<a name='2304'></font>
<font color=#447700>!-- ALBEDO      time-varying surface albedo including snow effect (unitless fraction)<a name='2305'></font>
<font color=#447700>!-- ALBBCK      background surface albedo (unitless fraction)<a name='2306'></font>
<font color=#447700>!-- CHS          surface exchange coefficient for heat and moisture (m s-1);<a name='2307'></font>
<font color=#447700>!-- CHS2        2m surface exchange coefficient for heat  (m s-1);<a name='2308'></font>
<font color=#447700>!-- CQS2        2m surface exchange coefficient for moisture (m s-1);<a name='2309'></font>
<font color=#447700>! --- soil variables<a name='2310'></font>
<font color=#447700>!-- num_soil_layers   the number of soil layers<a name='2311'></font>
<font color=#447700>!-- ZS          depths of centers of soil layers   (m)<a name='2312'></font>
<font color=#447700>!-- DZS         thicknesses of soil layers (m)<a name='2313'></font>
<font color=#447700>!-- SLDPTH      thickness of each soil layer (m, same as DZS)<a name='2314'></font>
<font color=#447700>!-- TMN         soil temperature at lower boundary (K)<a name='2315'></font>
<font color=#447700>!-- SMCWLT      wilting point (volumetric)<a name='2316'></font>
<font color=#447700>!-- SMCDRY      dry soil moisture threshold where direct evap from<a name='2317'></font>
<font color=#447700>!               top soil layer ends (volumetric)<a name='2318'></font>
<font color=#447700>!-- SMCREF      soil moisture threshold below which transpiration begins to<a name='2319'></font>
<font color=#447700>!                   stress (volumetric)<a name='2320'></font>
<font color=#447700>!-- SMCMAX      porosity, i.e. saturated value of soil moisture (volumetric)<a name='2321'></font>
<font color=#447700>!-- NROOT       number of root layers, a function of veg type, determined<a name='2322'></font>
<font color=#447700>!               in subroutine redprm.<a name='2323'></font>
<font color=#447700>!-- SMSTAV      Soil moisture availability for evapotranspiration (<a name='2324'></font>
<font color=#447700>!                   fraction between SMCWLT and SMCMXA)<a name='2325'></font>
<font color=#447700>!-- SMSTOT      Total soil moisture content frozen+unfrozen) in the soil column (mm)<a name='2326'></font>
<font color=#447700>! --- snow variables<a name='2327'></font>
<font color=#447700>!-- SNOWC       fraction snow coverage (0-1.0)<a name='2328'></font>
<font color=#447700>! --- vegetation variables<a name='2329'></font>
<font color=#447700>!-- SNOALB      upper bound on maximum albedo over deep snow<a name='2330'></font>
<font color=#447700>!-- SHDMIN      minimum areal fractional coverage of annual green vegetation<a name='2331'></font>
<font color=#447700>!-- SHDMAX      maximum areal fractional coverage of annual green vegetation<a name='2332'></font>
<font color=#447700>!-- XLAI        leaf area index (dimensionless)<a name='2333'></font>
<font color=#447700>!-- Z0BRD       Background fixed roughness length (M)<a name='2334'></font>
<font color=#447700>!-- Z0          Background vroughness length (M) as function<a name='2335'></font>
<font color=#447700>!-- ZNT         Time varying roughness length (M) as function<a name='2336'></font>
<font color=#447700>!-- ALBD(IVGTPK,ISN) background albedo reading from a table<a name='2337'></font>
<font color=#447700>! --- LSM output<a name='2338'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='2339'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='2340'></font>
<font color=#447700>!-- LH          upward moisture flux at the surface (W m-2)<a name='2341'></font>
<font color=#447700>!-- GRDFLX(I,J) ground heat flux (W m-2)<a name='2342'></font>
<font color=#447700>!-- FDOWN       radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN<a name='2343'></font>
<font color=#447700>!----------------------------------------------------------------------------<a name='2344'></font>
<font color=#447700>!-- EC          canopy water evaporation ((W m-2)<a name='2345'></font>
<font color=#447700>!-- EDIR        direct soil evaporation (W m-2)<a name='2346'></font>
<font color=#447700>!-- ET          plant transpiration from a particular root layer (W m-2)<a name='2347'></font>
<font color=#447700>!-- ETT         total plant transpiration (W m-2)<a name='2348'></font>
<font color=#447700>!-- ESNOW       sublimation from (or deposition to if &lt;0) snowpack (W m-2)<a name='2349'></font>
<font color=#447700>!-- DRIP        through-fall of precip and/or dew in excess of canopy<a name='2350'></font>
<font color=#447700>!                 water-holding capacity (m)<a name='2351'></font>
<font color=#447700>!-- DEW         dewfall (or frostfall for t&lt;273.15) (M)<a name='2352'></font>
<font color=#447700>!-- SMAV        Soil Moisture Availability for each layer, as a fraction<a name='2353'></font>
<font color=#447700>!                 between SMCWLT and SMCMAX (dimensionless fraction)<a name='2354'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2355'></font>
<font color=#447700>!-- BETA        ratio of actual/potential evap (dimensionless)<a name='2356'></font>
<font color=#447700>!-- ETP         potential evaporation (W m-2)<a name='2357'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2358'></font>
<font color=#447700>!-- FLX1        precip-snow sfc (W m-2)<a name='2359'></font>
<font color=#447700>!-- FLX2        freezing rain latent heat flux (W m-2)<a name='2360'></font>
<font color=#447700>!-- FLX3        phase-change heat flux from snowmelt (W m-2)<a name='2361'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2362'></font>
<font color=#447700>!-- ACSNOM      snow melt (mm) (water equivalent)<a name='2363'></font>
<font color=#447700>!-- ACSNOW      accumulated snow fall (mm) (water equivalent)<a name='2364'></font>
<font color=#447700>!-- SNOPCX      snow phase change heat flux (W/m^2)<a name='2365'></font>
<font color=#447700>!-- POTEVP      accumulated potential evaporation (m)<a name='2366'></font>
<font color=#447700>!-- RIB         Documentation needed!!!<a name='2367'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2368'></font>
<font color=#447700>!-- RUNOFF1     surface runoff (m s-1), not infiltrating the surface<a name='2369'></font>
<font color=#447700>!-- RUNOFF2     subsurface runoff (m s-1), drainage out bottom of last<a name='2370'></font>
<font color=#447700>!                  soil layer (baseflow)<a name='2371'></font>
<font color=#447700>!  important note: here RUNOFF2 is actually the sum of RUNOFF2 and RUNOFF3<a name='2372'></font>
<font color=#447700>!-- RUNOFF3     numerical trunctation in excess of porosity (smcmax)<a name='2373'></font>
<font color=#447700>!                  for a given soil layer at the end of a time step (m s-1).<a name='2374'></font>
<font color=#447700>!SFCRUNOFF     Surface Runoff (mm)<a name='2375'></font>
<font color=#447700>!UDRUNOFF      Total Underground Runoff (mm), which is the sum of RUNOFF2 and RUNOFF3<a name='2376'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2377'></font>
<font color=#447700>!-- RC          canopy resistance (s m-1)<a name='2378'></font>
<font color=#447700>!-- PC          plant coefficient (unitless fraction, 0-1) where PC*ETP = actual transp<a name='2379'></font>
<font color=#447700>!-- RSMIN       minimum canopy resistance (s m-1)<a name='2380'></font>
<font color=#447700>!-- RCS         incoming solar rc factor (dimensionless)<a name='2381'></font>
<font color=#447700>!-- RCT         air temperature rc factor (dimensionless)<a name='2382'></font>
<font color=#447700>!-- RCQ         atmos vapor pressure deficit rc factor (dimensionless)<a name='2383'></font>
<font color=#447700>!-- RCSOIL      soil moisture rc factor (dimensionless)<a name='2384'></font>
<a name='2385'>
<font color=#447700>!-- EMISS       surface emissivity (between 0 and 1)<a name='2386'></font>
<font color=#447700>!-- EMBCK       Background surface emissivity (between 0 and 1)<a name='2387'></font>
<a name='2388'>
<font color=#447700>!-- ROVCP       R/CP<a name='2389'></font>
<font color=#447700>!               (R_d/R_v) (dimensionless)<a name='2390'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='2391'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='2392'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='2393'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='2394'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='2395'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='2396'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='2397'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='2398'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='2399'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='2400'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='2401'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='2402'></font>
<font color=#447700>!-- its         start index for i in tile<a name='2403'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='2404'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='2405'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='2406'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='2407'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='2408'></font>
<font color=#447700>!<a name='2409'></font>
<font color=#447700>!-- SR          fraction of frozen precip (0.0 to 1.0)<a name='2410'></font>
<font color=#447700>!----------------------------------------------------------------<a name='2411'></font>
<a name='2412'>
<font color=#447700>! IN only<a name='2413'></font>
<a name='2414'>
   INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='2415'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='2416'>
                                    its,ite, jts,jte, kts,kte<a name='2417'>
<a name='2418'>
   INTEGER,  INTENT(IN   )   ::  sf_urban_physics               <font color=#447700>!urban<a name='2419'></font>
   INTEGER,  INTENT(IN   )   ::  isurban<a name='2420'>
   INTEGER,  INTENT(IN   )   ::  isice<a name='2421'>
   INTEGER,  INTENT(IN   )   ::  julian,julyr<a name='2422'>
<a name='2423'>
<font color=#447700>!added by Wei Yu  for routing<a name='2424'></font>
    REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2425'>
             INTENT(INOUT)  :: sfcheadrt,INFXSRT,soldrain <a name='2426'>
    real :: etpnd1<a name='2427'>
<font color=#447700>!end added<a name='2428'></font>
<a name='2429'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2430'>
            INTENT(IN   )    ::                            TMN, &amp;<a name='2431'>
                                                         XLAND, &amp;<a name='2432'>
                                                          XICE, &amp;<a name='2433'>
                                                        VEGFRA, &amp;<a name='2434'>
                                                        SHDMIN, &amp;<a name='2435'>
                                                        SHDMAX, &amp;<a name='2436'>
                                                        SNOALB, &amp;<a name='2437'>
                                                           GSW, &amp;<a name='2438'>
                                                        SWDOWN, &amp; <font color=#447700>!added 10 jan 2007<a name='2439'></font>
                                                           GLW, &amp;<a name='2440'>
                                                        RAINBL, &amp;<a name='2441'>
                                                        SR<a name='2442'>
<a name='2443'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2444'>
            INTENT(INOUT)    ::                         ALBBCK, &amp;<a name='2445'>
                                                            Z0, &amp;<a name='2446'>
                                                         EMBCK                  <font color=#447700>! danli mosaic<a name='2447'></font>
                                                         <a name='2448'>
   CHARACTER(LEN=*), INTENT(IN   )    ::                 MMINLU<a name='2449'>
<a name='2450'>
   REAL,    DIMENSION( ims:ime, kms:kme, jms:jme )            , &amp;<a name='2451'>
            INTENT(IN   )    ::                           QV3D, &amp;<a name='2452'>
                                                         p8w3D, &amp;<a name='2453'>
                                                          DZ8W, &amp;<a name='2454'>
                                                          T3D<a name='2455'>
   REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='2456'>
             INTENT(IN   )               ::               QGH,  &amp;<a name='2457'>
                                                          CPM<a name='2458'>
<a name='2459'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2460'>
            INTENT(IN   )    ::                          ISLTYP<a name='2461'>
                                                        <a name='2462'>
   INTEGER, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2463'>
            INTENT(INOUT   )    ::                         IVGTYP                   <font color=#447700>! for mosaic danli<a name='2464'></font>
<a name='2465'>
   INTEGER, INTENT(IN)       ::     num_soil_layers,ITIMESTEP<a name='2466'>
<a name='2467'>
   REAL,     INTENT(IN   )   ::     DT,ROVCP<a name='2468'>
<a name='2469'>
   REAL,     DIMENSION(1:num_soil_layers), INTENT(IN)::DZS<a name='2470'>
<a name='2471'>
<font color=#447700>! IN and OUT<a name='2472'></font>
<a name='2473'>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;<a name='2474'>
             INTENT(INOUT)   ::                          SMOIS, &amp; <font color=#447700>! total soil moisture<a name='2475'></font>
                                                         SH2O,  &amp; <font color=#447700>! new soil liquid<a name='2476'></font>
                                                         TSLB     <font color=#447700>! TSLB     STEMP<a name='2477'></font>
<a name='2478'>
   REAL,     DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;<a name='2479'>
             INTENT(OUT)     ::                         SMCREL<a name='2480'>
<a name='2481'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2482'>
            INTENT(INOUT)    ::                            TSK, &amp; <font color=#447700>!was TGB (temperature)<a name='2483'></font>
                                                           HFX, &amp;<a name='2484'>
                                                           QFX, &amp;<a name='2485'>
                                                            LH, &amp;<a name='2486'>
                                                        GRDFLX, &amp;<a name='2487'>
                                                          QSFC,&amp;<a name='2488'>
                                                          CQS2,&amp;<a name='2489'>
                                                          CHS,   &amp;<a name='2490'>
                                                          CHS2,&amp;<a name='2491'>
                                                          SNOW, &amp;<a name='2492'>
                                                         SNOWC, &amp;<a name='2493'>
                                                         SNOWH, &amp; <font color=#447700>!new<a name='2494'></font>
                                                        CANWAT, &amp;<a name='2495'>
                                                        SMSTAV, &amp;<a name='2496'>
                                                        SMSTOT, &amp;<a name='2497'>
                                                     SFCRUNOFF, &amp;<a name='2498'>
                                                      UDRUNOFF, &amp;<a name='2499'>
                                                        ACSNOM, &amp;<a name='2500'>
                                                        ACSNOW, &amp;<a name='2501'>
                                                       SNOTIME, &amp;<a name='2502'>
                                                        SNOPCX, &amp;<a name='2503'>
                                                        EMISS,  &amp;<a name='2504'>
                                                          RIB,  &amp;<a name='2505'>
                                                        POTEVP, &amp;<a name='2506'>
                                                        ALBEDO, &amp;<a name='2507'>
                                                           ZNT<a name='2508'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2509'>
            INTENT(OUT)      ::                         NOAHRES<a name='2510'>
   INTEGER,                                INTENT(IN)  :: OPT_THCND<a name='2511'>
<a name='2512'>
<font color=#447700>! Noah UA changes<a name='2513'></font>
   LOGICAL,                                INTENT(IN)  :: UA_PHYS<a name='2514'>
   REAL,    DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: FLX4_2D,FVB_2D,FBUR_2D,FGSN_2D<a name='2515'>
   REAL                                                :: FLX4,FVB,FBUR,FGSN<a name='2516'>
<a name='2517'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2518'>
               INTENT(OUT)    ::                        CHKLOWQ<a name='2519'>
   REAL,    DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LAI<a name='2520'>
   REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) ::        QZ0<a name='2521'>
<a name='2522'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMR_SFCDIF<a name='2523'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHR_SFCDIF<a name='2524'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMGR_SFCDIF<a name='2525'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHGR_SFCDIF<a name='2526'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMC_SFCDIF<a name='2527'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHC_SFCDIF<a name='2528'>
<font color=#447700>! Local variables (moved here from driver to make routine thread safe, 20031007 jm)<a name='2529'></font>
<a name='2530'>
      REAL, DIMENSION(1:num_soil_layers) ::  ET<a name='2531'>
<a name='2532'>
      REAL, DIMENSION(1:num_soil_layers) ::  SMAV<a name='2533'>
<a name='2534'>
      REAL  ::  BETA, ETP, SSOIL,EC, EDIR, ESNOW, ETT,        &amp;<a name='2535'>
                FLX1,FLX2,FLX3, DRIP,DEW,FDOWN,RC,PC,RSMIN,XLAI,  &amp;<a name='2536'>
<font color=#447700>!                RCS,RCT,RCQ,RCSOIL<a name='2537'></font>
                RCS,RCT,RCQ,RCSOIL,FFROZP<a name='2538'>
<a name='2539'>
    LOGICAL,    INTENT(IN   )    ::     myj,frpcpn<a name='2540'>
<a name='2541'>
<font color=#447700>! DECLARATIONS - LOGICAL<a name='2542'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2543'></font>
      LOGICAL, PARAMETER :: LOCAL=.false.<a name='2544'>
      LOGICAL :: FRZGRA, SNOWNG<a name='2545'>
<a name='2546'>
      LOGICAL :: IPRINT<a name='2547'>
<a name='2548'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2549'></font>
<font color=#447700>! DECLARATIONS - INTEGER<a name='2550'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2551'></font>
      INTEGER :: I,J, ICE,NSOIL,SLOPETYP,SOILTYP,VEGTYP<a name='2552'>
      INTEGER :: NROOT<a name='2553'>
      INTEGER :: KZ ,K<a name='2554'>
      INTEGER :: NS<a name='2555'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2556'></font>
<font color=#447700>! DECLARATIONS - REAL<a name='2557'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2558'></font>
<a name='2559'>
      REAL  :: SHMIN,SHMAX,DQSDT2,LWDN,PRCP,PRCPRAIN,                    &amp;<a name='2560'>
               Q2SAT,Q2SATI,SFCPRS,SFCSPD,SFCTMP,SHDFAC,SNOALB1,         &amp;<a name='2561'>
               SOLDN,TBOT,ZLVL, Q2K,ALBBRD, ALBEDOK, ETA, ETA_KINEMATIC, &amp;<a name='2562'>
               EMBRD,                                                    &amp;<a name='2563'>
               Z0K,RUNOFF1,RUNOFF2,RUNOFF3,SHEAT,SOLNET,E2SAT,SFCTSNO,   &amp;<a name='2564'>
<font color=#447700>! mek, WRF testing, expanded diagnostics<a name='2565'></font>
               SOLUP,LWUP,RNET,RES,Q1SFC,TAIRV,SATFLG<a name='2566'>
<font color=#447700>! MEK MAY 2007<a name='2567'></font>
      REAL ::  FDTLIW<a name='2568'>
<font color=#447700>! MEK JUL2007 for pot. evap.<a name='2569'></font>
      REAL :: RIBB<a name='2570'>
      REAL ::  FDTW<a name='2571'>
<a name='2572'>
      REAL  :: EMISSI<a name='2573'>
<a name='2574'>
      REAL  :: SNCOVR,SNEQV,SNOWHK,CMC, CHK,TH2<a name='2575'>
<a name='2576'>
      REAL  :: SMCDRY,SMCMAX,SMCREF,SMCWLT,SNOMLT,SOILM,SOILW,Q1,T1<a name='2577'>
      REAL  :: SNOTIME1    <font color=#447700>! LSTSNW1 INITIAL NUMBER OF TIMESTEPS SINCE LAST SNOWFALL<a name='2578'></font>
<a name='2579'>
      REAL  :: DUMMY,Z0BRD<a name='2580'>
<font color=#447700>!<a name='2581'></font>
      REAL  :: COSZ, SOLARDIRECT<a name='2582'>
<font color=#447700>!<a name='2583'></font>
      REAL, DIMENSION(1:num_soil_layers)::  SLDPTH, STC,SMC,SWC<a name='2584'>
<font color=#447700>!<a name='2585'></font>
      REAL, DIMENSION(1:num_soil_layers) ::     ZSOIL, RTDIS<a name='2586'>
      REAL, PARAMETER  :: TRESH=.95E0, A2=17.67,A3=273.15,A4=29.65,   &amp;<a name='2587'>
                          T0=273.16E0, ELWV=2.50E6,  A23M4=A2*(A3-A4)<a name='2588'>
<font color=#447700>! MEK MAY 2007<a name='2589'></font>
      REAL, PARAMETER  :: ROW=1.E3,ELIW=XLF,ROWLIW=ROW*ELIW<a name='2590'>
<a name='2591'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2592'></font>
<font color=#447700>! DECLARATIONS START - urban<a name='2593'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2594'></font>
<a name='2595'>
<font color=#447700>! input variables surface_driver --&gt; lsm<a name='2596'></font>
     INTEGER, INTENT(IN) :: num_roof_layers<a name='2597'>
     INTEGER, INTENT(IN) :: num_wall_layers<a name='2598'>
     INTEGER, INTENT(IN) :: num_road_layers<a name='2599'>
     REAL, OPTIONAL, DIMENSION(1:num_roof_layers), INTENT(IN) :: DZR<a name='2600'>
     REAL, OPTIONAL, DIMENSION(1:num_wall_layers), INTENT(IN) :: DZB<a name='2601'>
     REAL, OPTIONAL, DIMENSION(1:num_road_layers), INTENT(IN) :: DZG<a name='2602'>
     REAL, OPTIONAL, INTENT(IN) :: DECLIN_URB<a name='2603'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: COSZ_URB2D<a name='2604'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: OMG_URB2D<a name='2605'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: XLAT_URB2D<a name='2606'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: U_PHY<a name='2607'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: V_PHY<a name='2608'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: TH_PHY<a name='2609'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: P_PHY<a name='2610'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: RHO<a name='2611'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: UST<a name='2612'>
<a name='2613'>
     LOGICAL, intent(in) :: rdlai2d<a name='2614'>
     LOGICAL, intent(in) :: USEMONALB<a name='2615'>
<a name='2616'>
<font color=#447700>! input variables lsm --&gt; urban<a name='2617'></font>
     INTEGER :: UTYPE_URB <font color=#447700>! urban type [urban=1, suburban=2, rural=3]<a name='2618'></font>
     REAL :: TA_URB       <font color=#447700>! potential temp at 1st atmospheric level [K]<a name='2619'></font>
     REAL :: QA_URB       <font color=#447700>! mixing ratio at 1st atmospheric level  [kg/kg]<a name='2620'></font>
     REAL :: UA_URB       <font color=#447700>! wind speed at 1st atmospheric level    [m/s]<a name='2621'></font>
     REAL :: U1_URB       <font color=#447700>! u at 1st atmospheric level             [m/s]<a name='2622'></font>
     REAL :: V1_URB       <font color=#447700>! v at 1st atmospheric level             [m/s]<a name='2623'></font>
     REAL :: SSG_URB      <font color=#447700>! downward total short wave radiation    [W/m/m]<a name='2624'></font>
     REAL :: LLG_URB      <font color=#447700>! downward long wave radiation           [W/m/m]<a name='2625'></font>
     REAL :: RAIN_URB     <font color=#447700>! precipitation                          [mm/h]<a name='2626'></font>
     REAL :: RHOO_URB     <font color=#447700>! air density                            [kg/m^3]<a name='2627'></font>
     REAL :: ZA_URB       <font color=#447700>! first atmospheric level                [m]<a name='2628'></font>
     REAL :: DELT_URB     <font color=#447700>! time step                              [s]<a name='2629'></font>
     REAL :: SSGD_URB     <font color=#447700>! downward direct short wave radiation   [W/m/m]<a name='2630'></font>
     REAL :: SSGQ_URB     <font color=#447700>! downward diffuse short wave radiation  [W/m/m]<a name='2631'></font>
     REAL :: XLAT_URB     <font color=#447700>! latitude                               [deg]<a name='2632'></font>
     REAL :: COSZ_URB     <font color=#447700>! cosz<a name='2633'></font>
     REAL :: OMG_URB      <font color=#447700>! hour angle<a name='2634'></font>
     REAL :: ZNT_URB      <font color=#447700>! roughness length                       [m]<a name='2635'></font>
     REAL :: TR_URB<a name='2636'>
     REAL :: TB_URB<a name='2637'>
     REAL :: TG_URB<a name='2638'>
     REAL :: TC_URB<a name='2639'>
     REAL :: QC_URB<a name='2640'>
     REAL :: UC_URB<a name='2641'>
     REAL :: XXXR_URB<a name='2642'>
     REAL :: XXXB_URB<a name='2643'>
     REAL :: XXXG_URB<a name='2644'>
     REAL :: XXXC_URB<a name='2645'>
     REAL, DIMENSION(1:num_roof_layers) :: TRL_URB  <font color=#447700>! roof layer temp [K]<a name='2646'></font>
     REAL, DIMENSION(1:num_wall_layers) :: TBL_URB  <font color=#447700>! wall layer temp [K]<a name='2647'></font>
     REAL, DIMENSION(1:num_road_layers) :: TGL_URB  <font color=#447700>! road layer temp [K]<a name='2648'></font>
     LOGICAL  :: LSOLAR_URB<a name='2649'>
<a name='2650'>
<font color=#447700>!===Yang,2014/10/08,hydrological variable for single layer UCM===<a name='2651'></font>
     INTEGER :: jmonth, jday, tloc<a name='2652'>
     INTEGER :: IRIOPTION, USOIL, DSOIL<a name='2653'>
     REAL :: AOASIS, OMG<a name='2654'>
     REAL :: DRELR_URB<a name='2655'>
     REAL :: DRELB_URB<a name='2656'>
     REAL :: DRELG_URB<a name='2657'>
     REAL :: FLXHUMR_URB<a name='2658'>
     REAL :: FLXHUMB_URB<a name='2659'>
     REAL :: FLXHUMG_URB<a name='2660'>
     REAL :: CMCR_URB<a name='2661'>
     REAL :: TGR_URB<a name='2662'>
     REAL, DIMENSION(1:num_roof_layers) :: SMR_URB  <font color=#447700>! green roof layer moisture<a name='2663'></font>
     REAL, DIMENSION(1:num_roof_layers) :: TGRL_URB <font color=#447700>! green roof layer temp [K]<a name='2664'></font>
<a name='2665'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELR_URB2D<a name='2666'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELB_URB2D<a name='2667'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELG_URB2D<a name='2668'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMR_URB2D<a name='2669'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMB_URB2D<a name='2670'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMG_URB2D<a name='2671'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMCR_URB2D<a name='2672'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TGR_URB2D<a name='2673'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: TGRL_URB3D<a name='2674'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: SMR_URB3D<a name='2675'>
<a name='2676'>
<font color=#447700>! state variable surface_driver &lt;--&gt; lsm &lt;--&gt; urban<a name='2677'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TR_URB2D<a name='2678'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TB_URB2D<a name='2679'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TG_URB2D<a name='2680'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TC_URB2D<a name='2681'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: QC_URB2D<a name='2682'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: UC_URB2D<a name='2683'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXR_URB2D<a name='2684'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXB_URB2D<a name='2685'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXG_URB2D<a name='2686'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXC_URB2D<a name='2687'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: SH_URB2D<a name='2688'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LH_URB2D<a name='2689'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: G_URB2D<a name='2690'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: RN_URB2D<a name='2691'>
<font color=#447700>!<a name='2692'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TS_URB2D<a name='2693'>
<a name='2694'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: TRL_URB3D<a name='2695'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_wall_layers, jms:jme ), INTENT(INOUT) :: TBL_URB3D<a name='2696'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_road_layers, jms:jme ), INTENT(INOUT) :: TGL_URB3D<a name='2697'>
<a name='2698'>
<font color=#447700>! output variable lsm --&gt; surface_driver<a name='2699'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: PSIM_URB2D<a name='2700'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: PSIH_URB2D<a name='2701'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: GZ1OZ0_URB2D<a name='2702'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: U10_URB2D<a name='2703'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: V10_URB2D<a name='2704'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: TH2_URB2D<a name='2705'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: Q2_URB2D<a name='2706'>
<font color=#447700>!<a name='2707'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: AKMS_URB2D<a name='2708'>
<font color=#447700>!<a name='2709'></font>
     REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: UST_URB2D<a name='2710'>
     REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FRC_URB2D                <font color=#447700>! change this to inout, danli mosaic<a name='2711'></font>
     INTEGER, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: UTYPE_URB2D<a name='2712'>
<a name='2713'>
<font color=#447700>! output variables urban --&gt; lsm<a name='2714'></font>
     REAL :: TS_URB     <font color=#447700>! surface radiative temperature    [K]<a name='2715'></font>
     REAL :: QS_URB     <font color=#447700>! surface humidity                 [-]<a name='2716'></font>
     REAL :: SH_URB     <font color=#447700>! sensible heat flux               [W/m/m]<a name='2717'></font>
     REAL :: LH_URB     <font color=#447700>! latent heat flux                 [W/m/m]<a name='2718'></font>
     REAL :: LH_KINEMATIC_URB <font color=#447700>! latent heat flux, kinetic  [kg/m/m/s]<a name='2719'></font>
     REAL :: SW_URB     <font color=#447700>! upward short wave radiation flux [W/m/m]<a name='2720'></font>
     REAL :: ALB_URB    <font color=#447700>! time-varying albedo            [fraction]<a name='2721'></font>
     REAL :: LW_URB     <font color=#447700>! upward long wave radiation flux  [W/m/m]<a name='2722'></font>
     REAL :: G_URB      <font color=#447700>! heat flux into the ground        [W/m/m]<a name='2723'></font>
     REAL :: RN_URB     <font color=#447700>! net radiation                    [W/m/m]<a name='2724'></font>
     REAL :: PSIM_URB   <font color=#447700>! shear f for momentum             [-]<a name='2725'></font>
     REAL :: PSIH_URB   <font color=#447700>! shear f for heat                 [-]<a name='2726'></font>
     REAL :: GZ1OZ0_URB   <font color=#447700>! shear f for heat                 [-]<a name='2727'></font>
     REAL :: U10_URB    <font color=#447700>! wind u component at 10 m         [m/s]<a name='2728'></font>
     REAL :: V10_URB    <font color=#447700>! wind v component at 10 m         [m/s]<a name='2729'></font>
     REAL :: TH2_URB    <font color=#447700>! potential temperature at 2 m     [K]<a name='2730'></font>
     REAL :: Q2_URB     <font color=#447700>! humidity at 2 m                  [-]<a name='2731'></font>
     REAL :: CHS_URB<a name='2732'>
     REAL :: CHS2_URB<a name='2733'>
     REAL :: UST_URB<a name='2734'>
<font color=#447700>! NUDAPT Parameters urban --&gt; lam<a name='2735'></font>
     REAL :: mh_urb<a name='2736'>
     REAL :: stdh_urb<a name='2737'>
     REAL :: lp_urb<a name='2738'>
     REAL :: hgt_urb<a name='2739'>
     REAL, DIMENSION(4) :: lf_urb<a name='2740'>
<font color=#447700>! Variables for multi-layer UCM (Martilli et al. 2002)<a name='2741'></font>
   REAL, OPTIONAL, INTENT(IN  )   ::                                   GMT <a name='2742'>
   INTEGER, OPTIONAL, INTENT(IN  ) ::                               JULDAY<a name='2743'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   )        ::XLAT, XLONG<a name='2744'>
   INTEGER, INTENT(IN  ) ::                               NUM_URBAN_LAYERS<a name='2745'>
   INTEGER, INTENT(IN  ) ::                               NUM_URBAN_HI<a name='2746'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: trb_urb4d<a name='2747'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1_urb4d<a name='2748'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2_urb4d<a name='2749'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tgb_urb4d<a name='2750'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tlev_urb3d<a name='2751'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: qlev_urb3d<a name='2752'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1lev_urb3d<a name='2753'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2lev_urb3d<a name='2754'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tglev_urb3d<a name='2755'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tflev_urb3d<a name='2756'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: lf_ac_urb3d<a name='2757'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: sf_ac_urb3d<a name='2758'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: cm_ac_urb3d<a name='2759'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: sfvent_urb3d<a name='2760'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: lfvent_urb3d<a name='2761'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin1_urb3d<a name='2762'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin2_urb3d<a name='2763'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw1_urb3d<a name='2764'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw2_urb3d<a name='2765'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfr_urb3d<a name='2766'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfg_urb3d<a name='2767'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_hi, jms:jme ), INTENT(IN) :: hi_urb2d<a name='2768'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: lp_urb2d<a name='2769'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: lb_urb2d<a name='2770'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: hgt_urb2d<a name='2771'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: mh_urb2d<a name='2772'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: stdh_urb2d<a name='2773'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 4, jms:jme ), INTENT(IN) :: lf_urb2d<a name='2774'>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_u_bep   <font color=#447700>!Implicit momemtum component X-direction<a name='2775'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_v_bep   <font color=#447700>!Implicit momemtum component Y-direction<a name='2776'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_t_bep   <font color=#447700>!Implicit component pot. temperature<a name='2777'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_q_bep   <font color=#447700>!Implicit momemtum component X-direction<a name='2778'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_e_bep   <font color=#447700>!Implicit component TKE<a name='2779'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_u_bep   <font color=#447700>!Explicit momentum component X-direction<a name='2780'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_v_bep   <font color=#447700>!Explicit momentum component Y-direction<a name='2781'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_t_bep   <font color=#447700>!Explicit component pot. temperature<a name='2782'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_q_bep   <font color=#447700>!Implicit momemtum component Y-direction<a name='2783'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_e_bep   <font color=#447700>!Explicit component TKE<a name='2784'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::vl_bep    <font color=#447700>!Fraction air volume in grid cell<a name='2785'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::dlg_bep   <font color=#447700>!Height above ground<a name='2786'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::sf_bep  <font color=#447700>!Fraction air at the face of grid cell<a name='2787'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::dl_u_bep  <font color=#447700>!Length scale<a name='2788'></font>
<a name='2789'>
<font color=#447700>! Local variables for multi-layer UCM (Martilli et al. 2002)<a name='2790'></font>
   REAL,    DIMENSION( its:ite, jts:jte ) :: HFX_RURAL,LH_RURAL,GRDFLX_RURAL <font color=#447700>! ,RN_RURAL<a name='2791'></font>
   REAL,    DIMENSION( its:ite, jts:jte ) :: QFX_RURAL <font color=#447700>! ,QSFC_RURAL,UMOM_RURAL,VMOM_RURAL<a name='2792'></font>
   REAL,    DIMENSION( its:ite, jts:jte ) :: ALB_RURAL,EMISS_RURAL,TSK_RURAL <font color=#447700>! ,UST_RURAL<a name='2793'></font>
<font color=#447700>!   REAL,    DIMENSION( ims:ime, jms:jme ) :: QSFC_URB<a name='2794'></font>
   REAL,    DIMENSION( its:ite, jts:jte ) :: HFX_URB,UMOM_URB,VMOM_URB<a name='2795'>
   REAL,    DIMENSION( its:ite, jts:jte ) :: QFX_URB<a name='2796'>
<font color=#447700>!   REAL,    DIMENSION( ims:ime, jms:jme ) :: ALBEDO_URB,EMISS_URB,UMOM,VMOM,UST<a name='2797'></font>
   REAL, DIMENSION(its:ite,jts:jte) ::EMISS_URB<a name='2798'>
   REAL, DIMENSION(its:ite,jts:jte) :: RL_UP_URB<a name='2799'>
   REAL, DIMENSION(its:ite,jts:jte) ::RS_ABS_URB<a name='2800'>
   REAL, DIMENSION(its:ite,jts:jte) ::GRDFLX_URB<a name='2801'>
   REAL :: SIGMA_SB,RL_UP_RURAL,RL_UP_TOT,RS_ABS_TOT,UMOM,VMOM<a name='2802'>
   REAL :: r1,r2,r3<a name='2803'>
   REAL :: CMR_URB, CHR_URB, CMC_URB, CHC_URB, CMGR_URB, CHGR_URB<a name='2804'>
   REAL :: frc_urb,lb_urb<a name='2805'>
   REAL :: check <a name='2806'>
<font color=#447700>! ----------------------------------------------------------------------<a name='2807'></font>
<font color=#447700>! DECLARATIONS END - urban<a name='2808'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='2809'></font>
<font color=#447700>!-------------------------------------------------<a name='2810'></font>
<font color=#447700>! Noah-mosaic related variables are added to declaration  (danli)<a name='2811'></font>
<font color=#447700>!-------------------------------------------------<a name='2812'></font>
  <a name='2813'>
  INTEGER, INTENT(IN) :: sf_surface_mosaic    <a name='2814'>
  INTEGER, INTENT(IN) :: mosaic_cat, NLCAT<a name='2815'>
  REAL, DIMENSION( ims:ime, NLCAT, jms:jme ), INTENT(IN) :: landusef <a name='2816'>
  REAL, DIMENSION( ims:ime, NLCAT, jms:jme ), INTENT(INOUT) ::landusef2 <a name='2817'>
  INTEGER, DIMENSION( ims:ime, NLCAT, jms:jme ), INTENT(INOUT) :: mosaic_cat_index <a name='2818'>
<a name='2819'>
  REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::   &amp;<a name='2820'>
        TSK_mosaic, QSFC_mosaic, CANWAT_mosaic, SNOW_mosaic,SNOWH_mosaic, SNOWC_mosaic <a name='2821'>
  REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::   &amp;<a name='2822'>
        ALBEDO_mosaic,ALBBCK_mosaic, EMISS_mosaic, EMBCK_mosaic, ZNT_mosaic, Z0_mosaic,   &amp;<a name='2823'>
        HFX_mosaic,QFX_mosaic, LH_mosaic, GRDFLX_mosaic,SNOTIME_mosaic    <a name='2824'>
  REAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), OPTIONAL, INTENT(INOUT)::   &amp;<a name='2825'>
        TSLB_mosaic,SMOIS_mosaic,SH2O_mosaic<a name='2826'>
  REAL, DIMENSION( ims:ime, jms:jme ) :: TSK_mosaic_avg, QSFC_mosaic_avg, CANWAT_mosaic_avg,SNOW_mosaic_avg,SNOWH_mosaic_avg, &amp;<a name='2827'>
                                         SNOWC_mosaic_avg, HFX_mosaic_avg, QFX_mosaic_avg, LH_mosaic_avg, GRDFLX_mosaic_avg,  &amp;<a name='2828'>
                                         ALBEDO_mosaic_avg, ALBBCK_mosaic_avg, EMISS_mosaic_avg, EMBCK_mosaic_avg,            &amp;<a name='2829'>
                                         ZNT_mosaic_avg, Z0_mosaic_avg, SNOTIME_mosaic_avg, FAREA_mosaic_avg  <a name='2830'>
  REAL, DIMENSION( ims:ime, 1:num_soil_layers, jms:jme )                     ::   &amp;<a name='2831'>
        TSLB_mosaic_avg,SMOIS_mosaic_avg,SH2O_mosaic_avg<a name='2832'>
  <a name='2833'>
  REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::   &amp;<a name='2834'>
        TR_URB2D_mosaic, TB_URB2D_mosaic, TG_URB2D_mosaic, TC_URB2D_mosaic,QC_URB2D_mosaic, UC_URB2D_mosaic, &amp;<a name='2835'>
        SH_URB2D_mosaic,LH_URB2D_mosaic,G_URB2D_mosaic,RN_URB2D_mosaic,TS_URB2D_mosaic, TS_RUL2D_mosaic  <a name='2836'>
                  <a name='2837'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TRL_URB3D_mosaic<a name='2838'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_wall_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TBL_URB3D_mosaic<a name='2839'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_road_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TGL_URB3D_mosaic<a name='2840'>
<a name='2841'>
  INTEGER, DIMENSION( ims:ime, jms:jme ) ::    IVGTYP_dominant<a name='2842'>
  INTEGER ::  mosaic_i, URBAN_METHOD, zo_avg_option<a name='2843'>
  REAL :: FAREA<a name='2844'>
  LOGICAL :: IPRINT_mosaic, Noah_call<a name='2845'>
<font color=#447700>!-------------------------------------------------<a name='2846'></font>
<font color=#447700>! Noah-mosaic related variables declaration end (danli)<a name='2847'></font>
<font color=#447700>!-------------------------------------------------<a name='2848'></font>
<a name='2849'>
  REAL, PARAMETER  :: CAPA=R_D/CP<a name='2850'>
  REAL :: APELM,APES,SFCTH2,PSFC<a name='2851'>
  real, intent(in) :: xice_threshold<a name='2852'>
  character(len=80) :: message_text<a name='2853'>
<font color=#447700>!<a name='2854'></font>
<font color=#447700>!  FASDAS: it doesn't work for mosaic, but we need the variables to call sflx<a name='2855'></font>
<font color=#447700>!<a name='2856'></font>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='2857'>
            INTENT(INOUT)  ::   SDA_HFX, SDA_QFX, HFX_BOTH, QFX_BOTH, QNORM<a name='2858'>
   INTEGER, INTENT(IN   )  ::  fasdas<a name='2859'>
   REAL                    ::  XSDA_HFX, XSDA_QFX, XQNORM<a name='2860'>
   REAL                    ::  HFX_PHY, QFX_PHY<a name='2861'>
   REAL                    ::  DZQ<a name='2862'>
   REAL                    ::  HCPCT_FASDAS<a name='2863'>
<a name='2864'>
   HFX_PHY = 0.0   <font color=#447700>! initialize<a name='2865'></font>
   QFX_PHY = 0.0<a name='2866'>
   XQNORM  = 0.0<a name='2867'>
   XSDA_HFX = 0.0<a name='2868'>
   XSDA_QFX = 0.0<a name='2869'>
<font color=#447700>!<a name='2870'></font>
<font color=#447700>!  END FASDAS<a name='2871'></font>
<font color=#447700>!<a name='2872'></font>
<font color=#447700>! MEK MAY 2007<a name='2873'></font>
      FDTLIW=DT/ROWLIW<a name='2874'>
<font color=#447700>! MEK JUL2007<a name='2875'></font>
      FDTW=DT/(XLV*RHOWATER)<a name='2876'>
<font color=#447700>! debug printout<a name='2877'></font>
      IPRINT=.false.<a name='2878'>
      IPRINT_mosaic=.false.<a name='2879'>
<a name='2880'>
<font color=#447700>!      SLOPETYP=2<a name='2881'></font>
      SLOPETYP=1<a name='2882'>
<font color=#447700>!      SHDMIN=0.00<a name='2883'></font>
<a name='2884'>
      NSOIL=num_soil_layers<a name='2885'>
<a name='2886'>
     DO NS=1,NSOIL<a name='2887'>
     SLDPTH(NS)=DZS(NS)<a name='2888'>
     ENDDO<a name='2889'>
<a name='2890'>
     JLOOP : DO J=jts,jte<a name='2891'>
<a name='2892'>
      IF(ITIMESTEP.EQ.1)THEN<a name='2893'>
        DO 50 I=its,ite<a name='2894'>
<font color=#447700>!*** initialize soil conditions for IHOP 31 May case<a name='2895'></font>
<font color=#447700>!         IF((XLAND(I,J)-1.5) &lt; 0.)THEN<a name='2896'></font>
<font color=#447700>!            if (I==108.and.j==85) then<a name='2897'></font>
<font color=#447700>!                  DO NS=1,NSOIL<a name='2898'></font>
<font color=#447700>!                      SMOIS(I,NS,J)=0.10<a name='2899'></font>
<font color=#447700>!                      SH2O(I,NS,J)=0.10<a name='2900'></font>
<font color=#447700>!                  enddo<a name='2901'></font>
<font color=#447700>!             endif<a name='2902'></font>
<font color=#447700>!         ENDIF<a name='2903'></font>
<a name='2904'>
<font color=#447700>!*** SET ZERO-VALUE FOR SOME OUTPUT DIAGNOSTIC ARRAYS<a name='2905'></font>
          IF((XLAND(I,J)-1.5).GE.0.)THEN<a name='2906'>
<font color=#447700>! check sea-ice point<a name='2907'></font>
#if 0<a name='2908'>
            IF( XICE(I,J).GE. XICE_THRESHOLD .and. IPRINT ) PRINT*, ' sea-ice at water point, I=',I,'J=',J<a name='2909'>
#endif<a name='2910'>
<font color=#447700>!***   Open Water Case<a name='2911'></font>
            SMSTAV(I,J)=1.0<a name='2912'>
            SMSTOT(I,J)=1.0<a name='2913'>
            DO NS=1,NSOIL<a name='2914'>
              SMOIS(I,NS,J)=1.0<a name='2915'>
              TSLB(I,NS,J)=273.16                                          <font color=#447700>!STEMP<a name='2916'></font>
              SMCREL(I,NS,J)=1.0<a name='2917'>
            ENDDO<a name='2918'>
          ELSE<a name='2919'>
            IF ( XICE(I,J) .GE. XICE_THRESHOLD ) THEN<a name='2920'>
<font color=#447700>!***        SEA-ICE CASE<a name='2921'></font>
              SMSTAV(I,J)=1.0<a name='2922'>
              SMSTOT(I,J)=1.0<a name='2923'>
              DO NS=1,NSOIL<a name='2924'>
                SMOIS(I,NS,J)=1.0<a name='2925'>
                SMCREL(I,NS,J)=1.0<a name='2926'>
              ENDDO<a name='2927'>
            ENDIF<a name='2928'>
          ENDIF<a name='2929'>
<font color=#447700>!<a name='2930'></font>
   50   CONTINUE<a name='2931'>
      ENDIF                                                               <font color=#447700>! end of initialization over ocean<a name='2932'></font>
<a name='2933'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2934'></font>
      ILOOP : DO I=its,ite<a name='2935'>
      <a name='2936'>
         IF (((XLAND(I,J)-1.5).LT.0.) .AND. (XICE(I,J) &lt; XICE_THRESHOLD) ) THEN<a name='2937'>
               <a name='2938'>
               IVGTYP_dominant(I,J)=IVGTYP(I,J)                                   <font color=#447700>! save this<a name='2939'></font>
      <a name='2940'>
            <font color=#447700>! INITIALIZE THE AREA-AVERAGED FLUXES <a name='2941'></font>
               <a name='2942'>
                 TSK_mosaic_avg(i,j)= 0                              <font color=#447700>! from 3D to 2D<a name='2943'></font>
                 QSFC_mosaic_avg(i,j)= 0<a name='2944'>
                 CANWAT_mosaic_avg(i,j)= 0<a name='2945'>
                 SNOW_mosaic_avg(i,j)= 0<a name='2946'>
                 SNOWH_mosaic_avg(i,j)= 0<a name='2947'>
                 SNOWC_mosaic_avg(i,j)= 0<a name='2948'>
            <a name='2949'>
                          DO NS=1,NSOIL<a name='2950'>
            <a name='2951'>
                     TSLB_mosaic_avg(i,NS,j)=0<a name='2952'>
                     SMOIS_mosaic_avg(i,NS,j)=0<a name='2953'>
                     SH2O_mosaic_avg(i,NS,j)=0<a name='2954'>
            <a name='2955'>
                         ENDDO<a name='2956'>
            <a name='2957'>
                 HFX_mosaic_avg(i,j)= 0<a name='2958'>
                 QFX_mosaic_avg(i,j)= 0  <a name='2959'>
                 LH_mosaic_avg(i,j)=  0 <a name='2960'>
                 GRDFLX_mosaic_avg(i,j)= 0<a name='2961'>
                 ALBEDO_mosaic_avg(i,j)=0<a name='2962'>
                 ALBBCK_mosaic_avg(i,j)=0<a name='2963'>
                 EMISS_mosaic_avg(i,j)=0<a name='2964'>
                 EMBCK_mosaic_avg(i,j)=0<a name='2965'>
                 ZNT_mosaic_avg(i,j)=0<a name='2966'>
                 Z0_mosaic_avg(i,j)=0  <a name='2967'>
                 FAREA_mosaic_avg(i,j)=0  <a name='2968'>
            <a name='2969'>
            <font color=#447700>! add a new loop for the mosaic_cat<a name='2970'></font>
            <a name='2971'>
               DO mosaic_i = mosaic_cat, 1, -1<a name='2972'>
               <a name='2973'>
            <font color=#447700>!   if (mosaic_cat_index(I,mosaic_i,J) .EQ. 16 ) then<a name='2974'></font>
            <font color=#447700>!   PRINT*, 'you still have water tiles at','i=',i,'j=',j, 'mosaic_i',mosaic_i<a name='2975'></font>
            <font color=#447700>!   PRINT*, 'xland',xland(i,j),'xice',xice(i,j)<a name='2976'></font>
            <font color=#447700>!   endif<a name='2977'></font>
               <a name='2978'>
               IVGTYP(I,J)=mosaic_cat_index(I,mosaic_i,J)                         <font color=#447700>! replace it with the mosaic one          <a name='2979'></font>
               TSK(I,J)=TSK_mosaic(I,mosaic_i,J)                                  <font color=#447700>! from 3D to 2D<a name='2980'></font>
               QSFC(i,j)=QSFC_mosaic(I,mosaic_i,J)<a name='2981'>
               CANWAT(i,j)=CANWAT_mosaic(i,mosaic_i,j) <a name='2982'>
               SNOW(i,j)=SNOW_mosaic(i,mosaic_i,j) <a name='2983'>
               SNOWH(i,j)=SNOWH_mosaic(i,mosaic_i,j)  <a name='2984'>
               SNOWC(i,j)=SNOWC_mosaic(i,mosaic_i,j)<a name='2985'>
            <a name='2986'>
                ALBEDO(i,j) = ALBEDO_mosaic(i,mosaic_i,j)<a name='2987'>
                ALBBCK(i,j)= ALBBCK_mosaic(i,mosaic_i,j) <a name='2988'>
                EMISS(i,j)= EMISS_mosaic(i,mosaic_i,j) <a name='2989'>
                EMBCK(i,j)= EMBCK_mosaic(i,mosaic_i,j) <a name='2990'>
                ZNT(i,j)= ZNT_mosaic(i,mosaic_i,j) <a name='2991'>
                Z0(i,j)= Z0_mosaic(i,mosaic_i,j)    <a name='2992'>
            <a name='2993'>
                 SNOTIME(i,j)= SNOTIME_mosaic(i,mosaic_i,j)          <a name='2994'>
              <a name='2995'>
                          DO NS=1,NSOIL<a name='2996'>
            <a name='2997'>
                     TSLB(i,NS,j)=TSLB_mosaic(i,NSOIL*(mosaic_i-1)+NS,j)<a name='2998'>
                     SMOIS(i,NS,j)=SMOIS_mosaic(i,NSOIL*(mosaic_i-1)+NS,j)<a name='2999'>
                     SH2O(i,NS,j)=SH2O_mosaic(i,NSOIL*(mosaic_i-1)+NS,j)<a name='3000'>
            <a name='3001'>
                          ENDDO<a name='3002'>
            <a name='3003'>
                       IF(IPRINT_mosaic) THEN<a name='3004'>
            <a name='3005'>
                   print*, 'BEFORE SFLX, in Noahdrv.F'<a name='3006'>
                   print*, 'mosaic_cat', mosaic_cat, 'IVGTYP',IVGTYP(i,j), 'TSK',TSK(i,j),'HFX',HFX(i,j), 'QSFC', QSFC(i,j),   &amp;<a name='3007'>
                   'CANWAT', CANWAT(i,j), 'SNOW',SNOW(i,j), 'ALBEDO',ALBEDO(i,j), 'TSLB',TSLB(i,1,j),'CHS',CHS(i,j),'ZNT',ZNT(i,j)<a name='3008'>
            <a name='3009'>
                       ENDIF<a name='3010'>
            <a name='3011'>
            <font color=#447700>!-----------------------------------------------------------------------<a name='3012'></font>
            <font color=#447700>! insert the NOAH model here for the non-urban one and the urban one  DANLI<a name='3013'></font>
            <font color=#447700>!-----------------------------------------------------------------------<a name='3014'></font>
            <a name='3015'>
      <font color=#447700>! surface pressure<a name='3016'></font>
              PSFC=P8w3D(i,1,j)<a name='3017'>
      <font color=#447700>! pressure in middle of lowest layer<a name='3018'></font>
              SFCPRS=(P8W3D(I,KTS+1,j)+P8W3D(i,KTS,j))*0.5<a name='3019'>
      <font color=#447700>! convert from mixing ratio to specific humidity<a name='3020'></font>
               Q2K=QV3D(i,1,j)/(1.0+QV3D(i,1,j))<a name='3021'>
      <font color=#447700>!<a name='3022'></font>
      <font color=#447700>!         Q2SAT=QGH(I,j)<a name='3023'></font>
               Q2SAT=QGH(I,J)/(1.0+QGH(I,J))        <font color=#447700>! Q2SAT is sp humidity<a name='3024'></font>
      <font color=#447700>! add check on myj=.true.<a name='3025'></font>
      <font color=#447700>!        IF((Q2K.GE.Q2SAT*TRESH).AND.Q2K.LT.QZ0(I,J))THEN<a name='3026'></font>
              IF((myj).AND.(Q2K.GE.Q2SAT*TRESH).AND.Q2K.LT.QZ0(I,J))THEN<a name='3027'>
                SATFLG=0.<a name='3028'>
                CHKLOWQ(I,J)=0.<a name='3029'>
              ELSE<a name='3030'>
                SATFLG=1.0<a name='3031'>
                CHKLOWQ(I,J)=1.<a name='3032'>
              ENDIF<a name='3033'>
      <a name='3034'>
              SFCTMP=T3D(i,1,j)<a name='3035'>
              ZLVL=0.5*DZ8W(i,1,j)<a name='3036'>
      <a name='3037'>
      <font color=#447700>!        TH2=SFCTMP+(0.0097545*ZLVL)<a name='3038'></font>
      <font color=#447700>! calculate SFCTH2 via Exner function vs lapse-rate (above)<a name='3039'></font>
               APES=(1.E5/PSFC)**CAPA<a name='3040'>
               APELM=(1.E5/SFCPRS)**CAPA<a name='3041'>
               SFCTH2=SFCTMP*APELM<a name='3042'>
               TH2=SFCTH2/APES<a name='3043'>
      <font color=#447700>!<a name='3044'></font>
               EMISSI = EMISS(I,J)<a name='3045'>
               LWDN=GLW(I,J)*EMISSI<a name='3046'>
      <font color=#447700>! SOLDN is total incoming solar<a name='3047'></font>
              SOLDN=SWDOWN(I,J)<a name='3048'>
      <font color=#447700>! GSW is net downward solar<a name='3049'></font>
      <font color=#447700>!        SOLNET=GSW(I,J)<a name='3050'></font>
      <font color=#447700>! use mid-day albedo to determine net downward solar (no solar zenith angle correction)<a name='3051'></font>
              SOLNET=SOLDN*(1.-ALBEDO(I,J))<a name='3052'>
              PRCP=RAINBL(i,j)/DT<a name='3053'>
              VEGTYP=IVGTYP(I,J)<a name='3054'>
              SOILTYP=ISLTYP(I,J)<a name='3055'>
              SHDFAC=VEGFRA(I,J)/100.<a name='3056'>
              T1=TSK(I,J)<a name='3057'>
              CHK=CHS(I,J)<a name='3058'>
              SHMIN=SHDMIN(I,J)/100. <font color=#447700>!NEW<a name='3059'></font>
              SHMAX=SHDMAX(I,J)/100. <font color=#447700>!NEW<a name='3060'></font>
      <font color=#447700>! convert snow water equivalent from mm to meter<a name='3061'></font>
              SNEQV=SNOW(I,J)*0.001<a name='3062'>
      <font color=#447700>! snow depth in meters<a name='3063'></font>
              SNOWHK=SNOWH(I,J)<a name='3064'>
              SNCOVR=SNOWC(I,J)<a name='3065'>
      <a name='3066'>
      <font color=#447700>! if "SR" present, set frac of frozen precip ("FFROZP") = snow-ratio ("SR", range:0-1)<a name='3067'></font>
      <font color=#447700>! SR from e.g. Ferrier microphysics<a name='3068'></font>
      <font color=#447700>! otherwise define from 1st atmos level temperature<a name='3069'></font>
             IF(FRPCPN) THEN<a name='3070'>
                FFROZP=SR(I,J)<a name='3071'>
              ELSE<a name='3072'>
                IF (SFCTMP &lt;=  273.15) THEN<a name='3073'>
                  FFROZP = 1.0<a name='3074'>
      	  ELSE<a name='3075'>
      	    FFROZP = 0.0<a name='3076'>
      	  ENDIF<a name='3077'>
              ENDIF<a name='3078'>
      <font color=#447700>!***<a name='3079'></font>
              IF((XLAND(I,J)-1.5).GE.0.)THEN                                  <font color=#447700>! begining of land/sea if block<a name='3080'></font>
      <font color=#447700>! Open water points<a name='3081'></font>
                TSK_RURAL(I,J)=TSK(I,J)<a name='3082'>
                HFX_RURAL(I,J)=HFX(I,J)<a name='3083'>
                QFX_RURAL(I,J)=QFX(I,J)<a name='3084'>
                LH_RURAL(I,J)=LH(I,J)<a name='3085'>
                EMISS_RURAL(I,J)=EMISS(I,J)<a name='3086'>
                GRDFLX_RURAL(I,J)=GRDFLX(I,J)<a name='3087'>
              ELSE<a name='3088'>
      <font color=#447700>! Land or sea-ice case<a name='3089'></font>
      <a name='3090'>
                IF (XICE(I,J) &gt;= XICE_THRESHOLD) THEN<a name='3091'>
                   <font color=#447700>! Sea-ice point<a name='3092'></font>
                   ICE = 1<a name='3093'>
                ELSE IF ( VEGTYP == ISICE ) THEN<a name='3094'>
                   <font color=#447700>! Land-ice point<a name='3095'></font>
                   ICE = -1<a name='3096'>
                ELSE<a name='3097'>
                   <font color=#447700>! Neither sea ice or land ice.<a name='3098'></font>
                   ICE=0<a name='3099'>
                ENDIF<a name='3100'>
                DQSDT2=Q2SAT*A23M4/(SFCTMP-A4)**2<a name='3101'>
      <a name='3102'>
                IF(SNOW(I,J).GT.0.0)THEN<a name='3103'>
      <font color=#447700>! snow on surface (use ice saturation properties)<a name='3104'></font>
                  SFCTSNO=SFCTMP<a name='3105'>
                  E2SAT=611.2*EXP(6174.*(1./273.15 - 1./SFCTSNO))<a name='3106'>
                  Q2SATI=0.622*E2SAT/(SFCPRS-E2SAT)<a name='3107'>
                  Q2SATI=Q2SATI/(1.0+Q2SATI)    <font color=#447700>! spec. hum.<a name='3108'></font>
                  IF (T1 .GT. 273.14) THEN<a name='3109'>
      <font color=#447700>! warm ground temps, weight the saturation between ice and water according to SNOWC<a name='3110'></font>
                    Q2SAT=Q2SAT*(1.-SNOWC(I,J)) + Q2SATI*SNOWC(I,J)<a name='3111'>
                    DQSDT2=DQSDT2*(1.-SNOWC(I,J)) + Q2SATI*6174./(SFCTSNO**2)*SNOWC(I,J)<a name='3112'>
                  ELSE<a name='3113'>
      <font color=#447700>! cold ground temps, use ice saturation only<a name='3114'></font>
                    Q2SAT=Q2SATI<a name='3115'>
                    DQSDT2=Q2SATI*6174./(SFCTSNO**2)<a name='3116'>
                  ENDIF<a name='3117'>
      <font color=#447700>! for snow cover fraction at 0 C, ground temp will not change, so DQSDT2 effectively zero<a name='3118'></font>
                  IF(T1 .GT. 273. .AND. SNOWC(I,J) .GT. 0.)DQSDT2=DQSDT2*(1.-SNOWC(I,J))<a name='3119'>
                ENDIF<a name='3120'>
      <a name='3121'>
                <font color=#447700>! Land-ice or land points use the usual deep-soil temperature.<a name='3122'></font>
                TBOT=TMN(I,J)<a name='3123'>
      <a name='3124'>
                IF(VEGTYP.EQ.25) SHDFAC=0.0000<a name='3125'>
                IF(VEGTYP.EQ.26) SHDFAC=0.0000<a name='3126'>
                IF(VEGTYP.EQ.27) SHDFAC=0.0000<a name='3127'>
                IF(SOILTYP.EQ.14.AND.XICE(I,J).EQ.0.)THEN<a name='3128'>
#if 0<a name='3129'>
               IF(IPRINT)PRINT*,' SOIL TYPE FOUND TO BE WATER AT A LAND-POINT'<a name='3130'>
               IF(IPRINT)PRINT*,i,j,'RESET SOIL in surfce.F'<a name='3131'>
#endif<a name='3132'>
                  SOILTYP=7<a name='3133'>
                ENDIF<a name='3134'>
                SNOALB1 = SNOALB(I,J)<a name='3135'>
                CMC=CANWAT(I,J)<a name='3136'>
      <a name='3137'>
      <font color=#447700>!-------------------------------------------<a name='3138'></font>
      <font color=#447700>!*** convert snow depth from mm to meter<a name='3139'></font>
      <font color=#447700>!<a name='3140'></font>
      <font color=#447700>!          IF(RDMAXALB) THEN<a name='3141'></font>
      <font color=#447700>!           SNOALB=ALBMAX(I,J)*0.01<a name='3142'></font>
      <font color=#447700>!         ELSE<a name='3143'></font>
      <font color=#447700>!           SNOALB=MAXALB(IVGTPK)*0.01<a name='3144'></font>
      <font color=#447700>!         ENDIF<a name='3145'></font>
      <a name='3146'>
      <font color=#447700>!        SNOALB1=0.80<a name='3147'></font>
      <font color=#447700>!        SHMIN=0.00<a name='3148'></font>
              ALBBRD=ALBBCK(I,J)<a name='3149'>
              Z0BRD=Z0(I,J)<a name='3150'>
              EMBRD=EMBCK(I,J)<a name='3151'>
              SNOTIME1 = SNOTIME(I,J)<a name='3152'>
              RIBB=RIB(I,J)<a name='3153'>
      <font color=#447700>!FEI: temporaray arrays above need to be changed later by using SI<a name='3154'></font>
      <a name='3155'>
                DO NS=1,NSOIL<a name='3156'>
                  SMC(NS)=SMOIS(I,NS,J)<a name='3157'>
                  STC(NS)=TSLB(I,NS,J)                                          <font color=#447700>!STEMP<a name='3158'></font>
                  SWC(NS)=SH2O(I,NS,J)<a name='3159'>
                ENDDO<a name='3160'>
      <font color=#447700>!<a name='3161'></font>
                if ( (SNEQV.ne.0..AND.SNOWHK.eq.0.).or.(SNOWHK.le.SNEQV) )THEN<a name='3162'>
                  SNOWHK= 5.*SNEQV<a name='3163'>
                endif<a name='3164'>
      <font color=#447700>!<a name='3165'></font>
      <a name='3166'>
      <font color=#447700>!Fei: urban. for urban surface, if calling UCM, redefine the natural surface in cities as<a name='3167'></font>
      <font color=#447700>! the "NATURAL" category in the VEGPARM.TBL<a name='3168'></font>
      	<a name='3169'>
      	<font color=#447700>!   IF(SF_URBAN_PHYSICS == 1.OR. SF_URBAN_PHYSICS==2.OR.SF_URBAN_PHYSICS==3 ) THEN<a name='3170'></font>
                       <a name='3171'>
      <a name='3172'>
           <font color=#447700>!           IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='3173'></font>
           <font color=#447700>!            IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='3174'></font>
           <font color=#447700>!	 VEGTYP = NATURAL<a name='3175'></font>
           <font color=#447700>!            SHDFAC = SHDTBL(NATURAL)<a name='3176'></font>
           <font color=#447700>!            ALBEDOK =0.2         !  0.2<a name='3177'></font>
           <font color=#447700>!            ALBBRD  =0.2         !0.2<a name='3178'></font>
           <font color=#447700>!            EMISSI = 0.98                                 !for VEGTYP=5<a name='3179'></font>
           <font color=#447700>!	 IF ( FRC_URB2D(I,J) &lt; 0.99 ) THEN<a name='3180'></font>
          <font color=#447700>!               if(sf_urban_physics.eq.1)then<a name='3181'></font>
          <font color=#447700>!       T1= ( TSK(I,J) -FRC_URB2D(I,J) * TS_URB2D (I,J) )/ (1-FRC_URB2D(I,J))<a name='3182'></font>
          <font color=#447700>!               elseif((sf_urban_physics.eq.2).OR.(sf_urban_physics.eq.3))then<a name='3183'></font>
          <font color=#447700>!            r1= (tsk(i,j)**4.)<a name='3184'></font>
          <font color=#447700>!            r2= frc_urb2d(i,j)*(ts_urb2d(i,j)**4.)<a name='3185'></font>
          <font color=#447700>!            r3= (1.-frc_urb2d(i,j))<a name='3186'></font>
         <font color=#447700>!             t1= ((r1-r2)/r3)**.25<a name='3187'></font>
         <font color=#447700>!                endif<a name='3188'></font>
         <font color=#447700>!	         ELSE<a name='3189'></font>
         <font color=#447700>!		 T1 = TSK(I,J)<a name='3190'></font>
         <font color=#447700>!              ENDIF<a name='3191'></font>
         <font color=#447700>!             ENDIF<a name='3192'></font>
          <font color=#447700>!       ELSE<a name='3193'></font>
           <font color=#447700>!            IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='3194'></font>
          <font color=#447700>!              IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='3195'></font>
           <font color=#447700>!             VEGTYP = ISURBAN<a name='3196'></font>
           <font color=#447700>!      	 ENDIF<a name='3197'></font>
           <font color=#447700>!      ENDIF<a name='3198'></font>
      <a name='3199'>
            Noah_call=.TRUE.<a name='3200'>
      <a name='3201'>
            If ( SF_URBAN_PHYSICS == 0 ) THEN   <font color=#447700>! ONLY NOAH<a name='3202'></font>
      <a name='3203'>
                 IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='3204'>
                       IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='3205'>
                       Noah_call = .TRUE.                 <a name='3206'>
                       VEGTYP = ISURBAN<a name='3207'>
                 ENDIF<a name='3208'>
      <a name='3209'>
            ENDIF<a name='3210'>
            <a name='3211'>
            IF(SF_URBAN_PHYSICS == 1) THEN<a name='3212'>
      <a name='3213'>
                 IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='3214'>
                       IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN   <a name='3215'>
              	<a name='3216'>
                       Noah_call = .TRUE.                       <a name='3217'>
              	       VEGTYP = NATURAL                                              <a name='3218'>
                       SHDFAC = SHDTBL(NATURAL)<a name='3219'>
                       ALBEDOK =0.2         <font color=#447700>!  0.2<a name='3220'></font>
                       ALBBRD  =0.2         <font color=#447700>!  0.2<a name='3221'></font>
                       EMISSI = 0.98        <font color=#447700>!  for VEGTYP=5       <a name='3222'></font>
                       <a name='3223'>
      		      T1= TS_RUL2D_mosaic(I,mosaic_i,J)<a name='3224'>
                       <a name='3225'>
                 ENDIF<a name='3226'>
      <a name='3227'>
            ENDIF<a name='3228'>
<a name='3229'>
<font color=#447700>!===Yang, 2014/10/08, hydrological processes for urban vegetation in single layer UCM===<a name='3230'></font>
           AOASIS = 1.0<a name='3231'>
           USOIL = 1<a name='3232'>
           DSOIL = 2<a name='3233'>
           IRIOPTION=IRI_SCHEME<a name='3234'>
           OMG= OMG_URB2D(I,J)   <a name='3235'>
           tloc=mod(int(OMG/3.14159*180./15.+12.+0.5 ),24)<a name='3236'>
           if (tloc.lt.0) tloc=tloc+24<a name='3237'>
           if (tloc==0) tloc=24<a name='3238'>
           CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>cal_mon_day</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_8">(julian,julyr,jmonth,jday) <a name='3239'>
	  IF(SF_URBAN_PHYSICS == 1) THEN<a name='3240'>
           IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='3241'>
                IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='3242'>
            AOASIS = oasis  <font color=#447700>! urban oasis effect<a name='3243'></font>
                   IF (IRIOPTION ==1) THEN<a name='3244'>
                   IF (tloc==21 .or. tloc==22) THEN  <font color=#447700>!irrigation on vegetaion in urban area, MAY-SEP, 9-10pm<a name='3245'></font>
                   IF (jmonth==5 .or. jmonth==6 .or. jmonth==7 .or. jmonth==8 .or. jmonth==9) THEN<a name='3246'>
                      IF (SMC(USOIL) .LT. SMCREF) SMC(USOIL)= REFSMC(ISLTYP(I,J))<a name='3247'>
                      IF (SMC(DSOIL) .LT. SMCREF) SMC(DSOIL)= REFSMC(ISLTYP(I,J))<a name='3248'>
                   ENDIF<a name='3249'>
                   ENDIF<a name='3250'>
                   ENDIF<a name='3251'>
                ENDIF<a name='3252'>
           ENDIF<a name='3253'>
<a name='3254'>
	  IF(SF_URBAN_PHYSICS == 2 .or. SF_URBAN_PHYSICS == 3) THEN<a name='3255'>
          IF(AOASIS &gt; 1.0) THEN<a name='3256'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1167">('Urban oasis option is for SF_URBAN_PHYSICS == 1 only')<a name='3257'>
          ENDIF<a name='3258'>
          IF(IRIOPTION == 1) THEN<a name='3259'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1168">('Urban irrigation option is for SF_URBAN_PHYSICS == 1 only')<a name='3260'>
          ENDIF<a name='3261'>
          ENDIF<a name='3262'>
            <a name='3263'>
            IF( SF_URBAN_PHYSICS==2.OR.SF_URBAN_PHYSICS==3 ) THEN<a name='3264'>
<font color=#447700>!             print*, 'MOSAIC is not designed to work with SF_URBAN_PHYSICS=2 or SF_URBAN_PHYSICS=3'<a name='3265'></font>
            ENDIF<a name='3266'>
      <a name='3267'>
         IF (Noah_call) THEN<a name='3268'>
#if 0<a name='3269'>
                IF(IPRINT) THEN<a name='3270'>
      <font color=#447700>!<a name='3271'></font>
             print*, 'BEFORE SFLX, in Noahlsm_driver'<a name='3272'>
             print*, 'ICE', ICE, 'DT',DT, 'ZLVL',ZLVL, 'NSOIL', NSOIL,   &amp;<a name='3273'>
             'SLDPTH', SLDPTH, 'LOCAL',LOCAL, 'LUTYPE',&amp;<a name='3274'>
              LUTYPE, 'SLTYPE',SLTYPE, 'LWDN',LWDN, 'SOLDN',SOLDN,      &amp;<a name='3275'>
              'SFCPRS',SFCPRS, 'PRCP',PRCP,'SFCTMP',SFCTMP,'Q2K',Q2K,   &amp;<a name='3276'>
               'TH2',TH2,'Q2SAT',Q2SAT,'DQSDT2',DQSDT2,'VEGTYP', VEGTYP,&amp;<a name='3277'>
               'SOILTYP',SOILTYP, 'SLOPETYP',SLOPETYP, 'SHDFAC',SHDFAC,&amp;<a name='3278'>
               'SHMIN',SHMIN, 'ALBBRD',ALBBRD,'SNOALB1',SNOALB1,'TBOT',&amp;<a name='3279'>
                TBOT, 'Z0BRD',Z0BRD, 'Z0K',Z0K, 'CMC',CMC, 'T1',T1,'STC',&amp;<a name='3280'>
                STC, 'SMC',SMC, 'SWC',SWC,'SNOWHK',SNOWHK,'SNEQV',SNEQV,&amp;<a name='3281'>
                'ALBEDOK',ALBEDOK,'CHK',CHK,'ETA',ETA,'SHEAT',SHEAT,      &amp;<a name='3282'>
                'ETA_KINEMATIC',ETA_KINEMATIC, 'FDOWN',FDOWN,'EC',EC,   &amp;<a name='3283'>
                'EDIR',EDIR,'ET',ET,'ETT',ETT,'ESNOW',ESNOW,'DRIP',DRIP,&amp;<a name='3284'>
                'DEW',DEW,'BETA',BETA,'ETP',ETP,'SSOIL',SSOIL,'FLX1',FLX1,&amp;<a name='3285'>
                'FLX2',FLX2,'FLX3',FLX3,'SNOMLT',SNOMLT,'SNCOVR',SNCOVR,&amp;<a name='3286'>
                'RUNOFF1',RUNOFF1,'RUNOFF2',RUNOFF2,'RUNOFF3',RUNOFF3, &amp;<a name='3287'>
                'RC',RC, 'PC',PC,'RSMIN',RSMIN,'XLAI',XLAI,'RCS',RCS,  &amp;<a name='3288'>
                'RCT',RCT,'RCQ',RCQ,'RCSOIL',RCSOIL,'SOILW',SOILW,     &amp;<a name='3289'>
                'SOILM',SOILM,'Q1',Q1,'SMCWLT',SMCWLT,'SMCDRY',SMCDRY,&amp;<a name='3290'>
                'SMCREF',SMCREF,'SMCMAX',SMCMAX,'NROOT',NROOT<a name='3291'>
                 endif<a name='3292'>
#endif<a name='3293'>
      <a name='3294'>
                IF (rdlai2d) THEN<a name='3295'>
                   xlai = lai(i,j)<a name='3296'>
                endif<a name='3297'>
      <a name='3298'>
          IF ( ICE == 1 ) THEN<a name='3299'>
      <a name='3300'>
             <font color=#447700>! Sea-ice case<a name='3301'></font>
      <a name='3302'>
             DO NS = 1, NSOIL<a name='3303'>
                SH2O(I,NS,J) = 1.0<a name='3304'>
             ENDDO<a name='3305'>
             LAI(I,J) = 0.01<a name='3306'>
      <a name='3307'>
             CYCLE ILOOP<a name='3308'>
      <a name='3309'>
          ELSEIF (ICE == 0) THEN<a name='3310'>
      <a name='3311'>
             <font color=#447700>! Non-glacial land<a name='3312'></font>
      <a name='3313'>
             CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX'>SFLX</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFLX_2"> (I,J,FFROZP, ISURBAN, DT,ZLVL,NSOIL,SLDPTH,       &amp;    <font color=#447700>!C<a name='3314'></font>
                       LOCAL,                                            &amp;    <font color=#447700>!L<a name='3315'></font>
                       LUTYPE, SLTYPE,                                   &amp;    <font color=#447700>!CL<a name='3316'></font>
                       LWDN,SOLDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2K,DUMMY,   &amp;    <font color=#447700>!F<a name='3317'></font>
                       DUMMY,DUMMY, DUMMY,                               &amp;    <font color=#447700>!F PRCPRAIN not used<a name='3318'></font>
                       TH2,Q2SAT,DQSDT2,                                 &amp;    <font color=#447700>!I<a name='3319'></font>
                       VEGTYP,SOILTYP,SLOPETYP,SHDFAC,SHMIN,SHMAX,       &amp;    <font color=#447700>!I<a name='3320'></font>
                       ALBBRD, SNOALB1,TBOT, Z0BRD, Z0K, EMISSI, EMBRD,  &amp;    <font color=#447700>!S<a name='3321'></font>
                       CMC,T1,STC,SMC,SWC,SNOWHK,SNEQV,ALBEDOK,CHK,dummy,&amp;    <font color=#447700>!H<a name='3322'></font>
                       ETA,SHEAT, ETA_KINEMATIC,FDOWN,                   &amp;    <font color=#447700>!O<a name='3323'></font>
                       EC,EDIR,ET,ETT,ESNOW,DRIP,DEW,                    &amp;    <font color=#447700>!O<a name='3324'></font>
                       BETA,ETP,SSOIL,                                   &amp;    <font color=#447700>!O<a name='3325'></font>
                       FLX1,FLX2,FLX3,                                   &amp;    <font color=#447700>!O<a name='3326'></font>
      		 FLX4,FVB,FBUR,FGSN,UA_PHYS,                             &amp;    <font color=#447700>!UA <a name='3327'></font>
                       SNOMLT,SNCOVR,                                    &amp;    <font color=#447700>!O<a name='3328'></font>
                       RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;    <font color=#447700>!O<a name='3329'></font>
                       RC,PC,RSMIN,XLAI,RCS,RCT,RCQ,RCSOIL,              &amp;    <font color=#447700>!O<a name='3330'></font>
                       SOILW,SOILM,Q1,SMAV,                              &amp;    <font color=#447700>!D<a name='3331'></font>
                       RDLAI2D,USEMONALB,                                &amp;<a name='3332'>
                       SNOTIME1,                                         &amp;<a name='3333'>
                       RIBB,                                             &amp;<a name='3334'>
                       SMCWLT,SMCDRY,SMCREF,SMCMAX,NROOT,                &amp;<a name='3335'>
                       sfcheadrt(i,j),                                   &amp;    <font color=#447700>!I<a name='3336'></font>
                       INFXSRT(i,j),ETPND1,OPT_THCND,AOASIS              &amp;    <font color=#447700>!O<a name='3337'></font>
                ,XSDA_QFX, HFX_PHY, QFX_PHY, XQNORM, fasdas, HCPCT_FASDAS    &amp; <font color=#447700>! fasdas vars<a name='3338'></font>
                       )<a name='3339'>
      <a name='3340'>
#ifdef WRF_HYDRO<a name='3341'>
                       soldrain(i,j) = RUNOFF2*DT*1000.0<a name='3342'>
#endif<a name='3343'>
          ELSEIF (ICE == -1) THEN<a name='3344'>
      <a name='3345'>
             <font color=#447700>!<a name='3346'></font>
             <font color=#447700>! Set values that the LSM is expected to update,<a name='3347'></font>
             <font color=#447700>! but don't get updated for glacial points.<a name='3348'></font>
             <font color=#447700>!<a name='3349'></font>
             SOILM = 0.0 <font color=#447700>!BSINGH(PNNL)- SOILM is undefined for this case, it is used for diagnostics so setting it to zero<a name='3350'></font>
             XLAI = 0.01 <font color=#447700>! KWM Should this be Zero over land ice?  Does this value matter?<a name='3351'></font>
             RUNOFF2 = 0.0<a name='3352'>
             RUNOFF3 = 0.0<a name='3353'>
             DO NS = 1, NSOIL<a name='3354'>
                SWC(NS) = 1.0<a name='3355'>
                SMC(NS) = 1.0<a name='3356'>
                SMAV(NS) = 1.0<a name='3357'>
             ENDDO<a name='3358'>
             CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL'>SFLX_GLACIAL</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFLX_GLACIAL_2">(I,J,ISICE,FFROZP,DT,ZLVL,NSOIL,SLDPTH,   &amp;    <font color=#447700>!C<a name='3359'></font>
                  &amp;    LWDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2K,              &amp;    <font color=#447700>!F<a name='3360'></font>
                  &amp;    TH2,Q2SAT,DQSDT2,                                &amp;    <font color=#447700>!I<a name='3361'></font>
                  &amp;    ALBBRD, SNOALB1,TBOT, Z0BRD, Z0K, EMISSI, EMBRD, &amp;    <font color=#447700>!S<a name='3362'></font>
                  &amp;    T1,STC(1:NSOIL),SNOWHK,SNEQV,ALBEDOK,CHK,        &amp;    <font color=#447700>!H<a name='3363'></font>
                  &amp;    ETA,SHEAT,ETA_KINEMATIC,FDOWN,                   &amp;    <font color=#447700>!O<a name='3364'></font>
                  &amp;    ESNOW,DEW,                                       &amp;    <font color=#447700>!O<a name='3365'></font>
                  &amp;    ETP,SSOIL,                                       &amp;    <font color=#447700>!O<a name='3366'></font>
                  &amp;    FLX1,FLX2,FLX3,                                  &amp;    <font color=#447700>!O<a name='3367'></font>
                  &amp;    SNOMLT,SNCOVR,                                   &amp;    <font color=#447700>!O<a name='3368'></font>
                  &amp;    RUNOFF1,                                         &amp;    <font color=#447700>!O<a name='3369'></font>
                  &amp;    Q1,                                              &amp;    <font color=#447700>!D<a name='3370'></font>
                  &amp;    SNOTIME1,                                        &amp;<a name='3371'>
                  &amp;    RIBB)<a name='3372'>
      <a name='3373'>
          ENDIF<a name='3374'>
      <a name='3375'>
             lai(i,j) = xlai<a name='3376'>
      <a name='3377'>
#if 0<a name='3378'>
                IF(IPRINT) THEN<a name='3379'>
      <a name='3380'>
             print*, 'AFTER SFLX, in Noahlsm_driver'<a name='3381'>
             print*, 'ICE', ICE, 'DT',DT, 'ZLVL',ZLVL, 'NSOIL', NSOIL,   &amp;<a name='3382'>
             'SLDPTH', SLDPTH, 'LOCAL',LOCAL, 'LUTYPE',&amp;<a name='3383'>
              LUTYPE, 'SLTYPE',SLTYPE, 'LWDN',LWDN, 'SOLDN',SOLDN,      &amp;<a name='3384'>
              'SFCPRS',SFCPRS, 'PRCP',PRCP,'SFCTMP',SFCTMP,'Q2K',Q2K,   &amp;<a name='3385'>
               'TH2',TH2,'Q2SAT',Q2SAT,'DQSDT2',DQSDT2,'VEGTYP', VEGTYP,&amp;<a name='3386'>
                'SOILTYP',SOILTYP, 'SLOPETYP',SLOPETYP, 'SHDFAC',SHDFAC,&amp;<a name='3387'>
               'SHDMIN',SHMIN, 'ALBBRD',ALBBRD,'SNOALB',SNOALB1,'TBOT',&amp;<a name='3388'>
                TBOT, 'Z0BRD',Z0BRD, 'Z0K',Z0K, 'CMC',CMC, 'T1',T1,'STC',&amp;<a name='3389'>
                STC, 'SMC',SMC, 'SWc',SWC,'SNOWHK',SNOWHK,'SNEQV',SNEQV,&amp;<a name='3390'>
                'ALBEDOK',ALBEDOK,'CHK',CHK,'ETA',ETA,'SHEAT',SHEAT,      &amp;<a name='3391'>
                'ETA_KINEMATIC',ETA_KINEMATIC, 'FDOWN',FDOWN,'EC',EC,   &amp;<a name='3392'>
                'EDIR',EDIR,'ET',ET,'ETT',ETT,'ESNOW',ESNOW,'DRIP',DRIP,&amp;<a name='3393'>
                'DEW',DEW,'BETA',BETA,'ETP',ETP,'SSOIL',SSOIL,'FLX1',FLX1,&amp;<a name='3394'>
                'FLX2',FLX2,'FLX3',FLX3,'SNOMLT',SNOMLT,'SNCOVR',SNCOVR,&amp;<a name='3395'>
                'RUNOFF1',RUNOFF1,'RUNOFF2',RUNOFF2,'RUNOFF3',RUNOFF3, &amp;<a name='3396'>
                'RC',RC, 'PC',PC,'RSMIN',RSMIN,'XLAI',XLAI,'RCS',RCS,  &amp;<a name='3397'>
                'RCT',RCT,'RCQ',RCQ,'RCSOIL',RCSOIL,'SOILW',SOILW,     &amp;<a name='3398'>
                'SOILM',SOILM,'Q1',Q1,'SMCWLT',SMCWLT,'SMCDRY',SMCDRY,&amp;<a name='3399'>
                'SMCREF',SMCREF,'SMCMAX',SMCMAX,'NROOT',NROOT<a name='3400'>
                 endif<a name='3401'>
#endif<a name='3402'>
      <a name='3403'>
      <font color=#447700>!***  UPDATE STATE VARIABLES<a name='3404'></font>
                CANWAT(I,J)=CMC<a name='3405'>
                SNOW(I,J)=SNEQV*1000.<a name='3406'>
      <font color=#447700>!          SNOWH(I,J)=SNOWHK*1000.<a name='3407'></font>
                SNOWH(I,J)=SNOWHK                   <font color=#447700>! SNOWHK in meters<a name='3408'></font>
                ALBEDO(I,J)=ALBEDOK<a name='3409'>
                ALB_RURAL(I,J)=ALBEDOK<a name='3410'>
                ALBBCK(I,J)=ALBBRD<a name='3411'>
                Z0(I,J)=Z0BRD<a name='3412'>
                EMISS(I,J) = EMISSI<a name='3413'>
                EMISS_RURAL(I,J) = EMISSI<a name='3414'>
      <font color=#447700>! Noah: activate time-varying roughness length (V3.3 Feb 2011)<a name='3415'></font>
                ZNT(I,J)=Z0K<a name='3416'>
                TSK(I,J)=T1<a name='3417'>
                TSK_RURAL(I,J)=T1<a name='3418'>
                HFX(I,J)=SHEAT<a name='3419'>
                HFX_RURAL(I,J)=SHEAT<a name='3420'>
      <font color=#447700>! MEk Jul07 add potential evap accum<a name='3421'></font>
              POTEVP(I,J)=POTEVP(I,J)+ETP*FDTW<a name='3422'>
                QFX(I,J)=ETA_KINEMATIC<a name='3423'>
                QFX_RURAL(I,J)=ETA_KINEMATIC<a name='3424'>
      <a name='3425'>
#ifdef WRF_HYDRO<a name='3426'>
      <font color=#447700>!added by Wei Yu<a name='3427'></font>
      <font color=#447700>!         QFX(I,J) = QFX(I,J) + ETPND1<a name='3428'></font>
      <font color=#447700>!         ETA = ETA + ETPND1/2.501E6*dt<a name='3429'></font>
      <font color=#447700>!end added by Wei Yu<a name='3430'></font>
#endif<a name='3431'>
      <a name='3432'>
                LH(I,J)=ETA<a name='3433'>
                LH_RURAL(I,J)=ETA<a name='3434'>
                GRDFLX(I,J)=SSOIL<a name='3435'>
                GRDFLX_RURAL(I,J)=SSOIL<a name='3436'>
                SNOWC(I,J)=SNCOVR<a name='3437'>
                CHS2(I,J)=CQS2(I,J)<a name='3438'>
                SNOTIME(I,J) = SNOTIME1<a name='3439'>
      <font color=#447700>!      prevent diagnostic ground q (q1) from being greater than qsat(tsk)<a name='3440'></font>
      <font color=#447700>!      as happens over snow cover where the cqs2 value also becomes irrelevant<a name='3441'></font>
      <font color=#447700>!      by setting cqs2=chs in this situation the 2m q should become just qv(k=1)<a name='3442'></font>
                IF (Q1 .GT. QSFC(I,J)) THEN<a name='3443'>
                  CQS2(I,J) = CHS(I,J)<a name='3444'>
                ENDIF<a name='3445'>
      <font color=#447700>!          QSFC(I,J)=Q1<a name='3446'></font>
      <font color=#447700>! Convert QSFC back to mixing ratio<a name='3447'></font>
                 QSFC(I,J)= Q1/(1.0-Q1)<a name='3448'>
      <font color=#447700>!<a name='3449'></font>
                 <font color=#447700>! QSFC_RURAL(I,J)= Q1/(1.0-Q1)<a name='3450'></font>
      <font color=#447700>! Calculate momentum flux from rural surface for use with multi-layer UCM (Martilli et al. 2002)<a name='3451'></font>
      <a name='3452'>
                DO 81 NS=1,NSOIL<a name='3453'>
                 SMOIS(I,NS,J)=SMC(NS)<a name='3454'>
                 TSLB(I,NS,J)=STC(NS)                                        <font color=#447700>!  STEMP<a name='3455'></font>
                 SH2O(I,NS,J)=SWC(NS)<a name='3456'>
         81     CONTINUE<a name='3457'>
      <font color=#447700>!       ENDIF<a name='3458'></font>
      <a name='3459'>
              FLX4_2D(I,J)  = FLX4<a name='3460'>
      	FVB_2D(I,J)   = FVB<a name='3461'>
      	FBUR_2D(I,J)  = FBUR<a name='3462'>
      	FGSN_2D(I,J)  = FGSN<a name='3463'>
      <a name='3464'>
           <font color=#447700>!<a name='3465'></font>
           <font color=#447700>! Residual of surface energy balance equation terms<a name='3466'></font>
           <font color=#447700>!<a name='3467'></font>
      <a name='3468'>
           IF ( UA_PHYS ) THEN<a name='3469'>
               noahres(i,j) = ( solnet + lwdn ) - sheat + ssoil - eta &amp;<a name='3470'>
                    - ( emissi * STBOLT * (t1**4) ) - flx1 - flx2 - flx3 - flx4<a name='3471'>
      <a name='3472'>
           ELSE<a name='3473'>
               noahres(i,j) = ( solnet + lwdn ) - sheat + ssoil - eta &amp;<a name='3474'>
                    - ( emissi * STBOLT * (t1**4) ) - flx1 - flx2 - flx3<a name='3475'>
           ENDIF<a name='3476'>
      <a name='3477'>
               ENDIF   <font color=#447700>!ENDIF FOR Noah_call<a name='3478'></font>
               <a name='3479'>
              IF (SF_URBAN_PHYSICS == 1 ) THEN                                              <font color=#447700>! Beginning of UCM CALL if block<a name='3480'></font>
      <font color=#447700>!--------------------------------------<a name='3481'></font>
      <font color=#447700>! URBAN CANOPY MODEL START - urban<a name='3482'></font>
      <font color=#447700>!--------------------------------------<a name='3483'></font>
      <font color=#447700>! Input variables lsm --&gt; urban<a name='3484'></font>
      <a name='3485'>
                IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='3486'>
                    IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL ) THEN            <a name='3487'>
      <a name='3488'>
                <font color=#447700>!  UTYPE_URB = UTYPE_URB2D(I,J) !urban type (low, high or industrial)<a name='3489'></font>
                <font color=#447700>!  this need to be changed in the mosaic danli<a name='3490'></font>
      <a name='3491'>
                IF(IVGTYP(I,J)==ISURBAN) UTYPE_URB=2<a name='3492'>
                IF(IVGTYP(I,J)==LOW_DENSITY_RESIDENTIAL) UTYPE_URB=1<a name='3493'>
                IF(IVGTYP(I,J)==HIGH_DENSITY_RESIDENTIAL) UTYPE_URB=2<a name='3494'>
                IF(IVGTYP(I,J)==HIGH_INTENSITY_INDUSTRIAL) UTYPE_URB=3<a name='3495'>
                        <a name='3496'>
                IF(UTYPE_URB==1) FRC_URB2D(I,J)=0.5<a name='3497'>
                IF(UTYPE_URB==2) FRC_URB2D(I,J)=0.9<a name='3498'>
                IF(UTYPE_URB==3) FRC_URB2D(I,J)=0.95<a name='3499'>
      <a name='3500'>
                  TA_URB    = SFCTMP           <font color=#447700>! [K]<a name='3501'></font>
                  QA_URB    = Q2K              <font color=#447700>! [kg/kg]<a name='3502'></font>
                  UA_URB    = SQRT(U_PHY(I,1,J)**2.+V_PHY(I,1,J)**2.)<a name='3503'>
                  U1_URB    = U_PHY(I,1,J)<a name='3504'>
                  V1_URB    = V_PHY(I,1,J)<a name='3505'>
                  IF(UA_URB &lt; 1.) UA_URB=1.    <font color=#447700>! [m/s]<a name='3506'></font>
                  SSG_URB   = SOLDN            <font color=#447700>! [W/m/m]<a name='3507'></font>
                  SSGD_URB  = 0.8*SOLDN        <font color=#447700>! [W/m/m]<a name='3508'></font>
                  SSGQ_URB  = SSG_URB-SSGD_URB <font color=#447700>! [W/m/m]<a name='3509'></font>
                  LLG_URB   = GLW(I,J)         <font color=#447700>! [W/m/m]<a name='3510'></font>
                  RAIN_URB  = RAINBL(I,J)      <font color=#447700>! [mm]<a name='3511'></font>
                  RHOO_URB  = SFCPRS / (287.04 * SFCTMP * (1.0+ 0.61 * Q2K)) <font color=#447700>![kg/m/m/m]<a name='3512'></font>
                  ZA_URB    = ZLVL             <font color=#447700>! [m]<a name='3513'></font>
                  DELT_URB  = DT               <font color=#447700>! [sec]<a name='3514'></font>
                  XLAT_URB  = XLAT_URB2D(I,J)  <font color=#447700>! [deg]<a name='3515'></font>
                  COSZ_URB  = COSZ_URB2D(I,J)  <font color=#447700>!<a name='3516'></font>
                  OMG_URB   = OMG_URB2D(I,J)   <font color=#447700>!<a name='3517'></font>
                  ZNT_URB   = ZNT(I,J)<a name='3518'>
      <a name='3519'>
                  LSOLAR_URB = .FALSE.<a name='3520'>
                  <a name='3521'>
      <font color=#447700>! mosaic 3D to 2D<a name='3522'></font>
      <a name='3523'>
         TR_URB2D(I,J)=TR_URB2D_mosaic(I,mosaic_i,J)                         <font color=#447700>! replace it with the mosaic one          <a name='3524'></font>
         TB_URB2D(I,J)=TB_URB2D_mosaic(I,mosaic_i,J)                         <font color=#447700>! replace it with the mosaic one          <a name='3525'></font>
         TG_URB2D(I,J)=TG_URB2D_mosaic(I,mosaic_i,J)                         <font color=#447700>! replace it with the mosaic one          <a name='3526'></font>
         TC_URB2D(I,J)=TC_URB2D_mosaic(I,mosaic_i,J)                         <font color=#447700>! replace it with the mosaic one          <a name='3527'></font>
         QC_URB2D(I,J)=QC_URB2D_mosaic(I,mosaic_i,J)                         <font color=#447700>! replace it with the mosaic one          <a name='3528'></font>
         UC_URB2D(I,J)=UC_URB2D_mosaic(I,mosaic_i,J)                         <font color=#447700>! replace it with the mosaic one          <a name='3529'></font>
         TS_URB2D(I,J)=TS_URB2D_mosaic(I,mosaic_i,J)                         <font color=#447700>! replace it with the mosaic one          <a name='3530'></font>
      <a name='3531'>
                  DO K = 1,num_roof_layers<a name='3532'>
                    TRL_URB3D(I,K,J) = TRL_URB3D_mosaic(I,K+(mosaic_i-1)*num_roof_layers,J)<a name='3533'>
                  END DO<a name='3534'>
                  DO K = 1,num_wall_layers<a name='3535'>
                    TBL_URB3D(I,K,J) = TBL_URB3D_mosaic(I,K+(mosaic_i-1)*num_roof_layers,J)<a name='3536'>
                  END DO<a name='3537'>
                  DO K = 1,num_road_layers<a name='3538'>
                    TGL_URB3D(I,K,J) = TGL_URB3D_mosaic(I,K+(mosaic_i-1)*num_roof_layers,J)<a name='3539'>
                  END DO<a name='3540'>
      <a name='3541'>
      <font color=#447700>! mosaic 2D to 1D            <a name='3542'></font>
      <a name='3543'>
                  TR_URB = TR_URB2D(I,J)<a name='3544'>
                  TB_URB = TB_URB2D(I,J)<a name='3545'>
                  TG_URB = TG_URB2D(I,J)<a name='3546'>
                  TC_URB = TC_URB2D(I,J)<a name='3547'>
                  QC_URB = QC_URB2D(I,J)<a name='3548'>
                  UC_URB = UC_URB2D(I,J)<a name='3549'>
      <a name='3550'>
                  DO K = 1,num_roof_layers<a name='3551'>
                    TRL_URB(K) = TRL_URB3D(I,K,J)<a name='3552'>
                    SMR_URB(K) = SMR_URB3D(I,K,J)<a name='3553'>
                    TGRL_URB(K)= TGRL_URB3D(I,K,J)<a name='3554'>
                  END DO<a name='3555'>
                  DO K = 1,num_wall_layers<a name='3556'>
                    TBL_URB(K) = TBL_URB3D(I,K,J)<a name='3557'>
                  END DO<a name='3558'>
                  DO K = 1,num_road_layers<a name='3559'>
                    TGL_URB(K) = TGL_URB3D(I,K,J)<a name='3560'>
                  END DO<a name='3561'>
                  <a name='3562'>
                  TGR_URB   = TGR_URB2D(I,J)<a name='3563'>
                  CMCR_URB  = CMCR_URB2D(I,J)<a name='3564'>
                  FLXHUMR_URB = FLXHUMR_URB2D(I,J)<a name='3565'>
                  FLXHUMB_URB = FLXHUMB_URB2D(I,J)<a name='3566'>
                  FLXHUMG_URB = FLXHUMG_URB2D(I,J)<a name='3567'>
                  DRELR_URB = DRELR_URB2D(I,J)<a name='3568'>
                  DRELB_URB = DRELB_URB2D(I,J)<a name='3569'>
                  DRELG_URB = DRELG_URB2D(I,J)<a name='3570'>
      <a name='3571'>
                  XXXR_URB = XXXR_URB2D(I,J)<a name='3572'>
                  XXXB_URB = XXXB_URB2D(I,J)<a name='3573'>
                  XXXG_URB = XXXG_URB2D(I,J)<a name='3574'>
                  XXXC_URB = XXXC_URB2D(I,J)<a name='3575'>
      <font color=#447700>!<a name='3576'></font>
      <font color=#447700>!      Limits to avoid dividing by small number<a name='3577'></font>
                  if (CHS(I,J) &lt; 1.0E-02) then<a name='3578'>
                     CHS(I,J)  = 1.0E-02<a name='3579'>
                  endif<a name='3580'>
                  if (CHS2(I,J) &lt; 1.0E-02) then<a name='3581'>
                     CHS2(I,J)  = 1.0E-02<a name='3582'>
                  endif<a name='3583'>
                  if (CQS2(I,J) &lt; 1.0E-02) then<a name='3584'>
                     CQS2(I,J)  = 1.0E-02<a name='3585'>
                  endif<a name='3586'>
      <font color=#447700>!<a name='3587'></font>
                  CHS_URB  = CHS(I,J)<a name='3588'>
                  CHS2_URB = CHS2(I,J)<a name='3589'>
                  IF (PRESENT(CMR_SFCDIF)) THEN<a name='3590'>
                     CMR_URB = CMR_SFCDIF(I,J)<a name='3591'>
                     CHR_URB = CHR_SFCDIF(I,J)<a name='3592'>
                     CMGR_URB = CMGR_SFCDIF(I,J)<a name='3593'>
                     CHGR_URB = CHGR_SFCDIF(I,J)<a name='3594'>
                     CMC_URB = CMC_SFCDIF(I,J)<a name='3595'>
                     CHC_URB = CHC_SFCDIF(I,J)<a name='3596'>
                  ENDIF<a name='3597'>
      <a name='3598'>
      <font color=#447700>! NUDAPT for SLUCM<a name='3599'></font>
                  mh_urb = mh_urb2d(I,J)<a name='3600'>
                  stdh_urb = stdh_urb2d(I,J)<a name='3601'>
                  lp_urb = lp_urb2d(I,J)<a name='3602'>
                  hgt_urb = hgt_urb2d(I,J)<a name='3603'>
                  lf_urb = 0.0<a name='3604'>
                  DO K = 1,4<a name='3605'>
                    lf_urb(K)=lf_urb2d(I,K,J)<a name='3606'>
                  ENDDO<a name='3607'>
                  frc_urb = frc_urb2d(I,J)<a name='3608'>
                  lb_urb = lb_urb2d(I,J)<a name='3609'>
                  check = 0<a name='3610'>
                  if (I.eq.73.and.J.eq.125)THEN<a name='3611'>
                     check = 1<a name='3612'>
                  end if<a name='3613'>
      <font color=#447700>!<a name='3614'></font>
      <font color=#447700>! Call urban<a name='3615'></font>
                  CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>cal_mon_day</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_9">(julian,julyr,jmonth,jday)      <a name='3616'>
                  CALL <A href='../../html_code/phys/module_sf_urban.F.html#URBAN'>urban</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="URBAN_3">(LSOLAR_URB,                                      &amp; <font color=#447700>! I<a name='3617'></font>
                             num_roof_layers,num_wall_layers,num_road_layers, &amp; <font color=#447700>! C<a name='3618'></font>
                             DZR,DZB,DZG,                                     &amp; <font color=#447700>! C<a name='3619'></font>
                             UTYPE_URB,TA_URB,QA_URB,UA_URB,U1_URB,V1_URB,SSG_URB, &amp; <font color=#447700>! I<a name='3620'></font>
                             SSGD_URB,SSGQ_URB,LLG_URB,RAIN_URB,RHOO_URB,     &amp; <font color=#447700>! I<a name='3621'></font>
                             ZA_URB,DECLIN_URB,COSZ_URB,OMG_URB,              &amp; <font color=#447700>! I<a name='3622'></font>
                             XLAT_URB,DELT_URB,ZNT_URB,                       &amp; <font color=#447700>! I<a name='3623'></font>
                             CHS_URB, CHS2_URB,                               &amp; <font color=#447700>! I<a name='3624'></font>
                             TR_URB, TB_URB, TG_URB, TC_URB, QC_URB,UC_URB,   &amp; <font color=#447700>! H<a name='3625'></font>
                             TRL_URB,TBL_URB,TGL_URB,                         &amp; <font color=#447700>! H<a name='3626'></font>
                             XXXR_URB, XXXB_URB, XXXG_URB, XXXC_URB,          &amp; <font color=#447700>! H<a name='3627'></font>
                             TS_URB,QS_URB,SH_URB,LH_URB,LH_KINEMATIC_URB,    &amp; <font color=#447700>! O<a name='3628'></font>
                             SW_URB,ALB_URB,LW_URB,G_URB,RN_URB,PSIM_URB,PSIH_URB, &amp; <font color=#447700>! O<a name='3629'></font>
                             GZ1OZ0_URB,                                      &amp; <font color=#447700>!O<a name='3630'></font>
                             CMR_URB, CHR_URB, CMC_URB, CHC_URB,              &amp;<a name='3631'>
                             U10_URB, V10_URB, TH2_URB, Q2_URB,               &amp; <font color=#447700>! O<a name='3632'></font>
                             UST_URB,mh_urb, stdh_urb, lf_urb, lp_urb,        &amp; <font color=#447700>! 0<a name='3633'></font>
                             hgt_urb,frc_urb,lb_urb, check,CMCR_URB,TGR_URB,  &amp; <font color=#447700>! H<a name='3634'></font>
                             TGRL_URB,SMR_URB,CMGR_URB,CHGR_URB,jmonth,       &amp; <font color=#447700>! H<a name='3635'></font>
                             DRELR_URB,DRELB_URB,                             &amp; <font color=#447700>! H<a name='3636'></font>
                             DRELG_URB,FLXHUMR_URB,FLXHUMB_URB,FLXHUMG_URB)     <a name='3637'>
      <a name='3638'>
#if 0<a name='3639'>
                IF(IPRINT) THEN<a name='3640'>
      <a name='3641'>
             print*, 'AFTER CALL URBAN'<a name='3642'>
             print*,'num_roof_layers',num_roof_layers, 'num_wall_layers',  &amp;<a name='3643'>
              num_wall_layers,                                             &amp;<a name='3644'>
             'DZR',DZR,'DZB',DZB,'DZG',DZG,'UTYPE_URB',UTYPE_URB,'TA_URB', &amp;<a name='3645'>
              TA_URB,                                                      &amp;<a name='3646'>
              'QA_URB',QA_URB,'UA_URB',UA_URB,'U1_URB',U1_URB,'V1_URB',    &amp;<a name='3647'>
               V1_URB,                                                     &amp;<a name='3648'>
               'SSG_URB',SSG_URB,'SSGD_URB',SSGD_URB,'SSGQ_URB',SSGQ_URB,  &amp;<a name='3649'>
              'LLG_URB',LLG_URB,'RAIN_URB',RAIN_URB,'RHOO_URB',RHOO_URB,   &amp;<a name='3650'>
              'ZA_URB',ZA_URB, 'DECLIN_URB',DECLIN_URB,'COSZ_URB',COSZ_URB,&amp;<a name='3651'>
              'OMG_URB',OMG_URB,'XLAT_URB',XLAT_URB,'DELT_URB',DELT_URB,   &amp;<a name='3652'>
               'ZNT_URB',ZNT_URB,'TR_URB',TR_URB, 'TB_URB',TB_URB,'TG_URB',&amp;<a name='3653'>
               TG_URB,'TC_URB',TC_URB,'QC_URB',QC_URB,'TRL_URB',TRL_URB,   &amp;<a name='3654'>
                'TBL_URB',TBL_URB,'TGL_URB',TGL_URB,'XXXR_URB',XXXR_URB,   &amp;<a name='3655'>
               'XXXB_URB',XXXB_URB,'XXXG_URB',XXXG_URB,'XXXC_URB',XXXC_URB,&amp;<a name='3656'>
               'TS_URB',TS_URB,'QS_URB',QS_URB,'SH_URB',SH_URB,'LH_URB',   &amp;<a name='3657'>
               LH_URB, 'LH_KINEMATIC_URB',LH_KINEMATIC_URB,'SW_URB',SW_URB,&amp;<a name='3658'>
               'ALB_URB',ALB_URB,'LW_URB',LW_URB,'G_URB',G_URB,'RN_URB',   &amp;<a name='3659'>
                RN_URB, 'PSIM_URB',PSIM_URB,'PSIH_URB',PSIH_URB,          &amp;<a name='3660'>
               'U10_URB',U10_URB,'V10_URB',V10_URB,'TH2_URB',TH2_URB,      &amp;<a name='3661'>
                'Q2_URB',Q2_URB,'CHS_URB',CHS_URB,'CHS2_URB',CHS2_URB<a name='3662'>
                 endif<a name='3663'>
#endif<a name='3664'>
      <a name='3665'>
                  TS_URB2D(I,J) = TS_URB<a name='3666'>
      <a name='3667'>
                  ALBEDO(I,J) = FRC_URB2D(I,J)*ALB_URB+(1-FRC_URB2D(I,J))*ALBEDOK   <font color=#447700>![-]<a name='3668'></font>
                  HFX(I,J) = FRC_URB2D(I,J)*SH_URB+(1-FRC_URB2D(I,J))*SHEAT         <font color=#447700>![W/m/m]<a name='3669'></font>
                  QFX(I,J) = FRC_URB2D(I,J)*LH_KINEMATIC_URB &amp;<a name='3670'>
                           + (1-FRC_URB2D(I,J))*ETA_KINEMATIC                <font color=#447700>![kg/m/m/s]<a name='3671'></font>
                  LH(I,J) = FRC_URB2D(I,J)*LH_URB+(1-FRC_URB2D(I,J))*ETA            <font color=#447700>![W/m/m]<a name='3672'></font>
                  GRDFLX(I,J) = FRC_URB2D(I,J)*G_URB+(1-FRC_URB2D(I,J))*SSOIL       <font color=#447700>![W/m/m]<a name='3673'></font>
                  TSK(I,J) = FRC_URB2D(I,J)*TS_URB+(1-FRC_URB2D(I,J))*T1            <font color=#447700>![K]<a name='3674'></font>
                  Q1 = FRC_URB2D(I,J)*QS_URB+(1-FRC_URB2D(I,J))*Q1            <font color=#447700>![-]<a name='3675'></font>
      <font color=#447700>! Convert QSFC back to mixing ratio<a name='3676'></font>
                  QSFC(I,J)= Q1/(1.0-Q1)<a name='3677'>
                  UST(I,J)= FRC_URB2D(I,J)*UST_URB+(1-FRC_URB2D(I,J))*UST(I,J)      <font color=#447700>![m/s]<a name='3678'></font>
                  ZNT(I,J)= EXP(FRC_URB2D(I,J)*ALOG(ZNT_URB)+(1-FRC_URB2D(I,J))* ALOG(ZNT(I,J)))   <font color=#447700>! ADD BY DAN<a name='3679'></font>
<a name='3680'>
#if 0<a name='3681'>
          IF(IPRINT)THEN<a name='3682'>
      <a name='3683'>
          print*, ' FRC_URB2D', FRC_URB2D,                        &amp;<a name='3684'>
          'ALB_URB',ALB_URB, 'ALBEDOK',ALBEDOK, &amp;<a name='3685'>
          'ALBEDO(I,J)',  ALBEDO(I,J),                  &amp;<a name='3686'>
          'SH_URB',SH_URB,'SHEAT',SHEAT, 'HFX(I,J)',HFX(I,J),  &amp;<a name='3687'>
          'LH_KINEMATIC_URB',LH_KINEMATIC_URB,'ETA_KINEMATIC',  &amp;<a name='3688'>
           ETA_KINEMATIC, 'QFX(I,J)',QFX(I,J),                  &amp;<a name='3689'>
          'LH_URB',LH_URB, 'ETA',ETA, 'LH(I,J)',LH(I,J),        &amp;<a name='3690'>
          'G_URB',G_URB,'SSOIL',SSOIL,'GRDFLX(I,J)', GRDFLX(I,J),&amp;<a name='3691'>
          'TS_URB',TS_URB,'T1',T1,'TSK(I,J)',TSK(I,J),          &amp;<a name='3692'>
          'QS_URB',QS_URB,'Q1',Q1,'QSFC(I,J)',QSFC(I,J)<a name='3693'>
           endif<a name='3694'>
#endif<a name='3695'>
      <a name='3696'>
      <font color=#447700>! Renew Urban State Varialbes<a name='3697'></font>
      <a name='3698'>
                  TR_URB2D(I,J) = TR_URB<a name='3699'>
                  TB_URB2D(I,J) = TB_URB<a name='3700'>
                  TG_URB2D(I,J) = TG_URB<a name='3701'>
                  TC_URB2D(I,J) = TC_URB<a name='3702'>
                  QC_URB2D(I,J) = QC_URB<a name='3703'>
                  UC_URB2D(I,J) = UC_URB<a name='3704'>
      <a name='3705'>
                  DO K = 1,num_roof_layers<a name='3706'>
                    TRL_URB3D(I,K,J) = TRL_URB(K)<a name='3707'>
                    SMR_URB3D(I,K,J) = SMR_URB(K)<a name='3708'>
                    TGRL_URB3D(I,K,J)= TGRL_URB(K)<a name='3709'>
                  END DO<a name='3710'>
                  DO K = 1,num_wall_layers<a name='3711'>
                    TBL_URB3D(I,K,J) = TBL_URB(K)<a name='3712'>
                  END DO<a name='3713'>
                  DO K = 1,num_road_layers<a name='3714'>
                    TGL_URB3D(I,K,J) = TGL_URB(K)<a name='3715'>
                  END DO<a name='3716'>
<a name='3717'>
                  TGR_URB2D(I,J) =TGR_URB <a name='3718'>
                  CMCR_URB2D(I,J)=CMCR_URB<a name='3719'>
            	    FLXHUMR_URB2D(I,J)=FLXHUMR_URB <a name='3720'>
                  FLXHUMB_URB2D(I,J)=FLXHUMB_URB<a name='3721'>
                  FLXHUMG_URB2D(I,J)=FLXHUMG_URB<a name='3722'>
                  DRELR_URB2D(I,J) = DRELR_URB <a name='3723'>
                  DRELB_URB2D(I,J) = DRELB_URB <a name='3724'>
                  DRELG_URB2D(I,J) = DRELG_URB<a name='3725'>
           <a name='3726'>
                  XXXR_URB2D(I,J) = XXXR_URB<a name='3727'>
                  XXXB_URB2D(I,J) = XXXB_URB<a name='3728'>
                  XXXG_URB2D(I,J) = XXXG_URB<a name='3729'>
                  XXXC_URB2D(I,J) = XXXC_URB<a name='3730'>
      <a name='3731'>
                  SH_URB2D(I,J)    = SH_URB<a name='3732'>
                  LH_URB2D(I,J)    = LH_URB<a name='3733'>
                  G_URB2D(I,J)     = G_URB<a name='3734'>
                  RN_URB2D(I,J)    = RN_URB<a name='3735'>
                  PSIM_URB2D(I,J)  = PSIM_URB<a name='3736'>
                  PSIH_URB2D(I,J)  = PSIH_URB<a name='3737'>
                  GZ1OZ0_URB2D(I,J)= GZ1OZ0_URB<a name='3738'>
                  U10_URB2D(I,J)   = U10_URB<a name='3739'>
                  V10_URB2D(I,J)   = V10_URB<a name='3740'>
                  TH2_URB2D(I,J)   = TH2_URB<a name='3741'>
                  Q2_URB2D(I,J)    = Q2_URB<a name='3742'>
                  UST_URB2D(I,J)   = UST_URB<a name='3743'>
                  AKMS_URB2D(I,J)  = KARMAN * UST_URB2D(I,J)/(GZ1OZ0_URB2D(I,J)-PSIM_URB2D(I,J))<a name='3744'>
                  IF (PRESENT(CMR_SFCDIF)) THEN<a name='3745'>
                     CMR_SFCDIF(I,J) = CMR_URB<a name='3746'>
                     CHR_SFCDIF(I,J) = CHR_URB<a name='3747'>
                     CMGR_SFCDIF(I,J) = CMGR_URB<a name='3748'>
                     CHGR_SFCDIF(I,J) = CHGR_URB<a name='3749'>
                     CMC_SFCDIF(I,J) = CMC_URB<a name='3750'>
                     CHC_SFCDIF(I,J) = CHC_URB<a name='3751'>
                  ENDIF<a name='3752'>
                  <a name='3753'>
                     <font color=#447700>! 2D to 3D  mosaic danli<a name='3754'></font>
      	    	              <a name='3755'>
      	    	                       TR_URB2D_mosaic(I,mosaic_i,J)=TR_URB2D(I,J)                               <a name='3756'>
      	    	    	               TB_URB2D_mosaic(I,mosaic_i,J)=TB_URB2D(I,J)                                   <a name='3757'>
      	    	    	               TG_URB2D_mosaic(I,mosaic_i,J)=TG_URB2D(I,J)                                   <a name='3758'>
      	    	    	               TC_URB2D_mosaic(I,mosaic_i,J)=TC_URB2D(I,J)                                  <a name='3759'>
      	    	    	               QC_URB2D_mosaic(I,mosaic_i,J)=QC_URB2D(I,J)                                   <a name='3760'>
      	    	    	               UC_URB2D_mosaic(I,mosaic_i,J)=UC_URB2D(I,J)                                   <a name='3761'>
      	    	    	               TS_URB2D_mosaic(I,mosaic_i,J)=TS_URB2D(I,J)                                   <a name='3762'>
      	    	    	               TS_RUL2D_mosaic(I,mosaic_i,J)=T1                                <a name='3763'>
      	    	    	  	  <a name='3764'>
      	    	    	  	              DO K = 1,num_roof_layers<a name='3765'>
      	    	    	  	                TRL_URB3D_mosaic(I,K+(mosaic_i-1)*num_roof_layers,J)=TRL_URB3D(I,K,J) <a name='3766'>
      	    	    	  	              END DO<a name='3767'>
      	    	    	  	              DO K = 1,num_wall_layers<a name='3768'>
      	    	    	  	                TBL_URB3D_mosaic(I,K+(mosaic_i-1)*num_roof_layers,J)=TBL_URB3D(I,K,J) <a name='3769'>
      	    	    	  	              END DO<a name='3770'>
      	    	    	  	              DO K = 1,num_road_layers<a name='3771'>
      	    	    	  	                TGL_URB3D_mosaic(I,K+(mosaic_i-1)*num_roof_layers,J)=TGL_URB3D(I,K,J) <a name='3772'>
      	    	    	                        END DO<a name='3773'>
      	    	    	            <a name='3774'>
      	    	    	              SH_URB2D_mosaic(I,mosaic_i,J) = SH_URB2D(I,J)<a name='3775'>
      	    	    	  	      LH_URB2D_mosaic(I,mosaic_i,J) = LH_URB2D(I,J)<a name='3776'>
      	    	    	              G_URB2D_mosaic(I,mosaic_i,J)  = G_URB2D(I,J)<a name='3777'>
                                    RN_URB2D_mosaic(I,mosaic_i,J) = RN_URB2D(I,J)<a name='3778'>
                                    <a name='3779'>
                END IF<a name='3780'>
      <a name='3781'>
               ENDIF                                   <font color=#447700>! end of UCM CALL if block<a name='3782'></font>
      <font color=#447700>!--------------------------------------<a name='3783'></font>
      <font color=#447700>! Urban Part End - urban<a name='3784'></font>
      <font color=#447700>!--------------------------------------<a name='3785'></font>
      <a name='3786'>
      <font color=#447700>!***  DIAGNOSTICS<a name='3787'></font>
                SMSTAV(I,J)=SOILW<a name='3788'>
                SMSTOT(I,J)=SOILM*1000.<a name='3789'>
                DO NS=1,NSOIL<a name='3790'>
                SMCREL(I,NS,J)=SMAV(NS)<a name='3791'>
                ENDDO<a name='3792'>
      <a name='3793'>
      <font color=#447700>!         Convert the water unit into mm<a name='3794'></font>
                SFCRUNOFF(I,J)=SFCRUNOFF(I,J)+RUNOFF1*DT*1000.0<a name='3795'>
                UDRUNOFF(I,J)=UDRUNOFF(I,J)+RUNOFF2*DT*1000.0<a name='3796'>
      <font color=#447700>! snow defined when fraction of frozen precip (FFROZP) &gt; 0.5,<a name='3797'></font>
                IF(FFROZP.GT.0.5)THEN<a name='3798'>
                  ACSNOW(I,J)=ACSNOW(I,J)+PRCP*DT<a name='3799'>
                ENDIF<a name='3800'>
                IF(SNOW(I,J).GT.0.)THEN<a name='3801'>
                  ACSNOM(I,J)=ACSNOM(I,J)+SNOMLT*1000.<a name='3802'>
      <font color=#447700>! accumulated snow-melt energy<a name='3803'></font>
                  SNOPCX(I,J)=SNOPCX(I,J)-SNOMLT/FDTLIW<a name='3804'>
                ENDIF<a name='3805'>
      <a name='3806'>
              ENDIF                                                           <font color=#447700>! endif of land-sea test<a name='3807'></font>
      <a name='3808'>
      <font color=#447700>!-----------------------------------------------------------------------<a name='3809'></font>
      <font color=#447700>! Done with the Noah-UCM MOSAIC  DANLI<a name='3810'></font>
      <font color=#447700>!-----------------------------------------------------------------------<a name='3811'></font>
      <a name='3812'>
                  TSK_mosaic(i,mosaic_i,j)=TSK(i,j)                           <font color=#447700>! from 2D to 3D<a name='3813'></font>
                  QSFC_mosaic(i,mosaic_i,j)=QSFC(i,j)<a name='3814'>
                  CANWAT_mosaic(i,mosaic_i,j)=CANWAT(i,j) <a name='3815'>
                  SNOW_mosaic(i,mosaic_i,j)=SNOW(i,j) <a name='3816'>
                  SNOWH_mosaic(i,mosaic_i,j)=SNOWH(i,j)  <a name='3817'>
                  SNOWC_mosaic(i,mosaic_i,j)=SNOWC(i,j) <a name='3818'>
      <a name='3819'>
                  ALBEDO_mosaic(i,mosaic_i,j)=ALBEDO(i,j) <a name='3820'>
                  ALBBCK_mosaic(i,mosaic_i,j)=ALBBCK(i,j)  <a name='3821'>
                  EMISS_mosaic(i,mosaic_i,j)=EMISS(i,j) <a name='3822'>
                  EMBCK_mosaic(i,mosaic_i,j)=EMBCK(i,j)  <a name='3823'>
                  ZNT_mosaic(i,mosaic_i,j)=ZNT(i,j)  <a name='3824'>
                  Z0_mosaic(i,mosaic_i,j)=Z0(i,j)    <a name='3825'>
                                                                                       <a name='3826'>
                  HFX_mosaic(i,mosaic_i,j)=HFX(i,j) <a name='3827'>
                  QFX_mosaic(i,mosaic_i,j)=QFX(i,j)  <a name='3828'>
                  LH_mosaic(i,mosaic_i,j)=LH(i,j)  <a name='3829'>
                  GRDFLX_mosaic(i,mosaic_i,j)=GRDFLX(i,j) <a name='3830'>
                  SNOTIME_mosaic(i,mosaic_i,j)=SNOTIME(i,j) <a name='3831'>
       <a name='3832'>
                  DO NS=1,NSOIL<a name='3833'>
        <a name='3834'>
                  TSLB_mosaic(i,NSOIL*(mosaic_i-1)+NS,j)=TSLB(i,NS,j)<a name='3835'>
                  SMOIS_mosaic(i,NSOIL*(mosaic_i-1)+NS,j)=SMOIS(i,NS,j)<a name='3836'>
                  SH2O_mosaic(i,NSOIL*(mosaic_i-1)+NS,j)=SH2O(i,NS,j)  <a name='3837'>
      <a name='3838'>
                  ENDDO<a name='3839'>
                  <a name='3840'>
#if 0<a name='3841'>
            IF(TSK_mosaic(i,mosaic_i,j) &gt; 350 .OR. TSK_mosaic(i,mosaic_i,j) &lt; 250 .OR. abs(HFX_mosaic(i,mosaic_i,j)) &gt; 700 ) THEN<a name='3842'>
                  print*, 'I', I, 'J', J, 'MOSAIC_I', MOSAIC_I<a name='3843'>
                  print*, 'mosaic_cat_index',mosaic_cat_index(I,mosaic_i,J), 'landusef2',landusef2(i,mosaic_i,j)<a name='3844'>
                  print*, 'TSK_mosaic', TSK_mosaic(i,mosaic_i,j), 'HFX_mosaic', HFX_mosaic(i,mosaic_i,j), &amp;<a name='3845'>
                          'LH_mosaic',LH_mosaic(i,mosaic_i,j),'GRDFLX_mosaic',GRDFLX_mosaic(i,mosaic_i,j)<a name='3846'>
                  print*, 'ZNT_mosaic', ZNT_mosaic(i, mosaic_i,j), 'Z0_mosaic', Z0_mosaic(i,mosaic_i,j) <a name='3847'>
                  print*, 'FRC_URB2D',FRC_URB2D(I,J)<a name='3848'>
                  print*, 'TS_URB',TS_URB2D(I,J),'T1',T1<a name='3849'>
                  print*, 'SH_URB2D',SH_URB2D(I,J),'SHEAT',SHEAT<a name='3850'>
                  print*, 'LH_URB',LH_URB2D(I,J),'ETA',ETA<a name='3851'>
                  print*, 'TS_RUL2D',TS_RUL2D_mosaic(I,mosaic_i,J)<a name='3852'>
                  <a name='3853'>
            ENDIF<a name='3854'>
#endif<a name='3855'>
                  <a name='3856'>
      <font color=#447700>!-----------------------------------------------------------------------<a name='3857'></font>
      <font color=#447700>! Now let's do the grid-averaging<a name='3858'></font>
      <font color=#447700>!-----------------------------------------------------------------------<a name='3859'></font>
      <a name='3860'>
                  FAREA  = landusef2(i,mosaic_i,j)<a name='3861'>
      <a name='3862'>
                  TSK_mosaic_avg(i,j) = TSK_mosaic_avg(i,j) + (EMISS_mosaic(i,mosaic_i,j)*TSK_mosaic(i,mosaic_i,j)**4)*FAREA    <font color=#447700>! conserve the longwave radiation<a name='3863'></font>
                  <a name='3864'>
                  QSFC_mosaic_avg(i,j) = QSFC_mosaic_avg(i,j) + QSFC_mosaic(i,mosaic_i,j)*FAREA<a name='3865'>
                  CANWAT_mosaic_avg(i,j) = CANWAT_mosaic_avg(i,j) + CANWAT_mosaic(i,mosaic_i,j)*FAREA<a name='3866'>
                  SNOW_mosaic_avg(i,j) = SNOW_mosaic_avg(i,j) + SNOW_mosaic(i,mosaic_i,j)*FAREA<a name='3867'>
                  SNOWH_mosaic_avg(i,j) = SNOWH_mosaic_avg(i,j) + SNOWH_mosaic(i,mosaic_i,j)*FAREA<a name='3868'>
                  SNOWC_mosaic_avg(i,j) = SNOWC_mosaic_avg(i,j) + SNOWC_mosaic(i,mosaic_i,j)*FAREA<a name='3869'>
      <a name='3870'>
                   DO NS=1,NSOIL<a name='3871'>
      <a name='3872'>
                 TSLB_mosaic_avg(i,NS,j)=TSLB_mosaic_avg(i,NS,j) + TSLB_mosaic(i,NS*mosaic_i,j)*FAREA<a name='3873'>
                 SMOIS_mosaic_avg(i,NS,j)=SMOIS_mosaic_avg(i,NS,j) + SMOIS_mosaic(i,NS*mosaic_i,j)*FAREA<a name='3874'>
                 SH2O_mosaic_avg(i,NS,j)=SH2O_mosaic_avg(i,NS,j) + SH2O_mosaic(i,NS*mosaic_i,j)*FAREA<a name='3875'>
      <a name='3876'>
                   ENDDO<a name='3877'>
      <a name='3878'>
                  FAREA_mosaic_avg(i,j)=FAREA_mosaic_avg(i,j)+FAREA<a name='3879'>
                  HFX_mosaic_avg(i,j) = HFX_mosaic_avg(i,j) + HFX_mosaic(i,mosaic_i,j)*FAREA<a name='3880'>
                  QFX_mosaic_avg(i,j) = QFX_mosaic_avg(i,j) + QFX_mosaic(i,mosaic_i,j)*FAREA<a name='3881'>
                  LH_mosaic_avg(i,j) = LH_mosaic_avg(i,j) + LH_mosaic(i,mosaic_i,j)*FAREA<a name='3882'>
                  GRDFLX_mosaic_avg(i,j)=GRDFLX_mosaic_avg(i,j)+GRDFLX_mosaic(i,mosaic_i,j)*FAREA<a name='3883'>
                  <a name='3884'>
                  ALBEDO_mosaic_avg(i,j)=ALBEDO_mosaic_avg(i,j)+ALBEDO_mosaic(i,mosaic_i,j)*FAREA<a name='3885'>
                  ALBBCK_mosaic_avg(i,j)=ALBBCK_mosaic_avg(i,j)+ALBBCK_mosaic(i,mosaic_i,j)*FAREA<a name='3886'>
                  EMISS_mosaic_avg(i,j)=EMISS_mosaic_avg(i,j)+EMISS_mosaic(i,mosaic_i,j)*FAREA<a name='3887'>
                  EMBCK_mosaic_avg(i,j)=EMBCK_mosaic_avg(i,j)+EMBCK_mosaic(i,mosaic_i,j)*FAREA<a name='3888'>
                  ZNT_mosaic_avg(i,j)=ZNT_mosaic_avg(i,j)+ALOG(ZNT_mosaic(i,mosaic_i,j))*FAREA<a name='3889'>
                  Z0_mosaic_avg(i,j)=Z0_mosaic_avg(i,j)+ALOG(Z0_mosaic(i,mosaic_i,j))*FAREA<a name='3890'>
       <a name='3891'>
         ENDDO                     <font color=#447700>! ENDDO FOR mosaic_i = 1, mosaic_cat<a name='3892'></font>
      <a name='3893'>
      <font color=#447700>!-----------------------------------------------------------------------<a name='3894'></font>
      <font color=#447700>! Now let's send the 3D values to the 2D variables that might be needed in other routines<a name='3895'></font>
      <font color=#447700>!-----------------------------------------------------------------------<a name='3896'></font>
      <a name='3897'>
          IVGTYP(I,J)=IVGTYP_dominant(I,J)                                 <font color=#447700>! the dominant vege category <a name='3898'></font>
          ALBEDO(i,j)=ALBEDO_mosaic_avg(i,j)<a name='3899'>
          ALBBCK(i,j)=ALBBCK_mosaic_avg(i,j) <a name='3900'>
          EMISS(i,j)= EMISS_mosaic_avg(i,j) <a name='3901'>
          EMBCK(i,j)= EMBCK_mosaic_avg(i,j)  <a name='3902'>
          ZNT(i,j)= EXP(ZNT_mosaic_avg(i,j)/FAREA_mosaic_avg(i,j))<a name='3903'>
          Z0(i,j)= EXP(Z0_mosaic_avg(i,j)/FAREA_mosaic_avg(i,j))<a name='3904'>
                                                                                       <a name='3905'>
          TSK(i,j)=(TSK_mosaic_avg(I,J)/EMISS_mosaic_avg(I,J))**(0.25)                                  <font color=#447700>! from 3D to 2D<a name='3906'></font>
          QSFC(i,j)=QSFC_mosaic_avg(I,J)<a name='3907'>
          CANWAT(i,j) = CANWAT_mosaic_avg(i,j)<a name='3908'>
          SNOW(i,j) = SNOW_mosaic_avg(i,j)<a name='3909'>
          SNOWH(i,j) = SNOWH_mosaic_avg(i,j)  <a name='3910'>
          SNOWC(i,j) = SNOWC_mosaic_avg(i,j)    <a name='3911'>
          <a name='3912'>
          HFX(i,j) = HFX_mosaic_avg(i,j) <a name='3913'>
          QFX(i,j) = QFX_mosaic_avg(i,j) <a name='3914'>
          LH(i,j) = LH_mosaic_avg(i,j) <a name='3915'>
          GRDFLX(i,j)=GRDFLX_mosaic_avg(i,j)<a name='3916'>
        <a name='3917'>
                    DO NS=1,NSOIL<a name='3918'>
      <a name='3919'>
               TSLB(i,NS,j)=TSLB_mosaic_avg(i,NS,j)<a name='3920'>
               SMOIS(i,NS,j)=SMOIS_mosaic_avg(i,NS,j)<a name='3921'>
               SH2O(i,NS,j)=SH2O_mosaic_avg(i,NS,j)<a name='3922'>
      <a name='3923'>
                    ENDDO<a name='3924'>
      <a name='3925'>
      ELSE    <font color=#447700>! This corresponds to IF ((sf_surface_mosaic == 1) .AND. ((XLAND(I,J)-1.5).LT.0.) .AND. (XICE(I,J) &lt; XICE_THRESHOLD) ) THEN<a name='3926'></font>
      <a name='3927'>
      <font color=#447700>! surface pressure<a name='3928'></font>
              PSFC=P8w3D(i,1,j)<a name='3929'>
      <font color=#447700>! pressure in middle of lowest layer<a name='3930'></font>
              SFCPRS=(P8W3D(I,KTS+1,j)+P8W3D(i,KTS,j))*0.5<a name='3931'>
      <font color=#447700>! convert from mixing ratio to specific humidity<a name='3932'></font>
               Q2K=QV3D(i,1,j)/(1.0+QV3D(i,1,j))<a name='3933'>
      <font color=#447700>!<a name='3934'></font>
      <font color=#447700>!         Q2SAT=QGH(I,j)<a name='3935'></font>
               Q2SAT=QGH(I,J)/(1.0+QGH(I,J))        <font color=#447700>! Q2SAT is sp humidity<a name='3936'></font>
      <font color=#447700>! add check on myj=.true.<a name='3937'></font>
      <font color=#447700>!        IF((Q2K.GE.Q2SAT*TRESH).AND.Q2K.LT.QZ0(I,J))THEN<a name='3938'></font>
              IF((myj).AND.(Q2K.GE.Q2SAT*TRESH).AND.Q2K.LT.QZ0(I,J))THEN<a name='3939'>
                SATFLG=0.<a name='3940'>
                CHKLOWQ(I,J)=0.<a name='3941'>
              ELSE<a name='3942'>
                SATFLG=1.0<a name='3943'>
                CHKLOWQ(I,J)=1.<a name='3944'>
              ENDIF<a name='3945'>
      <a name='3946'>
              SFCTMP=T3D(i,1,j)<a name='3947'>
              ZLVL=0.5*DZ8W(i,1,j)<a name='3948'>
      <a name='3949'>
      <font color=#447700>!        TH2=SFCTMP+(0.0097545*ZLVL)<a name='3950'></font>
      <font color=#447700>! calculate SFCTH2 via Exner function vs lapse-rate (above)<a name='3951'></font>
               APES=(1.E5/PSFC)**CAPA<a name='3952'>
               APELM=(1.E5/SFCPRS)**CAPA<a name='3953'>
               SFCTH2=SFCTMP*APELM<a name='3954'>
               TH2=SFCTH2/APES<a name='3955'>
      <font color=#447700>!<a name='3956'></font>
               EMISSI = EMISS(I,J)<a name='3957'>
               LWDN=GLW(I,J)*EMISSI<a name='3958'>
      <font color=#447700>! SOLDN is total incoming solar<a name='3959'></font>
              SOLDN=SWDOWN(I,J)<a name='3960'>
      <font color=#447700>! GSW is net downward solar<a name='3961'></font>
      <font color=#447700>!        SOLNET=GSW(I,J)<a name='3962'></font>
      <font color=#447700>! use mid-day albedo to determine net downward solar (no solar zenith angle correction)<a name='3963'></font>
              SOLNET=SOLDN*(1.-ALBEDO(I,J))<a name='3964'>
              PRCP=RAINBL(i,j)/DT<a name='3965'>
              VEGTYP=IVGTYP(I,J)<a name='3966'>
              SOILTYP=ISLTYP(I,J)<a name='3967'>
              SHDFAC=VEGFRA(I,J)/100.<a name='3968'>
              T1=TSK(I,J)<a name='3969'>
              CHK=CHS(I,J)<a name='3970'>
              SHMIN=SHDMIN(I,J)/100. <font color=#447700>!NEW<a name='3971'></font>
              SHMAX=SHDMAX(I,J)/100. <font color=#447700>!NEW<a name='3972'></font>
      <font color=#447700>! convert snow water equivalent from mm to meter<a name='3973'></font>
              SNEQV=SNOW(I,J)*0.001<a name='3974'>
      <font color=#447700>! snow depth in meters<a name='3975'></font>
              SNOWHK=SNOWH(I,J)<a name='3976'>
              SNCOVR=SNOWC(I,J)<a name='3977'>
      <a name='3978'>
      <font color=#447700>! if "SR" present, set frac of frozen precip ("FFROZP") = snow-ratio ("SR", range:0-1)<a name='3979'></font>
      <font color=#447700>! SR from e.g. Ferrier microphysics<a name='3980'></font>
      <font color=#447700>! otherwise define from 1st atmos level temperature<a name='3981'></font>
             IF(FRPCPN) THEN<a name='3982'>
                FFROZP=SR(I,J)<a name='3983'>
              ELSE<a name='3984'>
                IF (SFCTMP &lt;=  273.15) THEN<a name='3985'>
                  FFROZP = 1.0<a name='3986'>
      	  ELSE<a name='3987'>
      	    FFROZP = 0.0<a name='3988'>
      	  ENDIF<a name='3989'>
              ENDIF<a name='3990'>
      <font color=#447700>!***<a name='3991'></font>
              IF((XLAND(I,J)-1.5).GE.0.)THEN                                  <font color=#447700>! begining of land/sea if block<a name='3992'></font>
      <font color=#447700>! Open water points<a name='3993'></font>
                TSK_RURAL(I,J)=TSK(I,J)<a name='3994'>
                HFX_RURAL(I,J)=HFX(I,J)<a name='3995'>
                QFX_RURAL(I,J)=QFX(I,J)<a name='3996'>
                LH_RURAL(I,J)=LH(I,J)<a name='3997'>
                EMISS_RURAL(I,J)=EMISS(I,J)<a name='3998'>
                GRDFLX_RURAL(I,J)=GRDFLX(I,J)<a name='3999'>
              ELSE<a name='4000'>
      <font color=#447700>! Land or sea-ice case<a name='4001'></font>
      <a name='4002'>
                IF (XICE(I,J) &gt;= XICE_THRESHOLD) THEN<a name='4003'>
                   <font color=#447700>! Sea-ice point<a name='4004'></font>
                   ICE = 1<a name='4005'>
                ELSE IF ( VEGTYP == ISICE ) THEN<a name='4006'>
                   <font color=#447700>! Land-ice point<a name='4007'></font>
                   ICE = -1<a name='4008'>
                ELSE<a name='4009'>
                   <font color=#447700>! Neither sea ice or land ice.<a name='4010'></font>
                   ICE=0<a name='4011'>
                ENDIF<a name='4012'>
                DQSDT2=Q2SAT*A23M4/(SFCTMP-A4)**2<a name='4013'>
      <a name='4014'>
                IF(SNOW(I,J).GT.0.0)THEN<a name='4015'>
      <font color=#447700>! snow on surface (use ice saturation properties)<a name='4016'></font>
                  SFCTSNO=SFCTMP<a name='4017'>
                  E2SAT=611.2*EXP(6174.*(1./273.15 - 1./SFCTSNO))<a name='4018'>
                  Q2SATI=0.622*E2SAT/(SFCPRS-E2SAT)<a name='4019'>
                  Q2SATI=Q2SATI/(1.0+Q2SATI)    <font color=#447700>! spec. hum.<a name='4020'></font>
                  IF (T1 .GT. 273.14) THEN<a name='4021'>
      <font color=#447700>! warm ground temps, weight the saturation between ice and water according to SNOWC<a name='4022'></font>
                    Q2SAT=Q2SAT*(1.-SNOWC(I,J)) + Q2SATI*SNOWC(I,J)<a name='4023'>
                    DQSDT2=DQSDT2*(1.-SNOWC(I,J)) + Q2SATI*6174./(SFCTSNO**2)*SNOWC(I,J)<a name='4024'>
                  ELSE<a name='4025'>
      <font color=#447700>! cold ground temps, use ice saturation only<a name='4026'></font>
                    Q2SAT=Q2SATI<a name='4027'>
                    DQSDT2=Q2SATI*6174./(SFCTSNO**2)<a name='4028'>
                  ENDIF<a name='4029'>
      <font color=#447700>! for snow cover fraction at 0 C, ground temp will not change, so DQSDT2 effectively zero<a name='4030'></font>
                  IF(T1 .GT. 273. .AND. SNOWC(I,J) .GT. 0.)DQSDT2=DQSDT2*(1.-SNOWC(I,J))<a name='4031'>
                ENDIF<a name='4032'>
      <a name='4033'>
                <font color=#447700>! Land-ice or land points use the usual deep-soil temperature.<a name='4034'></font>
                TBOT=TMN(I,J)<a name='4035'>
      <a name='4036'>
                IF(VEGTYP.EQ.25) SHDFAC=0.0000<a name='4037'>
                IF(VEGTYP.EQ.26) SHDFAC=0.0000<a name='4038'>
                IF(VEGTYP.EQ.27) SHDFAC=0.0000<a name='4039'>
                IF(SOILTYP.EQ.14.AND.XICE(I,J).EQ.0.)THEN<a name='4040'>
#if 0<a name='4041'>
               IF(IPRINT)PRINT*,' SOIL TYPE FOUND TO BE WATER AT A LAND-POINT'<a name='4042'>
               IF(IPRINT)PRINT*,i,j,'RESET SOIL in surfce.F'<a name='4043'>
#endif<a name='4044'>
                  SOILTYP=7<a name='4045'>
                ENDIF<a name='4046'>
                SNOALB1 = SNOALB(I,J)<a name='4047'>
                CMC=CANWAT(I,J)<a name='4048'>
      <a name='4049'>
      <font color=#447700>!-------------------------------------------<a name='4050'></font>
      <font color=#447700>!*** convert snow depth from mm to meter<a name='4051'></font>
      <font color=#447700>!<a name='4052'></font>
      <font color=#447700>!          IF(RDMAXALB) THEN<a name='4053'></font>
      <font color=#447700>!           SNOALB=ALBMAX(I,J)*0.01<a name='4054'></font>
      <font color=#447700>!         ELSE<a name='4055'></font>
      <font color=#447700>!           SNOALB=MAXALB(IVGTPK)*0.01<a name='4056'></font>
      <font color=#447700>!         ENDIF<a name='4057'></font>
      <a name='4058'>
      <font color=#447700>!        SNOALB1=0.80<a name='4059'></font>
      <font color=#447700>!        SHMIN=0.00<a name='4060'></font>
              ALBBRD=ALBBCK(I,J)<a name='4061'>
              Z0BRD=Z0(I,J)<a name='4062'>
              EMBRD=EMBCK(I,J)<a name='4063'>
              SNOTIME1 = SNOTIME(I,J)<a name='4064'>
              RIBB=RIB(I,J)<a name='4065'>
      <font color=#447700>!FEI: temporaray arrays above need to be changed later by using SI<a name='4066'></font>
      <a name='4067'>
                DO NS=1,NSOIL<a name='4068'>
                  SMC(NS)=SMOIS(I,NS,J)<a name='4069'>
                  STC(NS)=TSLB(I,NS,J)                                          <font color=#447700>!STEMP<a name='4070'></font>
                  SWC(NS)=SH2O(I,NS,J)<a name='4071'>
                ENDDO<a name='4072'>
      <font color=#447700>!<a name='4073'></font>
                if ( (SNEQV.ne.0..AND.SNOWHK.eq.0.).or.(SNOWHK.le.SNEQV) )THEN<a name='4074'>
                  SNOWHK= 5.*SNEQV<a name='4075'>
                endif<a name='4076'>
      <font color=#447700>!<a name='4077'></font>
      <a name='4078'>
      <font color=#447700>!Fei: urban. for urban surface, if calling UCM, redefine the natural surface in cities as<a name='4079'></font>
      <font color=#447700>! the "NATURAL" category in the VEGPARM.TBL<a name='4080'></font>
      	<a name='4081'>
      	   IF(SF_URBAN_PHYSICS == 1.OR. SF_URBAN_PHYSICS==2.OR.SF_URBAN_PHYSICS==3 ) THEN<a name='4082'>
                      IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='4083'>
                        IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='4084'>
      		 VEGTYP = NATURAL<a name='4085'>
                       SHDFAC = SHDTBL(NATURAL)<a name='4086'>
                       ALBEDOK =0.2         <font color=#447700>!  0.2<a name='4087'></font>
                       ALBBRD  =0.2         <font color=#447700>!0.2<a name='4088'></font>
                       EMISSI = 0.98                                 <font color=#447700>!for VEGTYP=5<a name='4089'></font>
      		 IF ( FRC_URB2D(I,J) &lt; 0.99 ) THEN<a name='4090'>
                         if(sf_urban_physics.eq.1)then<a name='4091'>
                 T1= ( TSK(I,J) -FRC_URB2D(I,J) * TS_URB2D (I,J) )/ (1-FRC_URB2D(I,J))<a name='4092'>
                         elseif((sf_urban_physics.eq.2).OR.(sf_urban_physics.eq.3))then<a name='4093'>
                      r1= (tsk(i,j)**4.)<a name='4094'>
                      r2= frc_urb2d(i,j)*(ts_urb2d(i,j)**4.)<a name='4095'>
                      r3= (1.-frc_urb2d(i,j))<a name='4096'>
                      t1= ((r1-r2)/r3)**.25<a name='4097'>
                         endif<a name='4098'>
      	         ELSE<a name='4099'>
      		 T1 = TSK(I,J)<a name='4100'>
                       ENDIF<a name='4101'>
                      ENDIF<a name='4102'>
                 ELSE<a name='4103'>
                       IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='4104'>
                        IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='4105'>
                        VEGTYP = ISURBAN<a name='4106'>
                 	 ENDIF<a name='4107'>
                 ENDIF<a name='4108'>
<a name='4109'>
<a name='4110'>
<font color=#447700>!===Yang, 2014/10/08, hydrological processes for urban vegetation in single layer UCM===<a name='4111'></font>
           AOASIS = 1.0<a name='4112'>
           USOIL = 1<a name='4113'>
           DSOIL = 2<a name='4114'>
           IRIOPTION=IRI_SCHEME<a name='4115'>
           OMG= OMG_URB2D(I,J)   <a name='4116'>
           tloc=mod(int(OMG/3.14159*180./15.+12.+0.5 ),24)<a name='4117'>
           if (tloc.lt.0) tloc=tloc+24<a name='4118'>
           if (tloc==0) tloc=24<a name='4119'>
           CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>cal_mon_day</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_10">(julian,julyr,jmonth,jday) <a name='4120'>
	  IF(SF_URBAN_PHYSICS == 1) THEN<a name='4121'>
           IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='4122'>
                IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN<a name='4123'>
            AOASIS = oasis  <font color=#447700>! urban oasis effect<a name='4124'></font>
                   IF (IRIOPTION ==1) THEN<a name='4125'>
                   IF (tloc==21 .or. tloc==22) THEN  <font color=#447700>!irrigation on vegetaion in urban area, MAY-SEP, 9-10pm<a name='4126'></font>
                   IF (jmonth==5 .or. jmonth==6 .or. jmonth==7 .or. jmonth==8 .or. jmonth==9) THEN<a name='4127'>
                      IF (SMC(USOIL) .LT. SMCREF) SMC(USOIL)= REFSMC(ISLTYP(I,J))<a name='4128'>
                      IF (SMC(DSOIL) .LT. SMCREF) SMC(DSOIL)= REFSMC(ISLTYP(I,J))<a name='4129'>
                   ENDIF<a name='4130'>
                   ENDIF<a name='4131'>
                   ENDIF<a name='4132'>
                ENDIF<a name='4133'>
           ENDIF<a name='4134'>
<a name='4135'>
	  IF(SF_URBAN_PHYSICS == 2 .or. SF_URBAN_PHYSICS == 3) THEN<a name='4136'>
          IF(AOASIS &gt; 1.0) THEN<a name='4137'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1169">('Urban oasis option is for SF_URBAN_PHYSICS == 1 only')<a name='4138'>
          ENDIF<a name='4139'>
          IF(IRIOPTION == 1) THEN<a name='4140'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1170">('Urban irrigation option is for SF_URBAN_PHYSICS == 1 only')<a name='4141'>
          ENDIF<a name='4142'>
          ENDIF<a name='4143'>
<a name='4144'>
#if 0<a name='4145'>
                IF(IPRINT) THEN<a name='4146'>
      <font color=#447700>!<a name='4147'></font>
             print*, 'BEFORE SFLX, in Noahlsm_driver'<a name='4148'>
             print*, 'ICE', ICE, 'DT',DT, 'ZLVL',ZLVL, 'NSOIL', NSOIL,   &amp;<a name='4149'>
             'SLDPTH', SLDPTH, 'LOCAL',LOCAL, 'LUTYPE',&amp;<a name='4150'>
              LUTYPE, 'SLTYPE',SLTYPE, 'LWDN',LWDN, 'SOLDN',SOLDN,      &amp;<a name='4151'>
              'SFCPRS',SFCPRS, 'PRCP',PRCP,'SFCTMP',SFCTMP,'Q2K',Q2K,   &amp;<a name='4152'>
               'TH2',TH2,'Q2SAT',Q2SAT,'DQSDT2',DQSDT2,'VEGTYP', VEGTYP,&amp;<a name='4153'>
               'SOILTYP',SOILTYP, 'SLOPETYP',SLOPETYP, 'SHDFAC',SHDFAC,&amp;<a name='4154'>
               'SHMIN',SHMIN, 'ALBBRD',ALBBRD,'SNOALB1',SNOALB1,'TBOT',&amp;<a name='4155'>
                TBOT, 'Z0BRD',Z0BRD, 'Z0K',Z0K, 'CMC',CMC, 'T1',T1,'STC',&amp;<a name='4156'>
                STC, 'SMC',SMC, 'SWC',SWC,'SNOWHK',SNOWHK,'SNEQV',SNEQV,&amp;<a name='4157'>
                'ALBEDOK',ALBEDOK,'CHK',CHK,'ETA',ETA,'SHEAT',SHEAT,      &amp;<a name='4158'>
                'ETA_KINEMATIC',ETA_KINEMATIC, 'FDOWN',FDOWN,'EC',EC,   &amp;<a name='4159'>
                'EDIR',EDIR,'ET',ET,'ETT',ETT,'ESNOW',ESNOW,'DRIP',DRIP,&amp;<a name='4160'>
                'DEW',DEW,'BETA',BETA,'ETP',ETP,'SSOIL',SSOIL,'FLX1',FLX1,&amp;<a name='4161'>
                'FLX2',FLX2,'FLX3',FLX3,'SNOMLT',SNOMLT,'SNCOVR',SNCOVR,&amp;<a name='4162'>
                'RUNOFF1',RUNOFF1,'RUNOFF2',RUNOFF2,'RUNOFF3',RUNOFF3, &amp;<a name='4163'>
                'RC',RC, 'PC',PC,'RSMIN',RSMIN,'XLAI',XLAI,'RCS',RCS,  &amp;<a name='4164'>
                'RCT',RCT,'RCQ',RCQ,'RCSOIL',RCSOIL,'SOILW',SOILW,     &amp;<a name='4165'>
                'SOILM',SOILM,'Q1',Q1,'SMCWLT',SMCWLT,'SMCDRY',SMCDRY,&amp;<a name='4166'>
                'SMCREF',SMCREF,'SMCMAX',SMCMAX,'NROOT',NROOT<a name='4167'>
                 endif<a name='4168'>
#endif<a name='4169'>
      <a name='4170'>
                IF (rdlai2d) THEN<a name='4171'>
                   xlai = lai(i,j)<a name='4172'>
                endif<a name='4173'>
      <a name='4174'>
          IF ( ICE == 1 ) THEN<a name='4175'>
      <a name='4176'>
             <font color=#447700>! Sea-ice case<a name='4177'></font>
      <a name='4178'>
             DO NS = 1, NSOIL<a name='4179'>
                SH2O(I,NS,J) = 1.0<a name='4180'>
             ENDDO<a name='4181'>
             LAI(I,J) = 0.01<a name='4182'>
      <a name='4183'>
             CYCLE ILOOP<a name='4184'>
      <a name='4185'>
          ELSEIF (ICE == 0) THEN<a name='4186'>
      <a name='4187'>
             <font color=#447700>! Non-glacial land<a name='4188'></font>
      <a name='4189'>
             CALL <A href='../../html_code/phys/module_sf_noahlsm.F.html#SFLX'>SFLX</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFLX_3"> (I,J,FFROZP, ISURBAN, DT,ZLVL,NSOIL,SLDPTH,       &amp;    <font color=#447700>!C<a name='4190'></font>
                       LOCAL,                                            &amp;    <font color=#447700>!L<a name='4191'></font>
                       LUTYPE, SLTYPE,                                   &amp;    <font color=#447700>!CL<a name='4192'></font>
                       LWDN,SOLDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2K,DUMMY,   &amp;    <font color=#447700>!F<a name='4193'></font>
                       DUMMY,DUMMY, DUMMY,                               &amp;    <font color=#447700>!F PRCPRAIN not used<a name='4194'></font>
                       TH2,Q2SAT,DQSDT2,                                 &amp;    <font color=#447700>!I<a name='4195'></font>
                       VEGTYP,SOILTYP,SLOPETYP,SHDFAC,SHMIN,SHMAX,       &amp;    <font color=#447700>!I<a name='4196'></font>
                       ALBBRD, SNOALB1,TBOT, Z0BRD, Z0K, EMISSI, EMBRD,  &amp;    <font color=#447700>!S<a name='4197'></font>
                       CMC,T1,STC,SMC,SWC,SNOWHK,SNEQV,ALBEDOK,CHK,dummy,&amp;    <font color=#447700>!H<a name='4198'></font>
                       ETA,SHEAT, ETA_KINEMATIC,FDOWN,                   &amp;    <font color=#447700>!O<a name='4199'></font>
                       EC,EDIR,ET,ETT,ESNOW,DRIP,DEW,                    &amp;    <font color=#447700>!O<a name='4200'></font>
                       BETA,ETP,SSOIL,                                   &amp;    <font color=#447700>!O<a name='4201'></font>
                       FLX1,FLX2,FLX3,                                   &amp;    <font color=#447700>!O<a name='4202'></font>
      		 FLX4,FVB,FBUR,FGSN,UA_PHYS,                             &amp;    <font color=#447700>!UA <a name='4203'></font>
                       SNOMLT,SNCOVR,                                    &amp;    <font color=#447700>!O<a name='4204'></font>
                       RUNOFF1,RUNOFF2,RUNOFF3,                          &amp;    <font color=#447700>!O<a name='4205'></font>
                       RC,PC,RSMIN,XLAI,RCS,RCT,RCQ,RCSOIL,              &amp;    <font color=#447700>!O<a name='4206'></font>
                       SOILW,SOILM,Q1,SMAV,                              &amp;    <font color=#447700>!D<a name='4207'></font>
                       RDLAI2D,USEMONALB,                                &amp;<a name='4208'>
                       SNOTIME1,                                         &amp;<a name='4209'>
                       RIBB,                                             &amp;<a name='4210'>
                       SMCWLT,SMCDRY,SMCREF,SMCMAX,NROOT,                &amp;<a name='4211'>
                       sfcheadrt(i,j),                                   &amp;    <font color=#447700>!I<a name='4212'></font>
                       INFXSRT(i,j),ETPND1,OPT_THCND,AOASIS              &amp;    <font color=#447700>!O<a name='4213'></font>
                ,XSDA_QFX, HFX_PHY, QFX_PHY, XQNORM, fasdas, HCPCT_FASDAS    &amp; <font color=#447700>! fasdas vars<a name='4214'></font>
                       )<a name='4215'>
      <a name='4216'>
#ifdef WRF_HYDRO<a name='4217'>
                       soldrain(i,j) = RUNOFF2*DT*1000.0<a name='4218'>
#endif<a name='4219'>
          ELSEIF (ICE == -1) THEN<a name='4220'>
      <a name='4221'>
             <font color=#447700>!<a name='4222'></font>
             <font color=#447700>! Set values that the LSM is expected to update,<a name='4223'></font>
             <font color=#447700>! but don't get updated for glacial points.<a name='4224'></font>
             <font color=#447700>!<a name='4225'></font>
             SOILM = 0.0 <font color=#447700>!BSINGH(PNNL)- SOILM is undefined for this case, it is used for diagnostics so setting it to zero<a name='4226'></font>
             XLAI = 0.01 <font color=#447700>! KWM Should this be Zero over land ice?  Does this value matter?<a name='4227'></font>
             RUNOFF2 = 0.0<a name='4228'>
             RUNOFF3 = 0.0<a name='4229'>
             DO NS = 1, NSOIL<a name='4230'>
                SWC(NS) = 1.0<a name='4231'>
                SMC(NS) = 1.0<a name='4232'>
                SMAV(NS) = 1.0<a name='4233'>
             ENDDO<a name='4234'>
             CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL'>SFLX_GLACIAL</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFLX_GLACIAL_3">(I,J,ISICE,FFROZP,DT,ZLVL,NSOIL,SLDPTH,   &amp;    <font color=#447700>!C<a name='4235'></font>
                  &amp;    LWDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2K,              &amp;    <font color=#447700>!F<a name='4236'></font>
                  &amp;    TH2,Q2SAT,DQSDT2,                                &amp;    <font color=#447700>!I<a name='4237'></font>
                  &amp;    ALBBRD, SNOALB1,TBOT, Z0BRD, Z0K, EMISSI, EMBRD, &amp;    <font color=#447700>!S<a name='4238'></font>
                  &amp;    T1,STC(1:NSOIL),SNOWHK,SNEQV,ALBEDOK,CHK,        &amp;    <font color=#447700>!H<a name='4239'></font>
                  &amp;    ETA,SHEAT,ETA_KINEMATIC,FDOWN,                   &amp;    <font color=#447700>!O<a name='4240'></font>
                  &amp;    ESNOW,DEW,                                       &amp;    <font color=#447700>!O<a name='4241'></font>
                  &amp;    ETP,SSOIL,                                       &amp;    <font color=#447700>!O<a name='4242'></font>
                  &amp;    FLX1,FLX2,FLX3,                                  &amp;    <font color=#447700>!O<a name='4243'></font>
                  &amp;    SNOMLT,SNCOVR,                                   &amp;    <font color=#447700>!O<a name='4244'></font>
                  &amp;    RUNOFF1,                                         &amp;    <font color=#447700>!O<a name='4245'></font>
                  &amp;    Q1,                                              &amp;    <font color=#447700>!D<a name='4246'></font>
                  &amp;    SNOTIME1,                                        &amp;<a name='4247'>
                  &amp;    RIBB)<a name='4248'>
      <a name='4249'>
          ENDIF<a name='4250'>
      <a name='4251'>
             lai(i,j) = xlai<a name='4252'>
      <a name='4253'>
#if 0<a name='4254'>
                IF(IPRINT) THEN<a name='4255'>
      <a name='4256'>
             print*, 'AFTER SFLX, in Noahlsm_driver'<a name='4257'>
             print*, 'ICE', ICE, 'DT',DT, 'ZLVL',ZLVL, 'NSOIL', NSOIL,   &amp;<a name='4258'>
             'SLDPTH', SLDPTH, 'LOCAL',LOCAL, 'LUTYPE',&amp;<a name='4259'>
              LUTYPE, 'SLTYPE',SLTYPE, 'LWDN',LWDN, 'SOLDN',SOLDN,      &amp;<a name='4260'>
              'SFCPRS',SFCPRS, 'PRCP',PRCP,'SFCTMP',SFCTMP,'Q2K',Q2K,   &amp;<a name='4261'>
               'TH2',TH2,'Q2SAT',Q2SAT,'DQSDT2',DQSDT2,'VEGTYP', VEGTYP,&amp;<a name='4262'>
                'SOILTYP',SOILTYP, 'SLOPETYP',SLOPETYP, 'SHDFAC',SHDFAC,&amp;<a name='4263'>
               'SHDMIN',SHMIN, 'ALBBRD',ALBBRD,'SNOALB',SNOALB1,'TBOT',&amp;<a name='4264'>
                TBOT, 'Z0BRD',Z0BRD, 'Z0K',Z0K, 'CMC',CMC, 'T1',T1,'STC',&amp;<a name='4265'>
                STC, 'SMC',SMC, 'SWc',SWC,'SNOWHK',SNOWHK,'SNEQV',SNEQV,&amp;<a name='4266'>
                'ALBEDOK',ALBEDOK,'CHK',CHK,'ETA',ETA,'SHEAT',SHEAT,      &amp;<a name='4267'>
                'ETA_KINEMATIC',ETA_KINEMATIC, 'FDOWN',FDOWN,'EC',EC,   &amp;<a name='4268'>
                'EDIR',EDIR,'ET',ET,'ETT',ETT,'ESNOW',ESNOW,'DRIP',DRIP,&amp;<a name='4269'>
                'DEW',DEW,'BETA',BETA,'ETP',ETP,'SSOIL',SSOIL,'FLX1',FLX1,&amp;<a name='4270'>
                'FLX2',FLX2,'FLX3',FLX3,'SNOMLT',SNOMLT,'SNCOVR',SNCOVR,&amp;<a name='4271'>
                'RUNOFF1',RUNOFF1,'RUNOFF2',RUNOFF2,'RUNOFF3',RUNOFF3, &amp;<a name='4272'>
                'RC',RC, 'PC',PC,'RSMIN',RSMIN,'XLAI',XLAI,'RCS',RCS,  &amp;<a name='4273'>
                'RCT',RCT,'RCQ',RCQ,'RCSOIL',RCSOIL,'SOILW',SOILW,     &amp;<a name='4274'>
                'SOILM',SOILM,'Q1',Q1,'SMCWLT',SMCWLT,'SMCDRY',SMCDRY,&amp;<a name='4275'>
                'SMCREF',SMCREF,'SMCMAX',SMCMAX,'NROOT',NROOT<a name='4276'>
                 endif<a name='4277'>
#endif<a name='4278'>
      <a name='4279'>
      <font color=#447700>!***  UPDATE STATE VARIABLES<a name='4280'></font>
                CANWAT(I,J)=CMC<a name='4281'>
                SNOW(I,J)=SNEQV*1000.<a name='4282'>
      <font color=#447700>!          SNOWH(I,J)=SNOWHK*1000.<a name='4283'></font>
                SNOWH(I,J)=SNOWHK                   <font color=#447700>! SNOWHK in meters<a name='4284'></font>
                ALBEDO(I,J)=ALBEDOK<a name='4285'>
                ALB_RURAL(I,J)=ALBEDOK<a name='4286'>
                ALBBCK(I,J)=ALBBRD<a name='4287'>
                Z0(I,J)=Z0BRD<a name='4288'>
                EMISS(I,J) = EMISSI<a name='4289'>
                EMISS_RURAL(I,J) = EMISSI<a name='4290'>
      <font color=#447700>! Noah: activate time-varying roughness length (V3.3 Feb 2011)<a name='4291'></font>
                ZNT(I,J)=Z0K<a name='4292'>
                TSK(I,J)=T1<a name='4293'>
                TSK_RURAL(I,J)=T1<a name='4294'>
                HFX(I,J)=SHEAT<a name='4295'>
                HFX_RURAL(I,J)=SHEAT<a name='4296'>
      <font color=#447700>! MEk Jul07 add potential evap accum<a name='4297'></font>
              POTEVP(I,J)=POTEVP(I,J)+ETP*FDTW<a name='4298'>
                QFX(I,J)=ETA_KINEMATIC<a name='4299'>
                QFX_RURAL(I,J)=ETA_KINEMATIC<a name='4300'>
      <a name='4301'>
#ifdef WRF_HYDRO<a name='4302'>
      <font color=#447700>!added by Wei Yu<a name='4303'></font>
      <font color=#447700>!         QFX(I,J) = QFX(I,J) + ETPND1<a name='4304'></font>
      <font color=#447700>!         ETA = ETA + ETPND1/2.501E6*dt<a name='4305'></font>
      <font color=#447700>!end added by Wei Yu<a name='4306'></font>
#endif<a name='4307'>
      <a name='4308'>
                LH(I,J)=ETA<a name='4309'>
                LH_RURAL(I,J)=ETA<a name='4310'>
                GRDFLX(I,J)=SSOIL<a name='4311'>
                GRDFLX_RURAL(I,J)=SSOIL<a name='4312'>
                SNOWC(I,J)=SNCOVR<a name='4313'>
                CHS2(I,J)=CQS2(I,J)<a name='4314'>
                SNOTIME(I,J) = SNOTIME1<a name='4315'>
      <font color=#447700>!      prevent diagnostic ground q (q1) from being greater than qsat(tsk)<a name='4316'></font>
      <font color=#447700>!      as happens over snow cover where the cqs2 value also becomes irrelevant<a name='4317'></font>
      <font color=#447700>!      by setting cqs2=chs in this situation the 2m q should become just qv(k=1)<a name='4318'></font>
                IF (Q1 .GT. QSFC(I,J)) THEN<a name='4319'>
                  CQS2(I,J) = CHS(I,J)<a name='4320'>
                ENDIF<a name='4321'>
      <font color=#447700>!          QSFC(I,J)=Q1<a name='4322'></font>
      <font color=#447700>! Convert QSFC back to mixing ratio<a name='4323'></font>
                 QSFC(I,J)= Q1/(1.0-Q1)<a name='4324'>
      <font color=#447700>!<a name='4325'></font>
                 <font color=#447700>! QSFC_RURAL(I,J)= Q1/(1.0-Q1)<a name='4326'></font>
      <font color=#447700>! Calculate momentum flux from rural surface for use with multi-layer UCM (Martilli et al. 2002)<a name='4327'></font>
      <a name='4328'>
                DO 80 NS=1,NSOIL<a name='4329'>
                 SMOIS(I,NS,J)=SMC(NS)<a name='4330'>
                 TSLB(I,NS,J)=STC(NS)                                        <font color=#447700>!  STEMP<a name='4331'></font>
                 SH2O(I,NS,J)=SWC(NS)<a name='4332'>
         80     CONTINUE<a name='4333'>
      <font color=#447700>!       ENDIF<a name='4334'></font>
      <a name='4335'>
              FLX4_2D(I,J)  = FLX4<a name='4336'>
      	FVB_2D(I,J)   = FVB<a name='4337'>
      	FBUR_2D(I,J)  = FBUR<a name='4338'>
      	FGSN_2D(I,J)  = FGSN<a name='4339'>
           <font color=#447700>!<a name='4340'></font>
           <font color=#447700>! Residual of surface energy balance equation terms<a name='4341'></font>
           <font color=#447700>!<a name='4342'></font>
      <a name='4343'>
           IF ( UA_PHYS ) THEN<a name='4344'>
               noahres(i,j) = ( solnet + lwdn ) - sheat + ssoil - eta &amp;<a name='4345'>
                    - ( emissi * STBOLT * (t1**4) ) - flx1 - flx2 - flx3 - flx4<a name='4346'>
      <a name='4347'>
           ELSE<a name='4348'>
               noahres(i,j) = ( solnet + lwdn ) - sheat + ssoil - eta &amp;<a name='4349'>
                    - ( emissi * STBOLT * (t1**4) ) - flx1 - flx2 - flx3<a name='4350'>
           ENDIF<a name='4351'>
      <a name='4352'>
              IF (SF_URBAN_PHYSICS == 1 ) THEN                                              <font color=#447700>! Beginning of UCM CALL if block<a name='4353'></font>
      <font color=#447700>!--------------------------------------<a name='4354'></font>
      <font color=#447700>! URBAN CANOPY MODEL START - urban<a name='4355'></font>
      <font color=#447700>!--------------------------------------<a name='4356'></font>
      <font color=#447700>! Input variables lsm --&gt; urban<a name='4357'></font>
      <a name='4358'>
                IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;<a name='4359'>
                    IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) ==  HIGH_INTENSITY_INDUSTRIAL) THEN<a name='4360'>
      <a name='4361'>
      <font color=#447700>! Call urban<a name='4362'></font>
      <font color=#447700>!<a name='4363'></font>
                  UTYPE_URB = UTYPE_URB2D(I,J) <font color=#447700>!urban type (low, high or industrial)<a name='4364'></font>
      <a name='4365'>
                  TA_URB    = SFCTMP           <font color=#447700>! [K]<a name='4366'></font>
                  QA_URB    = Q2K              <font color=#447700>! [kg/kg]<a name='4367'></font>
                  UA_URB    = SQRT(U_PHY(I,1,J)**2.+V_PHY(I,1,J)**2.)<a name='4368'>
                  U1_URB    = U_PHY(I,1,J)<a name='4369'>
                  V1_URB    = V_PHY(I,1,J)<a name='4370'>
                  IF(UA_URB &lt; 1.) UA_URB=1.    <font color=#447700>! [m/s]<a name='4371'></font>
                  SSG_URB   = SOLDN            <font color=#447700>! [W/m/m]<a name='4372'></font>
                  SSGD_URB  = 0.8*SOLDN        <font color=#447700>! [W/m/m]<a name='4373'></font>
                  SSGQ_URB  = SSG_URB-SSGD_URB <font color=#447700>! [W/m/m]<a name='4374'></font>
                  LLG_URB   = GLW(I,J)         <font color=#447700>! [W/m/m]<a name='4375'></font>
                  RAIN_URB  = RAINBL(I,J)      <font color=#447700>! [mm]<a name='4376'></font>
                  RHOO_URB  = SFCPRS / (287.04 * SFCTMP * (1.0+ 0.61 * Q2K)) <font color=#447700>![kg/m/m/m]<a name='4377'></font>
                  ZA_URB    = ZLVL             <font color=#447700>! [m]<a name='4378'></font>
                  DELT_URB  = DT               <font color=#447700>! [sec]<a name='4379'></font>
                  XLAT_URB  = XLAT_URB2D(I,J)  <font color=#447700>! [deg]<a name='4380'></font>
                  COSZ_URB  = COSZ_URB2D(I,J)  <font color=#447700>!<a name='4381'></font>
                  OMG_URB   = OMG_URB2D(I,J)   <font color=#447700>!<a name='4382'></font>
                  ZNT_URB   = ZNT(I,J)<a name='4383'>
      <a name='4384'>
                  LSOLAR_URB = .FALSE.<a name='4385'>
      <a name='4386'>
                  TR_URB = TR_URB2D(I,J)<a name='4387'>
                  TB_URB = TB_URB2D(I,J)<a name='4388'>
                  TG_URB = TG_URB2D(I,J)<a name='4389'>
                  TC_URB = TC_URB2D(I,J)<a name='4390'>
                  QC_URB = QC_URB2D(I,J)<a name='4391'>
                  UC_URB = UC_URB2D(I,J)<a name='4392'>
      <a name='4393'>
                  DO K = 1,num_roof_layers<a name='4394'>
                    TRL_URB(K) = TRL_URB3D(I,K,J)<a name='4395'>
                    SMR_URB(K) = SMR_URB3D(I,K,J)<a name='4396'>
             	      TGRL_URB(K)= TGRL_URB3D(I,K,J)<a name='4397'>
                  END DO<a name='4398'>
                  DO K = 1,num_wall_layers<a name='4399'>
                    TBL_URB(K) = TBL_URB3D(I,K,J)<a name='4400'>
                  END DO<a name='4401'>
                  DO K = 1,num_road_layers<a name='4402'>
                    TGL_URB(K) = TGL_URB3D(I,K,J)<a name='4403'>
                  END DO<a name='4404'>
<a name='4405'>
                  TGR_URB   = TGR_URB2D(I,J)<a name='4406'>
                  CMCR_URB  = CMCR_URB2D(I,J)<a name='4407'>
                  FLXHUMR_URB = FLXHUMR_URB2D(I,J)<a name='4408'>
                  FLXHUMB_URB = FLXHUMB_URB2D(I,J)<a name='4409'>
                  FLXHUMG_URB = FLXHUMG_URB2D(I,J)<a name='4410'>
                  DRELR_URB = DRELR_URB2D(I,J)<a name='4411'>
                  DRELB_URB = DRELB_URB2D(I,J)<a name='4412'>
                  DRELG_URB = DRELG_URB2D(I,J)<a name='4413'>
      <a name='4414'>
                  XXXR_URB = XXXR_URB2D(I,J)<a name='4415'>
                  XXXB_URB = XXXB_URB2D(I,J)<a name='4416'>
                  XXXG_URB = XXXG_URB2D(I,J)<a name='4417'>
                  XXXC_URB = XXXC_URB2D(I,J)<a name='4418'>
      <font color=#447700>!<a name='4419'></font>
      <font color=#447700>!      Limits to avoid dividing by small number<a name='4420'></font>
                  if (CHS(I,J) &lt; 1.0E-02) then<a name='4421'>
                     CHS(I,J)  = 1.0E-02<a name='4422'>
                  endif<a name='4423'>
                  if (CHS2(I,J) &lt; 1.0E-02) then<a name='4424'>
                     CHS2(I,J)  = 1.0E-02<a name='4425'>
                  endif<a name='4426'>
                  if (CQS2(I,J) &lt; 1.0E-02) then<a name='4427'>
                     CQS2(I,J)  = 1.0E-02<a name='4428'>
                  endif<a name='4429'>
      <font color=#447700>!<a name='4430'></font>
                  CHS_URB  = CHS(I,J)<a name='4431'>
                  CHS2_URB = CHS2(I,J)<a name='4432'>
                  IF (PRESENT(CMR_SFCDIF)) THEN<a name='4433'>
                     CMR_URB = CMR_SFCDIF(I,J)<a name='4434'>
                     CHR_URB = CHR_SFCDIF(I,J)<a name='4435'>
                     CMGR_URB = CMGR_SFCDIF(I,J)<a name='4436'>
                     CHGR_URB = CHGR_SFCDIF(I,J)<a name='4437'>
                     CMC_URB = CMC_SFCDIF(I,J)<a name='4438'>
                     CHC_URB = CHC_SFCDIF(I,J)<a name='4439'>
                  ENDIF<a name='4440'>
      <a name='4441'>
      <font color=#447700>! NUDAPT for SLUCM<a name='4442'></font>
                  mh_urb = mh_urb2d(I,J)<a name='4443'>
                  stdh_urb = stdh_urb2d(I,J)<a name='4444'>
                  lp_urb = lp_urb2d(I,J)<a name='4445'>
                  hgt_urb = hgt_urb2d(I,J)<a name='4446'>
                  lf_urb = 0.0<a name='4447'>
                  DO K = 1,4<a name='4448'>
                    lf_urb(K)=lf_urb2d(I,K,J)<a name='4449'>
                  ENDDO<a name='4450'>
                  frc_urb = frc_urb2d(I,J)<a name='4451'>
                  lb_urb = lb_urb2d(I,J)<a name='4452'>
                  check = 0<a name='4453'>
                  if (I.eq.73.and.J.eq.125)THEN<a name='4454'>
                     check = 1<a name='4455'>
                  end if<a name='4456'>
      <font color=#447700>!<a name='4457'></font>
      <font color=#447700>! Call urban<a name='4458'></font>
                  CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>cal_mon_day</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_11">(julian,julyr,jmonth,jday)        <a name='4459'>
                  CALL <A href='../../html_code/phys/module_sf_urban.F.html#URBAN'>urban</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="URBAN_4">(LSOLAR_URB,                                      &amp; <font color=#447700>! I<a name='4460'></font>
                             num_roof_layers,num_wall_layers,num_road_layers, &amp; <font color=#447700>! C<a name='4461'></font>
                             DZR,DZB,DZG,                                     &amp; <font color=#447700>! C<a name='4462'></font>
                             UTYPE_URB,TA_URB,QA_URB,UA_URB,U1_URB,V1_URB,SSG_URB, &amp; <font color=#447700>! I<a name='4463'></font>
                             SSGD_URB,SSGQ_URB,LLG_URB,RAIN_URB,RHOO_URB,     &amp; <font color=#447700>! I<a name='4464'></font>
                             ZA_URB,DECLIN_URB,COSZ_URB,OMG_URB,              &amp; <font color=#447700>! I<a name='4465'></font>
                             XLAT_URB,DELT_URB,ZNT_URB,                       &amp; <font color=#447700>! I<a name='4466'></font>
                             CHS_URB, CHS2_URB,                               &amp; <font color=#447700>! I<a name='4467'></font>
                             TR_URB, TB_URB, TG_URB, TC_URB, QC_URB,UC_URB,   &amp; <font color=#447700>! H<a name='4468'></font>
                             TRL_URB,TBL_URB,TGL_URB,                         &amp; <font color=#447700>! H<a name='4469'></font>
                             XXXR_URB, XXXB_URB, XXXG_URB, XXXC_URB,          &amp; <font color=#447700>! H<a name='4470'></font>
                             TS_URB,QS_URB,SH_URB,LH_URB,LH_KINEMATIC_URB,    &amp; <font color=#447700>! O<a name='4471'></font>
                             SW_URB,ALB_URB,LW_URB,G_URB,RN_URB,PSIM_URB,PSIH_URB, &amp; <font color=#447700>! O<a name='4472'></font>
                             GZ1OZ0_URB,                                      &amp; <font color=#447700>!O<a name='4473'></font>
                             CMR_URB, CHR_URB, CMC_URB, CHC_URB,              &amp;<a name='4474'>
                             U10_URB, V10_URB, TH2_URB, Q2_URB,               &amp; <font color=#447700>! O<a name='4475'></font>
                             UST_URB,mh_urb, stdh_urb, lf_urb, lp_urb,        &amp; <font color=#447700>! 0<a name='4476'></font>
                             hgt_urb,frc_urb,lb_urb, check,CMCR_URB,TGR_URB,  &amp; <font color=#447700>! H<a name='4477'></font>
                             TGRL_URB,SMR_URB,CMGR_URB,CHGR_URB,jmonth,       &amp; <font color=#447700>! H<a name='4478'></font>
                             DRELR_URB,DRELB_URB,                             &amp; <font color=#447700>! H<a name='4479'></font>
                             DRELG_URB,FLXHUMR_URB,FLXHUMB_URB,FLXHUMG_URB)  <a name='4480'>
      <a name='4481'>
#if 0<a name='4482'>
                IF(IPRINT) THEN<a name='4483'>
      <a name='4484'>
             print*, 'AFTER CALL URBAN'<a name='4485'>
             print*,'num_roof_layers',num_roof_layers, 'num_wall_layers',  &amp;<a name='4486'>
              num_wall_layers,                                             &amp;<a name='4487'>
             'DZR',DZR,'DZB',DZB,'DZG',DZG,'UTYPE_URB',UTYPE_URB,'TA_URB', &amp;<a name='4488'>
              TA_URB,                                                      &amp;<a name='4489'>
              'QA_URB',QA_URB,'UA_URB',UA_URB,'U1_URB',U1_URB,'V1_URB',    &amp;<a name='4490'>
               V1_URB,                                                     &amp;<a name='4491'>
               'SSG_URB',SSG_URB,'SSGD_URB',SSGD_URB,'SSGQ_URB',SSGQ_URB,  &amp;<a name='4492'>
              'LLG_URB',LLG_URB,'RAIN_URB',RAIN_URB,'RHOO_URB',RHOO_URB,   &amp;<a name='4493'>
              'ZA_URB',ZA_URB, 'DECLIN_URB',DECLIN_URB,'COSZ_URB',COSZ_URB,&amp;<a name='4494'>
              'OMG_URB',OMG_URB,'XLAT_URB',XLAT_URB,'DELT_URB',DELT_URB,   &amp;<a name='4495'>
               'ZNT_URB',ZNT_URB,'TR_URB',TR_URB, 'TB_URB',TB_URB,'TG_URB',&amp;<a name='4496'>
               TG_URB,'TC_URB',TC_URB,'QC_URB',QC_URB,'TRL_URB',TRL_URB,   &amp;<a name='4497'>
                'TBL_URB',TBL_URB,'TGL_URB',TGL_URB,'XXXR_URB',XXXR_URB,   &amp;<a name='4498'>
               'XXXB_URB',XXXB_URB,'XXXG_URB',XXXG_URB,'XXXC_URB',XXXC_URB,&amp;<a name='4499'>
               'TS_URB',TS_URB,'QS_URB',QS_URB,'SH_URB',SH_URB,'LH_URB',   &amp;<a name='4500'>
               LH_URB, 'LH_KINEMATIC_URB',LH_KINEMATIC_URB,'SW_URB',SW_URB,&amp;<a name='4501'>
               'ALB_URB',ALB_URB,'LW_URB',LW_URB,'G_URB',G_URB,'RN_URB',   &amp;<a name='4502'>
                RN_URB, 'PSIM_URB',PSIM_URB,'PSIH_URB',PSIH_URB,          &amp;<a name='4503'>
               'U10_URB',U10_URB,'V10_URB',V10_URB,'TH2_URB',TH2_URB,      &amp;<a name='4504'>
                'Q2_URB',Q2_URB,'CHS_URB',CHS_URB,'CHS2_URB',CHS2_URB<a name='4505'>
                 endif<a name='4506'>
#endif<a name='4507'>
      <a name='4508'>
                  TS_URB2D(I,J) = TS_URB<a name='4509'>
      <a name='4510'>
                  ALBEDO(I,J) = FRC_URB2D(I,J)*ALB_URB+(1-FRC_URB2D(I,J))*ALBEDOK   <font color=#447700>![-]<a name='4511'></font>
                  HFX(I,J) = FRC_URB2D(I,J)*SH_URB+(1-FRC_URB2D(I,J))*SHEAT         <font color=#447700>![W/m/m]<a name='4512'></font>
                  QFX(I,J) = FRC_URB2D(I,J)*LH_KINEMATIC_URB &amp;<a name='4513'>
                           + (1-FRC_URB2D(I,J))*ETA_KINEMATIC                <font color=#447700>![kg/m/m/s]<a name='4514'></font>
                  LH(I,J) = FRC_URB2D(I,J)*LH_URB+(1-FRC_URB2D(I,J))*ETA            <font color=#447700>![W/m/m]<a name='4515'></font>
                  GRDFLX(I,J) = FRC_URB2D(I,J)*G_URB+(1-FRC_URB2D(I,J))*SSOIL       <font color=#447700>![W/m/m]<a name='4516'></font>
                  TSK(I,J) = FRC_URB2D(I,J)*TS_URB+(1-FRC_URB2D(I,J))*T1            <font color=#447700>![K]<a name='4517'></font>
                  Q1 = FRC_URB2D(I,J)*QS_URB+(1-FRC_URB2D(I,J))*Q1            <font color=#447700>![-]<a name='4518'></font>
      <font color=#447700>! Convert QSFC back to mixing ratio<a name='4519'></font>
                  QSFC(I,J)= Q1/(1.0-Q1)<a name='4520'>
                  UST(I,J)= FRC_URB2D(I,J)*UST_URB+(1-FRC_URB2D(I,J))*UST(I,J)      <font color=#447700>![m/s]<a name='4521'></font>
      <a name='4522'>
#if 0<a name='4523'>
          IF(IPRINT)THEN<a name='4524'>
      <a name='4525'>
          print*, ' FRC_URB2D', FRC_URB2D,                        &amp;<a name='4526'>
          'ALB_URB',ALB_URB, 'ALBEDOK',ALBEDOK, &amp;<a name='4527'>
          'ALBEDO(I,J)',  ALBEDO(I,J),                  &amp;<a name='4528'>
          'SH_URB',SH_URB,'SHEAT',SHEAT, 'HFX(I,J)',HFX(I,J),  &amp;<a name='4529'>
          'LH_KINEMATIC_URB',LH_KINEMATIC_URB,'ETA_KINEMATIC',  &amp;<a name='4530'>
           ETA_KINEMATIC, 'QFX(I,J)',QFX(I,J),                  &amp;<a name='4531'>
          'LH_URB',LH_URB, 'ETA',ETA, 'LH(I,J)',LH(I,J),        &amp;<a name='4532'>
          'G_URB',G_URB,'SSOIL',SSOIL,'GRDFLX(I,J)', GRDFLX(I,J),&amp;<a name='4533'>
          'TS_URB',TS_URB,'T1',T1,'TSK(I,J)',TSK(I,J),          &amp;<a name='4534'>
          'QS_URB',QS_URB,'Q1',Q1,'QSFC(I,J)',QSFC(I,J)<a name='4535'>
           endif<a name='4536'>
#endif<a name='4537'>
      <a name='4538'>
      <font color=#447700>! Renew Urban State Varialbes<a name='4539'></font>
      <a name='4540'>
                  TR_URB2D(I,J) = TR_URB<a name='4541'>
                  TB_URB2D(I,J) = TB_URB<a name='4542'>
                  TG_URB2D(I,J) = TG_URB<a name='4543'>
                  TC_URB2D(I,J) = TC_URB<a name='4544'>
                  QC_URB2D(I,J) = QC_URB<a name='4545'>
                  UC_URB2D(I,J) = UC_URB<a name='4546'>
      <a name='4547'>
                  DO K = 1,num_roof_layers<a name='4548'>
                    TRL_URB3D(I,K,J) = TRL_URB(K)<a name='4549'>
                    SMR_URB3D(I,K,J) = SMR_URB(K)<a name='4550'>
                    TGRL_URB3D(I,K,J)= TGRL_URB(K)<a name='4551'>
                  END DO<a name='4552'>
                  DO K = 1,num_wall_layers<a name='4553'>
                    TBL_URB3D(I,K,J) = TBL_URB(K)<a name='4554'>
                  END DO<a name='4555'>
                  DO K = 1,num_road_layers<a name='4556'>
                    TGL_URB3D(I,K,J) = TGL_URB(K)<a name='4557'>
                  END DO<a name='4558'>
                 <a name='4559'>
                  TGR_URB2D(I,J) =TGR_URB <a name='4560'>
                  CMCR_URB2D(I,J)=CMCR_URB<a name='4561'>
                  FLXHUMR_URB2D(I,J)=FLXHUMR_URB <a name='4562'>
                  FLXHUMB_URB2D(I,J)=FLXHUMB_URB<a name='4563'>
                  FLXHUMG_URB2D(I,J)=FLXHUMG_URB<a name='4564'>
                  DRELR_URB2D(I,J) = DRELR_URB <a name='4565'>
                  DRELB_URB2D(I,J) = DRELB_URB <a name='4566'>
                  DRELG_URB2D(I,J) = DRELG_URB<a name='4567'>
<a name='4568'>
                  XXXR_URB2D(I,J) = XXXR_URB<a name='4569'>
                  XXXB_URB2D(I,J) = XXXB_URB<a name='4570'>
                  XXXG_URB2D(I,J) = XXXG_URB<a name='4571'>
                  XXXC_URB2D(I,J) = XXXC_URB<a name='4572'>
      <a name='4573'>
                  SH_URB2D(I,J)    = SH_URB<a name='4574'>
                  LH_URB2D(I,J)    = LH_URB<a name='4575'>
                  G_URB2D(I,J)     = G_URB<a name='4576'>
                  RN_URB2D(I,J)    = RN_URB<a name='4577'>
                  PSIM_URB2D(I,J)  = PSIM_URB<a name='4578'>
                  PSIH_URB2D(I,J)  = PSIH_URB<a name='4579'>
                  GZ1OZ0_URB2D(I,J)= GZ1OZ0_URB<a name='4580'>
                  U10_URB2D(I,J)   = U10_URB<a name='4581'>
                  V10_URB2D(I,J)   = V10_URB<a name='4582'>
                  TH2_URB2D(I,J)   = TH2_URB<a name='4583'>
                  Q2_URB2D(I,J)    = Q2_URB<a name='4584'>
                  UST_URB2D(I,J)   = UST_URB<a name='4585'>
                  AKMS_URB2D(I,J)  = KARMAN * UST_URB2D(I,J)/(GZ1OZ0_URB2D(I,J)-PSIM_URB2D(I,J))<a name='4586'>
                  IF (PRESENT(CMR_SFCDIF)) THEN<a name='4587'>
                     CMR_SFCDIF(I,J) = CMR_URB<a name='4588'>
                     CHR_SFCDIF(I,J) = CHR_URB<a name='4589'>
                     CMGR_SFCDIF(I,J) = CMGR_URB<a name='4590'>
                     CHGR_SFCDIF(I,J) = CHGR_URB<a name='4591'>
                     CMC_SFCDIF(I,J) = CMC_URB<a name='4592'>
                     CHC_SFCDIF(I,J) = CHC_URB<a name='4593'>
                  ENDIF<a name='4594'>
                END IF<a name='4595'>
      <a name='4596'>
               ENDIF                                   <font color=#447700>! end of UCM CALL if block<a name='4597'></font>
      <font color=#447700>!--------------------------------------<a name='4598'></font>
      <font color=#447700>! Urban Part End - urban<a name='4599'></font>
      <font color=#447700>!--------------------------------------<a name='4600'></font>
      <a name='4601'>
      <font color=#447700>!***  DIAGNOSTICS<a name='4602'></font>
                SMSTAV(I,J)=SOILW<a name='4603'>
                SMSTOT(I,J)=SOILM*1000.<a name='4604'>
                DO NS=1,NSOIL<a name='4605'>
                SMCREL(I,NS,J)=SMAV(NS)<a name='4606'>
                ENDDO<a name='4607'>
      <a name='4608'>
      <font color=#447700>!         Convert the water unit into mm<a name='4609'></font>
                SFCRUNOFF(I,J)=SFCRUNOFF(I,J)+RUNOFF1*DT*1000.0<a name='4610'>
                UDRUNOFF(I,J)=UDRUNOFF(I,J)+RUNOFF2*DT*1000.0<a name='4611'>
      <font color=#447700>! snow defined when fraction of frozen precip (FFROZP) &gt; 0.5,<a name='4612'></font>
                IF(FFROZP.GT.0.5)THEN<a name='4613'>
                  ACSNOW(I,J)=ACSNOW(I,J)+PRCP*DT<a name='4614'>
                ENDIF<a name='4615'>
                IF(SNOW(I,J).GT.0.)THEN<a name='4616'>
                  ACSNOM(I,J)=ACSNOM(I,J)+SNOMLT*1000.<a name='4617'>
      <font color=#447700>! accumulated snow-melt energy<a name='4618'></font>
                  SNOPCX(I,J)=SNOPCX(I,J)-SNOMLT/FDTLIW<a name='4619'>
                ENDIF<a name='4620'>
      <a name='4621'>
              ENDIF                                                           <font color=#447700>! endif of land-sea test<a name='4622'></font>
<a name='4623'>
      ENDIF                                           <font color=#447700>! ENDIF FOR MOSAIC DANLI  ! This corresponds to IF ((sf_surface_mosaic == 1) .AND. ((XLAND(I,J)-1.5).LT.0.) .AND. (XICE(I,J) &lt; XICE_THRESHOLD) ) THEN<a name='4624'></font>
<a name='4625'>
      ENDDO ILOOP                                                       <font color=#447700>! of I loop<a name='4626'></font>
   ENDDO JLOOP                                                          <font color=#447700>! of J loop   <a name='4627'></font>
       <a name='4628'>
<font color=#447700>!------------------------------------------------------<a name='4629'></font>
   END SUBROUTINE lsm_mosaic<a name='4630'>
<font color=#447700>!------------------------------------------------------<a name='4631'></font>
<font color=#447700>!===========================================================================<a name='4632'></font>
<font color=#447700>!<a name='4633'></font>
<font color=#447700>! subroutine lsm_mosaic_init: initialization of mosaic state variables<a name='4634'></font>
<font color=#447700>!<a name='4635'></font>
<font color=#447700>!===========================================================================   <a name='4636'></font>
  <a name='4637'>
<A NAME='LSM_MOSAIC_INIT'><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4638'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>lsm_mosaic_init</font>(IVGTYP,ISWATER,ISURBAN,ISICE, XLAND, XICE,fractional_seaice, &amp; <A href='../../call_to/LSM_MOSAIC_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/LSM_MOSAIC_INIT.html' TARGET='index'>24</A><a name='4639'>
                  TSK,TSLB,SMOIS,SH2O,SNOW,SNOWC,SNOWH,CANWAT,    &amp;<a name='4640'>
                  ids,ide, jds,jde, kds,kde,                      &amp;<a name='4641'>
                  ims,ime, jms,jme, kms,kme,                      &amp;<a name='4642'>
                  its,ite, jts,jte, kts,kte, restart,             &amp;<a name='4643'>
                  landusef,landusef2,NLCAT,num_soil_layers        &amp; <a name='4644'>
                  ,sf_surface_mosaic, mosaic_cat                  &amp; <a name='4645'>
                  ,mosaic_cat_index                               &amp;   <a name='4646'>
                  ,TSK_mosaic,TSLB_mosaic                         &amp;<a name='4647'>
                  ,SMOIS_mosaic,SH2O_mosaic                       &amp; <a name='4648'>
                  ,CANWAT_mosaic,SNOW_mosaic                      &amp;<a name='4649'>
                  ,SNOWH_mosaic,SNOWC_mosaic                      &amp;<a name='4650'>
                  ,ALBEDO,ALBBCK, EMISS, EMBCK,Z0                 &amp;  <font color=#447700>!danli  <a name='4651'></font>
                  ,ALBEDO_mosaic,ALBBCK_mosaic, EMISS_mosaic      &amp;  <font color=#447700>!danli<a name='4652'></font>
                  ,EMBCK_mosaic, ZNT_mosaic, Z0_mosaic            &amp;  <font color=#447700>!danli<a name='4653'></font>
                  ,TR_URB2D_mosaic,TB_URB2D_mosaic                &amp;  <font color=#447700>!danli mosaic <a name='4654'></font>
                  ,TG_URB2D_mosaic,TC_URB2D_mosaic                &amp;  <font color=#447700>!danli mosaic <a name='4655'></font>
                  ,QC_URB2D_mosaic                                &amp;  <font color=#447700>!danli mosaic                  <a name='4656'></font>
                  ,TRL_URB3D_mosaic,TBL_URB3D_mosaic              &amp;  <font color=#447700>!danli mosaic <a name='4657'></font>
                  ,TGL_URB3D_mosaic                               &amp;  <font color=#447700>!danli mosaic <a name='4658'></font>
                  ,SH_URB2D_mosaic,LH_URB2D_mosaic                &amp;  <font color=#447700>!danli mosaic <a name='4659'></font>
                  ,G_URB2D_mosaic,RN_URB2D_mosaic                 &amp;  <font color=#447700>!danli mosaic <a name='4660'></font>
                  ,TS_URB2D_mosaic                                &amp;  <font color=#447700>!danli mosaic <a name='4661'></font>
                  ,TS_RUL2D_mosaic                                &amp;  <font color=#447700>!danli mosaic                    <a name='4662'></font>
                   ) <a name='4663'>
  <a name='4664'>
    INTEGER,  INTENT(IN)   ::       ids,ide, jds,jde, kds,kde,  &amp;<a name='4665'>
                                    ims,ime, jms,jme, kms,kme,  &amp;<a name='4666'>
                                    its,ite, jts,jte, kts,kte <a name='4667'>
<a name='4668'>
   INTEGER, INTENT(IN)       ::     NLCAT, num_soil_layers, ISWATER,ISURBAN, ISICE, fractional_seaice<a name='4669'>
<a name='4670'>
   LOGICAL , INTENT(IN) :: restart <a name='4671'>
<a name='4672'>
<font color=#447700>!   REAL,    DIMENSION( num_soil_layers), INTENT(INOUT) :: ZS, DZS<a name='4673'></font>
<a name='4674'>
   REAL,    DIMENSION( ims:ime, num_soil_layers, jms:jme )    , &amp;<a name='4675'>
            INTENT(IN)    ::                             SMOIS, &amp;  <font color=#447700>!Total soil moisture<a name='4676'></font>
                                                         SH2O,  &amp;  <font color=#447700>!liquid soil moisture       <a name='4677'></font>
                                                         TSLB      <font color=#447700>!STEMP<a name='4678'></font>
<a name='4679'>
   REAL,    DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='4680'>
            INTENT(IN)    ::                           SNOW, &amp;<a name='4681'>
                                                         SNOWH, &amp;<a name='4682'>
                                                         SNOWC, &amp;<a name='4683'>
                                                        CANWAT, &amp;<a name='4684'>
                                                        TSK, XICE, XLAND         <a name='4685'>
  <a name='4686'>
  INTEGER, INTENT(IN) :: sf_surface_mosaic  <a name='4687'>
  INTEGER, INTENT(IN) :: mosaic_cat<a name='4688'>
  INTEGER, DIMENSION( ims:ime, jms:jme ),INTENT(IN) :: IVGTYP<a name='4689'>
  REAL, DIMENSION( ims:ime, NLCAT, jms:jme ) , INTENT(IN)::   LANDUSEF<a name='4690'>
  REAL, DIMENSION( ims:ime, NLCAT, jms:jme ) , INTENT(INOUT)::   LANDUSEF2<a name='4691'>
  <a name='4692'>
  INTEGER, DIMENSION( ims:ime, NLCAT, jms:jme ), INTENT(INOUT) :: mosaic_cat_index <a name='4693'>
<a name='4694'>
  REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::   &amp;<a name='4695'>
        TSK_mosaic, CANWAT_mosaic, SNOW_mosaic,SNOWH_mosaic, SNOWC_mosaic <a name='4696'>
  REAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), OPTIONAL, INTENT(INOUT)::   &amp;<a name='4697'>
        TSLB_mosaic,SMOIS_mosaic,SH2O_mosaic<a name='4698'>
  <a name='4699'>
  REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(IN)::   ALBEDO, ALBBCK, EMISS, EMBCK, Z0 <a name='4700'>
  REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::   &amp;<a name='4701'>
        ALBEDO_mosaic,ALBBCK_mosaic, EMISS_mosaic, EMBCK_mosaic, ZNT_mosaic, Z0_mosaic<a name='4702'>
<a name='4703'>
  REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::   &amp;<a name='4704'>
        TR_URB2D_mosaic, TB_URB2D_mosaic, TG_URB2D_mosaic, TC_URB2D_mosaic,QC_URB2D_mosaic,  &amp;<a name='4705'>
        SH_URB2D_mosaic,LH_URB2D_mosaic,G_URB2D_mosaic,RN_URB2D_mosaic,TS_URB2D_mosaic, TS_RUL2D_mosaic  <a name='4706'>
                    <a name='4707'>
  REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TRL_URB3D_mosaic<a name='4708'>
  REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TBL_URB3D_mosaic<a name='4709'>
  REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TGL_URB3D_mosaic    <a name='4710'>
<a name='4711'>
  INTEGER :: ij,i,j,mosaic_i,LastSwap,NumPairs,soil_k, Temp2,Temp5,Temp7, ICE,temp_index<a name='4712'>
  REAL :: Temp, Temp3,Temp4,Temp6,xice_threshold<a name='4713'>
  LOGICAL :: IPRINT<a name='4714'>
  CHARACTER(len=256) :: message_text<a name='4715'>
<a name='4716'>
  IPRINT=.false.<a name='4717'>
<a name='4718'>
  if ( fractional_seaice == 0 ) then<a name='4719'>
     xice_threshold = 0.5<a name='4720'>
  else if ( fractional_seaice == 1 ) then<a name='4721'>
     xice_threshold = 0.02<a name='4722'>
  endif<a name='4723'>
<a name='4724'>
    IF(.not.restart)THEN<a name='4725'>
  <font color=#447700>!===========================================================================   <a name='4726'></font>
  <font color=#447700>! CHOOSE THE TILES<a name='4727'></font>
  <font color=#447700>!===========================================================================  <a name='4728'></font>
  <a name='4729'>
  itf=min0(ite,ide-1)<a name='4730'>
  jtf=min0(jte,jde-1)<a name='4731'>
<a name='4732'>
  <font color=#447700>! simple test<a name='4733'></font>
   <a name='4734'>
  DO i = its,itf<a name='4735'>
     DO j = jts,jtf <a name='4736'>
        IF ((xland(i,j).LT. 1.5 ) .AND. (IVGTYP(i,j) .EQ. ISWATER)) THEN<a name='4737'>
           PRINT*, 'BEFORE MOSAIC_INIT'<a name='4738'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_922">("BEFORE MOSAIC_INIT")<a name='4739'>
           WRITE(message_text,fmt='(a,2I6,2F8.2,2I6)') 'I,J,xland,xice,mosaic_cat_index,ivgtyp = ', &amp;<a name='4740'>
                 I,J,xland(i,j),xice(i,j),mosaic_cat_index(I,1,J),IVGTYP(i,j)<a name='4741'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_923">(message_text)<a name='4742'>
        ENDIF<a name='4743'>
     ENDDO<a name='4744'>
  ENDDO<a name='4745'>
<a name='4746'>
     DO i = its,itf<a name='4747'>
        DO j = jts,jtf<a name='4748'>
           DO mosaic_i=1,NLCAT<a name='4749'>
              LANDUSEF2(i,mosaic_i,j)=LANDUSEF(i,mosaic_i,j)<a name='4750'>
              mosaic_cat_index(i,mosaic_i,j)=mosaic_i<a name='4751'>
           ENDDO<a name='4752'>
        ENDDO<a name='4753'>
     ENDDO<a name='4754'>
<a name='4755'>
     DO i = its,itf<a name='4756'>
        DO j = jts,jtf<a name='4757'>
          <a name='4758'>
          NumPairs=NLCAT-1<a name='4759'>
          <a name='4760'>
          DO <a name='4761'>
               IF (NumPairs == 0) EXIT<a name='4762'>
                   LastSwap = 1<a name='4763'>
          DO  mosaic_i=1, NumPairs<a name='4764'>
            IF(LANDUSEF2(i,mosaic_i, j) &lt; LANDUSEF2(i,mosaic_i+1, j)  ) THEN<a name='4765'>
               Temp = LANDUSEF2(i,mosaic_i, j)<a name='4766'>
               LANDUSEF2(i,mosaic_i, j)=LANDUSEF2(i,mosaic_i+1, j)<a name='4767'>
               LANDUSEF2(i,mosaic_i+1, j)=Temp            <a name='4768'>
               LastSwap = mosaic_i <a name='4769'>
            <a name='4770'>
               Temp2 =  mosaic_cat_index(i,mosaic_i,j)<a name='4771'>
               mosaic_cat_index(i,mosaic_i,j)=mosaic_cat_index(i,mosaic_i+1,j)<a name='4772'>
               mosaic_cat_index(i,mosaic_i+1,j)=Temp2<a name='4773'>
            ENDIF<a name='4774'>
          ENDDO<a name='4775'>
               NumPairs = LastSwap - 1<a name='4776'>
          ENDDO<a name='4777'>
          <a name='4778'>
        ENDDO<a name='4779'>
      ENDDO<a name='4780'>
<a name='4781'>
  <font color=#447700>!===========================================================================   <a name='4782'></font>
  <font color=#447700>! For non-seaice grids, eliminate the seaice-tiles<a name='4783'></font>
  <font color=#447700>!=========================================================================== <a name='4784'></font>
<a name='4785'>
     DO i = its,itf<a name='4786'>
        DO j = jts,jtf<a name='4787'>
        <a name='4788'>
         IF   (XLAND(I,J).LT.1.5)  THEN<a name='4789'>
<a name='4790'>
             ICE = 0<a name='4791'>
                 IF( XICE(I,J).GE. XICE_THRESHOLD ) THEN<a name='4792'>
                   WRITE (message_text,fmt='(a,2I5)') 'sea-ice at point, I and J = ', i,j<a name='4793'>
                   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_924">(message_text)<a name='4794'>
                 ICE = 1<a name='4795'>
                 ENDIF   <a name='4796'>
           <a name='4797'>
          IF (ICE == 1)   Then         <font color=#447700>! sea-ice case , eliminate sea-ice if they are not the dominant ones<a name='4798'></font>
<a name='4799'>
          IF (IVGTYP(i,j) == isice)  THEN    <font color=#447700>! if this grid cell is dominanted by ice, then do nothing<a name='4800'></font>
<a name='4801'>
          ELSE<a name='4802'>
<a name='4803'>
                DO mosaic_i=2,mosaic_cat<a name='4804'>
                   IF (mosaic_cat_index(i,mosaic_i,j) == isice ) THEN<a name='4805'>
                       Temp4=LANDUSEF2(i,mosaic_i,j)<a name='4806'>
                       Temp5=mosaic_cat_index(i,mosaic_i,j)<a name='4807'>
<a name='4808'>
                       LANDUSEF2(i,mosaic_i:NLCAT-1,j)=LANDUSEF2(i,mosaic_i+1:NLCAT,j)                       <a name='4809'>
                       mosaic_cat_index(i,mosaic_i:NLCAT-1,j)=mosaic_cat_index(i,mosaic_i+1:NLCAT,j)<a name='4810'>
<a name='4811'>
                       LANDUSEF2(i,NLCAT,j)=Temp4<a name='4812'>
                       mosaic_cat_index(i,NLCAT,j)=Temp5<a name='4813'>
                   ENDIF <a name='4814'>
                 ENDDO<a name='4815'>
<a name='4816'>
          ENDIF   <font color=#447700>! for (IVGTYP(i,j) == isice )<a name='4817'></font>
          <a name='4818'>
          ELSEIF (ICE ==0)  THEN<a name='4819'>
          <a name='4820'>
          IF ((mosaic_cat_index(I,1,J) .EQ. ISWATER)) THEN    <a name='4821'>
          <a name='4822'>
          <font color=#447700>! xland &lt; 1.5 but the dominant land use category based on our calculation is water<a name='4823'></font>
	             <a name='4824'>
           IF (IVGTYP(i,j) .EQ. ISWATER) THEN  <a name='4825'>
           <a name='4826'>
           <font color=#447700>! xland &lt; 1.5 but the dominant land use category based on the geogrid calculation is water, this must be wrong<a name='4827'></font>
           <a name='4828'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_925">("IN MOSAIC_INIT")<a name='4829'>
              WRITE(message_text,fmt='(a,3I6,2F8.2)') 'I,J,IVGTYP,XLAND,XICE = ',I,J,IVGTYP(I,J),xland(i,j),xice(i,j) <a name='4830'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_926">(message_text)<a name='4831'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_927">("xland &lt; 1.5 but the dominant land use category based on our calculation is water."//&amp;<a name='4832'>
                   "In addition, the dominant land use category based on the geogrid calculation is water, this must be wrong")<a name='4833'>
           <a name='4834'>
           ENDIF  <font color=#447700>! for (IVGTYP(i,j) .EQ. ISWATER)<a name='4835'></font>
           <a name='4836'>
           IF (IVGTYP(i,j) .NE. ISWATER) THEN <a name='4837'>
           <a name='4838'>
           <font color=#447700>! xland &lt; 1.5,   the dominant land use category based on our calculation is water, but based on the geogrid calculation is not water, which might be due to the inconsistence between land use data and land-sea mask<a name='4839'></font>
           <a name='4840'>
	       Temp4=LANDUSEF2(i,1,j)<a name='4841'>
	       Temp5=mosaic_cat_index(i,1,j)<a name='4842'>
	  <a name='4843'>
	       LANDUSEF2(i,1:NLCAT-1,j)=LANDUSEF2(i,2:NLCAT,j)                       <a name='4844'>
	       mosaic_cat_index(i,1:NLCAT-1,j)=mosaic_cat_index(i,2:NLCAT,j)<a name='4845'>
	  <a name='4846'>
	       LANDUSEF2(i,NLCAT,j)=Temp4<a name='4847'>
	       mosaic_cat_index(i,NLCAT,j)=Temp5<a name='4848'>
	             <a name='4849'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_928">("IN MOSAIC_INIT")<a name='4850'>
              WRITE(message_text,fmt='(a,3I6,2F8.2)') 'I,J,IVGTYP,XLAND,XICE = ',I,J,IVGTYP(I,J),xland(i,j),xice(i,j) <a name='4851'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_929">(message_text)<a name='4852'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_930">("xland &lt; 1.5 but the dominant land use category based on our calculation is water."//&amp;<a name='4853'>
                   "this is fine as long as we change our calculation so that the dominant land use category is"//&amp;<a name='4854'>
                   "stwiched back to not water.")<a name='4855'>
              WRITE(message_text,fmt='(a,2I6)') 'land use category has been switched, before and after values are ', &amp;<a name='4856'>
                   temp5,mosaic_cat_index(i,1,j)<a name='4857'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_931">(message_text)<a name='4858'>
              WRITE(message_text,fmt='(a,2I6)') 'new dominant and second dominant cat are ', mosaic_cat_index(i,1,j),mosaic_cat_index(i,2,j)<a name='4859'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_932">(message_text)<a name='4860'>
	             <a name='4861'>
           ENDIF  <font color=#447700>! for (IVGTYP(i,j) .NE. ISWATER)<a name='4862'></font>
          <a name='4863'>
           ELSE    <font color=#447700>!  for (mosaic_cat_index(I,1,J) .EQ. ISWATER)<a name='4864'></font>
           <a name='4865'>
                     DO mosaic_i=2,mosaic_cat<a name='4866'>
	                IF (mosaic_cat_index(i,mosaic_i,j) == iswater ) THEN<a name='4867'>
	                   Temp4=LANDUSEF2(i,mosaic_i,j)<a name='4868'>
	                   Temp5=mosaic_cat_index(i,mosaic_i,j)<a name='4869'>
	   <a name='4870'>
	                   LANDUSEF2(i,mosaic_i:NLCAT-1,j)=LANDUSEF2(i,mosaic_i+1:NLCAT,j)                       <a name='4871'>
	                   mosaic_cat_index(i,mosaic_i:NLCAT-1,j)=mosaic_cat_index(i,mosaic_i+1:NLCAT,j)<a name='4872'>
	  <a name='4873'>
	                   LANDUSEF2(i,NLCAT,j)=Temp4<a name='4874'>
	                   mosaic_cat_index(i,NLCAT,j)=Temp5<a name='4875'>
	                ENDIF <a name='4876'>
	              ENDDO<a name='4877'>
             <a name='4878'>
           ENDIF <font color=#447700>!  for (mosaic_cat_index(I,1,J) .EQ. ISWATER)<a name='4879'></font>
             <a name='4880'>
          ENDIF  <font color=#447700>!  for ICE == 1<a name='4881'></font>
          <a name='4882'>
      ELSE  <font color=#447700>! FOR (XLAND(I,J).LT.1.5)<a name='4883'></font>
      <a name='4884'>
                 ICE = 0<a name='4885'>
      <a name='4886'>
                     IF( XICE(I,J).GE. XICE_THRESHOLD ) THEN<a name='4887'>
                       WRITE (message_text,fmt='(a,2I6)') 'sea-ice at water point, I and J = ', i,j<a name='4888'>
                       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_933">(message_text)<a name='4889'>
                       ICE = 1<a name='4890'>
                     ENDIF  <a name='4891'>
      <a name='4892'>
           IF ((mosaic_cat_index(I,1,J) .NE. ISWATER)) THEN    <a name='4893'>
                <a name='4894'>
                <font color=#447700>! xland &gt; 1.5 and the dominant land use category based on our calculation is not water<a name='4895'></font>
      	             <a name='4896'>
                 IF (IVGTYP(i,j) .NE. ISWATER) THEN  <a name='4897'>
                 <a name='4898'>
                 <font color=#447700>! xland &gt; 1.5 but the dominant land use category based on the geogrid calculation is not water, this must be wrong<a name='4899'></font>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_934">("IN MOSAIC_INIT")<a name='4900'>
                 WRITE(message_text,fmt='(a,3I6,2F8.2)') 'I,J,IVGTYP,XLAND,XICE = ',I,J,IVGTYP(I,J),xland(i,j),xice(i,j)<a name='4901'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_935">(message_text)<a name='4902'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_936">("xland &gt; 1.5 but the dominant land use category based on our calculation is not water."// &amp;<a name='4903'>
                      "in addition, the dominant land use category based on the geogrid calculation is not water,"//  &amp;<a name='4904'>
                      "this must be wrong.")<a name='4905'>
                 ENDIF  <font color=#447700>! for (IVGTYP(i,j) .NE. ISWATER)<a name='4906'></font>
                 <a name='4907'>
                 IF (IVGTYP(i,j) .EQ. ISWATER) THEN <a name='4908'>
                 <a name='4909'>
                 <font color=#447700>! xland &gt; 1.5,   the dominant land use category based on our calculation is not water, but based on the geogrid calculation is water, which might be due to the inconsistence between land use data and land-sea mask<a name='4910'></font>
<a name='4911'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_937">("IN MOSAIC_INIT")<a name='4912'>
                 WRITE(message_text,fmt='(a,3I6,2F8.2)') 'I,J,IVGTYP,XLAND,XICE = ',I,J,IVGTYP(I,J),xland(i,j),xice(i,j)<a name='4913'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_938">(message_text)<a name='4914'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_939">("xland &gt; 1.5 but the dominant land use category based on our calculation is not water."// &amp;<a name='4915'>
                      "however, the dominant land use category based on the geogrid calculation is water")<a name='4916'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_940">("This is fine. We do not need to do anyting because in the noaddrv, "//&amp;<a name='4917'>
                      "we use xland as a criterion for whether using"// &amp;<a name='4918'>
                      "mosaic or not when xland &gt; 1.5, no mosaic will be used anyway")<a name='4919'>
      	             <a name='4920'>
                 ENDIF  <font color=#447700>! for (IVGTYP(i,j) .NE. ISWATER)<a name='4921'></font>
                <a name='4922'>
           ENDIF <font color=#447700>!  for (mosaic_cat_index(I,1,J) .NE. ISWATER)<a name='4923'></font>
      <a name='4924'>
        ENDIF  <font color=#447700>! FOR (XLAND(I,J).LT.1.5)<a name='4925'></font>
<a name='4926'>
          ENDDO<a name='4927'>
      ENDDO<a name='4928'>
      <a name='4929'>
  <font color=#447700>!===========================================================================   <a name='4930'></font>
  <font color=#447700>! normalize<a name='4931'></font>
  <font color=#447700>!=========================================================================== <a name='4932'></font>
<a name='4933'>
     DO i = its,itf<a name='4934'>
        DO j = jts,jtf<a name='4935'>
<a name='4936'>
          Temp6=0<a name='4937'>
<a name='4938'>
            DO mosaic_i=1,mosaic_cat<a name='4939'>
               Temp6=Temp6+LANDUSEF2(i,mosaic_i,j)<a name='4940'>
            ENDDO<a name='4941'>
            <a name='4942'>
            if (Temp6 .LT. 1e-5)  then<a name='4943'>
            <a name='4944'>
            Temp6 = 1e-5<a name='4945'>
            WRITE (message_text,fmt='(a,e8.1)') 'the total land surface fraction is less than ', temp6<a name='4946'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_941">(message_text)<a name='4947'>
            WRITE (message_text,fmt='(a,2I6,4F8.2)') 'some landusef values at i,j are ', &amp;<a name='4948'>
                 i,j,landusef2(i,1,j),landusef2(i,2,j),landusef2(i,3,j),landusef2(i,4,j)<a name='4949'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_942">(message_text)<a name='4950'>
            WRITE (message_text,fmt='(a,2I6,3I6)') 'some mosaic cat values at i,j are ', &amp;<a name='4951'>
                 i,j,mosaic_cat_index(i,1,j),mosaic_cat_index(i,2,j),mosaic_cat_index(i,3,j) <a name='4952'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_943">(message_text)<a name='4953'>
            <a name='4954'>
            endif<a name='4955'>
<a name='4956'>
            LANDUSEF2(i,1:mosaic_cat, j)=LANDUSEF2(i,1:mosaic_cat,j)*(1/Temp6)<a name='4957'>
<a name='4958'>
          ENDDO<a name='4959'>
      ENDDO<a name='4960'>
      <a name='4961'>
  <font color=#447700>!===========================================================================   <a name='4962'></font>
  <font color=#447700>! initilize the variables<a name='4963'></font>
  <font color=#447700>!===========================================================================   <a name='4964'></font>
<a name='4965'>
     DO i = its,itf<a name='4966'>
        DO j = jts,jtf<a name='4967'>
    <a name='4968'>
             DO mosaic_i=1,mosaic_cat<a name='4969'>
        <a name='4970'>
            TSK_mosaic(i,mosaic_i,j)=TSK(i,j)          <a name='4971'>
            CANWAT_mosaic(i,mosaic_i,j)=CANWAT(i,j) <a name='4972'>
            SNOW_mosaic(i,mosaic_i,j)=SNOW(i,j) <a name='4973'>
            SNOWH_mosaic(i,mosaic_i,j)=SNOWH(i,j)  <a name='4974'>
            SNOWC_mosaic(i,mosaic_i,j)=SNOWC(i,j) <a name='4975'>
<a name='4976'>
            ALBEDO_mosaic(i,mosaic_i,j)=ALBEDO(i,j)<a name='4977'>
            ALBBCK_mosaic(i,mosaic_i,j)=ALBBCK(i,j)<a name='4978'>
            EMISS_mosaic(i,mosaic_i,j)=EMISS(i,j) <a name='4979'>
            EMBCK_mosaic(i,mosaic_i,j)=EMBCK(i,j) <a name='4980'>
            ZNT_mosaic(i,mosaic_i,j)=Z0(i,j)<a name='4981'>
            Z0_mosaic(i,mosaic_i,j)=Z0(i,j)              <a name='4982'>
  <a name='4983'>
              DO soil_k=1,num_soil_layers <a name='4984'>
  <a name='4985'>
            TSLB_mosaic(i,num_soil_layers*(mosaic_i-1)+soil_k,j)=TSLB(i,soil_k,j)<a name='4986'>
            SMOIS_mosaic(i,num_soil_layers*(mosaic_i-1)+soil_k,j)=SMOIS(i,soil_k,j)<a name='4987'>
            SH2O_mosaic(i,num_soil_layers*(mosaic_i-1)+soil_k,j)=SH2O(i,soil_k,j)  <a name='4988'>
          <a name='4989'>
              ENDDO<a name='4990'>
           <a name='4991'>
           TR_URB2D_mosaic(i,mosaic_i,j)=TSK(i,j)   <a name='4992'>
           TB_URB2D_mosaic(i,mosaic_i,j)=TSK(i,j)   <a name='4993'>
           TG_URB2D_mosaic(i,mosaic_i,j)=TSK(i,j)   <a name='4994'>
           TC_URB2D_mosaic(i,mosaic_i,j)=TSK(i,j)   <a name='4995'>
           TS_URB2D_mosaic(i,mosaic_i,j)=TSK(i,j)   <a name='4996'>
           TS_RUL2D_mosaic(i,mosaic_i,j)=TSK(i,j)   <a name='4997'>
           QC_URB2D_mosaic(i,mosaic_i,j)=0.01<a name='4998'>
           SH_URB2D_mosaic(i,mosaic_i,j)=0<a name='4999'>
           LH_URB2D_mosaic(i,mosaic_i,j)=0<a name='5000'>
           G_URB2D_mosaic(i,mosaic_i,j)=0<a name='5001'>
           RN_URB2D_mosaic(i,mosaic_i,j)=0<a name='5002'>
          <a name='5003'>
          TRL_URB3D_mosaic(I,4*(mosaic_i-1)+1,J)=TSLB(I,1,J)+0.<a name='5004'>
          TRL_URB3D_mosaic(I,4*(mosaic_i-1)+2,J)=0.5*(TSLB(I,1,J)+TSLB(I,2,J))<a name='5005'>
          TRL_URB3D_mosaic(I,4*(mosaic_i-1)+3,J)=TSLB(I,2,J)+0.<a name='5006'>
          TRL_URB3D_mosaic(I,4*(mosaic_i-1)+4,J)=TSLB(I,2,J)+(TSLB(I,3,J)-TSLB(I,2,J))*0.29<a name='5007'>
<a name='5008'>
          TBL_URB3D_mosaic(I,4*(mosaic_i-1)+1,J)=TSLB(I,1,J)+0.<a name='5009'>
          TBL_URB3D_mosaic(I,4*(mosaic_i-1)+2,J)=0.5*(TSLB(I,1,J)+TSLB(I,2,J))<a name='5010'>
          TBL_URB3D_mosaic(I,4*(mosaic_i-1)+3,J)=TSLB(I,2,J)+0.<a name='5011'>
          TBL_URB3D_mosaic(I,4*(mosaic_i-1)+4,J)=TSLB(I,2,J)+(TSLB(I,3,J)-TSLB(I,2,J))*0.29           <a name='5012'>
                    <a name='5013'>
          TGL_URB3D_mosaic(I,4*(mosaic_i-1)+1,J)=TSLB(I,1,J)<a name='5014'>
          TGL_URB3D_mosaic(I,4*(mosaic_i-1)+2,J)=TSLB(I,2,J)<a name='5015'>
          TGL_URB3D_mosaic(I,4*(mosaic_i-1)+3,J)=TSLB(I,3,J)<a name='5016'>
          TGL_URB3D_mosaic(I,4*(mosaic_i-1)+4,J)=TSLB(I,4,J)<a name='5017'>
           <a name='5018'>
            ENDDO<a name='5019'>
          ENDDO<a name='5020'>
      ENDDO<a name='5021'>
<a name='5022'>
   <font color=#447700>! simple test<a name='5023'></font>
   <a name='5024'>
       DO i = its,itf<a name='5025'>
        DO j = jts,jtf <a name='5026'>
   <a name='5027'>
           IF ((xland(i,j).LT. 1.5 ) .AND. (mosaic_cat_index(I,1,J) .EQ. ISWATER)) THEN<a name='5028'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_944">("After MOSAIC_INIT")<a name='5029'>
             WRITE (message_text,fmt='(a,2I6,2F8.2,2I6)') 'weird xland,xice,mosaic_cat_index and ivgtyp at I,J = ', &amp;<a name='5030'>
                i,j,xland(i,j),xice(i,j),mosaic_cat_index(I,1,J),IVGTYP(i,j)<a name='5031'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_945">(message_text)<a name='5032'>
           ENDIF<a name='5033'>
           <a name='5034'>
        ENDDO<a name='5035'>
      ENDDO<a name='5036'>
      <a name='5037'>
 ENDIF      <font color=#447700>!  for not restart<a name='5038'></font>
      <a name='5039'>
<font color=#447700>!--------------------------------      <a name='5040'></font>
  END SUBROUTINE lsm_mosaic_init  <a name='5041'>
<font color=#447700>!--------------------------------  <a name='5042'></font>
<a name='5043'>
END MODULE module_sf_noahdrv<a name='5044'>
</pre></body></html>