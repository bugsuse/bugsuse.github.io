<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_NOAH_SEAICE'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#MODULE_SF_NOAH_SEAICE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_noah_seaice</font> <A href='../../call_to/MODULE_SF_NOAH_SEAICE.html' TARGET='index'>1</A><a name='3'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#module_sf_noah_seaice.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_95">, only : CP, R_D, XLF, XLV, RHOWATER, STBOLT<a name='4'>
  use <A href='../../html_code/phys/module_sf_noahlsm.F.html#MODULE_SF_NOAHLSM'>module_sf_noahlsm</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#module_sf_noah_seaice.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHLSM_3">, only : RD, SIGMA, CPH2O, CPICE, LSUBF, EMISSI_S, &amp;<a name='5'>
       &amp;                        HSTEP<a name='6'>
<a name='7'>
  PUBLIC  SFLX_SEAICE<a name='8'>
  PRIVATE CSNOW<a name='9'>
  PRIVATE HRTICE<a name='10'>
  PRIVATE PENMAN<a name='11'>
  PRIVATE SHFLX<a name='12'>
  PRIVATE SNOPAC<a name='13'>
  PRIVATE SNOWPACK<a name='14'>
  PRIVATE SNOWZ0<a name='15'>
  PRIVATE SNOW_NEW<a name='16'>
<a name='17'>
  INTEGER, PRIVATE :: ILOC<a name='18'>
  INTEGER, PRIVATE :: JLOC<a name='19'>
<font color=#447700>!$omp threadprivate(iloc, jloc)<a name='20'></font>
<a name='21'>
  REAL, PARAMETER, PRIVATE :: TFREEZ = 273.15<a name='22'>
<font color=#447700>!<a name='23'></font>
CONTAINS<a name='24'>
<font color=#447700>!<a name='25'></font>
<A NAME='SFLX_SEAICE'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SFLX_SEAICE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='26'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFLX_SEAICE</font> (IILOC, JJLOC, SEAICE_ALBEDO_OPT, SEAICE_ALBEDO_DEFAULT, &amp;    <font color=#447700>!C <A href='../../call_to/SFLX_SEAICE.html' TARGET='index'>1</A>,<A href='../../call_from/SFLX_SEAICE.html' TARGET='index'>7</A><a name='27'></font>
       &amp;                  SEAICE_SNOWDEPTH_OPT, SEAICE_SNOWDEPTH_MAX,      &amp;    <font color=#447700>!C<a name='28'></font>
       &amp;                  SEAICE_SNOWDEPTH_MIN,                            &amp;    <font color=#447700>!C<a name='29'></font>
       &amp;                  FFROZP,DT,ZLVL,NSOIL,                            &amp;    <font color=#447700>!C<a name='30'></font>
       &amp;                  SITHICK,                                         &amp;<a name='31'>
       &amp;                  LWDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2,               &amp;    <font color=#447700>!F<a name='32'></font>
       &amp;                  TH2,Q2SAT,DQSDT2,                                &amp;    <font color=#447700>!I<a name='33'></font>
       &amp;                  SNOALB,TBOT, Z0BRD, Z0, EMISSI,                  &amp;    <font color=#447700>!S<a name='34'></font>
       &amp;                  T1,STC,SNOWH,SNEQV,ALBEDO, CH,                   &amp;    <font color=#447700>!H<a name='35'></font>
       &amp;                  ALBEDOSI, SNOWONSI,                              &amp;<a name='36'>
       &amp;                  ETA,SHEAT,ETA_KINEMATIC,FDOWN,                   &amp;    <font color=#447700>!O<a name='37'></font>
       &amp;                  ESNOW,DEW,ETP,SSOIL,FLX1,FLX2,FLX3,              &amp;    <font color=#447700>!O<a name='38'></font>
       &amp;                  SNOMLT,SNCOVR,                                   &amp;    <font color=#447700>!O<a name='39'></font>
       &amp;                  RUNOFF1,Q1,RIBB)<a name='40'>
<a name='41'>
<font color=#447700>! ----------------------------------------------------------------------<a name='42'></font>
<font color=#447700>! SUBROUTINE SFLX_SEAICE<a name='43'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='44'></font>
<font color=#447700>! SUB-DRIVER FOR "Noah LSM" FAMILY OF PHYSICS SUBROUTINES FOR A SEA-ICE<a name='45'></font>
<font color=#447700>! LAND-SURFACE MODEL TO UPDATE ICE TEMPERATURE, SKIN TEMPERATURE,<a name='46'></font>
<font color=#447700>! SNOWPACK WATER CONTENT, SNOWDEPTH, AND ALL TERMS OF THE SURFACE ENERGY<a name='47'></font>
<font color=#447700>! BALANCE (EXCLUDING INPUT ATMOSPHERIC FORCINGS OF DOWNWARD RADIATION<a name='48'></font>
<font color=#447700>! AND PRECIP)<a name='49'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='50'></font>
<font color=#447700>! SFLX_SEAICE ARGUMENT LIST KEY:<a name='51'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='52'></font>
<font color=#447700>!  C  CONFIGURATION INFORMATION<a name='53'></font>
<font color=#447700>!  F  FORCING DATA<a name='54'></font>
<font color=#447700>!  I  OTHER (INPUT) FORCING DATA<a name='55'></font>
<font color=#447700>!  S  SURFACE CHARACTERISTICS<a name='56'></font>
<font color=#447700>!  H  HISTORY (STATE) VARIABLES<a name='57'></font>
<font color=#447700>!  O  OUTPUT VARIABLES<a name='58'></font>
<font color=#447700>!  D  DIAGNOSTIC OUTPUT<a name='59'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='60'></font>
<font color=#447700>! 1. CONFIGURATION INFORMATION (C):<a name='61'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='62'></font>
<font color=#447700>!   DT         TIMESTEP (SEC) (DT SHOULD NOT EXCEED 3600 SECS, RECOMMEND<a name='63'></font>
<font color=#447700>!                1800 SECS OR LESS)<a name='64'></font>
<font color=#447700>!   ZLVL       HEIGHT (M) ABOVE GROUND OF ATMOSPHERIC FORCING VARIABLES<a name='65'></font>
<font color=#447700>!   NSOIL      NUMBER OF SOIL LAYERS (AT LEAST 2, AND NOT GREATER THAN<a name='66'></font>
<font color=#447700>!                PARAMETER NSOLD SET BELOW)<a name='67'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='68'></font>
<font color=#447700>! 3. FORCING DATA (F):<a name='69'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='70'></font>
<font color=#447700>!   LWDN       LW DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET LONGWAVE)<a name='71'></font>
<font color=#447700>!   SOLNET     NET DOWNWARD SOLAR RADIATION ((W M-2; POSITIVE)<a name='72'></font>
<font color=#447700>!   SFCPRS     PRESSURE AT HEIGHT ZLVL ABOVE GROUND (PASCALS)<a name='73'></font>
<font color=#447700>!   PRCP       PRECIP RATE (KG M-2 S-1) (NOTE, THIS IS A RATE)<a name='74'></font>
<font color=#447700>!   SFCTMP     AIR TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND<a name='75'></font>
<font color=#447700>!   TH2        AIR POTENTIAL TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND<a name='76'></font>
<font color=#447700>!   Q2         MIXING RATIO AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)<a name='77'></font>
<font color=#447700>!   FFROZP     FRACTION OF FROZEN PRECIPITATION<a name='78'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='79'></font>
<font color=#447700>! 4. OTHER FORCING (INPUT) DATA (I):<a name='80'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='81'></font>
<font color=#447700>!   Q2SAT      SAT SPECIFIC HUMIDITY AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)<a name='82'></font>
<font color=#447700>!   DQSDT2     SLOPE OF SAT SPECIFIC HUMIDITY CURVE AT T=SFCTMP<a name='83'></font>
<font color=#447700>!                (KG KG-1 K-1)<a name='84'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='85'></font>
<font color=#447700>! 5. CANOPY/SOIL CHARACTERISTICS (S):<a name='86'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='87'></font>
<font color=#447700>!   SNOALB     UPPER BOUND ON MAXIMUM ALBEDO OVER DEEP SNOW (E.G. FROM<a name='88'></font>
<font color=#447700>!                ROBINSON AND KUKLA, 1985, J. CLIM. &amp; APPL. METEOR.)<a name='89'></font>
<font color=#447700>!   TBOT       BOTTOM SOIL TEMPERATURE (LOCAL YEARLY-MEAN SFC AIR<a name='90'></font>
<font color=#447700>!                TEMPERATURE)<a name='91'></font>
<font color=#447700>!   Z0BRD      Background fixed roughness length (M)<a name='92'></font>
<font color=#447700>!   Z0         Time varying roughness length (M) as function of snow depth<a name='93'></font>
<font color=#447700>!<a name='94'></font>
<font color=#447700>!   EMISSI     Surface emissivity (between 0 and 1)<a name='95'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='96'></font>
<font color=#447700>! 6. HISTORY (STATE) VARIABLES (H):<a name='97'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='98'></font>
<font color=#447700>!  T1          GROUND/CANOPY/SNOWPACK) EFFECTIVE SKIN TEMPERATURE (K)<a name='99'></font>
<font color=#447700>!  STC(NSOIL)  SOIL TEMP (K)<a name='100'></font>
<font color=#447700>!  SNOWH       ACTUAL SNOW DEPTH (M)<a name='101'></font>
<font color=#447700>!  SNEQV       LIQUID WATER-EQUIVALENT SNOW DEPTH (M)<a name='102'></font>
<font color=#447700>!                NOTE: SNOW DENSITY = SNEQV/SNOWH<a name='103'></font>
<font color=#447700>!  ALBEDO      SURFACE ALBEDO<a name='104'></font>
<font color=#447700>!  CH          SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE<a name='105'></font>
<font color=#447700>!                (M S-1); NOTE: CH IS TECHNICALLY A CONDUCTANCE SINCE<a name='106'></font>
<font color=#447700>!                IT HAS BEEN MULTIPLIED BY WIND SPEED.<a name='107'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='108'></font>
<font color=#447700>! 7. OUTPUT (O):<a name='109'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='110'></font>
<font color=#447700>! OUTPUT VARIABLES NECESSARY FOR A COUPLED NWP MODEL.  FOR THIS APPLICATION,<a name='111'></font>
<font color=#447700>! THE REMAINING OUTPUT/DIAGNOSTIC/PARAMETER BLOCKS BELOW ARE NOT<a name='112'></font>
<font color=#447700>! NECESSARY.  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.<a name='113'></font>
<font color=#447700>!   ETA        ACTUAL LATENT HEAT FLUX (W m-2: NEGATIVE, IF UP FROM<a name='114'></font>
<font color=#447700>!              SURFACE)<a name='115'></font>
<font color=#447700>!  ETA_KINEMATIC actual latent heat flux in Kg m-2 s-1<a name='116'></font>
<font color=#447700>!   SHEAT      SENSIBLE HEAT FLUX (W M-2: NEGATIVE, IF UPWARD FROM<a name='117'></font>
<font color=#447700>!              SURFACE)<a name='118'></font>
<font color=#447700>!   FDOWN      Radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN<a name='119'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='120'></font>
<font color=#447700>!   ESNOW      SUBLIMATION FROM (OR DEPOSITION TO IF &lt;0) SNOWPACK (W m-2)<a name='121'></font>
<font color=#447700>!   DEW        DEWFALL (OR FROSTFALL FOR T&lt;273.15) (M)<a name='122'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='123'></font>
<font color=#447700>!   ETP        POTENTIAL EVAPORATION (W m-2)<a name='124'></font>
<font color=#447700>!   SSOIL      SOIL HEAT FLUX (W M-2: NEGATIVE IF DOWNWARD FROM SURFACE)<a name='125'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='126'></font>
<font color=#447700>!   FLX1       PRECIP-SNOW SFC (W M-2)<a name='127'></font>
<font color=#447700>!   FLX2       FREEZING RAIN LATENT HEAT FLUX (W M-2)<a name='128'></font>
<font color=#447700>!   FLX3       PHASE-CHANGE HEAT FLUX FROM SNOWMELT (W M-2)<a name='129'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='130'></font>
<font color=#447700>!   SNOMLT     SNOW MELT (M) (WATER EQUIVALENT)<a name='131'></font>
<font color=#447700>!   SNCOVR     FRACTIONAL SNOW COVER (UNITLESS FRACTION, 0-1)<a name='132'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='133'></font>
<font color=#447700>!   RUNOFF1    SURFACE RUNOFF (M S-1), NOT INFILTRATING THE SURFACE<a name='134'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='135'></font>
<font color=#447700>! 8. DIAGNOSTIC OUTPUT (D):<a name='136'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='137'></font>
<font color=#447700>!   Q1         Effective mixing ratio at surface (kg kg-1), used for<a name='138'></font>
<font color=#447700>!              diagnosing the mixing ratio at 2 meter for coupled model<a name='139'></font>
<font color=#447700>!  Documentation SNOABL2 ?????<a name='140'></font>
<font color=#447700>!  What categories of arguments do these variables fall into ????<a name='141'></font>
<font color=#447700>!  Documentation for RIBB ?????<a name='142'></font>
<font color=#447700>!  What category of argument does RIBB fall into ?????<a name='143'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='144'></font>
      IMPLICIT NONE<a name='145'>
<font color=#447700>! ----------------------------------------------------------------------<a name='146'></font>
      integer, intent(in) :: iiloc, jjloc<a name='147'>
      INTEGER, INTENT(IN) :: SEAICE_ALBEDO_OPT<a name='148'>
      REAL,    INTENT(IN) :: SEAICE_ALBEDO_DEFAULT<a name='149'>
      INTEGER, INTENT(IN) :: SEAICE_SNOWDEPTH_OPT<a name='150'>
      REAL,    INTENT(IN) :: SEAICE_SNOWDEPTH_MAX<a name='151'>
      REAL,    INTENT(IN) :: SEAICE_SNOWDEPTH_MIN<a name='152'>
<a name='153'>
      LOGICAL            ::  FRZGRA, SNOWNG<a name='154'>
<a name='155'>
      INTEGER,INTENT(IN) ::  NSOIL<a name='156'>
<a name='157'>
      REAL, INTENT(IN)   :: DT,DQSDT2,LWDN,PRCP,                   &amp;<a name='158'>
                            Q2,Q2SAT,SFCPRS,SFCTMP,SNOALB,ALBEDOSI,          &amp;<a name='159'>
                            SOLNET,TBOT,TH2,ZLVL,                            &amp;<a name='160'>
                            FFROZP<a name='161'>
      REAL, INTENT(OUT)  :: ALBEDO<a name='162'>
      REAL, INTENT(INOUT):: CH,                         &amp;<a name='163'>
                            SNEQV,SNCOVR,SNOWH,T1,Z0BRD,                    &amp;<a name='164'>
                            EMISSI<a name='165'>
      REAL, INTENT(IN)   :: SNOWONSI<a name='166'>
      REAL, INTENT(IN)   :: SITHICK<a name='167'>
      REAL, INTENT(INOUT):: RIBB<a name='168'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) ::  STC<a name='169'>
      REAL,DIMENSION(1:NSOIL)::   ZSOIL<a name='170'>
<a name='171'>
      REAL,INTENT(OUT)   :: ETA_KINEMATIC,DEW,ESNOW,ETA,                    &amp;<a name='172'>
                            ETP,FLX1,FLX2,FLX3,SHEAT,RUNOFF1,               &amp;<a name='173'>
                            SSOIL,                                          &amp;<a name='174'>
                            SNOMLT,                                         &amp;<a name='175'>
                            FDOWN,Q1,Z0<a name='176'>
      REAL :: DF1,DF1A,                                                     &amp;<a name='177'>
              DSOIL,DTOT,FRCSNO,FRCSOI,                                     &amp;<a name='178'>
              RCH,RR,                                                       &amp;<a name='179'>
              SNDENS,SNCOND,SN_NEW,                                         &amp;<a name='180'>
              T24,T2V,TH2V,TSNOW<a name='181'>
<a name='182'>
      REAL :: RHO<a name='183'>
      INTEGER  :: KZ, K<a name='184'>
<a name='185'>
      REAL :: ALB_SNOW<a name='186'>
      REAL :: ALB_ICE<a name='187'>
      REAL :: Z0N<a name='188'>
      REAL :: SNCOVRR<a name='189'>
<a name='190'>
<font color=#447700>! ----------------------------------------------------------------------<a name='191'></font>
<font color=#447700>! DECLARATIONS - PARAMETERS<a name='192'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='193'></font>
<a name='194'>
      REAL, PARAMETER :: LVH2O = 2.501E+6<a name='195'>
      REAL, PARAMETER :: LSUBS = 2.83E+6<a name='196'>
      REAL, PARAMETER :: R = 287.04<a name='197'>
<a name='198'>
      iloc = iiloc<a name='199'>
      jloc = jjloc<a name='200'>
<font color=#447700>! ----------------------------------------------------------------------<a name='201'></font>
<font color=#447700>!   INITIALIZATION<a name='202'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='203'></font>
<a name='204'>
      RUNOFF1 = 0.0<a name='205'>
      SNOMLT = 0.0<a name='206'>
<a name='207'>
<font color=#447700>! ----------------------------------------------------------------------<a name='208'></font>
<font color=#447700>! SEA-ICE LAYERS ARE EQUAL THICKNESS AND SUM TO &lt;SITHICK&gt; METERS<a name='209'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='210'></font>
<a name='211'>
      DO KZ = 1,NSOIL<a name='212'>
         ZSOIL (KZ) = -SITHICK * FLOAT (KZ) / FLOAT (NSOIL)<a name='213'>
      END DO<a name='214'>
<a name='215'>
<font color=#447700>! ----------------------------------------------------------------------<a name='216'></font>
<a name='217'>
      Z0BRD = 0.001 <a name='218'>
<font color=#447700>!      ALB = 0.82  ! Arctic pre-melt spring and post-melt autumn<a name='219'></font>
<font color=#447700>!      ALB = 0.80  ! Antarctica<a name='220'></font>
<font color=#447700>!      ALB = 0.50  ! Arctic mid-summer (ice and melt ponds)<a name='221'></font>
<font color=#447700>!      ALB = 0.65  ! Arctic bare ice with no snow and no melt ponds<a name='222'></font>
<a name='223'>
<font color=#447700>! ----------------------------------------------------------------------<a name='224'></font>
<font color=#447700>!  INITIALIZE PRECIPITATION LOGICALS.<a name='225'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='226'></font>
<a name='227'>
      SNOWNG = .FALSE.<a name='228'>
      FRZGRA = .FALSE.<a name='229'>
<a name='230'>
<font color=#447700>! ----------------------------------------------------------------------<a name='231'></font>
<font color=#447700>! OVER SEA-ICE, IF S.W.E. (SNEQV) BELOW THRESHOLD LOWER<a name='232'></font>
<font color=#447700>! BOUND (0.01 M FOR SEA-ICE, 0.10 M FOR GLACIAL-ICE), THEN SET AT LOWER<a name='233'></font>
<font color=#447700>! BOUND<a name='234'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='235'></font>
<font color=#447700>! FOR SEA-ICE CASE, ASSIGN DEFAULT WATER-EQUIV SNOW ON TOP<a name='236'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='237'></font>
<a name='238'>
      SELECT CASE ( SEAICE_ALBEDO_OPT )<a name='239'>
<a name='240'>
      CASE DEFAULT<a name='241'>
<a name='242'>
         IF ( SNEQV &lt; 0.01 ) THEN<a name='243'>
            SNEQV = 0.01<a name='244'>
            SNOWH = 0.05<a name='245'>
         ENDIF<a name='246'>
<a name='247'>
      CASE ( 1 ) <font color=#447700>! Arctic sea-ice albedo from Mills (2011)<a name='248'></font>
<a name='249'>
         IF ( SNEQV &lt; 0.0001 ) THEN<a name='250'>
            SNEQV = 0.0001<a name='251'>
            SNOWH = 0.0005<a name='252'>
         ENDIF<a name='253'>
<a name='254'>
      END SELECT<a name='255'>
<a name='256'>
<a name='257'>
      IF ( SEAICE_SNOWDEPTH_OPT == 0 ) THEN<a name='258'>
<a name='259'>
          <font color=#447700>!<a name='260'></font>
          <font color=#447700>! Enforce bounds on snow depth, maintaining original snow density.<a name='261'></font>
          <font color=#447700>!<a name='262'></font>
<a name='263'>
          SNDENS = SNEQV / SNOWH<a name='264'>
          SNOWH = MAX ( SEAICE_SNOWDEPTH_MIN , MIN ( SNOWH , SEAICE_SNOWDEPTH_MAX ) )<a name='265'>
          SNEQV = SNOWH * SNDENS <a name='266'>
<a name='267'>
      ELSEIF ( SEAICE_SNOWDEPTH_OPT == 1 ) THEN<a name='268'>
<a name='269'>
          <font color=#447700>!<a name='270'></font>
          <font color=#447700>! Regardless of the assignments above, we want to enforce<a name='271'></font>
          <font color=#447700>! a specified snow depth and density on sea ice.<a name='272'></font>
          <font color=#447700>!<a name='273'></font>
<a name='274'>
          SNDENS = 0.3<a name='275'>
          SNOWH = SNOWONSI<a name='276'>
          SNEQV = SNOWH * SNDENS<a name='277'>
      ENDIF<a name='278'>
<a name='279'>
<font color=#447700>! ----------------------------------------------------------------------<a name='280'></font>
<font color=#447700>! IF INPUT SNOWPACK IS NONZERO, THEN COMPUTE SNOW DENSITY "SNDENS" AND<a name='281'></font>
<font color=#447700>! SNOW THERMAL CONDUCTIVITY "SNCOND"<a name='282'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='283'></font>
<a name='284'>
      SNDENS = SNEQV / SNOWH<a name='285'>
      IF(SNDENS &gt; 1.0) THEN<a name='286'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SFLX_SEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1149"> ( 'Physical snow depth is less than snow water equiv.' )<a name='287'>
      ENDIF<a name='288'>
      CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SFLX_SEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_1"> (SNCOND,SNDENS)<a name='289'>
<a name='290'>
<font color=#447700>! ----------------------------------------------------------------------<a name='291'></font>
<font color=#447700>! DETERMINE IF IT'S PRECIPITATING AND WHAT KIND OF PRECIP IT IS.<a name='292'></font>
<font color=#447700>! IF IT'S PRCPING AND THE AIR TEMP IS COLDER THAN 0 C, IT'S SNOWING!<a name='293'></font>
<font color=#447700>! IF IT'S PRCPING AND THE AIR TEMP IS WARMER THAN 0 C, BUT THE GRND<a name='294'></font>
<font color=#447700>! TEMP IS COLDER THAN 0 C, FREEZING RAIN IS PRESUMED TO BE FALLING.<a name='295'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='296'></font>
<a name='297'>
      IF (PRCP &gt; 0.0) THEN<a name='298'>
<font color=#447700>! snow defined when fraction of frozen precip (FFROZP) &gt; 0.5,<a name='299'></font>
<font color=#447700>! passed in from model microphysics.<a name='300'></font>
         IF (FFROZP .GT. 0.5) THEN<a name='301'>
            SNOWNG = .TRUE.<a name='302'>
         ELSE<a name='303'>
            IF (T1 &lt;= TFREEZ) FRZGRA = .TRUE.<a name='304'>
         END IF<a name='305'>
      END IF<a name='306'>
<a name='307'>
<font color=#447700>! ----------------------------------------------------------------------<a name='308'></font>
<font color=#447700>! IF EITHER PRCP FLAG IS SET, DETERMINE NEW SNOWFALL (CONVERTING PRCP<a name='309'></font>
<font color=#447700>! RATE FROM KG M-2 S-1 TO A LIQUID EQUIV SNOW DEPTH IN METERS) AND ADD<a name='310'></font>
<font color=#447700>! IT TO THE EXISTING SNOWPACK.<a name='311'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='312'></font>
<a name='313'>
      IF ( SNOWNG .OR. FRZGRA ) THEN<a name='314'>
         SN_NEW = PRCP * DT * 0.001<a name='315'>
         SNEQV = SNEQV + SN_NEW<a name='316'>
<a name='317'>
<font color=#447700>! ----------------------------------------------------------------------<a name='318'></font>
<font color=#447700>! UPDATE SNOW DENSITY BASED ON NEW SNOWFALL, USING OLD AND NEW SNOW.<a name='319'></font>
<font color=#447700>! UPDATE SNOW THERMAL CONDUCTIVITY<a name='320'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='321'></font>
<a name='322'>
         CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOW_NEW'>SNOW_NEW</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SFLX_SEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_NEW_1"> ( SFCTMP , SN_NEW , SNOWH , SNDENS )<a name='323'>
         <font color=#447700>!<a name='324'></font>
         <font color=#447700>! kmh 09/04/2006 set Snow Density at 0.2 g/cm**3<a name='325'></font>
         <font color=#447700>! for "cold permanent ice" or new "dry" snow<a name='326'></font>
         <font color=#447700>!<a name='327'></font>
         IF ( SNCOVR .GT. 0.99 ) THEN<a name='328'>
            <font color=#447700>!<a name='329'></font>
            <font color=#447700>!  if soil temperature less than 268.15 K, treat as typical <a name='330'></font>
            <font color=#447700>!  Antarctic/Greenland snow firn<a name='331'></font>
            <font color=#447700>!<a name='332'></font>
            IF ( STC(1) .LT. (TFREEZ - 5.) ) SNDENS = 0.2<a name='333'>
            IF ( SNOWNG .AND. (T1.LT.273.) .AND. (SFCTMP.LT.273.) ) SNDENS=0.2<a name='334'>
         ENDIF<a name='335'>
<a name='336'>
         CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SFLX_SEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_2"> (SNCOND,SNDENS)<a name='337'>
<a name='338'>
      END IF<a name='339'>
<a name='340'>
<font color=#447700>! ----------------------------------------------------------------------<a name='341'></font>
<font color=#447700>! ALBEDO OF SEA ICE<a name='342'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='343'></font>
      <a name='344'>
<a name='345'>
      SELECT CASE ( SEAICE_ALBEDO_OPT )<a name='346'>
<a name='347'>
      CASE DEFAULT<a name='348'>
<a name='349'>
         SNCOVR = 1.0<a name='350'>
         EMISSI = 0.98<a name='351'>
         ALBEDO = SEAICE_ALBEDO_DEFAULT<a name='352'>
<font color=#447700>!        ALBEDO = 0.82  ! Arctic pre-melt spring and post-melt autumn<a name='353'></font>
<font color=#447700>!        ALBEDO = 0.80  ! Antarctica<a name='354'></font>
<font color=#447700>!        ALBEDO = 0.50  ! Arctic mid-summer (ice and melt ponds)<a name='355'></font>
<font color=#447700>!        ALBEDO = 0.65  ! Arctic bare ice with no snow and no melt ponds<a name='356'></font>
<a name='357'>
      CASE ( 1 ) <font color=#447700>! Arctic sea-ice albedo from Mills (2011)<a name='358'></font>
<a name='359'>
         <font color=#447700>!<a name='360'></font>
         <font color=#447700>! Make albedo of snow on sea-ice a function of skin temperature:<a name='361'></font>
         <font color=#447700>!<a name='362'></font>
         IF (T1 &lt; 268.15) THEN<a name='363'>
            alb_snow = 0.8<a name='364'>
         ELSEIF ( ( T1 &gt;= 268.15 ) .AND. ( T1 &lt; 273.15 ) ) then<a name='365'>
            alb_snow = 0.65 - ( 0.03 * (T1 - 273.15) )<a name='366'>
         ELSE<a name='367'>
            alb_snow = 0.65<a name='368'>
         ENDIF<a name='369'>
<a name='370'>
         <font color=#447700>!<a name='371'></font>
         <font color=#447700>! Make albedo of snow-free sea-ice a function of air temperature<a name='372'></font>
         <font color=#447700>!<a name='373'></font>
         IF ( SFCTMP &lt;= 273.15 ) THEN<a name='374'>
            alb_ice = 0.65<a name='375'>
         ELSEIF ( ( SFCTMP &gt; 273.15 ) .and. ( SFCTMP &lt; 278.15 ) ) THEN<a name='376'>
            alb_ice = 0.65 - ( 0.04 * (SFCTMP - 273.15) )<a name='377'>
         ELSE<a name='378'>
            alb_ice = 0.45<a name='379'>
         ENDIF<a name='380'>
<a name='381'>
         <font color=#447700>!<a name='382'></font>
         <font color=#447700>! Define a snow-cover fraction for use only with Mills sea-ice albedo<a name='383'></font>
         <font color=#447700>!<a name='384'></font>
         Z0N = 0.10 <font color=#447700>! Approximate roughness length of snow-covered surface<a name='385'></font>
         SNCOVRR = SNOWH / ( SNOWH + Z0N )<a name='386'>
<a name='387'>
         <font color=#447700>!<a name='388'></font>
         <font color=#447700>! Final albedo over sea-ice point is a combination of the snow <a name='389'></font>
         <font color=#447700>! albedo and the snow-free ice albedo, weighted by the snow cover.<a name='390'></font>
         <font color=#447700>!<a name='391'></font>
         ALBEDO = (SNCOVRR * alb_snow ) + ( ( 1.0 - SNCOVRR) * alb_ice )<a name='392'>
<a name='393'>
      CASE ( 2 ) <font color=#447700>! Seaice albedo from 2d field<a name='394'></font>
<a name='395'>
         SNCOVR = 1.0<a name='396'>
         EMISSI = 0.98<a name='397'>
         ALBEDO = ALBEDOSI<a name='398'>
<a name='399'>
      END SELECT<a name='400'>
<a name='401'>
<font color=#447700>! ----------------------------------------------------------------------<a name='402'></font>
<font color=#447700>! THERMAL CONDUCTIVITY FOR SEA-ICE CASE<a name='403'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='404'></font>
      DF1 = 2.2<a name='405'>
<a name='406'>
      DSOIL = - (0.5 * ZSOIL (1))<a name='407'>
<a name='408'>
      DTOT = SNOWH + DSOIL<a name='409'>
      FRCSNO = SNOWH / DTOT<a name='410'>
<a name='411'>
<font color=#447700>! 1. HARMONIC MEAN (SERIES FLOW)<a name='412'></font>
<font color=#447700>!        DF1 = (SNCOND*DF1)/(FRCSOI*SNCOND+FRCSNO*DF1)<a name='413'></font>
      FRCSOI = DSOIL / DTOT<a name='414'>
<font color=#447700>! 2. ARITHMETIC MEAN (PARALLEL FLOW)<a name='415'></font>
<font color=#447700>!        DF1 = FRCSNO*SNCOND + FRCSOI*DF1<a name='416'></font>
<a name='417'>
<font color=#447700>! 3. GEOMETRIC MEAN (INTERMEDIATE BETWEEN HARMONIC AND ARITHMETIC MEAN)<a name='418'></font>
<font color=#447700>!        DF1 = (SNCOND**FRCSNO)*(DF1**FRCSOI)<a name='419'></font>
<font color=#447700>! weigh DF by snow fraction<a name='420'></font>
      DF1A = FRCSNO * SNCOND + FRCSOI * DF1<a name='421'>
<a name='422'>
<font color=#447700>! ----------------------------------------------------------------------<a name='423'></font>
<font color=#447700>! CALCULATE SUBSURFACE HEAT FLUX, SSOIL, FROM FINAL THERMAL DIFFUSIVITY<a name='424'></font>
<font color=#447700>! OF SURFACE MEDIUMS, DF1 ABOVE, AND SKIN TEMPERATURE AND TOP<a name='425'></font>
<font color=#447700>! MID-LAYER SOIL TEMPERATURE<a name='426'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='427'></font>
      DF1 = DF1A * SNCOVR + DF1 * ( 1.0 - SNCOVR )<a name='428'>
      <a name='429'>
      SSOIL = DF1 * ( T1 - STC(1) ) / DTOT<a name='430'>
<a name='431'>
<font color=#447700>! ----------------------------------------------------------------------<a name='432'></font>
<font color=#447700>! DETERMINE SURFACE ROUGHNESS OVER SNOWPACK USING SNOW CONDITION FROM<a name='433'></font>
<font color=#447700>! THE PREVIOUS TIMESTEP.<a name='434'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='435'></font>
<a name='436'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWZ0'>SNOWZ0</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SFLX_SEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWZ0_1"> (SNCOVR,Z0,Z0BRD,SNOWH)<a name='437'>
<a name='438'>
<font color=#447700>! ----------------------------------------------------------------------<a name='439'></font>
<font color=#447700>! CALCULATE TOTAL DOWNWARD RADIATION (SOLAR PLUS LONGWAVE) NEEDED IN<a name='440'></font>
<font color=#447700>! PENMAN EP SUBROUTINE THAT FOLLOWS<a name='441'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='442'></font>
      FDOWN =  SOLNET + LWDN<a name='443'>
<font color=#447700>! ----------------------------------------------------------------------<a name='444'></font>
<font color=#447700>! CALC VIRTUAL TEMPS AND VIRTUAL POTENTIAL TEMPS NEEDED BY SUBROUTINES<a name='445'></font>
<font color=#447700>! PENMAN.<a name='446'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='447'></font>
      T2V = SFCTMP * (1.0+ 0.61 * Q2 )<a name='448'>
      T24 = SFCTMP * SFCTMP * SFCTMP * SFCTMP<a name='449'>
      RHO = SFCPRS / ( RD * T2V )<a name='450'>
      <font color=#447700>! RCH = RHO * CP * CH<a name='451'></font>
      RCH = RHO * 1004.6 * CH  <font color=#447700>! CP is defined different in subroutine PENMAN.<a name='452'></font>
                               <font color=#447700>! Pulling this computation out of PENMAN changed<a name='453'></font>
                               <font color=#447700>! the results.  So I'm hard-coding the PENMAN<a name='454'></font>
                               <font color=#447700>! value here, but perhaps this should go back<a name='455'></font>
                               <font color=#447700>! into PENMAN for now.<a name='456'></font>
<a name='457'>
<font color=#447700>! ----------------------------------------------------------------------<a name='458'></font>
<font color=#447700>! CALL PENMAN SUBROUTINE TO CALCULATE POTENTIAL EVAPORATION (ETP), AND<a name='459'></font>
<font color=#447700>! OTHER PARTIAL PRODUCTS AND SUMS FOR LATER CALCULATIONS.<a name='460'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='461'></font>
<a name='462'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#PENMAN'>PENMAN</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SFLX_SEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PENMAN_1"> (SFCTMP,SFCPRS,CH,TH2,PRCP,FDOWN,T24,SSOIL,     &amp;<a name='463'>
           Q2,Q2SAT,ETP,RCH,RR,SNOWNG,FRZGRA,                     &amp;<a name='464'>
           DQSDT2,FLX2,EMISSI,T1)<a name='465'>
<a name='466'>
      ESNOW = 0.0<a name='467'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC'>SNOPAC</A><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SFLX_SEAICE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOPAC_1"> (ETP,ETA,PRCP,SNOWNG,                    &amp;<a name='468'>
           NSOIL,DT,DF1,                                   &amp;<a name='469'>
           Q2,T1,SFCTMP,T24,TH2,FDOWN,SSOIL,STC,           &amp;<a name='470'>
           SFCPRS,RCH,RR,SNCOVR,SNEQV,SNDENS,              &amp;<a name='471'>
           SNOWH,ZSOIL,TBOT,                               &amp;<a name='472'>
           SNOMLT,DEW,FLX1,FLX2,FLX3,ESNOW,EMISSI,RIBB,    &amp;<a name='473'>
           SEAICE_ALBEDO_OPT)<a name='474'>
<font color=#447700>!     ETA_KINEMATIC =  ESNOW<a name='475'></font>
      ETA_KINEMATIC =  ETP<a name='476'>
<a name='477'>
      IF ( SEAICE_SNOWDEPTH_OPT == 0 ) THEN<a name='478'>
<a name='479'>
          <font color=#447700>!<a name='480'></font>
          <font color=#447700>! Set bounds on snow depth, maintaining snow density.<a name='481'></font>
          <font color=#447700>!<a name='482'></font>
          SNDENS = SNEQV / SNOWH<a name='483'>
          SNOWH = MAX ( SEAICE_SNOWDEPTH_MIN , MIN ( SNOWH , SEAICE_SNOWDEPTH_MAX ) )<a name='484'>
          SNEQV = SNOWH * SNDENS <a name='485'>
<a name='486'>
      ELSEIF ( SEAICE_SNOWDEPTH_OPT == 1 ) THEN<a name='487'>
<a name='488'>
          <font color=#447700>!<a name='489'></font>
          <font color=#447700>! Regardless of the results of snopac, we want to enforce<a name='490'></font>
          <font color=#447700>! a specified snow depth and density on sea ice.<a name='491'></font>
          <font color=#447700>!<a name='492'></font>
          SNDENS = 0.3<a name='493'>
          SNOWH = SNOWONSI<a name='494'>
          SNEQV = SNOWH * SNDENS<a name='495'>
      ENDIF<a name='496'>
<a name='497'>
<font color=#447700>!     Calculate effective mixing ratio at ground level (skin)<a name='498'></font>
      Q1=Q2+ETA_KINEMATIC*CP/RCH<a name='499'>
<font color=#447700>!<a name='500'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='501'></font>
<font color=#447700>! DETERMINE SENSIBLE HEAT (H) IN ENERGY UNITS (W M-2)<a name='502'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='503'></font>
<a name='504'>
      SHEAT = - (CH * CP * SFCPRS)/ (R * T2V) * ( TH2- T1 )<a name='505'>
<a name='506'>
<font color=#447700>! ----------------------------------------------------------------------<a name='507'></font>
<font color=#447700>! CONVERT EVAP TERMS FROM KINEMATIC (KG M-2 S-1) TO ENERGY UNITS (W M-2)<a name='508'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='509'></font>
<a name='510'>
      ESNOW = ESNOW * LSUBS<a name='511'>
      ETP = ETP*((1.-SNCOVR)*LVH2O + SNCOVR*LSUBS)<a name='512'>
      IF (ETP .GT. 0.) THEN<a name='513'>
         ETA = ESNOW<a name='514'>
      ELSE<a name='515'>
         ETA = ETP<a name='516'>
      ENDIF<a name='517'>
<a name='518'>
<font color=#447700>! ----------------------------------------------------------------------<a name='519'></font>
<font color=#447700>! CONVERT THE SIGN OF SOIL HEAT FLUX SO THAT:<a name='520'></font>
<font color=#447700>!   SSOIL&gt;0: WARM THE SURFACE  (NIGHT TIME)<a name='521'></font>
<font color=#447700>!   SSOIL&lt;0: COOL THE SURFACE  (DAY TIME)<a name='522'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='523'></font>
<a name='524'>
      SSOIL = -1.0* SSOIL<a name='525'>
<a name='526'>
<font color=#447700>! ----------------------------------------------------------------------<a name='527'></font>
<font color=#447700>! FOR THE CASE OF SEA-ICE, ADD ANY<a name='528'></font>
<font color=#447700>! SNOWMELT DIRECTLY TO SURFACE RUNOFF (RUNOFF1) SINCE THERE IS NO<a name='529'></font>
<font color=#447700>! SOIL MEDIUM, AND THUS NO CALL TO SUBROUTINE SMFLX (FOR SOIL MOISTURE<a name='530'></font>
<font color=#447700>! TENDENCY).<a name='531'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='532'></font>
      RUNOFF1 = SNOMLT/DT<a name='533'>
<a name='534'>
<font color=#447700>! ----------------------------------------------------------------------<a name='535'></font>
    END SUBROUTINE SFLX_SEAICE<a name='536'>
<font color=#447700>! ----------------------------------------------------------------------<a name='537'></font>
<a name='538'>
<A NAME='CSNOW'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#CSNOW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='539'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CSNOW</font> (SNCOND,DSNOW) <A href='../../call_to/CSNOW.html' TARGET='index'>7</A><a name='540'>
<a name='541'>
<font color=#447700>! ----------------------------------------------------------------------<a name='542'></font>
<font color=#447700>! SUBROUTINE CSNOW<a name='543'></font>
<font color=#447700>! FUNCTION CSNOW<a name='544'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='545'></font>
<font color=#447700>! CALCULATE SNOW TERMAL CONDUCTIVITY<a name='546'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='547'></font>
      IMPLICIT NONE<a name='548'>
      REAL, INTENT(IN) :: DSNOW<a name='549'>
      REAL, INTENT(OUT):: SNCOND<a name='550'>
      REAL             :: C<a name='551'>
      REAL, PARAMETER  :: UNIT = 0.11631<a name='552'>
<a name='553'>
<font color=#447700>! ----------------------------------------------------------------------<a name='554'></font>
<font color=#447700>! SNCOND IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)<a name='555'></font>
<font color=#447700>! CSNOW IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)<a name='556'></font>
<font color=#447700>! BASIC VERSION IS DYACHKOVA EQUATION (1960), FOR RANGE 0.1-0.4<a name='557'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='558'></font>
      C = 0.328*10** (2.25* DSNOW)<a name='559'>
<font color=#447700>!      CSNOW=UNIT*C<a name='560'></font>
<a name='561'>
<font color=#447700>! ----------------------------------------------------------------------<a name='562'></font>
<font color=#447700>! DE VAUX EQUATION (1933), IN RANGE 0.1-0.6<a name='563'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='564'></font>
<font color=#447700>!      SNCOND=0.0293*(1.+100.*DSNOW**2)<a name='565'></font>
<font color=#447700>!      CSNOW=0.0293*(1.+100.*DSNOW**2)<a name='566'></font>
<a name='567'>
<font color=#447700>! ----------------------------------------------------------------------<a name='568'></font>
<font color=#447700>! E. ANDERSEN FROM FLERCHINGER<a name='569'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='570'></font>
<font color=#447700>!      SNCOND=0.021+2.51*DSNOW**2<a name='571'></font>
<font color=#447700>!      CSNOW=0.021+2.51*DSNOW**2<a name='572'></font>
<a name='573'>
<font color=#447700>!      SNCOND = UNIT * C<a name='574'></font>
<font color=#447700>! double snow thermal conductivity<a name='575'></font>
      SNCOND = 2.0 * UNIT * C<a name='576'>
<a name='577'>
<font color=#447700>! ----------------------------------------------------------------------<a name='578'></font>
  END SUBROUTINE CSNOW<a name='579'>
<font color=#447700>! ----------------------------------------------------------------------<a name='580'></font>
<A NAME='HRTICE'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#HRTICE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='581'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRTICE</font> (RHSTS,STC,TBOT,NSOIL,ZSOIL,YY,ZZ1,DF1,AI,BI,CI) <A href='../../call_to/HRTICE.html' TARGET='index'>2</A><a name='582'>
<font color=#447700>! ----------------------------------------------------------------------<a name='583'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL<a name='584'></font>
<font color=#447700>! THERMAL DIFFUSION EQUATION IN THE CASE OF SEA-ICE (ICE=1) OR GLACIAL<a name='585'></font>
<font color=#447700>! ICE (ICE=-1). COMPUTE (PREPARE) THE MATRIX COEFFICIENTS FOR THE<a name='586'></font>
<font color=#447700>! TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.<a name='587'></font>
<font color=#447700>!<a name='588'></font>
<font color=#447700>! (NOTE:  THIS SUBROUTINE ONLY CALLED FOR SEA-ICE OR GLACIAL ICE, BUT<a name='589'></font>
<font color=#447700>! NOT FOR NON-GLACIAL LAND (ICE = 0).<a name='590'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='591'></font>
      IMPLICIT NONE<a name='592'>
<a name='593'>
<a name='594'>
      INTEGER, INTENT(IN)    :: NSOIL<a name='595'>
      INTEGER                :: K<a name='596'>
<a name='597'>
      REAL,    INTENT(IN)    :: DF1,YY,ZZ1<a name='598'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: AI, BI,CI<a name='599'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN) :: STC, ZSOIL<a name='600'>
      REAL, DIMENSION(1:NSOIL), INTENT(OUT):: RHSTS<a name='601'>
      REAL,                     INTENT(IN) :: TBOT<a name='602'>
      REAL                   :: DDZ,DDZ2,DENOM,DTSDZ,DTSDZ2,SSOIL,       &amp;<a name='603'>
                                ZBOT<a name='604'>
      REAL                   :: HCPCT<a name='605'>
      REAL :: DF1K<a name='606'>
      REAL :: DF1N<a name='607'>
      REAL :: ZMD<a name='608'>
<a name='609'>
<font color=#447700>! ----------------------------------------------------------------------<a name='610'></font>
<font color=#447700>! SET A NOMINAL UNIVERSAL VALUE OF THE SEA-ICE SPECIFIC HEAT CAPACITY,<a name='611'></font>
<font color=#447700>! HCPCT = 1880.0*917.0.<a name='612'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='613'></font>
      <font color=#447700>! Sea-ice values<a name='614'></font>
      HCPCT = 1.72396E+6<a name='615'>
<a name='616'>
<font color=#447700>! ----------------------------------------------------------------------<a name='617'></font>
<font color=#447700>! THE INPUT ARGUMENT DF1 IS A UNIVERSALLY CONSTANT VALUE OF SEA-ICE<a name='618'></font>
<font color=#447700>! THERMAL DIFFUSIVITY, SET IN ROUTINE SNOPAC AS DF1 = 2.2.<a name='619'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='620'></font>
<font color=#447700>! SET ICE PACK DEPTH.  USE TBOT AS ICE PACK LOWER BOUNDARY TEMPERATURE<a name='621'></font>
<font color=#447700>! (THAT OF UNFROZEN SEA WATER AT BOTTOM OF SEA ICE PACK).  ASSUME ICE<a name='622'></font>
<font color=#447700>! PACK IS OF N=NSOIL LAYERS SPANNING A UNIFORM CONSTANT ICE PACK<a name='623'></font>
<font color=#447700>! THICKNESS AS DEFINED BY ZSOIL(NSOIL) IN ROUTINE SFLX.<a name='624'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='625'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='626'></font>
<font color=#447700>! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER<a name='627'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='628'></font>
      ZBOT = ZSOIL (NSOIL)<a name='629'>
      DDZ = 1.0 / ( -0.5 * ZSOIL (2) )<a name='630'>
      AI (1) = 0.0<a name='631'>
      CI (1) = (DF1 * DDZ) / (ZSOIL (1) * HCPCT)<a name='632'>
<a name='633'>
<font color=#447700>! ----------------------------------------------------------------------<a name='634'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT BTWN THE TOP AND 2ND SOIL LAYERS.<a name='635'></font>
<font color=#447700>! RECALC/ADJUST THE SOIL HEAT FLUX.  USE THE GRADIENT AND FLUX TO CALC<a name='636'></font>
<font color=#447700>! RHSTS FOR THE TOP SOIL LAYER.<a name='637'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='638'></font>
      BI (1) = - CI (1) + DF1/ (0.5 * ZSOIL (1) * ZSOIL (1) * HCPCT *    &amp;<a name='639'>
       ZZ1)<a name='640'>
      DTSDZ = ( STC (1) - STC (2) ) / ( -0.5 * ZSOIL (2) )<a name='641'>
      SSOIL = DF1 * ( STC (1) - YY ) / ( 0.5 * ZSOIL (1) * ZZ1 )<a name='642'>
<a name='643'>
<font color=#447700>! ----------------------------------------------------------------------<a name='644'></font>
<font color=#447700>! INITIALIZE DDZ2<a name='645'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='646'></font>
      RHSTS (1) = ( DF1 * DTSDZ - SSOIL ) / ( ZSOIL (1) * HCPCT )<a name='647'>
<a name='648'>
<font color=#447700>! ----------------------------------------------------------------------<a name='649'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS<a name='650'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='651'></font>
      DDZ2 = 0.0<a name='652'>
      DF1K = DF1<a name='653'>
      DF1N = DF1<a name='654'>
      DO K = 2,NSOIL<a name='655'>
<a name='656'>
<font color=#447700>! ----------------------------------------------------------------------<a name='657'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER.<a name='658'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='659'></font>
         IF (K /= NSOIL) THEN<a name='660'>
            DENOM = 0.5 * ( ZSOIL (K -1) - ZSOIL (K +1) )<a name='661'>
<a name='662'>
<font color=#447700>! ----------------------------------------------------------------------<a name='663'></font>
<font color=#447700>! CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT.<a name='664'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='665'></font>
            DTSDZ2 = ( STC (K) - STC (K +1) ) / DENOM<a name='666'>
            DDZ2 = 2. / (ZSOIL (K -1) - ZSOIL (K +1))<a name='667'>
            CI (K) = - DF1N * DDZ2 / ( (ZSOIL (K -1) - ZSOIL (K))*HCPCT)<a name='668'>
<a name='669'>
<font color=#447700>! ----------------------------------------------------------------------<a name='670'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THE LOWEST LAYER.<a name='671'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='672'></font>
         ELSE<a name='673'>
<a name='674'>
<font color=#447700>! ----------------------------------------------------------------------<a name='675'></font>
<font color=#447700>! SET MATRIX COEF, CI TO ZERO.<a name='676'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='677'></font>
            DTSDZ2 = (STC (K) - TBOT)/ (.5 * (ZSOIL (K -1) + ZSOIL (K)) &amp;<a name='678'>
                     - ZBOT)<a name='679'>
            CI (K) = 0.<a name='680'>
         END IF<a name='681'>
<font color=#447700>! ----------------------------------------------------------------------<a name='682'></font>
<font color=#447700>! CALC RHSTS FOR THIS LAYER AFTER CALC'NG A PARTIAL PRODUCT.<a name='683'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='684'></font>
         DENOM = ( ZSOIL (K) - ZSOIL (K -1) ) * HCPCT<a name='685'>
<font color=#447700>! ----------------------------------------------------------------------<a name='686'></font>
<font color=#447700>! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.<a name='687'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='688'></font>
         RHSTS (K) = ( DF1N * DTSDZ2- DF1K * DTSDZ ) / DENOM<a name='689'>
         AI (K) = - DF1K * DDZ / ( (ZSOIL (K -1) - ZSOIL (K)) * HCPCT)<a name='690'>
         BI (K) = - (AI (K) + CI (K))<a name='691'>
<font color=#447700>! ----------------------------------------------------------------------<a name='692'></font>
<font color=#447700>! RESET VALUES OF DTSDZ AND DDZ FOR LOOP TO NEXT SOIL LYR.<a name='693'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='694'></font>
         DF1K = DF1N<a name='695'>
         DTSDZ = DTSDZ2<a name='696'>
         DDZ = DDZ2<a name='697'>
      END DO<a name='698'>
<font color=#447700>! ----------------------------------------------------------------------<a name='699'></font>
  END SUBROUTINE HRTICE<a name='700'>
<font color=#447700>! ----------------------------------------------------------------------<a name='701'></font>
<a name='702'>
<A NAME='PENMAN'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#PENMAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='703'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>PENMAN</font> (SFCTMP,SFCPRS,CH,TH2,PRCP,FDOWN,T24,SSOIL, &amp; <A href='../../call_to/PENMAN.html' TARGET='index'>3</A><a name='704'>
       &amp;             Q2,Q2SAT,ETP,RCH,RR,SNOWNG,FRZGRA,       &amp;<a name='705'>
       &amp;             DQSDT2,FLX2,EMISSI,T1)<a name='706'>
<a name='707'>
<font color=#447700>! ----------------------------------------------------------------------<a name='708'></font>
<font color=#447700>! CALCULATE POTENTIAL EVAPORATION FOR THE CURRENT POINT.  VARIOUS<a name='709'></font>
<font color=#447700>! PARTIAL SUMS/PRODUCTS ARE ALSO CALCULATED AND PASSED BACK TO THE<a name='710'></font>
<font color=#447700>! CALLING ROUTINE FOR LATER USE.<a name='711'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='712'></font>
<a name='713'>
    IMPLICIT NONE<a name='714'>
    LOGICAL, INTENT(IN)     :: SNOWNG, FRZGRA<a name='715'>
    REAL, INTENT(IN)        :: CH, DQSDT2, FDOWN, PRCP,           &amp;<a name='716'>
         &amp;                     Q2, Q2SAT, SSOIL, SFCPRS, SFCTMP,  &amp;<a name='717'>
         &amp;                     TH2,EMISSI<a name='718'>
    REAL, INTENT(IN)        :: T1, T24, RCH<a name='719'>
    REAL, INTENT(OUT)       :: ETP,FLX2,RR<a name='720'>
    REAL                    :: ELCP1, LVS, EPSCA, A, DELTA, FNET, RAD<a name='721'>
<a name='722'>
    REAL, PARAMETER      :: ELCP = 2.4888E+3, LSUBC = 2.501000E+6,CP = 1004.6<a name='723'>
    REAL, PARAMETER      :: LSUBS = 2.83E+6<a name='724'>
<a name='725'>
<font color=#447700>! ----------------------------------------------------------------------<a name='726'></font>
<font color=#447700>! PREPARE PARTIAL QUANTITIES FOR PENMAN EQUATION.<a name='727'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='728'></font>
<a name='729'>
    IF ( T1 &gt; 273.15 ) THEN<a name='730'>
       ELCP1=ELCP<a name='731'>
       LVS=LSUBC<a name='732'>
    ELSE<a name='733'>
       ELCP1  = ELCP*LSUBS/LSUBC<a name='734'>
       LVS    = LSUBS<a name='735'>
    ENDIF<a name='736'>
<a name='737'>
    FLX2 = 0.0<a name='738'>
    DELTA = ELCP1 * DQSDT2<a name='739'>
    RR = EMISSI * T24 * 6.48E-8 / (SFCPRS * CH) + 1.0<a name='740'>
<a name='741'>
<font color=#447700>! ----------------------------------------------------------------------<a name='742'></font>
<font color=#447700>! ADJUST THE PARTIAL SUMS / PRODUCTS WITH THE LATENT HEAT<a name='743'></font>
<font color=#447700>! EFFECTS CAUSED BY FALLING PRECIPITATION.<a name='744'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='745'></font>
<a name='746'>
    IF ( PRCP &gt; 0.0 ) THEN<a name='747'>
       IF (.NOT. SNOWNG) THEN<a name='748'>
          RR = RR + CPH2O * PRCP / RCH<a name='749'>
       ELSE<a name='750'>
          RR = RR + CPICE * PRCP / RCH<a name='751'>
       ENDIF<a name='752'>
    ENDIF<a name='753'>
<a name='754'>
<font color=#447700>! ----------------------------------------------------------------------<a name='755'></font>
<font color=#447700>! INCLUDE THE LATENT HEAT EFFECTS OF FREEZING RAIN CONVERTING TO ICE ON<a name='756'></font>
<font color=#447700>! IMPACT IN THE CALCULATION OF FLX2 AND FNET.<a name='757'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='758'></font>
<a name='759'>
    FNET = FDOWN - EMISSI * SIGMA * T24 - SSOIL<a name='760'>
    IF (FRZGRA) THEN<a name='761'>
       FLX2 = - LSUBF * PRCP<a name='762'>
       FNET = FNET - FLX2<a name='763'>
    END IF<a name='764'>
<a name='765'>
<font color=#447700>! ----------------------------------------------------------------------<a name='766'></font>
<font color=#447700>! FINISH PENMAN EQUATION CALCULATIONS.<a name='767'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='768'></font>
<a name='769'>
    RAD = FNET / RCH + TH2 - SFCTMP<a name='770'>
    A = ELCP1 * (Q2SAT - Q2)<a name='771'>
    EPSCA = (A * RR + RAD * DELTA) / (DELTA + RR)<a name='772'>
    ETP = EPSCA * RCH / LVS<a name='773'>
<a name='774'>
<font color=#447700>! ----------------------------------------------------------------------<a name='775'></font>
  END SUBROUTINE PENMAN<a name='776'>
<font color=#447700>! ----------------------------------------------------------------------<a name='777'></font>
<a name='778'>
<A NAME='SHFLX'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SHFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='779'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SHFLX</font> (STC,NSOIL,DT,YY,ZZ1,ZSOIL,TBOT,DF1) <A href='../../call_to/SHFLX.html' TARGET='index'>5</A>,<A href='../../call_from/SHFLX.html' TARGET='index'>8</A><a name='780'>
<font color=#447700>! ----------------------------------------------------------------------<a name='781'></font>
<font color=#447700>! UPDATE THE TEMPERATURE STATE OF THE SOIL COLUMN BASED ON THE THERMAL<a name='782'></font>
<font color=#447700>! DIFFUSION EQUATION.<a name='783'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='784'></font>
      IMPLICIT NONE<a name='785'>
<a name='786'>
      INTEGER,                  INTENT(IN)    :: NSOIL<a name='787'>
      REAL,                     INTENT(IN)    :: DF1,DT,TBOT,YY, ZZ1<a name='788'>
      REAL, DIMENSION(1:NSOIL), INTENT(IN)    :: ZSOIL<a name='789'>
      REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: STC<a name='790'>
      REAL, DIMENSION(1:NSOIL)                :: AI, BI, CI, STCF,RHSTS<a name='791'>
      INTEGER                                 :: I<a name='792'>
      REAL, PARAMETER                         :: T0 = 273.15<a name='793'>
<a name='794'>
<font color=#447700>! ----------------------------------------------------------------------<a name='795'></font>
<font color=#447700>! HRTICE ROUTINE CALCS THE RIGHT HAND SIDE OF THE SOIL TEMP DIF EQN<a name='796'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='797'></font>
<a name='798'>
      CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#HRTICE'>HRTICE</A><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRTICE_1"> (RHSTS,STC,TBOT,NSOIL,ZSOIL,YY,ZZ1,DF1,AI,BI,CI)<a name='799'>
      CALL <A href='../../html_code/phys/module_sf_urban.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_1"> (STCF,STC,RHSTS,DT,NSOIL,AI,BI,CI)<a name='800'>
<a name='801'>
      DO I = 1,NSOIL<a name='802'>
         STC (I) = STCF (I)<a name='803'>
      END DO<a name='804'>
<a name='805'>
<font color=#447700>! ----------------------------------------------------------------------<a name='806'></font>
  END SUBROUTINE SHFLX<a name='807'>
<font color=#447700>! ----------------------------------------------------------------------<a name='808'></font>
<a name='809'>
<A NAME='SNOPAC'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SNOPAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='810'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOPAC</font> (ETP,ETA,PRCP,SNOWNG,            &amp; <A href='../../call_to/SNOPAC.html' TARGET='index'>3</A>,<A href='../../call_from/SNOPAC.html' TARGET='index'>9</A><a name='811'>
       NSOIL,DT,DF1,                                 &amp;<a name='812'>
       Q2,T1,SFCTMP,T24,TH2,FDOWN,SSOIL,STC,         &amp;<a name='813'>
       SFCPRS,RCH,RR,SNCOVR,ESD,SNDENS,              &amp;<a name='814'>
       SNOWH,ZSOIL,TBOT,                             &amp;<a name='815'>
       SNOMLT,DEW,FLX1,FLX2,FLX3,ESNOW,EMISSI,       &amp;<a name='816'>
       RIBB, SEAICE_ALBEDO_OPT)<a name='817'>
<a name='818'>
<font color=#447700>! ----------------------------------------------------------------------<a name='819'></font>
<font color=#447700>! SUBROUTINE SNOPAC<a name='820'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='821'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES &amp; UPDATE SOIL MOISTURE<a name='822'></font>
<font color=#447700>! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN A SNOW PACK IS<a name='823'></font>
<font color=#447700>! PRESENT.<a name='824'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='825'></font>
    IMPLICIT NONE<a name='826'>
<a name='827'>
    INTEGER, INTENT(IN)   :: NSOIL<a name='828'>
    INTEGER               :: K<a name='829'>
    LOGICAL, INTENT(IN)   :: SNOWNG<a name='830'>
    REAL, INTENT(IN)      :: DF1,                                     &amp;<a name='831'>
         &amp;                   DT,FDOWN,                                &amp;<a name='832'>
         &amp;                   PRCP,Q2,                                 &amp;<a name='833'>
         &amp;                   RCH,RR,SFCPRS, SFCTMP,                   &amp;<a name='834'>
         &amp;                   T24,                                     &amp;<a name='835'>
         &amp;                   TBOT,TH2,EMISSI<a name='836'>
    REAL, INTENT(INOUT)   :: ESD,FLX2,SNOWH,SNCOVR,                   &amp;<a name='837'>
         &amp;                   SNDENS, T1, RIBB, ETP<a name='838'>
    REAL, INTENT(OUT)     :: DEW,ESNOW,                               &amp;<a name='839'>
         &amp;                   FLX1,FLX3, SSOIL,SNOMLT<a name='840'>
    REAL, DIMENSION(1:NSOIL),INTENT(IN)     :: ZSOIL<a name='841'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: STC<a name='842'>
    REAL                  :: DENOM,DSOIL,DTOT,ETA,                    &amp;<a name='843'>
         &amp;                   ESNOW1, ESNOW2, ETA1,ETP1,ETP2,          &amp;<a name='844'>
         &amp;                   ETANRG, EX, SEH,                         &amp;<a name='845'>
         &amp;                   SNCOND,T12, T12A,                        &amp;<a name='846'>
         &amp;                   T12B, T14, YY, ZZ1<a name='847'>
    INTEGER, INTENT(IN)   :: SEAICE_ALBEDO_OPT<a name='848'>
    REAL, PARAMETER       :: ESDMIN = 1.E-6, LSUBC = 2.501000E+6,     &amp;<a name='849'>
         LSUBS = 2.83E+6, SNOEXP = 2.0<a name='850'>
<a name='851'>
<font color=#447700>! ----------------------------------------------------------------------<a name='852'></font>
<font color=#447700>! SNOWCOVER FRACTION = 1.0, AND SUBLIMATION IS AT THE POTENTIAL RATE.<a name='853'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='854'></font>
<font color=#447700>! INITIALIZE EVAP TERMS.<a name='855'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='856'></font>
<font color=#447700>! conversions:<a name='857'></font>
<font color=#447700>! ESNOW [KG M-2 S-1]<a name='858'></font>
<font color=#447700>! ESNOW1 [M S-1]<a name='859'></font>
<font color=#447700>! ESNOW2 [M]<a name='860'></font>
<font color=#447700>! ETP [KG M-2 S-1]<a name='861'></font>
<font color=#447700>! ETP1 [M S-1]<a name='862'></font>
<font color=#447700>! ETP2 [M]<a name='863'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='864'></font>
    DEW = 0.<a name='865'>
    ESNOW = 0.<a name='866'>
    ESNOW1 = 0.<a name='867'>
    ESNOW2 = 0.<a name='868'>
<a name='869'>
<font color=#447700>! ----------------------------------------------------------------------<a name='870'></font>
<font color=#447700>! CONVERT POTENTIAL EVAP (ETP) FROM KG M-2 S-1 TO ETP1 IN M S-1<a name='871'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='872'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='873'></font>
<font color=#447700>! IF ETP&lt;0 (DOWNWARD) THEN DEWFALL (=FROSTFALL IN THIS CASE).<a name='874'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='875'></font>
    IF (ETP &lt;= 0.0) THEN<a name='876'>
       IF ( ( RIBB &gt;= 0.1 ) .AND. ( FDOWN &gt; 150.0 ) ) THEN<a name='877'>
          ETP=(MIN(ETP*(1.0-RIBB),0.)*SNCOVR/0.980 + ETP*(0.980-SNCOVR))/0.980<a name='878'>
       ENDIF<a name='879'>
       ETP1 = ETP * 0.001<a name='880'>
       DEW = -ETP1<a name='881'>
       ESNOW2 = ETP1*DT<a name='882'>
       ETANRG = ETP*((1.-SNCOVR)*LSUBC + SNCOVR*LSUBS)<a name='883'>
    ELSE<a name='884'>
       ETP1 = ETP * 0.001<a name='885'>
       ESNOW  = ETP<a name='886'>
       ESNOW1 = ESNOW*0.001<a name='887'>
       ESNOW2 = ESNOW1*DT<a name='888'>
       ETANRG = ESNOW*LSUBS<a name='889'>
       ESNOW  = ETP*SNCOVR<a name='890'>
       ESNOW1 = ESNOW*0.001<a name='891'>
       ESNOW2 = ESNOW1*DT<a name='892'>
       ETANRG = ESNOW*LSUBS<a name='893'>
    END IF<a name='894'>
<a name='895'>
<font color=#447700>! ----------------------------------------------------------------------<a name='896'></font>
<font color=#447700>! IF PRECIP IS FALLING, CALCULATE HEAT FLUX FROM SNOW SFC TO NEWLY<a name='897'></font>
<font color=#447700>! ACCUMULATING PRECIP.  NOTE THAT THIS REFLECTS THE FLUX APPROPRIATE FOR<a name='898'></font>
<font color=#447700>! THE NOT-YET-UPDATED SKIN TEMPERATURE (T1).  ASSUMES TEMPERATURE OF THE<a name='899'></font>
<font color=#447700>! SNOWFALL STRIKING THE GROUND IS =SFCTMP (LOWEST MODEL LEVEL AIR TEMP).<a name='900'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='901'></font>
    FLX1 = 0.0<a name='902'>
    IF (SNOWNG) THEN<a name='903'>
       FLX1 = CPICE * PRCP * (T1- SFCTMP)<a name='904'>
    ELSE<a name='905'>
       IF (PRCP &gt;  0.0) FLX1 = CPH2O * PRCP * (T1- SFCTMP)<a name='906'>
<font color=#447700>! ----------------------------------------------------------------------<a name='907'></font>
<font color=#447700>! CALCULATE AN 'EFFECTIVE SNOW-GRND SFC TEMP' (T12) BASED ON HEAT FLUXES<a name='908'></font>
<font color=#447700>! BETWEEN THE SNOW PACK AND THE SOIL AND ON NET RADIATION.<a name='909'></font>
<font color=#447700>! INCLUDE FLX1 (PRECIP-SNOW SFC) AND FLX2 (FREEZING RAIN LATENT HEAT)<a name='910'></font>
<font color=#447700>! FLUXES.  FLX1 FROM ABOVE, FLX2 BROUGHT IN VIA COMMOM BLOCK RITE.<a name='911'></font>
<font color=#447700>! FLX2 REFLECTS FREEZING RAIN LATENT HEAT FLUX USING T1 CALCULATED IN<a name='912'></font>
<font color=#447700>! PENMAN.<a name='913'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='914'></font>
    END IF<a name='915'>
    DSOIL = - (0.5 * ZSOIL (1))<a name='916'>
    DTOT = SNOWH + DSOIL<a name='917'>
    DENOM = 1.0+ DF1 / (DTOT * RR * RCH)<a name='918'>
<font color=#447700>! surface emissivity weighted by snow cover fraction<a name='919'></font>
<font color=#447700>!      T12A = ( (FDOWN - FLX1 - FLX2 -                                   &amp;<a name='920'></font>
<font color=#447700>!     &amp;       ((SNCOVR*EMISSI_S)+EMISSI*(1.0-SNCOVR))*SIGMA *T24)/RCH    &amp;<a name='921'></font>
<font color=#447700>!     &amp;       + TH2 - SFCTMP - ETANRG/RCH ) / RR<a name='922'></font>
    T12A = ( (FDOWN - FLX1 - FLX2 - EMISSI * SIGMA * T24)/ RCH                    &amp;<a name='923'>
         + TH2 - SFCTMP - ETANRG / RCH ) / RR<a name='924'>
<a name='925'>
    T12B = DF1 * STC (1) / (DTOT * RR * RCH)<a name='926'>
<a name='927'>
<font color=#447700>! ----------------------------------------------------------------------<a name='928'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS AT OR BELOW FREEZING, NO SNOW<a name='929'></font>
<font color=#447700>! MELT WILL OCCUR.  SET THE SKIN TEMP TO THIS EFFECTIVE TEMP.  REDUCE<a name='930'></font>
<font color=#447700>! (BY SUBLIMINATION ) OR INCREASE (BY FROST) THE DEPTH OF THE SNOWPACK,<a name='931'></font>
<font color=#447700>! DEPENDING ON SIGN OF ETP.<a name='932'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX (SSOIL) USING NEW SKIN TEMPERATURE (T1)<a name='933'></font>
<font color=#447700>! SINCE NO SNOWMELT, SET ACCUMULATED SNOWMELT TO ZERO, SET 'EFFECTIVE'<a name='934'></font>
<font color=#447700>! PRECIP FROM SNOWMELT TO ZERO, SET PHASE-CHANGE HEAT FLUX FROM SNOWMELT<a name='935'></font>
<font color=#447700>! TO ZERO.<a name='936'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='937'></font>
<font color=#447700>! SUB-FREEZING BLOCK<a name='938'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='939'></font>
    T12 = (SFCTMP + T12A + T12B) / DENOM<a name='940'>
    IF (T12 &lt;=  TFREEZ) THEN<a name='941'>
       T1 = T12<a name='942'>
       SSOIL = DF1 * (T1- STC (1)) / DTOT<a name='943'>
<font color=#447700>!        ESD = MAX (0.0, ESD- ETP2)<a name='944'></font>
       ESD = MAX(0.0, ESD-ESNOW2)<a name='945'>
       FLX3 = 0.0<a name='946'>
       EX = 0.0<a name='947'>
<a name='948'>
       SNOMLT = 0.0<a name='949'>
<font color=#447700>! ----------------------------------------------------------------------<a name='950'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS ABOVE FREEZING, SNOW MELT<a name='951'></font>
<font color=#447700>! WILL OCCUR.  CALL THE SNOW MELT RATE,EX AND AMT, SNOMLT.  REVISE THE<a name='952'></font>
<font color=#447700>! EFFECTIVE SNOW DEPTH.  REVISE THE SKIN TEMP BECAUSE IT WOULD HAVE CHGD<a name='953'></font>
<font color=#447700>! DUE TO THE LATENT HEAT RELEASED BY THE MELTING. CALC THE LATENT HEAT<a name='954'></font>
<font color=#447700>! RELEASED, FLX3.  ADJUSTMENT TO T1 TO ACCOUNT FOR SNOW PATCHES.<a name='955'></font>
<font color=#447700>! CALCULATE QSAT VALID AT FREEZING POINT.  NOTE THAT ESAT (SATURATION<a name='956'></font>
<font color=#447700>! VAPOR PRESSURE) VALUE OF 6.11E+2 USED HERE IS THAT VALID AT FRZZING<a name='957'></font>
<font color=#447700>! POINT.  NOTE THAT ETP FROM CALL PENMAN IN SFLX IS IGNORED HERE IN<a name='958'></font>
<font color=#447700>! FAVOR OF BULK ETP OVER 'OPEN WATER' AT FREEZING TEMP.<a name='959'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX (S) USING NEW SKIN TEMPERATURE (T1)<a name='960'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='961'></font>
<font color=#447700>! ABOVE FREEZING BLOCK<a name='962'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='963'></font>
    ELSE<a name='964'>
       T1 = TFREEZ <a name='965'>
       SSOIL = DF1 * (T1- STC (1)) / DTOT<a name='966'>
<a name='967'>
<font color=#447700>! ----------------------------------------------------------------------<a name='968'></font>
<font color=#447700>! IF POTENTIAL EVAP (SUBLIMATION) GREATER THAN DEPTH OF SNOWPACK.<a name='969'></font>
<font color=#447700>! SNOWPACK HAS SUBLIMATED AWAY, SET DEPTH TO ZERO.<a name='970'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='971'></font>
<a name='972'>
       IF (ESD-ESNOW2 &lt;= ESDMIN) THEN<a name='973'>
          ESD = 0.0<a name='974'>
          EX = 0.0<a name='975'>
          SNOMLT = 0.0<a name='976'>
          FLX3 = 0.0<a name='977'>
<font color=#447700>! ----------------------------------------------------------------------<a name='978'></font>
<font color=#447700>! SUBLIMATION LESS THAN DEPTH OF SNOWPACK<a name='979'></font>
<font color=#447700>! SNOWPACK (ESD) REDUCED BY ESNOW2 (DEPTH OF SUBLIMATED SNOW)<a name='980'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='981'></font>
       ELSE<a name='982'>
          ESD = ESD-ESNOW2<a name='983'>
          SEH = RCH * (T1- TH2)<a name='984'>
          T14 = ( T1 * T1 ) * ( T1 * T1 )<a name='985'>
          FLX3 = FDOWN - FLX1- FLX2- EMISSI*SIGMA * T14- SSOIL - SEH - ETANRG<a name='986'>
          IF (FLX3 &lt;= 0.0) FLX3 = 0.0<a name='987'>
<font color=#447700>! ----------------------------------------------------------------------<a name='988'></font>
<font color=#447700>! SNOWMELT REDUCTION DEPENDING ON SNOW COVER<a name='989'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='990'></font>
          EX = FLX3*0.001/ LSUBF<a name='991'>
<a name='992'>
<font color=#447700>! ----------------------------------------------------------------------<a name='993'></font>
<font color=#447700>! ESDMIN REPRESENTS A SNOWPACK DEPTH THRESHOLD VALUE BELOW WHICH WE<a name='994'></font>
<font color=#447700>! CHOOSE NOT TO RETAIN ANY SNOWPACK, AND INSTEAD INCLUDE IT IN SNOWMELT.<a name='995'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='996'></font>
          SNOMLT = EX * DT<a name='997'>
          IF (ESD- SNOMLT &gt;=  ESDMIN) THEN<a name='998'>
             ESD = ESD- SNOMLT<a name='999'>
          ELSE<a name='1000'>
             <font color=#447700>!<a name='1001'></font>
             <font color=#447700>! SNOWMELT EXCEEDS SNOW DEPTH<a name='1002'></font>
             <font color=#447700>!<a name='1003'></font>
             EX = ESD / DT<a name='1004'>
             FLX3 = EX *1000.0* LSUBF<a name='1005'>
             SNOMLT = ESD<a name='1006'>
<a name='1007'>
             ESD = 0.0<a name='1008'>
          ENDIF<a name='1009'>
       ENDIF<a name='1010'>
<a name='1011'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1012'></font>
<font color=#447700>! END OF 'T12 .LE. TFREEZ' IF-BLOCK<a name='1013'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1014'></font>
<a name='1015'>
    ENDIF<a name='1016'>
<a name='1017'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1018'></font>
<font color=#447700>! FOR SEA-ICE, THE SNOWMELT WILL BE ADDED TO SUBSURFACE<a name='1019'></font>
<font color=#447700>! RUNOFF/BASEFLOW LATER NEAR THE END OF SFLX (AFTER RETURN FROM CALL TO<a name='1020'></font>
<font color=#447700>! SUBROUTINE SNOPAC)<a name='1021'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1022'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1023'></font>
<font color=#447700>! SET THE EFFECTIVE POTNL EVAPOTRANSP (ETP1) TO ZERO SINCE THIS IS SNOW<a name='1024'></font>
<font color=#447700>! CASE, SO SURFACE EVAP NOT CALCULATED FROM EDIR IN SMFLX (BELOW).<a name='1025'></font>
<font color=#447700>! IF SEAICE (ICE==1) SKIP CALL TO SMFLX, SINCE NO SOIL MEDIUM FOR SEA-ICE<a name='1026'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1027'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1028'></font>
<font color=#447700>! BEFORE CALL SHFLX IN THIS SNOWPACK CASE, SET ZZ1 AND YY ARGUMENTS TO<a name='1029'></font>
<font color=#447700>! SPECIAL VALUES THAT ENSURE THAT GROUND HEAT FLUX CALCULATED IN SHFLX<a name='1030'></font>
<font color=#447700>! MATCHES THAT ALREADY COMPUTED FOR BELOW THE SNOWPACK, THUS THE SFC<a name='1031'></font>
<font color=#447700>! HEAT FLUX TO BE COMPUTED IN SHFLX WILL EFFECTIVELY BE THE FLUX AT THE<a name='1032'></font>
<font color=#447700>! SNOW TOP SURFACE.<a name='1033'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1034'></font>
<a name='1035'>
    ZZ1 = 1.0<a name='1036'>
    YY = STC (1) -0.5* SSOIL * ZSOIL (1)* ZZ1/ DF1<a name='1037'>
<a name='1038'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1039'></font>
<font color=#447700>! SHFLX WILL CALC/UPDATE THE ICE TEMPS.<a name='1040'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1041'></font>
<a name='1042'>
    CALL <A href='../../html_code/phys/module_sf_urban.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_1"> (STC,NSOIL,DT,YY,ZZ1,ZSOIL,TBOT,DF1)<a name='1043'>
<a name='1044'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1045'></font>
<font color=#447700>! SNOW DEPTH AND DENSITY ADJUSTMENT BASED ON SNOW COMPACTION.  YY IS<a name='1046'></font>
<font color=#447700>! ASSUMED TO BE THE SOIL TEMPERTURE AT THE TOP OF THE SOIL COLUMN.<a name='1047'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1048'></font>
    SELECT CASE ( SEAICE_ALBEDO_OPT )<a name='1049'>
<a name='1050'>
    CASE DEFAULT<a name='1051'>
<a name='1052'>
       IF (ESD .GE. 0.01) THEN<a name='1053'>
          CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWPACK'>SNOWPACK</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWPACK_1"> (ESD,DT,SNOWH,SNDENS,T1,YY)<a name='1054'>
       ELSE<a name='1055'>
          ESD = 0.01<a name='1056'>
          SNOWH = 0.05<a name='1057'>
<font color=#447700>!KWM???? SNDENS =<a name='1058'></font>
<font color=#447700>!KWM???? SNCOND =<a name='1059'></font>
          SNCOVR = 1.0<a name='1060'>
       ENDIF<a name='1061'>
<a name='1062'>
    CASE ( 1 ) <font color=#447700>! Arctic sea-ice albedo from Mills (2011)<a name='1063'></font>
<a name='1064'>
       IF ( ESD &gt;= 0.0001 ) THEN<a name='1065'>
          CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWPACK'>SNOWPACK</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWPACK_2"> (ESD,DT,SNOWH,SNDENS,T1,YY)<a name='1066'>
       ELSE<a name='1067'>
          ESD    = 0.0001<a name='1068'>
          SNOWH  = 0.0005<a name='1069'>
          SNCOVR = 0.005<a name='1070'>
       ENDIF<a name='1071'>
<a name='1072'>
    END SELECT<a name='1073'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1074'></font>
  END SUBROUTINE SNOPAC<a name='1075'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1076'></font>
<a name='1077'>
<A NAME='SNOWPACK'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SNOWPACK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1078'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWPACK</font> (ESD,DTSEC,SNOWH,SNDENS,TSNOW,TSOIL) <A href='../../call_to/SNOWPACK.html' TARGET='index'>4</A><a name='1079'>
<a name='1080'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1081'></font>
<font color=#447700>! SUBROUTINE SNOWPACK<a name='1082'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1083'></font>
<font color=#447700>! CALCULATE COMPACTION OF SNOWPACK UNDER CONDITIONS OF INCREASING SNOW<a name='1084'></font>
<font color=#447700>! DENSITY, AS OBTAINED FROM AN APPROXIMATE SOLUTION OF E. ANDERSON'S<a name='1085'></font>
<font color=#447700>! DIFFERENTIAL EQUATION (3.29), NOAA TECHNICAL REPORT NWS 19, BY VICTOR<a name='1086'></font>
<font color=#447700>! KOREN, 03/25/95.<a name='1087'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1088'></font>
<font color=#447700>! ESD     WATER EQUIVALENT OF SNOW (M)<a name='1089'></font>
<font color=#447700>! DTSEC   TIME STEP (SEC)<a name='1090'></font>
<font color=#447700>! SNOWH   SNOW DEPTH (M)<a name='1091'></font>
<font color=#447700>! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)<a name='1092'></font>
<font color=#447700>! TSNOW   SNOW SURFACE TEMPERATURE (K)<a name='1093'></font>
<font color=#447700>! TSOIL   SOIL SURFACE TEMPERATURE (K)<a name='1094'></font>
<a name='1095'>
<font color=#447700>! SUBROUTINE WILL RETURN NEW VALUES OF SNOWH AND SNDENS<a name='1096'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1097'></font>
      IMPLICIT NONE<a name='1098'>
<a name='1099'>
      INTEGER                :: IPOL, J<a name='1100'>
      REAL, INTENT(IN)       :: ESD, DTSEC,TSNOW,TSOIL<a name='1101'>
      REAL, INTENT(INOUT)    :: SNOWH, SNDENS<a name='1102'>
      REAL                   :: BFAC,DSX,DTHR,DW,SNOWHC,PEXP,           &amp;<a name='1103'>
                                TAVGC,TSNOWC,TSOILC,ESDC,ESDCX<a name='1104'>
      REAL, PARAMETER        :: C1 = 0.01, C2 = 21.0, G = 9.81,         &amp;<a name='1105'>
                                KN = 4000.0<a name='1106'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1107'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS<a name='1108'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1109'></font>
      SNOWHC = SNOWH *100.<a name='1110'>
      ESDC = ESD *100.<a name='1111'>
      DTHR = DTSEC /3600.<a name='1112'>
      TSNOWC = TSNOW -273.15<a name='1113'>
      TSOILC = TSOIL -273.15<a name='1114'>
<a name='1115'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1116'></font>
<font color=#447700>! CALCULATING OF AVERAGE TEMPERATURE OF SNOW PACK<a name='1117'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1118'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1119'></font>
<font color=#447700>! CALCULATING OF SNOW DEPTH AND DENSITY AS A RESULT OF COMPACTION<a name='1120'></font>
<font color=#447700>!  SNDENS=DS0*(EXP(BFAC*ESD)-1.)/(BFAC*ESD)<a name='1121'></font>
<font color=#447700>!  BFAC=DTHR*C1*EXP(0.08*TAVGC-C2*DS0)<a name='1122'></font>
<font color=#447700>! NOTE: BFAC*ESD IN SNDENS EQN ABOVE HAS TO BE CAREFULLY TREATED<a name='1123'></font>
<font color=#447700>! NUMERICALLY BELOW:<a name='1124'></font>
<font color=#447700>!   C1 IS THE FRACTIONAL INCREASE IN DENSITY (1/(CM*HR))<a name='1125'></font>
<font color=#447700>!   C2 IS A CONSTANT (CM3/G) KOJIMA ESTIMATED AS 21 CMS/G<a name='1126'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1127'></font>
      TAVGC = 0.5* (TSNOWC + TSOILC)<a name='1128'>
      IF (ESDC &gt;  1.E-2) THEN<a name='1129'>
         ESDCX = ESDC<a name='1130'>
      ELSE<a name='1131'>
         ESDCX = 1.E-2<a name='1132'>
      END IF<a name='1133'>
<a name='1134'>
<font color=#447700>!      DSX = SNDENS*((DEXP(BFAC*ESDC)-1.)/(BFAC*ESDC))<a name='1135'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1136'></font>
<font color=#447700>! THE FUNCTION OF THE FORM (e**x-1)/x EMBEDDED IN ABOVE EXPRESSION<a name='1137'></font>
<font color=#447700>! FOR DSX WAS CAUSING NUMERICAL DIFFICULTIES WHEN THE DENOMINATOR "x"<a name='1138'></font>
<font color=#447700>! (I.E. BFAC*ESDC) BECAME ZERO OR APPROACHED ZERO (DESPITE THE FACT THAT<a name='1139'></font>
<font color=#447700>! THE ANALYTICAL FUNCTION (e**x-1)/x HAS A WELL DEFINED LIMIT AS<a name='1140'></font>
<font color=#447700>! "x" APPROACHES ZERO), HENCE BELOW WE REPLACE THE (e**x-1)/x<a name='1141'></font>
<font color=#447700>! EXPRESSION WITH AN EQUIVALENT, NUMERICALLY WELL-BEHAVED<a name='1142'></font>
<font color=#447700>! POLYNOMIAL EXPANSION.<a name='1143'></font>
<a name='1144'>
<font color=#447700>! NUMBER OF TERMS OF POLYNOMIAL EXPANSION, AND HENCE ITS ACCURACY,<a name='1145'></font>
<font color=#447700>! IS GOVERNED BY ITERATION LIMIT "IPOL".<a name='1146'></font>
<font color=#447700>!      IPOL GREATER THAN 9 ONLY MAKES A DIFFERENCE ON DOUBLE<a name='1147'></font>
<font color=#447700>!            PRECISION (RELATIVE ERRORS GIVEN IN PERCENT %).<a name='1148'></font>
<font color=#447700>!       IPOL=9, FOR REL.ERROR &lt;~ 1.6 E-6 % (8 SIGNIFICANT DIGITS)<a name='1149'></font>
<font color=#447700>!       IPOL=8, FOR REL.ERROR &lt;~ 1.8 E-5 % (7 SIGNIFICANT DIGITS)<a name='1150'></font>
<font color=#447700>!       IPOL=7, FOR REL.ERROR &lt;~ 1.8 E-4 % ...<a name='1151'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1152'></font>
      BFAC = DTHR * C1* EXP (0.08* TAVGC - C2* SNDENS)<a name='1153'>
      IPOL = 4<a name='1154'>
      PEXP = 0.<a name='1155'>
<font color=#447700>!        PEXP = (1. + PEXP)*BFAC*ESDC/REAL(J+1)<a name='1156'></font>
      DO J = IPOL,1, -1<a name='1157'>
         PEXP = (1. + PEXP)* BFAC * ESDCX / REAL (J +1)<a name='1158'>
      END DO<a name='1159'>
<a name='1160'>
      PEXP = PEXP + 1.<a name='1161'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1162'></font>
<font color=#447700>! ABOVE LINE ENDS POLYNOMIAL SUBSTITUTION<a name='1163'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1164'></font>
<font color=#447700>!     END OF KOREAN FORMULATION<a name='1165'></font>
<a name='1166'>
<font color=#447700>!     BASE FORMULATION (COGLEY ET AL., 1990)<a name='1167'></font>
<font color=#447700>!     CONVERT DENSITY FROM G/CM3 TO KG/M3<a name='1168'></font>
<font color=#447700>!       DSM=SNDENS*1000.0<a name='1169'></font>
<a name='1170'>
<font color=#447700>!       DSX=DSM+DTSEC*0.5*DSM*G*ESD/<a name='1171'></font>
<font color=#447700>!    &amp;      (1E7*EXP(-0.02*DSM+KN/(TAVGC+273.16)-14.643))<a name='1172'></font>
<a name='1173'>
<font color=#447700>!  &amp;   CONVERT DENSITY FROM KG/M3 TO G/CM3<a name='1174'></font>
<font color=#447700>!       DSX=DSX/1000.0<a name='1175'></font>
<a name='1176'>
<font color=#447700>!     END OF COGLEY ET AL. FORMULATION<a name='1177'></font>
<a name='1178'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1179'></font>
<font color=#447700>! SET UPPER/LOWER LIMIT ON SNOW DENSITY<a name='1180'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1181'></font>
      DSX = SNDENS * (PEXP)<a name='1182'>
      IF (DSX &gt; 0.40) DSX = 0.40<a name='1183'>
      IF (DSX &lt; 0.05) DSX = 0.05<a name='1184'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1185'></font>
<font color=#447700>! UPDATE OF SNOW DEPTH AND DENSITY DEPENDING ON LIQUID WATER DURING<a name='1186'></font>
<font color=#447700>! SNOWMELT.  ASSUMED THAT 13% OF LIQUID WATER CAN BE STORED IN SNOW PER<a name='1187'></font>
<font color=#447700>! DAY DURING SNOWMELT TILL SNOW DENSITY 0.40.<a name='1188'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1189'></font>
      SNDENS = DSX<a name='1190'>
      IF (TSNOWC &gt;=  0.) THEN<a name='1191'>
         DW = 0.13* DTHR /24.<a name='1192'>
         SNDENS = SNDENS * (1. - DW) + DW<a name='1193'>
         IF (SNDENS &gt;=  0.40) SNDENS = 0.40<a name='1194'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1195'></font>
<font color=#447700>! CALCULATE SNOW DEPTH (CM) FROM SNOW WATER EQUIVALENT AND SNOW DENSITY.<a name='1196'></font>
<font color=#447700>! CHANGE SNOW DEPTH UNITS TO METERS<a name='1197'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1198'></font>
      END IF<a name='1199'>
      SNOWHC = ESDC / SNDENS<a name='1200'>
      SNOWH = SNOWHC *0.01<a name='1201'>
<a name='1202'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1203'></font>
  END SUBROUTINE SNOWPACK<a name='1204'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1205'></font>
<a name='1206'>
<A NAME='SNOWZ0'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SNOWZ0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1207'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWZ0</font> (SNCOVR,Z0, Z0BRD, SNOWH) <A href='../../call_to/SNOWZ0.html' TARGET='index'>4</A><a name='1208'>
<a name='1209'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1210'></font>
<font color=#447700>! SUBROUTINE SNOWZ0<a name='1211'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1212'></font>
<font color=#447700>! CALCULATE TOTAL ROUGHNESS LENGTH OVER SNOW<a name='1213'></font>
<font color=#447700>! SNCOVR  FRACTIONAL SNOW COVER<a name='1214'></font>
<font color=#447700>! Z0      ROUGHNESS LENGTH (m)<a name='1215'></font>
<font color=#447700>! Z0S     SNOW ROUGHNESS LENGTH:=0.001 (m)<a name='1216'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1217'></font>
      IMPLICIT NONE<a name='1218'>
      REAL, INTENT(IN)        :: SNCOVR, Z0BRD<a name='1219'>
      REAL, INTENT(OUT)       :: Z0<a name='1220'>
      REAL, PARAMETER         :: Z0S=0.001<a name='1221'>
      REAL, INTENT(IN)        :: SNOWH<a name='1222'>
      REAL                    :: BURIAL<a name='1223'>
      REAL                    :: Z0EFF<a name='1224'>
<a name='1225'>
<font color=#447700>!m      Z0 = (1.- SNCOVR)* Z0BRD + SNCOVR * Z0S<a name='1226'></font>
      BURIAL = 7.0*Z0BRD - SNOWH<a name='1227'>
      IF(BURIAL.LE.0.0007) THEN<a name='1228'>
        Z0EFF = Z0S<a name='1229'>
      ELSE      <a name='1230'>
        Z0EFF = BURIAL/7.0<a name='1231'>
      ENDIF<a name='1232'>
      <a name='1233'>
      Z0 = (1.- SNCOVR)* Z0BRD + SNCOVR * Z0EFF<a name='1234'>
<a name='1235'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1236'></font>
  END SUBROUTINE SNOWZ0<a name='1237'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1238'></font>
<a name='1239'>
<a name='1240'>
<A NAME='SNOW_NEW'><A href='../../html_code/phys/module_sf_noah_seaice.F.html#SNOW_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1241'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOW_NEW</font> (TEMP,NEWSN,SNOWH,SNDENS) <A href='../../call_to/SNOW_NEW.html' TARGET='index'>3</A><a name='1242'>
<a name='1243'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1244'></font>
<font color=#447700>! SUBROUTINE SNOW_NEW<a name='1245'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1246'></font>
<font color=#447700>! CALCULATE SNOW DEPTH AND DENSITY TO ACCOUNT FOR THE NEW SNOWFALL.<a name='1247'></font>
<font color=#447700>! NEW VALUES OF SNOW DEPTH &amp; DENSITY RETURNED.<a name='1248'></font>
<a name='1249'>
<font color=#447700>! TEMP    AIR TEMPERATURE (K)<a name='1250'></font>
<font color=#447700>! NEWSN   NEW SNOWFALL (M)<a name='1251'></font>
<font color=#447700>! SNOWH   SNOW DEPTH (M)<a name='1252'></font>
<font color=#447700>! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)<a name='1253'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1254'></font>
      IMPLICIT NONE<a name='1255'>
      REAL, INTENT(IN)        :: NEWSN, TEMP<a name='1256'>
      REAL, INTENT(INOUT)     :: SNDENS, SNOWH<a name='1257'>
      REAL                    :: DSNEW, HNEWC, SNOWHC,NEWSNC,TEMPC<a name='1258'>
<a name='1259'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1260'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS<a name='1261'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1262'></font>
      SNOWHC = SNOWH *100.<a name='1263'>
      NEWSNC = NEWSN *100.<a name='1264'>
<a name='1265'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1266'></font>
<font color=#447700>! CALCULATING NEW SNOWFALL DENSITY DEPENDING ON TEMPERATURE<a name='1267'></font>
<font color=#447700>! EQUATION FROM GOTTLIB L. 'A GENERAL RUNOFF MODEL FOR SNOWCOVERED<a name='1268'></font>
<font color=#447700>! AND GLACIERIZED BASIN', 6TH NORDIC HYDROLOGICAL CONFERENCE,<a name='1269'></font>
<font color=#447700>! VEMADOLEN, SWEDEN, 1980, 172-177PP.<a name='1270'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1271'></font>
      TEMPC = TEMP -273.15<a name='1272'>
      IF (TEMPC &lt;=  -15.) THEN<a name='1273'>
         DSNEW = 0.05<a name='1274'>
      ELSE<a name='1275'>
         DSNEW = 0.05+0.0017* (TEMPC +15.)**1.5<a name='1276'>
      END IF<a name='1277'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1278'></font>
<font color=#447700>! ADJUSTMENT OF SNOW DENSITY DEPENDING ON NEW SNOWFALL<a name='1279'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1280'></font>
      HNEWC = NEWSNC / DSNEW<a name='1281'>
      IF (SNOWHC + HNEWC .LT. 1.0E-3) THEN<a name='1282'>
         SNDENS = MAX(DSNEW,SNDENS)<a name='1283'>
      ELSE<a name='1284'>
         SNDENS = (SNOWHC * SNDENS + HNEWC * DSNEW)/ (SNOWHC + HNEWC)<a name='1285'>
      ENDIF<a name='1286'>
      SNOWHC = SNOWHC + HNEWC<a name='1287'>
      SNOWH = SNOWHC *0.01<a name='1288'>
<a name='1289'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1290'></font>
  END SUBROUTINE SNOW_NEW<a name='1291'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1292'></font>
<a name='1293'>
END MODULE module_sf_noah_seaice<a name='1294'>
</pre></body></html>