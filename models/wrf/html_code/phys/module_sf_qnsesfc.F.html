<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!----------------------------------------------------------------------<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_SF_QNSESFC'><A href='../../html_code/phys/module_sf_qnsesfc.F.html#MODULE_SF_QNSESFC' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
      <font color=#993300>MODULE </font><font color=#cc0000>MODULE_SF_QNSESFC</font> <A href='../../call_to/MODULE_SF_QNSESFC.html' TARGET='index'>3</A><a name='5'>
<font color=#447700>!<a name='6'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='7'></font>
<font color=#447700>!<a name='8'></font>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>MODULE_MODEL_CONSTANTS</A><A href='../../html_code/phys/module_sf_qnsesfc.F.html#module_sf_qnsesfc.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_100"><a name='9'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>MODULE_DM</A><A href='../../html_code/phys/module_sf_qnsesfc.F.html#module_sf_qnsesfc.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_164">, ONLY : WRF_DM_MAXVAL<a name='10'>
<font color=#447700>!<a name='11'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='12'></font>
<font color=#447700>!<a name='13'></font>
<font color=#447700>! REFERENCES:  Janjic (2002), NCEP Office Note 437<a name='14'></font>
<font color=#447700>!<a name='15'></font>
<font color=#447700>! ABSTRACT:<a name='16'></font>
<font color=#447700>!     MYJSFC GENERATES THE SURFACE EXCHANGE COEFFICIENTS FOR VERTICAL<a name='17'></font>
<font color=#447700>!     TURBULENT EXCHANGE BASED UPON MONIN_OBUKHOV THEORY WITH<a name='18'></font>
<font color=#447700>!     VARIOUS REFINEMENTS.<a name='19'></font>
<font color=#447700>!<a name='20'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='21'></font>
<font color=#447700>!<a name='22'></font>
      INTEGER :: ITRMX=5 <font color=#447700>! Iteration count for sfc layer computations<a name='23'></font>
<font color=#447700>!<a name='24'></font>
      REAL,PARAMETER :: EPSQ2L=0.01<a name='25'>
      REAL,PARAMETER :: VKARMAN=0.4<a name='26'>
      REAL,PARAMETER :: CAPA=R_D/CP,ELOCP=2.72E6/CP,RCAP=1./CAPA<a name='27'>
      REAL,PARAMETER :: GOCP02=G/CP*2.,GOCP10=G/CP*10.<a name='28'>
<font color=#447700>!      REAL,PARAMETER :: EPSU2=1.E-4,EPSUST=0.07,EPSZT=1.E-5<a name='29'></font>
<font color=#447700>!	ECMWF sets lower limit on ln(Z0h)=-20 --&gt; EPSZT=2.E-9<a name='30'></font>
      REAL,PARAMETER :: EPSU2=1.E-6,EPSUST=1.E-9,EPSZT=1.E-28<a name='31'>
      REAL,PARAMETER :: A2S=17.2693882,A3S=273.16,A4S=35.86<a name='32'>
      REAL,PARAMETER :: SEAFC=0.98,PQ0SEA=PQ0*SEAFC<a name='33'>
      REAL,PARAMETER :: BETA=1./273.,CZIL=0.1,EXCML=0.0001,EXCMS=0.0001  &amp;<a name='34'>
<font color=#447700>!old      REAL,PARAMETER :: BETA=1./273.,CZIL=0.1,EXCML=0.001,EXCMS=0.001  &amp;<a name='35'></font>
     &amp;                 ,GLKBR=10.,GLKBS=30.,PI=3.1415926               &amp;<a name='36'>
     &amp;                 ,QVISC=2.1E-5,RIC=0.505,SMALL=0.35              &amp;<a name='37'>
     &amp;                 ,SQPR=0.84,SQSC=0.84,SQVISC=258.2,TVISC=2.1E-5  &amp;<a name='38'>
     &amp;                 ,USTC=0.7,USTR=0.225,VISC=1.5E-5,FH=1.01        &amp;<a name='39'>
     &amp;                 ,WWST=1.2,ZTFC=0.1,TOPOFAC=9.0E-6<a name='40'>
<font color=#447700>!<a name='41'></font>
      REAL,PARAMETER :: BTG=BETA*G,CZIV=SMALL*GLKBS                    &amp;<a name='42'>
     &amp;                 ,GRRS=GLKBR/GLKBS                               &amp;<a name='43'>
     &amp;                 ,RTVISC=1./TVISC,RVISC=1./VISC                  &amp;<a name='44'>
     &amp;                 ,ZQRZT=SQSC/SQPR                                &amp;<a name='45'>
     &amp;                 ,FZQ1=RTVISC*QVISC*ZQRZT                        &amp;<a name='46'>
     &amp;                 ,FZQ2=RTVISC*QVISC*ZQRZT                        &amp;<a name='47'>
     &amp;                 ,FZT1=RVISC *TVISC*SQPR                         &amp;<a name='48'>
     &amp;                 ,FZT2=CZIV*GRRS*TVISC*SQPR                      &amp;<a name='49'>
     &amp;                 ,FZU1=CZIV*VISC                                 &amp;<a name='50'>
     &amp;                 ,PIHF=0.5*PI                                    &amp;<a name='51'>
     &amp;                 ,PRT0=0.72                                      &amp;<a name='52'>
     &amp;                 ,RQVISC=1./QVISC                                &amp;<a name='53'>
     &amp;                 ,USTFC=0.018/G                                  &amp;<a name='54'>
     &amp;                 ,WWST2=WWST*WWST                                &amp;<a name='55'>
     &amp;                 ,ZILFC=-CZIL*VKARMAN*SQVISC<a name='56'>
<font color=#447700>!<a name='57'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='58'></font>
      INTEGER, PARAMETER :: KZTM=10001,KZTM2=KZTM-2<a name='59'>
<font color=#447700>!<a name='60'></font>
      REAL :: DZETA1,DZETA2,FH01,FH02,ZTMAX1,ZTMAX2,ZTMIN1,ZTMIN2<a name='61'>
<font color=#447700>!<a name='62'></font>
      REAL,DIMENSION(KZTM) :: PSIH1,PSIH2,PSIM1,PSIM2<a name='63'>
<font color=#447700>!<a name='64'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='65'></font>
<font color=#447700>!<a name='66'></font>
CONTAINS<a name='67'>
<font color=#447700>!<a name='68'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='69'></font>
<A NAME='QNSESFC'><A href='../../html_code/phys/module_sf_qnsesfc.F.html#QNSESFC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='70'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>QNSESFC</font>(ITIMESTEP,HT,DZ                                &amp;  <A href='../../call_to/QNSESFC.html' TARGET='index'>3</A>,<A href='../../call_from/QNSESFC.html' TARGET='index'>1</A><a name='71'>
     &amp;                 ,PMID,PINT,TH,T,QV,QC,U,V,Q2                    &amp;<a name='72'>
     &amp;                 ,TSK,QSFC,THZ0,QZ0,UZ0,VZ0                      &amp;<a name='73'>
     &amp;                 ,LOWLYR,XLAND                                   &amp;<a name='74'>
     &amp;                 ,USTAR,ZNT,Z0BASE,PBLH,MAVAIL,RMOL              &amp;<a name='75'>
     &amp;                 ,AKHS,AKMS                                      &amp;<a name='76'>
     &amp;                 ,RIB                                            &amp;<a name='77'>
     &amp;                 ,CHS,CHS2,CQS2,HFX,QFX,FLX_LH,FLHC,FLQC         &amp;<a name='78'>
     &amp;                 ,QGH,CPM,CT                                     &amp;<a name='79'>
     &amp;                 ,U10,V10,T02,TH02,TSHLTR,TH10,Q02,QSHLTR,Q10,PSHLTR          &amp;<a name='80'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='81'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='82'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE,SCM_FORCE_FLUX  )<a name='83'>
<font color=#447700>!----------------------------------------------------------------------<a name='84'></font>
<font color=#447700>!<a name='85'></font>
      IMPLICIT NONE<a name='86'>
<font color=#447700>!<a name='87'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='88'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='89'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='90'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='91'>
<font color=#447700>!<a name='92'></font>
      INTEGER,INTENT(IN) :: ITIMESTEP<a name='93'>
<font color=#447700>!<a name='94'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: LOWLYR<a name='95'>
<font color=#447700>!<a name='96'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: HT,MAVAIL,TSK      &amp;<a name='97'>
     &amp;                                             ,XLAND,Z0BASE<a name='98'>
<font color=#447700>!<a name='99'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: DZ         &amp;<a name='100'>
     &amp;                                                     ,PMID,PINT  &amp;<a name='101'>
     &amp;                                                     ,Q2,QC,QV   &amp;<a name='102'>
     &amp;                                                     ,T,TH       &amp;<a name='103'>
     &amp;                                                     ,U,V   <a name='104'>
<font color=#447700>!<a name='105'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: PSHLTR,Q10,QSHLTR &amp;<a name='106'>
     &amp;                                              ,TH10,TSHLTR,T02   &amp;<a name='107'>
     &amp;                                              ,U10,V10,TH02,Q02<a name='108'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: FLX_LH,HFX,QFX <a name='109'>
<font color=#447700>!<a name='110'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: AKHS,AKMS       &amp;<a name='111'>
     &amp;                                                ,PBLH,QSFC<a name='112'>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT)   :: RIB<a name='113'>
<font color=#447700>!<a name='114'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: QZ0,RMOL,THZ0   &amp;<a name='115'>
     &amp;                                                ,USTAR,UZ0,VZ0   &amp;<a name='116'>
     &amp;                                                ,ZNT<a name='117'>
<font color=#447700>!<a name='118'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(OUT) :: CHS,CHS2,CQS2     &amp;<a name='119'>
     &amp;                                              ,CPM,CT,FLHC,FLQC  &amp;<a name='120'>
     &amp;                                              ,QGH <a name='121'>
<a name='122'>
     INTEGER,  OPTIONAL,  INTENT(IN )   ::     SCM_FORCE_FLUX  <font color=#447700>! JP <a name='123'></font>
<a name='124'>
<font color=#447700>!----------------------------------------------------------------------<a name='125'></font>
<font color=#447700>!***<a name='126'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='127'></font>
<font color=#447700>!***<a name='128'></font>
      INTEGER :: I,J,K,KFLIP,LMH,LPBL,NTSD<a name='129'>
<font color=#447700>!<a name='130'></font>
      REAL :: A,APESFC,B,BTGX,CWMLOW                                   &amp;<a name='131'>
     &amp;       ,DQDT,DTDIF,DTDT,DUDT,DVDT                                &amp;<a name='132'>
     &amp;       ,FIS                                                      &amp;<a name='133'>
     &amp;       ,P02P,P10P,PLOW,PSFC,PTOP,QLOW,QS02,QS10                  &amp;<a name='134'>
     &amp;       ,RAPA,RAPA02,RAPA10,RATIOMX,RDZ,SEAMASK,SM                &amp;<a name='135'>
     &amp;       ,T02P,T10P,TEM,TH02P,TH10P,THLOW,THELOW,THM               &amp;<a name='136'>
     &amp;       ,TLOW,TZ0,ULOW,VLOW,ZSL<a name='137'>
<font color=#447700>!<a name='138'></font>
      REAL,DIMENSION(KTS:KTE) :: CWMK,PK,Q2K,QK,THEK,THK,TK,UK,VK<a name='139'>
<font color=#447700>!<a name='140'></font>
      REAL,DIMENSION(KTS:KTE-1) :: EL,ELM<a name='141'>
<font color=#447700>!<a name='142'></font>
      REAL,DIMENSION(KTS:KTE+1) :: ZHK<a name='143'>
<font color=#447700>!<a name='144'></font>
      REAL,DIMENSION(ITS:ITE,JTS:JTE) :: THSK<a name='145'>
<font color=#447700>!<a name='146'></font>
      REAL,DIMENSION(ITS:ITE,KTS:KTE+1,JTS:JTE) :: ZINT<a name='147'>
<font color=#447700>!<a name='148'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='149'></font>
<font color=#447700>!**********************************************************************<a name='150'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='151'></font>
<font color=#447700>!<a name='152'></font>
<font color=#447700>!***  MAKE PREPARATIONS<a name='153'></font>
<font color=#447700>!<a name='154'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='155'></font>
      DO J=JTS,JTE<a name='156'>
      DO K=KTS,KTE+1<a name='157'>
      DO I=ITS,ITE<a name='158'>
        ZINT(I,K,J)=0.<a name='159'>
      ENDDO<a name='160'>
      ENDDO<a name='161'>
      ENDDO<a name='162'>
<font color=#447700>!<a name='163'></font>
      DO J=JTS,JTE<a name='164'>
      DO I=ITS,ITE<a name='165'>
        ZINT(I,KTE+1,J)=HT(I,J)     <font color=#447700>! Z at bottom of lowest sigma layer<a name='166'></font>
        PBLH(I,J)=-1.<a name='167'>
<font color=#447700>!<a name='168'></font>
<font color=#447700>!!!!!!!!!<a name='169'></font>
<font color=#447700>!!!!!! UNCOMMENT THESE LINES IF USING ETA COORDINATES<a name='170'></font>
<font color=#447700>!!!!!!!!!<a name='171'></font>
<font color=#447700>!!!!!!  ZINT(I,KTE+1,J)=1.E-4       ! Z of bottom of lowest eta layer<a name='172'></font>
<font color=#447700>!!!!!!  ZHK(KTE+1)=1.E-4            ! Z of bottom of lowest eta layer<a name='173'></font>
<font color=#447700>!<a name='174'></font>
      ENDDO<a name='175'>
      ENDDO<a name='176'>
<font color=#447700>!<a name='177'></font>
      DO J=JTS,JTE<a name='178'>
      DO K=KTE,KTS,-1<a name='179'>
        KFLIP=KTE+1-K<a name='180'>
        DO I=ITS,ITE<a name='181'>
          ZINT(I,K,J)=ZINT(I,K+1,J)+DZ(I,KFLIP,J)<a name='182'>
        ENDDO<a name='183'>
      ENDDO<a name='184'>
      ENDDO<a name='185'>
<font color=#447700>!<a name='186'></font>
      NTSD=ITIMESTEP<a name='187'>
<font color=#447700>!<a name='188'></font>
      IF(NTSD==1)THEN<a name='189'>
        DO J=JTS,JTE<a name='190'>
        DO I=ITS,ITE<a name='191'>
          USTAR(I,J)=0.1<a name='192'>
          FIS=HT(I,J)*G<a name='193'>
          SM=XLAND(I,J)-1.<a name='194'>
<font color=#447700>!!!       Z0(I,J)=SM*Z0SEA+(1.-SM)*(Z0(I,J)*Z0MAX+FIS*FCM+Z0LAND)<a name='195'></font>
<font color=#447700>!!!       ZNT(I,J)=SM*Z0SEA+(1.-SM)*(ZNT(I,J)*Z0MAX+FIS*FCM+Z0LAND)<a name='196'></font>
        ENDDO<a name='197'>
        ENDDO<a name='198'>
      ENDIF<a name='199'>
<font color=#447700>!<a name='200'></font>
<font color=#447700>!!!!  IF(NTSD==1)THEN<a name='201'></font>
        DO J=JTS,JTE<a name='202'>
        DO I=ITS,ITE<a name='203'>
          CT(I,J)=0.<a name='204'>
        ENDDO<a name='205'>
        ENDDO<a name='206'>
<font color=#447700>!!!!  ENDIF<a name='207'></font>
<font color=#447700>!<a name='208'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='209'></font>
        setup_integration:  DO J=JTS,JTE<a name='210'>
<font color=#447700>!----------------------------------------------------------------------<a name='211'></font>
<font color=#447700>!<a name='212'></font>
        DO I=ITS,ITE<a name='213'>
<font color=#447700>!<a name='214'></font>
<font color=#447700>!***  LOWEST LAYER ABOVE GROUND MUST BE FLIPPED<a name='215'></font>
<font color=#447700>!<a name='216'></font>
          LMH=KTE-LOWLYR(I,J)+1<a name='217'>
<font color=#447700>!<a name='218'></font>
          PTOP=PINT(I,KTE+1,J)      <font color=#447700>! KTE+1=KME<a name='219'></font>
          PSFC=PINT(I,LOWLYR(I,J),J)<a name='220'>
<font color=#447700>! Define THSK here (for first timestep mostly)<a name='221'></font>
          THSK(I,J)=TSK(I,J)/(PSFC*1.E-5)**CAPA<a name='222'>
<font color=#447700>!<a name='223'></font>
<font color=#447700>!***  CONVERT LAND MASK (1 FOR SEA; 0 FOR LAND)<a name='224'></font>
<font color=#447700>!<a name='225'></font>
          SEAMASK=XLAND(I,J)-1.<a name='226'>
<font color=#447700>!<a name='227'></font>
<font color=#447700>!***  FILL 1-D VERTICAL ARRAYS<a name='228'></font>
<font color=#447700>!***  AND FLIP DIRECTION SINCE MYJ SCHEME<a name='229'></font>
<font color=#447700>!***  COUNTS DOWNWARD FROM THE DOMAIN'S TOP<a name='230'></font>
<font color=#447700>!<a name='231'></font>
          DO K=KTE,KTS,-1<a name='232'>
            KFLIP=KTE+1-K<a name='233'>
            THK(K)=TH(I,KFLIP,J)<a name='234'>
            TK(K)=T(I,KFLIP,J)<a name='235'>
            RATIOMX=QV(I,KFLIP,J)<a name='236'>
            QK(K)=RATIOMX/(1.+RATIOMX)<a name='237'>
            PK(K)=PMID(I,KFLIP,J)<a name='238'>
            CWMK(K)=QC(I,KFLIP,J)<a name='239'>
            THEK(K)=(CWMK(K)*(-ELOCP/TK(K))+1.)*THK(K)<a name='240'>
            Q2K(K)=2.*Q2(I,KFLIP,J)<a name='241'>
<font color=#447700>!<a name='242'></font>
<font color=#447700>!<a name='243'></font>
<font color=#447700>!***  COMPUTE THE HEIGHTS OF THE LAYER INTERFACES<a name='244'></font>
<font color=#447700>!<a name='245'></font>
            ZHK(K)=ZINT(I,K,J)<a name='246'>
<font color=#447700>!<a name='247'></font>
          ENDDO<a name='248'>
          ZHK(KTE+1)=HT(I,J)          <font color=#447700>! Z at bottom of lowest sigma layer<a name='249'></font>
<font color=#447700>!<a name='250'></font>
          DO K=KTE,KTS,-1<a name='251'>
            KFLIP=KTE+1-K<a name='252'>
            UK(K)=U(I,KFLIP,J)<a name='253'>
            VK(K)=V(I,KFLIP,J)<a name='254'>
          ENDDO<a name='255'>
<font color=#447700>!<a name='256'></font>
<font color=#447700>!***  FIND THE HEIGHT OF THE PBL<a name='257'></font>
<font color=#447700>!<a name='258'></font>
          LPBL=LMH<a name='259'>
          DO K=LMH-1,1,-1<a name='260'>
            IF(Q2K(K)&lt;=EPSQ2L*FH) THEN<a name='261'>
              LPBL=K<a name='262'>
              GO TO 110<a name='263'>
            ENDIF<a name='264'>
          ENDDO<a name='265'>
<font color=#447700>!<a name='266'></font>
          LPBL=1<a name='267'>
<font color=#447700>!<a name='268'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='269'></font>
<font color=#447700>!--------------THE HEIGHT OF THE PBL------------------------------------<a name='270'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='271'></font>
<font color=#447700>!<a name='272'></font>
 110      PBLH(I,J)=ZHK(LPBL)-ZHK(LMH+1)<a name='273'>
<font color=#447700>!<a name='274'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='275'></font>
<font color=#447700>!***<a name='276'></font>
<font color=#447700>!***  FIND THE SURFACE EXCHANGE COEFFICIENTS<a name='277'></font>
<font color=#447700>!***<a name='278'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='279'></font>
          PLOW=PK(LMH)<a name='280'>
          TLOW=TK(LMH)<a name='281'>
          THLOW=THK(LMH)<a name='282'>
          THELOW=THEK(LMH)<a name='283'>
          QLOW=QK(LMH)<a name='284'>
          CWMLOW=CWMK(LMH)<a name='285'>
          ULOW=UK(LMH)<a name='286'>
          VLOW=VK(LMH)<a name='287'>
          ZSL=(ZHK(LMH)-ZHK(LMH+1))*0.5<a name='288'>
          APESFC=(PSFC*1.E-5)**CAPA<a name='289'>
          TZ0=THZ0(I,J)*APESFC<a name='290'>
<font color=#447700>!<a name='291'></font>
          CALL <A href='../../html_code/phys/module_sf_qnsesfc.F.html#SFCDIF'>SFCDIF</A><A href='../../html_code/phys/module_sf_qnsesfc.F.html#QNSESFC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIF_2">(NTSD,SEAMASK,THSK(I,J),QSFC(I,J),PSFC            &amp;<a name='292'>
     &amp;               ,UZ0(I,J),VZ0(I,J),TZ0,THZ0(I,J),QZ0(I,J)         &amp;<a name='293'>
     &amp;               ,USTAR(I,J),ZNT(I,J),Z0BASE(I,J),CT(I,J),RMOL(I,J) &amp;<a name='294'>
     &amp;               ,AKMS(I,J),AKHS(I,J),RIB(I,J),PBLH(I,J),MAVAIL(I,J) &amp;<a name='295'>
     &amp;               ,CHS(I,J),CHS2(I,J),CQS2(I,J)                     &amp;<a name='296'>
     &amp;               ,HFX(I,J),QFX(I,J),FLX_LH(I,J)                    &amp;<a name='297'>
     &amp;               ,FLHC(I,J),FLQC(I,J),QGH(I,J),CPM(I,J)            &amp;<a name='298'>
     &amp;               ,ULOW,VLOW,TLOW,THLOW,THELOW,QLOW,CWMLOW          &amp;<a name='299'>
     &amp;               ,ZSL,PLOW                                         &amp;<a name='300'>
     &amp;               ,U10(I,J),V10(I,J),TSHLTR(I,J),TH10(I,J)          &amp;<a name='301'>
     &amp;               ,QSHLTR(I,J),Q10(I,J),PSHLTR(I,J)                 &amp;<a name='302'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                          &amp;<a name='303'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                          &amp;<a name='304'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE,i,j,ZHK(LMH+1)           &amp;<a name='305'>
     &amp;               ,SCM_FORCE_FLUX) <a name='306'>
<font color=#447700>!<a name='307'></font>
<a name='308'>
<font color=#447700>!***  REMOVE SUPERATURATION AT 2M AND 10M<a name='309'></font>
<font color=#447700>!<a name='310'></font>
          RAPA=APESFC<a name='311'>
          TH02P=TSHLTR(I,J)<a name='312'>
          TH10P=TH10(I,J)<a name='313'>
          TH02(I,J)=TSHLTR(I,J)    <font color=#447700>!emt<a name='314'></font>
         IF (SEAMASK.EQ.1.AND.I.EQ.170.AND.J.EQ.20) THEN<a name='315'>
          print*,'HFX_SEA_point',HFX(I,J)<a name='316'>
         END IF<a name='317'>
<font color=#447700>!<a name='318'></font>
          RAPA02=RAPA-GOCP02/TH02P<a name='319'>
          RAPA10=RAPA-GOCP10/TH10P<a name='320'>
<font color=#447700>!<a name='321'></font>
          T02P=TH02P*RAPA02<a name='322'>
          T10P=TH10P*RAPA10<a name='323'>
           T02(I,J) = TH02(I,J)*APESFC  <font color=#447700>!emt<a name='324'></font>
<font color=#447700>!<a name='325'></font>
<a name='326'>
          P02P=(RAPA02**RCAP)*1.E5<a name='327'>
          P10P=(RAPA10**RCAP)*1.E5<a name='328'>
<font color=#447700>!<a name='329'></font>
          QS02=PQ0/P02P*EXP(A2*(T02P-A3)/(T02P-A4))<a name='330'>
          QS10=PQ0/P10P*EXP(A2*(T10P-A3)/(T10P-A4))<a name='331'>
<font color=#447700>!<a name='332'></font>
          IF(QSHLTR(I,J)&gt;QS02)QSHLTR(I,J)=QS02<a name='333'>
          IF(Q10   (I,J)&gt;QS10)Q10   (I,J)=QS10<a name='334'>
           Q02(I,J)=QSHLTR(I,J)/(1.-QSHLTR(I,J))  <font color=#447700>!emt<a name='335'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='336'></font>
<font color=#447700>!<a name='337'></font>
        ENDDO<a name='338'>
<font color=#447700>!<a name='339'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='340'></font>
      ENDDO setup_integration<a name='341'>
<font color=#447700>!----------------------------------------------------------------------<a name='342'></font>
 <a name='343'>
      END SUBROUTINE QNSESFC<a name='344'>
<font color=#447700>!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<a name='345'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='346'></font>
<A NAME='SFCDIF'><A href='../../html_code/phys/module_sf_qnsesfc.F.html#SFCDIF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='347'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCDIF</font>(NTSD,SEAMASK,THS,QS,PSFC                       &amp; <A href='../../call_to/SFCDIF.html' TARGET='index'>2</A><a name='348'>
     &amp;                 ,UZ0,VZ0,TZ0,THZ0,QZ0                           &amp;<a name='349'>
     &amp;                 ,USTAR,Z0,Z0BASE,CT,RLMO,AKMS,AKHS,RIB,PBLH,WETM &amp;<a name='350'>
     &amp;                 ,CHS,CHS2,CQS2,HFX,QFX,FLX_LH,FLHC,FLQC,QGH,CPM &amp;<a name='351'>
     &amp;                 ,ULOW,VLOW,TLOW,THLOW,THELOW,QLOW,CWMLOW        &amp;<a name='352'>
     &amp;                 ,ZSL,PLOW                                       &amp;<a name='353'>
     &amp;                 ,U10,V10,TH02,TH10,Q02,Q10,PSHLTR               &amp;<a name='354'>
     &amp;                 ,IDS,IDE,JDS,JDE,KDS,KDE                        &amp;<a name='355'>
     &amp;                 ,IMS,IME,JMS,JME,KMS,KME                        &amp;<a name='356'>
     &amp;                 ,ITS,ITE,JTS,JTE,KTS,KTE,i,j,ZSFC,SCM_FORCE_FLUX)<a name='357'>
<font color=#447700>!     ****************************************************************<a name='358'></font>
<font color=#447700>!     *                                                              *<a name='359'></font>
<font color=#447700>!     *                       SURFACE LAYER                          *<a name='360'></font>
<font color=#447700>!     *                                                              *<a name='361'></font>
<font color=#447700>!     ****************************************************************<a name='362'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='363'></font>
<font color=#447700>!<a name='364'></font>
      IMPLICIT NONE<a name='365'>
<font color=#447700>!<a name='366'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='367'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='368'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='369'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE,i,j<a name='370'>
<font color=#447700>!<a name='371'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='372'>
<font color=#447700>!<a name='373'></font>
      REAL,INTENT(IN) :: CWMLOW,PBLH,PLOW,QLOW,PSFC,SEAMASK,ZSFC       &amp;<a name='374'>
     &amp;                  ,THELOW,THLOW,THS,TLOW,ULOW,VLOW,WETM,ZSL  &amp;<a name='375'>
     &amp;                  ,Z0BASE<a name='376'>
<font color=#447700>!<a name='377'></font>
      REAL,INTENT(OUT) :: CHS,CHS2,CPM,CQS2,CT,FLHC,FLQC,    &amp;<a name='378'>
     &amp;                   PSHLTR,Q02,Q10,QGH,RIB,RLMO,TH02,TH10,U10,V10<a name='379'>
<font color=#447700>!<a name='380'></font>
      REAL,INTENT(INOUT) :: FLX_LH,HFX,QFX  <a name='381'>
<font color=#447700>!<a name='382'></font>
      REAL,INTENT(INOUT) :: AKHS,AKMS,QZ0,THZ0,USTAR,UZ0,VZ0,Z0,QS,TZ0<a name='383'>
<a name='384'>
      INTEGER,  OPTIONAL,  INTENT(IN )   ::     SCM_FORCE_FLUX<a name='385'>
<a name='386'>
<font color=#447700>!----------------------------------------------------------------------<a name='387'></font>
<font color=#447700>!***<a name='388'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='389'></font>
<font color=#447700>!***<a name='390'></font>
      INTEGER :: ITR,K<a name='391'>
<font color=#447700>!<a name='392'></font>
      REAL :: A,B,BTGH,BTGX,CXCHL,CXCHS,DTHV,DU2,ELFC,FCT              &amp;<a name='393'>
     &amp;       ,HLFLX,HSFLX,HV,PSH02,PSH10,PSHZ,PSHZL,PSM10,PSMZ,PSMZL   &amp;<a name='394'>
     &amp;       ,RDZ,RDZT,RLMA,RLMN,RLMP                                  &amp;<a name='395'>
     &amp;       ,RLOGT,RLOGU,RWGH,RZ,RZST,RZSU,SIMH,SIMM,TEM,THM          &amp;<a name='396'>
     &amp;       ,UMFLX,USTARK,VMFLX,WGHT,WGHTT,WGHTQ,WSTAR2               &amp;<a name='397'>
     &amp;       ,X,XLT,XLT4,XLU,XLU4,XT,XT4,XU,XU4,ZETALT,ZETALU          &amp;<a name='398'>
     &amp;       ,ZETAT,ZETAU,ZQ,ZSLT,ZSLU,ZT,ZU,TOPOTERM,ZZIL<a name='399'>
<font color=#447700>!<a name='400'></font>
<font color=#447700>!***  DIAGNOSTICS<a name='401'></font>
<font color=#447700>!<a name='402'></font>
      REAL :: AKHS02,AKHS10,AKMS02,AKMS10,EKMS10,QSAT10,QSAT2          &amp;<a name='403'>
     &amp;       ,RLNT02,RLNT10,RLNU10,SIMH02,SIMH10,SIMM10,T02,T10        &amp;<a name='404'>
     &amp;       ,TERM1,RLOW,U10E,V10E,WSTAR,XLT02,XLT024,XLT10            &amp;<a name='405'>
     &amp;       ,XLT104,XLU10,XLU104,XU10,XU104,ZT02,ZT10,ZTAT02,ZTAT10   &amp;<a name='406'>
     &amp;       ,ZTAU,ZTAU10,ZU10,ZUUZ<a name='407'>
<font color=#447700>!----------------------------------------------------------------------<a name='408'></font>
<font color=#447700>!**********************************************************************<a name='409'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='410'></font>
      RDZ=1./ZSL<a name='411'>
      CXCHL=EXCML*RDZ<a name='412'>
      CXCHS=EXCMS*RDZ<a name='413'>
<font color=#447700>!<a name='414'></font>
      BTGX=G/THLOW<a name='415'>
      ELFC=VKARMAN*BTGX<a name='416'>
<font color=#447700>!<a name='417'></font>
      IF(PBLH&gt;1000.)THEN<a name='418'>
        BTGH=BTGX*PBLH<a name='419'>
      ELSE<a name='420'>
        BTGH=BTGX*1000.<a name='421'>
      ENDIF<a name='422'>
<a name='423'>
      RLOW=PLOW/(R_D*TLOW)<a name='424'>
<font color=#447700>!<a name='425'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='426'></font>
<font color=#447700>!<a name='427'></font>
<font color=#447700>!***  SEA POINTS<a name='428'></font>
<font color=#447700>!<a name='429'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='430'></font>
<font color=#447700>!<a name='431'></font>
      IF(SEAMASK&gt;0.5)THEN <a name='432'>
<font color=#447700>!<a name='433'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='434'></font>
        DO ITR=1,ITRMX<a name='435'>
<font color=#447700>!----------------------------------------------------------------------<a name='436'></font>
          Z0=MAX(USTFC*USTAR*USTAR,1.59E-5)<a name='437'>
<font color=#447700>!<a name='438'></font>
<font color=#447700>!***  VISCOUS SUBLAYER, JANJIC MWR 1994<a name='439'></font>
<font color=#447700>!<a name='440'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='441'></font>
          IF(USTAR&lt;USTC)THEN<a name='442'>
<font color=#447700>!----------------------------------------------------------------------<a name='443'></font>
<font color=#447700>!<a name='444'></font>
            IF(USTAR&lt;USTR)THEN<a name='445'>
<font color=#447700>!<a name='446'></font>
              IF(NTSD==1)THEN<a name='447'>
                AKMS=CXCHS<a name='448'>
                AKHS=CXCHS<a name='449'>
                QS=QLOW<a name='450'>
              ENDIF<a name='451'>
<font color=#447700>!<a name='452'></font>
              ZU=FZU1*SQRT(SQRT(Z0*USTAR*RVISC))/USTAR<a name='453'>
              WGHT=AKMS*ZU*RVISC<a name='454'>
              RWGH=WGHT/(WGHT+1.)<a name='455'>
              UZ0=(ULOW*RWGH+UZ0)*0.5<a name='456'>
              VZ0=(VLOW*RWGH+VZ0)*0.5<a name='457'>
<font color=#447700>!<a name='458'></font>
              ZT=FZT1*ZU<a name='459'>
              ZQ=FZQ1*ZT<a name='460'>
              WGHTT=AKHS*ZT*RTVISC<a name='461'>
              WGHTQ=AKHS*ZQ*RQVISC<a name='462'>
<font color=#447700>!<a name='463'></font>
              IF(NTSD&gt;1)THEN<a name='464'>
                THZ0=((WGHTT*THLOW+THS)/(WGHTT+1.)+THZ0)*0.5<a name='465'>
                QZ0=((WGHTQ*QLOW+QS)/(WGHTQ+1.)+QZ0)*0.5<a name='466'>
              ELSE<a name='467'>
                THZ0=(WGHTT*THLOW+THS)/(WGHTT+1.)            <a name='468'>
                QZ0=(WGHTQ*QLOW+QS)/(WGHTQ+1.)<a name='469'>
              ENDIF<a name='470'>
<font color=#447700>!<a name='471'></font>
            ENDIF<a name='472'>
<font color=#447700>!<a name='473'></font>
            IF(USTAR&gt;=USTR.AND.USTAR&lt;USTC)THEN<a name='474'>
              ZU=Z0<a name='475'>
              UZ0=0.<a name='476'>
              VZ0=0.<a name='477'>
<font color=#447700>!<a name='478'></font>
              ZT=FZT2*SQRT(SQRT(Z0*USTAR*RVISC))/USTAR<a name='479'>
              ZQ=FZQ2*ZT<a name='480'>
              WGHTT=AKHS*ZT*RTVISC<a name='481'>
              WGHTQ=AKHS*ZQ*RQVISC<a name='482'>
<font color=#447700>!<a name='483'></font>
              IF(NTSD&gt;1)THEN<a name='484'>
                THZ0=((WGHTT*THLOW+THS)/(WGHTT+1.)+THZ0)*0.5<a name='485'>
                QZ0=((WGHTQ*QLOW+QS)/(WGHTQ+1.)+QZ0)*0.5<a name='486'>
              ELSE<a name='487'>
                THZ0=(WGHTT*THLOW+THS)/(WGHTT+1.)<a name='488'>
                QZ0=(WGHTQ*QLOW+QS)/(WGHTQ+1.)<a name='489'>
              ENDIF<a name='490'>
<font color=#447700>!<a name='491'></font>
            ENDIF<a name='492'>
<font color=#447700>!----------------------------------------------------------------------<a name='493'></font>
          ELSE<a name='494'>
<font color=#447700>!----------------------------------------------------------------------<a name='495'></font>
            ZU=Z0<a name='496'>
            UZ0=0.<a name='497'>
            VZ0=0.<a name='498'>
<font color=#447700>!<a name='499'></font>
            ZT=Z0<a name='500'>
            THZ0=THS<a name='501'>
<font color=#447700>!<a name='502'></font>
            ZQ=Z0<a name='503'>
            QZ0=QS<a name='504'>
<font color=#447700>!----------------------------------------------------------------------<a name='505'></font>
          ENDIF<a name='506'>
<font color=#447700>!----------------------------------------------------------------------<a name='507'></font>
          TEM=(TLOW+TZ0)*0.5<a name='508'>
          THM=(THELOW+THZ0)*0.5<a name='509'>
<font color=#447700>!<a name='510'></font>
          A=THM*P608<a name='511'>
          B=(ELOCP/TEM-1.-P608)*THM<a name='512'>
<font color=#447700>!<a name='513'></font>
          DTHV=((THELOW-THZ0)*((QLOW+QZ0+CWMLOW)*(0.5*P608)+1.)        &amp;<a name='514'>
     &amp;        +(QLOW-QZ0+CWMLOW)*A+CWMLOW*B) <a name='515'>
<font color=#447700>!<a name='516'></font>
          DU2=MAX((ULOW-UZ0)**2+(VLOW-VZ0)**2,EPSU2)<a name='517'>
          RIB=BTGX*DTHV*ZSL/DU2<a name='518'>
<font color=#447700>!----------------------------------------------------------------------<a name='519'></font>
<font color=#447700>!         IF(RIB&gt;=RIC)THEN<a name='520'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='521'></font>
<font color=#447700>!           AKMS=MAX( VISC*RDZ,CXCHS)<a name='522'></font>
<font color=#447700>!           AKHS=MAX(TVISC*RDZ,CXCHS)<a name='523'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='524'></font>
<font color=#447700>!         ELSE  !  turbulent branch<a name='525'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='526'></font>
            ZSLU=ZSL+ZU<a name='527'>
            ZSLT=ZSL+ZT<a name='528'>
<font color=#447700>!<a name='529'></font>
            RZSU=ZSLU/ZU<a name='530'>
            RZST=ZSLT/ZT<a name='531'>
<font color=#447700>!<a name='532'></font>
            RLOGU=LOG(RZSU)<a name='533'>
            RLOGT=LOG(RZST)<a name='534'>
<font color=#447700>!<a name='535'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='536'></font>
<font color=#447700>!***  1./MONIN-OBUKHOV LENGTH<a name='537'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='538'></font>
<font color=#447700>!<a name='539'></font>
            RLMO=ELFC*AKHS*DTHV/USTAR**3<a name='540'>
<font color=#447700>!<a name='541'></font>
            ZETALU=ZSLU*RLMO<a name='542'>
            ZETALT=ZSLT*RLMO<a name='543'>
            ZETAU=ZU*RLMO<a name='544'>
            ZETAT=ZT*RLMO<a name='545'>
<font color=#447700>!<a name='546'></font>
            ZETALU=MIN(MAX(ZETALU,ZTMIN1),ZTMAX1)<a name='547'>
            ZETALT=MIN(MAX(ZETALT,ZTMIN1),ZTMAX1)<a name='548'>
            ZETAU=MIN(MAX(ZETAU,ZTMIN1/RZSU),ZTMAX1/RZSU)<a name='549'>
            ZETAT=MIN(MAX(ZETAT,ZTMIN1/RZST),ZTMAX1/RZST)<a name='550'>
<font color=#447700>!<a name='551'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='552'></font>
<font color=#447700>!***   WATER FUNCTIONS<a name='553'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='554'></font>
<font color=#447700>!<a name='555'></font>
            RZ=(ZETAU-ZTMIN1)/DZETA1<a name='556'>
            K=INT(RZ)<a name='557'>
            RDZT=RZ-REAL(K)<a name='558'>
            K=MIN(K,KZTM2)<a name='559'>
            K=MAX(K,0)<a name='560'>
            PSMZ=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)    <font color=#447700>!Interpolation from the table<a name='561'></font>
<font color=#447700>!<a name='562'></font>
            RZ=(ZETALU-ZTMIN1)/DZETA1<a name='563'>
            K=INT(RZ)<a name='564'>
            RDZT=RZ-REAL(K)<a name='565'>
            K=MIN(K,KZTM2)<a name='566'>
            K=MAX(K,0)<a name='567'>
            PSMZL=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)<a name='568'>
<font color=#447700>!<a name='569'></font>
            SIMM=PSMZL-PSMZ+RLOGU<a name='570'>
<font color=#447700>!<a name='571'></font>
            RZ=(ZETAT-ZTMIN1)/DZETA1<a name='572'>
            K=INT(RZ)<a name='573'>
            RDZT=RZ-REAL(K)<a name='574'>
            K=MIN(K,KZTM2)<a name='575'>
            K=MAX(K,0)<a name='576'>
            PSHZ=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='577'>
<font color=#447700>!<a name='578'></font>
            RZ=(ZETALT-ZTMIN1)/DZETA1<a name='579'>
            K=INT(RZ)<a name='580'>
            RDZT=RZ-REAL(K)<a name='581'>
            K=MIN(K,KZTM2)<a name='582'>
            K=MAX(K,0)<a name='583'>
            PSHZL=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='584'>
<font color=#447700>!<a name='585'></font>
            SIMH=(PSHZL-PSHZ+RLOGT)*PRT0<a name='586'>
<font color=#447700>!           SIMH=(PSHZL-PSHZ+RLOGT)*FH01<a name='587'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='588'></font>
            USTARK=USTAR*VKARMAN<a name='589'>
            AKMS=MAX(USTARK/SIMM,CXCHS)<a name='590'>
            AKHS=MAX(USTARK/SIMH,CXCHS)<a name='591'>
<font color=#447700>!<a name='592'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='593'></font>
<font color=#447700>!***  BELJAARS CORRECTION FOR USTAR (FOR CONVECTION)<a name='594'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='595'></font>
<font color=#447700>!<a name='596'></font>
            IF(DTHV&lt;=0.)THEN                                           <font color=#447700>!zj<a name='597'></font>
              WSTAR2=WWST2*ABS(BTGH*AKHS*DTHV)**(2./3.)                <font color=#447700>!zj<a name='598'></font>
            ELSE                                                       <font color=#447700>!zj<a name='599'></font>
              WSTAR2=0.                                                <font color=#447700>!zj<a name='600'></font>
            ENDIF                                                      <font color=#447700>!zj<a name='601'></font>
            USTAR=MAX(SQRT(AKMS*SQRT(DU2+WSTAR2)),EPSUST)<a name='602'>
<font color=#447700>!<a name='603'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='604'></font>
<font color=#447700>!         ENDIF  !  End of turbulent branch<a name='605'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='606'></font>
<font color=#447700>!<a name='607'></font>
        ENDDO  <font color=#447700>!  End of the iteration loop over sea points<a name='608'></font>
<font color=#447700>!<a name='609'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='610'></font>
<font color=#447700>!<a name='611'></font>
<font color=#447700>!***  LAND POINTS<a name='612'></font>
<font color=#447700>!<a name='613'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='614'></font>
<font color=#447700>!<a name='615'></font>
      ELSE  <a name='616'>
<font color=#447700>!<a name='617'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='618'></font>
        IF(NTSD==1)THEN<a name='619'>
          QS=QLOW<a name='620'>
        ENDIF<a name='621'>
<font color=#447700>!<a name='622'></font>
        ZU=Z0<a name='623'>
        UZ0=0.<a name='624'>
        VZ0=0.<a name='625'>
<font color=#447700>!<a name='626'></font>
        ZT=ZU*ZTFC<a name='627'>
        THZ0=THS<a name='628'>
<font color=#447700>!       RLOW=PLOW/(R_D*TLOW)          <a name='629'></font>
<font color=#447700>!<a name='630'></font>
        ZQ=ZT<a name='631'>
        QZ0=QS<a name='632'>
<font color=#447700>!----------------------------------------------------------------------<a name='633'></font>
        TEM=(TLOW+TZ0)*0.5<a name='634'>
        THM=(THELOW+THZ0)*0.5<a name='635'>
<font color=#447700>!<a name='636'></font>
        A=THM*P608<a name='637'>
        B=(ELOCP/TEM-1.-P608)*THM<a name='638'>
<font color=#447700>!<a name='639'></font>
        DTHV=((THELOW-THZ0)*((QLOW+QZ0+CWMLOW)*(0.5*P608)+1.)          &amp;<a name='640'>
     &amp;        +(QLOW-QZ0+CWMLOW)*A+CWMLOW*B) <a name='641'>
<font color=#447700>!<a name='642'></font>
        DU2=MAX((ULOW-UZ0)**2+(VLOW-VZ0)**2,EPSU2)<a name='643'>
        RIB=BTGX*DTHV*ZSL/DU2<a name='644'>
<font color=#447700>!----------------------------------------------------------------------<a name='645'></font>
<font color=#447700>!       IF(RIB&gt;=RIC)THEN<a name='646'></font>
<font color=#447700>!         AKMS=MAX( VISC*RDZ,CXCHL)<a name='647'></font>
<font color=#447700>!         AKHS=MAX(TVISC*RDZ,CXCHL)<a name='648'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='649'></font>
<font color=#447700>!       ELSE  !  Turbulent branch<a name='650'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='651'></font>
          ZSLU=ZSL+ZU<a name='652'>
<font color=#447700>!<a name='653'></font>
          RZSU=ZSLU/ZU<a name='654'>
<font color=#447700>!<a name='655'></font>
          RLOGU=LOG(RZSU)<a name='656'>
<a name='657'>
          ZSLT=ZSL+ZU <font color=#447700>! u,v and t are at the same level<a name='658'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='659'></font>
<font color=#447700>!<a name='660'></font>
<font color=#447700>!mp   Topo modification of ZILFC term<a name='661'></font>
<font color=#447700>!	<a name='662'></font>
          TOPOTERM=TOPOFAC*ZSFC**2.<a name='663'>
          TOPOTERM=MAX(TOPOTERM,3.0)<a name='664'>
<font color=#447700>!<a name='665'></font>
          IF(DTHV&gt;0.)THEN<a name='666'>
            ZZIL=ZILFC*TOPOTERM<a name='667'>
          ELSE<a name='668'>
            ZZIL=ZILFC<a name='669'>
          ENDIF<a name='670'>
<font color=#447700>!<a name='671'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='672'></font>
<font color=#447700>!<a name='673'></font>
          land_point_iteration: DO ITR=1,ITRMX<a name='674'>
<font color=#447700>!<a name='675'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='676'></font>
<font color=#447700>!***  ZILITINKEVITCH FIX FOR ZT<a name='677'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='678'></font>
<font color=#447700>!<a name='679'></font>
<font color=#447700>! oldform   ZT=MAX(EXP(ZZIL*SQRT(USTAR*ZU))*ZU,EPSZT)<a name='680'></font>
            ZT=MAX(EXP(ZZIL*SQRT(USTAR*Z0BASE))*Z0BASE,EPSZT)<a name='681'>
            ZT=MAX(ZT,ZU*ZTFC)               <font color=#447700>!Quick fix by S. Sukoriansky<a name='682'></font>
<font color=#447700>!<a name='683'></font>
            RZST=ZSLT/ZT<a name='684'>
            RLOGT=LOG(RZST)<a name='685'>
<font color=#447700>!<a name='686'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='687'></font>
<font color=#447700>!***  1./MONIN-OBUKHOV LENGTH-SCALE<a name='688'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='689'></font>
<font color=#447700>!<a name='690'></font>
            RLMO=ELFC*AKHS*DTHV/USTAR**3<a name='691'>
            ZETALU=ZSLU*RLMO<a name='692'>
            ZETALT=ZSLT*RLMO<a name='693'>
            ZETAU=ZU*RLMO<a name='694'>
            ZETAT=ZT*RLMO<a name='695'>
<font color=#447700>!<a name='696'></font>
            ZETALU=MIN(MAX(ZETALU,ZTMIN2),ZTMAX2)<a name='697'>
            ZETALT=MIN(MAX(ZETALT,ZTMIN2),ZTMAX2)<a name='698'>
            ZETAU=MIN(MAX(ZETAU,ZTMIN2/RZSU),ZTMAX2/RZSU)<a name='699'>
            ZETAT=MIN(MAX(ZETAT,ZTMIN2/RZST),ZTMAX2/RZST)<a name='700'>
<font color=#447700>!<a name='701'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='702'></font>
<font color=#447700>!***  LAND FUNCTIONS<a name='703'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='704'></font>
<font color=#447700>!<a name='705'></font>
            RZ=(ZETAU-ZTMIN2)/DZETA2<a name='706'>
            K=INT(RZ)<a name='707'>
            RDZT=RZ-REAL(K)<a name='708'>
            K=MIN(K,KZTM2)<a name='709'>
            K=MAX(K,0)<a name='710'>
            PSMZ=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='711'>
<font color=#447700>!<a name='712'></font>
            RZ=(ZETALU-ZTMIN2)/DZETA2<a name='713'>
            K=INT(RZ)<a name='714'>
            RDZT=RZ-REAL(K)<a name='715'>
            K=MIN(K,KZTM2)<a name='716'>
            K=MAX(K,0)<a name='717'>
            PSMZL=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='718'>
<font color=#447700>!<a name='719'></font>
            SIMM=PSMZL-PSMZ+RLOGU<a name='720'>
<font color=#447700>!<a name='721'></font>
            RZ=(ZETAT-ZTMIN2)/DZETA2<a name='722'>
            K=INT(RZ)<a name='723'>
            RDZT=RZ-REAL(K)<a name='724'>
            K=MIN(K,KZTM2)<a name='725'>
            K=MAX(K,0)<a name='726'>
            PSHZ=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='727'>
<font color=#447700>!<a name='728'></font>
            RZ=(ZETALT-ZTMIN2)/DZETA2<a name='729'>
            K=INT(RZ)<a name='730'>
            RDZT=RZ-REAL(K)<a name='731'>
            K=MIN(K,KZTM2)<a name='732'>
            K=MAX(K,0)<a name='733'>
            PSHZL=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='734'>
<font color=#447700>!<a name='735'></font>
            SIMH=(PSHZL-PSHZ+RLOGT)*PRT0<a name='736'>
<font color=#447700>!           SIMH=(PSHZL-PSHZ+RLOGT)*FH02<a name='737'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='738'></font>
            USTARK=USTAR*VKARMAN<a name='739'>
            AKMS=MAX(USTARK/SIMM,CXCHL)<a name='740'>
            AKHS=MAX(USTARK/SIMH,CXCHL)<a name='741'>
            THZ0=HFX/(AKHS*RLOW*CP)+THLOW<a name='742'>
            TZ0=(PSFC*1.E-5)**CAPA*THZ0<a name='743'>
<font color=#447700>!<a name='744'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='745'></font>
<font color=#447700>!***  BELJAARS CORRECTION FOR USTAR<a name='746'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='747'></font>
<font color=#447700>!<a name='748'></font>
            IF(DTHV&lt;=0.)THEN                                           <font color=#447700>!zj<a name='749'></font>
              WSTAR2=WWST2*ABS(BTGH*AKHS*DTHV)**(2./3.)                <font color=#447700>!zj<a name='750'></font>
            ELSE                                                       <font color=#447700>!zj<a name='751'></font>
              WSTAR2=0.                                                <font color=#447700>!zj<a name='752'></font>
            ENDIF                                                      <font color=#447700>!zj<a name='753'></font>
<font color=#447700>!<a name='754'></font>
            USTAR=MAX(SQRT(AKMS*SQRT(DU2+WSTAR2)),EPSUST)<a name='755'>
<font color=#447700>!<a name='756'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='757'></font>
          ENDDO land_point_iteration<a name='758'>
<font color=#447700>!----------------------------------------------------------------------<a name='759'></font>
<font color=#447700>!<a name='760'></font>
<font color=#447700>!       ENDIF  !  End of turbulant branch over land<a name='761'></font>
<font color=#447700>!<a name='762'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='763'></font>
<font color=#447700>!<a name='764'></font>
      ENDIF  <font color=#447700>!  End of land/sea branch<a name='765'></font>
<font color=#447700>!<a name='766'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='767'></font>
<font color=#447700>!***  COUNTERGRADIENT FIX<a name='768'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='769'></font>
<font color=#447700>!<a name='770'></font>
<font color=#447700>!     HV=-AKHS*DTHV<a name='771'></font>
<font color=#447700>!     IF(HV&gt;0.)THEN<a name='772'></font>
<font color=#447700>!       FCT=-10.*(BTGX)**(-1./3.)<a name='773'></font>
<font color=#447700>!       CT=FCT*(HV/(PBLH*PBLH))**(2./3.)<a name='774'></font>
<font color=#447700>!     ELSE<a name='775'></font>
       CT=0.<a name='776'>
<font color=#447700>!     ENDIF<a name='777'></font>
<font color=#447700>!<a name='778'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='779'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='780'></font>
<font color=#447700>!***  THE FOLLOWING DIAGNOSTIC BLOCK PRODUCES 2-m and 10-m VALUES<a name='781'></font>
<font color=#447700>!***  FOR TEMPERATURE, MOISTURE, AND WINDS.  IT IS DONE HERE SINCE<a name='782'></font>
<font color=#447700>!***  THE VARIOUS QUANTITIES NEEDED FOR THE COMPUTATION ARE LOST<a name='783'></font>
<font color=#447700>!***  UPON EXIT FROM THE ROTUINE.<a name='784'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='785'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='786'></font>
<font color=#447700>!<a name='787'></font>
      WSTAR=SQRT(WSTAR2)/WWST<a name='788'>
<font color=#447700>!<a name='789'></font>
      UMFLX=AKMS*(ULOW -UZ0 )<a name='790'>
      VMFLX=AKMS*(VLOW -VZ0 )<a name='791'>
      HSFLX=AKHS*(THLOW-THZ0)<a name='792'>
      HLFLX=AKHS*(QLOW -QZ0 )<a name='793'>
<font color=#447700>!----------------------------------------------------------------------<a name='794'></font>
<font color=#447700>!     IF(RIB&gt;=RIC)THEN<a name='795'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='796'></font>
<font color=#447700>!       IF(SEAMASK&gt;0.5)THEN<a name='797'></font>
<font color=#447700>!         AKMS10=MAX( VISC/10.,CXCHS)<a name='798'></font>
<font color=#447700>!         AKHS02=MAX(TVISC/02.,CXCHS)<a name='799'></font>
<font color=#447700>!         AKHS10=MAX(TVISC/10.,CXCHS)<a name='800'></font>
<font color=#447700>!       ELSE<a name='801'></font>
<font color=#447700>!         AKMS10=MAX( VISC/10.,CXCHL)<a name='802'></font>
<font color=#447700>!         AKHS02=MAX(TVISC/02.,CXCHL)<a name='803'></font>
<font color=#447700>!         AKHS10=MAX(TVISC/10.,CXCHL)<a name='804'></font>
<font color=#447700>!       ENDIF<a name='805'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='806'></font>
<font color=#447700>!     ELSE<a name='807'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='808'></font>
        ZU10=ZU+10.<a name='809'>
        ZT02=ZT+02.<a name='810'>
        ZT10=ZT+10.<a name='811'>
<font color=#447700>!<a name='812'></font>
        RLNU10=LOG(ZU10/ZU)<a name='813'>
        RLNT02=LOG(ZT02/ZT)<a name='814'>
        RLNT10=LOG(ZT10/ZT)<a name='815'>
<font color=#447700>!<a name='816'></font>
        ZTAU10=ZU10*RLMO<a name='817'>
        ZTAT02=ZT02*RLMO<a name='818'>
        ZTAT10=ZT10*RLMO<a name='819'>
<font color=#447700>!<a name='820'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='821'></font>
<font color=#447700>!***  SEA<a name='822'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='823'></font>
<font color=#447700>!<a name='824'></font>
        IF(SEAMASK&gt;0.5)THEN<a name='825'>
<font color=#447700>!<a name='826'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='827'></font>
          ZTAU10=MIN(MAX(ZTAU10,ZTMIN1),ZTMAX1)<a name='828'>
          ZTAT02=MIN(MAX(ZTAT02,ZTMIN1),ZTMAX1)<a name='829'>
          ZTAT10=MIN(MAX(ZTAT10,ZTMIN1),ZTMAX1)<a name='830'>
<font color=#447700>!----------------------------------------------------------------------<a name='831'></font>
          RZ=(ZTAU10-ZTMIN1)/DZETA1<a name='832'>
          K=INT(RZ)<a name='833'>
          RDZT=RZ-REAL(K)<a name='834'>
          K=MIN(K,KZTM2)<a name='835'>
          K=MAX(K,0)<a name='836'>
          PSM10=(PSIM1(K+2)-PSIM1(K+1))*RDZT+PSIM1(K+1)<a name='837'>
<font color=#447700>!<a name='838'></font>
          SIMM10=PSM10-PSMZ+RLNU10<a name='839'>
<font color=#447700>!<a name='840'></font>
          RZ=(ZTAT02-ZTMIN1)/DZETA1<a name='841'>
          K=INT(RZ)<a name='842'>
          RDZT=RZ-REAL(K)<a name='843'>
          K=MIN(K,KZTM2)<a name='844'>
          K=MAX(K,0)<a name='845'>
          PSH02=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='846'>
<font color=#447700>!<a name='847'></font>
          SIMH02=(PSH02-PSHZ+RLNT02)*PRT0<a name='848'>
<font color=#447700>!         SIMH02=(PSH02-PSHZ+RLNT02)*FH01<a name='849'></font>
<font color=#447700>!<a name='850'></font>
          RZ=(ZTAT10-ZTMIN1)/DZETA1<a name='851'>
          K=INT(RZ)<a name='852'>
          RDZT=RZ-REAL(K)<a name='853'>
          K=MIN(K,KZTM2)<a name='854'>
          K=MAX(K,0)<a name='855'>
          PSH10=(PSIH1(K+2)-PSIH1(K+1))*RDZT+PSIH1(K+1)<a name='856'>
<font color=#447700>!<a name='857'></font>
          SIMH10=(PSH10-PSHZ+RLNT10)*PRT0<a name='858'>
<font color=#447700>!         SIMH10=(PSH10-PSHZ+RLNT10)*FH01<a name='859'></font>
<font color=#447700>!<a name='860'></font>
          AKMS10=MAX(USTARK/SIMM10,CXCHS)<a name='861'>
          AKHS02=MAX(USTARK/SIMH02,CXCHS)<a name='862'>
          AKHS10=MAX(USTARK/SIMH10,CXCHS)<a name='863'>
<font color=#447700>!<a name='864'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='865'></font>
<font color=#447700>!***  LAND<a name='866'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='867'></font>
<font color=#447700>!<a name='868'></font>
        ELSE<a name='869'>
<font color=#447700>!<a name='870'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='871'></font>
          ZTAU10=MIN(MAX(ZTAU10,ZTMIN2),ZTMAX2)<a name='872'>
          ZTAT02=MIN(MAX(ZTAT02,ZTMIN2),ZTMAX2)<a name='873'>
          ZTAT10=MIN(MAX(ZTAT10,ZTMIN2),ZTMAX2)<a name='874'>
<font color=#447700>!----------------------------------------------------------------------<a name='875'></font>
          RZ=(ZTAU10-ZTMIN2)/DZETA2<a name='876'>
          K=INT(RZ)<a name='877'>
          RDZT=RZ-REAL(K)<a name='878'>
          K=MIN(K,KZTM2)<a name='879'>
          K=MAX(K,0)<a name='880'>
          PSM10=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='881'>
<font color=#447700>!<a name='882'></font>
          SIMM10=PSM10-PSMZ+RLNU10<a name='883'>
<font color=#447700>!<a name='884'></font>
          RZ=(ZTAT02-ZTMIN2)/DZETA2<a name='885'>
          K=INT(RZ)<a name='886'>
          RDZT=RZ-REAL(K)<a name='887'>
          K=MIN(K,KZTM2)<a name='888'>
          K=MAX(K,0)<a name='889'>
          PSH02=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='890'>
<font color=#447700>!<a name='891'></font>
          SIMH02=(PSH02-PSHZ+RLNT02)*PRT0<a name='892'>
<font color=#447700>!         SIMH02=(PSH02-PSHZ+RLNT02)*FH02<a name='893'></font>
<font color=#447700>!<a name='894'></font>
          RZ=(ZTAT10-ZTMIN2)/DZETA2<a name='895'>
          K=INT(RZ)<a name='896'>
          RDZT=RZ-REAL(K)<a name='897'>
          K=MIN(K,KZTM2)<a name='898'>
          K=MAX(K,0)<a name='899'>
          PSH10=(PSIH2(K+2)-PSIH2(K+1))*RDZT+PSIH2(K+1)<a name='900'>
<font color=#447700>!<a name='901'></font>
          SIMH10=(PSH10-PSHZ+RLNT10)*PRT0<a name='902'>
<font color=#447700>!         SIMH10=(PSH10-PSHZ+RLNT10)*FH02<a name='903'></font>
<font color=#447700>!<a name='904'></font>
          AKMS10=MAX(USTARK/SIMM10,CXCHL)<a name='905'>
          AKHS02=MAX(USTARK/SIMH02,CXCHL)<a name='906'>
          AKHS10=MAX(USTARK/SIMH10,CXCHL)<a name='907'>
<font color=#447700>!----------------------------------------------------------------------<a name='908'></font>
        ENDIF<a name='909'>
<font color=#447700>!----------------------------------------------------------------------<a name='910'></font>
<font color=#447700>!     ENDIF<a name='911'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='912'></font>
      U10 =UMFLX/AKMS10+UZ0<a name='913'>
      V10 =VMFLX/AKMS10+VZ0<a name='914'>
      TH02=HSFLX/AKHS02+THZ0<a name='915'>
      TH10=HSFLX/AKHS10+THZ0<a name='916'>
      Q02 =HLFLX/AKHS02+QZ0<a name='917'>
      Q10 =HLFLX/AKHS10+QZ0<a name='918'>
      TERM1=-0.068283/TLOW<a name='919'>
      PSHLTR=PSFC*EXP(TERM1)<a name='920'>
<font color=#447700>!<a name='921'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='922'></font>
<font color=#447700>!***  COMPUTE "EQUIVALENT" Z0 TO APPROXIMATE LOCAL SHELTER READINGS.<a name='923'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='924'></font>
<font color=#447700>!<a name='925'></font>
      U10E=U10<a name='926'>
      V10E=V10<a name='927'>
<font color=#447700>!<a name='928'></font>
      IF(SEAMASK&lt;0.5)THEN<a name='929'>
<a name='930'>
<font color=#447700>!1st        ZUUZ=MIN(0.5*ZU,0.1)<a name='931'></font>
<font color=#447700>!1st        ZU=MAX(0.1*ZU,ZUUZ)<a name='932'></font>
<font color=#447700>!tst        ZUUZ=amin1(ZU*0.50,0.3)<a name='933'></font>
<font color=#447700>!tst        ZU=amax1(ZU*0.3,ZUUZ)<a name='934'></font>
<a name='935'>
        ZUUZ=AMIN1(ZU*0.50,0.18)<a name='936'>
        ZU=AMAX1(ZU*0.35,ZUUZ)<a name='937'>
<font color=#447700>!<a name='938'></font>
        ZU10=ZU+10.<a name='939'>
        RZSU=ZU10/ZU<a name='940'>
        RLNU10=LOG(RZSU)<a name='941'>
<a name='942'>
        ZETAU=ZU*RLMO<a name='943'>
        ZTAU10=ZU10*RLMO<a name='944'>
<a name='945'>
        ZTAU10=MIN(MAX(ZTAU10,ZTMIN2),ZTMAX2)<a name='946'>
        ZETAU=MIN(MAX(ZETAU,ZTMIN2/RZSU),ZTMAX2/RZSU)<a name='947'>
<a name='948'>
        RZ=(ZTAU10-ZTMIN2)/DZETA2<a name='949'>
        K=INT(RZ)<a name='950'>
        RDZT=RZ-REAL(K)<a name='951'>
        K=MIN(K,KZTM2)<a name='952'>
        K=MAX(K,0)<a name='953'>
        PSM10=(PSIM2(K+2)-PSIM2(K+1))*RDZT+PSIM2(K+1)<a name='954'>
        SIMM10=PSM10-PSMZ+RLNU10<a name='955'>
        EKMS10=MAX(USTARK/SIMM10,CXCHL)<a name='956'>
<a name='957'>
        U10E=UMFLX/EKMS10+UZ0<a name='958'>
        V10E=VMFLX/EKMS10+VZ0<a name='959'>
<a name='960'>
      ENDIF<a name='961'>
<font color=#447700>!<a name='962'></font>
      U10=U10E<a name='963'>
      V10=V10E<a name='964'>
<font color=#447700>!<a name='965'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='966'></font>
<font color=#447700>!***  SET OTHER WRF DRIVER ARRAYS<a name='967'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='968'></font>
<font color=#447700>!<a name='969'></font>
      CHS=AKHS<a name='970'>
      CHS2=AKHS02<a name='971'>
      CQS2=AKHS02<a name='972'>
     <font color=#447700>! IF(SEAMASK.EQ.1) THEN<a name='973'></font>
     <font color=#447700>!  print*,'HSFLX=',HSFLX<a name='974'></font>
     <font color=#447700>!  print*,'RLOW=',RLOW<a name='975'></font>
     <font color=#447700>!  print*,'********'<a name='976'></font>
     <font color=#447700>! END IF<a name='977'></font>
      IF ( PRESENT(SCM_FORCE_FLUX) ) THEN              <a name='978'>
         IF (SCM_FORCE_FLUX.EQ.0) THEN              <a name='979'>
           HFX=-RLOW*CP*HSFLX<a name='980'>
           QFX=-RLOW*HLFLX*WETM<a name='981'>
         ENDIF<a name='982'>
      ENDIF<a name='983'>
      FLX_LH=XLV*QFX<a name='984'>
      FLHC=RLOW*CP*AKHS<a name='985'>
      FLQC=RLOW*AKHS*WETM<a name='986'>
<font color=#447700>!!!   QGH=PQ0/PSHLTR*EXP(A2S*(TSK-A3S)/(TSK-A4S))<a name='987'></font>
      QGH=((1.-SEAMASK)*PQ0+SEAMASK*PQ0SEA)                            &amp;<a name='988'>
     &amp;     /PLOW*EXP(A2S*(TLOW-A3S)/(TLOW-A4S))<a name='989'>
      QGH=QGH/(1.-QGH)    <font color=#447700>!Convert to mixing ratio<a name='990'></font>
      CPM=CP*(1.+0.8*QLOW)<a name='991'>
<font color=#447700>!<a name='992'></font>
<font color=#447700>!***  DO NOT COMPUTE QS OVER LAND POINTS HERE SINCE IT IS<a name='993'></font>
<font color=#447700>!***  A PROGNOSTIC VARIABLE THERE.  IT IS OKAY TO USE IT <a name='994'></font>
<font color=#447700>!***  AS A DIAGNOSTIC OVER WATER SINCE IT WILL CAUSE NO<a name='995'></font>
<font color=#447700>!***  INTERFERENCE BEFORE BEING RECOMPUTED IN MYJPBL.<a name='996'></font>
<font color=#447700>!<a name='997'></font>
      IF(SEAMASK&gt;0.5)THEN<a name='998'>
        QS=QLOW+QFX/(RLOW*AKHS)<a name='999'>
        QS=QS/(1.-QS)<a name='1000'>
      ENDIF<a name='1001'>
<font color=#447700>!----------------------------------------------------------------------<a name='1002'></font>
<font color=#447700>!<a name='1003'></font>
      END SUBROUTINE SFCDIF<a name='1004'>
<font color=#447700>!<a name='1005'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1006'></font>
<A NAME='QNSESFCINIT'><A href='../../html_code/phys/module_sf_qnsesfc.F.html#QNSESFCINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1007'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>QNSESFCINIT</font>(LOWLYR,USTAR,Z0                            &amp; <A href='../../call_to/QNSESFCINIT.html' TARGET='index'>1</A>,<A href='../../call_from/QNSESFCINIT.html' TARGET='index'>1</A><a name='1008'>
     &amp;                     ,SEAMASK,XICE,IVGTYP,RESTART                &amp;<a name='1009'>
     &amp;                     ,ALLOWED_TO_READ                            &amp;<a name='1010'>
     &amp;                     ,IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='1011'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1012'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='1013'>
<font color=#447700>!----------------------------------------------------------------------<a name='1014'></font>
      IMPLICIT NONE<a name='1015'>
<font color=#447700>!----------------------------------------------------------------------<a name='1016'></font>
      LOGICAL,INTENT(IN) :: RESTART,ALLOWED_TO_READ<a name='1017'>
<font color=#447700>!<a name='1018'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='1019'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='1020'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='1021'>
<font color=#447700>!<a name='1022'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IVGTYP<a name='1023'>
<font color=#447700>!<a name='1024'></font>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: LOWLYR<a name='1025'>
<font color=#447700>!<a name='1026'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: SEAMASK,XICE<a name='1027'>
<font color=#447700>!<a name='1028'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(INOUT) :: USTAR,Z0<a name='1029'>
<font color=#447700>!<a name='1030'></font>
      REAL,DIMENSION(0:30) :: VZ0TBL<a name='1031'>
      REAL,DIMENSION(0:30) :: VZ0TBL_24<a name='1032'>
<font color=#447700>!<a name='1033'></font>
      INTEGER :: I,IDUM,IRECV,J,JDUM,K,ITF,JTF,KTF,MAXGBL_IVGTYP       &amp;<a name='1034'>
     &amp;,          MAXLOC_IVGTYP,MPI_COMM_COMP<a name='1035'>
<font color=#447700>!<a name='1036'></font>
<font color=#447700>!     INTEGER :: MPI_INTEGER,MPI_MAX<a name='1037'></font>
<font color=#447700>!<a name='1038'></font>
      REAL :: SM,X,ZETA1,ZETA2,ZRNG1,ZRNG2,PSIMQ,PSIHQ<a name='1039'>
<font color=#447700>!<a name='1040'></font>
      REAL :: PIHF=3.1415926/2.,EPS=1.E-6<a name='1041'>
<font color=#447700>!----------------------------------------------------------------------<a name='1042'></font>
      VZ0TBL=                                                          &amp;<a name='1043'>
     &amp;  (/0.,                                                          &amp;<a name='1044'>
     &amp;    2.653,0.826,0.563,1.089,0.854,0.856,0.035,0.238,0.065,0.076  &amp;<a name='1045'>
     &amp;   ,0.011,0.035,0.011,0.000,0.000,0.000,0.000,0.000,0.000,0.000  &amp;<a name='1046'>
     &amp;   ,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000/)<a name='1047'>
<a name='1048'>
      VZ0TBL_24= (/0.,                                                 &amp;<a name='1049'>
     &amp;            1.00,  0.07,  0.07,  0.07,  0.07,  0.15,             &amp;<a name='1050'>
     &amp;            0.08,  0.03,  0.05,  0.86,  0.80,  0.85,             &amp;<a name='1051'>
     &amp;            2.65,  1.09,  0.80,  0.001, 0.04,  0.05,             &amp;<a name='1052'>
     &amp;            0.01,  0.04,  0.06,  0.05,  0.03,  0.001,            &amp;<a name='1053'>
     &amp;            0.000, 0.000, 0.000, 0.000, 0.000, 0.000/)<a name='1054'>
<a name='1055'>
<font color=#447700>!----------------------------------------------------------------------<a name='1056'></font>
<font color=#447700>!<a name='1057'></font>
      JTF=MIN0(JTE,JDE-1)<a name='1058'>
      KTF=MIN0(KTE,KDE-1)<a name='1059'>
      ITF=MIN0(ITE,IDE-1)<a name='1060'>
<font color=#447700>!<a name='1061'></font>
<font color=#447700>!<a name='1062'></font>
<font color=#447700>!***  FOR NOW, ASSUME SIGMA MODE FOR LOWEST MODEL LAYER<a name='1063'></font>
<font color=#447700>!<a name='1064'></font>
      DO J=JTS,JTF<a name='1065'>
      DO I=ITS,ITF<a name='1066'>
        LOWLYR(I,J)=1<a name='1067'>
<font color=#447700>!       USTAR(I,J)=EPSUST<a name='1068'></font>
      ENDDO<a name='1069'>
      ENDDO<a name='1070'>
<font color=#447700>!----------------------------------------------------------------------<a name='1071'></font>
#if (NMM_CORE == 1)<a name='1072'>
<font color=#447700>!<a name='1073'></font>
      IF(.NOT.RESTART)THEN<a name='1074'>
<font color=#447700>!       CALL WRF_GET_DM_COMMUNICATOR(MPI_COMM_COMP)<a name='1075'></font>
<font color=#447700>!       MAXLOC_IVGTYP=MAXVAL(IVGTYP)<a name='1076'></font>
<font color=#447700>!       CALL MPI_ALLREDUCE(MAXLOC_IVGTYP,MAXGBL_IVGTYP,1,MPI_INTEGER   &amp;<a name='1077'></font>
<font color=#447700>!    &amp;,                    MPI_MAX,MPI_COMM_COMP,IRECV)<a name='1078'></font>
        MAXGBL_IVGTYP=MAXVAL(IVGTYP)<a name='1079'>
<a name='1080'>
#ifdef DM_PARALLEL<a name='1081'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>WRF_DM_MAXVAL</A><A href='../../html_code/phys/module_sf_qnsesfc.F.html#QNSESFCINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_12">(MAXGBL_IVGTYP,IDUM,JDUM)<a name='1082'>
#endif<a name='1083'>
<a name='1084'>
<font color=#447700>!<a name='1085'></font>
        IF (MAXGBL_IVGTYP&lt;13) THEN<a name='1086'>
          DO J=JTS,JTE<a name='1087'>
          DO I=ITS,ITE<a name='1088'>
            SM=SEAMASK(I,J)-1.<a name='1089'>
            IF(SM+XICE(I,J)&lt;0.5)THEN<a name='1090'>
              Z0(I,J)=VZ0TBL(IVGTYP(I,J))<a name='1091'>
            ENDIF<a name='1092'>
          ENDDO<a name='1093'>
          ENDDO<a name='1094'>
<font color=#447700>!<a name='1095'></font>
        ELSE<a name='1096'>
<font color=#447700>!<a name='1097'></font>
          DO J=JTS,JTE<a name='1098'>
          DO I=ITS,ITE<a name='1099'>
            SM=SEAMASK(I,J)-1.<a name='1100'>
            IF(SM+XICE(I,J)&lt;0.5)THEN<a name='1101'>
              Z0(I,J)=VZ0TBL_24(IVGTYP(I,J))<a name='1102'>
            ENDIF<a name='1103'>
          ENDDO<a name='1104'>
          ENDDO<a name='1105'>
<font color=#447700>!<a name='1106'></font>
        ENDIF <font color=#447700>! Vegtype check<a name='1107'></font>
<font color=#447700>!<a name='1108'></font>
      ENDIF <font color=#447700>! Restart check<a name='1109'></font>
#endif<a name='1110'>
<font color=#447700>!----------------------------------------------------------------------<a name='1111'></font>
      IF(.NOT.RESTART)THEN<a name='1112'>
        DO J=JTS,JTE<a name='1113'>
        DO I=ITS,ITF<a name='1114'>
          USTAR(I,J)=0.1<a name='1115'>
        ENDDO<a name='1116'>
        ENDDO<a name='1117'>
      ENDIF<a name='1118'>
<font color=#447700>!----------------------------------------------------------------------<a name='1119'></font>
<font color=#447700>!<a name='1120'></font>
<font color=#447700>!***  COMPUTE SURFACE LAYER INTEGRAL FUNCTIONS<a name='1121'></font>
<font color=#447700>!<a name='1122'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1123'></font>
      FH01=1.<a name='1124'>
      FH02=1.<a name='1125'>
<font color=#447700>!<a name='1126'></font>
<font color=#447700>!      ZTMIN1=-10.0<a name='1127'></font>
<font color=#447700>!      ZTMAX1=2.0<a name='1128'></font>
<font color=#447700>!      ZTMIN2=-10.0<a name='1129'></font>
<font color=#447700>!      ZTMAX2=2.0<a name='1130'></font>
      ZTMIN1=-5.0<a name='1131'>
<font color=#447700>!      ZTMAX1=3.0<a name='1132'></font>
      ZTMAX1=2.3   <font color=#447700>! changed<a name='1133'></font>
      ZTMIN2=-5.0<a name='1134'>
<font color=#447700>!      ZTMAX2=3.0<a name='1135'></font>
      ZTMAX2=2.3   <font color=#447700>! changed<a name='1136'></font>
<font color=#447700>!<a name='1137'></font>
      ZRNG1=ZTMAX1-ZTMIN1<a name='1138'>
      ZRNG2=ZTMAX2-ZTMIN2<a name='1139'>
<font color=#447700>!<a name='1140'></font>
      DZETA1=ZRNG1/(KZTM-1)<a name='1141'>
      DZETA2=ZRNG2/(KZTM-1)<a name='1142'>
<font color=#447700>!<a name='1143'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1144'></font>
<font color=#447700>!***  FUNCTION DEFINITION LOOP<a name='1145'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1146'></font>
<font color=#447700>!<a name='1147'></font>
      ZETA1=ZTMIN1<a name='1148'>
      ZETA2=ZTMIN2<a name='1149'>
<font color=#447700>!<a name='1150'></font>
      DO K=1,KZTM<a name='1151'>
<font color=#447700>!<a name='1152'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1153'></font>
<font color=#447700>!***  UNSTABLE RANGE<a name='1154'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1155'></font>
<font color=#447700>!<a name='1156'></font>
        IF(ZETA1&lt;0.)THEN<a name='1157'>
<font color=#447700>!<a name='1158'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1159'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1160'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1161'></font>
          X=SQRT(SQRT(1.-16.*ZETA1))<a name='1162'>
 <a name='1163'>
          PSIM1(K)=-2.*LOG((X+1.)/2.)-LOG((X*X+1.)/2.)+2.*ATAN(X)-PIHF<a name='1164'>
          PSIH1(K)=-2.*LOG((X*X+1.)/2.)<a name='1165'>
<font color=#447700>!<a name='1166'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1167'></font>
<font color=#447700>!***  DERIVED BY S. SUKORIANSKY USING QNSE THEORY<a name='1168'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1169'></font>
<font color=#447700>!<a name='1170'></font>
          PSIMQ=2.25*ZETA1+ZETA1**2+45.9*ZETA1**3<a name='1171'>
          PSIHQ=2.0*ZETA1+10.3*ZETA1**2+130*ZETA1**3<a name='1172'>
<font color=#447700>!         PSIHQ=1.45*ZETA1+7.42*ZETA1**2+93.5*ZETA1**3      ! /PRT0<a name='1173'></font>
          PSIM1(K)=MAX(PSIMQ,PSIM1(K))<a name='1174'>
          PSIH1(K)=MAX(PSIHQ,PSIH1(K))<a name='1175'>
<font color=#447700>!<a name='1176'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1177'></font>
<font color=#447700>!***  STABLE RANGE<a name='1178'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1179'></font>
<font color=#447700>!<a name='1180'></font>
        ELSE<a name='1181'>
<font color=#447700>!<a name='1182'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1183'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1184'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1185'></font>
<font color=#447700>!<a name='1186'></font>
<font color=#447700>!         PSIM1(K)=5.*ZETA1<a name='1187'></font>
<font color=#447700>!         PSIH1(K)=5.*ZETA1<a name='1188'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1189'></font>
<font color=#447700>!***   HOLTSLAG AND DE BRUIN 1988<a name='1190'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1191'></font>
<font color=#447700>!<a name='1192'></font>
<font color=#447700>!         PSIM1(K)=0.7*ZETA1+0.75*ZETA1*(6.-0.35*ZETA1)*EXP(-0.35*ZETA1)<a name='1193'></font>
<font color=#447700>!         PSIH1(K)=0.7*ZETA1+0.75*ZETA1*(6.-0.35*ZETA1)*EXP(-0.35*ZETA1)<a name='1194'></font>
<font color=#447700>!<a name='1195'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1196'></font>
<font color=#447700>!***  DERIVED BY S. SUKORIANSKY USING QNSE THEORY<a name='1197'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1198'></font>
<font color=#447700>!<a name='1199'></font>
          PSIM1(K)=2.25*ZETA1-0.2*ZETA1*ZETA1<a name='1200'>
          PSIH1(K)=2.0*ZETA1+0.14*((ZETA1-0.5)**5+0.03125)<a name='1201'>
<font color=#447700>!         PSIH1(K)=1.42*ZETA1+0.1*((ZETA1-0.5)**5+0.03125)  !/PRT0<a name='1202'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1203'></font>
<font color=#447700>!<a name='1204'></font>
        ENDIF<a name='1205'>
<font color=#447700>!<a name='1206'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1207'></font>
<font color=#447700>!***  UNSTABLE RANGE<a name='1208'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1209'></font>
<font color=#447700>!<a name='1210'></font>
        IF(ZETA2&lt;0.)THEN<a name='1211'>
<font color=#447700>!<a name='1212'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1213'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1214'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1215'></font>
<font color=#447700>!<a name='1216'></font>
          X=SQRT(SQRT(1.-16.*ZETA2))<a name='1217'>
 <a name='1218'>
          PSIM2(K)=-2.*LOG((X+1.)/2.)-LOG((X*X+1.)/2.)+2.*ATAN(X)-PIHF<a name='1219'>
          PSIH2(K)=-2.*LOG((X*X+1.)/2.)<a name='1220'>
<font color=#447700>!<a name='1221'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1222'></font>
<font color=#447700>!***  DERIVED BY S. SUKORIANSKY USING QNSE THEORY<a name='1223'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1224'></font>
<font color=#447700>!<a name='1225'></font>
          PSIMQ=2.25*ZETA2+ZETA2**2+45.9*ZETA2**3<a name='1226'>
          PSIHQ=2.0*ZETA2+10.3*ZETA2**2+130*ZETA2**3<a name='1227'>
<font color=#447700>!         PSIHQ=1.45*ZETA2+7.42*ZETA2**2+93.5*ZETA2**3      ! /PRT0<a name='1228'></font>
          PSIM2(K)=MAX(PSIMQ,PSIM2(K))<a name='1229'>
          PSIH2(K)=MAX(PSIHQ,PSIH2(K))<a name='1230'>
<font color=#447700>!<a name='1231'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1232'></font>
<font color=#447700>!***  STABLE RANGE<a name='1233'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1234'></font>
<font color=#447700>!<a name='1235'></font>
        ELSE<a name='1236'>
<font color=#447700>!<a name='1237'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1238'></font>
<font color=#447700>!***  PAULSON 1970 FUNCTIONS<a name='1239'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1240'></font>
<font color=#447700>!<a name='1241'></font>
<font color=#447700>!         PSIM2(K)=5.*ZETA2<a name='1242'></font>
<font color=#447700>!         PSIH2(K)=5.*ZETA2<a name='1243'></font>
<font color=#447700>!<a name='1244'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1245'></font>
<font color=#447700>!***  HOLTSLAG AND DE BRUIN 1988<a name='1246'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1247'></font>
<font color=#447700>!<a name='1248'></font>
<font color=#447700>!         PSIM2(K)=0.7*ZETA2+0.75*ZETA2*(6.-0.35*ZETA2)*EXP(-0.35*ZETA2)<a name='1249'></font>
<font color=#447700>!         PSIH2(K)=0.7*ZETA2+0.75*ZETA2*(6.-0.35*ZETA2)*EXP(-0.35*ZETA2)<a name='1250'></font>
<font color=#447700>!<a name='1251'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1252'></font>
<font color=#447700>!***  DERIVED BY S. SUKORIANSKY USING QNSE THEORY<a name='1253'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1254'></font>
<font color=#447700>!<a name='1255'></font>
          PSIM2(K)=2.25*ZETA2-0.2*ZETA2*ZETA2<a name='1256'>
          PSIH2(K)=2.0*ZETA2+0.14*((ZETA2-0.5)**5+0.03125)<a name='1257'>
<font color=#447700>!         PSIH2(K)=1.42*ZETA2+0.1*((ZETA2-0.5)**5+0.03125)  !/PRT0<a name='1258'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1259'></font>
<font color=#447700>!<a name='1260'></font>
        ENDIF<a name='1261'>
<font color=#447700>!<a name='1262'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1263'></font>
        IF(K==KZTM)THEN<a name='1264'>
          ZTMAX1=ZETA1<a name='1265'>
          ZTMAX2=ZETA2<a name='1266'>
        ENDIF<a name='1267'>
<font color=#447700>!<a name='1268'></font>
        ZETA1=ZETA1+DZETA1<a name='1269'>
        ZETA2=ZETA2+DZETA2<a name='1270'>
<font color=#447700>!----------------------------------------------------------------------<a name='1271'></font>
      ENDDO<a name='1272'>
<font color=#447700>!----------------------------------------------------------------------<a name='1273'></font>
      ZTMAX1=ZTMAX1-EPS<a name='1274'>
      ZTMAX2=ZTMAX2-EPS<a name='1275'>
<font color=#447700>!----------------------------------------------------------------------<a name='1276'></font>
<font color=#447700>!<a name='1277'></font>
      END SUBROUTINE QNSESFCINIT<a name='1278'>
<font color=#447700>!<a name='1279'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1280'></font>
<font color=#447700>!<a name='1281'></font>
      END MODULE MODULE_SF_QNSESFC<a name='1282'>
<font color=#447700>!<a name='1283'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='1284'></font>
</pre></body></html>