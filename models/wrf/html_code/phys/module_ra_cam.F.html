<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_RA_CAM'><A href='../../html_code/phys/module_ra_cam.F.html#MODULE_RA_CAM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_ra_cam</font> <A href='../../call_to/MODULE_RA_CAM.html' TARGET='index'>2</A><a name='3'>
  use <A href='../../html_code/phys/module_ra_cam_support.F.html#MODULE_RA_CAM_SUPPORT'>module_ra_cam_support</A><A href='../../html_code/phys/module_ra_cam.F.html#module_ra_cam.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_CAM_SUPPORT_2"><a name='4'>
  use <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_ra_cam.F.html#module_ra_cam.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_50">, only: endrun<a name='5'>
<a name='6'>
  implicit none<a name='7'>
<font color=#447700>! <a name='8'></font>
<font color=#447700>! A. Slingo's data for cloud particle radiative properties (from 'A GCM<a name='9'></font>
<font color=#447700>! Parameterization for the Shortwave Properties of Water Clouds' JAS<a name='10'></font>
<font color=#447700>! vol. 46 may 1989 pp 1419-1427)<a name='11'></font>
<font color=#447700>! <a name='12'></font>
   real(r8) abarl(4)         <font color=#447700>! A coefficient for extinction optical depth<a name='13'></font>
   real(r8) bbarl(4)         <font color=#447700>! B coefficient for extinction optical depth<a name='14'></font>
   real(r8) cbarl(4)         <font color=#447700>! C coefficient for single scat albedo<a name='15'></font>
   real(r8) dbarl(4)         <font color=#447700>! D coefficient for single  scat albedo<a name='16'></font>
   real(r8) ebarl(4)         <font color=#447700>! E coefficient for asymmetry parameter<a name='17'></font>
   real(r8) fbarl(4)         <font color=#447700>! F coefficient for asymmetry parameter<a name='18'></font>
<a name='19'>
   save abarl, bbarl, cbarl, dbarl, ebarl, fbarl<a name='20'>
<a name='21'>
   data abarl/ 2.817e-02, 2.682e-02,2.264e-02,1.281e-02/<a name='22'>
   data bbarl/ 1.305    , 1.346    ,1.454    ,1.641    /<a name='23'>
   data cbarl/-5.62e-08 ,-6.94e-06 ,4.64e-04 ,0.201    /<a name='24'>
   data dbarl/ 1.63e-07 , 2.35e-05 ,1.24e-03 ,7.56e-03 /<a name='25'>
   data ebarl/ 0.829    , 0.794    ,0.754    ,0.826    /<a name='26'>
   data fbarl/ 2.482e-03, 4.226e-03,6.560e-03,4.353e-03/<a name='27'>
<a name='28'>
#if 0<a name='29'>
<font color=#447700>! moved and changed to local variables into radcswmx for thread-safety, JM 20100217<a name='30'></font>
   real(r8) abarli           <font color=#447700>! A coefficient for current spectral band<a name='31'></font>
   real(r8) bbarli           <font color=#447700>! B coefficient for current spectral band<a name='32'></font>
   real(r8) cbarli           <font color=#447700>! C coefficient for current spectral band<a name='33'></font>
   real(r8) dbarli           <font color=#447700>! D coefficient for current spectral band<a name='34'></font>
   real(r8) ebarli           <font color=#447700>! E coefficient for current spectral band<a name='35'></font>
   real(r8) fbarli           <font color=#447700>! F coefficient for current spectral band<a name='36'></font>
#endif<a name='37'>
<font color=#447700>! <a name='38'></font>
<font color=#447700>! Caution... A. Slingo recommends no less than 4.0 micro-meters nor<a name='39'></font>
<font color=#447700>! greater than 20 micro-meters<a name='40'></font>
<font color=#447700>! <a name='41'></font>
<font color=#447700>! ice water coefficients (Ebert and Curry,1992, JGR, 97, 3831-3836)<a name='42'></font>
<font color=#447700>! <a name='43'></font>
   real(r8) abari(4)         <font color=#447700>! a coefficient for extinction optical depth<a name='44'></font>
   real(r8) bbari(4)         <font color=#447700>! b coefficient for extinction optical depth<a name='45'></font>
   real(r8) cbari(4)         <font color=#447700>! c coefficient for single scat albedo<a name='46'></font>
   real(r8) dbari(4)         <font color=#447700>! d coefficient for single scat albedo<a name='47'></font>
   real(r8) ebari(4)         <font color=#447700>! e coefficient for asymmetry parameter<a name='48'></font>
   real(r8) fbari(4)         <font color=#447700>! f coefficient for asymmetry parameter<a name='49'></font>
<a name='50'>
   save abari, bbari, cbari, dbari, ebari, fbari<a name='51'>
<a name='52'>
   data abari/ 3.448e-03, 3.448e-03,3.448e-03,3.448e-03/<a name='53'>
   data bbari/ 2.431    , 2.431    ,2.431    ,2.431    /<a name='54'>
   data cbari/ 1.00e-05 , 1.10e-04 ,1.861e-02,.46658   /<a name='55'>
   data dbari/ 0.0      , 1.405e-05,8.328e-04,2.05e-05 /<a name='56'>
   data ebari/ 0.7661   , 0.7730   ,0.794    ,0.9595   /<a name='57'>
   data fbari/ 5.851e-04, 5.665e-04,7.267e-04,1.076e-04/<a name='58'>
<a name='59'>
#if 0<a name='60'>
<font color=#447700>! moved and changed to local variables into radcswmx for thread-safety, JM 20100217<a name='61'></font>
   real(r8) abarii           <font color=#447700>! A coefficient for current spectral band<a name='62'></font>
   real(r8) bbarii           <font color=#447700>! B coefficient for current spectral band<a name='63'></font>
   real(r8) cbarii           <font color=#447700>! C coefficient for current spectral band<a name='64'></font>
   real(r8) dbarii           <font color=#447700>! D coefficient for current spectral band<a name='65'></font>
   real(r8) ebarii           <font color=#447700>! E coefficient for current spectral band<a name='66'></font>
   real(r8) fbarii           <font color=#447700>! F coefficient for current spectral band<a name='67'></font>
#endif<a name='68'>
<font color=#447700>! <a name='69'></font>
   real(r8) delta            <font color=#447700>! Pressure (in atm) for stratos. h2o limit<a name='70'></font>
   real(r8) o2mmr            <font color=#447700>! O2 mass mixing ratio:<a name='71'></font>
<a name='72'>
   save delta, o2mmr<a name='73'>
<a name='74'>
<font color=#447700>!<a name='75'></font>
<font color=#447700>! UPDATE TO H2O NEAR-IR: Delta optimized for Hitran 2K and CKD 2.4<a name='76'></font>
<font color=#447700>!<a name='77'></font>
   data delta / 0.0014257179260883 /<a name='78'>
<font color=#447700>!<a name='79'></font>
<font color=#447700>! END UPDATE<a name='80'></font>
<font color=#447700>!<a name='81'></font>
   data o2mmr / .23143 /<a name='82'>
<a name='83'>
<font color=#447700>! Next series depends on spectral interval<a name='84'></font>
<font color=#447700>! <a name='85'></font>
   real(r8) frcsol(nspint)   <font color=#447700>! Fraction of solar flux in spectral interval<a name='86'></font>
   real(r8) wavmin(nspint)   <font color=#447700>! Min wavelength (micro-meters) of interval<a name='87'></font>
   real(r8) wavmax(nspint)   <font color=#447700>! Max wavelength (micro-meters) of interval<a name='88'></font>
   real(r8) raytau(nspint)   <font color=#447700>! Rayleigh scattering optical depth<a name='89'></font>
   real(r8) abh2o(nspint)    <font color=#447700>! Absorption coefficiant for h2o (cm2/g)<a name='90'></font>
   real(r8) abo3 (nspint)    <font color=#447700>! Absorption coefficiant for o3  (cm2/g)<a name='91'></font>
   real(r8) abco2(nspint)    <font color=#447700>! Absorption coefficiant for co2 (cm2/g)<a name='92'></font>
   real(r8) abo2 (nspint)    <font color=#447700>! Absorption coefficiant for o2  (cm2/g)<a name='93'></font>
   real(r8) ph2o(nspint)     <font color=#447700>! Weight of h2o in spectral interval<a name='94'></font>
   real(r8) pco2(nspint)     <font color=#447700>! Weight of co2 in spectral interval<a name='95'></font>
   real(r8) po2 (nspint)     <font color=#447700>! Weight of o2  in spectral interval<a name='96'></font>
   real(r8) nirwgt(nspint)   <font color=#447700>! Spectral Weights to simulate Nimbus-7 filter<a name='97'></font>
   save frcsol ,wavmin ,wavmax ,raytau ,abh2o ,abo3 , &amp;<a name='98'>
        abco2  ,abo2   ,ph2o   ,pco2   ,po2   ,nirwgt<a name='99'>
<a name='100'>
   data frcsol / .001488, .001389, .001290, .001686, .002877, &amp;<a name='101'>
                 .003869, .026336, .360739, .065392, .526861, &amp;<a name='102'>
                 .526861, .526861, .526861, .526861, .526861, &amp;<a name='103'>
                 .526861, .006239, .001834, .001834/<a name='104'>
<font color=#447700>! <a name='105'></font>
<font color=#447700>! weight for 0.64 - 0.7 microns  appropriate to clear skies over oceans<a name='106'></font>
<font color=#447700>! <a name='107'></font>
   data nirwgt /  0.0,   0.0,   0.0,      0.0,   0.0, &amp;<a name='108'>
                  0.0,   0.0,   0.0, 0.320518,   1.0,  1.0, &amp;<a name='109'>
                  1.0,   1.0,   1.0,      1.0,   1.0, &amp;<a name='110'>
                  1.0,   1.0,   1.0 /<a name='111'>
<a name='112'>
   data wavmin / .200,  .245,  .265,  .275,  .285, &amp;<a name='113'>
                 .295,  .305,  .350,  .640,  .700,  .701, &amp;<a name='114'>
                 .701,  .701,  .701,  .702,  .702, &amp;<a name='115'>
                 2.630, 4.160, 4.160/<a name='116'>
<a name='117'>
   data wavmax / .245,  .265,  .275,  .285,  .295, &amp;<a name='118'>
                 .305,  .350,  .640,  .700, 5.000, 5.000, &amp;<a name='119'>
                 5.000, 5.000, 5.000, 5.000, 5.000, &amp;<a name='120'>
                 2.860, 4.550, 4.550/<a name='121'>
<a name='122'>
<font color=#447700>!<a name='123'></font>
<font color=#447700>! UPDATE TO H2O NEAR-IR: Rayleigh scattering optimized for Hitran 2K &amp; CKD 2.4<a name='124'></font>
<font color=#447700>!<a name='125'></font>
   real(r8) v_raytau_35<a name='126'>
   real(r8) v_raytau_64<a name='127'>
   real(r8) v_abo3_35<a name='128'>
   real(r8) v_abo3_64<a name='129'>
   parameter( &amp;<a name='130'>
        v_raytau_35 = 0.155208, &amp;<a name='131'>
        v_raytau_64 = 0.0392, &amp;<a name='132'>
        v_abo3_35 = 2.4058030e+01, &amp;  <a name='133'>
        v_abo3_64 = 2.210e+01 &amp;<a name='134'>
        )<a name='135'>
<a name='136'>
   data raytau / 4.020, 2.180, 1.700, 1.450, 1.250, &amp;<a name='137'>
                  1.085, 0.730, v_raytau_35, v_raytau_64, &amp;<a name='138'>
                  0.02899756, 0.01356763, 0.00537341, &amp;<a name='139'>
                  0.00228515, 0.00105028, 0.00046631, &amp;<a name='140'>
                  0.00025734, &amp;<a name='141'>
                 .0001, .0001, .0001/<a name='142'>
<font color=#447700>!<a name='143'></font>
<font color=#447700>! END UPDATE<a name='144'></font>
<font color=#447700>!<a name='145'></font>
<a name='146'>
<font color=#447700>! <a name='147'></font>
<font color=#447700>! Absorption coefficients<a name='148'></font>
<font color=#447700>! <a name='149'></font>
<font color=#447700>!<a name='150'></font>
<font color=#447700>! UPDATE TO H2O NEAR-IR: abh2o optimized for Hitran 2K and CKD 2.4<a name='151'></font>
<font color=#447700>!<a name='152'></font>
   data abh2o /    .000,     .000,    .000,    .000,    .000, &amp;<a name='153'>
                   .000,     .000,    .000,    .000,    &amp;<a name='154'>
                   0.00256608,  0.06310504,   0.42287445, 2.45397941, &amp;<a name='155'>
                  11.20070807, 47.66091389, 240.19010243, &amp;<a name='156'>
                   .000,    .000,    .000/<a name='157'>
<font color=#447700>!<a name='158'></font>
<font color=#447700>! END UPDATE<a name='159'></font>
<font color=#447700>!<a name='160'></font>
<a name='161'>
   data abo3  /5.370e+04, 13.080e+04,  9.292e+04, 4.530e+04, 1.616e+04, &amp;<a name='162'>
               4.441e+03,  1.775e+02, v_abo3_35, v_abo3_64,      .000, &amp;<a name='163'>
               .000,   .000    ,   .000   ,   .000   ,      .000, &amp;<a name='164'>
               .000,   .000    ,   .000   ,   .000    /<a name='165'>
<a name='166'>
   data abco2  /   .000,     .000,    .000,    .000,    .000, &amp;<a name='167'>
                   .000,     .000,    .000,    .000,    .000, &amp;<a name='168'>
                   .000,     .000,    .000,    .000,    .000, &amp;<a name='169'>
                   .000,     .094,    .196,   1.963/<a name='170'>
<a name='171'>
   data abo2  /    .000,     .000,    .000,    .000,    .000, &amp;<a name='172'>
                   .000,     .000,    .000,1.11e-05,6.69e-05, &amp;<a name='173'>
                   .000,     .000,    .000,    .000,    .000, &amp;  <a name='174'>
                   .000,     .000,    .000,    .000/<a name='175'>
<font color=#447700>! <a name='176'></font>
<font color=#447700>! Spectral interval weights<a name='177'></font>
<font color=#447700>! <a name='178'></font>
   data ph2o  /    .000,     .000,    .000,    .000,    .000, &amp;<a name='179'>
        .000,     .000,    .000,    .000,    .505,     &amp;<a name='180'>
        .210,     .120,    .070,    .048,    .029,     &amp;<a name='181'>
        .018,     .000,    .000,    .000/<a name='182'>
<a name='183'>
   data pco2  /    .000,     .000,    .000,    .000,    .000, &amp;<a name='184'>
        .000,     .000,    .000,    .000,    .000,     &amp;<a name='185'>
        .000,     .000,    .000,    .000,    .000,     &amp;<a name='186'>
        .000,    1.000,    .640,    .360/<a name='187'>
<a name='188'>
   data po2   /    .000,     .000,    .000,    .000,    .000, &amp;<a name='189'>
        .000,     .000,    .000,   1.000,   1.000,     &amp;<a name='190'>
        .000,     .000,    .000,    .000,    .000,     &amp;<a name='191'>
        .000,     .000,    .000,    .000/<a name='192'>
<a name='193'>
   real(r8) amo                 <font color=#447700>! Molecular weight of ozone (g/mol)<a name='194'></font>
   save     amo<a name='195'>
<a name='196'>
   data amo   /  48.0000   /<a name='197'>
<a name='198'>
contains<a name='199'>
<A NAME='CAMRAD'><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='200'>
<font color=#993300>subroutine </font><font color=#cc0000>camrad</font>(RTHRATENLW,RTHRATENSW,                           &amp; <A href='../../call_to/CAMRAD.html' TARGET='index'>2</A>,<A href='../../call_from/CAMRAD.html' TARGET='index'>12</A><a name='201'>
                     dolw,dosw,                                    &amp;<a name='202'>
                     SWUPT,SWUPTC,SWDNT,SWDNTC,                    &amp;<a name='203'>
                     LWUPT,LWUPTC,LWDNT,LWDNTC,                    &amp;<a name='204'>
                     SWUPB,SWUPBC,SWDNB,SWDNBC,                    &amp;<a name='205'>
                     LWUPB,LWUPBC,LWDNB,LWDNBC,                    &amp;<a name='206'>
                     swcf,lwcf,olr,cemiss,taucldc,taucldi,coszr,   &amp;<a name='207'>
                     GSW,GLW,XLAT,XLONG,                           &amp;<a name='208'>
                     ALBEDO,t_phy,TSK,EMISS,                       &amp;<a name='209'>
                     QV3D,QC3D,QR3D,QI3D,QS3D,QG3D,                &amp;<a name='210'>
                     ALSWVISDIR,ALSWVISDIF,                        &amp; <font color=#447700>!ssib  <a name='211'></font>
                     ALSWNIRDIR,ALSWNIRDIF,                        &amp; <font color=#447700>!ssib <a name='212'></font>
                     SWVISDIR,SWVISDIF,                            &amp; <font color=#447700>!ssib <a name='213'></font>
                     SWNIRDIR,SWNIRDIF,                            &amp; <font color=#447700>!ssib <a name='214'></font>
                     sf_surface_physics,                           &amp; <font color=#447700>!ssib <a name='215'></font>
                     SWDDIR,SWDDIF,SWDDNI,                         &amp; <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='216'></font>
                     F_QV,F_QC,F_QR,F_QI,F_QS,F_QG,                &amp;<a name='217'>
                     f_ice_phy,f_rain_phy,                         &amp;<a name='218'>
                     p_phy,p8w,z,pi_phy,rho_phy,dz8w,               &amp;<a name='219'>
                     CLDFRA,XLAND,XICE,SNOW,                        &amp;<a name='220'>
                     ozmixm,pin0,levsiz,num_months,                 &amp;<a name='221'>
                     m_psp,m_psn,aerosolcp,aerosolcn,m_hybi0,       &amp;<a name='222'>
                     cam_abs_dim1, cam_abs_dim2,                    &amp;<a name='223'>
                     paerlev,naer_c,                                &amp;<a name='224'>
                     GMT,JULDAY,JULIAN,YR,DT,XTIME,DECLIN,SOLCON,         &amp;<a name='225'>
                     RADT,DEGRAD,n_cldadv,                                  &amp;<a name='226'>
                     abstot_3d, absnxt_3d, emstot_3d,              &amp;<a name='227'>
                     doabsems,                                     &amp;<a name='228'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='229'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='230'>
                     its,ite, jts,jte, kts,kte,                    &amp;<a name='231'>
                     coszen                                        )<a name='232'>
<a name='233'>
<font color=#447700>!ccc To use CLWRF time-varying trace gases<a name='234'></font>
   USE <A href='../../html_code/phys/module_ra_clWRF_support.F.html#MODULE_RA_CLWRF_SUPPORT'>MODULE_RA_CLWRF_SUPPORT</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_CLWRF_SUPPORT_1">, ONLY : read_CAMgases<a name='235'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_72"><a name='236'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_142">, ONLY : SSIBSCHEME, CLMSCHEME          <font color=#447700>!ssib &amp; clm<a name='237'></font>
<a name='238'>
<font color=#447700>!------------------------------------------------------------------<a name='239'></font>
   IMPLICIT NONE<a name='240'>
<font color=#447700>!------------------------------------------------------------------<a name='241'></font>
<a name='242'>
   INTEGER,    INTENT(IN   ) ::        ids,ide, jds,jde, kds,kde, &amp;<a name='243'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='244'>
                                       its,ite, jts,jte, kts,kte<a name='245'>
   LOGICAL,    INTENT(IN   ) ::        F_QV,F_QC,F_QR,F_QI,F_QS,F_QG<a name='246'>
   LOGICAL,    INTENT(INout) ::        doabsems<a name='247'>
   LOGICAL,    INTENT(IN   ) ::        dolw,dosw<a name='248'>
<a name='249'>
   INTEGER,    INTENT(IN  )  ::        n_cldadv<a name='250'>
   INTEGER,    INTENT(IN  )  ::        JULDAY<a name='251'>
   REAL,       INTENT(IN  )  ::        JULIAN<a name='252'>
   INTEGER,    INTENT(IN  )  ::        YR<a name='253'>
   REAL,       INTENT(IN  )  ::        DT<a name='254'>
   INTEGER,      INTENT(IN   )    ::   levsiz, num_months<a name='255'>
   INTEGER,      INTENT(IN   )    ::   paerlev, naer_c<a name='256'>
   INTEGER,      INTENT(IN   )    ::   cam_abs_dim1, cam_abs_dim2<a name='257'>
<a name='258'>
<a name='259'>
   REAL, INTENT(IN    )      ::        RADT,DEGRAD,             &amp;<a name='260'>
                                       XTIME,DECLIN,SOLCON,GMT<a name='261'>
<font color=#447700>!<a name='262'></font>
<font color=#447700>!<a name='263'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp;<a name='264'>
         INTENT(IN    ) ::                                   P_PHY, &amp;<a name='265'>
                                                           P8W, &amp;<a name='266'>
                                                             Z, &amp;<a name='267'>
                                                            pi_PHY, &amp;<a name='268'>
                                                           rho_PHY, &amp;<a name='269'>
                                                              dz8w, &amp;<a name='270'>
                                                             T_PHY, &amp;<a name='271'>
                                                            QV3D, &amp;<a name='272'>
                                                            QC3D, &amp;<a name='273'>
                                                            QR3D, &amp;<a name='274'>
                                                            QI3D, &amp;<a name='275'>
                                                            QS3D, &amp;<a name='276'>
                                                            QG3D, &amp;<a name='277'>
                                                        CLDFRA<a name='278'>
<a name='279'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                  &amp;<a name='280'>
         INTENT(INOUT)  ::                              RTHRATENLW, &amp;<a name='281'>
                                                        RTHRATENSW<a name='282'>
<font color=#447700>!<a name='283'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='284'>
         INTENT(IN   )  ::                                  XLAT, &amp;<a name='285'>
                                                           XLONG, &amp;<a name='286'>
                                                           XLAND, &amp;<a name='287'>
                                                           XICE, &amp;<a name='288'>
                                                           SNOW, &amp;<a name='289'>
                                                           EMISS, &amp;<a name='290'>
                                                             TSK, &amp;<a name='291'>
                                                             ALBEDO<a name='292'>
<a name='293'>
   REAL,  DIMENSION( ims:ime, levsiz, jms:jme, num_months ),      &amp;<a name='294'>
          INTENT(IN   ) ::                                  OZMIXM<a name='295'>
<a name='296'>
   REAL,  DIMENSION(levsiz), INTENT(IN )  ::                   PIN0<a name='297'>
<a name='298'>
   REAL,  DIMENSION(ims:ime,jms:jme), INTENT(IN )  ::      m_psp,m_psn<a name='299'>
   REAL,  DIMENSION(paerlev), intent(in)             ::      m_hybi0<a name='300'>
   REAL,  DIMENSION( ims:ime, paerlev, jms:jme, naer_c ),      &amp;<a name='301'>
          INTENT(IN   ) ::                    aerosolcp, aerosolcn<a name='302'>
<a name='303'>
<font color=#447700>!<a name='304'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='305'>
         INTENT(INOUT)  ::                                   GSW, GLW<a name='306'>
<a name='307'>
<font color=#447700>!---------SSiB variables (fds 06/2010)----------------<a name='308'></font>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='309'>
         INTENT(IN)     ::                            ALSWVISDIR, &amp;<a name='310'>
                                                      ALSWVISDIF, &amp;<a name='311'>
                                                      ALSWNIRDIR, &amp;<a name='312'>
                                                      ALSWNIRDIF<a name='313'>
<a name='314'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='315'>
         INTENT(OUT)    ::                              SWVISDIR, &amp;<a name='316'>
                                                        SWVISDIF, &amp;<a name='317'>
                                                        SWNIRDIR, &amp;<a name='318'>
                                                        SWNIRDIF, &amp;<a name='319'>
							                            SWDDIR,   &amp;<a name='320'>
                                                        SWDDNI,   &amp;<a name='321'>
                                                        SWDDIF<a name='322'>
<a name='323'>
   INTEGER, INTENT(IN) :: sf_surface_physics<a name='324'>
<font color=#447700>!--------------------------------------<a name='325'></font>
<font color=#447700>! saving arrays for doabsems reduction of radiation calcs<a name='326'></font>
<a name='327'>
   REAL, DIMENSION( ims:ime, kms:kme, cam_abs_dim2 , jms:jme ),           &amp;<a name='328'>
         INTENT(INOUT)  ::                                  abstot_3d<a name='329'>
   REAL, DIMENSION( ims:ime, kms:kme, cam_abs_dim1 , jms:jme ),           &amp;<a name='330'>
         INTENT(INOUT)  ::                                  absnxt_3d<a name='331'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),           &amp;<a name='332'>
         INTENT(INOUT)  ::                                  emstot_3d<a name='333'>
<a name='334'>
<a name='335'>
<font color=#447700>! Added outputs of total and clearsky fluxes etc<a name='336'></font>
<font color=#447700>! Note that k=1 refers to the half level below the model lowest level (Sfc)<a name='337'></font>
<font color=#447700>!           k=kme refers to the half level above the model highest level (TOA)<a name='338'></font>
<font color=#447700>!<a name='339'></font>
<font color=#447700>!   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                &amp;<a name='340'></font>
<font color=#447700>!         INTENT(INOUT)  ::                                  swup, &amp;<a name='341'></font>
<font color=#447700>!                                                       swupclear, &amp;<a name='342'></font>
<font color=#447700>!                                                            swdn, &amp;<a name='343'></font>
<font color=#447700>!                                                       swdnclear, &amp;<a name='344'></font>
<font color=#447700>!                                                            lwup, &amp;<a name='345'></font>
<font color=#447700>!                                                       lwupclear, &amp;<a name='346'></font>
<font color=#447700>!                                                            lwdn, &amp;<a name='347'></font>
<font color=#447700>!                                                       lwdnclear<a name='348'></font>
<a name='349'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT) ::&amp;<a name='350'>
                    SWUPT,SWUPTC,SWDNT,SWDNTC,                    &amp;<a name='351'>
                    LWUPT,LWUPTC,LWDNT,LWDNTC,                    &amp;<a name='352'>
                    SWUPB,SWUPBC,SWDNB,SWDNBC,                    &amp;<a name='353'>
                    LWUPB,LWUPBC,LWDNB,LWDNBC<a name='354'>
<a name='355'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='356'>
         INTENT(INOUT)  ::                                  swcf, &amp;<a name='357'>
                                                            lwcf, &amp;<a name='358'>
                                                             olr, &amp;<a name='359'>
                                                            coszr    <a name='360'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme )                 , &amp;<a name='361'>
         INTENT(OUT   )  ::                               cemiss, &amp;        <font color=#447700>! cloud emissivity for isccp<a name='362'></font>
                                                         taucldc, &amp;        <font color=#447700>! cloud water optical depth for isccp<a name='363'></font>
                                                         taucldi           <font color=#447700>! cloud ice optical depth for isccp<a name='364'></font>
<font color=#447700>!<a name='365'></font>
<font color=#447700>!<a name='366'></font>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                     &amp;<a name='367'>
         INTENT(IN   ) ::                                            &amp;<a name='368'>
                                                          F_ICE_PHY, &amp;<a name='369'>
                                                         F_RAIN_PHY<a name='370'>
<a name='371'>
  real, dimension(ims:ime,jms:jme), optional, intent(in) :: coszen<a name='372'>
<a name='373'>
<font color=#447700>! LOCAL VARIABLES<a name='374'></font>
 <a name='375'>
   INTEGER :: lchnk, ncol, pcols, pver, pverp, pverr, pverrp<a name='376'>
   INTEGER :: pcnst, pnats, ppcnst, i, j, k, ii, kk, kk1, m, n<a name='377'>
   integer :: begchunk, endchunk<a name='378'>
   integer :: nyrm, nyrp<a name='379'>
   real(r8) doymodel, doydatam, doydatap, deltat, fact1, fact2<a name='380'>
<a name='381'>
   REAL :: XT24, TLOCTM, HRANG, XXLAT, oldXT24<a name='382'>
 <a name='383'>
   real(r8), DIMENSION( 1:ite-its+1 ) :: coszrs, landfrac, landm, snowh, icefrac, lwups<a name='384'>
   real(r8), DIMENSION( 1:ite-its+1 ) :: asdir, asdif, aldir, aldif, ps<a name='385'>
   real(r8), DIMENSION( 1:ite-its+1, 1:kte-kts+1 ) :: cld, pmid, lnpmid, pdel, zm, t<a name='386'>
   real(r8), DIMENSION( 1:ite-its+1, 1:kte-kts+2 ) ::  pint, lnpint<a name='387'>
   real(r8), DIMENSION( 1:ite-its+1, 1:kte-kts+1, n_cldadv) :: q<a name='388'>
<font color=#447700>!   real(r8), DIMENSION( 1:kte-kts+1 ) :: hypm       ! reference pressures at midpoints<a name='389'></font>
<font color=#447700>!   real(r8), DIMENSION( 1:kte-kts+2 ) :: hypi       ! reference pressures at interfaces<a name='390'></font>
    real(r8), dimension(  1:ite-its+1, 1:kte-kts+1 ) :: cicewp      <font color=#447700>! in-cloud cloud ice water path<a name='391'></font>
    real(r8), dimension(  1:ite-its+1, 1:kte-kts+1 ) :: cliqwp      <font color=#447700>! in-cloud cloud liquid water path<a name='392'></font>
    real(r8), dimension(  1:ite-its+1, 0:kte-kts+1 ) :: tauxcl      <font color=#447700>! cloud water optical depth<a name='393'></font>
    real(r8), dimension(  1:ite-its+1, 0:kte-kts+1 ) :: tauxci      <font color=#447700>! cloud ice optical depth<a name='394'></font>
    real(r8), dimension(  1:ite-its+1, 1:kte-kts+1 ) :: emis        <font color=#447700>! cloud emissivity<a name='395'></font>
    real(r8), dimension(  1:ite-its+1, 1:kte-kts+1 ) :: rel         <font color=#447700>! effective drop radius (microns)<a name='396'></font>
    real(r8), dimension(  1:ite-its+1, 1:kte-kts+1 ) :: rei         <font color=#447700>! ice effective drop size (microns)<a name='397'></font>
    real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 ) :: pmxrgn      <font color=#447700>! Maximum values of pressure for each<a name='398'></font>
    integer , dimension(  1:ite-its+1 ) :: nmxrgn               <font color=#447700>! Number of maximally overlapped regions<a name='399'></font>
<a name='400'>
   real(r8), dimension(  1:ite-its+1 ) :: fsns          <font color=#447700>! Surface absorbed solar flux<a name='401'></font>
   real(r8), dimension(  1:ite-its+1 ) :: fsnt          <font color=#447700>! Net column abs solar flux at model top<a name='402'></font>
   real(r8), dimension(  1:ite-its+1 ) :: flns          <font color=#447700>! Srf longwave cooling (up-down) flux<a name='403'></font>
   real(r8), dimension(  1:ite-its+1 ) :: flnt          <font color=#447700>! Net outgoing lw flux at model top<a name='404'></font>
<font color=#447700>! Added outputs of total and clearsky fluxes etc<a name='405'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fsup        <font color=#447700>! Upward total sky solar<a name='406'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fsupc       <font color=#447700>! Upward clear sky solar<a name='407'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fsdn        <font color=#447700>! Downward total sky solar<a name='408'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fsdnc       <font color=#447700>! Downward clear sky solar<a name='409'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fsdndir     <font color=#447700>! Direct Downward total sky solar amontornes-bcodina (2014-04-20)<a name='410'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fsdncdir    <font color=#447700>! Direct Downward clear sky solar amontornes-bcodina (2014-04-20)<a name='411'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fsdndif     <font color=#447700>! Diffuse Downward total sky solar amontornes-bcodina (2014-04-20)<a name='412'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fsdncdif    <font color=#447700>! Diffuse Downward clear sky solar amontornes-bcodina (2014-04-20)<a name='413'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: flup        <font color=#447700>! Upward total sky longwave<a name='414'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: flupc       <font color=#447700>! Upward clear sky longwave<a name='415'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fldn        <font color=#447700>! Downward total sky longwave<a name='416'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+2 )  :: fldnc       <font color=#447700>! Downward clear sky longwave<a name='417'></font>
   real(r8), dimension(  1:ite-its+1 ) :: swcftoa                 <font color=#447700>! Top of the atmosphere solar cloud forcing<a name='418'></font>
   real(r8), dimension(  1:ite-its+1 ) :: lwcftoa                 <font color=#447700>! Top of the atmosphere longwave cloud forcing<a name='419'></font>
   real(r8), dimension(  1:ite-its+1 ) :: olrtoa                  <font color=#447700>! Top of the atmosphere outgoing longwave <a name='420'></font>
<font color=#447700>!<a name='421'></font>
   real(r8), dimension(  1:ite-its+1 ) :: sols          <font color=#447700>! Downward solar rad onto surface (sw direct)<a name='422'></font>
   real(r8), dimension(  1:ite-its+1 ) :: soll          <font color=#447700>! Downward solar rad onto surface (lw direct)<a name='423'></font>
   real(r8), dimension(  1:ite-its+1 ) :: solsd         <font color=#447700>! Downward solar rad onto surface (sw diffuse)<a name='424'></font>
   real(r8), dimension(  1:ite-its+1 ) :: solld         <font color=#447700>! Downward solar rad onto surface (lw diffuse)<a name='425'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+1 ) :: qrs      <font color=#447700>! Solar heating rate<a name='426'></font>
   real(r8), dimension(  1:ite-its+1 ) :: fsds          <font color=#447700>! Flux Shortwave Downwelling Surface<a name='427'></font>
   real(r8), dimension(  1:ite-its+1 ) :: fsdsdir       <font color=#447700>! Flux Shortwave Direct Downwelling Surface<a name='428'></font>
   real(r8), dimension(  1:ite-its+1 ) :: fsdsdif       <font color=#447700>! Flux Shortwave Diffuse Downwelling Surface<a name='429'></font>
   real(r8), dimension(  1:ite-its+1, 1:kte-kts+1 ) :: qrl      <font color=#447700>! Longwave cooling rate<a name='430'></font>
   real(r8), dimension(  1:ite-its+1 ) :: flwds          <font color=#447700>! Surface down longwave flux<a name='431'></font>
   real(r8), dimension(  1:ite-its+1, levsiz, num_months ) :: ozmixmj        <font color=#447700>! monthly ozone mixing ratio<a name='432'></font>
   real(r8), dimension(  1:ite-its+1, levsiz ) :: ozmix          <font color=#447700>! ozone mixing ratio (time interpolated)<a name='433'></font>
   real(r8), dimension(levsiz)         :: pin            <font color=#447700>! ozone pressure level<a name='434'></font>
   real(r8), dimension(1:ite-its+1)    :: m_psjp,m_psjn          <font color=#447700>! MATCH surface pressure<a name='435'></font>
   real(r8), dimension(  1:ite-its+1, paerlev, naer_c ) :: aerosoljp        <font color=#447700>! monthly aerosol concentrations<a name='436'></font>
   real(r8), dimension(  1:ite-its+1, paerlev, naer_c ) :: aerosoljn        <font color=#447700>! monthly aerosol concentrations<a name='437'></font>
   real(r8), dimension(paerlev)                           :: m_hybi<a name='438'>
   real(r8), dimension(1:ite-its+1 )          :: clat           <font color=#447700>! latitude in radians for columns<a name='439'></font>
   real(r8), dimension(its:ite,kts:kte+1,kts:kte+1) :: abstot <font color=#447700>! Total absorptivity<a name='440'></font>
   real(r8), dimension(its:ite,kts:kte,4)           :: absnxt <font color=#447700>! Total nearest layer absorptivity<a name='441'></font>
   real(r8), dimension(its:ite,kts:kte+1)           :: emstot <font color=#447700>! Total emissivity<a name='442'></font>
   CHARACTER(LEN=256) :: msgstr<a name='443'>
<a name='444'>
<font color=#447700>!ccc<a name='445'></font>
#ifdef CLWRFGHG<a name='446'>
<font color=#447700>! CLWRF-UC June.09 <a name='447'></font>
   REAL(r8)                                         :: co2vmr, n2ovmr, ch4vmr, f11vmr, f12vmr<a name='448'>
#endif<a name='449'>
   LOGICAL, EXTERNAL                                :: wrf_dm_on_monitor<a name='450'>
   CHARACTER(LEN=256)                               :: message<a name='451'>
<a name='452'>
<font color=#447700>!ccc<a name='453'></font>
<a name='454'>
#if <font color=#447700>!defined(MAC_KLUDGE)<a name='455'></font>
   lchnk = 1<a name='456'>
   begchunk = ims<a name='457'>
   endchunk = ime<a name='458'>
   ncol = ite - its + 1<a name='459'>
   pcols= ite - its + 1<a name='460'>
   pver = kte - kts + 1<a name='461'>
   pverp= pver + 1<a name='462'>
   pverr = kte - kts + 1<a name='463'>
   pverrp= pverr + 1<a name='464'>
<font color=#447700>! number of advected constituents and non-advected constituents (including water vapor)<a name='465'></font>
   ppcnst = n_cldadv<a name='466'>
<font color=#447700>! number of non-advected constituents<a name='467'></font>
   pnats = 0<a name='468'>
   pcnst = ppcnst-pnats<a name='469'>
<a name='470'>
<font color=#447700>! check the # species defined for the input climatology and naer<a name='471'></font>
<a name='472'>
<font color=#447700>!  if(naer_c.ne.naer) then<a name='473'></font>
<font color=#447700>!            WRITE( wrf_err_message , * ) 'naer_c ne naer ', naer_c, naer<a name='474'></font>
   if(naer_c.ne.naer_all) then<a name='475'>
             WRITE( wrf_err_message , * ) 'naer_c-1 ne naer_all ', naer_c, naer_all<a name='476'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_976"> ( wrf_err_message )<a name='477'>
   endif <a name='478'>
<a name='479'>
<font color=#447700>! update CO2 volume mixing ratio (co2vmr)<a name='480'></font>
  <a name='481'>
<font color=#447700>! determine time interpolation factors, check sanity<a name='482'></font>
<font color=#447700>! of interpolation factors to within 32-bit roundoff<a name='483'></font>
<font color=#447700>! assume that day of year is 1 for all input data<a name='484'></font>
<font color=#447700>!<a name='485'></font>
<font color=#447700>!ccc<a name='486'></font>
#ifdef CLWRFGHG<a name='487'>
<font color=#447700>! CLWRF-UC June.09  (Copy from share/wrf_tsin.F)<a name='488'></font>
<a name='489'>
   CALL <A href='../../html_code/phys/module_ra_clWRF_support.F.html#READ_CAMGASES'>read_CAMgases</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_CAMGASES_1">(yr,julian,"CAM",co2vmr,n2ovmr,ch4vmr,f11vmr,f12vmr)<a name='490'>
<a name='491'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='492'>
     WRITE(message,*)'write 1 CAM-CLWRF interpolated values______ year:',yr,' julian day:',julian<a name='493'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_753">( 100, message)<a name='494'>
     WRITE(message,*)'  CAM-CLWRF co2vmr: ',co2vmr,' n2ovmr:',n2ovmr,' ch4vmr:',ch4vmr,' cfc11:'&amp;<a name='495'>
       ,f11vmr,' cfc12:',f12vmr<a name='496'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_754">( 100, message)<a name='497'>
   ENDIF<a name='498'>
<a name='499'>
#else<a name='500'>
<font color=#447700>!ccc<a name='501'></font>
   nyrm     = yr - yrdata(1) + 1<a name='502'>
   nyrp     = nyrm + 1<a name='503'>
   doymodel = yr*365.    + julian<a name='504'>
   doydatam = yrdata(nyrm)*365. + 1.<a name='505'>
   doydatap = yrdata(nyrp)*365. + 1.<a name='506'>
   deltat   = doydatap - doydatam<a name='507'>
   fact1    = (doydatap - doymodel)/deltat<a name='508'>
   fact2    = (doymodel - doydatam)/deltat<a name='509'>
   co2vmr = (co2(nyrm)*fact1 + co2(nyrp)*fact2)*1.e-06<a name='510'>
<font color=#447700>!ccc<a name='511'></font>
   IF ( wrf_dm_on_monitor() ) THEN<a name='512'>
     WRITE(message,*)'CAM interpolated values_____ year:',yr,' julian day:',julian<a name='513'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_755">( 100, message)<a name='514'>
     WRITE(message,*)'CAM co2vmr: ',co2vmr,' n2ovmr:',n2ovmr,' ch4vmr:',ch4vmr,' cfc11:',f11vmr,&amp;<a name='515'>
       ' cfc12:',f12vmr<a name='516'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_756">( 100, message)<a name='517'>
   ENDIF<a name='518'>
#endif<a name='519'>
<font color=#447700>!ccc<a name='520'></font>
<a name='521'>
   co2mmr=co2vmr*mwco2/mwdry<a name='522'>
<font color=#447700>!<a name='523'></font>
<font color=#447700>!===================================================<a name='524'></font>
<font color=#447700>! Radiation computations<a name='525'></font>
<font color=#447700>!===================================================<a name='526'></font>
<a name='527'>
      do k=1,levsiz<a name='528'>
      pin(k)=pin0(k)<a name='529'>
      enddo<a name='530'>
<a name='531'>
      do k=1,paerlev<a name='532'>
      m_hybi(k)=m_hybi0(k)<a name='533'>
      enddo<a name='534'>
<a name='535'>
<font color=#447700>! check for uninitialized arrays<a name='536'></font>
      if(abstot_3d(its,kts,kts,jts) .eq. 0.0 .and. .not.doabsems .and. dolw)then<a name='537'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_757">(0, 'camrad lw: CAUTION: re-calculating abstot, absnxt, emstot on restart')<a name='538'>
        doabsems = .true.<a name='539'>
      endif<a name='540'>
<a name='541'>
   do j =jts,jte<a name='542'>
<a name='543'>
<font color=#447700>!<a name='544'></font>
<font color=#447700>! Cosine solar zenith angle for current time step<a name='545'></font>
<font color=#447700>!<a name='546'></font>
<a name='547'>
<font color=#447700>!  call zenith (calday, clat, clon, coszrs, ncol)<a name='548'></font>
<a name='549'>
      if (present(coszen)) then<a name='550'>
         do i=its,ite<a name='551'>
            ii=i-its+1<a name='552'>
            clat(ii)=XLAT(I,J)*DEGRAD<a name='553'>
            coszrs(ii)=coszen(i,j)<a name='554'>
         enddo<a name='555'>
      else<a name='556'>
         do i = its,ite<a name='557'>
            ii = i - its + 1<a name='558'>
            <font color=#447700>! XT24 is the fractional part of simulation days plus half of RADT expressed in <a name='559'></font>
            <font color=#447700>! units of minutes<a name='560'></font>
            <font color=#447700>! JULIAN is in days<a name='561'></font>
            <font color=#447700>! RADT is in minutes<a name='562'></font>
            XT24=MOD(XTIME+RADT*0.5,1440.)<a name='563'>
            TLOCTM=GMT+XT24/60.+XLONG(I,J)/15.<a name='564'>
            HRANG=15.*(TLOCTM-12.)*DEGRAD<a name='565'>
            XXLAT=XLAT(I,J)*DEGRAD<a name='566'>
            clat(ii)=xxlat<a name='567'>
            coszrs(II)=SIN(XXLAT)*SIN(DECLIN)+COS(XXLAT)*COS(DECLIN)*COS(HRANG)<a name='568'>
         enddo<a name='569'>
      end if<a name='570'>
<a name='571'>
<font color=#447700>! moist variables<a name='572'></font>
<a name='573'>
      do k = kts,kte<a name='574'>
      kk = kte - k + kts <a name='575'>
      do i = its,ite<a name='576'>
      ii = i - its + 1<a name='577'>
<font color=#447700>!    convert to specific humidity<a name='578'></font>
      q(ii,kk,1) = max(1.e-10,qv3d(i,k,j)/(1.+qv3d(i,k,j)))<a name='579'>
     IF ( F_QI .and. F_QC .and. F_QS ) THEN<a name='580'>
      q(ii,kk,ixcldliq) = max(0.,qc3d(i,k,j)/(1.+qv3d(i,k,j)))<a name='581'>
      q(ii,kk,ixcldice) = max(0.,(qi3d(i,k,j)+qs3d(i,k,j))/(1.+qv3d(i,k,j)))<a name='582'>
     ELSE IF ( F_QC .and. F_QI ) THEN<a name='583'>
<font color=#447700>! For Ferrier (note fixed after V3.8.1 for hires window Ferrier)<a name='584'></font>
      q(ii,kk,ixcldice) = max(0.,qi3d(i,k,j)/(1.+qv3d(i,k,j)))<a name='585'>
      q(ii,kk,ixcldliq) = max(0.,qc3d(i,k,j)/(1.+qv3d(i,k,j)))<a name='586'>
     ELSE IF ( F_QC .and. F_QR ) THEN<a name='587'>
<font color=#447700>! Warm rain or simple ice<a name='588'></font>
      q(ii,kk,ixcldliq) = 0.<a name='589'>
      q(ii,kk,ixcldice) = 0.<a name='590'>
      if(t_phy(i,k,j).gt.273.15)q(ii,kk,ixcldliq) = max(0.,qc3d(i,k,j)/(1.+qv3d(i,k,j)))<a name='591'>
      if(t_phy(i,k,j).le.273.15)q(ii,kk,ixcldice) = max(0.,qc3d(i,k,j)/(1.+qv3d(i,k,j)))<a name='592'>
     ELSE<a name='593'>
      q(ii,kk,ixcldliq) = 0.<a name='594'>
      q(ii,kk,ixcldice) = 0.<a name='595'>
     ENDIF<a name='596'>
      cld(ii,kk) = CLDFRA(I,K,J)<a name='597'>
      enddo<a name='598'>
      enddo<a name='599'>
<a name='600'>
      do i = its,ite<a name='601'>
      ii = i - its + 1<a name='602'>
      landfrac(ii) = 2.-XLAND(I,J)<a name='603'>
      landm(ii) = landfrac(ii)<a name='604'>
      snowh(ii) = 0.001*SNOW(I,J)<a name='605'>
      icefrac(ii) = XICE(I,J)<a name='606'>
      enddo<a name='607'>
<a name='608'>
      do m=1,num_months-1<a name='609'>
      do k=1,levsiz<a name='610'>
      do i = its,ite<a name='611'>
      ii = i - its + 1<a name='612'>
      ozmixmj(ii,k,m) = ozmixm(i,k,j,m+1)<a name='613'>
      enddo<a name='614'>
      enddo<a name='615'>
      enddo<a name='616'>
<a name='617'>
      do i = its,ite<a name='618'>
      ii = i - its + 1<a name='619'>
      m_psjp(ii) = m_psp(i,j)<a name='620'>
      m_psjn(ii) = m_psn(i,j)<a name='621'>
      enddo<a name='622'>
<a name='623'>
      do n=1,naer_c<a name='624'>
      do k=1,paerlev<a name='625'>
      do i = its,ite<a name='626'>
      ii = i - its + 1<a name='627'>
      aerosoljp(ii,k,n) = aerosolcp(i,k,j,n)<a name='628'>
      aerosoljn(ii,k,n) = aerosolcn(i,k,j,n)<a name='629'>
      enddo<a name='630'>
      enddo<a name='631'>
      enddo<a name='632'>
<a name='633'>
<font color=#447700>!<a name='634'></font>
<font color=#447700>! Complete radiation calculations<a name='635'></font>
<font color=#447700>!<a name='636'></font>
      do i = its,ite<a name='637'>
      ii = i - its + 1<a name='638'>
      lwups(ii) = stebol*EMISS(I,J)*TSK(I,J)**4<a name='639'>
      enddo<a name='640'>
<a name='641'>
      do k = kts,kte+1<a name='642'>
      kk = kte - k + kts + 1<a name='643'>
      do i = its,ite<a name='644'>
      ii = i - its + 1<a name='645'>
      pint(ii,kk) = p8w(i,k,j)<a name='646'>
      if(k.eq.kts)ps(ii)=pint(ii,kk)<a name='647'>
      lnpint(ii,kk) = log(pint(ii,kk))<a name='648'>
      enddo<a name='649'>
      enddo<a name='650'>
<a name='651'>
      if(.not.doabsems .and. dolw)then<a name='652'>
<font color=#447700>!      do kk = kts,kte+1<a name='653'></font>
      do kk = 1,cam_abs_dim2<a name='654'>
        do kk1 = kts,kte+1<a name='655'>
          do i = its,ite<a name='656'>
            abstot(i,kk1,kk) = abstot_3d(i,kk1,kk,j)<a name='657'>
          enddo<a name='658'>
        enddo<a name='659'>
      enddo<a name='660'>
<font color=#447700>!      do kk = 1,4<a name='661'></font>
      do kk = 1,cam_abs_dim1<a name='662'>
        do kk1 = kts,kte<a name='663'>
          do i = its,ite<a name='664'>
            absnxt(i,kk1,kk) = absnxt_3d(i,kk1,kk,j)<a name='665'>
          enddo<a name='666'>
        enddo<a name='667'>
      enddo<a name='668'>
      do kk = kts,kte+1<a name='669'>
          do i = its,ite<a name='670'>
            emstot(i,kk) = emstot_3d(i,kk,j)<a name='671'>
          enddo<a name='672'>
      enddo<a name='673'>
      endif<a name='674'>
<a name='675'>
      do k = kts,kte<a name='676'>
      kk = kte - k + kts <a name='677'>
      do i = its,ite<a name='678'>
      ii = i - its + 1<a name='679'>
      pmid(ii,kk) = p_phy(i,k,j)<a name='680'>
      lnpmid(ii,kk) = log(pmid(ii,kk))<a name='681'>
      lnpint(ii,kk) = log(pint(ii,kk))<a name='682'>
      pdel(ii,kk) = pint(ii,kk+1) - pint(ii,kk)<a name='683'>
      t(ii,kk) = t_phy(i,k,j)<a name='684'>
      zm(ii,kk) = z(i,k,j)<a name='685'>
      enddo<a name='686'>
      enddo<a name='687'>
<a name='688'>
<a name='689'>
<font color=#447700>! Compute cloud water/ice paths and optical properties for input to radiation<a name='690'></font>
<a name='691'>
      call <A href='../../html_code/phys/module_ra_cam.F.html#PARAM_CLDOPTICS_CALC'>param_cldoptics_calc</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PARAM_CLDOPTICS_CALC_1">(ncol, pcols, pver, pverp, pverr, pverrp, ppcnst, q, cld, landfrac, landm,icefrac, &amp;<a name='692'>
                                pdel, t, ps, pmid, pint, cicewp, cliqwp, emis, rel, rei, pmxrgn, nmxrgn, snowh)<a name='693'>
<a name='694'>
<font color=#447700>!-----fds (06/2010)----------------------------<a name='695'></font>
   SELECT CASE(sf_surface_physics)<a name='696'>
   CASE (SSIBSCHEME)<a name='697'>
   if (xtime .gt. 1.0) then<a name='698'>
<font color=#447700>!      call wrf_message("using SSiB albedoes for land points")<a name='699'></font>
      do i = its,ite<a name='700'>
         ii = i - its + 1<a name='701'>
         if (xland(i,j).lt.1.5) then   <font color=#447700>!land points only<a name='702'></font>
           asdir(ii) = ALSWVISDIR(i,j) <font color=#447700>! SSiB visdir albedo<a name='703'></font>
           asdif(ii) = ALSWVISDIF(i,j) <font color=#447700>! SSiB visdif albedo<a name='704'></font>
           aldir(ii) = ALSWNIRDIR(i,j) <font color=#447700>! SSiB nirdir albedo<a name='705'></font>
           aldif(ii) = ALSWNIRDIF(i,j) <font color=#447700>! SSiB nirdif albedo<a name='706'></font>
         else<a name='707'>
           asdir(ii) = albedo(i,j)<a name='708'>
           asdif(ii) = albedo(i,j)<a name='709'>
           aldir(ii) = albedo(i,j)<a name='710'>
           aldif(ii) = albedo(i,j)<a name='711'>
         endif<a name='712'>
      enddo<a name='713'>
   else<a name='714'>
      do i = its,ite<a name='715'>
         ii = i - its + 1<a name='716'>
         asdir(ii) = albedo(i,j)<a name='717'>
         asdif(ii) = albedo(i,j)<a name='718'>
         aldir(ii) = albedo(i,j)<a name='719'>
         aldif(ii) = albedo(i,j)<a name='720'>
      enddo<a name='721'>
   endif<a name='722'>
   CASE (CLMSCHEME)<a name='723'>
   if (xtime .gt. 1.0) then<a name='724'>
      do i = its,ite<a name='725'>
         ii = i - its + 1<a name='726'>
         if (xland(i,j).lt.1.5) then   <font color=#447700>!land points only<a name='727'></font>
           asdir(ii) = ALSWVISDIR(i,j) <font color=#447700>! CLM visdir albedo<a name='728'></font>
           asdif(ii) = ALSWVISDIF(i,j) <font color=#447700>! CLM visdif albedo<a name='729'></font>
           aldir(ii) = ALSWNIRDIR(i,j) <font color=#447700>! CLM nirdir albedo<a name='730'></font>
           aldif(ii) = ALSWNIRDIF(i,j) <font color=#447700>! CLM nirdif albedo<a name='731'></font>
         else<a name='732'>
           asdir(ii) = albedo(i,j)<a name='733'>
           asdif(ii) = albedo(i,j)<a name='734'>
           aldir(ii) = albedo(i,j)<a name='735'>
           aldif(ii) = albedo(i,j)<a name='736'>
         endif<a name='737'>
      enddo<a name='738'>
   else<a name='739'>
      do i = its,ite<a name='740'>
         ii = i - its + 1<a name='741'>
         asdir(ii) = albedo(i,j)<a name='742'>
         asdif(ii) = albedo(i,j)<a name='743'>
         aldir(ii) = albedo(i,j)<a name='744'>
         aldif(ii) = albedo(i,j)<a name='745'>
      enddo<a name='746'>
   endif<a name='747'>
<a name='748'>
   CASE DEFAULT<a name='749'>
      do i = its,ite<a name='750'>
      ii = i - its + 1<a name='751'>
<font color=#447700>! use same albedo for direct and diffuse<a name='752'></font>
<font color=#447700>! change this when separate values are provided<a name='753'></font>
      asdir(ii) = albedo(i,j)<a name='754'>
      asdif(ii) = albedo(i,j)<a name='755'>
      aldir(ii) = albedo(i,j)<a name='756'>
      aldif(ii) = albedo(i,j)<a name='757'>
      enddo<a name='758'>
   END SELECT<a name='759'>
<font color=#447700>!-----------------------------------------------<a name='760'></font>
<a name='761'>
<font color=#447700>! WRF allocate space here (not needed if oznini is called)<a name='762'></font>
<font color=#447700>!  allocate (ozmix(pcols,levsiz,begchunk:endchunk)) ! This line from oznini.F90<a name='763'></font>
<a name='764'>
      call <A href='../../html_code/phys/module_ra_cam.F.html#RADCTL'>radctl</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRAD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADCTL_1"> (j,lchnk, ncol, pcols, pver, pverp, pverr, pverrp, ppcnst, pcnst, lwups, emis, pmid,             &amp;<a name='765'>
                   pint, lnpmid, lnpint, pdel, t, q,   &amp;<a name='766'>
                   cld, cicewp, cliqwp, tauxcl, tauxci, coszrs, clat, asdir, asdif,               &amp;<a name='767'>
                   aldir, aldif, solcon, GMT,JULDAY,JULIAN,DT,XTIME,   &amp;<a name='768'>
                   pin, ozmixmj, ozmix, levsiz, num_months,  &amp; <a name='769'>
                   m_psjp,m_psjn, aerosoljp, aerosoljn,  m_hybi, paerlev, naer_c, pmxrgn, nmxrgn, &amp;<a name='770'>
                   dolw, dosw, doabsems, abstot, absnxt, emstot, &amp;<a name='771'>
                   fsup, fsupc, fsdn, fsdnc,            &amp;<a name='772'>
                   fsdndir ,fsdncdir,fsdndif ,fsdncdif, &amp; <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes<a name='773'></font>
                   flup, flupc, fldn, fldnc, swcftoa, lwcftoa, olrtoa,  &amp;<a name='774'>
                   fsns, fsnt    ,flns    ,flnt    , &amp;<a name='775'>
                   qrs, qrl, flwds, rel, rei,                       &amp;<a name='776'>
                   sols, soll, solsd, solld,                  &amp;<a name='777'>
<font color=#447700>!ccc<a name='778'></font>
#ifdef CLWRFGHG<a name='779'>
<font color=#447700>!CLWRF-UC June.09<a name='780'></font>
                   n2ovmr, ch4vmr, f11vmr, f12vmr  , &amp;<a name='781'>
#endif<a name='782'>
<font color=#447700>!ccc<a name='783'></font>
                   landfrac, zm, fsds, fsdsdir, fsdsdif) <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes<a name='784'></font>
<a name='785'>
      do k = kts,kte<a name='786'>
      kk = kte - k + kts <a name='787'>
      do i = its,ite<a name='788'>
      ii = i - its + 1<a name='789'>
      if(dolw)RTHRATENLW(I,K,J) = 1.e4*qrl(ii,kk)/(cpair*pi_phy(i,k,j))<a name='790'>
      if(dosw)RTHRATENSW(I,K,J) = 1.e4*qrs(ii,kk)/(cpair*pi_phy(i,k,j))<a name='791'>
      cemiss(i,k,j)     = emis(ii,kk)<a name='792'>
      taucldc(i,k,j)    = tauxcl(ii,kk)<a name='793'>
      taucldi(i,k,j)    = tauxci(ii,kk)<a name='794'>
      enddo<a name='795'>
      enddo<a name='796'>
<a name='797'>
      if(doabsems .and. dolw)then<a name='798'>
<font color=#447700>!      do kk = kts,kte+1<a name='799'></font>
      do kk = 1,cam_abs_dim2<a name='800'>
        do kk1 = kts,kte+1<a name='801'>
          do i = its,ite<a name='802'>
            abstot_3d(i,kk1,kk,j) = abstot(i,kk1,kk)<a name='803'>
          enddo<a name='804'>
        enddo<a name='805'>
      enddo<a name='806'>
<font color=#447700>!      do kk = 1,4<a name='807'></font>
      do kk = 1,cam_abs_dim1<a name='808'>
        do kk1 = kts,kte<a name='809'>
          do i = its,ite<a name='810'>
            absnxt_3d(i,kk1,kk,j) = absnxt(i,kk1,kk)<a name='811'>
          enddo<a name='812'>
        enddo<a name='813'>
      enddo<a name='814'>
      do kk = kts,kte+1<a name='815'>
          do i = its,ite<a name='816'>
            emstot_3d(i,kk,j) = emstot(i,kk)<a name='817'>
          enddo<a name='818'>
      enddo<a name='819'>
      endif<a name='820'>
<a name='821'>
      IF(PRESENT(SWUPT))THEN<a name='822'>
      if(dosw)then<a name='823'>
<font color=#447700>! Added shortwave and longwave upward/downward total and clear sky fluxes<a name='824'></font>
      do k = kts,kte+1<a name='825'>
      kk = kte +1 - k + kts<a name='826'>
      do i = its,ite<a name='827'>
      ii = i - its + 1<a name='828'>
<font color=#447700>!      swup(i,k,j)      = fsup(ii,kk)<a name='829'></font>
<font color=#447700>!      swupclear(i,k,j) = fsupc(ii,kk)<a name='830'></font>
<font color=#447700>!      swdn(i,k,j)      = fsdn(ii,kk)<a name='831'></font>
<font color=#447700>!      swdnclear(i,k,j) = fsdnc(ii,kk)<a name='832'></font>
       if(k.eq.kte+1)then<a name='833'>
         swupt(i,j)     = fsup(ii,kk)<a name='834'>
         swuptc(i,j)    = fsupc(ii,kk)<a name='835'>
         swdnt(i,j)     = fsdn(ii,kk)<a name='836'>
         swdntc(i,j)    = fsdnc(ii,kk)<a name='837'>
       endif<a name='838'>
       if(k.eq.kts)then<a name='839'>
         swupb(i,j)     = fsup(ii,kk)<a name='840'>
         swupbc(i,j)    = fsupc(ii,kk)<a name='841'>
         swdnb(i,j)     = fsdn(ii,kk)<a name='842'>
         swdnbc(i,j)    = fsdnc(ii,kk)<a name='843'>
       endif<a name='844'>
<font color=#447700>!            if(i.eq.30.and.j.eq.30) then<a name='845'></font>
<font color=#447700>!            print 1234, 'short ', i,ii,k,kk,fsup(ii,kk),fsupc(ii,kk),fsdn(ii,kk),fsdnc(ii,kk)<a name='846'></font>
<font color=#447700>!            1234 format (a6,4i4,4f10.3)<a name='847'></font>
<font color=#447700>!            endif<a name='848'></font>
     enddo<a name='849'>
      enddo<a name='850'>
      endif<a name='851'>
      if(dolw)then<a name='852'>
<font color=#447700>! Added shortwave and longwave upward/downward total and clear sky fluxes<a name='853'></font>
      do k = kts,kte+1<a name='854'>
      kk = kte +1 - k + kts<a name='855'>
      do i = its,ite<a name='856'>
      ii = i - its + 1<a name='857'>
<font color=#447700>!      lwup(i,k,j)      = flup(ii,kk)<a name='858'></font>
<font color=#447700>!      lwupclear(i,k,j) = flupc(ii,kk)<a name='859'></font>
<font color=#447700>!      lwdn(i,k,j)      = fldn(ii,kk)<a name='860'></font>
<font color=#447700>!      lwdnclear(i,k,j) = fldnc(ii,kk)<a name='861'></font>
       if(k.eq.kte+1)then<a name='862'>
         lwupt(i,j)     = flup(ii,kk)<a name='863'>
         lwuptc(i,j)    = flupc(ii,kk)<a name='864'>
         lwdnt(i,j)     = fldn(ii,kk)<a name='865'>
         lwdntc(i,j)    = fldnc(ii,kk)<a name='866'>
       endif<a name='867'>
       if(k.eq.kts)then<a name='868'>
         lwupb(i,j)     = flup(ii,kk)<a name='869'>
         lwupbc(i,j)    = flupc(ii,kk)<a name='870'>
         lwdnb(i,j)     = fldn(ii,kk)<a name='871'>
         lwdnbc(i,j)    = fldnc(ii,kk)<a name='872'>
       endif<a name='873'>
<font color=#447700>!            if(i.eq.30.and.j.eq.30) then<a name='874'></font>
<font color=#447700>!            print 1234, 'long  ', i,ii,k,kk,flup(ii,kk),flupc(ii,kk),fldn(ii,kk),fldnc(ii,kk)<a name='875'></font>
<font color=#447700>!            1234 format (a6,4i4,4f10.3)<a name='876'></font>
<font color=#447700>!            endif<a name='877'></font>
      enddo<a name='878'>
      enddo<a name='879'>
      endif<a name='880'>
      ENDIF<a name='881'>
<a name='882'>
      do i = its,ite<a name='883'>
      ii = i - its + 1<a name='884'>
<font color=#447700>! Added shortwave and longwave cloud forcing at TOA and surface<a name='885'></font>
      if(dolw)then<a name='886'>
        GLW(I,J) = flwds(ii)<a name='887'>
        lwcf(i,j) = lwcftoa(ii)<a name='888'>
        olr(i,j)  = olrtoa(ii)<a name='889'>
      endif<a name='890'>
      if(dosw)then<a name='891'>
        GSW(I,J) = fsns(ii)<a name='892'>
        swcf(i,j) = swcftoa(ii)<a name='893'>
        coszr(i,j) = coszrs(ii)<a name='894'>
        SWDDIR(i,j)= fsdsdir(ii)               <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='895'></font>
        SWDDNI(i,j)= fsdsdir(ii)/coszrs(ii)    <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='896'></font>
        SWDDIF(i,j)= fsdsdif(ii)               <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='897'></font>
      endif<a name='898'>
      enddo<a name='899'>
<font color=#447700>!-------fds (06/2010)---------<a name='900'></font>
   SELECT CASE(sf_surface_physics)<a name='901'>
   CASE (SSIBSCHEME)<a name='902'>
<font color=#447700>!   call wrf_message("CAM using ssib albedo2")<a name='903'></font>
      if(dosw)then<a name='904'>
      do i = its,ite<a name='905'>
        ii = i - its + 1<a name='906'>
        SWVISDIR(I,J) = sols(ii)  <font color=#447700>!SSiB <a name='907'></font>
        SWVISDIF(I,J) = solsd(ii) <font color=#447700>!SSiB <a name='908'></font>
        SWNIRDIR(I,J) = soll(ii)  <font color=#447700>!SSiB <a name='909'></font>
        SWNIRDIF(I,J) = solld(ii) <font color=#447700>!SSiB <a name='910'></font>
      enddo<a name='911'>
      endif<a name='912'>
  CASE (CLMSCHEME)<a name='913'>
      if(dosw)then<a name='914'>
      do i = its,ite<a name='915'>
        ii = i - its + 1<a name='916'>
        SWVISDIR(I,J) = sols(ii)  <font color=#447700>!CLM<a name='917'></font>
        SWVISDIF(I,J) = solsd(ii) <font color=#447700>!CLM<a name='918'></font>
        SWNIRDIR(I,J) = soll(ii)  <font color=#447700>!CLM<a name='919'></font>
        SWNIRDIF(I,J) = solld(ii) <font color=#447700>!CLM<a name='920'></font>
      enddo<a name='921'>
      endif<a name='922'>
<a name='923'>
   END SELECT<a name='924'>
<font color=#447700>!-----------------------------<a name='925'></font>
<a name='926'>
    enddo    <font color=#447700>! j-loop<a name='927'></font>
<a name='928'>
#endif<a name='929'>
<a name='930'>
end subroutine camrad<a name='931'>
<font color=#447700>!====================================================================<a name='932'></font>
<A NAME='CAMRADINIT'><A href='../../html_code/phys/module_ra_cam.F.html#CAMRADINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='933'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>camradinit</font>(                                           &amp; <A href='../../call_to/CAMRADINIT.html' TARGET='index'>2</A>,<A href='../../call_from/CAMRADINIT.html' TARGET='index'>6</A><a name='934'>
                         R_D,R_V,CP,G,STBOLT,EP_2,shalf,pptop,               &amp;<a name='935'>
                         ozmixm,pin,levsiz,XLAT,num_months,         &amp;<a name='936'>
                         m_psp,m_psn,m_hybi,aerosolcp,aerosolcn,    &amp;<a name='937'>
                         paerlev,naer_c,                            &amp;<a name='938'>
                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='939'>
                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='940'>
                     its, ite, jts, jte, kts, kte                   )<a name='941'>
<a name='942'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRADINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_73"><a name='943'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRADINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_143"><a name='944'>
   <font color=#447700>!USE module_configure<a name='945'></font>
<a name='946'>
<font color=#447700>!--------------------------------------------------------------------<a name='947'></font>
   IMPLICIT NONE<a name='948'>
<font color=#447700>!--------------------------------------------------------------------<a name='949'></font>
   INTEGER , INTENT(IN)           :: ids, ide, jds, jde, kds, kde,  &amp;<a name='950'>
                                     ims, ime, jms, jme, kms, kme,  &amp;<a name='951'>
                                     its, ite, jts, jte, kts, kte<a name='952'>
   REAL, intent(in)               :: pptop<a name='953'>
   REAL, INTENT(IN)               :: R_D,R_V,CP,G,STBOLT,EP_2<a name='954'>
<a name='955'>
   REAL,     DIMENSION( kms:kme )  :: shalf<a name='956'>
<a name='957'>
   INTEGER,      INTENT(IN   )    ::   levsiz, num_months<a name='958'>
   INTEGER,      INTENT(IN   )    ::   paerlev, naer_c<a name='959'>
<a name='960'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   )  :: XLAT<a name='961'>
<a name='962'>
   REAL,  DIMENSION( ims:ime, levsiz, jms:jme, num_months ),      &amp;<a name='963'>
          INTENT(INOUT   ) ::                                  OZMIXM<a name='964'>
<a name='965'>
   REAL,  DIMENSION(levsiz), INTENT(INOUT )  ::                   PIN<a name='966'>
   REAL,  DIMENSION(ims:ime, jms:jme), INTENT(INOUT )  ::                  m_psp,m_psn<a name='967'>
   REAL,  DIMENSION(paerlev), INTENT(INOUT )  ::               m_hybi<a name='968'>
   REAL,  DIMENSION( ims:ime, paerlev, jms:jme, naer_c ),      &amp;<a name='969'>
          INTENT(INOUT) ::                             aerosolcp,aerosolcn<a name='970'>
<a name='971'>
   REAL(r8)    :: pstd<a name='972'>
   REAL(r8)    :: rh2o, cpair<a name='973'>
<a name='974'>
<font color=#447700>! These were made allocatable 20090612 to save static memory allocation. JM<a name='975'></font>
   IF ( .NOT. ALLOCATED( ksul   ) ) ALLOCATE( ksul( nrh, nspint ) )<a name='976'>
   IF ( .NOT. ALLOCATED( wsul   ) ) ALLOCATE( wsul( nrh, nspint ) )<a name='977'>
   IF ( .NOT. ALLOCATED( gsul   ) ) ALLOCATE( gsul( nrh, nspint ) )<a name='978'>
   IF ( .NOT. ALLOCATED( ksslt  ) ) ALLOCATE( ksslt( nrh, nspint ) )<a name='979'>
   IF ( .NOT. ALLOCATED( wsslt  ) ) ALLOCATE( wsslt( nrh, nspint ) )<a name='980'>
   IF ( .NOT. ALLOCATED( gsslt  ) ) ALLOCATE( gsslt( nrh, nspint ) )<a name='981'>
   IF ( .NOT. ALLOCATED( kcphil ) ) ALLOCATE( kcphil( nrh, nspint ) )<a name='982'>
   IF ( .NOT. ALLOCATED( wcphil ) ) ALLOCATE( wcphil( nrh, nspint ) )<a name='983'>
   IF ( .NOT. ALLOCATED( gcphil ) ) ALLOCATE( gcphil( nrh, nspint ) )<a name='984'>
<a name='985'>
   IF ( .NOT. ALLOCATED(ah2onw  ) ) ALLOCATE( ah2onw(n_p, n_tp, n_u, n_te, n_rh) )<a name='986'>
   IF ( .NOT. ALLOCATED(eh2onw  ) ) ALLOCATE( eh2onw(n_p, n_tp, n_u, n_te, n_rh) )<a name='987'>
   IF ( .NOT. ALLOCATED(ah2ow   ) ) ALLOCATE( ah2ow(n_p, n_tp, n_u, n_te, n_rh) )<a name='988'>
   IF ( .NOT. ALLOCATED(cn_ah2ow) ) ALLOCATE( cn_ah2ow(n_p, n_tp, n_u, n_te, n_rh) )<a name='989'>
   IF ( .NOT. ALLOCATED(cn_eh2ow) ) ALLOCATE( cn_eh2ow(n_p, n_tp, n_u, n_te, n_rh) )<a name='990'>
   IF ( .NOT. ALLOCATED(ln_ah2ow) ) ALLOCATE( ln_ah2ow(n_p, n_tp, n_u, n_te, n_rh) )<a name='991'>
   IF ( .NOT. ALLOCATED(ln_eh2ow) ) ALLOCATE( ln_eh2ow(n_p, n_tp, n_u, n_te, n_rh) )<a name='992'>
<a name='993'>
#if <font color=#447700>!defined(MAC_KLUDGE)<a name='994'></font>
   ozncyc = .true.<a name='995'>
   indirect = .true.<a name='996'>
   ixcldliq = 2<a name='997'>
   ixcldice = 3<a name='998'>
#if (NMM_CORE <font color=#447700>!= 1)<a name='999'></font>
<font color=#447700>! aerosol array is not in the NMM Registry <a name='1000'></font>
<font color=#447700>!   since CAM radiation not available to NMM (yet)<a name='1001'></font>
<font color=#447700>!   so this is blocked out to enable CAM compilation with NMM<a name='1002'></font>
   idxSUL = P_SUL<a name='1003'>
   idxSSLT = P_SSLT<a name='1004'>
   idxDUSTfirst = P_DUST1<a name='1005'>
   idxOCPHO = P_OCPHO<a name='1006'>
   idxCARBONfirst = P_OCPHO<a name='1007'>
   idxBCPHO = P_BCPHO<a name='1008'>
   idxOCPHI = P_OCPHI<a name='1009'>
   idxBCPHI = P_BCPHI<a name='1010'>
   idxBG = P_BG<a name='1011'>
   idxVOLC = P_VOLC<a name='1012'>
#endif<a name='1013'>
<a name='1014'>
   pstd = 101325.0<a name='1015'>
<font color=#447700>! from physconst module<a name='1016'></font>
   mwdry = 28.966            <font color=#447700>! molecular weight dry air ~ kg/kmole (shr_const_mwdair)<a name='1017'></font>
   mwco2 =  44.              <font color=#447700>! molecular weight co2<a name='1018'></font>
   mwh2o = 18.016            <font color=#447700>! molecular weight water vapor (shr_const_mwwv)<a name='1019'></font>
   mwch4 =  16.              <font color=#447700>! molecular weight ch4<a name='1020'></font>
   mwn2o =  44.              <font color=#447700>! molecular weight n2o<a name='1021'></font>
   mwf11 = 136.              <font color=#447700>! molecular weight cfc11<a name='1022'></font>
   mwf12 = 120.              <font color=#447700>! molecular weight cfc12<a name='1023'></font>
   cappa = R_D/CP<a name='1024'>
   rair = R_D<a name='1025'>
   tmelt = 273.16            <font color=#447700>! freezing T of fresh water ~ K <a name='1026'></font>
   r_universal = 6.02214e26 * STBOLT   <font color=#447700>! Universal gas constant ~ J/K/kmole<a name='1027'></font>
   latvap = 2.501e6          <font color=#447700>! latent heat of evaporation ~ J/kg<a name='1028'></font>
   latice = 3.336e5          <font color=#447700>! latent heat of fusion ~ J/kg<a name='1029'></font>
   zvir = R_V/R_D - 1.<a name='1030'>
   rh2o = R_V<a name='1031'>
   cpair = CP<a name='1032'>
<font color=#447700>!<a name='1033'></font>
   epsqs = EP_2<a name='1034'>
<a name='1035'>
   CALL <A href='../../html_code/phys/module_ra_cam_support.F.html#RADINI'>radini</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRADINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADINI_1">(G, CP, EP_2, STBOLT, pstd*10.0 )<a name='1036'>
   CALL <A href='../../html_code/phys/module_ra_cam_support.F.html#ESINTI'>esinti</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRADINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ESINTI_2">(epsqs  ,latvap  ,latice  ,rh2o    ,cpair   ,tmelt   )<a name='1037'>
   CALL <A href='../../html_code/phys/module_ra_cam_support.F.html#OZNINI'>oznini</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRADINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OZNINI_2">(ozmixm,pin,levsiz,num_months,XLAT,                   &amp;<a name='1038'>
                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='1039'>
                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='1040'>
                     its, ite, jts, jte, kts, kte)                   <a name='1041'>
   CALL <A href='../../html_code/phys/module_ra_flg.F.html#AEROSOL_INIT'>aerosol_init</A><A href='../../html_code/phys/module_ra_cam.F.html#CAMRADINIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AEROSOL_INIT_1">(m_psp,m_psn,m_hybi,aerosolcp,aerosolcn,paerlev,naer_c,shalf,pptop,    &amp;<a name='1042'>
                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='1043'>
                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='1044'>
                     its, ite, jts, jte, kts, kte)<a name='1045'>
<a name='1046'>
#endif<a name='1047'>
<a name='1048'>
   END SUBROUTINE camradinit<a name='1049'>
#if <font color=#447700>!defined(MAC_KLUDGE)<a name='1050'></font>
<a name='1051'>
<a name='1052'>
<A NAME='OZNINT'><A href='../../html_code/phys/module_ra_cam.F.html#OZNINT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1053'>
<font color=#993300>subroutine </font><font color=#cc0000>oznint</font>(julday,julian,dt,gmt,xtime,ozmixmj,ozmix,levsiz,num_months,pcols) <A href='../../call_to/OZNINT.html' TARGET='index'>1</A>,<A href='../../call_from/OZNINT.html' TARGET='index'>1</A><a name='1054'>
<a name='1055'>
      IMPLICIT NONE<a name='1056'>
<a name='1057'>
   INTEGER,      INTENT(IN   )    ::   levsiz, num_months,pcols<a name='1058'>
<a name='1059'>
   REAL(r8),  DIMENSION( pcols, levsiz, num_months ),      &amp;<a name='1060'>
          INTENT(IN   ) ::                                  ozmixmj <a name='1061'>
<a name='1062'>
   REAL, INTENT(IN    )      ::        XTIME,GMT<a name='1063'>
   INTEGER, INTENT(IN )      ::        JULDAY<a name='1064'>
   REAL,    INTENT(IN )      ::        JULIAN<a name='1065'>
   REAL,    INTENT(IN )      ::        DT<a name='1066'>
<a name='1067'>
   REAL(r8),  DIMENSION( pcols, levsiz ),      &amp;<a name='1068'>
          INTENT(OUT  ) ::                                  ozmix<a name='1069'>
   <font color=#447700>!Local<a name='1070'></font>
   REAL(r8)  :: intJULIAN<a name='1071'>
   integer   :: np1,np,nm,m,k,i<a name='1072'>
   integer   :: IJUL<a name='1073'>
   integer, dimension(12) ::  date_oz<a name='1074'>
   data date_oz/16, 45, 75, 105, 136, 166, 197, 228, 258, 289, 319, 350/<a name='1075'>
   real(r8) :: cdayozp, cdayozm<a name='1076'>
   real(r8) :: fact1, fact2<a name='1077'>
   logical  :: finddate<a name='1078'>
   CHARACTER(LEN=256) :: msgstr<a name='1079'>
<a name='1080'>
   <font color=#447700>! JULIAN starts from 0.0 at 0Z on 1 Jan.<a name='1081'></font>
   intJULIAN = JULIAN + 1.0_r8    <font color=#447700>! offset by one day<a name='1082'></font>
<font color=#447700>! jan 1st 00z is julian=1.0 here<a name='1083'></font>
   IJUL=INT(intJULIAN)<a name='1084'>
<font color=#447700>!  Note that following will drift. <a name='1085'></font>
<font color=#447700>!    Need to use actual month/day info to compute julian.<a name='1086'></font>
   intJULIAN=intJULIAN-FLOAT(IJUL)<a name='1087'>
   IJUL=MOD(IJUL,365)<a name='1088'>
   IF(IJUL.EQ.0)IJUL=365<a name='1089'>
   intJULIAN=intJULIAN+IJUL<a name='1090'>
   np1=1<a name='1091'>
   finddate=.false.<a name='1092'>
<font color=#447700>!   do m=1,num_months<a name='1093'></font>
   do m=1,12<a name='1094'>
   if(date_oz(m).gt.intjulian.and..not.finddate) then<a name='1095'>
     np1=m<a name='1096'>
     finddate=.true.<a name='1097'>
   endif<a name='1098'>
   enddo<a name='1099'>
   cdayozp=date_oz(np1)<a name='1100'>
   if(np1.gt.1) then<a name='1101'>
   cdayozm=date_oz(np1-1)<a name='1102'>
   np=np1<a name='1103'>
   nm=np-1<a name='1104'>
   else<a name='1105'>
   cdayozm=date_oz(12)<a name='1106'>
   np=np1<a name='1107'>
   nm=12<a name='1108'>
   endif<a name='1109'>
   call <A href='../../html_code/phys/module_ra_cam_support.F.html#GETFACTORS'>getfactors</A><A href='../../html_code/phys/module_ra_cam.F.html#OZNINT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETFACTORS_1">(ozncyc,np1, cdayozm, cdayozp,intjulian, &amp;<a name='1110'>
                    fact1, fact2) <a name='1111'>
<a name='1112'>
<font color=#447700>!<a name='1113'></font>
<font color=#447700>! Time interpolation.<a name='1114'></font>
<font color=#447700>!<a name='1115'></font>
      do k=1,levsiz<a name='1116'>
         do i=1,pcols<a name='1117'>
            ozmix(i,k) = ozmixmj(i,k,nm)*fact1 + ozmixmj(i,k,np)*fact2<a name='1118'>
         end do<a name='1119'>
      end do<a name='1120'>
<a name='1121'>
END subroutine oznint<a name='1122'>
<a name='1123'>
<a name='1124'>
<A NAME='GET_AEROSOL'><A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1125'>
<font color=#993300>subroutine </font><font color=#cc0000>get_aerosol</font>(c, julday, julian, dt, gmt, xtime, m_psp, m_psn, aerosoljp, &amp; <A href='../../call_to/GET_AEROSOL.html' TARGET='index'>3</A>,<A href='../../call_from/GET_AEROSOL.html' TARGET='index'>7</A><a name='1126'>
  aerosoljn, m_hybi, paerlev, naer_c, pint, pcols, pver, pverp, pverr, pverrp, AEROSOLt, scale)<a name='1127'>
<font color=#447700>!------------------------------------------------------------------<a name='1128'></font>
<font color=#447700>!<a name='1129'></font>
<font color=#447700>!  Input:<a name='1130'></font>
<font color=#447700>!     time at which aerosol mmrs are needed (get_curr_calday())<a name='1131'></font>
<font color=#447700>!     chunk index<a name='1132'></font>
<font color=#447700>!     CAM's vertical grid (pint)<a name='1133'></font>
<font color=#447700>!<a name='1134'></font>
<font color=#447700>!  Output:<a name='1135'></font>
<font color=#447700>!     values for Aerosol Mass Mixing Ratios at specified time<a name='1136'></font>
<font color=#447700>!     on vertical grid specified by CAM (AEROSOLt)<a name='1137'></font>
<font color=#447700>!<a name='1138'></font>
<font color=#447700>!  Method:<a name='1139'></font>
<font color=#447700>!     first determine which indexs of aerosols are the bounding data sets<a name='1140'></font>
<font color=#447700>!     interpolate both onto vertical grid aerm(),aerp().<a name='1141'></font>
<font color=#447700>!     from those two, interpolate in time.<a name='1142'></font>
<font color=#447700>!<a name='1143'></font>
<font color=#447700>!------------------------------------------------------------------<a name='1144'></font>
<a name='1145'>
<font color=#447700>!  use volcanicmass, only: get_volcanic_mass<a name='1146'></font>
<font color=#447700>!  use timeinterp, only: getfactors<a name='1147'></font>
<font color=#447700>!<a name='1148'></font>
<font color=#447700>! aerosol fields interpolated to current time step<a name='1149'></font>
<font color=#447700>!   on pressure levels of this time step.<a name='1150'></font>
<font color=#447700>! these should be made read-only for other modules<a name='1151'></font>
<font color=#447700>! Is allocation done correctly here?<a name='1152'></font>
<font color=#447700>!<a name='1153'></font>
   integer, intent(in) :: c                   <font color=#447700>! Chunk Id.<a name='1154'></font>
   integer, intent(in) :: paerlev, naer_c, pcols, pver, pverp, pverr, pverrp<a name='1155'>
   real(r8), intent(in) :: pint(pcols,pverp)  <font color=#447700>! midpoint pres.<a name='1156'></font>
   real(r8), intent(in) :: scale(naer_all)    <font color=#447700>! scale each aerosol by this amount<a name='1157'></font>
   REAL, INTENT(IN    )      ::        XTIME,GMT<a name='1158'>
   INTEGER, INTENT(IN )      ::        JULDAY<a name='1159'>
   REAL, INTENT(IN    )      ::        JULIAN<a name='1160'>
   REAL, INTENT(IN    )      ::        DT<a name='1161'>
   real(r8), intent(in   )      ::        m_psp(pcols),m_psn(pcols)  <font color=#447700>! Match surface pressure<a name='1162'></font>
   real(r8), intent(in   )   ::        aerosoljp(pcols,paerlev,naer_c) <a name='1163'>
   real(r8), intent(in   )   ::        aerosoljn(pcols,paerlev,naer_c) <a name='1164'>
   real(r8), intent(in   )   ::        m_hybi(paerlev)<a name='1165'>
<a name='1166'>
   real(r8), intent(out) :: AEROSOLt(pcols, pver, naer_all) <font color=#447700>! aerosols<a name='1167'></font>
<font color=#447700>!<a name='1168'></font>
<font color=#447700>! Local workspace<a name='1169'></font>
<font color=#447700>!<a name='1170'></font>
   real(r8) caldayloc                     <font color=#447700>! calendar day of current timestep<a name='1171'></font>
   real(r8) fact1, fact2                  <font color=#447700>! time interpolation factors<a name='1172'></font>
<a name='1173'>
  integer :: nm = 1                <font color=#447700>! index to prv month in array. init to 1 and toggle between 1 and 2<a name='1174'></font>
  integer :: np = 2                <font color=#447700>! index to nxt month in array. init to 2 and toggle between 1 and 2<a name='1175'></font>
  integer :: mo_nxt = bigint       <font color=#447700>! index to nxt month in file<a name='1176'></font>
  integer :: mo_prv                       <font color=#447700>! index to previous month<a name='1177'></font>
<a name='1178'>
  real(r8) :: cdaym = inf          <font color=#447700>! calendar day of prv month<a name='1179'></font>
  real(r8) :: cdayp = inf          <font color=#447700>! calendar day of next month<a name='1180'></font>
  real(r8) :: Mid(12)              <font color=#447700>! Days into year for mid month date<a name='1181'></font>
  data Mid/16.5, 46.0, 75.5, 106.0, 136.5, 167.0, 197.5, 228.5, 259.0, 289.5, 320.0, 350.5 /<a name='1182'>
<a name='1183'>
   integer i, k, j                        <font color=#447700>! spatial indices<a name='1184'></font>
   integer m                              <font color=#447700>! constituent index<a name='1185'></font>
   integer lats(pcols),lons(pcols)        <font color=#447700>! latitude and longitudes of column<a name='1186'></font>
   integer ncol                           <font color=#447700>! number of columns<a name='1187'></font>
   INTEGER IJUL<a name='1188'>
   REAL(r8) intJULIAN<a name='1189'>
<a name='1190'>
   real(r8) speciesmin(naer)              <font color=#447700>! minimal value for each species<a name='1191'></font>
<font color=#447700>!<a name='1192'></font>
<font color=#447700>! values before current time step "the minus month"<a name='1193'></font>
<font color=#447700>! aerosolm(pcols,pver) is value of preceeding month's aerosol mmr<a name='1194'></font>
<font color=#447700>! aerosolp(pcols,pver) is value of next month's aerosol mmr<a name='1195'></font>
<font color=#447700>!  (think minus and plus or values to left and right of point to be interpolated)<a name='1196'></font>
<font color=#447700>!<a name='1197'></font>
   real(r8) AEROSOLm(pcols,pver,naer) <font color=#447700>! aerosol mmr from MATCH in column at previous (minus) month<a name='1198'></font>
<font color=#447700>!<a name='1199'></font>
<font color=#447700>! values beyond (or at) current time step "the plus month"<a name='1200'></font>
<font color=#447700>!<a name='1201'></font>
   real(r8) AEROSOLp(pcols,pver,naer) <font color=#447700>! aerosol mmr from MATCH in column at next (plus) month<a name='1202'></font>
   CHARACTER(LEN=256) :: msgstr<a name='1203'>
<a name='1204'>
   <font color=#447700>! JULIAN starts from 0.0 at 0Z on 1 Jan.<a name='1205'></font>
   intJULIAN = JULIAN + 1.0_r8    <font color=#447700>! offset by one day<a name='1206'></font>
<font color=#447700>! jan 1st 00z is julian=1.0 here<a name='1207'></font>
   IJUL=INT(intJULIAN)<a name='1208'>
<font color=#447700>!  Note that following will drift. <a name='1209'></font>
<font color=#447700>!    Need to use actual month/day info to compute julian.<a name='1210'></font>
   intJULIAN=intJULIAN-FLOAT(IJUL)<a name='1211'>
   IJUL=MOD(IJUL,365)<a name='1212'>
   IF(IJUL.EQ.0)IJUL=365<a name='1213'>
   caldayloc=intJULIAN+IJUL<a name='1214'>
<a name='1215'>
   if (caldayloc &lt; Mid(1)) then<a name='1216'>
      mo_prv = 12<a name='1217'>
      mo_nxt =  1<a name='1218'>
   else if (caldayloc &gt;= Mid(12)) then<a name='1219'>
      mo_prv = 12<a name='1220'>
      mo_nxt =  1<a name='1221'>
   else<a name='1222'>
      do i = 2 , 12<a name='1223'>
         if (caldayloc &lt; Mid(i)) then<a name='1224'>
            mo_prv = i-1<a name='1225'>
            mo_nxt = i<a name='1226'>
            exit<a name='1227'>
         end if<a name='1228'>
      end do<a name='1229'>
   end if<a name='1230'>
<font color=#447700>!<a name='1231'></font>
<font color=#447700>! Set initial calendar day values<a name='1232'></font>
<font color=#447700>!<a name='1233'></font>
   cdaym = Mid(mo_prv)<a name='1234'>
   cdayp = Mid(mo_nxt)<a name='1235'>
<a name='1236'>
<font color=#447700>!<a name='1237'></font>
<font color=#447700>! Determine time interpolation factors.  1st arg says we are cycling 1 year of data<a name='1238'></font>
<font color=#447700>!<a name='1239'></font>
   call <A href='../../html_code/phys/module_ra_cam_support.F.html#GETFACTORS'>getfactors</A><A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETFACTORS_2"> (.true., mo_nxt, cdaym, cdayp, caldayloc, &amp;<a name='1240'>
                    fact1, fact2)<a name='1241'>
<font color=#447700>!<a name='1242'></font>
<font color=#447700>! interpolate (prv and nxt month) bounding datasets onto cam vertical grid.<a name='1243'></font>
<font color=#447700>! compute mass mixing ratios on CAMS's pressure coordinate<a name='1244'></font>
<font color=#447700>!  for both the "minus" and "plus" months<a name='1245'></font>
<font color=#447700>!<a name='1246'></font>
<font color=#447700>!  ncol = get_ncols_p(c)<a name='1247'></font>
   ncol = pcols<a name='1248'>
<a name='1249'>
<font color=#447700>!  call vert_interpolate (M_ps_cam_col(1,c,nm), pint, nm, AEROSOLm, ncol, c)<a name='1250'></font>
<font color=#447700>!  call vert_interpolate (M_ps_cam_col(1,c,np), pint, np, AEROSOLp, ncol, c)<a name='1251'></font>
<a name='1252'>
   call <A href='../../html_code/phys/module_ra_cam_support.F.html#VERT_INTERPOLATE'>vert_interpolate</A><A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INTERPOLATE_1"> (m_psp, aerosoljp, m_hybi, paerlev, naer_c, pint, nm, AEROSOLm, pcols, pver, pverp, ncol, c)<a name='1253'>
   call <A href='../../html_code/phys/module_ra_cam_support.F.html#VERT_INTERPOLATE'>vert_interpolate</A><A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INTERPOLATE_2"> (m_psn, aerosoljn, m_hybi, paerlev, naer_c, pint, np, AEROSOLp, pcols, pver, pverp, ncol, c)<a name='1254'>
<a name='1255'>
<font color=#447700>!<a name='1256'></font>
<font color=#447700>! Time interpolate.<a name='1257'></font>
<font color=#447700>!<a name='1258'></font>
   do m=1,naer<a name='1259'>
      do k=1,pver<a name='1260'>
         do i=1,ncol<a name='1261'>
            AEROSOLt(i,k,m) = AEROSOLm(i,k,m)*fact1 + AEROSOLp(i,k,m)*fact2<a name='1262'>
         end do<a name='1263'>
      end do<a name='1264'>
   end do<a name='1265'>
<a name='1266'>
<font color=#447700>!  do i=1,ncol<a name='1267'></font>
<font color=#447700>!     Match_ps_chunk(i,c) = m_ps(i,nm)*fact1 + m_ps(i,np)*fact2<a name='1268'></font>
<font color=#447700>!  end do<a name='1269'></font>
<font color=#447700>!<a name='1270'></font>
<font color=#447700>! get background aerosol (tuning) field<a name='1271'></font>
<font color=#447700>!<a name='1272'></font>
   call <A href='../../html_code/phys/module_ra_cam_support.F.html#BACKGROUND'>background</A><A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BACKGROUND_1"> (c, ncol, pint, pcols, pverr, pverrp, AEROSOLt(:, :, idxBG))<a name='1273'>
<a name='1274'>
<font color=#447700>!<a name='1275'></font>
<font color=#447700>! find volcanic aerosol masses<a name='1276'></font>
<font color=#447700>!<a name='1277'></font>
<font color=#447700>! if (strat_volcanic) then<a name='1278'></font>
<font color=#447700>!   call get_volcanic_mass(c, AEROSOLt(:,:,idxVOLC))<a name='1279'></font>
<font color=#447700>! else<a name='1280'></font>
    AEROSOLt(:,:,idxVOLC) = 0._r8<a name='1281'>
<font color=#447700>! endif<a name='1282'></font>
<a name='1283'>
<font color=#447700>!<a name='1284'></font>
<font color=#447700>! exit if mmr is negative (we have previously set<a name='1285'></font>
<font color=#447700>!  cumulative mass to be a decreasing function.)<a name='1286'></font>
<font color=#447700>!<a name='1287'></font>
   speciesmin(:) = 0. <font color=#447700>! speciesmin(m) = 0 is minimum mmr for each species<a name='1288'></font>
<a name='1289'>
   do m=1,naer<a name='1290'>
      do k=1,pver<a name='1291'>
         do i=1,ncol<a name='1292'>
            if (AEROSOLt(i, k, m) &lt; speciesmin(m)) then<a name='1293'>
               write(6,*) 'AEROSOL_INTERPOLATE: negative mass mixing ratio, exiting'<a name='1294'>
               write(6,*) 'm, column, pver',m, i, k ,AEROSOLt(i, k, m)<a name='1295'>
<font color=#447700>!ccc<a name='1296'></font>
#ifdef CLWRFGHG<a name='1297'>
<font color=#447700>!CLWRF-UC July.09<a name='1298'></font>
               print *,'naer:',naer,' pver:',pver,' ncol:',ncol<a name='1299'>
               PRINT *,'ERROR -- error -- ERROR -- error -- ERROR -- error'<a name='1300'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_977">('CLWRF-module_ra_cam. : AEROSOLt=NaN')<a name='1301'>
#endif<a name='1302'>
<font color=#447700>!ccc<a name='1303'></font>
               call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_30"> ()<a name='1304'>
            end if<a name='1305'>
         end do<a name='1306'>
      end do<a name='1307'>
   end do<a name='1308'>
<font color=#447700>!<a name='1309'></font>
<font color=#447700>! scale any AEROSOLS as required<a name='1310'></font>
<font color=#447700>!<a name='1311'></font>
   call <A href='../../html_code/phys/module_ra_cam_support.F.html#SCALE_AEROSOLS'>scale_aerosols</A><A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCALE_AEROSOLS_1"> (AEROSOLt, pcols, pver, ncol, c, scale)<a name='1312'>
<a name='1313'>
   return<a name='1314'>
end subroutine get_aerosol<a name='1315'>
<a name='1316'>
<a name='1317'>
<A NAME='AEROSOL_INDIRECT'><A href='../../html_code/phys/module_ra_cam.F.html#AEROSOL_INDIRECT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1318'>
<font color=#993300>subroutine </font><font color=#cc0000>aerosol_indirect</font>(ncol,lchnk,pcols,pver,ppcnst,landfrac,pmid,t,qm1,cld,zm,rel) <A href='../../call_to/AEROSOL_INDIRECT.html' TARGET='index'>2</A><a name='1319'>
<font color=#447700>!--------------------------------------------------------------<a name='1320'></font>
<font color=#447700>! Compute effect of sulfate on effective liquid water radius<a name='1321'></font>
<font color=#447700>!  Method of Martin et. al.<a name='1322'></font>
<font color=#447700>!--------------------------------------------------------------<a name='1323'></font>
<a name='1324'>
<font color=#447700>! use constituents, only: ppcnst, cnst_get_ind<a name='1325'></font>
<font color=#447700>! use history, only: outfld<a name='1326'></font>
<a name='1327'>
<font color=#447700>!#include "comctl.h"<a name='1328'></font>
<a name='1329'>
  integer, intent(in) :: ncol                  <font color=#447700>! number of atmospheric columns<a name='1330'></font>
  integer, intent(in) :: lchnk                 <font color=#447700>! chunk identifier<a name='1331'></font>
  integer, intent(in) :: pcols,pver,ppcnst<a name='1332'>
<a name='1333'>
  real(r8), intent(in) :: landfrac(pcols)      <font color=#447700>! land fraction<a name='1334'></font>
  real(r8), intent(in) :: pmid(pcols,pver)     <font color=#447700>! Model level pressures<a name='1335'></font>
  real(r8), intent(in) :: t(pcols,pver)        <font color=#447700>! Model level temperatures<a name='1336'></font>
  real(r8), intent(in) :: qm1(pcols,pver,ppcnst) <font color=#447700>! Specific humidity and tracers<a name='1337'></font>
  real(r8), intent(in) :: cld(pcols,pver)      <font color=#447700>! Fractional cloud cover<a name='1338'></font>
  real(r8), intent(in) :: zm(pcols,pver)       <font color=#447700>! Height of midpoints (above surface)<a name='1339'></font>
  real(r8), intent(in) :: rel(pcols,pver)      <font color=#447700>! liquid effective drop size (microns)<a name='1340'></font>
<font color=#447700>!<a name='1341'></font>
<font color=#447700>! local variables<a name='1342'></font>
<font color=#447700>!<a name='1343'></font>
  real(r8) locrhoair(pcols,pver)  <font color=#447700>! dry air density            [kg/m^3 ]<a name='1344'></font>
  real(r8) lwcwat(pcols,pver)     <font color=#447700>! in-cloud liquid water path [kg/m^3 ]<a name='1345'></font>
  real(r8) sulfmix(pcols,pver)    <font color=#447700>! sulfate mass mixing ratio  [kg/kg  ]<a name='1346'></font>
  real(r8) so4mass(pcols,pver)    <font color=#447700>! sulfate mass concentration [g/cm^3 ]<a name='1347'></font>
  real(r8) Aso4(pcols,pver)       <font color=#447700>! sulfate # concentration    [#/cm^3 ]<a name='1348'></font>
  real(r8) Ntot(pcols,pver)       <font color=#447700>! ccn # concentration        [#/cm^3 ]<a name='1349'></font>
  real(r8) relmod(pcols,pver)     <font color=#447700>! effective radius           [microns]<a name='1350'></font>
<a name='1351'>
  real(r8) wrel(pcols,pver)       <font color=#447700>! weighted effective radius    [microns]<a name='1352'></font>
  real(r8) wlwc(pcols,pver)       <font color=#447700>! weighted liq. water content  [kg/m^3 ]<a name='1353'></font>
  real(r8) cldfrq(pcols,pver)     <font color=#447700>! frequency of occurance of...<a name='1354'></font>
<font color=#447700>!                                  ! clouds (cld =&gt; 0.01)         [fraction]<a name='1355'></font>
  real(r8) locPi                  <font color=#447700>! my piece of the pi<a name='1356'></font>
  real(r8) Rdryair                <font color=#447700>! gas constant of dry air   [J/deg/kg]<a name='1357'></font>
  real(r8) rhowat                 <font color=#447700>! density of water          [kg/m^3  ]<a name='1358'></font>
  real(r8) Acoef                  <font color=#447700>! m-&gt;A conversion factor; assumes<a name='1359'></font>
<font color=#447700>!                                  ! Dbar=0.10, sigma=2.0      [g^-1    ]<a name='1360'></font>
  real(r8) rekappa                <font color=#447700>! kappa in evaluation of re(lmod)<a name='1361'></font>
  real(r8) recoef                 <font color=#447700>! temp. coeficient for calc of re(lmod)<a name='1362'></font>
  real(r8) reexp                  <font color=#447700>! 1.0/3.0<a name='1363'></font>
  real(r8) Ntotb                  <font color=#447700>! temp var to hold below cloud ccn<a name='1364'></font>
<font color=#447700>! -- Parameters for background CDNC (from `ambient' non-sulfate aerosols)...<a name='1365'></font>
  real(r8) Cmarn                  <font color=#447700>! Coef for CDNC_marine         [cm^-3]<a name='1366'></font>
  real(r8) Cland                  <font color=#447700>! Coef for CDNC_land           [cm^-3]<a name='1367'></font>
  real(r8) Hmarn                  <font color=#447700>! Scale height for CDNC_marine [m]<a name='1368'></font>
  real(r8) Hland                  <font color=#447700>! Scale height for CDNC_land   [m]<a name='1369'></font>
  parameter ( Cmarn = 50.0, Cland = 100.0 )<a name='1370'>
  parameter ( Hmarn = 1000.0, Hland = 2000.0 )<a name='1371'>
  real(r8) bgaer                  <font color=#447700>! temp var to hold background CDNC<a name='1372'></font>
<a name='1373'>
  integer i,k     <font color=#447700>! loop indices<a name='1374'></font>
<font color=#447700>!<a name='1375'></font>
<font color=#447700>! Statement functions<a name='1376'></font>
<font color=#447700>!<a name='1377'></font>
  logical land    <font color=#447700>! is this a column over land?<a name='1378'></font>
  land(i) = nint(landfrac(i)).gt.0.5_r8<a name='1379'>
<a name='1380'>
  if (indirect) then<a name='1381'>
<a name='1382'>
<font color=#447700>!   call endrun ('AEROSOL_INDIRECT:  indirect effect is obsolete')<a name='1383'></font>
<a name='1384'>
<font color=#447700>!   ramping is not yet resolved so sulfmix is 0.<a name='1385'></font>
    sulfmix(1:ncol,1:pver) = 0._r8<a name='1386'>
<a name='1387'>
    locPi = 3.141592654<a name='1388'>
    Rdryair = 287.04<a name='1389'>
    rhowat = 1000.0<a name='1390'>
    Acoef = 1.2930E14<a name='1391'>
    recoef = 3.0/(4.0*locPi*rhowat)<a name='1392'>
    reexp = 1.0/3.0<a name='1393'>
<a name='1394'>
<font color=#447700>!   call cnst_get_ind('CLDLIQ', ixcldliq)<a name='1395'></font>
    do k=pver,1,-1<a name='1396'>
      do i = 1,ncol<a name='1397'>
        locrhoair(i,k) = pmid(i,k)/( Rdryair*t(i,k) )<a name='1398'>
        lwcwat(i,k) = ( qm1(i,k,ixcldliq)/max(0.01_r8,cld(i,k)) )* &amp;<a name='1399'>
                      locrhoair(i,k)<a name='1400'>
<font color=#447700>!          NOTE: 0.001 converts kg/m3 -&gt; g/cm3<a name='1401'></font>
        so4mass(i,k) = sulfmix(i,k)*locrhoair(i,k)*0.001<a name='1402'>
        Aso4(i,k) = so4mass(i,k)*Acoef<a name='1403'>
<a name='1404'>
        if (Aso4(i,k) &lt;= 280.0) then<a name='1405'>
           Aso4(i,k) = max(36.0_r8,Aso4(i,k))<a name='1406'>
           Ntot(i,k) = -1.15E-3*Aso4(i,k)**2 + 0.963*Aso4(i,k)+5.30<a name='1407'>
           rekappa = 0.80<a name='1408'>
        else<a name='1409'>
           Aso4(i,k) = min(1500.0_r8,Aso4(i,k))<a name='1410'>
           Ntot(i,k) = -2.10E-4*Aso4(i,k)**2 + 0.568*Aso4(i,k)-27.9<a name='1411'>
           rekappa = 0.67<a name='1412'>
        end if<a name='1413'>
        if (land(i)) then <font color=#447700>! Account for local background aerosol;<a name='1414'></font>
           bgaer = Cland*exp(-(zm(i,k)/Hland))<a name='1415'>
           Ntot(i,k) = max(bgaer,Ntot(i,k))<a name='1416'>
        else<a name='1417'>
           bgaer = Cmarn*exp(-(zm(i,k)/Hmarn))<a name='1418'>
           Ntot(i,k) = max(bgaer,Ntot(i,k))<a name='1419'>
        end if<a name='1420'>
<a name='1421'>
        if (k == pver) then<a name='1422'>
           Ntotb = Ntot(i,k)<a name='1423'>
        else<a name='1424'>
           Ntotb = Ntot(i,k+1)<a name='1425'>
        end if<a name='1426'>
<a name='1427'>
        relmod(i,k) = (( (recoef*lwcwat(i,k))/(rekappa*Ntotb))**reexp)*10000.0<a name='1428'>
        relmod(i,k) = max(4.0_r8,relmod(i,k))<a name='1429'>
        relmod(i,k) = min(20.0_r8,relmod(i,k))<a name='1430'>
        if (cld(i,k) &gt;= 0.01) then<a name='1431'>
           cldfrq(i,k) = 1.0<a name='1432'>
        else<a name='1433'>
           cldfrq(i,k) = 0.0<a name='1434'>
        end if<a name='1435'>
        wrel(i,k) = relmod(i,k)*cldfrq(i,k)<a name='1436'>
        wlwc(i,k) = lwcwat(i,k)*cldfrq(i,k)<a name='1437'>
      end do<a name='1438'>
    end do<a name='1439'>
<font color=#447700>!   call outfld('MSO4    ',so4mass,pcols,lchnk)<a name='1440'></font>
<font color=#447700>!   call outfld('LWC     ',lwcwat ,pcols,lchnk)<a name='1441'></font>
<font color=#447700>!   call outfld('CLDFRQ  ',cldfrq ,pcols,lchnk)<a name='1442'></font>
<font color=#447700>!   call outfld('WREL    ',wrel   ,pcols,lchnk)<a name='1443'></font>
<font color=#447700>!   call outfld('WLWC    ',wlwc   ,pcols,lchnk)<a name='1444'></font>
<font color=#447700>!   write(6,*)'WARNING: indirect calculation has no effects'<a name='1445'></font>
  else<a name='1446'>
    do k = 1, pver<a name='1447'>
      do i = 1, ncol<a name='1448'>
        relmod(i,k) = rel(i,k)<a name='1449'>
      end do<a name='1450'>
    end do<a name='1451'>
  endif<a name='1452'>
<a name='1453'>
<font color=#447700>! call outfld('REL     ',relmod ,pcols,lchnk)<a name='1454'></font>
<a name='1455'>
  return<a name='1456'>
end subroutine aerosol_indirect<a name='1457'>
<a name='1458'>
<a name='1459'>
<A NAME='AER_TRN'><A href='../../html_code/phys/module_ra_cam.F.html#AER_TRN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1460'>
      <font color=#993300>subroutine </font><font color=#cc0000>aer_trn</font>(aer_mpp, aer_trn_ttl, pcols, plev, plevp ) <A href='../../call_to/AER_TRN.html' TARGET='index'>1</A><a name='1461'>
<font color=#447700>!<a name='1462'></font>
<font color=#447700>!     Purpose: Compute strat. aerosol transmissions needed in absorptivity/<a name='1463'></font>
<font color=#447700>!              emissivity calculations<a name='1464'></font>
<font color=#447700>!              aer_trn() is called by radclw() when doabsems is .true.<a name='1465'></font>
<font color=#447700>!<a name='1466'></font>
<font color=#447700>!     use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='1467'></font>
<font color=#447700>!     use pmgrid<a name='1468'></font>
<font color=#447700>!     use ppgrid<a name='1469'></font>
<font color=#447700>!     use prescribed_aerosols, only: strat_volcanic<a name='1470'></font>
      implicit none<a name='1471'>
<a name='1472'>
<font color=#447700>!     Input arguments<a name='1473'></font>
<font color=#447700>!<a name='1474'></font>
<font color=#447700>!       [kg m-2] Volcanics path above kth interface level<a name='1475'></font>
<font color=#447700>!<a name='1476'></font>
      integer, intent(in)         :: pcols, plev, plevp<a name='1477'>
      real(r8), intent(in) :: aer_mpp(pcols,plevp)<a name='1478'>
<a name='1479'>
<font color=#447700>!     Output arguments<a name='1480'></font>
<font color=#447700>!<a name='1481'></font>
<font color=#447700>!       [fraction] Total volcanic transmission between interfaces k1 and k2<a name='1482'></font>
<font color=#447700>!<a name='1483'></font>
      real(r8), intent(out) ::  aer_trn_ttl(pcols,plevp,plevp,bnd_nbr_LW)<a name='1484'>
<a name='1485'>
<font color=#447700>!-------------------------------------------------------------------------<a name='1486'></font>
<font color=#447700>!     Local variables<a name='1487'></font>
<a name='1488'>
      integer bnd_idx           <font color=#447700>! LW band index<a name='1489'></font>
      integer i                 <font color=#447700>! lon index<a name='1490'></font>
      integer k1                <font color=#447700>! lev index<a name='1491'></font>
      integer k2                <font color=#447700>! lev index<a name='1492'></font>
      real(r8) aer_pth_dlt      <font color=#447700>! [kg m-2] Volcanics path between interface<a name='1493'></font>
                                <font color=#447700>!          levels k1 and k2<a name='1494'></font>
      real(r8) odap_aer_ttl     <font color=#447700>! [fraction] Total path absorption optical<a name='1495'></font>
                                <font color=#447700>!            depth<a name='1496'></font>
<a name='1497'>
<font color=#447700>!-------------------------------------------------------------------------<a name='1498'></font>
<a name='1499'>
      if (strat_volcanic) then<a name='1500'>
        do bnd_idx=1,bnd_nbr_LW<a name='1501'>
           do i=1,pcols<a name='1502'>
              aer_trn_ttl(i,1,1,bnd_idx)=1.0<a name='1503'>
           end do<a name='1504'>
           do k1=2,plevp<a name='1505'>
              do i=1,pcols<a name='1506'>
                 aer_trn_ttl(i,k1,k1,bnd_idx)=1.0<a name='1507'>
<a name='1508'>
                 aer_pth_dlt  = abs(aer_mpp(i,k1) - aer_mpp(i,1))<a name='1509'>
                 odap_aer_ttl = abs_cff_mss_aer(bnd_idx) * aer_pth_dlt<a name='1510'>
<a name='1511'>
                 aer_trn_ttl(i,1,k1,bnd_idx) = exp(-1.66 * odap_aer_ttl)<a name='1512'>
              end do<a name='1513'>
           end do<a name='1514'>
<a name='1515'>
           do k1=2,plev<a name='1516'>
              do k2=k1+1,plevp<a name='1517'>
                 do i=1,pcols<a name='1518'>
                    aer_trn_ttl(i,k1,k2,bnd_idx) = &amp;<a name='1519'>
                         aer_trn_ttl(i,1,k2,bnd_idx) / &amp;<a name='1520'>
                         aer_trn_ttl(i,1,k1,bnd_idx)<a name='1521'>
                 end do<a name='1522'>
              end do<a name='1523'>
           end do<a name='1524'>
<a name='1525'>
           do k1=2,plevp<a name='1526'>
              do k2=1,k1-1<a name='1527'>
                 do i=1,pcols<a name='1528'>
                    aer_trn_ttl(i,k1,k2,bnd_idx)=aer_trn_ttl(i,k2,k1,bnd_idx)<a name='1529'>
                 end do<a name='1530'>
              end do<a name='1531'>
           end do<a name='1532'>
        end do<a name='1533'>
      else<a name='1534'>
        aer_trn_ttl = 1.0<a name='1535'>
      endif<a name='1536'>
<a name='1537'>
      return<a name='1538'>
      end subroutine aer_trn<a name='1539'>
<a name='1540'>
<A NAME='AER_PTH'><A href='../../html_code/phys/module_ra_cam.F.html#AER_PTH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1541'>
      <font color=#993300>subroutine </font><font color=#cc0000>aer_pth</font>(aer_mass, aer_mpp, ncol, pcols, plev, plevp) <A href='../../call_to/AER_PTH.html' TARGET='index'>1</A><a name='1542'>
<font color=#447700>!------------------------------------------------------<a name='1543'></font>
<font color=#447700>!     Purpose: convert mass per layer to cumulative mass from Top<a name='1544'></font>
<font color=#447700>!------------------------------------------------------<a name='1545'></font>
<font color=#447700>!     use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='1546'></font>
<font color=#447700>!     use ppgrid<a name='1547'></font>
<font color=#447700>!     use pmgrid<a name='1548'></font>
      implicit none<a name='1549'>
<font color=#447700>!#include "crdcon.h"<a name='1550'></font>
<a name='1551'>
<font color=#447700>!     Parameters<a name='1552'></font>
<font color=#447700>!     Input<a name='1553'></font>
      integer, intent(in)        :: pcols, plev, plevp<a name='1554'>
      real(r8), intent(in):: aer_mass(pcols,plev)  <font color=#447700>! Rad level aerosol mass mixing ratio<a name='1555'></font>
      integer, intent(in):: ncol<a name='1556'>
<font color=#447700>!<a name='1557'></font>
<font color=#447700>!     Output<a name='1558'></font>
      real(r8), intent(out):: aer_mpp(pcols,plevp) <font color=#447700>! [kg m-2] Volcanics path above kth interface<a name='1559'></font>
<font color=#447700>!<a name='1560'></font>
<font color=#447700>!     Local<a name='1561'></font>
      integer i      <font color=#447700>! Column index<a name='1562'></font>
      integer k      <font color=#447700>! Level index<a name='1563'></font>
<font color=#447700>!------------------------------------------------------<a name='1564'></font>
<font color=#447700>!------------------------------------------------------<a name='1565'></font>
<a name='1566'>
      aer_mpp(1:ncol,1) =  0._r8<a name='1567'>
      do k=2,plevp<a name='1568'>
          aer_mpp(1:ncol,k) = aer_mpp(1:ncol,k-1) + aer_mass(1:ncol,k-1)<a name='1569'>
      enddo<a name='1570'>
<font color=#447700>!<a name='1571'></font>
      return<a name='1572'>
      end subroutine aer_pth<a name='1573'>
<a name='1574'>
<A NAME='RADCTL'><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1575'>
<font color=#993300>subroutine </font><font color=#cc0000>radctl</font>(j, lchnk   ,ncol    , pcols, pver, pverp, pverr, pverrp, ppcnst, pcnst,  &amp; <A href='../../call_to/RADCTL.html' TARGET='index'>1</A>,<A href='../../call_from/RADCTL.html' TARGET='index'>20</A><a name='1576'>
                  lwups   ,emis    ,          &amp;<a name='1577'>
                  pmid    ,pint    ,pmln    ,piln    ,pdel    ,t       , &amp;<a name='1578'>
<font color=#447700>!                 qm1     ,cld     ,cicewp  ,cliqwp  ,coszrs,  clat, &amp;<a name='1579'></font>
                  qm1     ,cld     ,cicewp  ,cliqwp  ,tauxcl, tauxci, coszrs,  clat, &amp;<a name='1580'>
                  asdir   ,asdif   ,aldir   ,aldif   ,solcon, GMT,JULDAY,JULIAN,DT,XTIME,  &amp;<a name='1581'>
                  pin, ozmixmj, ozmix, levsiz, num_months,      &amp;<a name='1582'>
                  m_psp, m_psn,  aerosoljp, aerosoljn, m_hybi, paerlev, naer_c, pmxrgn  , &amp;<a name='1583'>
                  nmxrgn  ,                   &amp;<a name='1584'>
                  dolw, dosw, doabsems, abstot, absnxt, emstot, &amp;<a name='1585'>
                  fsup    ,fsupc   ,fsdn    ,fsdnc   , &amp;<a name='1586'>
                  fsdndir ,fsdncdir,fsdndif ,fsdncdif, &amp; <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes<a name='1587'></font>
                  flup    ,flupc   ,fldn    ,fldnc   , &amp;<a name='1588'>
                  swcf    ,lwcf    ,flut    ,          &amp;<a name='1589'>
                  fsns    ,fsnt    ,flns    ,flnt    , &amp;<a name='1590'>
                  qrs     ,qrl     ,flwds   ,rel     ,rei     , &amp;<a name='1591'>
                  sols    ,soll    ,solsd   ,solld   , &amp;<a name='1592'>
<font color=#447700>!ccc<a name='1593'></font>
#ifdef CLWRFGHG<a name='1594'>
<font color=#447700>!CLWRF-UC June.09<a name='1595'></font>
                  n2ovmr, ch4vmr, f11vmr, f12vmr     , &amp;<a name='1596'>
#endif<a name='1597'>
<font color=#447700>!ccc<a name='1598'></font>
                  landfrac,zm      ,fsds, fsdsdir,fsdsdif     ) <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes<a name='1599'></font>
<font color=#447700>!----------------------------------------------------------------------- <a name='1600'></font>
<font color=#447700>! <a name='1601'></font>
<font color=#447700>! Purpose: <a name='1602'></font>
<font color=#447700>! Driver for radiation computation.<a name='1603'></font>
<font color=#447700>! <a name='1604'></font>
<font color=#447700>! Method: <a name='1605'></font>
<font color=#447700>! Radiation uses cgs units, so conversions must be done from<a name='1606'></font>
<font color=#447700>! model fields to radiation fields.<a name='1607'></font>
<font color=#447700>!<a name='1608'></font>
<font color=#447700>! Author: CCM1,  CMS Contact: J. Truesdale<a name='1609'></font>
<font color=#447700>! <a name='1610'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1611'></font>
<font color=#447700>!  use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='1612'></font>
<font color=#447700>!  use ppgrid<a name='1613'></font>
<font color=#447700>!  use pspect<a name='1614'></font>
<font color=#447700>!  use commap<a name='1615'></font>
<font color=#447700>!  use history, only: outfld<a name='1616'></font>
<font color=#447700>!  use constituents, only: ppcnst, cnst_get_ind<a name='1617'></font>
<font color=#447700>!  use prescribed_aerosols, only: get_aerosol, naer_all, aerosol_diagnostics, &amp;<a name='1618'></font>
<font color=#447700>!     aerosol_indirect, get_rf_scales, get_int_scales, radforce, idxVOLC<a name='1619'></font>
<font color=#447700>!  use physics_types, only: physics_state<a name='1620'></font>
<font color=#447700>!  use wv_saturation, only: aqsat<a name='1621'></font>
<font color=#447700>!  use chemistry,    only: trace_gas<a name='1622'></font>
<font color=#447700>!  use physconst, only: cpair, epsilo<a name='1623'></font>
<font color=#447700>!  use aer_optics, only: idxVIS<a name='1624'></font>
<font color=#447700>!  use aerosol_intr, only: set_aerosol_from_prognostics<a name='1625'></font>
<a name='1626'>
<a name='1627'>
   implicit none<a name='1628'>
<a name='1629'>
<font color=#447700>!<a name='1630'></font>
<font color=#447700>! Input arguments<a name='1631'></font>
<font color=#447700>!<a name='1632'></font>
   integer, intent(in) :: lchnk,j                 <font color=#447700>! chunk identifier<a name='1633'></font>
   integer, intent(in) :: ncol                  <font color=#447700>! number of atmospheric columns<a name='1634'></font>
   integer, intent(in) :: levsiz                <font color=#447700>! number of ozone data levels<a name='1635'></font>
   integer, intent(in) :: num_months            <font color=#447700>! 12 months<a name='1636'></font>
   integer, intent(in) :: paerlev,naer_c          <font color=#447700>! aerosol vertical level and # species<a name='1637'></font>
   integer, intent(in) :: pcols, pver, pverp, pverr, pverrp, ppcnst, pcnst<a name='1638'>
   logical, intent(in) :: dolw,dosw,doabsems<a name='1639'>
<a name='1640'>
<a name='1641'>
   integer nspint            <font color=#447700>! Num of spctrl intervals across solar spectrum<a name='1642'></font>
   integer naer_groups       <font color=#447700>! Num of aerosol groups for optical diagnostics<a name='1643'></font>
   parameter ( nspint = 19 )<a name='1644'>
   parameter ( naer_groups = 7 )    <font color=#447700>! current groupings are sul, sslt, all carbons, all dust, background, and all aerosols<a name='1645'></font>
<a name='1646'>
<a name='1647'>
   real(r8), intent(in) :: lwups(pcols)         <font color=#447700>! Longwave up flux at surface<a name='1648'></font>
   real(r8), intent(in) :: emis(pcols,pver)     <font color=#447700>! Cloud emissivity<a name='1649'></font>
   real(r8), intent(in) :: pmid(pcols,pver)     <font color=#447700>! Model level pressures<a name='1650'></font>
   real(r8), intent(in) :: pint(pcols,pverp)    <font color=#447700>! Model interface pressures<a name='1651'></font>
   real(r8), intent(in) :: pmln(pcols,pver)     <font color=#447700>! Natural log of pmid<a name='1652'></font>
   real(r8), intent(in) :: rel(pcols,pver)      <font color=#447700>! liquid effective drop size (microns)<a name='1653'></font>
   real(r8), intent(in) :: rei(pcols,pver)      <font color=#447700>! ice effective drop size (microns)<a name='1654'></font>
   real(r8), intent(in) :: piln(pcols,pverp)    <font color=#447700>! Natural log of pint<a name='1655'></font>
   real(r8), intent(in) :: pdel(pcols,pverp)    <font color=#447700>! Pressure difference across layer <a name='1656'></font>
   real(r8), intent(in) :: t(pcols,pver)        <font color=#447700>! Model level temperatures<a name='1657'></font>
   real(r8), intent(in) :: qm1(pcols,pver,ppcnst) <font color=#447700>! Specific humidity and tracers<a name='1658'></font>
   real(r8), intent(in) :: cld(pcols,pver)      <font color=#447700>! Fractional cloud cover<a name='1659'></font>
   real(r8), intent(in) :: cicewp(pcols,pver)   <font color=#447700>! in-cloud cloud ice water path<a name='1660'></font>
   real(r8), intent(in) :: cliqwp(pcols,pver)   <font color=#447700>! in-cloud cloud liquid water path<a name='1661'></font>
   real(r8), intent(inout) :: tauxcl(pcols,0:pver) <font color=#447700>! cloud water optical depth<a name='1662'></font>
   real(r8), intent(inout) :: tauxci(pcols,0:pver) <font color=#447700>! cloud ice optical depth<a name='1663'></font>
   real(r8), intent(in) :: coszrs(pcols)        <font color=#447700>! Cosine solar zenith angle<a name='1664'></font>
   real(r8), intent(in) :: clat(pcols)          <font color=#447700>! latitude in radians for columns <a name='1665'></font>
   real(r8), intent(in) :: asdir(pcols)         <font color=#447700>! albedo shortwave direct<a name='1666'></font>
   real(r8), intent(in) :: asdif(pcols)         <font color=#447700>! albedo shortwave diffuse<a name='1667'></font>
   real(r8), intent(in) :: aldir(pcols)         <font color=#447700>! albedo longwave direct<a name='1668'></font>
   real(r8), intent(in) :: aldif(pcols)         <font color=#447700>! albedo longwave diffuse<a name='1669'></font>
   real(r8), intent(in) :: landfrac(pcols)      <font color=#447700>! land fraction<a name='1670'></font>
   real(r8), intent(in) :: zm(pcols,pver)       <font color=#447700>! Height of midpoints (above surface)<a name='1671'></font>
   real(r8), intent(in) :: pin(levsiz)          <font color=#447700>! Pressure levels of ozone data<a name='1672'></font>
   real(r8), intent(in) :: ozmixmj(pcols,levsiz,num_months)  <font color=#447700>! monthly ozone mixing ratio<a name='1673'></font>
   real(r8), intent(inout) :: ozmix(pcols,levsiz)  <font color=#447700>! Ozone data<a name='1674'></font>
   real, intent(in) :: solcon               <font color=#447700>! solar constant with eccentricity factor<a name='1675'></font>
   REAL, INTENT(IN    )      ::        XTIME,GMT              <a name='1676'>
   INTEGER, INTENT(IN )      ::        JULDAY<a name='1677'>
   REAL,    INTENT(IN )      ::        JULIAN<a name='1678'>
   REAL,    INTENT(IN )      ::        DT<a name='1679'>
   real(r8), intent(in)     :: m_psp(pcols),m_psn(pcols)       <font color=#447700>! MATCH surface pressure<a name='1680'></font>
   real(r8), intent(in)     :: aerosoljp(pcols,paerlev,naer_c)   <font color=#447700>! aerosol concentrations<a name='1681'></font>
   real(r8), intent(in)     :: aerosoljn(pcols,paerlev,naer_c)   <font color=#447700>! aerosol concentrations<a name='1682'></font>
   real(r8), intent(in)     :: m_hybi(paerlev)<a name='1683'>
<font color=#447700>!  type(physics_state), intent(in) :: state     <a name='1684'></font>
   real(r8), intent(inout) :: pmxrgn(pcols,pverp) <font color=#447700>! Maximum values of pmid for each<a name='1685'></font>
<font color=#447700>!    maximally overlapped region.<a name='1686'></font>
<font color=#447700>!    0-&gt;pmxrgn(i,1) is range of pmid for<a name='1687'></font>
<font color=#447700>!    1st region, pmxrgn(i,1)-&gt;pmxrgn(i,2) for<a name='1688'></font>
<font color=#447700>!    2nd region, etc<a name='1689'></font>
   integer, intent(inout) :: nmxrgn(pcols)     <font color=#447700>! Number of maximally overlapped regions<a name='1690'></font>
<a name='1691'>
    real(r8) :: pmxrgnrf(pcols,pverp)             <font color=#447700>! temporary copy of pmxrgn<a name='1692'></font>
    integer  :: nmxrgnrf(pcols)     <font color=#447700>! temporary copy of nmxrgn<a name='1693'></font>
<a name='1694'>
<font color=#447700>!<a name='1695'></font>
<font color=#447700>! Output solar arguments<a name='1696'></font>
<font color=#447700>!<a name='1697'></font>
   real(r8), intent(out) :: fsns(pcols)          <font color=#447700>! Surface absorbed solar flux<a name='1698'></font>
   real(r8), intent(out) :: fsnt(pcols)          <font color=#447700>! Net column abs solar flux at model top<a name='1699'></font>
   real(r8), intent(out) :: flns(pcols)          <font color=#447700>! Srf longwave cooling (up-down) flux<a name='1700'></font>
   real(r8), intent(out) :: flnt(pcols)          <font color=#447700>! Net outgoing lw flux at model top<a name='1701'></font>
   real(r8), intent(out) :: sols(pcols)          <font color=#447700>! Downward solar rad onto surface (sw direct)<a name='1702'></font>
   real(r8), intent(out) :: soll(pcols)          <font color=#447700>! Downward solar rad onto surface (lw direct)<a name='1703'></font>
   real(r8), intent(out) :: solsd(pcols)         <font color=#447700>! Downward solar rad onto surface (sw diffuse)<a name='1704'></font>
   real(r8), intent(out) :: solld(pcols)         <font color=#447700>! Downward solar rad onto surface (lw diffuse)<a name='1705'></font>
   real(r8), intent(out) :: qrs(pcols,pver)      <font color=#447700>! Solar heating rate<a name='1706'></font>
   real(r8), intent(out) :: fsds(pcols)          <font color=#447700>! Flux Shortwave Downwelling Surface<a name='1707'></font>
   real(r8), intent(out) :: fsdsdir(pcols)       <font color=#447700>! Flux Shortwave Direct Downwelling Surface (amontornes-bcodina 2014-04-20)<a name='1708'></font>
   real(r8), intent(out) :: fsdsdif(pcols)       <font color=#447700>! Flux Shortwave Diffuse Downwelling Surface (amontornes-bcodina 2014-04-20)<a name='1709'></font>
<font color=#447700>! Added outputs of total and clearsky fluxes etc<a name='1710'></font>
   real(r8), intent(out) :: fsup(pcols,pverp)    <font color=#447700>! Upward total sky solar<a name='1711'></font>
   real(r8), intent(out) :: fsupc(pcols,pverp)   <font color=#447700>! Upward clear sky solar<a name='1712'></font>
   real(r8), intent(out) :: fsdn(pcols,pverp)    <font color=#447700>! Downward total sky solar<a name='1713'></font>
   real(r8), intent(out) :: fsdnc(pcols,pverp)   <font color=#447700>! Downward clear sky solar<a name='1714'></font>
   real(r8), intent(out) :: fsdndir(pcols,pverp) <font color=#447700>! Downward Direct total sky solar (amontornes-bcodina 2014-04-20)<a name='1715'></font>
   real(r8), intent(out) :: fsdncdir(pcols,pverp)<font color=#447700>! Downward Direct clear sky solar (amontornes-bcodina 2014-04-20)<a name='1716'></font>
   real(r8), intent(out) :: fsdndif(pcols,pverp) <font color=#447700>! Downward Diffuse total sky solar (amontornes-bcodina 2014-04-20)<a name='1717'></font>
   real(r8), intent(out) :: fsdncdif(pcols,pverp)<font color=#447700>! Downward Diffuse clear sky solar (amontornes-bcodina 2014-04-20)<a name='1718'></font>
   real(r8), intent(out) :: flup(pcols,pverp)    <font color=#447700>! Upward total sky longwave<a name='1719'></font>
   real(r8), intent(out) :: flupc(pcols,pverp)   <font color=#447700>! Upward clear sky longwave<a name='1720'></font>
   real(r8), intent(out) :: fldn(pcols,pverp)    <font color=#447700>! Downward total sky longwave<a name='1721'></font>
   real(r8), intent(out) :: fldnc(pcols,pverp)   <font color=#447700>! Downward clear sky longwave<a name='1722'></font>
   real(r8), intent(out) :: swcf(pcols)          <font color=#447700>! Top of the atmosphere solar cloud forcing<a name='1723'></font>
   real(r8), intent(out) :: lwcf(pcols)          <font color=#447700>! Top of the atmosphere longwave cloud forcing<a name='1724'></font>
   real(r8), intent(out) :: flut(pcols)          <font color=#447700>! Top of the atmosphere outgoing longwave<a name='1725'></font>
<font color=#447700>!<a name='1726'></font>
<font color=#447700>! Output longwave arguments<a name='1727'></font>
<font color=#447700>!<a name='1728'></font>
   real(r8), intent(out) :: qrl(pcols,pver)      <font color=#447700>! Longwave cooling rate<a name='1729'></font>
   real(r8), intent(out) :: flwds(pcols)         <font color=#447700>! Surface down longwave flux<a name='1730'></font>
<a name='1731'>
   real(r8), intent(inout) :: abstot(pcols,pverp,pverp) <font color=#447700>! Total absorptivity<a name='1732'></font>
   real(r8), intent(inout) :: absnxt(pcols,pver,4)      <font color=#447700>! Total nearest layer absorptivity<a name='1733'></font>
   real(r8), intent(inout) :: emstot(pcols,pverp)     <font color=#447700>! Total emissivity<a name='1734'></font>
<a name='1735'>
<a name='1736'>
<font color=#447700>!<a name='1737'></font>
<font color=#447700>!---------------------------Local variables-----------------------------<a name='1738'></font>
<font color=#447700>!<a name='1739'></font>
   integer i, k              <font color=#447700>! index<a name='1740'></font>
<a name='1741'>
   integer :: in2o, ich4, if11, if12 <font color=#447700>! indexes of gases in constituent array<a name='1742'></font>
<a name='1743'>
   real(r8) solin(pcols)         <font color=#447700>! Solar incident flux<a name='1744'></font>
<font color=#447700>!  real(r8) fsds(pcols)          ! Flux Shortwave Downwelling Surface<a name='1745'></font>
   real(r8) fsntoa(pcols)        <font color=#447700>! Net solar flux at TOA<a name='1746'></font>
   real(r8) fsntoac(pcols)       <font color=#447700>! Clear sky net solar flux at TOA<a name='1747'></font>
   real(r8) fsnirt(pcols)        <font color=#447700>! Near-IR flux absorbed at toa<a name='1748'></font>
   real(r8) fsnrtc(pcols)        <font color=#447700>! Clear sky near-IR flux absorbed at toa<a name='1749'></font>
   real(r8) fsnirtsq(pcols)      <font color=#447700>! Near-IR flux absorbed at toa &gt;= 0.7 microns<a name='1750'></font>
   real(r8) fsntc(pcols)         <font color=#447700>! Clear sky total column abs solar flux<a name='1751'></font>
   real(r8) fsnsc(pcols)         <font color=#447700>! Clear sky surface abs solar flux<a name='1752'></font>
   real(r8) fsdsc(pcols)         <font color=#447700>! Clear sky surface downwelling solar flux<a name='1753'></font>
   real(r8) fsdscdir(pcols)      <font color=#447700>! Clear sky surface direct downwelling solar flux (amontornes-bcodina 2014-04-20)<a name='1754'></font>
   real(r8) fsdscdif(pcols)      <font color=#447700>! Clear sky surface diffuse downwelling solar flux (amontornes-bcodina 2014-04-20)<a name='1755'></font>
<font color=#447700>!  real(r8) flut(pcols)          ! Upward flux at top of model<a name='1756'></font>
<font color=#447700>!  real(r8) lwcf(pcols)          ! longwave cloud forcing<a name='1757'></font>
<font color=#447700>!  real(r8) swcf(pcols)          ! shortwave cloud forcing<a name='1758'></font>
   real(r8) flutc(pcols)         <font color=#447700>! Upward Clear Sky flux at top of model<a name='1759'></font>
   real(r8) flntc(pcols)         <font color=#447700>! Clear sky lw flux at model top<a name='1760'></font>
   real(r8) flnsc(pcols)         <font color=#447700>! Clear sky lw flux at srf (up-down)<a name='1761'></font>
   real(r8) ftem(pcols,pver)     <font color=#447700>! temporary array for outfld<a name='1762'></font>
<a name='1763'>
   real(r8) pbr(pcols,pverr)     <font color=#447700>! Model mid-level pressures (dynes/cm2)<a name='1764'></font>
   real(r8) pnm(pcols,pverrp)    <font color=#447700>! Model interface pressures (dynes/cm2)<a name='1765'></font>
   real(r8) o3vmr(pcols,pverr)   <font color=#447700>! Ozone volume mixing ratio<a name='1766'></font>
   real(r8) o3mmr(pcols,pverr)   <font color=#447700>! Ozone mass mixing ratio<a name='1767'></font>
   real(r8) eccf                 <font color=#447700>! Earth/sun distance factor<a name='1768'></font>
   real(r8) n2o(pcols,pver)      <font color=#447700>! nitrous oxide mass mixing ratio<a name='1769'></font>
   real(r8) ch4(pcols,pver)      <font color=#447700>! methane mass mixing ratio<a name='1770'></font>
   real(r8) cfc11(pcols,pver)    <font color=#447700>! cfc11 mass mixing ratio<a name='1771'></font>
   real(r8) cfc12(pcols,pver)    <font color=#447700>! cfc12 mass mixing ratio<a name='1772'></font>
   real(r8) rh(pcols,pverr)      <font color=#447700>! level relative humidity (fraction)<a name='1773'></font>
   real(r8) lwupcgs(pcols)       <font color=#447700>! Upward longwave flux in cgs units<a name='1774'></font>
<a name='1775'>
   real(r8) esat(pcols,pverr)    <font color=#447700>! saturation vapor pressure<a name='1776'></font>
   real(r8) qsat(pcols,pverr)    <font color=#447700>! saturation specific humidity<a name='1777'></font>
<a name='1778'>
   real(r8) :: frc_day(pcols) <font color=#447700>! = 1 for daylight, =0 for night colums<a name='1779'></font>
   real(r8) :: aertau(pcols,nspint,naer_groups) <font color=#447700>! Aerosol column optical depth<a name='1780'></font>
   real(r8) :: aerssa(pcols,nspint,naer_groups) <font color=#447700>! Aerosol column averaged single scattering albedo<a name='1781'></font>
   real(r8) :: aerasm(pcols,nspint,naer_groups) <font color=#447700>! Aerosol column averaged asymmetry parameter<a name='1782'></font>
   real(r8) :: aerfwd(pcols,nspint,naer_groups) <font color=#447700>! Aerosol column averaged forward scattering<a name='1783'></font>
<a name='1784'>
   real(r8) aerosol(pcols, pver, naer_all) <font color=#447700>! aerosol mass mixing ratios<a name='1785'></font>
   real(r8) scales(naer_all)               <font color=#447700>! scaling factors for aerosols<a name='1786'></font>
<a name='1787'>
<font color=#447700>!ccc<a name='1788'></font>
#ifdef CLWRFGHG<a name='1789'>
<font color=#447700>!CLWRF-UC July.09<a name='1790'></font>
   real(r8), INTENT(IN)        ::    n2ovmr, ch4vmr, f11vmr, f12vmr<a name='1791'>
#endif<a name='1792'>
   LOGICAL, EXTERNAL                                :: wrf_dm_on_monitor<a name='1793'>
   CHARACTER (LEN=256)         ::    message<a name='1794'>
<font color=#447700>!ccc<a name='1795'></font>
<a name='1796'>
<font color=#447700>!<a name='1797'></font>
<font color=#447700>! Interpolate ozone volume mixing ratio to model levels<a name='1798'></font>
<font color=#447700>!<a name='1799'></font>
<font color=#447700>! WRF: added pin, levsiz, ozmix here<a name='1800'></font>
   call <A href='../../html_code/phys/module_ra_cam.F.html#OZNINT'>oznint</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OZNINT_1">(julday,julian,dt,gmt,xtime,ozmixmj,ozmix,levsiz,num_months,pcols)<a name='1801'>
<a name='1802'>
   call <A href='../../html_code/phys/module_ra_cam.F.html#RADOZN'>radozn</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADOZN_1">(lchnk   ,ncol    &amp;<a name='1803'>
              ,pcols, pver &amp;<a name='1804'>
              ,pmid    ,pin, levsiz, ozmix, o3vmr   )<a name='1805'>
<a name='1806'>
<font color=#447700>!  call outfld('O3VMR   ',o3vmr ,pcols, lchnk)<a name='1807'></font>
<a name='1808'>
<font color=#447700>!<a name='1809'></font>
<font color=#447700>! Set chunk dependent radiation input<a name='1810'></font>
<font color=#447700>!<a name='1811'></font>
   call <A href='../../html_code/phys/module_ra_cam.F.html#RADINP'>radinp</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADINP_1">(lchnk   ,ncol    ,pcols, pver, pverp,      &amp;<a name='1812'>
               pmid    ,pint    ,o3vmr   , pbr     ,&amp;<a name='1813'>
               pnm     ,eccf    ,o3mmr   )<a name='1814'>
<a name='1815'>
<font color=#447700>!<a name='1816'></font>
<font color=#447700>! Solar radiation computation<a name='1817'></font>
<font color=#447700>!<a name='1818'></font>
   if (dosw) then<a name='1819'>
<a name='1820'>
<font color=#447700>!<a name='1821'></font>
<font color=#447700>! calculate heating with aerosols<a name='1822'></font>
<font color=#447700>!<a name='1823'></font>
      call <A href='../../html_code/phys/module_ra_cam_support.F.html#AQSAT'>aqsat</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AQSAT_4">(t, pmid, esat, qsat, pcols, &amp;<a name='1824'>
                 ncol, pver, 1, pver)<a name='1825'>
<a name='1826'>
      <font color=#447700>! calculate relative humidity<a name='1827'></font>
<font color=#447700>!     rh(1:ncol,1:pver) = q(1:ncol,1:pver,1) / qsat(1:ncol,1:pver) * &amp;<a name='1828'></font>
<font color=#447700>!        ((1.0 - epsilo) * qsat(1:ncol,1:pver) + epsilo) / &amp;<a name='1829'></font>
<font color=#447700>!        ((1.0 - epsilo) * q(1:ncol,1:pver,1) + epsilo)<a name='1830'></font>
      rh(1:ncol,1:pver) = qm1(1:ncol,1:pver,1) / qsat(1:ncol,1:pver) * &amp;<a name='1831'>
         ((1.0 - epsilo) * qsat(1:ncol,1:pver) + epsilo) / &amp;<a name='1832'>
         ((1.0 - epsilo) * qm1(1:ncol,1:pver,1) + epsilo)<a name='1833'>
<a name='1834'>
      if (radforce) then<a name='1835'>
<a name='1836'>
         pmxrgnrf = pmxrgn<a name='1837'>
         nmxrgnrf = nmxrgn<a name='1838'>
<a name='1839'>
         call <A href='../../html_code/phys/module_ra_cam_support.F.html#GET_RF_SCALES'>get_rf_scales</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_RF_SCALES_1">(scales)<a name='1840'>
<a name='1841'>
         call <A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL'>get_aerosol</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_AEROSOL_1">(lchnk, julday, julian, dt, gmt, xtime, m_psp, m_psn, aerosoljp, &amp;<a name='1842'>
           aerosoljn, m_hybi, paerlev, naer, pint, pcols, pver, pverp, pverr, pverrp, aerosol, scales)<a name='1843'>
<a name='1844'>
         <font color=#447700>! overwrite with prognostics aerosols<a name='1845'></font>
<a name='1846'>
<font color=#447700>!   no feedback from prognostic aerosols <a name='1847'></font>
<font color=#447700>!        call set_aerosol_from_prognostics (ncol, q, aerosol)<a name='1848'></font>
<a name='1849'>
         call <A href='../../html_code/phys/module_ra_cam.F.html#AEROSOL_INDIRECT'>aerosol_indirect</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AEROSOL_INDIRECT_1">(ncol,lchnk,pcols,pver,ppcnst,landfrac,pmid,t,qm1,cld,zm,rel)<a name='1850'>
   <a name='1851'>
<font color=#447700>!        call t_startf('radcswmx_rf')<a name='1852'></font>
         call <A href='../../html_code/phys/module_ra_cam.F.html#RADCSWMX'>radcswmx</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADCSWMX_1">(j, lchnk   ,ncol ,pcols, pver, pverp,         &amp;<a name='1853'>
                    pnm     ,pbr     ,qm1     ,rh      ,o3mmr   , &amp;<a name='1854'>
                    aerosol ,cld     ,cicewp  ,cliqwp  ,rel     , &amp;<a name='1855'>
<font color=#447700>!                   rei     ,eccf    ,coszrs  ,scon    ,solin   ,solcon , &amp;<a name='1856'></font>
                    rei     ,tauxcl  ,tauxci  ,eccf    ,coszrs  ,scon    ,solin   ,solcon , &amp;<a name='1857'>
                    asdir   ,asdif   ,aldir   ,aldif   ,nmxrgnrf, &amp;<a name='1858'>
                    pmxrgnrf,qrs     ,fsnt    ,fsntc   ,fsntoa  , &amp;<a name='1859'>
                    fsntoac ,fsnirt  ,fsnrtc  ,fsnirtsq,fsns    , &amp;<a name='1860'>
                    fsnsc   ,fsdsc   ,fsds    ,sols    ,soll    , &amp;<a name='1861'>
                    solsd   ,solld   ,frc_day ,                   &amp;<a name='1862'>
                    fsup    ,fsupc   ,fsdn    ,fsdnc   ,          &amp;<a name='1863'>
                    fsdndir ,fsdncdir,fsdndif ,fsdncdif,          &amp; <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes profile<a name='1864'></font>
                    fsdsdir ,fsdsdif ,fsdscdir,fsdscdif,          &amp; <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes sfc<a name='1865'></font>
                    aertau  ,aerssa  ,aerasm  ,aerfwd             )<a name='1866'>
<font color=#447700>!        call t_stopf('radcswmx_rf')<a name='1867'></font>
<a name='1868'>
<font color=#447700>!<a name='1869'></font>
<font color=#447700>! Convert units of shortwave fields needed by rest of model from CGS to MKS<a name='1870'></font>
<font color=#447700>!<a name='1871'></font>
<a name='1872'>
            do i = 1, ncol<a name='1873'>
            solin(i) = solin(i)*1.e-3<a name='1874'>
            fsnt(i)  = fsnt(i) *1.e-3<a name='1875'>
            fsns(i)  = fsns(i) *1.e-3<a name='1876'>
            fsntc(i) = fsntc(i)*1.e-3<a name='1877'>
            fsnsc(i) = fsnsc(i)*1.e-3<a name='1878'>
            end do<a name='1879'>
         ftem(:ncol,:pver) = qrs(:ncol,:pver)/cpair<a name='1880'>
<font color=#447700>!<a name='1881'></font>
<font color=#447700>! Dump shortwave radiation information to history tape buffer (diagnostics)<a name='1882'></font>
<font color=#447700>!<a name='1883'></font>
<font color=#447700>!        call outfld('QRS_RF  ',ftem  ,pcols,lchnk)<a name='1884'></font>
<font color=#447700>!        call outfld('FSNT_RF ',fsnt  ,pcols,lchnk)<a name='1885'></font>
<font color=#447700>!        call outfld('FSNS_RF ',fsns  ,pcols,lchnk)<a name='1886'></font>
<font color=#447700>!        call outfld('FSNTC_RF',fsntc ,pcols,lchnk)<a name='1887'></font>
<font color=#447700>!        call outfld('FSNSC_RF',fsnsc ,pcols,lchnk)<a name='1888'></font>
 <a name='1889'>
      endif <font color=#447700>! if (radforce)<a name='1890'></font>
<a name='1891'>
      call <A href='../../html_code/phys/module_ra_cam_support.F.html#GET_INT_SCALES'>get_int_scales</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INT_SCALES_1">(scales)<a name='1892'>
<a name='1893'>
      call <A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL'>get_aerosol</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_AEROSOL_2">(lchnk, julday, julian, dt, gmt, xtime, m_psp, m_psn, aerosoljp, aerosoljn, &amp;<a name='1894'>
             m_hybi, paerlev, naer, pint, pcols, pver, pverp, pverr, pverrp, aerosol, scales)<a name='1895'>
<a name='1896'>
      <font color=#447700>! overwrite with prognostics aerosols<a name='1897'></font>
<font color=#447700>!     call set_aerosol_from_prognostics (ncol, q, aerosol)<a name='1898'></font>
<a name='1899'>
      call <A href='../../html_code/phys/module_ra_cam.F.html#AEROSOL_INDIRECT'>aerosol_indirect</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AEROSOL_INDIRECT_2">(ncol,lchnk,pcols,pver,ppcnst,landfrac,pmid,t,qm1,cld,zm,rel)<a name='1900'>
<font color=#447700>!     call t_startf('radcswmx')<a name='1901'></font>
<a name='1902'>
      call <A href='../../html_code/phys/module_ra_cam.F.html#RADCSWMX'>radcswmx</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADCSWMX_2">(j, lchnk   ,ncol    ,pcols, pver, pverp,         &amp;<a name='1903'>
                    pnm     ,pbr     ,qm1     ,rh      ,o3mmr   , &amp;<a name='1904'>
                    aerosol ,cld     ,cicewp  ,cliqwp  ,rel     , &amp;<a name='1905'>
<font color=#447700>!                   rei     ,eccf    ,coszrs  ,scon    ,solin   ,solcon , &amp;<a name='1906'></font>
                    rei     ,tauxcl  ,tauxci  ,eccf    ,coszrs  ,scon    ,solin   ,solcon , &amp;<a name='1907'>
                    asdir   ,asdif   ,aldir   ,aldif   ,nmxrgn  , &amp;<a name='1908'>
                    pmxrgn  ,qrs     ,fsnt    ,fsntc   ,fsntoa  , &amp;<a name='1909'>
                    fsntoac ,fsnirt  ,fsnrtc  ,fsnirtsq,fsns    , &amp;<a name='1910'>
                    fsnsc   ,fsdsc   ,fsds    ,sols    ,soll    , &amp;<a name='1911'>
                    solsd   ,solld   ,frc_day ,                   &amp;<a name='1912'>
                    fsup    ,fsupc   ,fsdn    ,fsdnc   ,          &amp;<a name='1913'>
                    fsdndir ,fsdncdir,fsdndif ,fsdncdif,          &amp; <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes profiles<a name='1914'></font>
                    fsdsdir ,fsdsdif ,fsdscdir,fsdscdif,          &amp; <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes sfc<a name='1915'></font>
                    aertau  ,aerssa  ,aerasm  ,aerfwd             )<a name='1916'>
<font color=#447700>!     call t_stopf('radcswmx')<a name='1917'></font>
<a name='1918'>
<font color=#447700>! -- tls ---------------------------------------------------------------2<a name='1919'></font>
<font color=#447700>!<a name='1920'></font>
<font color=#447700>! Convert units of shortwave fields needed by rest of model from CGS to MKS<a name='1921'></font>
<font color=#447700>!<a name='1922'></font>
      do i=1,ncol<a name='1923'>
         solin(i) = solin(i)*1.e-3<a name='1924'>
         fsds(i)  = fsds(i)*1.e-3<a name='1925'>
         fsnirt(i)= fsnirt(i)*1.e-3<a name='1926'>
         fsnrtc(i)= fsnrtc(i)*1.e-3<a name='1927'>
         fsnirtsq(i)= fsnirtsq(i)*1.e-3<a name='1928'>
         fsnt(i)  = fsnt(i) *1.e-3<a name='1929'>
         fsns(i)  = fsns(i) *1.e-3<a name='1930'>
         fsntc(i) = fsntc(i)*1.e-3<a name='1931'>
         fsnsc(i) = fsnsc(i)*1.e-3<a name='1932'>
         fsdsc(i) = fsdsc(i)*1.e-3<a name='1933'>
         fsntoa(i)=fsntoa(i)*1.e-3<a name='1934'>
         fsntoac(i)=fsntoac(i)*1.e-3<a name='1935'>
         swcf(i)  = fsntoa(i) - fsntoac(i)<a name='1936'>
<a name='1937'>
         fsdsdir(i)  = fsdsdir(i)*1.e-3  <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='1938'></font>
         fsdsdif(i)  = fsdsdif(i)*1.e-3  <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='1939'></font>
         fsdscdir(i) = fsdscdir(i)*1.e-3 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='1940'></font>
         fsdscdif(i) = fsdscdif(i)*1.e-3 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='1941'></font>
      end do<a name='1942'>
      ftem(:ncol,:pver) = qrs(:ncol,:pver)/cpair<a name='1943'>
<a name='1944'>
<font color=#447700>! Added upward/downward total and clear sky fluxes<a name='1945'></font>
         do k = 1, pverp<a name='1946'>
            do i = 1, ncol<a name='1947'>
            fsup(i,k)  = fsup(i,k)*1.e-3<a name='1948'>
            fsupc(i,k) = fsupc(i,k)*1.e-3<a name='1949'>
            fsdn(i,k)  = fsdn(i,k)*1.e-3<a name='1950'>
            fsdnc(i,k) = fsdnc(i,k)*1.e-3<a name='1951'>
            end do<a name='1952'>
         end do<a name='1953'>
<a name='1954'>
<font color=#447700>!<a name='1955'></font>
<font color=#447700>! Dump shortwave radiation information to history tape buffer (diagnostics)<a name='1956'></font>
<font color=#447700>!<a name='1957'></font>
<a name='1958'>
<font color=#447700>!     call outfld('frc_day ', frc_day, pcols, lchnk)<a name='1959'></font>
<font color=#447700>!     call outfld('SULOD_v ', aertau(:,idxVIS,1) ,pcols,lchnk)<a name='1960'></font>
<font color=#447700>!     call outfld('SSLTOD_v', aertau(:,idxVIS,2) ,pcols,lchnk)<a name='1961'></font>
<font color=#447700>!     call outfld('CAROD_v ', aertau(:,idxVIS,3) ,pcols,lchnk)<a name='1962'></font>
<font color=#447700>!     call outfld('DUSTOD_v', aertau(:,idxVIS,4) ,pcols,lchnk)<a name='1963'></font>
<font color=#447700>!     call outfld('BGOD_v  ', aertau(:,idxVIS,5) ,pcols,lchnk)<a name='1964'></font>
<font color=#447700>!     call outfld('VOLCOD_v', aertau(:,idxVIS,6) ,pcols,lchnk)<a name='1965'></font>
<font color=#447700>!     call outfld('AEROD_v ', aertau(:,idxVIS,7) ,pcols,lchnk)<a name='1966'></font>
<font color=#447700>!     call outfld('AERSSA_v', aerssa(:,idxVIS,7) ,pcols,lchnk)<a name='1967'></font>
<font color=#447700>!     call outfld('AERASM_v', aerasm(:,idxVIS,7) ,pcols,lchnk)<a name='1968'></font>
<font color=#447700>!     call outfld('AERFWD_v', aerfwd(:,idxVIS,7) ,pcols,lchnk)<a name='1969'></font>
<font color=#447700>!     call aerosol_diagnostics (lchnk, ncol, pdel, aerosol)<a name='1970'></font>
<a name='1971'>
<font color=#447700>!     call outfld('QRS     ',ftem  ,pcols,lchnk)<a name='1972'></font>
<font color=#447700>!     call outfld('SOLIN   ',solin ,pcols,lchnk)<a name='1973'></font>
<font color=#447700>!     call outfld('FSDS    ',fsds  ,pcols,lchnk)<a name='1974'></font>
<font color=#447700>!     call outfld('FSNIRTOA',fsnirt,pcols,lchnk)<a name='1975'></font>
<font color=#447700>!     call outfld('FSNRTOAC',fsnrtc,pcols,lchnk)<a name='1976'></font>
<font color=#447700>!     call outfld('FSNRTOAS',fsnirtsq,pcols,lchnk)<a name='1977'></font>
<font color=#447700>!     call outfld('FSNT    ',fsnt  ,pcols,lchnk)<a name='1978'></font>
<font color=#447700>!     call outfld('FSNS    ',fsns  ,pcols,lchnk)<a name='1979'></font>
<font color=#447700>!     call outfld('FSNTC   ',fsntc ,pcols,lchnk)<a name='1980'></font>
<font color=#447700>!     call outfld('FSNSC   ',fsnsc ,pcols,lchnk)<a name='1981'></font>
<font color=#447700>!     call outfld('FSDSC   ',fsdsc ,pcols,lchnk)<a name='1982'></font>
<font color=#447700>!     call outfld('FSNTOA  ',fsntoa,pcols,lchnk)<a name='1983'></font>
<font color=#447700>!     call outfld('FSNTOAC ',fsntoac,pcols,lchnk)<a name='1984'></font>
<font color=#447700>!     call outfld('SOLS    ',sols  ,pcols,lchnk)<a name='1985'></font>
<font color=#447700>!     call outfld('SOLL    ',soll  ,pcols,lchnk)<a name='1986'></font>
<font color=#447700>!     call outfld('SOLSD   ',solsd ,pcols,lchnk)<a name='1987'></font>
<font color=#447700>!     call outfld('SOLLD   ',solld ,pcols,lchnk)<a name='1988'></font>
<a name='1989'>
   end if<a name='1990'>
<font color=#447700>!<a name='1991'></font>
<font color=#447700>! Longwave radiation computation<a name='1992'></font>
<font color=#447700>!<a name='1993'></font>
   if (dolw) then<a name='1994'>
<a name='1995'>
      call <A href='../../html_code/phys/module_ra_cam_support.F.html#GET_INT_SCALES'>get_int_scales</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_INT_SCALES_2">(scales)<a name='1996'>
<a name='1997'>
      call <A href='../../html_code/phys/module_ra_cam.F.html#GET_AEROSOL'>get_aerosol</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_AEROSOL_3">(lchnk, julday, julian, dt, gmt, xtime, m_psp, m_psn, aerosoljp, aerosoljn, &amp;<a name='1998'>
             m_hybi, paerlev, naer, pint, pcols, pver, pverp, pverr, pverrp, aerosol, scales)<a name='1999'>
<a name='2000'>
<font color=#447700>!<a name='2001'></font>
<font color=#447700>! Convert upward longwave flux units to CGS<a name='2002'></font>
<font color=#447700>!<a name='2003'></font>
      do i=1,ncol<a name='2004'>
<font color=#447700>!        lwupcgs(i) = lwup(i)*1000.<a name='2005'></font>
         lwupcgs(i) = lwups(i)<a name='2006'>
      end do<a name='2007'>
<font color=#447700>!<a name='2008'></font>
<font color=#447700>! Do longwave computation. If not implementing greenhouse gas code then<a name='2009'></font>
<font color=#447700>! first specify trace gas mixing ratios. If greenhouse gas code then:<a name='2010'></font>
<font color=#447700>!  o ixtrcg   =&gt; indx of advected n2o tracer<a name='2011'></font>
<font color=#447700>!  o ixtrcg+1 =&gt; indx of advected ch4 tracer<a name='2012'></font>
<font color=#447700>!  o ixtrcg+2 =&gt; indx of advected cfc11 tracer<a name='2013'></font>
<font color=#447700>!  o ixtrcg+3 =&gt; indx of advected cfc12 tracer<a name='2014'></font>
<font color=#447700>!<a name='2015'></font>
      if (trace_gas) then<a name='2016'>
<font color=#447700>!        call cnst_get_ind('N2O'  , in2o)<a name='2017'></font>
<font color=#447700>!        call cnst_get_ind('CH4'  , ich4)<a name='2018'></font>
<font color=#447700>!        call cnst_get_ind('CFC11', if11)<a name='2019'></font>
<font color=#447700>!        call cnst_get_ind('CFC12', if12)<a name='2020'></font>
<font color=#447700>!        call t_startf("radclwmx")<a name='2021'></font>
         call <A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX'>radclwmx</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADCLWMX_1">(lchnk   ,ncol    ,pcols, pver, pverp ,        &amp; <a name='2022'>
                       lwupcgs ,t       ,qm1(1,1,1)       ,o3vmr ,   &amp;<a name='2023'>
                       pbr     ,pnm     ,pmln    ,piln    ,          &amp;<a name='2024'>
                       qm1(1,1,in2o)    ,qm1(1,1,ich4)    ,          &amp;<a name='2025'>
                       qm1(1,1,if11)    ,qm1(1,1,if12)    ,          &amp;<a name='2026'>
                       cld     ,emis    ,pmxrgn  ,nmxrgn  ,qrl     , &amp;<a name='2027'>
                       doabsems, abstot, absnxt, emstot,             &amp;<a name='2028'>
                       flns    ,flnt    ,flnsc   ,flntc   ,flwds   , &amp;<a name='2029'>
                       flut    ,flutc   ,                            &amp;<a name='2030'>
                       flup    ,flupc   ,fldn    ,fldnc   ,          &amp;<a name='2031'>
                       aerosol(:,:,idxVOLC))<a name='2032'>
<font color=#447700>!        call t_stopf("radclwmx")<a name='2033'></font>
      else<a name='2034'>
<font color=#447700>!ccc<a name='2035'></font>
#ifdef CLWRFGHG<a name='2036'>
         IF ( wrf_dm_on_monitor() ) THEN<a name='2037'>
           WRITE(message,*)'CLWRF-CAM_call-trcmix n2ovmr:',n2ovmr,' ch4vmr:',ch4vmr,' f11vmr:',f11vmr,' f12vmr:',f12vmr<a name='2038'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_758">(1, message)<a name='2039'>
         END IF<a name='2040'>
         call <A href='../../html_code/phys/module_ra_cam_support.F.html#TRCMIX_CLWRF'>trcmix_clwrf</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRCMIX_CLWRF_1">(lchnk   ,ncol    ,pcols, pver,  &amp;<a name='2041'>
                     pmid    ,clat, n2ovmr, ch4vmr, f11vmr, f12vmr, n2o,   &amp;<a name='2042'>
                     ch4, cfc11, cfc12 )<a name='2043'>
<a name='2044'>
#else<a name='2045'>
         call <A href='../../html_code/phys/module_ra_cam_support.F.html#TRCMIX'>trcmix</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRCMIX_1">(lchnk   ,ncol    ,pcols, pver,  &amp;<a name='2046'>
                     pmid    ,clat, n2o     ,ch4     ,                     &amp;<a name='2047'>
                     cfc11   ,cfc12   )<a name='2048'>
#endif<a name='2049'>
         IF ( wrf_dm_on_monitor() ) THEN<a name='2050'>
           WRITE(message,*)'CLWRF post_trcmix_values. n2o:', n2o(pcols/2,pver/2), ' ch4:',      &amp;<a name='2051'>
             ch4(pcols/2,pver/2),' cfc11:', cfc11(pcols/2,pver/2),' cfc12:', cfc12(pcols/2,pver/2) <a name='2052'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_759">(1, message)<a name='2053'>
         END IF <a name='2054'>
<font color=#447700>!ccc<a name='2055'></font>
<font color=#447700>!        call t_startf("radclwmx")<a name='2056'></font>
         call <A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX'>radclwmx</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCTL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADCLWMX_2">(lchnk     ,ncol    ,pcols, pver, pverp ,        &amp;<a name='2057'>
                       lwupcgs   ,t       ,qm1(1,1,1)       ,o3vmr ,   &amp;<a name='2058'>
                       pbr       ,pnm     ,pmln    ,piln    ,          &amp;<a name='2059'>
                       n2o       ,ch4     ,cfc11   ,cfc12   ,          &amp;<a name='2060'>
                       cld       ,emis    ,pmxrgn  ,nmxrgn  ,qrl     , &amp;<a name='2061'>
                       doabsems, abstot, absnxt, emstot,             &amp;<a name='2062'>
                       flns      ,flnt    ,flnsc   ,flntc   ,flwds   , &amp;<a name='2063'>
                       flut      ,flutc   ,                            &amp;<a name='2064'>
                       flup      ,flupc   ,fldn    ,fldnc   ,          &amp;<a name='2065'>
                       aerosol(:,:,idxVOLC))<a name='2066'>
<font color=#447700>!        call t_stopf("radclwmx")<a name='2067'></font>
      endif<a name='2068'>
<font color=#447700>!<a name='2069'></font>
<font color=#447700>! Convert units of longwave fields needed by rest of model from CGS to MKS<a name='2070'></font>
<font color=#447700>!<a name='2071'></font>
      do i=1,ncol<a name='2072'>
         flnt(i)  = flnt(i)*1.e-3<a name='2073'>
         flut(i)  = flut(i)*1.e-3<a name='2074'>
         flutc(i) = flutc(i)*1.e-3<a name='2075'>
         flns(i)  = flns(i)*1.e-3<a name='2076'>
         flntc(i) = flntc(i)*1.e-3<a name='2077'>
         flnsc(i) = flnsc(i)*1.e-3<a name='2078'>
         flwds(i) = flwds(i)*1.e-3<a name='2079'>
         lwcf(i)  = flutc(i) - flut(i)<a name='2080'>
      end do<a name='2081'>
<a name='2082'>
<font color=#447700>! Added upward/downward total and clear sky fluxes<a name='2083'></font>
         do k = 1, pverp<a name='2084'>
            do i = 1, ncol<a name='2085'>
            flup(i,k)  = flup(i,k)*1.e-3<a name='2086'>
            flupc(i,k) = flupc(i,k)*1.e-3<a name='2087'>
            fldn(i,k)  = fldn(i,k)*1.e-3<a name='2088'>
            fldnc(i,k) = fldnc(i,k)*1.e-3<a name='2089'>
            end do<a name='2090'>
         end do<a name='2091'>
<font color=#447700>!<a name='2092'></font>
<font color=#447700>! Dump longwave radiation information to history tape buffer (diagnostics)<a name='2093'></font>
<font color=#447700>!<a name='2094'></font>
<font color=#447700>!     call outfld('QRL     ',qrl(:ncol,:)/cpair,ncol,lchnk)<a name='2095'></font>
<font color=#447700>!     call outfld('FLNT    ',flnt  ,pcols,lchnk)<a name='2096'></font>
<font color=#447700>!     call outfld('FLUT    ',flut  ,pcols,lchnk)<a name='2097'></font>
<font color=#447700>!     call outfld('FLUTC   ',flutc ,pcols,lchnk)<a name='2098'></font>
<font color=#447700>!     call outfld('FLNTC   ',flntc ,pcols,lchnk)<a name='2099'></font>
<font color=#447700>!     call outfld('FLNS    ',flns  ,pcols,lchnk)<a name='2100'></font>
<font color=#447700>!     call outfld('FLNSC   ',flnsc ,pcols,lchnk)<a name='2101'></font>
<font color=#447700>!     call outfld('LWCF    ',lwcf  ,pcols,lchnk)<a name='2102'></font>
<font color=#447700>!     call outfld('SWCF    ',swcf  ,pcols,lchnk)<a name='2103'></font>
<font color=#447700>!<a name='2104'></font>
   end if<a name='2105'>
<font color=#447700>!<a name='2106'></font>
   return<a name='2107'>
end subroutine radctl<a name='2108'>
<A NAME='PARAM_CLDOPTICS_CALC'><A href='../../html_code/phys/module_ra_cam.F.html#PARAM_CLDOPTICS_CALC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2109'>
  <font color=#993300>subroutine </font><font color=#cc0000>param_cldoptics_calc</font>(ncol, pcols, pver, pverp, pverr, pverrp, ppcnst, &amp; <A href='../../call_to/PARAM_CLDOPTICS_CALC.html' TARGET='index'>1</A>,<A href='../../call_from/PARAM_CLDOPTICS_CALC.html' TARGET='index'>3</A><a name='2110'>
                                  q, cldn, landfrac, landm,icefrac, &amp;<a name='2111'>
        pdel,  t, ps, pmid, pint, cicewp, cliqwp, emis, rel, rei, pmxrgn, nmxrgn, snowh )<a name='2112'>
<font color=#447700>!<a name='2113'></font>
<font color=#447700>! Compute (liquid+ice) water path and cloud water/ice diagnostics<a name='2114'></font>
<font color=#447700>! *** soon this code will compute liquid and ice paths from input liquid and ice mixing ratios<a name='2115'></font>
<font color=#447700>! <a name='2116'></font>
<font color=#447700>! **** mixes interface and physics code temporarily<a name='2117'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2118'></font>
<font color=#447700>!   use physics_types, only: physics_state<a name='2119'></font>
<font color=#447700>!   use history,       only: outfld<a name='2120'></font>
<font color=#447700>!   use pkg_cldoptics, only: cldefr, cldems, cldovrlap, cldclw<a name='2121'></font>
<a name='2122'>
    implicit none<a name='2123'>
<a name='2124'>
<font color=#447700>! Arguments<a name='2125'></font>
    integer, intent(in) :: ncol, pcols, pver, pverp, pverr, pverrp, ppcnst<a name='2126'>
    real(r8), intent(in)  :: q(pcols,pver,ppcnst)     <font color=#447700>! moisture arrays<a name='2127'></font>
    real(r8), intent(in)  :: cldn(pcols,pver)        <font color=#447700>! new cloud fraction<a name='2128'></font>
    real(r8), intent(in)  :: pdel(pcols,pver)        <font color=#447700>! pressure thickness<a name='2129'></font>
    real(r8), intent(in)  :: t(pcols,pver)           <font color=#447700>! temperature<a name='2130'></font>
    real(r8), intent(in)  :: pmid(pcols,pver)        <font color=#447700>! pressure <a name='2131'></font>
    real(r8), intent(in)  :: pint(pcols,pverp)       <font color=#447700>! pressure <a name='2132'></font>
    real(r8), intent(in)  :: ps(pcols)               <font color=#447700>! surface pressure <a name='2133'></font>
    real(r8), intent(in)  :: landfrac(pcols)         <font color=#447700>! Land fraction<a name='2134'></font>
    real(r8), intent(in)  :: icefrac(pcols)          <font color=#447700>! Ice fraction<a name='2135'></font>
    real(r8), intent(in)  :: landm(pcols)            <font color=#447700>! Land fraction ramped<a name='2136'></font>
    real(r8), intent(in) :: snowh(pcols)         <font color=#447700>! Snow depth over land, water equivalent (m)<a name='2137'></font>
<a name='2138'>
<font color=#447700>!!$    real(r8), intent(out) :: cwp   (pcols,pver)      ! in-cloud cloud (total) water path<a name='2139'></font>
    real(r8), intent(out) :: cicewp(pcols,pver)      <font color=#447700>! in-cloud cloud ice water path<a name='2140'></font>
    real(r8), intent(out) :: cliqwp(pcols,pver)      <font color=#447700>! in-cloud cloud liquid water path<a name='2141'></font>
    real(r8), intent(out) :: emis  (pcols,pver)      <font color=#447700>! cloud emissivity<a name='2142'></font>
    real(r8), intent(out) :: rel   (pcols,pver)      <font color=#447700>! effective drop radius (microns)<a name='2143'></font>
    real(r8), intent(out) :: rei   (pcols,pver)      <font color=#447700>! ice effective drop size (microns)<a name='2144'></font>
    real(r8), intent(out) :: pmxrgn(pcols,pver+1)    <font color=#447700>! Maximum values of pressure for each<a name='2145'></font>
    integer , intent(out) :: nmxrgn(pcols)           <font color=#447700>! Number of maximally overlapped regions<a name='2146'></font>
<a name='2147'>
<font color=#447700>! Local variables<a name='2148'></font>
    real(r8) :: cwp   (pcols,pver)      <font color=#447700>! in-cloud cloud (total) water path<a name='2149'></font>
<font color=#447700>!!$    real(r8) :: cicewp(pcols,pver)      ! in-cloud cloud ice water path<a name='2150'></font>
<font color=#447700>!!$    real(r8) :: cliqwp(pcols,pver)      ! in-cloud cloud liquid water path<a name='2151'></font>
    real(r8) :: effcld(pcols,pver)                   <font color=#447700>! effective cloud=cld*emis<a name='2152'></font>
    real(r8) :: gicewp(pcols,pver)                   <font color=#447700>! grid-box cloud ice water path<a name='2153'></font>
    real(r8) :: gliqwp(pcols,pver)                   <font color=#447700>! grid-box cloud liquid water path<a name='2154'></font>
    real(r8) :: gwp   (pcols,pver)                   <font color=#447700>! grid-box cloud (total) water path<a name='2155'></font>
    real(r8) :: hl     (pcols)                       <font color=#447700>! Liquid water scale height<a name='2156'></font>
    real(r8) :: tgicewp(pcols)                       <font color=#447700>! Vertically integrated ice water path<a name='2157'></font>
    real(r8) :: tgliqwp(pcols)                       <font color=#447700>! Vertically integrated liquid water path<a name='2158'></font>
    real(r8) :: tgwp   (pcols)                       <font color=#447700>! Vertically integrated (total) cloud water path<a name='2159'></font>
    real(r8) :: tpw    (pcols)                       <font color=#447700>! total precipitable water<a name='2160'></font>
    real(r8) :: clwpold(pcols,pver)                  <font color=#447700>! Presribed cloud liq. h2o path<a name='2161'></font>
    real(r8) :: ficemr (pcols,pver)                  <font color=#447700>! Ice fraction from ice and liquid mixing ratios<a name='2162'></font>
<a name='2163'>
    real(r8) :: rgrav                <font color=#447700>! inverse gravitational acceleration<a name='2164'></font>
<a name='2165'>
    integer :: i,k                                   <font color=#447700>! loop indexes<a name='2166'></font>
    integer :: lchnk<a name='2167'>
<a name='2168'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2169'></font>
<a name='2170'>
<font color=#447700>! Compute liquid and ice water paths<a name='2171'></font>
    tgicewp(:ncol) = 0.<a name='2172'>
    tgliqwp(:ncol) = 0.<a name='2173'>
    do k=1,pver<a name='2174'>
       do i = 1,ncol<a name='2175'>
          gicewp(i,k) = q(i,k,ixcldice)*pdel(i,k)/gravmks*1000.0  <font color=#447700>! Grid box ice water path.<a name='2176'></font>
          gliqwp(i,k) = q(i,k,ixcldliq)*pdel(i,k)/gravmks*1000.0  <font color=#447700>! Grid box liquid water path.<a name='2177'></font>
<font color=#447700>!!$          gwp   (i,k) = gicewp(i,k) + gliqwp(i,k)<a name='2178'></font>
          cicewp(i,k) = gicewp(i,k) / max(0.01_r8,cldn(i,k))                 <font color=#447700>! In-cloud ice water path.<a name='2179'></font>
          cliqwp(i,k) = gliqwp(i,k) / max(0.01_r8,cldn(i,k))                 <font color=#447700>! In-cloud liquid water path.<a name='2180'></font>
<font color=#447700>!!$          cwp   (i,k) = gwp   (i,k) / max(0.01_r8,cldn(i,k))<a name='2181'></font>
          ficemr(i,k) = q(i,k,ixcldice) /                 &amp;<a name='2182'>
               max(1.e-10_r8,(q(i,k,ixcldice)+q(i,k,ixcldliq)))<a name='2183'>
          <a name='2184'>
          tgicewp(i)  = tgicewp(i) + gicewp(i,k)<a name='2185'>
          tgliqwp(i)  = tgliqwp(i) + gliqwp(i,k)<a name='2186'>
       end do<a name='2187'>
    end do<a name='2188'>
    tgwp(:ncol) = tgicewp(:ncol) + tgliqwp(:ncol)<a name='2189'>
    gwp(:ncol,:pver) = gicewp(:ncol,:pver) + gliqwp(:ncol,:pver) <a name='2190'>
    cwp(:ncol,:pver) = cicewp(:ncol,:pver) + cliqwp(:ncol,:pver) <a name='2191'>
<a name='2192'>
<font color=#447700>! Compute total preciptable water in column (in mm)<a name='2193'></font>
    tpw(:ncol) = 0.0<a name='2194'>
    rgrav = 1.0/gravmks<a name='2195'>
    do k=1,pver<a name='2196'>
       do i=1,ncol<a name='2197'>
          tpw(i) = tpw(i) + pdel(i,k)*q(i,k,1)*rgrav<a name='2198'>
       end do<a name='2199'>
    end do<a name='2200'>
<a name='2201'>
<font color=#447700>! Diagnostic liquid water path (old specified form)<a name='2202'></font>
<font color=#447700>!   call cldclw(lchnk, ncol, pcols, pver, pverp, state%zi, clwpold, tpw, hl)<a name='2203'></font>
<a name='2204'>
<font color=#447700>! Cloud water and ice particle sizes<a name='2205'></font>
    call <A href='../../html_code/phys/module_ra_cam_support.F.html#CLDEFR'>cldefr</A><A href='../../html_code/phys/module_ra_cam.F.html#PARAM_CLDOPTICS_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLDEFR_1">(lchnk, ncol, pcols, pver, pverp, landfrac, t, rel, rei, ps, pmid, landm, icefrac, snowh)<a name='2206'>
<a name='2207'>
<font color=#447700>! Cloud emissivity.<a name='2208'></font>
    call <A href='../../html_code/phys/module_ra_cam_support.F.html#CLDEMS'>cldems</A><A href='../../html_code/phys/module_ra_cam.F.html#PARAM_CLDOPTICS_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLDEMS_1">(lchnk, ncol, pcols, pver, pverp, cwp, ficemr, rei, emis)<a name='2209'>
<a name='2210'>
<font color=#447700>! Effective cloud cover<a name='2211'></font>
    do k=1,pver<a name='2212'>
       do i=1,ncol<a name='2213'>
          effcld(i,k) = cldn(i,k)*emis(i,k)<a name='2214'>
       end do<a name='2215'>
    end do<a name='2216'>
<a name='2217'>
<font color=#447700>! Determine parameters for maximum/random overlap<a name='2218'></font>
    call <A href='../../html_code/phys/module_ra_cam_support.F.html#CLDOVRLAP'>cldovrlap</A><A href='../../html_code/phys/module_ra_cam.F.html#PARAM_CLDOPTICS_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLDOVRLAP_1">(lchnk, ncol, pcols, pver, pverp, pint, cldn, nmxrgn, pmxrgn)<a name='2219'>
<a name='2220'>
<font color=#447700>!   call outfld('GCLDLWP' ,gwp    , pcols,lchnk)<a name='2221'></font>
<font color=#447700>!   call outfld('TGCLDCWP',tgwp   , pcols,lchnk)<a name='2222'></font>
<font color=#447700>!   call outfld('TGCLDLWP',tgliqwp, pcols,lchnk)<a name='2223'></font>
<font color=#447700>!   call outfld('TGCLDIWP',tgicewp, pcols,lchnk)<a name='2224'></font>
<font color=#447700>!   call outfld('ICLDLWP' ,cwp    , pcols,lchnk)<a name='2225'></font>
<font color=#447700>!   call outfld('SETLWP'  ,clwpold, pcols,lchnk)<a name='2226'></font>
<font color=#447700>!   call outfld('EFFCLD'  ,effcld , pcols,lchnk)<a name='2227'></font>
<font color=#447700>!   call outfld('LWSH'    ,hl     , pcols,lchnk)<a name='2228'></font>
<a name='2229'>
  end subroutine param_cldoptics_calc<a name='2230'>
<a name='2231'>
<A NAME='RADABS'><A href='../../html_code/phys/module_ra_cam.F.html#RADABS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2232'>
<font color=#993300>subroutine </font><font color=#cc0000>radabs</font>(lchnk   ,ncol    ,pcols, pver, pverp,   &amp; <A href='../../call_to/RADABS.html' TARGET='index'>1</A>,<A href='../../call_from/RADABS.html' TARGET='index'>3</A><a name='2233'>
   pbr    ,pnm     ,co2em    ,co2eml  ,tplnka  , &amp;<a name='2234'>
   s2c    ,tcg     ,w        ,h2otr   ,plco2   , &amp;<a name='2235'>
   plh2o  ,co2t    ,tint     ,tlayr   ,plol    , &amp;<a name='2236'>
   plos   ,pmln    ,piln     ,ucfc11  ,ucfc12  , &amp;<a name='2237'>
   un2o0  ,un2o1   ,uch4     ,uco211  ,uco212  , &amp;<a name='2238'>
   uco213 ,uco221  ,uco222   ,uco223  ,uptype  , &amp;<a name='2239'>
   bn2o0  ,bn2o1   ,bch4    ,abplnk1  ,abplnk2 , &amp;<a name='2240'>
   abstot ,absnxt  ,plh2ob  ,wb       , &amp;<a name='2241'>
   aer_mpp ,aer_trn_ttl)<a name='2242'>
<font color=#447700>!----------------------------------------------------------------------- <a name='2243'></font>
<font color=#447700>! <a name='2244'></font>
<font color=#447700>! Purpose: <a name='2245'></font>
<font color=#447700>! Compute absorptivities for h2o, co2, o3, ch4, n2o, cfc11 and cfc12<a name='2246'></font>
<font color=#447700>! <a name='2247'></font>
<font color=#447700>! Method: <a name='2248'></font>
<font color=#447700>! h2o  ....  Uses nonisothermal emissivity method for water vapor from<a name='2249'></font>
<font color=#447700>!            Ramanathan, V. and  P.Downey, 1986: A Nonisothermal<a name='2250'></font>
<font color=#447700>!            Emissivity and Absorptivity Formulation for Water Vapor<a name='2251'></font>
<font color=#447700>!            Journal of Geophysical Research, vol. 91., D8, pp 8649-8666<a name='2252'></font>
<font color=#447700>!<a name='2253'></font>
<font color=#447700>!            Implementation updated by Collins, Hackney, and Edwards (2001)<a name='2254'></font>
<font color=#447700>!               using line-by-line calculations based upon Hitran 1996 and<a name='2255'></font>
<font color=#447700>!               CKD 2.1 for absorptivity and emissivity<a name='2256'></font>
<font color=#447700>!<a name='2257'></font>
<font color=#447700>!            Implementation updated by Collins, Lee-Taylor, and Edwards (2003)<a name='2258'></font>
<font color=#447700>!               using line-by-line calculations based upon Hitran 2000 and<a name='2259'></font>
<font color=#447700>!               CKD 2.4 for absorptivity and emissivity<a name='2260'></font>
<font color=#447700>!<a name='2261'></font>
<font color=#447700>! co2  ....  Uses absorptance parameterization of the 15 micro-meter<a name='2262'></font>
<font color=#447700>!            (500 - 800 cm-1) band system of Carbon Dioxide, from<a name='2263'></font>
<font color=#447700>!            Kiehl, J.T. and B.P.Briegleb, 1991: A New Parameterization<a name='2264'></font>
<font color=#447700>!            of the Absorptance Due to the 15 micro-meter Band System<a name='2265'></font>
<font color=#447700>!            of Carbon Dioxide Jouranl of Geophysical Research,<a name='2266'></font>
<font color=#447700>!            vol. 96., D5, pp 9013-9019.<a name='2267'></font>
<font color=#447700>!            Parameterizations for the 9.4 and 10.4 mircon bands of CO2<a name='2268'></font>
<font color=#447700>!            are also included.<a name='2269'></font>
<font color=#447700>!<a name='2270'></font>
<font color=#447700>! o3   ....  Uses absorptance parameterization of the 9.6 micro-meter<a name='2271'></font>
<font color=#447700>!            band system of ozone, from Ramanathan, V. and R.Dickinson,<a name='2272'></font>
<font color=#447700>!            1979: The Role of stratospheric ozone in the zonal and<a name='2273'></font>
<font color=#447700>!            seasonal radiative energy balance of the earth-troposphere<a name='2274'></font>
<font color=#447700>!            system. Journal of the Atmospheric Sciences, Vol. 36,<a name='2275'></font>
<font color=#447700>!            pp 1084-1104<a name='2276'></font>
<font color=#447700>!<a name='2277'></font>
<font color=#447700>! ch4  ....  Uses a broad band model for the 7.7 micron band of methane.<a name='2278'></font>
<font color=#447700>!<a name='2279'></font>
<font color=#447700>! n20  ....  Uses a broad band model for the 7.8, 8.6 and 17.0 micron<a name='2280'></font>
<font color=#447700>!            bands of nitrous oxide<a name='2281'></font>
<font color=#447700>!<a name='2282'></font>
<font color=#447700>! cfc11 ...  Uses a quasi-linear model for the 9.2, 10.7, 11.8 and 12.5<a name='2283'></font>
<font color=#447700>!            micron bands of CFC11<a name='2284'></font>
<font color=#447700>!<a name='2285'></font>
<font color=#447700>! cfc12 ...  Uses a quasi-linear model for the 8.6, 9.1, 10.8 and 11.2<a name='2286'></font>
<font color=#447700>!            micron bands of CFC12<a name='2287'></font>
<font color=#447700>!<a name='2288'></font>
<font color=#447700>!<a name='2289'></font>
<font color=#447700>! Computes individual absorptivities for non-adjacent layers, accounting<a name='2290'></font>
<font color=#447700>! for band overlap, and sums to obtain the total; then, computes the<a name='2291'></font>
<font color=#447700>! nearest layer contribution.<a name='2292'></font>
<font color=#447700>! <a name='2293'></font>
<font color=#447700>! Author: W. Collins (H2O absorptivity) and J. Kiehl<a name='2294'></font>
<font color=#447700>! <a name='2295'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2296'></font>
<font color=#447700>!------------------------------Arguments--------------------------------<a name='2297'></font>
<font color=#447700>!<a name='2298'></font>
<font color=#447700>! Input arguments<a name='2299'></font>
<font color=#447700>!<a name='2300'></font>
   integer, intent(in) :: lchnk                       <font color=#447700>! chunk identifier<a name='2301'></font>
   integer, intent(in) :: ncol                        <font color=#447700>! number of atmospheric columns<a name='2302'></font>
   integer, intent(in) :: pcols, pver, pverp<a name='2303'>
<a name='2304'>
   real(r8), intent(in) :: pbr(pcols,pver)            <font color=#447700>! Prssr at mid-levels (dynes/cm2)<a name='2305'></font>
   real(r8), intent(in) :: pnm(pcols,pverp)           <font color=#447700>! Prssr at interfaces (dynes/cm2)<a name='2306'></font>
   real(r8), intent(in) :: co2em(pcols,pverp)         <font color=#447700>! Co2 emissivity function<a name='2307'></font>
   real(r8), intent(in) :: co2eml(pcols,pver)         <font color=#447700>! Co2 emissivity function<a name='2308'></font>
   real(r8), intent(in) :: tplnka(pcols,pverp)        <font color=#447700>! Planck fnctn level temperature<a name='2309'></font>
   real(r8), intent(in) :: s2c(pcols,pverp)           <font color=#447700>! H2o continuum path length<a name='2310'></font>
   real(r8), intent(in) :: tcg(pcols,pverp)           <font color=#447700>! H2o-mass-wgted temp. (Curtis-Godson approx.)<a name='2311'></font>
   real(r8), intent(in) :: w(pcols,pverp)             <font color=#447700>! H2o prs wghted path<a name='2312'></font>
   real(r8), intent(in) :: h2otr(pcols,pverp)         <font color=#447700>! H2o trnsmssn fnct for o3 overlap<a name='2313'></font>
   real(r8), intent(in) :: plco2(pcols,pverp)         <font color=#447700>! Co2 prs wghted path length<a name='2314'></font>
   real(r8), intent(in) :: plh2o(pcols,pverp)         <font color=#447700>! H2o prs wfhted path length<a name='2315'></font>
   real(r8), intent(in) :: co2t(pcols,pverp)          <font color=#447700>! Tmp and prs wghted path length<a name='2316'></font>
   real(r8), intent(in) :: tint(pcols,pverp)          <font color=#447700>! Interface temperatures<a name='2317'></font>
   real(r8), intent(in) :: tlayr(pcols,pverp)         <font color=#447700>! K-1 level temperatures<a name='2318'></font>
   real(r8), intent(in) :: plol(pcols,pverp)          <font color=#447700>! Ozone prs wghted path length<a name='2319'></font>
   real(r8), intent(in) :: plos(pcols,pverp)          <font color=#447700>! Ozone path length<a name='2320'></font>
   real(r8), intent(in) :: pmln(pcols,pver)           <font color=#447700>! Ln(pmidm1)<a name='2321'></font>
   real(r8), intent(in) :: piln(pcols,pverp)          <font color=#447700>! Ln(pintm1)<a name='2322'></font>
   real(r8), intent(in) :: plh2ob(nbands,pcols,pverp) <font color=#447700>! Pressure weighted h2o path with <a name='2323'></font>
                                                      <font color=#447700>!    Hulst-Curtis-Godson temp. factor <a name='2324'></font>
                                                      <font color=#447700>!    for H2O bands <a name='2325'></font>
   real(r8), intent(in) :: wb(nbands,pcols,pverp)     <font color=#447700>! H2o path length with <a name='2326'></font>
                                                      <font color=#447700>!    Hulst-Curtis-Godson temp. factor <a name='2327'></font>
                                                      <font color=#447700>!    for H2O bands <a name='2328'></font>
<a name='2329'>
   real(r8), intent(in) :: aer_mpp(pcols,pverp) <font color=#447700>! STRAER path above kth interface level<a name='2330'></font>
   real(r8), intent(in) :: aer_trn_ttl(pcols,pverp,pverp,bnd_nbr_LW) <font color=#447700>! aer trn.<a name='2331'></font>
<a name='2332'>
<a name='2333'>
<font color=#447700>!<a name='2334'></font>
<font color=#447700>! Trace gas variables<a name='2335'></font>
<font color=#447700>!<a name='2336'></font>
   real(r8), intent(in) :: ucfc11(pcols,pverp)        <font color=#447700>! CFC11 path length<a name='2337'></font>
   real(r8), intent(in) :: ucfc12(pcols,pverp)        <font color=#447700>! CFC12 path length<a name='2338'></font>
   real(r8), intent(in) :: un2o0(pcols,pverp)         <font color=#447700>! N2O path length<a name='2339'></font>
   real(r8), intent(in) :: un2o1(pcols,pverp)         <font color=#447700>! N2O path length (hot band)<a name='2340'></font>
   real(r8), intent(in) :: uch4(pcols,pverp)          <font color=#447700>! CH4 path length<a name='2341'></font>
   real(r8), intent(in) :: uco211(pcols,pverp)        <font color=#447700>! CO2 9.4 micron band path length<a name='2342'></font>
   real(r8), intent(in) :: uco212(pcols,pverp)        <font color=#447700>! CO2 9.4 micron band path length<a name='2343'></font>
   real(r8), intent(in) :: uco213(pcols,pverp)        <font color=#447700>! CO2 9.4 micron band path length<a name='2344'></font>
   real(r8), intent(in) :: uco221(pcols,pverp)        <font color=#447700>! CO2 10.4 micron band path length<a name='2345'></font>
   real(r8), intent(in) :: uco222(pcols,pverp)        <font color=#447700>! CO2 10.4 micron band path length<a name='2346'></font>
   real(r8), intent(in) :: uco223(pcols,pverp)        <font color=#447700>! CO2 10.4 micron band path length<a name='2347'></font>
   real(r8), intent(in) :: uptype(pcols,pverp)        <font color=#447700>! continuum path length<a name='2348'></font>
   real(r8), intent(in) :: bn2o0(pcols,pverp)         <font color=#447700>! pressure factor for n2o<a name='2349'></font>
   real(r8), intent(in) :: bn2o1(pcols,pverp)         <font color=#447700>! pressure factor for n2o<a name='2350'></font>
   real(r8), intent(in) :: bch4(pcols,pverp)          <font color=#447700>! pressure factor for ch4<a name='2351'></font>
   real(r8), intent(in) :: abplnk1(14,pcols,pverp)    <font color=#447700>! non-nearest layer Planck factor<a name='2352'></font>
   real(r8), intent(in) :: abplnk2(14,pcols,pverp)    <font color=#447700>! nearest layer factor<a name='2353'></font>
<font color=#447700>!<a name='2354'></font>
<font color=#447700>! Output arguments<a name='2355'></font>
<font color=#447700>!<a name='2356'></font>
   real(r8), intent(out) :: abstot(pcols,pverp,pverp) <font color=#447700>! Total absorptivity<a name='2357'></font>
   real(r8), intent(out) :: absnxt(pcols,pver,4)      <font color=#447700>! Total nearest layer absorptivity<a name='2358'></font>
<font color=#447700>!<a name='2359'></font>
<font color=#447700>!---------------------------Local variables-----------------------------<a name='2360'></font>
<font color=#447700>!<a name='2361'></font>
   integer i                   <font color=#447700>! Longitude index<a name='2362'></font>
   integer k                   <font color=#447700>! Level index<a name='2363'></font>
   integer k1                  <font color=#447700>! Level index<a name='2364'></font>
   integer k2                  <font color=#447700>! Level index<a name='2365'></font>
   integer kn                  <font color=#447700>! Nearest level index<a name='2366'></font>
   integer wvl                 <font color=#447700>! Wavelength index<a name='2367'></font>
<a name='2368'>
   real(r8) abstrc(pcols)              <font color=#447700>! total trace gas absorptivity<a name='2369'></font>
   real(r8) bplnk(14,pcols,4)          <font color=#447700>! Planck functions for sub-divided layers<a name='2370'></font>
   real(r8) pnew(pcols)        <font color=#447700>! Effective pressure for H2O vapor linewidth<a name='2371'></font>
   real(r8) pnewb(nbands)      <font color=#447700>! Effective pressure for h2o linewidth w/<a name='2372'></font>
                               <font color=#447700>!    Hulst-Curtis-Godson correction for<a name='2373'></font>
                               <font color=#447700>!    each band<a name='2374'></font>
   real(r8) u(pcols)           <font color=#447700>! Pressure weighted H2O path length<a name='2375'></font>
   real(r8) ub(nbands)         <font color=#447700>! Pressure weighted H2O path length with<a name='2376'></font>
                               <font color=#447700>!    Hulst-Curtis-Godson correction for<a name='2377'></font>
                               <font color=#447700>!    each band<a name='2378'></font>
   real(r8) tbar(pcols,4)      <font color=#447700>! Mean layer temperature<a name='2379'></font>
   real(r8) emm(pcols,4)       <font color=#447700>! Mean co2 emissivity<a name='2380'></font>
   real(r8) o3emm(pcols,4)     <font color=#447700>! Mean o3 emissivity<a name='2381'></font>
   real(r8) o3bndi             <font color=#447700>! Ozone band parameter<a name='2382'></font>
   real(r8) temh2o(pcols,4)    <font color=#447700>! Mean layer temperature equivalent to tbar<a name='2383'></font>
   real(r8) k21                <font color=#447700>! Exponential coefficient used to calculate<a name='2384'></font>
<font color=#447700>!                              !  rotation band transmissvty in the 650-800<a name='2385'></font>
<font color=#447700>!                              !  cm-1 region (tr1)<a name='2386'></font>
   real(r8) k22                <font color=#447700>! Exponential coefficient used to calculate<a name='2387'></font>
<font color=#447700>!                              !  rotation band transmissvty in the 500-650<a name='2388'></font>
<font color=#447700>!                              !  cm-1 region (tr2)<a name='2389'></font>
   real(r8) uc1(pcols)         <font color=#447700>! H2o continuum pathlength in 500-800 cm-1<a name='2390'></font>
   real(r8) to3h2o(pcols)      <font color=#447700>! H2o trnsmsn for overlap with o3<a name='2391'></font>
   real(r8) pi                 <font color=#447700>! For co2 absorptivity computation<a name='2392'></font>
   real(r8) sqti(pcols)        <font color=#447700>! Used to store sqrt of mean temperature<a name='2393'></font>
   real(r8) et                 <font color=#447700>! Co2 hot band factor<a name='2394'></font>
   real(r8) et2                <font color=#447700>! Co2 hot band factor squared<a name='2395'></font>
   real(r8) et4                <font color=#447700>! Co2 hot band factor to fourth power<a name='2396'></font>
   real(r8) omet               <font color=#447700>! Co2 stimulated emission term<a name='2397'></font>
   real(r8) f1co2              <font color=#447700>! Co2 central band factor<a name='2398'></font>
   real(r8) f2co2(pcols)       <font color=#447700>! Co2 weak band factor<a name='2399'></font>
   real(r8) f3co2(pcols)       <font color=#447700>! Co2 weak band factor<a name='2400'></font>
   real(r8) t1co2(pcols)       <font color=#447700>! Overlap factr weak bands on strong band<a name='2401'></font>
   real(r8) sqwp               <font color=#447700>! Sqrt of co2 pathlength<a name='2402'></font>
   real(r8) f1sqwp(pcols)      <font color=#447700>! Main co2 band factor<a name='2403'></font>
   real(r8) oneme              <font color=#447700>! Co2 stimulated emission term<a name='2404'></font>
   real(r8) alphat             <font color=#447700>! Part of the co2 stimulated emission term<a name='2405'></font>
   real(r8) wco2               <font color=#447700>! Constants used to define co2 pathlength<a name='2406'></font>
   real(r8) posqt              <font color=#447700>! Effective pressure for co2 line width<a name='2407'></font>
   real(r8) u7(pcols)          <font color=#447700>! Co2 hot band path length<a name='2408'></font>
   real(r8) u8                 <font color=#447700>! Co2 hot band path length<a name='2409'></font>
   real(r8) u9                 <font color=#447700>! Co2 hot band path length<a name='2410'></font>
   real(r8) u13                <font color=#447700>! Co2 hot band path length<a name='2411'></font>
   real(r8) rbeta7(pcols)      <font color=#447700>! Inverse of co2 hot band line width par<a name='2412'></font>
   real(r8) rbeta8             <font color=#447700>! Inverse of co2 hot band line width par<a name='2413'></font>
   real(r8) rbeta9             <font color=#447700>! Inverse of co2 hot band line width par<a name='2414'></font>
   real(r8) rbeta13            <font color=#447700>! Inverse of co2 hot band line width par<a name='2415'></font>
   real(r8) tpatha             <font color=#447700>! For absorptivity computation<a name='2416'></font>
   real(r8) abso(pcols,4)      <font color=#447700>! Absorptivity for various gases/bands<a name='2417'></font>
   real(r8) dtx(pcols)         <font color=#447700>! Planck temperature minus 250 K<a name='2418'></font>
   real(r8) dty(pcols)         <font color=#447700>! Path temperature minus 250 K<a name='2419'></font>
   real(r8) term7(pcols,2)     <font color=#447700>! Kl_inf(i) in eq(r8) of table A3a of R&amp;D<a name='2420'></font>
   real(r8) term8(pcols,2)     <font color=#447700>! Delta kl_inf(i) in eq(r8)<a name='2421'></font>
   real(r8) tr1                <font color=#447700>! Eqn(6) in table A2 of R&amp;D for 650-800<a name='2422'></font>
   real(r8) tr10(pcols)        <font color=#447700>! Eqn (6) times eq(4) in table A2<a name='2423'></font>
<font color=#447700>!                              !  of R&amp;D for 500-650 cm-1 region<a name='2424'></font>
   real(r8) tr2                <font color=#447700>! Eqn(6) in table A2 of R&amp;D for 500-650<a name='2425'></font>
   real(r8) tr5                <font color=#447700>! Eqn(4) in table A2 of R&amp;D for 650-800<a name='2426'></font>
   real(r8) tr6                <font color=#447700>! Eqn(4) in table A2 of R&amp;D for 500-650<a name='2427'></font>
   real(r8) tr9(pcols)         <font color=#447700>! Equation (6) times eq(4) in table A2<a name='2428'></font>
<font color=#447700>!                              !  of R&amp;D for 650-800 cm-1 region<a name='2429'></font>
   real(r8) sqrtu(pcols)       <font color=#447700>! Sqrt of pressure weighted h20 pathlength<a name='2430'></font>
   real(r8) fwk(pcols)         <font color=#447700>! Equation(33) in R&amp;D far wing correction<a name='2431'></font>
   real(r8) fwku(pcols)        <font color=#447700>! GU term in eqs(1) and (6) in table A2<a name='2432'></font>
   real(r8) to3co2(pcols)      <font color=#447700>! P weighted temp in ozone band model<a name='2433'></font>
   real(r8) dpnm(pcols)        <font color=#447700>! Pressure difference between two levels<a name='2434'></font>
   real(r8) pnmsq(pcols,pverp) <font color=#447700>! Pressure squared<a name='2435'></font>
   real(r8) dw(pcols)          <font color=#447700>! Amount of h2o between two levels<a name='2436'></font>
   real(r8) uinpl(pcols,4)     <font color=#447700>! Nearest layer subdivision factor<a name='2437'></font>
   real(r8) winpl(pcols,4)     <font color=#447700>! Nearest layer subdivision factor<a name='2438'></font>
   real(r8) zinpl(pcols,4)     <font color=#447700>! Nearest layer subdivision factor<a name='2439'></font>
   real(r8) pinpl(pcols,4)     <font color=#447700>! Nearest layer subdivision factor<a name='2440'></font>
   real(r8) dplh2o(pcols)      <font color=#447700>! Difference in press weighted h2o amount<a name='2441'></font>
   real(r8) r293               <font color=#447700>! 1/293<a name='2442'></font>
   real(r8) r250               <font color=#447700>! 1/250<a name='2443'></font>
   real(r8) r3205              <font color=#447700>! Line width factor for o3 (see R&amp;Di)<a name='2444'></font>
   real(r8) r300               <font color=#447700>! 1/300<a name='2445'></font>
   real(r8) rsslp              <font color=#447700>! Reciprocal of sea level pressure<a name='2446'></font>
   real(r8) r2sslp             <font color=#447700>! 1/2 of rsslp<a name='2447'></font>
   real(r8) ds2c               <font color=#447700>! Y in eq(7) in table A2 of R&amp;D<a name='2448'></font>
   real(r8)  dplos             <font color=#447700>! Ozone pathlength eq(A2) in R&amp;Di<a name='2449'></font>
   real(r8) dplol              <font color=#447700>! Presure weighted ozone pathlength<a name='2450'></font>
   real(r8) tlocal             <font color=#447700>! Local interface temperature<a name='2451'></font>
   real(r8) beta               <font color=#447700>! Ozone mean line parameter eq(A3) in R&amp;Di<a name='2452'></font>
<font color=#447700>!                               (includes Voigt line correction factor)<a name='2453'></font>
   real(r8) rphat              <font color=#447700>! Effective pressure for ozone beta<a name='2454'></font>
   real(r8) tcrfac             <font color=#447700>! Ozone temperature factor table 1 R&amp;Di<a name='2455'></font>
   real(r8) tmp1               <font color=#447700>! Ozone band factor see eq(A1) in R&amp;Di<a name='2456'></font>
   real(r8) u1                 <font color=#447700>! Effective ozone pathlength eq(A2) in R&amp;Di<a name='2457'></font>
   real(r8) realnu             <font color=#447700>! 1/beta factor in ozone band model eq(A1)<a name='2458'></font>
   real(r8) tmp2               <font color=#447700>! Ozone band factor see eq(A1) in R&amp;Di<a name='2459'></font>
   real(r8) u2                 <font color=#447700>! Effective ozone pathlength eq(A2) in R&amp;Di<a name='2460'></font>
   real(r8) rsqti              <font color=#447700>! Reciprocal of sqrt of path temperature<a name='2461'></font>
   real(r8) tpath              <font color=#447700>! Path temperature used in co2 band model<a name='2462'></font>
   real(r8) tmp3               <font color=#447700>! Weak band factor see K&amp;B<a name='2463'></font>
   real(r8) rdpnmsq            <font color=#447700>! Reciprocal of difference in press^2<a name='2464'></font>
   real(r8) rdpnm              <font color=#447700>! Reciprocal of difference in press<a name='2465'></font>
   real(r8) p1                 <font color=#447700>! Mean pressure factor<a name='2466'></font>
   real(r8) p2                 <font color=#447700>! Mean pressure factor<a name='2467'></font>
   real(r8) dtym10             <font color=#447700>! T - 260 used in eq(9) and (10) table A3a<a name='2468'></font>
   real(r8) dplco2             <font color=#447700>! Co2 path length<a name='2469'></font>
   real(r8) te                 <font color=#447700>! A_0 T factor in ozone model table 1 of R&amp;Di<a name='2470'></font>
   real(r8) denom              <font color=#447700>! Denominator in eq(r8) of table A3a of R&amp;D<a name='2471'></font>
   real(r8) th2o(pcols)        <font color=#447700>! transmission due to H2O<a name='2472'></font>
   real(r8) tco2(pcols)        <font color=#447700>! transmission due to CO2<a name='2473'></font>
   real(r8) to3(pcols)         <font color=#447700>! transmission due to O3<a name='2474'></font>
<font color=#447700>!<a name='2475'></font>
<font color=#447700>! Transmission terms for various spectral intervals:<a name='2476'></font>
<font color=#447700>!<a name='2477'></font>
   real(r8) trab2(pcols)       <font color=#447700>! H2o   500 -  800 cm-1<a name='2478'></font>
   real(r8) absbnd             <font color=#447700>! Proportional to co2 band absorptance<a name='2479'></font>
   real(r8) dbvtit(pcols,pverp)<font color=#447700>! Intrfc drvtv plnck fnctn for o3<a name='2480'></font>
   real(r8) dbvtly(pcols,pver) <font color=#447700>! Level drvtv plnck fnctn for o3<a name='2481'></font>
<font color=#447700>!<a name='2482'></font>
<font color=#447700>! Variables for Collins/Hackney/Edwards (C/H/E) &amp; <a name='2483'></font>
<font color=#447700>!       Collins/Lee-Taylor/Edwards (C/LT/E) H2O parameterization<a name='2484'></font>
<a name='2485'>
<font color=#447700>!<a name='2486'></font>
<font color=#447700>! Notation:<a name='2487'></font>
<font color=#447700>! U   = integral (P/P_0 dW)  eq. 15 in Ramanathan/Downey 1986<a name='2488'></font>
<font color=#447700>! P   = atmospheric pressure<a name='2489'></font>
<font color=#447700>! P_0 = reference atmospheric pressure<a name='2490'></font>
<font color=#447700>! W   = precipitable water path<a name='2491'></font>
<font color=#447700>! T_e = emission temperature<a name='2492'></font>
<font color=#447700>! T_p = path temperature<a name='2493'></font>
<font color=#447700>! RH  = path relative humidity<a name='2494'></font>
<font color=#447700>!<a name='2495'></font>
   real(r8) fa               <font color=#447700>! asymptotic value of abs. as U-&gt;infinity<a name='2496'></font>
   real(r8) a_star           <font color=#447700>! normalized absorptivity for non-window<a name='2497'></font>
   real(r8) l_star           <font color=#447700>! interpolated line transmission<a name='2498'></font>
   real(r8) c_star           <font color=#447700>! interpolated continuum transmission<a name='2499'></font>
<a name='2500'>
   real(r8) te1              <font color=#447700>! emission temperature<a name='2501'></font>
   real(r8) te2              <font color=#447700>! te^2<a name='2502'></font>
   real(r8) te3              <font color=#447700>! te^3<a name='2503'></font>
   real(r8) te4              <font color=#447700>! te^4<a name='2504'></font>
   real(r8) te5              <font color=#447700>! te^5<a name='2505'></font>
<a name='2506'>
   real(r8) log_u            <font color=#447700>! log base 10 of U <a name='2507'></font>
   real(r8) log_uc           <font color=#447700>! log base 10 of H2O continuum path<a name='2508'></font>
   real(r8) log_p            <font color=#447700>! log base 10 of P<a name='2509'></font>
   real(r8) t_p              <font color=#447700>! T_p<a name='2510'></font>
   real(r8) t_e              <font color=#447700>! T_e (offset by T_p)<a name='2511'></font>
<a name='2512'>
   integer iu                <font color=#447700>! index for log10(U)<a name='2513'></font>
   integer iu1               <font color=#447700>! iu + 1<a name='2514'></font>
   integer iuc               <font color=#447700>! index for log10(H2O continuum path)<a name='2515'></font>
   integer iuc1              <font color=#447700>! iuc + 1<a name='2516'></font>
   integer ip                <font color=#447700>! index for log10(P)<a name='2517'></font>
   integer ip1               <font color=#447700>! ip + 1<a name='2518'></font>
   integer itp               <font color=#447700>! index for T_p<a name='2519'></font>
   integer itp1              <font color=#447700>! itp + 1<a name='2520'></font>
   integer ite               <font color=#447700>! index for T_e<a name='2521'></font>
   integer ite1              <font color=#447700>! ite + 1<a name='2522'></font>
   integer irh               <font color=#447700>! index for RH<a name='2523'></font>
   integer irh1              <font color=#447700>! irh + 1<a name='2524'></font>
<a name='2525'>
   real(r8) dvar             <font color=#447700>! normalized variation in T_p/T_e/P/U<a name='2526'></font>
   real(r8) uvar             <font color=#447700>! U * diffusivity factor<a name='2527'></font>
   real(r8) uscl             <font color=#447700>! factor for lineary scaling as U-&gt;0<a name='2528'></font>
<a name='2529'>
   real(r8) wu               <font color=#447700>! weight for U<a name='2530'></font>
   real(r8) wu1              <font color=#447700>! 1 - wu<a name='2531'></font>
   real(r8) wuc              <font color=#447700>! weight for H2O continuum path<a name='2532'></font>
   real(r8) wuc1             <font color=#447700>! 1 - wuc<a name='2533'></font>
   real(r8) wp               <font color=#447700>! weight for P<a name='2534'></font>
   real(r8) wp1              <font color=#447700>! 1 - wp<a name='2535'></font>
   real(r8) wtp              <font color=#447700>! weight for T_p<a name='2536'></font>
   real(r8) wtp1             <font color=#447700>! 1 - wtp<a name='2537'></font>
   real(r8) wte              <font color=#447700>! weight for T_e<a name='2538'></font>
   real(r8) wte1             <font color=#447700>! 1 - wte<a name='2539'></font>
   real(r8) wrh              <font color=#447700>! weight for RH<a name='2540'></font>
   real(r8) wrh1             <font color=#447700>! 1 - wrh<a name='2541'></font>
<a name='2542'>
   real(r8) w_0_0_           <font color=#447700>! weight for Tp/Te combination<a name='2543'></font>
   real(r8) w_0_1_           <font color=#447700>! weight for Tp/Te combination<a name='2544'></font>
   real(r8) w_1_0_           <font color=#447700>! weight for Tp/Te combination<a name='2545'></font>
   real(r8) w_1_1_           <font color=#447700>! weight for Tp/Te combination<a name='2546'></font>
<a name='2547'>
   real(r8) w_0_00           <font color=#447700>! weight for Tp/Te/RH combination<a name='2548'></font>
   real(r8) w_0_01           <font color=#447700>! weight for Tp/Te/RH combination<a name='2549'></font>
   real(r8) w_0_10           <font color=#447700>! weight for Tp/Te/RH combination<a name='2550'></font>
   real(r8) w_0_11           <font color=#447700>! weight for Tp/Te/RH combination<a name='2551'></font>
   real(r8) w_1_00           <font color=#447700>! weight for Tp/Te/RH combination<a name='2552'></font>
   real(r8) w_1_01           <font color=#447700>! weight for Tp/Te/RH combination<a name='2553'></font>
   real(r8) w_1_10           <font color=#447700>! weight for Tp/Te/RH combination<a name='2554'></font>
   real(r8) w_1_11           <font color=#447700>! weight for Tp/Te/RH combination<a name='2555'></font>
<a name='2556'>
   real(r8) w00_00           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2557'></font>
   real(r8) w00_01           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2558'></font>
   real(r8) w00_10           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2559'></font>
   real(r8) w00_11           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2560'></font>
   real(r8) w01_00           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2561'></font>
   real(r8) w01_01           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2562'></font>
   real(r8) w01_10           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2563'></font>
   real(r8) w01_11           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2564'></font>
   real(r8) w10_00           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2565'></font>
   real(r8) w10_01           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2566'></font>
   real(r8) w10_10           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2567'></font>
   real(r8) w10_11           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2568'></font>
   real(r8) w11_00           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2569'></font>
   real(r8) w11_01           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2570'></font>
   real(r8) w11_10           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2571'></font>
   real(r8) w11_11           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='2572'></font>
<a name='2573'>
   integer ib                <font color=#447700>! spectral interval:<a name='2574'></font>
                             <font color=#447700>!   1 = 0-800 cm^-1 and 1200-2200 cm^-1<a name='2575'></font>
                             <font color=#447700>!   2 = 800-1200 cm^-1<a name='2576'></font>
<a name='2577'>
<a name='2578'>
   real(r8) pch2o            <font color=#447700>! H2O continuum path<a name='2579'></font>
   real(r8) fch2o            <font color=#447700>! temp. factor for continuum<a name='2580'></font>
   real(r8) uch2o            <font color=#447700>! U corresponding to H2O cont. path (window)<a name='2581'></font>
<a name='2582'>
   real(r8) fdif             <font color=#447700>! secant(zenith angle) for diffusivity approx.<a name='2583'></font>
<a name='2584'>
   real(r8) sslp_mks         <font color=#447700>! Sea-level pressure in MKS units<a name='2585'></font>
   real(r8) esx              <font color=#447700>! saturation vapor pressure returned by vqsatd<a name='2586'></font>
   real(r8) qsx              <font color=#447700>! saturation mixing ratio returned by vqsatd<a name='2587'></font>
   real(r8) pnew_mks         <font color=#447700>! pnew in MKS units<a name='2588'></font>
   real(r8) q_path           <font color=#447700>! effective specific humidity along path<a name='2589'></font>
   real(r8) rh_path          <font color=#447700>! effective relative humidity along path<a name='2590'></font>
   real(r8) omeps            <font color=#447700>! 1 - epsilo<a name='2591'></font>
<a name='2592'>
   integer  iest             <font color=#447700>! index in estblh2o<a name='2593'></font>
<a name='2594'>
      integer bnd_idx        <font color=#447700>! LW band index<a name='2595'></font>
      real(r8) aer_pth_dlt   <font color=#447700>! [kg m-2] STRAER path between interface levels k1 and k2<a name='2596'></font>
      real(r8) aer_pth_ngh(pcols)<a name='2597'>
                             <font color=#447700>! [kg m-2] STRAER path between neighboring layers<a name='2598'></font>
      real(r8) odap_aer_ttl  <font color=#447700>! [fraction] Total path absorption optical depth<a name='2599'></font>
      real(r8) aer_trn_ngh(pcols,bnd_nbr_LW) <a name='2600'>
                             <font color=#447700>! [fraction] Total transmission between <a name='2601'></font>
                             <font color=#447700>!            nearest neighbor sub-levels<a name='2602'></font>
<font color=#447700>!<a name='2603'></font>
<font color=#447700>!--------------------------Statement function---------------------------<a name='2604'></font>
<font color=#447700>!<a name='2605'></font>
   real(r8) dbvt,t             <font color=#447700>! Planck fnctn tmp derivative for o3<a name='2606'></font>
<font color=#447700>!<a name='2607'></font>
   dbvt(t)=(-2.8911366682e-4+(2.3771251896e-6+1.1305188929e-10*t)*t)/ &amp;<a name='2608'>
      (1.0+(-6.1364820707e-3+1.5550319767e-5*t)*t)<a name='2609'>
<font color=#447700>!<a name='2610'></font>
<font color=#447700>!<a name='2611'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2612'></font>
<font color=#447700>!<a name='2613'></font>
<font color=#447700>! Initialize<a name='2614'></font>
<font color=#447700>!<a name='2615'></font>
   do k2=1,ntoplw-1<a name='2616'>
      do k1=1,ntoplw-1<a name='2617'>
         abstot(:,k1,k2) = inf    <font color=#447700>! set unused portions for lf95 restart write<a name='2618'></font>
      end do<a name='2619'>
   end do<a name='2620'>
   do k2=1,4<a name='2621'>
      do k1=1,ntoplw-1<a name='2622'>
         absnxt(:,k1,k2) = inf    <font color=#447700>! set unused portions for lf95 restart write<a name='2623'></font>
      end do<a name='2624'>
   end do<a name='2625'>
<a name='2626'>
   do k=ntoplw,pverp<a name='2627'>
      abstot(:,k,k) = inf         <font color=#447700>! set unused portions for lf95 restart write<a name='2628'></font>
   end do<a name='2629'>
<a name='2630'>
   do k=ntoplw,pver<a name='2631'>
      do i=1,ncol<a name='2632'>
         dbvtly(i,k) = dbvt(tlayr(i,k+1))<a name='2633'>
         dbvtit(i,k) = dbvt(tint(i,k))<a name='2634'>
      end do<a name='2635'>
   end do<a name='2636'>
   do i=1,ncol<a name='2637'>
      dbvtit(i,pverp) = dbvt(tint(i,pverp))<a name='2638'>
   end do<a name='2639'>
<font color=#447700>!<a name='2640'></font>
   r293    = 1./293.<a name='2641'>
   r250    = 1./250.<a name='2642'>
   r3205   = 1./.3205<a name='2643'>
   r300    = 1./300.<a name='2644'>
   rsslp   = 1./sslp<a name='2645'>
   r2sslp  = 1./(2.*sslp)<a name='2646'>
<font color=#447700>!<a name='2647'></font>
<font color=#447700>!Constants for computing U corresponding to H2O cont. path<a name='2648'></font>
<font color=#447700>!<a name='2649'></font>
   fdif       = 1.66<a name='2650'>
   sslp_mks   = sslp / 10.0<a name='2651'>
   omeps      = 1.0 - epsilo<a name='2652'>
<font color=#447700>!<a name='2653'></font>
<font color=#447700>! Non-adjacent layer absorptivity:<a name='2654'></font>
<font color=#447700>!<a name='2655'></font>
<font color=#447700>! abso(i,1)     0 -  800 cm-1   h2o rotation band<a name='2656'></font>
<font color=#447700>! abso(i,1)  1200 - 2200 cm-1   h2o vibration-rotation band<a name='2657'></font>
<font color=#447700>! abso(i,2)   800 - 1200 cm-1   h2o window<a name='2658'></font>
<font color=#447700>!<a name='2659'></font>
<font color=#447700>! Separation between rotation and vibration-rotation dropped, so<a name='2660'></font>
<font color=#447700>!                only 2 slots needed for H2O absorptivity<a name='2661'></font>
<font color=#447700>!<a name='2662'></font>
<font color=#447700>! 500-800 cm^-1 H2o continuum/line overlap already included<a name='2663'></font>
<font color=#447700>!                in abso(i,1).  This used to be in abso(i,4)<a name='2664'></font>
<font color=#447700>!<a name='2665'></font>
<font color=#447700>! abso(i,3)   o3  9.6 micrometer band (nu3 and nu1 bands)<a name='2666'></font>
<font color=#447700>! abso(i,4)   co2 15  micrometer band system<a name='2667'></font>
<font color=#447700>!<a name='2668'></font>
   do k=ntoplw,pverp<a name='2669'>
      do i=1,ncol<a name='2670'>
         pnmsq(i,k) = pnm(i,k)**2<a name='2671'>
         dtx(i) = tplnka(i,k) - 250.<a name='2672'>
      end do<a name='2673'>
   end do<a name='2674'>
<font color=#447700>!<a name='2675'></font>
<font color=#447700>! Non-nearest layer level loops<a name='2676'></font>
<font color=#447700>!<a name='2677'></font>
   do k1=pverp,ntoplw,-1<a name='2678'>
      do k2=pverp,ntoplw,-1<a name='2679'>
         if (k1 == k2) cycle<a name='2680'>
         do i=1,ncol<a name='2681'>
            dplh2o(i) = plh2o(i,k1) - plh2o(i,k2)<a name='2682'>
            u(i)      = abs(dplh2o(i))<a name='2683'>
            sqrtu(i)  = sqrt(u(i))<a name='2684'>
            ds2c      = abs(s2c(i,k1) - s2c(i,k2))<a name='2685'>
            dw(i)     = abs(w(i,k1) - w(i,k2))<a name='2686'>
            uc1(i)    = (ds2c + 1.7e-3*u(i))*(1. +  2.*ds2c)/(1. + 15.*ds2c)<a name='2687'>
            pch2o     = ds2c<a name='2688'>
            pnew(i)   = u(i)/dw(i)<a name='2689'>
            pnew_mks  = pnew(i) * sslp_mks<a name='2690'>
<font color=#447700>!<a name='2691'></font>
<font color=#447700>! Changed effective path temperature to std. Curtis-Godson form<a name='2692'></font>
<font color=#447700>!<a name='2693'></font>
            tpatha = abs(tcg(i,k1) - tcg(i,k2))/dw(i)<a name='2694'>
            t_p = min(max(tpatha, min_tp_h2o), max_tp_h2o)<a name='2695'>
            iest = floor(t_p) - min_tp_h2o<a name='2696'>
            esx = estblh2o(iest) + (estblh2o(iest+1)-estblh2o(iest)) * &amp;<a name='2697'>
                 (t_p - min_tp_h2o - iest)<a name='2698'>
            qsx = epsilo * esx / (pnew_mks - omeps * esx)<a name='2699'>
<font color=#447700>!<a name='2700'></font>
<font color=#447700>! Compute effective RH along path<a name='2701'></font>
<font color=#447700>!<a name='2702'></font>
            q_path = dw(i) / abs(pnm(i,k1) - pnm(i,k2)) / rga<a name='2703'>
<font color=#447700>!<a name='2704'></font>
<font color=#447700>! Calculate effective u, pnew for each band using<a name='2705'></font>
<font color=#447700>!        Hulst-Curtis-Godson approximation:<a name='2706'></font>
<font color=#447700>! Formulae: Goody and Yung, Atmospheric Radiation: Theoretical Basis, <a name='2707'></font>
<font color=#447700>!           2nd edition, Oxford University Press, 1989.<a name='2708'></font>
<font color=#447700>! Effective H2O path (w)<a name='2709'></font>
<font color=#447700>!      eq. 6.24, p. 228<a name='2710'></font>
<font color=#447700>! Effective H2O path pressure (pnew = u/w):<a name='2711'></font>
<font color=#447700>!      eq. 6.29, p. 228<a name='2712'></font>
<font color=#447700>!<a name='2713'></font>
            ub(1) = abs(plh2ob(1,i,k1) - plh2ob(1,i,k2)) / psi(t_p,1)<a name='2714'>
            ub(2) = abs(plh2ob(2,i,k1) - plh2ob(2,i,k2)) / psi(t_p,2)<a name='2715'>
            <a name='2716'>
            pnewb(1) = ub(1) / abs(wb(1,i,k1) - wb(1,i,k2)) * phi(t_p,1)<a name='2717'>
            pnewb(2) = ub(2) / abs(wb(2,i,k1) - wb(2,i,k2)) * phi(t_p,2)<a name='2718'>
<a name='2719'>
            dtx(i)      = tplnka(i,k2) - 250.<a name='2720'>
            dty(i)      = tpatha       - 250.<a name='2721'>
<a name='2722'>
            fwk(i)  = fwcoef + fwc1/(1. + fwc2*u(i))<a name='2723'>
            fwku(i) = fwk(i)*u(i)<a name='2724'>
<font color=#447700>!<a name='2725'></font>
<font color=#447700>! Define variables for C/H/E (now C/LT/E) fit<a name='2726'></font>
<font color=#447700>!<a name='2727'></font>
<font color=#447700>! abso(i,1)     0 -  800 cm-1   h2o rotation band<a name='2728'></font>
<font color=#447700>! abso(i,1)  1200 - 2200 cm-1   h2o vibration-rotation band<a name='2729'></font>
<font color=#447700>! abso(i,2)   800 - 1200 cm-1   h2o window<a name='2730'></font>
<font color=#447700>!<a name='2731'></font>
<font color=#447700>! Separation between rotation and vibration-rotation dropped, so<a name='2732'></font>
<font color=#447700>!                only 2 slots needed for H2O absorptivity<a name='2733'></font>
<font color=#447700>!<a name='2734'></font>
<font color=#447700>! Notation:<a name='2735'></font>
<font color=#447700>! U   = integral (P/P_0 dW)  <a name='2736'></font>
<font color=#447700>! P   = atmospheric pressure<a name='2737'></font>
<font color=#447700>! P_0 = reference atmospheric pressure<a name='2738'></font>
<font color=#447700>! W   = precipitable water path<a name='2739'></font>
<font color=#447700>! T_e = emission temperature<a name='2740'></font>
<font color=#447700>! T_p = path temperature<a name='2741'></font>
<font color=#447700>! RH  = path relative humidity<a name='2742'></font>
<font color=#447700>!<a name='2743'></font>
<font color=#447700>!<a name='2744'></font>
<font color=#447700>! Terms for asymptotic value of emissivity<a name='2745'></font>
<font color=#447700>!<a name='2746'></font>
            te1  = tplnka(i,k2)<a name='2747'>
            te2  = te1 * te1<a name='2748'>
            te3  = te2 * te1<a name='2749'>
            te4  = te3 * te1<a name='2750'>
            te5  = te4 * te1<a name='2751'>
<a name='2752'>
<font color=#447700>!<a name='2753'></font>
<font color=#447700>!  Band-independent indices for lines and continuum tables<a name='2754'></font>
<font color=#447700>!<a name='2755'></font>
            dvar = (t_p - min_tp_h2o) / dtp_h2o<a name='2756'>
            itp = min(max(int(aint(dvar,r8)) + 1, 1), n_tp - 1)<a name='2757'>
            itp1 = itp + 1<a name='2758'>
            wtp = dvar - floor(dvar)<a name='2759'>
            wtp1 = 1.0 - wtp<a name='2760'>
            <a name='2761'>
            t_e = min(max(tplnka(i,k2)-t_p, min_te_h2o), max_te_h2o)<a name='2762'>
            dvar = (t_e - min_te_h2o) / dte_h2o<a name='2763'>
            ite = min(max(int(aint(dvar,r8)) + 1, 1), n_te - 1)<a name='2764'>
            ite1 = ite + 1<a name='2765'>
            wte = dvar - floor(dvar)<a name='2766'>
            wte1 = 1.0 - wte<a name='2767'>
            <a name='2768'>
            rh_path = min(max(q_path / qsx, min_rh_h2o), max_rh_h2o)<a name='2769'>
            dvar = (rh_path - min_rh_h2o) / drh_h2o<a name='2770'>
            irh = min(max(int(aint(dvar,r8)) + 1, 1), n_rh - 1)<a name='2771'>
            irh1 = irh + 1<a name='2772'>
            wrh = dvar - floor(dvar)<a name='2773'>
            wrh1 = 1.0 - wrh<a name='2774'>
<a name='2775'>
            w_0_0_ = wtp  * wte<a name='2776'>
            w_0_1_ = wtp  * wte1<a name='2777'>
            w_1_0_ = wtp1 * wte <a name='2778'>
            w_1_1_ = wtp1 * wte1<a name='2779'>
            <a name='2780'>
            w_0_00 = w_0_0_ * wrh<a name='2781'>
            w_0_01 = w_0_0_ * wrh1<a name='2782'>
            w_0_10 = w_0_1_ * wrh<a name='2783'>
            w_0_11 = w_0_1_ * wrh1<a name='2784'>
            w_1_00 = w_1_0_ * wrh<a name='2785'>
            w_1_01 = w_1_0_ * wrh1<a name='2786'>
            w_1_10 = w_1_1_ * wrh<a name='2787'>
            w_1_11 = w_1_1_ * wrh1<a name='2788'>
<a name='2789'>
<font color=#447700>!<a name='2790'></font>
<font color=#447700>! H2O Continuum path for 0-800 and 1200-2200 cm^-1<a name='2791'></font>
<font color=#447700>!<a name='2792'></font>
<font color=#447700>!    Assume foreign continuum dominates total H2O continuum in these bands<a name='2793'></font>
<font color=#447700>!    per Clough et al, JGR, v. 97, no. D14 (Oct 20, 1992), p. 15776<a name='2794'></font>
<font color=#447700>!    Then the effective H2O path is just <a name='2795'></font>
<font color=#447700>!         U_c = integral[ f(P) dW ]<a name='2796'></font>
<font color=#447700>!    where <a name='2797'></font>
<font color=#447700>!           W = water-vapor mass and <a name='2798'></font>
<font color=#447700>!        f(P) = dependence of foreign continuum on pressure <a name='2799'></font>
<font color=#447700>!             = P / sslp<a name='2800'></font>
<font color=#447700>!    Then <a name='2801'></font>
<font color=#447700>!         U_c = U (the same effective H2O path as for lines)<a name='2802'></font>
<font color=#447700>!<a name='2803'></font>
<font color=#447700>!<a name='2804'></font>
<font color=#447700>! Continuum terms for 800-1200 cm^-1<a name='2805'></font>
<font color=#447700>!<a name='2806'></font>
<font color=#447700>!    Assume self continuum dominates total H2O continuum for this band<a name='2807'></font>
<font color=#447700>!    per Clough et al, JGR, v. 97, no. D14 (Oct 20, 1992), p. 15776<a name='2808'></font>
<font color=#447700>!    Then the effective H2O self-continuum path is <a name='2809'></font>
<font color=#447700>!         U_c = integral[ h(e,T) dW ]                        (*eq. 1*)<a name='2810'></font>
<font color=#447700>!    where <a name='2811'></font>
<font color=#447700>!           W = water-vapor mass and <a name='2812'></font>
<font color=#447700>!           e = partial pressure of H2O along path<a name='2813'></font>
<font color=#447700>!           T = temperature along path<a name='2814'></font>
<font color=#447700>!      h(e,T) = dependence of foreign continuum on e,T<a name='2815'></font>
<font color=#447700>!             = e / sslp * f(T)<a name='2816'></font>
<font color=#447700>!<a name='2817'></font>
<font color=#447700>!    Replacing<a name='2818'></font>
<font color=#447700>!           e =~ q * P / epsilo<a name='2819'></font>
<font color=#447700>!           q = mixing ratio of H2O<a name='2820'></font>
<font color=#447700>!     epsilo = 0.622<a name='2821'></font>
<font color=#447700>!<a name='2822'></font>
<font color=#447700>!    and using the definition<a name='2823'></font>
<font color=#447700>!           U = integral [ (P / sslp) dW ]<a name='2824'></font>
<font color=#447700>!             = (P / sslp) W                                 (homogeneous path)<a name='2825'></font>
<font color=#447700>!<a name='2826'></font>
<font color=#447700>!    the effective path length for the self continuum is<a name='2827'></font>
<font color=#447700>!         U_c = (q / epsilo) f(T) U                         (*eq. 2*)<a name='2828'></font>
<font color=#447700>!<a name='2829'></font>
<font color=#447700>!    Once values of T, U, and q have been calculated for the inhomogeneous<a name='2830'></font>
<font color=#447700>!        path, this sets U_c for the corresponding<a name='2831'></font>
<font color=#447700>!        homogeneous atmosphere.  However, this need not equal the<a name='2832'></font>
<font color=#447700>!        value of U_c' defined by eq. 1 for the actual inhomogeneous atmosphere<a name='2833'></font>
<font color=#447700>!        under consideration.<a name='2834'></font>
<font color=#447700>!<a name='2835'></font>
<font color=#447700>!    Solution: hold T and q constant, solve for U' that gives U_c' by<a name='2836'></font>
<font color=#447700>!        inverting eq. (2):<a name='2837'></font>
<font color=#447700>!<a name='2838'></font>
<font color=#447700>!        U' = (U_c * epsilo) / (q * f(T))<a name='2839'></font>
<font color=#447700>!<a name='2840'></font>
            fch2o = <A href='../../html_code/phys/module_ra_cam_support.F.html#FH2OSELF'>fh2oself</A><A href='../../html_code/phys/module_ra_cam.F.html#RADABS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FH2OSELF_1">(t_p) <a name='2841'>
            uch2o = (pch2o * epsilo) / (q_path * fch2o)<a name='2842'>
<a name='2843'>
<font color=#447700>!<a name='2844'></font>
<font color=#447700>! Band-dependent indices for non-window<a name='2845'></font>
<font color=#447700>!<a name='2846'></font>
            ib = 1<a name='2847'>
<a name='2848'>
            uvar = ub(ib) * fdif<a name='2849'>
            log_u  = min(log10(max(uvar, min_u_h2o)), max_lu_h2o)<a name='2850'>
            dvar = (log_u - min_lu_h2o) / dlu_h2o<a name='2851'>
            iu = min(max(int(aint(dvar,r8)) + 1, 1), n_u - 1)<a name='2852'>
            iu1 = iu + 1<a name='2853'>
            wu = dvar - floor(dvar)<a name='2854'>
            wu1 = 1.0 - wu<a name='2855'>
            <a name='2856'>
            log_p  = min(log10(max(pnewb(ib), min_p_h2o)), max_lp_h2o)<a name='2857'>
            dvar = (log_p - min_lp_h2o) / dlp_h2o<a name='2858'>
            ip = min(max(int(aint(dvar,r8)) + 1, 1), n_p - 1)<a name='2859'>
            ip1 = ip + 1<a name='2860'>
            wp = dvar - floor(dvar)<a name='2861'>
            wp1 = 1.0 - wp<a name='2862'>
         <a name='2863'>
            w00_00 = wp  * w_0_00 <a name='2864'>
            w00_01 = wp  * w_0_01 <a name='2865'>
            w00_10 = wp  * w_0_10 <a name='2866'>
            w00_11 = wp  * w_0_11 <a name='2867'>
            w01_00 = wp  * w_1_00 <a name='2868'>
            w01_01 = wp  * w_1_01 <a name='2869'>
            w01_10 = wp  * w_1_10 <a name='2870'>
            w01_11 = wp  * w_1_11 <a name='2871'>
            w10_00 = wp1 * w_0_00 <a name='2872'>
            w10_01 = wp1 * w_0_01 <a name='2873'>
            w10_10 = wp1 * w_0_10 <a name='2874'>
            w10_11 = wp1 * w_0_11 <a name='2875'>
            w11_00 = wp1 * w_1_00 <a name='2876'>
            w11_01 = wp1 * w_1_01 <a name='2877'>
            w11_10 = wp1 * w_1_10 <a name='2878'>
            w11_11 = wp1 * w_1_11 <a name='2879'>
<font color=#447700>!<a name='2880'></font>
<font color=#447700>! Asymptotic value of absorptivity as U-&gt;infinity<a name='2881'></font>
<font color=#447700>!<a name='2882'></font>
            fa = fat(1,ib) + &amp;<a name='2883'>
                 fat(2,ib) * te1 + &amp;<a name='2884'>
                 fat(3,ib) * te2 + &amp;<a name='2885'>
                 fat(4,ib) * te3 + &amp;<a name='2886'>
                 fat(5,ib) * te4 + &amp;<a name='2887'>
                 fat(6,ib) * te5<a name='2888'>
<a name='2889'>
            a_star = &amp;<a name='2890'>
                 ah2onw(ip , itp , iu , ite , irh ) * w11_11 * wu1 + &amp;<a name='2891'>
                 ah2onw(ip , itp , iu , ite , irh1) * w11_10 * wu1 + &amp;<a name='2892'>
                 ah2onw(ip , itp , iu , ite1, irh ) * w11_01 * wu1 + &amp;<a name='2893'>
                 ah2onw(ip , itp , iu , ite1, irh1) * w11_00 * wu1 + &amp;<a name='2894'>
                 ah2onw(ip , itp , iu1, ite , irh ) * w11_11 * wu  + &amp;<a name='2895'>
                 ah2onw(ip , itp , iu1, ite , irh1) * w11_10 * wu  + &amp;<a name='2896'>
                 ah2onw(ip , itp , iu1, ite1, irh ) * w11_01 * wu  + &amp;<a name='2897'>
                 ah2onw(ip , itp , iu1, ite1, irh1) * w11_00 * wu  + &amp;<a name='2898'>
                 ah2onw(ip , itp1, iu , ite , irh ) * w10_11 * wu1 + &amp;<a name='2899'>
                 ah2onw(ip , itp1, iu , ite , irh1) * w10_10 * wu1 + &amp;<a name='2900'>
                 ah2onw(ip , itp1, iu , ite1, irh ) * w10_01 * wu1 + &amp;<a name='2901'>
                 ah2onw(ip , itp1, iu , ite1, irh1) * w10_00 * wu1 + &amp;<a name='2902'>
                 ah2onw(ip , itp1, iu1, ite , irh ) * w10_11 * wu  + &amp;<a name='2903'>
                 ah2onw(ip , itp1, iu1, ite , irh1) * w10_10 * wu  + &amp;<a name='2904'>
                 ah2onw(ip , itp1, iu1, ite1, irh ) * w10_01 * wu  + &amp;<a name='2905'>
                 ah2onw(ip , itp1, iu1, ite1, irh1) * w10_00 * wu  + &amp;<a name='2906'>
                 ah2onw(ip1, itp , iu , ite , irh ) * w01_11 * wu1 + &amp;<a name='2907'>
                 ah2onw(ip1, itp , iu , ite , irh1) * w01_10 * wu1 + &amp;<a name='2908'>
                 ah2onw(ip1, itp , iu , ite1, irh ) * w01_01 * wu1 + &amp;<a name='2909'>
                 ah2onw(ip1, itp , iu , ite1, irh1) * w01_00 * wu1 + &amp;<a name='2910'>
                 ah2onw(ip1, itp , iu1, ite , irh ) * w01_11 * wu  + &amp;<a name='2911'>
                 ah2onw(ip1, itp , iu1, ite , irh1) * w01_10 * wu  + &amp;<a name='2912'>
                 ah2onw(ip1, itp , iu1, ite1, irh ) * w01_01 * wu  + &amp;<a name='2913'>
                 ah2onw(ip1, itp , iu1, ite1, irh1) * w01_00 * wu  + &amp;<a name='2914'>
                 ah2onw(ip1, itp1, iu , ite , irh ) * w00_11 * wu1 + &amp;<a name='2915'>
                 ah2onw(ip1, itp1, iu , ite , irh1) * w00_10 * wu1 + &amp;<a name='2916'>
                 ah2onw(ip1, itp1, iu , ite1, irh ) * w00_01 * wu1 + &amp;<a name='2917'>
                 ah2onw(ip1, itp1, iu , ite1, irh1) * w00_00 * wu1 + &amp;<a name='2918'>
                 ah2onw(ip1, itp1, iu1, ite , irh ) * w00_11 * wu  + &amp;<a name='2919'>
                 ah2onw(ip1, itp1, iu1, ite , irh1) * w00_10 * wu  + &amp;<a name='2920'>
                 ah2onw(ip1, itp1, iu1, ite1, irh ) * w00_01 * wu  + &amp;<a name='2921'>
                 ah2onw(ip1, itp1, iu1, ite1, irh1) * w00_00 * wu <a name='2922'>
            abso(i,ib) = min(max(fa * (1.0 - (1.0 - a_star) * &amp;<a name='2923'>
                                 aer_trn_ttl(i,k1,k2,ib)), &amp;<a name='2924'>
                             0.0_r8), 1.0_r8)<a name='2925'>
<font color=#447700>!<a name='2926'></font>
<font color=#447700>! Invoke linear limit for scaling wrt u below min_u_h2o<a name='2927'></font>
<font color=#447700>!<a name='2928'></font>
            if (uvar &lt; min_u_h2o) then<a name='2929'>
               uscl = uvar / min_u_h2o<a name='2930'>
               abso(i,ib) = abso(i,ib) * uscl<a name='2931'>
            endif<a name='2932'>
                         <a name='2933'>
<font color=#447700>!<a name='2934'></font>
<font color=#447700>! Band-dependent indices for window<a name='2935'></font>
<font color=#447700>!<a name='2936'></font>
            ib = 2<a name='2937'>
<a name='2938'>
            uvar = ub(ib) * fdif<a name='2939'>
            log_u  = min(log10(max(uvar, min_u_h2o)), max_lu_h2o)<a name='2940'>
            dvar = (log_u - min_lu_h2o) / dlu_h2o<a name='2941'>
            iu = min(max(int(aint(dvar,r8)) + 1, 1), n_u - 1)<a name='2942'>
            iu1 = iu + 1<a name='2943'>
            wu = dvar - floor(dvar)<a name='2944'>
            wu1 = 1.0 - wu<a name='2945'>
            <a name='2946'>
            log_p  = min(log10(max(pnewb(ib), min_p_h2o)), max_lp_h2o)<a name='2947'>
            dvar = (log_p - min_lp_h2o) / dlp_h2o<a name='2948'>
            ip = min(max(int(aint(dvar,r8)) + 1, 1), n_p - 1)<a name='2949'>
            ip1 = ip + 1<a name='2950'>
            wp = dvar - floor(dvar)<a name='2951'>
            wp1 = 1.0 - wp<a name='2952'>
         <a name='2953'>
            w00_00 = wp  * w_0_00 <a name='2954'>
            w00_01 = wp  * w_0_01 <a name='2955'>
            w00_10 = wp  * w_0_10 <a name='2956'>
            w00_11 = wp  * w_0_11 <a name='2957'>
            w01_00 = wp  * w_1_00 <a name='2958'>
            w01_01 = wp  * w_1_01 <a name='2959'>
            w01_10 = wp  * w_1_10 <a name='2960'>
            w01_11 = wp  * w_1_11 <a name='2961'>
            w10_00 = wp1 * w_0_00 <a name='2962'>
            w10_01 = wp1 * w_0_01 <a name='2963'>
            w10_10 = wp1 * w_0_10 <a name='2964'>
            w10_11 = wp1 * w_0_11 <a name='2965'>
            w11_00 = wp1 * w_1_00 <a name='2966'>
            w11_01 = wp1 * w_1_01 <a name='2967'>
            w11_10 = wp1 * w_1_10 <a name='2968'>
            w11_11 = wp1 * w_1_11 <a name='2969'>
<a name='2970'>
            log_uc  = min(log10(max(uch2o * fdif, min_u_h2o)), max_lu_h2o)<a name='2971'>
            dvar = (log_uc - min_lu_h2o) / dlu_h2o<a name='2972'>
            iuc = min(max(int(aint(dvar,r8)) + 1, 1), n_u - 1)<a name='2973'>
            iuc1 = iuc + 1<a name='2974'>
            wuc = dvar - floor(dvar)<a name='2975'>
            wuc1 = 1.0 - wuc<a name='2976'>
<font color=#447700>!<a name='2977'></font>
<font color=#447700>! Asymptotic value of absorptivity as U-&gt;infinity<a name='2978'></font>
<font color=#447700>!<a name='2979'></font>
            fa = fat(1,ib) + &amp;<a name='2980'>
                 fat(2,ib) * te1 + &amp;<a name='2981'>
                 fat(3,ib) * te2 + &amp;<a name='2982'>
                 fat(4,ib) * te3 + &amp;<a name='2983'>
                 fat(5,ib) * te4 + &amp;<a name='2984'>
                 fat(6,ib) * te5<a name='2985'>
<a name='2986'>
            l_star = &amp;<a name='2987'>
                 ln_ah2ow(ip , itp , iu , ite , irh ) * w11_11 * wu1 + &amp;<a name='2988'>
                 ln_ah2ow(ip , itp , iu , ite , irh1) * w11_10 * wu1 + &amp;<a name='2989'>
                 ln_ah2ow(ip , itp , iu , ite1, irh ) * w11_01 * wu1 + &amp;<a name='2990'>
                 ln_ah2ow(ip , itp , iu , ite1, irh1) * w11_00 * wu1 + &amp;<a name='2991'>
                 ln_ah2ow(ip , itp , iu1, ite , irh ) * w11_11 * wu  + &amp;<a name='2992'>
                 ln_ah2ow(ip , itp , iu1, ite , irh1) * w11_10 * wu  + &amp;<a name='2993'>
                 ln_ah2ow(ip , itp , iu1, ite1, irh ) * w11_01 * wu  + &amp;<a name='2994'>
                 ln_ah2ow(ip , itp , iu1, ite1, irh1) * w11_00 * wu  + &amp;<a name='2995'>
                 ln_ah2ow(ip , itp1, iu , ite , irh ) * w10_11 * wu1 + &amp;<a name='2996'>
                 ln_ah2ow(ip , itp1, iu , ite , irh1) * w10_10 * wu1 + &amp;<a name='2997'>
                 ln_ah2ow(ip , itp1, iu , ite1, irh ) * w10_01 * wu1 + &amp;<a name='2998'>
                 ln_ah2ow(ip , itp1, iu , ite1, irh1) * w10_00 * wu1 + &amp;<a name='2999'>
                 ln_ah2ow(ip , itp1, iu1, ite , irh ) * w10_11 * wu  + &amp;<a name='3000'>
                 ln_ah2ow(ip , itp1, iu1, ite , irh1) * w10_10 * wu  + &amp;<a name='3001'>
                 ln_ah2ow(ip , itp1, iu1, ite1, irh ) * w10_01 * wu  + &amp;<a name='3002'>
                 ln_ah2ow(ip , itp1, iu1, ite1, irh1) * w10_00 * wu  + &amp;<a name='3003'>
                 ln_ah2ow(ip1, itp , iu , ite , irh ) * w01_11 * wu1 + &amp;<a name='3004'>
                 ln_ah2ow(ip1, itp , iu , ite , irh1) * w01_10 * wu1 + &amp;<a name='3005'>
                 ln_ah2ow(ip1, itp , iu , ite1, irh ) * w01_01 * wu1 + &amp;<a name='3006'>
                 ln_ah2ow(ip1, itp , iu , ite1, irh1) * w01_00 * wu1 + &amp;<a name='3007'>
                 ln_ah2ow(ip1, itp , iu1, ite , irh ) * w01_11 * wu  + &amp;<a name='3008'>
                 ln_ah2ow(ip1, itp , iu1, ite , irh1) * w01_10 * wu  + &amp;<a name='3009'>
                 ln_ah2ow(ip1, itp , iu1, ite1, irh ) * w01_01 * wu  + &amp;<a name='3010'>
                 ln_ah2ow(ip1, itp , iu1, ite1, irh1) * w01_00 * wu  + &amp;<a name='3011'>
                 ln_ah2ow(ip1, itp1, iu , ite , irh ) * w00_11 * wu1 + &amp;<a name='3012'>
                 ln_ah2ow(ip1, itp1, iu , ite , irh1) * w00_10 * wu1 + &amp;<a name='3013'>
                 ln_ah2ow(ip1, itp1, iu , ite1, irh ) * w00_01 * wu1 + &amp;<a name='3014'>
                 ln_ah2ow(ip1, itp1, iu , ite1, irh1) * w00_00 * wu1 + &amp;<a name='3015'>
                 ln_ah2ow(ip1, itp1, iu1, ite , irh ) * w00_11 * wu  + &amp;<a name='3016'>
                 ln_ah2ow(ip1, itp1, iu1, ite , irh1) * w00_10 * wu  + &amp;<a name='3017'>
                 ln_ah2ow(ip1, itp1, iu1, ite1, irh ) * w00_01 * wu  + &amp;<a name='3018'>
                 ln_ah2ow(ip1, itp1, iu1, ite1, irh1) * w00_00 * wu <a name='3019'>
<a name='3020'>
            c_star = &amp;<a name='3021'>
                 cn_ah2ow(ip , itp , iuc , ite , irh ) * w11_11 * wuc1 + &amp;<a name='3022'>
                 cn_ah2ow(ip , itp , iuc , ite , irh1) * w11_10 * wuc1 + &amp;<a name='3023'>
                 cn_ah2ow(ip , itp , iuc , ite1, irh ) * w11_01 * wuc1 + &amp;<a name='3024'>
                 cn_ah2ow(ip , itp , iuc , ite1, irh1) * w11_00 * wuc1 + &amp;<a name='3025'>
                 cn_ah2ow(ip , itp , iuc1, ite , irh ) * w11_11 * wuc  + &amp;<a name='3026'>
                 cn_ah2ow(ip , itp , iuc1, ite , irh1) * w11_10 * wuc  + &amp;<a name='3027'>
                 cn_ah2ow(ip , itp , iuc1, ite1, irh ) * w11_01 * wuc  + &amp;<a name='3028'>
                 cn_ah2ow(ip , itp , iuc1, ite1, irh1) * w11_00 * wuc  + &amp;<a name='3029'>
                 cn_ah2ow(ip , itp1, iuc , ite , irh ) * w10_11 * wuc1 + &amp;<a name='3030'>
                 cn_ah2ow(ip , itp1, iuc , ite , irh1) * w10_10 * wuc1 + &amp;<a name='3031'>
                 cn_ah2ow(ip , itp1, iuc , ite1, irh ) * w10_01 * wuc1 + &amp;<a name='3032'>
                 cn_ah2ow(ip , itp1, iuc , ite1, irh1) * w10_00 * wuc1 + &amp;<a name='3033'>
                 cn_ah2ow(ip , itp1, iuc1, ite , irh ) * w10_11 * wuc  + &amp;<a name='3034'>
                 cn_ah2ow(ip , itp1, iuc1, ite , irh1) * w10_10 * wuc  + &amp;<a name='3035'>
                 cn_ah2ow(ip , itp1, iuc1, ite1, irh ) * w10_01 * wuc  + &amp;<a name='3036'>
                 cn_ah2ow(ip , itp1, iuc1, ite1, irh1) * w10_00 * wuc  + &amp;<a name='3037'>
                 cn_ah2ow(ip1, itp , iuc , ite , irh ) * w01_11 * wuc1 + &amp;<a name='3038'>
                 cn_ah2ow(ip1, itp , iuc , ite , irh1) * w01_10 * wuc1 + &amp;<a name='3039'>
                 cn_ah2ow(ip1, itp , iuc , ite1, irh ) * w01_01 * wuc1 + &amp;<a name='3040'>
                 cn_ah2ow(ip1, itp , iuc , ite1, irh1) * w01_00 * wuc1 + &amp;<a name='3041'>
                 cn_ah2ow(ip1, itp , iuc1, ite , irh ) * w01_11 * wuc  + &amp;<a name='3042'>
                 cn_ah2ow(ip1, itp , iuc1, ite , irh1) * w01_10 * wuc  + &amp;<a name='3043'>
                 cn_ah2ow(ip1, itp , iuc1, ite1, irh ) * w01_01 * wuc  + &amp;<a name='3044'>
                 cn_ah2ow(ip1, itp , iuc1, ite1, irh1) * w01_00 * wuc  + &amp;<a name='3045'>
                 cn_ah2ow(ip1, itp1, iuc , ite , irh ) * w00_11 * wuc1 + &amp;<a name='3046'>
                 cn_ah2ow(ip1, itp1, iuc , ite , irh1) * w00_10 * wuc1 + &amp;<a name='3047'>
                 cn_ah2ow(ip1, itp1, iuc , ite1, irh ) * w00_01 * wuc1 + &amp;<a name='3048'>
                 cn_ah2ow(ip1, itp1, iuc , ite1, irh1) * w00_00 * wuc1 + &amp;<a name='3049'>
                 cn_ah2ow(ip1, itp1, iuc1, ite , irh ) * w00_11 * wuc  + &amp;<a name='3050'>
                 cn_ah2ow(ip1, itp1, iuc1, ite , irh1) * w00_10 * wuc  + &amp;<a name='3051'>
                 cn_ah2ow(ip1, itp1, iuc1, ite1, irh ) * w00_01 * wuc  + &amp;<a name='3052'>
                 cn_ah2ow(ip1, itp1, iuc1, ite1, irh1) * w00_00 * wuc <a name='3053'>
            abso(i,ib) = min(max(fa * (1.0 - l_star * c_star * &amp;<a name='3054'>
                                 aer_trn_ttl(i,k1,k2,ib)), &amp;<a name='3055'>
                             0.0_r8), 1.0_r8) <a name='3056'>
<font color=#447700>!<a name='3057'></font>
<font color=#447700>! Invoke linear limit for scaling wrt u below min_u_h2o<a name='3058'></font>
<font color=#447700>!<a name='3059'></font>
            if (uvar &lt; min_u_h2o) then<a name='3060'>
               uscl = uvar / min_u_h2o<a name='3061'>
               abso(i,ib) = abso(i,ib) * uscl<a name='3062'>
            endif<a name='3063'>
<a name='3064'>
         end do<a name='3065'>
<font color=#447700>!<a name='3066'></font>
<font color=#447700>! Line transmission in 800-1000 and 1000-1200 cm-1 intervals<a name='3067'></font>
<font color=#447700>!<a name='3068'></font>
         do i=1,ncol<a name='3069'>
            term7(i,1) = coefj(1,1) + coefj(2,1)*dty(i)*(1. + c16*dty(i))<a name='3070'>
            term8(i,1) = coefk(1,1) + coefk(2,1)*dty(i)*(1. + c17*dty(i))<a name='3071'>
            term7(i,2) = coefj(1,2) + coefj(2,2)*dty(i)*(1. + c26*dty(i))<a name='3072'>
            term8(i,2) = coefk(1,2) + coefk(2,2)*dty(i)*(1. + c27*dty(i))<a name='3073'>
         end do<a name='3074'>
<font color=#447700>!<a name='3075'></font>
<font color=#447700>! 500 -  800 cm-1   h2o rotation band overlap with co2<a name='3076'></font>
<font color=#447700>!<a name='3077'></font>
         do i=1,ncol<a name='3078'>
            k21    = term7(i,1) + term8(i,1)/ &amp;<a name='3079'>
               (1. + (c30 + c31*(dty(i)-10.)*(dty(i)-10.))*sqrtu(i))<a name='3080'>
            k22    = term7(i,2) + term8(i,2)/ &amp;<a name='3081'>
               (1. + (c28 + c29*(dty(i)-10.))*sqrtu(i))<a name='3082'>
            tr1    = exp(-(k21*(sqrtu(i) + fc1*fwku(i))))<a name='3083'>
            tr2    = exp(-(k22*(sqrtu(i) + fc1*fwku(i))))<a name='3084'>
            tr1=tr1*aer_trn_ttl(i,k1,k2,idx_LW_0650_0800) <a name='3085'>
<font color=#447700>!                                          ! H2O line+STRAER trn 650--800 cm-1<a name='3086'></font>
            tr2=tr2*aer_trn_ttl(i,k1,k2,idx_LW_0500_0650)<a name='3087'>
<font color=#447700>!                                          ! H2O line+STRAER trn 500--650 cm-1<a name='3088'></font>
            tr5    = exp(-((coefh(1,3) + coefh(2,3)*dtx(i))*uc1(i)))<a name='3089'>
            tr6    = exp(-((coefh(1,4) + coefh(2,4)*dtx(i))*uc1(i)))<a name='3090'>
            tr9(i)   = tr1*tr5<a name='3091'>
            tr10(i)  = tr2*tr6<a name='3092'>
            th2o(i) = tr10(i)<a name='3093'>
            trab2(i) = 0.65*tr9(i) + 0.35*tr10(i)<a name='3094'>
         end do<a name='3095'>
         if (k2 &lt; k1) then<a name='3096'>
            do i=1,ncol<a name='3097'>
               to3h2o(i) = h2otr(i,k1)/h2otr(i,k2)<a name='3098'>
            end do<a name='3099'>
         else<a name='3100'>
            do i=1,ncol<a name='3101'>
               to3h2o(i) = h2otr(i,k2)/h2otr(i,k1)<a name='3102'>
            end do<a name='3103'>
         end if<a name='3104'>
<font color=#447700>!<a name='3105'></font>
<font color=#447700>! abso(i,3)   o3  9.6 micrometer band (nu3 and nu1 bands)<a name='3106'></font>
<font color=#447700>!<a name='3107'></font>
         do i=1,ncol<a name='3108'>
            dpnm(i)  = pnm(i,k1) - pnm(i,k2)<a name='3109'>
            to3co2(i) = (pnm(i,k1)*co2t(i,k1) - pnm(i,k2)*co2t(i,k2))/dpnm(i)<a name='3110'>
            te       = (to3co2(i)*r293)**.7<a name='3111'>
            dplos    = plos(i,k1) - plos(i,k2)<a name='3112'>
            dplol    = plol(i,k1) - plol(i,k2)<a name='3113'>
            u1       = 18.29*abs(dplos)/te<a name='3114'>
            u2       = .5649*abs(dplos)/te<a name='3115'>
            rphat    = dplol/dplos<a name='3116'>
            tlocal   = tint(i,k2)<a name='3117'>
            tcrfac   = sqrt(tlocal*r250)*te<a name='3118'>
            beta     = r3205*(rphat + dpfo3*tcrfac)<a name='3119'>
            realnu   = te/beta<a name='3120'>
            tmp1     = u1/sqrt(4. + u1*(1. + realnu))<a name='3121'>
            tmp2     = u2/sqrt(4. + u2*(1. + realnu))<a name='3122'>
            o3bndi    = 74.*te*log(1. + tmp1 + tmp2)<a name='3123'>
            abso(i,3) = o3bndi*to3h2o(i)*dbvtit(i,k2)<a name='3124'>
            to3(i)   = 1.0/(1. + 0.1*tmp1 + 0.1*tmp2)<a name='3125'>
         end do<a name='3126'>
<font color=#447700>!<a name='3127'></font>
<font color=#447700>! abso(i,4)      co2 15  micrometer band system<a name='3128'></font>
<font color=#447700>!<a name='3129'></font>
         do i=1,ncol<a name='3130'>
            sqwp      = sqrt(abs(plco2(i,k1) - plco2(i,k2)))<a name='3131'>
            et        = exp(-480./to3co2(i))<a name='3132'>
            sqti(i)   = sqrt(to3co2(i))<a name='3133'>
            rsqti     = 1./sqti(i)<a name='3134'>
            et2       = et*et<a name='3135'>
            et4       = et2*et2<a name='3136'>
            omet      = 1. - 1.5*et2<a name='3137'>
            f1co2     = 899.70*omet*(1. + 1.94774*et + 4.73486*et2)*rsqti<a name='3138'>
            f1sqwp(i) = f1co2*sqwp<a name='3139'>
            t1co2(i)  = 1./(1. + (245.18*omet*sqwp*rsqti))<a name='3140'>
            oneme     = 1. - et2<a name='3141'>
            alphat    = oneme**3*rsqti<a name='3142'>
            pi        = abs(dpnm(i))<a name='3143'>
            wco2      =  2.5221*co2vmr*pi*rga<a name='3144'>
            u7(i)     =  4.9411e4*alphat*et2*wco2<a name='3145'>
            u8        =  3.9744e4*alphat*et4*wco2<a name='3146'>
            u9        =  1.0447e5*alphat*et4*et2*wco2<a name='3147'>
            u13       = 2.8388e3*alphat*et4*wco2<a name='3148'>
            tpath     = to3co2(i)<a name='3149'>
            tlocal    = tint(i,k2)<a name='3150'>
            tcrfac    = sqrt(tlocal*r250*tpath*r300)<a name='3151'>
            posqt     = ((pnm(i,k2) + pnm(i,k1))*r2sslp + dpfco2*tcrfac)*rsqti<a name='3152'>
            rbeta7(i) = 1./(5.3228*posqt)<a name='3153'>
            rbeta8    = 1./(10.6576*posqt)<a name='3154'>
            rbeta9    = rbeta7(i)<a name='3155'>
            rbeta13   = rbeta9<a name='3156'>
            f2co2(i)  = (u7(i)/sqrt(4. + u7(i)*(1. + rbeta7(i)))) + &amp;<a name='3157'>
               (u8   /sqrt(4. + u8*(1. + rbeta8))) + &amp;<a name='3158'>
               (u9   /sqrt(4. + u9*(1. + rbeta9)))<a name='3159'>
            f3co2(i)  = u13/sqrt(4. + u13*(1. + rbeta13))<a name='3160'>
         end do<a name='3161'>
         if (k2 &gt;= k1) then<a name='3162'>
            do i=1,ncol<a name='3163'>
               sqti(i) = sqrt(tlayr(i,k2))<a name='3164'>
            end do<a name='3165'>
         end if<a name='3166'>
<font color=#447700>!<a name='3167'></font>
         do i=1,ncol<a name='3168'>
            tmp1      = log(1. + f1sqwp(i))<a name='3169'>
            tmp2      = log(1. + f2co2(i))<a name='3170'>
            tmp3      = log(1. + f3co2(i))<a name='3171'>
            absbnd    = (tmp1 + 2.*t1co2(i)*tmp2 + 2.*tmp3)*sqti(i)<a name='3172'>
            abso(i,4) = trab2(i)*co2em(i,k2)*absbnd<a name='3173'>
            tco2(i)   = 1./(1.0+10.0*(u7(i)/sqrt(4. + u7(i)*(1. + rbeta7(i)))))<a name='3174'>
         end do<a name='3175'>
<font color=#447700>!<a name='3176'></font>
<font color=#447700>! Calculate absorptivity due to trace gases, abstrc<a name='3177'></font>
<font color=#447700>!<a name='3178'></font>
         call <A href='../../html_code/phys/module_ra_cam_support.F.html#TRCAB'>trcab</A><A href='../../html_code/phys/module_ra_cam.F.html#RADABS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRCAB_1">( lchnk   ,ncol    ,pcols, pverp,                   &amp;<a name='3179'>
            k1      ,k2      ,ucfc11  ,ucfc12  ,un2o0   , &amp;<a name='3180'>
            un2o1   ,uch4    ,uco211  ,uco212  ,uco213  , &amp;<a name='3181'>
            uco221  ,uco222  ,uco223  ,bn2o0   ,bn2o1   , &amp;<a name='3182'>
            bch4    ,to3co2  ,pnm     ,dw      ,pnew    , &amp;<a name='3183'>
            s2c     ,uptype  ,u       ,abplnk1 ,tco2    , &amp;<a name='3184'>
            th2o    ,to3     ,abstrc  , &amp;<a name='3185'>
            aer_trn_ttl)<a name='3186'>
<font color=#447700>!<a name='3187'></font>
<font color=#447700>! Sum total absorptivity<a name='3188'></font>
<font color=#447700>!<a name='3189'></font>
         do i=1,ncol<a name='3190'>
            abstot(i,k1,k2) = abso(i,1) + abso(i,2) + &amp;<a name='3191'>
               abso(i,3) + abso(i,4) + abstrc(i)<a name='3192'>
         end do<a name='3193'>
      end do <font color=#447700>! do k2 = <a name='3194'></font>
   end do <font color=#447700>! do k1 = <a name='3195'></font>
<font color=#447700>!<a name='3196'></font>
<font color=#447700>! Adjacent layer absorptivity:<a name='3197'></font>
<font color=#447700>!<a name='3198'></font>
<font color=#447700>! abso(i,1)     0 -  800 cm-1   h2o rotation band<a name='3199'></font>
<font color=#447700>! abso(i,1)  1200 - 2200 cm-1   h2o vibration-rotation band<a name='3200'></font>
<font color=#447700>! abso(i,2)   800 - 1200 cm-1   h2o window<a name='3201'></font>
<font color=#447700>!<a name='3202'></font>
<font color=#447700>! Separation between rotation and vibration-rotation dropped, so<a name='3203'></font>
<font color=#447700>!                only 2 slots needed for H2O absorptivity<a name='3204'></font>
<font color=#447700>!<a name='3205'></font>
<font color=#447700>! 500-800 cm^-1 H2o continuum/line overlap already included<a name='3206'></font>
<font color=#447700>!                in abso(i,1).  This used to be in abso(i,4)<a name='3207'></font>
<font color=#447700>!<a name='3208'></font>
<font color=#447700>! abso(i,3)   o3  9.6 micrometer band (nu3 and nu1 bands)<a name='3209'></font>
<font color=#447700>! abso(i,4)   co2 15  micrometer band system<a name='3210'></font>
<font color=#447700>!<a name='3211'></font>
<font color=#447700>! Nearest layer level loop<a name='3212'></font>
<font color=#447700>!<a name='3213'></font>
   do k2=pver,ntoplw,-1<a name='3214'>
      do i=1,ncol<a name='3215'>
         tbar(i,1)   = 0.5*(tint(i,k2+1) + tlayr(i,k2+1))<a name='3216'>
         emm(i,1)    = 0.5*(co2em(i,k2+1) + co2eml(i,k2))<a name='3217'>
         tbar(i,2)   = 0.5*(tlayr(i,k2+1) + tint(i,k2))<a name='3218'>
         emm(i,2)    = 0.5*(co2em(i,k2) + co2eml(i,k2))<a name='3219'>
         tbar(i,3)   = 0.5*(tbar(i,2) + tbar(i,1))<a name='3220'>
         emm(i,3)    = emm(i,1)<a name='3221'>
         tbar(i,4)   = tbar(i,3)<a name='3222'>
         emm(i,4)    = emm(i,2)<a name='3223'>
         o3emm(i,1)  = 0.5*(dbvtit(i,k2+1) + dbvtly(i,k2))<a name='3224'>
         o3emm(i,2)  = 0.5*(dbvtit(i,k2) + dbvtly(i,k2))<a name='3225'>
         o3emm(i,3)  = o3emm(i,1)<a name='3226'>
         o3emm(i,4)  = o3emm(i,2)<a name='3227'>
         temh2o(i,1) = tbar(i,1)<a name='3228'>
         temh2o(i,2) = tbar(i,2)<a name='3229'>
         temh2o(i,3) = tbar(i,1)<a name='3230'>
         temh2o(i,4) = tbar(i,2)<a name='3231'>
         dpnm(i)     = pnm(i,k2+1) - pnm(i,k2)<a name='3232'>
      end do<a name='3233'>
<font color=#447700>!<a name='3234'></font>
<font color=#447700>!  Weighted Planck functions for trace gases<a name='3235'></font>
<font color=#447700>!<a name='3236'></font>
      do wvl = 1,14<a name='3237'>
         do i = 1,ncol<a name='3238'>
            bplnk(wvl,i,1) = 0.5*(abplnk1(wvl,i,k2+1) + abplnk2(wvl,i,k2))<a name='3239'>
            bplnk(wvl,i,2) = 0.5*(abplnk1(wvl,i,k2) + abplnk2(wvl,i,k2))<a name='3240'>
            bplnk(wvl,i,3) = bplnk(wvl,i,1)<a name='3241'>
            bplnk(wvl,i,4) = bplnk(wvl,i,2)<a name='3242'>
         end do<a name='3243'>
      end do<a name='3244'>
      <a name='3245'>
      do i=1,ncol<a name='3246'>
         rdpnmsq    = 1./(pnmsq(i,k2+1) - pnmsq(i,k2))<a name='3247'>
         rdpnm      = 1./dpnm(i)<a name='3248'>
         p1         = .5*(pbr(i,k2) + pnm(i,k2+1))<a name='3249'>
         p2         = .5*(pbr(i,k2) + pnm(i,k2  ))<a name='3250'>
         uinpl(i,1) =  (pnmsq(i,k2+1) - p1**2)*rdpnmsq<a name='3251'>
         uinpl(i,2) = -(pnmsq(i,k2  ) - p2**2)*rdpnmsq<a name='3252'>
         uinpl(i,3) = -(pnmsq(i,k2  ) - p1**2)*rdpnmsq<a name='3253'>
         uinpl(i,4) =  (pnmsq(i,k2+1) - p2**2)*rdpnmsq<a name='3254'>
         winpl(i,1) = (.5*( pnm(i,k2+1) - pbr(i,k2)))*rdpnm<a name='3255'>
         winpl(i,2) = (.5*(-pnm(i,k2  ) + pbr(i,k2)))*rdpnm<a name='3256'>
         winpl(i,3) = (.5*( pnm(i,k2+1) + pbr(i,k2)) - pnm(i,k2  ))*rdpnm<a name='3257'>
         winpl(i,4) = (.5*(-pnm(i,k2  ) - pbr(i,k2)) + pnm(i,k2+1))*rdpnm<a name='3258'>
         tmp1       = 1./(piln(i,k2+1) - piln(i,k2))<a name='3259'>
         tmp2       = piln(i,k2+1) - pmln(i,k2)<a name='3260'>
         tmp3       = piln(i,k2  ) - pmln(i,k2)<a name='3261'>
         zinpl(i,1) = (.5*tmp2          )*tmp1<a name='3262'>
         zinpl(i,2) = (        - .5*tmp3)*tmp1<a name='3263'>
         zinpl(i,3) = (.5*tmp2 -    tmp3)*tmp1<a name='3264'>
         zinpl(i,4) = (   tmp2 - .5*tmp3)*tmp1<a name='3265'>
         pinpl(i,1) = 0.5*(p1 + pnm(i,k2+1))<a name='3266'>
         pinpl(i,2) = 0.5*(p2 + pnm(i,k2  ))<a name='3267'>
         pinpl(i,3) = 0.5*(p1 + pnm(i,k2  ))<a name='3268'>
         pinpl(i,4) = 0.5*(p2 + pnm(i,k2+1))<a name='3269'>
         if(strat_volcanic) then<a name='3270'>
           aer_pth_ngh(i) = abs(aer_mpp(i,k2)-aer_mpp(i,k2+1))<a name='3271'>
         endif<a name='3272'>
      end do<a name='3273'>
      do kn=1,4<a name='3274'>
         do i=1,ncol<a name='3275'>
            u(i)     = uinpl(i,kn)*abs(plh2o(i,k2) - plh2o(i,k2+1))<a name='3276'>
            sqrtu(i) = sqrt(u(i))<a name='3277'>
            dw(i)    = abs(w(i,k2) - w(i,k2+1))<a name='3278'>
            pnew(i)  = u(i)/(winpl(i,kn)*dw(i))<a name='3279'>
            pnew_mks  = pnew(i) * sslp_mks<a name='3280'>
            t_p = min(max(tbar(i,kn), min_tp_h2o), max_tp_h2o)<a name='3281'>
            iest = floor(t_p) - min_tp_h2o<a name='3282'>
            esx = estblh2o(iest) + (estblh2o(iest+1)-estblh2o(iest)) * &amp;<a name='3283'>
                 (t_p - min_tp_h2o - iest)<a name='3284'>
            qsx = epsilo * esx / (pnew_mks - omeps * esx)<a name='3285'>
            q_path = dw(i) / ABS(dpnm(i)) / rga<a name='3286'>
            <a name='3287'>
            ds2c     = abs(s2c(i,k2) - s2c(i,k2+1))<a name='3288'>
            uc1(i)   = uinpl(i,kn)*ds2c<a name='3289'>
            pch2o    = uc1(i)<a name='3290'>
            uc1(i)   = (uc1(i) + 1.7e-3*u(i))*(1. +  2.*uc1(i))/(1. + 15.*uc1(i))<a name='3291'>
            dtx(i)      = temh2o(i,kn) - 250.<a name='3292'>
            dty(i)      = tbar(i,kn) - 250.<a name='3293'>
            <a name='3294'>
            fwk(i)    = fwcoef + fwc1/(1. + fwc2*u(i))<a name='3295'>
            fwku(i)   = fwk(i)*u(i)<a name='3296'>
<a name='3297'>
            if(strat_volcanic) then<a name='3298'>
              aer_pth_dlt=uinpl(i,kn)*aer_pth_ngh(i)<a name='3299'>
  <a name='3300'>
              do bnd_idx=1,bnd_nbr_LW<a name='3301'>
                 odap_aer_ttl=abs_cff_mss_aer(bnd_idx) * aer_pth_dlt <a name='3302'>
                 aer_trn_ngh(i,bnd_idx)=exp(-fdif * odap_aer_ttl)<a name='3303'>
              end do<a name='3304'>
            else<a name='3305'>
              aer_trn_ngh(i,:) = 1.0<a name='3306'>
            endif<a name='3307'>
<a name='3308'>
<font color=#447700>!<a name='3309'></font>
<font color=#447700>! Define variables for C/H/E (now C/LT/E) fit<a name='3310'></font>
<font color=#447700>!<a name='3311'></font>
<font color=#447700>! abso(i,1)     0 -  800 cm-1   h2o rotation band<a name='3312'></font>
<font color=#447700>! abso(i,1)  1200 - 2200 cm-1   h2o vibration-rotation band<a name='3313'></font>
<font color=#447700>! abso(i,2)   800 - 1200 cm-1   h2o window<a name='3314'></font>
<font color=#447700>!<a name='3315'></font>
<font color=#447700>! Separation between rotation and vibration-rotation dropped, so<a name='3316'></font>
<font color=#447700>!                only 2 slots needed for H2O absorptivity<a name='3317'></font>
<font color=#447700>!<a name='3318'></font>
<font color=#447700>! Notation:<a name='3319'></font>
<font color=#447700>! U   = integral (P/P_0 dW)  <a name='3320'></font>
<font color=#447700>! P   = atmospheric pressure<a name='3321'></font>
<font color=#447700>! P_0 = reference atmospheric pressure<a name='3322'></font>
<font color=#447700>! W   = precipitable water path<a name='3323'></font>
<font color=#447700>! T_e = emission temperature<a name='3324'></font>
<font color=#447700>! T_p = path temperature<a name='3325'></font>
<font color=#447700>! RH  = path relative humidity<a name='3326'></font>
<font color=#447700>!<a name='3327'></font>
<font color=#447700>!<a name='3328'></font>
<font color=#447700>! Terms for asymptotic value of emissivity<a name='3329'></font>
<font color=#447700>!<a name='3330'></font>
            te1  = temh2o(i,kn)<a name='3331'>
            te2  = te1 * te1<a name='3332'>
            te3  = te2 * te1<a name='3333'>
            te4  = te3 * te1<a name='3334'>
            te5  = te4 * te1<a name='3335'>
<a name='3336'>
<font color=#447700>!<a name='3337'></font>
<font color=#447700>! Indices for lines and continuum tables <a name='3338'></font>
<font color=#447700>! Note: because we are dealing with the nearest layer,<a name='3339'></font>
<font color=#447700>!       the Hulst-Curtis-Godson corrections<a name='3340'></font>
<font color=#447700>!       for inhomogeneous paths are not applied.<a name='3341'></font>
<font color=#447700>!<a name='3342'></font>
            uvar = u(i)*fdif<a name='3343'>
            log_u  = min(log10(max(uvar, min_u_h2o)), max_lu_h2o)<a name='3344'>
            dvar = (log_u - min_lu_h2o) / dlu_h2o<a name='3345'>
            iu = min(max(int(aint(dvar,r8)) + 1, 1), n_u - 1)<a name='3346'>
            iu1 = iu + 1<a name='3347'>
            wu = dvar - floor(dvar)<a name='3348'>
            wu1 = 1.0 - wu<a name='3349'>
            <a name='3350'>
            log_p  = min(log10(max(pnew(i), min_p_h2o)), max_lp_h2o)<a name='3351'>
            dvar = (log_p - min_lp_h2o) / dlp_h2o<a name='3352'>
            ip = min(max(int(aint(dvar,r8)) + 1, 1), n_p - 1)<a name='3353'>
            ip1 = ip + 1<a name='3354'>
            wp = dvar - floor(dvar)<a name='3355'>
            wp1 = 1.0 - wp<a name='3356'>
            <a name='3357'>
            dvar = (t_p - min_tp_h2o) / dtp_h2o<a name='3358'>
            itp = min(max(int(aint(dvar,r8)) + 1, 1), n_tp - 1)<a name='3359'>
            itp1 = itp + 1<a name='3360'>
            wtp = dvar - floor(dvar)<a name='3361'>
            wtp1 = 1.0 - wtp<a name='3362'>
            <a name='3363'>
            t_e = min(max(temh2o(i,kn)-t_p,min_te_h2o),max_te_h2o)<a name='3364'>
            dvar = (t_e - min_te_h2o) / dte_h2o<a name='3365'>
            ite = min(max(int(aint(dvar,r8)) + 1, 1), n_te - 1)<a name='3366'>
            ite1 = ite + 1<a name='3367'>
            wte = dvar - floor(dvar)<a name='3368'>
            wte1 = 1.0 - wte<a name='3369'>
            <a name='3370'>
            rh_path = min(max(q_path / qsx, min_rh_h2o), max_rh_h2o)<a name='3371'>
            dvar = (rh_path - min_rh_h2o) / drh_h2o<a name='3372'>
            irh = min(max(int(aint(dvar,r8)) + 1, 1), n_rh - 1)<a name='3373'>
            irh1 = irh + 1<a name='3374'>
            wrh = dvar - floor(dvar)<a name='3375'>
            wrh1 = 1.0 - wrh<a name='3376'>
            <a name='3377'>
            w_0_0_ = wtp  * wte<a name='3378'>
            w_0_1_ = wtp  * wte1<a name='3379'>
            w_1_0_ = wtp1 * wte <a name='3380'>
            w_1_1_ = wtp1 * wte1<a name='3381'>
            <a name='3382'>
            w_0_00 = w_0_0_ * wrh<a name='3383'>
            w_0_01 = w_0_0_ * wrh1<a name='3384'>
            w_0_10 = w_0_1_ * wrh<a name='3385'>
            w_0_11 = w_0_1_ * wrh1<a name='3386'>
            w_1_00 = w_1_0_ * wrh<a name='3387'>
            w_1_01 = w_1_0_ * wrh1<a name='3388'>
            w_1_10 = w_1_1_ * wrh<a name='3389'>
            w_1_11 = w_1_1_ * wrh1<a name='3390'>
            <a name='3391'>
            w00_00 = wp  * w_0_00 <a name='3392'>
            w00_01 = wp  * w_0_01 <a name='3393'>
            w00_10 = wp  * w_0_10 <a name='3394'>
            w00_11 = wp  * w_0_11 <a name='3395'>
            w01_00 = wp  * w_1_00 <a name='3396'>
            w01_01 = wp  * w_1_01 <a name='3397'>
            w01_10 = wp  * w_1_10 <a name='3398'>
            w01_11 = wp  * w_1_11 <a name='3399'>
            w10_00 = wp1 * w_0_00 <a name='3400'>
            w10_01 = wp1 * w_0_01 <a name='3401'>
            w10_10 = wp1 * w_0_10 <a name='3402'>
            w10_11 = wp1 * w_0_11 <a name='3403'>
            w11_00 = wp1 * w_1_00 <a name='3404'>
            w11_01 = wp1 * w_1_01 <a name='3405'>
            w11_10 = wp1 * w_1_10 <a name='3406'>
            w11_11 = wp1 * w_1_11 <a name='3407'>
<a name='3408'>
<font color=#447700>!<a name='3409'></font>
<font color=#447700>! Non-window absorptivity<a name='3410'></font>
<font color=#447700>!<a name='3411'></font>
            ib = 1<a name='3412'>
            <a name='3413'>
            fa = fat(1,ib) + &amp;<a name='3414'>
                 fat(2,ib) * te1 + &amp;<a name='3415'>
                 fat(3,ib) * te2 + &amp;<a name='3416'>
                 fat(4,ib) * te3 + &amp;<a name='3417'>
                 fat(5,ib) * te4 + &amp;<a name='3418'>
                 fat(6,ib) * te5<a name='3419'>
            <a name='3420'>
            a_star = &amp;<a name='3421'>
                 ah2onw(ip , itp , iu , ite , irh ) * w11_11 * wu1 + &amp;<a name='3422'>
                 ah2onw(ip , itp , iu , ite , irh1) * w11_10 * wu1 + &amp;<a name='3423'>
                 ah2onw(ip , itp , iu , ite1, irh ) * w11_01 * wu1 + &amp;<a name='3424'>
                 ah2onw(ip , itp , iu , ite1, irh1) * w11_00 * wu1 + &amp;<a name='3425'>
                 ah2onw(ip , itp , iu1, ite , irh ) * w11_11 * wu  + &amp;<a name='3426'>
                 ah2onw(ip , itp , iu1, ite , irh1) * w11_10 * wu  + &amp;<a name='3427'>
                 ah2onw(ip , itp , iu1, ite1, irh ) * w11_01 * wu  + &amp;<a name='3428'>
                 ah2onw(ip , itp , iu1, ite1, irh1) * w11_00 * wu  + &amp;<a name='3429'>
                 ah2onw(ip , itp1, iu , ite , irh ) * w10_11 * wu1 + &amp;<a name='3430'>
                 ah2onw(ip , itp1, iu , ite , irh1) * w10_10 * wu1 + &amp;<a name='3431'>
                 ah2onw(ip , itp1, iu , ite1, irh ) * w10_01 * wu1 + &amp;<a name='3432'>
                 ah2onw(ip , itp1, iu , ite1, irh1) * w10_00 * wu1 + &amp;<a name='3433'>
                 ah2onw(ip , itp1, iu1, ite , irh ) * w10_11 * wu  + &amp;<a name='3434'>
                 ah2onw(ip , itp1, iu1, ite , irh1) * w10_10 * wu  + &amp;<a name='3435'>
                 ah2onw(ip , itp1, iu1, ite1, irh ) * w10_01 * wu  + &amp;<a name='3436'>
                 ah2onw(ip , itp1, iu1, ite1, irh1) * w10_00 * wu  + &amp;<a name='3437'>
                 ah2onw(ip1, itp , iu , ite , irh ) * w01_11 * wu1 + &amp;<a name='3438'>
                 ah2onw(ip1, itp , iu , ite , irh1) * w01_10 * wu1 + &amp;<a name='3439'>
                 ah2onw(ip1, itp , iu , ite1, irh ) * w01_01 * wu1 + &amp;<a name='3440'>
                 ah2onw(ip1, itp , iu , ite1, irh1) * w01_00 * wu1 + &amp;<a name='3441'>
                 ah2onw(ip1, itp , iu1, ite , irh ) * w01_11 * wu  + &amp;<a name='3442'>
                 ah2onw(ip1, itp , iu1, ite , irh1) * w01_10 * wu  + &amp;<a name='3443'>
                 ah2onw(ip1, itp , iu1, ite1, irh ) * w01_01 * wu  + &amp;<a name='3444'>
                 ah2onw(ip1, itp , iu1, ite1, irh1) * w01_00 * wu  + &amp;<a name='3445'>
                 ah2onw(ip1, itp1, iu , ite , irh ) * w00_11 * wu1 + &amp;<a name='3446'>
                 ah2onw(ip1, itp1, iu , ite , irh1) * w00_10 * wu1 + &amp;<a name='3447'>
                 ah2onw(ip1, itp1, iu , ite1, irh ) * w00_01 * wu1 + &amp;<a name='3448'>
                 ah2onw(ip1, itp1, iu , ite1, irh1) * w00_00 * wu1 + &amp;<a name='3449'>
                 ah2onw(ip1, itp1, iu1, ite , irh ) * w00_11 * wu  + &amp;<a name='3450'>
                 ah2onw(ip1, itp1, iu1, ite , irh1) * w00_10 * wu  + &amp;<a name='3451'>
                 ah2onw(ip1, itp1, iu1, ite1, irh ) * w00_01 * wu  + &amp;<a name='3452'>
                 ah2onw(ip1, itp1, iu1, ite1, irh1) * w00_00 * wu<a name='3453'>
            <a name='3454'>
            abso(i,ib) = min(max(fa * (1.0 - (1.0 - a_star) * &amp;<a name='3455'>
                                 aer_trn_ngh(i,ib)), &amp;<a name='3456'>
                             0.0_r8), 1.0_r8)<a name='3457'>
<a name='3458'>
<font color=#447700>!<a name='3459'></font>
<font color=#447700>! Invoke linear limit for scaling wrt u below min_u_h2o<a name='3460'></font>
<font color=#447700>!<a name='3461'></font>
            if (uvar &lt; min_u_h2o) then<a name='3462'>
               uscl = uvar / min_u_h2o<a name='3463'>
               abso(i,ib) = abso(i,ib) * uscl<a name='3464'>
            endif<a name='3465'>
            <a name='3466'>
<font color=#447700>!<a name='3467'></font>
<font color=#447700>! Window absorptivity<a name='3468'></font>
<font color=#447700>!<a name='3469'></font>
            ib = 2<a name='3470'>
            <a name='3471'>
            fa = fat(1,ib) + &amp;<a name='3472'>
                 fat(2,ib) * te1 + &amp;<a name='3473'>
                 fat(3,ib) * te2 + &amp;<a name='3474'>
                 fat(4,ib) * te3 + &amp;<a name='3475'>
                 fat(5,ib) * te4 + &amp;<a name='3476'>
                 fat(6,ib) * te5<a name='3477'>
            <a name='3478'>
            a_star = &amp;<a name='3479'>
                 ah2ow(ip , itp , iu , ite , irh ) * w11_11 * wu1 + &amp;<a name='3480'>
                 ah2ow(ip , itp , iu , ite , irh1) * w11_10 * wu1 + &amp;<a name='3481'>
                 ah2ow(ip , itp , iu , ite1, irh ) * w11_01 * wu1 + &amp;<a name='3482'>
                 ah2ow(ip , itp , iu , ite1, irh1) * w11_00 * wu1 + &amp;<a name='3483'>
                 ah2ow(ip , itp , iu1, ite , irh ) * w11_11 * wu  + &amp;<a name='3484'>
                 ah2ow(ip , itp , iu1, ite , irh1) * w11_10 * wu  + &amp;<a name='3485'>
                 ah2ow(ip , itp , iu1, ite1, irh ) * w11_01 * wu  + &amp;<a name='3486'>
                 ah2ow(ip , itp , iu1, ite1, irh1) * w11_00 * wu  + &amp;<a name='3487'>
                 ah2ow(ip , itp1, iu , ite , irh ) * w10_11 * wu1 + &amp;<a name='3488'>
                 ah2ow(ip , itp1, iu , ite , irh1) * w10_10 * wu1 + &amp;<a name='3489'>
                 ah2ow(ip , itp1, iu , ite1, irh ) * w10_01 * wu1 + &amp;<a name='3490'>
                 ah2ow(ip , itp1, iu , ite1, irh1) * w10_00 * wu1 + &amp;<a name='3491'>
                 ah2ow(ip , itp1, iu1, ite , irh ) * w10_11 * wu  + &amp;<a name='3492'>
                 ah2ow(ip , itp1, iu1, ite , irh1) * w10_10 * wu  + &amp;<a name='3493'>
                 ah2ow(ip , itp1, iu1, ite1, irh ) * w10_01 * wu  + &amp;<a name='3494'>
                 ah2ow(ip , itp1, iu1, ite1, irh1) * w10_00 * wu  + &amp;<a name='3495'>
                 ah2ow(ip1, itp , iu , ite , irh ) * w01_11 * wu1 + &amp;<a name='3496'>
                 ah2ow(ip1, itp , iu , ite , irh1) * w01_10 * wu1 + &amp;<a name='3497'>
                 ah2ow(ip1, itp , iu , ite1, irh ) * w01_01 * wu1 + &amp;<a name='3498'>
                 ah2ow(ip1, itp , iu , ite1, irh1) * w01_00 * wu1 + &amp;<a name='3499'>
                 ah2ow(ip1, itp , iu1, ite , irh ) * w01_11 * wu  + &amp;<a name='3500'>
                 ah2ow(ip1, itp , iu1, ite , irh1) * w01_10 * wu  + &amp;<a name='3501'>
                 ah2ow(ip1, itp , iu1, ite1, irh ) * w01_01 * wu  + &amp;<a name='3502'>
                 ah2ow(ip1, itp , iu1, ite1, irh1) * w01_00 * wu  + &amp;<a name='3503'>
                 ah2ow(ip1, itp1, iu , ite , irh ) * w00_11 * wu1 + &amp;<a name='3504'>
                 ah2ow(ip1, itp1, iu , ite , irh1) * w00_10 * wu1 + &amp;<a name='3505'>
                 ah2ow(ip1, itp1, iu , ite1, irh ) * w00_01 * wu1 + &amp;<a name='3506'>
                 ah2ow(ip1, itp1, iu , ite1, irh1) * w00_00 * wu1 + &amp;<a name='3507'>
                 ah2ow(ip1, itp1, iu1, ite , irh ) * w00_11 * wu  + &amp;<a name='3508'>
                 ah2ow(ip1, itp1, iu1, ite , irh1) * w00_10 * wu  + &amp;<a name='3509'>
                 ah2ow(ip1, itp1, iu1, ite1, irh ) * w00_01 * wu  + &amp;<a name='3510'>
                 ah2ow(ip1, itp1, iu1, ite1, irh1) * w00_00 * wu<a name='3511'>
            <a name='3512'>
            abso(i,ib) = min(max(fa * (1.0 - (1.0 - a_star) * &amp;<a name='3513'>
                                 aer_trn_ngh(i,ib)), &amp;<a name='3514'>
                             0.0_r8), 1.0_r8)<a name='3515'>
<a name='3516'>
<font color=#447700>!<a name='3517'></font>
<font color=#447700>! Invoke linear limit for scaling wrt u below min_u_h2o<a name='3518'></font>
<font color=#447700>!<a name='3519'></font>
            if (uvar &lt; min_u_h2o) then<a name='3520'>
               uscl = uvar / min_u_h2o<a name='3521'>
               abso(i,ib) = abso(i,ib) * uscl<a name='3522'>
            endif<a name='3523'>
            <a name='3524'>
         end do<a name='3525'>
<font color=#447700>!<a name='3526'></font>
<font color=#447700>! Line transmission in 800-1000 and 1000-1200 cm-1 intervals<a name='3527'></font>
<font color=#447700>!<a name='3528'></font>
         do i=1,ncol<a name='3529'>
            term7(i,1) = coefj(1,1) + coefj(2,1)*dty(i)*(1. + c16*dty(i))<a name='3530'>
            term8(i,1) = coefk(1,1) + coefk(2,1)*dty(i)*(1. + c17*dty(i))<a name='3531'>
            term7(i,2) = coefj(1,2) + coefj(2,2)*dty(i)*(1. + c26*dty(i))<a name='3532'>
            term8(i,2) = coefk(1,2) + coefk(2,2)*dty(i)*(1. + c27*dty(i))<a name='3533'>
         end do<a name='3534'>
<font color=#447700>!<a name='3535'></font>
<font color=#447700>! 500 -  800 cm-1   h2o rotation band overlap with co2<a name='3536'></font>
<font color=#447700>!<a name='3537'></font>
         do i=1,ncol<a name='3538'>
            dtym10     = dty(i) - 10.<a name='3539'>
            denom      = 1. + (c30 + c31*dtym10*dtym10)*sqrtu(i)<a name='3540'>
            k21        = term7(i,1) + term8(i,1)/denom<a name='3541'>
            denom      = 1. + (c28 + c29*dtym10       )*sqrtu(i)<a name='3542'>
            k22        = term7(i,2) + term8(i,2)/denom<a name='3543'>
            tr1     = exp(-(k21*(sqrtu(i) + fc1*fwku(i))))<a name='3544'>
            tr2     = exp(-(k22*(sqrtu(i) + fc1*fwku(i))))<a name='3545'>
            tr1=tr1*aer_trn_ngh(i,idx_LW_0650_0800) <a name='3546'>
<font color=#447700>!                                         ! H2O line+STRAER trn 650--800 cm-1<a name='3547'></font>
            tr2=tr2*aer_trn_ngh(i,idx_LW_0500_0650) <a name='3548'>
<font color=#447700>!                                         ! H2O line+STRAER trn 500--650 cm-1<a name='3549'></font>
            tr5     = exp(-((coefh(1,3) + coefh(2,3)*dtx(i))*uc1(i)))<a name='3550'>
            tr6     = exp(-((coefh(1,4) + coefh(2,4)*dtx(i))*uc1(i)))<a name='3551'>
            tr9(i)  = tr1*tr5<a name='3552'>
            tr10(i) = tr2*tr6<a name='3553'>
            trab2(i)= 0.65*tr9(i) + 0.35*tr10(i)<a name='3554'>
            th2o(i) = tr10(i)<a name='3555'>
         end do<a name='3556'>
<font color=#447700>!<a name='3557'></font>
<font color=#447700>! abso(i,3)  o3  9.6 micrometer (nu3 and nu1 bands)<a name='3558'></font>
<font color=#447700>!<a name='3559'></font>
         do i=1,ncol<a name='3560'>
            te        = (tbar(i,kn)*r293)**.7<a name='3561'>
            dplos     = abs(plos(i,k2+1) - plos(i,k2))<a name='3562'>
            u1        = zinpl(i,kn)*18.29*dplos/te<a name='3563'>
            u2        = zinpl(i,kn)*.5649*dplos/te<a name='3564'>
            tlocal    = tbar(i,kn)<a name='3565'>
            tcrfac    = sqrt(tlocal*r250)*te<a name='3566'>
            beta      = r3205*(pinpl(i,kn)*rsslp + dpfo3*tcrfac)<a name='3567'>
            realnu    = te/beta<a name='3568'>
            tmp1      = u1/sqrt(4. + u1*(1. + realnu))<a name='3569'>
            tmp2      = u2/sqrt(4. + u2*(1. + realnu))<a name='3570'>
            o3bndi    = 74.*te*log(1. + tmp1 + tmp2)<a name='3571'>
            abso(i,3) = o3bndi*o3emm(i,kn)*(h2otr(i,k2+1)/h2otr(i,k2))<a name='3572'>
            to3(i)    = 1.0/(1. + 0.1*tmp1 + 0.1*tmp2)<a name='3573'>
         end do<a name='3574'>
<font color=#447700>!<a name='3575'></font>
<font color=#447700>! abso(i,4)   co2 15  micrometer band system<a name='3576'></font>
<font color=#447700>!<a name='3577'></font>
         do i=1,ncol<a name='3578'>
            dplco2   = plco2(i,k2+1) - plco2(i,k2)<a name='3579'>
            sqwp     = sqrt(uinpl(i,kn)*dplco2)<a name='3580'>
            et       = exp(-480./tbar(i,kn))<a name='3581'>
            sqti(i)  = sqrt(tbar(i,kn))<a name='3582'>
            rsqti    = 1./sqti(i)<a name='3583'>
            et2      = et*et<a name='3584'>
            et4      = et2*et2<a name='3585'>
            omet     = (1. - 1.5*et2)<a name='3586'>
            f1co2    = 899.70*omet*(1. + 1.94774*et + 4.73486*et2)*rsqti<a name='3587'>
            f1sqwp(i)= f1co2*sqwp<a name='3588'>
            t1co2(i) = 1./(1. + (245.18*omet*sqwp*rsqti))<a name='3589'>
            oneme    = 1. - et2<a name='3590'>
            alphat   = oneme**3*rsqti<a name='3591'>
            pi       = abs(dpnm(i))*winpl(i,kn)<a name='3592'>
            wco2     = 2.5221*co2vmr*pi*rga<a name='3593'>
            u7(i)    = 4.9411e4*alphat*et2*wco2<a name='3594'>
            u8       = 3.9744e4*alphat*et4*wco2<a name='3595'>
            u9       = 1.0447e5*alphat*et4*et2*wco2<a name='3596'>
            u13      = 2.8388e3*alphat*et4*wco2<a name='3597'>
            tpath    = tbar(i,kn)<a name='3598'>
            tlocal   = tbar(i,kn)<a name='3599'>
            tcrfac   = sqrt((tlocal*r250)*(tpath*r300))<a name='3600'>
            posqt    = (pinpl(i,kn)*rsslp + dpfco2*tcrfac)*rsqti<a name='3601'>
            rbeta7(i)= 1./(5.3228*posqt)<a name='3602'>
            rbeta8   = 1./(10.6576*posqt)<a name='3603'>
            rbeta9   = rbeta7(i)<a name='3604'>
            rbeta13  = rbeta9<a name='3605'>
            f2co2(i) = u7(i)/sqrt(4. + u7(i)*(1. + rbeta7(i))) + &amp;<a name='3606'>
                 u8   /sqrt(4. + u8*(1. + rbeta8)) + &amp;<a name='3607'>
                 u9   /sqrt(4. + u9*(1. + rbeta9))<a name='3608'>
            f3co2(i) = u13/sqrt(4. + u13*(1. + rbeta13))<a name='3609'>
            tmp1     = log(1. + f1sqwp(i))<a name='3610'>
            tmp2     = log(1. + f2co2(i))<a name='3611'>
            tmp3     = log(1. + f3co2(i))<a name='3612'>
            absbnd   = (tmp1 + 2.*t1co2(i)*tmp2 + 2.*tmp3)*sqti(i)<a name='3613'>
            abso(i,4)= trab2(i)*emm(i,kn)*absbnd<a name='3614'>
            tco2(i)  = 1.0/(1.0+ 10.0*u7(i)/sqrt(4. + u7(i)*(1. + rbeta7(i))))<a name='3615'>
         end do <font color=#447700>! do i =<a name='3616'></font>
<font color=#447700>!<a name='3617'></font>
<font color=#447700>! Calculate trace gas absorptivity for nearest layer, abstrc<a name='3618'></font>
<font color=#447700>!<a name='3619'></font>
         call <A href='../../html_code/phys/module_ra_cam_support.F.html#TRCABN'>trcabn</A><A href='../../html_code/phys/module_ra_cam.F.html#RADABS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRCABN_1">(lchnk   ,ncol    ,pcols, pverp,                   &amp;<a name='3620'>
              k2      ,kn      ,ucfc11  ,ucfc12  ,un2o0   , &amp;<a name='3621'>
              un2o1   ,uch4    ,uco211  ,uco212  ,uco213  , &amp;<a name='3622'>
              uco221  ,uco222  ,uco223  ,tbar    ,bplnk   , &amp;<a name='3623'>
              winpl   ,pinpl   ,tco2    ,th2o    ,to3     , &amp;<a name='3624'>
              uptype  ,dw      ,s2c     ,u       ,pnew    , &amp;<a name='3625'>
              abstrc  ,uinpl   , &amp;<a name='3626'>
              aer_trn_ngh)<a name='3627'>
<font color=#447700>!<a name='3628'></font>
<font color=#447700>! Total next layer absorptivity:<a name='3629'></font>
<font color=#447700>!<a name='3630'></font>
         do i=1,ncol<a name='3631'>
            absnxt(i,k2,kn) = abso(i,1) + abso(i,2) + &amp;<a name='3632'>
                 abso(i,3) + abso(i,4) + abstrc(i)<a name='3633'>
         end do<a name='3634'>
      end do <font color=#447700>! do kn =<a name='3635'></font>
   end do <font color=#447700>! do k2 =<a name='3636'></font>
<a name='3637'>
   return<a name='3638'>
end subroutine radabs<a name='3639'>
<a name='3640'>
<a name='3641'>
<a name='3642'>
<A NAME='RADEMS'><A href='../../html_code/phys/module_ra_cam.F.html#RADEMS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3643'>
<font color=#993300>subroutine </font><font color=#cc0000>radems</font>(lchnk   ,ncol    ,pcols, pver, pverp,         &amp; <A href='../../call_to/RADEMS.html' TARGET='index'>1</A>,<A href='../../call_from/RADEMS.html' TARGET='index'>3</A><a name='3644'>
                  s2c     ,tcg     ,w       ,tplnke  ,plh2o   , &amp;<a name='3645'>
                  pnm     ,plco2   ,tint    ,tint4   ,tlayr   , &amp;<a name='3646'>
                  tlayr4  ,plol    ,plos    ,ucfc11  ,ucfc12  , &amp;<a name='3647'>
                  un2o0   ,un2o1   ,uch4    ,uco211 ,uco212   , &amp;<a name='3648'>
                  uco213  ,uco221  ,uco222  ,uco223  ,uptype  , &amp;<a name='3649'>
                  bn2o0   ,bn2o1   ,bch4    ,co2em   ,co2eml  , &amp;<a name='3650'>
                  co2t    ,h2otr   ,abplnk1 ,abplnk2 ,emstot  , &amp;<a name='3651'>
                  plh2ob  ,wb      , &amp;<a name='3652'>
                  aer_trn_ttl)<a name='3653'>
<font color=#447700>!----------------------------------------------------------------------- <a name='3654'></font>
<font color=#447700>! <a name='3655'></font>
<font color=#447700>! Purpose: <a name='3656'></font>
<font color=#447700>! Compute emissivity for H2O, CO2, O3, CH4, N2O, CFC11 and CFC12<a name='3657'></font>
<font color=#447700>! <a name='3658'></font>
<font color=#447700>! Method: <a name='3659'></font>
<font color=#447700>! H2O  ....  Uses nonisothermal emissivity method for water vapor from<a name='3660'></font>
<font color=#447700>!            Ramanathan, V. and  P.Downey, 1986: A Nonisothermal<a name='3661'></font>
<font color=#447700>!            Emissivity and Absorptivity Formulation for Water Vapor<a name='3662'></font>
<font color=#447700>!            Jouranl of Geophysical Research, vol. 91., D8, pp 8649-8666<a name='3663'></font>
<font color=#447700>!<a name='3664'></font>
<font color=#447700>!            Implementation updated by Collins,Hackney, and Edwards 2001<a name='3665'></font>
<font color=#447700>!               using line-by-line calculations based upon Hitran 1996 and<a name='3666'></font>
<font color=#447700>!               CKD 2.1 for absorptivity and emissivity<a name='3667'></font>
<font color=#447700>!<a name='3668'></font>
<font color=#447700>!            Implementation updated by Collins, Lee-Taylor, and Edwards (2003)<a name='3669'></font>
<font color=#447700>!               using line-by-line calculations based upon Hitran 2000 and<a name='3670'></font>
<font color=#447700>!               CKD 2.4 for absorptivity and emissivity<a name='3671'></font>
<font color=#447700>!<a name='3672'></font>
<font color=#447700>! CO2  ....  Uses absorptance parameterization of the 15 micro-meter<a name='3673'></font>
<font color=#447700>!            (500 - 800 cm-1) band system of Carbon Dioxide, from<a name='3674'></font>
<font color=#447700>!            Kiehl, J.T. and B.P.Briegleb, 1991: A New Parameterization<a name='3675'></font>
<font color=#447700>!            of the Absorptance Due to the 15 micro-meter Band System<a name='3676'></font>
<font color=#447700>!            of Carbon Dioxide Jouranl of Geophysical Research,<a name='3677'></font>
<font color=#447700>!            vol. 96., D5, pp 9013-9019. Also includes the effects<a name='3678'></font>
<font color=#447700>!            of the 9.4 and 10.4 micron bands of CO2.<a name='3679'></font>
<font color=#447700>!<a name='3680'></font>
<font color=#447700>! O3   ....  Uses absorptance parameterization of the 9.6 micro-meter<a name='3681'></font>
<font color=#447700>!            band system of ozone, from Ramanathan, V. and R. Dickinson,<a name='3682'></font>
<font color=#447700>!            1979: The Role of stratospheric ozone in the zonal and<a name='3683'></font>
<font color=#447700>!            seasonal radiative energy balance of the earth-troposphere<a name='3684'></font>
<font color=#447700>!            system. Journal of the Atmospheric Sciences, Vol. 36,<a name='3685'></font>
<font color=#447700>!            pp 1084-1104<a name='3686'></font>
<font color=#447700>!<a name='3687'></font>
<font color=#447700>! ch4  ....  Uses a broad band model for the 7.7 micron band of methane.<a name='3688'></font>
<font color=#447700>!<a name='3689'></font>
<font color=#447700>! n20  ....  Uses a broad band model for the 7.8, 8.6 and 17.0 micron<a name='3690'></font>
<font color=#447700>!            bands of nitrous oxide<a name='3691'></font>
<font color=#447700>!<a name='3692'></font>
<font color=#447700>! cfc11 ...  Uses a quasi-linear model for the 9.2, 10.7, 11.8 and 12.5<a name='3693'></font>
<font color=#447700>!            micron bands of CFC11<a name='3694'></font>
<font color=#447700>!<a name='3695'></font>
<font color=#447700>! cfc12 ...  Uses a quasi-linear model for the 8.6, 9.1, 10.8 and 11.2<a name='3696'></font>
<font color=#447700>!            micron bands of CFC12<a name='3697'></font>
<font color=#447700>!<a name='3698'></font>
<font color=#447700>!<a name='3699'></font>
<font color=#447700>! Computes individual emissivities, accounting for band overlap, and<a name='3700'></font>
<font color=#447700>! sums to obtain the total.<a name='3701'></font>
<font color=#447700>!<a name='3702'></font>
<font color=#447700>! Author: W. Collins (H2O emissivity) and J. Kiehl<a name='3703'></font>
<font color=#447700>! <a name='3704'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3705'></font>
<font color=#447700>!------------------------------Arguments--------------------------------<a name='3706'></font>
<font color=#447700>!<a name='3707'></font>
<font color=#447700>! Input arguments<a name='3708'></font>
<font color=#447700>!<a name='3709'></font>
   integer, intent(in) :: lchnk                    <font color=#447700>! chunk identifier<a name='3710'></font>
   integer, intent(in) :: ncol                     <font color=#447700>! number of atmospheric columns<a name='3711'></font>
   integer, intent(in) :: pcols, pver, pverp<a name='3712'>
<a name='3713'>
   real(r8), intent(in) :: s2c(pcols,pverp)        <font color=#447700>! H2o continuum path length<a name='3714'></font>
   real(r8), intent(in) :: tcg(pcols,pverp)        <font color=#447700>! H2o-mass-wgted temp. (Curtis-Godson approx.)<a name='3715'></font>
   real(r8), intent(in) :: w(pcols,pverp)          <font color=#447700>! H2o path length<a name='3716'></font>
   real(r8), intent(in) :: tplnke(pcols)           <font color=#447700>! Layer planck temperature<a name='3717'></font>
   real(r8), intent(in) :: plh2o(pcols,pverp)      <font color=#447700>! H2o prs wghted path length<a name='3718'></font>
   real(r8), intent(in) :: pnm(pcols,pverp)        <font color=#447700>! Model interface pressure<a name='3719'></font>
   real(r8), intent(in) :: plco2(pcols,pverp)      <font color=#447700>! Prs wghted path of co2<a name='3720'></font>
   real(r8), intent(in) :: tint(pcols,pverp)       <font color=#447700>! Model interface temperatures<a name='3721'></font>
   real(r8), intent(in) :: tint4(pcols,pverp)      <font color=#447700>! Tint to the 4th power<a name='3722'></font>
   real(r8), intent(in) :: tlayr(pcols,pverp)      <font color=#447700>! K-1 model layer temperature<a name='3723'></font>
   real(r8), intent(in) :: tlayr4(pcols,pverp)     <font color=#447700>! Tlayr to the 4th power<a name='3724'></font>
   real(r8), intent(in) :: plol(pcols,pverp)       <font color=#447700>! Pressure wghtd ozone path<a name='3725'></font>
   real(r8), intent(in) :: plos(pcols,pverp)       <font color=#447700>! Ozone path<a name='3726'></font>
   real(r8), intent(in) :: plh2ob(nbands,pcols,pverp) <font color=#447700>! Pressure weighted h2o path with <a name='3727'></font>
                                                      <font color=#447700>!    Hulst-Curtis-Godson temp. factor <a name='3728'></font>
                                                      <font color=#447700>!    for H2O bands <a name='3729'></font>
   real(r8), intent(in) :: wb(nbands,pcols,pverp)     <font color=#447700>! H2o path length with <a name='3730'></font>
                                                      <font color=#447700>!    Hulst-Curtis-Godson temp. factor <a name='3731'></font>
                                                      <font color=#447700>!    for H2O bands <a name='3732'></font>
<a name='3733'>
   real(r8), intent(in) :: aer_trn_ttl(pcols,pverp,pverp,bnd_nbr_LW) <a name='3734'>
<font color=#447700>!                               ! [fraction] Total strat. aerosol<a name='3735'></font>
<font color=#447700>!                               ! transmission between interfaces k1 and k2  <a name='3736'></font>
<a name='3737'>
<font color=#447700>!<a name='3738'></font>
<font color=#447700>! Trace gas variables<a name='3739'></font>
<font color=#447700>!<a name='3740'></font>
   real(r8), intent(in) :: ucfc11(pcols,pverp)     <font color=#447700>! CFC11 path length<a name='3741'></font>
   real(r8), intent(in) :: ucfc12(pcols,pverp)     <font color=#447700>! CFC12 path length<a name='3742'></font>
   real(r8), intent(in) :: un2o0(pcols,pverp)      <font color=#447700>! N2O path length<a name='3743'></font>
   real(r8), intent(in) :: un2o1(pcols,pverp)      <font color=#447700>! N2O path length (hot band)<a name='3744'></font>
   real(r8), intent(in) :: uch4(pcols,pverp)       <font color=#447700>! CH4 path length<a name='3745'></font>
   real(r8), intent(in) :: uco211(pcols,pverp)     <font color=#447700>! CO2 9.4 micron band path length<a name='3746'></font>
   real(r8), intent(in) :: uco212(pcols,pverp)     <font color=#447700>! CO2 9.4 micron band path length<a name='3747'></font>
   real(r8), intent(in) :: uco213(pcols,pverp)     <font color=#447700>! CO2 9.4 micron band path length<a name='3748'></font>
   real(r8), intent(in) :: uco221(pcols,pverp)     <font color=#447700>! CO2 10.4 micron band path length<a name='3749'></font>
   real(r8), intent(in) :: uco222(pcols,pverp)     <font color=#447700>! CO2 10.4 micron band path length<a name='3750'></font>
   real(r8), intent(in) :: uco223(pcols,pverp)     <font color=#447700>! CO2 10.4 micron band path length<a name='3751'></font>
   real(r8), intent(in) :: bn2o0(pcols,pverp)      <font color=#447700>! pressure factor for n2o<a name='3752'></font>
   real(r8), intent(in) :: bn2o1(pcols,pverp)      <font color=#447700>! pressure factor for n2o<a name='3753'></font>
   real(r8), intent(in) :: bch4(pcols,pverp)       <font color=#447700>! pressure factor for ch4<a name='3754'></font>
   real(r8), intent(in) :: uptype(pcols,pverp)     <font color=#447700>! p-type continuum path length<a name='3755'></font>
<font color=#447700>!<a name='3756'></font>
<font color=#447700>! Output arguments<a name='3757'></font>
<font color=#447700>!<a name='3758'></font>
   real(r8), intent(out) :: emstot(pcols,pverp)     <font color=#447700>! Total emissivity<a name='3759'></font>
   real(r8), intent(out) :: co2em(pcols,pverp)      <font color=#447700>! Layer co2 normalzd plnck funct drvtv<a name='3760'></font>
   real(r8), intent(out) :: co2eml(pcols,pver)      <font color=#447700>! Intrfc co2 normalzd plnck func drvtv<a name='3761'></font>
   real(r8), intent(out) :: co2t(pcols,pverp)       <font color=#447700>! Tmp and prs weighted path length<a name='3762'></font>
   real(r8), intent(out) :: h2otr(pcols,pverp)      <font color=#447700>! H2o transmission over o3 band<a name='3763'></font>
   real(r8), intent(out) :: abplnk1(14,pcols,pverp) <font color=#447700>! non-nearest layer Plack factor<a name='3764'></font>
   real(r8), intent(out) :: abplnk2(14,pcols,pverp) <font color=#447700>! nearest layer factor<a name='3765'></font>
<a name='3766'>
<font color=#447700>!<a name='3767'></font>
<font color=#447700>!---------------------------Local variables-----------------------------<a name='3768'></font>
<font color=#447700>!<a name='3769'></font>
   integer i                    <font color=#447700>! Longitude index<a name='3770'></font>
   integer k                    <font color=#447700>! Level index]<a name='3771'></font>
   integer k1                   <font color=#447700>! Level index<a name='3772'></font>
<font color=#447700>!<a name='3773'></font>
<font color=#447700>! Local variables for H2O:<a name='3774'></font>
<font color=#447700>!<a name='3775'></font>
   real(r8) h2oems(pcols,pverp)     <font color=#447700>! H2o emissivity<a name='3776'></font>
   real(r8) tpathe                  <font color=#447700>! Used to compute h2o emissivity<a name='3777'></font>
   real(r8) dtx(pcols)              <font color=#447700>! Planck temperature minus 250 K<a name='3778'></font>
   real(r8) dty(pcols)              <font color=#447700>! Path temperature minus 250 K<a name='3779'></font>
<font color=#447700>!<a name='3780'></font>
<font color=#447700>! The 500-800 cm^-1 emission in emis(i,4) has been combined<a name='3781'></font>
<font color=#447700>!              into the 0-800 cm^-1 emission in emis(i,1)<a name='3782'></font>
<font color=#447700>!<a name='3783'></font>
   real(r8) emis(pcols,2)           <font color=#447700>! H2O emissivity <a name='3784'></font>
<font color=#447700>!<a name='3785'></font>
<font color=#447700>!<a name='3786'></font>
<font color=#447700>!<a name='3787'></font>
   real(r8) term7(pcols,2)          <font color=#447700>! Kl_inf(i) in eq(r8) of table A3a of R&amp;D<a name='3788'></font>
   real(r8) term8(pcols,2)          <font color=#447700>! Delta kl_inf(i) in eq(r8)<a name='3789'></font>
   real(r8) tr1(pcols)              <font color=#447700>! Equation(6) in table A2 for 650-800<a name='3790'></font>
   real(r8) tr2(pcols)              <font color=#447700>! Equation(6) in table A2 for 500-650<a name='3791'></font>
   real(r8) tr3(pcols)              <font color=#447700>! Equation(4) in table A2 for 650-800<a name='3792'></font>
   real(r8) tr4(pcols)              <font color=#447700>! Equation(4),table A2 of R&amp;D for 500-650<a name='3793'></font>
   real(r8) tr7(pcols)              <font color=#447700>! Equation (6) times eq(4) in table A2<a name='3794'></font>
<font color=#447700>!                                      of R&amp;D for 650-800 cm-1 region<a name='3795'></font>
   real(r8) tr8(pcols)              <font color=#447700>! Equation (6) times eq(4) in table A2<a name='3796'></font>
<font color=#447700>!                                      of R&amp;D for 500-650 cm-1 region<a name='3797'></font>
   real(r8) k21(pcols)              <font color=#447700>! Exponential coefficient used to calc<a name='3798'></font>
<font color=#447700>!                                     rot band transmissivity in the 650-800<a name='3799'></font>
<font color=#447700>!                                     cm-1 region (tr1)<a name='3800'></font>
   real(r8) k22(pcols)              <font color=#447700>! Exponential coefficient used to calc<a name='3801'></font>
<font color=#447700>!                                     rot band transmissivity in the 500-650<a name='3802'></font>
<font color=#447700>!                                     cm-1 region (tr2)<a name='3803'></font>
   real(r8) u(pcols)                <font color=#447700>! Pressure weighted H2O path length<a name='3804'></font>
   real(r8) ub(nbands)              <font color=#447700>! Pressure weighted H2O path length with<a name='3805'></font>
                                    <font color=#447700>!  Hulst-Curtis-Godson correction for<a name='3806'></font>
                                    <font color=#447700>!  each band<a name='3807'></font>
   real(r8) pnew                    <font color=#447700>! Effective pressure for h2o linewidth<a name='3808'></font>
   real(r8) pnewb(nbands)           <font color=#447700>! Effective pressure for h2o linewidth w/<a name='3809'></font>
                                    <font color=#447700>!  Hulst-Curtis-Godson correction for<a name='3810'></font>
                                    <font color=#447700>!  each band<a name='3811'></font>
   real(r8) uc1(pcols)              <font color=#447700>! H2o continuum pathlength 500-800 cm-1<a name='3812'></font>
   real(r8) fwk                     <font color=#447700>! Equation(33) in R&amp;D far wing correction<a name='3813'></font>
   real(r8) troco2(pcols,pverp)     <font color=#447700>! H2o overlap factor for co2 absorption<a name='3814'></font>
   real(r8) emplnk(14,pcols)        <font color=#447700>! emissivity Planck factor<a name='3815'></font>
   real(r8) emstrc(pcols,pverp)     <font color=#447700>! total trace gas emissivity<a name='3816'></font>
<font color=#447700>!<a name='3817'></font>
<font color=#447700>! Local variables for CO2:<a name='3818'></font>
<font color=#447700>!<a name='3819'></font>
   real(r8) co2ems(pcols,pverp)      <font color=#447700>! Co2 emissivity<a name='3820'></font>
   real(r8) co2plk(pcols)            <font color=#447700>! Used to compute co2 emissivity<a name='3821'></font>
   real(r8) sum(pcols)               <font color=#447700>! Used to calculate path temperature<a name='3822'></font>
   real(r8) t1i                      <font color=#447700>! Co2 hot band temperature factor<a name='3823'></font>
   real(r8) sqti                     <font color=#447700>! Sqrt of temperature<a name='3824'></font>
   real(r8) pi                       <font color=#447700>! Pressure used in co2 mean line width<a name='3825'></font>
   real(r8) et                       <font color=#447700>! Co2 hot band factor<a name='3826'></font>
   real(r8) et2                      <font color=#447700>! Co2 hot band factor<a name='3827'></font>
   real(r8) et4                      <font color=#447700>! Co2 hot band factor<a name='3828'></font>
   real(r8) omet                     <font color=#447700>! Co2 stimulated emission term<a name='3829'></font>
   real(r8) ex                       <font color=#447700>! Part of co2 planck function<a name='3830'></font>
   real(r8) f1co2                    <font color=#447700>! Co2 weak band factor<a name='3831'></font>
   real(r8) f2co2                    <font color=#447700>! Co2 weak band factor<a name='3832'></font>
   real(r8) f3co2                    <font color=#447700>! Co2 weak band factor<a name='3833'></font>
   real(r8) t1co2                    <font color=#447700>! Overlap factor weak bands strong band<a name='3834'></font>
   real(r8) sqwp                     <font color=#447700>! Sqrt of co2 pathlength<a name='3835'></font>
   real(r8) f1sqwp                   <font color=#447700>! Main co2 band factor<a name='3836'></font>
   real(r8) oneme                    <font color=#447700>! Co2 stimulated emission term<a name='3837'></font>
   real(r8) alphat                   <font color=#447700>! Part of the co2 stimulated emiss term<a name='3838'></font>
   real(r8) wco2                     <font color=#447700>! Consts used to define co2 pathlength<a name='3839'></font>
   real(r8) posqt                    <font color=#447700>! Effective pressure for co2 line width<a name='3840'></font>
   real(r8) rbeta7                   <font color=#447700>! Inverse of co2 hot band line width par<a name='3841'></font>
   real(r8) rbeta8                   <font color=#447700>! Inverse of co2 hot band line width par<a name='3842'></font>
   real(r8) rbeta9                   <font color=#447700>! Inverse of co2 hot band line width par<a name='3843'></font>
   real(r8) rbeta13                  <font color=#447700>! Inverse of co2 hot band line width par<a name='3844'></font>
   real(r8) tpath                    <font color=#447700>! Path temp used in co2 band model<a name='3845'></font>
   real(r8) tmp1                     <font color=#447700>! Co2 band factor<a name='3846'></font>
   real(r8) tmp2                     <font color=#447700>! Co2 band factor<a name='3847'></font>
   real(r8) tmp3                     <font color=#447700>! Co2 band factor<a name='3848'></font>
   real(r8) tlayr5                   <font color=#447700>! Temperature factor in co2 Planck func<a name='3849'></font>
   real(r8) rsqti                    <font color=#447700>! Reciprocal of sqrt of temperature<a name='3850'></font>
   real(r8) exm1sq                   <font color=#447700>! Part of co2 Planck function<a name='3851'></font>
   real(r8) u7                       <font color=#447700>! Absorber amt for various co2 band systems<a name='3852'></font>
   real(r8) u8                       <font color=#447700>! Absorber amt for various co2 band systems<a name='3853'></font>
   real(r8) u9                       <font color=#447700>! Absorber amt for various co2 band systems<a name='3854'></font>
   real(r8) u13                      <font color=#447700>! Absorber amt for various co2 band systems<a name='3855'></font>
   real(r8) r250                     <font color=#447700>! Inverse 250K<a name='3856'></font>
   real(r8) r300                     <font color=#447700>! Inverse 300K<a name='3857'></font>
   real(r8) rsslp                    <font color=#447700>! Inverse standard sea-level pressure<a name='3858'></font>
<font color=#447700>!<a name='3859'></font>
<font color=#447700>! Local variables for O3:<a name='3860'></font>
<font color=#447700>!<a name='3861'></font>
   real(r8) o3ems(pcols,pverp)       <font color=#447700>! Ozone emissivity<a name='3862'></font>
   real(r8) dbvtt(pcols)             <font color=#447700>! Tmp drvtv of planck fctn for tplnke<a name='3863'></font>
   real(r8) dbvt,fo3,t,ux,vx<a name='3864'>
   real(r8) te                       <font color=#447700>! Temperature factor<a name='3865'></font>
   real(r8) u1                       <font color=#447700>! Path length factor<a name='3866'></font>
   real(r8) u2                       <font color=#447700>! Path length factor<a name='3867'></font>
   real(r8) phat                     <font color=#447700>! Effecitive path length pressure<a name='3868'></font>
   real(r8) tlocal                   <font color=#447700>! Local planck function temperature<a name='3869'></font>
   real(r8) tcrfac                   <font color=#447700>! Scaled temperature factor<a name='3870'></font>
   real(r8) beta                     <font color=#447700>! Absorption funct factor voigt effect<a name='3871'></font>
   real(r8) realnu                   <font color=#447700>! Absorption function factor<a name='3872'></font>
   real(r8) o3bndi                   <font color=#447700>! Band absorption factor<a name='3873'></font>
<font color=#447700>!<a name='3874'></font>
<font color=#447700>! Transmission terms for various spectral intervals:<a name='3875'></font>
<font color=#447700>!<a name='3876'></font>
   real(r8) absbnd                   <font color=#447700>! Proportional to co2 band absorptance<a name='3877'></font>
   real(r8) tco2(pcols)              <font color=#447700>! co2 overlap factor<a name='3878'></font>
   real(r8) th2o(pcols)              <font color=#447700>! h2o overlap factor<a name='3879'></font>
   real(r8) to3(pcols)               <font color=#447700>! o3 overlap factor<a name='3880'></font>
<font color=#447700>!<a name='3881'></font>
<font color=#447700>! Variables for new H2O parameterization<a name='3882'></font>
<font color=#447700>!<a name='3883'></font>
<font color=#447700>! Notation:<a name='3884'></font>
<font color=#447700>! U   = integral (P/P_0 dW)  eq. 15 in Ramanathan/Downey 1986<a name='3885'></font>
<font color=#447700>! P   = atmospheric pressure<a name='3886'></font>
<font color=#447700>! P_0 = reference atmospheric pressure<a name='3887'></font>
<font color=#447700>! W   = precipitable water path<a name='3888'></font>
<font color=#447700>! T_e = emission temperature<a name='3889'></font>
<font color=#447700>! T_p = path temperature<a name='3890'></font>
<font color=#447700>! RH  = path relative humidity<a name='3891'></font>
<font color=#447700>!<a name='3892'></font>
   real(r8) fe               <font color=#447700>! asymptotic value of emis. as U-&gt;infinity<a name='3893'></font>
   real(r8) e_star           <font color=#447700>! normalized non-window emissivity<a name='3894'></font>
   real(r8) l_star           <font color=#447700>! interpolated line transmission<a name='3895'></font>
   real(r8) c_star           <font color=#447700>! interpolated continuum transmission<a name='3896'></font>
<a name='3897'>
   real(r8) te1              <font color=#447700>! emission temperature<a name='3898'></font>
   real(r8) te2              <font color=#447700>! te^2<a name='3899'></font>
   real(r8) te3              <font color=#447700>! te^3<a name='3900'></font>
   real(r8) te4              <font color=#447700>! te^4<a name='3901'></font>
   real(r8) te5              <font color=#447700>! te^5<a name='3902'></font>
<a name='3903'>
   real(r8) log_u            <font color=#447700>! log base 10 of U <a name='3904'></font>
   real(r8) log_uc           <font color=#447700>! log base 10 of H2O continuum path<a name='3905'></font>
   real(r8) log_p            <font color=#447700>! log base 10 of P<a name='3906'></font>
   real(r8) t_p              <font color=#447700>! T_p<a name='3907'></font>
   real(r8) t_e              <font color=#447700>! T_e (offset by T_p)<a name='3908'></font>
<a name='3909'>
   integer iu                <font color=#447700>! index for log10(U)<a name='3910'></font>
   integer iu1               <font color=#447700>! iu + 1<a name='3911'></font>
   integer iuc               <font color=#447700>! index for log10(H2O continuum path)<a name='3912'></font>
   integer iuc1              <font color=#447700>! iuc + 1<a name='3913'></font>
   integer ip                <font color=#447700>! index for log10(P)<a name='3914'></font>
   integer ip1               <font color=#447700>! ip + 1<a name='3915'></font>
   integer itp               <font color=#447700>! index for T_p<a name='3916'></font>
   integer itp1              <font color=#447700>! itp + 1<a name='3917'></font>
   integer ite               <font color=#447700>! index for T_e<a name='3918'></font>
   integer ite1              <font color=#447700>! ite + 1<a name='3919'></font>
   integer irh               <font color=#447700>! index for RH<a name='3920'></font>
   integer irh1              <font color=#447700>! irh + 1<a name='3921'></font>
<a name='3922'>
   real(r8) dvar             <font color=#447700>! normalized variation in T_p/T_e/P/U<a name='3923'></font>
   real(r8) uvar             <font color=#447700>! U * diffusivity factor<a name='3924'></font>
   real(r8) uscl             <font color=#447700>! factor for lineary scaling as U-&gt;0<a name='3925'></font>
<a name='3926'>
   real(r8) wu               <font color=#447700>! weight for U<a name='3927'></font>
   real(r8) wu1              <font color=#447700>! 1 - wu<a name='3928'></font>
   real(r8) wuc              <font color=#447700>! weight for H2O continuum path<a name='3929'></font>
   real(r8) wuc1             <font color=#447700>! 1 - wuc<a name='3930'></font>
   real(r8) wp               <font color=#447700>! weight for P<a name='3931'></font>
   real(r8) wp1              <font color=#447700>! 1 - wp<a name='3932'></font>
   real(r8) wtp              <font color=#447700>! weight for T_p<a name='3933'></font>
   real(r8) wtp1             <font color=#447700>! 1 - wtp<a name='3934'></font>
   real(r8) wte              <font color=#447700>! weight for T_e<a name='3935'></font>
   real(r8) wte1             <font color=#447700>! 1 - wte<a name='3936'></font>
   real(r8) wrh              <font color=#447700>! weight for RH<a name='3937'></font>
   real(r8) wrh1             <font color=#447700>! 1 - wrh<a name='3938'></font>
<a name='3939'>
   real(r8) w_0_0_           <font color=#447700>! weight for Tp/Te combination<a name='3940'></font>
   real(r8) w_0_1_           <font color=#447700>! weight for Tp/Te combination<a name='3941'></font>
   real(r8) w_1_0_           <font color=#447700>! weight for Tp/Te combination<a name='3942'></font>
   real(r8) w_1_1_           <font color=#447700>! weight for Tp/Te combination<a name='3943'></font>
<a name='3944'>
   real(r8) w_0_00           <font color=#447700>! weight for Tp/Te/RH combination<a name='3945'></font>
   real(r8) w_0_01           <font color=#447700>! weight for Tp/Te/RH combination<a name='3946'></font>
   real(r8) w_0_10           <font color=#447700>! weight for Tp/Te/RH combination<a name='3947'></font>
   real(r8) w_0_11           <font color=#447700>! weight for Tp/Te/RH combination<a name='3948'></font>
   real(r8) w_1_00           <font color=#447700>! weight for Tp/Te/RH combination<a name='3949'></font>
   real(r8) w_1_01           <font color=#447700>! weight for Tp/Te/RH combination<a name='3950'></font>
   real(r8) w_1_10           <font color=#447700>! weight for Tp/Te/RH combination<a name='3951'></font>
   real(r8) w_1_11           <font color=#447700>! weight for Tp/Te/RH combination<a name='3952'></font>
<a name='3953'>
   real(r8) w00_00           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3954'></font>
   real(r8) w00_01           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3955'></font>
   real(r8) w00_10           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3956'></font>
   real(r8) w00_11           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3957'></font>
   real(r8) w01_00           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3958'></font>
   real(r8) w01_01           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3959'></font>
   real(r8) w01_10           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3960'></font>
   real(r8) w01_11           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3961'></font>
   real(r8) w10_00           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3962'></font>
   real(r8) w10_01           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3963'></font>
   real(r8) w10_10           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3964'></font>
   real(r8) w10_11           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3965'></font>
   real(r8) w11_00           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3966'></font>
   real(r8) w11_01           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3967'></font>
   real(r8) w11_10           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3968'></font>
   real(r8) w11_11           <font color=#447700>! weight for P/Tp/Te/RH combination<a name='3969'></font>
<a name='3970'>
   integer ib                <font color=#447700>! spectral interval:<a name='3971'></font>
                             <font color=#447700>!   1 = 0-800 cm^-1 and 1200-2200 cm^-1<a name='3972'></font>
                             <font color=#447700>!   2 = 800-1200 cm^-1<a name='3973'></font>
<a name='3974'>
   real(r8) pch2o            <font color=#447700>! H2O continuum path<a name='3975'></font>
   real(r8) fch2o            <font color=#447700>! temp. factor for continuum<a name='3976'></font>
   real(r8) uch2o            <font color=#447700>! U corresponding to H2O cont. path (window)<a name='3977'></font>
<a name='3978'>
   real(r8) fdif             <font color=#447700>! secant(zenith angle) for diffusivity approx.<a name='3979'></font>
<a name='3980'>
   real(r8) sslp_mks         <font color=#447700>! Sea-level pressure in MKS units<a name='3981'></font>
   real(r8) esx              <font color=#447700>! saturation vapor pressure returned by vqsatd<a name='3982'></font>
   real(r8) qsx              <font color=#447700>! saturation mixing ratio returned by vqsatd<a name='3983'></font>
   real(r8) pnew_mks         <font color=#447700>! pnew in MKS units<a name='3984'></font>
   real(r8) q_path           <font color=#447700>! effective specific humidity along path<a name='3985'></font>
   real(r8) rh_path          <font color=#447700>! effective relative humidity along path<a name='3986'></font>
   real(r8) omeps            <font color=#447700>! 1 - epsilo<a name='3987'></font>
<a name='3988'>
   integer  iest             <font color=#447700>! index in estblh2o<a name='3989'></font>
<a name='3990'>
<font color=#447700>!<a name='3991'></font>
<font color=#447700>!---------------------------Statement functions-------------------------<a name='3992'></font>
<font color=#447700>!<a name='3993'></font>
<font color=#447700>! Derivative of planck function at 9.6 micro-meter wavelength, and<a name='3994'></font>
<font color=#447700>! an absorption function factor:<a name='3995'></font>
<font color=#447700>!<a name='3996'></font>
<font color=#447700>!<a name='3997'></font>
   dbvt(t)=(-2.8911366682e-4+(2.3771251896e-6+1.1305188929e-10*t)*t)/ &amp;<a name='3998'>
           (1.0+(-6.1364820707e-3+1.5550319767e-5*t)*t)<a name='3999'>
<font color=#447700>!<a name='4000'></font>
   fo3(ux,vx)=ux/sqrt(4.+ux*(1.+vx))<a name='4001'>
<font color=#447700>!<a name='4002'></font>
<font color=#447700>!<a name='4003'></font>
<font color=#447700>!<a name='4004'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4005'></font>
<font color=#447700>!<a name='4006'></font>
<font color=#447700>! Initialize<a name='4007'></font>
<font color=#447700>!<a name='4008'></font>
   r250  = 1./250.<a name='4009'>
   r300  = 1./300.<a name='4010'>
   rsslp = 1./sslp<a name='4011'>
<font color=#447700>!<a name='4012'></font>
<font color=#447700>! Constants for computing U corresponding to H2O cont. path<a name='4013'></font>
<font color=#447700>!<a name='4014'></font>
   fdif       = 1.66<a name='4015'>
   sslp_mks   = sslp / 10.0<a name='4016'>
   omeps      = 1.0 - epsilo<a name='4017'>
<font color=#447700>!<a name='4018'></font>
<font color=#447700>! Planck function for co2<a name='4019'></font>
<font color=#447700>!<a name='4020'></font>
   do i=1,ncol<a name='4021'>
      ex             = exp(960./tplnke(i))<a name='4022'>
      co2plk(i)      = 5.e8/((tplnke(i)**4)*(ex - 1.))<a name='4023'>
      co2t(i,ntoplw) = tplnke(i)<a name='4024'>
      sum(i)         = co2t(i,ntoplw)*pnm(i,ntoplw)<a name='4025'>
   end do<a name='4026'>
   k = ntoplw<a name='4027'>
   do k1=pverp,ntoplw+1,-1<a name='4028'>
      k = k + 1<a name='4029'>
      do i=1,ncol<a name='4030'>
         sum(i)         = sum(i) + tlayr(i,k)*(pnm(i,k)-pnm(i,k-1))<a name='4031'>
         ex             = exp(960./tlayr(i,k1))<a name='4032'>
         tlayr5         = tlayr(i,k1)*tlayr4(i,k1)<a name='4033'>
         co2eml(i,k1-1) = 1.2e11*ex/(tlayr5*(ex - 1.)**2)<a name='4034'>
         co2t(i,k)      = sum(i)/pnm(i,k)<a name='4035'>
      end do<a name='4036'>
   end do<a name='4037'>
<font color=#447700>!<a name='4038'></font>
<font color=#447700>! Initialize planck function derivative for O3<a name='4039'></font>
<font color=#447700>!<a name='4040'></font>
   do i=1,ncol<a name='4041'>
      dbvtt(i) = dbvt(tplnke(i))<a name='4042'>
   end do<a name='4043'>
<font color=#447700>!<a name='4044'></font>
<font color=#447700>! Calculate trace gas Planck functions<a name='4045'></font>
<font color=#447700>!<a name='4046'></font>
   call <A href='../../html_code/phys/module_ra_cam_support.F.html#TRCPLK'>trcplk</A><A href='../../html_code/phys/module_ra_cam.F.html#RADEMS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRCPLK_1">(lchnk   ,ncol    ,pcols, pver, pverp,         &amp;<a name='4047'>
               tint    ,tlayr   ,tplnke  ,emplnk  ,abplnk1 , &amp;<a name='4048'>
               abplnk2 )<a name='4049'>
<font color=#447700>!<a name='4050'></font>
<font color=#447700>! Interface loop<a name='4051'></font>
<font color=#447700>!<a name='4052'></font>
   do k1=ntoplw,pverp<a name='4053'>
<font color=#447700>!<a name='4054'></font>
<font color=#447700>! H2O emissivity<a name='4055'></font>
<font color=#447700>!<a name='4056'></font>
<font color=#447700>! emis(i,1)     0 -  800 cm-1   h2o rotation band<a name='4057'></font>
<font color=#447700>! emis(i,1)  1200 - 2200 cm-1   h2o vibration-rotation band<a name='4058'></font>
<font color=#447700>! emis(i,2)   800 - 1200 cm-1   h2o window<a name='4059'></font>
<font color=#447700>!<a name='4060'></font>
<font color=#447700>! Separation between rotation and vibration-rotation dropped, so<a name='4061'></font>
<font color=#447700>!                only 2 slots needed for H2O emissivity<a name='4062'></font>
<font color=#447700>!<a name='4063'></font>
<font color=#447700>!      emis(i,3)   = 0.0<a name='4064'></font>
<font color=#447700>!<a name='4065'></font>
<font color=#447700>! For the p type continuum<a name='4066'></font>
<font color=#447700>!<a name='4067'></font>
      do i=1,ncol<a name='4068'>
         u(i)        = plh2o(i,k1)<a name='4069'>
         pnew        = u(i)/w(i,k1)<a name='4070'>
         pnew_mks    = pnew * sslp_mks<a name='4071'>
<font color=#447700>!<a name='4072'></font>
<font color=#447700>! Apply scaling factor for 500-800 continuum<a name='4073'></font>
<font color=#447700>!<a name='4074'></font>
         uc1(i)      = (s2c(i,k1) + 1.7e-3*plh2o(i,k1))*(1. + 2.*s2c(i,k1))/ &amp;<a name='4075'>
                       (1. + 15.*s2c(i,k1))<a name='4076'>
         pch2o       = s2c(i,k1)<a name='4077'>
<font color=#447700>!<a name='4078'></font>
<font color=#447700>! Changed effective path temperature to std. Curtis-Godson form<a name='4079'></font>
<font color=#447700>!<a name='4080'></font>
         tpathe   = tcg(i,k1)/w(i,k1)<a name='4081'>
         t_p = min(max(tpathe, min_tp_h2o), max_tp_h2o)<a name='4082'>
         iest = floor(t_p) - min_tp_h2o<a name='4083'>
         esx = estblh2o(iest) + (estblh2o(iest+1)-estblh2o(iest)) * &amp;<a name='4084'>
               (t_p - min_tp_h2o - iest)<a name='4085'>
         qsx = epsilo * esx / (pnew_mks - omeps * esx)<a name='4086'>
<font color=#447700>!<a name='4087'></font>
<font color=#447700>! Compute effective RH along path<a name='4088'></font>
<font color=#447700>!<a name='4089'></font>
         q_path = w(i,k1) / pnm(i,k1) / rga<a name='4090'>
<font color=#447700>!<a name='4091'></font>
<font color=#447700>! Calculate effective u, pnew for each band using<a name='4092'></font>
<font color=#447700>!        Hulst-Curtis-Godson approximation:<a name='4093'></font>
<font color=#447700>! Formulae: Goody and Yung, Atmospheric Radiation: Theoretical Basis, <a name='4094'></font>
<font color=#447700>!           2nd edition, Oxford University Press, 1989.<a name='4095'></font>
<font color=#447700>! Effective H2O path (w)<a name='4096'></font>
<font color=#447700>!      eq. 6.24, p. 228<a name='4097'></font>
<font color=#447700>! Effective H2O path pressure (pnew = u/w):<a name='4098'></font>
<font color=#447700>!      eq. 6.29, p. 228<a name='4099'></font>
<font color=#447700>!<a name='4100'></font>
         ub(1) = plh2ob(1,i,k1) / psi(t_p,1)<a name='4101'>
         ub(2) = plh2ob(2,i,k1) / psi(t_p,2)<a name='4102'>
<a name='4103'>
         pnewb(1) = ub(1) / wb(1,i,k1) * phi(t_p,1)<a name='4104'>
         pnewb(2) = ub(2) / wb(2,i,k1) * phi(t_p,2)<a name='4105'>
<font color=#447700>!<a name='4106'></font>
<font color=#447700>!<a name='4107'></font>
<font color=#447700>!<a name='4108'></font>
         dtx(i) = tplnke(i) - 250.<a name='4109'>
         dty(i) = tpathe - 250.<a name='4110'>
<font color=#447700>!<a name='4111'></font>
<font color=#447700>! Define variables for C/H/E (now C/LT/E) fit<a name='4112'></font>
<font color=#447700>!<a name='4113'></font>
<font color=#447700>! emis(i,1)     0 -  800 cm-1   h2o rotation band<a name='4114'></font>
<font color=#447700>! emis(i,1)  1200 - 2200 cm-1   h2o vibration-rotation band<a name='4115'></font>
<font color=#447700>! emis(i,2)   800 - 1200 cm-1   h2o window<a name='4116'></font>
<font color=#447700>!<a name='4117'></font>
<font color=#447700>! Separation between rotation and vibration-rotation dropped, so<a name='4118'></font>
<font color=#447700>!                only 2 slots needed for H2O emissivity<a name='4119'></font>
<font color=#447700>!<a name='4120'></font>
<font color=#447700>! emis(i,3)   = 0.0<a name='4121'></font>
<font color=#447700>!<a name='4122'></font>
<font color=#447700>! Notation:<a name='4123'></font>
<font color=#447700>! U   = integral (P/P_0 dW)  <a name='4124'></font>
<font color=#447700>! P   = atmospheric pressure<a name='4125'></font>
<font color=#447700>! P_0 = reference atmospheric pressure<a name='4126'></font>
<font color=#447700>! W   = precipitable water path<a name='4127'></font>
<font color=#447700>! T_e = emission temperature<a name='4128'></font>
<font color=#447700>! T_p = path temperature<a name='4129'></font>
<font color=#447700>! RH  = path relative humidity<a name='4130'></font>
<font color=#447700>!<a name='4131'></font>
<font color=#447700>! Terms for asymptotic value of emissivity<a name='4132'></font>
<font color=#447700>!<a name='4133'></font>
         te1  = tplnke(i)<a name='4134'>
         te2  = te1 * te1<a name='4135'>
         te3  = te2 * te1<a name='4136'>
         te4  = te3 * te1<a name='4137'>
         te5  = te4 * te1<a name='4138'>
<font color=#447700>!<a name='4139'></font>
<font color=#447700>! Band-independent indices for lines and continuum tables<a name='4140'></font>
<font color=#447700>!<a name='4141'></font>
         dvar = (t_p - min_tp_h2o) / dtp_h2o<a name='4142'>
         itp = min(max(int(aint(dvar,r8)) + 1, 1), n_tp - 1)<a name='4143'>
         itp1 = itp + 1<a name='4144'>
         wtp = dvar - floor(dvar)<a name='4145'>
         wtp1 = 1.0 - wtp<a name='4146'>
<a name='4147'>
         t_e = min(max(tplnke(i) - t_p, min_te_h2o), max_te_h2o)<a name='4148'>
         dvar = (t_e - min_te_h2o) / dte_h2o<a name='4149'>
         ite = min(max(int(aint(dvar,r8)) + 1, 1), n_te - 1)<a name='4150'>
         ite1 = ite + 1<a name='4151'>
         wte = dvar - floor(dvar)<a name='4152'>
         wte1 = 1.0 - wte<a name='4153'>
<a name='4154'>
         rh_path = min(max(q_path / qsx, min_rh_h2o), max_rh_h2o)<a name='4155'>
         dvar = (rh_path - min_rh_h2o) / drh_h2o<a name='4156'>
         irh = min(max(int(aint(dvar,r8)) + 1, 1), n_rh - 1)<a name='4157'>
         irh1 = irh + 1<a name='4158'>
         wrh = dvar - floor(dvar)<a name='4159'>
         wrh1 = 1.0 - wrh<a name='4160'>
<a name='4161'>
         w_0_0_ = wtp  * wte<a name='4162'>
         w_0_1_ = wtp  * wte1<a name='4163'>
         w_1_0_ = wtp1 * wte <a name='4164'>
         w_1_1_ = wtp1 * wte1<a name='4165'>
<a name='4166'>
         w_0_00 = w_0_0_ * wrh<a name='4167'>
         w_0_01 = w_0_0_ * wrh1<a name='4168'>
         w_0_10 = w_0_1_ * wrh<a name='4169'>
         w_0_11 = w_0_1_ * wrh1<a name='4170'>
         w_1_00 = w_1_0_ * wrh<a name='4171'>
         w_1_01 = w_1_0_ * wrh1<a name='4172'>
         w_1_10 = w_1_1_ * wrh<a name='4173'>
         w_1_11 = w_1_1_ * wrh1<a name='4174'>
<font color=#447700>!<a name='4175'></font>
<font color=#447700>! H2O Continuum path for 0-800 and 1200-2200 cm^-1<a name='4176'></font>
<font color=#447700>!<a name='4177'></font>
<font color=#447700>!    Assume foreign continuum dominates total H2O continuum in these bands<a name='4178'></font>
<font color=#447700>!    per Clough et al, JGR, v. 97, no. D14 (Oct 20, 1992), p. 15776<a name='4179'></font>
<font color=#447700>!    Then the effective H2O path is just <a name='4180'></font>
<font color=#447700>!         U_c = integral[ f(P) dW ]<a name='4181'></font>
<font color=#447700>!    where <a name='4182'></font>
<font color=#447700>!           W = water-vapor mass and <a name='4183'></font>
<font color=#447700>!        f(P) = dependence of foreign continuum on pressure <a name='4184'></font>
<font color=#447700>!             = P / sslp<a name='4185'></font>
<font color=#447700>!    Then <a name='4186'></font>
<font color=#447700>!         U_c = U (the same effective H2O path as for lines)<a name='4187'></font>
<font color=#447700>!<a name='4188'></font>
<font color=#447700>!<a name='4189'></font>
<font color=#447700>! Continuum terms for 800-1200 cm^-1<a name='4190'></font>
<font color=#447700>!<a name='4191'></font>
<font color=#447700>!    Assume self continuum dominates total H2O continuum for this band<a name='4192'></font>
<font color=#447700>!    per Clough et al, JGR, v. 97, no. D14 (Oct 20, 1992), p. 15776<a name='4193'></font>
<font color=#447700>!    Then the effective H2O self-continuum path is <a name='4194'></font>
<font color=#447700>!         U_c = integral[ h(e,T) dW ]                        (*eq. 1*)<a name='4195'></font>
<font color=#447700>!    where <a name='4196'></font>
<font color=#447700>!           W = water-vapor mass and <a name='4197'></font>
<font color=#447700>!           e = partial pressure of H2O along path<a name='4198'></font>
<font color=#447700>!           T = temperature along path<a name='4199'></font>
<font color=#447700>!      h(e,T) = dependence of foreign continuum on e,T<a name='4200'></font>
<font color=#447700>!             = e / sslp * f(T)<a name='4201'></font>
<font color=#447700>!<a name='4202'></font>
<font color=#447700>!    Replacing<a name='4203'></font>
<font color=#447700>!           e =~ q * P / epsilo<a name='4204'></font>
<font color=#447700>!           q = mixing ratio of H2O<a name='4205'></font>
<font color=#447700>!     epsilo = 0.622<a name='4206'></font>
<font color=#447700>!<a name='4207'></font>
<font color=#447700>!    and using the definition<a name='4208'></font>
<font color=#447700>!           U = integral [ (P / sslp) dW ]<a name='4209'></font>
<font color=#447700>!             = (P / sslp) W                                 (homogeneous path)<a name='4210'></font>
<font color=#447700>!<a name='4211'></font>
<font color=#447700>!    the effective path length for the self continuum is<a name='4212'></font>
<font color=#447700>!         U_c = (q / epsilo) f(T) U                         (*eq. 2*)<a name='4213'></font>
<font color=#447700>!<a name='4214'></font>
<font color=#447700>!    Once values of T, U, and q have been calculated for the inhomogeneous<a name='4215'></font>
<font color=#447700>!        path, this sets U_c for the corresponding<a name='4216'></font>
<font color=#447700>!        homogeneous atmosphere.  However, this need not equal the<a name='4217'></font>
<font color=#447700>!        value of U_c' defined by eq. 1 for the actual inhomogeneous atmosphere<a name='4218'></font>
<font color=#447700>!        under consideration.<a name='4219'></font>
<font color=#447700>!<a name='4220'></font>
<font color=#447700>!    Solution: hold T and q constant, solve for U' that gives U_c' by<a name='4221'></font>
<font color=#447700>!        inverting eq. (2):<a name='4222'></font>
<font color=#447700>!<a name='4223'></font>
<font color=#447700>!        U' = (U_c * epsilo) / (q * f(T))<a name='4224'></font>
<font color=#447700>!<a name='4225'></font>
         fch2o = <A href='../../html_code/phys/module_ra_cam_support.F.html#FH2OSELF'>fh2oself</A><A href='../../html_code/phys/module_ra_cam.F.html#RADEMS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FH2OSELF_2">(t_p)<a name='4226'>
         uch2o = (pch2o * epsilo) / (q_path * fch2o)<a name='4227'>
<a name='4228'>
<font color=#447700>!<a name='4229'></font>
<font color=#447700>! Band-dependent indices for non-window<a name='4230'></font>
<font color=#447700>!<a name='4231'></font>
         ib = 1<a name='4232'>
<a name='4233'>
         uvar = ub(ib) * fdif<a name='4234'>
         log_u  = min(log10(max(uvar, min_u_h2o)), max_lu_h2o)<a name='4235'>
         dvar = (log_u - min_lu_h2o) / dlu_h2o<a name='4236'>
         iu = min(max(int(aint(dvar,r8)) + 1, 1), n_u - 1)<a name='4237'>
         iu1 = iu + 1<a name='4238'>
         wu = dvar - floor(dvar)<a name='4239'>
         wu1 = 1.0 - wu<a name='4240'>
         <a name='4241'>
         log_p  = min(log10(max(pnewb(ib), min_p_h2o)), max_lp_h2o)<a name='4242'>
         dvar = (log_p - min_lp_h2o) / dlp_h2o<a name='4243'>
         ip = min(max(int(aint(dvar,r8)) + 1, 1), n_p - 1)<a name='4244'>
         ip1 = ip + 1<a name='4245'>
         wp = dvar - floor(dvar)<a name='4246'>
         wp1 = 1.0 - wp<a name='4247'>
<a name='4248'>
         w00_00 = wp  * w_0_00 <a name='4249'>
         w00_01 = wp  * w_0_01 <a name='4250'>
         w00_10 = wp  * w_0_10 <a name='4251'>
         w00_11 = wp  * w_0_11 <a name='4252'>
         w01_00 = wp  * w_1_00 <a name='4253'>
         w01_01 = wp  * w_1_01 <a name='4254'>
         w01_10 = wp  * w_1_10 <a name='4255'>
         w01_11 = wp  * w_1_11 <a name='4256'>
         w10_00 = wp1 * w_0_00 <a name='4257'>
         w10_01 = wp1 * w_0_01 <a name='4258'>
         w10_10 = wp1 * w_0_10 <a name='4259'>
         w10_11 = wp1 * w_0_11 <a name='4260'>
         w11_00 = wp1 * w_1_00 <a name='4261'>
         w11_01 = wp1 * w_1_01 <a name='4262'>
         w11_10 = wp1 * w_1_10 <a name='4263'>
         w11_11 = wp1 * w_1_11 <a name='4264'>
<a name='4265'>
<font color=#447700>!<a name='4266'></font>
<font color=#447700>! Asymptotic value of emissivity as U-&gt;infinity<a name='4267'></font>
<font color=#447700>!<a name='4268'></font>
         fe = fet(1,ib) + &amp;<a name='4269'>
              fet(2,ib) * te1 + &amp;<a name='4270'>
              fet(3,ib) * te2 + &amp;<a name='4271'>
              fet(4,ib) * te3 + &amp;<a name='4272'>
              fet(5,ib) * te4 + &amp;<a name='4273'>
              fet(6,ib) * te5<a name='4274'>
<a name='4275'>
         e_star = &amp;<a name='4276'>
              eh2onw(ip , itp , iu , ite , irh ) * w11_11 * wu1 + &amp;<a name='4277'>
              eh2onw(ip , itp , iu , ite , irh1) * w11_10 * wu1 + &amp;<a name='4278'>
              eh2onw(ip , itp , iu , ite1, irh ) * w11_01 * wu1 + &amp;<a name='4279'>
              eh2onw(ip , itp , iu , ite1, irh1) * w11_00 * wu1 + &amp;<a name='4280'>
              eh2onw(ip , itp , iu1, ite , irh ) * w11_11 * wu  + &amp;<a name='4281'>
              eh2onw(ip , itp , iu1, ite , irh1) * w11_10 * wu  + &amp;<a name='4282'>
              eh2onw(ip , itp , iu1, ite1, irh ) * w11_01 * wu  + &amp;<a name='4283'>
              eh2onw(ip , itp , iu1, ite1, irh1) * w11_00 * wu  + &amp;<a name='4284'>
              eh2onw(ip , itp1, iu , ite , irh ) * w10_11 * wu1 + &amp;<a name='4285'>
              eh2onw(ip , itp1, iu , ite , irh1) * w10_10 * wu1 + &amp;<a name='4286'>
              eh2onw(ip , itp1, iu , ite1, irh ) * w10_01 * wu1 + &amp;<a name='4287'>
              eh2onw(ip , itp1, iu , ite1, irh1) * w10_00 * wu1 + &amp;<a name='4288'>
              eh2onw(ip , itp1, iu1, ite , irh ) * w10_11 * wu  + &amp;<a name='4289'>
              eh2onw(ip , itp1, iu1, ite , irh1) * w10_10 * wu  + &amp;<a name='4290'>
              eh2onw(ip , itp1, iu1, ite1, irh ) * w10_01 * wu  + &amp;<a name='4291'>
              eh2onw(ip , itp1, iu1, ite1, irh1) * w10_00 * wu  + &amp;<a name='4292'>
              eh2onw(ip1, itp , iu , ite , irh ) * w01_11 * wu1 + &amp;<a name='4293'>
              eh2onw(ip1, itp , iu , ite , irh1) * w01_10 * wu1 + &amp;<a name='4294'>
              eh2onw(ip1, itp , iu , ite1, irh ) * w01_01 * wu1 + &amp;<a name='4295'>
              eh2onw(ip1, itp , iu , ite1, irh1) * w01_00 * wu1 + &amp;<a name='4296'>
              eh2onw(ip1, itp , iu1, ite , irh ) * w01_11 * wu  + &amp;<a name='4297'>
              eh2onw(ip1, itp , iu1, ite , irh1) * w01_10 * wu  + &amp;<a name='4298'>
              eh2onw(ip1, itp , iu1, ite1, irh ) * w01_01 * wu  + &amp;<a name='4299'>
              eh2onw(ip1, itp , iu1, ite1, irh1) * w01_00 * wu  + &amp;<a name='4300'>
              eh2onw(ip1, itp1, iu , ite , irh ) * w00_11 * wu1 + &amp;<a name='4301'>
              eh2onw(ip1, itp1, iu , ite , irh1) * w00_10 * wu1 + &amp;<a name='4302'>
              eh2onw(ip1, itp1, iu , ite1, irh ) * w00_01 * wu1 + &amp;<a name='4303'>
              eh2onw(ip1, itp1, iu , ite1, irh1) * w00_00 * wu1 + &amp;<a name='4304'>
              eh2onw(ip1, itp1, iu1, ite , irh ) * w00_11 * wu  + &amp;<a name='4305'>
              eh2onw(ip1, itp1, iu1, ite , irh1) * w00_10 * wu  + &amp;<a name='4306'>
              eh2onw(ip1, itp1, iu1, ite1, irh ) * w00_01 * wu  + &amp;<a name='4307'>
              eh2onw(ip1, itp1, iu1, ite1, irh1) * w00_00 * wu <a name='4308'>
         emis(i,ib) = min(max(fe * (1.0 - (1.0 - e_star) * &amp;<a name='4309'>
                              aer_trn_ttl(i,k1,1,ib)), &amp;<a name='4310'>
                          0.0_r8), 1.0_r8)<a name='4311'>
<font color=#447700>!<a name='4312'></font>
<font color=#447700>! Invoke linear limit for scaling wrt u below min_u_h2o<a name='4313'></font>
<font color=#447700>!<a name='4314'></font>
         if (uvar &lt; min_u_h2o) then<a name='4315'>
            uscl = uvar / min_u_h2o<a name='4316'>
            emis(i,ib) = emis(i,ib) * uscl<a name='4317'>
         endif<a name='4318'>
<a name='4319'>
                      <a name='4320'>
<a name='4321'>
<font color=#447700>!<a name='4322'></font>
<font color=#447700>! Band-dependent indices for window<a name='4323'></font>
<font color=#447700>!<a name='4324'></font>
         ib = 2<a name='4325'>
<a name='4326'>
         uvar = ub(ib) * fdif<a name='4327'>
         log_u  = min(log10(max(uvar, min_u_h2o)), max_lu_h2o)<a name='4328'>
         dvar = (log_u - min_lu_h2o) / dlu_h2o<a name='4329'>
         iu = min(max(int(aint(dvar,r8)) + 1, 1), n_u - 1)<a name='4330'>
         iu1 = iu + 1<a name='4331'>
         wu = dvar - floor(dvar)<a name='4332'>
         wu1 = 1.0 - wu<a name='4333'>
         <a name='4334'>
         log_p  = min(log10(max(pnewb(ib), min_p_h2o)), max_lp_h2o)<a name='4335'>
         dvar = (log_p - min_lp_h2o) / dlp_h2o<a name='4336'>
         ip = min(max(int(aint(dvar,r8)) + 1, 1), n_p - 1)<a name='4337'>
         ip1 = ip + 1<a name='4338'>
         wp = dvar - floor(dvar)<a name='4339'>
         wp1 = 1.0 - wp<a name='4340'>
<a name='4341'>
         w00_00 = wp  * w_0_00 <a name='4342'>
         w00_01 = wp  * w_0_01 <a name='4343'>
         w00_10 = wp  * w_0_10 <a name='4344'>
         w00_11 = wp  * w_0_11 <a name='4345'>
         w01_00 = wp  * w_1_00 <a name='4346'>
         w01_01 = wp  * w_1_01 <a name='4347'>
         w01_10 = wp  * w_1_10 <a name='4348'>
         w01_11 = wp  * w_1_11 <a name='4349'>
         w10_00 = wp1 * w_0_00 <a name='4350'>
         w10_01 = wp1 * w_0_01 <a name='4351'>
         w10_10 = wp1 * w_0_10 <a name='4352'>
         w10_11 = wp1 * w_0_11 <a name='4353'>
         w11_00 = wp1 * w_1_00 <a name='4354'>
         w11_01 = wp1 * w_1_01 <a name='4355'>
         w11_10 = wp1 * w_1_10 <a name='4356'>
         w11_11 = wp1 * w_1_11 <a name='4357'>
<a name='4358'>
         log_uc  = min(log10(max(uch2o * fdif, min_u_h2o)), max_lu_h2o)<a name='4359'>
         dvar = (log_uc - min_lu_h2o) / dlu_h2o<a name='4360'>
         iuc = min(max(int(aint(dvar,r8)) + 1, 1), n_u - 1)<a name='4361'>
         iuc1 = iuc + 1<a name='4362'>
         wuc = dvar - floor(dvar)<a name='4363'>
         wuc1 = 1.0 - wuc<a name='4364'>
<font color=#447700>!<a name='4365'></font>
<font color=#447700>! Asymptotic value of emissivity as U-&gt;infinity<a name='4366'></font>
<font color=#447700>!<a name='4367'></font>
         fe = fet(1,ib) + &amp;<a name='4368'>
              fet(2,ib) * te1 + &amp;<a name='4369'>
              fet(3,ib) * te2 + &amp;<a name='4370'>
              fet(4,ib) * te3 + &amp;<a name='4371'>
              fet(5,ib) * te4 + &amp;<a name='4372'>
              fet(6,ib) * te5<a name='4373'>
<a name='4374'>
         l_star = &amp;<a name='4375'>
              ln_eh2ow(ip , itp , iu , ite , irh ) * w11_11 * wu1 + &amp;<a name='4376'>
              ln_eh2ow(ip , itp , iu , ite , irh1) * w11_10 * wu1 + &amp;<a name='4377'>
              ln_eh2ow(ip , itp , iu , ite1, irh ) * w11_01 * wu1 + &amp;<a name='4378'>
              ln_eh2ow(ip , itp , iu , ite1, irh1) * w11_00 * wu1 + &amp;<a name='4379'>
              ln_eh2ow(ip , itp , iu1, ite , irh ) * w11_11 * wu  + &amp;<a name='4380'>
              ln_eh2ow(ip , itp , iu1, ite , irh1) * w11_10 * wu  + &amp;<a name='4381'>
              ln_eh2ow(ip , itp , iu1, ite1, irh ) * w11_01 * wu  + &amp;<a name='4382'>
              ln_eh2ow(ip , itp , iu1, ite1, irh1) * w11_00 * wu  + &amp;<a name='4383'>
              ln_eh2ow(ip , itp1, iu , ite , irh ) * w10_11 * wu1 + &amp;<a name='4384'>
              ln_eh2ow(ip , itp1, iu , ite , irh1) * w10_10 * wu1 + &amp;<a name='4385'>
              ln_eh2ow(ip , itp1, iu , ite1, irh ) * w10_01 * wu1 + &amp;<a name='4386'>
              ln_eh2ow(ip , itp1, iu , ite1, irh1) * w10_00 * wu1 + &amp;<a name='4387'>
              ln_eh2ow(ip , itp1, iu1, ite , irh ) * w10_11 * wu  + &amp;<a name='4388'>
              ln_eh2ow(ip , itp1, iu1, ite , irh1) * w10_10 * wu  + &amp;<a name='4389'>
              ln_eh2ow(ip , itp1, iu1, ite1, irh ) * w10_01 * wu  + &amp;<a name='4390'>
              ln_eh2ow(ip , itp1, iu1, ite1, irh1) * w10_00 * wu  + &amp;<a name='4391'>
              ln_eh2ow(ip1, itp , iu , ite , irh ) * w01_11 * wu1 + &amp;<a name='4392'>
              ln_eh2ow(ip1, itp , iu , ite , irh1) * w01_10 * wu1 + &amp;<a name='4393'>
              ln_eh2ow(ip1, itp , iu , ite1, irh ) * w01_01 * wu1 + &amp;<a name='4394'>
              ln_eh2ow(ip1, itp , iu , ite1, irh1) * w01_00 * wu1 + &amp;<a name='4395'>
              ln_eh2ow(ip1, itp , iu1, ite , irh ) * w01_11 * wu  + &amp;<a name='4396'>
              ln_eh2ow(ip1, itp , iu1, ite , irh1) * w01_10 * wu  + &amp;<a name='4397'>
              ln_eh2ow(ip1, itp , iu1, ite1, irh ) * w01_01 * wu  + &amp;<a name='4398'>
              ln_eh2ow(ip1, itp , iu1, ite1, irh1) * w01_00 * wu  + &amp;<a name='4399'>
              ln_eh2ow(ip1, itp1, iu , ite , irh ) * w00_11 * wu1 + &amp;<a name='4400'>
              ln_eh2ow(ip1, itp1, iu , ite , irh1) * w00_10 * wu1 + &amp;<a name='4401'>
              ln_eh2ow(ip1, itp1, iu , ite1, irh ) * w00_01 * wu1 + &amp;<a name='4402'>
              ln_eh2ow(ip1, itp1, iu , ite1, irh1) * w00_00 * wu1 + &amp;<a name='4403'>
              ln_eh2ow(ip1, itp1, iu1, ite , irh ) * w00_11 * wu  + &amp;<a name='4404'>
              ln_eh2ow(ip1, itp1, iu1, ite , irh1) * w00_10 * wu  + &amp;<a name='4405'>
              ln_eh2ow(ip1, itp1, iu1, ite1, irh ) * w00_01 * wu  + &amp;<a name='4406'>
              ln_eh2ow(ip1, itp1, iu1, ite1, irh1) * w00_00 * wu <a name='4407'>
<a name='4408'>
         c_star = &amp;<a name='4409'>
              cn_eh2ow(ip , itp , iuc , ite , irh ) * w11_11 * wuc1 + &amp;<a name='4410'>
              cn_eh2ow(ip , itp , iuc , ite , irh1) * w11_10 * wuc1 + &amp;<a name='4411'>
              cn_eh2ow(ip , itp , iuc , ite1, irh ) * w11_01 * wuc1 + &amp;<a name='4412'>
              cn_eh2ow(ip , itp , iuc , ite1, irh1) * w11_00 * wuc1 + &amp;<a name='4413'>
              cn_eh2ow(ip , itp , iuc1, ite , irh ) * w11_11 * wuc  + &amp;<a name='4414'>
              cn_eh2ow(ip , itp , iuc1, ite , irh1) * w11_10 * wuc  + &amp;<a name='4415'>
              cn_eh2ow(ip , itp , iuc1, ite1, irh ) * w11_01 * wuc  + &amp;<a name='4416'>
              cn_eh2ow(ip , itp , iuc1, ite1, irh1) * w11_00 * wuc  + &amp;<a name='4417'>
              cn_eh2ow(ip , itp1, iuc , ite , irh ) * w10_11 * wuc1 + &amp;<a name='4418'>
              cn_eh2ow(ip , itp1, iuc , ite , irh1) * w10_10 * wuc1 + &amp;<a name='4419'>
              cn_eh2ow(ip , itp1, iuc , ite1, irh ) * w10_01 * wuc1 + &amp;<a name='4420'>
              cn_eh2ow(ip , itp1, iuc , ite1, irh1) * w10_00 * wuc1 + &amp;<a name='4421'>
              cn_eh2ow(ip , itp1, iuc1, ite , irh ) * w10_11 * wuc  + &amp;<a name='4422'>
              cn_eh2ow(ip , itp1, iuc1, ite , irh1) * w10_10 * wuc  + &amp;<a name='4423'>
              cn_eh2ow(ip , itp1, iuc1, ite1, irh ) * w10_01 * wuc  + &amp;<a name='4424'>
              cn_eh2ow(ip , itp1, iuc1, ite1, irh1) * w10_00 * wuc  + &amp;<a name='4425'>
              cn_eh2ow(ip1, itp , iuc , ite , irh ) * w01_11 * wuc1 + &amp;<a name='4426'>
              cn_eh2ow(ip1, itp , iuc , ite , irh1) * w01_10 * wuc1 + &amp;<a name='4427'>
              cn_eh2ow(ip1, itp , iuc , ite1, irh ) * w01_01 * wuc1 + &amp;<a name='4428'>
              cn_eh2ow(ip1, itp , iuc , ite1, irh1) * w01_00 * wuc1 + &amp;<a name='4429'>
              cn_eh2ow(ip1, itp , iuc1, ite , irh ) * w01_11 * wuc  + &amp;<a name='4430'>
              cn_eh2ow(ip1, itp , iuc1, ite , irh1) * w01_10 * wuc  + &amp;<a name='4431'>
              cn_eh2ow(ip1, itp , iuc1, ite1, irh ) * w01_01 * wuc  + &amp;<a name='4432'>
              cn_eh2ow(ip1, itp , iuc1, ite1, irh1) * w01_00 * wuc  + &amp;<a name='4433'>
              cn_eh2ow(ip1, itp1, iuc , ite , irh ) * w00_11 * wuc1 + &amp;<a name='4434'>
              cn_eh2ow(ip1, itp1, iuc , ite , irh1) * w00_10 * wuc1 + &amp;<a name='4435'>
              cn_eh2ow(ip1, itp1, iuc , ite1, irh ) * w00_01 * wuc1 + &amp;<a name='4436'>
              cn_eh2ow(ip1, itp1, iuc , ite1, irh1) * w00_00 * wuc1 + &amp;<a name='4437'>
              cn_eh2ow(ip1, itp1, iuc1, ite , irh ) * w00_11 * wuc  + &amp;<a name='4438'>
              cn_eh2ow(ip1, itp1, iuc1, ite , irh1) * w00_10 * wuc  + &amp;<a name='4439'>
              cn_eh2ow(ip1, itp1, iuc1, ite1, irh ) * w00_01 * wuc  + &amp;<a name='4440'>
              cn_eh2ow(ip1, itp1, iuc1, ite1, irh1) * w00_00 * wuc <a name='4441'>
         emis(i,ib) = min(max(fe * (1.0 - l_star * c_star * &amp;<a name='4442'>
                              aer_trn_ttl(i,k1,1,ib)), &amp;<a name='4443'>
                          0.0_r8), 1.0_r8) <a name='4444'>
<font color=#447700>!<a name='4445'></font>
<font color=#447700>! Invoke linear limit for scaling wrt u below min_u_h2o<a name='4446'></font>
<font color=#447700>!<a name='4447'></font>
         if (uvar &lt; min_u_h2o) then<a name='4448'>
            uscl = uvar / min_u_h2o<a name='4449'>
            emis(i,ib) = emis(i,ib) * uscl<a name='4450'>
         endif<a name='4451'>
<a name='4452'>
                      <a name='4453'>
<font color=#447700>!<a name='4454'></font>
<font color=#447700>! Compute total emissivity for H2O<a name='4455'></font>
<font color=#447700>!<a name='4456'></font>
         h2oems(i,k1) = emis(i,1)+emis(i,2)<a name='4457'>
<a name='4458'>
      end do<a name='4459'>
<font color=#447700>!<a name='4460'></font>
<font color=#447700>!<a name='4461'></font>
<font color=#447700>!<a name='4462'></font>
<a name='4463'>
      do i=1,ncol<a name='4464'>
         term7(i,1) = coefj(1,1) + coefj(2,1)*dty(i)*(1.+c16*dty(i))<a name='4465'>
         term8(i,1) = coefk(1,1) + coefk(2,1)*dty(i)*(1.+c17*dty(i))<a name='4466'>
         term7(i,2) = coefj(1,2) + coefj(2,2)*dty(i)*(1.+c26*dty(i))<a name='4467'>
         term8(i,2) = coefk(1,2) + coefk(2,2)*dty(i)*(1.+c27*dty(i))<a name='4468'>
      end do<a name='4469'>
      do i=1,ncol<a name='4470'>
<font color=#447700>!<a name='4471'></font>
<font color=#447700>! 500 -  800 cm-1   rotation band overlap with co2<a name='4472'></font>
<font color=#447700>!<a name='4473'></font>
         k21(i) = term7(i,1) + term8(i,1)/ &amp;<a name='4474'>
                 (1. + (c30 + c31*(dty(i)-10.)*(dty(i)-10.))*sqrt(u(i)))<a name='4475'>
         k22(i) = term7(i,2) + term8(i,2)/ &amp;<a name='4476'>
                 (1. + (c28 + c29*(dty(i)-10.))*sqrt(u(i)))<a name='4477'>
         fwk    = fwcoef + fwc1/(1.+fwc2*u(i))<a name='4478'>
         tr1(i) = exp(-(k21(i)*(sqrt(u(i)) + fc1*fwk*u(i))))<a name='4479'>
         tr2(i) = exp(-(k22(i)*(sqrt(u(i)) + fc1*fwk*u(i))))<a name='4480'>
         tr1(i)=tr1(i)*aer_trn_ttl(i,k1,1,idx_LW_0650_0800) <a name='4481'>
<font color=#447700>!                                            ! H2O line+aer trn 650--800 cm-1<a name='4482'></font>
         tr2(i)=tr2(i)*aer_trn_ttl(i,k1,1,idx_LW_0500_0650) <a name='4483'>
<font color=#447700>!                                            ! H2O line+aer trn 500--650 cm-1<a name='4484'></font>
         tr3(i) = exp(-((coefh(1,1) + coefh(2,1)*dtx(i))*uc1(i)))<a name='4485'>
         tr4(i) = exp(-((coefh(1,2) + coefh(2,2)*dtx(i))*uc1(i)))<a name='4486'>
         tr7(i) = tr1(i)*tr3(i)<a name='4487'>
         tr8(i) = tr2(i)*tr4(i)<a name='4488'>
         troco2(i,k1) = 0.65*tr7(i) + 0.35*tr8(i)<a name='4489'>
         th2o(i) = tr8(i)<a name='4490'>
      end do<a name='4491'>
<font color=#447700>!<a name='4492'></font>
<font color=#447700>! CO2 emissivity for 15 micron band system<a name='4493'></font>
<font color=#447700>!<a name='4494'></font>
      do i=1,ncol<a name='4495'>
         t1i    = exp(-480./co2t(i,k1))<a name='4496'>
         sqti   = sqrt(co2t(i,k1))<a name='4497'>
         rsqti  = 1./sqti<a name='4498'>
         et     = t1i<a name='4499'>
         et2    = et*et<a name='4500'>
         et4    = et2*et2<a name='4501'>
         omet   = 1. - 1.5*et2<a name='4502'>
         f1co2  = 899.70*omet*(1. + 1.94774*et + 4.73486*et2)*rsqti<a name='4503'>
         sqwp   = sqrt(plco2(i,k1))<a name='4504'>
         f1sqwp = f1co2*sqwp<a name='4505'>
         t1co2  = 1./(1. + 245.18*omet*sqwp*rsqti)<a name='4506'>
         oneme  = 1. - et2<a name='4507'>
         alphat = oneme**3*rsqti<a name='4508'>
         wco2   = 2.5221*co2vmr*pnm(i,k1)*rga<a name='4509'>
         u7     = 4.9411e4*alphat*et2*wco2<a name='4510'>
         u8     = 3.9744e4*alphat*et4*wco2<a name='4511'>
         u9     = 1.0447e5*alphat*et4*et2*wco2<a name='4512'>
         u13    = 2.8388e3*alphat*et4*wco2<a name='4513'>
<font color=#447700>!<a name='4514'></font>
         tpath  = co2t(i,k1)<a name='4515'>
         tlocal = tplnke(i)<a name='4516'>
         tcrfac = sqrt((tlocal*r250)*(tpath*r300))<a name='4517'>
         pi     = pnm(i,k1)*rsslp + 2.*dpfco2*tcrfac<a name='4518'>
         posqt  = pi/(2.*sqti)<a name='4519'>
         rbeta7 =  1./( 5.3288*posqt)<a name='4520'>
         rbeta8 = 1./ (10.6576*posqt)<a name='4521'>
         rbeta9 = rbeta7<a name='4522'>
         rbeta13= rbeta9<a name='4523'>
         f2co2  = (u7/sqrt(4. + u7*(1. + rbeta7))) + &amp;<a name='4524'>
                  (u8/sqrt(4. + u8*(1. + rbeta8))) + &amp;<a name='4525'>
                  (u9/sqrt(4. + u9*(1. + rbeta9)))<a name='4526'>
         f3co2  = u13/sqrt(4. + u13*(1. + rbeta13))<a name='4527'>
         tmp1   = log(1. + f1sqwp)<a name='4528'>
         tmp2   = log(1. +  f2co2)<a name='4529'>
         tmp3   = log(1. +  f3co2)<a name='4530'>
         absbnd = (tmp1 + 2.*t1co2*tmp2 + 2.*tmp3)*sqti<a name='4531'>
         tco2(i)=1.0/(1.0+10.0*(u7/sqrt(4. + u7*(1. + rbeta7))))<a name='4532'>
         co2ems(i,k1)  = troco2(i,k1)*absbnd*co2plk(i)<a name='4533'>
         ex     = exp(960./tint(i,k1))<a name='4534'>
         exm1sq = (ex - 1.)**2<a name='4535'>
         co2em(i,k1) = 1.2e11*ex/(tint(i,k1)*tint4(i,k1)*exm1sq)<a name='4536'>
      end do<a name='4537'>
<font color=#447700>!<a name='4538'></font>
<font color=#447700>! O3 emissivity<a name='4539'></font>
<font color=#447700>!<a name='4540'></font>
      do i=1,ncol<a name='4541'>
         h2otr(i,k1) = exp(-12.*s2c(i,k1))<a name='4542'>
          h2otr(i,k1)=h2otr(i,k1)*aer_trn_ttl(i,k1,1,idx_LW_1000_1200)<a name='4543'>
         te          = (co2t(i,k1)/293.)**.7<a name='4544'>
         u1          = 18.29*plos(i,k1)/te<a name='4545'>
         u2          = .5649*plos(i,k1)/te<a name='4546'>
         phat        = plos(i,k1)/plol(i,k1)<a name='4547'>
         tlocal      = tplnke(i)<a name='4548'>
         tcrfac      = sqrt(tlocal*r250)*te<a name='4549'>
         beta        = (1./.3205)*((1./phat) + (dpfo3*tcrfac))<a name='4550'>
         realnu      = (1./beta)*te<a name='4551'>
         o3bndi      = 74.*te*(tplnke(i)/375.)*log(1. + fo3(u1,realnu) + fo3(u2,realnu))<a name='4552'>
         o3ems(i,k1) = dbvtt(i)*h2otr(i,k1)*o3bndi<a name='4553'>
         to3(i)=1.0/(1. + 0.1*fo3(u1,realnu) + 0.1*fo3(u2,realnu))<a name='4554'>
      end do<a name='4555'>
<font color=#447700>!<a name='4556'></font>
<font color=#447700>!   Calculate trace gas emissivities<a name='4557'></font>
<font color=#447700>!<a name='4558'></font>
      call <A href='../../html_code/phys/module_ra_cam_support.F.html#TRCEMS'>trcems</A><A href='../../html_code/phys/module_ra_cam.F.html#RADEMS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRCEMS_1">(lchnk   ,ncol    ,pcols, pverp,               &amp;<a name='4559'>
                  k1      ,co2t    ,pnm     ,ucfc11  ,ucfc12  , &amp;<a name='4560'>
                  un2o0   ,un2o1   ,bn2o0   ,bn2o1   ,uch4    , &amp;<a name='4561'>
                  bch4    ,uco211  ,uco212  ,uco213  ,uco221  , &amp;<a name='4562'>
                  uco222  ,uco223  ,uptype  ,w       ,s2c     , &amp;<a name='4563'>
                  u       ,emplnk  ,th2o    ,tco2    ,to3     , &amp;<a name='4564'>
                  emstrc  , &amp;<a name='4565'>
                  aer_trn_ttl)<a name='4566'>
<font color=#447700>!<a name='4567'></font>
<font color=#447700>! Total emissivity:<a name='4568'></font>
<font color=#447700>!<a name='4569'></font>
      do i=1,ncol<a name='4570'>
         emstot(i,k1) = h2oems(i,k1) + co2ems(i,k1) + o3ems(i,k1)  &amp;<a name='4571'>
                        + emstrc(i,k1)<a name='4572'>
      end do<a name='4573'>
   end do <font color=#447700>! End of interface loop<a name='4574'></font>
<a name='4575'>
   return<a name='4576'>
end subroutine radems<a name='4577'>
<a name='4578'>
<A NAME='RADTPL'><A href='../../html_code/phys/module_ra_cam.F.html#RADTPL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4579'>
<font color=#993300>subroutine </font><font color=#cc0000>radtpl</font>(lchnk   ,ncol    ,pcols, pver, pverp,                 &amp; <A href='../../call_to/RADTPL.html' TARGET='index'>1</A><a name='4580'>
                  tnm     ,lwupcgs ,qnm     ,pnm     ,plco2   ,plh2o   , &amp;<a name='4581'>
                  tplnka  ,s2c     ,tcg     ,w       ,tplnke  , &amp;<a name='4582'>
                  tint    ,tint4   ,tlayr   ,tlayr4  ,pmln    , &amp;<a name='4583'>
                  piln    ,plh2ob  ,wb      )<a name='4584'>
<font color=#447700>!--------------------------------------------------------------------<a name='4585'></font>
<font color=#447700>!<a name='4586'></font>
<font color=#447700>! Purpose:<a name='4587'></font>
<font color=#447700>! Compute temperatures and path lengths for longwave radiation<a name='4588'></font>
<font color=#447700>!<a name='4589'></font>
<font color=#447700>! Method:<a name='4590'></font>
<font color=#447700>! &lt;Describe the algorithm(s) used in the routine.&gt;<a name='4591'></font>
<font color=#447700>! &lt;Also include any applicable external references.&gt;<a name='4592'></font>
<font color=#447700>!<a name='4593'></font>
<font color=#447700>! Author: CCM1<a name='4594'></font>
<font color=#447700>!<a name='4595'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='4596'></font>
<a name='4597'>
<font color=#447700>!------------------------------Arguments-----------------------------<a name='4598'></font>
<font color=#447700>!<a name='4599'></font>
<font color=#447700>! Input arguments<a name='4600'></font>
<font color=#447700>!<a name='4601'></font>
   integer, intent(in) :: lchnk                 <font color=#447700>! chunk identifier<a name='4602'></font>
   integer, intent(in) :: ncol                  <font color=#447700>! number of atmospheric columns<a name='4603'></font>
   integer, intent(in) :: pcols, pver, pverp<a name='4604'>
<a name='4605'>
   real(r8), intent(in) :: tnm(pcols,pver)      <font color=#447700>! Model level temperatures<a name='4606'></font>
   real(r8), intent(in) :: lwupcgs(pcols)       <font color=#447700>! Surface longwave up flux<a name='4607'></font>
   real(r8), intent(in) :: qnm(pcols,pver)      <font color=#447700>! Model level specific humidity<a name='4608'></font>
   real(r8), intent(in) :: pnm(pcols,pverp)     <font color=#447700>! Pressure at model interfaces (dynes/cm2)<a name='4609'></font>
   real(r8), intent(in) :: pmln(pcols,pver)     <font color=#447700>! Ln(pmidm1)<a name='4610'></font>
   real(r8), intent(in) :: piln(pcols,pverp)    <font color=#447700>! Ln(pintm1)<a name='4611'></font>
<font color=#447700>!<a name='4612'></font>
<font color=#447700>! Output arguments<a name='4613'></font>
<font color=#447700>!<a name='4614'></font>
   real(r8), intent(out) :: plco2(pcols,pverp)   <font color=#447700>! Pressure weighted co2 path<a name='4615'></font>
   real(r8), intent(out) :: plh2o(pcols,pverp)   <font color=#447700>! Pressure weighted h2o path<a name='4616'></font>
   real(r8), intent(out) :: tplnka(pcols,pverp)  <font color=#447700>! Level temperature from interface temperatures<a name='4617'></font>
   real(r8), intent(out) :: s2c(pcols,pverp)     <font color=#447700>! H2o continuum path length<a name='4618'></font>
   real(r8), intent(out) :: tcg(pcols,pverp)     <font color=#447700>! H2o-mass-wgted temp. (Curtis-Godson approx.)<a name='4619'></font>
   real(r8), intent(out) :: w(pcols,pverp)       <font color=#447700>! H2o path length<a name='4620'></font>
   real(r8), intent(out) :: tplnke(pcols)        <font color=#447700>! Equal to tplnka<a name='4621'></font>
   real(r8), intent(out) :: tint(pcols,pverp)    <font color=#447700>! Layer interface temperature<a name='4622'></font>
   real(r8), intent(out) :: tint4(pcols,pverp)   <font color=#447700>! Tint to the 4th power<a name='4623'></font>
   real(r8), intent(out) :: tlayr(pcols,pverp)   <font color=#447700>! K-1 level temperature<a name='4624'></font>
   real(r8), intent(out) :: tlayr4(pcols,pverp)  <font color=#447700>! Tlayr to the 4th power<a name='4625'></font>
   real(r8), intent(out) :: plh2ob(nbands,pcols,pverp)<font color=#447700>! Pressure weighted h2o path with <a name='4626'></font>
                                                      <font color=#447700>!    Hulst-Curtis-Godson temp. factor <a name='4627'></font>
                                                      <font color=#447700>!    for H2O bands <a name='4628'></font>
   real(r8), intent(out) :: wb(nbands,pcols,pverp)    <font color=#447700>! H2o path length with <a name='4629'></font>
                                                      <font color=#447700>!    Hulst-Curtis-Godson temp. factor <a name='4630'></font>
                                                      <font color=#447700>!    for H2O bands <a name='4631'></font>
<a name='4632'>
<font color=#447700>!<a name='4633'></font>
<font color=#447700>!---------------------------Local variables--------------------------<a name='4634'></font>
<font color=#447700>!<a name='4635'></font>
   integer i                 <font color=#447700>! Longitude index<a name='4636'></font>
   integer k                 <font color=#447700>! Level index<a name='4637'></font>
   integer kp1               <font color=#447700>! Level index + 1<a name='4638'></font>
<a name='4639'>
   real(r8) repsil               <font color=#447700>! Inver ratio mol weight h2o to dry air<a name='4640'></font>
   real(r8) dy                   <font color=#447700>! Thickness of layer for tmp interp<a name='4641'></font>
   real(r8) dpnm                 <font color=#447700>! Pressure thickness of layer<a name='4642'></font>
   real(r8) dpnmsq               <font color=#447700>! Prs squared difference across layer<a name='4643'></font>
   real(r8) dw                   <font color=#447700>! Increment in H2O path length<a name='4644'></font>
   real(r8) dplh2o               <font color=#447700>! Increment in plh2o<a name='4645'></font>
   real(r8) cpwpl                <font color=#447700>! Const in co2 mix ratio to path length conversn<a name='4646'></font>
<a name='4647'>
<font color=#447700>!--------------------------------------------------------------------<a name='4648'></font>
<font color=#447700>!<a name='4649'></font>
   repsil = 1./epsilo<a name='4650'>
<font color=#447700>!<a name='4651'></font>
<font color=#447700>! Compute co2 and h2o paths<a name='4652'></font>
<font color=#447700>!<a name='4653'></font>
   cpwpl = amco2/amd * 0.5/(gravit*p0)<a name='4654'>
   do i=1,ncol<a name='4655'>
      plh2o(i,ntoplw)  = rgsslp*qnm(i,ntoplw)*pnm(i,ntoplw)*pnm(i,ntoplw)<a name='4656'>
      plco2(i,ntoplw)  = co2vmr*cpwpl*pnm(i,ntoplw)*pnm(i,ntoplw)<a name='4657'>
   end do<a name='4658'>
   do k=ntoplw,pver<a name='4659'>
      do i=1,ncol<a name='4660'>
         plh2o(i,k+1)  = plh2o(i,k) + rgsslp* &amp;<a name='4661'>
                         (pnm(i,k+1)**2 - pnm(i,k)**2)*qnm(i,k)<a name='4662'>
         plco2(i,k+1)  = co2vmr*cpwpl*pnm(i,k+1)**2<a name='4663'>
      end do<a name='4664'>
   end do<a name='4665'>
<font color=#447700>!<a name='4666'></font>
<font color=#447700>! Set the top and bottom intermediate level temperatures,<a name='4667'></font>
<font color=#447700>! top level planck temperature and top layer temp**4.<a name='4668'></font>
<font color=#447700>!<a name='4669'></font>
<font color=#447700>! Tint is lower interface temperature<a name='4670'></font>
<font color=#447700>! (not available for bottom layer, so use ground temperature)<a name='4671'></font>
<font color=#447700>!<a name='4672'></font>
   do i=1,ncol<a name='4673'>
      tint4(i,pverp)   = lwupcgs(i)/stebol<a name='4674'>
      tint(i,pverp)    = sqrt(sqrt(tint4(i,pverp)))<a name='4675'>
      tplnka(i,ntoplw) = tnm(i,ntoplw)<a name='4676'>
      tint(i,ntoplw)   = tplnka(i,ntoplw)<a name='4677'>
      tlayr4(i,ntoplw) = tplnka(i,ntoplw)**4<a name='4678'>
      tint4(i,ntoplw)  = tlayr4(i,ntoplw)<a name='4679'>
   end do<a name='4680'>
<font color=#447700>!<a name='4681'></font>
<font color=#447700>! Intermediate level temperatures are computed using temperature<a name='4682'></font>
<font color=#447700>! at the full level below less dy*delta t,between the full level<a name='4683'></font>
<font color=#447700>!<a name='4684'></font>
   do k=ntoplw+1,pver<a name='4685'>
      do i=1,ncol<a name='4686'>
         dy = (piln(i,k) - pmln(i,k))/(pmln(i,k-1) - pmln(i,k))<a name='4687'>
         tint(i,k)  = tnm(i,k) - dy*(tnm(i,k)-tnm(i,k-1))<a name='4688'>
         tint4(i,k) = tint(i,k)**4<a name='4689'>
      end do<a name='4690'>
   end do<a name='4691'>
<font color=#447700>!<a name='4692'></font>
<font color=#447700>! Now set the layer temp=full level temperatures and establish a<a name='4693'></font>
<font color=#447700>! planck temperature for absorption (tplnka) which is the average<a name='4694'></font>
<font color=#447700>! the intermediate level temperatures.  Note that tplnka is not<a name='4695'></font>
<font color=#447700>! equal to the full level temperatures.<a name='4696'></font>
<font color=#447700>!<a name='4697'></font>
   do k=ntoplw+1,pverp<a name='4698'>
      do i=1,ncol<a name='4699'>
         tlayr(i,k)  = tnm(i,k-1)<a name='4700'>
         tlayr4(i,k) = tlayr(i,k)**4<a name='4701'>
         tplnka(i,k) = .5*(tint(i,k) + tint(i,k-1))<a name='4702'>
      end do<a name='4703'>
   end do<a name='4704'>
<font color=#447700>!<a name='4705'></font>
<font color=#447700>! Calculate tplank for emissivity calculation.<a name='4706'></font>
<font color=#447700>! Assume isothermal tplnke i.e. all levels=ttop.<a name='4707'></font>
<font color=#447700>!<a name='4708'></font>
   do i=1,ncol<a name='4709'>
      tplnke(i)       = tplnka(i,ntoplw)<a name='4710'>
      tlayr(i,ntoplw) = tint(i,ntoplw)<a name='4711'>
   end do<a name='4712'>
<font color=#447700>!<a name='4713'></font>
<font color=#447700>! Now compute h2o path fields:<a name='4714'></font>
<font color=#447700>!<a name='4715'></font>
   do i=1,ncol<a name='4716'>
<font color=#447700>!<a name='4717'></font>
<font color=#447700>! Changed effective path temperature to std. Curtis-Godson form<a name='4718'></font>
<font color=#447700>!<a name='4719'></font>
      tcg(i,ntoplw) = rga*qnm(i,ntoplw)*pnm(i,ntoplw)*tnm(i,ntoplw)<a name='4720'>
      w(i,ntoplw)   = sslp * (plh2o(i,ntoplw)*2.) / pnm(i,ntoplw)<a name='4721'>
<font color=#447700>!<a name='4722'></font>
<font color=#447700>! Hulst-Curtis-Godson scaling for H2O path<a name='4723'></font>
<font color=#447700>!<a name='4724'></font>
      wb(1,i,ntoplw) = w(i,ntoplw) * phi(tnm(i,ntoplw),1)<a name='4725'>
      wb(2,i,ntoplw) = w(i,ntoplw) * phi(tnm(i,ntoplw),2)<a name='4726'>
<font color=#447700>!<a name='4727'></font>
<font color=#447700>! Hulst-Curtis-Godson scaling for effective pressure along H2O path<a name='4728'></font>
<font color=#447700>!<a name='4729'></font>
      plh2ob(1,i,ntoplw) = plh2o(i,ntoplw) * psi(tnm(i,ntoplw),1)<a name='4730'>
      plh2ob(2,i,ntoplw) = plh2o(i,ntoplw) * psi(tnm(i,ntoplw),2)<a name='4731'>
<a name='4732'>
      s2c(i,ntoplw) = plh2o(i,ntoplw)*fh2oself(tnm(i,ntoplw))*qnm(i,ntoplw)*repsil<a name='4733'>
   end do<a name='4734'>
<a name='4735'>
   do k=ntoplw,pver<a name='4736'>
      do i=1,ncol<a name='4737'>
         dpnm       = pnm(i,k+1) - pnm(i,k)<a name='4738'>
         dpnmsq     = pnm(i,k+1)**2 - pnm(i,k)**2<a name='4739'>
         dw         = rga*qnm(i,k)*dpnm<a name='4740'>
         kp1        = k+1<a name='4741'>
         w(i,kp1)   = w(i,k) + dw<a name='4742'>
<font color=#447700>!<a name='4743'></font>
<font color=#447700>! Hulst-Curtis-Godson scaling for H2O path<a name='4744'></font>
<font color=#447700>!<a name='4745'></font>
         wb(1,i,kp1) = wb(1,i,k) + dw * phi(tnm(i,k),1)<a name='4746'>
         wb(2,i,kp1) = wb(2,i,k) + dw * phi(tnm(i,k),2)<a name='4747'>
<font color=#447700>!<a name='4748'></font>
<font color=#447700>! Hulst-Curtis-Godson scaling for effective pressure along H2O path<a name='4749'></font>
<font color=#447700>!<a name='4750'></font>
         dplh2o = plh2o(i,kp1) - plh2o(i,k)<a name='4751'>
<a name='4752'>
         plh2ob(1,i,kp1) = plh2ob(1,i,k) + dplh2o * psi(tnm(i,k),1)<a name='4753'>
         plh2ob(2,i,kp1) = plh2ob(2,i,k) + dplh2o * psi(tnm(i,k),2)<a name='4754'>
<font color=#447700>!<a name='4755'></font>
<font color=#447700>! Changed effective path temperature to std. Curtis-Godson form<a name='4756'></font>
<font color=#447700>!<a name='4757'></font>
         tcg(i,kp1) = tcg(i,k) + dw*tnm(i,k)<a name='4758'>
         s2c(i,kp1) = s2c(i,k) + rgsslp*dpnmsq*qnm(i,k)* &amp;<a name='4759'>
                      fh2oself(tnm(i,k))*qnm(i,k)*repsil<a name='4760'>
      end do<a name='4761'>
   end do<a name='4762'>
<font color=#447700>!<a name='4763'></font>
   return<a name='4764'>
end subroutine radtpl<a name='4765'>
<a name='4766'>
<a name='4767'>
<A NAME='RADCLWMX'><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4768'>
<font color=#993300>subroutine </font><font color=#cc0000>radclwmx</font>(lchnk   ,ncol    ,pcols, pver, pverp,         &amp; <A href='../../call_to/RADCLWMX.html' TARGET='index'>2</A>,<A href='../../call_from/RADCLWMX.html' TARGET='index'>8</A><a name='4769'>
                    lwupcgs ,tnm     ,qnm     ,o3vmr   , &amp;<a name='4770'>
                    pmid    ,pint    ,pmln    ,piln    ,          &amp;<a name='4771'>
                             n2o     ,ch4     ,cfc11   ,cfc12   , &amp;<a name='4772'>
                    cld     ,emis    ,pmxrgn  ,nmxrgn  ,qrl     , &amp;<a name='4773'>
                    doabsems, abstot, absnxt, emstot,             &amp;<a name='4774'>
                    flns    ,flnt    ,flnsc   ,flntc   ,flwds   , &amp;<a name='4775'>
                    flut    ,flutc   , &amp;<a name='4776'>
                    flup    ,flupc   ,fldn    ,fldnc   ,          &amp;<a name='4777'>
                    aer_mass)<a name='4778'>
<font color=#447700>!----------------------------------------------------------------------- <a name='4779'></font>
<font color=#447700>! <a name='4780'></font>
<font color=#447700>! Purpose: <a name='4781'></font>
<font color=#447700>! Compute longwave radiation heating rates and boundary fluxes<a name='4782'></font>
<font color=#447700>! <a name='4783'></font>
<font color=#447700>! Method: <a name='4784'></font>
<font color=#447700>! Uses broad band absorptivity/emissivity method to compute clear sky;<a name='4785'></font>
<font color=#447700>! assumes randomly overlapped clouds with variable cloud emissivity to<a name='4786'></font>
<font color=#447700>! include effects of clouds.<a name='4787'></font>
<font color=#447700>!<a name='4788'></font>
<font color=#447700>! Computes clear sky absorptivity/emissivity at lower frequency (in<a name='4789'></font>
<font color=#447700>! general) than the model radiation frequency; uses previously computed<a name='4790'></font>
<font color=#447700>! and stored values for efficiency<a name='4791'></font>
<font color=#447700>!<a name='4792'></font>
<font color=#447700>! Note: This subroutine contains vertical indexing which proceeds<a name='4793'></font>
<font color=#447700>!       from bottom to top rather than the top to bottom indexing<a name='4794'></font>
<font color=#447700>!       used in the rest of the model.<a name='4795'></font>
<font color=#447700>! <a name='4796'></font>
<font color=#447700>! Author: B. Collins<a name='4797'></font>
<font color=#447700>! <a name='4798'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4799'></font>
<font color=#447700>!  use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='4800'></font>
<font color=#447700>!  use ppgrid<a name='4801'></font>
<font color=#447700>!  use radae, only: nbands, radems, radabs, radtpl, abstot_3d, absnxt_3d, emstot_3d<a name='4802'></font>
<font color=#447700>!  use volcrad<a name='4803'></font>
<a name='4804'>
   implicit none<a name='4805'>
<a name='4806'>
   integer pverp2,pverp3,pverp4<a name='4807'>
<font color=#447700>!  parameter (pverp2=pver+2,pverp3=pver+3,pverp4=pver+4)<a name='4808'></font>
<a name='4809'>
   real(r8) cldmin<a name='4810'>
   parameter (cldmin = 1.0d-80)<a name='4811'>
<font color=#447700>!------------------------------Commons----------------------------------<a name='4812'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4813'></font>
<font color=#447700>!------------------------------Arguments--------------------------------<a name='4814'></font>
<font color=#447700>!<a name='4815'></font>
<font color=#447700>! Input arguments<a name='4816'></font>
<font color=#447700>!<a name='4817'></font>
   integer, intent(in) :: lchnk                 <font color=#447700>! chunk identifier<a name='4818'></font>
   integer, intent(in) :: pcols, pver, pverp<a name='4819'>
   integer, intent(in) :: ncol                  <font color=#447700>! number of atmospheric columns<a name='4820'></font>
<font color=#447700>!    maximally overlapped region.<a name='4821'></font>
<font color=#447700>!    0-&gt;pmxrgn(i,1) is range of pmid for<a name='4822'></font>
<font color=#447700>!    1st region, pmxrgn(i,1)-&gt;pmxrgn(i,2) for<a name='4823'></font>
<font color=#447700>!    2nd region, etc<a name='4824'></font>
   integer, intent(in) :: nmxrgn(pcols)         <font color=#447700>! Number of maximally overlapped regions<a name='4825'></font>
   logical, intent(in) :: doabsems<a name='4826'>
<a name='4827'>
   real(r8), intent(in) :: pmxrgn(pcols,pverp)  <font color=#447700>! Maximum values of pmid for each<a name='4828'></font>
   real(r8), intent(in) :: lwupcgs(pcols)       <font color=#447700>! Longwave up flux in CGS units<a name='4829'></font>
<font color=#447700>!<a name='4830'></font>
<font color=#447700>! Input arguments which are only passed to other routines<a name='4831'></font>
<font color=#447700>!<a name='4832'></font>
   real(r8), intent(in) :: tnm(pcols,pver)      <font color=#447700>! Level temperature<a name='4833'></font>
   real(r8), intent(in) :: qnm(pcols,pver)      <font color=#447700>! Level moisture field<a name='4834'></font>
   real(r8), intent(in) :: o3vmr(pcols,pver)    <font color=#447700>! ozone volume mixing ratio<a name='4835'></font>
   real(r8), intent(in) :: pmid(pcols,pver)     <font color=#447700>! Level pressure<a name='4836'></font>
   real(r8), intent(in) :: pint(pcols,pverp)    <font color=#447700>! Model interface pressure<a name='4837'></font>
   real(r8), intent(in) :: pmln(pcols,pver)     <font color=#447700>! Ln(pmid)<a name='4838'></font>
   real(r8), intent(in) :: piln(pcols,pverp)    <font color=#447700>! Ln(pint)<a name='4839'></font>
   real(r8), intent(in) :: n2o(pcols,pver)      <font color=#447700>! nitrous oxide mass mixing ratio<a name='4840'></font>
   real(r8), intent(in) :: ch4(pcols,pver)      <font color=#447700>! methane mass mixing ratio<a name='4841'></font>
   real(r8), intent(in) :: cfc11(pcols,pver)    <font color=#447700>! cfc11 mass mixing ratio<a name='4842'></font>
   real(r8), intent(in) :: cfc12(pcols,pver)    <font color=#447700>! cfc12 mass mixing ratio<a name='4843'></font>
   real(r8), intent(in) :: cld(pcols,pver)      <font color=#447700>! Cloud cover<a name='4844'></font>
   real(r8), intent(in) :: emis(pcols,pver)     <font color=#447700>! Cloud emissivity<a name='4845'></font>
   real(r8), intent(in) :: aer_mass(pcols,pver) <font color=#447700>! STRAER mass in layer<a name='4846'></font>
<a name='4847'>
<font color=#447700>!<a name='4848'></font>
<font color=#447700>! Output arguments<a name='4849'></font>
<font color=#447700>!<a name='4850'></font>
   real(r8), intent(out) :: qrl(pcols,pver)      <font color=#447700>! Longwave heating rate<a name='4851'></font>
   real(r8), intent(out) :: flns(pcols)          <font color=#447700>! Surface cooling flux<a name='4852'></font>
   real(r8), intent(out) :: flnt(pcols)          <font color=#447700>! Net outgoing flux<a name='4853'></font>
   real(r8), intent(out) :: flut(pcols)          <font color=#447700>! Upward flux at top of model<a name='4854'></font>
   real(r8), intent(out) :: flnsc(pcols)         <font color=#447700>! Clear sky surface cooing<a name='4855'></font>
   real(r8), intent(out) :: flntc(pcols)         <font color=#447700>! Net clear sky outgoing flux<a name='4856'></font>
   real(r8), intent(out) :: flutc(pcols)         <font color=#447700>! Upward clear-sky flux at top of model<a name='4857'></font>
   real(r8), intent(out) :: flwds(pcols)         <font color=#447700>! Down longwave flux at surface<a name='4858'></font>
<font color=#447700>! Added downward/upward total and clear sky fluxes<a name='4859'></font>
   real(r8), intent(out) :: flup(pcols,pverp)      <font color=#447700>! Total sky upward longwave flux <a name='4860'></font>
   real(r8), intent(out) :: flupc(pcols,pverp)     <font color=#447700>! Clear sky upward longwave flux <a name='4861'></font>
   real(r8), intent(out) :: fldn(pcols,pverp)      <font color=#447700>! Total sky downward longwave flux <a name='4862'></font>
   real(r8), intent(out) :: fldnc(pcols,pverp)     <font color=#447700>! Clear sky downward longwave flux<a name='4863'></font>
<font color=#447700>!<a name='4864'></font>
   real(r8), intent(inout) :: abstot(pcols,pverp,pverp) <font color=#447700>! Total absorptivity<a name='4865'></font>
   real(r8), intent(inout) :: absnxt(pcols,pver,4)      <font color=#447700>! Total nearest layer absorptivity<a name='4866'></font>
   real(r8), intent(inout) :: emstot(pcols,pverp)     <font color=#447700>! Total emissivity<a name='4867'></font>
<a name='4868'>
<font color=#447700>!---------------------------Local variables-----------------------------<a name='4869'></font>
<font color=#447700>!<a name='4870'></font>
   integer i                 <font color=#447700>! Longitude index<a name='4871'></font>
   integer ilon              <font color=#447700>! Longitude index<a name='4872'></font>
   integer ii                <font color=#447700>! Longitude index<a name='4873'></font>
   integer iimx              <font color=#447700>! Longitude index (max overlap)<a name='4874'></font>
   integer k                 <font color=#447700>! Level index<a name='4875'></font>
   integer k1                <font color=#447700>! Level index<a name='4876'></font>
   integer k2                <font color=#447700>! Level index<a name='4877'></font>
   integer k3                <font color=#447700>! Level index<a name='4878'></font>
   integer km                <font color=#447700>! Level index<a name='4879'></font>
   integer km1               <font color=#447700>! Level index<a name='4880'></font>
   integer km3               <font color=#447700>! Level index<a name='4881'></font>
   integer km4               <font color=#447700>! Level index<a name='4882'></font>
   integer irgn              <font color=#447700>! Index for max-overlap regions<a name='4883'></font>
   integer l                 <font color=#447700>! Index for clouds to overlap<a name='4884'></font>
   integer l1                <font color=#447700>! Index for clouds to overlap<a name='4885'></font>
   integer n                 <font color=#447700>! Counter<a name='4886'></font>
<a name='4887'>
<font color=#447700>!<a name='4888'></font>
   real(r8) :: plco2(pcols,pverp)   <font color=#447700>! Path length co2<a name='4889'></font>
   real(r8) :: plh2o(pcols,pverp)   <font color=#447700>! Path length h2o<a name='4890'></font>
   real(r8) tmp(pcols)           <font color=#447700>! Temporary workspace<a name='4891'></font>
   real(r8) tmp2(pcols)          <font color=#447700>! Temporary workspace<a name='4892'></font>
   real(r8) absbt(pcols)         <font color=#447700>! Downward emission at model top<a name='4893'></font>
   real(r8) plol(pcols,pverp)    <font color=#447700>! O3 pressure wghted path length<a name='4894'></font>
   real(r8) plos(pcols,pverp)    <font color=#447700>! O3 path length<a name='4895'></font>
   real(r8) aer_mpp(pcols,pverp) <font color=#447700>! STRAER path above kth interface level<a name='4896'></font>
   real(r8) co2em(pcols,pverp)   <font color=#447700>! Layer co2 normalized planck funct. derivative<a name='4897'></font>
   real(r8) co2eml(pcols,pver)   <font color=#447700>! Interface co2 normalized planck funct. deriv.<a name='4898'></font>
   real(r8) delt(pcols)          <font color=#447700>! Diff t**4 mid layer to top interface<a name='4899'></font>
   real(r8) delt1(pcols)         <font color=#447700>! Diff t**4 lower intrfc to mid layer<a name='4900'></font>
   real(r8) bk1(pcols)           <font color=#447700>! Absrptvty for vertical quadrature<a name='4901'></font>
   real(r8) bk2(pcols)           <font color=#447700>! Absrptvty for vertical quadrature<a name='4902'></font>
   real(r8) cldp(pcols,pverp)    <font color=#447700>! Cloud cover with extra layer<a name='4903'></font>
   real(r8) ful(pcols,pverp)     <font color=#447700>! Total upwards longwave flux<a name='4904'></font>
   real(r8) fsul(pcols,pverp)    <font color=#447700>! Clear sky upwards longwave flux<a name='4905'></font>
   real(r8) fdl(pcols,pverp)     <font color=#447700>! Total downwards longwave flux<a name='4906'></font>
   real(r8) fsdl(pcols,pverp)    <font color=#447700>! Clear sky downwards longwv flux<a name='4907'></font>
   real(r8) fclb4(pcols,-1:pver)    <font color=#447700>! Sig t**4 for cld bottom interfc<a name='4908'></font>
   real(r8) fclt4(pcols,0:pver)    <font color=#447700>! Sig t**4 for cloud top interfc<a name='4909'></font>
   real(r8) s(pcols,pverp,pverp) <font color=#447700>! Flx integral sum<a name='4910'></font>
   real(r8) tplnka(pcols,pverp)  <font color=#447700>! Planck fnctn temperature<a name='4911'></font>
   real(r8) s2c(pcols,pverp)     <font color=#447700>! H2o cont amount<a name='4912'></font>
   real(r8) tcg(pcols,pverp)     <font color=#447700>! H2o-mass-wgted temp. (Curtis-Godson approx.)<a name='4913'></font>
   real(r8) w(pcols,pverp)       <font color=#447700>! H2o path<a name='4914'></font>
   real(r8) tplnke(pcols)        <font color=#447700>! Planck fnctn temperature<a name='4915'></font>
   real(r8) h2otr(pcols,pverp)   <font color=#447700>! H2o trnmsn for o3 overlap<a name='4916'></font>
   real(r8) co2t(pcols,pverp)    <font color=#447700>! Prs wghted temperature path<a name='4917'></font>
   real(r8) tint(pcols,pverp)    <font color=#447700>! Interface temperature<a name='4918'></font>
   real(r8) tint4(pcols,pverp)   <font color=#447700>! Interface temperature**4<a name='4919'></font>
   real(r8) tlayr(pcols,pverp)   <font color=#447700>! Level temperature<a name='4920'></font>
   real(r8) tlayr4(pcols,pverp)  <font color=#447700>! Level temperature**4<a name='4921'></font>
   real(r8) plh2ob(nbands,pcols,pverp)<font color=#447700>! Pressure weighted h2o path with <a name='4922'></font>
                                      <font color=#447700>!    Hulst-Curtis-Godson temp. factor <a name='4923'></font>
                                      <font color=#447700>!    for H2O bands <a name='4924'></font>
   real(r8) wb(nbands,pcols,pverp)    <font color=#447700>! H2o path length with <a name='4925'></font>
                                      <font color=#447700>!    Hulst-Curtis-Godson temp. factor <a name='4926'></font>
                                      <font color=#447700>!    for H2O bands <a name='4927'></font>
<a name='4928'>
   real(r8) cld0                 <font color=#447700>! previous cloud amt (for max overlap)<a name='4929'></font>
   real(r8) cld1                 <font color=#447700>! next cloud amt (for max overlap)<a name='4930'></font>
   real(r8) emx(0:pverp)         <font color=#447700>! Emissivity factors (max overlap)<a name='4931'></font>
   real(r8) emx0                 <font color=#447700>! Emissivity factors for BCs (max overlap)<a name='4932'></font>
   real(r8) trans                <font color=#447700>! 1 - emis<a name='4933'></font>
   real(r8) asort(pver)          <font color=#447700>! 1 - cloud amounts to be sorted for max ovrlp.<a name='4934'></font>
   real(r8) atmp                 <font color=#447700>! Temporary storage for sort when nxs = 2<a name='4935'></font>
   real(r8) maxcld(pcols)        <font color=#447700>! Maximum cloud at any layer<a name='4936'></font>
<a name='4937'>
   integer indx(pcols)       <font color=#447700>! index vector of gathered array values<a name='4938'></font>
<font color=#447700>!!$   integer indxmx(pcols+1,pverp)! index vector of gathered array values<a name='4939'></font>
   integer indxmx(pcols,pverp)<font color=#447700>! index vector of gathered array values<a name='4940'></font>
<font color=#447700>!    (max overlap)<a name='4941'></font>
   integer nrgn(pcols)       <font color=#447700>! Number of max overlap regions at longitude<a name='4942'></font>
   integer npts              <font color=#447700>! number of values satisfying some criterion<a name='4943'></font>
   integer ncolmx(pverp)     <font color=#447700>! number of columns with clds in region<a name='4944'></font>
   integer kx1(pcols,pverp)  <font color=#447700>! Level index for top of max-overlap region<a name='4945'></font>
   integer kx2(pcols,0:pverp)<font color=#447700>! Level index for bottom of max-overlap region<a name='4946'></font>
   integer kxs(0:pverp,pcols,pverp)<font color=#447700>! Level indices for cld layers sorted by cld()<a name='4947'></font>
<font color=#447700>!    in descending order<a name='4948'></font>
   integer nxs(pcols,pverp)  <font color=#447700>! Number of cloudy layers between kx1 and kx2<a name='4949'></font>
   integer nxsk              <font color=#447700>! Number of cloudy layers between (kx1/kx2)&amp;k<a name='4950'></font>
   integer ksort(0:pverp)    <font color=#447700>! Level indices of cloud amounts to be sorted<a name='4951'></font>
<font color=#447700>!    for max ovrlp. calculation<a name='4952'></font>
   integer ktmp              <font color=#447700>! Temporary storage for sort when nxs = 2<a name='4953'></font>
<a name='4954'>
<font color=#447700>!  real aer_trn_ttl(pcols,pverp,pverp,bnd_nbr_LW) ! [fraction] Total<a name='4955'></font>
  real(r8) aer_trn_ttl(pcols,pverp,pverp,bnd_nbr_LW) <font color=#447700>! [fraction] Total<a name='4956'></font>
<font color=#447700>!                               ! transmission between interfaces k1 and k2  <a name='4957'></font>
<font color=#447700>!<a name='4958'></font>
<font color=#447700>! Pointer variables to 3d structures<a name='4959'></font>
<font color=#447700>!<a name='4960'></font>
<font color=#447700>!  real(r8), pointer :: abstot(:,:,:)<a name='4961'></font>
<font color=#447700>!  real(r8), pointer :: absnxt(:,:,:)<a name='4962'></font>
<font color=#447700>!  real(r8), pointer :: emstot(:,:)<a name='4963'></font>
<a name='4964'>
<font color=#447700>!<a name='4965'></font>
<font color=#447700>! Trace gas variables<a name='4966'></font>
<font color=#447700>!<a name='4967'></font>
   real(r8) ucfc11(pcols,pverp)  <font color=#447700>! CFC11 path length<a name='4968'></font>
   real(r8) ucfc12(pcols,pverp)  <font color=#447700>! CFC12 path length<a name='4969'></font>
   real(r8) un2o0(pcols,pverp)   <font color=#447700>! N2O path length<a name='4970'></font>
   real(r8) un2o1(pcols,pverp)   <font color=#447700>! N2O path length (hot band)<a name='4971'></font>
   real(r8) uch4(pcols,pverp)    <font color=#447700>! CH4 path length<a name='4972'></font>
   real(r8) uco211(pcols,pverp)  <font color=#447700>! CO2 9.4 micron band path length<a name='4973'></font>
   real(r8) uco212(pcols,pverp)  <font color=#447700>! CO2 9.4 micron band path length<a name='4974'></font>
   real(r8) uco213(pcols,pverp)  <font color=#447700>! CO2 9.4 micron band path length<a name='4975'></font>
   real(r8) uco221(pcols,pverp)  <font color=#447700>! CO2 10.4 micron band path length<a name='4976'></font>
   real(r8) uco222(pcols,pverp)  <font color=#447700>! CO2 10.4 micron band path length<a name='4977'></font>
   real(r8) uco223(pcols,pverp)  <font color=#447700>! CO2 10.4 micron band path length<a name='4978'></font>
   real(r8) bn2o0(pcols,pverp)   <font color=#447700>! pressure factor for n2o<a name='4979'></font>
   real(r8) bn2o1(pcols,pverp)   <font color=#447700>! pressure factor for n2o<a name='4980'></font>
   real(r8) bch4(pcols,pverp)    <font color=#447700>! pressure factor for ch4<a name='4981'></font>
   real(r8) uptype(pcols,pverp)  <font color=#447700>! p-type continuum path length<a name='4982'></font>
   real(r8) abplnk1(14,pcols,pverp)  <font color=#447700>! non-nearest layer Plack factor<a name='4983'></font>
   real(r8) abplnk2(14,pcols,pverp)  <font color=#447700>! nearest layer factor<a name='4984'></font>
<font color=#447700>!<a name='4985'></font>
<font color=#447700>!<a name='4986'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='4987'></font>
<font color=#447700>!<a name='4988'></font>
<font color=#447700>!<a name='4989'></font>
   pverp2=pver+2<a name='4990'>
   pverp3=pver+3<a name='4991'>
   pverp4=pver+4<a name='4992'>
<font color=#447700>!<a name='4993'></font>
<font color=#447700>! Set pointer variables<a name='4994'></font>
<font color=#447700>!<a name='4995'></font>
<font color=#447700>!  abstot =&gt; abstot_3d(:,:,:,lchnk)<a name='4996'></font>
<font color=#447700>!  absnxt =&gt; absnxt_3d(:,:,:,lchnk)<a name='4997'></font>
<font color=#447700>!  emstot =&gt; emstot_3d(:,:,lchnk)<a name='4998'></font>
<font color=#447700>!<a name='4999'></font>
<font color=#447700>! accumulate mass path from top of atmosphere<a name='5000'></font>
<font color=#447700>!<a name='5001'></font>
  call <A href='../../html_code/phys/module_ra_cam.F.html#AER_PTH'>aer_pth</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AER_PTH_1">(aer_mass, aer_mpp, ncol, pcols, pver, pverp)<a name='5002'>
<a name='5003'>
<font color=#447700>!<a name='5004'></font>
<font color=#447700>! Calculate some temperatures needed to derive absorptivity and<a name='5005'></font>
<font color=#447700>! emissivity, as well as some h2o path lengths<a name='5006'></font>
<font color=#447700>!<a name='5007'></font>
   call <A href='../../html_code/phys/module_ra_cam.F.html#RADTPL'>radtpl</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADTPL_1">(lchnk   ,ncol    ,pcols, pver, pverp,                  &amp;<a name='5008'>
               tnm     ,lwupcgs ,qnm     ,pint    ,plco2   ,plh2o   , &amp;<a name='5009'>
               tplnka  ,s2c     ,tcg     ,w       ,tplnke  , &amp;<a name='5010'>
               tint    ,tint4   ,tlayr   ,tlayr4  ,pmln    , &amp;<a name='5011'>
               piln    ,plh2ob  ,wb      )<a name='5012'>
   if (doabsems) then<a name='5013'>
<font color=#447700>!<a name='5014'></font>
<font color=#447700>! Compute ozone path lengths at frequency of a/e calculation.<a name='5015'></font>
<font color=#447700>!<a name='5016'></font>
      call <A href='../../html_code/phys/module_ra_cam.F.html#RADOZ2'>radoz2</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADOZ2_1">(lchnk, ncol, pcols, pver, pverp, o3vmr   ,pint    ,plol    ,plos, ntoplw    )<a name='5017'>
<font color=#447700>!<a name='5018'></font>
<font color=#447700>! Compute trace gas path lengths<a name='5019'></font>
<font color=#447700>!<a name='5020'></font>
      call <A href='../../html_code/phys/module_ra_cam_support.F.html#TRCPTH'>trcpth</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRCPTH_1">(lchnk   ,ncol    ,pcols, pver, pverp,         &amp;<a name='5021'>
                  tnm     ,pint    ,cfc11   ,cfc12   ,n2o     , &amp;<a name='5022'>
                  ch4     ,qnm     ,ucfc11  ,ucfc12  ,un2o0   , &amp;<a name='5023'>
                  un2o1   ,uch4    ,uco211  ,uco212  ,uco213  , &amp;<a name='5024'>
                  uco221  ,uco222  ,uco223  ,bn2o0   ,bn2o1   , &amp;<a name='5025'>
                  bch4    ,uptype  )<a name='5026'>
<a name='5027'>
<font color=#447700>!     Compute transmission through STRAER absorption continuum<a name='5028'></font>
      call <A href='../../html_code/phys/module_ra_cam.F.html#AER_TRN'>aer_trn</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AER_TRN_1">(aer_mpp, aer_trn_ttl, pcols, pver, pverp)<a name='5029'>
<a name='5030'>
<font color=#447700>!<a name='5031'></font>
<font color=#447700>!<a name='5032'></font>
<font color=#447700>! Compute total emissivity:<a name='5033'></font>
<font color=#447700>!<a name='5034'></font>
      call <A href='../../html_code/phys/module_ra_cam.F.html#RADEMS'>radems</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADEMS_1">(lchnk   ,ncol    ,pcols, pver, pverp,         &amp;<a name='5035'>
                  s2c     ,tcg     ,w       ,tplnke  ,plh2o   , &amp;<a name='5036'>
                  pint    ,plco2   ,tint    ,tint4   ,tlayr   , &amp;<a name='5037'>
                  tlayr4  ,plol    ,plos    ,ucfc11  ,ucfc12  , &amp;<a name='5038'>
                  un2o0   ,un2o1   ,uch4    ,uco211  ,uco212  , &amp;<a name='5039'>
                  uco213  ,uco221  ,uco222  ,uco223  ,uptype  , &amp;<a name='5040'>
                  bn2o0   ,bn2o1   ,bch4    ,co2em   ,co2eml  , &amp;<a name='5041'>
                  co2t    ,h2otr   ,abplnk1 ,abplnk2 ,emstot  , &amp;<a name='5042'>
                  plh2ob  ,wb      , &amp;<a name='5043'>
                  aer_trn_ttl)<a name='5044'>
<font color=#447700>!<a name='5045'></font>
<font color=#447700>! Compute total absorptivity:<a name='5046'></font>
<font color=#447700>!<a name='5047'></font>
      call <A href='../../html_code/phys/module_ra_cam.F.html#RADABS'>radabs</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADABS_1">(lchnk   ,ncol    ,pcols, pver, pverp,         &amp;<a name='5048'>
                  pmid    ,pint    ,co2em   ,co2eml  ,tplnka  , &amp;<a name='5049'>
                  s2c     ,tcg     ,w       ,h2otr   ,plco2   , &amp;<a name='5050'>
                  plh2o   ,co2t    ,tint    ,tlayr   ,plol    , &amp;<a name='5051'>
                  plos    ,pmln    ,piln    ,ucfc11  ,ucfc12  , &amp;<a name='5052'>
                  un2o0   ,un2o1   ,uch4    ,uco211  ,uco212  , &amp;<a name='5053'>
                  uco213  ,uco221  ,uco222  ,uco223  ,uptype  , &amp;<a name='5054'>
                  bn2o0   ,bn2o1   ,bch4    ,abplnk1 ,abplnk2 , &amp;<a name='5055'>
                  abstot  ,absnxt  ,plh2ob  ,wb      , &amp;<a name='5056'>
                  aer_mpp ,aer_trn_ttl)<a name='5057'>
   end if<a name='5058'>
<font color=#447700>!<a name='5059'></font>
<font color=#447700>! Compute sums used in integrals (all longitude points)<a name='5060'></font>
<font color=#447700>!<a name='5061'></font>
<font color=#447700>! Definition of bk1 &amp; bk2 depends on finite differencing.  for<a name='5062'></font>
<font color=#447700>! trapezoidal rule bk1=bk2. trapezoidal rule applied for nonadjacent<a name='5063'></font>
<font color=#447700>! layers only.<a name='5064'></font>
<font color=#447700>!<a name='5065'></font>
<font color=#447700>! delt=t**4 in layer above current sigma level km.<a name='5066'></font>
<font color=#447700>! delt1=t**4 in layer below current sigma level km.<a name='5067'></font>
<font color=#447700>!<a name='5068'></font>
   do i=1,ncol<a name='5069'>
      delt(i) = tint4(i,pver) - tlayr4(i,pverp)<a name='5070'>
      delt1(i) = tlayr4(i,pverp) - tint4(i,pverp)<a name='5071'>
      s(i,pverp,pverp) = stebol*(delt1(i)*absnxt(i,pver,1) + delt (i)*absnxt(i,pver,4))<a name='5072'>
      s(i,pver,pverp)  = stebol*(delt (i)*absnxt(i,pver,2) + delt1(i)*absnxt(i,pver,3))<a name='5073'>
   end do<a name='5074'>
   do k=ntoplw,pver-1<a name='5075'>
      do i=1,ncol<a name='5076'>
         bk2(i) = (abstot(i,k,pver) + abstot(i,k,pverp))*0.5<a name='5077'>
         bk1(i) = bk2(i)<a name='5078'>
         s(i,k,pverp) = stebol*(bk2(i)*delt(i) + bk1(i)*delt1(i))<a name='5079'>
      end do<a name='5080'>
   end do<a name='5081'>
<font color=#447700>!<a name='5082'></font>
<font color=#447700>! All k, km&gt;1<a name='5083'></font>
<font color=#447700>!<a name='5084'></font>
   do km=pver,ntoplw+1,-1<a name='5085'>
      do i=1,ncol<a name='5086'>
         delt(i)  = tint4(i,km-1) - tlayr4(i,km)<a name='5087'>
         delt1(i) = tlayr4(i,km) - tint4(i,km)<a name='5088'>
      end do<a name='5089'>
      do k=pverp,ntoplw,-1<a name='5090'>
         if (k == km) then<a name='5091'>
            do i=1,ncol<a name='5092'>
               bk2(i) = absnxt(i,km-1,4)<a name='5093'>
               bk1(i) = absnxt(i,km-1,1)<a name='5094'>
            end do<a name='5095'>
         else if (k == km-1) then<a name='5096'>
            do i=1,ncol<a name='5097'>
               bk2(i) = absnxt(i,km-1,2)<a name='5098'>
               bk1(i) = absnxt(i,km-1,3)<a name='5099'>
            end do<a name='5100'>
         else<a name='5101'>
            do i=1,ncol<a name='5102'>
               bk2(i) = (abstot(i,k,km-1) + abstot(i,k,km))*0.5<a name='5103'>
               bk1(i) = bk2(i)<a name='5104'>
            end do<a name='5105'>
         end if<a name='5106'>
         do i=1,ncol<a name='5107'>
            s(i,k,km) = s(i,k,km+1) + stebol*(bk2(i)*delt(i) + bk1(i)*delt1(i))<a name='5108'>
         end do<a name='5109'>
      end do<a name='5110'>
   end do<a name='5111'>
<font color=#447700>!<a name='5112'></font>
<font color=#447700>! Computation of clear sky fluxes always set first level of fsul<a name='5113'></font>
<font color=#447700>!<a name='5114'></font>
   do i=1,ncol<a name='5115'>
      fsul(i,pverp) = lwupcgs(i)<a name='5116'>
   end do<a name='5117'>
<font color=#447700>!<a name='5118'></font>
<font color=#447700>! Downward clear sky fluxes store intermediate quantities in down flux<a name='5119'></font>
<font color=#447700>! Initialize fluxes to clear sky values.<a name='5120'></font>
<font color=#447700>!<a name='5121'></font>
   do i=1,ncol<a name='5122'>
      tmp(i) = fsul(i,pverp) - stebol*tint4(i,pverp)<a name='5123'>
      fsul(i,ntoplw) = fsul(i,pverp) - abstot(i,ntoplw,pverp)*tmp(i) + s(i,ntoplw,ntoplw+1)<a name='5124'>
      fsdl(i,ntoplw) = stebol*(tplnke(i)**4)*emstot(i,ntoplw)<a name='5125'>
   end do<a name='5126'>
<font color=#447700>!<a name='5127'></font>
<font color=#447700>! fsdl(i,pverp) assumes isothermal layer<a name='5128'></font>
<font color=#447700>!<a name='5129'></font>
   do k=ntoplw+1,pver<a name='5130'>
      do i=1,ncol<a name='5131'>
         fsul(i,k) = fsul(i,pverp) - abstot(i,k,pverp)*tmp(i) + s(i,k,k+1)<a name='5132'>
         fsdl(i,k) = stebol*(tplnke(i)**4)*emstot(i,k) - (s(i,k,ntoplw+1) - s(i,k,k+1))<a name='5133'>
      end do<a name='5134'>
   end do<a name='5135'>
<font color=#447700>!<a name='5136'></font>
<font color=#447700>! Store the downward emission from level 1 = total gas emission * sigma<a name='5137'></font>
<font color=#447700>! t**4.  fsdl does not yet include all terms<a name='5138'></font>
<font color=#447700>!<a name='5139'></font>
   do i=1,ncol<a name='5140'>
      absbt(i) = stebol*(tplnke(i)**4)*emstot(i,pverp)<a name='5141'>
      fsdl(i,pverp) = absbt(i) - s(i,pverp,ntoplw+1)<a name='5142'>
   end do<a name='5143'>
<font color=#447700>!<a name='5144'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='5145'></font>
<font color=#447700>! Modifications for clouds -- max/random overlap assumption<a name='5146'></font>
<font color=#447700>!<a name='5147'></font>
<font color=#447700>! The column is divided into sets of adjacent layers, called regions,<a name='5148'></font>
<font color=#447700>!   in which the clouds are maximally overlapped.  The clouds are<a name='5149'></font>
<font color=#447700>!   randomly overlapped between different regions.  The number of<a name='5150'></font>
<font color=#447700>!   regions in a column is set by nmxrgn, and the range of pressures<a name='5151'></font>
<font color=#447700>!   included in each region is set by pmxrgn.  The max/random overlap<a name='5152'></font>
<font color=#447700>!   can be written in terms of the solutions of random overlap with<a name='5153'></font>
<font color=#447700>!   cloud amounts = 1.  The random overlap assumption is equivalent to<a name='5154'></font>
<font color=#447700>!   setting the flux boundary conditions (BCs) at the edges of each region<a name='5155'></font>
<font color=#447700>!   equal to the mean all-sky flux at those boundaries.  Since the<a name='5156'></font>
<font color=#447700>!   emissivity array for propogating BCs is only computed for the<a name='5157'></font>
<font color=#447700>!   TOA BC, the flux BCs elsewhere in the atmosphere have to be formulated<a name='5158'></font>
<font color=#447700>!   in terms of solutions to the random overlap equations.  This is done<a name='5159'></font>
<font color=#447700>!   by writing the flux BCs as the sum of a clear-sky flux and emission<a name='5160'></font>
<font color=#447700>!   from a cloud outside the region weighted by an emissivity.  This<a name='5161'></font>
<font color=#447700>!   emissivity is determined from the location of the cloud and the<a name='5162'></font>
<font color=#447700>!   flux BC.<a name='5163'></font>
<font color=#447700>!<a name='5164'></font>
<font color=#447700>! Copy cloud amounts to buffer with extra layer (needed for overlap logic)<a name='5165'></font>
<font color=#447700>!<a name='5166'></font>
   cldp(:ncol,ntoplw:pver) = cld(:ncol,ntoplw:pver)<a name='5167'>
   cldp(:ncol,pverp) = 0.0<a name='5168'>
<font color=#447700>!<a name='5169'></font>
<font color=#447700>!<a name='5170'></font>
<font color=#447700>! Select only those locations where there are no clouds<a name='5171'></font>
<font color=#447700>!    (maximum cloud fraction &lt;= 1.e-3 treated as clear)<a name='5172'></font>
<font color=#447700>!    Set all-sky fluxes to clear-sky values.<a name='5173'></font>
<font color=#447700>!<a name='5174'></font>
   maxcld(1:ncol) = maxval(cldp(1:ncol,ntoplw:pver),dim=2)<a name='5175'>
<a name='5176'>
   npts = 0<a name='5177'>
   do i=1,ncol<a name='5178'>
      if (maxcld(i) &lt; cldmin) then<a name='5179'>
         npts = npts + 1<a name='5180'>
         indx(npts) = i<a name='5181'>
      end if<a name='5182'>
   end do<a name='5183'>
<a name='5184'>
   do ii = 1, npts<a name='5185'>
      i = indx(ii)<a name='5186'>
      do k = ntoplw, pverp<a name='5187'>
         fdl(i,k) = fsdl(i,k)<a name='5188'>
         ful(i,k) = fsul(i,k)<a name='5189'>
      end do<a name='5190'>
   end do<a name='5191'>
<font color=#447700>!<a name='5192'></font>
<font color=#447700>! Select only those locations where there are clouds<a name='5193'></font>
<font color=#447700>!<a name='5194'></font>
   npts = 0<a name='5195'>
   do i=1,ncol<a name='5196'>
      if (maxcld(i) &gt;= cldmin) then<a name='5197'>
         npts = npts + 1<a name='5198'>
         indx(npts) = i<a name='5199'>
      end if<a name='5200'>
   end do<a name='5201'>
<a name='5202'>
<font color=#447700>!<a name='5203'></font>
<font color=#447700>! Initialize all-sky fluxes. fdl(i,1) &amp; ful(i,pverp) are boundary conditions<a name='5204'></font>
<font color=#447700>!<a name='5205'></font>
   do ii = 1, npts<a name='5206'>
      i = indx(ii)<a name='5207'>
      fdl(i,ntoplw) = fsdl(i,ntoplw)<a name='5208'>
      fdl(i,pverp)  = 0.0<a name='5209'>
      ful(i,ntoplw) = 0.0<a name='5210'>
      ful(i,pverp)  = fsul(i,pverp)<a name='5211'>
      do k = ntoplw+1, pver<a name='5212'>
         fdl(i,k) = 0.0<a name='5213'>
         ful(i,k) = 0.0<a name='5214'>
      end do<a name='5215'>
<font color=#447700>!<a name='5216'></font>
<font color=#447700>! Initialize Planck emission from layer boundaries<a name='5217'></font>
<font color=#447700>!<a name='5218'></font>
      do k = ntoplw, pver<a name='5219'>
         fclt4(i,k-1) = stebol*tint4(i,k)<a name='5220'>
         fclb4(i,k-1) = stebol*tint4(i,k+1)<a name='5221'>
      enddo<a name='5222'>
      fclb4(i,ntoplw-2) =  stebol*tint4(i,ntoplw)<a name='5223'>
      fclt4(i,pver)     = stebol*tint4(i,pverp)<a name='5224'>
<font color=#447700>!<a name='5225'></font>
<font color=#447700>! Initialize indices for layers to be max-overlapped<a name='5226'></font>
<font color=#447700>!<a name='5227'></font>
      do irgn = 0, nmxrgn(i)<a name='5228'>
         kx2(i,irgn) = ntoplw-1<a name='5229'>
      end do<a name='5230'>
      nrgn(i) = 0<a name='5231'>
   end do<a name='5232'>
<a name='5233'>
<font color=#447700>!----------------------------------------------------------------------<a name='5234'></font>
<font color=#447700>! INDEX CALCULATIONS FOR MAX OVERLAP<a name='5235'></font>
<a name='5236'>
   do ii = 1, npts<a name='5237'>
      ilon = indx(ii)<a name='5238'>
<a name='5239'>
<font color=#447700>!<a name='5240'></font>
<font color=#447700>! Outermost loop over regions (sets of adjacent layers) to be max overlapped<a name='5241'></font>
<font color=#447700>!<a name='5242'></font>
      do irgn = 1, nmxrgn(ilon)<a name='5243'>
<font color=#447700>!<a name='5244'></font>
<font color=#447700>! Calculate min/max layer indices inside region.<a name='5245'></font>
<font color=#447700>!<a name='5246'></font>
         n = 0<a name='5247'>
         if (kx2(ilon,irgn-1) &lt; pver) then<a name='5248'>
            nrgn(ilon) = irgn<a name='5249'>
            k1 = kx2(ilon,irgn-1)+1<a name='5250'>
            kx1(ilon,irgn) = k1<a name='5251'>
            kx2(ilon,irgn) = 0<a name='5252'>
            do k2 = pver, k1, -1<a name='5253'>
               if (pmid(ilon,k2) &lt;= pmxrgn(ilon,irgn)) then<a name='5254'>
                  kx2(ilon,irgn) = k2<a name='5255'>
                  exit<a name='5256'>
               end if<a name='5257'>
            end do<a name='5258'>
<font color=#447700>!<a name='5259'></font>
<font color=#447700>! Identify columns with clouds in the given region.<a name='5260'></font>
<font color=#447700>!<a name='5261'></font>
            do k = k1, k2<a name='5262'>
               if (cldp(ilon,k) &gt;= cldmin) then<a name='5263'>
                  n = n+1<a name='5264'>
                  indxmx(n,irgn) = ilon<a name='5265'>
                  exit<a name='5266'>
               endif<a name='5267'>
            end do<a name='5268'>
         endif<a name='5269'>
         ncolmx(irgn) = n<a name='5270'>
<font color=#447700>!<a name='5271'></font>
<font color=#447700>! Dummy value for handling clear-sky regions<a name='5272'></font>
<font color=#447700>!<a name='5273'></font>
<font color=#447700>!!$         indxmx(ncolmx(irgn)+1,irgn) = ncol+1<a name='5274'></font>
<font color=#447700>!<a name='5275'></font>
<font color=#447700>! Outer loop over columns with clouds in the max-overlap region<a name='5276'></font>
<font color=#447700>!<a name='5277'></font>
         do iimx = 1, ncolmx(irgn)<a name='5278'>
            i = indxmx(iimx,irgn)<a name='5279'>
<font color=#447700>!<a name='5280'></font>
<font color=#447700>! Sort cloud areas and corresponding level indices.<a name='5281'></font>
<font color=#447700>!<a name='5282'></font>
            n = 0<a name='5283'>
            do k = kx1(i,irgn),kx2(i,irgn)<a name='5284'>
               if (cldp(i,k) &gt;= cldmin) then<a name='5285'>
                  n = n+1<a name='5286'>
                  ksort(n) = k<a name='5287'>
<font color=#447700>!<a name='5288'></font>
<font color=#447700>! We need indices for clouds in order of largest to smallest, so<a name='5289'></font>
<font color=#447700>!    sort 1-cld in ascending order<a name='5290'></font>
<font color=#447700>!<a name='5291'></font>
                  asort(n) = 1.0-cldp(i,k)<a name='5292'>
               end if<a name='5293'>
            end do<a name='5294'>
            nxs(i,irgn) = n<a name='5295'>
<font color=#447700>!<a name='5296'></font>
<font color=#447700>! If nxs(i,irgn) eq 1, no need to sort.<a name='5297'></font>
<font color=#447700>! If nxs(i,irgn) eq 2, sort by swapping if necessary<a name='5298'></font>
<font color=#447700>! If nxs(i,irgn) ge 3, sort using local sort routine<a name='5299'></font>
<font color=#447700>!<a name='5300'></font>
            if (nxs(i,irgn) == 2) then<a name='5301'>
               if (asort(2) &lt; asort(1)) then<a name='5302'>
                  ktmp = ksort(1)<a name='5303'>
                  ksort(1) = ksort(2)<a name='5304'>
                  ksort(2) = ktmp<a name='5305'>
<a name='5306'>
                  atmp = asort(1)<a name='5307'>
                  asort(1) = asort(2)<a name='5308'>
                  asort(2) = atmp<a name='5309'>
               endif<a name='5310'>
            else if (nxs(i,irgn) &gt;= 3) then<a name='5311'>
               call <A href='../../html_code/phys/module_ra_cam_support.F.html#SORTARRAY'>sortarray</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCLWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SORTARRAY_1">(nxs(i,irgn),asort,ksort(1:))<a name='5312'>
            endif<a name='5313'>
<a name='5314'>
            do l = 1, nxs(i,irgn)<a name='5315'>
               kxs(l,i,irgn) = ksort(l)<a name='5316'>
            end do<a name='5317'>
<font color=#447700>!<a name='5318'></font>
<font color=#447700>! End loop over longitude i for fluxes<a name='5319'></font>
<font color=#447700>!<a name='5320'></font>
         end do<a name='5321'>
<font color=#447700>!<a name='5322'></font>
<font color=#447700>! End loop over regions irgn for max-overlap<a name='5323'></font>
<font color=#447700>!<a name='5324'></font>
      end do<a name='5325'>
<font color=#447700>!<a name='5326'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='5327'></font>
<font color=#447700>! DOWNWARD FLUXES:<a name='5328'></font>
<font color=#447700>! Outermost loop over regions (sets of adjacent layers) to be max overlapped<a name='5329'></font>
<font color=#447700>!<a name='5330'></font>
      do irgn = 1, nmxrgn(ilon)<a name='5331'>
<font color=#447700>!<a name='5332'></font>
<font color=#447700>! Compute clear-sky fluxes for regions without clouds<a name='5333'></font>
<font color=#447700>!<a name='5334'></font>
         iimx = 1<a name='5335'>
         if (ilon &lt; indxmx(iimx,irgn) .and. irgn &lt;= nrgn(ilon)) then<a name='5336'>
<font color=#447700>!<a name='5337'></font>
<font color=#447700>! Calculate emissivity so that downward flux at upper boundary of region<a name='5338'></font>
<font color=#447700>!    can be cast in form of solution for downward flux from cloud above<a name='5339'></font>
<font color=#447700>!    that boundary.  Then solutions for fluxes at other levels take form of<a name='5340'></font>
<font color=#447700>!    random overlap expressions.  Try to locate "cloud" as close as possible<a name='5341'></font>
<font color=#447700>!    to TOA such that the "cloud" pseudo-emissivity is between 0 and 1.<a name='5342'></font>
<font color=#447700>!<a name='5343'></font>
            k1 = kx1(ilon,irgn)<a name='5344'>
            do km1 = ntoplw-2, k1-2<a name='5345'>
               km4 = km1+3<a name='5346'>
               k2 = k1<a name='5347'>
               k3 = k2+1<a name='5348'>
               tmp(ilon) = s(ilon,k2,min(k3,pverp))*min(1,pverp2-k3)<a name='5349'>
               emx0 = (fdl(ilon,k1)-fsdl(ilon,k1))/ &amp;<a name='5350'>
                      ((fclb4(ilon,km1)-s(ilon,k2,km4)+tmp(ilon))- fsdl(ilon,k1))<a name='5351'>
               if (emx0 &gt;= 0.0 .and. emx0 &lt;= 1.0) exit<a name='5352'>
            end do<a name='5353'>
            km1 = min(km1,k1-2)<a name='5354'>
            do k2 = kx1(ilon,irgn)+1, kx2(ilon,irgn)+1<a name='5355'>
               k3 = k2+1<a name='5356'>
               tmp(ilon) = s(ilon,k2,min(k3,pverp))*min(1,pverp2-k3)<a name='5357'>
               fdl(ilon,k2) = (1.0-emx0)*fsdl(ilon,k2) + &amp;<a name='5358'>
                               emx0*(fclb4(ilon,km1)-s(ilon,k2,km4)+tmp(ilon))<a name='5359'>
            end do<a name='5360'>
         else if (ilon==indxmx(iimx,irgn) .and. iimx&lt;=ncolmx(irgn)) then<a name='5361'>
            iimx = iimx+1<a name='5362'>
         end if<a name='5363'>
<font color=#447700>!<a name='5364'></font>
<font color=#447700>! Outer loop over columns with clouds in the max-overlap region<a name='5365'></font>
<font color=#447700>!<a name='5366'></font>
         do iimx = 1, ncolmx(irgn)<a name='5367'>
            i = indxmx(iimx,irgn)<a name='5368'>
<a name='5369'>
<font color=#447700>!<a name='5370'></font>
<font color=#447700>! Calculate emissivity so that downward flux at upper boundary of region<a name='5371'></font>
<font color=#447700>!    can be cast in form of solution for downward flux from cloud above that<a name='5372'></font>
<font color=#447700>!    boundary.  Then solutions for fluxes at other levels take form of<a name='5373'></font>
<font color=#447700>!    random overlap expressions.  Try to locate "cloud" as close as possible<a name='5374'></font>
<font color=#447700>!    to TOA such that the "cloud" pseudo-emissivity is between 0 and 1.<a name='5375'></font>
<font color=#447700>!<a name='5376'></font>
            k1 = kx1(i,irgn)<a name='5377'>
            do km1 = ntoplw-2,k1-2<a name='5378'>
               km4 = km1+3<a name='5379'>
               k2 = k1<a name='5380'>
               k3 = k2 + 1<a name='5381'>
               tmp(i) = s(i,k2,min(k3,pverp))*min(1,pverp2-k3)<a name='5382'>
               tmp2(i) = s(i,k2,min(km4,pverp))*min(1,pverp2-km4)<a name='5383'>
               emx0 = (fdl(i,k1)-fsdl(i,k1))/((fclb4(i,km1)-tmp2(i)+tmp(i))-fsdl(i,k1))<a name='5384'>
               if (emx0 &gt;= 0.0 .and. emx0 &lt;= 1.0) exit<a name='5385'>
            end do<a name='5386'>
            km1 = min(km1,k1-2)<a name='5387'>
            ksort(0) = km1 + 1<a name='5388'>
<font color=#447700>!<a name='5389'></font>
<font color=#447700>! Loop to calculate fluxes at level k<a name='5390'></font>
<font color=#447700>!<a name='5391'></font>
            nxsk = 0<a name='5392'>
            do k = kx1(i,irgn), kx2(i,irgn)<a name='5393'>
<font color=#447700>!<a name='5394'></font>
<font color=#447700>! Identify clouds (largest to smallest area) between kx1 and k<a name='5395'></font>
<font color=#447700>!    Since nxsk will increase with increasing k up to nxs(i,irgn), once<a name='5396'></font>
<font color=#447700>!    nxsk == nxs(i,irgn) then use the list constructed for previous k<a name='5397'></font>
<font color=#447700>!<a name='5398'></font>
               if (nxsk &lt; nxs(i,irgn)) then<a name='5399'>
                  nxsk = 0<a name='5400'>
                  do l = 1, nxs(i,irgn)<a name='5401'>
                     k1 = kxs(l,i,irgn)<a name='5402'>
                     if (k &gt;= k1) then<a name='5403'>
                        nxsk = nxsk + 1<a name='5404'>
                        ksort(nxsk) = k1<a name='5405'>
                     endif<a name='5406'>
                  end do<a name='5407'>
               endif<a name='5408'>
<font color=#447700>!<a name='5409'></font>
<font color=#447700>! Dummy value of index to insure computation of cloud amt is valid for l=nxsk+1<a name='5410'></font>
<font color=#447700>!<a name='5411'></font>
               ksort(nxsk+1) = pverp<a name='5412'>
<font color=#447700>!<a name='5413'></font>
<font color=#447700>! Initialize iterated emissivity factors<a name='5414'></font>
<font color=#447700>!<a name='5415'></font>
               do l = 1, nxsk<a name='5416'>
                  emx(l) = emis(i,ksort(l))<a name='5417'>
               end do<a name='5418'>
<font color=#447700>!<a name='5419'></font>
<font color=#447700>! Initialize iterated emissivity factor for bnd. condition at upper interface<a name='5420'></font>
<font color=#447700>!<a name='5421'></font>
               emx(0) = emx0<a name='5422'>
<font color=#447700>!<a name='5423'></font>
<font color=#447700>! Initialize previous cloud amounts<a name='5424'></font>
<font color=#447700>!<a name='5425'></font>
               cld0 = 1.0<a name='5426'>
<font color=#447700>!<a name='5427'></font>
<font color=#447700>! Indices for flux calculations<a name='5428'></font>
<font color=#447700>!<a name='5429'></font>
               k2 = k+1<a name='5430'>
               k3 = k2+1<a name='5431'>
               tmp(i) = s(i,k2,min(k3,pverp))*min(1,pverp2-k3)<a name='5432'>
<font color=#447700>!<a name='5433'></font>
<font color=#447700>! Loop over number of cloud levels inside region (biggest to smallest cld area)<a name='5434'></font>
<font color=#447700>!<a name='5435'></font>
               do l = 1, nxsk+1<a name='5436'>
<font color=#447700>!<a name='5437'></font>
<font color=#447700>! Calculate downward fluxes<a name='5438'></font>
<font color=#447700>!<a name='5439'></font>
                  cld1 = cldp(i,ksort(l))*min(1,nxsk+1-l)<a name='5440'>
                  if (cld0 /= cld1) then<a name='5441'>
                     fdl(i,k2) = fdl(i,k2)+(cld0-cld1)*fsdl(i,k2)<a name='5442'>
                     do l1 = 0, l - 1<a name='5443'>
                        km1 = ksort(l1)-1<a name='5444'>
                        km4 = km1+3<a name='5445'>
                        tmp2(i) = s(i,k2,min(km4,pverp))* min(1,pverp2-km4)<a name='5446'>
                        fdl(i,k2) = fdl(i,k2)+(cld0-cld1)*emx(l1)*(fclb4(i,km1)-tmp2(i)+tmp(i)- &amp;<a name='5447'>
                                    fsdl(i,k2))<a name='5448'>
                     end do<a name='5449'>
                  endif<a name='5450'>
                  cld0 = cld1<a name='5451'>
<font color=#447700>!<a name='5452'></font>
<font color=#447700>! Multiply emissivity factors by current cloud transmissivity<a name='5453'></font>
<font color=#447700>!<a name='5454'></font>
                  if (l &lt;= nxsk) then<a name='5455'>
                     k1 = ksort(l)<a name='5456'>
                     trans = 1.0-emis(i,k1)<a name='5457'>
<font color=#447700>!<a name='5458'></font>
<font color=#447700>! Ideally the upper bound on l1 would be l-1, but the sort routine<a name='5459'></font>
<font color=#447700>!    scrambles the order of layers with identical cloud amounts<a name='5460'></font>
<font color=#447700>!<a name='5461'></font>
                     do l1 = 0, nxsk<a name='5462'>
                        if (ksort(l1) &lt; k1) then<a name='5463'>
                           emx(l1) = emx(l1)*trans<a name='5464'>
                        endif<a name='5465'>
                     end do<a name='5466'>
                  end if<a name='5467'>
<font color=#447700>!<a name='5468'></font>
<font color=#447700>! End loop over number l of cloud levels<a name='5469'></font>
<font color=#447700>!<a name='5470'></font>
               end do<a name='5471'>
<font color=#447700>!<a name='5472'></font>
<font color=#447700>! End loop over level k for fluxes<a name='5473'></font>
<font color=#447700>!<a name='5474'></font>
            end do<a name='5475'>
<font color=#447700>!<a name='5476'></font>
<font color=#447700>! End loop over longitude i for fluxes<a name='5477'></font>
<font color=#447700>!<a name='5478'></font>
         end do<a name='5479'>
<font color=#447700>!<a name='5480'></font>
<font color=#447700>! End loop over regions irgn for max-overlap<a name='5481'></font>
<font color=#447700>!<a name='5482'></font>
      end do<a name='5483'>
<a name='5484'>
<font color=#447700>!<a name='5485'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='5486'></font>
<font color=#447700>! UPWARD FLUXES:<a name='5487'></font>
<font color=#447700>! Outermost loop over regions (sets of adjacent layers) to be max overlapped<a name='5488'></font>
<font color=#447700>!<a name='5489'></font>
      do irgn = nmxrgn(ilon), 1, -1<a name='5490'>
<font color=#447700>!<a name='5491'></font>
<font color=#447700>! Compute clear-sky fluxes for regions without clouds<a name='5492'></font>
<font color=#447700>!<a name='5493'></font>
         iimx = 1<a name='5494'>
         if (ilon &lt; indxmx(iimx,irgn) .and. irgn &lt;= nrgn(ilon)) then<a name='5495'>
<font color=#447700>!<a name='5496'></font>
<font color=#447700>! Calculate emissivity so that upward flux at lower boundary of region<a name='5497'></font>
<font color=#447700>!    can be cast in form of solution for upward flux from cloud below that<a name='5498'></font>
<font color=#447700>!    boundary.  Then solutions for fluxes at other levels take form of<a name='5499'></font>
<font color=#447700>!    random overlap expressions.  Try to locate "cloud" as close as possible<a name='5500'></font>
<font color=#447700>!    to surface such that the "cloud" pseudo-emissivity is between 0 and 1.<a name='5501'></font>
<font color=#447700>! Include allowance for surface emissivity (both numerator and denominator<a name='5502'></font>
<font color=#447700>!    equal 1)<a name='5503'></font>
<font color=#447700>!<a name='5504'></font>
            k1 = kx2(ilon,irgn)+1<a name='5505'>
            if (k1 &lt; pverp) then<a name='5506'>
               do km1 = pver-1,kx2(ilon,irgn),-1<a name='5507'>
                  km3 = km1+2<a name='5508'>
                  k2 = k1<a name='5509'>
                  k3 = k2+1<a name='5510'>
                  tmp(ilon) = s(ilon,k2,min(km3,pverp))* min(1,pverp2-km3)<a name='5511'>
                  emx0 = (ful(ilon,k1)-fsul(ilon,k1))/ &amp;<a name='5512'>
                         ((fclt4(ilon,km1)+s(ilon,k2,k3)-tmp(ilon))- fsul(ilon,k1))<a name='5513'>
                  if (emx0 &gt;= 0.0 .and. emx0 &lt;= 1.0) exit<a name='5514'>
               end do<a name='5515'>
               km1 = max(km1,kx2(ilon,irgn))<a name='5516'>
            else<a name='5517'>
               km1 = k1-1<a name='5518'>
               km3 = km1+2<a name='5519'>
               emx0 = 1.0<a name='5520'>
            endif<a name='5521'>
<a name='5522'>
            do k2 = kx1(ilon,irgn), kx2(ilon,irgn)<a name='5523'>
               k3 = k2+1<a name='5524'>
<font color=#447700>!<a name='5525'></font>
<font color=#447700>! If km3 == pver+2, one of the s integrals = 0 (integration limits both = p_s)<a name='5526'></font>
<font color=#447700>!<a name='5527'></font>
               tmp(ilon) = s(ilon,k2,min(km3,pverp))* min(1,pverp2-km3)<a name='5528'>
               ful(ilon,k2) =(1.0-emx0)*fsul(ilon,k2) + emx0* &amp;<a name='5529'>
                             (fclt4(ilon,km1)+s(ilon,k2,k3)-tmp(ilon))<a name='5530'>
            end do<a name='5531'>
         else if (ilon==indxmx(iimx,irgn) .and. iimx&lt;=ncolmx(irgn)) then<a name='5532'>
            iimx = iimx+1<a name='5533'>
         end if<a name='5534'>
<font color=#447700>!<a name='5535'></font>
<font color=#447700>! Outer loop over columns with clouds in the max-overlap region<a name='5536'></font>
<font color=#447700>!<a name='5537'></font>
         do iimx = 1, ncolmx(irgn)<a name='5538'>
            i = indxmx(iimx,irgn)<a name='5539'>
<a name='5540'>
<font color=#447700>!<a name='5541'></font>
<font color=#447700>! Calculate emissivity so that upward flux at lower boundary of region<a name='5542'></font>
<font color=#447700>!    can be cast in form of solution for upward flux from cloud at that<a name='5543'></font>
<font color=#447700>!    boundary.  Then solutions for fluxes at other levels take form of<a name='5544'></font>
<font color=#447700>!    random overlap expressions.  Try to locate "cloud" as close as possible<a name='5545'></font>
<font color=#447700>!    to surface such that the "cloud" pseudo-emissivity is between 0 and 1.<a name='5546'></font>
<font color=#447700>! Include allowance for surface emissivity (both numerator and denominator<a name='5547'></font>
<font color=#447700>!    equal 1)<a name='5548'></font>
<font color=#447700>!<a name='5549'></font>
            k1 = kx2(i,irgn)+1<a name='5550'>
            if (k1 &lt; pverp) then<a name='5551'>
               do km1 = pver-1,kx2(i,irgn),-1<a name='5552'>
                  km3 = km1+2<a name='5553'>
                  k2 = k1<a name='5554'>
                  k3 = k2+1<a name='5555'>
                  tmp(i) = s(i,k2,min(km3,pverp))*min(1,pverp2-km3)<a name='5556'>
                  emx0 = (ful(i,k1)-fsul(i,k1))/((fclt4(i,km1)+s(i,k2,k3)-tmp(i))-fsul(i,k1))<a name='5557'>
                  if (emx0 &gt;= 0.0 .and. emx0 &lt;= 1.0) exit<a name='5558'>
               end do<a name='5559'>
               km1 = max(km1,kx2(i,irgn))<a name='5560'>
            else<a name='5561'>
               emx0 = 1.0<a name='5562'>
               km1 = k1-1<a name='5563'>
            endif<a name='5564'>
            ksort(0) = km1 + 1<a name='5565'>
<a name='5566'>
<font color=#447700>!<a name='5567'></font>
<font color=#447700>! Loop to calculate fluxes at level k<a name='5568'></font>
<font color=#447700>!<a name='5569'></font>
            nxsk = 0<a name='5570'>
            do k = kx2(i,irgn), kx1(i,irgn), -1<a name='5571'>
<font color=#447700>!<a name='5572'></font>
<font color=#447700>! Identify clouds (largest to smallest area) between k and kx2<a name='5573'></font>
<font color=#447700>!    Since nxsk will increase with decreasing k up to nxs(i,irgn), once<a name='5574'></font>
<font color=#447700>!    nxsk == nxs(i,irgn) then use the list constructed for previous k<a name='5575'></font>
<font color=#447700>!<a name='5576'></font>
               if (nxsk &lt; nxs(i,irgn)) then<a name='5577'>
                  nxsk = 0<a name='5578'>
                  do l = 1, nxs(i,irgn)<a name='5579'>
                     k1 = kxs(l,i,irgn)<a name='5580'>
                     if (k &lt;= k1) then<a name='5581'>
                        nxsk = nxsk + 1<a name='5582'>
                        ksort(nxsk) = k1<a name='5583'>
                     endif<a name='5584'>
                  end do<a name='5585'>
               endif<a name='5586'>
<font color=#447700>!<a name='5587'></font>
<font color=#447700>! Dummy value of index to insure computation of cloud amt is valid for l=nxsk+1<a name='5588'></font>
<font color=#447700>!<a name='5589'></font>
               ksort(nxsk+1) = pverp<a name='5590'>
<font color=#447700>!<a name='5591'></font>
<font color=#447700>! Initialize iterated emissivity factors<a name='5592'></font>
<font color=#447700>!<a name='5593'></font>
               do l = 1, nxsk<a name='5594'>
                  emx(l) = emis(i,ksort(l))<a name='5595'>
               end do<a name='5596'>
<font color=#447700>!<a name='5597'></font>
<font color=#447700>! Initialize iterated emissivity factor for bnd. condition at lower interface<a name='5598'></font>
<font color=#447700>!<a name='5599'></font>
               emx(0) = emx0<a name='5600'>
<font color=#447700>!<a name='5601'></font>
<font color=#447700>! Initialize previous cloud amounts<a name='5602'></font>
<font color=#447700>!<a name='5603'></font>
               cld0 = 1.0<a name='5604'>
<font color=#447700>!<a name='5605'></font>
<font color=#447700>! Indices for flux calculations<a name='5606'></font>
<font color=#447700>!<a name='5607'></font>
               k2 = k<a name='5608'>
               k3 = k2+1<a name='5609'>
<font color=#447700>!<a name='5610'></font>
<font color=#447700>! Loop over number of cloud levels inside region (biggest to smallest cld area)<a name='5611'></font>
<font color=#447700>!<a name='5612'></font>
               do l = 1, nxsk+1<a name='5613'>
<font color=#447700>!<a name='5614'></font>
<font color=#447700>! Calculate upward fluxes<a name='5615'></font>
<font color=#447700>!<a name='5616'></font>
                  cld1 = cldp(i,ksort(l))*min(1,nxsk+1-l)<a name='5617'>
                  if (cld0 /= cld1) then<a name='5618'>
                     ful(i,k2) = ful(i,k2)+(cld0-cld1)*fsul(i,k2)<a name='5619'>
                     do l1 = 0, l - 1<a name='5620'>
                        km1 = ksort(l1)-1<a name='5621'>
                        km3 = km1+2<a name='5622'>
<font color=#447700>!<a name='5623'></font>
<font color=#447700>! If km3 == pver+2, one of the s integrals = 0 (integration limits both = p_s)<a name='5624'></font>
<font color=#447700>!<a name='5625'></font>
                        tmp(i) = s(i,k2,min(km3,pverp))* min(1,pverp2-km3)<a name='5626'>
                        ful(i,k2) = ful(i,k2)+(cld0-cld1)*emx(l1)* &amp;<a name='5627'>
                                   (fclt4(i,km1)+s(i,k2,k3)-tmp(i)- fsul(i,k2))<a name='5628'>
                     end do<a name='5629'>
                  endif<a name='5630'>
                  cld0 = cld1<a name='5631'>
<font color=#447700>!<a name='5632'></font>
<font color=#447700>! Multiply emissivity factors by current cloud transmissivity<a name='5633'></font>
<font color=#447700>!<a name='5634'></font>
                  if (l &lt;= nxsk) then<a name='5635'>
                     k1 = ksort(l)<a name='5636'>
                     trans = 1.0-emis(i,k1)<a name='5637'>
<font color=#447700>!<a name='5638'></font>
<font color=#447700>! Ideally the upper bound on l1 would be l-1, but the sort routine<a name='5639'></font>
<font color=#447700>!    scrambles the order of layers with identical cloud amounts<a name='5640'></font>
<font color=#447700>!<a name='5641'></font>
                     do l1 = 0, nxsk<a name='5642'>
                        if (ksort(l1) &gt; k1) then<a name='5643'>
                           emx(l1) = emx(l1)*trans<a name='5644'>
                        endif<a name='5645'>
                     end do<a name='5646'>
                  end if<a name='5647'>
<font color=#447700>!<a name='5648'></font>
<font color=#447700>! End loop over number l of cloud levels<a name='5649'></font>
<font color=#447700>!<a name='5650'></font>
               end do<a name='5651'>
<font color=#447700>!<a name='5652'></font>
<font color=#447700>! End loop over level k for fluxes<a name='5653'></font>
<font color=#447700>!<a name='5654'></font>
            end do<a name='5655'>
<font color=#447700>!<a name='5656'></font>
<font color=#447700>! End loop over longitude i for fluxes<a name='5657'></font>
<font color=#447700>!<a name='5658'></font>
         end do<a name='5659'>
<font color=#447700>!<a name='5660'></font>
<font color=#447700>! End loop over regions irgn for max-overlap<a name='5661'></font>
<font color=#447700>!<a name='5662'></font>
      end do<a name='5663'>
<font color=#447700>!<a name='5664'></font>
<font color=#447700>! End outermost longitude loop<a name='5665'></font>
<font color=#447700>!<a name='5666'></font>
   end do<a name='5667'>
<font color=#447700>!<a name='5668'></font>
<font color=#447700>! End cloud modification loops<a name='5669'></font>
<font color=#447700>!<a name='5670'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='5671'></font>
<font color=#447700>! All longitudes: store history tape quantities<a name='5672'></font>
<font color=#447700>!<a name='5673'></font>
   do i=1,ncol<a name='5674'>
      flwds(i) = fdl (i,pverp )<a name='5675'>
      flns(i)  = ful (i,pverp ) - fdl (i,pverp )<a name='5676'>
      flnsc(i) = fsul(i,pverp ) - fsdl(i,pverp )<a name='5677'>
      flnt(i)  = ful (i,ntoplw) - fdl (i,ntoplw)<a name='5678'>
      flntc(i) = fsul(i,ntoplw) - fsdl(i,ntoplw)<a name='5679'>
      flut(i)  = ful (i,ntoplw)<a name='5680'>
      flutc(i) = fsul(i,ntoplw)<a name='5681'>
   end do<a name='5682'>
<font color=#447700>!<a name='5683'></font>
<font color=#447700>! Computation of longwave heating (J/kg/s)<a name='5684'></font>
<font color=#447700>!<a name='5685'></font>
   do k=ntoplw,pver<a name='5686'>
      do i=1,ncol<a name='5687'>
         qrl(i,k) = (ful(i,k) - fdl(i,k) - ful(i,k+1) + fdl(i,k+1))* &amp;<a name='5688'>
                     1.E-4*gravit/((pint(i,k) - pint(i,k+1)))<a name='5689'>
      end do<a name='5690'>
   end do<a name='5691'>
<font color=#447700>! Return 0 above solution domain<a name='5692'></font>
   if ( ntoplw &gt; 1 )then<a name='5693'>
      qrl(:ncol,:ntoplw-1) = 0.<a name='5694'>
   end if<a name='5695'>
<a name='5696'>
<font color=#447700>! Added downward/upward total and clear sky fluxes<a name='5697'></font>
<font color=#447700>!<a name='5698'></font>
   do k=ntoplw,pverp<a name='5699'>
      do i=1,ncol<a name='5700'>
        flup(i,k)  = ful(i,k)<a name='5701'>
        flupc(i,k) = fsul(i,k)<a name='5702'>
        fldn(i,k)  = fdl(i,k)<a name='5703'>
        fldnc(i,k) = fsdl(i,k)<a name='5704'>
      end do<a name='5705'>
   end do<a name='5706'>
<font color=#447700>! Return 0 above solution domain<a name='5707'></font>
   if ( ntoplw &gt; 1 )then<a name='5708'>
      flup(:ncol,:ntoplw-1) = 0.<a name='5709'>
      flupc(:ncol,:ntoplw-1) = 0.<a name='5710'>
      fldn(:ncol,:ntoplw-1) = 0.<a name='5711'>
      fldnc(:ncol,:ntoplw-1) = 0.<a name='5712'>
   end if<a name='5713'>
<font color=#447700>!<a name='5714'></font>
   return<a name='5715'>
end subroutine radclwmx<a name='5716'>
<a name='5717'>
<A NAME='RADCSWMX'><A href='../../html_code/phys/module_ra_cam.F.html#RADCSWMX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5718'>
<font color=#993300>subroutine </font><font color=#cc0000>radcswmx</font>(jj, lchnk   ,ncol    ,pcols, pver, pverp,         &amp; <A href='../../call_to/RADCSWMX.html' TARGET='index'>2</A>,<A href='../../call_from/RADCSWMX.html' TARGET='index'>4</A><a name='5719'>
                    pint    ,pmid    ,h2ommr  ,rh      ,o3mmr   , &amp;<a name='5720'>
                    aermmr  ,cld     ,cicewp  ,cliqwp  ,rel     , &amp;<a name='5721'>
<font color=#447700>!                   rei     ,eccf    ,coszrs  ,scon    ,solin   ,solcon,  &amp;<a name='5722'></font>
                    rei     ,tauxcl  ,tauxci  ,eccf    ,coszrs  ,scon    ,solin   ,solcon,  &amp;<a name='5723'>
                    asdir   ,asdif   ,aldir   ,aldif   ,nmxrgn  , &amp;<a name='5724'>
                    pmxrgn  ,qrs     ,fsnt    ,fsntc   ,fsntoa  , &amp;<a name='5725'>
                    fsntoac ,fsnirtoa,fsnrtoac,fsnrtoaq,fsns    , &amp;<a name='5726'>
                    fsnsc   ,fsdsc   ,fsds    ,sols    ,soll    , &amp;<a name='5727'>
                    solsd   ,solld   ,frc_day ,                   &amp;<a name='5728'>
                    fsup    ,fsupc   ,fsdn    ,fsdnc   ,          &amp;<a name='5729'>
                    fsdndir ,fsdncdir,fsdndif ,fsdncdif,          &amp; <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes profiles<a name='5730'></font>
                    fsdsdir ,fsdsdif ,fsdscdir,fsdscdif,          &amp; <font color=#447700>! amontornes-bcodina (2014-04-20) Dir/Dif fluxes sfc<a name='5731'></font>
                    aertau  ,aerssa  ,aerasm  ,aerfwd             )<a name='5732'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5733'></font>
<font color=#447700>! <a name='5734'></font>
<font color=#447700>! Purpose: <a name='5735'></font>
<font color=#447700>! Solar radiation code<a name='5736'></font>
<font color=#447700>! <a name='5737'></font>
<font color=#447700>! Method: <a name='5738'></font>
<font color=#447700>! Basic method is Delta-Eddington as described in:<a name='5739'></font>
<font color=#447700>! <a name='5740'></font>
<font color=#447700>! Briegleb, Bruce P., 1992: Delta-Eddington<a name='5741'></font>
<font color=#447700>! Approximation for Solar Radiation in the NCAR Community Climate Model,<a name='5742'></font>
<font color=#447700>! Journal of Geophysical Research, Vol 97, D7, pp7603-7612).<a name='5743'></font>
<font color=#447700>! <a name='5744'></font>
<font color=#447700>! Five changes to the basic method described above are:<a name='5745'></font>
<font color=#447700>! (1) addition of sulfate aerosols (Kiehl and Briegleb, 1993)<a name='5746'></font>
<font color=#447700>! (2) the distinction between liquid and ice particle clouds <a name='5747'></font>
<font color=#447700>! (Kiehl et al, 1996);<a name='5748'></font>
<font color=#447700>! (3) provision for calculating TOA fluxes with spectral response to<a name='5749'></font>
<font color=#447700>! match Nimbus-7 visible/near-IR radiometers (Collins, 1998);<a name='5750'></font>
<font color=#447700>! (4) max-random overlap (Collins, 2001)<a name='5751'></font>
<font color=#447700>! (5) The near-IR absorption by H2O was updated in 2003 by Collins, <a name='5752'></font>
<font color=#447700>!     Lee-Taylor, and Edwards for consistency with the new line data in<a name='5753'></font>
<font color=#447700>!     Hitran 2000 and the H2O continuum version CKD 2.4.  Modifications<a name='5754'></font>
<font color=#447700>!     were optimized by reducing RMS errors in heating rates relative<a name='5755'></font>
<font color=#447700>!     to a series of benchmark calculations for the 5 standard AFGL <a name='5756'></font>
<font color=#447700>!     atmospheres.  The benchmarks were performed using DISORT2 combined<a name='5757'></font>
<font color=#447700>!     with GENLN3.  The near-IR scattering optical depths for Rayleigh<a name='5758'></font>
<font color=#447700>!     scattering were also adjusted, as well as the correction for<a name='5759'></font>
<font color=#447700>!     stratospheric heating by H2O.<a name='5760'></font>
<font color=#447700>!<a name='5761'></font>
<font color=#447700>! The treatment of maximum-random overlap is described in the<a name='5762'></font>
<font color=#447700>! comment block "INDEX CALCULATIONS FOR MAX OVERLAP".<a name='5763'></font>
<font color=#447700>! <a name='5764'></font>
<font color=#447700>! Divides solar spectrum into 19 intervals from 0.2-5.0 micro-meters.<a name='5765'></font>
<font color=#447700>! solar flux fractions specified for each interval. allows for<a name='5766'></font>
<font color=#447700>! seasonally and diurnally varying solar input.  Includes molecular,<a name='5767'></font>
<font color=#447700>! cloud, aerosol, and surface scattering, along with h2o,o3,co2,o2,cloud, <a name='5768'></font>
<font color=#447700>! and surface absorption. Computes delta-eddington reflections and<a name='5769'></font>
<font color=#447700>! transmissions assuming homogeneously mixed layers. Adds the layers <a name='5770'></font>
<font color=#447700>! assuming scattering between layers to be isotropic, and distinguishes <a name='5771'></font>
<font color=#447700>! direct solar beam from scattered radiation.<a name='5772'></font>
<font color=#447700>! <a name='5773'></font>
<font color=#447700>! Longitude loops are broken into 1 or 2 sections, so that only daylight<a name='5774'></font>
<font color=#447700>! (i.e. coszrs &gt; 0) computations are done.<a name='5775'></font>
<font color=#447700>! <a name='5776'></font>
<font color=#447700>! Note that an extra layer above the model top layer is added.<a name='5777'></font>
<font color=#447700>! <a name='5778'></font>
<font color=#447700>! cgs units are used.<a name='5779'></font>
<font color=#447700>! <a name='5780'></font>
<font color=#447700>! Special diagnostic calculation of the clear sky surface and total column<a name='5781'></font>
<font color=#447700>! absorbed flux is also done for cloud forcing diagnostics.<a name='5782'></font>
<font color=#447700>! <a name='5783'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5784'></font>
<font color=#447700>!  use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='5785'></font>
<font color=#447700>!  use ppgrid<a name='5786'></font>
<font color=#447700>!  use ghg_surfvals, only: co2mmr<a name='5787'></font>
<font color=#447700>!  use prescribed_aerosols, only: idxBG, idxSUL, idxSSLT, idxOCPHO, idxBCPHO, idxOCPHI, idxBCPHI, &amp;<a name='5788'></font>
<font color=#447700>!    idxDUSTfirst, numDUST, idxVOLC, naer_all<a name='5789'></font>
<font color=#447700>!  use aer_optics, only: nrh, ndstsz, ksul, wsul, gsul, &amp;<a name='5790'></font>
<font color=#447700>!    ksslt, wsslt, gsslt, kcphil, wcphil, gcphil, kcphob, wcphob, gcphob, &amp;<a name='5791'></font>
<font color=#447700>!    kcb, wcb, gcb, kdst, wdst, gdst, kbg, wbg, gbg, kvolc, wvolc, gvolc<a name='5792'></font>
<font color=#447700>!  use abortutils, only: endrun<a name='5793'></font>
<a name='5794'>
   implicit none<a name='5795'>
<a name='5796'>
   integer nspint            <font color=#447700>! Num of spctrl intervals across solar spectrum<a name='5797'></font>
   integer naer_groups       <font color=#447700>! Num of aerosol groups for optical diagnostics<a name='5798'></font>
<a name='5799'>
   parameter ( nspint = 19 )<a name='5800'>
   parameter ( naer_groups = 7 )    <font color=#447700>! current groupings are sul, sslt, all carbons, all dust, and all aerosols<a name='5801'></font>
<font color=#447700>!-----------------------Constants for new band (640-700 nm)-------------<a name='5802'></font>
<a name='5803'>
<font color=#447700>!-------------Parameters for accelerating max-random solution-------------<a name='5804'></font>
<font color=#447700>! <a name='5805'></font>
<font color=#447700>! The solution time scales like prod(j:1-&gt;N) (1 + n_j) where <a name='5806'></font>
<font color=#447700>! N   = number of max-overlap regions (nmxrgn)<a name='5807'></font>
<font color=#447700>! n_j = number of unique cloud amounts in region j<a name='5808'></font>
<font color=#447700>! <a name='5809'></font>
<font color=#447700>! Therefore the solution cost can be reduced by decreasing n_j.<a name='5810'></font>
<font color=#447700>! cldmin reduces n_j by treating cloud amounts &lt; cldmin as clear sky.<a name='5811'></font>
<font color=#447700>! cldeps reduces n_j by treating cloud amounts identical to log(1/cldeps)<a name='5812'></font>
<font color=#447700>! decimal places as identical<a name='5813'></font>
<font color=#447700>! <a name='5814'></font>
<font color=#447700>! areamin reduces the cost by dropping configurations that occupy<a name='5815'></font>
<font color=#447700>! a surface area &lt; areamin of the model grid box.  The surface area<a name='5816'></font>
<font color=#447700>! for a configuration C(j,k_j), where j is the region number and k_j is the<a name='5817'></font>
<font color=#447700>! index for a unique cloud amount (in descending order from biggest to<a name='5818'></font>
<font color=#447700>! smallest clouds) in region j, is<a name='5819'></font>
<font color=#447700>! <a name='5820'></font>
<font color=#447700>! A = prod(j:1-&gt;N) [C(j,k_j) - C(j,k_j+1)]<a name='5821'></font>
<font color=#447700>! <a name='5822'></font>
<font color=#447700>! where C(j,0) = 1.0 and C(j,n_j+1) = 0.0.<a name='5823'></font>
<font color=#447700>! <a name='5824'></font>
<font color=#447700>! nconfgmax reduces the cost and improves load balancing by setting an upper<a name='5825'></font>
<font color=#447700>! bound on the number of cloud configurations in the solution.  If the number<a name='5826'></font>
<font color=#447700>! of configurations exceeds nconfgmax, the nconfgmax configurations with the<a name='5827'></font>
<font color=#447700>! largest area are retained, and the fluxes are normalized by the total area<a name='5828'></font>
<font color=#447700>! of these nconfgmax configurations.  For the current max/random overlap <a name='5829'></font>
<font color=#447700>! assumption (see subroutine cldovrlap), 30 levels, and cloud-amount <a name='5830'></font>
<font color=#447700>! parameterization, the mean and RMS number of configurations are <a name='5831'></font>
<font color=#447700>! both roughly 5.  nconfgmax has been set to the mean+2*RMS number, or 15.<a name='5832'></font>
<font color=#447700>! <a name='5833'></font>
<font color=#447700>! Minimum cloud amount (as a fraction of the grid-box area) to <a name='5834'></font>
<font color=#447700>! distinguish from clear sky<a name='5835'></font>
<font color=#447700>! <a name='5836'></font>
   real(r8) cldmin<a name='5837'>
   parameter (cldmin = 1.0e-80_r8)<a name='5838'>
<font color=#447700>! <a name='5839'></font>
<font color=#447700>! Minimimum horizontal area (as a fraction of the grid-box area) to retain <a name='5840'></font>
<font color=#447700>! for a unique cloud configuration in the max-random solution<a name='5841'></font>
<font color=#447700>! <a name='5842'></font>
   real(r8) areamin<a name='5843'>
   parameter (areamin = 0.01_r8)<a name='5844'>
<font color=#447700>! <a name='5845'></font>
<font color=#447700>! Decimal precision of cloud amount (0 -&gt; preserve full resolution;<a name='5846'></font>
<font color=#447700>! 10^-n -&gt; preserve n digits of cloud amount)<a name='5847'></font>
<font color=#447700>! <a name='5848'></font>
   real(r8) cldeps<a name='5849'>
   parameter (cldeps = 0.0_r8)<a name='5850'>
<font color=#447700>! <a name='5851'></font>
<font color=#447700>! Maximum number of configurations to include in solution<a name='5852'></font>
<font color=#447700>! <a name='5853'></font>
   integer nconfgmax<a name='5854'>
   parameter (nconfgmax = 15)<a name='5855'>
<font color=#447700>!------------------------------Commons----------------------------------<a name='5856'></font>
<font color=#447700>! <a name='5857'></font>
<font color=#447700>! Input arguments<a name='5858'></font>
<font color=#447700>! <a name='5859'></font>
   integer, intent(in) :: lchnk,jj             <font color=#447700>! chunk identifier<a name='5860'></font>
   integer, intent(in) :: pcols, pver, pverp<a name='5861'>
   integer, intent(in) :: ncol              <font color=#447700>! number of atmospheric columns<a name='5862'></font>
<a name='5863'>
   real(r8), intent(in) :: pmid(pcols,pver) <font color=#447700>! Level pressure<a name='5864'></font>
   real(r8), intent(in) :: pint(pcols,pverp) <font color=#447700>! Interface pressure<a name='5865'></font>
   real(r8), intent(in) :: h2ommr(pcols,pver) <font color=#447700>! Specific humidity (h2o mass mix ratio)<a name='5866'></font>
   real(r8), intent(in) :: o3mmr(pcols,pver) <font color=#447700>! Ozone mass mixing ratio<a name='5867'></font>
   real(r8), intent(in) :: aermmr(pcols,pver,naer_all) <font color=#447700>! Aerosol mass mixing ratio<a name='5868'></font>
   real(r8), intent(in) :: rh(pcols,pver)   <font color=#447700>! Relative humidity (fraction)<a name='5869'></font>
<font color=#447700>! <a name='5870'></font>
   real(r8), intent(in) :: cld(pcols,pver)  <font color=#447700>! Fractional cloud cover<a name='5871'></font>
   real(r8), intent(in) :: cicewp(pcols,pver) <font color=#447700>! in-cloud cloud ice water path<a name='5872'></font>
   real(r8), intent(in) :: cliqwp(pcols,pver) <font color=#447700>! in-cloud cloud liquid water path<a name='5873'></font>
   real(r8), intent(in) :: rel(pcols,pver)  <font color=#447700>! Liquid effective drop size (microns)<a name='5874'></font>
   real(r8), intent(in) :: rei(pcols,pver)  <font color=#447700>! Ice effective drop size (microns)<a name='5875'></font>
<font color=#447700>! <a name='5876'></font>
   real(r8), intent(in) :: eccf             <font color=#447700>! Eccentricity factor (1./earth-sun dist^2)<a name='5877'></font>
   real, intent(in) :: solcon           <font color=#447700>! solar constant with eccentricity factor<a name='5878'></font>
   real(r8), intent(in) :: coszrs(pcols)    <font color=#447700>! Cosine solar zenith angle<a name='5879'></font>
   real(r8), intent(in) :: asdir(pcols)     <font color=#447700>! 0.2-0.7 micro-meter srfc alb: direct rad<a name='5880'></font>
   real(r8), intent(in) :: aldir(pcols)     <font color=#447700>! 0.7-5.0 micro-meter srfc alb: direct rad<a name='5881'></font>
   real(r8), intent(in) :: asdif(pcols)     <font color=#447700>! 0.2-0.7 micro-meter srfc alb: diffuse rad<a name='5882'></font>
   real(r8), intent(in) :: aldif(pcols)     <font color=#447700>! 0.7-5.0 micro-meter srfc alb: diffuse rad<a name='5883'></font>
<a name='5884'>
   real(r8), intent(in) :: scon             <font color=#447700>! solar constant <a name='5885'></font>
<font color=#447700>! <a name='5886'></font>
<font color=#447700>! IN/OUT arguments<a name='5887'></font>
<font color=#447700>! <a name='5888'></font>
   real(r8), intent(inout) :: pmxrgn(pcols,pverp) <font color=#447700>! Maximum values of pressure for each<a name='5889'></font>
<font color=#447700>!                                                 !    maximally overlapped region. <a name='5890'></font>
<font color=#447700>!                                                 !    0-&gt;pmxrgn(i,1) is range of pressure for<a name='5891'></font>
<font color=#447700>!                                                 !    1st region,pmxrgn(i,1)-&gt;pmxrgn(i,2) for<a name='5892'></font>
<font color=#447700>!                                                 !    2nd region, etc<a name='5893'></font>
   integer, intent(inout) ::  nmxrgn(pcols)    <font color=#447700>! Number of maximally overlapped regions<a name='5894'></font>
<font color=#447700>! <a name='5895'></font>
<font color=#447700>! Output arguments<a name='5896'></font>
<font color=#447700>! <a name='5897'></font>
<a name='5898'>
   real(r8), intent(out) :: solin(pcols)     <font color=#447700>! Incident solar flux<a name='5899'></font>
   real(r8), intent(out) :: qrs(pcols,pver)  <font color=#447700>! Solar heating rate<a name='5900'></font>
   real(r8), intent(out) :: fsns(pcols)      <font color=#447700>! Surface absorbed solar flux<a name='5901'></font>
   real(r8), intent(out) :: fsnt(pcols)      <font color=#447700>! Total column absorbed solar flux<a name='5902'></font>
   real(r8), intent(out) :: fsntoa(pcols)    <font color=#447700>! Net solar flux at TOA<a name='5903'></font>
   real(r8), intent(out) :: fsds(pcols)      <font color=#447700>! Flux shortwave downwelling surface<a name='5904'></font>
<font color=#447700>! <a name='5905'></font>
   real(r8), intent(out) :: fsnsc(pcols)     <font color=#447700>! Clear sky surface absorbed solar flux<a name='5906'></font>
   real(r8), intent(out) :: fsdsc(pcols)     <font color=#447700>! Clear sky surface downwelling solar flux<a name='5907'></font>
<a name='5908'>
   real(r8), intent(out) :: fsdscdir(pcols)  <font color=#447700>! Clear sky surface direct downwelling solar flux (amontornes-bcodina 2014-04-20)<a name='5909'></font>
   real(r8), intent(out) :: fsdscdif(pcols)  <font color=#447700>! Clear sky surface diffuse downwelling solar flux (amontornes-bcodina 2014-04-20)<a name='5910'></font>
   real(r8), intent(out) :: fsdsdir(pcols)   <font color=#447700>! Clear sky surface direct downwelling solar flux (amontornes-bcodina 2014-04-20)<a name='5911'></font>
   real(r8), intent(out) :: fsdsdif(pcols)   <font color=#447700>! Clear sky surface diffuse downwelling solar flux (amontornes-bcodina 2014-04-20)<a name='5912'></font>
<a name='5913'>
   real(r8), intent(out) :: fsntc(pcols)     <font color=#447700>! Clear sky total column absorbed solar flx<a name='5914'></font>
   real(r8), intent(out) :: fsntoac(pcols)   <font color=#447700>! Clear sky net solar flx at TOA<a name='5915'></font>
   real(r8), intent(out) :: sols(pcols)      <font color=#447700>! Direct solar rad on surface (&lt; 0.7)<a name='5916'></font>
   real(r8), intent(out) :: soll(pcols)      <font color=#447700>! Direct solar rad on surface (&gt;= 0.7)<a name='5917'></font>
   real(r8), intent(out) :: solsd(pcols)     <font color=#447700>! Diffuse solar rad on surface (&lt; 0.7)<a name='5918'></font>
   real(r8), intent(out) :: solld(pcols)     <font color=#447700>! Diffuse solar rad on surface (&gt;= 0.7)<a name='5919'></font>
   real(r8), intent(out) :: fsnirtoa(pcols)  <font color=#447700>! Near-IR flux absorbed at toa<a name='5920'></font>
   real(r8), intent(out) :: fsnrtoac(pcols)  <font color=#447700>! Clear sky near-IR flux absorbed at toa<a name='5921'></font>
   real(r8), intent(out) :: fsnrtoaq(pcols)  <font color=#447700>! Net near-IR flux at toa &gt;= 0.7 microns<a name='5922'></font>
   real(r8), intent(out) :: tauxcl(pcols,0:pver) <font color=#447700>! water cloud extinction optical depth<a name='5923'></font>
   real(r8), intent(out) :: tauxci(pcols,0:pver) <font color=#447700>! ice cloud extinction optical depth<a name='5924'></font>
<a name='5925'>
<font color=#447700>! Added downward/upward total and clear sky fluxes<a name='5926'></font>
   real(r8), intent(out) :: fsup(pcols,pverp)      <font color=#447700>! Total sky upward solar flux (spectrally summed)<a name='5927'></font>
   real(r8), intent(out) :: fsupc(pcols,pverp)     <font color=#447700>! Clear sky upward solar flux (spectrally summed)<a name='5928'></font>
   real(r8), intent(out) :: fsdn(pcols,pverp)      <font color=#447700>! Total sky downward solar flux (spectrally summed)<a name='5929'></font>
   real(r8), intent(out) :: fsdnc(pcols,pverp)     <font color=#447700>! Clear sky downward solar flux (spectrally summed)<a name='5930'></font>
   real(r8), intent(out) :: fsdndir(pcols,pverp)   <font color=#447700>! Total sky direct downward solar flux (spectrally summed) amontornes-bcodina (2014-04-20)<a name='5931'></font>
   real(r8), intent(out) :: fsdncdir(pcols,pverp)  <font color=#447700>! Clear sky direct downward solar flux (spectrally summed) amontornes-bcodina (2014-04-20)<a name='5932'></font>
   real(r8), intent(out) :: fsdndif(pcols,pverp)   <font color=#447700>! Total sky diffuse downward solar flux (spectrally summed) amontornes-bcodina (2014-04-20)<a name='5933'></font>
   real(r8), intent(out) :: fsdncdif(pcols,pverp)  <font color=#447700>! Clear sky diffuse downward solar flux (spectrally summed) amontornes-bcodina (2014-04-20)<a name='5934'></font>
<font color=#447700>!<a name='5935'></font>
   real(r8) , intent(out) :: frc_day(pcols) <font color=#447700>! = 1 for daylight, =0 for night columns<a name='5936'></font>
   real(r8) :: aertau(pcols,nspint,naer_groups) <font color=#447700>! Aerosol column optical depth<a name='5937'></font>
   real(r8) :: aerssa(pcols,nspint,naer_groups) <font color=#447700>! Aerosol column averaged single scattering albedo<a name='5938'></font>
   real(r8) :: aerasm(pcols,nspint,naer_groups) <font color=#447700>! Aerosol column averaged asymmetry parameter<a name='5939'></font>
   real(r8) :: aerfwd(pcols,nspint,naer_groups) <font color=#447700>! Aerosol column averaged forward scattering<a name='5940'></font>
<font color=#447700>!  real(r8), intent(out) :: aertau(pcols,nspint,naer_groups) ! Aerosol column optical depth<a name='5941'></font>
<font color=#447700>!  real(r8), intent(out) :: aerssa(pcols,nspint,naer_groups) ! Aerosol column averaged single scattering albedo<a name='5942'></font>
<font color=#447700>!  real(r8), intent(out) :: aerasm(pcols,nspint,naer_groups) ! Aerosol column averaged asymmetry parameter<a name='5943'></font>
<font color=#447700>!  real(r8), intent(out) :: aerfwd(pcols,nspint,naer_groups) ! Aerosol column averaged forward scattering<a name='5944'></font>
<font color=#447700>! <a name='5945'></font>
<font color=#447700>!---------------------------Local variables-----------------------------<a name='5946'></font>
<font color=#447700>! <a name='5947'></font>
<font color=#447700>! Max/random overlap variables<a name='5948'></font>
<font color=#447700>! <a name='5949'></font>
   real(r8) asort(pverp)     <font color=#447700>! 1 - cloud amounts to be sorted for max ovrlp.<a name='5950'></font>
   real(r8) atmp             <font color=#447700>! Temporary storage for sort when nxs = 2<a name='5951'></font>
   real(r8) cld0             <font color=#447700>! 1 - (cld amt) used to make wstr, cstr, nstr<a name='5952'></font>
   real(r8) totwgt           <font color=#447700>! Total of xwgts = total fractional area of <a name='5953'></font>
<font color=#447700>!   grid-box covered by cloud configurations<a name='5954'></font>
<font color=#447700>!   included in solution to fluxes<a name='5955'></font>
<a name='5956'>
   real(r8) wgtv(nconfgmax)  <font color=#447700>! Weights for fluxes<a name='5957'></font>
<font color=#447700>!   1st index is configuration number<a name='5958'></font>
   real(r8) wstr(pverp,pverp) <font color=#447700>! area weighting factors for streams<a name='5959'></font>
<font color=#447700>!   1st index is for stream #, <a name='5960'></font>
<font color=#447700>!   2nd index is for region #<a name='5961'></font>
<a name='5962'>
   real(r8) xexpt            <font color=#447700>! solar direct beam trans. for layer above<a name='5963'></font>
   real(r8) xrdnd            <font color=#447700>! diffuse reflectivity for layer above<a name='5964'></font>
   real(r8) xrupd            <font color=#447700>! diffuse reflectivity for layer below<a name='5965'></font>
   real(r8) xrups            <font color=#447700>! direct-beam reflectivity for layer below<a name='5966'></font>
   real(r8) xtdnt            <font color=#447700>! total trans for layers above<a name='5967'></font>
<a name='5968'>
   real(r8) xwgt             <font color=#447700>! product of cloud amounts<a name='5969'></font>
<a name='5970'>
   real(r8) yexpt            <font color=#447700>! solar direct beam trans. for layer above<a name='5971'></font>
   real(r8) yrdnd            <font color=#447700>! diffuse reflectivity for layer above<a name='5972'></font>
   real(r8) yrupd            <font color=#447700>! diffuse reflectivity for layer below<a name='5973'></font>
   real(r8) ytdnd            <font color=#447700>! dif-beam transmission for layers above<a name='5974'></font>
   real(r8) ytupd            <font color=#447700>! dif-beam transmission for layers below<a name='5975'></font>
<a name='5976'>
   real(r8) zexpt            <font color=#447700>! solar direct beam trans. for layer above<a name='5977'></font>
   real(r8) zrdnd            <font color=#447700>! diffuse reflectivity for layer above<a name='5978'></font>
   real(r8) zrupd            <font color=#447700>! diffuse reflectivity for layer below<a name='5979'></font>
   real(r8) zrups            <font color=#447700>! direct-beam reflectivity for layer below<a name='5980'></font>
   real(r8) ztdnt            <font color=#447700>! total trans for layers above<a name='5981'></font>
<a name='5982'>
   logical new_term          <font color=#447700>! Flag for configurations to include in fluxes<a name='5983'></font>
   logical region_found      <font color=#447700>! flag for identifying regions<a name='5984'></font>
<a name='5985'>
   integer ccon(0:pverp,nconfgmax)                                <a name='5986'>
<font color=#447700>! flags for presence of clouds<a name='5987'></font>
<font color=#447700>!   1st index is for level # (including <a name='5988'></font>
<font color=#447700>!    layer above top of model and at surface)<a name='5989'></font>
<font color=#447700>!   2nd index is for configuration #<a name='5990'></font>
   integer cstr(0:pverp,pverp)                                <a name='5991'>
<font color=#447700>! flags for presence of clouds<a name='5992'></font>
<font color=#447700>!   1st index is for level # (including <a name='5993'></font>
<font color=#447700>!    layer above top of model and at surface)<a name='5994'></font>
<font color=#447700>!   2nd index is for stream #<a name='5995'></font>
   integer icond(0:pverp,nconfgmax)<a name='5996'>
<font color=#447700>! Indices for copying rad. properties from<a name='5997'></font>
<font color=#447700>!     one identical downward cld config.<a name='5998'></font>
<font color=#447700>!     to another in adding method (step 2)<a name='5999'></font>
<font color=#447700>!   1st index is for interface # (including <a name='6000'></font>
<font color=#447700>!     layer above top of model and at surface)<a name='6001'></font>
<font color=#447700>!   2nd index is for configuration # range<a name='6002'></font>
   integer iconu(0:pverp,nconfgmax)<a name='6003'>
<font color=#447700>! Indices for copying rad. properties from<a name='6004'></font>
<font color=#447700>!     one identical upward configuration<a name='6005'></font>
<font color=#447700>!     to another in adding method (step 2)<a name='6006'></font>
<font color=#447700>!   1st index is for interface # (including <a name='6007'></font>
<font color=#447700>!     layer above top of model and at surface)<a name='6008'></font>
<font color=#447700>!   2nd index is for configuration # range<a name='6009'></font>
   integer iconfig           <font color=#447700>! Counter for random-ovrlap configurations<a name='6010'></font>
   integer irgn              <font color=#447700>! Index for max-overlap regions<a name='6011'></font>
   integer is0               <font color=#447700>! Lower end of stream index range<a name='6012'></font>
   integer is1               <font color=#447700>! Upper end of stream index range<a name='6013'></font>
   integer isn               <font color=#447700>! Stream index<a name='6014'></font>
   integer istr(pverp+1)     <font color=#447700>! index for stream #s during flux calculation<a name='6015'></font>
   integer istrtd(0:pverp,0:nconfgmax+1)<a name='6016'>
<font color=#447700>! indices into icond <a name='6017'></font>
<font color=#447700>!   1st index is for interface # (including <a name='6018'></font>
<font color=#447700>!     layer above top of model and at surface)<a name='6019'></font>
<font color=#447700>!   2nd index is for configuration # range<a name='6020'></font>
   integer istrtu(0:pverp,0:nconfgmax+1)<a name='6021'>
<font color=#447700>! indices into iconu <a name='6022'></font>
<font color=#447700>!   1st index is for interface # (including <a name='6023'></font>
<font color=#447700>!     layer above top of model and at surface)<a name='6024'></font>
<font color=#447700>!   2nd index is for configuration # range<a name='6025'></font>
   integer j                 <font color=#447700>! Configuration index<a name='6026'></font>
   integer k1                <font color=#447700>! Level index<a name='6027'></font>
   integer k2                <font color=#447700>! Level index<a name='6028'></font>
   integer ksort(pverp)      <font color=#447700>! Level indices of cloud amounts to be sorted<a name='6029'></font>
   integer ktmp              <font color=#447700>! Temporary storage for sort when nxs = 2<a name='6030'></font>
   integer kx1(0:pverp)      <font color=#447700>! Level index for top of max-overlap region<a name='6031'></font>
   integer kx2(0:pverp)      <font color=#447700>! Level index for bottom of max-overlap region<a name='6032'></font>
   integer l                 <font color=#447700>! Index <a name='6033'></font>
   integer l0                <font color=#447700>! Index<a name='6034'></font>
   integer mrgn              <font color=#447700>! Counter for nrgn<a name='6035'></font>
   integer mstr              <font color=#447700>! Counter for nstr<a name='6036'></font>
   integer n0                <font color=#447700>! Number of configurations with ccon(k,:)==0<a name='6037'></font>
   integer n1                <font color=#447700>! Number of configurations with ccon(k,:)==1<a name='6038'></font>
   integer nconfig           <font color=#447700>! Number of random-ovrlap configurations<a name='6039'></font>
   integer nconfigm          <font color=#447700>! Value of config before testing for areamin,<a name='6040'></font>
<font color=#447700>!    nconfgmax<a name='6041'></font>
   integer npasses           <font color=#447700>! number of passes over the indexing loop<a name='6042'></font>
   integer nrgn              <font color=#447700>! Number of max overlap regions at current <a name='6043'></font>
<font color=#447700>!    longitude<a name='6044'></font>
   integer nstr(pverp)       <font color=#447700>! Number of unique cloud configurations<a name='6045'></font>
<font color=#447700>!   ("streams") in a max-overlapped region<a name='6046'></font>
<font color=#447700>!   1st index is for region #<a name='6047'></font>
   integer nuniq             <font color=#447700>! # of unique cloud configurations<a name='6048'></font>
   integer nuniqd(0:pverp)   <font color=#447700>! # of unique cloud configurations: TOA <a name='6049'></font>
<font color=#447700>!   to level k<a name='6050'></font>
   integer nuniqu(0:pverp)   <font color=#447700>! # of unique cloud configurations: surface<a name='6051'></font>
<font color=#447700>!   to level k <a name='6052'></font>
   integer nxs               <font color=#447700>! Number of cloudy layers between k1 and k2 <a name='6053'></font>
   integer ptr0(nconfgmax)   <font color=#447700>! Indices of configurations with ccon(k,:)==0<a name='6054'></font>
   integer ptr1(nconfgmax)   <font color=#447700>! Indices of configurations with ccon(k,:)==1<a name='6055'></font>
   integer ptrc(nconfgmax)   <font color=#447700>! Pointer for configurations sorted by wgtv<a name='6056'></font>
<font color=#447700>!  integer findvalue         ! Function for finding kth smallest element<a name='6057'></font>
<font color=#447700>!   in a vector<a name='6058'></font>
<font color=#447700>!  external findvalue<a name='6059'></font>
<a name='6060'>
<font color=#447700>! <a name='6061'></font>
<font color=#447700>! Other<a name='6062'></font>
<font color=#447700>! <a name='6063'></font>
   integer ns                <font color=#447700>! Spectral loop index<a name='6064'></font>
   integer i                 <font color=#447700>! Longitude loop index<a name='6065'></font>
   integer k                 <font color=#447700>! Level loop index<a name='6066'></font>
   integer km1               <font color=#447700>! k - 1<a name='6067'></font>
   integer kp1               <font color=#447700>! k + 1<a name='6068'></font>
   integer n                 <font color=#447700>! Loop index for daylight<a name='6069'></font>
   integer ndayc             <font color=#447700>! Number of daylight columns<a name='6070'></font>
   integer idayc(pcols)      <font color=#447700>! Daytime column indices<a name='6071'></font>
   integer indxsl            <font color=#447700>! Index for cloud particle properties<a name='6072'></font>
   integer ksz               <font color=#447700>! dust size bin index<a name='6073'></font>
   integer krh               <font color=#447700>! relative humidity bin index<a name='6074'></font>
   integer kaer              <font color=#447700>! aerosol group index<a name='6075'></font>
   real(r8) wrh              <font color=#447700>! weight for linear interpolation between lut points<a name='6076'></font>
   real(r8) :: rhtrunc       <font color=#447700>! rh, truncated for the purposes of extrapolating<a name='6077'></font>
                             <font color=#447700>! aerosol optical properties <a name='6078'></font>
   real(r8) albdir(pcols,nspint) <font color=#447700>! Current spc intrvl srf alb to direct rad<a name='6079'></font>
   real(r8) albdif(pcols,nspint) <font color=#447700>! Current spc intrvl srf alb to diffuse rad<a name='6080'></font>
<font color=#447700>! <a name='6081'></font>
   real(r8) wgtint           <font color=#447700>! Weight for specific spectral interval<a name='6082'></font>
<a name='6083'>
<font color=#447700>! <a name='6084'></font>
<font color=#447700>! Diagnostic and accumulation arrays; note that sfltot, fswup, and<a name='6085'></font>
<font color=#447700>! fswdn are not used in the computation,but are retained for future use.<a name='6086'></font>
<font color=#447700>! <a name='6087'></font>
   real(r8) solflx           <font color=#447700>! Solar flux in current interval<a name='6088'></font>
   real(r8) sfltot           <font color=#447700>! Spectrally summed total solar flux<a name='6089'></font>
   real(r8) totfld(0:pver)   <font color=#447700>! Spectrally summed flux divergence<a name='6090'></font>
   real(r8) fswup(0:pverp)   <font color=#447700>! Spectrally summed up flux<a name='6091'></font>
   real(r8) fswdn(0:pverp)   <font color=#447700>! Spectrally summed down flux<a name='6092'></font>
   real(r8) fswupc(0:pverp)  <font color=#447700>! Spectrally summed up clear sky flux<a name='6093'></font>
   real(r8) fswdnc(0:pverp)  <font color=#447700>! Spectrally summed down clear sky flux<a name='6094'></font>
   real(r8) fswdndir(0:pverp) <font color=#447700>! Spectrally summed direct flux in all sky    (amontornes-bcodina 2014-04-20)<a name='6095'></font>
   real(r8) fswdncdir(0:pverp)<font color=#447700>! Spectrally summed direct flux in clear sky  (amontornes-bcodina 2014-04-20)<a name='6096'></font>
<font color=#447700>! <a name='6097'></font>
<font color=#447700>! Cloud radiative property arrays<a name='6098'></font>
<font color=#447700>! <a name='6099'></font>
<font color=#447700>!  real(r8) tauxcl(pcols,0:pver) ! water cloud extinction optical depth<a name='6100'></font>
<font color=#447700>!  real(r8) tauxci(pcols,0:pver) ! ice cloud extinction optical depth<a name='6101'></font>
   real(r8) wcl(pcols,0:pver) <font color=#447700>! liquid cloud single scattering albedo<a name='6102'></font>
   real(r8) gcl(pcols,0:pver) <font color=#447700>! liquid cloud asymmetry parameter<a name='6103'></font>
   real(r8) fcl(pcols,0:pver) <font color=#447700>! liquid cloud forward scattered fraction<a name='6104'></font>
   real(r8) wci(pcols,0:pver) <font color=#447700>! ice cloud single scattering albedo<a name='6105'></font>
   real(r8) gci(pcols,0:pver) <font color=#447700>! ice cloud asymmetry parameter<a name='6106'></font>
   real(r8) fci(pcols,0:pver) <font color=#447700>! ice cloud forward scattered fraction<a name='6107'></font>
<font color=#447700>!<a name='6108'></font>
<font color=#447700>! Aerosol mass paths by species<a name='6109'></font>
<font color=#447700>!<a name='6110'></font>
  real(r8) usul(pcols,pver)   <font color=#447700>! sulfate (SO4)<a name='6111'></font>
  real(r8) ubg(pcols,pver)    <font color=#447700>! background aerosol<a name='6112'></font>
  real(r8) usslt(pcols,pver)  <font color=#447700>! sea-salt (SSLT)<a name='6113'></font>
  real(r8) ucphil(pcols,pver) <font color=#447700>! hydrophilic organic carbon (OCPHI)<a name='6114'></font>
  real(r8) ucphob(pcols,pver) <font color=#447700>! hydrophobic organic carbon (OCPHO)<a name='6115'></font>
  real(r8) ucb(pcols,pver)    <font color=#447700>! black carbon (BCPHI + BCPHO)<a name='6116'></font>
  real(r8) uvolc(pcols,pver) <font color=#447700>! volcanic mass<a name='6117'></font>
  real(r8) udst(ndstsz,pcols,pver) <font color=#447700>! dust<a name='6118'></font>
<a name='6119'>
<font color=#447700>!<a name='6120'></font>
<font color=#447700>! local variables used for the external mixing of aerosol species<a name='6121'></font>
<font color=#447700>!<a name='6122'></font>
  real(r8) tau_sul             <font color=#447700>! optical depth, sulfate<a name='6123'></font>
  real(r8) tau_bg              <font color=#447700>! optical depth, background aerosol<a name='6124'></font>
  real(r8) tau_sslt            <font color=#447700>! optical depth, sea-salt<a name='6125'></font>
  real(r8) tau_cphil           <font color=#447700>! optical depth, hydrophilic carbon<a name='6126'></font>
  real(r8) tau_cphob           <font color=#447700>! optical depth, hydrophobic carbon<a name='6127'></font>
  real(r8) tau_cb              <font color=#447700>! optical depth, black carbon<a name='6128'></font>
  real(r8) tau_volc            <font color=#447700>! optical depth, volcanic<a name='6129'></font>
  real(r8) tau_dst(ndstsz)     <font color=#447700>! optical depth, dust, by size category<a name='6130'></font>
  real(r8) tau_dst_tot         <font color=#447700>! optical depth, total dust<a name='6131'></font>
  real(r8) tau_tot             <font color=#447700>! optical depth, total aerosol<a name='6132'></font>
<a name='6133'>
  real(r8) tau_w_sul           <font color=#447700>! optical depth * single scattering albedo, sulfate<a name='6134'></font>
  real(r8) tau_w_bg            <font color=#447700>! optical depth * single scattering albedo, background aerosol<a name='6135'></font>
  real(r8) tau_w_sslt          <font color=#447700>! optical depth * single scattering albedo, sea-salt<a name='6136'></font>
  real(r8) tau_w_cphil         <font color=#447700>! optical depth * single scattering albedo, hydrophilic carbon<a name='6137'></font>
  real(r8) tau_w_cphob         <font color=#447700>! optical depth * single scattering albedo, hydrophobic carbon<a name='6138'></font>
  real(r8) tau_w_cb            <font color=#447700>! optical depth * single scattering albedo, black carbon<a name='6139'></font>
  real(r8) tau_w_volc          <font color=#447700>! optical depth * single scattering albedo, volcanic<a name='6140'></font>
  real(r8) tau_w_dst(ndstsz)   <font color=#447700>! optical depth * single scattering albedo, dust, by size<a name='6141'></font>
  real(r8) tau_w_dst_tot       <font color=#447700>! optical depth * single scattering albedo, total dust<a name='6142'></font>
  real(r8) tau_w_tot           <font color=#447700>! optical depth * single scattering albedo, total aerosol<a name='6143'></font>
<a name='6144'>
  real(r8) tau_w_g_sul         <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, sulfate<a name='6145'></font>
  real(r8) tau_w_g_bg          <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, background aerosol<a name='6146'></font>
  real(r8) tau_w_g_sslt        <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, sea-salt<a name='6147'></font>
  real(r8) tau_w_g_cphil       <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, hydrophilic carbon<a name='6148'></font>
  real(r8) tau_w_g_cphob       <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, hydrophobic carbon<a name='6149'></font>
  real(r8) tau_w_g_cb          <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, black carbon<a name='6150'></font>
  real(r8) tau_w_g_volc        <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, volcanic<a name='6151'></font>
  real(r8) tau_w_g_dst(ndstsz) <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, dust, by size<a name='6152'></font>
  real(r8) tau_w_g_dst_tot     <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, total dust<a name='6153'></font>
  real(r8) tau_w_g_tot         <font color=#447700>! optical depth * single scattering albedo * asymmetry parameter, total aerosol<a name='6154'></font>
<a name='6155'>
  real(r8) f_sul               <font color=#447700>! forward scattering fraction, sulfate<a name='6156'></font>
  real(r8) f_bg                <font color=#447700>! forward scattering fraction, background aerosol<a name='6157'></font>
  real(r8) f_sslt              <font color=#447700>! forward scattering fraction, sea-salt<a name='6158'></font>
  real(r8) f_cphil             <font color=#447700>! forward scattering fraction, hydrophilic carbon<a name='6159'></font>
  real(r8) f_cphob             <font color=#447700>! forward scattering fraction, hydrophobic carbon<a name='6160'></font>
  real(r8) f_cb                <font color=#447700>! forward scattering fraction, black carbon<a name='6161'></font>
  real(r8) f_volc              <font color=#447700>! forward scattering fraction, volcanic<a name='6162'></font>
  real(r8) f_dst(ndstsz)       <font color=#447700>! forward scattering fraction, dust, by size<a name='6163'></font>
  real(r8) f_dst_tot           <font color=#447700>! forward scattering fraction, total dust<a name='6164'></font>
  real(r8) f_tot               <font color=#447700>! forward scattering fraction, total aerosol<a name='6165'></font>
<a name='6166'>
  real(r8) tau_w_f_sul         <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, sulfate<a name='6167'></font>
  real(r8) tau_w_f_bg          <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, background<a name='6168'></font>
  real(r8) tau_w_f_sslt        <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, sea-salt<a name='6169'></font>
  real(r8) tau_w_f_cphil       <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, hydrophilic C<a name='6170'></font>
  real(r8) tau_w_f_cphob       <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, hydrophobic C<a name='6171'></font>
  real(r8) tau_w_f_cb          <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, black C<a name='6172'></font>
  real(r8) tau_w_f_volc        <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, volcanic<a name='6173'></font>
  real(r8) tau_w_f_dst(ndstsz) <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, dust, by size<a name='6174'></font>
  real(r8) tau_w_f_dst_tot     <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, total dust<a name='6175'></font>
  real(r8) tau_w_f_tot         <font color=#447700>! optical depth * forward scattering fraction * single scattering albedo, total aerosol<a name='6176'></font>
  real(r8) w_dst_tot           <font color=#447700>! single scattering albedo, total dust<a name='6177'></font>
  real(r8) w_tot               <font color=#447700>! single scattering albedo, total aerosol<a name='6178'></font>
  real(r8) g_dst_tot           <font color=#447700>! asymmetry parameter, total dust<a name='6179'></font>
  real(r8) g_tot               <font color=#447700>! asymmetry parameter, total aerosol<a name='6180'></font>
  real(r8) ksuli               <font color=#447700>! specific extinction interpolated between rh look-up-table points, sulfate<a name='6181'></font>
  real(r8) ksslti              <font color=#447700>! specific extinction interpolated between rh look-up-table points, sea-salt<a name='6182'></font>
  real(r8) kcphili             <font color=#447700>! specific extinction interpolated between rh look-up-table points, hydrophilic carbon<a name='6183'></font>
  real(r8) wsuli               <font color=#447700>! single scattering albedo interpolated between rh look-up-table points, sulfate<a name='6184'></font>
  real(r8) wsslti              <font color=#447700>! single scattering albedo interpolated between rh look-up-table points, sea-salt<a name='6185'></font>
  real(r8) wcphili             <font color=#447700>! single scattering albedo interpolated between rh look-up-table points, hydrophilic carbon<a name='6186'></font>
  real(r8) gsuli               <font color=#447700>! asymmetry parameter interpolated between rh look-up-table points, sulfate<a name='6187'></font>
  real(r8) gsslti              <font color=#447700>! asymmetry parameter interpolated between rh look-up-table points, sea-salt<a name='6188'></font>
  real(r8) gcphili             <font color=#447700>! asymmetry parameter interpolated between rh look-up-table points, hydrophilic carbon<a name='6189'></font>
<font color=#447700>! <a name='6190'></font>
<font color=#447700>! Aerosol radiative property arrays<a name='6191'></font>
<font color=#447700>! <a name='6192'></font>
   real(r8) tauxar(pcols,0:pver) <font color=#447700>! aerosol extinction optical depth<a name='6193'></font>
   real(r8) wa(pcols,0:pver) <font color=#447700>! aerosol single scattering albedo<a name='6194'></font>
   real(r8) ga(pcols,0:pver) <font color=#447700>! aerosol assymetry parameter<a name='6195'></font>
   real(r8) fa(pcols,0:pver) <font color=#447700>! aerosol forward scattered fraction<a name='6196'></font>
<a name='6197'>
<font color=#447700>! <a name='6198'></font>
<font color=#447700>! Various arrays and other constants:<a name='6199'></font>
<font color=#447700>! <a name='6200'></font>
   real(r8) pflx(pcols,0:pverp) <font color=#447700>! Interface press, including extra layer<a name='6201'></font>
   real(r8) zenfac(pcols)    <font color=#447700>! Square root of cos solar zenith angle<a name='6202'></font>
   real(r8) sqrco2           <font color=#447700>! Square root of the co2 mass mixg ratio<a name='6203'></font>
   real(r8) tmp1             <font color=#447700>! Temporary constant array<a name='6204'></font>
   real(r8) tmp2             <font color=#447700>! Temporary constant array<a name='6205'></font>
   real(r8) pdel             <font color=#447700>! Pressure difference across layer<a name='6206'></font>
   real(r8) path             <font color=#447700>! Mass path of layer<a name='6207'></font>
   real(r8) ptop             <font color=#447700>! Lower interface pressure of extra layer<a name='6208'></font>
   real(r8) ptho2            <font color=#447700>! Used to compute mass path of o2<a name='6209'></font>
   real(r8) ptho3            <font color=#447700>! Used to compute mass path of o3<a name='6210'></font>
   real(r8) pthco2           <font color=#447700>! Used to compute mass path of co2<a name='6211'></font>
   real(r8) pthh2o           <font color=#447700>! Used to compute mass path of h2o<a name='6212'></font>
   real(r8) h2ostr           <font color=#447700>! Inverse sq. root h2o mass mixing ratio<a name='6213'></font>
   real(r8) wavmid(nspint)   <font color=#447700>! Spectral interval middle wavelength<a name='6214'></font>
   real(r8) trayoslp         <font color=#447700>! Rayleigh optical depth/standard pressure<a name='6215'></font>
   real(r8) tmp1l            <font color=#447700>! Temporary constant array<a name='6216'></font>
   real(r8) tmp2l            <font color=#447700>! Temporary constant array<a name='6217'></font>
   real(r8) tmp3l            <font color=#447700>! Temporary constant array<a name='6218'></font>
   real(r8) tmp1i            <font color=#447700>! Temporary constant array<a name='6219'></font>
   real(r8) tmp2i            <font color=#447700>! Temporary constant array<a name='6220'></font>
   real(r8) tmp3i            <font color=#447700>! Temporary constant array<a name='6221'></font>
   real(r8) rdenom           <font color=#447700>! Multiple scattering term<a name='6222'></font>
   real(r8) rdirexp          <font color=#447700>! layer direct ref times exp transmission<a name='6223'></font>
   real(r8) tdnmexp          <font color=#447700>! total transmission - exp transmission<a name='6224'></font>
   real(r8) psf(nspint)      <font color=#447700>! Frac of solar flux in spect interval<a name='6225'></font>
<font color=#447700>! <a name='6226'></font>
<font color=#447700>! Layer absorber amounts; note that 0 refers to the extra layer added<a name='6227'></font>
<font color=#447700>! above the top model layer<a name='6228'></font>
<font color=#447700>! <a name='6229'></font>
   real(r8) uh2o(pcols,0:pver) <font color=#447700>! Layer absorber amount of h2o<a name='6230'></font>
   real(r8) uo3(pcols,0:pver) <font color=#447700>! Layer absorber amount of  o3<a name='6231'></font>
   real(r8) uco2(pcols,0:pver) <font color=#447700>! Layer absorber amount of co2<a name='6232'></font>
   real(r8) uo2(pcols,0:pver) <font color=#447700>! Layer absorber amount of  o2<a name='6233'></font>
   real(r8) uaer(pcols,0:pver) <font color=#447700>! Layer aerosol amount <a name='6234'></font>
<font color=#447700>! <a name='6235'></font>
<font color=#447700>! Total column absorber amounts:<a name='6236'></font>
<font color=#447700>! <a name='6237'></font>
   real(r8) uth2o(pcols)     <font color=#447700>! Total column  absorber amount of  h2o<a name='6238'></font>
   real(r8) uto3(pcols)      <font color=#447700>! Total column  absorber amount of  o3<a name='6239'></font>
   real(r8) utco2(pcols)     <font color=#447700>! Total column  absorber amount of  co2<a name='6240'></font>
   real(r8) uto2(pcols)      <font color=#447700>! Total column  absorber amount of  o2<a name='6241'></font>
<font color=#447700>! <a name='6242'></font>
<font color=#447700>! These arrays are defined for pver model layers; 0 refers to the extra<a name='6243'></font>
<font color=#447700>! layer on top:<a name='6244'></font>
<font color=#447700>! <a name='6245'></font>
   real(r8) rdir(nspint,pcols,0:pver) <font color=#447700>! Layer reflectivity to direct rad<a name='6246'></font>
   real(r8) rdif(nspint,pcols,0:pver) <font color=#447700>! Layer reflectivity to diffuse rad<a name='6247'></font>
   real(r8) tdir(nspint,pcols,0:pver) <font color=#447700>! Layer transmission to direct rad<a name='6248'></font>
   real(r8) tdif(nspint,pcols,0:pver) <font color=#447700>! Layer transmission to diffuse rad<a name='6249'></font>
   real(r8) explay(nspint,pcols,0:pver) <font color=#447700>! Solar beam exp trans. for layer<a name='6250'></font>
<a name='6251'>
   real(r8) rdirc(nspint,pcols,0:pver) <font color=#447700>! Clear Layer reflec. to direct rad<a name='6252'></font>
   real(r8) rdifc(nspint,pcols,0:pver) <font color=#447700>! Clear Layer reflec. to diffuse rad<a name='6253'></font>
   real(r8) tdirc(nspint,pcols,0:pver) <font color=#447700>! Clear Layer trans. to direct rad<a name='6254'></font>
   real(r8) tdifc(nspint,pcols,0:pver) <font color=#447700>! Clear Layer trans. to diffuse rad<a name='6255'></font>
   real(r8) explayc(nspint,pcols,0:pver) <font color=#447700>! Solar beam exp trans. clear layer<a name='6256'></font>
<a name='6257'>
   real(r8) flxdiv           <font color=#447700>! Flux divergence for layer<a name='6258'></font>
<font color=#447700>! <a name='6259'></font>
<font color=#447700>! <a name='6260'></font>
<font color=#447700>! Radiative Properties:<a name='6261'></font>
<font color=#447700>! <a name='6262'></font>
<font color=#447700>! There are 1 classes of properties:<a name='6263'></font>
<font color=#447700>! (1. All-sky bulk properties<a name='6264'></font>
<font color=#447700>! (2. Clear-sky properties<a name='6265'></font>
<font color=#447700>! <a name='6266'></font>
<font color=#447700>! The first set of properties are generated during step 2 of the solution.<a name='6267'></font>
<font color=#447700>! <a name='6268'></font>
<font color=#447700>! These arrays are defined at model interfaces; in 1st index (for level #),<a name='6269'></font>
<font color=#447700>! 0 is the top of the extra layer above the model top, and<a name='6270'></font>
<font color=#447700>! pverp is the earth surface.  2nd index is for cloud configuration<a name='6271'></font>
<font color=#447700>! defined over a whole column.<a name='6272'></font>
<font color=#447700>! <a name='6273'></font>
   real(r8) exptdn(0:pverp,nconfgmax) <font color=#447700>! Sol. beam trans from layers above<a name='6274'></font>
   real(r8) rdndif(0:pverp,nconfgmax) <font color=#447700>! Ref to dif rad for layers above<a name='6275'></font>
   real(r8) rupdif(0:pverp,nconfgmax) <font color=#447700>! Ref to dif rad for layers below<a name='6276'></font>
   real(r8) rupdir(0:pverp,nconfgmax) <font color=#447700>! Ref to dir rad for layers below<a name='6277'></font>
   real(r8) tdntot(0:pverp,nconfgmax) <font color=#447700>! Total trans for layers above<a name='6278'></font>
<font color=#447700>! <a name='6279'></font>
<font color=#447700>! Bulk properties used during the clear-sky calculation.<a name='6280'></font>
<font color=#447700>! <a name='6281'></font>
   real(r8) exptdnc(0:pverp) <font color=#447700>! clr: Sol. beam trans from layers above<a name='6282'></font>
   real(r8) rdndifc(0:pverp) <font color=#447700>! clr: Ref to dif rad for layers above<a name='6283'></font>
   real(r8) rupdifc(0:pverp) <font color=#447700>! clr: Ref to dif rad for layers below<a name='6284'></font>
   real(r8) rupdirc(0:pverp) <font color=#447700>! clr: Ref to dir rad for layers below<a name='6285'></font>
   real(r8) tdntotc(0:pverp) <font color=#447700>! clr: Total trans for layers above<a name='6286'></font>
<a name='6287'>
   real(r8) fluxup(0:pverp)  <font color=#447700>! Up   flux at model interface<a name='6288'></font>
   real(r8) fluxdn(0:pverp)  <font color=#447700>! Down flux at model interface<a name='6289'></font>
   real(r8) fluxdndir(0:pverp)  <font color=#447700>! Direct Down flux at model interface (amontornes-bcodina 2014-04-20)<a name='6290'></font>
   real(r8) wexptdn          <font color=#447700>! Direct solar beam trans. to surface<a name='6291'></font>
<a name='6292'>
<font color=#447700>! moved to here from the module storage above, because these have to be thread-private.  JM 20100217<a name='6293'></font>
   real(r8) abarli           <font color=#447700>! A coefficient for current spectral band<a name='6294'></font>
   real(r8) bbarli           <font color=#447700>! B coefficient for current spectral band<a name='6295'></font>
   real(r8) cbarli           <font color=#447700>! C coefficient for current spectral band<a name='6296'></font>
   real(r8) dbarli           <font color=#447700>! D coefficient for current spectral band<a name='6297'></font>
   real(r8) ebarli           <font color=#447700>! E coefficient for current spectral band<a name='6298'></font>
   real(r8) fbarli           <font color=#447700>! F coefficient for current spectral band<a name='6299'></font>
<a name='6300'>
   real(r8) abarii           <font color=#447700>! A coefficient for current spectral band<a name='6301'></font>
   real(r8) bbarii           <font color=#447700>! B coefficient for current spectral band<a name='6302'></font>
   real(r8) cbarii           <font color=#447700>! C coefficient for current spectral band<a name='6303'></font>
   real(r8) dbarii           <font color=#447700>! D coefficient for current spectral band<a name='6304'></font>
   real(r8) ebarii           <font color=#447700>! E coefficient for current spectral band<a name='6305'></font>
   real(r8) fbarii           <font color=#447700>! F coefficient for current spectral band<a name='6306'></font>
<font color=#447700>! JM 20100217<a name='6307'></font>
<a name='6308'>
<font color=#447700>! <a name='6309'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6310'></font>
<font color=#447700>! START OF CALCULATION<a name='6311'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6312'></font>
<font color=#447700>! <a name='6313'></font>
<font color=#447700>!  write (6, '(a, x, i3)') 'radcswmx : chunk identifier', lchnk<a name='6314'></font>
<a name='6315'>
   do i=1, ncol<a name='6316'>
<font color=#447700>! <a name='6317'></font>
<font color=#447700>! Initialize output fields:<a name='6318'></font>
<font color=#447700>! <a name='6319'></font>
      fsds(i)     = 0.0_r8<a name='6320'>
<a name='6321'>
      fsnirtoa(i) = 0.0_r8<a name='6322'>
      fsnrtoac(i) = 0.0_r8<a name='6323'>
      fsnrtoaq(i) = 0.0_r8<a name='6324'>
<a name='6325'>
      fsns(i)     = 0.0_r8<a name='6326'>
      fsnsc(i)    = 0.0_r8<a name='6327'>
      fsdsc(i)    = 0.0_r8<a name='6328'>
<a name='6329'>
      fsdscdir(i) = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='6330'></font>
      fsdscdif(i) = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='6331'></font>
      fsdsdir(i)  = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='6332'></font>
      fsdsdif(i)  = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='6333'></font>
<a name='6334'>
      fsnt(i)     = 0.0_r8<a name='6335'>
      fsntc(i)    = 0.0_r8<a name='6336'>
      fsntoa(i)   = 0.0_r8<a name='6337'>
      fsntoac(i)  = 0.0_r8<a name='6338'>
<a name='6339'>
      solin(i)    = 0.0_r8<a name='6340'>
<a name='6341'>
      sols(i)     = 0.0_r8<a name='6342'>
      soll(i)     = 0.0_r8<a name='6343'>
      solsd(i)    = 0.0_r8<a name='6344'>
      solld(i)    = 0.0_r8<a name='6345'>
<a name='6346'>
<font color=#447700>! initialize added downward/upward total and clear sky fluxes<a name='6347'></font>
<a name='6348'>
         do k=1,pverp<a name='6349'>
            fsup(i,k)  = 0.0_r8<a name='6350'>
            fsupc(i,k) = 0.0_r8<a name='6351'>
            fsdn(i,k)  = 0.0_r8<a name='6352'>
            fsdnc(i,k) = 0.0_r8<a name='6353'>
            fsdndir(i,k)  = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='6354'></font>
            fsdncdir(i,k) = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='6355'></font>
            fsdndif(i,k)  = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='6356'></font>
            fsdncdif(i,k) = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='6357'></font>
            tauxcl(i,k-1) = 0.0_r8<a name='6358'>
            tauxci(i,k-1) = 0.0_r8<a name='6359'>
         end do<a name='6360'>
<a name='6361'>
      do k=1, pver<a name='6362'>
         qrs(i,k) = 0.0_r8<a name='6363'>
      end do<a name='6364'>
<a name='6365'>
      <font color=#447700>! initialize aerosol diagnostic fields to 0.0 <a name='6366'></font>
      <font color=#447700>! Average can be obtained by dividing &lt;aerod&gt;/&lt;frc_day&gt;<a name='6367'></font>
      do kaer = 1, naer_groups<a name='6368'>
         do ns = 1, nspint<a name='6369'>
            frc_day(i) = 0.0_r8<a name='6370'>
            aertau(i,ns,kaer) = 0.0_r8<a name='6371'>
            aerssa(i,ns,kaer) = 0.0_r8<a name='6372'>
            aerasm(i,ns,kaer) = 0.0_r8<a name='6373'>
            aerfwd(i,ns,kaer) = 0.0_r8<a name='6374'>
         end do<a name='6375'>
      end do<a name='6376'>
<a name='6377'>
   end do<a name='6378'>
<font color=#447700>! <a name='6379'></font>
<font color=#447700>! Compute starting, ending daytime loop indices:<a name='6380'></font>
<font color=#447700>!  *** Note this logic assumes day and night points are contiguous so<a name='6381'></font>
<font color=#447700>!  *** will not work in general with chunked data structure.<a name='6382'></font>
<font color=#447700>! <a name='6383'></font>
   ndayc = 0<a name='6384'>
   do i=1,ncol<a name='6385'>
      if (coszrs(i) &gt; 0.0_r8) then<a name='6386'>
         ndayc = ndayc + 1<a name='6387'>
         idayc(ndayc) = i<a name='6388'>
      end if<a name='6389'>
   end do<a name='6390'>
<font color=#447700>! <a name='6391'></font>
<font color=#447700>! If night everywhere, return:<a name='6392'></font>
<font color=#447700>! <a name='6393'></font>
   if (ndayc == 0) return<a name='6394'>
<font color=#447700>! <a name='6395'></font>
<font color=#447700>! Perform other initializations<a name='6396'></font>
<font color=#447700>! <a name='6397'></font>
   tmp1   = 0.5_r8/(gravit*sslp)<a name='6398'>
   tmp2   = delta/gravit<a name='6399'>
   sqrco2 = sqrt(co2mmr)<a name='6400'>
<a name='6401'>
   do n=1,ndayc<a name='6402'>
      i=idayc(n)<a name='6403'>
<font color=#447700>! <a name='6404'></font>
<font color=#447700>! Define solar incident radiation and interface pressures:<a name='6405'></font>
<font color=#447700>! <a name='6406'></font>
<font color=#447700>!        solin(i)  = scon*eccf*coszrs(i)<a name='6407'></font>
<font color=#447700>!WRF use SOLCON (MKS) calculated outside<a name='6408'></font>
         solin(i)  = solcon*coszrs(i)*1000.<a name='6409'>
         pflx(i,0) = 0._r8<a name='6410'>
         do k=1,pverp<a name='6411'>
            pflx(i,k) = pint(i,k)<a name='6412'>
         end do<a name='6413'>
<font color=#447700>! <a name='6414'></font>
<font color=#447700>! Compute optical paths:<a name='6415'></font>
<font color=#447700>! <a name='6416'></font>
         ptop      = pflx(i,1)<a name='6417'>
         ptho2     = o2mmr * ptop / gravit<a name='6418'>
         ptho3     = o3mmr(i,1) * ptop / gravit<a name='6419'>
         pthco2    = sqrco2 * (ptop / gravit)<a name='6420'>
         h2ostr    = sqrt( 1._r8 / h2ommr(i,1) )<a name='6421'>
         zenfac(i) = sqrt(coszrs(i))<a name='6422'>
         pthh2o    = ptop**2*tmp1 + (ptop*rga)* &amp;<a name='6423'>
                    (h2ostr*zenfac(i)*delta)<a name='6424'>
         uh2o(i,0) = h2ommr(i,1)*pthh2o<a name='6425'>
         uco2(i,0) = zenfac(i)*pthco2<a name='6426'>
         uo2 (i,0) = zenfac(i)*ptho2<a name='6427'>
         uo3 (i,0) = ptho3<a name='6428'>
         uaer(i,0) = 0.0_r8<a name='6429'>
         do k=1,pver<a name='6430'>
            pdel      = pflx(i,k+1) - pflx(i,k)<a name='6431'>
            path      = pdel / gravit<a name='6432'>
            ptho2     = o2mmr * path<a name='6433'>
            ptho3     = o3mmr(i,k) * path<a name='6434'>
            pthco2    = sqrco2 * path<a name='6435'>
            h2ostr    = sqrt(1.0_r8/h2ommr(i,k))<a name='6436'>
            pthh2o    = (pflx(i,k+1)**2 - pflx(i,k)**2)*tmp1 + pdel*h2ostr*zenfac(i)*tmp2<a name='6437'>
            uh2o(i,k) = h2ommr(i,k)*pthh2o<a name='6438'>
            uco2(i,k) = zenfac(i)*pthco2<a name='6439'>
            uo2 (i,k) = zenfac(i)*ptho2<a name='6440'>
            uo3 (i,k) = ptho3<a name='6441'>
            usul(i,k) = aermmr(i,k,idxSUL) * path <a name='6442'>
            ubg(i,k) = aermmr(i,k,idxBG) * path <a name='6443'>
            usslt(i,k) = aermmr(i,k,idxSSLT) * path<a name='6444'>
            if (usslt(i,k) .lt. 0.0) then  <font color=#447700>! usslt is sometimes small and negative, will be fixed<a name='6445'></font>
              usslt(i,k) = 0.0<a name='6446'>
            end if<a name='6447'>
            ucphil(i,k) = aermmr(i,k,idxOCPHI) * path<a name='6448'>
            ucphob(i,k) = aermmr(i,k,idxOCPHO) * path<a name='6449'>
            ucb(i,k) = ( aermmr(i,k,idxBCPHO) + aermmr(i,k,idxBCPHI) ) * path<a name='6450'>
            uvolc(i,k) =  aermmr(i,k,idxVOLC)<a name='6451'>
            do ksz = 1, ndstsz<a name='6452'>
              udst(ksz,i,k) = aermmr(i,k,idxDUSTfirst-1+ksz) * path<a name='6453'>
            end do<a name='6454'>
         end do<a name='6455'>
<font color=#447700>! <a name='6456'></font>
<font color=#447700>! Compute column absorber amounts for the clear sky computation:<a name='6457'></font>
<font color=#447700>! <a name='6458'></font>
         uth2o(i) = 0.0_r8<a name='6459'>
         uto3(i)  = 0.0_r8<a name='6460'>
         utco2(i) = 0.0_r8<a name='6461'>
         uto2(i)  = 0.0_r8<a name='6462'>
<a name='6463'>
         do k=1,pver<a name='6464'>
            uth2o(i) = uth2o(i) + uh2o(i,k)<a name='6465'>
            uto3(i)  = uto3(i)  + uo3(i,k)<a name='6466'>
            utco2(i) = utco2(i) + uco2(i,k)<a name='6467'>
            uto2(i)  = uto2(i)  + uo2(i,k)<a name='6468'>
         end do<a name='6469'>
<font color=#447700>! <a name='6470'></font>
<font color=#447700>! Set cloud properties for top (0) layer; so long as tauxcl is zero,<a name='6471'></font>
<font color=#447700>! there is no cloud above top of model; the other cloud properties<a name='6472'></font>
<font color=#447700>! are arbitrary:<a name='6473'></font>
<font color=#447700>! <a name='6474'></font>
         tauxcl(i,0)  = 0._r8<a name='6475'>
         wcl(i,0)     = 0.999999_r8<a name='6476'>
         gcl(i,0)     = 0.85_r8<a name='6477'>
         fcl(i,0)     = 0.725_r8<a name='6478'>
         tauxci(i,0)  = 0._r8<a name='6479'>
         wci(i,0)     = 0.999999_r8<a name='6480'>
         gci(i,0)     = 0.85_r8<a name='6481'>
         fci(i,0)     = 0.725_r8<a name='6482'>
<font color=#447700>! <a name='6483'></font>
<font color=#447700>! Aerosol <a name='6484'></font>
<font color=#447700>! <a name='6485'></font>
         tauxar(i,0)  = 0._r8<a name='6486'>
         wa(i,0)      = 0.925_r8<a name='6487'>
         ga(i,0)      = 0.850_r8<a name='6488'>
         fa(i,0)      = 0.7225_r8<a name='6489'>
<font color=#447700>! <a name='6490'></font>
<font color=#447700>! End  do n=1,ndayc<a name='6491'></font>
<font color=#447700>! <a name='6492'></font>
   end do<a name='6493'>
<font color=#447700>! <a name='6494'></font>
<font color=#447700>! Begin spectral loop<a name='6495'></font>
<font color=#447700>! <a name='6496'></font>
   do ns=1,nspint<a name='6497'>
<font color=#447700>! <a name='6498'></font>
<font color=#447700>! Set index for cloud particle properties based on the wavelength,<a name='6499'></font>
<font color=#447700>! according to A. Slingo (1989) equations 1-3:<a name='6500'></font>
<font color=#447700>! Use index 1 (0.25 to 0.69 micrometers) for visible<a name='6501'></font>
<font color=#447700>! Use index 2 (0.69 - 1.19 micrometers) for near-infrared<a name='6502'></font>
<font color=#447700>! Use index 3 (1.19 to 2.38 micrometers) for near-infrared<a name='6503'></font>
<font color=#447700>! Use index 4 (2.38 to 4.00 micrometers) for near-infrared<a name='6504'></font>
<font color=#447700>! <a name='6505'></font>
<font color=#447700>! Note that the minimum wavelength is encoded (with .001, .002, .003)<a name='6506'></font>
<font color=#447700>! in order to specify the index appropriate for the near-infrared<a name='6507'></font>
<font color=#447700>! cloud absorption properties<a name='6508'></font>
<font color=#447700>! <a name='6509'></font>
      if(wavmax(ns) &lt;= 0.7_r8) then<a name='6510'>
         indxsl = 1<a name='6511'>
      else if(wavmin(ns) == 0.700_r8) then<a name='6512'>
         indxsl = 2<a name='6513'>
      else if(wavmin(ns) == 0.701_r8) then<a name='6514'>
         indxsl = 3<a name='6515'>
      else if(wavmin(ns) == 0.702_r8 .or. wavmin(ns) &gt; 2.38_r8) then<a name='6516'>
         indxsl = 4<a name='6517'>
      end if<a name='6518'>
<font color=#447700>! <a name='6519'></font>
<font color=#447700>! Set cloud extinction optical depth, single scatter albedo,<a name='6520'></font>
<font color=#447700>! asymmetry parameter, and forward scattered fraction:<a name='6521'></font>
<font color=#447700>! <a name='6522'></font>
      abarli = abarl(indxsl)<a name='6523'>
      bbarli = bbarl(indxsl)<a name='6524'>
      cbarli = cbarl(indxsl)<a name='6525'>
      dbarli = dbarl(indxsl)<a name='6526'>
      ebarli = ebarl(indxsl)<a name='6527'>
      fbarli = fbarl(indxsl)<a name='6528'>
<font color=#447700>! <a name='6529'></font>
      abarii = abari(indxsl)<a name='6530'>
      bbarii = bbari(indxsl)<a name='6531'>
      cbarii = cbari(indxsl)<a name='6532'>
      dbarii = dbari(indxsl)<a name='6533'>
      ebarii = ebari(indxsl)<a name='6534'>
      fbarii = fbari(indxsl)<a name='6535'>
<font color=#447700>! <a name='6536'></font>
<font color=#447700>! adjustfraction within spectral interval to allow for the possibility of<a name='6537'></font>
<font color=#447700>! sub-divisions within a particular interval:<a name='6538'></font>
<font color=#447700>! <a name='6539'></font>
      psf(ns) = 1.0_r8<a name='6540'>
      if(ph2o(ns)/=0._r8) psf(ns) = psf(ns)*ph2o(ns)<a name='6541'>
      if(pco2(ns)/=0._r8) psf(ns) = psf(ns)*pco2(ns)<a name='6542'>
      if(po2 (ns)/=0._r8) psf(ns) = psf(ns)*po2 (ns)<a name='6543'>
<a name='6544'>
      do n=1,ndayc<a name='6545'>
         i=idayc(n)<a name='6546'>
<a name='6547'>
         frc_day(i) = 1.0_r8<a name='6548'>
         do kaer = 1, naer_groups<a name='6549'>
            aertau(i,ns,kaer) = 0.0<a name='6550'>
            aerssa(i,ns,kaer) = 0.0<a name='6551'>
            aerasm(i,ns,kaer) = 0.0<a name='6552'>
            aerfwd(i,ns,kaer) = 0.0<a name='6553'>
         end do<a name='6554'>
<a name='6555'>
            do k=1,pver<a name='6556'>
<font color=#447700>! <a name='6557'></font>
<font color=#447700>! liquid<a name='6558'></font>
<font color=#447700>! <a name='6559'></font>
               tmp1l = abarli + bbarli/rel(i,k)<a name='6560'>
               tmp2l = 1._r8 - cbarli - dbarli*rel(i,k)<a name='6561'>
               tmp3l = fbarli*rel(i,k)<a name='6562'>
<font color=#447700>! <a name='6563'></font>
<font color=#447700>! ice<a name='6564'></font>
<font color=#447700>! <a name='6565'></font>
               tmp1i = abarii + bbarii/rei(i,k)<a name='6566'>
               tmp2i = 1._r8 - cbarii - dbarii*rei(i,k)<a name='6567'>
               tmp3i = fbarii*rei(i,k)<a name='6568'>
<a name='6569'>
               if (cld(i,k) &gt;= cldmin .and. cld(i,k) &gt;= cldeps) then<a name='6570'>
                  tauxcl(i,k) = cliqwp(i,k)*tmp1l<a name='6571'>
                  tauxci(i,k) = cicewp(i,k)*tmp1i<a name='6572'>
               else<a name='6573'>
                  tauxcl(i,k) = 0.0<a name='6574'>
                  tauxci(i,k) = 0.0<a name='6575'>
               endif<a name='6576'>
<font color=#447700>! <a name='6577'></font>
<font color=#447700>! Do not let single scatter albedo be 1.  Delta-eddington solution<a name='6578'></font>
<font color=#447700>! for non-conservative case has different analytic form from solution<a name='6579'></font>
<font color=#447700>! for conservative case, and raddedmx is written for non-conservative case.<a name='6580'></font>
<font color=#447700>! <a name='6581'></font>
               wcl(i,k) = min(tmp2l,.999999_r8)<a name='6582'>
               gcl(i,k) = ebarli + tmp3l<a name='6583'>
               fcl(i,k) = gcl(i,k)*gcl(i,k)<a name='6584'>
<font color=#447700>! <a name='6585'></font>
               wci(i,k) = min(tmp2i,.999999_r8)<a name='6586'>
               gci(i,k) = ebarii + tmp3i<a name='6587'>
               fci(i,k) = gci(i,k)*gci(i,k)<a name='6588'>
<font color=#447700>! <a name='6589'></font>
<font color=#447700>! Set aerosol properties<a name='6590'></font>
<font color=#447700>! Conversion factor to adjust aerosol extinction (m2/g)<a name='6591'></font>
<font color=#447700>! <a name='6592'></font>
               rhtrunc = rh(i,k)<a name='6593'>
               rhtrunc = min(rh(i,k),1._r8)<a name='6594'>
<font color=#447700>!              if(rhtrunc.lt.0._r8) call endrun ('RADCSWMX')<a name='6595'></font>
               krh = min(floor( rhtrunc * nrh ) + 1, nrh - 1)<a name='6596'>
               wrh = rhtrunc * nrh - krh<a name='6597'>
<a name='6598'>
               <font color=#447700>! linear interpolation of optical properties between rh table points<a name='6599'></font>
               ksuli = ksul(krh + 1, ns) * (wrh + 1) - ksul(krh, ns) * wrh<a name='6600'>
               ksslti = ksslt(krh + 1, ns) * (wrh + 1) - ksslt(krh, ns) * wrh<a name='6601'>
               kcphili = kcphil(krh + 1, ns) * (wrh + 1) - kcphil(krh, ns) * wrh<a name='6602'>
               wsuli = wsul(krh + 1, ns) * (wrh + 1) - wsul(krh, ns) * wrh<a name='6603'>
               wsslti = wsslt(krh + 1, ns) * (wrh + 1) - wsslt(krh, ns) * wrh<a name='6604'>
               wcphili = wcphil(krh + 1, ns) * (wrh + 1) - wcphil(krh, ns) * wrh<a name='6605'>
               gsuli = gsul(krh + 1, ns) * (wrh + 1) - gsul(krh, ns) * wrh<a name='6606'>
               gsslti = gsslt(krh + 1, ns) * (wrh + 1) - gsslt(krh, ns) * wrh<a name='6607'>
               gcphili = gcphil(krh + 1, ns) * (wrh + 1) - gcphil(krh, ns) * wrh<a name='6608'>
<a name='6609'>
               tau_sul = 1.e4 * ksuli * usul(i,k)<a name='6610'>
               tau_sslt = 1.e4 * ksslti * usslt(i,k)<a name='6611'>
               tau_cphil = 1.e4 * kcphili * ucphil(i,k)<a name='6612'>
               tau_cphob = 1.e4 * kcphob(ns) * ucphob(i,k)<a name='6613'>
               tau_cb = 1.e4 * kcb(ns) * ucb(i,k)<a name='6614'>
               tau_volc = 1.e3 * kvolc(ns) * uvolc(i,k)<a name='6615'>
               tau_dst(:) = 1.e4 * kdst(:,ns) * udst(:,i,k)<a name='6616'>
               tau_bg = 1.e4 * kbg(ns) * ubg(i,k)<a name='6617'>
<a name='6618'>
               tau_w_sul = tau_sul * wsuli<a name='6619'>
               tau_w_sslt = tau_sslt * wsslti<a name='6620'>
               tau_w_cphil = tau_cphil * wcphili<a name='6621'>
               tau_w_cphob = tau_cphob * wcphob(ns)<a name='6622'>
               tau_w_cb = tau_cb * wcb(ns)<a name='6623'>
               tau_w_volc = tau_volc * wvolc(ns)<a name='6624'>
               tau_w_dst(:) = tau_dst(:) * wdst(:,ns)<a name='6625'>
               tau_w_bg = tau_bg * wbg(ns)<a name='6626'>
<a name='6627'>
               tau_w_g_sul = tau_w_sul * gsuli<a name='6628'>
               tau_w_g_sslt = tau_w_sslt * gsslti<a name='6629'>
               tau_w_g_cphil = tau_w_cphil * gcphili<a name='6630'>
               tau_w_g_cphob = tau_w_cphob * gcphob(ns)<a name='6631'>
               tau_w_g_cb = tau_w_cb * gcb(ns)<a name='6632'>
               tau_w_g_volc = tau_w_volc * gvolc(ns)<a name='6633'>
               tau_w_g_dst(:) = tau_w_dst(:) * gdst(:,ns)<a name='6634'>
               tau_w_g_bg = tau_w_bg * gbg(ns)<a name='6635'>
<a name='6636'>
               f_sul = gsuli * gsuli<a name='6637'>
               f_sslt = gsslti * gsslti<a name='6638'>
               f_cphil = gcphili * gcphili<a name='6639'>
               f_cphob = gcphob(ns) * gcphob(ns)<a name='6640'>
               f_cb = gcb(ns) * gcb(ns)<a name='6641'>
               f_volc = gvolc(ns) * gvolc(ns)<a name='6642'>
               f_dst(:) = gdst(:,ns) * gdst(:,ns)<a name='6643'>
               f_bg = gbg(ns) * gbg(ns)<a name='6644'>
<a name='6645'>
               tau_w_f_sul = tau_w_sul * f_sul<a name='6646'>
               tau_w_f_bg = tau_w_bg * f_bg<a name='6647'>
               tau_w_f_sslt = tau_w_sslt * f_sslt<a name='6648'>
               tau_w_f_cphil = tau_w_cphil * f_cphil<a name='6649'>
               tau_w_f_cphob = tau_w_cphob * f_cphob<a name='6650'>
               tau_w_f_cb = tau_w_cb * f_cb<a name='6651'>
               tau_w_f_volc = tau_w_volc * f_volc<a name='6652'>
               tau_w_f_dst(:) = tau_w_dst(:) * f_dst(:)<a name='6653'>
<font color=#447700>!<a name='6654'></font>
<font color=#447700>! mix dust aerosol size bins<a name='6655'></font>
<font color=#447700>!   w_dst_tot, g_dst_tot, w_dst_tot are currently not used anywhere<a name='6656'></font>
<font color=#447700>!   but calculate them anyway for future use<a name='6657'></font>
<font color=#447700>!<a name='6658'></font>
               tau_dst_tot = sum(tau_dst)<a name='6659'>
               tau_w_dst_tot = sum(tau_w_dst)<a name='6660'>
               tau_w_g_dst_tot = sum(tau_w_g_dst)<a name='6661'>
               tau_w_f_dst_tot = sum(tau_w_f_dst)<a name='6662'>
<a name='6663'>
               if (tau_dst_tot .gt. 0.0) then<a name='6664'>
                 w_dst_tot = tau_w_dst_tot / tau_dst_tot<a name='6665'>
               else<a name='6666'>
                 w_dst_tot = 0.0<a name='6667'>
               endif<a name='6668'>
<a name='6669'>
               if (tau_w_dst_tot .gt. 0.0) then<a name='6670'>
                 g_dst_tot = tau_w_g_dst_tot / tau_w_dst_tot<a name='6671'>
                 f_dst_tot = tau_w_f_dst_tot / tau_w_dst_tot<a name='6672'>
               else<a name='6673'>
                 g_dst_tot = 0.0<a name='6674'>
                 f_dst_tot = 0.0<a name='6675'>
               endif<a name='6676'>
<font color=#447700>!<a name='6677'></font>
<font color=#447700>! mix aerosols<a name='6678'></font>
<font color=#447700>!<a name='6679'></font>
               tau_tot     = tau_sul + tau_sslt &amp;<a name='6680'>
                           + tau_cphil + tau_cphob + tau_cb + tau_dst_tot<a name='6681'>
               tau_tot     = tau_tot + tau_bg + tau_volc<a name='6682'>
<a name='6683'>
               tau_w_tot   = tau_w_sul + tau_w_sslt &amp;<a name='6684'>
                           + tau_w_cphil + tau_w_cphob + tau_w_cb + tau_w_dst_tot<a name='6685'>
               tau_w_tot   = tau_w_tot + tau_w_bg + tau_w_volc<a name='6686'>
<a name='6687'>
               tau_w_g_tot = tau_w_g_sul + tau_w_g_sslt &amp;<a name='6688'>
                           + tau_w_g_cphil + tau_w_g_cphob + tau_w_g_cb + tau_w_g_dst_tot<a name='6689'>
               tau_w_g_tot = tau_w_g_tot + tau_w_g_bg + tau_w_g_volc<a name='6690'>
<a name='6691'>
               tau_w_f_tot = tau_w_f_sul + tau_w_f_sslt &amp;<a name='6692'>
                           + tau_w_f_cphil + tau_w_f_cphob + tau_w_f_cb + tau_w_f_dst_tot<a name='6693'>
               tau_w_f_tot = tau_w_f_tot + tau_w_f_bg  + tau_w_f_volc<a name='6694'>
<a name='6695'>
               if (tau_tot .gt. 0.0) then<a name='6696'>
                 w_tot = tau_w_tot / tau_tot<a name='6697'>
               else<a name='6698'>
                 w_tot = 0.0<a name='6699'>
               endif<a name='6700'>
<a name='6701'>
               if (tau_w_tot .gt. 0.0) then<a name='6702'>
                 g_tot = tau_w_g_tot / tau_w_tot<a name='6703'>
                 f_tot = tau_w_f_tot / tau_w_tot<a name='6704'>
               else<a name='6705'>
                 g_tot = 0.0<a name='6706'>
                 f_tot = 0.0<a name='6707'>
               endif<a name='6708'>
<a name='6709'>
               tauxar(i,k) = tau_tot<a name='6710'>
               wa(i,k)     = min(w_tot, 0.999999_r8)<a name='6711'>
               if (g_tot.gt.1._r8) write(6,*) "g_tot &gt; 1"<a name='6712'>
               if (g_tot.lt.-1._r8) write(6,*) "g_tot &lt; -1"<a name='6713'>
<font color=#447700>!              if (g_tot.gt.1._r8) call endrun ('RADCSWMX')<a name='6714'></font>
<font color=#447700>!              if (g_tot.lt.-1._r8) call endrun ('RADCSWMX')<a name='6715'></font>
               ga(i,k)     = g_tot<a name='6716'>
               if (f_tot.gt.1._r8) write(6,*)"f_tot &gt; 1"<a name='6717'>
               if (f_tot.lt.0._r8) write(6,*)"f_tot &lt; 0"<a name='6718'>
<font color=#447700>!              if (f_tot.gt.1._r8) call endrun ('RADCSWMX')<a name='6719'></font>
<font color=#447700>!              if (f_tot.lt.0._r8) call endrun ('RADCSWMX')<a name='6720'></font>
               fa(i,k)     = f_tot<a name='6721'>
<a name='6722'>
               aertau(i,ns,1) = aertau(i,ns,1) + tau_sul<a name='6723'>
               aertau(i,ns,2) = aertau(i,ns,2) + tau_sslt<a name='6724'>
               aertau(i,ns,3) = aertau(i,ns,3) + tau_cphil + tau_cphob + tau_cb<a name='6725'>
               aertau(i,ns,4) = aertau(i,ns,4) + tau_dst_tot<a name='6726'>
               aertau(i,ns,5) = aertau(i,ns,5) + tau_bg<a name='6727'>
               aertau(i,ns,6) = aertau(i,ns,6) + tau_volc<a name='6728'>
               aertau(i,ns,7) = aertau(i,ns,7) + tau_tot<a name='6729'>
<a name='6730'>
               aerssa(i,ns,1) = aerssa(i,ns,1) + tau_w_sul<a name='6731'>
               aerssa(i,ns,2) = aerssa(i,ns,2) + tau_w_sslt<a name='6732'>
               aerssa(i,ns,3) = aerssa(i,ns,3) + tau_w_cphil + tau_w_cphob + tau_w_cb<a name='6733'>
               aerssa(i,ns,4) = aerssa(i,ns,4) + tau_w_dst_tot<a name='6734'>
               aerssa(i,ns,5) = aerssa(i,ns,5) + tau_w_bg<a name='6735'>
               aerssa(i,ns,6) = aerssa(i,ns,6) + tau_w_volc<a name='6736'>
               aerssa(i,ns,7) = aerssa(i,ns,7) + tau_w_tot<a name='6737'>
<a name='6738'>
               aerasm(i,ns,1) = aerasm(i,ns,1) + tau_w_g_sul<a name='6739'>
               aerasm(i,ns,2) = aerasm(i,ns,2) + tau_w_g_sslt<a name='6740'>
               aerasm(i,ns,3) = aerasm(i,ns,3) + tau_w_g_cphil + tau_w_g_cphob + tau_w_g_cb<a name='6741'>
               aerasm(i,ns,4) = aerasm(i,ns,4) + tau_w_g_dst_tot<a name='6742'>
               aerasm(i,ns,5) = aerasm(i,ns,5) + tau_w_g_bg<a name='6743'>
               aerasm(i,ns,6) = aerasm(i,ns,6) + tau_w_g_volc<a name='6744'>
               aerasm(i,ns,7) = aerasm(i,ns,7) + tau_w_g_tot<a name='6745'>
<a name='6746'>
               aerfwd(i,ns,1) = aerfwd(i,ns,1) + tau_w_f_sul<a name='6747'>
               aerfwd(i,ns,2) = aerfwd(i,ns,2) + tau_w_f_sslt<a name='6748'>
               aerfwd(i,ns,3) = aerfwd(i,ns,3) + tau_w_f_cphil + tau_w_f_cphob + tau_w_f_cb<a name='6749'>
               aerfwd(i,ns,4) = aerfwd(i,ns,4) + tau_w_f_dst_tot<a name='6750'>
               aerfwd(i,ns,5) = aerfwd(i,ns,5) + tau_w_f_bg<a name='6751'>
               aerfwd(i,ns,6) = aerfwd(i,ns,6) + tau_w_f_volc<a name='6752'>
               aerfwd(i,ns,7) = aerfwd(i,ns,7) + tau_w_f_tot<a name='6753'>
<a name='6754'>
<font color=#447700>! <a name='6755'></font>
<font color=#447700>! End do k=1,pver<a name='6756'></font>
<font color=#447700>! <a name='6757'></font>
            end do<a name='6758'>
<a name='6759'>
            <font color=#447700>! normalize aerosol optical diagnostic fields<a name='6760'></font>
            do kaer = 1, naer_groups<a name='6761'>
<a name='6762'>
               if (aerssa(i,ns,kaer) .gt. 0.0) then   <font color=#447700>! aerssa currently holds product of tau and ssa<a name='6763'></font>
                  aerasm(i,ns,kaer) = aerasm(i,ns,kaer) / aerssa(i,ns,kaer)<a name='6764'>
                  aerfwd(i,ns,kaer) = aerfwd(i,ns,kaer) / aerssa(i,ns,kaer)<a name='6765'>
               else<a name='6766'>
                  aerasm(i,ns,kaer) = 0.0_r8<a name='6767'>
                  aerfwd(i,ns,kaer) = 0.0_r8<a name='6768'>
               end if<a name='6769'>
<a name='6770'>
               if (aertau(i,ns,kaer) .gt. 0.0) then<a name='6771'>
                  aerssa(i,ns,kaer) = aerssa(i,ns,kaer) / aertau(i,ns,kaer)<a name='6772'>
               else<a name='6773'>
                  aerssa(i,ns,kaer) = 0.0_r8<a name='6774'>
               end if<a name='6775'>
<a name='6776'>
            end do<a name='6777'>
<a name='6778'>
<a name='6779'>
<font color=#447700>! <a name='6780'></font>
<font color=#447700>! End do n=1,ndayc<a name='6781'></font>
<font color=#447700>! <a name='6782'></font>
      end do<a name='6783'>
<a name='6784'>
<font color=#447700>! <a name='6785'></font>
<font color=#447700>! Set reflectivities for surface based on mid-point wavelength<a name='6786'></font>
<font color=#447700>! <a name='6787'></font>
      wavmid(ns) = 0.5_r8*(wavmin(ns) + wavmax(ns))<a name='6788'>
<font color=#447700>! <a name='6789'></font>
<font color=#447700>! Wavelength less  than 0.7 micro-meter<a name='6790'></font>
<font color=#447700>! <a name='6791'></font>
      if (wavmid(ns) &lt; 0.7_r8 ) then<a name='6792'>
         do n=1,ndayc<a name='6793'>
            i=idayc(n)<a name='6794'>
               albdir(i,ns) = asdir(i)<a name='6795'>
               albdif(i,ns) = asdif(i)<a name='6796'>
         end do<a name='6797'>
<font color=#447700>! <a name='6798'></font>
<font color=#447700>! Wavelength greater than 0.7 micro-meter<a name='6799'></font>
<font color=#447700>! <a name='6800'></font>
      else<a name='6801'>
         do n=1,ndayc<a name='6802'>
            i=idayc(n)<a name='6803'>
               albdir(i,ns) = aldir(i)<a name='6804'>
               albdif(i,ns) = aldif(i)<a name='6805'>
         end do<a name='6806'>
      end if<a name='6807'>
      trayoslp = raytau(ns)/sslp<a name='6808'>
<font color=#447700>! <a name='6809'></font>
<font color=#447700>! Layer input properties now completely specified; compute the<a name='6810'></font>
<font color=#447700>! delta-Eddington solution reflectivities and transmissivities<a name='6811'></font>
<font color=#447700>! for each layer<a name='6812'></font>
<font color=#447700>! <a name='6813'></font>
      call <A href='../../html_code/phys/module_ra_cam.F.html#RADDEDMX'>raddedmx</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCSWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADDEDMX_1">(pver, pverp, pcols, coszrs   ,ndayc    ,idayc   , &amp;<a name='6814'>
              abh2o(ns),abo3(ns) ,abco2(ns),abo2(ns) , &amp;<a name='6815'>
              uh2o     ,uo3      ,uco2     ,uo2      , &amp;<a name='6816'>
              trayoslp ,pflx     ,ns       , &amp;<a name='6817'>
              tauxcl   ,wcl      ,gcl      ,fcl      , &amp;<a name='6818'>
              tauxci   ,wci      ,gci      ,fci      , &amp;<a name='6819'>
              tauxar   ,wa       ,ga       ,fa       , &amp;<a name='6820'>
              rdir     ,rdif     ,tdir     ,tdif     ,explay  , &amp;<a name='6821'>
              rdirc    ,rdifc    ,tdirc    ,tdifc    ,explayc )<a name='6822'>
<font color=#447700>! <a name='6823'></font>
<font color=#447700>! End spectral loop<a name='6824'></font>
<font color=#447700>! <a name='6825'></font>
   end do<a name='6826'>
<font color=#447700>! <a name='6827'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='6828'></font>
<font color=#447700>! <a name='6829'></font>
<font color=#447700>! Solution for max/random cloud overlap.  <a name='6830'></font>
<font color=#447700>! <a name='6831'></font>
<font color=#447700>! Steps:<a name='6832'></font>
<font color=#447700>! (1. delta-Eddington solution for each layer (called above)<a name='6833'></font>
<font color=#447700>! <a name='6834'></font>
<font color=#447700>! (2. The adding method is used to<a name='6835'></font>
<font color=#447700>! compute the reflectivity and transmissivity to direct and diffuse<a name='6836'></font>
<font color=#447700>! radiation from the top and bottom of the atmosphere for each<a name='6837'></font>
<font color=#447700>! cloud configuration.  This calculation is based upon the<a name='6838'></font>
<font color=#447700>! max-random overlap assumption.<a name='6839'></font>
<font color=#447700>! <a name='6840'></font>
<font color=#447700>! (3. to solve for the fluxes, combine the<a name='6841'></font>
<font color=#447700>! bulk properties of the atmosphere above/below the region.<a name='6842'></font>
<font color=#447700>! <a name='6843'></font>
<font color=#447700>! Index calculations for steps 2-3 are performed outside spectral<a name='6844'></font>
<font color=#447700>! loop to avoid redundant calculations.  Index calculations (with<a name='6845'></font>
<font color=#447700>! application of areamin &amp; nconfgmax conditions) are performed <a name='6846'></font>
<font color=#447700>! first to identify the minimum subset of terms for the configurations <a name='6847'></font>
<font color=#447700>! satisfying the areamin &amp; nconfgmax conditions. This minimum set is <a name='6848'></font>
<font color=#447700>! used to identify the corresponding minimum subset of terms in <a name='6849'></font>
<font color=#447700>! steps 2 and 3.<a name='6850'></font>
<font color=#447700>! <a name='6851'></font>
<a name='6852'>
   do n=1,ndayc<a name='6853'>
      i=idayc(n)<a name='6854'>
<a name='6855'>
<font color=#447700>!----------------------------------------------------------------------<a name='6856'></font>
<font color=#447700>! INDEX CALCULATIONS FOR MAX OVERLAP<a name='6857'></font>
<font color=#447700>! <a name='6858'></font>
<font color=#447700>! The column is divided into sets of adjacent layers, called regions, <a name='6859'></font>
<font color=#447700>! in which the clouds are maximally overlapped.  The clouds are<a name='6860'></font>
<font color=#447700>! randomly overlapped between different regions.  The number of<a name='6861'></font>
<font color=#447700>! regions in a column is set by nmxrgn, and the range of pressures<a name='6862'></font>
<font color=#447700>! included in each region is set by pmxrgn.  <a name='6863'></font>
<font color=#447700>! <a name='6864'></font>
<font color=#447700>! The following calculations determine the number of unique cloud <a name='6865'></font>
<font color=#447700>! configurations (assuming maximum overlap), called "streams",<a name='6866'></font>
<font color=#447700>! within each region. Each stream consists of a vector of binary<a name='6867'></font>
<font color=#447700>! clouds (either 0 or 100% cloud cover).  Over the depth of the region, <a name='6868'></font>
<font color=#447700>! each stream requires a separate calculation of radiative properties. These<a name='6869'></font>
<font color=#447700>! properties are generated using the adding method from<a name='6870'></font>
<font color=#447700>! the radiative properties for each layer calculated by raddedmx.<a name='6871'></font>
<font color=#447700>! <a name='6872'></font>
<font color=#447700>! The upward and downward-propagating streams are treated<a name='6873'></font>
<font color=#447700>! separately.<a name='6874'></font>
<font color=#447700>! <a name='6875'></font>
<font color=#447700>! We will refer to a particular configuration of binary clouds<a name='6876'></font>
<font color=#447700>! within a single max-overlapped region as a "stream".  We will <a name='6877'></font>
<font color=#447700>! refer to a particular arrangement of binary clouds over the entire column<a name='6878'></font>
<font color=#447700>! as a "configuration".<a name='6879'></font>
<font color=#447700>! <a name='6880'></font>
<font color=#447700>! This section of the code generates the following information:<a name='6881'></font>
<font color=#447700>! (1. nrgn    : the true number of max-overlap regions (need not = nmxrgn)<a name='6882'></font>
<font color=#447700>! (2. nstr    : the number of streams in a region (&gt;=1)<a name='6883'></font>
<font color=#447700>! (3. cstr    : flags for presence of clouds at each layer in each stream<a name='6884'></font>
<font color=#447700>! (4. wstr    : the fractional horizontal area of a grid box covered<a name='6885'></font>
<font color=#447700>! by each stream<a name='6886'></font>
<font color=#447700>! (5. kx1,2   : level indices for top/bottom of each region<a name='6887'></font>
<font color=#447700>! <a name='6888'></font>
<font color=#447700>! The max-overlap calculation proceeds in 3 stages:<a name='6889'></font>
<font color=#447700>! (1. compute layer radiative properties in raddedmx.<a name='6890'></font>
<font color=#447700>! (2. combine these properties between layers <a name='6891'></font>
<font color=#447700>! (3. combine properties to compute fluxes at each interface.  <a name='6892'></font>
<font color=#447700>! <a name='6893'></font>
<font color=#447700>! Most of the indexing information calculated here is used in steps 2-3<a name='6894'></font>
<font color=#447700>! after the call to raddedmx.<a name='6895'></font>
<font color=#447700>! <a name='6896'></font>
<font color=#447700>! Initialize indices for layers to be max-overlapped<a name='6897'></font>
<font color=#447700>! <a name='6898'></font>
<font color=#447700>! Loop to handle fix in totwgt=0. For original overlap config <a name='6899'></font>
<font color=#447700>! from npasses = 0.<a name='6900'></font>
<font color=#447700>! <a name='6901'></font>
         npasses = 0<a name='6902'>
         do<a name='6903'>
            do irgn = 0, nmxrgn(i)<a name='6904'>
               kx2(irgn) = 0<a name='6905'>
            end do<a name='6906'>
            mrgn = 0<a name='6907'>
<font color=#447700>! <a name='6908'></font>
<font color=#447700>! Outermost loop over regions (sets of adjacent layers) to be max overlapped<a name='6909'></font>
<font color=#447700>! <a name='6910'></font>
            do irgn = 1, nmxrgn(i)<a name='6911'>
<font color=#447700>! <a name='6912'></font>
<font color=#447700>! Calculate min/max layer indices inside region.  <a name='6913'></font>
<font color=#447700>! <a name='6914'></font>
               region_found = .false.<a name='6915'>
               if (kx2(irgn-1) &lt; pver) then<a name='6916'>
                  k1 = kx2(irgn-1)+1<a name='6917'>
                  kx1(irgn) = k1<a name='6918'>
                  kx2(irgn) = k1-1<a name='6919'>
                  do k2 = pver, k1, -1<a name='6920'>
                     if (pmid(i,k2) &lt;= pmxrgn(i,irgn)) then<a name='6921'>
                        kx2(irgn) = k2<a name='6922'>
                        mrgn = mrgn+1<a name='6923'>
                        region_found = .true.<a name='6924'>
                        exit<a name='6925'>
                     end if<a name='6926'>
                  end do<a name='6927'>
               else<a name='6928'>
                  exit<a name='6929'>
               endif<a name='6930'>
<a name='6931'>
               if (region_found) then<a name='6932'>
<font color=#447700>! <a name='6933'></font>
<font color=#447700>! Sort cloud areas and corresponding level indices.  <a name='6934'></font>
<font color=#447700>! <a name='6935'></font>
                  nxs = 0<a name='6936'>
                  if (cldeps &gt; 0) then <a name='6937'>
                     do k = k1,k2<a name='6938'>
                        if (cld(i,k) &gt;= cldmin .and. cld(i,k) &gt;= cldeps) then<a name='6939'>
                           nxs = nxs+1<a name='6940'>
                           ksort(nxs) = k<a name='6941'>
<font color=#447700>! <a name='6942'></font>
<font color=#447700>! We need indices for clouds in order of largest to smallest, so<a name='6943'></font>
<font color=#447700>! sort 1-cld in ascending order<a name='6944'></font>
<font color=#447700>! <a name='6945'></font>
                           asort(nxs) = 1.0_r8-(floor(cld(i,k)/cldeps)*cldeps)<a name='6946'>
                        end if<a name='6947'>
                     end do<a name='6948'>
                  else<a name='6949'>
                     do k = k1,k2<a name='6950'>
                        if (cld(i,k) &gt;= cldmin) then<a name='6951'>
                           nxs = nxs+1<a name='6952'>
                           ksort(nxs) = k<a name='6953'>
<font color=#447700>! <a name='6954'></font>
<font color=#447700>! We need indices for clouds in order of largest to smallest, so<a name='6955'></font>
<font color=#447700>! sort 1-cld in ascending order<a name='6956'></font>
<font color=#447700>! <a name='6957'></font>
                           asort(nxs) = 1.0_r8-cld(i,k)<a name='6958'>
                        end if<a name='6959'>
                     end do<a name='6960'>
                  endif<a name='6961'>
<font color=#447700>! <a name='6962'></font>
<font color=#447700>! If nxs eq 1, no need to sort. <a name='6963'></font>
<font color=#447700>! If nxs eq 2, sort by swapping if necessary<a name='6964'></font>
<font color=#447700>! If nxs ge 3, sort using local sort routine<a name='6965'></font>
<font color=#447700>! <a name='6966'></font>
                  if (nxs == 2) then<a name='6967'>
                     if (asort(2) &lt; asort(1)) then<a name='6968'>
                        ktmp = ksort(1)<a name='6969'>
                        ksort(1) = ksort(2)<a name='6970'>
                        ksort(2) = ktmp<a name='6971'>
<a name='6972'>
                        atmp = asort(1)<a name='6973'>
                        asort(1) = asort(2)<a name='6974'>
                        asort(2) = atmp<a name='6975'>
                     endif<a name='6976'>
                  else if (nxs &gt;= 3) then<a name='6977'>
                     call <A href='../../html_code/phys/module_ra_cam_support.F.html#SORTARRAY'>sortarray</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCSWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SORTARRAY_2">(nxs,asort,ksort)<a name='6978'>
                  endif<a name='6979'>
<font color=#447700>! <a name='6980'></font>
<font color=#447700>! Construct wstr, cstr, nstr for this region<a name='6981'></font>
<font color=#447700>! <a name='6982'></font>
                  cstr(k1:k2,1:nxs+1) = 0<a name='6983'>
                  mstr = 1<a name='6984'>
                  cld0 = 0.0_r8<a name='6985'>
                  do l = 1, nxs<a name='6986'>
                     if (asort(l) /= cld0) then<a name='6987'>
                        wstr(mstr,mrgn) = asort(l) - cld0<a name='6988'>
                        cld0 = asort(l)<a name='6989'>
                        mstr = mstr + 1<a name='6990'>
                     endif<a name='6991'>
                     cstr(ksort(l),mstr:nxs+1) = 1<a name='6992'>
                  end do<a name='6993'>
                  nstr(mrgn) = mstr<a name='6994'>
                  wstr(mstr,mrgn) = 1.0_r8 - cld0<a name='6995'>
<font color=#447700>! <a name='6996'></font>
<font color=#447700>! End test of region_found = true<a name='6997'></font>
<font color=#447700>! <a name='6998'></font>
               endif<a name='6999'>
<font color=#447700>! <a name='7000'></font>
<font color=#447700>! End loop over regions irgn for max-overlap<a name='7001'></font>
<font color=#447700>! <a name='7002'></font>
            end do<a name='7003'>
            nrgn = mrgn<a name='7004'>
<font color=#447700>! <a name='7005'></font>
<font color=#447700>! Finish construction of cstr for additional top layer<a name='7006'></font>
<font color=#447700>! <a name='7007'></font>
            cstr(0,1:nstr(1)) = 0<a name='7008'>
<font color=#447700>! <a name='7009'></font>
<font color=#447700>! INDEX COMPUTATIONS FOR STEP 2-3<a name='7010'></font>
<font color=#447700>! This section of the code generates the following information:<a name='7011'></font>
<font color=#447700>! (1. totwgt     step 3     total frac. area of configurations satisfying<a name='7012'></font>
<font color=#447700>! areamin &amp; nconfgmax criteria<a name='7013'></font>
<font color=#447700>! (2. wgtv       step 3     frac. area of configurations <a name='7014'></font>
<font color=#447700>! (3. ccon       step 2     binary flag for clouds in each configuration<a name='7015'></font>
<font color=#447700>! (4. nconfig    steps 2-3  number of configurations<a name='7016'></font>
<font color=#447700>! (5. nuniqu/d   step 2     Number of unique cloud configurations for<a name='7017'></font>
<font color=#447700>! up/downwelling rad. between surface/TOA<a name='7018'></font>
<font color=#447700>! and level k<a name='7019'></font>
<font color=#447700>! (6. istrtu/d   step 2     Indices into iconu/d<a name='7020'></font>
<font color=#447700>! (7. iconu/d    step 2     Cloud configurations which are identical<a name='7021'></font>
<font color=#447700>! for up/downwelling rad. between surface/TOA<a name='7022'></font>
<font color=#447700>! and level k<a name='7023'></font>
<font color=#447700>! <a name='7024'></font>
<font color=#447700>! Number of configurations (all permutations of streams in each region)<a name='7025'></font>
<font color=#447700>! <a name='7026'></font>
            nconfigm = product(nstr(1: nrgn))<a name='7027'>
<font color=#447700>! <a name='7028'></font>
<font color=#447700>! Construction of totwgt, wgtv, ccon, nconfig<a name='7029'></font>
<font color=#447700>! <a name='7030'></font>
            istr(1: nrgn) = 1<a name='7031'>
            nconfig = 0<a name='7032'>
            totwgt = 0.0_r8<a name='7033'>
            new_term = .true.<a name='7034'>
            do iconfig = 1, nconfigm<a name='7035'>
               xwgt = 1.0_r8<a name='7036'>
               do mrgn = 1,  nrgn<a name='7037'>
                  xwgt = xwgt * wstr(istr(mrgn),mrgn)<a name='7038'>
               end do<a name='7039'>
               if (xwgt &gt;= areamin) then<a name='7040'>
                  nconfig = nconfig + 1<a name='7041'>
                  if (nconfig &lt;= nconfgmax) then<a name='7042'>
                     j = nconfig<a name='7043'>
                     ptrc(nconfig) = nconfig<a name='7044'>
                  else<a name='7045'>
                     nconfig = nconfgmax<a name='7046'>
                     if (new_term) then<a name='7047'>
                        j = <A href='../../html_code/phys/module_ra_cam_support.F.html#FINDVALUE'>findvalue</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCSWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FINDVALUE_1">(1,nconfig,wgtv,ptrc)<a name='7048'>
                     endif<a name='7049'>
                     if (wgtv(j) &lt; xwgt) then<a name='7050'>
                        totwgt = totwgt - wgtv(j)<a name='7051'>
                        new_term = .true.<a name='7052'>
                     else<a name='7053'>
                        new_term = .false.<a name='7054'>
                     endif<a name='7055'>
                  endif<a name='7056'>
                  if (new_term) then<a name='7057'>
                     wgtv(j) = xwgt<a name='7058'>
                     totwgt = totwgt + xwgt<a name='7059'>
                     do mrgn = 1, nrgn<a name='7060'>
                        ccon(kx1(mrgn):kx2(mrgn),j) = cstr(kx1(mrgn):kx2(mrgn),istr(mrgn))<a name='7061'>
                     end do<a name='7062'>
                  endif<a name='7063'>
               endif<a name='7064'>
<a name='7065'>
               mrgn =  nrgn<a name='7066'>
               istr(mrgn) = istr(mrgn) + 1<a name='7067'>
               do while (istr(mrgn) &gt; nstr(mrgn) .and. mrgn &gt; 1)<a name='7068'>
                  istr(mrgn) = 1<a name='7069'>
                  mrgn = mrgn - 1<a name='7070'>
                  istr(mrgn) = istr(mrgn) + 1<a name='7071'>
               end do<a name='7072'>
<font color=#447700>! <a name='7073'></font>
<font color=#447700>! End do iconfig = 1, nconfigm<a name='7074'></font>
<font color=#447700>! <a name='7075'></font>
            end do<a name='7076'>
<font color=#447700>! <a name='7077'></font>
<font color=#447700>! If totwgt = 0 implement maximum overlap and make another pass<a name='7078'></font>
<font color=#447700>! if totwgt = 0 on this second pass then terminate.<a name='7079'></font>
<font color=#447700>! <a name='7080'></font>
            if (totwgt &gt; 0.) then<a name='7081'>
               exit<a name='7082'>
            else<a name='7083'>
               npasses = npasses + 1<a name='7084'>
               if (npasses &gt;= 2 ) then<a name='7085'>
                  write(6,*)'RADCSWMX: Maximum overlap of column ','failed'<a name='7086'>
                  call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_ra_cam.F.html#RADCSWMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_31"><a name='7087'>
               endif<a name='7088'>
               nmxrgn(i)=1<a name='7089'>
               pmxrgn(i,1)=1.0e30<a name='7090'>
            end if<a name='7091'>
<font color=#447700>!<a name='7092'></font>
<font color=#447700>! End npasses = 0, do<a name='7093'></font>
<font color=#447700>!<a name='7094'></font>
         end do<a name='7095'>
<font color=#447700>! <a name='7096'></font>
<font color=#447700>! <a name='7097'></font>
<font color=#447700>! Finish construction of ccon<a name='7098'></font>
<font color=#447700>! <a name='7099'></font>
         ccon(0,:) = 0<a name='7100'>
         ccon(pverp,:) = 0<a name='7101'>
<font color=#447700>! <a name='7102'></font>
<font color=#447700>! Construction of nuniqu/d, istrtu/d, iconu/d using binary tree <a name='7103'></font>
<font color=#447700>! <a name='7104'></font>
         nuniqd(0) = 1<a name='7105'>
         nuniqu(pverp) = 1<a name='7106'>
<a name='7107'>
         istrtd(0,1) = 1<a name='7108'>
         istrtu(pverp,1) = 1<a name='7109'>
<a name='7110'>
         do j = 1, nconfig<a name='7111'>
            icond(0,j)=j<a name='7112'>
            iconu(pverp,j)=j<a name='7113'>
         end do<a name='7114'>
<a name='7115'>
         istrtd(0,2) = nconfig+1<a name='7116'>
         istrtu(pverp,2) = nconfig+1<a name='7117'>
<a name='7118'>
         do k = 1, pverp<a name='7119'>
            km1 = k-1<a name='7120'>
            nuniq = 0<a name='7121'>
            istrtd(k,1) = 1<a name='7122'>
            do l0 = 1, nuniqd(km1)<a name='7123'>
               is0 = istrtd(km1,l0)<a name='7124'>
               is1 = istrtd(km1,l0+1)-1<a name='7125'>
               n0 = 0<a name='7126'>
               n1 = 0<a name='7127'>
               do isn = is0, is1<a name='7128'>
                  j = icond(km1,isn)<a name='7129'>
                  if (ccon(k,j) == 0) then<a name='7130'>
                     n0 = n0 + 1<a name='7131'>
                     ptr0(n0) = j<a name='7132'>
                  endif<a name='7133'>
                  if (ccon(k,j) == 1) then<a name='7134'>
                     n1 = n1 + 1<a name='7135'>
                     ptr1(n1) = j<a name='7136'>
                  endif<a name='7137'>
               end do<a name='7138'>
               if (n0 &gt; 0) then<a name='7139'>
                  nuniq = nuniq + 1<a name='7140'>
                  istrtd(k,nuniq+1) = istrtd(k,nuniq)+n0<a name='7141'>
                  icond(k,istrtd(k,nuniq):istrtd(k,nuniq+1)-1) =  ptr0(1:n0)<a name='7142'>
               endif<a name='7143'>
               if (n1 &gt; 0) then<a name='7144'>
                  nuniq = nuniq + 1<a name='7145'>
                  istrtd(k,nuniq+1) = istrtd(k,nuniq)+n1<a name='7146'>
                  icond(k,istrtd(k,nuniq):istrtd(k,nuniq+1)-1) =  ptr1(1:n1)<a name='7147'>
               endif<a name='7148'>
            end do<a name='7149'>
            nuniqd(k) = nuniq<a name='7150'>
         end do<a name='7151'>
<a name='7152'>
         do k = pver, 0, -1<a name='7153'>
            kp1 = k+1<a name='7154'>
            nuniq = 0<a name='7155'>
            istrtu(k,1) = 1<a name='7156'>
            do l0 = 1, nuniqu(kp1)<a name='7157'>
               is0 = istrtu(kp1,l0)<a name='7158'>
               is1 = istrtu(kp1,l0+1)-1<a name='7159'>
               n0 = 0<a name='7160'>
               n1 = 0<a name='7161'>
               do isn = is0, is1<a name='7162'>
                  j = iconu(kp1,isn)<a name='7163'>
                  if (ccon(k,j) == 0) then<a name='7164'>
                     n0 = n0 + 1<a name='7165'>
                     ptr0(n0) = j<a name='7166'>
                  endif<a name='7167'>
                  if (ccon(k,j) == 1) then<a name='7168'>
                     n1 = n1 + 1<a name='7169'>
                     ptr1(n1) = j<a name='7170'>
                  endif<a name='7171'>
               end do<a name='7172'>
               if (n0 &gt; 0) then<a name='7173'>
                  nuniq = nuniq + 1<a name='7174'>
                  istrtu(k,nuniq+1) = istrtu(k,nuniq)+n0<a name='7175'>
                  iconu(k,istrtu(k,nuniq):istrtu(k,nuniq+1)-1) =  ptr0(1:n0)<a name='7176'>
               endif<a name='7177'>
               if (n1 &gt; 0) then<a name='7178'>
                  nuniq = nuniq + 1<a name='7179'>
                  istrtu(k,nuniq+1) = istrtu(k,nuniq)+n1<a name='7180'>
                  iconu(k,istrtu(k,nuniq):istrtu(k,nuniq+1)-1) = ptr1(1:n1)<a name='7181'>
               endif<a name='7182'>
            end do<a name='7183'>
            nuniqu(k) = nuniq<a name='7184'>
         end do<a name='7185'>
<font color=#447700>! <a name='7186'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='7187'></font>
<font color=#447700>! End of index calculations<a name='7188'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='7189'></font>
<a name='7190'>
<a name='7191'>
<font color=#447700>!----------------------------------------------------------------------<a name='7192'></font>
<font color=#447700>! Start of flux calculations<a name='7193'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='7194'></font>
<font color=#447700>! <a name='7195'></font>
<font color=#447700>! Initialize spectrally integrated totals:<a name='7196'></font>
<font color=#447700>! <a name='7197'></font>
         do k=0,pver<a name='7198'>
            totfld(k) = 0.0_r8<a name='7199'>
            fswup (k) = 0.0_r8<a name='7200'>
            fswdn (k) = 0.0_r8<a name='7201'>
            fswupc (k) = 0.0_r8<a name='7202'>
            fswdnc (k) = 0.0_r8<a name='7203'>
            fswdndir(k) = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7204'></font>
            fswdncdir(k)= 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7205'></font>
         end do<a name='7206'>
<a name='7207'>
         sfltot        = 0.0_r8<a name='7208'>
         fswup (pverp) = 0.0_r8<a name='7209'>
         fswdn (pverp) = 0.0_r8<a name='7210'>
         fswupc (pverp) = 0.0_r8<a name='7211'>
         fswdnc (pverp) = 0.0_r8<a name='7212'>
         fswdndir(pverp) = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7213'></font>
         fswdncdir(pverp)= 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7214'></font>
<a name='7215'>
<font color=#447700>! <a name='7216'></font>
<font color=#447700>! Start spectral interval<a name='7217'></font>
<font color=#447700>! <a name='7218'></font>
         do ns = 1,nspint<a name='7219'>
            wgtint = nirwgt(ns)<a name='7220'>
<font color=#447700>!----------------------------------------------------------------------<a name='7221'></font>
<font color=#447700>! STEP 2<a name='7222'></font>
<font color=#447700>! <a name='7223'></font>
<font color=#447700>! <a name='7224'></font>
<font color=#447700>! Apply adding method to solve for radiative properties<a name='7225'></font>
<font color=#447700>! <a name='7226'></font>
<font color=#447700>! First initialize the bulk properties at TOA<a name='7227'></font>
<font color=#447700>! <a name='7228'></font>
            rdndif(0,1:nconfig) = 0.0_r8<a name='7229'>
            exptdn(0,1:nconfig) = 1.0_r8<a name='7230'>
            tdntot(0,1:nconfig) = 1.0_r8<a name='7231'>
<font color=#447700>! <a name='7232'></font>
<font color=#447700>! Solve for properties involving downward propagation of radiation.<a name='7233'></font>
<font color=#447700>! The bulk properties are:<a name='7234'></font>
<font color=#447700>! <a name='7235'></font>
<font color=#447700>! (1. exptdn   Sol. beam dwn. trans from layers above<a name='7236'></font>
<font color=#447700>! (2. rdndif   Ref to dif rad for layers above<a name='7237'></font>
<font color=#447700>! (3. tdntot   Total trans for layers above<a name='7238'></font>
<font color=#447700>! <a name='7239'></font>
            do k = 1, pverp<a name='7240'>
               km1 = k - 1<a name='7241'>
               do l0 = 1, nuniqd(km1)<a name='7242'>
                  is0 = istrtd(km1,l0)<a name='7243'>
                  is1 = istrtd(km1,l0+1)-1<a name='7244'>
<a name='7245'>
                  j = icond(km1,is0)<a name='7246'>
<a name='7247'>
                  xexpt   = exptdn(km1,j)<a name='7248'>
                  xrdnd   = rdndif(km1,j)<a name='7249'>
                  tdnmexp = tdntot(km1,j) - xexpt<a name='7250'>
<a name='7251'>
                  if (ccon(km1,j) == 1) then<a name='7252'>
<font color=#447700>! <a name='7253'></font>
<font color=#447700>! If cloud in layer, use cloudy layer radiative properties<a name='7254'></font>
<font color=#447700>! <a name='7255'></font>
                     ytdnd = tdif(ns,i,km1)<a name='7256'>
                     yrdnd = rdif(ns,i,km1)<a name='7257'>
<a name='7258'>
                     rdenom  = 1._r8/(1._r8-yrdnd*xrdnd)<a name='7259'>
                     rdirexp = rdir(ns,i,km1)*xexpt<a name='7260'>
<a name='7261'>
                     zexpt = xexpt * explay(ns,i,km1)<a name='7262'>
                     zrdnd = yrdnd + xrdnd*(ytdnd**2)*rdenom<a name='7263'>
                     ztdnt = xexpt*tdir(ns,i,km1) + ytdnd*(tdnmexp + xrdnd*rdirexp)*rdenom<a name='7264'>
                  else<a name='7265'>
<font color=#447700>! <a name='7266'></font>
<font color=#447700>! If clear layer, use clear-sky layer radiative properties<a name='7267'></font>
<font color=#447700>! <a name='7268'></font>
                     ytdnd = tdifc(ns,i,km1)<a name='7269'>
                     yrdnd = rdifc(ns,i,km1)<a name='7270'>
<a name='7271'>
                     rdenom  = 1._r8/(1._r8-yrdnd*xrdnd)<a name='7272'>
                     rdirexp = rdirc(ns,i,km1)*xexpt<a name='7273'>
<a name='7274'>
                     zexpt = xexpt * explayc(ns,i,km1)<a name='7275'>
                     zrdnd = yrdnd + xrdnd*(ytdnd**2)*rdenom<a name='7276'>
                     ztdnt = xexpt*tdirc(ns,i,km1) + ytdnd* &amp;<a name='7277'>
                                            (tdnmexp + xrdnd*rdirexp)*rdenom<a name='7278'>
                  endif<a name='7279'>
<a name='7280'>
<font color=#447700>! <a name='7281'></font>
<font color=#447700>! If 2 or more configurations share identical properties at a given level k,<a name='7282'></font>
<font color=#447700>! the properties (at level k) are computed once and copied to <a name='7283'></font>
<font color=#447700>! all the configurations for efficiency.<a name='7284'></font>
<font color=#447700>! <a name='7285'></font>
                  do isn = is0, is1<a name='7286'>
                     j = icond(km1,isn)<a name='7287'>
                     exptdn(k,j) = zexpt<a name='7288'>
                     rdndif(k,j) = zrdnd<a name='7289'>
                     tdntot(k,j) = ztdnt<a name='7290'>
                  end do<a name='7291'>
<font color=#447700>! <a name='7292'></font>
<font color=#447700>! end do l0 = 1, nuniqd(k)<a name='7293'></font>
<font color=#447700>! <a name='7294'></font>
               end do<a name='7295'>
<font color=#447700>! <a name='7296'></font>
<font color=#447700>! end do k = 1, pverp<a name='7297'></font>
<font color=#447700>! <a name='7298'></font>
            end do<a name='7299'>
<font color=#447700>! <a name='7300'></font>
<font color=#447700>! Solve for properties involving upward propagation of radiation.<a name='7301'></font>
<font color=#447700>! The bulk properties are:<a name='7302'></font>
<font color=#447700>! <a name='7303'></font>
<font color=#447700>! (1. rupdif   Ref to dif rad for layers below<a name='7304'></font>
<font color=#447700>! (2. rupdir   Ref to dir rad for layers below<a name='7305'></font>
<font color=#447700>! <a name='7306'></font>
<font color=#447700>! Specify surface boundary conditions (surface albedos)<a name='7307'></font>
<font color=#447700>! <a name='7308'></font>
            rupdir(pverp,1:nconfig) = albdir(i,ns)<a name='7309'>
            rupdif(pverp,1:nconfig) = albdif(i,ns)<a name='7310'>
<a name='7311'>
            do k = pver, 0, -1<a name='7312'>
               do l0 = 1, nuniqu(k)<a name='7313'>
                  is0 = istrtu(k,l0)<a name='7314'>
                  is1 = istrtu(k,l0+1)-1<a name='7315'>
<a name='7316'>
                  j = iconu(k,is0)<a name='7317'>
<a name='7318'>
                  xrupd = rupdif(k+1,j)<a name='7319'>
                  xrups = rupdir(k+1,j)<a name='7320'>
<a name='7321'>
                  if (ccon(k,j) == 1) then<a name='7322'>
<font color=#447700>! <a name='7323'></font>
<font color=#447700>! If cloud in layer, use cloudy layer radiative properties<a name='7324'></font>
<font color=#447700>! <a name='7325'></font>
                     yexpt = explay(ns,i,k)<a name='7326'>
                     yrupd = rdif(ns,i,k)<a name='7327'>
                     ytupd = tdif(ns,i,k)<a name='7328'>
<a name='7329'>
                     rdenom  = 1._r8/( 1._r8 - yrupd*xrupd)<a name='7330'>
                     tdnmexp = (tdir(ns,i,k)-yexpt)<a name='7331'>
                     rdirexp = xrups*yexpt<a name='7332'>
<a name='7333'>
                     zrupd = yrupd + xrupd*(ytupd**2)*rdenom<a name='7334'>
                     zrups = rdir(ns,i,k) + ytupd*(rdirexp + xrupd*tdnmexp)*rdenom<a name='7335'>
                  else<a name='7336'>
<font color=#447700>! <a name='7337'></font>
<font color=#447700>! If clear layer, use clear-sky layer radiative properties<a name='7338'></font>
<font color=#447700>! <a name='7339'></font>
                     yexpt = explayc(ns,i,k)<a name='7340'>
                     yrupd = rdifc(ns,i,k)<a name='7341'>
                     ytupd = tdifc(ns,i,k)<a name='7342'>
<a name='7343'>
                     rdenom  = 1._r8/( 1._r8 - yrupd*xrupd)<a name='7344'>
                     tdnmexp = (tdirc(ns,i,k)-yexpt)<a name='7345'>
                     rdirexp = xrups*yexpt<a name='7346'>
<a name='7347'>
                     zrupd = yrupd + xrupd*(ytupd**2)*rdenom<a name='7348'>
                     zrups = rdirc(ns,i,k) + ytupd*(rdirexp + xrupd*tdnmexp)*rdenom<a name='7349'>
                  endif<a name='7350'>
<a name='7351'>
<font color=#447700>! <a name='7352'></font>
<font color=#447700>! If 2 or more configurations share identical properties at a given level k,<a name='7353'></font>
<font color=#447700>! the properties (at level k) are computed once and copied to <a name='7354'></font>
<font color=#447700>! all the configurations for efficiency.<a name='7355'></font>
<font color=#447700>! <a name='7356'></font>
                  do isn = is0, is1<a name='7357'>
                     j = iconu(k,isn)<a name='7358'>
                     rupdif(k,j) = zrupd<a name='7359'>
                     rupdir(k,j) = zrups<a name='7360'>
                  end do<a name='7361'>
<font color=#447700>! <a name='7362'></font>
<font color=#447700>! end do l0 = 1, nuniqu(k)<a name='7363'></font>
<font color=#447700>! <a name='7364'></font>
               end do<a name='7365'>
<font color=#447700>! <a name='7366'></font>
<font color=#447700>! end do k = pver,0,-1<a name='7367'></font>
<font color=#447700>! <a name='7368'></font>
            end do<a name='7369'>
<font color=#447700>! <a name='7370'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='7371'></font>
<font color=#447700>! <a name='7372'></font>
<font color=#447700>! STEP 3<a name='7373'></font>
<font color=#447700>! <a name='7374'></font>
<font color=#447700>! Compute up and down fluxes for each interface k.  This requires<a name='7375'></font>
<font color=#447700>! adding up the contributions from all possible permutations<a name='7376'></font>
<font color=#447700>! of streams in all max-overlap regions, weighted by the<a name='7377'></font>
<font color=#447700>! product of the fractional areas of the streams in each region<a name='7378'></font>
<font color=#447700>! (the random overlap assumption).  The adding principle has been<a name='7379'></font>
<font color=#447700>! used in step 2 to combine the bulk radiative properties <a name='7380'></font>
<font color=#447700>! above and below the interface.<a name='7381'></font>
<font color=#447700>! <a name='7382'></font>
            do k = 0,pverp<a name='7383'>
<font color=#447700>! <a name='7384'></font>
<font color=#447700>! Initialize the fluxes<a name='7385'></font>
<font color=#447700>! <a name='7386'></font>
               fluxup(k)=0.0_r8<a name='7387'>
               fluxdn(k)=0.0_r8<a name='7388'>
               fluxdndir(k) = 0.0_r8 <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7389'></font>
<a name='7390'>
               do iconfig = 1, nconfig<a name='7391'>
                  xwgt = wgtv(iconfig)<a name='7392'>
                  xexpt = exptdn(k,iconfig)<a name='7393'>
                  xtdnt = tdntot(k,iconfig)<a name='7394'>
                  xrdnd = rdndif(k,iconfig)<a name='7395'>
                  xrupd = rupdif(k,iconfig)<a name='7396'>
                  xrups = rupdir(k,iconfig)<a name='7397'>
<font color=#447700>! <a name='7398'></font>
<font color=#447700>! Flux computation<a name='7399'></font>
<font color=#447700>! <a name='7400'></font>
                  rdenom = 1._r8/(1._r8 - xrdnd * xrupd)<a name='7401'>
<a name='7402'>
                  fluxup(k) = fluxup(k) + xwgt *  &amp;<a name='7403'>
                              ((xexpt * xrups + (xtdnt - xexpt) * xrupd) * rdenom)<a name='7404'>
                  fluxdn(k) = fluxdn(k) + xwgt *  &amp;<a name='7405'>
                              (xexpt + (xtdnt - xexpt + xexpt * xrups * xrdnd) * rdenom)<a name='7406'>
                  fluxdndir(k) = fluxdndir(k) + xwgt * xexpt <font color=#447700>! Beer's Law amontornes-bcodina (2014-04-20)<a name='7407'></font>
                  <a name='7408'>
<font color=#447700>! <a name='7409'></font>
<font color=#447700>! End do iconfig = 1, nconfig<a name='7410'></font>
<font color=#447700>! <a name='7411'></font>
               end do<a name='7412'>
<font color=#447700>! <a name='7413'></font>
<font color=#447700>! Normalize by total area covered by cloud configurations included<a name='7414'></font>
<font color=#447700>! in solution<a name='7415'></font>
<font color=#447700>! <a name='7416'></font>
               fluxup(k)=fluxup(k) / totwgt<a name='7417'>
               fluxdn(k)=fluxdn(k) / totwgt           <a name='7418'>
               fluxdndir(k)=fluxdndir(k) / totwgt    <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7419'></font>
<font color=#447700>! <a name='7420'></font>
<font color=#447700>! End do k = 0,pverp<a name='7421'></font>
<font color=#447700>! <a name='7422'></font>
            end do<a name='7423'>
<font color=#447700>! <a name='7424'></font>
<font color=#447700>! Initialize the direct-beam flux at surface<a name='7425'></font>
<font color=#447700>! <a name='7426'></font>
            wexptdn = 0.0_r8<a name='7427'>
<a name='7428'>
            do iconfig = 1, nconfig<a name='7429'>
               wexptdn =  wexptdn + wgtv(iconfig) * exptdn(pverp,iconfig)<a name='7430'>
            end do<a name='7431'>
<a name='7432'>
            wexptdn = wexptdn / totwgt<a name='7433'>
<font color=#447700>! <a name='7434'></font>
<font color=#447700>! Monochromatic computation completed; accumulate in totals<a name='7435'></font>
<font color=#447700>! <a name='7436'></font>
            solflx   = solin(i)*frcsol(ns)*psf(ns)<a name='7437'>
            fsnt(i)  = fsnt(i) + solflx*(fluxdn(1) - fluxup(1))<a name='7438'>
            fsntoa(i)= fsntoa(i) + solflx*(fluxdn(0) - fluxup(0))<a name='7439'>
            fsns(i)  = fsns(i) + solflx*(fluxdn(pverp)-fluxup(pverp))<a name='7440'>
            sfltot   = sfltot + solflx<a name='7441'>
            fswup(0) = fswup(0) + solflx*fluxup(0)<a name='7442'>
            fswdn(0) = fswdn(0) + solflx*fluxdn(0)<a name='7443'>
            fswdndir(0) = fswdndir(0) + solflx*fluxdndir(0)  <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7444'></font>
<font color=#447700>! <a name='7445'></font>
<font color=#447700>! Down spectral fluxes need to be in mks; thus the .001 conversion factors<a name='7446'></font>
<font color=#447700>! <a name='7447'></font>
            if (wavmid(ns) &lt; 0.7_r8) then<a name='7448'>
               sols(i)  = sols(i) + wexptdn*solflx*0.001_r8<a name='7449'>
               solsd(i) = solsd(i)+(fluxdn(pverp)-wexptdn)*solflx*0.001_r8<a name='7450'>
            else<a name='7451'>
               soll(i)  = soll(i) + wexptdn*solflx*0.001_r8<a name='7452'>
               solld(i) = solld(i)+(fluxdn(pverp)-wexptdn)*solflx*0.001_r8<a name='7453'>
               fsnrtoaq(i) = fsnrtoaq(i) + solflx*(fluxdn(0) - fluxup(0))<a name='7454'>
            end if<a name='7455'>
            fsnirtoa(i) = fsnirtoa(i) + wgtint*solflx*(fluxdn(0) - fluxup(0))<a name='7456'>
<a name='7457'>
            do k=0,pver<a name='7458'>
<font color=#447700>! <a name='7459'></font>
<font color=#447700>! Compute flux divergence in each layer using the interface up and down<a name='7460'></font>
<font color=#447700>! fluxes:<a name='7461'></font>
<font color=#447700>! <a name='7462'></font>
               kp1 = k+1<a name='7463'>
               flxdiv = (fluxdn(k  ) - fluxdn(kp1)) + (fluxup(kp1) - fluxup(k  ))<a name='7464'>
               totfld(k)  = totfld(k)  + solflx*flxdiv<a name='7465'>
               fswdn(kp1) = fswdn(kp1) + solflx*fluxdn(kp1)<a name='7466'>
               fswup(kp1) = fswup(kp1) + solflx*fluxup(kp1)<a name='7467'>
               fswdndir(kp1) = fswdndir(kp1) + solflx*fluxdndir(kp1)  <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7468'></font>
            end do<a name='7469'>
<font color=#447700>! <a name='7470'></font>
<font color=#447700>! Perform clear-sky calculation<a name='7471'></font>
<font color=#447700>! <a name='7472'></font>
            exptdnc(0) =   1.0_r8<a name='7473'>
            rdndifc(0) =   0.0_r8<a name='7474'>
            tdntotc(0) =   1.0_r8<a name='7475'>
            rupdirc(pverp) = albdir(i,ns)<a name='7476'>
            rupdifc(pverp) = albdif(i,ns)<a name='7477'>
<a name='7478'>
            do k = 1, pverp<a name='7479'>
               km1 = k - 1<a name='7480'>
               xexpt = exptdnc(km1)<a name='7481'>
               xrdnd = rdndifc(km1)<a name='7482'>
               yrdnd = rdifc(ns,i,km1)<a name='7483'>
               ytdnd = tdifc(ns,i,km1)<a name='7484'>
<a name='7485'>
               exptdnc(k) = xexpt*explayc(ns,i,km1)<a name='7486'>
<a name='7487'>
               rdenom  = 1._r8/(1._r8 - yrdnd*xrdnd)<a name='7488'>
               rdirexp = rdirc(ns,i,km1)*xexpt<a name='7489'>
               tdnmexp = tdntotc(km1) - xexpt<a name='7490'>
<a name='7491'>
               tdntotc(k) = xexpt*tdirc(ns,i,km1) + ytdnd*(tdnmexp + xrdnd*rdirexp)* &amp;<a name='7492'>
                                rdenom<a name='7493'>
               rdndifc(k) = yrdnd + xrdnd*(ytdnd**2)*rdenom<a name='7494'>
            end do<a name='7495'>
<a name='7496'>
            do k=pver,0,-1<a name='7497'>
               xrupd = rupdifc(k+1)<a name='7498'>
               yexpt = explayc(ns,i,k)<a name='7499'>
               yrupd = rdifc(ns,i,k)<a name='7500'>
               ytupd = tdifc(ns,i,k)<a name='7501'>
<a name='7502'>
               rdenom = 1._r8/( 1._r8 - yrupd*xrupd)<a name='7503'>
<a name='7504'>
               rupdirc(k) = rdirc(ns,i,k) + ytupd*(rupdirc(k+1)*yexpt + &amp;<a name='7505'>
                            xrupd*(tdirc(ns,i,k)-yexpt))*rdenom<a name='7506'>
               rupdifc(k) = yrupd + xrupd*ytupd**2*rdenom<a name='7507'>
            end do<a name='7508'>
<a name='7509'>
            do k=0,1<a name='7510'>
               rdenom    = 1._r8/(1._r8 - rdndifc(k)*rupdifc(k))<a name='7511'>
               fluxup(k) = (exptdnc(k)*rupdirc(k) + (tdntotc(k)-exptdnc(k))*rupdifc(k))* &amp;<a name='7512'>
                           rdenom<a name='7513'>
               fluxdn(k) = exptdnc(k) + &amp;<a name='7514'>
                           (tdntotc(k) - exptdnc(k) + exptdnc(k)*rupdirc(k)*rdndifc(k))* &amp;<a name='7515'>
                           rdenom<a name='7516'>
               fswupc(k) = fswupc(k) + solflx*fluxup(k)<a name='7517'>
               fswdnc(k) = fswdnc(k) + solflx*fluxdn(k)<a name='7518'>
               fswdncdir(k) = fswdncdir(k) + solflx*exptdnc(k) <font color=#447700>! Beer's Law amontornes-bcodina (2014-04-20)<a name='7519'></font>
            end do<a name='7520'>
<font color=#447700>!           k = pverp<a name='7521'></font>
            do k=2,pverp<a name='7522'>
            rdenom      = 1._r8/(1._r8 - rdndifc(k)*rupdifc(k))<a name='7523'>
            fluxup(k)   = (exptdnc(k)*rupdirc(k) + (tdntotc(k)-exptdnc(k))*rupdifc(k))* &amp;<a name='7524'>
                           rdenom<a name='7525'>
            fluxdn(k)   = exptdnc(k) + (tdntotc(k) - exptdnc(k) + &amp;<a name='7526'>
                          exptdnc(k)*rupdirc(k)*rdndifc(k))*rdenom<a name='7527'>
            fswupc(k)   = fswupc(k) + solflx*fluxup(k)<a name='7528'>
            fswdnc(k)   = fswdnc(k) + solflx*fluxdn(k)<a name='7529'>
            fswdncdir(k) = fswdncdir(k) + solflx*exptdnc(k) <font color=#447700>! Beer's Law amontornes-bcodina (2014-04-20)<a name='7530'></font>
            end do<a name='7531'>
<a name='7532'>
            fsntc(i)    = fsntc(i)+solflx*(fluxdn(1)-fluxup(1))<a name='7533'>
            fsntoac(i)  = fsntoac(i)+solflx*(fluxdn(0)-fluxup(0))<a name='7534'>
            fsnsc(i)    = fsnsc(i)+solflx*(fluxdn(pverp)-fluxup(pverp))<a name='7535'>
            fsdsc(i)    = fsdsc(i)+solflx*(fluxdn(pverp))<a name='7536'>
            fsnrtoac(i) = fsnrtoac(i)+wgtint*solflx*(fluxdn(0)-fluxup(0))<a name='7537'>
<font color=#447700>! <a name='7538'></font>
<font color=#447700>! End of clear sky calculation<a name='7539'></font>
<font color=#447700>! <a name='7540'></font>
<a name='7541'>
<font color=#447700>! <a name='7542'></font>
<font color=#447700>! End of spectral interval loop<a name='7543'></font>
<font color=#447700>! <a name='7544'></font>
         end do<a name='7545'>
<font color=#447700>! <a name='7546'></font>
<font color=#447700>! Compute solar heating rate (J/kg/s)<a name='7547'></font>
<font color=#447700>! <a name='7548'></font>
         do k=1,pver<a name='7549'>
            qrs(i,k) = -1.E-4*gravit*totfld(k)/(pint(i,k) - pint(i,k+1))<a name='7550'>
         end do<a name='7551'>
<a name='7552'>
<font color=#447700>! Added downward/upward total and clear sky fluxes<a name='7553'></font>
<a name='7554'>
         do k=1,pverp<a name='7555'>
            fsup(i,k)  = fswup(k)<a name='7556'>
            fsupc(i,k) = fswupc(k)<a name='7557'>
            fsdn(i,k)  = fswdn(k)<a name='7558'>
            fsdnc(i,k) = fswdnc(k)<a name='7559'>
            fsdndir(i,k)  = fswdndir(k)            <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7560'></font>
            fsdncdir(i,k) = fswdncdir(k)           <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7561'></font>
            fsdndif(i,k)  = fswdn(k)-fswdndir(k)   <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7562'></font>
            fsdncdif(i,k) = fswdnc(k)-fswdncdir(k) <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7563'></font>
         end do<a name='7564'>
<a name='7565'>
<font color=#447700>! <a name='7566'></font>
<font color=#447700>! Set the downwelling flux at the surface <a name='7567'></font>
<font color=#447700>! <a name='7568'></font>
         fsds(i) = fswdn(pverp)<a name='7569'>
<font color=#447700>! amontornes-bcodina (2014-04-20) :: Save surface direct/difuse fluxes<a name='7570'></font>
      fsdscdir(i) = fsdncdir(i,pverp) <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7571'></font>
      fsdscdif(i) = fsdncdif(i,pverp) <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7572'></font>
      fsdsdir(i)  = fsdndir(i,pverp)  <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7573'></font>
      fsdsdif(i)  = fsdndif(i,pverp)  <font color=#447700>! amontornes-bcodina (2014-04-20)<a name='7574'></font>
<font color=#447700>! <a name='7575'></font>
<font color=#447700>! End do n=1,ndayc<a name='7576'></font>
<font color=#447700>! <a name='7577'></font>
   end do<a name='7578'>
<a name='7579'>
<font color=#447700>!  write (6, '(a, x, i3)') 'radcswmx : exiting, chunk identifier', lchnk<a name='7580'></font>
<a name='7581'>
   return<a name='7582'>
end subroutine radcswmx<a name='7583'>
<a name='7584'>
<A NAME='RADDEDMX'><A href='../../html_code/phys/module_ra_cam.F.html#RADDEDMX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7585'>
<font color=#993300>subroutine </font><font color=#cc0000>raddedmx</font>(pver, pverp, pcols, coszrs  ,ndayc   ,idayc   ,abh2o   , &amp; <A href='../../call_to/RADDEDMX.html' TARGET='index'>1</A>,<A href='../../call_from/RADDEDMX.html' TARGET='index'>2</A><a name='7586'>
                    abo3    ,abco2   ,abo2    ,uh2o    ,uo3     , &amp;<a name='7587'>
                    uco2    ,uo2     ,trayoslp,pflx    ,ns      , &amp;<a name='7588'>
                    tauxcl  ,wcl     ,gcl     ,fcl     ,tauxci  , &amp;<a name='7589'>
                    wci     ,gci     ,fci     ,tauxar  ,wa      , &amp;<a name='7590'>
                    ga      ,fa      ,rdir    ,rdif    ,tdir    , &amp;<a name='7591'>
                    tdif    ,explay  ,rdirc   ,rdifc   ,tdirc   , &amp;<a name='7592'>
                    tdifc   ,explayc )<a name='7593'>
<font color=#447700>!----------------------------------------------------------------------- <a name='7594'></font>
<font color=#447700>! <a name='7595'></font>
<font color=#447700>! Purpose: <a name='7596'></font>
<font color=#447700>! Computes layer reflectivities and transmissivities, from the top down<a name='7597'></font>
<font color=#447700>! to the surface using the delta-Eddington solutions for each layer<a name='7598'></font>
<font color=#447700>! <a name='7599'></font>
<font color=#447700>! Method: <a name='7600'></font>
<font color=#447700>! For more details , see Briegleb, Bruce P., 1992: Delta-Eddington<a name='7601'></font>
<font color=#447700>! Approximation for Solar Radiation in the NCAR Community Climate Model,<a name='7602'></font>
<font color=#447700>! Journal of Geophysical Research, Vol 97, D7, pp7603-7612).<a name='7603'></font>
<font color=#447700>!<a name='7604'></font>
<font color=#447700>! Modified for maximum/random cloud overlap by Bill Collins and John<a name='7605'></font>
<font color=#447700>!    Truesdale<a name='7606'></font>
<font color=#447700>! <a name='7607'></font>
<font color=#447700>! Author: Bill Collins<a name='7608'></font>
<font color=#447700>! <a name='7609'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7610'></font>
<font color=#447700>!  use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='7611'></font>
<font color=#447700>!  use ppgrid<a name='7612'></font>
<a name='7613'>
   implicit none<a name='7614'>
<a name='7615'>
   integer nspint           <font color=#447700>! Num of spctrl intervals across solar spectrum<a name='7616'></font>
<a name='7617'>
   parameter ( nspint = 19 )<a name='7618'>
<font color=#447700>!<a name='7619'></font>
<font color=#447700>! Minimum total transmission below which no layer computation are done:<a name='7620'></font>
<font color=#447700>!<a name='7621'></font>
   real(r8) trmin                <font color=#447700>! Minimum total transmission allowed<a name='7622'></font>
   real(r8) wray                 <font color=#447700>! Rayleigh single scatter albedo<a name='7623'></font>
   real(r8) gray                 <font color=#447700>! Rayleigh asymetry parameter<a name='7624'></font>
   real(r8) fray                 <font color=#447700>! Rayleigh forward scattered fraction<a name='7625'></font>
<a name='7626'>
   parameter (trmin = 1.e-3)<a name='7627'>
   parameter (wray = 0.999999)<a name='7628'>
   parameter (gray = 0.0)<a name='7629'>
   parameter (fray = 0.1)<a name='7630'>
<font color=#447700>!<a name='7631'></font>
<font color=#447700>!------------------------------Arguments--------------------------------<a name='7632'></font>
<font color=#447700>!<a name='7633'></font>
<font color=#447700>! Input arguments<a name='7634'></font>
<font color=#447700>!<a name='7635'></font>
   integer, intent(in) :: pver, pverp, pcols<a name='7636'>
   real(r8), intent(in) :: coszrs(pcols)        <font color=#447700>! Cosine zenith angle<a name='7637'></font>
   real(r8), intent(in) :: trayoslp             <font color=#447700>! Tray/sslp<a name='7638'></font>
   real(r8), intent(in) :: pflx(pcols,0:pverp)  <font color=#447700>! Interface pressure<a name='7639'></font>
   real(r8), intent(in) :: abh2o                <font color=#447700>! Absorption coefficiant for h2o<a name='7640'></font>
   real(r8), intent(in) :: abo3                 <font color=#447700>! Absorption coefficiant for o3<a name='7641'></font>
   real(r8), intent(in) :: abco2                <font color=#447700>! Absorption coefficiant for co2<a name='7642'></font>
   real(r8), intent(in) :: abo2                 <font color=#447700>! Absorption coefficiant for o2<a name='7643'></font>
   real(r8), intent(in) :: uh2o(pcols,0:pver)   <font color=#447700>! Layer absorber amount of h2o<a name='7644'></font>
   real(r8), intent(in) :: uo3(pcols,0:pver)    <font color=#447700>! Layer absorber amount of  o3<a name='7645'></font>
   real(r8), intent(in) :: uco2(pcols,0:pver)   <font color=#447700>! Layer absorber amount of co2<a name='7646'></font>
   real(r8), intent(in) :: uo2(pcols,0:pver)    <font color=#447700>! Layer absorber amount of  o2<a name='7647'></font>
   real(r8), intent(in) :: tauxcl(pcols,0:pver) <font color=#447700>! Cloud extinction optical depth (liquid)<a name='7648'></font>
   real(r8), intent(in) :: wcl(pcols,0:pver)    <font color=#447700>! Cloud single scattering albedo (liquid)<a name='7649'></font>
   real(r8), intent(in) :: gcl(pcols,0:pver)    <font color=#447700>! Cloud asymmetry parameter (liquid)<a name='7650'></font>
   real(r8), intent(in) :: fcl(pcols,0:pver)    <font color=#447700>! Cloud forward scattered fraction (liquid)<a name='7651'></font>
   real(r8), intent(in) :: tauxci(pcols,0:pver) <font color=#447700>! Cloud extinction optical depth (ice)<a name='7652'></font>
   real(r8), intent(in) :: wci(pcols,0:pver)    <font color=#447700>! Cloud single scattering albedo (ice)<a name='7653'></font>
   real(r8), intent(in) :: gci(pcols,0:pver)    <font color=#447700>! Cloud asymmetry parameter (ice)<a name='7654'></font>
   real(r8), intent(in) :: fci(pcols,0:pver)    <font color=#447700>! Cloud forward scattered fraction (ice)<a name='7655'></font>
   real(r8), intent(in) :: tauxar(pcols,0:pver) <font color=#447700>! Aerosol extinction optical depth<a name='7656'></font>
   real(r8), intent(in) :: wa(pcols,0:pver)     <font color=#447700>! Aerosol single scattering albedo<a name='7657'></font>
   real(r8), intent(in) :: ga(pcols,0:pver)     <font color=#447700>! Aerosol asymmetry parameter<a name='7658'></font>
   real(r8), intent(in) :: fa(pcols,0:pver)     <font color=#447700>! Aerosol forward scattered fraction<a name='7659'></font>
<a name='7660'>
   integer, intent(in) :: ndayc                 <font color=#447700>! Number of daylight columns<a name='7661'></font>
   integer, intent(in) :: idayc(pcols)          <font color=#447700>! Daylight column indices<a name='7662'></font>
   integer, intent(in) :: ns                    <font color=#447700>! Index of spectral interval<a name='7663'></font>
<font color=#447700>!<a name='7664'></font>
<font color=#447700>! Input/Output arguments<a name='7665'></font>
<font color=#447700>!<a name='7666'></font>
<font color=#447700>! Following variables are defined for each layer; 0 refers to extra<a name='7667'></font>
<font color=#447700>! layer above top of model:<a name='7668'></font>
<font color=#447700>!<a name='7669'></font>
   real(r8), intent(inout) :: rdir(nspint,pcols,0:pver)   <font color=#447700>! Layer reflectivity to direct rad<a name='7670'></font>
   real(r8), intent(inout) :: rdif(nspint,pcols,0:pver)   <font color=#447700>! Layer reflectivity to diffuse rad<a name='7671'></font>
   real(r8), intent(inout) :: tdir(nspint,pcols,0:pver)   <font color=#447700>! Layer transmission to direct rad<a name='7672'></font>
   real(r8), intent(inout) :: tdif(nspint,pcols,0:pver)   <font color=#447700>! Layer transmission to diffuse rad<a name='7673'></font>
   real(r8), intent(inout) :: explay(nspint,pcols,0:pver) <font color=#447700>! Solar beam exp transm for layer<a name='7674'></font>
<font color=#447700>!<a name='7675'></font>
<font color=#447700>! Corresponding quantities for clear-skies<a name='7676'></font>
<font color=#447700>!<a name='7677'></font>
   real(r8), intent(inout) :: rdirc(nspint,pcols,0:pver)  <font color=#447700>! Clear layer reflec. to direct rad<a name='7678'></font>
   real(r8), intent(inout) :: rdifc(nspint,pcols,0:pver)  <font color=#447700>! Clear layer reflec. to diffuse rad<a name='7679'></font>
   real(r8), intent(inout) :: tdirc(nspint,pcols,0:pver)  <font color=#447700>! Clear layer trans. to direct rad<a name='7680'></font>
   real(r8), intent(inout) :: tdifc(nspint,pcols,0:pver)  <font color=#447700>! Clear layer trans. to diffuse rad<a name='7681'></font>
   real(r8), intent(inout) :: explayc(nspint,pcols,0:pver)<font color=#447700>! Solar beam exp transm clear layer<a name='7682'></font>
<font color=#447700>!<a name='7683'></font>
<font color=#447700>!---------------------------Local variables-----------------------------<a name='7684'></font>
<font color=#447700>!<a name='7685'></font>
   integer i                 <font color=#447700>! Column indices<a name='7686'></font>
   integer k                 <font color=#447700>! Level index<a name='7687'></font>
   integer nn                <font color=#447700>! Index of column loops (max=ndayc)<a name='7688'></font>
<a name='7689'>
   real(r8) taugab(pcols)        <font color=#447700>! Layer total gas absorption optical depth<a name='7690'></font>
   real(r8) tauray(pcols)        <font color=#447700>! Layer rayleigh optical depth<a name='7691'></font>
   real(r8) taucsc               <font color=#447700>! Layer cloud scattering optical depth<a name='7692'></font>
   real(r8) tautot               <font color=#447700>! Total layer optical depth<a name='7693'></font>
   real(r8) wtot                 <font color=#447700>! Total layer single scatter albedo<a name='7694'></font>
   real(r8) gtot                 <font color=#447700>! Total layer asymmetry parameter<a name='7695'></font>
   real(r8) ftot                 <font color=#447700>! Total layer forward scatter fraction<a name='7696'></font>
   real(r8) wtau                 <font color=#447700>!  rayleigh layer scattering optical depth<a name='7697'></font>
   real(r8) wt                   <font color=#447700>!  layer total single scattering albedo<a name='7698'></font>
   real(r8) ts                   <font color=#447700>!  layer scaled extinction optical depth<a name='7699'></font>
   real(r8) ws                   <font color=#447700>!  layer scaled single scattering albedo<a name='7700'></font>
   real(r8) gs                   <font color=#447700>!  layer scaled asymmetry parameter<a name='7701'></font>
<font color=#447700>!<a name='7702'></font>
<font color=#447700>!---------------------------Statement functions-------------------------<a name='7703'></font>
<font color=#447700>!<a name='7704'></font>
<font color=#447700>! Statement functions and other local variables<a name='7705'></font>
<font color=#447700>!<a name='7706'></font>
   real(r8) alpha                <font color=#447700>! Term in direct reflect and transmissivity<a name='7707'></font>
   real(r8) gamma                <font color=#447700>! Term in direct reflect and transmissivity<a name='7708'></font>
   real(r8) el                   <font color=#447700>! Term in alpha,gamma,n,u<a name='7709'></font>
   real(r8) taus                 <font color=#447700>! Scaled extinction optical depth<a name='7710'></font>
   real(r8) omgs                 <font color=#447700>! Scaled single particle scattering albedo<a name='7711'></font>
   real(r8) asys                 <font color=#447700>! Scaled asymmetry parameter<a name='7712'></font>
   real(r8) u                    <font color=#447700>! Term in diffuse reflect and<a name='7713'></font>
<font color=#447700>!    transmissivity<a name='7714'></font>
   real(r8) n                    <font color=#447700>! Term in diffuse reflect and<a name='7715'></font>
<font color=#447700>!    transmissivity<a name='7716'></font>
   real(r8) lm                   <font color=#447700>! Temporary for el<a name='7717'></font>
   real(r8) ne                   <font color=#447700>! Temporary for n<a name='7718'></font>
   real(r8) w                    <font color=#447700>! Dummy argument for statement function<a name='7719'></font>
   real(r8) uu                   <font color=#447700>! Dummy argument for statement function<a name='7720'></font>
   real(r8) g                    <font color=#447700>! Dummy argument for statement function<a name='7721'></font>
   real(r8) e                    <font color=#447700>! Dummy argument for statement function<a name='7722'></font>
   real(r8) f                    <font color=#447700>! Dummy argument for statement function<a name='7723'></font>
   real(r8) t                    <font color=#447700>! Dummy argument for statement function<a name='7724'></font>
   real(r8) et                   <font color=#447700>! Dummy argument for statement function<a name='7725'></font>
<font color=#447700>!<a name='7726'></font>
<font color=#447700>! Intermediate terms for delta-eddington solution<a name='7727'></font>
<font color=#447700>!<a name='7728'></font>
   real(r8) alp                  <font color=#447700>! Temporary for alpha<a name='7729'></font>
   real(r8) gam                  <font color=#447700>! Temporary for gamma<a name='7730'></font>
   real(r8) ue                   <font color=#447700>! Temporary for u<a name='7731'></font>
   real(r8) arg                  <font color=#447700>! Exponential argument<a name='7732'></font>
   real(r8) extins               <font color=#447700>! Extinction<a name='7733'></font>
   real(r8) amg                  <font color=#447700>! Alp - gam<a name='7734'></font>
   real(r8) apg                  <font color=#447700>! Alp + gam<a name='7735'></font>
<font color=#447700>!<a name='7736'></font>
   alpha(w,uu,g,e) = .75_r8*w*uu*((1._r8 + g*(1._r8-w))/(1._r8 - e*e*uu*uu))<a name='7737'>
   gamma(w,uu,g,e) = .50_r8*w*((3._r8*g*(1._r8-w)*uu*uu + 1._r8)/(1._r8-e*e*uu*uu))<a name='7738'>
   el(w,g)         = sqrt(3._r8*(1._r8-w)*(1._r8 - w*g))<a name='7739'>
   taus(w,f,t)     = (1._r8 - w*f)*t<a name='7740'>
   omgs(w,f)       = (1._r8 - f)*w/(1._r8 - w*f)<a name='7741'>
   asys(g,f)       = (g - f)/(1._r8 - f)<a name='7742'>
   u(w,g,e)        = 1.5_r8*(1._r8 - w*g)/e<a name='7743'>
   n(uu,et)        = ((uu+1._r8)*(uu+1._r8)/et ) - ((uu-1._r8)*(uu-1._r8)*et)<a name='7744'>
<font color=#447700>!<a name='7745'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7746'></font>
<font color=#447700>!<a name='7747'></font>
<font color=#447700>! Compute layer radiative properties<a name='7748'></font>
<font color=#447700>!<a name='7749'></font>
<font color=#447700>! Compute radiative properties (reflectivity and transmissivity for<a name='7750'></font>
<font color=#447700>!    direct and diffuse radiation incident from above, under clear<a name='7751'></font>
<font color=#447700>!    and cloudy conditions) and transmission of direct radiation<a name='7752'></font>
<font color=#447700>!    (under clear and cloudy conditions) for each layer.<a name='7753'></font>
<font color=#447700>!<a name='7754'></font>
   do k=0,pver<a name='7755'>
      do nn=1,ndayc<a name='7756'>
         i=idayc(nn)<a name='7757'>
            tauray(i) = trayoslp*(pflx(i,k+1)-pflx(i,k))<a name='7758'>
            taugab(i) = abh2o*uh2o(i,k) + abo3*uo3(i,k) + abco2*uco2(i,k) + abo2*uo2(i,k)<a name='7759'>
            tautot = tauxcl(i,k) + tauxci(i,k) + tauray(i) + taugab(i) + tauxar(i,k)<a name='7760'>
            taucsc = tauxcl(i,k)*wcl(i,k) + tauxci(i,k)*wci(i,k) + tauxar(i,k)*wa(i,k)<a name='7761'>
            wtau   = wray*tauray(i)<a name='7762'>
            wt     = wtau + taucsc<a name='7763'>
            wtot   = wt/tautot<a name='7764'>
            gtot   = (wtau*gray + gcl(i,k)*wcl(i,k)*tauxcl(i,k) &amp;<a name='7765'>
                     + gci(i,k)*wci(i,k)*tauxci(i,k) + ga(i,k) *wa(i,k) *tauxar(i,k))/wt<a name='7766'>
            ftot   = (wtau*fray + fcl(i,k)*wcl(i,k)*tauxcl(i,k) &amp;<a name='7767'>
                     + fci(i,k)*wci(i,k)*tauxci(i,k) + fa(i,k) *wa(i,k) *tauxar(i,k))/wt<a name='7768'>
            ts   = taus(wtot,ftot,tautot)<a name='7769'>
            ws   = omgs(wtot,ftot)<a name='7770'>
            gs   = asys(gtot,ftot)<a name='7771'>
            lm   = el(ws,gs)<a name='7772'>
            alp  = alpha(ws,coszrs(i),gs,lm)<a name='7773'>
            gam  = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_ra_cam.F.html#RADDEDMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_112">(ws,coszrs(i),gs,lm)<a name='7774'>
            ue   = u(ws,gs,lm)<a name='7775'>
<font color=#447700>!<a name='7776'></font>
<font color=#447700>!     Limit argument of exponential to 25, in case lm very large:<a name='7777'></font>
<font color=#447700>!<a name='7778'></font>
            arg  = min(lm*ts,25._r8)<a name='7779'>
            extins = exp(-arg)<a name='7780'>
            ne = n(ue,extins)<a name='7781'>
            rdif(ns,i,k) = (ue+1._r8)*(ue-1._r8)*(1._r8/extins - extins)/ne<a name='7782'>
            tdif(ns,i,k)   =   4._r8*ue/ne<a name='7783'>
<font color=#447700>!<a name='7784'></font>
<font color=#447700>!     Limit argument of exponential to 25, in case coszrs is very small:<a name='7785'></font>
<font color=#447700>!<a name='7786'></font>
            arg       = min(ts/coszrs(i),25._r8)<a name='7787'>
            explay(ns,i,k) = exp(-arg)<a name='7788'>
            apg = alp + gam<a name='7789'>
            amg = alp - gam<a name='7790'>
            rdir(ns,i,k) = amg*(tdif(ns,i,k)*explay(ns,i,k)-1._r8) + apg*rdif(ns,i,k)<a name='7791'>
            tdir(ns,i,k) = apg*tdif(ns,i,k) + (amg*rdif(ns,i,k)-(apg-1._r8))*explay(ns,i,k)<a name='7792'>
<font color=#447700>!<a name='7793'></font>
<font color=#447700>!     Under rare conditions, reflectivies and transmissivities can be<a name='7794'></font>
<font color=#447700>!     negative; zero out any negative values<a name='7795'></font>
<font color=#447700>!<a name='7796'></font>
            rdir(ns,i,k) = max(rdir(ns,i,k),0.0_r8)<a name='7797'>
            tdir(ns,i,k) = max(tdir(ns,i,k),0.0_r8)<a name='7798'>
            rdif(ns,i,k) = max(rdif(ns,i,k),0.0_r8)<a name='7799'>
            tdif(ns,i,k) = max(tdif(ns,i,k),0.0_r8)<a name='7800'>
<font color=#447700>!<a name='7801'></font>
<font color=#447700>!     Clear-sky calculation<a name='7802'></font>
<font color=#447700>!<a name='7803'></font>
            if (tauxcl(i,k) == 0.0_r8 .and. tauxci(i,k) == 0.0_r8) then<a name='7804'>
<a name='7805'>
               rdirc(ns,i,k) = rdir(ns,i,k)<a name='7806'>
               tdirc(ns,i,k) = tdir(ns,i,k)<a name='7807'>
               rdifc(ns,i,k) = rdif(ns,i,k)<a name='7808'>
               tdifc(ns,i,k) = tdif(ns,i,k)<a name='7809'>
               explayc(ns,i,k) = explay(ns,i,k)<a name='7810'>
            else<a name='7811'>
               tautot = tauray(i) + taugab(i) + tauxar(i,k)<a name='7812'>
               taucsc = tauxar(i,k)*wa(i,k)<a name='7813'>
<font color=#447700>!<a name='7814'></font>
<font color=#447700>! wtau already computed for all-sky<a name='7815'></font>
<font color=#447700>!<a name='7816'></font>
               wt     = wtau + taucsc<a name='7817'>
               wtot   = wt/tautot<a name='7818'>
               gtot   = (wtau*gray + ga(i,k)*wa(i,k)*tauxar(i,k))/wt<a name='7819'>
               ftot   = (wtau*fray + fa(i,k)*wa(i,k)*tauxar(i,k))/wt<a name='7820'>
               ts   = taus(wtot,ftot,tautot)<a name='7821'>
               ws   = omgs(wtot,ftot)<a name='7822'>
               gs   = asys(gtot,ftot)<a name='7823'>
               lm   = el(ws,gs)<a name='7824'>
               alp  = alpha(ws,coszrs(i),gs,lm)<a name='7825'>
               gam  = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_ra_cam.F.html#RADDEDMX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_113">(ws,coszrs(i),gs,lm)<a name='7826'>
               ue   = u(ws,gs,lm)<a name='7827'>
<font color=#447700>!<a name='7828'></font>
<font color=#447700>!     Limit argument of exponential to 25, in case lm very large:<a name='7829'></font>
<font color=#447700>!<a name='7830'></font>
               arg  = min(lm*ts,25._r8)<a name='7831'>
               extins = exp(-arg)<a name='7832'>
               ne = n(ue,extins)<a name='7833'>
               rdifc(ns,i,k) = (ue+1._r8)*(ue-1._r8)*(1._r8/extins - extins)/ne<a name='7834'>
               tdifc(ns,i,k)   =   4._r8*ue/ne<a name='7835'>
<font color=#447700>!<a name='7836'></font>
<font color=#447700>!     Limit argument of exponential to 25, in case coszrs is very small:<a name='7837'></font>
<font color=#447700>!<a name='7838'></font>
               arg       = min(ts/coszrs(i),25._r8)<a name='7839'>
               explayc(ns,i,k) = exp(-arg)<a name='7840'>
               apg = alp + gam<a name='7841'>
               amg = alp - gam<a name='7842'>
               rdirc(ns,i,k) = amg*(tdifc(ns,i,k)*explayc(ns,i,k)-1._r8)+ &amp;<a name='7843'>
                               apg*rdifc(ns,i,k)<a name='7844'>
               tdirc(ns,i,k) = apg*tdifc(ns,i,k) + (amg*rdifc(ns,i,k) - (apg-1._r8))* &amp;<a name='7845'>
                               explayc(ns,i,k)<a name='7846'>
<font color=#447700>!<a name='7847'></font>
<font color=#447700>!     Under rare conditions, reflectivies and transmissivities can be<a name='7848'></font>
<font color=#447700>!     negative; zero out any negative values<a name='7849'></font>
<font color=#447700>!<a name='7850'></font>
               rdirc(ns,i,k) = max(rdirc(ns,i,k),0.0_r8)<a name='7851'>
               tdirc(ns,i,k) = max(tdirc(ns,i,k),0.0_r8)<a name='7852'>
               rdifc(ns,i,k) = max(rdifc(ns,i,k),0.0_r8)<a name='7853'>
               tdifc(ns,i,k) = max(tdifc(ns,i,k),0.0_r8)<a name='7854'>
            end if<a name='7855'>
         end do<a name='7856'>
   end do<a name='7857'>
<a name='7858'>
   return<a name='7859'>
end subroutine raddedmx<a name='7860'>
<a name='7861'>
<A NAME='RADINP'><A href='../../html_code/phys/module_ra_cam.F.html#RADINP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7862'>
<font color=#993300>subroutine </font><font color=#cc0000>radinp</font>(lchnk   ,ncol    , pcols, pver, pverp,     &amp; <A href='../../call_to/RADINP.html' TARGET='index'>1</A><a name='7863'>
                  pmid    ,pint    ,o3vmr   , pmidrd  ,&amp;<a name='7864'>
                  pintrd  ,eccf    ,o3mmr   )<a name='7865'>
<font color=#447700>!----------------------------------------------------------------------- <a name='7866'></font>
<font color=#447700>! <a name='7867'></font>
<font color=#447700>! Purpose: <a name='7868'></font>
<font color=#447700>! Set latitude and time dependent arrays for input to solar<a name='7869'></font>
<font color=#447700>! and longwave radiation.<a name='7870'></font>
<font color=#447700>! Convert model pressures to cgs, and compute ozone mixing ratio, needed for<a name='7871'></font>
<font color=#447700>! the solar radiation.<a name='7872'></font>
<font color=#447700>! <a name='7873'></font>
<font color=#447700>! Method: <a name='7874'></font>
<font color=#447700>! &lt;Describe the algorithm(s) used in the routine.&gt; <a name='7875'></font>
<font color=#447700>! &lt;Also include any applicable external references.&gt; <a name='7876'></font>
<font color=#447700>! <a name='7877'></font>
<font color=#447700>! Author: CCM1, CMS Contact J. Kiehl<a name='7878'></font>
<font color=#447700>! <a name='7879'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7880'></font>
<font color=#447700>!  use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='7881'></font>
<font color=#447700>!  use ppgrid<a name='7882'></font>
<font color=#447700>!  use time_manager, only: get_curr_calday<a name='7883'></font>
<a name='7884'>
   implicit none<a name='7885'>
<a name='7886'>
<font color=#447700>!------------------------------Arguments--------------------------------<a name='7887'></font>
<font color=#447700>!<a name='7888'></font>
<font color=#447700>! Input arguments<a name='7889'></font>
<font color=#447700>!<a name='7890'></font>
   integer, intent(in) :: lchnk                <font color=#447700>! chunk identifier<a name='7891'></font>
   integer, intent(in) :: pcols, pver, pverp<a name='7892'>
   integer, intent(in) :: ncol                 <font color=#447700>! number of atmospheric columns<a name='7893'></font>
<a name='7894'>
   real(r8), intent(in) :: pmid(pcols,pver)    <font color=#447700>! Pressure at model mid-levels (pascals)<a name='7895'></font>
   real(r8), intent(in) :: pint(pcols,pverp)   <font color=#447700>! Pressure at model interfaces (pascals)<a name='7896'></font>
   real(r8), intent(in) :: o3vmr(pcols,pver)   <font color=#447700>! ozone volume mixing ratio<a name='7897'></font>
<font color=#447700>!<a name='7898'></font>
<font color=#447700>! Output arguments<a name='7899'></font>
<font color=#447700>!<a name='7900'></font>
   real(r8), intent(out) :: pmidrd(pcols,pver)  <font color=#447700>! Pressure at mid-levels (dynes/cm*2)<a name='7901'></font>
   real(r8), intent(out) :: pintrd(pcols,pverp) <font color=#447700>! Pressure at interfaces (dynes/cm*2)<a name='7902'></font>
   real(r8), intent(out) :: eccf                <font color=#447700>! Earth-sun distance factor<a name='7903'></font>
   real(r8), intent(out) :: o3mmr(pcols,pver)   <font color=#447700>! Ozone mass mixing ratio<a name='7904'></font>
<a name='7905'>
<font color=#447700>!<a name='7906'></font>
<font color=#447700>!---------------------------Local variables-----------------------------<a name='7907'></font>
<font color=#447700>!<a name='7908'></font>
   integer i                <font color=#447700>! Longitude loop index<a name='7909'></font>
   integer k                <font color=#447700>! Vertical loop index<a name='7910'></font>
<a name='7911'>
   real(r8) :: calday           <font color=#447700>! current calendar day<a name='7912'></font>
   real(r8) vmmr                <font color=#447700>! Ozone volume mixing ratio<a name='7913'></font>
   real(r8) delta               <font color=#447700>! Solar declination angle<a name='7914'></font>
<a name='7915'>
<font color=#447700>!<a name='7916'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7917'></font>
<font color=#447700>!<a name='7918'></font>
<font color=#447700>!  calday = get_curr_calday()<a name='7919'></font>
   eccf = 1. <font color=#447700>! declared intent(out) so fill a value (not used in WRF)<a name='7920'></font>
<font color=#447700>!  call shr_orb_decl (calday  ,eccen     ,mvelpp  ,lambm0  ,obliqr  , &amp;<a name='7921'></font>
<font color=#447700>!                     delta   ,eccf)<a name='7922'></font>
<a name='7923'>
<font color=#447700>!<a name='7924'></font>
<font color=#447700>! Convert pressure from pascals to dynes/cm2<a name='7925'></font>
<font color=#447700>!<a name='7926'></font>
   do k=1,pver<a name='7927'>
      do i=1,ncol<a name='7928'>
         pmidrd(i,k) = pmid(i,k)*10.0<a name='7929'>
         pintrd(i,k) = pint(i,k)*10.0<a name='7930'>
      end do<a name='7931'>
   end do<a name='7932'>
   do i=1,ncol<a name='7933'>
      pintrd(i,pverp) = pint(i,pverp)*10.0<a name='7934'>
   end do<a name='7935'>
<font color=#447700>!<a name='7936'></font>
<font color=#447700>! Convert ozone volume mixing ratio to mass mixing ratio:<a name='7937'></font>
<font color=#447700>!<a name='7938'></font>
   vmmr = amo/amd<a name='7939'>
   do k=1,pver<a name='7940'>
      do i=1,ncol<a name='7941'>
         o3mmr(i,k) = vmmr*o3vmr(i,k)<a name='7942'>
      end do<a name='7943'>
   end do<a name='7944'>
<font color=#447700>!<a name='7945'></font>
   return<a name='7946'>
end subroutine radinp<a name='7947'>
<A NAME='RADOZ2'><A href='../../html_code/phys/module_ra_cam.F.html#RADOZ2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7948'>
<font color=#993300>subroutine </font><font color=#cc0000>radoz2</font>(lchnk   ,ncol    ,pcols, pver, pverp, o3vmr   ,pint    ,plol    ,plos, ntoplw    ) <A href='../../call_to/RADOZ2.html' TARGET='index'>1</A><a name='7949'>
<font color=#447700>!----------------------------------------------------------------------- <a name='7950'></font>
<font color=#447700>! <a name='7951'></font>
<font color=#447700>! Purpose: <a name='7952'></font>
<font color=#447700>! Computes the path length integrals to the model interfaces given the<a name='7953'></font>
<font color=#447700>! ozone volume mixing ratio<a name='7954'></font>
<font color=#447700>! <a name='7955'></font>
<font color=#447700>! Method: <a name='7956'></font>
<font color=#447700>! &lt;Describe the algorithm(s) used in the routine.&gt; <a name='7957'></font>
<font color=#447700>! &lt;Also include any applicable external references.&gt; <a name='7958'></font>
<font color=#447700>! <a name='7959'></font>
<font color=#447700>! Author: CCM1, CMS Contact J. Kiehl<a name='7960'></font>
<font color=#447700>! <a name='7961'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7962'></font>
<font color=#447700>!  use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='7963'></font>
<font color=#447700>!  use ppgrid<a name='7964'></font>
<font color=#447700>!  use comozp<a name='7965'></font>
<a name='7966'>
   implicit none<a name='7967'>
<font color=#447700>!------------------------------Input arguments--------------------------<a name='7968'></font>
<font color=#447700>!<a name='7969'></font>
   integer, intent(in) :: lchnk                <font color=#447700>! chunk identifier<a name='7970'></font>
   integer, intent(in) :: ncol                 <font color=#447700>! number of atmospheric columns<a name='7971'></font>
   integer, intent(in) :: pcols, pver, pverp<a name='7972'>
<a name='7973'>
   real(r8), intent(in) :: o3vmr(pcols,pver)   <font color=#447700>! ozone volume mixing ratio<a name='7974'></font>
   real(r8), intent(in) :: pint(pcols,pverp)   <font color=#447700>! Model interface pressures<a name='7975'></font>
<a name='7976'>
   integer, intent(in) :: ntoplw               <font color=#447700>! topmost level/layer longwave is solved for<a name='7977'></font>
<a name='7978'>
<font color=#447700>!<a name='7979'></font>
<font color=#447700>!----------------------------Output arguments---------------------------<a name='7980'></font>
<font color=#447700>!<a name='7981'></font>
   real(r8), intent(out) :: plol(pcols,pverp)   <font color=#447700>! Ozone prs weighted path length (cm)<a name='7982'></font>
   real(r8), intent(out) :: plos(pcols,pverp)   <font color=#447700>! Ozone path length (cm)<a name='7983'></font>
<a name='7984'>
<font color=#447700>!<a name='7985'></font>
<font color=#447700>!---------------------------Local workspace-----------------------------<a name='7986'></font>
<font color=#447700>!<a name='7987'></font>
   integer i                <font color=#447700>! longitude index<a name='7988'></font>
   integer k                <font color=#447700>! level index<a name='7989'></font>
<font color=#447700>!<a name='7990'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='7991'></font>
<font color=#447700>!<a name='7992'></font>
<font color=#447700>! Evaluate the ozone path length integrals to interfaces;<a name='7993'></font>
<font color=#447700>! factors of .1 and .01 to convert pressures from cgs to mks:<a name='7994'></font>
<font color=#447700>!<a name='7995'></font>
   do i=1,ncol<a name='7996'>
      plos(i,ntoplw) = 0.1 *cplos*o3vmr(i,ntoplw)*pint(i,ntoplw)<a name='7997'>
      plol(i,ntoplw) = 0.01*cplol*o3vmr(i,ntoplw)*pint(i,ntoplw)*pint(i,ntoplw)<a name='7998'>
   end do<a name='7999'>
   do k=ntoplw+1,pverp<a name='8000'>
      do i=1,ncol<a name='8001'>
         plos(i,k) = plos(i,k-1) + 0.1*cplos*o3vmr(i,k-1)*(pint(i,k) - pint(i,k-1))<a name='8002'>
         plol(i,k) = plol(i,k-1) + 0.01*cplol*o3vmr(i,k-1)* &amp;<a name='8003'>
                    (pint(i,k)*pint(i,k) - pint(i,k-1)*pint(i,k-1))<a name='8004'>
      end do<a name='8005'>
   end do<a name='8006'>
<font color=#447700>!<a name='8007'></font>
   return<a name='8008'>
end subroutine radoz2<a name='8009'>
<a name='8010'>
<a name='8011'>
<A NAME='RADOZN'><A href='../../html_code/phys/module_ra_cam.F.html#RADOZN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8012'>
<font color=#993300>subroutine </font><font color=#cc0000>radozn</font> (lchnk, ncol, pcols, pver,pmid, pin, levsiz, ozmix, o3vmr) <A href='../../call_to/RADOZN.html' TARGET='index'>1</A>,<A href='../../call_from/RADOZN.html' TARGET='index'>1</A><a name='8013'>
<font color=#447700>!----------------------------------------------------------------------- <a name='8014'></font>
<font color=#447700>! <a name='8015'></font>
<font color=#447700>! Purpose: Interpolate ozone from current time-interpolated values to model levels<a name='8016'></font>
<font color=#447700>! <a name='8017'></font>
<font color=#447700>! Method: Use pressure values to determine interpolation levels<a name='8018'></font>
<font color=#447700>! <a name='8019'></font>
<font color=#447700>! Author: Bruce Briegleb<a name='8020'></font>
<font color=#447700>! <a name='8021'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='8022'></font>
<font color=#447700>!  use shr_kind_mod, only: r8 =&gt; shr_kind_r8<a name='8023'></font>
<font color=#447700>!  use ppgrid<a name='8024'></font>
<font color=#447700>!  use phys_grid,     only: get_lat_all_p, get_lon_all_p<a name='8025'></font>
<font color=#447700>!  use comozp<a name='8026'></font>
<font color=#447700>!  use abortutils, only: endrun<a name='8027'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='8028'></font>
   implicit none<a name='8029'>
<font color=#447700>!--------------------------------------------------------------------------<a name='8030'></font>
<font color=#447700>!<a name='8031'></font>
<font color=#447700>! Arguments<a name='8032'></font>
<font color=#447700>!<a name='8033'></font>
   integer, intent(in) :: lchnk               <font color=#447700>! chunk identifier<a name='8034'></font>
   integer, intent(in) :: pcols, pver<a name='8035'>
   integer, intent(in) :: ncol                <font color=#447700>! number of atmospheric columns<a name='8036'></font>
   integer, intent(in) :: levsiz              <font color=#447700>! number of ozone layers<a name='8037'></font>
<a name='8038'>
   real(r8), intent(in) :: pmid(pcols,pver)   <font color=#447700>! level pressures (mks)<a name='8039'></font>
   real(r8), intent(in) :: pin(levsiz)        <font color=#447700>! ozone data level pressures (mks)<a name='8040'></font>
   real(r8), intent(in) :: ozmix(pcols,levsiz) <font color=#447700>! ozone mixing ratio<a name='8041'></font>
<a name='8042'>
   real(r8), intent(out) :: o3vmr(pcols,pver) <font color=#447700>! ozone volume mixing ratio<a name='8043'></font>
<font color=#447700>!<a name='8044'></font>
<font color=#447700>! local storage<a name='8045'></font>
<font color=#447700>!<a name='8046'></font>
   integer i                   <font color=#447700>! longitude index<a name='8047'></font>
   integer k, kk, kkstart      <font color=#447700>! level indices<a name='8048'></font>
   integer kupper(pcols)       <font color=#447700>! Level indices for interpolation<a name='8049'></font>
   integer kount               <font color=#447700>! Counter<a name='8050'></font>
   integer lats(pcols)         <font color=#447700>! latitude indices<a name='8051'></font>
   integer lons(pcols)         <font color=#447700>! latitude indices<a name='8052'></font>
<a name='8053'>
   real(r8) dpu                <font color=#447700>! upper level pressure difference<a name='8054'></font>
   real(r8) dpl                <font color=#447700>! lower level pressure difference<a name='8055'></font>
<font color=#447700>!<a name='8056'></font>
<font color=#447700>! Initialize latitude indices<a name='8057'></font>
<font color=#447700>!<a name='8058'></font>
<font color=#447700>!  call get_lat_all_p(lchnk, ncol, lats)<a name='8059'></font>
<font color=#447700>!  call get_lon_all_p(lchnk, ncol, lons)<a name='8060'></font>
<font color=#447700>!<a name='8061'></font>
<font color=#447700>! Initialize index array<a name='8062'></font>
<font color=#447700>!<a name='8063'></font>
   do i=1,ncol<a name='8064'>
      kupper(i) = 1<a name='8065'>
   end do<a name='8066'>
<a name='8067'>
   do k=1,pver<a name='8068'>
<font color=#447700>!<a name='8069'></font>
<font color=#447700>! Top level we need to start looking is the top level for the previous k<a name='8070'></font>
<font color=#447700>! for all longitude points<a name='8071'></font>
<font color=#447700>!<a name='8072'></font>
      kkstart = levsiz<a name='8073'>
      do i=1,ncol<a name='8074'>
         kkstart = min0(kkstart,kupper(i))<a name='8075'>
      end do<a name='8076'>
      kount = 0<a name='8077'>
<font color=#447700>!<a name='8078'></font>
<font color=#447700>! Store level indices for interpolation<a name='8079'></font>
<font color=#447700>!<a name='8080'></font>
      do kk=kkstart,levsiz-1<a name='8081'>
         do i=1,ncol<a name='8082'>
            if (pin(kk).lt.pmid(i,k) .and. pmid(i,k).le.pin(kk+1)) then<a name='8083'>
               kupper(i) = kk<a name='8084'>
               kount = kount + 1<a name='8085'>
            end if<a name='8086'>
         end do<a name='8087'>
<font color=#447700>!<a name='8088'></font>
<font color=#447700>! If all indices for this level have been found, do the interpolation and<a name='8089'></font>
<font color=#447700>! go to the next level<a name='8090'></font>
<font color=#447700>!<a name='8091'></font>
         if (kount.eq.ncol) then<a name='8092'>
            do i=1,ncol<a name='8093'>
               dpu = pmid(i,k) - pin(kupper(i))<a name='8094'>
               dpl = pin(kupper(i)+1) - pmid(i,k)<a name='8095'>
               o3vmr(i,k) = (ozmix(i,kupper(i))*dpl + &amp;<a name='8096'>
                             ozmix(i,kupper(i)+1)*dpu)/(dpl + dpu)<a name='8097'>
            end do<a name='8098'>
            goto 35<a name='8099'>
         end if<a name='8100'>
      end do<a name='8101'>
<font color=#447700>!<a name='8102'></font>
<font color=#447700>! If we've fallen through the kk=1,levsiz-1 loop, we cannot interpolate and<a name='8103'></font>
<font color=#447700>! must extrapolate from the bottom or top ozone data level for at least some<a name='8104'></font>
<font color=#447700>! of the longitude points.<a name='8105'></font>
<font color=#447700>!<a name='8106'></font>
      do i=1,ncol<a name='8107'>
         if (pmid(i,k) .lt. pin(1)) then<a name='8108'>
            o3vmr(i,k) = ozmix(i,1)*pmid(i,k)/pin(1)<a name='8109'>
         else if (pmid(i,k) .gt. pin(levsiz)) then<a name='8110'>
            o3vmr(i,k) = ozmix(i,levsiz)<a name='8111'>
         else<a name='8112'>
            dpu = pmid(i,k) - pin(kupper(i))<a name='8113'>
            dpl = pin(kupper(i)+1) - pmid(i,k)<a name='8114'>
            o3vmr(i,k) = (ozmix(i,kupper(i))*dpl + &amp;<a name='8115'>
                          ozmix(i,kupper(i)+1)*dpu)/(dpl + dpu)<a name='8116'>
         end if<a name='8117'>
      end do<a name='8118'>
<a name='8119'>
      if (kount.gt.ncol) then<a name='8120'>
         call <A href='../../html_code/phys/module_sf_clm.F.html#ENDRUN'>endrun</A><A href='../../html_code/phys/module_ra_cam.F.html#RADOZN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENDRUN_32"> ('RADOZN: Bad ozone data: non-monotonicity suspected')<a name='8121'>
      end if<a name='8122'>
35    continue<a name='8123'>
   end do<a name='8124'>
<a name='8125'>
   return<a name='8126'>
end subroutine radozn<a name='8127'>
<a name='8128'>
<a name='8129'>
#endif<a name='8130'>
<a name='8131'>
end MODULE module_ra_cam<a name='8132'>
</pre></body></html>