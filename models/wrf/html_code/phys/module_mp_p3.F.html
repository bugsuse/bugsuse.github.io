<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!__________________________________________________________________________________________<a name='2'></font>
<font color=#447700>! This module contains the Predicted Particle Property (P3) bulk microphysics scheme.      !<a name='3'></font>
<font color=#447700>!                                                                                          !<a name='4'></font>
<font color=#447700>! This code was originally written by H. Morrison,  MMM Division, NCAR (Dec 2012).         !<a name='5'></font>
<font color=#447700>! Modification were made by J. Milbrandt, RPN, Environment Canada (July 2014).             !<a name='6'></font>
<font color=#447700>!                                                                                          !<a name='7'></font>
<font color=#447700>! Two configurations of the P3 scheme are currently available:                             !<a name='8'></font>
<font color=#447700>!  1) specified droplet number (i.e. 1-moment cloud water)                                 !<a name='9'></font>
<font color=#447700>!  2) predicted droplet number (i.e. 2-moment cloud water).                                !<a name='10'></font>
<font color=#447700>!  The  2-moment cloud version is based on a specified aerosol distribution and            !<a name='11'></font>
<font color=#447700>!  does not include a subgrid-scale vertical velocity for droplet activation. Hence,       !<a name='12'></font>
<font color=#447700>!  this version should only be used for high-resolution simulations that resolve           !<a name='13'></font>
<font color=#447700>!  vertical motion driving droplet activation.                                             !<a name='14'></font>
<font color=#447700>!                                                                                          !<a name='15'></font>
<font color=#447700>! For details see: Morrison and Milbrandt (2015) [J. Atmos. Sci., 72, 287-311]             !<a name='16'></font>
<font color=#447700>!                  Milbrandt and Morrison (2016) [J. Atmos. Sci., 73, 975-995]             !<a name='17'></font>
<font color=#447700>!                                                                                          !<a name='18'></font>
<font color=#447700>! For questions or bug reports, please contact:                                            !<a name='19'></font>
<font color=#447700>!    Hugh Morrison   (morrison@ucar.edu), or                                               !<a name='20'></font>
<font color=#447700>!    Jason Milbrandt (jason.milbrandt@canada.ca)                                           !<a name='21'></font>
<font color=#447700>!__________________________________________________________________________________________!<a name='22'></font>
<font color=#447700>!                                                                                          !<a name='23'></font>
<font color=#447700>! Version:       2.4.7                                                                     !<a name='24'></font>
<font color=#447700>! Last updated:  2017-06-28                                                                !<a name='25'></font>
<font color=#447700>!__________________________________________________________________________________________!<a name='26'></font>
<a name='27'>
<A NAME='MODULE_MP_P3'><A href='../../html_code/phys/module_mp_p3.F.html#MODULE_MP_P3' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='28'>
 <font color=#993300>MODULE </font><font color=#cc0000>MODULE_MP_P3</font>   <font color=#447700>!WRF <A href='../../call_to/MODULE_MP_P3.html' TARGET='index'>2</A><a name='29'></font>
<font color=#447700>!MODULE MP_P3          !GEM<a name='30'></font>
<a name='31'>
 implicit none<a name='32'>
<a name='33'>
 public  :: mp_p3_wrapper_wrf,mp_p3_wrapper_gem,p3_main,polysvp1<a name='34'>
<a name='35'>
 private :: gamma,derf,find_lookupTable_indices_1a,find_lookupTable_indices_1b,          &amp;<a name='36'>
            find_lookupTable_indices_2,find_lookupTable_indices_3,get_cloud_dsd,         &amp;<a name='37'>
            get_rain_dsd,calc_bulkRhoRime,impose_max_total_Ni,check_values,qv_sat<a name='38'>
<a name='39'>
<font color=#447700>! ice microphysics lookup table array dimensions<a name='40'></font>
 integer, private, parameter :: isize        = 50<a name='41'>
 integer, private, parameter :: iisize       = 25<a name='42'>
 integer, private, parameter :: zsize        = 20  <font color=#447700>! size of mom6 array in lookup_table (for future 3-moment)<a name='43'></font>
 integer, private, parameter :: densize      =  5<a name='44'>
 integer, private, parameter :: rimsize      =  4<a name='45'>
 integer, private, parameter :: rcollsize    = 30<a name='46'>
 integer, private, parameter :: tabsize      = 12  <font color=#447700>! number of quantities used from lookup table<a name='47'></font>
 integer, private, parameter :: colltabsize  =  2  <font color=#447700>! number of ice-rain collection  quantities used from lookup table<a name='48'></font>
 integer, private, parameter :: collitabsize =  2  <font color=#447700>! number of ice-ice collection  quantities used from lookup table<a name='49'></font>
<a name='50'>
 real, private, parameter    :: real_rcollsize = real(rcollsize)<a name='51'>
<a name='52'>
 real, private, dimension(densize,rimsize,isize,tabsize) :: itab   <font color=#447700>!ice lookup table values<a name='53'></font>
<a name='54'>
<font color=#447700>!ice lookup table values for ice-rain collision/collection<a name='55'></font>
 double precision, private, dimension(densize,rimsize,isize,rcollsize,colltabsize)    :: itabcoll<a name='56'>
<font color=#447700>! separated into itabcolli1 and itabcolli2, due to max of 7 dimensional arrays on some FORTRAN compilers<a name='57'></font>
 double precision, private, dimension(iisize,rimsize,densize,iisize,rimsize,densize) :: itabcolli1<a name='58'>
 double precision, private, dimension(iisize,rimsize,densize,iisize,rimsize,densize) :: itabcolli2<a name='59'>
<a name='60'>
<font color=#447700>! integer switch for warm rain autoconversion/accretion schemes<a name='61'></font>
 integer, private :: iparam<a name='62'>
<a name='63'>
<font color=#447700>! droplet spectral shape parameter for mass spectra, used for Seifert and Beheng (2001)<a name='64'></font>
<font color=#447700>! warm rain autoconversion/accretion option only (iparam = 1)<a name='65'></font>
 real, private, dimension(16) :: dnu<a name='66'>
<a name='67'>
<font color=#447700>! lookup table values for rain shape parameter mu_r<a name='68'></font>
 real, private, dimension(150) :: mu_r_table<a name='69'>
<a name='70'>
<font color=#447700>! lookup table values for rain number- and mass-weighted fallspeeds and ventilation parameters<a name='71'></font>
 real, private, dimension(300,10) :: vn_table,vm_table,revap_table<a name='72'>
<a name='73'>
 <font color=#447700>! physical and mathematical constants<a name='74'></font>
 real, private  :: rhosur,rhosui,ar,br,f1r,f2r,ecr,rhow,kr,kc,bimm,aimm,rin,mi0,nccnst,  &amp;<a name='75'>
                   eci,eri,bcn,cpw,e0,cons1,cons2,cons3,cons4,cons5,cons6,cons7,         &amp;<a name='76'>
                   inv_rhow,qsmall,nsmall,bsmall,zsmall,cp,g,rd,rv,ep_2,inv_cp,mw,osm,   &amp;<a name='77'>
                   vi,epsm,rhoa,map,ma,rr,bact,inv_rm1,inv_rm2,sig1,nanew1,f11,f21,sig2, &amp;<a name='78'>
                   nanew2,f12,f22,pi,thrd,sxth,piov3,piov6,diff_nucthrs,rho_rimeMin,     &amp;<a name='79'>
                   rho_rimeMax,inv_rho_rimeMax,max_total_Ni,dbrk,nmltratio,clbfact_sub,  &amp;<a name='80'>
                   clbfact_dep<a name='81'>
<a name='82'>
 contains<a name='83'>
<a name='84'>
<font color=#447700>!==================================================================================================!<a name='85'></font>
<a name='86'>
<font color=#447700>! The approach to locating the lookupTable files(s) from s/r 'p3_init' is different in WRF and GEM<a name='87'></font>
<font color=#447700>! in this version of P3.  Comment/uncomment the following code appropriate depending on the model.<a name='88'></font>
<a name='89'>
<font color=#447700>!--- FOR WRF (v3.9/v3.9.1): ---<a name='90'></font>
<a name='91'>
<A NAME='P3_INIT'><A href='../../html_code/phys/module_mp_p3.F.html#P3_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='92'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>p3_init</font>(lookup_file_1,lookup_file_2,nCat) <A href='../../call_to/P3_INIT.html' TARGET='index'>2</A>,<A href='../../call_from/P3_INIT.html' TARGET='index'>1</A><a name='93'>
<a name='94'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='95'></font>
<font color=#447700>! This subroutine initializes all physical constants and parameters needed by the P3       !<a name='96'></font>
<font color=#447700>! scheme.  The subroutine 'P3_INIT' must be called at the first model time step from there !<a name='97'></font>
<font color=#447700>! wrapper subroutine, prior to first call to the main scheme subroutine, 'P3_MAIN'.        !<a name='98'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='99'></font>
<a name='100'>
 implicit none<a name='101'>
<a name='102'>
<font color=#447700>! Passed arguments:<a name='103'></font>
 character*(*), intent(in) :: lookup_file_1    <font color=#447700>!lookup table for main processes<a name='104'></font>
 character*(*), intent(in) :: lookup_file_2    <font color=#447700>!lookup table for ice category interactions<a name='105'></font>
 integer, intent(in)       :: nCat             <font color=#447700>!number of free ice categories<a name='106'></font>
<a name='107'>
<font color=#447700>! Local variables/parameters:<a name='108'></font>
 integer :: i,j,k,ii,jj,kk,jjj,jjj2,jjjj,jjjj2<a name='109'>
 real    :: lamr,mu_r,lamold,dum,initlamr<a name='110'>
 real    :: dm,dum1,dum2,dum3,dum4,dum5,dum6<a name='111'>
 real    :: dd,amg,vt,dia,vn,vm<a name='112'>
<font color=#447700>!<a name='113'></font>
<font color=#447700>!--- FOR GEM (RPNPHY_6.0): ---<a name='114'></font>
<font color=#447700>! ! !<a name='115'></font>
<font color=#447700>! ! !  SUBROUTINE p3_init(lookup_file_dir,nCat)<a name='116'></font>
<font color=#447700>! ! !<a name='117'></font>
<font color=#447700>! ! ! !------------------------------------------------------------------------------------------!<a name='118'></font>
<font color=#447700>! ! ! ! This subroutine initializes all physical constants and parameters needed by the P3       !<a name='119'></font>
<font color=#447700>! ! ! ! scheme.  The subroutine 'P3_INIT' must be called at the first model time step from there !<a name='120'></font>
<font color=#447700>! ! ! ! wrapper subroutine, prior to first call to the main scheme subroutine, 'P3_MAIN'.        !<a name='121'></font>
<font color=#447700>! ! ! !------------------------------------------------------------------------------------------!<a name='122'></font>
<font color=#447700>! ! !<a name='123'></font>
<font color=#447700>! ! !   implicit none<a name='124'></font>
<font color=#447700>! ! !<a name='125'></font>
<font color=#447700>! ! ! ! Passed arguments:<a name='126'></font>
<font color=#447700>! ! !  character*(*), intent(in) :: lookup_file_dir  ! directory of the lookup tables to be read in<a name='127'></font>
<font color=#447700>! ! !  integer,       intent(in) :: nCat             ! number of free ice categories<a name='128'></font>
<font color=#447700>! ! !<a name='129'></font>
<font color=#447700>! ! !  character(len=16), parameter :: TABLE_VERSION  = '02'<a name='130'></font>
<font color=#447700>! ! !  character(len=16), parameter :: TABLE_BASENAME = 'p3_lookup_table'<a name='131'></font>
<font color=#447700>! ! !<a name='132'></font>
<font color=#447700>! ! ! ! Local variables/parameters:<a name='133'></font>
<font color=#447700>! ! !  character(len=1024) :: lookup_file_1    !lookup table for ice category interactions<a name='134'></font>
<font color=#447700>! ! !  character(len=1024) :: lookup_file_2    !lookup table for ice category interactions<a name='135'></font>
<font color=#447700>! ! !  integer :: i,j,k,ii,jj,kk,jjj,jjj2,jjjj,jjjj2<a name='136'></font>
<font color=#447700>! ! !  real    :: lamr,mu_r,lamold,dum,initlamr<a name='137'></font>
<font color=#447700>! ! !  real    :: dm,dum1,dum2,dum3,dum4,dum5,dum6<a name='138'></font>
<font color=#447700>! ! !  real    :: dd,amg,vt,dia,vn,vm<a name='139'></font>
<font color=#447700>! ! !<a name='140'></font>
<font color=#447700>! ! !  !------------------------------------------------------------------------------------------!<a name='141'></font>
<font color=#447700>! ! !<a name='142'></font>
<font color=#447700>! ! ! lookup_file_1 = trim(lookup_file_dir)//'/'//trim(TABLE_BASENAME)//'-1_v'//trim(TABLE_VERSION)//'.dat'<a name='143'></font>
<font color=#447700>! ! ! lookup_file_2 = trim(lookup_file_dir)//'/'//trim(TABLE_BASENAME)//'-2_v'//trim(TABLE_VERSION)//'.dat'<a name='144'></font>
<font color=#447700>! ! !<a name='145'></font>
<font color=#447700>! ! ! !-- override for local path/filenames:<a name='146'></font>
<font color=#447700>! ! ! ! lookup_file_1 =  '/data/ords/armn/armngr8/storage_model/p3_lookup_tables/p3_lookup_table_1.dat-v2.3.2'<a name='147'></font>
<font color=#447700>! ! ! ! lookup_file_2 =  '/data/ords/armn/armngr8/storage_model/p3_lookup_tables/p3_lookup_table_2.dat-v2.3.2'<a name='148'></font>
<font color=#447700>! ! ! !==<a name='149'></font>
<font color=#447700>!===<a name='150'></font>
<a name='151'>
 <font color=#447700>!------------------------------------------------------------------------------------------!<a name='152'></font>
<a name='153'>
<font color=#447700>! mathematical/optimization constants<a name='154'></font>
 pi    = 3.14159265<a name='155'>
 thrd  = 1./3.<a name='156'>
 sxth  = 1./6.<a name='157'>
 piov3 = pi*thrd<a name='158'>
 piov6 = pi*sxth<a name='159'>
<a name='160'>
<font color=#447700>! maximum total ice concentration (sum of all categories)<a name='161'></font>
 max_total_Ni = 500.e+3  <font color=#447700>!(m)<a name='162'></font>
<a name='163'>
<font color=#447700>! switch for warm-rain parameterization<a name='164'></font>
<font color=#447700>! = 1 Seifert and Beheng 2001<a name='165'></font>
<font color=#447700>! = 2 Beheng 1994<a name='166'></font>
<font color=#447700>! = 3 Khairoutdinov and Kogan 2000<a name='167'></font>
 iparam = 3<a name='168'>
<a name='169'>
<font color=#447700>! droplet concentration (m-3)<a name='170'></font>
 nccnst = 400.e+6<a name='171'>
<a name='172'>
<font color=#447700>! parameters for Seifert and Beheng (2001) autoconversion/accretion<a name='173'></font>
 kc     = 9.44e+9<a name='174'>
 kr     = 5.78e+3<a name='175'>
<a name='176'>
<font color=#447700>! physical constants<a name='177'></font>
 cp     = 1005.<a name='178'>
 inv_cp = 1./cp<a name='179'>
 g      = 9.816<a name='180'>
 rd     = 287.15<a name='181'>
 rv     = 461.51<a name='182'>
 ep_2   = 0.622<a name='183'>
 rhosur = 100000./(rd*273.15)<a name='184'>
 rhosui = 60000./(rd*253.15)<a name='185'>
 ar     = 841.99667<a name='186'>
 br     = 0.8<a name='187'>
 f1r    = 0.78<a name='188'>
 f2r    = 0.32<a name='189'>
 ecr    = 1.<a name='190'>
 rhow   = 997.<a name='191'>
 cpw    = 4218.<a name='192'>
 inv_rhow = 1.e-3  <font color=#447700>!inverse of (max.) density of liquid water<a name='193'></font>
<a name='194'>
<font color=#447700>! limits for rime density [kg m-3]<a name='195'></font>
 rho_rimeMin     =  50.<a name='196'>
 rho_rimeMax     = 900.<a name='197'>
 inv_rho_rimeMax = 1./rho_rimeMax<a name='198'>
<a name='199'>
<font color=#447700>! minium allowable prognostic variables<a name='200'></font>
 qsmall = 1.e-14<a name='201'>
 nsmall = 1.e-16<a name='202'>
 bsmall = qsmall*inv_rho_rimeMax<a name='203'>
<font color=#447700>!zsmall = 1.e-35<a name='204'></font>
<a name='205'>
<font color=#447700>! Bigg (1953)<a name='206'></font>
<font color=#447700>!bimm   = 100.<a name='207'></font>
<font color=#447700>!aimm   = 0.66<a name='208'></font>
<font color=#447700>! Barklie and Gokhale (1959)<a name='209'></font>
 bimm   = 2.<a name='210'>
 aimm   = 0.65<a name='211'>
 rin    = 0.1e-6<a name='212'>
 mi0    = 4.*piov3*900.*1.e-18<a name='213'>
<a name='214'>
 eci    = 0.5<a name='215'>
 eri    = 1.<a name='216'>
 bcn    = 2.<a name='217'>
<a name='218'>
<font color=#447700>! mean size for soft lambda_r limiter [microns]<a name='219'></font>
 dbrk   = 600.e-6<a name='220'>
<font color=#447700>! ratio of rain number produced to ice number loss from melting<a name='221'></font>
 nmltratio = 0.2<a name='222'>
<a name='223'>
<font color=#447700>! saturation pressure at T = 0 C<a name='224'></font>
 e0    = <A href='../../html_code/phys/module_mp_p3.F.html#POLYSVP1'>polysvp1</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP1_1">(273.15,0)<a name='225'>
<a name='226'>
 cons1 = piov6*rhow<a name='227'>
 cons2 = 4.*piov3*rhow<a name='228'>
 cons3 = 1./(cons2*(25.e-6)**3)<a name='229'>
 cons4 = 1./(dbrk**3*pi*rhow)<a name='230'>
 cons5 = piov6*bimm<a name='231'>
 cons6 = piov6**2*rhow*bimm<a name='232'>
 cons7 = 4.*piov3*rhow*(1.e-6)**3<a name='233'>
<a name='234'>
<font color=#447700>! aerosol/droplet activation parameters<a name='235'></font>
 mw     = 0.018<a name='236'>
 osm    = 1.<a name='237'>
 vi     = 3.<a name='238'>
 epsm   = 0.9<a name='239'>
 rhoa   = 1777.<a name='240'>
 map    = 0.132<a name='241'>
 ma     = 0.0284<a name='242'>
 rr     = 8.3187<a name='243'>
 bact   = vi*osm*epsm*mw*rhoa/(map*rhow)<a name='244'>
<font color=#447700>! inv_bact = (map*rhow)/(vi*osm*epsm*mw*rhoa)    *** to replace /bact **<a name='245'></font>
<a name='246'>
<font color=#447700>! mode 1<a name='247'></font>
 inv_rm1 = 2.e+7           <font color=#447700>! inverse aerosol mean size (m-1)<a name='248'></font>
 sig1    = 2.0             <font color=#447700>! aerosol standard deviation<a name='249'></font>
 nanew1  = 300.e6          <font color=#447700>! aerosol number mixing ratio (kg-1)<a name='250'></font>
 f11     = 0.5*exp(2.5*(log(sig1))**2)<a name='251'>
 f21     = 1. + 0.25*log(sig1)<a name='252'>
<a name='253'>
<font color=#447700>! note: currently only set for a single mode, droplet activation code needs to<a name='254'></font>
<font color=#447700>!       be modified to include the second mode<a name='255'></font>
<font color=#447700>! mode 2<a name='256'></font>
 inv_rm2 = 7.6923076e+5    <font color=#447700>! inverse aerosol mean size (m-1)<a name='257'></font>
 sig2    = 2.5             <font color=#447700>! aerosol standard deviation<a name='258'></font>
 nanew2  = 0.              <font color=#447700>! aerosol number mixing ratio (kg-1)<a name='259'></font>
 f12     = 0.5*exp(2.5*(log(sig2))**2)<a name='260'>
 f22     = 1. + 0.25*log(sig2)<a name='261'>
<a name='262'>
<font color=#447700>! parameters for droplet mass spectral shape, used by Seifert and Beheng (2001)<a name='263'></font>
<font color=#447700>! warm rain scheme only (iparam = 1)<a name='264'></font>
 dnu(1)  =  0.<a name='265'>
 dnu(2)  = -0.557<a name='266'>
 dnu(3)  = -0.430<a name='267'>
 dnu(4)  = -0.307<a name='268'>
 dnu(5)  = -0.186<a name='269'>
 dnu(6)  = -0.067<a name='270'>
 dnu(7)  =  0.050<a name='271'>
 dnu(8)  =  0.167<a name='272'>
 dnu(9)  =  0.282<a name='273'>
 dnu(10) =  0.397<a name='274'>
 dnu(11) =  0.512<a name='275'>
 dnu(12) =  0.626<a name='276'>
 dnu(13) =  0.739<a name='277'>
 dnu(14) =  0.853<a name='278'>
 dnu(15) =  0.966<a name='279'>
 dnu(16) =  0.966<a name='280'>
<a name='281'>
<font color=#447700>! calibration factors for ice deposition and sublimation<a name='282'></font>
<font color=#447700>!   These are adjustable ad hoc factors used to increase or decrease deposition and/or<a name='283'></font>
<font color=#447700>!   sublimation rates.  The representation of the ice capacitances are highly simplified<a name='284'></font>
<font color=#447700>!   and the appropriate values in the diffusional growth equation are uncertain.<a name='285'></font>
 clbfact_dep = 1.<a name='286'>
 clbfact_sub = 1.<a name='287'>
<a name='288'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='289'></font>
<font color=#447700>! read in ice microphysics table<a name='290'></font>
<a name='291'>
 print*<a name='292'>
 print*, ' P3 microphysics, version: 2.4.7'<a name='293'>
 print*, '   P3_INIT (READING/CREATING LOOK-UP TABLES) ...'<a name='294'>
<font color=#447700>!print*, '   Reading lookup-table 1 ...'<a name='295'></font>
<a name='296'>
 open(unit=10,file=lookup_file_1, status='old')<a name='297'>
<a name='298'>
 do jj = 1,densize<a name='299'>
    do ii = 1,rimsize<a name='300'>
       do i = 1,isize<a name='301'>
          read(10,*) dum,dum,dum,dum,itab(jj,ii,i,1),itab(jj,ii,i,2),           &amp;<a name='302'>
               itab(jj,ii,i,3),itab(jj,ii,i,4),itab(jj,ii,i,5),                 &amp;<a name='303'>
               itab(jj,ii,i,6),itab(jj,ii,i,7),itab(jj,ii,i,8),dum,             &amp;<a name='304'>
               itab(jj,ii,i,9),itab(jj,ii,i,10),itab(jj,ii,i,11),               &amp;<a name='305'>
               itab(jj,ii,i,12)<a name='306'>
        enddo<a name='307'>
<font color=#447700>! read in table for ice-rain collection<a name='308'></font>
       do i = 1,isize<a name='309'>
          do j = 1,rcollsize<a name='310'>
             read(10,*) dum,dum,dum,dum,dum,itabcoll(jj,ii,i,j,1),              &amp;<a name='311'>
              itabcoll(jj,ii,i,j,2),dum<a name='312'>
              itabcoll(jj,ii,i,j,1) = dlog10(itabcoll(jj,ii,i,j,1))<a name='313'>
              itabcoll(jj,ii,i,j,2) = dlog10(itabcoll(jj,ii,i,j,2))<a name='314'>
          enddo<a name='315'>
       enddo<a name='316'>
    enddo<a name='317'>
 enddo<a name='318'>
<a name='319'>
<font color=#447700>! hm add fix to prevent end-of-file error in nested runs, 3/28/14<a name='320'></font>
 close(10)<a name='321'>
<a name='322'>
<font color=#447700>! read in ice-ice collision lookup table<a name='323'></font>
<a name='324'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='325'></font>
<a name='326'>
<font color=#447700>!                   *** used for multicategory only ***<a name='327'></font>
<a name='328'>
 if (nCat&gt;1) then<a name='329'>
<a name='330'>
   <font color=#447700>!print*, '   Reading lookup-table 2 ...'<a name='331'></font>
<a name='332'>
    open(unit=10,file=lookup_file_2,status='old')<a name='333'>
<a name='334'>
    do i = 1,iisize<a name='335'>
       do jjj = 1,rimsize<a name='336'>
          do jjjj = 1,densize<a name='337'>
             do ii = 1,iisize<a name='338'>
                do jjj2 = 1,rimsize<a name='339'>
                   do jjjj2 = 1,densize<a name='340'>
                      read(10,*) dum,dum,dum,dum,dum,dum,dum,                      &amp;<a name='341'>
                      itabcolli1(i,jjj,jjjj,ii,jjj2,jjjj2),                        &amp;<a name='342'>
                      itabcolli2(i,jjj,jjjj,ii,jjj2,jjjj2)<a name='343'>
                   enddo<a name='344'>
                enddo<a name='345'>
             enddo<a name='346'>
          enddo<a name='347'>
       enddo<a name='348'>
    enddo<a name='349'>
<a name='350'>
    close(unit=10)<a name='351'>
<a name='352'>
 else <font color=#447700>! for single cat<a name='353'></font>
<a name='354'>
    itabcolli1 = 0.<a name='355'>
    itabcolli2 = 0.<a name='356'>
<a name='357'>
 endif<a name='358'>
<a name='359'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='360'></font>
<a name='361'>
<font color=#447700>! Generate lookup table for rain shape parameter mu_r<a name='362'></font>
<font color=#447700>! this is very fast so it can be generated at the start of each run<a name='363'></font>
<font color=#447700>! make a 150x1 1D lookup table, this is done in parameter<a name='364'></font>
<font color=#447700>! space of a scaled mean size proportional qr/Nr -- initlamr<a name='365'></font>
<a name='366'>
<font color=#447700>!print*, '   Generating rain lookup-table ...'<a name='367'></font>
<a name='368'>
 do i = 1,150              <font color=#447700>! loop over lookup table values<a name='369'></font>
    initlamr = 1./((real(i)*2.)*1.e-6 + 250.e-6)<a name='370'>
<a name='371'>
<font color=#447700>! iterate to get mu_r<a name='372'></font>
<font color=#447700>! mu_r-lambda relationship is from Cao et al. (2008), eq. (7)<a name='373'></font>
<a name='374'>
<font color=#447700>! start with first guess, mu_r = 0<a name='375'></font>
<a name='376'>
    mu_r = 0.<a name='377'>
<a name='378'>
    do ii=1,50<a name='379'>
       lamr = initlamr*((mu_r+3.)*(mu_r+2.)*(mu_r+1.)/6.)**thrd<a name='380'>
<a name='381'>
<font color=#447700>! new estimate for mu_r based on lambda<a name='382'></font>
<font color=#447700>! set max lambda in formula for mu_r to 20 mm-1, so Cao et al.<a name='383'></font>
<font color=#447700>! formula is not extrapolated beyond Cao et al. data range<a name='384'></font>
       dum  = min(20.,lamr*1.e-3)<a name='385'>
       mu_r = max(0.,-0.0201*dum**2+0.902*dum-1.718)<a name='386'>
<a name='387'>
<font color=#447700>! if lambda is converged within 0.1%, then exit loop<a name='388'></font>
       if (ii.ge.2) then<a name='389'>
          if (abs((lamold-lamr)/lamr).lt.0.001) goto 111<a name='390'>
       end if<a name='391'>
<a name='392'>
       lamold = lamr<a name='393'>
<a name='394'>
    enddo<a name='395'>
<a name='396'>
111 continue<a name='397'>
<a name='398'>
<font color=#447700>! assign lookup table values<a name='399'></font>
    mu_r_table(i) = mu_r<a name='400'>
<a name='401'>
 enddo<a name='402'>
<a name='403'>
<font color=#447700>!.......................................................................<a name='404'></font>
<font color=#447700>! Generate lookup table for rain fallspeed and ventilation parameters<a name='405'></font>
<font color=#447700>! the lookup table is two dimensional as a function of number-weighted mean size<a name='406'></font>
<font color=#447700>! proportional to qr/Nr and shape parameter mu_r<a name='407'></font>
<a name='408'>
 mu_r_loop: do ii = 1,10   <font color=#447700>!** change 10 to 9, since range of mu_r is 0-8  CONFIRM<a name='409'></font>
<font color=#447700>!mu_r_loop: do ii = 1,9   !** change 10 to 9, since range of mu_r is 0-8<a name='410'></font>
<a name='411'>
    mu_r = real(ii-1)  <font color=#447700>! values of mu<a name='412'></font>
<a name='413'>
<font color=#447700>! loop over number-weighted mean size<a name='414'></font>
    meansize_loop: do jj = 1,300<a name='415'>
<a name='416'>
       if (jj.le.20) then<a name='417'>
          dm = (real(jj)*10.-5.)*1.e-6      <font color=#447700>! mean size [m]<a name='418'></font>
       elseif (jj.gt.20) then<a name='419'>
          dm = (real(jj-20)*30.+195.)*1.e-6 <font color=#447700>! mean size [m]<a name='420'></font>
       endif<a name='421'>
<a name='422'>
       lamr = (mu_r+1)/dm<a name='423'>
<a name='424'>
<font color=#447700>! do numerical integration over PSD<a name='425'></font>
<a name='426'>
       dum1 = 0. <font color=#447700>! numerator,   number-weighted fallspeed<a name='427'></font>
       dum2 = 0. <font color=#447700>! denominator, number-weighted fallspeed<a name='428'></font>
       dum3 = 0. <font color=#447700>! numerator,   mass-weighted fallspeed<a name='429'></font>
       dum4 = 0. <font color=#447700>! denominator, mass-weighted fallspeed<a name='430'></font>
       dum5 = 0. <font color=#447700>! term for ventilation factor in evap<a name='431'></font>
       dd   = 2.<a name='432'>
<a name='433'>
<font color=#447700>! loop over PSD to numerically integrate number and mass-weighted mean fallspeeds<a name='434'></font>
       do kk = 1,10000<a name='435'>
<a name='436'>
          dia = (real(kk)*dd-dd*0.5)*1.e-6  <font color=#447700>! size bin [m]<a name='437'></font>
          amg = piov6*997.*dia**3           <font color=#447700>! mass [kg]<a name='438'></font>
          amg = amg*1000.                   <font color=#447700>! convert [kg] to [g]<a name='439'></font>
<a name='440'>
         <font color=#447700>!get fallspeed as a function of size [m s-1]<a name='441'></font>
          if (dia*1.e+6.le.134.43)      then<a name='442'>
            vt = 4.5795e+3*amg**(2.*thrd)<a name='443'>
          elseif (dia*1.e+6.lt.1511.64) then<a name='444'>
            vt = 4.962e+1*amg**thrd<a name='445'>
          elseif (dia*1.e+6.lt.3477.84) then<a name='446'>
            vt = 1.732e+1*amg**sxth<a name='447'>
          else<a name='448'>
            vt = 9.17<a name='449'>
          endif<a name='450'>
<a name='451'>
         <font color=#447700>!note: factor of 4.*mu_r is non-answer changing and only needed to<a name='452'></font>
         <font color=#447700>!      prevent underflow/overflow errors, same with 3.*mu_r for dum5<a name='453'></font>
          dum1 = dum1 + vt*10.**(mu_r*alog10(dia)+4.*mu_r)*exp(-lamr*dia)*dd*1.e-6<a name='454'>
          dum2 = dum2 + 10.**(mu_r*alog10(dia)+4.*mu_r)*exp(-lamr*dia)*dd*1.e-6<a name='455'>
          dum3 = dum3 + vt*10.**((mu_r+3.)*alog10(dia)+4.*mu_r)*exp(-lamr*dia)*dd*1.e-6<a name='456'>
          dum4 = dum4 + 10.**((mu_r+3.)*alog10(dia)+4.*mu_r)*exp(-lamr*dia)*dd*1.e-6<a name='457'>
          dum5 = dum5 + (vt*dia)**0.5*10.**((mu_r+1.)*alog10(dia)+3.*mu_r)*exp(-lamr*dia)*dd*1.e-6<a name='458'>
<a name='459'>
       enddo <font color=#447700>! kk-loop (over PSD)<a name='460'></font>
<a name='461'>
       dum2 = max(dum2, 1.e-30)  <font color=#447700>!to prevent divide-by-zero below<a name='462'></font>
       dum4 = max(dum4, 1.e-30)  <font color=#447700>!to prevent divide-by-zero below<a name='463'></font>
       dum5 = max(dum5, 1.e-30)  <font color=#447700>!to prevent log10-of-zero below<a name='464'></font>
<a name='465'>
       vn_table(jj,ii)    = dum1/dum2<a name='466'>
       vm_table(jj,ii)    = dum3/dum4<a name='467'>
       revap_table(jj,ii) = 10.**(alog10(dum5)+(mu_r+1.)*alog10(lamr)-(3.*mu_r))<a name='468'>
<a name='469'>
    enddo meansize_loop<a name='470'>
<a name='471'>
 enddo mu_r_loop<a name='472'>
<a name='473'>
<font color=#447700>!.......................................................................<a name='474'></font>
<a name='475'>
 print*, '   P3_INIT DONE.'<a name='476'>
 print*<a name='477'>
<a name='478'>
END SUBROUTINE P3_INIT<a name='479'>
<a name='480'>
<a name='481'>
<font color=#447700>!==================================================================================================!<a name='482'></font>
<a name='483'>
<a name='484'>
<font color=#447700>!-- note:  If not running in WRF, one can uncomment the following lines and comment the<a name='485'></font>
<font color=#447700>!          code for s/r mp_p3_wrapper_wrf<a name='486'></font>
<font color=#447700>!<a name='487'></font>
<font color=#447700>! ! ! SUBROUTINE mp_p3_wrapper_wrf<a name='488'></font>
<font color=#447700>! ! ! END SUBROUTINE mp_p3_wrapper_wrf<a name='489'></font>
<font color=#447700>!==<a name='490'></font>
<a name='491'>
<a name='492'>
<A NAME='MP_P3_WRAPPER_WRF'><A href='../../html_code/phys/module_mp_p3.F.html#MP_P3_WRAPPER_WRF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='493'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>mp_p3_wrapper_wrf</font>(th_3d,qv_3d,qc_3d,qr_3d,qnr_3d,                            &amp; <A href='../../call_to/MP_P3_WRAPPER_WRF.html' TARGET='index'>2</A>,<A href='../../call_from/MP_P3_WRAPPER_WRF.html' TARGET='index'>1</A><a name='494'>
                              th_old_3d,qv_old_3d,                                       &amp;<a name='495'>
                              pii,p,dz,w,dt,itimestep,                                   &amp;<a name='496'>
                              rainnc,rainncv,sr,snownc,snowncv,n_iceCat,                 &amp;<a name='497'>
                              ids, ide, jds, jde, kds, kde ,                             &amp;<a name='498'>
                              ims, ime, jms, jme, kms, kme ,                             &amp;<a name='499'>
                              its, ite, jts, jte, kts, kte ,                             &amp;<a name='500'>
                              diag_zdbz_3d,diag_effc_3d,diag_effi_3d,                    &amp;<a name='501'>
                              diag_vmi_3d,diag_di_3d,diag_rhopo_3d,                      &amp;<a name='502'>
                              qi1_3d,qni1_3d,qir1_3d,qib1_3d,                            &amp;<a name='503'>
                              qi2_3d,qni2_3d,qir2_3d,qib2_3d,nc_3d)<a name='504'>
<a name='505'>
  <font color=#447700>!------------------------------------------------------------------------------------------!<a name='506'></font>
  <font color=#447700>! This subroutine is the main WRF interface with the P3 microphysics scheme.  It takes     !<a name='507'></font>
  <font color=#447700>! 3D variables form the driving model and passes 2D slabs (i,k) to the main microphysics   !<a name='508'></font>
  <font color=#447700>! subroutine ('P3_MAIN') over a j-loop.  For each slab, 'P3_MAIN' updates the prognostic   !<a name='509'></font>
  <font color=#447700>! variables (hydrometeor variables, potential temperature, and water vapor).  The wrapper  !<a name='510'></font>
  <font color=#447700>! also updates the accumulated precipitation arrays and then passes back them, the         !<a name='511'></font>
  <font color=#447700>! updated 3D fields, and some diagnostic fields to the driver model.                       !<a name='512'></font>
  <font color=#447700>!                                                                                          !<a name='513'></font>
  <font color=#447700>! This version of the WRF wrapper works with WRFV3.8.                                      !<a name='514'></font>
  <font color=#447700>!------------------------------------------------------------------------------------------!<a name='515'></font>
<a name='516'>
  <font color=#447700>!--- input:<a name='517'></font>
<a name='518'>
  <font color=#447700>! pii       --&gt; Exner function (nondimensional pressure) (currently not used!)<a name='519'></font>
  <font color=#447700>! p         --&gt; pressure (pa)<a name='520'></font>
  <font color=#447700>! dz        --&gt; height difference across vertical levels (m)<a name='521'></font>
  <font color=#447700>! w         --&gt; vertical air velocity (m/s)<a name='522'></font>
  <font color=#447700>! dt        --&gt; time step (s)<a name='523'></font>
  <font color=#447700>! itimestep --&gt; integer time step counter<a name='524'></font>
  <font color=#447700>! n_iceCat  --&gt; number of ice-phase categories<a name='525'></font>
<a name='526'>
<a name='527'>
  <font color=#447700>!--- input/output:<a name='528'></font>
<a name='529'>
  <font color=#447700>! th_3d     --&gt; theta (K)<a name='530'></font>
  <font color=#447700>! qv_3d     --&gt; vapor mass mixing ratio (kg/kg)<a name='531'></font>
  <font color=#447700>! qc_3d     --&gt; cloud water mass mixing ratio (kg/kg)<a name='532'></font>
  <font color=#447700>! qr_3d     --&gt; rain mass mixing ratio (kg/kg)<a name='533'></font>
  <font color=#447700>! qnr_3d    --&gt; rain number mixing ratio (#/kg)<a name='534'></font>
  <font color=#447700>! qi1_3d    --&gt; total ice mixing ratio (kg/kg)<a name='535'></font>
  <font color=#447700>! qni1_3d   --&gt; ice number mixing ratio (#/kg)<a name='536'></font>
  <font color=#447700>! qir1_3d   --&gt; rime ice mass mixing ratio (kg/kg)<a name='537'></font>
  <font color=#447700>! qib1_3d   --&gt; ice rime volume mixing ratio (m^-3 kg^-1)<a name='538'></font>
<a name='539'>
  <font color=#447700>!--- output:<a name='540'></font>
<a name='541'>
  <font color=#447700>! rainnc        --&gt; accumulated surface precip (mm)<a name='542'></font>
  <font color=#447700>! rainncv       --&gt; one time step accumulated surface precip (mm)<a name='543'></font>
  <font color=#447700>! sr            --&gt; ice to liquid surface precip ratio<a name='544'></font>
  <font color=#447700>! snownc        --&gt; accumulated surface ice precip (mm)<a name='545'></font>
  <font color=#447700>! snowncv       --&gt; one time step accumulated surface ice precip (mm)<a name='546'></font>
  <font color=#447700>! ids...kte     --&gt; integer domain/tile bounds<a name='547'></font>
  <font color=#447700>! diag_zdbz_3d  --&gt; reflectivity (dBZ)<a name='548'></font>
  <font color=#447700>! diag_effc_3d  --&gt; cloud droplet effective radius (m)<a name='549'></font>
  <font color=#447700>! diag_effi_3d  --&gt; ice effective radius (m)<a name='550'></font>
  <font color=#447700>! diag_vmi_3d   --&gt; mean mass weighted ice fallspeed (m/s)<a name='551'></font>
  <font color=#447700>! diag_di_3d    --&gt; mean mass weighted ice size (m)<a name='552'></font>
  <font color=#447700>! diag_rhopo_3d --&gt; mean mass weighted ice density (kg/m3)<a name='553'></font>
<a name='554'>
  implicit none<a name='555'>
<a name='556'>
  <font color=#447700>!--- arguments:<a name='557'></font>
<a name='558'>
   integer, intent(in)            ::  ids, ide, jds, jde, kds, kde ,                      &amp;<a name='559'>
                                      ims, ime, jms, jme, kms, kme ,                      &amp;<a name='560'>
                                      its, ite, jts, jte, kts, kte<a name='561'>
   real, dimension(ims:ime, kms:kme, jms:jme), intent(inout):: th_3d,qv_3d,qc_3d,qr_3d,   &amp;<a name='562'>
                   qnr_3d,diag_zdbz_3d,diag_effc_3d,diag_effi_3d,diag_vmi_3d,diag_di_3d,  &amp;<a name='563'>
                   diag_rhopo_3d,th_old_3d,qv_old_3d<a name='564'>
   real, dimension(ims:ime, kms:kme, jms:jme), intent(inout):: qi1_3d,qni1_3d,qir1_3d,    &amp;<a name='565'>
                                                               qib1_3d<a name='566'>
   real, dimension(ims:ime, kms:kme, jms:jme), intent(inout), optional :: qi2_3d,qni2_3d, &amp;<a name='567'>
                                                                          qir2_3d,qib2_3d<a name='568'>
   real, dimension(ims:ime, kms:kme, jms:jme), intent(inout), optional :: nc_3d<a name='569'>
<a name='570'>
   real, dimension(ims:ime, kms:kme, jms:jme), intent(in) :: pii,p,dz,w<a name='571'>
   real, dimension(ims:ime, jms:jme), intent(inout) :: RAINNC,RAINNCV,SR,SNOWNC,SNOWNCV<a name='572'>
   real, intent(in)    :: dt<a name='573'>
   integer, intent(in) :: itimestep<a name='574'>
   integer, intent(in) :: n_iceCat<a name='575'>
   logical :: log_predictNc<a name='576'>
<a name='577'>
   <font color=#447700>!--- local variables/parameters:<a name='578'></font>
<a name='579'>
   real, dimension(ims:ime, kms:kme) ::nc,ssat<a name='580'>
<a name='581'>
   <font color=#447700>! note: hard-wired for one ice category<a name='582'></font>
   real, dimension(ims:ime, kms:kme, 1) :: qitot,qirim,nitot,birim,diag_di,diag_vmi,       &amp;<a name='583'>
                                          diag_rhopo,diag_effi<a name='584'>
<a name='585'>
   real, dimension(its:ite) :: pcprt_liq,pcprt_sol<a name='586'>
   real                     :: dum1,dum2<a name='587'>
   integer                  :: i,k,j<a name='588'>
   integer, parameter       :: n_diag_ss = 3        <font color=#447700>! number of user-defined diagnostic fields<a name='589'></font>
   logical, parameter       :: nk_bottom = .false.  <font color=#447700>!.F. --&gt; nk at model top (as in WRF)<a name='590'></font>
<a name='591'>
   real, dimension(ims:ime, kms:kme, n_diag_ss) :: diag_ss<a name='592'>
<a name='593'>
<font color=#447700>!   allocate (qitot(ims:ime, kms:kme,n_iceCat))      ! ice mixing ratio, mass (total)   [kg kg-1]<a name='594'></font>
<font color=#447700>!   allocate (qirim(ims:ime, kms:kme,n_iceCat))      ! ice mixing ratio, mass (rime)    [kg kg-1]<a name='595'></font>
<font color=#447700>!   allocate (nitot(ims:ime, kms:kme,n_iceCat))      ! ice mixing ratio, number         [# kg-1]<a name='596'></font>
<font color=#447700>!   allocate (birim(ims:ime, kms:kme,n_iceCat))      ! ice mixing ratio, volume         [m3 kg-1]<a name='597'></font>
<font color=#447700>!   allocate (diag_di(ims:ime, kms:kme,n_iceCat))    ! mean-mass ice diameter           [m]<a name='598'></font>
<font color=#447700>!   allocate (diag_vmi(ims:ime, kms:kme,n_iceCat))   ! fall speed (mass-weighted), ice  [m s-1]<a name='599'></font>
<font color=#447700>!   allocate (diag_rhopo(ims:ime, kms:kme,n_iceCat)) ! bulk density, ice                [kg m-3]<a name='600'></font>
<font color=#447700>!   allocate (diag_effi(ims:ime, kms:kme,n_iceCat))  ! effective radius, ice            [m]<a name='601'></font>
<font color=#447700>!   allocate (diag_ss(ims:ime, kms:kme,n_diag_ss))   ! user-defined diagnostic fields<a name='602'></font>
<a name='603'>
   <font color=#447700>!------------------------------------------------------------------------------------------!<a name='604'></font>
<a name='605'>
   log_predictNc=.false.<a name='606'>
   if (present(nc_3d)) log_predictNc = .true.<a name='607'>
<a name='608'>
   do j = jts,jte      <font color=#447700>! j loop (north-south)<a name='609'></font>
<a name='610'>
      if (log_predictNc) then<a name='611'>
         nc(its:ite,kts:kte)=nc_3d(its:ite,kts:kte,j)<a name='612'>
     <font color=#447700>! if Nc is specified then set nc array to zero<a name='613'></font>
      else<a name='614'>
         nc=0.<a name='615'>
      endif<a name='616'>
<a name='617'>
     <font color=#447700>! note: code for prediction of ssat not currently avaiable, set 2D array to 0<a name='618'></font>
      ssat=0.<a name='619'>
<a name='620'>
    <font color=#447700>!contruct full ice arrays from individual category arrays:<a name='621'></font>
<font color=#447700>!      qitot(its:ite,kts:kte,1) = qi1_3d(its:ite,kts:kte,j)<a name='622'></font>
<font color=#447700>!      qirim(its:ite,kts:kte,1) = qir1_3d(its:ite,kts:kte,j)<a name='623'></font>
<font color=#447700>!      nitot(its:ite,kts:kte,1) = qni1_3d(its:ite,kts:kte,j)<a name='624'></font>
<font color=#447700>!      birim(its:ite,kts:kte,1) = qib1_3d(its:ite,kts:kte,j)<a name='625'></font>
<a name='626'>
  <font color=#447700>!    if (n_iceCat .ge. 2) then<a name='627'></font>
  <font color=#447700>!       qitot(:,:,2) = qi2_3d(:,:,j)<a name='628'></font>
  <font color=#447700>!       qirim(:,:,2) = qir2_3d(:,:,j)<a name='629'></font>
  <font color=#447700>!       nitot(:,:,2) = qni2_3d(:,:,j)<a name='630'></font>
  <font color=#447700>!       birim(:,:,2) = qib2_3d(:,:,j)<a name='631'></font>
  <font color=#447700>!      if (n_iceCat .ge. 3) then<a name='632'></font>
  <font color=#447700>!         qitot(:,:,3) = qi33d(:,:,j)<a name='633'></font>
  <font color=#447700>!         qirim(:,:,3) = qg33d(:,:,j)<a name='634'></font>
  <font color=#447700>!         nitot(:,:,3) = qni33d(:,:,j)<a name='635'></font>
  <font color=#447700>!         birim(:,:,3) = qvolg33d(:,:,j)<a name='636'></font>
  <font color=#447700>!         if (n_iceCat == 4) then<a name='637'></font>
  <font color=#447700>!            qitot(:,:,4) = qi43d(:,:,j)<a name='638'></font>
  <font color=#447700>!            qirim(:,:,4) = qg43d(:,:,j)<a name='639'></font>
  <font color=#447700>!            nitot(:,:,4) = qni43d(:,:,j)<a name='640'></font>
  <font color=#447700>!            birim(:,:,4) = qvolg43d(:,:,j)<a name='641'></font>
  <font color=#447700>!         endif<a name='642'></font>
  <font color=#447700>!      endif<a name='643'></font>
  <font color=#447700>!    endif<a name='644'></font>
<a name='645'>
      call <A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN'>P3_MAIN</A><A href='../../html_code/phys/module_mp_p3.F.html#MP_P3_WRAPPER_WRF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="P3_MAIN_1">(qc_3d(its:ite,kts:kte,j),nc(its:ite,kts:kte),                                       &amp;<a name='646'>
              qr_3d(its:ite,kts:kte,j),qnr_3d(its:ite,kts:kte,j),                                      &amp;<a name='647'>
              th_old_3d(its:ite,kts:kte,j),th_3d(its:ite,kts:kte,j),qv_old_3d(its:ite,kts:kte,j),      &amp;<a name='648'>
              qv_3d(its:ite,kts:kte,j),dt,qi1_3d(its:ite,kts:kte,j),                                   &amp;<a name='649'>
              qir1_3d(its:ite,kts:kte,j),qni1_3d(its:ite,kts:kte,j),                                   &amp;<a name='650'>
              qib1_3d(its:ite,kts:kte,j),ssat(its:ite,kts:kte),                                        &amp;<a name='651'>
              W(its:ite,kts:kte,j),P(its:ite,kts:kte,j),                                               &amp;<a name='652'>
              DZ(its:ite,kts:kte,j),itimestep,pcprt_liq,pcprt_sol,its,ite,kts,kte,nk_bottom,n_iceCat,  &amp;<a name='653'>
              diag_zdbz_3d(its:ite,kts:kte,j),diag_effc_3d(its:ite,kts:kte,j),                         &amp;<a name='654'>
              diag_effi_3d(its:ite,kts:kte,j),n_diag_ss,diag_ss(its:ite,kts:kte,1:n_diag_ss),          &amp;<a name='655'>
              log_predictNc)<a name='656'>
<a name='657'>
     <font color=#447700>!surface precipitation output:<a name='658'></font>
      dum1 = 1000.*dt<a name='659'>
      RAINNC(its:ite,j)  = RAINNC(its:ite,j) + pcprt_liq(:)*dum1  <font color=#447700>! conversion from m/s to mm/time step<a name='660'></font>
      RAINNCV(its:ite,j) = pcprt_liq(:)*dum1                      <font color=#447700>! conversion from m/s to mm/time step<a name='661'></font>
      SNOWNC(its:ite,j)  = SNOWNC(its:ite,j) + pcprt_sol(:)*dum1  <font color=#447700>! conversion from m/s to mm/time step<a name='662'></font>
      SNOWNCV(its:ite,j) = pcprt_sol(:)*dum1                      <font color=#447700>! conversion from m/s to mm/time step<a name='663'></font>
      SR(its:ite,j)      = pcprt_sol(:)/(pcprt_liq(:)+1.E-12)     <font color=#447700>! solid-to-liquid ratio<a name='664'></font>
<a name='665'>
    <font color=#447700>!convert nc array from 2D to 3D if Nc is predicted<a name='666'></font>
      if (log_predictNc) then<a name='667'>
         nc_3d(its:ite,kts:kte,j)=nc(its:ite,kts:kte)<a name='668'>
      endif<a name='669'>
<a name='670'>
    <font color=#447700>!set background effective radii (i.e. with no explicit condensate) to prescribed values:<a name='671'></font>
    <font color=#447700>!  where (qc_3d(:,:,j) &lt; 1.e-14) diag_effc_3d(:,:,j) = 10.e-6<a name='672'></font>
    <font color=#447700>!  where (qitot &lt; 1.e-14) diag_effi = 25.e-6<a name='673'></font>
<a name='674'>
    <font color=#447700>!decompose full ice arrays into individual category arrays:<a name='675'></font>
<font color=#447700>!      qi1_3d(its:ite,kts:kte,j)  = qitot(its:ite,kts:kte,1)<a name='676'></font>
<font color=#447700>!      qir1_3d(its:ite,kts:kte,j) = qirim(its:ite,kts:kte,1)<a name='677'></font>
<font color=#447700>!      qni1_3d(its:ite,kts:kte,j) = nitot(its:ite,kts:kte,1)<a name='678'></font>
<font color=#447700>!      qib1_3d(its:ite,kts:kte,j) = birim(its:ite,kts:kte,1)<a name='679'></font>
<a name='680'>
    <font color=#447700>!diagnostic fields for output:<a name='681'></font>
<font color=#447700>!      if (n_iceCat .eq. 1) then<a name='682'></font>
         diag_vmi_3d(its:ite,kts:kte,j)   = diag_ss(its:ite,kts:kte,1)<a name='683'>
         diag_di_3d(its:ite,kts:kte,j)    = diag_ss(its:ite,kts:kte,2)<a name='684'>
         diag_rhopo_3d(its:ite,kts:kte,j) = diag_ss(its:ite,kts:kte,3)<a name='685'>
<font color=#447700>!      endif<a name='686'></font>
<a name='687'>
    <font color=#447700>!decompose full ice arrays into individual category arrays:<a name='688'></font>
<font color=#447700>!      qi1_3d(:,:,j)  = qitot(:,:,1)<a name='689'></font>
<font color=#447700>!      qir1_3d(:,:,j) = qirim(:,:,1)<a name='690'></font>
<font color=#447700>!      qni1_3d(:,:,j) = nitot(:,:,1)<a name='691'></font>
<font color=#447700>!      qib1_3d(:,:,j) = birim(:,:,1)<a name='692'></font>
<a name='693'>
<font color=#447700>!      if (n_iceCat .eq. 1) then<a name='694'></font>
<font color=#447700>!         diag_vmi_3d(:,:,j)   = diag_vmi(:,:,1)<a name='695'></font>
<font color=#447700>!         diag_di_3d(:,:,j)    = diag_di(:,:,1)<a name='696'></font>
<font color=#447700>!         diag_rhopo_3d(:,:,j) = diag_rhopo(:,:,1)<a name='697'></font>
<font color=#447700>!         diag_effi_3d(:,:,j)  = diag_effi(:,:,1)<a name='698'></font>
<font color=#447700>!      endif<a name='699'></font>
<a name='700'>
 <font color=#447700>!     if (n_iceCat .ge. 2) then<a name='701'></font>
<a name='702'>
 <font color=#447700>!        qi2_3d(:,:,j)  = qitot(:,:,2)<a name='703'></font>
 <font color=#447700>!        qir2_3d(:,:,j) = qirim(:,:,2)<a name='704'></font>
 <font color=#447700>!        qni2_3d(:,:,j) = nitot(:,:,2)<a name='705'></font>
 <font color=#447700>!        qib2_3d(:,:,j) = birim(:,:,2)<a name='706'></font>
<a name='707'>
 <font color=#447700>!        do i=its,ite<a name='708'></font>
 <font color=#447700>!           do k=kts,kte<a name='709'></font>
 <font color=#447700>!<a name='710'></font>
 <font color=#447700>!        ! for output fallspeed, size, and density, use mass-weighting of categories<a name='711'></font>
 <font color=#447700>!     ! ****NOTE: this is only for two categories, needs to be modified for more than 2<a name='712'></font>
 <font color=#447700>!           if ((qitot(i,k,1)+qitot(i,k,2)).ge.qsmall) then<a name='713'></font>
 <font color=#447700>!              diag_vmi_3d(i,k,j) = (diag_vmi(i,k,1)*qitot(i,k,1)+diag_vmi(i,k,2)*qitot(i,k,2))/(qitot(i,k,1)+qitot(i,k,2))<a name='714'></font>
 <font color=#447700>!              diag_di_3d(i,k,j) = (diag_di(i,k,1)*qitot(i,k,1)+diag_di(i,k,2)*qitot(i,k,2))/(qitot(i,k,1)+qitot(i,k,2))<a name='715'></font>
 <font color=#447700>!              diag_rhopo_3d(i,k,j) = (diag_rhopo(i,k,1)*qitot(i,k,1)+diag_rhopo(i,k,2)*qitot(i,k,2))/(qitot(i,k,1)+qitot(i,k,2))<a name='716'></font>
 <font color=#447700>!           else  ! set to default values of 0 if ice is not present<a name='717'></font>
 <font color=#447700>!              diag_vmi_3d(i,k,j) = 0.<a name='718'></font>
 <font color=#447700>!              diag_di_3d(i,k,j) = 0.<a name='719'></font>
 <font color=#447700>!              diag_rhopo_3d(i,k,j) = 0.<a name='720'></font>
 <font color=#447700>!           end if<a name='721'></font>
 <font color=#447700>!<a name='722'></font>
 <font color=#447700>!           ! for the combined effective radius, we need to approriately weight by mass and projected area<a name='723'></font>
 <font color=#447700>!           if (qitot(i,k,1).ge.qsmall) then<a name='724'></font>
 <font color=#447700>!              dum1=qitot(i,k,1)/diag_effi(i,k,1)<a name='725'></font>
 <font color=#447700>!           else<a name='726'></font>
 <font color=#447700>!              dum1=0.<a name='727'></font>
 <font color=#447700>!           end if<a name='728'></font>
 <font color=#447700>!           if (qitot(i,k,2).ge.qsmall) then<a name='729'></font>
 <font color=#447700>!              dum2=qitot(i,k,2)/diag_effi(i,k,2)<a name='730'></font>
 <font color=#447700>!           else<a name='731'></font>
 <font color=#447700>!              dum2=0.<a name='732'></font>
 <font color=#447700>!           end if<a name='733'></font>
 <font color=#447700>!           diag_effi_3d(i,k,j)=25.e-6  ! set to default 25 microns<a name='734'></font>
 <font color=#447700>!           if (qitot(i,k,1).ge.qsmall.or.qitot(i,k,2).ge.qsmall) then<a name='735'></font>
 <font color=#447700>!              diag_effi_3d(i,k,j)=(qitot(i,k,1)+qitot(i,k,2))/(dum1+dum2)<a name='736'></font>
 <font color=#447700>!           end if<a name='737'></font>
 <font color=#447700>!<a name='738'></font>
 <font color=#447700>!           end do<a name='739'></font>
 <font color=#447700>!        end do<a name='740'></font>
 <font color=#447700>!<a name='741'></font>
 <font color=#447700>!        if (n_iceCat .ge. 3) then<a name='742'></font>
 <font color=#447700>!<a name='743'></font>
 <font color=#447700>!           qi33d(:,:,j)    = qitot(:,:,3)<a name='744'></font>
 <font color=#447700>!           qg33d(:,:,j)    = qirim(:,:,3)<a name='745'></font>
 <font color=#447700>!           qni33d(:,:,j)   = nitot(:,:,3)<a name='746'></font>
 <font color=#447700>!           qvolg33d(:,:,j) = birim(:,:,3)<a name='747'></font>
 <font color=#447700>!<a name='748'></font>
 <font color=#447700>!           if (n_iceCat == 4) then<a name='749'></font>
 <font color=#447700>!              qi43d(:,:,j)    = qitot(:,:,4)<a name='750'></font>
 <font color=#447700>!              qg43d(:,:,j)    = qirim(:,:,4)<a name='751'></font>
 <font color=#447700>!              qni43d(:,:,j)   = nitot(:,:,4)<a name='752'></font>
 <font color=#447700>!              qvolg43d(:,:,j) = birim(:,:,4)<a name='753'></font>
 <font color=#447700>!           endif<a name='754'></font>
 <font color=#447700>!<a name='755'></font>
 <font color=#447700>!        endif   !if n_iceCat.ge.3<a name='756'></font>
<a name='757'>
 <font color=#447700>!     endif  !if n_iceCat.ge.2<a name='758'></font>
<a name='759'>
   enddo <font color=#447700>! j loop<a name='760'></font>
<a name='761'>
 <font color=#447700>!  deallocate (qitot,qirim,nitot,birim,diag_di,diag_vmi,diag_rhopo,diag_effi,diag_ss)<a name='762'></font>
<a name='763'>
   END SUBROUTINE mp_p3_wrapper_wrf<a name='764'>
<a name='765'>
<font color=#447700>!==================================================================================================!<a name='766'></font>
<a name='767'>
<font color=#447700>!-- note: to compile with WRF or kin_1d, comment full subroutine and uncomment the following:<a name='768'></font>
<font color=#447700>!         (since mp_p3_wrapper_gem contains some GEM-specific code)<a name='769'></font>
<a name='770'>
<A NAME='MP_P3_WRAPPER_GEM'><A href='../../html_code/phys/module_mp_p3.F.html#MP_P3_WRAPPER_GEM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='771'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>mp_p3_wrapper_gem</font><a name='772'>
  END SUBROUTINE mp_p3_wrapper_gem<a name='773'>
<font color=#447700>!==<a name='774'></font>
<a name='775'>
<font color=#447700>! ! !  SUBROUTINE mp_p3_wrapper_gem(qvap_m,qvap,temp_m,temp,dt,ww,psfc,sigma,kount,trnch,ni,nk, &amp;<a name='776'></font>
<font color=#447700>! ! !                               prt_liq,prt_sol,diag_Zet,diag_Zec,diag_effc,qc,nc,qr,nr,    &amp;<a name='777'></font>
<font color=#447700>! ! !                               n_iceCat,n_diag_ss,diag_ss,                                 &amp;<a name='778'></font>
<font color=#447700>! ! !                               qitot_1,qirim_1,nitot_1,birim_1,diag_effi_1,                &amp;<a name='779'></font>
<font color=#447700>! ! !                               qitot_2,qirim_2,nitot_2,birim_2,diag_effi_2,                &amp;<a name='780'></font>
<font color=#447700>! ! !                               qitot_3,qirim_3,nitot_3,birim_3,diag_effi_3,                &amp;<a name='781'></font>
<font color=#447700>! ! !                               qitot_4,qirim_4,nitot_4,birim_4,diag_effi_4)<a name='782'></font>
<font color=#447700>! ! !<a name='783'></font>
<font color=#447700>! ! ! !------------------------------------------------------------------------------------------!<a name='784'></font>
<font color=#447700>! ! ! ! This wrapper subroutine is the main GEM interface with the P3 microphysics scheme.  It   !<a name='785'></font>
<font color=#447700>! ! ! ! prepares some necessary fields (converts temperature to potential temperature, etc.),    !<a name='786'></font>
<font color=#447700>! ! ! ! passes 2D slabs (i,k) to the main microphysics subroutine ('P3_MAIN') -- which updates   !<a name='787'></font>
<font color=#447700>! ! ! ! the prognostic variables (hydrometeor variables, temperature, and water vapor) and       !<a name='788'></font>
<font color=#447700>! ! ! ! computes various diagnostics fields (precipitation rates, reflectivity, etc.) -- and     !<a name='789'></font>
<font color=#447700>! ! ! ! finally converts the updated potential temperature to temperature.                       !<a name='790'></font>
<font color=#447700>! ! ! !------------------------------------------------------------------------------------------!<a name='791'></font>
<font color=#447700>! ! !<a name='792'></font>
<font color=#447700>! ! !  implicit none<a name='793'></font>
<font color=#447700>! ! !<a name='794'></font>
<font color=#447700>! ! ! !----- input/ouput arguments:  ------------------------------------------------------------!<a name='795'></font>
<font color=#447700>! ! !<a name='796'></font>
<font color=#447700>! ! !  integer, intent(in)                    :: ni                    ! number of columns in slab           -<a name='797'></font>
<font color=#447700>! ! !  integer, intent(in)                    :: nk                    ! number of vertical levels           -<a name='798'></font>
<font color=#447700>! ! !  integer, intent(in)                    :: n_iceCat              ! number of ice categories            -<a name='799'></font>
<font color=#447700>! ! !  integer, intent(in)                    :: kount                 ! time step counter                   -<a name='800'></font>
<font color=#447700>! ! !  integer, intent(in)                    :: trnch                 ! number of slice                     -<a name='801'></font>
<font color=#447700>! ! !  integer, intent(in)                    :: n_diag_ss             ! number of diagnostic fields<a name='802'></font>
<font color=#447700>! ! !  real, intent(in)                       :: dt                    ! model time step                     s<a name='803'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: qc                    ! cloud mixing ratio, mass            kg kg-1<a name='804'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: nc                    ! cloud mixing ratio, number          #  kg-1<a name='805'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: qr                    ! rain  mixing ratio, mass            kg kg-1<a name='806'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: nr                    ! rain  mixing ratio, number          #  kg-1<a name='807'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: qitot_1               ! ice   mixing ratio, mass (total)    kg kg-1<a name='808'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: qirim_1               ! ice   mixing ratio, mass (rime)     kg kg-1<a name='809'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: nitot_1               ! ice   mixing ratio, number          #  kg-1<a name='810'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: birim_1               ! ice   mixing ratio, volume          m3 kg-1<a name='811'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni,nk)  :: diag_effi_1           ! ice   effective radius, (cat 1)     m<a name='812'></font>
<font color=#447700>! ! !<a name='813'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: qitot_2     ! ice   mixing ratio, mass (total)    kg kg-1<a name='814'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: qirim_2     ! ice   mixing ratio, mass (rime)     kg kg-1<a name='815'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: nitot_2     ! ice   mixing ratio, number          #  kg-1<a name='816'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: birim_2     ! ice   mixing ratio, volume          m3 kg-1<a name='817'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni,nk), optional  :: diag_effi_2 ! ice   effective radius, (cat 2)     m<a name='818'></font>
<font color=#447700>! ! !<a name='819'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: qitot_3     ! ice   mixing ratio, mass (total)    kg kg-1<a name='820'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: qirim_3     ! ice   mixing ratio, mass (rime)     kg kg-1<a name='821'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: nitot_3     ! ice   mixing ratio, number          #  kg-1<a name='822'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: birim_3     ! ice   mixing ratio, volume          m3 kg-1<a name='823'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni,nk), optional  :: diag_effi_3 ! ice   effective radius,  (cat 3)     m<a name='824'></font>
<font color=#447700>! ! !<a name='825'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: qitot_4     ! ice   mixing ratio, mass (total)    kg kg-1<a name='826'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: qirim_4     ! ice   mixing ratio, mass (rime)     kg kg-1<a name='827'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: nitot_4     ! ice   mixing ratio, number          #  kg-1<a name='828'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk), optional  :: birim_4     ! ice   mixing ratio, volume          m3 kg-1<a name='829'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni,nk), optional  :: diag_effi_4 ! ice   effective radius, (cat 4)     m<a name='830'></font>
<font color=#447700>! ! !<a name='831'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: qvap_m                ! vapor mixing ratio (previous time) kg kg-1<a name='832'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: qvap                  ! vapor mixing ratio, mass           kg kg-1<a name='833'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: temp_m                ! temperature (previous time step)    K<a name='834'></font>
<font color=#447700>! ! !  real, intent(inout), dimension(ni,nk)  :: temp                  ! temperature                         K<a name='835'></font>
<font color=#447700>! ! !  real, intent(in),    dimension(ni)     :: psfc                  ! surface air pressure                Pa<a name='836'></font>
<font color=#447700>! ! !  real, intent(in),    dimension(ni,nk)  :: sigma                 ! sigma = p(k,:)/psfc(:)<a name='837'></font>
<font color=#447700>! ! !  real, intent(in),    dimension(ni,nk)  :: ww                    ! vertical motion                     m s-1<a name='838'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni)     :: prt_liq               ! precipitation rate, liquid          m s-1<a name='839'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni)     :: prt_sol               ! precipitation rate, solid           m s-1<a name='840'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni,nk)  :: diag_Zet              ! equivalent reflectivity, 3D         dBZ<a name='841'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni)     :: diag_Zec              ! equivalent reflectivity, col-max    dBZ<a name='842'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni,nk)  :: diag_effc             ! effective radius, cloud             m<a name='843'></font>
<font color=#447700>! ! !  real, intent(out),   dimension(ni,nk,n_diag_ss) :: diag_ss      ! user-defined diagnostic fields<a name='844'></font>
<font color=#447700>! ! !<a name='845'></font>
<font color=#447700>! ! ! !----------------------------------------------------------------------------------------!<a name='846'></font>
<font color=#447700>! ! !<a name='847'></font>
<font color=#447700>! ! ! !----- local variables and parameters:<a name='848'></font>
<font color=#447700>! ! !  real, dimension(ni,nk,n_iceCat)  :: qitot      ! ice mixing ratio, mass (total)          kg kg-1<a name='849'></font>
<font color=#447700>! ! !  real, dimension(ni,nk,n_iceCat)  :: qirim      ! ice mixing ratio, mass (rime)           kg kg-1<a name='850'></font>
<font color=#447700>! ! !  real, dimension(ni,nk,n_iceCat)  :: nitot      ! ice mixing ratio, number                #  kg-1<a name='851'></font>
<font color=#447700>! ! !  real, dimension(ni,nk,n_iceCat)  :: birim      ! ice mixing ratio, volume                m3 kg-1<a name='852'></font>
<font color=#447700>! ! !  real, dimension(ni,nk,n_iceCat)  :: diag_effi  ! effective radius, ice                   m<a name='853'></font>
<font color=#447700>! ! !<a name='854'></font>
<font color=#447700>! ! !  real, dimension(ni,nk)  :: theta_m             ! potential temperature (previous step)   K<a name='855'></font>
<font color=#447700>! ! !  real, dimension(ni,nk)  :: theta               ! potential temperature                   K<a name='856'></font>
<font color=#447700>! ! !  real, dimension(ni,nk)  :: pres                ! pressure                                Pa<a name='857'></font>
<font color=#447700>! ! !  real, dimension(ni,nk)  :: rho_air             ! air density                             kg m-3<a name='858'></font>
<font color=#447700>! ! !  real, dimension(ni,nk)  :: DP                  ! difference in pressure between levels   Pa<a name='859'></font>
<font color=#447700>! ! !  real, dimension(ni,nk)  :: DZ                  ! difference in height between levels     m<a name='860'></font>
<font color=#447700>! ! !  real, dimension(ni,nk)  :: ssat                ! supersaturation<a name='861'></font>
<font color=#447700>! ! !  logical, parameter      :: nk_BOTTOM = .true.  ! .true. for nk at bottom (GEM)<a name='862'></font>
<font color=#447700>! ! !  integer                 :: i,k,ktop,kbot,kdir,i_strt,k_strt<a name='863'></font>
<font color=#447700>! ! !<a name='864'></font>
<font color=#447700>! ! !  logical, parameter      :: log_predictNc = .true.   !temporary; to be put as GEM namelist<a name='865'></font>
<font color=#447700>! ! ! !----------------------------------------------------------------------------------------!<a name='866'></font>
<font color=#447700>! ! !<a name='867'></font>
<font color=#447700>! ! !    include "thermoconsts.inc"<a name='868'></font>
<font color=#447700>! ! !<a name='869'></font>
<font color=#447700>! ! !    i_strt = 1  ! beginning index of slab<a name='870'></font>
<font color=#447700>! ! !    k_strt = 1  ! beginning index of column<a name='871'></font>
<font color=#447700>! ! !<a name='872'></font>
<font color=#447700>! ! !   !for nk_bottom = .true. :<a name='873'></font>
<font color=#447700>! ! !    ktop  = 1   ! k index of top level<a name='874'></font>
<font color=#447700>! ! !    kbot  = nk  ! k index of bottom level<a name='875'></font>
<font color=#447700>! ! !    kdir  = -1  ! direction of vertical leveling for 1=bottom, nk=top<a name='876'></font>
<font color=#447700>! ! !<a name='877'></font>
<font color=#447700>! ! !  ! note: code for prediction of ssat not currently avaiable, thus array is to 0<a name='878'></font>
<font color=#447700>! ! !    ssat = 0.<a name='879'></font>
<font color=#447700>! ! !<a name='880'></font>
<font color=#447700>! ! !   !air pressure:<a name='881'></font>
<font color=#447700>! ! !    do k = kbot,ktop,kdir<a name='882'></font>
<font color=#447700>! ! !       pres(:,k)= psfc(:)*sigma(:,k)<a name='883'></font>
<font color=#447700>! ! !    enddo<a name='884'></font>
<font color=#447700>! ! !<a name='885'></font>
<font color=#447700>! ! !   !air density:<a name='886'></font>
<font color=#447700>! ! !    rho_air  = pres/(RGASD*temp)<a name='887'></font>
<font color=#447700>! ! !<a name='888'></font>
<font color=#447700>! ! !   !pressure difference between levels:<a name='889'></font>
<font color=#447700>! ! !    DP(:,kbot) = psfc(:)-pres(:,kbot)<a name='890'></font>
<font color=#447700>! ! !    do k = kbot+kdir,ktop,kdir<a name='891'></font>
<font color=#447700>! ! !       DP(:,k) = pres(:,k-kdir)-pres(:,k)<a name='892'></font>
<font color=#447700>! ! !    enddo<a name='893'></font>
<font color=#447700>! ! !<a name='894'></font>
<font color=#447700>! ! !   !thickness of layers for sedimentation calculation: (in height coordiates)<a name='895'></font>
<font color=#447700>! ! !    DZ = DP/(rho_air*GRAV)<a name='896'></font>
<font color=#447700>! ! !<a name='897'></font>
<font color=#447700>! ! !   !convert to potential temperature:<a name='898'></font>
<font color=#447700>! ! !    theta_m = temp_m*(1.e+5/pres)**0.286<a name='899'></font>
<font color=#447700>! ! !    theta = temp*(1.e+5/pres)**0.286<a name='900'></font>
<font color=#447700>! ! !<a name='901'></font>
<font color=#447700>! ! !   !contruct full ice arrays from individual category arrays:<a name='902'></font>
<font color=#447700>! ! !    qitot(:,:,1) = qitot_1(:,:)<a name='903'></font>
<font color=#447700>! ! !    qirim(:,:,1) = qirim_1(:,:)<a name='904'></font>
<font color=#447700>! ! !    nitot(:,:,1) = nitot_1(:,:)<a name='905'></font>
<font color=#447700>! ! !    birim(:,:,1) = birim_1(:,:)<a name='906'></font>
<font color=#447700>! ! !<a name='907'></font>
<font color=#447700>! ! !    if (n_iceCat &gt;= 2) then<a name='908'></font>
<font color=#447700>! ! !       qitot(:,:,2) = qitot_2(:,:)<a name='909'></font>
<font color=#447700>! ! !       qirim(:,:,2) = qirim_2(:,:)<a name='910'></font>
<font color=#447700>! ! !       nitot(:,:,2) = nitot_2(:,:)<a name='911'></font>
<font color=#447700>! ! !       birim(:,:,2) = birim_2(:,:)<a name='912'></font>
<font color=#447700>! ! !<a name='913'></font>
<font color=#447700>! ! !       if (n_iceCat &gt;= 3) then<a name='914'></font>
<font color=#447700>! ! !          qitot(:,:,3) = qitot_3(:,:)<a name='915'></font>
<font color=#447700>! ! !          qirim(:,:,3) = qirim_3(:,:)<a name='916'></font>
<font color=#447700>! ! !          nitot(:,:,3) = nitot_3(:,:)<a name='917'></font>
<font color=#447700>! ! !          birim(:,:,3) = birim_3(:,:)<a name='918'></font>
<font color=#447700>! ! !<a name='919'></font>
<font color=#447700>! ! !          if (n_iceCat == 4) then<a name='920'></font>
<font color=#447700>! ! !             qitot(:,:,4) = qitot_4(:,:)<a name='921'></font>
<font color=#447700>! ! !             qirim(:,:,4) = qirim_4(:,:)<a name='922'></font>
<font color=#447700>! ! !             nitot(:,:,4) = nitot_4(:,:)<a name='923'></font>
<font color=#447700>! ! !             birim(:,:,4) = birim_4(:,:)<a name='924'></font>
<font color=#447700>! ! !          endif<a name='925'></font>
<font color=#447700>! ! !       endif<a name='926'></font>
<font color=#447700>! ! !    endif<a name='927'></font>
<font color=#447700>! ! !<a name='928'></font>
<font color=#447700>! ! !    call p3_main(qc,nc,qr,nr,theta_m,theta,qvap_m,qvap,dt,qitot,qirim,nitot,birim,ssat,ww,  &amp;<a name='929'></font>
<font color=#447700>! ! !                 pres,DZ,kount,prt_liq,prt_sol,i_strt,ni,k_strt,nk,nk_bottom,n_iceCat,      &amp;<a name='930'></font>
<font color=#447700>! ! !                 diag_Zet,diag_effc,diag_effi,n_diag_ss,diag_ss,log_predictNc)<a name='931'></font>
<font color=#447700>! ! !<a name='932'></font>
<font color=#447700>! ! !   !decompose full ice arrays back into individual category arrays:<a name='933'></font>
<font color=#447700>! ! !    qitot_1(:,:) = qitot(:,:,1)<a name='934'></font>
<font color=#447700>! ! !    qirim_1(:,:) = qirim(:,:,1)<a name='935'></font>
<font color=#447700>! ! !    nitot_1(:,:) = nitot(:,:,1)<a name='936'></font>
<font color=#447700>! ! !    birim_1(:,:) = birim(:,:,1)<a name='937'></font>
<font color=#447700>! ! !    diag_effi_1(:,:) = diag_effi(:,:,1)<a name='938'></font>
<font color=#447700>! ! !<a name='939'></font>
<font color=#447700>! ! !    if (n_iceCat &gt;= 2) then<a name='940'></font>
<font color=#447700>! ! !       qitot_2(:,:) = qitot(:,:,2)<a name='941'></font>
<font color=#447700>! ! !       qirim_2(:,:) = qirim(:,:,2)<a name='942'></font>
<font color=#447700>! ! !       nitot_2(:,:) = nitot(:,:,2)<a name='943'></font>
<font color=#447700>! ! !       birim_2(:,:) = birim(:,:,2)<a name='944'></font>
<font color=#447700>! ! !       diag_effi_2(:,:) = diag_effi(:,:,2)<a name='945'></font>
<font color=#447700>! ! !<a name='946'></font>
<font color=#447700>! ! !       if (n_iceCat &gt;= 3) then<a name='947'></font>
<font color=#447700>! ! !          qitot_3(:,:) = qitot(:,:,3)<a name='948'></font>
<font color=#447700>! ! !          qirim_3(:,:) = qirim(:,:,3)<a name='949'></font>
<font color=#447700>! ! !          nitot_3(:,:) = nitot(:,:,3)<a name='950'></font>
<font color=#447700>! ! !          birim_3(:,:) = birim(:,:,3)<a name='951'></font>
<font color=#447700>! ! !          diag_effi_3(:,:) = diag_effi(:,:,3)<a name='952'></font>
<font color=#447700>! ! !<a name='953'></font>
<font color=#447700>! ! !          if (n_iceCat == 4) then<a name='954'></font>
<font color=#447700>! ! !             qitot_4(:,:) = qitot(:,:,4)<a name='955'></font>
<font color=#447700>! ! !             qirim_4(:,:) = qirim(:,:,4)<a name='956'></font>
<font color=#447700>! ! !             nitot_4(:,:) = nitot(:,:,4)<a name='957'></font>
<font color=#447700>! ! !             birim_4(:,:) = birim(:,:,4)<a name='958'></font>
<font color=#447700>! ! !             diag_effi_4(:,:) = diag_effi(:,:,4)<a name='959'></font>
<font color=#447700>! ! !          endif<a name='960'></font>
<font color=#447700>! ! !       endif<a name='961'></font>
<font color=#447700>! ! !    endif<a name='962'></font>
<font color=#447700>! ! !<a name='963'></font>
<font color=#447700>! ! !   !convert back to temperature:<a name='964'></font>
<font color=#447700>! ! !    temp = theta*(pres*1.e-5)**0.286<a name='965'></font>
<font color=#447700>! ! !<a name='966'></font>
<font color=#447700>! ! !   !convert precip rates from volume flux (m s-1) to mass flux (kg m-3 s-1):<a name='967'></font>
<font color=#447700>! ! !   ! (since they are computed back to liq-eqv volume flux in s/r 'ccdiagnostics.F90')<a name='968'></font>
<font color=#447700>! ! !    prt_liq = prt_liq*1000.<a name='969'></font>
<font color=#447700>! ! !    prt_sol = prt_sol*1000.<a name='970'></font>
<font color=#447700>! ! !<a name='971'></font>
<font color=#447700>! ! !   !compute composite (column-maximum) reflectivity:<a name='972'></font>
<font color=#447700>! ! !    do i = 1,ni<a name='973'></font>
<font color=#447700>! ! !       diag_Zec(i) = maxval(diag_Zet(i,:))<a name='974'></font>
<font color=#447700>! ! !    enddo<a name='975'></font>
<font color=#447700>! ! !<a name='976'></font>
<font color=#447700>! ! !  END SUBROUTINE mp_p3_wrapper_gem<a name='977'></font>
<a name='978'>
<font color=#447700>!==========================================================================================!<a name='979'></font>
<a name='980'>
<A NAME='P3_MAIN'><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='981'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>P3_MAIN</font>(qc,nc,qr,nr,th_old,th,qv_old,qv,dt,qitot,qirim,nitot,birim,ssat,uzpl,   &amp; <A href='../../call_to/P3_MAIN.html' TARGET='index'>1</A>,<A href='../../call_from/P3_MAIN.html' TARGET='index'>63</A><a name='982'>
                    pres,dzq,it,pcprt_liq,pcprt_sol,its,ite,kts,kte,nk_bottom,nCat,diag_ze, &amp;<a name='983'>
                    diag_effc,diag_effi,n_diag_ss,diag_ss,log_predictNc)<a name='984'>
<a name='985'>
<font color=#447700>!----------------------------------------------------------------------------------------!<a name='986'></font>
<font color=#447700>!                                                                                        !<a name='987'></font>
<font color=#447700>! This is the main subroutine for the P3 microphysics scheme.  It is called from the     !<a name='988'></font>
<font color=#447700>! wrapper subroutine ('MP_P3_WRAPPER') and is passed i,k slabs of all prognostic         !<a name='989'></font>
<font color=#447700>! variables -- hydrometeor fields, potential temperature, and water vapor mixing ratio.  !<a name='990'></font>
<font color=#447700>! Microphysical process rates are computed first.  These tendencies are then used to     !<a name='991'></font>
<font color=#447700>! computed updated values of the prognostic variables.  The hydrometeor variables are    !<a name='992'></font>
<font color=#447700>! then updated further due to sedimentation.                                             !<a name='993'></font>
<font color=#447700>!                                                                                        !<a name='994'></font>
<font color=#447700>! Several diagnostic values are also computed and returned to the wrapper subroutine,    !<a name='995'></font>
<font color=#447700>! including precipitation rates.                                                         !<a name='996'></font>
<font color=#447700>!                                                                                        !<a name='997'></font>
<font color=#447700>!----------------------------------------------------------------------------------------!<a name='998'></font>
<a name='999'>
 implicit none<a name='1000'>
<a name='1001'>
<font color=#447700>!----- Input/ouput arguments:  ----------------------------------------------------------!<a name='1002'></font>
<a name='1003'>
 real, intent(inout), dimension(its:ite,kts:kte)      :: qc         <font color=#447700>! cloud, mass mixing ratio         kg kg-1<a name='1004'></font>
<font color=#447700>! note: Nc may be specified or predicted (set by log_predictNc)<a name='1005'></font>
 real, intent(inout), dimension(its:ite,kts:kte)      :: nc         <font color=#447700>! cloud, number mixing ratio       #  kg-1<a name='1006'></font>
 real, intent(inout), dimension(its:ite,kts:kte)      :: qr         <font color=#447700>! rain, mass mixing ratio          kg kg-1<a name='1007'></font>
 real, intent(inout), dimension(its:ite,kts:kte)      :: nr         <font color=#447700>! rain, number mixing ratio        #  kg-1<a name='1008'></font>
 real, intent(inout), dimension(its:ite,kts:kte,nCat) :: qitot      <font color=#447700>! ice, total mass mixing ratio     kg kg-1<a name='1009'></font>
 real, intent(inout), dimension(its:ite,kts:kte,nCat) :: qirim      <font color=#447700>! ice, rime mass mixing ratio      kg kg-1<a name='1010'></font>
 real, intent(inout), dimension(its:ite,kts:kte,nCat) :: nitot      <font color=#447700>! ice, total number mixing ratio   #  kg-1<a name='1011'></font>
 real, intent(inout), dimension(its:ite,kts:kte,nCat) :: birim      <font color=#447700>! ice, rime volume mixing ratio    m3 kg-1<a name='1012'></font>
 real, intent(inout), dimension(its:ite,kts:kte)      :: ssat       <font color=#447700>! supersaturation (i.e., qv-qvs)   kg kg-1<a name='1013'></font>
<a name='1014'>
 real, intent(inout), dimension(its:ite,kts:kte)      :: qv         <font color=#447700>! water vapor mixing ratio         kg kg-1<a name='1015'></font>
 real, intent(inout), dimension(its:ite,kts:kte)      :: th         <font color=#447700>! potential temperature            K<a name='1016'></font>
<font color=#447700>!- WRF:<a name='1017'></font>
 real, intent(inout), dimension(its:ite,kts:kte)      :: th_old     <font color=#447700>! beginning of time step value of theta K<a name='1018'></font>
 real, intent(inout), dimension(its:ite,kts:kte)      :: qv_old     <font color=#447700>! beginning of time step value of qv    kg kg-1<a name='1019'></font>
<font color=#447700>!- GEM:<a name='1020'></font>
<font color=#447700>!real, intent(in),    dimension(its:ite,kts:kte)      :: th_old     ! beginning of time step value of theta K<a name='1021'></font>
<font color=#447700>!real, intent(in),    dimension(its:ite,kts:kte)      :: qv_old     ! beginning of time step value of qv    kg kg-1<a name='1022'></font>
<font color=#447700>!=<a name='1023'></font>
 real, intent(in),    dimension(its:ite,kts:kte)      :: uzpl       <font color=#447700>! vertical air velocity            m s-1<a name='1024'></font>
 real, intent(in),    dimension(its:ite,kts:kte)      :: pres       <font color=#447700>! pressure                         Pa<a name='1025'></font>
 real, intent(in),    dimension(its:ite,kts:kte)      :: dzq        <font color=#447700>! vertical grid spacing            m<a name='1026'></font>
 real, intent(in)                                     :: dt         <font color=#447700>! model time step                  s<a name='1027'></font>
<a name='1028'>
 real, intent(out),   dimension(its:ite)              :: pcprt_liq  <font color=#447700>! precipitation rate, liquid       m s-1<a name='1029'></font>
 real, intent(out),   dimension(its:ite)              :: pcprt_sol  <font color=#447700>! precipitation rate, solid        m s-1<a name='1030'></font>
 real, intent(out),   dimension(its:ite,kts:kte)      :: diag_ze    <font color=#447700>! equivalent reflectivity          dBZ<a name='1031'></font>
 real, intent(out),   dimension(its:ite,kts:kte)      :: diag_effc  <font color=#447700>! effective radius, cloud          m<a name='1032'></font>
 real, intent(out),   dimension(its:ite,kts:kte,nCat) :: diag_effi  <font color=#447700>! effective radius, ice            m<a name='1033'></font>
 real, intent(out),   dimension(its:ite,kts:kte,n_diag_ss)  :: diag_ss <font color=#447700>! user-defined diagnostic fields<a name='1034'></font>
<a name='1035'>
 integer, intent(in)                                  :: its,ite    <font color=#447700>! array bounds (horizontal)<a name='1036'></font>
 integer, intent(in)                                  :: kts,kte    <font color=#447700>! array bounds (vertical)<a name='1037'></font>
 integer, intent(in)                                  :: it         <font color=#447700>! time step counter NOTE: starts at 1 for first time step<a name='1038'></font>
 integer, intent(in)                                  :: nCat       <font color=#447700>! number of ice-phase categories<a name='1039'></font>
 integer, intent(in)                                  :: n_diag_ss  <font color=#447700>! number of diagnostic fields<a name='1040'></font>
<a name='1041'>
 logical, intent(in)                                  :: nk_bottom     <font color=#447700>! .F. -&gt; nk at top (WRF) / .T. -&gt; nk at bottom (GEM)<a name='1042'></font>
 logical, intent(in)                                  :: log_predictNc <font color=#447700>! .T. (.F.) for prediction (specification) of Nc<a name='1043'></font>
<a name='1044'>
<font color=#447700>!----- Local variables and parameters:  -------------------------------------------------!<a name='1045'></font>
<a name='1046'>
 real, dimension(its:ite,kts:kte) :: mu_r  <font color=#447700>! shape parameter of rain<a name='1047'></font>
 real, dimension(its:ite,kts:kte) :: t     <font color=#447700>! temperature at the beginning of the microhpysics step [K]<a name='1048'></font>
 real, dimension(its:ite,kts:kte) :: t_old <font color=#447700>! temperature at the beginning of the model time step [K]<a name='1049'></font>
<a name='1050'>
<font color=#447700>! 2D size distribution and fallspeed parameters:<a name='1051'></font>
<a name='1052'>
 real, dimension(its:ite,kts:kte) :: lamc<a name='1053'>
 real, dimension(its:ite,kts:kte) :: lamr<a name='1054'>
 real, dimension(its:ite,kts:kte) :: n0c<a name='1055'>
 real, dimension(its:ite,kts:kte) :: logn0r<a name='1056'>
 real, dimension(its:ite,kts:kte) :: mu_c<a name='1057'>
<font color=#447700>!real, dimension(its:ite,kts:kte) :: diag_effr   (currently not used)<a name='1058'></font>
 real, dimension(its:ite,kts:kte) :: nu<a name='1059'>
 real, dimension(its:ite,kts:kte) :: cdist<a name='1060'>
 real, dimension(its:ite,kts:kte) :: cdist1<a name='1061'>
 real, dimension(its:ite,kts:kte) :: cdistr<a name='1062'>
 real, dimension(its:ite,kts:kte) :: Vt_nc<a name='1063'>
 real, dimension(its:ite,kts:kte) :: Vt_qc<a name='1064'>
 real, dimension(its:ite,kts:kte) :: Vt_nr<a name='1065'>
 real, dimension(its:ite,kts:kte) :: Vt_qr<a name='1066'>
 real, dimension(its:ite,kts:kte) :: Vt_qit<a name='1067'>
 real, dimension(its:ite,kts:kte) :: Vt_nit<a name='1068'>
<font color=#447700>!real, dimension(its:ite,kts:kte) :: Vt_zit<a name='1069'></font>
<a name='1070'>
<font color=#447700>! liquid-phase microphysical process rates:<a name='1071'></font>
<font color=#447700>!  (all Q process rates in kg kg-1 s-1)<a name='1072'></font>
<font color=#447700>!  (all N process rates in # kg-1)<a name='1073'></font>
<a name='1074'>
 real :: qrcon   <font color=#447700>! rain condensation<a name='1075'></font>
 real :: qcacc   <font color=#447700>! cloud droplet accretion by rain<a name='1076'></font>
 real :: qcaut   <font color=#447700>! cloud droplet autoconversion to rain<a name='1077'></font>
 real :: ncacc   <font color=#447700>! change in cloud droplet number from accretion by rain<a name='1078'></font>
 real :: ncautc  <font color=#447700>! change in cloud droplet number from autoconversion<a name='1079'></font>
 real :: ncslf   <font color=#447700>! change in cloud droplet number from self-collection<a name='1080'></font>
 real :: nrslf   <font color=#447700>! change in rain number from self-collection<a name='1081'></font>
 real :: ncnuc   <font color=#447700>! change in cloud droplet number from activation of CCN<a name='1082'></font>
 real :: qccon   <font color=#447700>! cloud droplet condensation<a name='1083'></font>
 real :: qcnuc   <font color=#447700>! activation of cloud droplets from CCN<a name='1084'></font>
 real :: qrevp   <font color=#447700>! rain evaporation<a name='1085'></font>
 real :: qcevp   <font color=#447700>! cloud droplet evaporation<a name='1086'></font>
 real :: nrevp   <font color=#447700>! change in rain number from evaporation<a name='1087'></font>
 real :: ncautr  <font color=#447700>! change in rain number from autoconversion of cloud water<a name='1088'></font>
<a name='1089'>
<font color=#447700>! ice-phase microphysical process rates:<a name='1090'></font>
<font color=#447700>!  (all Q process rates in kg kg-1 s-1)<a name='1091'></font>
<font color=#447700>!  (all N process rates in # kg-1)<a name='1092'></font>
<a name='1093'>
 real, dimension(nCat) :: qccol     <font color=#447700>! collection of cloud water by ice<a name='1094'></font>
 real, dimension(nCat) :: qwgrth    <font color=#447700>! wet growth rate<a name='1095'></font>
 real, dimension(nCat) :: qidep     <font color=#447700>! vapor deposition<a name='1096'></font>
 real, dimension(nCat) :: qrcol     <font color=#447700>! collection rain mass by ice<a name='1097'></font>
 real, dimension(nCat) :: qinuc     <font color=#447700>! deposition/condensation freezing nuc<a name='1098'></font>
 real, dimension(nCat) :: nccol     <font color=#447700>! change in cloud droplet number from collection by ice<a name='1099'></font>
 real, dimension(nCat) :: nrcol     <font color=#447700>! change in rain number from collection by ice<a name='1100'></font>
 real, dimension(nCat) :: ninuc     <font color=#447700>! change in ice number from deposition/cond-freezing nucleation<a name='1101'></font>
 real, dimension(nCat) :: qisub     <font color=#447700>! sublimation of ice<a name='1102'></font>
 real, dimension(nCat) :: qimlt     <font color=#447700>! melting of ice<a name='1103'></font>
 real, dimension(nCat) :: nimlt     <font color=#447700>! melting of ice<a name='1104'></font>
 real, dimension(nCat) :: nisub     <font color=#447700>! change in ice number from sublimation<a name='1105'></font>
 real, dimension(nCat) :: nislf     <font color=#447700>! change in ice number from collection within a category<a name='1106'></font>
 real, dimension(nCat) :: qchetc    <font color=#447700>! contact freezing droplets<a name='1107'></font>
 real, dimension(nCat) :: qcheti    <font color=#447700>! immersion freezing droplets<a name='1108'></font>
 real, dimension(nCat) :: qrhetc    <font color=#447700>! contact freezing rain<a name='1109'></font>
 real, dimension(nCat) :: qrheti    <font color=#447700>! immersion freezing rain<a name='1110'></font>
 real, dimension(nCat) :: nchetc    <font color=#447700>! contact freezing droplets<a name='1111'></font>
 real, dimension(nCat) :: ncheti    <font color=#447700>! immersion freezing droplets<a name='1112'></font>
 real, dimension(nCat) :: nrhetc    <font color=#447700>! contact freezing rain<a name='1113'></font>
 real, dimension(nCat) :: nrheti    <font color=#447700>! immersion freezing rain<a name='1114'></font>
 real, dimension(nCat) :: nrshdr    <font color=#447700>! source for rain number from collision of rain/ice above freezing and shedding<a name='1115'></font>
 real, dimension(nCat) :: qcshd     <font color=#447700>! source for rain mass due to cloud water/ice collision above freezing and shedding or wet growth and shedding<a name='1116'></font>
 real, dimension(nCat) :: qcmul     <font color=#447700>! change in q, ice multiplication from rime-splitnering of cloud water (not included in the paper)<a name='1117'></font>
 real, dimension(nCat) :: qrmul     <font color=#447700>! change in q, ice multiplication from rime-splitnering of rain (not included in the paper)<a name='1118'></font>
 real, dimension(nCat) :: nimul     <font color=#447700>! change in Ni, ice multiplication from rime-splintering (not included in the paper)<a name='1119'></font>
 real, dimension(nCat) :: ncshdc    <font color=#447700>! source for rain number due to cloud water/ice collision above freezing  and shedding (combined with NRSHD in the paper)<a name='1120'></font>
 real, dimension(nCat) :: rhorime_c <font color=#447700>! density of rime (from cloud)<a name='1121'></font>
 real, dimension(nCat) :: rhorime_r <font color=#447700>! density of rime (from rain)<a name='1122'></font>
<a name='1123'>
 real, dimension(nCat,nCat) :: nicol <font color=#447700>! change of N due to ice-ice collision between categories<a name='1124'></font>
 real, dimension(nCat,nCat) :: qicol <font color=#447700>! change of q due to ice-ice collision between categories<a name='1125'></font>
<a name='1126'>
 real, dimension(its:ite,kts:kte,nCat) :: diag_vmi,diag_di,diag_rhopo <font color=#447700>!collected locally, but passed out through diag_ss<a name='1127'></font>
<a name='1128'>
 logical, dimension(nCat)   :: log_wetgrowth<a name='1129'>
<a name='1130'>
 real, dimension(nCat) :: Eii_fact,epsi<a name='1131'>
 real :: eii <font color=#447700>! temperature dependent aggregation efficiency<a name='1132'></font>
<a name='1133'>
 real, dimension(its:ite,kts:kte,nCat) :: diam_ice<a name='1134'>
<a name='1135'>
 real, dimension(its:ite,kts:kte)      :: inv_dzq,inv_rho,ze_ice,ze_rain,prec,rho,       &amp;<a name='1136'>
            rhofacr,rhofaci,acn,xxls,xxlv,xlf,qvs,qvi,sup,supi,ss,vtrmi1,vtrnitot,       &amp;<a name='1137'>
            tmparr1<a name='1138'>
<a name='1139'>
 real, dimension(kts:kte) :: dum_qit,dum_qr,dum_nit,dum_qir,dum_bir,dum_zit,dum_nr,      &amp;<a name='1140'>
            dum_qc,dum_nc,V_qr,V_qit,V_nit,V_nr,V_qc,V_nc,V_zit,flux_qr,flux_qit,        &amp;<a name='1141'>
            flux_nit,flux_nr,flux_qir,flux_bir,flux_zit,flux_qc,flux_nc,tend_qc,tend_qr, &amp;<a name='1142'>
            tend_nr,tend_qit,tend_qir,tend_bir,tend_nit,tend_nc <font color=#447700>!,tend_zit<a name='1143'></font>
<a name='1144'>
 real    :: lammax,lammin,mu,dv,sc,dqsdt,ab,kap,epsr,epsc,xx,aaa,epsilon,sigvl,epsi_tot, &amp;<a name='1145'>
            aact,alpha,gamm,gg,psi,eta1,eta2,sm1,sm2,smax,uu1,uu2,dum,dum0,dum1,dum2,    &amp;<a name='1146'>
            dumqv,dumqvs,dums,dumqc,ratio,qsat0,udiff,dum3,dum4,dum5,dum6,lamold,rdumii, &amp;<a name='1147'>
            rdumjj,dqsidt,abi,dumqvi,dap,nacnt,rhop,v_impact,ri,iTc,D_c,D_r,dumlr,tmp1,  &amp;<a name='1148'>
            tmp2,tmp3,inv_nstep,inv_dum,inv_dum3,odt,oxx,oabi,zero,test,test2,test3,     &amp;<a name='1149'>
            onstep,fluxdiv_qr,fluxdiv_qit,fluxdiv_nit,fluxdiv_qir,fluxdiv_bir,           &amp;<a name='1150'>
            fluxdiv_zit,fluxdiv_qc,fluxdiv_nc,fluxdiv_nr,rgvm,D_new,Q_nuc,N_nuc,         &amp;<a name='1151'>
            deltaD_init,dum1c,dum4c,dum5c,dumt,qcon_satadj,qdep_satadj,sources,sinks,    &amp;<a name='1152'>
            drhop,timeScaleFactor<a name='1153'>
<a name='1154'>
 integer :: dumi,i,k,kk,ii,jj,iice,iice_dest,j,dumk,dumj,dumii,dumjj,dumzz,n,nstep,      &amp;<a name='1155'>
            tmpint1,tmpint2,ktop,kbot,kdir,qcindex,qrindex,qiindex,dumic,dumiic,dumjjc,  &amp;<a name='1156'>
            catcoll<a name='1157'>
 logical :: log_nucleationPossible,log_hydrometeorsPresent,log_predictSsat,log_tmp1,     &amp;<a name='1158'>
            log_exitlevel,log_hmossopOn,log_qcpresent,log_qrpresent,log_qipresent,       &amp;<a name='1159'>
            log_ni_add<a name='1160'>
<a name='1161'>
<font color=#447700>! quantities related to process rates/parameters, interpolated from lookup tables:<a name='1162'></font>
<a name='1163'>
 real    :: f1pr01   <font color=#447700>! number-weighted fallspeed<a name='1164'></font>
 real    :: f1pr02   <font color=#447700>! mass-weighted fallspeed<a name='1165'></font>
 real    :: f1pr03   <font color=#447700>! ice collection within a category<a name='1166'></font>
 real    :: f1pr04   <font color=#447700>! collection of cloud water by ice<a name='1167'></font>
 real    :: f1pr05   <font color=#447700>! melting<a name='1168'></font>
 real    :: f1pr06   <font color=#447700>! effective radius<a name='1169'></font>
 real    :: f1pr07   <font color=#447700>! collection of rain number by ice<a name='1170'></font>
 real    :: f1pr08   <font color=#447700>! collection of rain mass by ice<a name='1171'></font>
 real    :: f1pr09   <font color=#447700>! minimum ice number (lambda limiter)<a name='1172'></font>
 real    :: f1pr10   <font color=#447700>! maximum ice number (lambda limiter)<a name='1173'></font>
 real    :: f1pr11   <font color=#447700>! not used<a name='1174'></font>
 real    :: f1pr12   <font color=#447700>! not used<a name='1175'></font>
 real    :: f1pr13   <font color=#447700>! reflectivity<a name='1176'></font>
 real    :: f1pr14   <font color=#447700>! melting (ventilation term)<a name='1177'></font>
 real    :: f1pr15   <font color=#447700>! mass-weighted mean diameter<a name='1178'></font>
 real    :: f1pr16   <font color=#447700>! mass-weighted mean particle density<a name='1179'></font>
 real    :: f1pr17   <font color=#447700>! ice-ice category collection change in number<a name='1180'></font>
 real    :: f1pr18   <font color=#447700>! ice-ice category collection change in mass<a name='1181'></font>
<a name='1182'>
 <font color=#447700>!--These will be added as namelist parameters in the future<a name='1183'></font>
 logical, parameter :: debug_ON     = .false.  <font color=#447700>!.true. to switch on debugging checks/traps throughout code<a name='1184'></font>
 logical, parameter :: debug_ABORT  = .false.  <font color=#447700>!.true. will result in forced abort in s/r 'check_values'<a name='1185'></font>
 <font color=#447700>!==<a name='1186'></font>
<a name='1187'>
<font color=#447700>!-----------------------------------------------------------------------------------!<a name='1188'></font>
<font color=#447700>!  End of variables/parameters declarations<a name='1189'></font>
<font color=#447700>!-----------------------------------------------------------------------------------!<a name='1190'></font>
<a name='1191'>
<font color=#447700>!-----------------------------------------------------------------------------------!<a name='1192'></font>
<font color=#447700>! Note, the array 'diag_ss(ni,nk,n_diag_ss)' provides a placeholder to output 3D diagnostic fields.<a name='1193'></font>
<font color=#447700>! The entire array array is inialized to zero (below).  Code can be added to store desired fields<a name='1194'></font>
<font color=#447700>! by simply adding the appropriate assignment statements.  For example, if one wishs to output the<a name='1195'></font>
<font color=#447700>! rain condensation and evaporation rates, simply add assignments in the appropriate locations.<a name='1196'></font>
<font color=#447700>!  e.g.:<a name='1197'></font>
<font color=#447700>!<a name='1198'></font>
<font color=#447700>!   diag_ss(i,k,1) = qrcon<a name='1199'></font>
<font color=#447700>!   diag_ss(i,k,2) = qrevp<a name='1200'></font>
<font color=#447700>!<a name='1201'></font>
<font color=#447700>! The fields will automatically be passed to the driving model.  In GEM, these arrays can be<a name='1202'></font>
<font color=#447700>! output by adding 'SS01' and 'SS02' to the model output list.<a name='1203'></font>
<font color=#447700>!-----------------------------------------------------------------------------------!<a name='1204'></font>
<a name='1205'>
<a name='1206'>
 <font color=#447700>!direction of vertical leveling:<a name='1207'></font>
 if (nk_bottom) then<a name='1208'>
   <font color=#447700>!GEM / kin_1d:<a name='1209'></font>
    ktop = kts        <font color=#447700>!k of top level<a name='1210'></font>
    kbot = kte        <font color=#447700>!k of bottom level<a name='1211'></font>
    kdir = -1         <font color=#447700>!(k: 1=top, nk=bottom)<a name='1212'></font>
 else<a name='1213'>
   <font color=#447700>!WRF / kin_2d:<a name='1214'></font>
    ktop = kte        <font color=#447700>!k of top level<a name='1215'></font>
    kbot = kts        <font color=#447700>!k of bottom level<a name='1216'></font>
    kdir = 1          <font color=#447700>!(k: 1=bottom, nk=top)<a name='1217'></font>
 endif<a name='1218'>
<a name='1219'>
<a name='1220'>
<font color=#447700>! Determine threshold size difference [m] as a function of nCat<a name='1221'></font>
<font color=#447700>! (used for destination category upon ice initiation)<a name='1222'></font>
<font color=#447700>! note -- this code could be moved to 'p3_init'<a name='1223'></font>
 select case (nCat)<a name='1224'>
    case (1)<a name='1225'>
       deltaD_init = 999.    <font color=#447700>!not used if n_iceCat=1 (but should be defined)<a name='1226'></font>
    case (2)<a name='1227'>
       deltaD_init = 500.e-6<a name='1228'>
    case (3)<a name='1229'>
       deltaD_init = 400.e-6<a name='1230'>
    case (4)<a name='1231'>
       deltaD_init = 235.e-6<a name='1232'>
    case (5)<a name='1233'>
       deltaD_init = 175.e-6<a name='1234'>
    case (6:)<a name='1235'>
       deltaD_init = 150.e-6<a name='1236'>
 end select<a name='1237'>
<a name='1238'>
<font color=#447700>! deltaD_init = 250.e-6   !for testing<a name='1239'></font>
<font color=#447700>! deltaD_init = dummy_in   !temporary; passed in from cld1d<a name='1240'></font>
<a name='1241'>
<font color=#447700>! Note:  Code for prediction of supersaturation is available in current version.<a name='1242'></font>
<font color=#447700>!        In the future 'log_predictSsat' will be a user-defined namelist key.<a name='1243'></font>
 log_predictSsat = .false.<a name='1244'>
<a name='1245'>
 log_hmossopOn   = (nCat.gt.1)      <font color=#447700>!default: off for nCat=1, off for nCat&gt;1<a name='1246'></font>
<font color=#447700>!log_hmossopOn   = .true.           !switch to have Hallet-Mossop ON<a name='1247'></font>
<font color=#447700>!log_hmossopOn   = .false.          !switch to have Hallet-Mossop OFF<a name='1248'></font>
<a name='1249'>
 inv_dzq    = 1./dzq  <font color=#447700>! inverse of thickness of layers<a name='1250'></font>
 odt        = 1./dt   <font color=#447700>! inverse model time step<a name='1251'></font>
<a name='1252'>
<font color=#447700>! Compute time scale factor over which to apply soft rain lambda limiter<a name='1253'></font>
<font color=#447700>! note: '1./max(30.,dt)' = '1.*min(1./30., 1./dt)'<a name='1254'></font>
 timeScaleFactor = min(1./120., odt)<a name='1255'>
<a name='1256'>
 pcprt_liq  = 0.<a name='1257'>
 pcprt_sol  = 0.<a name='1258'>
 prec       = 0.<a name='1259'>
 mu_r       = 0.<a name='1260'>
 diag_ze    = -99.<a name='1261'>
 diam_ice   = 0.<a name='1262'>
 ze_ice     = 1.e-22<a name='1263'>
 ze_rain    = 1.e-22<a name='1264'>
 diag_effc  = 10.e-6 <font color=#447700>! default value<a name='1265'></font>
<font color=#447700>!diag_effr  = 25.e-6 ! default value<a name='1266'></font>
 diag_effi  = 25.e-6 <font color=#447700>! default value<a name='1267'></font>
 diag_vmi   = 0.<a name='1268'>
 diag_di    = 0.<a name='1269'>
 diag_rhopo = 0.<a name='1270'>
 diag_ss    = 0.<a name='1271'>
 rhorime_c  = 400.<a name='1272'>
<font color=#447700>!rhorime_r  = 400.<a name='1273'></font>
<a name='1274'>
 tmparr1 = (pres*1.e-5)**(rd*inv_cp)<a name='1275'>
 t       = th    *tmparr1    <font color=#447700>!compute temperature from theta (value at beginning of microphysics step)<a name='1276'></font>
 t_old   = th_old*tmparr1    <font color=#447700>!compute temperature from theta (value at beginning of model time step)<a name='1277'></font>
 qv      = max(qv,0.)        <font color=#447700>!clip water vapor to prevent negative values passed in (beginning of microphysics)<a name='1278'></font>
<font color=#447700>!==<a name='1279'></font>
<font color=#447700>!-----------------------------------------------------------------------------------!<a name='1280'></font>
 i_loop_main: do i = its,ite  <font color=#447700>! main i-loop (around the entire scheme)<a name='1281'></font>
<a name='1282'>
    if (debug_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_14">(qv,T,qc,qr,nr,qitot,qirim,nitot,birim,i,it,.false.,debug_ABORT,100)<a name='1283'>
<a name='1284'>
    log_hydrometeorsPresent = .false.<a name='1285'>
    log_nucleationPossible  = .false.<a name='1286'>
<a name='1287'>
    k_loop_1: do k = kbot,ktop,kdir<a name='1288'>
<a name='1289'>
<font color=#447700>!-- To be deleted (moved to above)<a name='1290'></font>
<font color=#447700>! !      !calculate old temperature from old value of theta<a name='1291'></font>
<font color=#447700>! !        t_old(i,k) = th_old(i,k)*(pres(i,k)*1.e-5)**(rd*inv_cp)<a name='1292'></font>
<font color=#447700>! !      !calculate current temperature from current theta<a name='1293'></font>
<font color=#447700>! !        t(i,k) = th(i,k)*(pres(i,k)*1.e-5)**(rd*inv_cp)<a name='1294'></font>
<font color=#447700>!==<a name='1295'></font>
<a name='1296'>
     <font color=#447700>!calculate some time-varying atmospheric variables<a name='1297'></font>
       rho(i,k)     = pres(i,k)/(rd*t(i,k))<a name='1298'>
       inv_rho(i,k) = 1./rho(i,k)<a name='1299'>
       xxlv(i,k)    = 3.1484e6-2370.*t(i,k)<a name='1300'>
       xxls(i,k)    = xxlv(i,k)+0.3337e6<a name='1301'>
       xlf(i,k)     = xxls(i,k)-xxlv(i,k)<a name='1302'>
       qvs(i,k)     = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_1">(t_old(i,k),pres(i,k),0)<a name='1303'>
       qvi(i,k)     = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_2">(t_old(i,k),pres(i,k),1)<a name='1304'>
<a name='1305'>
      <font color=#447700>! if supersaturation is not predicted or during the first time step, then diagnose from qv and T (qvs)<a name='1306'></font>
       if (.not.(log_predictSsat).or.it.eq.1) then<a name='1307'>
          ssat(i,k)    = qv_old(i,k)-qvs(i,k)<a name='1308'>
          sup(i,k)     = qv_old(i,k)/qvs(i,k)-1.<a name='1309'>
          supi(i,k)    = qv_old(i,k)/qvi(i,k)-1.<a name='1310'>
      <font color=#447700>! if supersaturation is predicted then diagnose sup and supi from ssat<a name='1311'></font>
       else if ((log_predictSsat).and.it.gt.1) then<a name='1312'>
          sup(i,k)     = ssat(i,k)/qvs(i,k)<a name='1313'>
          supi(i,k)    = (ssat(i,k)+qvs(i,k)-qvi(i,k))/qvi(i,k)<a name='1314'>
       endif<a name='1315'>
<a name='1316'>
       rhofacr(i,k) = (rhosur*inv_rho(i,k))**0.54<a name='1317'>
       rhofaci(i,k) = (rhosui*inv_rho(i,k))**0.54<a name='1318'>
       dum          = 1.496e-6*t(i,k)**1.5/(t(i,k)+120.)  <font color=#447700>! this is mu<a name='1319'></font>
       acn(i,k)     = g*rhow/(18.*dum)  <font color=#447700>! 'a' parameter for droplet fallspeed (Stokes' law)<a name='1320'></font>
<a name='1321'>
      <font color=#447700>!specify cloud droplet number (for 1-moment version)<a name='1322'></font>
       if (.not.(log_predictNc)) then<a name='1323'>
          nc(i,k) = nccnst*inv_rho(i,k)<a name='1324'>
       endif<a name='1325'>
<a name='1326'>
       if ((t(i,k).lt.273.15 .and. supi(i,k).ge.-0.05) .or.                              &amp;<a name='1327'>
           (t(i,k).ge.273.15 .and. sup(i,k).ge.-0.05 )) log_nucleationPossible = .true.<a name='1328'>
<a name='1329'>
    <font color=#447700>!--- apply mass clipping if dry and mass is sufficiently small<a name='1330'></font>
    <font color=#447700>!    (implying all mass is expected to evaporate/sublimate in one time step)<a name='1331'></font>
<a name='1332'>
       if (qc(i,k).lt.qsmall .or. (qc(i,k).lt.1.e-8 .and. sup(i,k).lt.-0.1)) then<a name='1333'>
          qv(i,k) = qv(i,k) + qc(i,k)<a name='1334'>
          th(i,k) = th(i,k) - th(i,k)/t(i,k)*qc(i,k)*xxlv(i,k)*inv_cp<a name='1335'>
          qc(i,k) = 0.<a name='1336'>
          nc(i,k) = 0.<a name='1337'>
       else<a name='1338'>
          log_hydrometeorsPresent = .true.    <font color=#447700>! updated further down<a name='1339'></font>
       endif<a name='1340'>
<a name='1341'>
       if (qr(i,k).lt.qsmall .or. (qr(i,k).lt.1.e-8 .and. sup(i,k).lt.-0.1)) then<a name='1342'>
          qv(i,k) = qv(i,k) + qr(i,k)<a name='1343'>
          th(i,k) = th(i,k) - th(i,k)/t(i,k)*qr(i,k)*xxlv(i,k)*inv_cp<a name='1344'>
          qr(i,k) = 0.<a name='1345'>
          nr(i,k) = 0.<a name='1346'>
       else<a name='1347'>
          log_hydrometeorsPresent = .true.    <font color=#447700>! updated further down<a name='1348'></font>
       endif<a name='1349'>
<a name='1350'>
       do iice = 1,nCat<a name='1351'>
          if (qitot(i,k,iice).lt.qsmall .or. (qitot(i,k,iice).lt.1.e-8 .and.             &amp;<a name='1352'>
           supi(i,k).lt.-0.1)) then<a name='1353'>
             qv(i,k) = qv(i,k) + qitot(i,k,iice)<a name='1354'>
             th(i,k) = th(i,k) - th(i,k)/t(i,k)*qitot(i,k,iice)*xxls(i,k)*inv_cp<a name='1355'>
             qitot(i,k,iice) = 0.<a name='1356'>
             nitot(i,k,iice) = 0.<a name='1357'>
             qirim(i,k,iice) = 0.<a name='1358'>
             birim(i,k,iice) = 0.<a name='1359'>
          else<a name='1360'>
             log_hydrometeorsPresent = .true.    <font color=#447700>! final update<a name='1361'></font>
          endif<a name='1362'>
<a name='1363'>
          if (qitot(i,k,iice).ge.qsmall .and. qitot(i,k,iice).lt.1.e-8 .and.             &amp;<a name='1364'>
           t(i,k).ge.273.15) then<a name='1365'>
             qr(i,k) = qr(i,k) + qitot(i,k,iice)<a name='1366'>
             th(i,k) = th(i,k) - th(i,k)/t(i,k)*qitot(i,k,iice)*xlf(i,k)*inv_cp<a name='1367'>
             qitot(i,k,iice) = 0.<a name='1368'>
             nitot(i,k,iice) = 0.<a name='1369'>
             qirim(i,k,iice) = 0.<a name='1370'>
             birim(i,k,iice) = 0.<a name='1371'>
          endif<a name='1372'>
<a name='1373'>
       enddo  <font color=#447700>!iice-loop<a name='1374'></font>
<a name='1375'>
    <font color=#447700>!===<a name='1376'></font>
<a name='1377'>
    enddo k_loop_1<a name='1378'>
<a name='1379'>
    if (debug_ON) then<a name='1380'>
       tmparr1(i,:) = th(i,:)*(pres(i,:)*1.e-5)**(rd*inv_cp)<a name='1381'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_15">(qv,tmparr1,qc,qr,nr,qitot,qirim,nitot,birim,i,it,.true.,debug_ABORT,200)<a name='1382'>
    endif<a name='1383'>
<a name='1384'>
   <font color=#447700>!jump to end of i-loop if log_nucleationPossible=.false.  (i.e. skip everything)<a name='1385'></font>
    if (.not. (log_nucleationPossible .or. log_hydrometeorsPresent)) goto 333<a name='1386'>
<a name='1387'>
    log_hydrometeorsPresent = .false.   <font color=#447700>! reset value; used again below<a name='1388'></font>
<a name='1389'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='1390'></font>
<font color=#447700>!   main k-loop (for processes):<a name='1391'></font>
    k_loop_main: do k = kbot,ktop,kdir<a name='1392'>
<a name='1393'>
     <font color=#447700>! if relatively dry and no hydrometeors at this level, skip to end of k-loop (i.e. skip this level)<a name='1394'></font>
       log_exitlevel = .true.<a name='1395'>
       if (qc(i,k).ge.qsmall .or. qr(i,k).ge.qsmall) log_exitlevel = .false.<a name='1396'>
       do iice = 1,nCat<a name='1397'>
          if (qitot(i,k,iice).ge.qsmall) log_exitlevel = .false.<a name='1398'>
       enddo<a name='1399'>
       if (log_exitlevel .and.                                                           &amp;<a name='1400'>
          ((t(i,k).lt.273.15 .and. supi(i,k).lt.-0.05) .or.                              &amp;<a name='1401'>
           (t(i,k).ge.273.15 .and. sup(i,k) .lt.-0.05))) goto 555   <font color=#447700>!i.e. skip all process rates<a name='1402'></font>
<a name='1403'>
    <font color=#447700>! initialize warm-phase process rates<a name='1404'></font>
       qcacc   = 0.;     qrevp   = 0.;     qccon   = 0.<a name='1405'>
       qcaut   = 0.;     qcevp   = 0.;     qrcon   = 0.<a name='1406'>
       ncacc   = 0.;     ncnuc   = 0.;     ncslf   = 0.<a name='1407'>
       ncautc  = 0.;     qcnuc   = 0.;     nrslf   = 0.<a name='1408'>
       nrevp   = 0.;     ncautr  = 0.<a name='1409'>
<a name='1410'>
    <font color=#447700>! initialize ice-phase  process rates<a name='1411'></font>
       qchetc  = 0.;     qisub   = 0.;     nrshdr  = 0.<a name='1412'>
       qcheti  = 0.;     qrcol   = 0.;     qcshd   = 0.<a name='1413'>
       qrhetc  = 0.;     qimlt   = 0.;     qccol   = 0.<a name='1414'>
       qrheti  = 0.;     qinuc   = 0.;     nimlt   = 0.<a name='1415'>
       nchetc  = 0.;     nccol   = 0.;     ncshdc  = 0.<a name='1416'>
       ncheti  = 0.;     nrcol   = 0.;     nislf   = 0.<a name='1417'>
       nrhetc  = 0.;     ninuc   = 0.;     qidep   = 0.<a name='1418'>
       nrheti  = 0.;     nisub   = 0.;     qwgrth  = 0.<a name='1419'>
       qcmul   = 0.;     qrmul   = 0.;     nimul   = 0.<a name='1420'>
       qicol   = 0.;     nicol   = 0.<a name='1421'>
<a name='1422'>
       log_wetgrowth = .false.<a name='1423'>
<a name='1424'>
<font color=#447700>!----------------------------------------------------------------------<a name='1425'></font>
       predict_supersaturation: if (log_predictSsat) then<a name='1426'>
<a name='1427'>
      <font color=#447700>! Adjust cloud water and thermodynamics to prognostic supersaturation<a name='1428'></font>
      <font color=#447700>! following the method in Grabowski and Morrison (2008).<a name='1429'></font>
      <font color=#447700>! Note that the effects of vertical motion are assumed to dominate the<a name='1430'></font>
      <font color=#447700>! production term for supersaturation, and the effects are sub-grid<a name='1431'></font>
      <font color=#447700>! scale mixing and radiation are not explicitly included.<a name='1432'></font>
<a name='1433'>
          dqsdt   = xxlv(i,k)*qvs(i,k)/(rv*t(i,k)*t(i,k))<a name='1434'>
          ab      = 1. + dqsdt*xxlv(i,k)*inv_cp<a name='1435'>
          epsilon = (qv(i,k)-qvs(i,k)-ssat(i,k))/ab<a name='1436'>
          epsilon = max(epsilon,-qc(i,k))   <font color=#447700>! limit adjustment to available water<a name='1437'></font>
        <font color=#447700>! don't adjust upward if subsaturated<a name='1438'></font>
        <font color=#447700>! otherwise this could result in positive adjustment<a name='1439'></font>
        <font color=#447700>! (spurious generation ofcloud water) in subsaturated conditions<a name='1440'></font>
          if (ssat(i,k).lt.0.) epsilon = min(0.,epsilon)<a name='1441'>
<a name='1442'>
        <font color=#447700>! now do the adjustment<a name='1443'></font>
          if (abs(epsilon).ge.1.e-15) then<a name='1444'>
             qc(i,k)   = qc(i,k)+epsilon<a name='1445'>
             qv(i,k)   = qv(i,k)-epsilon<a name='1446'>
             th(i,k)   = th(i,k)+epsilon*th(i,k)/t(i,k)*xxlv(i,k)*inv_cp<a name='1447'>
            <font color=#447700>! recalculate variables if there was adjustment<a name='1448'></font>
             t(i,k)    = th(i,k)*(1.e-5*pres(i,k))**(rd*inv_cp)<a name='1449'>
             qvs(i,k)  = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_3">(t(i,k),pres(i,k),0)<a name='1450'>
             qvi(i,k)  = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_4">(t(i,k),pres(i,k),1)<a name='1451'>
             sup(i,k)  = qv(i,k)/qvs(i,k)-1.<a name='1452'>
             supi(i,k) = qv(i,k)/qvi(i,k)-1.<a name='1453'>
             ssat(i,k) = qv(i,k)-qvs(i,k)<a name='1454'>
          endif<a name='1455'>
<a name='1456'>
       endif predict_supersaturation<a name='1457'>
<font color=#447700>!----------------------------------------------------------------------<a name='1458'></font>
<a name='1459'>
<font color=#447700>! skip micro process calculations except nucleation/acvtivation if there no hydrometeors are present<a name='1460'></font>
       log_exitlevel = .true.<a name='1461'>
       if (qc(i,k).ge.qsmall .or. qr(i,k).ge.qsmall) log_exitlevel = .false.<a name='1462'>
       do iice = 1,nCat<a name='1463'>
          if (qitot(i,k,iice).ge.qsmall) log_exitlevel=.false.<a name='1464'>
       enddo<a name='1465'>
       if (log_exitlevel) goto 444   <font color=#447700>!i.e. skip to nucleation<a name='1466'></font>
<a name='1467'>
        <font color=#447700>!time/space varying physical variables<a name='1468'></font>
       mu     = 1.496e-6*t(i,k)**1.5/(t(i,k)+120.)<a name='1469'>
       dv     = 8.794e-5*t(i,k)**1.81/pres(i,k)<a name='1470'>
       sc     = mu/(rho(i,k)*dv)<a name='1471'>
       dum    = 1./(rv*t(i,k)**2)<a name='1472'>
       dqsdt  = xxlv(i,k)*qvs(i,k)*dum<a name='1473'>
       dqsidt = xxls(i,k)*qvi(i,k)*dum<a name='1474'>
       ab     = 1.+dqsdt*xxlv(i,k)*inv_cp<a name='1475'>
       abi    = 1.+dqsidt*xxls(i,k)*inv_cp<a name='1476'>
       kap    = 1.414e+3*mu<a name='1477'>
      <font color=#447700>! very simple temperature dependent aggregation efficiency<a name='1478'></font>
       if (t(i,k).lt.253.15) then<a name='1479'>
          eii=0.1<a name='1480'>
       else if (t(i,k).ge.253.15.and.t(i,k).lt.268.15) then<a name='1481'>
          eii=0.1+(t(i,k)-253.15)/15.*0.9  <font color=#447700>! linear ramp from 0.1 to 1 between 253.15 and 268.15 K<a name='1482'></font>
       else if (t(i,k).ge.268.15) then<a name='1483'>
          eii=1.<a name='1484'>
       end if<a name='1485'>
<a name='1486'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#GET_CLOUD_DSD'>get_cloud_dsd</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_DSD_1">(qc(i,k),nc(i,k),mu_c(i,k),rho(i,k),nu(i,k),dnu,lamc(i,k),      &amp;<a name='1487'>
                          lammin,lammax,k,cdist(i,k),cdist1(i,k),tmpint1,log_tmp1)<a name='1488'>
<a name='1489'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#GET_RAIN_DSD'>get_rain_dsd</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_RAIN_DSD_1">(qr(i,k),nr(i,k),mu_r(i,k),rdumii,dumii,lamr(i,k),mu_r_table,    &amp;<a name='1490'>
                         cdistr(i,k),logn0r(i,k),log_tmp1,tmpint1,tmpint2)<a name='1491'>
       <font color=#447700>!note: log_tmp1,tmpint1,tmpint2 are not used in this section<a name='1492'></font>
<a name='1493'>
     <font color=#447700>! initialize inverse supersaturation relaxation timescale for combined ice categories<a name='1494'></font>
       epsi_tot = 0.<a name='1495'>
<a name='1496'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#IMPOSE_MAX_TOTAL_NI'>impose_max_total_Ni</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IMPOSE_MAX_TOTAL_NI_1">(nitot(i,k,:),max_total_Ni,inv_rho(i,k))<a name='1497'>
<a name='1498'>
       iice_loop1: do iice = 1,nCat<a name='1499'>
<a name='1500'>
          if (qitot(i,k,iice).ge.qsmall) then<a name='1501'>
<a name='1502'>
            <font color=#447700>!impose lower limits to prevent taking log of # &lt; 0<a name='1503'></font>
             nitot(i,k,iice) = max(nitot(i,k,iice),nsmall)<a name='1504'>
             nr(i,k)         = max(nr(i,k),nsmall)<a name='1505'>
<a name='1506'>
            <font color=#447700>!compute mean-mass ice diameters (estimated; rigorous approach to be implemented later)<a name='1507'></font>
             dum2 = 500. <font color=#447700>!ice density<a name='1508'></font>
             diam_ice(i,k,iice) = ((qitot(i,k,iice)*6.)/(nitot(i,k,iice)*dum2*pi))**thrd<a name='1509'>
<a name='1510'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#CALC_BULKRHORIME'>calc_bulkRhoRime</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_BULKRHORIME_1">(qitot(i,k,iice),qirim(i,k,iice),birim(i,k,iice),rhop)<a name='1511'>
<a name='1512'>
           <font color=#447700>! if (.not. tripleMoment_on) zitot(i,k,iice) = diag_mom6(qitot(i,k,iice),nitot(i,k,iice),rho(i,k))<a name='1513'></font>
             call <A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_1A'>find_lookupTable_indices_1a</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_LOOKUPTABLE_INDICES_1A_1">(dumi,dumjj,dumii,dumzz,dum1,dum4,          &amp;<a name='1514'>
                                   dum5,dum6,isize,rimsize,densize,zsize,                &amp;<a name='1515'>
                                   qitot(i,k,iice),nitot(i,k,iice),qirim(i,k,iice),      &amp;<a name='1516'>
                                   999.,rhop)<a name='1517'>
                                  <font color=#447700>!qirim(i,k,iice),zitot(i,k,iice),rhop)<a name='1518'></font>
             call <A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_1B'>find_lookupTable_indices_1b</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_LOOKUPTABLE_INDICES_1B_1">(dumj,dum3,rcollsize,qr(i,k),nr(i,k))<a name='1519'>
<a name='1520'>
          <font color=#447700>! call to lookup table interpolation subroutines to get process rates<a name='1521'></font>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_1">(dumjj,dumii,dumi, 2,dum1,dum4,dum5,f1pr02)<a name='1522'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_2">(dumjj,dumii,dumi, 3,dum1,dum4,dum5,f1pr03)<a name='1523'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_3">(dumjj,dumii,dumi, 4,dum1,dum4,dum5,f1pr04)<a name='1524'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_4">(dumjj,dumii,dumi, 5,dum1,dum4,dum5,f1pr05)<a name='1525'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_5">(dumjj,dumii,dumi, 7,dum1,dum4,dum5,f1pr09)<a name='1526'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_6">(dumjj,dumii,dumi, 8,dum1,dum4,dum5,f1pr10)<a name='1527'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_7">(dumjj,dumii,dumi,10,dum1,dum4,dum5,f1pr14)<a name='1528'>
<a name='1529'>
          <font color=#447700>! ice-rain collection processes<a name='1530'></font>
             if (qr(i,k).ge.qsmall) then<a name='1531'>
                call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE_COLL'>access_lookup_table_coll</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_COLL_1">(dumjj,dumii,dumj,dumi,1,dum1,    &amp;<a name='1532'>
                                              dum3,dum4,dum5,f1pr07)<a name='1533'>
                call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE_COLL'>access_lookup_table_coll</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_COLL_2">(dumjj,dumii,dumj,dumi,2,dum1,    &amp;<a name='1534'>
                                              dum3,dum4,dum5,f1pr08)<a name='1535'>
             else<a name='1536'>
                f1pr07 = 0.<a name='1537'>
                f1pr08 = 0.<a name='1538'>
             endif<a name='1539'>
<a name='1540'>
          <font color=#447700>! adjust Ni if needed to make sure mean size is in bounds (i.e. apply lambda limiters)<a name='1541'></font>
          <font color=#447700>! note that the Nmax and Nmin are normalized and thus need to be multiplied by existing N<a name='1542'></font>
             nitot(i,k,iice) = min(nitot(i,k,iice),f1pr09*nitot(i,k,iice))<a name='1543'>
             nitot(i,k,iice) = max(nitot(i,k,iice),f1pr10*nitot(i,k,iice))<a name='1544'>
<a name='1545'>
<a name='1546'>
          <font color=#447700>! Determine additional collection efficiency factor to be applied to ice-ice collection.<a name='1547'></font>
          <font color=#447700>! The computed values of qicol and nicol are multipiled by Eii_fact to gradually shut off collection<a name='1548'></font>
          <font color=#447700>! if the ice in iice is highly rimed.<a name='1549'></font>
             if (qirim(i,k,iice)&gt;0.) then<a name='1550'>
                tmp1 = qirim(i,k,iice)/qitot(i,k,iice)   <font color=#447700>!rime mass fraction<a name='1551'></font>
                if (tmp1.lt.0.6) then<a name='1552'>
                   Eii_fact(iice)=1.<a name='1553'>
                else if (tmp1.ge.0.6.and.tmp1.lt.0.9) then<a name='1554'>
          <font color=#447700>! linear ramp from 1 to 0 for Fr between 0.6 and 0.9<a name='1555'></font>
                   Eii_fact(iice) = 1.-(tmp1-0.6)/0.3<a name='1556'>
                else if (tmp1.ge.0.9) then<a name='1557'>
                   Eii_fact(iice) = 0.<a name='1558'>
                endif<a name='1559'>
             else<a name='1560'>
                Eii_fact(iice) = 1.<a name='1561'>
             endif<a name='1562'>
<a name='1563'>
          endif   <font color=#447700>! qitot &gt; qsmall<a name='1564'></font>
<a name='1565'>
<font color=#447700>!----------------------------------------------------------------------<a name='1566'></font>
<font color=#447700>! Begin calculations of microphysical processes<a name='1567'></font>
<a name='1568'>
<font color=#447700>!......................................................................<a name='1569'></font>
<font color=#447700>! ice processes<a name='1570'></font>
<font color=#447700>!......................................................................<a name='1571'></font>
<a name='1572'>
<font color=#447700>!.......................<a name='1573'></font>
<font color=#447700>! collection of droplets<a name='1574'></font>
<a name='1575'>
<font color=#447700>! here we multiply rates by air density, air density fallspeed correction<a name='1576'></font>
<font color=#447700>! factor, and collection efficiency since these parameters are not<a name='1577'></font>
<font color=#447700>! included in lookup table calculations<a name='1578'></font>
<font color=#447700>! for T &lt; 273.15, assume collected cloud water is instantly frozen<a name='1579'></font>
<font color=#447700>! note 'f1pr' values are normalized, so we need to multiply by N<a name='1580'></font>
<a name='1581'>
          if (qitot(i,k,iice).ge.qsmall .and. qc(i,k).ge.qsmall .and. t(i,k).le.273.15) then<a name='1582'>
             qccol(iice) = rhofaci(i,k)*f1pr04*qc(i,k)*eci*rho(i,k)*nitot(i,k,iice)<a name='1583'>
             nccol(iice) = rhofaci(i,k)*f1pr04*nc(i,k)*eci*rho(i,k)*nitot(i,k,iice)<a name='1584'>
          endif<a name='1585'>
<a name='1586'>
<font color=#447700>! for T &gt; 273.15, assume cloud water is collected and shed as rain drops<a name='1587'></font>
<a name='1588'>
          if (qitot(i,k,iice).ge.qsmall .and. qc(i,k).ge.qsmall .and. t(i,k).gt.273.15) then<a name='1589'>
          <font color=#447700>! sink for cloud water mass and number, note qcshed is source for rain mass<a name='1590'></font>
             qcshd(iice) = rhofaci(i,k)*f1pr04*qc(i,k)*eci*rho(i,k)*nitot(i,k,iice)<a name='1591'>
             nccol(iice) = rhofaci(i,k)*f1pr04*nc(i,k)*eci*rho(i,k)*nitot(i,k,iice)<a name='1592'>
          <font color=#447700>! source for rain number, assume 1 mm drops are shed<a name='1593'></font>
             ncshdc(iice) = qcshd(iice)*1.923e+6<a name='1594'>
          endif<a name='1595'>
<a name='1596'>
<font color=#447700>!....................<a name='1597'></font>
<font color=#447700>! collection of rain<a name='1598'></font>
<a name='1599'>
     <font color=#447700>! here we multiply rates by air density, air density fallspeed correction<a name='1600'></font>
     <font color=#447700>! factor, collection efficiency, and n0r since these parameters are not<a name='1601'></font>
     <font color=#447700>! included in lookup table calculations<a name='1602'></font>
<a name='1603'>
     <font color=#447700>! for T &lt; 273.15, assume all collected rain mass freezes<a name='1604'></font>
     <font color=#447700>! note this is a sink for rain mass and number and a source<a name='1605'></font>
     <font color=#447700>! for ice mass<a name='1606'></font>
<a name='1607'>
     <font color=#447700>! note 'f1pr' values are normalized, so we need to multiply by N<a name='1608'></font>
<a name='1609'>
          if (qitot(i,k,iice).ge.qsmall .and. qr(i,k).ge.qsmall .and. t(i,k).le.273.15) then<a name='1610'>
           <font color=#447700>! qrcol(iice)=f1pr08*logn0r(i,k)*rho(i,k)*rhofaci(i,k)*eri*nitot(i,k,iice)<a name='1611'></font>
           <font color=#447700>! nrcol(iice)=f1pr07*logn0r(i,k)*rho(i,k)*rhofaci(i,k)*eri*nitot(i,k,iice)<a name='1612'></font>
           <font color=#447700>! note: f1pr08 and logn0r are already calculated as log_10<a name='1613'></font>
             qrcol(iice) = 10.**(f1pr08+logn0r(i,k))*rho(i,k)*rhofaci(i,k)*eri*nitot(i,k,iice)<a name='1614'>
             nrcol(iice) = 10.**(f1pr07+logn0r(i,k))*rho(i,k)*rhofaci(i,k)*eri*nitot(i,k,iice)<a name='1615'>
       endif<a name='1616'>
<a name='1617'>
     <font color=#447700>! for T &gt; 273.15, assume collected rain number is shed as<a name='1618'></font>
     <font color=#447700>! 1 mm drops<a name='1619'></font>
     <font color=#447700>! note that melting of ice number is scaled to the loss<a name='1620'></font>
     <font color=#447700>! rate of ice mass due to melting<a name='1621'></font>
     <font color=#447700>! collection of rain above freezing does not impact total rain mass<a name='1622'></font>
<a name='1623'>
          if (qitot(i,k,iice).ge.qsmall .and. qr(i,k).ge.qsmall .and. t(i,k).gt.273.15) then<a name='1624'>
           <font color=#447700>! rain number sink due to collection<a name='1625'></font>
             nrcol(iice)  = 10.**(f1pr07 + logn0r(i,k))*rho(i,k)*rhofaci(i,k)*eri*nitot(i,k,iice)<a name='1626'>
           <font color=#447700>! rain number source due to shedding = collected rain mass/mass of 1 mm drop<a name='1627'></font>
             dum    = 10.**(f1pr08 + logn0r(i,k))*rho(i,k)*rhofaci(i,k)*eri*nitot(i,k,iice)<a name='1628'>
     <font color=#447700>! for now neglect shedding of ice collecting rain above freezing, since snow is<a name='1629'></font>
     <font color=#447700>! not expected to shed in these conditions (though more hevaily rimed ice would be<a name='1630'></font>
     <font color=#447700>! expected to lead to shedding)<a name='1631'></font>
     <font color=#447700>!             nrshdr(iice) = dum*1.923e+6   ! 1./5.2e-7, 5.2e-7 is the mass of a 1 mm raindrop<a name='1632'></font>
          endif<a name='1633'>
<a name='1634'>
<a name='1635'>
<font color=#447700>!...................................<a name='1636'></font>
<font color=#447700>! collection between ice categories<a name='1637'></font>
<a name='1638'>
          iceice_interaction1:  if (iice.ge.2) then<a name='1639'>
<font color=#447700>!         iceice_interaction1:  if (.false.) then       !test, to suppress ice-ice interaction<a name='1640'></font>
<a name='1641'>
             qitot_notsmall: if (qitot(i,k,iice).ge.qsmall) then<a name='1642'>
                catcoll_loop: do catcoll = 1,iice-1<a name='1643'>
                   qitotcatcoll_notsmall: if (qitot(i,k,catcoll).ge.qsmall) then<a name='1644'>
<a name='1645'>
                  <font color=#447700>! first, calculate collection of catcoll category by iice category<a name='1646'></font>
<a name='1647'>
                    <font color=#447700>! if (.not. tripleMoment_on) zitot(i,k,iice) = diag_mom6(qitot(i,k,iice),nitot(i,k,iice),rho(i,k))<a name='1648'></font>
<a name='1649'>
                      call <A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_2'>find_lookupTable_indices_2</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_LOOKUPTABLE_INDICES_2_1">(dumi,dumii,dumjj,dumic,dumiic,   &amp;<a name='1650'>
                                 dumjjc,dum1,dum4,dum5,dum1c,dum4c,dum5c,              &amp;<a name='1651'>
                                 iisize,rimsize,densize,                               &amp;<a name='1652'>
                                 qitot(i,k,iice),qitot(i,k,catcoll),nitot(i,k,iice),        &amp;<a name='1653'>
                                 nitot(i,k,catcoll),qirim(i,k,iice),qirim(i,k,catcoll),     &amp;<a name='1654'>
                                 birim(i,k,iice),birim(i,k,catcoll))<a name='1655'>
<a name='1656'>
                      call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE_COLLI'>access_lookup_table_colli</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_COLLI_1">(dumjjc,dumiic,dumic,dumjj,dumii,dumj,  &amp;<a name='1657'>
                                 dumi,1,dum1c,dum4c,dum5c,dum1,dum4,dum5,f1pr17)<a name='1658'>
                      call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE_COLLI'>access_lookup_table_colli</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_COLLI_2">(dumjjc,dumiic,dumic,dumjj,dumii,dumj,  &amp;<a name='1659'>
                                 dumi,2,dum1c,dum4c,dum5c,dum1,dum4,dum5,f1pr18)<a name='1660'>
<a name='1661'>
                    <font color=#447700>! note: need to multiply by air density, air density fallspeed correction factor,<a name='1662'></font>
                    <font color=#447700>!       and N of the collectee and collector categories for process rates nicol and qicol,<a name='1663'></font>
                    <font color=#447700>!       first index is the collectee, second is the collector<a name='1664'></font>
                      nicol(catcoll,iice) = f1pr17*rhofaci(i,k)*rhofaci(i,k)*rho(i,k)*     &amp;<a name='1665'>
                                            nitot(i,k,catcoll)*nitot(i,k,iice)<a name='1666'>
                      qicol(catcoll,iice) = f1pr18*rhofaci(i,k)*rhofaci(i,k)*rho(i,k)*     &amp;<a name='1667'>
                                            nitot(i,k,catcoll)*nitot(i,k,iice)<a name='1668'>
<a name='1669'>
                      nicol(catcoll,iice) = eii*Eii_fact(iice)*nicol(catcoll,iice)<a name='1670'>
                      qicol(catcoll,iice) = eii*Eii_fact(iice)*qicol(catcoll,iice)<a name='1671'>
                      nicol(catcoll,iice) = min(nicol(catcoll,iice), nitot(i,k,catcoll)*odt)<a name='1672'>
                      qicol(catcoll,iice) = min(qicol(catcoll,iice), qitot(i,k,catcoll)*odt)<a name='1673'>
                  <font color=#447700>! second, calculate collection of iice category by catcoll category<a name='1674'></font>
<a name='1675'>
                    <font color=#447700>! if (.not. tripleMoment_on) zitot(i,k,iice) = diag_mom6(qitot(i,k,iice),nitot(i,k,iice),rho(i,k))<a name='1676'></font>
<a name='1677'>
                    <font color=#447700>!needed to force consistency between qirim(catcoll) and birim(catcoll) (not for rhop)<a name='1678'></font>
                      call <A href='../../html_code/phys/module_mp_p3.F.html#CALC_BULKRHORIME'>calc_bulkRhoRime</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_BULKRHORIME_2">(qitot(i,k,catcoll),qirim(i,k,catcoll),birim(i,k,catcoll),rhop)<a name='1679'>
<a name='1680'>
                      call <A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_2'>find_lookupTable_indices_2</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_LOOKUPTABLE_INDICES_2_2">(dumi,dumii,dumjj,dumic,dumiic,  &amp;<a name='1681'>
                                 dumjjc,dum1,dum4,dum5,dum1c,dum4c,dum5c,             &amp;<a name='1682'>
                                 iisize,rimsize,densize,                              &amp;<a name='1683'>
                                 qitot(i,k,catcoll),qitot(i,k,iice),nitot(i,k,catcoll),    &amp;<a name='1684'>
                                 nitot(i,k,iice),qirim(i,k,catcoll),qirim(i,k,iice),       &amp;<a name='1685'>
                                 birim(i,k,catcoll),birim(i,k,iice))<a name='1686'>
<a name='1687'>
                      call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE_COLLI'>access_lookup_table_colli</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_COLLI_3">(dumjjc,dumiic,dumic,dumjj,dumii,dumj, &amp;<a name='1688'>
                                 dumi,1,dum1c,dum4c,dum5c,dum1,dum4,dum5,f1pr17)<a name='1689'>
<a name='1690'>
                      call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE_COLLI'>access_lookup_table_colli</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_COLLI_4">(dumjjc,dumiic,dumic,dumjj,dumii,dumj, &amp;<a name='1691'>
                                 dumi,2,dum1c,dum4c,dum5c,dum1,dum4,dum5,f1pr18)<a name='1692'>
<a name='1693'>
                      nicol(iice,catcoll) = f1pr17*rhofaci(i,k)*rhofaci(i,k)*rho(i,k)*     &amp;<a name='1694'>
                                            nitot(i,k,iice)*nitot(i,k,catcoll)<a name='1695'>
                      qicol(iice,catcoll) = f1pr18*rhofaci(i,k)*rhofaci(i,k)*rho(i,k)*     &amp;<a name='1696'>
                                            nitot(i,k,iice)*nitot(i,k,catcoll)<a name='1697'>
                     <font color=#447700>! note: Eii_fact applied to the collector category<a name='1698'></font>
                      nicol(iice,catcoll) = eii*Eii_fact(catcoll)*nicol(iice,catcoll)<a name='1699'>
                      qicol(iice,catcoll) = eii*Eii_fact(catcoll)*qicol(iice,catcoll)<a name='1700'>
                      nicol(iice,catcoll) = min(nicol(iice,catcoll),nitot(i,k,iice)*odt)<a name='1701'>
                      qicol(iice,catcoll) = min(qicol(iice,catcoll),qitot(i,k,iice)*odt)<a name='1702'>
<a name='1703'>
                   endif qitotcatcoll_notsmall<a name='1704'>
                enddo catcoll_loop<a name='1705'>
             endif qitot_notsmall<a name='1706'>
<a name='1707'>
          endif iceice_interaction1<a name='1708'>
<a name='1709'>
<a name='1710'>
<font color=#447700>!.............................................<a name='1711'></font>
<font color=#447700>! self-collection of ice (in a given category)<a name='1712'></font>
<a name='1713'>
    <font color=#447700>! here we multiply rates by collection efficiency, air density,<a name='1714'></font>
    <font color=#447700>! and air density correction factor since these are not included<a name='1715'></font>
    <font color=#447700>! in the lookup table calculations<a name='1716'></font>
    <font color=#447700>! note 'f1pr' values are normalized, so we need to multiply by N<a name='1717'></font>
<a name='1718'>
          if (qitot(i,k,iice).ge.qsmall) then<a name='1719'>
             nislf(iice) = f1pr03*rho(i,k)*eii*Eii_fact(iice)*rhofaci(i,k)*nitot(i,k,iice)<a name='1720'>
          endif<a name='1721'>
<a name='1722'>
<a name='1723'>
<font color=#447700>!............................................................<a name='1724'></font>
<font color=#447700>! melting<a name='1725'></font>
<a name='1726'>
    <font color=#447700>! need to add back accelerated melting due to collection of ice mass by rain (pracsw1)<a name='1727'></font>
    <font color=#447700>! note 'f1pr' values are normalized, so we need to multiply by N<a name='1728'></font>
<a name='1729'>
          if (qitot(i,k,iice).ge.qsmall .and. t(i,k).gt.273.15) then<a name='1730'>
             qsat0 = 0.622*e0/(pres(i,k)-e0)<a name='1731'>
          <font color=#447700>!  dum=cpw/xlf(i,k)*(t(i,k)-273.15)*(pracsw1+qcshd(iice))<a name='1732'></font>
          <font color=#447700>! currently enhanced melting from collision is neglected<a name='1733'></font>
          <font color=#447700>! dum=cpw/xlf(i,k)*(t(i,k)-273.15)*(pracsw1)<a name='1734'></font>
             dum = 0.<a name='1735'>
          <font color=#447700>! qimlt(iice)=(f1pr05+f1pr14*sc**0.3333*(rhofaci(i,k)*rho(i,k)/mu)**0.5)* &amp;<a name='1736'></font>
          <font color=#447700>!       (t(i,k)-273.15)*2.*pi*kap/xlf(i,k)+dum<a name='1737'></font>
          <font color=#447700>! include RH dependence<a name='1738'></font>
             qimlt(iice) = ((f1pr05+f1pr14*sc**thrd*(rhofaci(i,k)*rho(i,k)/mu)**0.5)*((t(i,k)-   &amp;<a name='1739'>
                          273.15)*kap-rho(i,k)*xxlv(i,k)*dv*(qsat0-qv(i,k)))*2.*pi/xlf(i,k)+     &amp;<a name='1740'>
                          dum)*nitot(i,k,iice)<a name='1741'>
             qimlt(iice) = max(qimlt(iice),0.)<a name='1742'>
<font color=#447700>!             qimlt(iice) = min(qimlt(iice),qitot(i,k,iice)*odt)<a name='1743'></font>
             nimlt(iice) = qimlt(iice)*(nitot(i,k,iice)/qitot(i,k,iice))<a name='1744'>
          endif<a name='1745'>
<a name='1746'>
<font color=#447700>!............................................................<a name='1747'></font>
<font color=#447700>! calculate wet growth<a name='1748'></font>
<a name='1749'>
    <font color=#447700>! similar to Musil (1970), JAS<a name='1750'></font>
    <font color=#447700>! note 'f1pr' values are normalized, so we need to multiply by N<a name='1751'></font>
<a name='1752'>
          if (qitot(i,k,iice).ge.qsmall .and. qc(i,k)+qr(i,k).ge.1.e-6 .and. t(i,k).lt.273.15) then<a name='1753'>
<a name='1754'>
             qsat0  = 0.622*e0/(pres(i,k)-e0)<a name='1755'>
             qwgrth(iice) = ((f1pr05 + f1pr14*sc**thrd*(rhofaci(i,k)*rho(i,k)/mu)**0.5)*       &amp;<a name='1756'>
                       2.*pi*(rho(i,k)*xxlv(i,k)*dv*(qsat0-qv(i,k))-(t(i,k)-273.15)*           &amp;<a name='1757'>
                       kap)/(xlf(i,k)+cpw*(t(i,k)-273.15)))*nitot(i,k,iice)<a name='1758'>
             qwgrth(iice) = max(qwgrth(iice),0.)<a name='1759'>
         <font color=#447700>!calculate shedding for wet growth<a name='1760'></font>
             dum    = max(0.,(qccol(iice)+qrcol(iice))-qwgrth(iice))<a name='1761'>
             if (dum.ge.1.e-10) then<a name='1762'>
                nrshdr(iice) = nrshdr(iice) + dum*1.923e+6   <font color=#447700>! 1/5.2e-7, 5.2e-7 is the mass of a 1 mm raindrop<a name='1763'></font>
                if ((qccol(iice)+qrcol(iice)).ge.1.e-10) then<a name='1764'>
                   dum1  = 1./(qccol(iice)+qrcol(iice))<a name='1765'>
                   qcshd(iice) = qcshd(iice) + dum*qccol(iice)*dum1<a name='1766'>
                   qccol(iice) = qccol(iice) - dum*qccol(iice)*dum1<a name='1767'>
                   qrcol(iice) = qrcol(iice) - dum*qrcol(iice)*dum1<a name='1768'>
               endif<a name='1769'>
             <font color=#447700>! densify due to wet growth<a name='1770'></font>
               log_wetgrowth(iice) = .true.<a name='1771'>
             endif<a name='1772'>
<a name='1773'>
          endif<a name='1774'>
<a name='1775'>
<a name='1776'>
<font color=#447700>!-----------------------------<a name='1777'></font>
<font color=#447700>! calcualte total inverse ice relaxation timescale combined for all ice categories<a name='1778'></font>
<font color=#447700>! note 'f1pr' values are normalized, so we need to multiply by N<a name='1779'></font>
          if (qitot(i,k,iice).ge.qsmall .and. t(i,k).lt.273.15) then<a name='1780'>
             epsi(iice) = ((f1pr05+f1pr14*sc**thrd*(rhofaci(i,k)*rho(i,k)/mu)**0.5)*2.*pi* &amp;<a name='1781'>
                          rho(i,k)*dv)*nitot(i,k,iice)<a name='1782'>
             epsi_tot   = epsi_tot + epsi(iice)<a name='1783'>
          else<a name='1784'>
             epsi(iice) = 0.<a name='1785'>
          endif<a name='1786'>
<a name='1787'>
<a name='1788'>
<font color=#447700>!.........................<a name='1789'></font>
<font color=#447700>! calculate rime density<a name='1790'></font>
<a name='1791'>
<font color=#447700>!     FUTURE:  Add source term for birim (=qccol/rhorime_c) so that all process rates calculations<a name='1792'></font>
<font color=#447700>!              are done together, before conservation.<a name='1793'></font>
<a name='1794'>
     <font color=#447700>! NOTE: Tc (ambient) is assumed for the surface temperature.  Technically,<a name='1795'></font>
     <font color=#447700>! we should diagose graupel surface temperature from heat balance equation.<a name='1796'></font>
     <font color=#447700>! (but the ambient temperature is a reasonable approximation; tests show<a name='1797'></font>
     <font color=#447700>! very little sensitivity to different assumed values, Milbrandt and Morrison 2012).<a name='1798'></font>
<a name='1799'>
      <font color=#447700>! Compute rime density: (based on parameterization of Cober and List, 1993 [JAS])<a name='1800'></font>
      <font color=#447700>! for simplicty use mass-weighted ice and droplet/rain fallspeeds<a name='1801'></font>
<a name='1802'>
        <font color=#447700>! if (qitot(i,k,iice).ge.qsmall .and. t(i,k).lt.273.15) then<a name='1803'></font>
        <font color=#447700>!  NOTE:  condition applicable for cloud only; modify when rain is added back<a name='1804'></font>
          if (qccol(iice).ge.qsmall .and. t(i,k).lt.273.15) then<a name='1805'>
<a name='1806'>
           <font color=#447700>! get mass-weighted mean ice fallspeed<a name='1807'></font>
             vtrmi1(i,k) = f1pr02*rhofaci(i,k)<a name='1808'>
             iTc   = 1./min(-0.001,t(i,k)-273.15)<a name='1809'>
<a name='1810'>
          <font color=#447700>! cloud:<a name='1811'></font>
             if (qc(i,k).ge.qsmall) then<a name='1812'>
              <font color=#447700>! droplet fall speed<a name='1813'></font>
              <font color=#447700>! (use Stokes' formulation (thus use analytic solution)<a name='1814'></font>
                Vt_qc(i,k) = acn(i,k)*gamma(4.+bcn+mu_c(i,k))/(lamc(i,k)**bcn*gamma(mu_c(i,k)+4.))<a name='1815'>
              <font color=#447700>! use mass-weighted mean size<a name='1816'></font>
                D_c = (mu_c(i,k)+4.)/lamc(i,k)<a name='1817'>
                V_impact  = abs(vtrmi1(i,k)-Vt_qc(i,k))<a name='1818'>
                Ri        = -(0.5e+6*D_c)*V_impact*iTc<a name='1819'>
<font color=#447700>!               Ri        = max(1.,min(Ri,8.))<a name='1820'></font>
                Ri        = max(1.,min(Ri,12.))<a name='1821'>
                if (Ri.le.8.) then<a name='1822'>
                   rhorime_c(iice)  = (0.051 + 0.114*Ri - 0.0055*Ri**2)*1000.<a name='1823'>
                else<a name='1824'>
                <font color=#447700>! for Ri &gt; 8 assume a linear fit between 8 and 12,<a name='1825'></font>
                <font color=#447700>! rhorime = 900 kg m-3 at Ri = 12<a name='1826'></font>
                <font color=#447700>! this is somewhat ad-hoc but allows a smoother transition<a name='1827'></font>
                <font color=#447700>! in rime density up to wet growth<a name='1828'></font>
                   rhorime_c(iice)  = 611.+72.25*(Ri-8.)<a name='1829'>
                endif<a name='1830'>
<a name='1831'>
             endif    <font color=#447700>!if qc&gt;qsmall<a name='1832'></font>
<a name='1833'>
          <font color=#447700>! rain:<a name='1834'></font>
            <font color=#447700>! assume rime density for rain collecting ice is 900 kg/m3<a name='1835'></font>
<font color=#447700>!            if (qr(i,k).ge.qsmall) then<a name='1836'></font>
<font color=#447700>!               D_r = (mu_r(i,k)+1.)/lamr(i,k)<a name='1837'></font>
<font color=#447700>!               V_impact  = abs(vtrmi1(i,k)-Vt_qr(i,k))<a name='1838'></font>
<font color=#447700>!               Ri        = -(0.5e+6*D_r)*V_impact*iTc<a name='1839'></font>
<font color=#447700>!               Ri        = max(1.,min(Ri,8.))<a name='1840'></font>
<font color=#447700>!               rhorime_r(iice)  = (0.051 + 0.114*Ri - 0.0055*Ri*Ri)*1000.<a name='1841'></font>
<font color=#447700>!            else<a name='1842'></font>
<font color=#447700>!               rhorime_r(iice) = 400.<a name='1843'></font>
<font color=#447700>!            endif<a name='1844'></font>
<a name='1845'>
          else<a name='1846'>
             rhorime_c(iice) = 400.<a name='1847'>
<font color=#447700>!             rhorime_r(iice) = 400.<a name='1848'></font>
          endif <font color=#447700>! qi &gt; qsmall and T &lt; 273.15<a name='1849'></font>
<a name='1850'>
    <font color=#447700>!--------------------<a name='1851'></font>
       enddo iice_loop1<a name='1852'>
    <font color=#447700>!--------------------<a name='1853'></font>
<a name='1854'>
<font color=#447700>!............................................................<a name='1855'></font>
<font color=#447700>! contact and immersion freezing droplets<a name='1856'></font>
<a name='1857'>
<font color=#447700>! contact freezing currently turned off<a name='1858'></font>
<font color=#447700>!         dum=7.37*t(i,k)/(288.*10.*pres(i,k))/100.<a name='1859'></font>
<font color=#447700>!         dap=4.*pi*1.38e-23*t(i,k)*(1.+dum/rin)/ &amp;<a name='1860'></font>
<font color=#447700>!                (6.*pi*rin*mu)<a name='1861'></font>
<font color=#447700>!         nacnt=exp(-2.80+0.262*(273.15-t(i,k)))*1000.<a name='1862'></font>
<a name='1863'>
       if (qc(i,k).ge.qsmall .and. t(i,k).le.269.15) then<a name='1864'>
<font color=#447700>!         qchetc(iice) = pi*pi/3.*Dap*Nacnt*rhow*cdist1(i,k)*gamma(mu_c(i,k)+5.)/lamc(i,k)**4<a name='1865'></font>
<font color=#447700>!         nchetc(iice) = 2.*pi*Dap*Nacnt*cdist1(i,k)*gamma(mu_c(i,k)+2.)/lamc(i,k)<a name='1866'></font>
<font color=#447700>! for future: calculate gamma(mu_c+4) in one place since its used multiple times<a name='1867'></font>
          dum    = (1./lamc(i,k))**3<a name='1868'>
<font color=#447700>!         qcheti(iice_dest) = cons6*cdist1(i,k)*gamma(7.+pgam(i,k))*exp(aimm*(273.15-t(i,k)))*dum**2<a name='1869'></font>
<font color=#447700>!         ncheti(iice_dest) = cons5*cdist1(i,k)*gamma(pgam(i,k)+4.)*exp(aimm*(273.15-t(i,k)))*dum<a name='1870'></font>
          Q_nuc = cons6*cdist1(i,k)*gamma(7.+mu_c(i,k))*exp(aimm*(273.15-t(i,k)))*dum**2<a name='1871'>
          N_nuc = cons5*cdist1(i,k)*gamma(mu_c(i,k)+4.)*exp(aimm*(273.15-t(i,k)))*dum<a name='1872'>
         <font color=#447700>!--determine destination ice-phase category:<a name='1873'></font>
          dum1      = 900.     <font color=#447700>!density of new ice<a name='1874'></font>
          D_new     = ((Q_nuc*6.)/(pi*dum1*N_nuc))**thrd<a name='1875'>
          call <A href='../../html_code/phys/module_mp_p3.F.html#ICECAT_DESTINATION'>icecat_destination</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICECAT_DESTINATION_1">(qitot(i,k,:),diam_ice(i,k,:),D_new,deltaD_init,      &amp;<a name='1876'>
                                  log_ni_add,iice_dest)<a name='1877'>
         <font color=#447700>!==<a name='1878'></font>
          qcheti(iice_dest) = Q_nuc<a name='1879'>
          if (log_ni_add) ncheti(iice_dest) = N_nuc<a name='1880'>
       endif<a name='1881'>
<a name='1882'>
<a name='1883'>
<font color=#447700>!............................................................<a name='1884'></font>
<font color=#447700>! immersion freezing of rain<a name='1885'></font>
<font color=#447700>! for future: get rid of log statements below for rain freezing<a name='1886'></font>
<a name='1887'>
       if (qr(i,k).ge.qsmall.and.t(i,k).le.269.15) then<a name='1888'>
          Q_nuc = cons6*exp(log(cdistr(i,k))+log(gamma(7.+mu_r(i,k)))-6.*log(lamr(i,k)))* &amp;<a name='1889'>
                  exp(aimm*(273.15-T(i,k)))<a name='1890'>
          N_nuc = cons5*exp(log(cdistr(i,k))+log(gamma(mu_r(i,k)+4.))-3.*log(lamr(i,k)))* &amp;<a name='1891'>
                  exp(aimm*(273.15-T(i,k)))<a name='1892'>
         <font color=#447700>!--determine destination ice-phase category:<a name='1893'></font>
          dum1      = 900.     <font color=#447700>!density of new ice<a name='1894'></font>
          D_new     = ((Q_nuc*6.)/(pi*dum1*N_nuc))**thrd<a name='1895'>
          call <A href='../../html_code/phys/module_mp_p3.F.html#ICECAT_DESTINATION'>icecat_destination</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICECAT_DESTINATION_2">(qitot(i,k,:),diam_ice(i,k,:),D_new,deltaD_init,        &amp;<a name='1896'>
                               log_ni_add,iice_dest)<a name='1897'>
         <font color=#447700>!==<a name='1898'></font>
          qrheti(iice_dest) = Q_nuc<a name='1899'>
          if (log_ni_add) nrheti(iice_dest) = N_nuc<a name='1900'>
       endif<a name='1901'>
<a name='1902'>
<a name='1903'>
<font color=#447700>!......................................<a name='1904'></font>
<font color=#447700>! rime splintering (Hallet-Mossop 1974)<a name='1905'></font>
<a name='1906'>
       rimesplintering_on:  if (log_hmossopOn) then<a name='1907'>
<a name='1908'>
        <font color=#447700>! determine destination ice-phase category<a name='1909'></font>
          D_new = 10.e-6 <font color=#447700>!assumes ice crystals from rime splintering are tiny<a name='1910'></font>
          call <A href='../../html_code/phys/module_mp_p3.F.html#ICECAT_DESTINATION'>icecat_destination</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICECAT_DESTINATION_3">(qitot(i,k,:),diam_ice(i,k,:),D_new,deltaD_init,        &amp;<a name='1911'>
                                  log_ni_add,iice_dest)<a name='1912'>
<a name='1913'>
          iice_loop_HM:  do iice = 1,nCat<a name='1914'>
<a name='1915'>
             if (qitot(i,k,iice).ge.qsmall.and. (qccol(iice).gt.0. .or.                  &amp;<a name='1916'>
              qrcol(iice).gt.0.)) then<a name='1917'>
<a name='1918'>
                if (t(i,k).gt.270.15) then<a name='1919'>
                   dum = 0.<a name='1920'>
                elseif (t(i,k).le.270.15 .and. t(i,k).gt.268.15) then<a name='1921'>
                   dum = (270.15-t(i,k))*0.5<a name='1922'>
                elseif (t(i,k).le.268.15 .and. t(i,k).ge.265.15) then<a name='1923'>
                   dum = (t(i,k)-265.15)*thrd<a name='1924'>
                elseif (t(i,k).lt.265.15) then<a name='1925'>
                   dum = 0.<a name='1926'>
                endif<a name='1927'>
<a name='1928'>
                <font color=#447700>!rime splintering from riming of cloud droplets<a name='1929'></font>
<font color=#447700>!                dum1 = 35.e+4*qccol(iice)*dum*1000. ! 1000 is to convert kg to g<a name='1930'></font>
<font color=#447700>!                dum2 = dum1*piov6*900.*(10.e-6)**3  ! assume 10 micron splinters<a name='1931'></font>
<font color=#447700>!                qccol(iice) = qccol(iice)-dum2 ! subtract splintering from rime mass transfer<a name='1932'></font>
<font color=#447700>!                if (qccol(iice) .lt. 0.) then<a name='1933'></font>
<font color=#447700>!                   dum2 = qccol(iice)<a name='1934'></font>
<font color=#447700>!                   qccol(iice) = 0.<a name='1935'></font>
<font color=#447700>!                endif<a name='1936'></font>
<font color=#447700>!                qcmul(iice_dest) = qcmul(iice_dest)+dum2<a name='1937'></font>
<font color=#447700>!                if (log_ni_add) then<a name='1938'></font>
<font color=#447700>!                nimul(iice_dest) = nimul(iice_dest)+dum2/(piov6*900.*(10.e-6)**3)<a name='1939'></font>
<font color=#447700>!                end if<a name='1940'></font>
<a name='1941'>
               <font color=#447700>!rime splintering from riming of raindrops<a name='1942'></font>
                dum1 = 35.e+4*qrcol(iice)*dum*1000. <font color=#447700>! 1000 is to convert kg to g<a name='1943'></font>
                dum2 = dum1*piov6*900.*(10.e-6)**3  <font color=#447700>! assume 10 micron splinters<a name='1944'></font>
                qrcol(iice) = qrcol(iice)-dum2      <font color=#447700>! subtract splintering from rime mass transfer<a name='1945'></font>
                if (qrcol(iice) .lt. 0.) then<a name='1946'>
                   dum2 = qrcol(iice)<a name='1947'>
                   qrcol(iice) = 0.<a name='1948'>
                endif<a name='1949'>
<a name='1950'>
                qrmul(iice_dest) = qrmul(iice_dest) + dum2<a name='1951'>
                if (log_ni_add) nimul(iice_dest) = nimul(iice_dest) + dum2/(piov6*900.*(10.e-6)**3)<a name='1952'>
<a name='1953'>
             endif<a name='1954'>
<a name='1955'>
          enddo iice_loop_HM<a name='1956'>
<a name='1957'>
       endif rimesplintering_on<a name='1958'>
<a name='1959'>
<a name='1960'>
<font color=#447700>!................................................<a name='1961'></font>
<font color=#447700>! condensation/evaporation/deposition/sublimation<a name='1962'></font>
<font color=#447700>!   (use semi-analytic formulation)<a name='1963'></font>
<a name='1964'>
     <font color=#447700>! calculate rain evaporation including ventilation<a name='1965'></font>
       if (qr(i,k).ge.qsmall) then<a name='1966'>
          call <A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_3'>find_lookupTable_indices_3</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_LOOKUPTABLE_INDICES_3_1">(dumii,dumjj,dum1,rdumii,rdumjj,inv_dum3,mu_r(i,k),lamr(i,k))<a name='1967'>
         <font color=#447700>!interpolate value at mu_r<a name='1968'></font>
          dum1 = revap_table(dumii,dumjj)+(rdumii-real(dumii))*inv_dum3*                   &amp;<a name='1969'>
                 (revap_table(dumii+1,dumjj)-revap_table(dumii,dumjj))<a name='1970'>
         <font color=#447700>!interoplate value at mu_r+1<a name='1971'></font>
          dum2 = revap_table(dumii,dumjj+1)+(rdumii-real(dumii))*inv_dum3*                 &amp;<a name='1972'>
                 (revap_table(dumii+1,dumjj+1)-revap_table(dumii,dumjj+1))<a name='1973'>
         <font color=#447700>!final interpolation<a name='1974'></font>
          dum  = dum1+(rdumjj-real(dumjj))*(dum2-dum1)<a name='1975'>
<a name='1976'>
          epsr = 2.*pi*cdistr(i,k)*rho(i,k)*dv*(f1r*gamma(mu_r(i,k)+2.)/(lamr(i,k))+f2r*   &amp;<a name='1977'>
                 (rho(i,k)/mu)**0.5*sc**thrd*dum)<a name='1978'>
       else<a name='1979'>
          epsr = 0.<a name='1980'>
       endif<a name='1981'>
<a name='1982'>
       if (qc(i,k).ge.qsmall) then<a name='1983'>
          epsc = 2.*pi*rho(i,k)*dv*cdist(i,k)<a name='1984'>
       else<a name='1985'>
          epsc = 0.<a name='1986'>
       endif<a name='1987'>
   <font color=#447700>!===<a name='1988'></font>
<a name='1989'>
       if (t(i,k).lt.273.15) then<a name='1990'>
          oabi = 1./abi<a name='1991'>
          xx   = epsc + epsr + epsi_tot*(1.+xxls(i,k)*inv_cp*dqsdt)*oabi<a name='1992'>
       else<a name='1993'>
          xx   = epsc + epsr<a name='1994'>
       endif<a name='1995'>
<a name='1996'>
       dumqvi = qvi(i,k)   <font color=#447700>!no modification due to latent heating<a name='1997'></font>
<font color=#447700>!----<a name='1998'></font>
<font color=#447700>! !      ! modify due to latent heating from riming rate<a name='1999'></font>
<font color=#447700>! !      !   - currently this is done by simple linear interpolation<a name='2000'></font>
<font color=#447700>! !      !     between conditions for dry and wet growth --&gt; in wet growth it is assumed<a name='2001'></font>
<font color=#447700>! !      !     that particle surface temperature is at 0 C and saturation vapor pressure<a name='2002'></font>
<font color=#447700>! !      !     is that with respect to liquid. This simple treatment could be improved in the future.<a name='2003'></font>
<font color=#447700>! !        if (qwgrth(iice).ge.1.e-20) then<a name='2004'></font>
<font color=#447700>! !           dum = (qccol(iice)+qrcol(iice))/qwgrth(iice)<a name='2005'></font>
<font color=#447700>! !        else<a name='2006'></font>
<font color=#447700>! !           dum = 0.<a name='2007'></font>
<font color=#447700>! !        endif<a name='2008'></font>
<font color=#447700>! !        dumqvi = qvi(i,k) + dum*(qvs(i,k)-qvi(i,k))<a name='2009'></font>
<font color=#447700>! !        dumqvi = min(qvs(i,k),dumqvi)<a name='2010'></font>
<font color=#447700>!====<a name='2011'></font>
<a name='2012'>
<a name='2013'>
<font color=#447700>! 'A' term including ice (Bergeron process)<a name='2014'></font>
<font color=#447700>! note: qv and T tendencies due to mixing and radiation are<a name='2015'></font>
<font color=#447700>! currently neglected --&gt; assumed to be much smaller than cooling<a name='2016'></font>
<font color=#447700>! due to vertical motion which IS included<a name='2017'></font>
<a name='2018'>
<font color=#447700>! set equivalent vertical velocity consistent with dT/dt<a name='2019'></font>
<font color=#447700>! since -g/cp*dum = dT/dt therefore dum = -cp/g*dT/dt<a name='2020'></font>
<font color=#447700>! note this formulation for dT/dt is not exact since pressure<a name='2021'></font>
<font color=#447700>! may change and t and t_old were both diagnosed using the current pressure<a name='2022'></font>
<font color=#447700>! errors from this assumption are small<a name='2023'></font>
       dum = -cp/g*(t(i,k)-t_old(i,k))/dt<a name='2024'>
<a name='2025'>
<font color=#447700>!       dum = qvs(i,k)*rho(i,k)*g*uzpl(i,k)/max(1.e-3,(pres(i,k)-polysvp1(t(i,k),0)))<a name='2026'></font>
<a name='2027'>
       if (t(i,k).lt.273.15) then<a name='2028'>
          aaa = (qv(i,k)-qv_old(i,k))/dt - dqsdt*(-dum*g*inv_cp)-(qvs(i,k)-dumqvi)*(1.+xxls(i,k)*      &amp;<a name='2029'>
                inv_cp*dqsdt)*oabi*epsi_tot<a name='2030'>
       else<a name='2031'>
          aaa = (qv(i,k)-qv_old(i,k))/dt - dqsdt*(-dum*g*inv_cp)<a name='2032'>
       endif<a name='2033'>
<a name='2034'>
       xx  = max(1.e-20,xx)   <font color=#447700>! set lower bound on xx to prevent division by zero<a name='2035'></font>
       oxx = 1./xx<a name='2036'>
<a name='2037'>
       if (qc(i,k).ge.qsmall) &amp;<a name='2038'>
          qccon = (aaa*epsc*oxx+(ssat(i,k)-aaa*oxx)*odt*epsc*oxx*(1.-dexp(-dble(xx*dt))))/ab<a name='2039'>
       if (qr(i,k).ge.qsmall) &amp;<a name='2040'>
          qrcon = (aaa*epsr*oxx+(ssat(i,k)-aaa*oxx)*odt*epsr*oxx*(1.-dexp(-dble(xx*dt))))/ab<a name='2041'>
<a name='2042'>
     <font color=#447700>!for very small water contents, evaporate instantly<a name='2043'></font>
       if (sup(i,k).lt.-0.001 .and. qc(i,k).lt.1.e-12)  qccon = -qc(i,k)*odt<a name='2044'>
       if (sup(i,k).lt.-0.001 .and. qr(i,k).lt.1.e-12)  qrcon = -qr(i,k)*odt<a name='2045'>
<a name='2046'>
       if (qccon.lt.0.) then<a name='2047'>
          qcevp = -qccon<a name='2048'>
<font color=#447700>!          qcevp = min(qcevp,qc(i,k)*odt)<a name='2049'></font>
          qccon = 0.<a name='2050'>
       endif<a name='2051'>
<a name='2052'>
       if (qrcon.lt.0.) then<a name='2053'>
          qrevp = -qrcon<a name='2054'>
<font color=#447700>!          qrevp = min(qrevp,qr(i,k)*odt)<a name='2055'></font>
          nrevp = qrevp*(nr(i,k)/qr(i,k))<a name='2056'>
         <font color=#447700>!nrevp = nrevp*exp(-0.2*mu_r(i,k))  !add mu dependence [Seifert (2008), neglecting size dependence]<a name='2057'></font>
          qrcon = 0.<a name='2058'>
       endif<a name='2059'>
<a name='2060'>
      <font color=#447700>!limit total condensation/evaporation to saturation adjustment<a name='2061'></font>
<font color=#447700>!       dumt   = th(i,k)*(pres(i,k)*1.e-5)**(rd*inv_cp)<a name='2062'></font>
       dumqvs = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_5">(t(i,k),pres(i,k),0)<a name='2063'>
       qcon_satadj  = (qv(i,k)-dumqvs)/(1.+xxlv(i,k)**2*dumqvs/(cp*rv*t(i,k)**2))*odt<a name='2064'>
       if (qccon+qrcon.gt.0.) then<a name='2065'>
          ratio = max(0.,qcon_satadj)/(qccon+qrcon)<a name='2066'>
          ratio = min(1.,ratio)<a name='2067'>
          qccon = qccon*ratio<a name='2068'>
          qrcon = qrcon*ratio<a name='2069'>
       elseif (qcevp+qrevp.gt.0.) then<a name='2070'>
          ratio = max(0.,-qcon_satadj)/(qcevp+qrevp)<a name='2071'>
          ratio = min(1.,ratio)<a name='2072'>
          qcevp = qcevp*ratio<a name='2073'>
          qrevp = qrevp*ratio<a name='2074'>
       endif<a name='2075'>
<a name='2076'>
       iice_loop_depsub:  do iice = 1,nCat<a name='2077'>
<a name='2078'>
          if (qitot(i,k,iice).ge.qsmall.and.t(i,k).lt.273.15) then<a name='2079'>
             qidep(iice) = (aaa*epsi(iice)*oxx+(ssat(i,k)-aaa*oxx)*odt*epsi(iice)*oxx*   &amp;<a name='2080'>
                           (1.-dexp(-dble(xx*dt))))*oabi+(qvs(i,k)-dumqvi)*epsi(iice)*oabi<a name='2081'>
          endif<a name='2082'>
<a name='2083'>
         <font color=#447700>!for very small ice contents in dry air, sublimate all ice instantly<a name='2084'></font>
          if (supi(i,k).lt.-0.001 .and. qitot(i,k,iice).lt.1.e-12) &amp;<a name='2085'>
             qidep(iice) = -qitot(i,k,iice)*odt<a name='2086'>
<a name='2087'>
          if (qidep(iice).lt.0.) then<a name='2088'>
           <font color=#447700>!note: limit to saturation adjustment (for dep and subl) is applied later<a name='2089'></font>
             qisub(iice) = -qidep(iice)<a name='2090'>
             qisub(iice) = qisub(iice)*clbfact_sub<a name='2091'>
             qisub(iice) = min(qisub(iice), qitot(i,k,iice)*dt)<a name='2092'>
             nisub(iice) = qisub(iice)*(nitot(i,k,iice)/qitot(i,k,iice))<a name='2093'>
             qidep(iice) = 0.<a name='2094'>
          else<a name='2095'>
             qidep(iice) = qidep(iice)*clbfact_dep<a name='2096'>
          endif<a name='2097'>
<a name='2098'>
       enddo iice_loop_depsub<a name='2099'>
<a name='2100'>
444   continue<a name='2101'>
<a name='2102'>
<a name='2103'>
<font color=#447700>!................................................................<a name='2104'></font>
<font color=#447700>! deposition/condensation-freezing nucleation<a name='2105'></font>
<font color=#447700>! allow ice nucleation if &lt; -15 C and &gt; 5% ice supersaturation<a name='2106'></font>
<a name='2107'>
      if (t(i,k).lt.258.15 .and. supi(i,k).ge.0.05) then<a name='2108'>
<a name='2109'>
<font color=#447700>!        dum = exp(-0.639+0.1296*100.*supi(i,k))*1000.*inv_rho(i,k)  !Meyers et al. (1992)<a name='2110'></font>
         dum = 0.005*exp(0.304*(273.15-t(i,k)))*1000.*inv_rho(i,k)   <font color=#447700>!Cooper (1986)<a name='2111'></font>
         dum = min(dum,100.e3*inv_rho(i,k))<a name='2112'>
         N_nuc = max(0.,(dum-sum(nitot(i,k,:)))*odt)<a name='2113'>
<a name='2114'>
         if (N_nuc.ge.1.e-20) then<a name='2115'>
            Q_nuc = max(0.,(dum-sum(nitot(i,k,:)))*mi0*odt)<a name='2116'>
            <font color=#447700>!--determine destination ice-phase category:<a name='2117'></font>
            dum1      = 900.     <font color=#447700>!density of new ice<a name='2118'></font>
            D_new     = ((Q_nuc*6.)/(pi*dum1*N_nuc))**thrd<a name='2119'>
            call <A href='../../html_code/phys/module_mp_p3.F.html#ICECAT_DESTINATION'>icecat_destination</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICECAT_DESTINATION_4">(qitot(i,k,:),diam_ice(i,k,:),D_new,deltaD_init,    &amp;<a name='2120'>
                                    log_ni_add,iice_dest)<a name='2121'>
            <font color=#447700>!==<a name='2122'></font>
            qinuc(iice_dest) = Q_nuc<a name='2123'>
            if (log_ni_add) ninuc(iice_dest) = N_nuc<a name='2124'>
         endif<a name='2125'>
<a name='2126'>
      endif<a name='2127'>
<a name='2128'>
<a name='2129'>
<font color=#447700>!.................................................................<a name='2130'></font>
<font color=#447700>! droplet activation<a name='2131'></font>
<a name='2132'>
<font color=#447700>! for specified Nc, make sure droplets are present if conditions are supersaturated<a name='2133'></font>
<font color=#447700>! note that this is also applied at the first time step<a name='2134'></font>
<font color=#447700>! this is not applied at the first time step, since saturation adjustment is applied at the first step<a name='2135'></font>
<a name='2136'>
          if (.not.(log_predictNc).and.sup(i,k).gt.1.e-6.and.it.gt.1) then<a name='2137'>
             dum   = nccnst*inv_rho(i,k)*cons7-qc(i,k)<a name='2138'>
             dum   = max(0.,dum)<a name='2139'>
             dumqvs = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_6">(t(i,k),pres(i,k),0)<a name='2140'>
             dqsdt = xxlv(i,k)*dumqvs/(rv*t(i,k)*t(i,k))<a name='2141'>
             ab    = 1. + dqsdt*xxlv(i,k)*inv_cp<a name='2142'>
             dum   = min(dum,(qv(i,k)-dumqvs)/ab)  <font color=#447700>! limit overdepletion of supersaturation<a name='2143'></font>
             qcnuc = dum*odt<a name='2144'>
          endif<a name='2145'>
<a name='2146'>
          if (log_predictNc) then<a name='2147'>
<a name='2148'>
<font color=#447700>! for predicted Nc, calculate activation explicitly from supersaturation<a name='2149'></font>
<font color=#447700>! note that this is also applied at the first time step<a name='2150'></font>
<font color=#447700>! note that this is also applied at the first time step<a name='2151'></font>
<a name='2152'>
             if (sup(i,k).gt.1.e-6) then<a name='2153'>
                dum1  = 1./bact**0.5<a name='2154'>
                sigvl = 0.0761 - 1.55e-4*(t(i,k)-273.15)<a name='2155'>
                aact  = 2.*mw/(rhow*rr*t(i,k))*sigvl<a name='2156'>
                sm1   = 2.*dum1*(aact*thrd*inv_rm1)**1.5<a name='2157'>
                sm2   = 2.*dum1*(aact*thrd*inv_rm2)**1.5<a name='2158'>
                uu1   = 2.*log(sm1/sup(i,k))/(4.242*log(sig1))<a name='2159'>
                uu2   = 2.*log(sm2/sup(i,k))/(4.242*log(sig2))<a name='2160'>
                dum1  = nanew1*0.5*(1.-derf(uu1)) <font color=#447700>! activated number in kg-1 mode 1<a name='2161'></font>
                dum2  = nanew2*0.5*(1.-derf(uu2)) <font color=#447700>! activated number in kg-1 mode 2<a name='2162'></font>
              <font color=#447700>! make sure this value is not greater than total number of aerosol<a name='2163'></font>
                dum2  = min((nanew1+nanew2),dum1+dum2)<a name='2164'>
                dum2  = (dum2-nc(i,k))*odt<a name='2165'>
                dum2  = max(0.,dum2)<a name='2166'>
                ncnuc = dum2<a name='2167'>
              <font color=#447700>! don't include mass increase from droplet activation during first time step<a name='2168'></font>
              <font color=#447700>! since this is already accounted for by saturation adjustment below<a name='2169'></font>
                if (it.eq.1) then<a name='2170'>
                   qcnuc = 0.<a name='2171'>
                else<a name='2172'>
                   qcnuc = ncnuc*cons7<a name='2173'>
                endif<a name='2174'>
             endif<a name='2175'>
<a name='2176'>
          endif<a name='2177'>
<a name='2178'>
<font color=#447700>!................................................................<a name='2179'></font>
<font color=#447700>! saturation adjustment to get initial cloud water<a name='2180'></font>
<a name='2181'>
<font color=#447700>! This is only called once at the beginning of the simulation<a name='2182'></font>
<font color=#447700>! to remove any supersaturation in the intial conditions<a name='2183'></font>
<a name='2184'>
       if (it.eq.1) then<a name='2185'>
          dumt   = th(i,k)*(pres(i,k)*1.e-5)**(rd*inv_cp)<a name='2186'>
          dumqv  = qv(i,k)<a name='2187'>
          dumqvs = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_7">(dumt,pres(i,k),0)<a name='2188'>
          dums   = dumqv-dumqvs<a name='2189'>
          qccon  = dums/(1.+xxlv(i,k)**2*dumqvs/(cp*rv*dumt**2))*odt<a name='2190'>
          qccon  = max(0.,qccon)<a name='2191'>
          if (qccon.le.1.e-7) qccon = 0.<a name='2192'>
       endif<a name='2193'>
<a name='2194'>
<font color=#447700>!................<a name='2195'></font>
<font color=#447700>! autoconversion<a name='2196'></font>
<a name='2197'>
       qc_not_small: if (qc(i,k).ge.1.e-8) then<a name='2198'>
<a name='2199'>
          if (iparam.eq.1) then<a name='2200'>
<a name='2201'>
            <font color=#447700>!Seifert and Beheng (2001)<a name='2202'></font>
             dum   = 1.-qc(i,k)/(qc(i,k)+qr(i,k))<a name='2203'>
             dum1  = 600.*dum**0.68*(1.-dum**0.68)**3<a name='2204'>
           <font color=#447700>! qcaut = kc/(20.*2.6e-7)*(nu(i,k)+2.)*(nu(i,k)+4.)/(nu(i,k)+1.)**2*         &amp;<a name='2205'></font>
           <font color=#447700>!         (rho(i,k)*qc(i,k)/1000.)**4/(rho(i,k)*nc(i,k)/1.e+6)**2*(1.+       &amp;<a name='2206'></font>
           <font color=#447700>!         dum1/(1.-dum)**2)*1000.*inv_rho(i,k)<a name='2207'></font>
           <font color=#447700>! ncautc = qcaut*2./2.6e-7*1000.<a name='2208'></font>
             qcaut =  kc*1.9230769e-5*(nu(i,k)+2.)*(nu(i,k)+4.)/(nu(i,k)+1.)**2*        &amp;<a name='2209'>
                      (rho(i,k)*qc(i,k)*1.e-3)**4/(rho(i,k)*nc(i,k)*1.e-6)**2*(1.+      &amp;<a name='2210'>
                      dum1/(1.-dum)**2)*1000.*inv_rho(i,k)<a name='2211'>
             ncautc = qcaut*7.6923076e+9<a name='2212'>
<a name='2213'>
          elseif (iparam.eq.2) then<a name='2214'>
<a name='2215'>
            <font color=#447700>!Beheng (1994)<a name='2216'></font>
             if (nc(i,k)*rho(i,k)*1.e-6 .lt. 100.) then<a name='2217'>
                qcaut = 6.e+28*inv_rho(i,k)*mu_c(i,k)**(-1.7)*(1.e-6*rho(i,k)*          &amp;<a name='2218'>
                        nc(i,k))**(-3.3)*(1.e-3*rho(i,k)*qc(i,k))**4.7<a name='2219'>
             else<a name='2220'>
               <font color=#447700>!2D interpolation of tabled logarithmic values<a name='2221'></font>
                dum   = 41.46 + (nc(i,k)*1.e-6*rho(i,k)-100.)*(37.53-41.46)*5.e-3<a name='2222'>
                dum1  = 39.36 + (nc(i,k)*1.e-6*rho(i,k)-100.)*(30.72-39.36)*5.e-3<a name='2223'>
                qcaut = dum+(mu_c(i,k)-5.)*(dum1-dum)*0.1<a name='2224'>
              <font color=#447700>! 1000/rho is for conversion from g cm-3/s to kg/kg<a name='2225'></font>
                qcaut = exp(qcaut)*(1.e-3*rho(i,k)*qc(i,k))**4.7*1000.*inv_rho(i,k)<a name='2226'>
             endif<a name='2227'>
             ncautc = 7.7e+9*qcaut<a name='2228'>
<a name='2229'>
          elseif (iparam.eq.3) then<a name='2230'>
<a name='2231'>
           <font color=#447700>!Khroutdinov and Kogan (2000)<a name='2232'></font>
             dum   = qc(i,k)<a name='2233'>
             qcaut = 1350.*dum**2.47*(nc(i,k)*1.e-6*rho(i,k))**(-1.79)<a name='2234'>
            <font color=#447700>! note: ncautr is change in Nr; ncautc is change in Nc<a name='2235'></font>
             ncautr = qcaut*cons3<a name='2236'>
             ncautc = qcaut*nc(i,k)/qc(i,k)<a name='2237'>
<a name='2238'>
          endif<a name='2239'>
<a name='2240'>
          if (qcaut .eq.0.) ncautc = 0.<a name='2241'>
          if (ncautc.eq.0.) qcaut  = 0.<a name='2242'>
<font color=#447700>!          qcaut = min(qcaut, qc(i,k)*odt)<a name='2243'></font>
<a name='2244'>
       endif qc_not_small<a name='2245'>
<a name='2246'>
<font color=#447700>!............................<a name='2247'></font>
<font color=#447700>! self-collection of droplets<a name='2248'></font>
<a name='2249'>
       if (qc(i,k).ge.qsmall) then<a name='2250'>
<a name='2251'>
          if (iparam.eq.1) then<a name='2252'>
           <font color=#447700>!Seifert and Beheng (2001)<a name='2253'></font>
             ncslf = -kc*(1.e-3*rho(i,k)*qc(i,k))**2*(nu(i,k)+2.)/(nu(i,k)+1.)*         &amp;<a name='2254'>
                     1.e+6*inv_rho(i,k)+ncautc<a name='2255'>
          elseif (iparam.eq.2) then<a name='2256'>
           <font color=#447700>!Beheng (994)<a name='2257'></font>
             ncslf = -5.5e+16*inv_rho(i,k)*mu_c(i,k)**(-0.63)*(1.e-3*rho(i,k)*qc(i,k))**2<a name='2258'>
          elseif (iparam.eq.3) then<a name='2259'>
            <font color=#447700>!Khroutdinov and Kogan (2000)<a name='2260'></font>
             ncslf = 0.<a name='2261'>
          endif<a name='2262'>
<a name='2263'>
       endif<a name='2264'>
<a name='2265'>
<font color=#447700>!............................<a name='2266'></font>
<font color=#447700>! accretion of cloud by rain<a name='2267'></font>
<a name='2268'>
       if (qr(i,k).ge.qsmall .and. qc(i,k).ge.qsmall) then<a name='2269'>
<a name='2270'>
          if (iparam.eq.1) then<a name='2271'>
           <font color=#447700>!Seifert and Beheng (2001)<a name='2272'></font>
             dum   = 1.-qc(i,k)/(qc(i,k)+qr(i,k))<a name='2273'>
             dum1  = (dum/(dum+5.e-4))**4<a name='2274'>
             qcacc = kr*rho(i,k)*0.001*qc(i,k)*qr(i,k)*dum1<a name='2275'>
             ncacc = qcacc*rho(i,k)*0.001*(nc(i,k)*rho(i,k)*1.e-6)/(qc(i,k)*rho(i,k)*   &amp;<a name='2276'>
                     0.001)*1.e+6*inv_rho(i,k)<a name='2277'>
          elseif (iparam.eq.2) then<a name='2278'>
           <font color=#447700>!Beheng (994)<a name='2279'></font>
             qcacc = 6.*rho(i,k)*(qc(i,k)*qr(i,k))<a name='2280'>
             ncacc = qcacc*rho(i,k)*1.e-3*(nc(i,k)*rho(i,k)*1.e-6)/(qc(i,k)*rho(i,k)*1.e-3)* &amp;<a name='2281'>
                     1.e+6*inv_rho(i,k)<a name='2282'>
          elseif (iparam.eq.3) then<a name='2283'>
            <font color=#447700>!Khroutdinov and Kogan (2000)<a name='2284'></font>
             qcacc = 67.*(qc(i,k)*qr(i,k))**1.15<a name='2285'>
             ncacc = qcacc*nc(i,k)/qc(i,k)<a name='2286'>
          endif<a name='2287'>
<a name='2288'>
          if (qcacc.eq.0.) ncacc = 0.<a name='2289'>
          if (ncacc.eq.0.) qcacc = 0.<a name='2290'>
<font color=#447700>!          qcacc = min(qcacc, qc(i,k)*odt)<a name='2291'></font>
<a name='2292'>
       endif<a name='2293'>
<a name='2294'>
<font color=#447700>!.....................................<a name='2295'></font>
<font color=#447700>! self-collection and breakup of rain<a name='2296'></font>
<font color=#447700>! (breakup following modified Verlinde and Cotton scheme)<a name='2297'></font>
<a name='2298'>
       if (qr(i,k).ge.qsmall) then<a name='2299'>
<a name='2300'>
        <font color=#447700>! include breakup<a name='2301'></font>
          dum1 = 280.e-6<a name='2302'>
<a name='2303'>
        <font color=#447700>! use mass-mean diameter (do this by using<a name='2304'></font>
        <font color=#447700>! the old version of lambda w/o mu dependence)<a name='2305'></font>
        <font color=#447700>! note there should be a factor of 6^(1/3), but we<a name='2306'></font>
        <font color=#447700>! want to keep breakup threshold consistent so 'dum'<a name='2307'></font>
        <font color=#447700>! is expressed in terms of lambda rather than mass-mean D<a name='2308'></font>
<a name='2309'>
          dum2 = (qr(i,k)/(pi*rhow*nr(i,k)))**thrd<a name='2310'>
          if (dum2.lt.dum1) then<a name='2311'>
             dum = 1.<a name='2312'>
          else if (dum2.ge.dum1) then<a name='2313'>
             dum = 2.-exp(2300.*(dum2-dum1))<a name='2314'>
          endif<a name='2315'>
<a name='2316'>
          if (iparam.eq.1.) then<a name='2317'>
             nrslf = dum*kr*1.e-3*qr(i,k)*nr(i,k)*rho(i,k)<a name='2318'>
          elseif (iparam.eq.2 .or. iparam.eq.3) then<a name='2319'>
             nrslf = dum*5.78*nr(i,k)*qr(i,k)*rho(i,k)<a name='2320'>
          endif<a name='2321'>
<a name='2322'>
       endif<a name='2323'>
<a name='2324'>
<a name='2325'>
<font color=#447700>!.................................................................<a name='2326'></font>
<font color=#447700>! conservation of water<a name='2327'></font>
<font color=#447700>!.................................................................<a name='2328'></font>
<a name='2329'>
<font color=#447700>! The microphysical process rates are computed above, based on the environmental conditions.<a name='2330'></font>
<font color=#447700>! The rates are adjusted here (where necessary) such that the sum of the sinks of mass cannot<a name='2331'></font>
<font color=#447700>! be greater than the sum of the sources, thereby resulting in overdepletion.<a name='2332'></font>
<a name='2333'>
   <font color=#447700>!-- Limit ice process rates to prevent overdepletion of sources such that<a name='2334'></font>
   <font color=#447700>!   the subsequent adjustments are done with maximum possible rates for the<a name='2335'></font>
   <font color=#447700>!   time step.  (note: the same is done for all other process rates immediately<a name='2336'></font>
   <font color=#447700>!   after calculations; most ice rates are adjusted here since they must be done<a name='2337'></font>
   <font color=#447700>!   simultaneously (outside of iice-loops) to distribute reduction proportionally<a name='2338'></font>
   <font color=#447700>!   amongst categories.<a name='2339'></font>
<a name='2340'>
       dumqvi = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_8">(t(i,k),pres(i,k),1)<a name='2341'>
       qdep_satadj = (qv(i,k)-dumqvi)/(1.+xxls(i,k)**2*dumqvi/(cp*rv*t(i,k)**2))*odt<a name='2342'>
       qidep  = qidep*min(1.,max(0., qdep_satadj)/max(sum(qidep), 1.e-20))<a name='2343'>
       qisub  = qisub*min(1.,max(0.,-qdep_satadj)/max(sum(qisub), 1.e-20))<a name='2344'>
      <font color=#447700>!qchetc = qchetc*min(1.,qc(i,k)*odt/max(sum(qchetc),1.e-20))  !currently not used<a name='2345'></font>
      <font color=#447700>!qrhetc = qrhetc*min(1.,qr(i,k)*odt/max(sum(qrhetc),1.e-20))  !currently not used<a name='2346'></font>
   <font color=#447700>!==<a name='2347'></font>
<a name='2348'>
<font color=#447700>! vapor -- not needed, since all sinks already have limits imposed and the sum, therefore,<a name='2349'></font>
<font color=#447700>!          cannot possibly overdeplete qv<a name='2350'></font>
<a name='2351'>
<font color=#447700>! cloud<a name='2352'></font>
       sinks   = (qcaut+qcacc+sum(qccol)+qcevp+sum(qchetc)+sum(qcheti)+sum(qcshd))*dt<a name='2353'>
       sources = qc(i,k) + (qccon+qcnuc)*dt<a name='2354'>
       if (sinks.gt.sources .and. sinks.ge.1.e-20) then<a name='2355'>
          ratio  = sources/sinks<a name='2356'>
          qcaut  = qcaut*ratio<a name='2357'>
          qcacc  = qcacc*ratio<a name='2358'>
          qcevp  = qcevp*ratio<a name='2359'>
          qccol  = qccol*ratio<a name='2360'>
          qcheti = qcheti*ratio<a name='2361'>
          qcshd  = qcshd*ratio<a name='2362'>
         <font color=#447700>!qchetc = qchetc*ratio<a name='2363'></font>
       endif<a name='2364'>
<a name='2365'>
<font color=#447700>! rain<a name='2366'></font>
       sinks   = (qrevp+sum(qrcol)+sum(qrhetc)+sum(qrheti)+sum(qrmul))*dt<a name='2367'>
       sources = qr(i,k) + (qrcon+qcaut+qcacc+sum(qimlt)+sum(qcshd))*dt<a name='2368'>
       if (sinks.gt.sources .and. sinks.ge.1.e-20) then<a name='2369'>
          ratio  = sources/sinks<a name='2370'>
          qrevp  = qrevp*ratio<a name='2371'>
          qrcol  = qrcol*ratio<a name='2372'>
          qrheti = qrheti*ratio<a name='2373'>
          qrmul  = qrmul*ratio<a name='2374'>
         <font color=#447700>!qrhetc = qrhetc*ratio<a name='2375'></font>
       endif<a name='2376'>
<a name='2377'>
<font color=#447700>! ice<a name='2378'></font>
       do iice = 1,nCat<a name='2379'>
          sinks   = (qisub(iice)+qimlt(iice))*dt<a name='2380'>
          sources = qitot(i,k,iice) + (qidep(iice)+qinuc(iice)+qrcol(iice)+qccol(iice)+  &amp;<a name='2381'>
                    qrhetc(iice)+qrheti(iice)+qchetc(iice)+qcheti(iice)+qrmul(iice))*dt<a name='2382'>
          do catcoll = 1,nCat<a name='2383'>
            <font color=#447700>!category interaction leading to source for iice category<a name='2384'></font>
             sources = sources + qicol(catcoll,iice)*dt<a name='2385'>
            <font color=#447700>!category interaction leading to sink for iice category<a name='2386'></font>
             sinks = sinks + qicol(iice,catcoll)*dt<a name='2387'>
          enddo<a name='2388'>
          if (sinks.gt.sources .and. sinks.ge.1.e-20) then<a name='2389'>
             ratio = sources/sinks<a name='2390'>
             qisub(iice) = qisub(iice)*ratio<a name='2391'>
             qimlt(iice) = qimlt(iice)*ratio<a name='2392'>
             do catcoll = 1,nCat<a name='2393'>
                qicol(iice,catcoll) = qicol(iice,catcoll)*ratio<a name='2394'>
             enddo<a name='2395'>
          endif<a name='2396'>
      enddo  <font color=#447700>!iice-loop<a name='2397'></font>
<a name='2398'>
<a name='2399'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='2400'></font>
<font color=#447700>! update prognostic microphysics and thermodynamics variables<a name='2401'></font>
<font color=#447700>!---------------------------------------------------------------------------------<a name='2402'></font>
<a name='2403'>
   <font color=#447700>!-- ice-phase dependent processes:<a name='2404'></font>
       iice_loop2: do iice = 1,nCat<a name='2405'>
<a name='2406'>
          qc(i,k) = qc(i,k) + (-qchetc(iice)-qcheti(iice)-qccol(iice)-qcshd(iice))*dt<a name='2407'>
          if (log_predictNc) then<a name='2408'>
             nc(i,k) = nc(i,k) + (-nccol(iice)-nchetc(iice)-ncheti(iice))*dt<a name='2409'>
          endif<a name='2410'>
<a name='2411'>
          qr(i,k) = qr(i,k) + (-qrcol(iice)+qimlt(iice)-qrhetc(iice)-qrheti(iice)+            &amp;<a name='2412'>
                    qcshd(iice)-qrmul(iice))*dt<a name='2413'>
        <font color=#447700>! apply factor to source for rain number from melting of ice, (ad-hoc<a name='2414'></font>
        <font color=#447700>! but accounts for rapid evaporation of small melting ice particles)<a name='2415'></font>
          nr(i,k) = nr(i,k) + (-nrcol(iice)-nrhetc(iice)-nrheti(iice)+nmltratio*nimlt(iice)+  &amp;<a name='2416'>
                    nrshdr(iice)+ncshdc(iice))*dt<a name='2417'>
<a name='2418'>
          if (qitot(i,k,iice).ge.qsmall) then<a name='2419'>
         <font color=#447700>! add sink terms, assume density stays constant for sink terms<a name='2420'></font>
             birim(i,k,iice) = birim(i,k,iice) - ((qisub(iice)+qimlt(iice))/qitot(i,k,iice))* &amp;<a name='2421'>
                               dt*birim(i,k,iice)<a name='2422'>
             qirim(i,k,iice) = qirim(i,k,iice) - ((qisub(iice)+qimlt(iice))*qirim(i,k,iice)/  &amp;<a name='2423'>
                               qitot(i,k,iice))*dt<a name='2424'>
             qitot(i,k,iice) = qitot(i,k,iice) - (qisub(iice)+qimlt(iice))*dt<a name='2425'>
          endif<a name='2426'>
<a name='2427'>
          dum             = (qrcol(iice)+qccol(iice)+qrhetc(iice)+qrheti(iice)+          &amp;<a name='2428'>
                            qchetc(iice)+qcheti(iice)+qrmul(iice))*dt<a name='2429'>
          qitot(i,k,iice) = qitot(i,k,iice) + (qidep(iice)+qinuc(iice))*dt + dum<a name='2430'>
          qirim(i,k,iice) = qirim(i,k,iice) + dum<a name='2431'>
          birim(i,k,iice) = birim(i,k,iice) + (qrcol(iice)*inv_rho_rimeMax+qccol(iice)/  &amp;<a name='2432'>
                            rhorime_c(iice)+(qrhetc(iice)+qrheti(iice)+qchetc(iice)+     &amp;<a name='2433'>
                            qcheti(iice)+qrmul(iice))*inv_rho_rimeMax)*dt<a name='2434'>
          nitot(i,k,iice) = nitot(i,k,iice) + (ninuc(iice)-nimlt(iice)-nisub(iice)-      &amp;<a name='2435'>
                            nislf(iice)+nrhetc(iice)+nrheti(iice)+nchetc(iice)+          &amp;<a name='2436'>
                            ncheti(iice)+nimul(iice))*dt<a name='2437'>
<a name='2438'>
          interactions_loop: do catcoll = 1,nCat<a name='2439'>
        <font color=#447700>! add ice-ice category interaction collection tendencies<a name='2440'></font>
        <font color=#447700>! note: nicol is a sink for the collectee category, but NOT a source for collector<a name='2441'></font>
<a name='2442'>
             qitot(i,k,catcoll) = qitot(i,k,catcoll) - qicol(catcoll,iice)*dt<a name='2443'>
             nitot(i,k,catcoll) = nitot(i,k,catcoll) - nicol(catcoll,iice)*dt<a name='2444'>
             qitot(i,k,iice)    = qitot(i,k,iice)    + qicol(catcoll,iice)*dt<a name='2445'>
             <font color=#447700>! now modify rime mass and density, assume collection does not modify rime mass<a name='2446'></font>
             <font color=#447700>! fraction or density of the collectee, consistent with the assumption that<a name='2447'></font>
             <font color=#447700>! these are constant over the PSD<a name='2448'></font>
             if (qitot(i,k,catcoll).ge.qsmall) then<a name='2449'>
              <font color=#447700>!source for collector category<a name='2450'></font>
                qirim(i,k,iice) = qirim(i,k,iice)+qicol(catcoll,iice)*dt*                &amp;<a name='2451'>
                                  qirim(i,k,catcoll)/qitot(i,k,catcoll)<a name='2452'>
                birim(i,k,iice) = birim(i,k,iice)+qicol(catcoll,iice)*dt*                &amp;<a name='2453'>
                                  birim(i,k,catcoll)/qitot(i,k,catcoll)<a name='2454'>
              <font color=#447700>!sink for collectee category<a name='2455'></font>
                qirim(i,k,catcoll) = qirim(i,k,catcoll)-qicol(catcoll,iice)*dt*          &amp;<a name='2456'>
                                     qirim(i,k,catcoll)/qitot(i,k,catcoll)<a name='2457'>
                birim(i,k,catcoll) = birim(i,k,catcoll)-qicol(catcoll,iice)*dt*          &amp;<a name='2458'>
                                     birim(i,k,catcoll)/qitot(i,k,catcoll)<a name='2459'>
             endif<a name='2460'>
<a name='2461'>
          enddo interactions_loop <font color=#447700>! catcoll loop<a name='2462'></font>
<a name='2463'>
<a name='2464'>
          if (qirim(i,k,iice).lt.0.) then<a name='2465'>
             qirim(i,k,iice) = 0.<a name='2466'>
             birim(i,k,iice) = 0.<a name='2467'>
          endif<a name='2468'>
<a name='2469'>
        <font color=#447700>! densify under wet growth<a name='2470'></font>
        <font color=#447700>! -- to be removed post-v2.1.  Densification automatically happens<a name='2471'></font>
        <font color=#447700>!    during wet growth due to parameterized rime density --<a name='2472'></font>
          if (log_wetgrowth(iice)) then<a name='2473'>
             qirim(i,k,iice) = qitot(i,k,iice)<a name='2474'>
             birim(i,k,iice) = qirim(i,k,iice)*inv_rho_rimeMax<a name='2475'>
          endif<a name='2476'>
<a name='2477'>
        <font color=#447700>! densify in above freezing conditions and melting<a name='2478'></font>
        <font color=#447700>! -- future work --<a name='2479'></font>
        <font color=#447700>!   Ideally, this will be treated with the predicted liquid fraction in ice.<a name='2480'></font>
        <font color=#447700>!   Alternatively, it can be simplified by tending qirim -- qitot<a name='2481'></font>
        <font color=#447700>!   and birim such that rho_rim (qirim/birim) --&gt; rho_liq during melting.<a name='2482'></font>
        <font color=#447700>! ==<a name='2483'></font>
<a name='2484'>
          qv(i,k) = qv(i,k) + (-qidep(iice)+qisub(iice)-qinuc(iice))*dt<a name='2485'>
<a name='2486'>
          th(i,k) = th(i,k) + th(i,k)/t(i,k)*((qidep(iice)-qisub(iice)+qinuc(iice))*     &amp;<a name='2487'>
                              xxls(i,k)*inv_cp +(qrcol(iice)+qccol(iice)+qchetc(iice)+   &amp;<a name='2488'>
                              qcheti(iice)+qrhetc(iice)+qrheti(iice)-qimlt(iice))*       &amp;<a name='2489'>
                              xlf(i,k)*inv_cp)*dt<a name='2490'>
<a name='2491'>
       enddo iice_loop2<a name='2492'>
   <font color=#447700>!==<a name='2493'></font>
<a name='2494'>
   <font color=#447700>!-- warm-phase only processes:<a name='2495'></font>
       qc(i,k) = qc(i,k) + (-qcacc-qcaut+qcnuc+qccon-qcevp)*dt<a name='2496'>
       qr(i,k) = qr(i,k) + (qcacc+qcaut+qrcon-qrevp)*dt<a name='2497'>
<a name='2498'>
       if (log_predictNc) then<a name='2499'>
          nc(i,k) = nc(i,k) + (-ncacc-ncautc+ncslf+ncnuc)*dt<a name='2500'>
       else<a name='2501'>
          nc(i,k) = nccnst*inv_rho(i,k)<a name='2502'>
       endif<a name='2503'>
       if (iparam.eq.1 .or. iparam.eq.2) then<a name='2504'>
          nr(i,k) = nr(i,k) + (0.5*ncautc-nrslf-nrevp)*dt<a name='2505'>
       else<a name='2506'>
          nr(i,k) = nr(i,k) + (ncautr-nrslf-nrevp)*dt<a name='2507'>
       endif<a name='2508'>
<a name='2509'>
       qv(i,k) = qv(i,k) + (-qcnuc-qccon-qrcon+qcevp+qrevp)*dt<a name='2510'>
       th(i,k) = th(i,k) + th(i,k)/t(i,k)*((qcnuc+qccon+qrcon-qcevp-qrevp)*xxlv(i,k)*    &amp;<a name='2511'>
                 inv_cp)*dt<a name='2512'>
   <font color=#447700>!==<a name='2513'></font>
<a name='2514'>
     <font color=#447700>! clipping for small hydrometeor values<a name='2515'></font>
       if (qc(i,k).lt.qsmall) then<a name='2516'>
          qv(i,k) = qv(i,k) + qc(i,k)<a name='2517'>
          th(i,k) = th(i,k) - th(i,k)/t(i,k)*qc(i,k)*xxlv(i,k)*inv_cp<a name='2518'>
          qc(i,k) = 0.<a name='2519'>
          nc(i,k) = 0.<a name='2520'>
       else<a name='2521'>
          log_hydrometeorsPresent = .true.<a name='2522'>
       endif<a name='2523'>
<a name='2524'>
       if (qr(i,k).lt.qsmall) then<a name='2525'>
          qv(i,k) = qv(i,k) + qr(i,k)<a name='2526'>
          th(i,k) = th(i,k) - th(i,k)/t(i,k)*qr(i,k)*xxlv(i,k)*inv_cp<a name='2527'>
          qr(i,k) = 0.<a name='2528'>
          nr(i,k) = 0.<a name='2529'>
       else<a name='2530'>
          log_hydrometeorsPresent = .true.<a name='2531'>
       endif<a name='2532'>
<a name='2533'>
       do iice = 1,nCat<a name='2534'>
          if (qitot(i,k,iice).lt.qsmall) then<a name='2535'>
             qv(i,k) = qv(i,k) + qitot(i,k,iice)<a name='2536'>
             th(i,k) = th(i,k) - th(i,k)/t(i,k)*qitot(i,k,iice)*xxls(i,k)*inv_cp<a name='2537'>
             qitot(i,k,iice) = 0.<a name='2538'>
             nitot(i,k,iice) = 0.<a name='2539'>
             qirim(i,k,iice) = 0.<a name='2540'>
             birim(i,k,iice) = 0.<a name='2541'>
          else<a name='2542'>
             log_hydrometeorsPresent = .true.<a name='2543'>
          endif<a name='2544'>
       enddo <font color=#447700>!iice-loop<a name='2545'></font>
<a name='2546'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#IMPOSE_MAX_TOTAL_NI'>impose_max_total_Ni</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IMPOSE_MAX_TOTAL_NI_2">(nitot(i,k,:),max_total_Ni,inv_rho(i,k))<a name='2547'>
<a name='2548'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='2549'></font>
<a name='2550'>
555    continue<a name='2551'>
<a name='2552'>
    enddo k_loop_main<a name='2553'>
<a name='2554'>
    if (debug_ON) then<a name='2555'>
       tmparr1(i,:) = th(i,:)*(pres(i,:)*1.e-5)**(rd*inv_cp)<a name='2556'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_16">(qv,tmparr1,qc,qr,nr,qitot,qirim,nitot,birim,i,it,.true.,debug_ABORT,300)<a name='2557'>
    endif<a name='2558'>
<a name='2559'>
    if (.not. log_hydrometeorsPresent) goto 333<a name='2560'>
<a name='2561'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='2562'></font>
<font color=#447700>! End of main microphysical processes section<a name='2563'></font>
<font color=#447700>!==========================================================================================!<a name='2564'></font>
<a name='2565'>
<a name='2566'>
<font color=#447700>!==========================================================================================!<a name='2567'></font>
<font color=#447700>! Sedimentation:<a name='2568'></font>
<a name='2569'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='2570'></font>
<font color=#447700>! Cloud sedimentation:<a name='2571'></font>
<a name='2572'>
<font color=#447700>! initialize logicals for presence of hydrometeor species to .false.<a name='2573'></font>
    log_qcpresent = .false.<a name='2574'>
<a name='2575'>
    do k = ktop,kbot,-kdir<a name='2576'>
<a name='2577'>
       inv_dzq(i,k) = 1./dzq(i,k)<a name='2578'>
<a name='2579'>
<font color=#447700>! calculate Q- and N-weighted fallspeeds and find highest k level that hydrometeor is present<a name='2580'></font>
<a name='2581'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#GET_CLOUD_DSD'>get_cloud_dsd</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_DSD_2">(qc(i,k),nc(i,k),mu_c(i,k),rho(i,k),nu(i,k),dnu,lamc(i,k), &amp;<a name='2582'>
                          lammin,lammax,k,tmp1,tmp2,qcindex,log_qcpresent)<a name='2583'>
<a name='2584'>
<font color=#447700>! droplet fall speed<a name='2585'></font>
<font color=#447700>! all droplets in smallest category fallspeed; thus, analytic solution can be used<a name='2586'></font>
<a name='2587'>
       if (qc(i,k).ge.qsmall) then<a name='2588'>
          dum = 1./lamc(i,k)**bcn<a name='2589'>
          if (log_predictNc) then<a name='2590'>
             Vt_nc(i,k) =  acn(i,k)*gamma(1.+bcn+mu_c(i,k))*dum/(gamma(mu_c(i,k)+1.))<a name='2591'>
          endif<a name='2592'>
          Vt_qc(i,k) = acn(i,k)*gamma(4.+bcn+mu_c(i,k))*dum/(gamma(mu_c(i,k)+4.))<a name='2593'>
       else<a name='2594'>
          if (log_predictNc) then<a name='2595'>
             Vt_nc(i,k) = 0.<a name='2596'>
          endif<a name='2597'>
          Vt_qc(i,k) = 0.<a name='2598'>
       endif<a name='2599'>
<a name='2600'>
    enddo <font color=#447700>! k-loop<a name='2601'></font>
<a name='2602'>
    if (log_qcpresent) then<a name='2603'>
<a name='2604'>
<font color=#447700>! sedimentation of mass<a name='2605'></font>
<a name='2606'>
       nstep = 1<a name='2607'>
       do k = qcindex+kdir,kbot,-kdir<a name='2608'>
<a name='2609'>
         <font color=#447700>!- weighted fall speed arrays used for sedimentation calculations<a name='2610'></font>
         <font color=#447700>!  (assigned below to highest non-zero level value at lower levels with Vt_x=0)<a name='2611'></font>
          V_qc(K)  = Vt_qc(i,k)<a name='2612'>
<a name='2613'>
          if (kdir.eq.1) then<a name='2614'>
             if (k.le.qcindex-kdir) then<a name='2615'>
                if (V_qc(k).lt.1.E-10) then<a name='2616'>
                   V_qc(k) = V_qc(k+kdir)<a name='2617'>
                endif<a name='2618'>
             endif<a name='2619'>
          elseif (kdir.eq.-1) then<a name='2620'>
             if (k.ge.qcindex-kdir) then<a name='2621'>
                if (V_qc(k).lt.1.e-10) then<a name='2622'>
                   V_qc(k) = V_qc(k+kdir)<a name='2623'>
                endif<a name='2624'>
             endif<a name='2625'>
          endif<a name='2626'>
<a name='2627'>
<font color=#447700>! calculate number of split time steps<a name='2628'></font>
          rgvm       = V_qc(k)<a name='2629'>
          nstep      = max(int(rgvm*dt*inv_dzq(i,k)+1.),nstep)<a name='2630'>
          dum_qc(k)  = qc(i,k)*rho(i,k)<a name='2631'>
          tend_qc(K) = 0.<a name='2632'>
<a name='2633'>
       enddo <font color=#447700>! k-loop<a name='2634'></font>
<a name='2635'>
       inv_nstep = 1./real(nstep)<a name='2636'>
<a name='2637'>
       if (nstep.ge.100) then<a name='2638'>
          print*,'CLOUD nstep LARGE:',i,nstep<a name='2639'>
          stop<a name='2640'>
       endif<a name='2641'>
<a name='2642'>
<font color=#447700>! calculate sedimentation using first-order upwind method<a name='2643'></font>
       tmp1 = 0.<a name='2644'>
       do n = 1,nstep<a name='2645'>
<a name='2646'>
          do k = kbot,qcindex,kdir<a name='2647'>
             flux_qc(k) = V_qc(k)*dum_qc(k)<a name='2648'>
          enddo<a name='2649'>
          tmp1 = tmp1 + flux_qc(kbot)  <font color=#447700>!sum flux_ at lowest level for averaging over sub-stepping<a name='2650'></font>
<a name='2651'>
<font color=#447700>! top level with hydrometeor present<a name='2652'></font>
          k = qcindex<a name='2653'>
          fluxdiv_qc = flux_qc(k)*inv_dzq(i,k)<a name='2654'>
          tend_qc(k) = tend_qc(k)-fluxdiv_qc*inv_nstep*inv_rho(i,k)<a name='2655'>
          dum_qc(k)  = dum_qc(k)-fluxdiv_qc*dt*inv_nstep<a name='2656'>
<a name='2657'>
<font color=#447700>! loop from sceond to top level of hydrometeor to surface<a name='2658'></font>
          do k = qcindex-kdir,kbot,-kdir<a name='2659'>
             fluxdiv_qc = (flux_qc(k+kdir)-flux_qc(K))*inv_dzq(i,k)<a name='2660'>
             tend_qc(k) = tend_qc(k)+fluxdiv_qc*inv_nstep*inv_rho(i,k)<a name='2661'>
             dum_qc(k)  = dum_qc(k)+fluxdiv_qc*dt*inv_nstep<a name='2662'>
          enddo <font color=#447700>! k loop<a name='2663'></font>
<a name='2664'>
       enddo <font color=#447700>! nstep-loop<a name='2665'></font>
<a name='2666'>
       do k = kbot,qcindex,kdir<a name='2667'>
          qc(i,k) = qc(i,k)+tend_qc(k)*dt<a name='2668'>
       enddo<a name='2669'>
<a name='2670'>
<font color=#447700>! compute cloud contribution to liquid precipitation rate at surface<a name='2671'></font>
       tmp1 = tmp1*inv_nstep           <font color=#447700>!flux_ at surface, averaged over sub-step<a name='2672'></font>
       pcprt_liq(i) = tmp1*inv_rhow    <font color=#447700>!convert flux_ (kg m-2 s-1) to pcp rate (m s-1)<a name='2673'></font>
<a name='2674'>
<font color=#447700>!.......................................................................................<a name='2675'></font>
<font color=#447700>! sedimentation of number<a name='2676'></font>
<a name='2677'>
       if (log_predictNc) then<a name='2678'>
<a name='2679'>
       nstep = 1<a name='2680'>
       do k = qcindex+kdir,kbot,-kdir<a name='2681'>
<a name='2682'>
         <font color=#447700>!- weighted fall speed arrays used for sedimentation calculations<a name='2683'></font>
         <font color=#447700>!  (assigned below to highest non-zero level value at lower levels with Vt_x=0)<a name='2684'></font>
          V_nc(K) = Vt_nc(i,k)<a name='2685'>
<a name='2686'>
          if (kdir.eq.1) then<a name='2687'>
             if (k.le.qcindex-kdir) then<a name='2688'>
                if (V_nc(k).lt.1.E-10) then<a name='2689'>
                   V_nc(k) = V_nc(k+kdir)<a name='2690'>
                endif<a name='2691'>
             endif<a name='2692'>
          elseif (kdir.eq.-1) then<a name='2693'>
             if (k.ge.qcindex-kdir) then<a name='2694'>
                if (V_nc(k).lt.1.e-10) then<a name='2695'>
                   V_nc(k) = V_nc(k+kdir)<a name='2696'>
                endif<a name='2697'>
             endif<a name='2698'>
          endif<a name='2699'>
<a name='2700'>
<font color=#447700>! calculate number of split time steps<a name='2701'></font>
          rgvm       = V_nc(k)<a name='2702'>
          nstep      = max(int(rgvm*dt*inv_dzq(i,k)+1.),nstep)<a name='2703'>
          dum_nc(k)  = nc(i,k)*rho(i,k)<a name='2704'>
          tend_nc(K) = 0.<a name='2705'>
<a name='2706'>
       enddo <font color=#447700>! k-loop<a name='2707'></font>
<a name='2708'>
       inv_nstep = 1./real(nstep)<a name='2709'>
<a name='2710'>
       if (nstep.ge.100) then<a name='2711'>
          print*,'CLOUD nstep LARGE:',i,nstep<a name='2712'>
          stop<a name='2713'>
       endif<a name='2714'>
<a name='2715'>
<font color=#447700>! calculate sedimentation using first-order upwind method<a name='2716'></font>
       do n = 1,nstep<a name='2717'>
<a name='2718'>
          do k = kbot,qcindex,kdir<a name='2719'>
             flux_nc(k) = V_nc(k)*dum_nc(k)<a name='2720'>
          enddo<a name='2721'>
<a name='2722'>
<font color=#447700>! top level with hydrometeor present<a name='2723'></font>
          k = qcindex<a name='2724'>
          fluxdiv_nc = flux_nc(k)*inv_dzq(i,k)<a name='2725'>
          tend_nc(k) = tend_nc(k)-fluxdiv_nc*inv_nstep*inv_rho(i,k)<a name='2726'>
          dum_nc(k)  = dum_nc(k)-fluxdiv_nc*dt*inv_nstep<a name='2727'>
<a name='2728'>
<font color=#447700>! loop from sceond to top level of hydrometeor to surface<a name='2729'></font>
          do k = qcindex-kdir,kbot,-kdir<a name='2730'>
<a name='2731'>
             fluxdiv_nc = (flux_nc(k+kdir)-flux_nc(K))*inv_dzq(i,k)<a name='2732'>
             tend_nc(k) = tend_nc(k)+fluxdiv_nc*inv_nstep*inv_rho(i,k)<a name='2733'>
             dum_nc(k)  = dum_nc(k)+fluxdiv_nc*dt*inv_nstep<a name='2734'>
<a name='2735'>
          enddo <font color=#447700>! k loop<a name='2736'></font>
<a name='2737'>
       enddo <font color=#447700>! nstep-loop<a name='2738'></font>
<a name='2739'>
       do k = kbot,qcindex,kdir<a name='2740'>
          nc(i,k) = nc(i,k)+tend_nc(k)*dt<a name='2741'>
       enddo<a name='2742'>
<a name='2743'>
    endif <font color=#447700>! log_predictNc<a name='2744'></font>
<a name='2745'>
    endif <font color=#447700>! log_qcpresent<a name='2746'></font>
<a name='2747'>
<a name='2748'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='2749'></font>
<font color=#447700>! Rain sedimentation:<a name='2750'></font>
<a name='2751'>
    log_qrpresent = .false.<a name='2752'>
<a name='2753'>
    do k = ktop,kbot,-kdir<a name='2754'>
<a name='2755'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#GET_RAIN_DSD'>get_rain_dsd</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_RAIN_DSD_2">(qr(i,k),nr(i,k),mu_r(i,k),rdumii,dumii,lamr(i,k),mu_r_table,    &amp;<a name='2756'>
                         tmp1,tmp2,log_qrpresent,qrindex,k)<a name='2757'>
       <font color=#447700>!note: tmp1,tmp2 are not used in this section<a name='2758'></font>
<a name='2759'>
       if (qr(i,k).ge.qsmall) then<a name='2760'>
<a name='2761'>
       <font color=#447700>! read in fall mass- and number-weighted fall speeds from lookup table<a name='2762'></font>
          call <A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_3'>find_lookupTable_indices_3</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_LOOKUPTABLE_INDICES_3_2">(dumii,dumjj,dum1,rdumii,rdumjj,inv_dum3,       &amp;<a name='2763'>
                                          mu_r(i,k),lamr(i,k))<a name='2764'>
<a name='2765'>
     <font color=#447700>! number-weighted fall speed:<a name='2766'></font>
       <font color=#447700>!at mu_r:<a name='2767'></font>
          dum1 = vn_table(dumii,dumjj)+(rdumii-real(dumii))*inv_dum3*                    &amp;<a name='2768'>
                 (vn_table(dumii+1,dumjj)-vn_table(dumii,dumjj))<a name='2769'>
       <font color=#447700>!at mu_r+1:<a name='2770'></font>
          dum2 = vn_table(dumii,dumjj+1)+(rdumii-real(dumii))*                           &amp;<a name='2771'>
                 inv_dum3*(vn_table(dumii+1,dumjj+1)-vn_table(dumii,dumjj+1))<a name='2772'>
       <font color=#447700>!interpolated:<a name='2773'></font>
          Vt_nr(i,k) = dum1+(rdumjj-real(dumjj))*(dum2-dum1)<a name='2774'>
          Vt_nr(i,k) = Vt_nr(i,k)*rhofacr(i,k)<a name='2775'>
<a name='2776'>
      <font color=#447700>! mass-weighted fall speed:<a name='2777'></font>
       <font color=#447700>!at mu_r:<a name='2778'></font>
          dum1 = vm_table(dumii,dumjj)+(rdumii-real(dumii))*inv_dum3*                    &amp;<a name='2779'>
                 (vm_table(dumii+1,dumjj)-vm_table(dumii,dumjj))<a name='2780'>
       <font color=#447700>!at mu_r+1:<a name='2781'></font>
          dum2 = vm_table(dumii,dumjj+1)+(rdumii-real(dumii))*inv_dum3*                  &amp;<a name='2782'>
                 (vm_table(dumii+1,dumjj+1)-vm_table(dumii,dumjj+1))<a name='2783'>
<a name='2784'>
       <font color=#447700>!interpolated:<a name='2785'></font>
          Vt_qr(i,k) = dum1 + (rdumjj-real(dumjj))*(dum2-dum1)<a name='2786'>
          Vt_qr(i,k) = Vt_qr(i,k)*rhofacr(i,k)<a name='2787'>
<a name='2788'>
       else<a name='2789'>
<a name='2790'>
          Vt_nr(i,k) = 0.<a name='2791'>
          Vt_qr(i,k) = 0.<a name='2792'>
<a name='2793'>
       endif<a name='2794'>
<a name='2795'>
    enddo <font color=#447700>! k-loop<a name='2796'></font>
<a name='2797'>
    if (log_qrpresent) then<a name='2798'>
<a name='2799'>
       nstep = 1<a name='2800'>
<a name='2801'>
       do k = qrindex+kdir,kbot,-kdir<a name='2802'>
<a name='2803'>
         <font color=#447700>!- weighted fall speed arrays used for sedimentation calculations<a name='2804'></font>
         <font color=#447700>!  (assigned below to highest non-zero level value at lower levels with Vt_x=0)<a name='2805'></font>
          V_qr(k) = Vt_qr(i,k)<a name='2806'>
          V_nr(k) = Vt_nr(i,k)<a name='2807'>
<a name='2808'>
          if (kdir.eq.1) then<a name='2809'>
             if (k.le.qrindex-kdir) then<a name='2810'>
                if (V_qr(k).lt.1.e-10) then<a name='2811'>
                   V_qr(k) = V_qr(k+kdir)<a name='2812'>
                endif<a name='2813'>
                if (V_nr(k).lt.1.e-10) then<a name='2814'>
                   V_nr(k) = V_nr(k+kdir)<a name='2815'>
                endif<a name='2816'>
             endif<a name='2817'>
          elseif (kdir.eq.-1) then<a name='2818'>
             if (k.ge.qrindex-kdir) then<a name='2819'>
                if (V_qr(k).lt.1.e-10) then<a name='2820'>
                   V_qr(k) = V_qr(k+kdir)<a name='2821'>
                endif<a name='2822'>
                if (V_nr(k).lt.1.e-10) then<a name='2823'>
                   V_nr(k) = V_nr(k+kdir)<a name='2824'>
                endif<a name='2825'>
             endif<a name='2826'>
          endif<a name='2827'>
<a name='2828'>
       <font color=#447700>! calculate number of split time steps<a name='2829'></font>
          rgvm       = max(V_qr(k),V_nr(k))<a name='2830'>
          nstep      = max(int(rgvm*dt*inv_dzq(i,k)+1.),nstep)<a name='2831'>
          dum_qr(k)  = qr(i,k)*rho(i,k)<a name='2832'>
          dum_nr(k)  = nr(i,k)*rho(i,k)<a name='2833'>
          tend_qr(k) = 0.<a name='2834'>
          tend_nr(k) = 0.<a name='2835'>
<a name='2836'>
       enddo <font color=#447700>! k-loop<a name='2837'></font>
<a name='2838'>
       inv_nstep = 1./real(nstep)<a name='2839'>
<a name='2840'>
       if (nstep .ge. 100) then<a name='2841'>
          print*,'RAIN nstep LARGE:',i,nstep<a name='2842'>
          stop<a name='2843'>
       endif<a name='2844'>
<a name='2845'>
<font color=#447700>!--test:  explicitly calculate pcp rate:<a name='2846'></font>
<font color=#447700>! pcprt_liq(i) = qr(i,kbot)*rho(i,kbot)*Vt_qr(i,kbot)*1.e-3  !m s-1<a name='2847'></font>
<font color=#447700>!==<a name='2848'></font>
<a name='2849'>
<font color=#447700>! calculate sedimentation using first-order upwind method<a name='2850'></font>
       tmp1 = 0.<a name='2851'>
       do n = 1,nstep<a name='2852'>
<a name='2853'>
          do k = kbot,qrindex,kdir<a name='2854'>
             flux_qr(k) = V_qr(k)*dum_qr(k)<a name='2855'>
             flux_nr(k) = V_nr(k)*dum_nr(k)<a name='2856'>
          enddo<a name='2857'>
          tmp1 = tmp1 + flux_qr(kbot)  <font color=#447700>!sum flux_ at lowest level for averaging over sub-stepping<a name='2858'></font>
<a name='2859'>
<font color=#447700>! top level with hydrometeor present<a name='2860'></font>
          k          = qrindex<a name='2861'>
          fluxdiv_qr = flux_qr(k)*inv_dzq(i,k)<a name='2862'>
          fluxdiv_nr = flux_nr(k)*inv_dzq(i,k)<a name='2863'>
          tend_qr(k) = tend_qr(k) - fluxdiv_qr*inv_nstep*inv_rho(i,k)<a name='2864'>
          tend_nr(k) = tend_nr(k) - fluxdiv_nr*inv_nstep*inv_rho(i,k)<a name='2865'>
          dum_qr(k)  = dum_qr(k)  - fluxdiv_qr*dt*inv_nstep<a name='2866'>
          dum_nr(k)  = dum_nr(k)  - fluxdiv_nr*dt*inv_nstep<a name='2867'>
<a name='2868'>
<font color=#447700>! loop from second to top level of hydrometeor to surface<a name='2869'></font>
          do k = qrindex-kdir,kbot,-kdir<a name='2870'>
             fluxdiv_qr = (flux_qr(k+kdir) - flux_qr(K))*inv_dzq(i,k)<a name='2871'>
             fluxdiv_nr = (flux_nr(k+kdir) - flux_nr(K))*inv_dzq(i,k)<a name='2872'>
             tend_qr(k) = tend_qr(k) + fluxdiv_qr*inv_nstep*inv_rho(i,k)<a name='2873'>
             tend_nr(k) = tend_nr(k) + fluxdiv_nr*inv_nstep*inv_rho(i,k)<a name='2874'>
             dum_qr(k)  = dum_qr(k)  + fluxdiv_qr*dt*inv_nstep<a name='2875'>
             dum_nr(k)  = dum_nr(k)  + fluxdiv_nr*dt*inv_nstep<a name='2876'>
          enddo <font color=#447700>! k loop<a name='2877'></font>
<a name='2878'>
       enddo <font color=#447700>! nstep loop<a name='2879'></font>
<a name='2880'>
<font color=#447700>! update prognostic variables with sedimentation tendencies<a name='2881'></font>
       do k = kbot,qrindex,kdir<a name='2882'>
          qr(i,k) = qr(i,k) + tend_qr(k)*dt<a name='2883'>
          nr(i,k) = nr(i,k) + tend_nr(k)*dt<a name='2884'>
       enddo<a name='2885'>
<a name='2886'>
<font color=#447700>! add rain component of liquid precipitation rate at surface<a name='2887'></font>
       tmp1 = tmp1*inv_nstep               <font color=#447700>!flux_ at surface, averaged over sub-step<a name='2888'></font>
       tmp1 = tmp1*inv_rhow                <font color=#447700>!convert flux_ (kg m-2 s-1) to pcp rate (m s-1)<a name='2889'></font>
<a name='2890'>
       pcprt_liq(i) = pcprt_liq(i) + tmp1  <font color=#447700>!add pcp rate from cloud and rain<a name='2891'></font>
<a name='2892'>
    endif <font color=#447700>! log_qrpresent<a name='2893'></font>
<a name='2894'>
<a name='2895'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='2896'></font>
<font color=#447700>! Ice sedimentation:<a name='2897'></font>
<a name='2898'>
    iice_loop_sedi_ice:  do iice = 1,nCat<a name='2899'>
<a name='2900'>
       log_qipresent = .false.  <font color=#447700>!note: this applies to ice category 'iice' only<a name='2901'></font>
<a name='2902'>
       do k = ktop,kbot,-kdir<a name='2903'>
<a name='2904'>
<font color=#447700>! get ice fallspeed for updated variables<a name='2905'></font>
          qitot_not_small: if (qitot(i,k,iice).ge.qsmall) then<a name='2906'>
<a name='2907'>
            <font color=#447700>!impose lower limits to prevent taking log of # &lt; 0<a name='2908'></font>
             nitot(i,k,iice) = max(nitot(i,k,iice),nsmall)<a name='2909'>
<a name='2910'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#CALC_BULKRHORIME'>calc_bulkRhoRime</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_BULKRHORIME_3">(qitot(i,k,iice),qirim(i,k,iice),birim(i,k,iice),rhop)<a name='2911'>
<a name='2912'>
           <font color=#447700>! if (.not. tripleMoment_on) zitot(i,k,iice) = diag_mom6(qitot(i,k,iice),nitot(i,k,iice),rho(i,k))<a name='2913'></font>
             call <A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_1A'>find_lookupTable_indices_1a</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_LOOKUPTABLE_INDICES_1A_2">(dumi,dumjj,dumii,dumzz,dum1,dum4,dum5,     &amp;<a name='2914'>
                                       dum6,isize,rimsize,densize,zsize,qitot(i,k,iice), &amp;<a name='2915'>
                                       nitot(i,k,iice),qirim(i,k,iice),999.,rhop)<a name='2916'>
                                      <font color=#447700>!nitot(i,k,iice),qirim(i,k,iice),zitot(i,k,iice),rhop)<a name='2917'></font>
<a name='2918'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_8">(dumjj,dumii,dumi, 1,dum1,dum4,dum5,f1pr01)<a name='2919'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_9">(dumjj,dumii,dumi, 2,dum1,dum4,dum5,f1pr02)<a name='2920'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_10">(dumjj,dumii,dumi, 7,dum1,dum4,dum5,f1pr09)<a name='2921'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_11">(dumjj,dumii,dumi, 8,dum1,dum4,dum5,f1pr10)<a name='2922'>
<font color=#447700>!-- future (3-moment ice)<a name='2923'></font>
<font color=#447700>!            call access_lookup_table(dumzz,dumjj,dumii,dumi, 1,dum1,dum4,dum5,dum6,f1pr01)<a name='2924'></font>
<font color=#447700>!            call access_lookup_table(dumzz,dumjj,dumii,dumi, 2,dum1,dum4,dum5,dum6,f1pr02)<a name='2925'></font>
<font color=#447700>!            call access_lookup_table(dumzz,dumjj,dumii,dumi, 7,dum1,dum4,dum5,dum6,f1pr09)<a name='2926'></font>
<font color=#447700>!            call access_lookup_table(dumzz,dumjj,dumii,dumi, 8,dum1,dum4,dum5,dum6,f1pr10)<a name='2927'></font>
<font color=#447700>!            call access_lookup_table(dumzz,dumjj,dumii,dumi,13,dum1,dum4,dum5,dum6,f1pr19)   !mom6-weighted V<a name='2928'></font>
<font color=#447700>!            call access_lookup_table(dumzz,dumjj,dumii,dumi,14,dum1,dum4,dum5,dum6,f1pr020)   !z_max<a name='2929'></font>
<font color=#447700>!            call access_lookup_table(dumzz,dumjj,dumii,dumi,15,dum1,dum4,dum5,dum6,f1pr021)   !z_min<a name='2930'></font>
<font color=#447700>!==<a name='2931'></font>
<a name='2932'>
          <font color=#447700>! impose mean ice size bounds (i.e. apply lambda limiters)<a name='2933'></font>
          <font color=#447700>! note that the Nmax and Nmin are normalized and thus need to be multiplied by existing N<a name='2934'></font>
             nitot(i,k,iice) = min(nitot(i,k,iice),f1pr09*nitot(i,k,iice))<a name='2935'>
             nitot(i,k,iice) = max(nitot(i,k,iice),f1pr10*nitot(i,k,iice))<a name='2936'>
<a name='2937'>
<font color=#447700>! adjust Zi if needed to make sure mu_i is in bounds<a name='2938'></font>
<font color=#447700>!            zitot(i,k,iice) = min(zitot(i,k,iice),f1pr020)<a name='2939'></font>
<font color=#447700>!            zitot(i,k,iice) = max(zitot(i,k,iice),f1pr021)<a name='2940'></font>
<a name='2941'>
             if (.not. log_qipresent) then<a name='2942'>
                qiindex = k<a name='2943'>
             endif<a name='2944'>
             log_qipresent = .true.<a name='2945'>
<a name='2946'>
             Vt_nit(i,k) = f1pr01*rhofaci(i,k)     <font color=#447700>!number-weighted    fall speed (with density factor)<a name='2947'></font>
             Vt_qit(i,k) = f1pr02*rhofaci(i,k)     <font color=#447700>!mass-weighted  fall speed (with density factor)<a name='2948'></font>
          <font color=#447700>!  Vt_zit(i,k) = f1pr19*rhofaci(i,k)     !moment6-weighted fall speed (with density factor)<a name='2949'></font>
             diag_vmi(i,k,iice) = f1pr02           <font color=#447700>!output fallspeed, w/o density correction<a name='2950'></font>
<a name='2951'>
          else<a name='2952'>
<a name='2953'>
             Vt_nit(i,k) = 0.<a name='2954'>
             Vt_qit(i,k) = 0.<a name='2955'>
           <font color=#447700>! Vt_zit(i,k) = 0.<a name='2956'></font>
<a name='2957'>
          endif qitot_not_small<a name='2958'>
<a name='2959'>
       enddo <font color=#447700>! k-loop<a name='2960'></font>
<a name='2961'>
       qipresent: if (log_qipresent) then<a name='2962'>
<a name='2963'>
          nstep = 1<a name='2964'>
<a name='2965'>
          do k = qiindex+kdir,kbot,-kdir<a name='2966'>
<a name='2967'>
            <font color=#447700>!- weighted fall speed arrays used for sedimentation calculations<a name='2968'></font>
            <font color=#447700>!  (assigned below to highest non-zero level value at lower levels with Vt_x=0)<a name='2969'></font>
             V_qit(k) = Vt_qit(i,k)<a name='2970'>
             V_nit(k) = Vt_nit(i,k)<a name='2971'>
          <font color=#447700>!  V_zit(k) = Vt_zit(i,k)<a name='2972'></font>
<a name='2973'>
            <font color=#447700>!--fill in fall speeds levels below lowest level with hydrometeors<a name='2974'></font>
             if (kdir.eq.1) then<a name='2975'>
                if (k.le.qiindex-kdir) then<a name='2976'>
                   if (V_qit(k).lt.1.e-10)  V_qit(k) = V_qit(k+kdir)<a name='2977'>
                   if (V_nit(k).lt.1.e-10)  V_nit(k) = V_nit(k+kdir)<a name='2978'>
                 <font color=#447700>! if (V_zit(k).lt.1.e-10)  V_zit(k) = V_zit(k+kdir)<a name='2979'></font>
                endif<a name='2980'>
             elseif (kdir.eq.-1) then<a name='2981'>
                if (k.ge.qiindex-kdir) then<a name='2982'>
                   if (V_qit(k).lt.1.e-10)  V_qit(k) = V_qit(k+kdir)<a name='2983'>
                   if (V_nit(k).lt.1.e-10)  V_nit(k) = V_nit(k+kdir)<a name='2984'>
                 <font color=#447700>! if (V_zit(k).lt.1.e-10)  V_zit(k) = V_zit(k+kdir)<a name='2985'></font>
                endif<a name='2986'>
             endif <font color=#447700>! kdir<a name='2987'></font>
            <font color=#447700>!==<a name='2988'></font>
<a name='2989'>
<font color=#447700>! calculate number of split time steps<a name='2990'></font>
             rgvm        = max(V_qit(k),V_nit(k))<a name='2991'>
<font color=#447700>!            rgvm        = max(V_zit(k),max(V_qit(k),V_nit(k)))<a name='2992'></font>
             nstep       = max(int(rgvm*dt*inv_dzq(i,k)+1.),nstep)<a name='2993'>
             dum_qit(k)  = qitot(i,k,iice)*rho(i,k)<a name='2994'>
             dum_qir(k)  = qirim(i,k,iice)*rho(i,k)<a name='2995'>
             dum_bir(k)  = birim(i,k,iice)*rho(i,k)<a name='2996'>
             dum_nit(k)  = nitot(i,k,iice)*rho(i,k)<a name='2997'>
<font color=#447700>!            dum_zit(k)  = zitot(i,k,iice)*rho(i,k)<a name='2998'></font>
             tend_qit(k) = 0.<a name='2999'>
             tend_qir(k) = 0.<a name='3000'>
             tend_bir(k) = 0.<a name='3001'>
             tend_nit(k) = 0.<a name='3002'>
<font color=#447700>!            tend_zit(k) = 0.<a name='3003'></font>
<a name='3004'>
          enddo <font color=#447700>! k loop<a name='3005'></font>
<a name='3006'>
          inv_nstep = 1./real(nstep)<a name='3007'>
<a name='3008'>
          if (nstep.ge.200) then<a name='3009'>
             print*,'ICE nstep LARGE:',i,nstep<a name='3010'>
             if (nstep.ge.500) stop<a name='3011'>
          endif<a name='3012'>
<a name='3013'>
<font color=#447700>! calculate sedimentation using first-order upwind method<a name='3014'></font>
          tmp1 = 0.<a name='3015'>
          do n = 1,nstep<a name='3016'>
<a name='3017'>
             do k = kbot,qiindex,kdir<a name='3018'>
                flux_qit(k) = V_qit(k)*dum_qit(k)<a name='3019'>
                flux_nit(k) = V_nit(k)*dum_nit(k)<a name='3020'>
                flux_qir(k) = V_qit(k)*dum_qir(k)<a name='3021'>
                flux_bir(k) = V_qit(k)*dum_bir(k)<a name='3022'>
<font color=#447700>!               flux_zit(k) = V_zit(k)*dum_zit(k)<a name='3023'></font>
             enddo<a name='3024'>
            tmp1 = tmp1 + flux_qit(kbot)  <font color=#447700>!sum flux_ at lowest level for averaging over sub-stepping<a name='3025'></font>
<a name='3026'>
<font color=#447700>! top level with hydrometeor present<a name='3027'></font>
             k = qiindex<a name='3028'>
             fluxdiv_qit = flux_qit(k)*inv_dzq(i,k)<a name='3029'>
             fluxdiv_qir = flux_qir(k)*inv_dzq(i,k)<a name='3030'>
             fluxdiv_bir = flux_bir(k)*inv_dzq(i,k)<a name='3031'>
             fluxdiv_nit = flux_nit(k)*inv_dzq(i,k)<a name='3032'>
<font color=#447700>!            fluxdiv_zit = flux_zit(k)*inv_dzq(i,k)<a name='3033'></font>
<a name='3034'>
             tend_qit(k) = tend_qit(k) - fluxdiv_qit*inv_nstep*inv_rho(i,k)<a name='3035'>
             tend_qir(k) = tend_qir(k) - fluxdiv_qir*inv_nstep*inv_rho(i,k)<a name='3036'>
             tend_bir(k) = tend_bir(k) - fluxdiv_bir*inv_nstep*inv_rho(i,k)<a name='3037'>
             tend_nit(k) = tend_nit(k) - fluxdiv_nit*inv_nstep*inv_rho(i,k)<a name='3038'>
<font color=#447700>!            tend_zit(k) = tend_zit(k) - fluxdiv_zit*inv_nstep*inv_rho(i,k)<a name='3039'></font>
<a name='3040'>
             dum_qit(k) = dum_qit(k) - fluxdiv_qit*dt*inv_nstep<a name='3041'>
             dum_qir(k) = dum_qir(k) - fluxdiv_qir*dt*inv_nstep<a name='3042'>
             dum_bir(k) = dum_bir(k) - fluxdiv_bir*dt*inv_nstep<a name='3043'>
             dum_nit(k) = dum_nit(k) - fluxdiv_nit*dt*inv_nstep<a name='3044'>
<font color=#447700>!            dum_zit(k) = dum_zit(k) - fluxdiv_zit*dt*inv_nstep<a name='3045'></font>
<a name='3046'>
<font color=#447700>! loop from sceond to top level of hydrometeor to surface<a name='3047'></font>
             do k = qiindex-kdir,kbot,-kdir<a name='3048'>
                fluxdiv_qit = (flux_qit(k+kdir) - flux_qit(k))*inv_dzq(i,k)<a name='3049'>
                fluxdiv_qir = (flux_qir(k+kdir) - flux_qir(k))*inv_dzq(i,k)<a name='3050'>
                fluxdiv_bir = (flux_bir(k+kdir) - flux_bir(k))*inv_dzq(i,k)<a name='3051'>
                fluxdiv_nit = (flux_nit(k+kdir) - flux_nit(k))*inv_dzq(i,k)<a name='3052'>
<font color=#447700>!               fluxdiv_zit = (flux_zit(k+kdir) - flux_zit(k))*inv_dzq(i,k)<a name='3053'></font>
<a name='3054'>
                tend_qit(k) = tend_qit(k) + fluxdiv_qit*inv_nstep*inv_rho(i,k)<a name='3055'>
                tend_qir(k) = tend_qir(k) + fluxdiv_qir*inv_nstep*inv_rho(i,k)<a name='3056'>
                tend_bir(k) = tend_bir(k) + fluxdiv_bir*inv_nstep*inv_rho(i,k)<a name='3057'>
                tend_nit(k) = tend_nit(k) + fluxdiv_nit*inv_nstep*inv_rho(i,k)<a name='3058'>
<font color=#447700>!               tend_zit(k) = tend_zit(k) + fluxdiv_zit*inv_nstep*inv_rho(i,k)<a name='3059'></font>
<a name='3060'>
                dum_qit(k) = dum_qit(k) + fluxdiv_qit*dt*inv_nstep<a name='3061'>
                dum_qir(k) = dum_qir(k) + fluxdiv_qir*dt*inv_nstep<a name='3062'>
                dum_bir(k) = dum_bir(k) + fluxdiv_bir*dt*inv_nstep<a name='3063'>
                dum_nit(k) = dum_nit(k) + fluxdiv_nit*dt*inv_nstep<a name='3064'>
 <font color=#447700>!              dum_zit(k) = dum_nit(k) + fluxdiv_nit*dt*inv_nstep<a name='3065'></font>
             enddo <font color=#447700>! k loop<a name='3066'></font>
<a name='3067'>
          enddo <font color=#447700>! nstep loop<a name='3068'></font>
<a name='3069'>
<font color=#447700>! update prognostic variables with sedimentation tendencies<a name='3070'></font>
          do k = kbot,qiindex,kdir<a name='3071'>
             qitot(i,k,iice) = qitot(i,k,iice) + tend_qit(k)*dt<a name='3072'>
             qirim(i,k,iice) = qirim(i,k,iice) + tend_qir(k)*dt<a name='3073'>
             birim(i,k,iice) = birim(i,k,iice) + tend_bir(k)*dt<a name='3074'>
             nitot(i,k,iice) = nitot(i,k,iice) + tend_nit(k)*dt<a name='3075'>
<font color=#447700>!            zitot(i,k,iice) = zitot(i,k,iice) + tend_zit(k)*dt<a name='3076'></font>
          enddo<a name='3077'>
<a name='3078'>
<font color=#447700>! add contirubtion from iice to solid precipitation rate at surface<a name='3079'></font>
          tmp1 = tmp1*inv_nstep   <font color=#447700>!flux_ at surface, averaged over sub-step<a name='3080'></font>
          tmp1 = tmp1*inv_rhow    <font color=#447700>!convert flux_ (kg m-2 s-1) to pcp rate (m s-1), liquid-equivalent<a name='3081'></font>
          pcprt_sol(i) = pcprt_sol(i) + tmp1  <font color=#447700>!add pcp rate from<a name='3082'></font>
<a name='3083'>
       endif qipresent<a name='3084'>
<a name='3085'>
    enddo iice_loop_sedi_ice  <font color=#447700>!iice-loop<a name='3086'></font>
<a name='3087'>
<font color=#447700>!  if (debug_ON) call check_values(qv,T,qc,qr,nr,qitot,qirim,nitot,birim,i,it,.true.,debug_ABORT,600)<a name='3088'></font>
<a name='3089'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='3090'></font>
<font color=#447700>! End of sedimentation section<a name='3091'></font>
<font color=#447700>!==========================================================================================!<a name='3092'></font>
<a name='3093'>
<font color=#447700>!.......................................<a name='3094'></font>
<font color=#447700>! homogeneous freezing of cloud and rain<a name='3095'></font>
<a name='3096'>
    k_loop_fz:  do k = kbot,ktop,kdir<a name='3097'>
<a name='3098'>
    <font color=#447700>! compute mean-mass ice diameters (estimated; rigorous approach to be implemented later)<a name='3099'></font>
       diam_ice(i,k,:) = 0.<a name='3100'>
       do iice = 1,nCat<a name='3101'>
          if (qitot(i,k,iice).ge.qsmall) then<a name='3102'>
             dum1 = max(nitot(i,k,iice),nsmall)<a name='3103'>
             dum2 = 500. <font color=#447700>!ice density<a name='3104'></font>
             diam_ice(i,k,iice) = ((qitot(i,k,iice)*6.)/(dum1*dum2*pi))**thrd<a name='3105'>
          endif<a name='3106'>
       enddo  <font color=#447700>!iice loop<a name='3107'></font>
<a name='3108'>
       if (qc(i,k).ge.qsmall .and. t(i,k).lt.233.15) then<a name='3109'>
          Q_nuc = qc(i,k)<a name='3110'>
          N_nuc = max(nc(i,k),nsmall)<a name='3111'>
         <font color=#447700>!--determine destination ice-phase category:<a name='3112'></font>
          dum1   = 900.     <font color=#447700>!density of new ice<a name='3113'></font>
          D_new  = ((Q_nuc*6.)/(pi*dum1*N_nuc))**thrd<a name='3114'>
          call <A href='../../html_code/phys/module_mp_p3.F.html#ICECAT_DESTINATION'>icecat_destination</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICECAT_DESTINATION_5">(qitot(i,k,:),diam_ice(i,k,:),D_new,deltaD_init,       &amp;<a name='3115'>
                                  log_ni_add,iice_dest)<a name='3116'>
         <font color=#447700>!==<a name='3117'></font>
          qirim(i,k,iice_dest) = qirim(i,k,iice_dest) + Q_nuc<a name='3118'>
          qitot(i,k,iice_dest) = qitot(i,k,iice_dest) + Q_nuc<a name='3119'>
          birim(i,k,iice_dest) = birim(i,k,iice_dest) + Q_nuc*inv_rho_rimeMax<a name='3120'>
          nitot(i,k,iice_dest) = nitot(i,k,iice_dest) + N_nuc<a name='3121'>
          th(i,k) = th(i,k) + th(i,k)/t(i,k)*Q_nuc*xlf(i,k)*inv_cp<a name='3122'>
          qc(i,k) = 0.  <font color=#447700>!= qc(i,k) - Q_nuc<a name='3123'></font>
          nc(i,k) = 0.  <font color=#447700>!= nc(i,k) - N_nuc<a name='3124'></font>
       endif<a name='3125'>
<a name='3126'>
       if (qr(i,k).ge.qsmall .and. t(i,k).lt.233.15) then<a name='3127'>
          Q_nuc = qr(i,k)<a name='3128'>
          N_nuc = max(nr(i,k),nsmall)<a name='3129'>
         <font color=#447700>!--determine destination ice-phase category:<a name='3130'></font>
          dum1  = 900.     <font color=#447700>!density of new ice<a name='3131'></font>
          D_new = ((Q_nuc*6.)/(pi*dum1*N_nuc))**thrd<a name='3132'>
          call <A href='../../html_code/phys/module_mp_p3.F.html#ICECAT_DESTINATION'>icecat_destination</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ICECAT_DESTINATION_6">(qitot(i,k,:),diam_ice(i,k,:),D_new,deltaD_init,       &amp;<a name='3133'>
                                  log_ni_add,iice_dest)<a name='3134'>
         <font color=#447700>!==<a name='3135'></font>
          qirim(i,k,iice_dest) = qirim(i,k,iice_dest) + Q_nuc<a name='3136'>
          qitot(i,k,iice_dest) = qitot(i,k,iice_dest) + Q_nuc<a name='3137'>
          birim(i,k,iice_dest) = birim(i,k,iice_dest) + Q_nuc*inv_rho_rimeMax<a name='3138'>
          nitot(i,k,iice_dest) = nitot(i,k,iice_dest) + N_nuc<a name='3139'>
          th(i,k) = th(i,k) + th(i,k)/t(i,k)*Q_nuc*xlf(i,k)*inv_cp<a name='3140'>
          qr(i,k) = 0.  <font color=#447700>! = qr(i,k) - Q_nuc<a name='3141'></font>
          nr(i,k) = 0.  <font color=#447700>! = nr(i,k) - N_nuc<a name='3142'></font>
       endif<a name='3143'>
<a name='3144'>
    enddo k_loop_fz<a name='3145'>
<a name='3146'>
<font color=#447700>!  if (debug_ON) call check_values(qv,T,qc,qr,nr,qitot,qirim,nitot,birim,i,it,.true.,debug_ABORT,700)<a name='3147'></font>
<a name='3148'>
<font color=#447700>!...................................................<a name='3149'></font>
<font color=#447700>! final checks to ensure consistency of mass/number<a name='3150'></font>
<font color=#447700>! and compute diagnostic fields for output<a name='3151'></font>
<a name='3152'>
    k_loop_final_diagnostics:  do k = kbot,ktop,kdir<a name='3153'>
<a name='3154'>
    <font color=#447700>! cloud:<a name='3155'></font>
       if (qc(i,k).ge.qsmall) then<a name='3156'>
          call <A href='../../html_code/phys/module_mp_p3.F.html#GET_CLOUD_DSD'>get_cloud_dsd</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CLOUD_DSD_3">(qc(i,k),nc(i,k),mu_c(i,k),rho(i,k),nu(i,k),dnu,lamc(i,k),   &amp;<a name='3157'>
                             lammin,lammax,k,tmp1,tmp2,tmpint1,log_tmp1)<a name='3158'>
          diag_effc(i,k) = 0.5*(mu_c(i,k)+3.)/lamc(i,k)<a name='3159'>
       else<a name='3160'>
          qv(i,k) = qv(i,k)+qc(i,k)<a name='3161'>
          th(i,k) = th(i,k)-th(i,k)/t(i,k)*qc(i,k)*xxlv(i,k)*inv_cp<a name='3162'>
          qc(i,k) = 0.<a name='3163'>
          nc(i,k) = 0.<a name='3164'>
       endif<a name='3165'>
<a name='3166'>
    <font color=#447700>! rain:<a name='3167'></font>
       if (qr(i,k).ge.qsmall) then<a name='3168'>
          call <A href='../../html_code/phys/module_mp_p3.F.html#GET_RAIN_DSD'>get_rain_dsd</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_RAIN_DSD_3">(qr(i,k),nr(i,k),mu_r(i,k),rdumii,dumii,lamr(i,k),mu_r_table, &amp;<a name='3169'>
                            tmp1,tmp2,log_tmp1,tmpint1,tmpint2)<a name='3170'>
         <font color=#447700>! hm, turn off soft lambda limiter<a name='3171'></font>
         <font color=#447700>! impose size limits for rain with 'soft' lambda limiter<a name='3172'></font>
         <font color=#447700>! (adjusts over a set timescale rather than within one timestep)<a name='3173'></font>
         <font color=#447700>! dum2 = (qr(i,k)/(pi*rhow*nr(i,k)))**thrd<a name='3174'></font>
         <font color=#447700>! if (dum2.gt.dbrk) then<a name='3175'></font>
         <font color=#447700>!    dum   = qr(i,k)*cons4<a name='3176'></font>
         <font color=#447700>!   !dum1  = (dum-nr(i,k))/max(60.,dt)  !time scale for adjustment is 60 s<a name='3177'></font>
         <font color=#447700>!    dum1  = (dum-nr(i,k))*timeScaleFactor<a name='3178'></font>
         <font color=#447700>!     nr(i,k) = nr(i,k)+dum1*dt<a name='3179'></font>
         <font color=#447700>! endif<a name='3180'></font>
<a name='3181'>
         <font color=#447700>!diag_effr(i,k) = 0.5*(mu_r(i,k)+3.)/lamr(i,k)    (currently not used)<a name='3182'></font>
        <font color=#447700>! ze_rain(i,k) = n0r(i,k)*720./lamr(i,k)**3/lamr(i,k)**3/lamr(i,k)<a name='3183'></font>
          <font color=#447700>! non-exponential rain:<a name='3184'></font>
          ze_rain(i,k) = nr(i,k)*(mu_r(i,k)+6.)*(mu_r(i,k)+5.)*(mu_r(i,k)+4.)*           &amp;<a name='3185'>
                        (mu_r(i,k)+3.)*(mu_r(i,k)+2.)*(mu_r(i,k)+1.)/lamr(i,k)**6<a name='3186'>
          ze_rain(i,k) = max(ze_rain(i,k),1.e-22)<a name='3187'>
       else<a name='3188'>
          qv(i,k) = qv(i,k)+qr(i,k)<a name='3189'>
          th(i,k) = th(i,k)-th(i,k)/t(i,k)*qr(i,k)*xxlv(i,k)*inv_cp<a name='3190'>
          qr(i,k) = 0.<a name='3191'>
          nr(i,k) = 0.<a name='3192'>
       endif<a name='3193'>
<a name='3194'>
    <font color=#447700>! ice:<a name='3195'></font>
<a name='3196'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#IMPOSE_MAX_TOTAL_NI'>impose_max_total_Ni</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IMPOSE_MAX_TOTAL_NI_3">(nitot(i,k,:),max_total_Ni,inv_rho(i,k))<a name='3197'>
<a name='3198'>
       iice_loop_final_diagnostics:  do iice = 1,nCat<a name='3199'>
<a name='3200'>
          qi_not_small:  if (qitot(i,k,iice).ge.qsmall) then<a name='3201'>
<a name='3202'>
            <font color=#447700>!impose lower limits to prevent taking log of # &lt; 0<a name='3203'></font>
             nitot(i,k,iice) = max(nitot(i,k,iice),nsmall)<a name='3204'>
             nr(i,k)         = max(nr(i,k),nsmall)<a name='3205'>
<a name='3206'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#CALC_BULKRHORIME'>calc_bulkRhoRime</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_BULKRHORIME_4">(qitot(i,k,iice),qirim(i,k,iice),birim(i,k,iice),rhop)<a name='3207'>
<a name='3208'>
           <font color=#447700>! if (.not. tripleMoment_on) zitot(i,k,iice) = diag_mom6(qitot(i,k,iice),nitot(i,k,iice),rho(i,k))<a name='3209'></font>
             call <A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_1A'>find_lookupTable_indices_1a</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_LOOKUPTABLE_INDICES_1A_3">(dumi,dumjj,dumii,dumzz,dum1,dum4,          &amp;<a name='3210'>
                                              dum5,dum6,isize,rimsize,densize,zsize,     &amp;<a name='3211'>
                                              qitot(i,k,iice),nitot(i,k,iice),           &amp;<a name='3212'>
                                              qirim(i,k,iice),999.,rhop)<a name='3213'>
                                             <font color=#447700>!qirim(i,k,iice),zitot(i,k,iice),rhop)<a name='3214'></font>
<a name='3215'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_12">(dumjj,dumii,dumi, 6,dum1,dum4,dum5,f1pr06)<a name='3216'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_13">(dumjj,dumii,dumi, 7,dum1,dum4,dum5,f1pr09)<a name='3217'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_14">(dumjj,dumii,dumi, 8,dum1,dum4,dum5,f1pr10)<a name='3218'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_15">(dumjj,dumii,dumi, 9,dum1,dum4,dum5,f1pr13)<a name='3219'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_16">(dumjj,dumii,dumi,11,dum1,dum4,dum5,f1pr15)<a name='3220'>
             call <A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE'>access_lookup_table</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ACCESS_LOOKUP_TABLE_17">(dumjj,dumii,dumi,12,dum1,dum4,dum5,f1pr16)<a name='3221'>
<a name='3222'>
          <font color=#447700>! impose mean ice size bounds (i.e. apply lambda limiters)<a name='3223'></font>
          <font color=#447700>! note that the Nmax and Nmin are normalized and thus need to be multiplied by existing N<a name='3224'></font>
             nitot(i,k,iice) = min(nitot(i,k,iice),f1pr09*nitot(i,k,iice))<a name='3225'>
             nitot(i,k,iice) = max(nitot(i,k,iice),f1pr10*nitot(i,k,iice))<a name='3226'>
<a name='3227'>
  <font color=#447700>!--this should already be done in s/r 'calc_bulkRhoRime'<a name='3228'></font>
             if (qirim(i,k,iice).lt.qsmall) then<a name='3229'>
                qirim(i,k,iice) = 0.<a name='3230'>
                birim(i,k,iice) = 0.<a name='3231'>
             endif<a name='3232'>
  <font color=#447700>!==<a name='3233'></font>
<a name='3234'>
  <font color=#447700>! note that reflectivity from lookup table is normalized, so we need to multiply by N<a name='3235'></font>
             diag_effi(i,k,iice)  = f1pr06 <font color=#447700>! units are in m<a name='3236'></font>
             diag_di(i,k,iice)    = f1pr15<a name='3237'>
             diag_rhopo(i,k,iice) = f1pr16<a name='3238'>
          <font color=#447700>! note factor of air density below is to convert from m^6/kg to m^6/m^3<a name='3239'></font>
             ze_ice(i,k) = ze_ice(i,k) + 0.1892*f1pr13*nitot(i,k,iice)*rho(i,k)   <font color=#447700>! sum contribution from each ice category (note: 0.1892 = 0.176/0.93)<a name='3240'></font>
             ze_ice(i,k) = max(ze_ice(i,k),1.e-22)<a name='3241'>
<a name='3242'>
          else<a name='3243'>
<a name='3244'>
             qv(i,k) = qv(i,k) + qitot(i,k,iice)<a name='3245'>
             th(i,k) = th(i,k) - th(i,k)/t(i,k)*qitot(i,k,iice)*xxls(i,k)*inv_cp<a name='3246'>
             qitot(i,k,iice) = 0.<a name='3247'>
             nitot(i,k,iice) = 0.<a name='3248'>
             qirim(i,k,iice) = 0.<a name='3249'>
             birim(i,k,iice) = 0.<a name='3250'>
             diag_di(i,k,iice) = 0.<a name='3251'>
<a name='3252'>
          endif qi_not_small<a name='3253'>
<a name='3254'>
       enddo iice_loop_final_diagnostics<a name='3255'>
<a name='3256'>
     <font color=#447700>! sum ze components and convert to dBZ<a name='3257'></font>
       diag_ze(i,k) = 10.*log10((ze_rain(i,k) + ze_ice(i,k))*1.d+18)<a name='3258'>
<a name='3259'>
     <font color=#447700>! if qr is very small then set Nr to 0 (needs to be done here after call<a name='3260'></font>
     <font color=#447700>! to ice lookup table because a minimum Nr of nsmall will be set otherwise even if qr=0)<a name='3261'></font>
       if (qr(i,k).lt.qsmall) then<a name='3262'>
          nr(i,k) = 0.<a name='3263'>
       endif<a name='3264'>
<a name='3265'>
    enddo k_loop_final_diagnostics<a name='3266'>
<a name='3267'>
<font color=#447700>!   if (debug_ON) call check_values(qv,T,qc,qr,nr,qitot,qirim,nitot,birim,i,it,.true.,debug_ABORT,800)<a name='3268'></font>
<a name='3269'>
<font color=#447700>!..............................................<a name='3270'></font>
<font color=#447700>! merge ice categories with similar properties<a name='3271'></font>
<a name='3272'>
<font color=#447700>!   note:  this should be relocated to above, such that the diagnostic<a name='3273'></font>
<font color=#447700>!          ice properties are computed after merging<a name='3274'></font>
<a name='3275'>
    multicat:  if (nCat.gt.1) then<a name='3276'>
<font color=#447700>!   multicat:  if (.FALSE.) then       ! **** TEST<a name='3277'></font>
<a name='3278'>
       do k = kbot,ktop,kdir<a name='3279'>
          do iice = nCat,2,-1<a name='3280'>
<a name='3281'>
           <font color=#447700>! simility condition (similar mean sizes; similar bulk densities)<a name='3282'></font>
             if (abs(diag_di(i,k,iice)-diag_di(i,k,iice-1)).le.150.e-6   .and.           &amp;<a name='3283'>
                 abs(diag_rhopo(i,k,iice)-diag_rhopo(i,k,iice-1)).le.100.) then<a name='3284'>
<a name='3285'>
                qitot(i,k,iice-1) = qitot(i,k,iice-1) + qitot(i,k,iice)<a name='3286'>
                nitot(i,k,iice-1) = nitot(i,k,iice-1) + nitot(i,k,iice)<a name='3287'>
                qirim(i,k,iice-1) = qirim(i,k,iice-1) + qirim(i,k,iice)<a name='3288'>
                birim(i,k,iice-1) = birim(i,k,iice-1) + birim(i,k,iice)<a name='3289'>
             <font color=#447700>!  zitot(i,k,iice-1) = zitot(i,k,iice-1) + zitot(i,k,iice)<a name='3290'></font>
<a name='3291'>
                qitot(i,k,iice) = 0.<a name='3292'>
                nitot(i,k,iice) = 0.<a name='3293'>
                qirim(i,k,iice) = 0.<a name='3294'>
                birim(i,k,iice) = 0.<a name='3295'>
             <font color=#447700>!  zitot(i,k,iice) = 0.<a name='3296'></font>
<a name='3297'>
             endif<a name='3298'>
<a name='3299'>
          enddo <font color=#447700>!iice loop<a name='3300'></font>
       enddo <font color=#447700>!k loop<a name='3301'></font>
<a name='3302'>
    endif multicat<a name='3303'>
<a name='3304'>
<font color=#447700>!....................................................................<a name='3305'></font>
<a name='3306'>
333 continue<a name='3307'>
<a name='3308'>
    if (log_predictSsat) then<a name='3309'>
   <font color=#447700>! recalculate supersaturation from T and qv<a name='3310'></font>
       do k = kbot,ktop,kdir<a name='3311'>
          t(i,k) = th(i,k)*(1.e-5*pres(i,k))**(rd*inv_cp)<a name='3312'>
          dum    = <A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT'>qv_sat</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QV_SAT_9">(t(i,k),pres(i,k),0)<a name='3313'>
          ssat(i,k) = qv(i,k)-dum<a name='3314'>
       enddo<a name='3315'>
    endif<a name='3316'>
<a name='3317'>
    if (debug_ON) then<a name='3318'>
       tmparr1(i,:) = th(i,:)*(pres(i,:)*1.e-5)**(rd*inv_cp)<a name='3319'>
       call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_p3.F.html#P3_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_17">(qv,tmparr1,qc,qr,nr,qitot,qirim,nitot,birim,i,it,.true.,debug_ABORT,900)<a name='3320'>
    endif<a name='3321'>
<a name='3322'>
<font color=#447700>!.....................................................<a name='3323'></font>
<a name='3324'>
 enddo i_loop_main<a name='3325'>
<a name='3326'>
<font color=#447700>!-- for WRF:<a name='3327'></font>
<font color=#447700>!<a name='3328'></font>
<font color=#447700>! Diagnostics (for default WRF, ice category 1 only):<a name='3329'></font>
  diag_ss(:,:,1) = diag_vmi(:,:,1)     <font color=#447700>! mass-weighted Vi (w/o rhoa corr) m s-1<a name='3330'></font>
  diag_ss(:,:,2) = diag_di(:,:,1)      <font color=#447700>! mean size of ice                 m<a name='3331'></font>
  diag_ss(:,:,3) = diag_rhopo(:,:,1)   <font color=#447700>! bulk ice density                 kg m-3<a name='3332'></font>
<a name='3333'>
<font color=#447700>!   Save end of microphysics values of theta and qv as old values for next time step<a name='3334'></font>
<font color=#447700>!   note:  This is commented out for GEM, which already has these values available<a name='3335'></font>
<font color=#447700>!          from the beginning of the model time step (TT_moins and HU_moins) when<a name='3336'></font>
<font color=#447700>!          s/r 'p3_wrapper_gem' is called (from s/r 'condensation').<a name='3337'></font>
  th_old = th<a name='3338'>
  qv_old = qv<a name='3339'>
<font color=#447700>!<a name='3340'></font>
<font color=#447700>!==<a name='3341'></font>
<a name='3342'>
<font color=#447700>! end of main microphysics routine<a name='3343'></font>
<a name='3344'>
<font color=#447700>!.....................................................................................<a name='3345'></font>
<font color=#447700>!--<a name='3346'></font>
<font color=#447700>! output only<a name='3347'></font>
<font color=#447700>!      do i = its,ite<a name='3348'></font>
<font color=#447700>!       do k = kbot,ktop,kdir<a name='3349'></font>
<font color=#447700>!     !calculate temperature from theta<a name='3350'></font>
<font color=#447700>!       t(i,k) = th(i,k)*(pres(i,k)*1.e-5)**(rd*inv_cp)<a name='3351'></font>
<font color=#447700>!     !calculate some time-varying atmospheric variables<a name='3352'></font>
<font color=#447700>!       qvs(i,k) = qv_sat(t(i,k),pres(i,k),0)<a name='3353'></font>
<font color=#447700>!       if (qc(i,k).gt.1.e-5) then<a name='3354'></font>
<font color=#447700>!          write(6,'(a10,2i5,5e15.5)')'after',i,k,qc(i,k),qr(i,k),nc(i,k),qv(i,k)/qvs(i,k),uzpl(i,k)<a name='3355'></font>
<font color=#447700>!       end if<a name='3356'></font>
<font color=#447700>!       end do<a name='3357'></font>
<font color=#447700>!      enddo !i-loop<a name='3358'></font>
<font color=#447700>!   !saturation ratio at end of microphysics step:<a name='3359'></font>
<font color=#447700>!    do i = its,ite<a name='3360'></font>
<font color=#447700>!     do k = kbot,ktop,kdir<a name='3361'></font>
<font color=#447700>!        dum1     = th(i,k)*(pres(i,k)*1.e-5)**(rd*inv_cp)   !i.e. t(i,k)<a name='3362'></font>
<font color=#447700>!        qvs(i,k) = qv_sat(dumt,pres(i,k),0)<a name='3363'></font>
<font color=#447700>!        diag_ss(i,k,2) = qv(i,k)/qvs(i,k)<a name='3364'></font>
<font color=#447700>!     enddo<a name='3365'></font>
<font color=#447700>!    enddo !i-loop<a name='3366'></font>
<font color=#447700>!==<a name='3367'></font>
<a name='3368'>
<font color=#447700>!.....................................................................................<a name='3369'></font>
<a name='3370'>
 return<a name='3371'>
<a name='3372'>
 END SUBROUTINE p3_main<a name='3373'>
<a name='3374'>
<font color=#447700>!==========================================================================================!<a name='3375'></font>
<a name='3376'>
<A NAME='ACCESS_LOOKUP_TABLE'><A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3377'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>access_lookup_table</font>(dumjj,dumii,dumi,index,dum1,dum4,dum5,proc) <A href='../../call_to/ACCESS_LOOKUP_TABLE.html' TARGET='index'>17</A><a name='3378'>
<a name='3379'>
 implicit none<a name='3380'>
<a name='3381'>
 real    :: dum1,dum4,dum5,proc,dproc1,dproc2,iproc1,gproc1,tmp1,tmp2<a name='3382'>
 integer :: dumjj,dumii,dumi,index<a name='3383'>
<a name='3384'>
<font color=#447700>! get value at current density index<a name='3385'></font>
<a name='3386'>
<font color=#447700>! first interpolate for current rimed fraction index<a name='3387'></font>
<a name='3388'>
   iproc1 = itab(dumjj,dumii,dumi,index)+(dum1-real(dumi))*(itab(dumjj,dumii,       &amp;<a name='3389'>
            dumi+1,index)-itab(dumjj,dumii,dumi,index))<a name='3390'>
<a name='3391'>
<font color=#447700>! linearly interpolate to get process rates for rimed fraction index + 1<a name='3392'></font>
<a name='3393'>
   gproc1 = itab(dumjj,dumii+1,dumi,index)+(dum1-real(dumi))*(itab(dumjj,dumii+1,   &amp;<a name='3394'>
          dumi+1,index)-itab(dumjj,dumii+1,dumi,index))<a name='3395'>
<a name='3396'>
   tmp1   = iproc1+(dum4-real(dumii))*(gproc1-iproc1)<a name='3397'>
<a name='3398'>
<font color=#447700>! get value at density index + 1<a name='3399'></font>
<a name='3400'>
<font color=#447700>! first interpolate for current rimed fraction index<a name='3401'></font>
<a name='3402'>
   iproc1 = itab(dumjj+1,dumii,dumi,index)+(dum1-real(dumi))*(itab(dumjj+1,dumii,   &amp;<a name='3403'>
            dumi+1,index)-itab(dumjj+1,dumii,dumi,index))<a name='3404'>
<a name='3405'>
<font color=#447700>! linearly interpolate to get process rates for rimed fraction index + 1<a name='3406'></font>
<a name='3407'>
   gproc1 = itab(dumjj+1,dumii+1,dumi,index)+(dum1-real(dumi))*(itab(dumjj+1,       &amp;<a name='3408'>
            dumii+1,dumi+1,index)-itab(dumjj+1,dumii+1,dumi,index))<a name='3409'>
<a name='3410'>
   tmp2   = iproc1+(dum4-real(dumii))*(gproc1-iproc1)<a name='3411'>
<a name='3412'>
<font color=#447700>! get final process rate<a name='3413'></font>
   proc   = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3414'>
<a name='3415'>
END SUBROUTINE access_lookup_table<a name='3416'>
<a name='3417'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='3418'></font>
<A NAME='ACCESS_LOOKUP_TABLE_COLL'><A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE_COLL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3419'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>access_lookup_table_coll</font>(dumjj,dumii,dumj,dumi,index,dum1,dum3,          &amp; <A href='../../call_to/ACCESS_LOOKUP_TABLE_COLL.html' TARGET='index'>2</A><a name='3420'>
                                    dum4,dum5,proc)<a name='3421'>
<a name='3422'>
 implicit none<a name='3423'>
<a name='3424'>
 real    :: dum1,dum3,dum4,dum5,proc,dproc1,dproc2,iproc1,gproc1,tmp1,tmp2,dproc11, &amp;<a name='3425'>
            dproc12,dproc21,dproc22<a name='3426'>
 integer :: dumjj,dumii,dumj,dumi,index<a name='3427'>
<a name='3428'>
<a name='3429'>
<font color=#447700>! This subroutine interpolates lookup table values for rain/ice collection processes<a name='3430'></font>
<a name='3431'>
<font color=#447700>! current density index<a name='3432'></font>
<a name='3433'>
<font color=#447700>! current rime fraction index<a name='3434'></font>
  dproc1  = itabcoll(dumjj,dumii,dumi,dumj,index)+(dum1-real(dumi))*                &amp;<a name='3435'>
             (itabcoll(dumjj,dumii,dumi+1,dumj,index)-itabcoll(dumjj,dumii,dumi,    &amp;<a name='3436'>
             dumj,index))<a name='3437'>
<a name='3438'>
   dproc2  = itabcoll(dumjj,dumii,dumi,dumj+1,index)+(dum1-real(dumi))*             &amp;<a name='3439'>
             (itabcoll(dumjj,dumii,dumi+1,dumj+1,index)-itabcoll(dumjj,dumii,dumi,  &amp;<a name='3440'>
             dumj+1,index))<a name='3441'>
<a name='3442'>
   iproc1  = dproc1+(dum3-real(dumj))*(dproc2-dproc1)<a name='3443'>
<a name='3444'>
<font color=#447700>! rime fraction index + 1<a name='3445'></font>
<a name='3446'>
   dproc1  = itabcoll(dumjj,dumii+1,dumi,dumj,index)+(dum1-real(dumi))*             &amp;<a name='3447'>
             (itabcoll(dumjj,dumii+1,dumi+1,dumj,index)-itabcoll(dumjj,dumii+1,     &amp;<a name='3448'>
                 dumi,dumj,index))<a name='3449'>
<a name='3450'>
   dproc2  = itabcoll(dumjj,dumii+1,dumi,dumj+1,index)+(dum1-real(dumi))*           &amp;<a name='3451'>
             (itabcoll(dumjj,dumii+1,dumi+1,dumj+1,index)-itabcoll(dumjj,dumii+1,   &amp;<a name='3452'>
             dumi,dumj+1,index))<a name='3453'>
<a name='3454'>
   gproc1  = dproc1+(dum3-real(dumj))*(dproc2-dproc1)<a name='3455'>
   tmp1    = iproc1+(dum4-real(dumii))*(gproc1-iproc1)<a name='3456'>
<a name='3457'>
<font color=#447700>! density index + 1<a name='3458'></font>
<a name='3459'>
<font color=#447700>! current rime fraction index<a name='3460'></font>
<a name='3461'>
   dproc1  = itabcoll(dumjj+1,dumii,dumi,dumj,index)+(dum1-real(dumi))*             &amp;<a name='3462'>
             (itabcoll(dumjj+1,dumii,dumi+1,dumj,index)-itabcoll(dumjj+1,dumii,     &amp;<a name='3463'>
                 dumi,dumj,index))<a name='3464'>
<a name='3465'>
   dproc2  = itabcoll(dumjj+1,dumii,dumi,dumj+1,index)+(dum1-real(dumi))*           &amp;<a name='3466'>
             (itabcoll(dumjj+1,dumii,dumi+1,dumj+1,index)-itabcoll(dumjj+1,dumii,   &amp;<a name='3467'>
             dumi,dumj+1,index))<a name='3468'>
<a name='3469'>
   iproc1  = dproc1+(dum3-real(dumj))*(dproc2-dproc1)<a name='3470'>
<a name='3471'>
<font color=#447700>! rime fraction index + 1<a name='3472'></font>
<a name='3473'>
   dproc1  = itabcoll(dumjj+1,dumii+1,dumi,dumj,index)+(dum1-real(dumi))*           &amp;<a name='3474'>
             (itabcoll(dumjj+1,dumii+1,dumi+1,dumj,index)-itabcoll(dumjj+1,dumii+1, &amp;<a name='3475'>
             dumi,dumj,index))<a name='3476'>
<a name='3477'>
   dproc2  = itabcoll(dumjj+1,dumii+1,dumi,dumj+1,index)+(dum1-real(dumi))*         &amp;<a name='3478'>
             (itabcoll(dumjj+1,dumii+1,dumi+1,dumj+1,index)-itabcoll(dumjj+1,       &amp;<a name='3479'>
                 dumii+1,dumi,dumj+1,index))<a name='3480'>
<a name='3481'>
   gproc1  = dproc1+(dum3-real(dumj))*(dproc2-dproc1)<a name='3482'>
   tmp2    = iproc1+(dum4-real(dumii))*(gproc1-iproc1)<a name='3483'>
<a name='3484'>
<font color=#447700>! interpolate over density to get final values<a name='3485'></font>
   proc    = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3486'>
<a name='3487'>
 END SUBROUTINE access_lookup_table_coll<a name='3488'>
<a name='3489'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='3490'></font>
<a name='3491'>
<A NAME='ACCESS_LOOKUP_TABLE_COLLI'><A href='../../html_code/phys/module_mp_p3.F.html#ACCESS_LOOKUP_TABLE_COLLI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3492'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>access_lookup_table_colli</font>(dumjjc,dumiic,dumic,dumjj,dumii,dumj,dumi,     &amp; <A href='../../call_to/ACCESS_LOOKUP_TABLE_COLLI.html' TARGET='index'>4</A><a name='3493'>
                                     index,dum1c,dum4c,dum5c,dum1,dum4,dum5,proc)<a name='3494'>
<a name='3495'>
 implicit none<a name='3496'>
<a name='3497'>
 real    :: dum1,dum3,dum4,dum5,dum1c,dum4c,dum5c,proc,dproc1,dproc2,iproc1,iproc2, &amp;<a name='3498'>
            gproc1,gproc2,rproc1,rproc2,tmp1,tmp2,dproc11,dproc12<a name='3499'>
 integer :: dumjj,dumii,dumj,dumi,index,dumjjc,dumiic,dumic<a name='3500'>
<a name='3501'>
<a name='3502'>
<font color=#447700>! This subroutine interpolates lookup table values for rain/ice collection processes<a name='3503'></font>
<a name='3504'>
<font color=#447700>! current density index collectee category<a name='3505'></font>
<a name='3506'>
<font color=#447700>! current rime fraction index for collectee category<a name='3507'></font>
<a name='3508'>
<font color=#447700>! current density index collector category<a name='3509'></font>
<a name='3510'>
<font color=#447700>! current rime fraction index for collector category<a name='3511'></font>
<a name='3512'>
  if (index.eq.1) then<a name='3513'>
<a name='3514'>
   dproc11 = itabcolli1(dumic,dumiic,dumjjc,dumi,dumii,dumjj)+(dum1c-real(dumic))*    &amp;<a name='3515'>
             (itabcolli1(dumic+1,dumiic,dumjjc,dumi,dumii,dumjj)-                     &amp;<a name='3516'>
             itabcolli1(dumic,dumiic,dumjjc,dumi,dumii,dumjj))<a name='3517'>
<a name='3518'>
   dproc12 = itabcolli1(dumic,dumiic,dumjjc,dumi+1,dumii,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3519'>
             (itabcolli1(dumic+1,dumiic,dumjjc,dumi+1,dumii,dumjj)-                   &amp;<a name='3520'>
             itabcolli1(dumic,dumiic,dumjjc,dumi+1,dumii,dumjj))<a name='3521'>
<a name='3522'>
<font color=#447700>!   dproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3523'></font>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3524'>
<a name='3525'>
<a name='3526'>
<font color=#447700>! collector rime fraction index + 1<a name='3527'></font>
<a name='3528'>
   dproc11 = itabcolli1(dumic,dumiic,dumjjc,dumi,dumii+1,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3529'>
             (itabcolli1(dumic+1,dumiic,dumjjc,dumi,dumii+1,dumjj)-                   &amp;<a name='3530'>
             itabcolli1(dumic,dumiic,dumjjc,dumi,dumii+1,dumjj))<a name='3531'>
<a name='3532'>
   dproc12 = itabcolli1(dumic,dumiic,dumjjc,dumi+1,dumii+1,dumjj)+(dum1c-real(dumic))*&amp;<a name='3533'>
             (itabcolli1(dumic+1,dumiic,dumjjc,dumi+1,dumii+1,dumjj)-                 &amp;<a name='3534'>
             itabcolli1(dumic,dumiic,dumjjc,dumi+1,dumii+1,dumjj))<a name='3535'>
<a name='3536'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3537'>
<a name='3538'>
   tmp1    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3539'>
<a name='3540'>
<font color=#447700>! collector density index + 1<a name='3541'></font>
<a name='3542'>
   dproc11 = itabcolli1(dumic,dumiic,dumjjc,dumi,dumii,dumjj+1)+(dum1c-real(dumic))*  &amp;<a name='3543'>
             (itabcolli1(dumic+1,dumiic,dumjjc,dumi,dumii,dumjj+1)-                   &amp;<a name='3544'>
             itabcolli1(dumic,dumiic,dumjjc,dumi,dumii,dumjj+1))<a name='3545'>
<a name='3546'>
   dproc12 = itabcolli1(dumic,dumiic,dumjjc,dumi+1,dumii,dumjj+1)+(dum1c-real(dumic))*&amp;<a name='3547'>
             (itabcolli1(dumic+1,dumiic,dumjjc,dumi+1,dumii,dumjj+1)-                 &amp;<a name='3548'>
             itabcolli1(dumic,dumiic,dumjjc,dumi+1,dumii,dumjj+1))<a name='3549'>
<a name='3550'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3551'>
<a name='3552'>
<font color=#447700>! collector rime fraction index + 1<a name='3553'></font>
<a name='3554'>
   dproc11 = itabcolli1(dumic,dumiic,dumjjc,dumi,dumii+1,dumjj+1)+(dum1c-real(dumic))*&amp;<a name='3555'>
             (itabcolli1(dumic+1,dumiic,dumjjc,dumi,dumii+1,dumjj+1)-                 &amp;<a name='3556'>
             itabcolli1(dumic,dumiic,dumjjc,dumi,dumii+1,dumjj+1))<a name='3557'>
<a name='3558'>
   dproc12 = itabcolli1(dumic,dumiic,dumjjc,dumi+1,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3559'>
             (itabcolli1(dumic+1,dumiic,dumjjc,dumi+1,dumii+1,dumjj+1)-                  &amp;<a name='3560'>
             itabcolli1(dumic,dumiic,dumjjc,dumi+1,dumii+1,dumjj+1))<a name='3561'>
<a name='3562'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3563'>
<a name='3564'>
   tmp2    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3565'>
<a name='3566'>
   gproc1    = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3567'>
<a name='3568'>
<font color=#447700>!.......................................................................................................<a name='3569'></font>
<font color=#447700>! collectee rime fraction + 1<a name='3570'></font>
<a name='3571'>
   dproc11 = itabcolli1(dumic,dumiic+1,dumjjc,dumi,dumii,dumjj)+(dum1c-real(dumic))*   &amp;<a name='3572'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc,dumi,dumii,dumjj)-                    &amp;<a name='3573'>
             itabcolli1(dumic,dumiic+1,dumjjc,dumi,dumii,dumjj))<a name='3574'>
<a name='3575'>
   dproc12 = itabcolli1(dumic,dumiic+1,dumjjc,dumi+1,dumii,dumjj)+(dum1c-real(dumic))* &amp;<a name='3576'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc,dumi+1,dumii,dumjj)-                  &amp;<a name='3577'>
             itabcolli1(dumic,dumiic+1,dumjjc,dumi+1,dumii,dumjj))<a name='3578'>
<a name='3579'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3580'>
<a name='3581'>
<font color=#447700>! collector rime fraction index + 1<a name='3582'></font>
<a name='3583'>
   dproc11 = itabcolli1(dumic,dumiic+1,dumjjc,dumi,dumii+1,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3584'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc,dumi,dumii+1,dumjj)-                   &amp;<a name='3585'>
             itabcolli1(dumic,dumiic+1,dumjjc,dumi,dumii+1,dumjj))<a name='3586'>
<a name='3587'>
   dproc12 = itabcolli1(dumic,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3588'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj)-                  &amp;<a name='3589'>
             itabcolli1(dumic,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj))<a name='3590'>
<a name='3591'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3592'>
<a name='3593'>
   tmp1    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3594'>
<a name='3595'>
<font color=#447700>! collector density index + 1<a name='3596'></font>
<a name='3597'>
   dproc11 = itabcolli1(dumic,dumiic+1,dumjjc,dumi,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3598'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc,dumi,dumii,dumjj+1)-                  &amp;<a name='3599'>
             itabcolli1(dumic,dumiic+1,dumjjc,dumi,dumii,dumjj+1))<a name='3600'>
<a name='3601'>
   dproc12 = itabcolli1(dumic,dumiic+1,dumjjc,dumi+1,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3602'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc,dumi+1,dumii,dumjj+1)-                  &amp;<a name='3603'>
             itabcolli1(dumic,dumiic+1,dumjjc,dumi+1,dumii,dumjj+1))<a name='3604'>
<a name='3605'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3606'>
<a name='3607'>
<font color=#447700>! collector rime fraction index + 1<a name='3608'></font>
<a name='3609'>
   dproc11 = itabcolli1(dumic,dumiic+1,dumjjc,dumi,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3610'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc,dumi,dumii+1,dumjj+1)-                  &amp;<a name='3611'>
             itabcolli1(dumic,dumiic+1,dumjjc,dumi,dumii+1,dumjj+1))<a name='3612'>
<a name='3613'>
   dproc12 = itabcolli1(dumic,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3614'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj+1)-                  &amp;<a name='3615'>
             itabcolli1(dumic,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj+1))<a name='3616'>
<a name='3617'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3618'>
<a name='3619'>
   tmp2    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3620'>
<a name='3621'>
   gproc2  = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3622'>
<a name='3623'>
   rproc1  = gproc1+(dum4c-real(dumiic))*(gproc2-gproc1)<a name='3624'>
<a name='3625'>
<font color=#447700>!............................................................................................................<a name='3626'></font>
<font color=#447700>! collectee density index + 1<a name='3627'></font>
<a name='3628'>
   dproc11 = itabcolli1(dumic,dumiic,dumjjc+1,dumi,dumii,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3629'>
             (itabcolli1(dumic+1,dumiic,dumjjc+1,dumi,dumii,dumjj)-                   &amp;<a name='3630'>
             itabcolli1(dumic,dumiic,dumjjc+1,dumi,dumii,dumjj))<a name='3631'>
<a name='3632'>
   dproc12 = itabcolli1(dumic,dumiic,dumjjc+1,dumi+1,dumii,dumjj)+(dum1c-real(dumic))* &amp;<a name='3633'>
             (itabcolli1(dumic+1,dumiic,dumjjc+1,dumi+1,dumii,dumjj)-                  &amp;<a name='3634'>
             itabcolli1(dumic,dumiic,dumjjc+1,dumi+1,dumii,dumjj))<a name='3635'>
<a name='3636'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3637'>
<a name='3638'>
<font color=#447700>! collector rime fraction index + 1<a name='3639'></font>
<a name='3640'>
   dproc11 = itabcolli1(dumic,dumiic,dumjjc+1,dumi,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3641'>
             (itabcolli1(dumic+1,dumiic,dumjjc+1,dumi,dumii+1,dumjj)-                  &amp;<a name='3642'>
             itabcolli1(dumic,dumiic,dumjjc+1,dumi,dumii+1,dumjj))<a name='3643'>
<a name='3644'>
   dproc12 = itabcolli1(dumic,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3645'>
             (itabcolli1(dumic+1,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj)-                  &amp;<a name='3646'>
             itabcolli1(dumic,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj))<a name='3647'>
<a name='3648'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3649'>
<a name='3650'>
   tmp1    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3651'>
<a name='3652'>
<font color=#447700>! collector density index + 1<a name='3653'></font>
<a name='3654'>
   dproc11 = itabcolli1(dumic,dumiic,dumjjc+1,dumi,dumii,dumjj+1)+(dum1c-real(dumic))*  &amp;<a name='3655'>
             (itabcolli1(dumic+1,dumiic,dumjjc+1,dumi,dumii,dumjj+1)-                   &amp;<a name='3656'>
             itabcolli1(dumic,dumiic,dumjjc+1,dumi,dumii,dumjj+1))<a name='3657'>
<a name='3658'>
   dproc12 = itabcolli1(dumic,dumiic,dumjjc+1,dumi+1,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3659'>
             (itabcolli1(dumic+1,dumiic,dumjjc+1,dumi+1,dumii,dumjj+1)-                  &amp;<a name='3660'>
             itabcolli1(dumic,dumiic,dumjjc+1,dumi+1,dumii,dumjj+1))<a name='3661'>
<a name='3662'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3663'>
<a name='3664'>
<font color=#447700>! collector rime fraction index + 1<a name='3665'></font>
<a name='3666'>
   dproc11 = itabcolli1(dumic,dumiic,dumjjc+1,dumi,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3667'>
             (itabcolli1(dumic+1,dumiic,dumjjc+1,dumi,dumii+1,dumjj+1)-                  &amp;<a name='3668'>
             itabcolli1(dumic,dumiic,dumjjc+1,dumi,dumii+1,dumjj+1))<a name='3669'>
<a name='3670'>
   dproc12 = itabcolli1(dumic,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3671'>
             (itabcolli1(dumic+1,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj+1)-                  &amp;<a name='3672'>
             itabcolli1(dumic,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj+1))<a name='3673'>
<a name='3674'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3675'>
<a name='3676'>
   tmp2    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3677'>
<a name='3678'>
   gproc1    = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3679'>
<a name='3680'>
<font color=#447700>!.......................................................................................................<a name='3681'></font>
<font color=#447700>! collectee rime fraction + 1<a name='3682'></font>
<a name='3683'>
   dproc11 = itabcolli1(dumic,dumiic+1,dumjjc+1,dumi,dumii,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3684'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc+1,dumi,dumii,dumjj)-                   &amp;<a name='3685'>
             itabcolli1(dumic,dumiic+1,dumjjc+1,dumi,dumii,dumjj))<a name='3686'>
<a name='3687'>
   dproc12 = itabcolli1(dumic,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj)+(dum1c-real(dumic))* &amp;<a name='3688'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj)-                  &amp;<a name='3689'>
             itabcolli1(dumic,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj))<a name='3690'>
<a name='3691'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3692'>
<a name='3693'>
<font color=#447700>! collector rime fraction index + 1<a name='3694'></font>
<a name='3695'>
   dproc11 = itabcolli1(dumic,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3696'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj)-                  &amp;<a name='3697'>
             itabcolli1(dumic,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj))<a name='3698'>
<a name='3699'>
   dproc12 = itabcolli1(dumic,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3700'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj)-                  &amp;<a name='3701'>
             itabcolli1(dumic,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj))<a name='3702'>
<a name='3703'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3704'>
<a name='3705'>
   tmp1    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3706'>
<a name='3707'>
<font color=#447700>! collector density index + 1<a name='3708'></font>
<a name='3709'>
   dproc11 = itabcolli1(dumic,dumiic+1,dumjjc+1,dumi,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3710'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc+1,dumi,dumii,dumjj+1)-                  &amp;<a name='3711'>
             itabcolli1(dumic,dumiic+1,dumjjc+1,dumi,dumii,dumjj+1))<a name='3712'>
<a name='3713'>
   dproc12 = itabcolli1(dumic,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3714'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj+1)-                  &amp;<a name='3715'>
             itabcolli1(dumic,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj+1))<a name='3716'>
<a name='3717'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3718'>
<a name='3719'>
<font color=#447700>! collector rime fraction index + 1<a name='3720'></font>
<a name='3721'>
   dproc11 = itabcolli1(dumic,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3722'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj+1)-                  &amp;<a name='3723'>
             itabcolli1(dumic,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj+1))<a name='3724'>
<a name='3725'>
   dproc12 = itabcolli1(dumic,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3726'>
             (itabcolli1(dumic+1,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj+1)-                  &amp;<a name='3727'>
             itabcolli1(dumic,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj+1))<a name='3728'>
<a name='3729'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3730'>
<a name='3731'>
   tmp2    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3732'>
<a name='3733'>
   gproc2  = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3734'>
<a name='3735'>
   rproc2  = gproc1+(dum4c-real(dumiic))*(gproc2-gproc1)<a name='3736'>
<a name='3737'>
<font color=#447700>!..........................................................................................<a name='3738'></font>
<font color=#447700>! final process rate interpolation over collectee density<a name='3739'></font>
<a name='3740'>
   proc    = rproc1+(dum5c-real(dumjjc))*(rproc2-rproc1)<a name='3741'>
<a name='3742'>
 else if (index.eq.2) then<a name='3743'>
<a name='3744'>
   dproc11 = itabcolli2(dumic,dumiic,dumjjc,dumi,dumii,dumjj)+(dum1c-real(dumic))*    &amp;<a name='3745'>
             (itabcolli2(dumic+1,dumiic,dumjjc,dumi,dumii,dumjj)-                     &amp;<a name='3746'>
             itabcolli2(dumic,dumiic,dumjjc,dumi,dumii,dumjj))<a name='3747'>
<a name='3748'>
   dproc12 = itabcolli2(dumic,dumiic,dumjjc,dumi+1,dumii,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3749'>
             (itabcolli2(dumic+1,dumiic,dumjjc,dumi+1,dumii,dumjj)-                   &amp;<a name='3750'>
             itabcolli2(dumic,dumiic,dumjjc,dumi+1,dumii,dumjj))<a name='3751'>
<a name='3752'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3753'>
<a name='3754'>
<font color=#447700>! collector rime fraction index + 1<a name='3755'></font>
<a name='3756'>
   dproc11 = itabcolli2(dumic,dumiic,dumjjc,dumi,dumii+1,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3757'>
             (itabcolli2(dumic+1,dumiic,dumjjc,dumi,dumii+1,dumjj)-                   &amp;<a name='3758'>
             itabcolli2(dumic,dumiic,dumjjc,dumi,dumii+1,dumjj))<a name='3759'>
<a name='3760'>
   dproc12 = itabcolli2(dumic,dumiic,dumjjc,dumi+1,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3761'>
             (itabcolli2(dumic+1,dumiic,dumjjc,dumi+1,dumii+1,dumjj)-                  &amp;<a name='3762'>
             itabcolli2(dumic,dumiic,dumjjc,dumi+1,dumii+1,dumjj))<a name='3763'>
<a name='3764'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3765'>
<a name='3766'>
   tmp1    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3767'>
<a name='3768'>
<font color=#447700>! collector density index + 1<a name='3769'></font>
<a name='3770'>
   dproc11 = itabcolli2(dumic,dumiic,dumjjc,dumi,dumii,dumjj+1)+(dum1c-real(dumic))*  &amp;<a name='3771'>
             (itabcolli2(dumic+1,dumiic,dumjjc,dumi,dumii,dumjj+1)-                   &amp;<a name='3772'>
             itabcolli2(dumic,dumiic,dumjjc,dumi,dumii,dumjj+1))<a name='3773'>
<a name='3774'>
   dproc12 = itabcolli2(dumic,dumiic,dumjjc,dumi+1,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3775'>
             (itabcolli2(dumic+1,dumiic,dumjjc,dumi+1,dumii,dumjj+1)-                  &amp;<a name='3776'>
             itabcolli2(dumic,dumiic,dumjjc,dumi+1,dumii,dumjj+1))<a name='3777'>
<a name='3778'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3779'>
<a name='3780'>
<font color=#447700>! collector rime fraction index + 1<a name='3781'></font>
<a name='3782'>
   dproc11 = itabcolli2(dumic,dumiic,dumjjc,dumi,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3783'>
             (itabcolli2(dumic+1,dumiic,dumjjc,dumi,dumii+1,dumjj+1)-                  &amp;<a name='3784'>
             itabcolli2(dumic,dumiic,dumjjc,dumi,dumii+1,dumjj+1))<a name='3785'>
<a name='3786'>
   dproc12 = itabcolli2(dumic,dumiic,dumjjc,dumi+1,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3787'>
             (itabcolli2(dumic+1,dumiic,dumjjc,dumi+1,dumii+1,dumjj+1)-                  &amp;<a name='3788'>
             itabcolli2(dumic,dumiic,dumjjc,dumi+1,dumii+1,dumjj+1))<a name='3789'>
<a name='3790'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3791'>
<a name='3792'>
   tmp2    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3793'>
<a name='3794'>
   gproc1    = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3795'>
<a name='3796'>
<font color=#447700>!.......................................................................................................<a name='3797'></font>
<font color=#447700>! collectee rime fraction + 1<a name='3798'></font>
<a name='3799'>
   dproc11 = itabcolli2(dumic,dumiic+1,dumjjc,dumi,dumii,dumjj)+(dum1c-real(dumic))* &amp;<a name='3800'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc,dumi,dumii,dumjj)-                  &amp;<a name='3801'>
             itabcolli2(dumic,dumiic+1,dumjjc,dumi,dumii,dumjj))<a name='3802'>
<a name='3803'>
   dproc12 = itabcolli2(dumic,dumiic+1,dumjjc,dumi+1,dumii,dumjj)+(dum1c-real(dumic))* &amp;<a name='3804'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc,dumi+1,dumii,dumjj)-                  &amp;<a name='3805'>
             itabcolli2(dumic,dumiic+1,dumjjc,dumi+1,dumii,dumjj))<a name='3806'>
<a name='3807'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3808'>
<a name='3809'>
<font color=#447700>! collector rime fraction index + 1<a name='3810'></font>
<a name='3811'>
   dproc11 = itabcolli2(dumic,dumiic+1,dumjjc,dumi,dumii+1,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3812'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc,dumi,dumii+1,dumjj)-                   &amp;<a name='3813'>
             itabcolli2(dumic,dumiic+1,dumjjc,dumi,dumii+1,dumjj))<a name='3814'>
<a name='3815'>
   dproc12 = itabcolli2(dumic,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3816'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj)-                  &amp;<a name='3817'>
             itabcolli2(dumic,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj))<a name='3818'>
<a name='3819'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3820'>
<a name='3821'>
   tmp1    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3822'>
<a name='3823'>
<font color=#447700>! collector density index + 1<a name='3824'></font>
<a name='3825'>
   dproc11 = itabcolli2(dumic,dumiic+1,dumjjc,dumi,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3826'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc,dumi,dumii,dumjj+1)-                  &amp;<a name='3827'>
             itabcolli2(dumic,dumiic+1,dumjjc,dumi,dumii,dumjj+1))<a name='3828'>
<a name='3829'>
   dproc12 = itabcolli2(dumic,dumiic+1,dumjjc,dumi+1,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3830'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc,dumi+1,dumii,dumjj+1)-                  &amp;<a name='3831'>
             itabcolli2(dumic,dumiic+1,dumjjc,dumi+1,dumii,dumjj+1))<a name='3832'>
<a name='3833'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3834'>
<a name='3835'>
<font color=#447700>! collector rime fraction index + 1<a name='3836'></font>
<a name='3837'>
   dproc11 = itabcolli2(dumic,dumiic+1,dumjjc,dumi,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3838'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc,dumi,dumii+1,dumjj+1)-                  &amp;<a name='3839'>
             itabcolli2(dumic,dumiic+1,dumjjc,dumi,dumii+1,dumjj+1))<a name='3840'>
<a name='3841'>
   dproc12 = itabcolli2(dumic,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3842'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj+1)-                  &amp;<a name='3843'>
             itabcolli2(dumic,dumiic+1,dumjjc,dumi+1,dumii+1,dumjj+1))<a name='3844'>
<a name='3845'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3846'>
<a name='3847'>
   tmp2    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3848'>
<a name='3849'>
   gproc2  = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3850'>
<a name='3851'>
   rproc1  = gproc1+(dum4c-real(dumiic))*(gproc2-gproc1)<a name='3852'>
<a name='3853'>
<font color=#447700>!............................................................................................................<a name='3854'></font>
<font color=#447700>! collectee density index + 1<a name='3855'></font>
<a name='3856'>
   dproc11 = itabcolli2(dumic,dumiic,dumjjc+1,dumi,dumii,dumjj)+(dum1c-real(dumic))*  &amp;<a name='3857'>
             (itabcolli2(dumic+1,dumiic,dumjjc+1,dumi,dumii,dumjj)-                   &amp;<a name='3858'>
             itabcolli2(dumic,dumiic,dumjjc+1,dumi,dumii,dumjj))<a name='3859'>
<a name='3860'>
   dproc12 = itabcolli2(dumic,dumiic,dumjjc+1,dumi+1,dumii,dumjj)+(dum1c-real(dumic))* &amp;<a name='3861'>
             (itabcolli2(dumic+1,dumiic,dumjjc+1,dumi+1,dumii,dumjj)-                  &amp;<a name='3862'>
             itabcolli2(dumic,dumiic,dumjjc+1,dumi+1,dumii,dumjj))<a name='3863'>
<a name='3864'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3865'>
<a name='3866'>
<font color=#447700>! collector rime fraction index + 1<a name='3867'></font>
<a name='3868'>
   dproc11 = itabcolli2(dumic,dumiic,dumjjc+1,dumi,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3869'>
             (itabcolli2(dumic+1,dumiic,dumjjc+1,dumi,dumii+1,dumjj)-                  &amp;<a name='3870'>
             itabcolli2(dumic,dumiic,dumjjc+1,dumi,dumii+1,dumjj))<a name='3871'>
<a name='3872'>
   dproc12 = itabcolli2(dumic,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3873'>
             (itabcolli2(dumic+1,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj)-                  &amp;<a name='3874'>
             itabcolli2(dumic,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj))<a name='3875'>
<a name='3876'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3877'>
<a name='3878'>
   tmp1    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3879'>
<a name='3880'>
<font color=#447700>! collector density index + 1<a name='3881'></font>
<a name='3882'>
   dproc11 = itabcolli2(dumic,dumiic,dumjjc+1,dumi,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3883'>
             (itabcolli2(dumic+1,dumiic,dumjjc+1,dumi,dumii,dumjj+1)-                  &amp;<a name='3884'>
             itabcolli2(dumic,dumiic,dumjjc+1,dumi,dumii,dumjj+1))<a name='3885'>
<a name='3886'>
   dproc12 = itabcolli2(dumic,dumiic,dumjjc+1,dumi+1,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3887'>
             (itabcolli2(dumic+1,dumiic,dumjjc+1,dumi+1,dumii,dumjj+1)-                  &amp;<a name='3888'>
             itabcolli2(dumic,dumiic,dumjjc+1,dumi+1,dumii,dumjj+1))<a name='3889'>
<a name='3890'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3891'>
<a name='3892'>
<font color=#447700>! collector rime fraction index + 1<a name='3893'></font>
<a name='3894'>
   dproc11 = itabcolli2(dumic,dumiic,dumjjc+1,dumi,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3895'>
             (itabcolli2(dumic+1,dumiic,dumjjc+1,dumi,dumii+1,dumjj+1)-                  &amp;<a name='3896'>
             itabcolli2(dumic,dumiic,dumjjc+1,dumi,dumii+1,dumjj+1))<a name='3897'>
<a name='3898'>
   dproc12 = itabcolli2(dumic,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3899'>
             (itabcolli2(dumic+1,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj+1)-                  &amp;<a name='3900'>
             itabcolli2(dumic,dumiic,dumjjc+1,dumi+1,dumii+1,dumjj+1))<a name='3901'>
<a name='3902'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3903'>
<a name='3904'>
   tmp2    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3905'>
<a name='3906'>
   gproc1    = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3907'>
<a name='3908'>
<font color=#447700>!.......................................................................................................<a name='3909'></font>
<font color=#447700>! collectee rime fraction + 1<a name='3910'></font>
<a name='3911'>
   dproc11 = itabcolli2(dumic,dumiic+1,dumjjc+1,dumi,dumii,dumjj)+(dum1c-real(dumic))* &amp;<a name='3912'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc+1,dumi,dumii,dumjj)-                  &amp;<a name='3913'>
             itabcolli2(dumic,dumiic+1,dumjjc+1,dumi,dumii,dumjj))<a name='3914'>
<a name='3915'>
   dproc12 = itabcolli2(dumic,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj)+(dum1c-real(dumic))* &amp;<a name='3916'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj)-                  &amp;<a name='3917'>
             itabcolli2(dumic,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj))<a name='3918'>
<a name='3919'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3920'>
<a name='3921'>
<font color=#447700>! collector rime fraction index + 1<a name='3922'></font>
<a name='3923'>
   dproc11 = itabcolli2(dumic,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3924'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj)-                  &amp;<a name='3925'>
             itabcolli2(dumic,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj))<a name='3926'>
<a name='3927'>
   dproc12 = itabcolli2(dumic,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj)+(dum1c-real(dumic))* &amp;<a name='3928'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj)-                  &amp;<a name='3929'>
             itabcolli2(dumic,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj))<a name='3930'>
<a name='3931'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3932'>
<a name='3933'>
   tmp1    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3934'>
<a name='3935'>
<font color=#447700>! collector density index + 1<a name='3936'></font>
<a name='3937'>
   dproc11 = itabcolli2(dumic,dumiic+1,dumjjc+1,dumi,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3938'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc+1,dumi,dumii,dumjj+1)-                  &amp;<a name='3939'>
             itabcolli2(dumic,dumiic+1,dumjjc+1,dumi,dumii,dumjj+1))<a name='3940'>
<a name='3941'>
   dproc12 = itabcolli2(dumic,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3942'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj+1)-                  &amp;<a name='3943'>
             itabcolli2(dumic,dumiic+1,dumjjc+1,dumi+1,dumii,dumjj+1))<a name='3944'>
<a name='3945'>
   iproc1  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3946'>
<a name='3947'>
<font color=#447700>! collector rime fraction index + 1<a name='3948'></font>
<a name='3949'>
   dproc11 = itabcolli2(dumic,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3950'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj+1)-                  &amp;<a name='3951'>
             itabcolli2(dumic,dumiic+1,dumjjc+1,dumi,dumii+1,dumjj+1))<a name='3952'>
<a name='3953'>
   dproc12 = itabcolli2(dumic,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj+1)+(dum1c-real(dumic))* &amp;<a name='3954'>
             (itabcolli2(dumic+1,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj+1)-                  &amp;<a name='3955'>
             itabcolli2(dumic,dumiic+1,dumjjc+1,dumi+1,dumii+1,dumjj+1))<a name='3956'>
<a name='3957'>
   iproc2  = dproc11+(dum1-real(dumi))*(dproc12-dproc11)<a name='3958'>
<a name='3959'>
   tmp2    = iproc1+(dum4-real(dumii))*(iproc2-iproc1)<a name='3960'>
<a name='3961'>
   gproc2  = tmp1+(dum5-real(dumjj))*(tmp2-tmp1)<a name='3962'>
<a name='3963'>
   rproc2  = gproc1+(dum4c-real(dumiic))*(gproc2-gproc1)<a name='3964'>
<a name='3965'>
<font color=#447700>!..........................................................................................<a name='3966'></font>
<font color=#447700>! final process rate interpolation over collectee density<a name='3967'></font>
<a name='3968'>
   proc    = rproc1+(dum5c-real(dumjjc))*(rproc2-rproc1)<a name='3969'>
<a name='3970'>
 endif <font color=#447700>! index =1 or 2<a name='3971'></font>
<a name='3972'>
 END SUBROUTINE access_lookup_table_colli<a name='3973'>
<a name='3974'>
<font color=#447700>!==========================================================================================!<a name='3975'></font>
<a name='3976'>
<A NAME='POLYSVP1'><A href='../../html_code/phys/module_mp_p3.F.html#POLYSVP1' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3977'>
 real <font color=#993300>function </font><font color=#cc0000>polysvp1</font>(T,i_type) <A href='../../call_to/POLYSVP1.html' TARGET='index'>2</A><a name='3978'>
<a name='3979'>
<font color=#447700>!-------------------------------------------<a name='3980'></font>
<font color=#447700>!  COMPUTE SATURATION VAPOR PRESSURE<a name='3981'></font>
<font color=#447700>!  POLYSVP1 RETURNED IN UNITS OF PA.<a name='3982'></font>
<font color=#447700>!  T IS INPUT IN UNITS OF K.<a name='3983'></font>
<font color=#447700>!  i_type REFERS TO SATURATION WITH RESPECT TO LIQUID (0) OR ICE (1)<a name='3984'></font>
<font color=#447700>!-------------------------------------------<a name='3985'></font>
<a name='3986'>
      implicit none<a name='3987'>
<a name='3988'>
      real    :: DUM,T<a name='3989'>
      integer :: i_type<a name='3990'>
<a name='3991'>
<font color=#447700>! REPLACE GOFF-GRATCH WITH FASTER FORMULATION FROM FLATAU ET AL. 1992, TABLE 4 (RIGHT-HAND COLUMN)<a name='3992'></font>
<a name='3993'>
<font color=#447700>! ice<a name='3994'></font>
      real a0i,a1i,a2i,a3i,a4i,a5i,a6i,a7i,a8i<a name='3995'>
      data a0i,a1i,a2i,a3i,a4i,a5i,a6i,a7i,a8i /&amp;<a name='3996'>
        6.11147274, 0.503160820, 0.188439774e-1, &amp;<a name='3997'>
        0.420895665e-3, 0.615021634e-5,0.602588177e-7, &amp;<a name='3998'>
        0.385852041e-9, 0.146898966e-11, 0.252751365e-14/<a name='3999'>
<a name='4000'>
<font color=#447700>! liquid<a name='4001'></font>
      real a0,a1,a2,a3,a4,a5,a6,a7,a8<a name='4002'>
<a name='4003'>
<font color=#447700>! V1.7<a name='4004'></font>
      data a0,a1,a2,a3,a4,a5,a6,a7,a8 /&amp;<a name='4005'>
        6.11239921, 0.443987641, 0.142986287e-1, &amp;<a name='4006'>
        0.264847430e-3, 0.302950461e-5, 0.206739458e-7, &amp;<a name='4007'>
        0.640689451e-10,-0.952447341e-13,-0.976195544e-15/<a name='4008'>
      real dt<a name='4009'>
<a name='4010'>
<font color=#447700>!-------------------------------------------<a name='4011'></font>
<a name='4012'>
      if (i_type.EQ.1 .and. T.lt.273.15) then<a name='4013'>
<font color=#447700>! ICE<a name='4014'></font>
<a name='4015'>
<font color=#447700>!       Flatau formulation:<a name='4016'></font>
         dt       = max(-80.,t-273.16)<a name='4017'>
         polysvp1 = a0i + dt*(a1i+dt*(a2i+dt*(a3i+dt*(a4i+dt*(a5i+dt*(a6i+dt*(a7i+       &amp;<a name='4018'>
                    a8i*dt)))))))<a name='4019'>
         polysvp1 = polysvp1*100.<a name='4020'>
<a name='4021'>
<font color=#447700>!       Goff-Gratch formulation:<a name='4022'></font>
<font color=#447700>!        POLYSVP1 = 10.**(-9.09718*(273.16/T-1.)-3.56654*                 &amp;<a name='4023'></font>
<font color=#447700>!          log10(273.16/T)+0.876793*(1.-T/273.16)+                        &amp;<a name='4024'></font>
<font color=#447700>!          log10(6.1071))*100.<a name='4025'></font>
<a name='4026'>
<a name='4027'>
      elseif (i_type.EQ.0 .or. T.ge.273.15) then<a name='4028'>
<font color=#447700>! LIQUID<a name='4029'></font>
<a name='4030'>
<font color=#447700>!       Flatau formulation:<a name='4031'></font>
         dt       = max(-80.,t-273.16)<a name='4032'>
         polysvp1 = a0 + dt*(a1+dt*(a2+dt*(a3+dt*(a4+dt*(a5+dt*(a6+dt*(a7+a8*dt)))))))<a name='4033'>
         polysvp1 = polysvp1*100.<a name='4034'>
<a name='4035'>
<font color=#447700>!       Goff-Gratch formulation:<a name='4036'></font>
<font color=#447700>!        POLYSVP1 = 10.**(-7.90298*(373.16/T-1.)+                         &amp;<a name='4037'></font>
<font color=#447700>!             5.02808*log10(373.16/T)-                                    &amp;<a name='4038'></font>
<font color=#447700>!             1.3816E-7*(10**(11.344*(1.-T/373.16))-1.)+                  &amp;<a name='4039'></font>
<font color=#447700>!             8.1328E-3*(10**(-3.49149*(373.16/T-1.))-1.)+                &amp;<a name='4040'></font>
<font color=#447700>!             log10(1013.246))*100.<a name='4041'></font>
<a name='4042'>
         endif<a name='4043'>
<a name='4044'>
<a name='4045'>
 end function polysvp1<a name='4046'>
<a name='4047'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4048'></font>
<a name='4049'>
<A NAME='GAMMA'><A href='../../html_code/phys/module_mp_p3.F.html#GAMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4050'>
 real <font color=#993300>function </font><font color=#cc0000>gamma</font>(X) <A href='../../call_to/GAMMA.html' TARGET='index'>117</A><a name='4051'>
<font color=#447700>!----------------------------------------------------------------------<a name='4052'></font>
<font color=#447700>! THIS ROUTINE CALCULATES THE gamma FUNCTION FOR A REAL ARGUMENT X.<a name='4053'></font>
<font color=#447700>!   COMPUTATION IS BASED ON AN ALGORITHM OUTLINED IN REFERENCE 1.<a name='4054'></font>
<font color=#447700>!   THE PROGRAM USES RATIONAL FUNCTIONS THAT APPROXIMATE THE gamma<a name='4055'></font>
<font color=#447700>!   FUNCTION TO AT LEAST 20 SIGNIFICANT DECIMAL DIGITS.  COEFFICIENTS<a name='4056'></font>
<font color=#447700>!   FOR THE APPROXIMATION OVER THE INTERVAL (1,2) ARE UNPUBLISHED.<a name='4057'></font>
<font color=#447700>!   THOSE FOR THE APPROXIMATION FOR X .GE. 12 ARE FROM REFERENCE 2.<a name='4058'></font>
<font color=#447700>!   THE ACCURACY ACHIEVED DEPENDS ON THE ARITHMETIC SYSTEM, THE<a name='4059'></font>
<font color=#447700>!   COMPILER, THE INTRINSIC FUNCTIONS, AND PROPER SELECTION OF THE<a name='4060'></font>
<font color=#447700>!   MACHINE-DEPENDENT CONSTANTS.<a name='4061'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4062'></font>
<font color=#447700>!<a name='4063'></font>
<font color=#447700>! EXPLANATION OF MACHINE-DEPENDENT CONSTANTS<a name='4064'></font>
<font color=#447700>!<a name='4065'></font>
<font color=#447700>! BETA   - RADIX FOR THE FLOATING-POINT REPRESENTATION<a name='4066'></font>
<font color=#447700>! MAXEXP - THE SMALLEST POSITIVE POWER OF BETA THAT OVERFLOWS<a name='4067'></font>
<font color=#447700>! XBIG   - THE LARGEST ARGUMENT FOR WHICH gamma(X) IS REPRESENTABLE<a name='4068'></font>
<font color=#447700>!          IN THE MACHINE, I.E., THE SOLUTION TO THE EQUATION<a name='4069'></font>
<font color=#447700>!                  gamma(XBIG) = BETA**MAXEXP<a name='4070'></font>
<font color=#447700>! XINF   - THE LARGEST MACHINE REPRESENTABLE FLOATING-POINT NUMBER;<a name='4071'></font>
<font color=#447700>!          APPROXIMATELY BETA**MAXEXP<a name='4072'></font>
<font color=#447700>! EPS    - THE SMALLEST POSITIVE FLOATING-POINT NUMBER SUCH THAT<a name='4073'></font>
<font color=#447700>!          1.0+EPS .GT. 1.0<a name='4074'></font>
<font color=#447700>! XMININ - THE SMALLEST POSITIVE FLOATING-POINT NUMBER SUCH THAT<a name='4075'></font>
<font color=#447700>!          1/XMININ IS MACHINE REPRESENTABLE<a name='4076'></font>
<font color=#447700>!<a name='4077'></font>
<font color=#447700>!     APPROXIMATE VALUES FOR SOME IMPORTANT MACHINES ARE:<a name='4078'></font>
<font color=#447700>!<a name='4079'></font>
<font color=#447700>!                            BETA       MAXEXP        XBIG<a name='4080'></font>
<font color=#447700>!<a name='4081'></font>
<font color=#447700>! CRAY-1         (S.P.)        2         8191        966.961<a name='4082'></font>
<font color=#447700>! CYBER 180/855<a name='4083'></font>
<font color=#447700>!   UNDER NOS    (S.P.)        2         1070        177.803<a name='4084'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='4085'></font>
<font color=#447700>!   SUN, ETC.)   (S.P.)        2          128        35.040<a name='4086'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='4087'></font>
<font color=#447700>!   SUN, ETC.)   (D.P.)        2         1024        171.624<a name='4088'></font>
<font color=#447700>! IBM 3033       (D.P.)       16           63        57.574<a name='4089'></font>
<font color=#447700>! VAX D-FORMAT   (D.P.)        2          127        34.844<a name='4090'></font>
<font color=#447700>! VAX G-FORMAT   (D.P.)        2         1023        171.489<a name='4091'></font>
<font color=#447700>!<a name='4092'></font>
<font color=#447700>!                            XINF         EPS        XMININ<a name='4093'></font>
<font color=#447700>!<a name='4094'></font>
<font color=#447700>! CRAY-1         (S.P.)   5.45E+2465   7.11E-15    1.84E-2466<a name='4095'></font>
<font color=#447700>! CYBER 180/855<a name='4096'></font>
<font color=#447700>!   UNDER NOS    (S.P.)   1.26E+322    3.55E-15    3.14E-294<a name='4097'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='4098'></font>
<font color=#447700>!   SUN, ETC.)   (S.P.)   3.40E+38     1.19E-7     1.18E-38<a name='4099'></font>
<font color=#447700>! IEEE (IBM/XT,<a name='4100'></font>
<font color=#447700>!   SUN, ETC.)   (D.P.)   1.79D+308    2.22D-16    2.23D-308<a name='4101'></font>
<font color=#447700>! IBM 3033       (D.P.)   7.23D+75     2.22D-16    1.39D-76<a name='4102'></font>
<font color=#447700>! VAX D-FORMAT   (D.P.)   1.70D+38     1.39D-17    5.88D-39<a name='4103'></font>
<font color=#447700>! VAX G-FORMAT   (D.P.)   8.98D+307    1.11D-16    1.12D-308<a name='4104'></font>
<font color=#447700>!<a name='4105'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4106'></font>
<font color=#447700>!<a name='4107'></font>
<font color=#447700>! ERROR RETURNS<a name='4108'></font>
<font color=#447700>!<a name='4109'></font>
<font color=#447700>!  THE PROGRAM RETURNS THE VALUE XINF FOR SINGULARITIES OR<a name='4110'></font>
<font color=#447700>!     WHEN OVERFLOW WOULD OCCUR.  THE COMPUTATION IS BELIEVED<a name='4111'></font>
<font color=#447700>!     TO BE FREE OF UNDERFLOW AND OVERFLOW.<a name='4112'></font>
<font color=#447700>!<a name='4113'></font>
<font color=#447700>!<a name='4114'></font>
<font color=#447700>!  INTRINSIC FUNCTIONS REQUIRED ARE:<a name='4115'></font>
<font color=#447700>!<a name='4116'></font>
<font color=#447700>!     INT, DBLE, EXP, log, REAL, SIN<a name='4117'></font>
<font color=#447700>!<a name='4118'></font>
<font color=#447700>!<a name='4119'></font>
<font color=#447700>! REFERENCES:  AN OVERVIEW OF SOFTWARE DEVELOPMENT FOR SPECIAL<a name='4120'></font>
<font color=#447700>!              FUNCTIONS   W. J. CODY, LECTURE NOTES IN MATHEMATICS,<a name='4121'></font>
<font color=#447700>!              506, NUMERICAL ANALYSIS DUNDEE, 1975, G. A. WATSON<a name='4122'></font>
<font color=#447700>!              (ED.), SPRINGER VERLAG, BERLIN, 1976.<a name='4123'></font>
<font color=#447700>!<a name='4124'></font>
<font color=#447700>!              COMPUTER APPROXIMATIONS, HART, ET. AL., WILEY AND<a name='4125'></font>
<font color=#447700>!              SONS, NEW YORK, 1968.<a name='4126'></font>
<font color=#447700>!<a name='4127'></font>
<font color=#447700>!  LATEST MODIFICATION: OCTOBER 12, 1989<a name='4128'></font>
<font color=#447700>!<a name='4129'></font>
<font color=#447700>!  AUTHORS: W. J. CODY AND L. STOLTZ<a name='4130'></font>
<font color=#447700>!           APPLIED MATHEMATICS DIVISION<a name='4131'></font>
<font color=#447700>!           ARGONNE NATIONAL LABORATORY<a name='4132'></font>
<font color=#447700>!           ARGONNE, IL 60439<a name='4133'></font>
<font color=#447700>!<a name='4134'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4135'></font>
      implicit none<a name='4136'>
      integer :: I,N<a name='4137'>
      logical :: l_parity<a name='4138'>
      real ::                                                       &amp;<a name='4139'>
          CONV,EPS,FACT,HALF,ONE,res,sum,TWELVE,                    &amp;<a name='4140'>
          TWO,X,XBIG,XDEN,XINF,XMININ,XNUM,Y,Y1,YSQ,Z,ZERO<a name='4141'>
      real, dimension(7) :: C<a name='4142'>
      real, dimension(8) :: P<a name='4143'>
      real, dimension(8) :: Q<a name='4144'>
      real, parameter    :: constant1 = 0.9189385332046727417803297<a name='4145'>
<a name='4146'>
<font color=#447700>!----------------------------------------------------------------------<a name='4147'></font>
<font color=#447700>!  MATHEMATICAL CONSTANTS<a name='4148'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4149'></font>
      data ONE,HALF,TWELVE,TWO,ZERO/1.0E0,0.5E0,12.0E0,2.0E0,0.0E0/<a name='4150'>
<font color=#447700>!----------------------------------------------------------------------<a name='4151'></font>
<font color=#447700>!  MACHINE DEPENDENT PARAMETERS<a name='4152'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4153'></font>
      data XBIG,XMININ,EPS/35.040E0,1.18E-38,1.19E-7/,XINF/3.4E38/<a name='4154'>
<font color=#447700>!----------------------------------------------------------------------<a name='4155'></font>
<font color=#447700>!  NUMERATOR AND DENOMINATOR COEFFICIENTS FOR RATIONAL MINIMAX<a name='4156'></font>
<font color=#447700>!     APPROXIMATION OVER (1,2).<a name='4157'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4158'></font>
      data P/-1.71618513886549492533811E+0,2.47656508055759199108314E+1,  &amp;<a name='4159'>
             -3.79804256470945635097577E+2,6.29331155312818442661052E+2,  &amp;<a name='4160'>
             8.66966202790413211295064E+2,-3.14512729688483675254357E+4,  &amp;<a name='4161'>
             -3.61444134186911729807069E+4,6.64561438202405440627855E+4/<a name='4162'>
      data Q/-3.08402300119738975254353E+1,3.15350626979604161529144E+2,  &amp;<a name='4163'>
             -1.01515636749021914166146E+3,-3.10777167157231109440444E+3, &amp;<a name='4164'>
              2.25381184209801510330112E+4,4.75584627752788110767815E+3,  &amp;<a name='4165'>
            -1.34659959864969306392456E+5,-1.15132259675553483497211E+5/<a name='4166'>
<font color=#447700>!----------------------------------------------------------------------<a name='4167'></font>
<font color=#447700>!  COEFFICIENTS FOR MINIMAX APPROXIMATION OVER (12, INF).<a name='4168'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4169'></font>
      data C/-1.910444077728E-03,8.4171387781295E-04,                      &amp;<a name='4170'>
           -5.952379913043012E-04,7.93650793500350248E-04,                 &amp;<a name='4171'>
           -2.777777777777681622553E-03,8.333333333333333331554247E-02,    &amp;<a name='4172'>
            5.7083835261E-03/<a name='4173'>
<font color=#447700>!----------------------------------------------------------------------<a name='4174'></font>
<font color=#447700>!  STATEMENT FUNCTIONS FOR CONVERSION BETWEEN INTEGER AND FLOAT<a name='4175'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4176'></font>
      CONV(I) = REAL(I)<a name='4177'>
      l_parity=.FALSE.<a name='4178'>
      FACT=ONE<a name='4179'>
      N=0<a name='4180'>
      Y=X<a name='4181'>
      if (Y.LE.ZERO) then<a name='4182'>
<font color=#447700>!----------------------------------------------------------------------<a name='4183'></font>
<font color=#447700>!  ARGUMENT IS NEGATIVE<a name='4184'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4185'></font>
        Y=-X<a name='4186'>
        Y1=AINT(Y)<a name='4187'>
        res=Y-Y1<a name='4188'>
        if (res.NE.ZERO) then<a name='4189'>
          if(Y1.NE.AINT(Y1*HALF)*TWO)l_parity=.TRUE.<a name='4190'>
          FACT=-PI/SIN(PI*res)<a name='4191'>
          Y=Y+ONE<a name='4192'>
        else<a name='4193'>
          res=XINF<a name='4194'>
          goto 900<a name='4195'>
        endif<a name='4196'>
      endif<a name='4197'>
<font color=#447700>!----------------------------------------------------------------------<a name='4198'></font>
<font color=#447700>!  ARGUMENT IS POSITIVE<a name='4199'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4200'></font>
      if (Y.LT.EPS) then<a name='4201'>
<font color=#447700>!----------------------------------------------------------------------<a name='4202'></font>
<font color=#447700>!  ARGUMENT .LT. EPS<a name='4203'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4204'></font>
        if (Y.GE.XMININ) then<a name='4205'>
          res=ONE/Y<a name='4206'>
        else<a name='4207'>
          res=XINF<a name='4208'>
          goto 900<a name='4209'>
        endif<a name='4210'>
      elseif (Y.LT.TWELVE) then<a name='4211'>
        Y1=Y<a name='4212'>
        if (Y.LT.ONE) then<a name='4213'>
<font color=#447700>!----------------------------------------------------------------------<a name='4214'></font>
<font color=#447700>!  0.0 .LT. ARGUMENT .LT. 1.0<a name='4215'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4216'></font>
          Z=Y<a name='4217'>
          Y=Y+ONE<a name='4218'>
        else<a name='4219'>
<font color=#447700>!----------------------------------------------------------------------<a name='4220'></font>
<font color=#447700>!  1.0 .LT. ARGUMENT .LT. 12.0, REDUCE ARGUMENT IF NECESSARY<a name='4221'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4222'></font>
          N=INT(Y)-1<a name='4223'>
          Y=Y-CONV(N)<a name='4224'>
          Z=Y-ONE<a name='4225'>
        endif<a name='4226'>
<font color=#447700>!----------------------------------------------------------------------<a name='4227'></font>
<font color=#447700>!  EVALUATE APPROXIMATION FOR 1.0 .LT. ARGUMENT .LT. 2.0<a name='4228'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4229'></font>
        XNUM=ZERO<a name='4230'>
        XDEN=ONE<a name='4231'>
        do I=1,8<a name='4232'>
          XNUM=(XNUM+P(I))*Z<a name='4233'>
          XDEN=XDEN*Z+Q(I)<a name='4234'>
        enddo<a name='4235'>
        res=XNUM/XDEN+ONE<a name='4236'>
        if (Y1.LT.Y) then<a name='4237'>
<font color=#447700>!----------------------------------------------------------------------<a name='4238'></font>
<font color=#447700>!  ADJUST RESULT FOR CASE  0.0 .LT. ARGUMENT .LT. 1.0<a name='4239'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4240'></font>
          res=res/Y1<a name='4241'>
        elseif (Y1.GT.Y) then<a name='4242'>
<font color=#447700>!----------------------------------------------------------------------<a name='4243'></font>
<font color=#447700>!  ADJUST RESULT FOR CASE  2.0 .LT. ARGUMENT .LT. 12.0<a name='4244'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4245'></font>
          do I=1,N<a name='4246'>
            res=res*Y<a name='4247'>
            Y=Y+ONE<a name='4248'>
          enddo<a name='4249'>
        endif<a name='4250'>
      else<a name='4251'>
<font color=#447700>!----------------------------------------------------------------------<a name='4252'></font>
<font color=#447700>!  EVALUATE FOR ARGUMENT .GE. 12.0,<a name='4253'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4254'></font>
        if (Y.LE.XBIG) then<a name='4255'>
          YSQ=Y*Y<a name='4256'>
          sum=C(7)<a name='4257'>
          do I=1,6<a name='4258'>
            sum=sum/YSQ+C(I)<a name='4259'>
          enddo<a name='4260'>
          sum=sum/Y-Y+constant1<a name='4261'>
          sum=sum+(Y-HALF)*log(Y)<a name='4262'>
          res=exp(sum)<a name='4263'>
        else<a name='4264'>
          res=XINF<a name='4265'>
          goto 900<a name='4266'>
        endif<a name='4267'>
      endif<a name='4268'>
<font color=#447700>!----------------------------------------------------------------------<a name='4269'></font>
<font color=#447700>!  FINAL ADJUSTMENTS AND RETURN<a name='4270'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='4271'></font>
      if (l_parity)res=-res<a name='4272'>
      if (FACT.NE.ONE)res=FACT/res<a name='4273'>
  900 gamma=res<a name='4274'>
      return<a name='4275'>
<font color=#447700>! ---------- LAST LINE OF gamma ----------<a name='4276'></font>
<a name='4277'>
 end function gamma<a name='4278'>
<a name='4279'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4280'></font>
<a name='4281'>
<A NAME='DERF'><A href='../../html_code/phys/module_mp_p3.F.html#DERF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4282'>
 real <font color=#993300>function </font><font color=#cc0000>DERF</font>(X) <A href='../../call_to/DERF.html' TARGET='index'>1</A>,<A href='../../call_from/DERF.html' TARGET='index'>1</A><a name='4283'>
<a name='4284'>
 implicit none<a name='4285'>
<a name='4286'>
 real :: X<a name='4287'>
 real, dimension(0 : 64) :: A, B<a name='4288'>
 real :: W,T,Y<a name='4289'>
 integer :: K,I<a name='4290'>
      data A/                                                 &amp;<a name='4291'>
         0.00000000005958930743E0, -0.00000000113739022964E0, &amp;<a name='4292'>
         0.00000001466005199839E0, -0.00000016350354461960E0, &amp;<a name='4293'>
         0.00000164610044809620E0, -0.00001492559551950604E0, &amp;<a name='4294'>
         0.00012055331122299265E0, -0.00085483269811296660E0, &amp;<a name='4295'>
         0.00522397762482322257E0, -0.02686617064507733420E0, &amp;<a name='4296'>
         0.11283791670954881569E0, -0.37612638903183748117E0, &amp;<a name='4297'>
         1.12837916709551257377E0,                            &amp;<a name='4298'>
         0.00000000002372510631E0, -0.00000000045493253732E0, &amp;<a name='4299'>
         0.00000000590362766598E0, -0.00000006642090827576E0, &amp;<a name='4300'>
         0.00000067595634268133E0, -0.00000621188515924000E0, &amp;<a name='4301'>
         0.00005103883009709690E0, -0.00037015410692956173E0, &amp;<a name='4302'>
         0.00233307631218880978E0, -0.01254988477182192210E0, &amp;<a name='4303'>
         0.05657061146827041994E0, -0.21379664776456006580E0, &amp;<a name='4304'>
         0.84270079294971486929E0,                            &amp;<a name='4305'>
         0.00000000000949905026E0, -0.00000000018310229805E0, &amp;<a name='4306'>
         0.00000000239463074000E0, -0.00000002721444369609E0, &amp;<a name='4307'>
         0.00000028045522331686E0, -0.00000261830022482897E0, &amp;<a name='4308'>
         0.00002195455056768781E0, -0.00016358986921372656E0, &amp;<a name='4309'>
         0.00107052153564110318E0, -0.00608284718113590151E0, &amp;<a name='4310'>
         0.02986978465246258244E0, -0.13055593046562267625E0, &amp;<a name='4311'>
         0.67493323603965504676E0,                            &amp;<a name='4312'>
         0.00000000000382722073E0, -0.00000000007421598602E0, &amp;<a name='4313'>
         0.00000000097930574080E0, -0.00000001126008898854E0, &amp;<a name='4314'>
         0.00000011775134830784E0, -0.00000111992758382650E0, &amp;<a name='4315'>
         0.00000962023443095201E0, -0.00007404402135070773E0, &amp;<a name='4316'>
         0.00050689993654144881E0, -0.00307553051439272889E0, &amp;<a name='4317'>
         0.01668977892553165586E0, -0.08548534594781312114E0, &amp;<a name='4318'>
         0.56909076642393639985E0,                            &amp;<a name='4319'>
         0.00000000000155296588E0, -0.00000000003032205868E0, &amp;<a name='4320'>
         0.00000000040424830707E0, -0.00000000471135111493E0, &amp;<a name='4321'>
         0.00000005011915876293E0, -0.00000048722516178974E0, &amp;<a name='4322'>
         0.00000430683284629395E0, -0.00003445026145385764E0, &amp;<a name='4323'>
         0.00024879276133931664E0, -0.00162940941748079288E0, &amp;<a name='4324'>
         0.00988786373932350462E0, -0.05962426839442303805E0, &amp;<a name='4325'>
         0.49766113250947636708E0 /<a name='4326'>
      data (B(I), I = 0, 12) /                                 &amp;<a name='4327'>
         -0.00000000029734388465E0,  0.00000000269776334046E0, &amp;<a name='4328'>
         -0.00000000640788827665E0, -0.00000001667820132100E0, &amp;<a name='4329'>
         -0.00000021854388148686E0,  0.00000266246030457984E0, &amp;<a name='4330'>
          0.00001612722157047886E0, -0.00025616361025506629E0, &amp;<a name='4331'>
          0.00015380842432375365E0,  0.00815533022524927908E0, &amp;<a name='4332'>
         -0.01402283663896319337E0, -0.19746892495383021487E0, &amp;<a name='4333'>
          0.71511720328842845913E0 /<a name='4334'>
      data (B(I), I = 13, 25) /                                &amp;<a name='4335'>
         -0.00000000001951073787E0, -0.00000000032302692214E0, &amp;<a name='4336'>
          0.00000000522461866919E0,  0.00000000342940918551E0, &amp;<a name='4337'>
         -0.00000035772874310272E0,  0.00000019999935792654E0, &amp;<a name='4338'>
          0.00002687044575042908E0, -0.00011843240273775776E0, &amp;<a name='4339'>
         -0.00080991728956032271E0,  0.00661062970502241174E0, &amp;<a name='4340'>
          0.00909530922354827295E0, -0.20160072778491013140E0, &amp;<a name='4341'>
          0.51169696718727644908E0 /<a name='4342'>
      data (B(I), I = 26, 38) /                                &amp;<a name='4343'>
         0.00000000003147682272E0, -0.00000000048465972408E0,  &amp;<a name='4344'>
         0.00000000063675740242E0,  0.00000003377623323271E0,  &amp;<a name='4345'>
        -0.00000015451139637086E0, -0.00000203340624738438E0,  &amp;<a name='4346'>
         0.00001947204525295057E0,  0.00002854147231653228E0,  &amp;<a name='4347'>
        -0.00101565063152200272E0,  0.00271187003520095655E0,  &amp;<a name='4348'>
         0.02328095035422810727E0, -0.16725021123116877197E0,  &amp;<a name='4349'>
         0.32490054966649436974E0 /<a name='4350'>
      data (B(I), I = 39, 51) /                                &amp;<a name='4351'>
         0.00000000002319363370E0, -0.00000000006303206648E0,  &amp;<a name='4352'>
        -0.00000000264888267434E0,  0.00000002050708040581E0,  &amp;<a name='4353'>
         0.00000011371857327578E0, -0.00000211211337219663E0,  &amp;<a name='4354'>
         0.00000368797328322935E0,  0.00009823686253424796E0,  &amp;<a name='4355'>
        -0.00065860243990455368E0, -0.00075285814895230877E0,  &amp;<a name='4356'>
         0.02585434424202960464E0, -0.11637092784486193258E0,  &amp;<a name='4357'>
         0.18267336775296612024E0 /<a name='4358'>
      data (B(I), I = 52, 64) /                                &amp;<a name='4359'>
        -0.00000000000367789363E0,  0.00000000020876046746E0,  &amp;<a name='4360'>
        -0.00000000193319027226E0, -0.00000000435953392472E0,  &amp;<a name='4361'>
         0.00000018006992266137E0, -0.00000078441223763969E0,  &amp;<a name='4362'>
        -0.00000675407647949153E0,  0.00008428418334440096E0,  &amp;<a name='4363'>
        -0.00017604388937031815E0, -0.00239729611435071610E0,  &amp;<a name='4364'>
         0.02064129023876022970E0, -0.06905562880005864105E0,  &amp;<a name='4365'>
         0.09084526782065478489E0 /<a name='4366'>
      W = ABS(X)<a name='4367'>
      if (W .LT. 2.2D0) then<a name='4368'>
          T = W * W<a name='4369'>
          K = INT(T)<a name='4370'>
          T = T - K<a name='4371'>
          K = K * 13<a name='4372'>
          Y = ((((((((((((A(K) * T + A(K + 1)) * T +              &amp;<a name='4373'>
              A(K + 2)) * T + A(K + 3)) * T + A(K + 4)) * T +     &amp;<a name='4374'>
              A(K + 5)) * T + A(K + 6)) * T + A(K + 7)) * T +     &amp;<a name='4375'>
              A(K + 8)) * T + A(K + 9)) * T + A(K + 10)) * T +    &amp;<a name='4376'>
              A(K + 11)) * T + A(K + 12)) * W<a name='4377'>
      elseif (W .LT. 6.9D0) then<a name='4378'>
          K = INT(W)<a name='4379'>
          T = W - K<a name='4380'>
          K = 13 * (K - 2)<a name='4381'>
          Y = (((((((((((B(K) * T + B(K + 1)) * T +               &amp;<a name='4382'>
              B(K + 2)) * T + B(K + 3)) * T + B(K + 4)) * T +     &amp;<a name='4383'>
              B(K + 5)) * T + B(K + 6)) * T + B(K + 7)) * T +     &amp;<a name='4384'>
              B(K + 8)) * T + B(K + 9)) * T + B(K + 10)) * T +    &amp;<a name='4385'>
              B(K + 11)) * T + B(K + 12)<a name='4386'>
          Y = Y * Y<a name='4387'>
          Y = Y * Y<a name='4388'>
          Y = Y * Y<a name='4389'>
          Y = 1 - Y * Y<a name='4390'>
      else<a name='4391'>
          Y = 1<a name='4392'>
      endif<a name='4393'>
      if (X .LT. 0) Y = -Y<a name='4394'>
      DERF = Y<a name='4395'>
<a name='4396'>
 end function DERF<a name='4397'>
<a name='4398'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4399'></font>
<a name='4400'>
<A NAME='ISNAN'><A href='../../html_code/phys/module_mp_p3.F.html#ISNAN' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='4401'>
 logical <font color=#993300>function </font><font color=#cc0000>isnan</font>(arg1)<a name='4402'>
       real,intent(in) :: arg1<a name='4403'>
       isnan=( arg1  .ne. arg1 )<a name='4404'>
       return<a name='4405'>
 end function isnan<a name='4406'>
<a name='4407'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4408'></font>
<a name='4409'>
<font color=#447700>!==========================================================================================!<a name='4410'></font>
<A NAME='ICECAT_DESTINATION'><A href='../../html_code/phys/module_mp_p3.F.html#ICECAT_DESTINATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4411'>
 <font color=#993300>subroutine </font><font color=#cc0000>icecat_destination</font>(Qi,Di,D_nuc,deltaD_init,log_ni_add,iice_dest) <A href='../../call_to/ICECAT_DESTINATION.html' TARGET='index'>6</A><a name='4412'>
<a name='4413'>
 <font color=#447700>!--------------------------------------------------------------------------------------!<a name='4414'></font>
 <font color=#447700>! Returns the index of the destination ice category into which new ice is nucleated.<a name='4415'></font>
 <font color=#447700>!<a name='4416'></font>
 <font color=#447700>! New ice will be nucleated into the category in which the existing ice is<a name='4417'></font>
 <font color=#447700>! closest in size to the ice being nucleated.  The exception is that if the<a name='4418'></font>
 <font color=#447700>! size difference between the nucleated ice and existing ice exceeds a threshold<a name='4419'></font>
 <font color=#447700>! value for all categories, then ice is initiated into a new category.<a name='4420'></font>
 <font color=#447700>!<a name='4421'></font>
 <font color=#447700>! D_nuc        = mean diameter of new particles being added to a category<a name='4422'></font>
 <font color=#447700>! D(i)         = mean diameter of particles in category i<a name='4423'></font>
 <font color=#447700>! diff(i)      = |D(i) - D_nuc|<a name='4424'></font>
 <font color=#447700>! deltaD_init  = threshold size difference to consider a new (empty) category<a name='4425'></font>
 <font color=#447700>! mindiff      = minimum of all diff(i) (for non-empty categories)<a name='4426'></font>
 <font color=#447700>!<a name='4427'></font>
 <font color=#447700>! POSSIBLE CASES                      DESTINATION CATEGORY<a name='4428'></font>
 <font color=#447700>!---------------                      --------------------<a name='4429'></font>
 <font color=#447700>! case 1:  all empty                  category 1<a name='4430'></font>
 <font color=#447700>! case 2:  all full                   category with smallest diff<a name='4431'></font>
 <font color=#447700>! case 3:  partly full<a name='4432'></font>
 <font color=#447700>!  case 3a:  mindiff &lt;  diff_thrs     category with smallest diff<a name='4433'></font>
 <font color=#447700>!  case 3b:  mindiff &gt;= diff_thrs     first empty category<a name='4434'></font>
 <font color=#447700>!--------------------------------------------------------------------------------------!<a name='4435'></font>
<a name='4436'>
 implicit none<a name='4437'>
<a name='4438'>
<font color=#447700>! arguments:<a name='4439'></font>
 real, intent(in), dimension(:) :: Qi,Di<a name='4440'>
 real, intent(in)               :: D_nuc,deltaD_init<a name='4441'>
 integer, intent(out)           :: iice_dest<a name='4442'>
 logical, intent(out)           :: log_ni_add<a name='4443'>
<a name='4444'>
<font color=#447700>! local variables:<a name='4445'></font>
 logical                        :: all_full,all_empty<a name='4446'>
 integer                        :: i_firstEmptyCategory,iice,i_mindiff,n_cat<a name='4447'>
 real                           :: mindiff,diff<a name='4448'>
 real, parameter                :: qsmall_loc = 1.e-14<a name='4449'>
<a name='4450'>
 <font color=#447700>!--------------------------------------------------------------------------------------!<a name='4451'></font>
<a name='4452'>
 n_cat      = size(Qi)<a name='4453'>
 log_ni_add = .true.<a name='4454'>
 iice_dest  = -99<a name='4455'>
<a name='4456'>
<font color=#447700>!-- test:<a name='4457'></font>
<font color=#447700>! iice_dest = 1<a name='4458'></font>
<font color=#447700>! return<a name='4459'></font>
<font color=#447700>!==<a name='4460'></font>
<a name='4461'>
 if (sum(Qi(:))&lt;qsmall_loc) then<a name='4462'>
<a name='4463'>
 <font color=#447700>!case 1:<a name='4464'></font>
    iice_dest = 1<a name='4465'>
    return<a name='4466'>
<a name='4467'>
 else<a name='4468'>
<a name='4469'>
    all_full  = .true.<a name='4470'>
    all_empty = .false.<a name='4471'>
    mindiff   = 9.e+9<a name='4472'>
    i_firstEmptyCategory = 0<a name='4473'>
<a name='4474'>
    do iice = 1,n_cat<a name='4475'>
       if (Qi(iice) .ge. qsmall_loc) then<a name='4476'>
          all_empty = .false.<a name='4477'>
          diff      = abs(Di(iice)-D_nuc)<a name='4478'>
          if (diff .lt. mindiff) then<a name='4479'>
             mindiff   = diff<a name='4480'>
             i_mindiff = iice<a name='4481'>
          endif<a name='4482'>
       else<a name='4483'>
          all_full = .false.<a name='4484'>
          if (i_firstEmptyCategory.eq.0) i_firstEmptyCategory = iice<a name='4485'>
       endif<a name='4486'>
    enddo<a name='4487'>
<a name='4488'>
    if (all_full) then<a name='4489'>
 <font color=#447700>!case 2:<a name='4490'></font>
       iice_dest = i_mindiff<a name='4491'>
       if (mindiff .ge. 100.e-6) log_ni_add=.false.<a name='4492'>
       return<a name='4493'>
    else<a name='4494'>
       if (mindiff .lt. deltaD_init) then<a name='4495'>
 <font color=#447700>!case 3a:<a name='4496'></font>
          iice_dest = i_mindiff<a name='4497'>
          return<a name='4498'>
       else<a name='4499'>
 <font color=#447700>!case 3b:<a name='4500'></font>
          iice_dest = i_firstEmptyCategory<a name='4501'>
          return<a name='4502'>
       endif<a name='4503'>
    endif<a name='4504'>
<a name='4505'>
 endif<a name='4506'>
<a name='4507'>
 print*, 'ERROR in s/r icecat_destination -- made it to end'<a name='4508'>
 stop<a name='4509'>
<a name='4510'>
<a name='4511'>
 end subroutine icecat_destination<a name='4512'>
<a name='4513'>
<a name='4514'>
<font color=#447700>!======================================================================================!<a name='4515'></font>
<a name='4516'>
<A NAME='FIND_LOOKUPTABLE_INDICES_1A'><A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_1A' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4517'>
 <font color=#993300>subroutine </font><font color=#cc0000>find_lookupTable_indices_1a</font>(dumi,dumjj,dumii,dumzz,dum1,dum4,dum5,dum6,      &amp; <A href='../../call_to/FIND_LOOKUPTABLE_INDICES_1A.html' TARGET='index'>3</A><a name='4518'>
                                        isize,rimsize,densize,zsize,qitot,nitot,qirim,   &amp;<a name='4519'>
                                        zitot_in,rhop)<a name='4520'>
<a name='4521'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4522'></font>
<font color=#447700>! Finds indices in 3D ice (only) lookup table<a name='4523'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4524'></font>
<a name='4525'>
 implicit none<a name='4526'>
<a name='4527'>
<font color=#447700>! arguments:<a name='4528'></font>
 integer, intent(out) :: dumi,dumjj,dumii,dumzz<a name='4529'>
 real,    intent(out) :: dum1,dum4,dum5,dum6<a name='4530'>
 integer, intent(in)  :: isize,rimsize,densize,zsize<a name='4531'>
 real,    intent(in)  :: qitot,nitot,qirim,zitot_in,rhop<a name='4532'>
<a name='4533'>
<font color=#447700>! local variables:<a name='4534'></font>
 real                 :: zitot<a name='4535'>
<a name='4536'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4537'></font>
<a name='4538'>
           <font color=#447700>! find index for qi (normalized ice mass mixing ratio = qitot/nitot)<a name='4539'></font>
<font color=#447700>!             dum1 = (alog10(qitot)+16.)/0.70757  !orig<a name='4540'></font>
<font color=#447700>!             dum1 = (alog10(qitot)+16.)*1.41328<a name='4541'></font>
<font color=#447700>! we are inverting this equation from the lookup table to solve for i:<a name='4542'></font>
<font color=#447700>! qitot/nitot=261.7**((i+10)*0.1)*1.e-18<a name='4543'></font>
             dum1 = (alog10(qitot/nitot)+18.)/(0.1*alog10(261.7))-10.<a name='4544'>
             dumi = int(dum1)<a name='4545'>
             <font color=#447700>! set limits (to make sure the calculated index doesn't exceed range of lookup table)<a name='4546'></font>
             dum1 = min(dum1,real(isize))<a name='4547'>
             dum1 = max(dum1,1.)<a name='4548'>
             dumi = max(1,dumi)<a name='4549'>
             dumi = min(isize-1,dumi)<a name='4550'>
<a name='4551'>
           <font color=#447700>! find index for rime mass fraction<a name='4552'></font>
             dum4  = (qirim/qitot)*3. + 1.<a name='4553'>
             dumii = int(dum4)<a name='4554'>
             <font color=#447700>! set limits<a name='4555'></font>
             dum4  = min(dum4,real(rimsize))<a name='4556'>
             dum4  = max(dum4,1.)<a name='4557'>
             dumii = max(1,dumii)<a name='4558'>
             dumii = min(rimsize-1,dumii)<a name='4559'>
<a name='4560'>
           <font color=#447700>! find index for bulk rime density<a name='4561'></font>
           <font color=#447700>! (account for uneven spacing in lookup table for density)<a name='4562'></font>
             if (rhop.le.650.) then<a name='4563'>
                dum5 = (rhop-50.)*0.005 + 1.<a name='4564'>
             else<a name='4565'>
                dum5 =(rhop-650.)*0.004 + 4.<a name='4566'>
             endif<a name='4567'>
             dumjj = int(dum5)<a name='4568'>
             <font color=#447700>! set limits<a name='4569'></font>
             dum5  = min(dum5,real(densize))<a name='4570'>
             dum5  = max(dum5,1.)<a name='4571'>
             dumjj = max(1,dumjj)<a name='4572'>
             dumjj = min(densize-1,dumjj)<a name='4573'>
<a name='4574'>
<font color=#447700>! ! ! find index for moment6<a name='4575'></font>
<font color=#447700>! !             !invert equation in lookupTable1 that assigns mom6 values<a name='4576'></font>
<font color=#447700>! !             !to index values:  Z_value = 9.**i_Z*1.e-30<a name='4577'></font>
<font color=#447700>! !              dum6  = (alog10(zitot)+30.)*1.04795<a name='4578'></font>
<font color=#447700>! !              dumzz = int(dum6)<a name='4579'></font>
<font color=#447700>! !              ! set limits<a name='4580'></font>
<font color=#447700>! !              dum6  = min(dum6,real(zsize))<a name='4581'></font>
<font color=#447700>! !              dum6  = max(dum6,1.)<a name='4582'></font>
<font color=#447700>! !              dumzz = max(1,dumzz)<a name='4583'></font>
<font color=#447700>! !              dumzz = min(zsize-1,dumzz)<a name='4584'></font>
             dum6  = -99<a name='4585'>
             dumzz = -99<a name='4586'>
<a name='4587'>
 end subroutine find_lookupTable_indices_1a<a name='4588'>
<a name='4589'>
<font color=#447700>!======================================================================================!<a name='4590'></font>
<a name='4591'>
<A NAME='FIND_LOOKUPTABLE_INDICES_1B'><A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_1B' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4592'>
 <font color=#993300>subroutine </font><font color=#cc0000>find_lookupTable_indices_1b</font>(dumj,dum3,rcollsize,qr,nr) <A href='../../call_to/FIND_LOOKUPTABLE_INDICES_1B.html' TARGET='index'>1</A><a name='4593'>
<a name='4594'>
 <font color=#447700>!------------------------------------------------------------------------------------------!<a name='4595'></font>
 <font color=#447700>! Finds indices in 3D rain lookup table<a name='4596'></font>
 <font color=#447700>!------------------------------------------------------------------------------------------!<a name='4597'></font>
<a name='4598'>
 implicit none<a name='4599'>
<a name='4600'>
<font color=#447700>! arguments:<a name='4601'></font>
 integer, intent(out) :: dumj<a name='4602'>
 real,    intent(out) :: dum3<a name='4603'>
 integer, intent(in)  :: rcollsize<a name='4604'>
 real,    intent(in)  :: qr,nr<a name='4605'>
<a name='4606'>
<font color=#447700>! local variables:<a name='4607'></font>
 real                 :: dumlr<a name='4608'>
<a name='4609'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4610'></font>
<a name='4611'>
           <font color=#447700>! find index for scaled mean rain size<a name='4612'></font>
           <font color=#447700>! if no rain, then just choose dumj = 1 and do not calculate rain-ice collection processes<a name='4613'></font>
             if (qr.ge.qsmall .and. nr.gt.0.) then<a name='4614'>
              <font color=#447700>! calculate scaled mean size for consistency with ice lookup table<a name='4615'></font>
                dumlr = (qr/(pi*rhow*nr))**thrd<a name='4616'>
                dum3  = (alog10(1.*dumlr)+5.)*10.70415<a name='4617'>
                dumj  = int(dum3)<a name='4618'>
              <font color=#447700>! set limits<a name='4619'></font>
                dum3  = min(dum3,real_rcollsize)<a name='4620'>
                dum3  = max(dum3,1.)<a name='4621'>
                dumj  = max(1,dumj)<a name='4622'>
                dumj  = min(rcollsize-1,dumj)<a name='4623'>
             else<a name='4624'>
                dumj  = 1<a name='4625'>
                dum3  = 1.<a name='4626'>
             endif<a name='4627'>
<a name='4628'>
 end subroutine find_lookupTable_indices_1b<a name='4629'>
<a name='4630'>
<a name='4631'>
<font color=#447700>!======================================================================================!<a name='4632'></font>
<A NAME='FIND_LOOKUPTABLE_INDICES_2'><A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4633'>
 <font color=#993300>subroutine </font><font color=#cc0000>find_lookupTable_indices_2</font>(dumi,   dumii,   dumjj,  dumic, dumiic, dumjjc,  &amp; <A href='../../call_to/FIND_LOOKUPTABLE_INDICES_2.html' TARGET='index'>2</A><a name='4634'>
                                       dum1,   dum4,    dum5,   dum1c, dum4c,  dum5c,   &amp;<a name='4635'>
                                       iisize, rimsize, densize,                        &amp;<a name='4636'>
                                       qitot_1, qitot_2, nitot_1, nitot_2,                      &amp;<a name='4637'>
                                       qirim_1, qirim_2, birim_1, birim_2)<a name='4638'>
<a name='4639'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4640'></font>
<font color=#447700>! Finds indices in ice-ice interaction lookup table (2)<a name='4641'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4642'></font>
<a name='4643'>
 implicit none<a name='4644'>
<a name='4645'>
<font color=#447700>! arguments:<a name='4646'></font>
 integer, intent(out) :: dumi,   dumii,   dumjj,  dumic, dumiic, dumjjc<a name='4647'>
 real,    intent(out) :: dum1,   dum4,    dum5,   dum1c, dum4c,  dum5c<a name='4648'>
 integer, intent(in)  :: iisize, rimsize, densize<a name='4649'>
 real,    intent(in)  :: qitot_1,qitot_2,nitot_1,nitot_2,qirim_1,qirim_2,birim_1,birim_2<a name='4650'>
<a name='4651'>
<font color=#447700>! local variables:<a name='4652'></font>
 real                 :: drhop<a name='4653'>
<a name='4654'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4655'></font>
<a name='4656'>
                    <font color=#447700>! find index in lookup table for collector category<a name='4657'></font>
<a name='4658'>
                    <font color=#447700>! find index for qi (total ice mass mixing ratio)<a name='4659'></font>
<font color=#447700>! replace with new inversion for new lookup table 2 w/ reduced dimensionality<a name='4660'></font>
                      dum1 = (alog10(qitot_1/nitot_1)+18.)/(0.2*alog10(261.7))-5.<a name='4661'>
                      dumi = int(dum1)<a name='4662'>
                      dum1 = min(dum1,real(iisize))<a name='4663'>
                      dum1 = max(dum1,1.)<a name='4664'>
                      dumi = max(1,dumi)<a name='4665'>
                      dumi = min(iisize-1,dumi)<a name='4666'>
<a name='4667'>
   <font color=#447700>! note that the code below for finding rime mass fraction and density index is<a name='4668'></font>
   <font color=#447700>! redundant with code for main ice lookup table and can probably be omitted<a name='4669'></font>
   <font color=#447700>! for efficiency; for now it is left in<a name='4670'></font>
<a name='4671'>
                    <font color=#447700>! find index for rime mass fraction<a name='4672'></font>
                      dum4  = qirim_1/qitot_1*3. + 1.<a name='4673'>
                      dumii = int(dum4)<a name='4674'>
                      dum4  = min(dum4,real(rimsize))<a name='4675'>
                      dum4  = max(dum4,1.)<a name='4676'>
                      dumii = max(1,dumii)<a name='4677'>
                      dumii = min(rimsize-1,dumii)<a name='4678'>
<a name='4679'>
<a name='4680'>
                    <font color=#447700>! find index for bulk rime density<a name='4681'></font>
                    <font color=#447700>! (account for uneven spacing in lookup table for density)<a name='4682'></font>
                    <font color=#447700>! bulk rime density<a name='4683'></font>
                      if (birim_1.ge.bsmall) then<a name='4684'>
                         drhop = qirim_1/birim_1<a name='4685'>
                      else<a name='4686'>
                         drhop = 0.<a name='4687'>
                      endif<a name='4688'>
<a name='4689'>
                      if (drhop.le.650.) then<a name='4690'>
                         dum5 = (drhop-50.)*0.005 + 1.<a name='4691'>
                      else<a name='4692'>
                         dum5 =(drhop-650.)*0.004 + 4.<a name='4693'>
                      endif<a name='4694'>
                      dumjj = int(dum5)<a name='4695'>
                      dum5  = min(dum5,real(densize))<a name='4696'>
                      dum5  = max(dum5,1.)<a name='4697'>
                      dumjj = max(1,dumjj)<a name='4698'>
                      dumjj = min(densize-1,dumjj)<a name='4699'>
<a name='4700'>
<a name='4701'>
                    <font color=#447700>! find index in lookup table for collectee category, here 'q' is a scaled q/N<a name='4702'></font>
                    <font color=#447700>! find index for qi (total ice mass mixing ratio)<a name='4703'></font>
<font color=#447700>!                      dum1c = (alog10(qitot_2/nitot_2)+16.)   ! TO BE REMOVED<a name='4704'></font>
      		      dum1c = (alog10(qitot_2/nitot_2)+18.)/(0.2*alog10(261.7))-5.<a name='4705'>
                      dumic = int(dum1c)<a name='4706'>
                      dum1c = min(dum1c,real(iisize))<a name='4707'>
                      dum1c = max(dum1c,1.)<a name='4708'>
                      dumic = max(1,dumic)<a name='4709'>
                      dumic = min(iisize-1,dumic)<a name='4710'>
<a name='4711'>
<a name='4712'>
                    <font color=#447700>! find index for rime mass fraction<a name='4713'></font>
                      dum4c  = qirim_2/qitot_2*3. + 1.<a name='4714'>
                      dumiic = int(dum4c)<a name='4715'>
                      dum4c  = min(dum4c,real(rimsize))<a name='4716'>
                      dum4c  = max(dum4c,1.)<a name='4717'>
                      dumiic = max(1,dumiic)<a name='4718'>
                      dumiic = min(rimsize-1,dumiic)<a name='4719'>
                    <font color=#447700>! calculate predicted bulk rime density<a name='4720'></font>
                      if (birim_2.ge.1.e-15) then            <font color=#447700>!*** NOTE:  change to 'bsmall'<a name='4721'></font>
                         drhop = qirim_2/birim_2<a name='4722'>
                      else<a name='4723'>
                         drhop = 0.<a name='4724'>
                      endif<a name='4725'>
<a name='4726'>
                    <font color=#447700>! find index for bulk rime density<a name='4727'></font>
                    <font color=#447700>! (account for uneven spacing in lookup table for density)<a name='4728'></font>
                      if (drhop.le.650.) then<a name='4729'>
                         dum5c = (drhop-50.)*0.005 + 1.<a name='4730'>
                      else<a name='4731'>
                         dum5c =(drhop-650.)*0.004 + 4.<a name='4732'>
                      endif<a name='4733'>
                      dumjjc = int(dum5c)<a name='4734'>
                      dum5c  = min(dum5c,real(densize))<a name='4735'>
                      dum5c  = max(dum5c,1.)<a name='4736'>
                      dumjjc = max(1,dumjjc)<a name='4737'>
                      dumjjc = min(densize-1,dumjjc)<a name='4738'>
<a name='4739'>
 end subroutine find_lookupTable_indices_2<a name='4740'>
<a name='4741'>
<a name='4742'>
<font color=#447700>!======================================================================================!<a name='4743'></font>
<A NAME='FIND_LOOKUPTABLE_INDICES_3'><A href='../../html_code/phys/module_mp_p3.F.html#FIND_LOOKUPTABLE_INDICES_3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4744'>
 <font color=#993300>subroutine </font><font color=#cc0000>find_lookupTable_indices_3</font>(dumii,dumjj,dum1,rdumii,rdumjj,inv_dum3,mu_r,lamr) <A href='../../call_to/FIND_LOOKUPTABLE_INDICES_3.html' TARGET='index'>2</A><a name='4745'>
<a name='4746'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4747'></font>
<font color=#447700>! Finds indices in rain lookup table (3)<a name='4748'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4749'></font>
<a name='4750'>
 implicit none<a name='4751'>
<a name='4752'>
<font color=#447700>! arguments:<a name='4753'></font>
 integer, intent(out) :: dumii,dumjj<a name='4754'>
 real,    intent(out) :: dum1,rdumii,rdumjj,inv_dum3<a name='4755'>
 real,    intent(in)  :: mu_r,lamr<a name='4756'>
<a name='4757'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='4758'></font>
<a name='4759'>
        <font color=#447700>! find location in scaled mean size space<a name='4760'></font>
          dum1 = (mu_r+1.)/lamr<a name='4761'>
          if (dum1.le.195.e-6) then<a name='4762'>
             inv_dum3  = 0.1<a name='4763'>
             rdumii = (dum1*1.e6+5.)*inv_dum3<a name='4764'>
             rdumii = max(rdumii, 1.)<a name='4765'>
             rdumii = min(rdumii,20.)<a name='4766'>
             dumii  = int(rdumii)<a name='4767'>
             dumii  = max(dumii, 1)<a name='4768'>
             dumii  = min(dumii,20)<a name='4769'>
          elseif (dum1.gt.195.e-6) then<a name='4770'>
             inv_dum3  = thrd*0.1            <font color=#447700>!i.e. 1/30<a name='4771'></font>
             rdumii = (dum1*1.e+6-195.)*inv_dum3 + 20.<a name='4772'>
             rdumii = max(rdumii, 20.)<a name='4773'>
             rdumii = min(rdumii,300.)<a name='4774'>
             dumii  = int(rdumii)<a name='4775'>
             dumii  = max(dumii, 20)<a name='4776'>
             dumii  = min(dumii,299)<a name='4777'>
          endif<a name='4778'>
<a name='4779'>
        <font color=#447700>! find location in mu_r space<a name='4780'></font>
          rdumjj = mu_r+1.<a name='4781'>
          rdumjj = max(rdumjj,1.)<a name='4782'>
          rdumjj = min(rdumjj,10.)<a name='4783'>
          dumjj  = int(rdumjj)<a name='4784'>
          dumjj  = max(dumjj,1)<a name='4785'>
          dumjj  = min(dumjj,9)<a name='4786'>
<a name='4787'>
 end subroutine find_lookupTable_indices_3<a name='4788'>
<a name='4789'>
<a name='4790'>
<font color=#447700>!===========================================================================================<a name='4791'></font>
<A NAME='GET_CLOUD_DSD'><A href='../../html_code/phys/module_mp_p3.F.html#GET_CLOUD_DSD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4792'>
 <font color=#993300>subroutine </font><font color=#cc0000>get_cloud_dsd</font>(qc,nc,mu_c,rho,nu,dnu,lamc,lammin,lammax,k,cdist, &amp; <A href='../../call_to/GET_CLOUD_DSD.html' TARGET='index'>3</A><a name='4793'>
                          cdist1,qcindex,log_qcpresent)<a name='4794'>
<a name='4795'>
 implicit none<a name='4796'>
<a name='4797'>
<font color=#447700>!arguments:<a name='4798'></font>
 real, dimension(:), intent(in)  :: dnu<a name='4799'>
 real,     intent(in)            :: qc,rho<a name='4800'>
 real,     intent(inout)         :: nc<a name='4801'>
 real,     intent(out)           :: mu_c,nu,lamc,cdist,cdist1<a name='4802'>
 integer,  intent(in)            :: k<a name='4803'>
 integer, intent(out)            :: qcindex<a name='4804'>
 logical, intent(inout)          :: log_qcpresent<a name='4805'>
<a name='4806'>
<font color=#447700>!local variables<a name='4807'></font>
 real                            :: lammin,lammax<a name='4808'>
 integer                         :: dumi<a name='4809'>
<a name='4810'>
<font color=#447700>!--------------------------------------------------------------------------<a name='4811'></font>
<a name='4812'>
       if (qc.ge.qsmall) then<a name='4813'>
<a name='4814'>
        <font color=#447700>! set minimum nc to prevent floating point error<a name='4815'></font>
          nc   = max(nc,nsmall)<a name='4816'>
          mu_c = 0.0005714*(nc*1.e-6*rho)+0.2714<a name='4817'>
          mu_c = 1./(mu_c**2)-1.<a name='4818'>
          mu_c = max(mu_c,2.)<a name='4819'>
          mu_c = min(mu_c,15.)<a name='4820'>
<a name='4821'>
        <font color=#447700>! interpolate for mass distribution spectral shape parameter (for SB warm processes)<a name='4822'></font>
          if (iparam.eq.1) then<a name='4823'>
             dumi = int(mu_c)<a name='4824'>
             nu   = dnu(dumi)+(dnu(dumi+1)-dnu(dumi))*(mu_c-dumi)<a name='4825'>
          endif<a name='4826'>
<a name='4827'>
        <font color=#447700>! calculate lamc<a name='4828'></font>
          lamc = (cons1*nc*(mu_c+3.)*(mu_c+2.)*(mu_c+1.)/qc)**thrd<a name='4829'>
<a name='4830'>
        <font color=#447700>! apply lambda limiters<a name='4831'></font>
          lammin = (mu_c+1.)*2.5e+4   <font color=#447700>! min: 40 micron mean diameter<a name='4832'></font>
          lammax = (mu_c+1.)*1.e+6    <font color=#447700>! max:  1 micron mean diameter<a name='4833'></font>
<a name='4834'>
          if (lamc.lt.lammin) then<a name='4835'>
             lamc = lammin<a name='4836'>
             nc   = 6.*lamc**3*qc/(pi*rhow*(mu_c+3.)*(mu_c+2.)*(mu_c+1.))<a name='4837'>
          elseif (lamc.gt.lammax) then<a name='4838'>
             lamc = lammax<a name='4839'>
             nc   = 6.*lamc**3*qc/(pi*rhow*(mu_c+3.)*(mu_c+2.)*(mu_c+1.))<a name='4840'>
             if (.not. log_qcpresent) then<a name='4841'>
                qcindex = k<a name='4842'>
             endif<a name='4843'>
             log_qcpresent = .true.<a name='4844'>
<a name='4845'>
          endif<a name='4846'>
<a name='4847'>
          cdist  = nc*(mu_c+1.)/lamc<a name='4848'>
          cdist1 = nc/gamma(mu_c+1.)<a name='4849'>
<a name='4850'>
       else<a name='4851'>
<a name='4852'>
          lamc   = 0.<a name='4853'>
          cdist  = 0.<a name='4854'>
          cdist1 = 0.<a name='4855'>
<a name='4856'>
       endif<a name='4857'>
<a name='4858'>
 end subroutine get_cloud_dsd<a name='4859'>
<a name='4860'>
<a name='4861'>
<font color=#447700>!===========================================================================================<a name='4862'></font>
<A NAME='GET_RAIN_DSD'><A href='../../html_code/phys/module_mp_p3.F.html#GET_RAIN_DSD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4863'>
 <font color=#993300>subroutine </font><font color=#cc0000>get_rain_dsd</font>(qr,nr,mu_r,rdumii,dumii,lamr,mu_r_table,cdistr,logn0r, &amp; <A href='../../call_to/GET_RAIN_DSD.html' TARGET='index'>3</A><a name='4864'>
                         log_qrpresent,qrindex,k)<a name='4865'>
<a name='4866'>
<font color=#447700>! Computes and returns rain size distribution parameters<a name='4867'></font>
<a name='4868'>
 implicit none<a name='4869'>
<a name='4870'>
<font color=#447700>!arguments:<a name='4871'></font>
 real, dimension(:), intent(in)  :: mu_r_table<a name='4872'>
 real,     intent(in)            :: qr<a name='4873'>
 real,     intent(inout)         :: nr<a name='4874'>
 real,     intent(out)           :: rdumii,lamr,mu_r,cdistr,logn0r<a name='4875'>
 integer,  intent(in)            :: k<a name='4876'>
 integer,  intent(out)           :: dumii,qrindex<a name='4877'>
 logical,  intent(inout)         :: log_qrpresent<a name='4878'>
<a name='4879'>
<font color=#447700>!local variables:<a name='4880'></font>
 real                            :: inv_dum,lammax,lammin<a name='4881'>
<a name='4882'>
<font color=#447700>!--------------------------------------------------------------------------<a name='4883'></font>
<a name='4884'>
       if (qr.ge.qsmall) then<a name='4885'>
<a name='4886'>
       <font color=#447700>! use lookup table to get mu<a name='4887'></font>
       <font color=#447700>! mu-lambda relationship is from Cao et al. (2008), eq. (7)<a name='4888'></font>
<a name='4889'>
       <font color=#447700>! find spot in lookup table<a name='4890'></font>
       <font color=#447700>! (scaled N/q for lookup table parameter space_<a name='4891'></font>
          nr      = max(nr,nsmall)<a name='4892'>
          inv_dum = (qr/(cons1*nr*6.))**thrd<a name='4893'>
<a name='4894'>
          if (inv_dum.lt.282.e-6) then<a name='4895'>
             mu_r = 8.282<a name='4896'>
          elseif (inv_dum.ge.282.e-6 .and. inv_dum.lt.502.e-6) then<a name='4897'>
           <font color=#447700>! interpolate<a name='4898'></font>
             rdumii   = (inv_dum-250.e-6)*1.e+6*0.5<a name='4899'>
             rdumii   = max(rdumii,1.)<a name='4900'>
             rdumii   = min(rdumii,150.)<a name='4901'>
             dumii    = int(rdumii)<a name='4902'>
             dumii    = min(149,dumii)<a name='4903'>
             mu_r     = mu_r_table(dumii)+(mu_r_table(dumii+1)-mu_r_table(dumii))*(rdumii-  &amp;<a name='4904'>
                        real(dumii))<a name='4905'>
          elseif (inv_dum.ge.502.e-6) then<a name='4906'>
             mu_r = 0.<a name='4907'>
          endif<a name='4908'>
<a name='4909'>
          lamr = (cons1*nr*(mu_r+3.)*(mu_r+2)*(mu_r+1.)/(qr))**thrd  <font color=#447700>! recalculate slope based on mu_r<a name='4910'></font>
          lammax = (mu_r+1.)*1.e+5   <font color=#447700>! check for slope<a name='4911'></font>
          lammin = (mu_r+1.)*1250.   <font color=#447700>! set to small value since breakup is explicitly included (mean size 0.8 mm)<a name='4912'></font>
<a name='4913'>
        <font color=#447700>! apply lambda limiters for rain<a name='4914'></font>
          if (lamr.lt.lammin) then<a name='4915'>
             lamr = lammin<a name='4916'>
             nr   = exp(3.*log(lamr)+log(qr)+log(gamma(mu_r+1.))-log(gamma(mu_r+4.)))/(cons1)<a name='4917'>
          elseif (lamr.gt.lammax) then<a name='4918'>
             lamr = lammax<a name='4919'>
             nr   = exp(3.*log(lamr)+log(qr)+log(gamma(mu_r+1.))-log(gamma(mu_r+4.)))/(cons1)<a name='4920'>
          endif<a name='4921'>
<a name='4922'>
          if (.not. log_qrpresent) then<a name='4923'>
             qrindex = k<a name='4924'>
          endif<a name='4925'>
          log_qrpresent = .true.<a name='4926'>
<a name='4927'>
          cdistr = nr/gamma(mu_r+1.)<a name='4928'>
          logn0r    = alog10(nr)+(mu_r+1.)*alog10(lamr)-alog10(gamma(mu_r+1)) <font color=#447700>!note: logn0r is calculated as log10(n0r)<a name='4929'></font>
<a name='4930'>
       else<a name='4931'>
<a name='4932'>
          lamr = 0.<a name='4933'>
          cdistr = 0.<a name='4934'>
          logn0r = 0.<a name='4935'>
<a name='4936'>
       endif<a name='4937'>
<a name='4938'>
<a name='4939'>
 end subroutine get_rain_dsd<a name='4940'>
<a name='4941'>
<a name='4942'>
<font color=#447700>!===========================================================================================<a name='4943'></font>
<A NAME='CALC_BULKRHORIME'><A href='../../html_code/phys/module_mp_p3.F.html#CALC_BULKRHORIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4944'>
 <font color=#993300>subroutine </font><font color=#cc0000>calc_bulkRhoRime</font>(qi_tot,qi_rim,bi_rim,rho_rime) <A href='../../call_to/CALC_BULKRHORIME.html' TARGET='index'>4</A><a name='4945'>
<a name='4946'>
<font color=#447700>!--------------------------------------------------------------------------------<a name='4947'></font>
<font color=#447700>!  Calculates and returns the bulk rime density from the prognostic ice variables<a name='4948'></font>
<font color=#447700>!  and adjusts qirim and birim appropriately.<a name='4949'></font>
<font color=#447700>!--------------------------------------------------------------------------------<a name='4950'></font>
<a name='4951'>
 implicit none<a name='4952'>
<a name='4953'>
<font color=#447700>!arguments:<a name='4954'></font>
 real, intent(in)    :: qi_tot<a name='4955'>
 real, intent(inout) :: qi_rim,bi_rim<a name='4956'>
 real, intent(out)   :: rho_rime<a name='4957'>
<a name='4958'>
 <font color=#447700>!--------------------------------------------------------------------------<a name='4959'></font>
<a name='4960'>
 if (bi_rim.ge.1.e-15) then<a name='4961'>
<font color=#447700>!if (bi_rim.ge.bsmall) then<a name='4962'></font>
    rho_rime = qi_rim/bi_rim<a name='4963'>
    <font color=#447700>!impose limits on rho_rime;  adjust bi_rim if needed<a name='4964'></font>
    if (rho_rime.lt.rho_rimeMin) then<a name='4965'>
       rho_rime = rho_rimeMin<a name='4966'>
       bi_rim   = qi_rim/rho_rime<a name='4967'>
    elseif (rho_rime.gt.rho_rimeMax) then<a name='4968'>
       rho_rime = rho_rimeMax<a name='4969'>
       bi_rim   = qi_rim/rho_rime<a name='4970'>
    endif<a name='4971'>
 else<a name='4972'>
    qi_rim   = 0.<a name='4973'>
    bi_rim   = 0.<a name='4974'>
    rho_rime = 0.<a name='4975'>
 endif<a name='4976'>
<a name='4977'>
 <font color=#447700>!set upper constraint qi_rim &lt;= qi_tot<a name='4978'></font>
 if (qi_rim.gt.qi_tot .and. rho_rime.gt.0.) then<a name='4979'>
    qi_rim = qi_tot<a name='4980'>
    bi_rim = qi_rim/rho_rime<a name='4981'>
 endif<a name='4982'>
<a name='4983'>
 <font color=#447700>!impose consistency<a name='4984'></font>
 if (qi_rim.lt.qsmall) then<a name='4985'>
    qi_rim = 0.<a name='4986'>
    bi_rim = 0.<a name='4987'>
 endif<a name='4988'>
<a name='4989'>
<a name='4990'>
 end subroutine calc_bulkRhoRime<a name='4991'>
<a name='4992'>
<a name='4993'>
<font color=#447700>!===========================================================================================<a name='4994'></font>
<A NAME='IMPOSE_MAX_TOTAL_NI'><A href='../../html_code/phys/module_mp_p3.F.html#IMPOSE_MAX_TOTAL_NI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4995'>
 <font color=#993300>subroutine </font><font color=#cc0000>impose_max_total_Ni</font>(nitot_local,max_total_Ni,inv_rho_local) <A href='../../call_to/IMPOSE_MAX_TOTAL_NI.html' TARGET='index'>3</A><a name='4996'>
<a name='4997'>
<font color=#447700>!--------------------------------------------------------------------------------<a name='4998'></font>
<font color=#447700>! Impose maximum total ice number concentration (total of all ice categories).<a name='4999'></font>
<font color=#447700>! If the sum of all nitot(:) exceeds maximum allowable, each category to preserve<a name='5000'></font>
<font color=#447700>! ratio of number between categories.<a name='5001'></font>
<font color=#447700>!--------------------------------------------------------------------------------<a name='5002'></font>
<a name='5003'>
 implicit none<a name='5004'>
<a name='5005'>
<font color=#447700>!arguments:<a name='5006'></font>
 real, intent(inout), dimension(:) :: nitot_local           <font color=#447700>!note: dimension (nCat)<a name='5007'></font>
 real, intent(in)                  :: max_total_Ni,inv_rho_local<a name='5008'>
<a name='5009'>
<font color=#447700>!local variables:<a name='5010'></font>
 real                              :: dum<a name='5011'>
<a name='5012'>
 if (sum(nitot_local(:)).ge.1.e-20) then<a name='5013'>
    dum = max_total_Ni*inv_rho_local/sum(nitot_local(:))<a name='5014'>
    nitot_local(:) = nitot_local(:)*min(dum,1.)<a name='5015'>
 endif<a name='5016'>
<a name='5017'>
 end subroutine impose_max_total_Ni<a name='5018'>
<a name='5019'>
<a name='5020'>
<font color=#447700>!===========================================================================================<a name='5021'></font>
<a name='5022'>
<A NAME='QV_SAT'><A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='5023'>
 real <font color=#993300>function </font><font color=#cc0000>qv_sat</font>(t_atm,p_atm,i_wrt) <A href='../../call_to/QV_SAT.html' TARGET='index'>9</A>,<A href='../../call_from/QV_SAT.html' TARGET='index'>1</A><a name='5024'>
<a name='5025'>
<font color=#447700>!------------------------------------------------------------------------------------<a name='5026'></font>
<font color=#447700>! Calls polysvp1 to obtain the saturation vapor pressure, and then computes<a name='5027'></font>
<font color=#447700>! and returns the saturation mixing ratio, with respect to either liquid or ice,<a name='5028'></font>
<font color=#447700>! depending on value of 'i_wrt'<a name='5029'></font>
<font color=#447700>!------------------------------------------------------------------------------------<a name='5030'></font>
<a name='5031'>
 implicit none<a name='5032'>
<a name='5033'>
 <font color=#447700>!Calling parameters:<a name='5034'></font>
 real    :: t_atm  <font color=#447700>!temperature [K]<a name='5035'></font>
 real    :: p_atm  <font color=#447700>!pressure    [Pa]<a name='5036'></font>
 integer :: i_wrt  <font color=#447700>!index, 0 = w.r.t. liquid, 1 = w.r.t. ice<a name='5037'></font>
<a name='5038'>
 <font color=#447700>!Local variables:<a name='5039'></font>
 real            :: e_pres         <font color=#447700>!saturation vapor pressure [Pa]<a name='5040'></font>
<a name='5041'>
 <font color=#447700>!------------------<a name='5042'></font>
<a name='5043'>
 e_pres = <A href='../../html_code/phys/module_mp_p3.F.html#POLYSVP1'>polysvp1</A><A href='../../html_code/phys/module_mp_p3.F.html#QV_SAT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP1_2">(t_atm,i_wrt)<a name='5044'>
 qv_sat = ep_2*e_pres/max(1.e-3,(p_atm-e_pres))<a name='5045'>
<a name='5046'>
 return<a name='5047'>
 end function qv_sat<a name='5048'>
<a name='5049'>
<font color=#447700>!===========================================================================================<a name='5050'></font>
<a name='5051'>
<A NAME='CHECK_VALUES'><A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5052'>
 <font color=#993300>subroutine </font><font color=#cc0000>check_values</font>(Qv,T,Qc,Qr,Nr,Qitot,Qirim,Nitot,Birim,i,timestepcount,          &amp; <A href='../../call_to/CHECK_VALUES.html' TARGET='index'>17</A><a name='5053'>
                         check_consistency,force_abort,source_ind)<a name='5054'>
<a name='5055'>
<font color=#447700>!------------------------------------------------------------------------------------<a name='5056'></font>
<font color=#447700>! Checks current values of prognotic variables for reasonable values and<a name='5057'></font>
<font color=#447700>! stops and prints values if they are out of specified allowable ranges.<a name='5058'></font>
<font color=#447700>!<a name='5059'></font>
<font color=#447700>! 'check_consistency' means include trap for inconsistency in moments;<a name='5060'></font>
<font color=#447700>! otherwise, only trap for Q, T, and negative Qx, etc.  This option is here<a name='5061'></font>
<font color=#447700>! to allow for Q&lt;qsmall.and.N&gt;nsmall or Q&gt;qsmall.and.N&lt;small which can be produced<a name='5062'></font>
<font color=#447700>! at the leading edges due to sedimentation and whose values are accpetable<a name='5063'></font>
<font color=#447700>! since lambda limiters are later imposed after SEDI (so one does not necessarily<a name='5064'></font>
<font color=#447700>! want to trap for inconsistency after sedimentation has been called).<a name='5065'></font>
<font color=#447700>!<a name='5066'></font>
<font color=#447700>! The value 'source_ind' indicates the approximate location in 'p3_main'<a name='5067'></font>
<font color=#447700>! from where 'check_values' was called before it resulted in a trap.<a name='5068'></font>
<font color=#447700>!<a name='5069'></font>
<font color=#447700>!------------------------------------------------------------------------------------<a name='5070'></font>
<a name='5071'>
  implicit none<a name='5072'>
<a name='5073'>
 <font color=#447700>!Calling parameters:<a name='5074'></font>
  real, dimension(:,:),   intent(in) :: Qv,T,Qc,Qr,Nr <font color=#447700>!,Nc<a name='5075'></font>
  real, dimension(:,:,:), intent(in) :: Qitot,Qirim,Nitot,Birim<a name='5076'>
  integer,                intent(in) :: source_ind,i,timestepcount<a name='5077'>
  logical,                intent(in) :: force_abort         <font color=#447700>!.TRUE. = forces abort if value violation is detected<a name='5078'></font>
  logical,                intent(in) :: check_consistency   <font color=#447700>!.TRUE. = check for sign consistency between Qx and Nx<a name='5079'></font>
<a name='5080'>
 <font color=#447700>!Local variables:<a name='5081'></font>
  real, parameter :: T_low  = 173.<a name='5082'>
  real, parameter :: T_high = 323.<a name='5083'>
  real, parameter :: Q_high = 40.e-3<a name='5084'>
  real, parameter :: N_high = 1.e+20<a name='5085'>
  real, parameter :: B_high = Q_high*1.e-3<a name='5086'>
  real, parameter :: x_high = 1.e+30<a name='5087'>
  real, parameter :: x_low  = 0.<a name='5088'>
  integer         :: k,iice,ni,nk,ncat<a name='5089'>
  logical         :: trap,badvalue_found<a name='5090'>
<a name='5091'>
  nk   = size(Qitot,dim=2)<a name='5092'>
  ncat = size(Qitot,dim=3)<a name='5093'>
<a name='5094'>
  trap = .false.<a name='5095'>
<a name='5096'>
  k_loop: do k = 1,nk<a name='5097'>
<a name='5098'>
      <font color=#447700>! check unrealistic values or NANs for T and Qv<a name='5099'></font>
        if (.not.(T(i,k)&gt;T_low .and. T(i,k)&lt;T_high)) then<a name='5100'>
           write(6,'(a41,4i5,1e15.6)') '** WARNING IN P3_MAIN -- src,i,k,step,T: ',      &amp;<a name='5101'>
              source_ind,i,k,timestepcount,T(i,k)<a name='5102'>
           trap = .true.<a name='5103'>
        endif<a name='5104'>
        if (.not.(Qv(i,k)&gt;=0. .and. Qv(i,k)&lt;Q_high)) then<a name='5105'>
           write(6,'(a42,4i5,1e15.6)') '** WARNING IN P3_MAIN -- src,i,k,step,Qv: ',     &amp;<a name='5106'>
              source_ind,i,k,timestepcount,Qv(i,k)<a name='5107'>
<a name='5108'>
          <font color=#447700>!trap = .true.  !note, tentatively no trap, since Qv could be negative passed in to mp<a name='5109'></font>
        endif<a name='5110'>
<a name='5111'>
      <font color=#447700>! check NANs for mp variables:<a name='5112'></font>
         badvalue_found = .false.<a name='5113'>
<font color=#447700>!         if (.not.(Qc(i,k) &gt;= x_low .and. Qc(i,k) &lt; Q_high .and.                          &amp;<a name='5114'></font>
<font color=#447700>! !                 Nc(i,k) &gt;= x_low .and. QN(i,k) &lt; Q_high .and.                          &amp;  ! (for prog Nc)<a name='5115'></font>
<font color=#447700>!                   Qr(i,k) &gt;= x_low .and. Qr(i,k) &lt; Q_high .and.                          &amp;<a name='5116'></font>
<font color=#447700>!                   Nr(i,k) &gt;= x_lOw .and. Nr(i,k) &lt; N_high)) then<a name='5117'></font>
<font color=#447700>!            write(6,'(a48,4i5,4e15.6)') '** WARNING IN P3_MAIN -- src,i,k,step,Qc,Qr,Nr: ', &amp;<a name='5118'></font>
<font color=#447700>!               source_ind,i,k,timestepcount,Qc(i,k),Qr(i,k),Nr(i,k)<a name='5119'></font>
<font color=#447700>!            badvalue_found = .true.<a name='5120'></font>
<font color=#447700>!         endif<a name='5121'></font>
<font color=#447700>!        do iice = 1,ncat<a name='5122'></font>
<font color=#447700>!-- for strict testing:<a name='5123'></font>
<font color=#447700>!            if (.not.(Qitot(i,k,iice) &gt;= x_low .and. Qitot(i,k,iice) &lt; Q_high .and.       &amp;<a name='5124'></font>
<font color=#447700>!                      Qirim(i,k,iice) &gt;= x_low .and. Qirim(i,k,iice) &lt; Q_high .and.       &amp;<a name='5125'></font>
<font color=#447700>!                      Nitot(i,k,iice) &gt;= x_low .and. Nitot(i,k,iice) &lt; N_high .and.       &amp;<a name='5126'></font>
<font color=#447700>!                      Birim(i,k,iice) &gt;= x_low .and. Birim(i,k,iice) &lt; B_high)) then<a name='5127'></font>
<font color=#447700>!-- for "relaxed" testing (specifically, to avoid trapping understandable Qi-Ni values after microphysics source/sink section:<a name='5128'></font>
<font color=#447700>!            if (.not.(Qitot(i,k,iice) &gt;= x_low .and. Qitot(i,k,iice) &lt; Q_high .and.       &amp;<a name='5129'></font>
<font color=#447700>!                      Qirim(i,k,iice) &gt;= x_low .and. Qirim(i,k,iice) &lt; Q_high .and.       &amp;<a name='5130'></font>
<font color=#447700>!                      Nitot(i,k,iice) &gt;= x_low .and. Nitot(i,k,iice) &lt; N_high .and.       &amp;<a name='5131'></font>
<font color=#447700>!                      Birim(i,k,iice) &gt;= x_low .and. Birim(i,k,iice) &lt; B_high) .and.      &amp;<a name='5132'></font>
<font color=#447700>!                .not.(Qitot(i,k,iice)&lt;1.e-4 .and. Nitot(i,k,iice)&lt;0.)      ) then<a name='5133'></font>
<font color=#447700>! !==<a name='5134'></font>
<font color=#447700>!               write(6,'(a68,5i5,4e15.6)') '** WARNING IN P3_MAIN -- src,i,k,step,iice,Qitot,Qirim,Nitot,Birim: ',  &amp;<a name='5135'></font>
<font color=#447700>!                  source_ind,i,k,timestepcount,iice,Qitot(i,k,iice),Qirim(i,k,iice),Nitot(i,k,iice),Birim(i,k,iice)<a name='5136'></font>
<font color=#447700>!               badvalue_found = .true.<a name='5137'></font>
<font color=#447700>!            endif<a name='5138'></font>
<font color=#447700>!        enddo<a name='5139'></font>
<font color=#447700>!        if (badvalue_found) trap = .true.<a name='5140'></font>
<a name='5141'>
<a name='5142'>
      <font color=#447700>! check consistency amongst moments<a name='5143'></font>
<font color=#447700>! ! !       if (check_consistency) then<a name='5144'></font>
<font color=#447700>! !         if (.false.) then<a name='5145'></font>
<font color=#447700>! ! !-- future; prog Nc<a name='5146'></font>
<font color=#447700>! ! !          if ((Qc(i,k)&gt;qsmall.and.Nc(i,k)&lt;nsmall) .or. (Qc(i,k)&lt;qsmall.and.Nc(i,k)&gt;nsmall)) then<a name='5147'></font>
<font color=#447700>! ! !             print*,'** WARNING IN MICRO **'<a name='5148'></font>
<font color=#447700>! ! !             print*, '** src,i,k,Qc,Nc: ',source_ind,i,k,Qc(i,k),Nc(i,k)<a name='5149'></font>
<font color=#447700>! ! !             trap = .true.<a name='5150'></font>
<font color=#447700>! ! !           endif<a name='5151'></font>
<font color=#447700>! ! !==<a name='5152'></font>
<font color=#447700>! !            if ((Qr(i,k)&gt;qsmall.and.Nr(i,k)&lt;nsmall) .or. (Qr(i,k)&lt;qsmall.and.Nr(i,k)&gt;nsmall)) then<a name='5153'></font>
<font color=#447700>! !               print*,'** WARNING IN P3_MAIN **'<a name='5154'></font>
<font color=#447700>! !               print*, '** src,i,k,Qr,Nr: ',source_ind,i,k,Qr(i,k),Nr(i,k)<a name='5155'></font>
<font color=#447700>! !               trap = .true.<a name='5156'></font>
<font color=#447700>! !            endif<a name='5157'></font>
<font color=#447700>! !            do iice = 1,ncat<a name='5158'></font>
<font color=#447700>! !               if ( (Qitot(i,k,iice)&gt;qsmall.and.Nitot(i,k,iice)&lt;nsmall) .or.              &amp;<a name='5159'></font>
<font color=#447700>! !                    (Qitot(i,k,iice)&lt;qsmall.and.Nitot(i,k,iice)&gt;nsmall)) then<a name='5160'></font>
<font color=#447700>! !                  print*,'** WARNING IN P3_MAIN **'<a name='5161'></font>
<font color=#447700>! !                  print*, '** src,i,k,iice,Qitot,Nitot: ',source_ind,i,k,iice,            &amp;<a name='5162'></font>
<font color=#447700>! !                   Qitot(i,k,iice),Nitot(i,k,iice)<a name='5163'></font>
<font color=#447700>! !                  trap = .true.<a name='5164'></font>
<font color=#447700>! !               endif<a name='5165'></font>
<font color=#447700>! !               if ( (Qirim(i,k,iice)&gt;qsmall.and.Birim(i,k,iice)&lt;bsmall) .or.              &amp;<a name='5166'></font>
<font color=#447700>! !                    (Qirim(i,k,iice)&lt;qsmall.and.Birim(i,k,iice)&gt;bsmall)) then<a name='5167'></font>
<font color=#447700>! !                  print*, '** src,i,k,iice,Qirim,Birim: ',source_ind,i,k,iice,            &amp;<a name='5168'></font>
<font color=#447700>! !                   Qirim(i,k,iice),Birim(i,k,iice)<a name='5169'></font>
<font color=#447700>! !                  trap = .true.<a name='5170'></font>
<font color=#447700>! !               endif<a name='5171'></font>
<font color=#447700>! !            enddo<a name='5172'></font>
<font color=#447700>! !         endif !if (check_consistency)<a name='5173'></font>
<a name='5174'>
  enddo k_loop<a name='5175'>
<a name='5176'>
  if (trap .and. force_abort) then<a name='5177'>
     print*<a name='5178'>
     print*,'** DEBUG TRAP IN P3_MAIN, s/r CHECK_VALUES -- source: ',source_ind<a name='5179'>
     print*<a name='5180'>
     if (source_ind/=100) stop<a name='5181'>
  endif<a name='5182'>
<a name='5183'>
 end subroutine check_values<a name='5184'>
<font color=#447700>!===========================================================================================<a name='5185'></font>
<a name='5186'>
 END MODULE MODULE_MP_P3   <font color=#447700>!WRF<a name='5187'></font>
<font color=#447700>!END MODULE MP_P3          !GEM<a name='5188'></font>
</pre></body></html>