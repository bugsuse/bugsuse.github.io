<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_SF_GFS'><A href='../../html_code/phys/module_sf_gfs.F.html#MODULE_SF_GFS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_gfs</font> <A href='../../call_to/MODULE_SF_GFS.html' TARGET='index'>2</A><a name='5'>
<a name='6'>
<a name='7'>
CONTAINS<a name='8'>
<a name='9'>
<font color=#447700>!-------------------------------------------------------------------<a name='10'></font>
<A NAME='SF_GFS'><A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>SF_GFS</font>(U3D,V3D,T3D,QV3D,P3D,                              &amp; <A href='../../call_to/SF_GFS.html' TARGET='index'>3</A>,<A href='../../call_from/SF_GFS.html' TARGET='index'>5</A><a name='12'>
		 CP,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,             &amp;<a name='13'>
                     ZNT,UST,PSIM,PSIH,                                 &amp;<a name='14'>
		 XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,                    &amp;<a name='15'>
                     QGH,QSFC,U10,V10,                                  &amp;<a name='16'>
                     GZ1OZ0,WSPD,BR,ISFFLX,                             &amp;<a name='17'>
                     EP1,EP2,KARMAN,itimestep,                          &amp;<a name='18'>
                     ids,ide, jds,jde, kds,kde,                         &amp;<a name='19'>
                     ims,ime, jms,jme, kms,kme,                         &amp;<a name='20'>
                     its,ite, jts,jte, kts,kte                     )<a name='21'>
<font color=#447700>!-------------------------------------------------------------------<a name='22'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_32">, ONLY : kind_phys<a name='23'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_13"> , ONLY : gfuncphys,fpvs<a name='24'>
<font color=#447700>!-------------------------------------------------------------------<a name='25'></font>
      IMPLICIT NONE<a name='26'>
<font color=#447700>!-------------------------------------------------------------------<a name='27'></font>
<font color=#447700>!-- U3D    	3D u-velocity interpolated to theta points (m/s)<a name='28'></font>
<font color=#447700>!-- V3D    	3D v-velocity interpolated to theta points (m/s)<a name='29'></font>
<font color=#447700>!-- T3D     	temperature (K)<a name='30'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='31'></font>
<font color=#447700>!-- P3D         3D pressure (Pa)<a name='32'></font>
<font color=#447700>!-- CP		heat capacity at constant pressure for dry air (J/kg/K)<a name='33'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='34'></font>
<font color=#447700>!-- R           gas constant for dry air (J/kg/K)<a name='35'></font>
<font color=#447700>!-- XLV         latent heat of vaporization for water (J/kg)<a name='36'></font>
<font color=#447700>!-- PSFC	surface pressure (Pa)<a name='37'></font>
<font color=#447700>!-- ZNT		roughness length (m)<a name='38'></font>
<font color=#447700>!-- UST		u* in similarity theory (m/s)<a name='39'></font>
<font color=#447700>!-- PSIM        similarity stability function for momentum<a name='40'></font>
<font color=#447700>!-- PSIH        similarity stability function for heat<a name='41'></font>
<font color=#447700>!-- XLAND	land mask (1 for land, 2 for water)<a name='42'></font>
<font color=#447700>!-- HFX		upward heat flux at the surface (W/m^2)<a name='43'></font>
<font color=#447700>!-- QFX   	upward moisture flux at the surface (kg/m^2/s)<a name='44'></font>
<font color=#447700>!-- LH          net upward latent heat flux at surface (W/m^2)<a name='45'></font>
<font color=#447700>!-- TSK		surface temperature (K)<a name='46'></font>
<font color=#447700>!-- FLHC        exchange coefficient for heat (m/s)<a name='47'></font>
<font color=#447700>!-- FLQC        exchange coefficient for moisture (m/s)<a name='48'></font>
<font color=#447700>!-- QGH         lowest-level saturated mixing ratio<a name='49'></font>
<font color=#447700>!-- U10         diagnostic 10m u wind<a name='50'></font>
<font color=#447700>!-- V10         diagnostic 10m v wind<a name='51'></font>
<font color=#447700>!-- GZ1OZ0      log(z/z0) where z0 is roughness length<a name='52'></font>
<font color=#447700>!-- WSPD        wind speed at lowest model level (m/s)<a name='53'></font>
<font color=#447700>!-- BR          bulk Richardson number in surface layer<a name='54'></font>
<font color=#447700>!-- ISFFLX      isfflx=1 for surface heat and moisture fluxes<a name='55'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (R_v/R_d - 1) (dimensionless)<a name='56'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='57'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='58'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='59'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='60'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='61'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='62'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='63'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='64'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='65'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='66'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='67'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='68'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='69'></font>
<font color=#447700>!-- its         start index for i in tile<a name='70'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='71'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='72'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='73'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='74'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='75'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='76'></font>
<a name='77'>
      INTEGER, INTENT(IN) ::            ids,ide, jds,jde, kds,kde,      &amp;<a name='78'>
                                        ims,ime, jms,jme, kms,kme,      &amp;<a name='79'>
                                        its,ite, jts,jte, kts,kte,      &amp;<a name='80'>
                                        ISFFLX,itimestep<a name='81'>
<a name='82'>
      REAL,    INTENT(IN) ::                                            &amp;<a name='83'>
                                        CP,                             &amp;<a name='84'>
                                        EP1,                            &amp;<a name='85'>
                                        EP2,                            &amp;<a name='86'>
                                        KARMAN,                         &amp;<a name='87'>
                                        R,                              &amp;<a name='88'>
                                        ROVCP,                          &amp;<a name='89'>
                                        XLV<a name='90'>
<a name='91'>
      REAL,    DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) ::      &amp;<a name='92'>
                                        P3D,                            &amp;<a name='93'>
                                        QV3D,                           &amp;<a name='94'>
                                        T3D,                            &amp;<a name='95'>
                                        U3D,                            &amp;<a name='96'>
                                        V3D<a name='97'>
<a name='98'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(IN) ::               &amp;<a name='99'>
                                        TSK,                            &amp;<a name='100'>
                                        PSFC,                           &amp;<a name='101'>
                                        XLAND<a name='102'>
<a name='103'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(INOUT) ::            &amp;<a name='104'>
                                        UST,                            &amp;<a name='105'>
                                        ZNT<a name='106'>
<a name='107'>
      REAL, DIMENSION(ims:ime, jms:jme), INTENT(OUT) ::                 &amp;<a name='108'>
                                        BR,                             &amp;<a name='109'>
                                        CHS,                            &amp;<a name='110'>
                                        CHS2,                           &amp;<a name='111'>
                                        CPM,                            &amp;<a name='112'>
                                        CQS2,                           &amp;<a name='113'>
                                        FLHC,                           &amp;<a name='114'>
                                        FLQC,                           &amp;<a name='115'>
                                        GZ1OZ0,                         &amp;<a name='116'>
                                        HFX,                            &amp;<a name='117'>
                                        LH,                             &amp;<a name='118'>
                                        PSIM,                           &amp;<a name='119'>
                                        PSIH,                           &amp;<a name='120'>
                                        QFX,                            &amp;<a name='121'>
                                        QGH,                            &amp;<a name='122'>
                                        QSFC,                           &amp;<a name='123'>
                                        U10,                            &amp;<a name='124'>
                                        V10,                            &amp;<a name='125'>
                                        WSPD<a name='126'>
<a name='127'>
<a name='128'>
<font color=#447700>!--------------------------- LOCAL VARS ------------------------------<a name='129'></font>
<a name='130'>
      REAL ::                           ESAT<a name='131'>
<a name='132'>
      REAL     (kind=kind_phys) ::                                      &amp;<a name='133'>
                                        RHOX<a name='134'>
<a name='135'>
      REAL     (kind=kind_phys), DIMENSION(its:ite) ::                  &amp;<a name='136'>
                                        CH,                             &amp;<a name='137'>
                                        CM,                             &amp;<a name='138'>
                                        DDVEL,                          &amp;<a name='139'>
                                        DRAIN,                          &amp;<a name='140'>
                                        EP,                             &amp;<a name='141'>
                                        EVAP,                           &amp;<a name='142'>
                                        FH,                             &amp;<a name='143'>
                                        FH2,                            &amp;<a name='144'>
                                        FM,                             &amp;<a name='145'>
                                        HFLX,                           &amp;<a name='146'>
                                        PH,                             &amp;<a name='147'>
                                        PM,                             &amp;<a name='148'>
                                        PRSL1,                          &amp;<a name='149'>
                                        PRSLKI,                         &amp;<a name='150'>
                                        PS,                             &amp;<a name='151'>
                                        Q1,                             &amp;<a name='152'>
                                        Q2M,                            &amp;<a name='153'>
                                        QSS,                            &amp;<a name='154'>
                                        QSURF,                          &amp;<a name='155'>
                                        RB,                             &amp;<a name='156'>
                                        RCL,                            &amp;<a name='157'>
                                        RHO1,                           &amp;<a name='158'>
                                        SLIMSK,                         &amp;<a name='159'>
                                        STRESS,                         &amp;<a name='160'>
                                        T1,                             &amp;<a name='161'>
                                        T2M,                            &amp;<a name='162'>
                                        THGB,                           &amp;<a name='163'>
                                        THX,                            &amp;<a name='164'>
                                        TSKIN,                          &amp;<a name='165'>
                                        SHELEG,                         &amp;<a name='166'>
                                        U1,                             &amp;<a name='167'>
                                        U10M,                           &amp;<a name='168'>
                                        USTAR,                          &amp;<a name='169'>
                                        V1,                             &amp;<a name='170'>
                                        V10M,                           &amp;<a name='171'>
                                        WIND,                           &amp;<a name='172'>
                                        Z0RL,                           &amp;<a name='173'>
                                        Z1<a name='174'>
<a name='175'>
<a name='176'>
      INTEGER ::                                                        &amp;<a name='177'>
                                        I,                              &amp;<a name='178'>
                                        IM,                             &amp;<a name='179'>
                                        J,                              &amp;<a name='180'>
                                        K,                              &amp;<a name='181'>
                                        KM<a name='182'>
<a name='183'>
<a name='184'>
   if(itimestep.eq.0) then<a name='185'>
     CALL <A href='../../html_code/phys/module_gfs_funcphys.F.html#GFUNCPHYS'>GFUNCPHYS</A><A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GFUNCPHYS_46"><a name='186'>
   endif<a name='187'>
<a name='188'>
   IM=ITE-ITS+1<a name='189'>
   KM=KTE-KTS+1<a name='190'>
<a name='191'>
   DO J=jts,jte<a name='192'>
<a name='193'>
      DO i=its,ite<a name='194'>
        DDVEL(I)=0.<a name='195'>
        RCL(i)=1.<a name='196'>
        PRSL1(i)=P3D(i,kts,j)*.001<a name='197'>
        PS(i)=PSFC(i,j)*.001<a name='198'>
        Q1(I) = QV3D(i,kts,j)<a name='199'>
<font color=#447700>!        QSURF(I)=QSFC(I,J)<a name='200'></font>
        QSURF(I)=0.<a name='201'>
        SHELEG(I)=0.<a name='202'>
        SLIMSK(i)=ABS(XLAND(i,j)-2.)<a name='203'>
        TSKIN(i)=TSK(i,j)<a name='204'>
        T1(I) = T3D(i,kts,j)<a name='205'>
        U1(I) = U3D(i,kts,j)<a name='206'>
        USTAR(I) = UST(i,j)<a name='207'>
        V1(I) = V3D(i,kts,j)<a name='208'>
        Z0RL(I) = ZNT(i,j)*100.<a name='209'>
      ENDDO<a name='210'>
<a name='211'>
      DO i=its,ite<a name='212'>
         PRSLKI(i)=(PS(I)/PRSL1(I))**ROVCP<a name='213'>
         THGB(I)=TSKIN(i)*(100./PS(I))**ROVCP<a name='214'>
         THX(I)=T1(i)*(100./PRSL1(I))**ROVCP<a name='215'>
         RHO1(I)=PRSL1(I)*1000./(R*T1(I)*(1.+EP1*Q1(I)))<a name='216'>
         Q1(I)=Q1(I)/(1.+Q1(I))<a name='217'>
      ENDDO<a name='218'>
<a name='219'>
<a name='220'>
      CALL <A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM'>PROGTM</A><A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROGTM_1">(IM,KM,PS,U1,V1,T1,Q1,                                 &amp;<a name='221'>
                  SHELEG,TSKIN,QSURF,                                   &amp;<a name='222'>
<font color=#447700>!WRF              SMC,STC,DM,SOILTYP,SIGMAF,VEGTYPE,CANOPY,DLWFLX,      &amp;<a name='223'></font>
<font color=#447700>!WRF              SLRAD,SNOWMT,DELT,                                    &amp;<a name='224'></font>
                  Z0RL,                                                 &amp;<a name='225'>
<font color=#447700>!WRF              TG3,GFLUX,F10M,                                       &amp;<a name='226'></font>
                  U10M,V10M,T2M,Q2M,                                    &amp;<a name='227'>
<font color=#447700>!WRF              ZSOIL,                                                &amp;<a name='228'></font>
                  CM,CH,RB,                                             &amp;<a name='229'>
<font color=#447700>!WRF              RHSCNPY,RHSMC,AIM,BIM,CIM,                            &amp;<a name='230'></font>
                  RCL,PRSL1,PRSLKI,SLIMSK,                              &amp;<a name='231'>
                  DRAIN,EVAP,HFLX,STRESS,EP,                            &amp;<a name='232'>
                  FM,FH,USTAR,WIND,DDVEL,                               &amp;<a name='233'>
                  PM,PH,FH2,QSS,Z1                                      )<a name='234'>
<a name='235'>
<a name='236'>
      DO i=its,ite<a name='237'>
        U10(i,j)=U10M(i)<a name='238'>
        V10(i,j)=V10M(i)<a name='239'>
        BR(i,j)=RB(i)<a name='240'>
        CHS(I,J)=CH(I)*WIND(I)<a name='241'>
        CHS2(I,J)=USTAR(I)*KARMAN/FH2(I)<a name='242'>
        CPM(I,J)=CP*(1.+0.8*QV3D(i,kts,j))<a name='243'>
        esat = <A href='../../html_code/phys/module_mp_wsm6.F.html#FPVS'>fpvs</A><A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVS_6">(t1(i))<a name='244'>
        QGH(I,J)=ep2*esat/(1000.*ps(i)-esat)<a name='245'>
        QSFC(I,J)=qss(i)<a name='246'>
        PSIH(i,j)=PH(i)<a name='247'>
        PSIM(i,j)=PM(i)<a name='248'>
        UST(i,j)=ustar(i)<a name='249'>
        WSPD(i,j)=WIND(i)<a name='250'>
        ZNT(i,j)=Z0RL(i)*.01<a name='251'>
      ENDDO<a name='252'>
<a name='253'>
      DO i=its,ite<a name='254'>
        FLHC(i,j)=CPM(I,J)*RHO1(I)*CHS(I,J)<a name='255'>
        FLQC(i,j)=RHO1(I)*CHS(I,J)<a name='256'>
        GZ1OZ0(i,j)=LOG(Z1(I)/(Z0RL(I)*.01))<a name='257'>
        CQS2(i,j)=CHS2(I,J)<a name='258'>
      ENDDO<a name='259'>
<a name='260'>
      IF (ISFFLX.EQ.0) THEN<a name='261'>
        DO i=its,ite<a name='262'>
          HFX(i,j)=0.<a name='263'>
          LH(i,j)=0.<a name='264'>
          QFX(i,j)=0.<a name='265'>
        ENDDO<a name='266'>
      ELSE<a name='267'>
        DO i=its,ite<a name='268'>
          IF(XLAND(I,J)-1.5.GT.0.)THEN<a name='269'>
            HFX(I,J)=FLHC(I,J)*(THGB(I)-THX(I))<a name='270'>
          ELSEIF(XLAND(I,J)-1.5.LT.0.)THEN<a name='271'>
            HFX(I,J)=FLHC(I,J)*(THGB(I)-THX(I))<a name='272'>
            HFX(I,J)=AMAX1(HFX(I,J),-250.)<a name='273'>
          ENDIF<a name='274'>
          QFX(I,J)=FLQC(I,J)*(QSFC(I,J)-Q1(I))<a name='275'>
          QFX(I,J)=AMAX1(QFX(I,J),0.)<a name='276'>
          LH(I,J)=XLV*QFX(I,J)<a name='277'>
        ENDDO<a name='278'>
      ENDIF<a name='279'>
<a name='280'>
<a name='281'>
    ENDDO<a name='282'>
<a name='283'>
<a name='284'>
   END SUBROUTINE SF_GFS<a name='285'>
<a name='286'>
<a name='287'>
<font color=#447700>!-------------------------------------------------------------------<a name='288'></font>
<a name='289'>
<A NAME='PROGTM'><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='290'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>PROGTM</font>(IM,KM,PS,U1,V1,T1,Q1,                           &amp; <A href='../../call_to/PROGTM.html' TARGET='index'>1</A>,<A href='../../call_from/PROGTM.html' TARGET='index'>17</A><a name='291'>
     &amp;                  SHELEG,TSKIN,QSURF,                             &amp;<a name='292'>
<font color=#447700>!WRF     &amp;                  SMC,STC,DM,SOILTYP,SIGMAF,VEGTYPE,CANOPY,   &amp;<a name='293'></font>
<font color=#447700>!WRF     &amp;                  DLWFLX,SLRAD,SNOWMT,DELT,                   &amp;<a name='294'></font>
     &amp;                  Z0RL,                                           &amp;<a name='295'>
<font color=#447700>!WRF     &amp;                  TG3,GFLUX,F10M,                             &amp;<a name='296'></font>
     &amp;                  U10M,V10M,T2M,Q2M,                              &amp;<a name='297'>
<font color=#447700>!WRF     &amp;                  ZSOIL,                                      &amp;<a name='298'></font>
     &amp;                  CM, CH, RB,                                     &amp;<a name='299'>
<font color=#447700>!WRF     &amp;                  RHSCNPY,RHSMC,AIM,BIM,CIM,                  &amp;<a name='300'></font>
     &amp;                  RCL,PRSL1,PRSLKI,SLIMSK,                        &amp;<a name='301'>
     &amp;                  DRAIN,EVAP,HFLX,STRESS,EP,                      &amp;<a name='302'>
     &amp;                  FM,FH,USTAR,WIND,DDVEL,                         &amp;<a name='303'>
     &amp;                  PM,PH,FH2,QSS,Z1                                )<a name='304'>
<font color=#447700>!<a name='305'></font>
<a name='306'>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_33">, ONLY : kind_phys<a name='307'>
      USE <A href='../../html_code/phys/module_gfs_funcphys.F.html#MODULE_GFS_FUNCPHYS'>MODULE_GFS_FUNCPHYS</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_FUNCPHYS_14">, ONLY : fpvs<a name='308'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_20">, grav =&gt; con_g, SBC =&gt; con_sbc, HVAP =&gt; con_HVAP &amp;<a name='309'>
     &amp;,             CP =&gt; con_CP, HFUS =&gt; con_HFUS, JCAL =&gt; con_JCAL    &amp;<a name='310'>
     &amp;,             EPS =&gt; con_eps, EPSM1 =&gt; con_epsm1, t0c =&gt; con_t0c  &amp;<a name='311'>
     &amp;,             RVRDM1 =&gt; con_FVirt, RD =&gt; con_RD<a name='312'>
      implicit none<a name='313'>
<font color=#447700>!<a name='314'></font>
<font color=#447700>!     include 'constant.h'<a name='315'></font>
<font color=#447700>!<a name='316'></font>
      integer              IM, km<a name='317'>
<font color=#447700>!<a name='318'></font>
      real(kind=kind_phys), parameter :: cpinv=1.0/cp, HVAPI=1.0/HVAP<a name='319'>
      real(kind=kind_phys) DELT<a name='320'>
      INTEGER              SOILTYP(IM),  VEGTYPE(IM)<a name='321'>
      real(kind=kind_phys) PS(IM),       U1(IM),      V1(IM),           &amp;<a name='322'>
     &amp;                     T1(IM),       Q1(IM),      SHELEG(IM),       &amp;<a name='323'>
     &amp;                     TSKIN(IM),    QSURF(IM),   SMC(IM,KM),       &amp;<a name='324'>
     &amp;                     STC(IM,KM),   DM(IM),      SIGMAF(IM),       &amp;<a name='325'>
     &amp;                     CANOPY(IM),   DLWFLX(IM),  SLRAD(IM),        &amp;<a name='326'>
     &amp;                     SNOWMT(IM),   Z0RL(IM),    TG3(IM),          &amp;<a name='327'>
     &amp;                     GFLUX(IM),    F10M(IM),    U10M(IM),         &amp;<a name='328'>
     &amp;                     V10M(IM),     T2M(IM),     Q2M(IM),          &amp;<a name='329'>
     &amp;                     ZSOIL(IM,KM), CM(IM),      CH(IM),           &amp;<a name='330'>
     &amp;                     RB(IM),       RHSCNPY(IM), RHSMC(IM,KM),     &amp;<a name='331'>
     &amp;                     AIM(IM,KM),   BIM(IM,KM),  CIM(IM,KM),       &amp;<a name='332'>
     &amp;                     RCL(IM),      PRSL1(IM),   PRSLKI(IM),       &amp;<a name='333'>
     &amp;                     SLIMSK(IM),   DRAIN(IM),   EVAP(IM),         &amp;<a name='334'>
     &amp;                     HFLX(IM),     RNET(IM),    EP(IM),           &amp;<a name='335'>
     &amp;                     FM(IM),       FH(IM),      USTAR(IM),        &amp;<a name='336'>
     &amp;                     WIND(IM),     DDVEL(IM),   STRESS(IM)<a name='337'>
<font color=#447700>!<a name='338'></font>
<font color=#447700>!     Locals<a name='339'></font>
<font color=#447700>!<a name='340'></font>
      integer              k,i<a name='341'>
<font color=#447700>!<a name='342'></font>
      real(kind=kind_phys) CANFAC(IM),                                  &amp;<a name='343'>
     &amp;                     DDZ(IM),     DDZ2(IM),    DELTA(IM),         &amp;<a name='344'>
     &amp;                     DEW(IM),     DF1(IM),     DFT0(IM),          &amp;<a name='345'>
     &amp;                     DFT2(IM),    DFT1(IM),                       &amp;<a name='346'>
     &amp;                     DMDZ(IM),    DMDZ2(IM),   DTDZ1(IM),         &amp;<a name='347'>
     &amp;                     DTDZ2(IM),   DTV(IM),     EC(IM),            &amp;<a name='348'>
     &amp;                     EDIR(IM),    ETPFAC(IM),                     &amp;<a name='349'>
     &amp;                     FACTSNW(IM), FH2(IM),     FM10(IM),          &amp;<a name='350'>
     &amp;                     FX(IM),      GX(IM),                         &amp;<a name='351'>
     &amp;                     HCPCT(IM),   HL1(IM),     HL12(IM),          &amp;<a name='352'>
     &amp;                     HLINF(IM),   PARTLND(IM), PH(IM),            &amp;<a name='353'>
     &amp;                     PH2(IM),     PM(IM),      PM10(IM),          &amp;<a name='354'>
     &amp;                     PSURF(IM),   Q0(IM),      QS1(IM),           &amp;<a name='355'>
     &amp;                     QSS(IM),     RAT(IM),     RCAP(IM),          &amp;<a name='356'>
     &amp;                     RCH(IM),     RHO(IM),     RS(IM),            &amp;<a name='357'>
     &amp;                     RSMALL(IM),  SLWD(IM),    SMCZ(IM),          &amp;<a name='358'>
     &amp;                     SNET(IM),    SNOEVP(IM),  SNOWD(IM),         &amp;<a name='359'>
     &amp;                     T1O(IM),     T2MO(IM),    TERM1(IM),         &amp;<a name='360'>
     &amp;                     TERM2(IM),   THETA1(IM),  THV1(IM),          &amp;<a name='361'>
     &amp;                     TREF(IM),    TSURF(IM),   TV1(IM),           &amp;<a name='362'>
     &amp;                     TVS(IM),     TSURFO(IM),  TWILT(IM),         &amp;<a name='363'>
     &amp;                     XX(IM),      XRCL(IM),    YY(IM),            &amp;<a name='364'>
     &amp;                     Z0(IM),      Z0MAX(IM),   Z1(IM),            &amp;<a name='365'>
     &amp;                     ZTMAX(IM),   ZZ(IM),      PS1(IM)<a name='366'>
<font color=#447700>!<a name='367'></font>
      real(kind=kind_phys) a0,    a0p,      a1,    a1p,     aa,  aa0,   &amp;<a name='368'>
     &amp;                     aa1,   adtv,     alpha, arnu,    b1,  b1p,   &amp;<a name='369'>
     &amp;                     b2,    b2p,      bb,    bb0,     bb1, bb2,   &amp;<a name='370'>
     &amp;                     bfact, ca,       cc,    cc1,    cc2, cfactr, &amp;<a name='371'>
     &amp;                     ch2o,  charnock, cice,  convrad, cq,  csoil, &amp;<a name='372'>
     &amp;                     ctfil1,ctfil2,   delt2, df2,     dfsnow,     &amp;<a name='373'>
     &amp;                     elocp, eth,      ff,  FMS,                   &amp;<a name='374'>
<font color=#447700>!WRF     &amp;                     fhs,   funcdf,   funckt,g,      hl0, hl0inf, &amp;<a name='375'></font>
     &amp;                     fhs,   g,        hl0,    hl0inf,             &amp;<a name='376'>
     &amp;                     hl110, hlt,      hltinf,OLINF,   rcq, rcs,   &amp;<a name='377'>
     &amp;                     rct,   restar,   rhoh2o,rnu,     RSI,        &amp;<a name='378'>
     &amp;                     rss,   scanop,   sig2k, sigma,   smcdry,     &amp;<a name='379'>
     &amp;                     t12,   t14,      tflx,  tgice,   topt,       &amp;<a name='380'>
     &amp;                     val,   vis,      zbot,  snomin,  tem<a name='381'>
<font color=#447700>!<a name='382'></font>
<font color=#447700>!<a name='383'></font>
<a name='384'>
      PARAMETER (CHARNOCK=.014,CA=.4)<font color=#447700>!C CA IS THE VON KARMAN CONSTANT<a name='385'></font>
      PARAMETER (G=grav,sigma=sbc)<a name='386'>
<a name='387'>
      PARAMETER (ALPHA=5.,A0=-3.975,A1=12.32,B1=-7.755,B2=6.041)<a name='388'>
      PARAMETER (A0P=-7.941,A1P=24.75,B1P=-8.705,B2P=7.899,VIS=1.4E-5)<a name='389'>
      PARAMETER (AA1=-1.076,BB1=.7045,CC1=-.05808)<a name='390'>
      PARAMETER (BB2=-.1954,CC2=.009999)<a name='391'>
      PARAMETER (ELOCP=HVAP/CP,DFSNOW=.31,CH2O=4.2E6,CSOIL=1.26E6)<a name='392'>
      PARAMETER (SCANOP=.5,CFACTR=.5,ZBOT=-3.,TGICE=271.2)<a name='393'>
      PARAMETER (CICE=1880.*917.,topt=298.)<a name='394'>
      PARAMETER (RHOH2O=1000.,CONVRAD=JCAL*1.E4/60.)<a name='395'>
      PARAMETER (CTFIL1=.5,CTFIL2=1.-CTFIL1)<a name='396'>
      PARAMETER (RNU=1.51E-5,ARNU=.135*RNU)<a name='397'>
      parameter (snomin=1.0e-9)<a name='398'>
<font color=#447700>!<a name='399'></font>
      LOGICAL FLAG(IM), FLAGSNW(IM)<a name='400'>
<font color=#447700>!WRF      real(kind=kind_phys) KT1(IM),       KT2(IM),      KTSOIL,         &amp;<a name='401'></font>
      real(kind=kind_phys) KT1(IM),       KT2(IM),                      &amp;<a name='402'>
     &amp;                     ET(IM,KM),                                   &amp;<a name='403'>
     &amp;                     STSOIL(IM,KM), AI(IM,KM),    BI(IM,KM),      &amp;<a name='404'>
     &amp;                     CI(IM,KM),     RHSTC(IM,KM)<a name='405'>
      real(kind=kind_phys) rsmax(13), rgl(13),  rsmin(13), hs(13),      &amp;<a name='406'>
     &amp;                     smmax(9),  smdry(9), smref(9),  smwlt(9)<a name='407'>
<a name='408'>
<font color=#447700>!<a name='409'></font>
<font color=#447700>!  the 13 vegetation types are:<a name='410'></font>
<font color=#447700>!<a name='411'></font>
<font color=#447700>!  1  ...  broadleave-evergreen trees (tropical forest)<a name='412'></font>
<font color=#447700>!  2  ...  broadleave-deciduous trees<a name='413'></font>
<font color=#447700>!  3  ...  broadleave and needle leave trees (mixed forest)<a name='414'></font>
<font color=#447700>!  4  ...  needleleave-evergreen trees<a name='415'></font>
<font color=#447700>!  5  ...  needleleave-deciduous trees (larch)<a name='416'></font>
<font color=#447700>!  6  ...  broadleave trees with groundcover (savanna)<a name='417'></font>
<font color=#447700>!  7  ...  groundcover only (perenial)<a name='418'></font>
<font color=#447700>!  8  ...  broadleave shrubs with perenial groundcover<a name='419'></font>
<font color=#447700>!  9  ...  broadleave shrubs with bare soil<a name='420'></font>
<font color=#447700>! 10  ...  dwarf trees and shrubs with ground cover (trunda)<a name='421'></font>
<font color=#447700>! 11  ...  bare soil<a name='422'></font>
<font color=#447700>! 12  ...  cultivations (use parameters from type 7)<a name='423'></font>
<font color=#447700>! 13  ...  glacial<a name='424'></font>
<font color=#447700>!<a name='425'></font>
      data rsmax/13*5000./<a name='426'>
      data rsmin/150.,100.,125.,150.,100.,70.,40.,                      &amp;<a name='427'>
     &amp;           300.,400.,150.,999.,40.,999./<a name='428'>
      data rgl/5*30.,65.,4*100.,999.,100.,999./<a name='429'>
      data hs/41.69,54.53,51.93,47.35,47.35,54.53,36.35,                &amp;<a name='430'>
     &amp;        3*42.00,999.,36.35,999./<a name='431'>
      data smmax/.421,.464,.468,.434,.406,.465,.404,.439,.421/<a name='432'>
      data smdry/.07,.14,.22,.08,.18,.16,.12,.10,.07/<a name='433'>
      data smref/.283,.387,.412,.312,.338,.382,.315,.329,.283/<a name='434'>
      data smwlt/.029,.119,.139,.047,.010,.103,.069,.066,.029/<a name='435'>
<font color=#447700>!<a name='436'></font>
<font color=#447700>!!!   save rsmax, rsmin, rgl, hs, smmax, smdry, smref, smwlt<a name='437'></font>
<font color=#447700>!<a name='438'></font>
<a name='439'>
<font color=#447700>!WRF      DELT2 = DELT * 2.<a name='440'></font>
<font color=#447700>!<a name='441'></font>
<font color=#447700>!     ESTIMATE SIGMA ** K AT 2 M<a name='442'></font>
<font color=#447700>!<a name='443'></font>
      SIG2K = 1. - 4. * G * 2. / (CP * 280.)<a name='444'>
<font color=#447700>!<a name='445'></font>
<font color=#447700>!  INITIALIZE VARIABLES. ALL UNITS ARE SUPPOSEDLY M.K.S. UNLESS SPECIFIE<a name='446'></font>
<font color=#447700>!  PSURF IS IN PASCALS<a name='447'></font>
<font color=#447700>!  WIND IS WIND SPEED, THETA1 IS ADIABATIC SURFACE TEMP FROM LEVEL 1<a name='448'></font>
<font color=#447700>!  RHO IS DENSITY, QS1 IS SAT. HUM. AT LEVEL1 AND QSS IS SAT. HUM. AT<a name='449'></font>
<font color=#447700>!  SURFACE<a name='450'></font>
<font color=#447700>!  CONVERT SLRAD TO THE CIVILIZED UNIT FROM LANGLEY MINUTE-1 K-4<a name='451'></font>
<font color=#447700>!  SURFACE ROUGHNESS LENGTH IS CONVERTED TO M FROM CM<a name='452'></font>
<font color=#447700>!<a name='453'></font>
<font color=#447700>!!<a name='454'></font>
<font color=#447700>!     qs1 = fpvs(t1)<a name='455'></font>
<font color=#447700>!     qss = fpvs(tskin)<a name='456'></font>
      DO I=1,IM<a name='457'>
        XRCL(I)  = SQRT(RCL(I))<a name='458'>
        PSURF(I) = 1000. * PS(I)<a name='459'>
        PS1(I)   = 1000. * PRSL1(I)<a name='460'>
<font color=#447700>!       SLWD(I)  = SLRAD(I) * CONVRAD<a name='461'></font>
<font color=#447700>!WRF        SLWD(I)  = SLRAD(I)<a name='462'></font>
<font color=#447700>!<a name='463'></font>
<font color=#447700>!  DLWFLX has been given a negative sign for downward longwave<a name='464'></font>
<font color=#447700>!  snet is the net shortwave flux<a name='465'></font>
<font color=#447700>!<a name='466'></font>
<font color=#447700>!WRF        SNET(I) = -SLWD(I) - DLWFLX(I)<a name='467'></font>
        WIND(I) = XRCL(I) * SQRT(U1(I) * U1(I) + V1(I) * V1(I))         &amp;<a name='468'>
     &amp;              + MAX(0.0_kind_phys, MIN(DDVEL(I), 30.0_kind_phys))<a name='469'>
        WIND(I) = MAX(WIND(I),1._kind_phys)<a name='470'>
        Q0(I) = MAX(Q1(I),1.E-8_kind_phys)<a name='471'>
        TSURF(I) = TSKIN(I)<a name='472'>
        THETA1(I) = T1(I) * PRSLKI(I)<a name='473'>
        TV1(I) = T1(I) * (1. + RVRDM1 * Q0(I))<a name='474'>
        THV1(I) = THETA1(I) * (1. + RVRDM1 * Q0(I))<a name='475'>
        TVS(I) = TSURF(I) * (1. + RVRDM1 * Q0(I))<a name='476'>
        RHO(I) = PS1(I) / (RD * TV1(I))<a name='477'>
<font color=#447700>!jfe    QS1(I) = 1000. * FPVS(T1(I))<a name='478'></font>
        qs1(i) = <A href='../../html_code/phys/module_mp_wsm6.F.html#FPVS'>fpvs</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVS_7">(t1(i))<a name='479'>
        QS1(I) = EPS * QS1(I) / (PS1(I) + EPSM1 * QS1(I))<a name='480'>
        QS1(I) = MAX(QS1(I), 1.E-8_kind_phys)<a name='481'>
        Q0(I) = min(QS1(I),Q0(I))<a name='482'>
<font color=#447700>!jfe    QSS(I) = 1000. * FPVS(TSURF(I))<a name='483'></font>
        qss(i) = <A href='../../html_code/phys/module_mp_wsm6.F.html#FPVS'>fpvs</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVS_8">(tskin(i))<a name='484'>
        QSS(I) = EPS * QSS(I) / (PSURF(I) + EPSM1 * QSS(I))<a name='485'>
<font color=#447700>!       RS = PLANTR<a name='486'></font>
        RS(I) = 0.<a name='487'>
<font color=#447700>!WRF        if(VEGTYPE(I).gt.0.) RS(I) = rsmin(VEGTYPE(I))<a name='488'></font>
        Z0(I) = .01 * Z0RL(i)<a name='489'>
<font color=#447700>!WRF        CANOPY(I)= MAX(CANOPY(I),0._kind_phys)<a name='490'></font>
        DM(I) = 1.<a name='491'>
<font color=#447700>!WRF<a name='492'></font>
      GOTO 1111<a name='493'>
<font color=#447700>!WRF<a name='494'></font>
        FACTSNW(I) = 10.<a name='495'>
        IF(SLIMSK(I).EQ.2.) FACTSNW(I) = 3.<a name='496'>
<font color=#447700>!<a name='497'></font>
<font color=#447700>!  SNOW DEPTH IN WATER EQUIVALENT IS CONVERTED FROM MM TO M UNIT<a name='498'></font>
<font color=#447700>!<a name='499'></font>
        SNOWD(I) = SHELEG(I) / 1000.<a name='500'>
        FLAGSNW(I) = .FALSE.<a name='501'>
<font color=#447700>!<a name='502'></font>
<font color=#447700>!  WHEN SNOW DEPTH IS LESS THAN 1 MM, A PATCHY SNOW IS ASSUMED AND<a name='503'></font>
<font color=#447700>!  SOIL IS ALLOWED TO INTERACT WITH THE ATMOSPHERE.<a name='504'></font>
<font color=#447700>!  WE SHOULD EVENTUALLY MOVE TO A LINEAR COMBINATION OF SOIL AND<a name='505'></font>
<font color=#447700>!  SNOW UNDER THE CONDITION OF PATCHY SNOW.<a name='506'></font>
<font color=#447700>!<a name='507'></font>
        IF(SNOWD(I).GT..001.OR.SLIMSK(I).EQ.2.) RS(I) = 0.<a name='508'>
        IF(SNOWD(I).GT..001) FLAGSNW(I) = .TRUE.<a name='509'>
<font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='510'></font>
<font color=#447700>!##DG    PRINT *, ' WIND,TV1,TVS,Q1,QS1,SNOW,SLIMSK=',<a name='511'></font>
<font color=#447700>!##DG&amp;   WIND,TV1,TVS,Q1,QS1,SNOWD,SLIMSK<a name='512'></font>
<font color=#447700>!##DG    PRINT *, ' SNET, SLWD =', SNET, SLWD(I)<a name='513'></font>
<font color=#447700>!##DG  ENDIF<a name='514'></font>
        IF(SLIMSK(I).EQ.0.) THEN<a name='515'>
          ZSOIL(I,1) = 0.<a name='516'>
        ELSEIF(SLIMSK(I).EQ.1.) THEN<a name='517'>
          ZSOIL(I,1) = -.10<a name='518'>
        ELSE<a name='519'>
          ZSOIL(I,1) = -3. / KM<a name='520'>
        ENDIF<a name='521'>
<font color=#447700>!WRF<a name='522'></font>
1111  CONTINUE<a name='523'>
<font color=#447700>!WRF<a name='524'></font>
      ENDDO<a name='525'>
<a name='526'>
<font color=#447700>!!<a name='527'></font>
<font color=#447700>!WRF<a name='528'></font>
      GOTO 2222<a name='529'>
<font color=#447700>!WRF<a name='530'></font>
      DO K = 2, KM<a name='531'>
        DO I=1,IM<a name='532'>
          IF(SLIMSK(I).EQ.0.) THEN<a name='533'>
            ZSOIL(I,K) = 0.<a name='534'>
          ELSEIF(SLIMSK(I).EQ.1.) THEN<a name='535'>
            ZSOIL(I,K) = ZSOIL(I,K-1)                                   &amp;<a name='536'>
     &amp;                   + (-2. - ZSOIL(I,1)) / (KM - 1)<a name='537'>
          ELSE<a name='538'>
            ZSOIL(I,K) = - 3. * FLOAT(K) / FLOAT(KM)<a name='539'>
          ENDIF<a name='540'>
        ENDDO<a name='541'>
      ENDDO<a name='542'>
<font color=#447700>!WRF<a name='543'></font>
2222  CONTINUE<a name='544'>
<font color=#447700>!WRF<a name='545'></font>
<font color=#447700>!!<a name='546'></font>
      DO I=1,IM<a name='547'>
        Z1(I) = -RD * TV1(I) * LOG(PS1(I)/PSURF(I)) / G<a name='548'>
        DRAIN(I) = 0.<a name='549'>
      ENDDO<a name='550'>
<a name='551'>
<font color=#447700>!!<a name='552'></font>
      DO K = 1, KM<a name='553'>
        DO I=1,IM<a name='554'>
          ET(I,K) = 0.<a name='555'>
          RHSMC(I,K) = 0.<a name='556'>
          AIM(I,K) = 0.<a name='557'>
          BIM(I,K) = 1.<a name='558'>
          CIM(I,K) = 0.<a name='559'>
          STSOIL(I,K) = STC(I,K)<a name='560'>
        ENDDO<a name='561'>
      ENDDO<a name='562'>
<a name='563'>
      DO I=1,IM<a name='564'>
        EDIR(I) = 0.<a name='565'>
        EC(I) = 0.<a name='566'>
        EVAP(I) = 0.<a name='567'>
        EP(I) = 0.<a name='568'>
        SNOWMT(I) = 0.<a name='569'>
        GFLUX(I) = 0.<a name='570'>
        RHSCNPY(I) = 0.<a name='571'>
        FX(I) = 0.<a name='572'>
        ETPFAC(I) = 0.<a name='573'>
        CANFAC(I) = 0.<a name='574'>
      ENDDO<a name='575'>
<font color=#447700>!<a name='576'></font>
<font color=#447700>!  COMPUTE STABILITY DEPENDENT EXCHANGE COEFFICIENTS<a name='577'></font>
<font color=#447700>!<a name='578'></font>
<font color=#447700>!  THIS PORTION OF THE CODE IS PRESENTLY SUPPRESSED<a name='579'></font>
<font color=#447700>!<a name='580'></font>
      DO I=1,IM<a name='581'>
        IF(SLIMSK(I).EQ.0.) THEN<a name='582'>
          USTAR(I) = SQRT(G * Z0(I) / CHARNOCK)<a name='583'>
        ENDIF<a name='584'>
<font color=#447700>!<a name='585'></font>
<font color=#447700>!  COMPUTE STABILITY INDICES (RB AND HLINF)<a name='586'></font>
<font color=#447700>!<a name='587'></font>
<a name='588'>
        Z0MAX(I) = MIN(Z0(I),0.1 * Z1(I))<a name='589'>
        ZTMAX(I) = Z0MAX(I)<a name='590'>
        IF(SLIMSK(I).EQ.0.) THEN<a name='591'>
          RESTAR = USTAR(I) * Z0MAX(I) / VIS<a name='592'>
          RESTAR = MAX(RESTAR,.000001_kind_phys)<a name='593'>
<font color=#447700>!         RESTAR = ALOG(RESTAR)<a name='594'></font>
<font color=#447700>!         RESTAR = MIN(RESTAR,5.)<a name='595'></font>
<font color=#447700>!         RESTAR = MAX(RESTAR,-5.)<a name='596'></font>
<font color=#447700>!         RAT(I) = AA1 + BB1 * RESTAR + CC1 * RESTAR ** 2<a name='597'></font>
<font color=#447700>!         RAT(I) = RAT(I) / (1. + BB2 * RESTAR<a name='598'></font>
<font color=#447700>!    &amp;                       + CC2 * RESTAR ** 2)<a name='599'></font>
<font color=#447700>!  Rat taken from Zeng, Zhao and Dickinson 1997<a name='600'></font>
          RAT(I) = 2.67 * restar ** .25 - 2.57<a name='601'>
          RAT(I) = min(RAT(I),7._kind_phys)<a name='602'>
          ZTMAX(I) = Z0MAX(I) * EXP(-RAT(I))<a name='603'>
        ENDIF<a name='604'>
      ENDDO<a name='605'>
<a name='606'>
<font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='607'></font>
<font color=#447700>!##DG    PRINT *, ' z0max, ztmax, restar, RAT(I) =',<a name='608'></font>
<font color=#447700>!##DG &amp;   z0max, ztmax, restar, RAT(I)<a name='609'></font>
<font color=#447700>!##DG  ENDIF<a name='610'></font>
      DO I = 1, IM<a name='611'>
        DTV(I) = THV1(I) - TVS(I)<a name='612'>
        ADTV = ABS(DTV(I))<a name='613'>
        ADTV = MAX(ADTV,.001_kind_phys)<a name='614'>
        DTV(I) = SIGN(1._kind_phys,DTV(I)) * ADTV<a name='615'>
        RB(I) = G * DTV(I) * Z1(I) / (.5 * (THV1(I) + TVS(I))           &amp;<a name='616'>
     &amp;          * WIND(I) * WIND(I))<a name='617'>
        RB(I) = MAX(RB(I),-5000._kind_phys)<a name='618'>
<font color=#447700>!        FM(I) = LOG((Z0MAX(I)+Z1(I)) / Z0MAX(I))<a name='619'></font>
<font color=#447700>!        FH(I) = LOG((ZTMAX(I)+Z1(I)) / ZTMAX(I))<a name='620'></font>
        FM(I) = LOG((Z1(I)) / Z0MAX(I))<a name='621'>
        FH(I) = LOG((Z1(I)) / ZTMAX(I))<a name='622'>
        HLINF(I) = RB(I) * FM(I) * FM(I) / FH(I)<a name='623'>
        FM10(I) = LOG((Z0MAX(I)+10.) / Z0MAX(I))<a name='624'>
        FH2(I) = LOG((ZTMAX(I)+2.) / ZTMAX(I))<a name='625'>
      ENDDO<a name='626'>
<font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='627'></font>
<font color=#447700>!##DG    PRINT *, ' DTV, RB(I), FM(I), FH(I), HLINF =',<a name='628'></font>
<font color=#447700>!##DG &amp;   dtv, rb, FM(I), FH(I), hlinf<a name='629'></font>
<font color=#447700>!##DG  ENDIF<a name='630'></font>
<font color=#447700>!<a name='631'></font>
<font color=#447700>!  STABLE CASE<a name='632'></font>
<font color=#447700>!<a name='633'></font>
      DO I = 1, IM<a name='634'>
        IF(DTV(I).GE.0.) THEN<a name='635'>
          HL1(I) = HLINF(I)<a name='636'>
        ENDIF<a name='637'>
        IF(DTV(I).GE.0..AND.HLINF(I).GT..25) THEN<a name='638'>
          HL0INF = Z0MAX(I) * HLINF(I) / Z1(I)<a name='639'>
          HLTINF = ZTMAX(I) * HLINF(I) / Z1(I)<a name='640'>
          AA = SQRT(1. + 4. * ALPHA * HLINF(I))<a name='641'>
          AA0 = SQRT(1. + 4. * ALPHA * HL0INF)<a name='642'>
          BB = AA<a name='643'>
          BB0 = SQRT(1. + 4. * ALPHA * HLTINF)<a name='644'>
          PM(I) = AA0 - AA + LOG((AA + 1.) / (AA0 + 1.))<a name='645'>
          PH(I) = BB0 - BB + LOG((BB + 1.) / (BB0 + 1.))<a name='646'>
          FMS = FM(I) - PM(I)<a name='647'>
          FHS = FH(I) - PH(I)<a name='648'>
          HL1(I) = FMS * FMS * RB(I) / FHS<a name='649'>
        ENDIF<a name='650'>
      ENDDO<a name='651'>
<font color=#447700>!<a name='652'></font>
<font color=#447700>!  SECOND ITERATION<a name='653'></font>
<font color=#447700>!<a name='654'></font>
      DO I = 1, IM<a name='655'>
        IF(DTV(I).GE.0.) THEN<a name='656'>
          HL0 = Z0MAX(I) * HL1(I) / Z1(I)<a name='657'>
          HLT = ZTMAX(I) * HL1(I) / Z1(I)<a name='658'>
          AA = SQRT(1. + 4. * ALPHA * HL1(I))<a name='659'>
          AA0 = SQRT(1. + 4. * ALPHA * HL0)<a name='660'>
          BB = AA<a name='661'>
          BB0 = SQRT(1. + 4. * ALPHA * HLT)<a name='662'>
          PM(I) = AA0 - AA + LOG((AA + 1.) / (AA0 + 1.))<a name='663'>
          PH(I) = BB0 - BB + LOG((BB + 1.) / (BB0 + 1.))<a name='664'>
          HL110 = HL1(I) * 10. / Z1(I)<a name='665'>
          AA = SQRT(1. + 4. * ALPHA * HL110)<a name='666'>
          PM10(I) = AA0 - AA + LOG((AA + 1.) / (AA0 + 1.))<a name='667'>
          HL12(I) = HL1(I) * 2. / Z1(I)<a name='668'>
<font color=#447700>!         AA = SQRT(1. + 4. * ALPHA * HL12(I))<a name='669'></font>
          BB = SQRT(1. + 4. * ALPHA * HL12(I))<a name='670'>
          PH2(I) = BB0 - BB + LOG((BB + 1.) / (BB0 + 1.))<a name='671'>
        ENDIF<a name='672'>
      ENDDO<a name='673'>
<font color=#447700>!!<a name='674'></font>
<font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='675'></font>
<font color=#447700>!##DG    PRINT *, ' HL1(I), PM, PH =',<a name='676'></font>
<font color=#447700>!##DG &amp;   HL1(I),  pm, ph<a name='677'></font>
<font color=#447700>!##DG  ENDIF<a name='678'></font>
<font color=#447700>!<a name='679'></font>
<font color=#447700>!  UNSTABLE CASE<a name='680'></font>
<font color=#447700>!<a name='681'></font>
<font color=#447700>!<a name='682'></font>
<font color=#447700>!  CHECK FOR UNPHYSICAL OBUKHOV LENGTH<a name='683'></font>
<font color=#447700>!<a name='684'></font>
      DO I=1,IM<a name='685'>
        IF(DTV(I).LT.0.) THEN<a name='686'>
          OLINF = Z1(I) / HLINF(I)<a name='687'>
          IF(ABS(OLINF).LE.50. * Z0MAX(I)) THEN<a name='688'>
            HLINF(I) = -Z1(I) / (50. * Z0MAX(I))<a name='689'>
          ENDIF<a name='690'>
        ENDIF<a name='691'>
      ENDDO<a name='692'>
<font color=#447700>!<a name='693'></font>
<font color=#447700>!  GET PM AND PH<a name='694'></font>
<font color=#447700>!<a name='695'></font>
      DO I = 1, IM<a name='696'>
        IF(DTV(I).LT.0..AND.HLINF(I).GE.-.5) THEN<a name='697'>
          HL1(I) = HLINF(I)<a name='698'>
          PM(I) = (A0 + A1 * HL1(I)) * HL1(I)                           &amp;<a name='699'>
     &amp;            / (1. + B1 * HL1(I) + B2 * HL1(I) * HL1(I))<a name='700'>
          PH(I) = (A0P + A1P * HL1(I)) * HL1(I)                         &amp;<a name='701'>
     &amp;            / (1. + B1P * HL1(I) + B2P * HL1(I) * HL1(I))<a name='702'>
          HL110 = HL1(I) * 10. / Z1(I)<a name='703'>
          PM10(I) = (A0 + A1 * HL110) * HL110                           &amp;<a name='704'>
     &amp;            / (1. + B1 * HL110 + B2 * HL110 * HL110)<a name='705'>
          HL12(I) = HL1(I) * 2. / Z1(I)<a name='706'>
          PH2(I) = (A0P + A1P * HL12(I)) * HL12(I)                      &amp;<a name='707'>
     &amp;            / (1. + B1P * HL12(I) + B2P * HL12(I) * HL12(I))<a name='708'>
        ENDIF<a name='709'>
        IF(DTV(I).LT.0.AND.HLINF(I).LT.-.5) THEN<a name='710'>
          HL1(I) = -HLINF(I)<a name='711'>
          PM(I) = LOG(HL1(I)) + 2. * HL1(I) ** (-.25) - .8776<a name='712'>
          PH(I) = LOG(HL1(I)) + .5 * HL1(I) ** (-.5) + 1.386<a name='713'>
          HL110 = HL1(I) * 10. / Z1(I)<a name='714'>
          PM10(I) = LOG(HL110) + 2. * HL110 ** (-.25) - .8776<a name='715'>
          HL12(I) = HL1(I) * 2. / Z1(I)<a name='716'>
          PH2(I) = LOG(HL12(I)) + .5 * HL12(I) ** (-.5) + 1.386<a name='717'>
        ENDIF<a name='718'>
      ENDDO<a name='719'>
<font color=#447700>!<a name='720'></font>
<font color=#447700>!  FINISH THE EXCHANGE COEFFICIENT COMPUTATION TO PROVIDE FM AND FH<a name='721'></font>
<font color=#447700>!<a name='722'></font>
      DO I = 1, IM<a name='723'>
<a name='724'>
        FM(I) = FM(I) - PM(I)<a name='725'>
        FH(I) = FH(I) - PH(I)<a name='726'>
        FM10(I) = FM10(I) - PM10(I)<a name='727'>
        FH2(I) = FH2(I) - PH2(I)<a name='728'>
        CM(I) = CA * CA / (FM(I) * FM(I))<a name='729'>
        CH(I) = CA * CA / (FM(I) * FH(I))<a name='730'>
        CQ = CH(I)<a name='731'>
        STRESS(I) = CM(I) * WIND(I) * WIND(I)<a name='732'>
        USTAR(I)  = SQRT(STRESS(I))<a name='733'>
<font color=#447700>!       USTAR(I) = SQRT(CM(I) * WIND(I) * WIND(I))<a name='734'></font>
      ENDDO<a name='735'>
<font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='736'></font>
<font color=#447700>!##DG    PRINT *, ' FM, FH, CM, CH(I), USTAR =',<a name='737'></font>
<font color=#447700>!##DG &amp;   FM, FH, CM, ch, USTAR<a name='738'></font>
<font color=#447700>!##DG  ENDIF<a name='739'></font>
<font color=#447700>!<a name='740'></font>
<font color=#447700>!  UPDATE Z0 OVER OCEAN<a name='741'></font>
<font color=#447700>!<a name='742'></font>
      DO I = 1, IM<a name='743'>
        IF(SLIMSK(I).EQ.0.) THEN<a name='744'>
          Z0(I) = (CHARNOCK / G) * USTAR(I) ** 2<a name='745'>
<font color=#447700>!  NEW IMPLEMENTATION OF Z0<a name='746'></font>
<font color=#447700>!         CC = USTAR(I) * Z0 / RNU<a name='747'></font>
<font color=#447700>!         PP = CC / (1. + CC)<a name='748'></font>
<font color=#447700>!         FF = G * ARNU / (CHARNOCK * USTAR(I) ** 3)<a name='749'></font>
<font color=#447700>!         Z0 = ARNU / (USTAR(I) * FF ** PP)<a name='750'></font>
          Z0(I) = MIN(Z0(I),.1_kind_phys)<a name='751'>
          Z0(I) = MAX(Z0(I),1.E-7_kind_phys)<a name='752'>
          Z0RL(I) = 100. * Z0(I)<a name='753'>
        ENDIF<a name='754'>
      ENDDO<a name='755'>
<a name='756'>
	  GOTO 5555<a name='757'>
<font color=#447700>!<a name='758'></font>
<font color=#447700>!  RCP = RHO CP CH V<a name='759'></font>
<font color=#447700>!<a name='760'></font>
      DO I = 1, IM<a name='761'>
        RCH(I) = RHO(I) * CP * CH(I) * WIND(I)<a name='762'>
      ENDDO<a name='763'>
<a name='764'>
<a name='765'>
<font color=#447700>!<a name='766'></font>
<font color=#447700>!  SENSIBLE AND LATENT HEAT FLUX OVER OPEN WATER<a name='767'></font>
<font color=#447700>!<a name='768'></font>
      DO I = 1, IM<a name='769'>
        IF(SLIMSK(I).EQ.0.) THEN<a name='770'>
          EVAP(I) = ELOCP * RCH(I) * (QSS(I) - Q1(I))<a name='771'>
          DM(I) = 1.<a name='772'>
          QSURF(I) = QSS(I)<a name='773'>
        ENDIF<a name='774'>
      ENDDO<a name='775'>
<a name='776'>
        <font color=#447700>!<a name='777'></font>
        <font color=#447700>!  COMPUTE SOIL/SNOW/ICE HEAT FLUX IN PREPARATION FOR SURFACE ENERGY<a name='778'></font>
        <font color=#447700>!  BALANCE CALCULATION<a name='779'></font>
        <font color=#447700>!<a name='780'></font>
	    DO I = 1, IM<a name='781'>
	      GFLUX(I) = 0.<a name='782'>
	      IF(SLIMSK(I).EQ.1.) THEN<a name='783'>
	        SMCZ(I) = .5 * (SMC(I,1) + .20)<a name='784'>
	        DFT0(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#KTSOIL'>KTSOIL</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KTSOIL_1">(SMCZ(I),SOILTYP(I))<a name='785'>
	      ELSEIF(SLIMSK(I).EQ.2.) THEN<a name='786'>
        <font color=#447700>!  DF FOR ICE IS TAKEN FROM MAYKUT AND UNTERSTEINER<a name='787'></font>
        <font color=#447700>!  DF IS IN SI UNIT OF W K-1 M-1<a name='788'></font>
	        DFT0(I) = 2.2<a name='789'>
	      ENDIF<a name='790'>
	    ENDDO<a name='791'>
        <font color=#447700>!!<a name='792'></font>
	    DO I=1,IM<a name='793'>
	      IF(SLIMSK(I).NE.0.) THEN<a name='794'>
        <font color=#447700>!         IF(SNOWD(I).GT..001) THEN<a name='795'></font>
	        IF(FLAGSNW(I)) THEN<a name='796'>
        <font color=#447700>!<a name='797'></font>
        <font color=#447700>!  WHEN SNOW COVERED, GROUND HEAT FLUX COMES FROM SNOW<a name='798'></font>
        <font color=#447700>!<a name='799'></font>
		TFLX = MIN(T1(I), TSURF(I))<a name='800'>
		GFLUX(I) = -DFSNOW * (TFLX - STSOIL(I,1))                   &amp;<a name='801'>
	   &amp;                 / (FACTSNW(I) * MAX(SNOWD(I),.001_kind_phys))<a name='802'>
	        ELSE<a name='803'>
		GFLUX(I) = DFT0(I) * (STSOIL(I,1) - TSURF(I))               &amp;<a name='804'>
	   &amp;                 / (-.5 * ZSOIL(I,1))<a name='805'>
	        ENDIF<a name='806'>
	        GFLUX(I) = MAX(GFLUX(I),-200._kind_phys)<a name='807'>
	        GFLUX(I) = MIN(GFLUX(I),+200._kind_phys)<a name='808'>
	      ENDIF<a name='809'>
	    ENDDO<a name='810'>
	    DO I = 1, IM<a name='811'>
	      FLAG(I) = SLIMSK(I).NE.0.<a name='812'>
	      PARTLND(I) = 1.<a name='813'>
	      IF(SNOWD(I).GT.0..AND.SNOWD(I).LE..001) THEN<a name='814'>
	        PARTLND(I) = 1. - SNOWD(I) / .001<a name='815'>
	      ENDIF<a name='816'>
	    ENDDO<a name='817'>
	    DO I = 1, IM<a name='818'>
	      SNOEVP(I) = 0.<a name='819'>
	      if(SNOWD(I).gt..001) PARTLND(I) = 0.<a name='820'>
	    ENDDO<a name='821'>
        <font color=#447700>!<a name='822'></font>
        <font color=#447700>!  COMPUTE POTENTIAL EVAPORATION FOR LAND AND SEA ICE<a name='823'></font>
        <font color=#447700>!<a name='824'></font>
	    DO I = 1, IM<a name='825'>
	      IF(FLAG(I)) THEN<a name='826'>
	        T12 = T1(I) * T1(I)<a name='827'>
	        T14 = T12 * T12<a name='828'>
        <font color=#447700>!<a name='829'></font>
        <font color=#447700>!  RCAP = FNET - SIGMA T**4 + GFLX - RHO CP CH V (T1-THETA1)<a name='830'></font>
        <font color=#447700>!<a name='831'></font>
	        RCAP(I) = -SLWD(I) - SIGMA * T14 + GFLUX(I)                   &amp;<a name='832'>
	   &amp;              - RCH(I) * (T1(I) - THETA1(I))<a name='833'>
        <font color=#447700>!<a name='834'></font>
        <font color=#447700>!  RSMALL = 4 SIGMA T**3 / RCH(I) + 1<a name='835'></font>
        <font color=#447700>!<a name='836'></font>
	        RSMALL(I) = 4. * SIGMA * T1(I) * T12 / RCH(I) + 1.<a name='837'>
        <font color=#447700>!<a name='838'></font>
        <font color=#447700>!  DELTA = L / CP * DQS/DT<a name='839'></font>
        <font color=#447700>!<a name='840'></font>
	        DELTA(I) = ELOCP * EPS * HVAP * QS1(I) / (RD * T12)<a name='841'>
        <font color=#447700>!<a name='842'></font>
        <font color=#447700>!  POTENTIAL EVAPOTRANSPIRATION ( WATTS / M**2 ) AND<a name='843'></font>
        <font color=#447700>!  POTENTIAL EVAPORATION<a name='844'></font>
        <font color=#447700>!<a name='845'></font>
	        TERM1(I) = ELOCP * RSMALL(I) * RCH(I)*(QS1(I)-Q0(I))<a name='846'>
	        TERM2(I) = RCAP(I) * DELTA(I)<a name='847'>
	        EP(I) = (ELOCP * RSMALL(I) * RCH(I) * (QS1(I) - Q0(I))        &amp;<a name='848'>
	   &amp;              + RCAP(I) * DELTA(I))<a name='849'>
	        EP(I) = EP(I) / (RSMALL(I) + DELTA(I))<a name='850'>
	      ENDIF<a name='851'>
	    ENDDO<a name='852'>
        <font color=#447700>!<a name='853'></font>
        <font color=#447700>!  ACTUAL EVAPORATION OVER LAND IN THREE PARTS : EDIR, ET, AND EC<a name='854'></font>
        <font color=#447700>!<a name='855'></font>
        <font color=#447700>!  DIRECT EVAPORATION FROM SOIL, THE UNIT GOES FROM M S-1 TO KG M-2 S-1<a name='856'></font>
        <font color=#447700>!<a name='857'></font>
	    DO I = 1, IM<a name='858'>
	      FLAG(I) = SLIMSK(I).EQ.1..AND.EP(I).GT.0.<a name='859'>
	    ENDDO<a name='860'>
	    DO I = 1, IM<a name='861'>
	      IF(FLAG(I)) THEN<a name='862'>
	        DF1(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#FUNCDF'>FUNCDF</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FUNCDF_1">(SMC(I,1),SOILTYP(I))<a name='863'>
	        KT1(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#FUNCKT'>FUNCKT</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FUNCKT_1">(SMC(I,1),SOILTYP(I))<a name='864'>
	      endif<a name='865'>
	      if(FLAG(I).and.STC(I,1).lt.t0c) then<a name='866'>
	        DF1(I) = 0.<a name='867'>
	        KT1(I) = 0.<a name='868'>
	      endif<a name='869'>
	      IF(FLAG(I)) THEN<a name='870'>
        <font color=#447700>!         TREF = .75 * THSAT(SOILTYP(I))<a name='871'></font>
	        TREF(I) = smref(SOILTYP(I))<a name='872'>
        <font color=#447700>!         TWILT = TWLT(SOILTYP(I))<a name='873'></font>
	        TWILT(I) = smwlt(SOILTYP(I))<a name='874'>
	        smcdry = smdry(SOILTYP(I))<a name='875'>
        <font color=#447700>!         FX(I) = -2. * DF1(I) * (SMC(I,1) - .23) / ZSOIL(I,1)<a name='876'></font>
        <font color=#447700>!    &amp;            - KT1(I)<a name='877'></font>
	        FX(I) = -2. * DF1(I) * (SMC(I,1) - smcdry) / ZSOIL(I,1)       &amp;<a name='878'>
	   &amp;            - KT1(I)<a name='879'>
	        FX(I) = MIN(FX(I), EP(I)/HVAP)<a name='880'>
	        FX(I) = MAX(FX(I),0._kind_phys)<a name='881'>
        <font color=#447700>!<a name='882'></font>
        <font color=#447700>!  SIGMAF IS THE FRACTION OF AREA COVERED BY VEGETATION<a name='883'></font>
        <font color=#447700>!<a name='884'></font>
	        EDIR(I) = FX(I) * (1. - SIGMAF(I)) * PARTLND(I)<a name='885'>
	      ENDIF<a name='886'>
	    ENDDO<a name='887'>
        <font color=#447700>!<a name='888'></font>
        <font color=#447700>!  calculate stomatal resistance<a name='889'></font>
        <font color=#447700>!<a name='890'></font>
	    DO I = 1, IM<a name='891'>
	      if(FLAG(I)) then<a name='892'>
        <font color=#447700>!<a name='893'></font>
        <font color=#447700>!  resistance due to PAR. We use net solar flux as proxy at the present time<a name='894'></font>
        <font color=#447700>!<a name='895'></font>
	        ff = .55 * 2. * SNET(I) / rgl(VEGTYPE(I))<a name='896'>
	        rcs = (ff + RS(I)/rsmax(VEGTYPE(I))) / (1. + ff)<a name='897'>
	        rcs = max(rcs,.0001_kind_phys)<a name='898'>
	        rct = 1.<a name='899'>
	        rcq = 1.<a name='900'>
        <font color=#447700>!<a name='901'></font>
        <font color=#447700>!  resistance due to thermal effect<a name='902'></font>
        <font color=#447700>!<a name='903'></font>
        <font color=#447700>!         rct = 1. - .0016 * (topt - theta1) ** 2<a name='904'></font>
        <font color=#447700>!         rct = max(rct,.0001)<a name='905'></font>
        <font color=#447700>!<a name='906'></font>
        <font color=#447700>!  resistance due to humidity<a name='907'></font>
        <font color=#447700>!<a name='908'></font>
        <font color=#447700>!         rcq = 1. / (1. + hs(VEGTYPE(I)) * (QS1(I) - Q0(I)))<a name='909'></font>
        <font color=#447700>!         rcq = max(rcq,.0001)<a name='910'></font>
        <font color=#447700>!<a name='911'></font>
        <font color=#447700>!  compute resistance without the effect of soil moisture<a name='912'></font>
        <font color=#447700>!<a name='913'></font>
	        RS(I) = RS(I) / (rcs * rct * rcq)<a name='914'>
	      endif<a name='915'>
	    ENDDO<a name='916'>
        <font color=#447700>!<a name='917'></font>
        <font color=#447700>!  TRANSPIRATION FROM ALL LEVELS OF THE SOIL<a name='918'></font>
        <font color=#447700>!<a name='919'></font>
	    DO I = 1, IM<a name='920'>
	      IF(FLAG(I)) THEN<a name='921'>
	        CANFAC(I) = (CANOPY(I) / SCANOP) ** CFACTR<a name='922'>
	      endif<a name='923'>
	      IF(FLAG(I)) THEN<a name='924'>
	        ETPFAC(I) = SIGMAF(I)                                         &amp;<a name='925'>
	   &amp;           * (1. - CANFAC(I)) / HVAP<a name='926'>
	        GX(I) = (SMC(I,1) - TWILT(I)) / (TREF(I) - TWILT(I))<a name='927'>
	        GX(I) = MAX(GX(I),0._kind_phys)<a name='928'>
	        GX(I) = MIN(GX(I),1._kind_phys)<a name='929'>
        <font color=#447700>!<a name='930'></font>
        <font color=#447700>!  resistance due to soil moisture deficit<a name='931'></font>
        <font color=#447700>!<a name='932'></font>
	        rss = GX(I) * (ZSOIL(I,1) / ZSOIL(I,km))<a name='933'>
	        rss = max(rss,.0001_kind_phys)<a name='934'>
	        RSI = RS(I) / rss<a name='935'>
        <font color=#447700>!<a name='936'></font>
        <font color=#447700>!  transpiration a la Monteith<a name='937'></font>
        <font color=#447700>!<a name='938'></font>
	        eth = (TERM1(I) + TERM2(I)) /                                 &amp;<a name='939'>
	   &amp;          (DELTA(I) + RSMALL(I) * (1. + RSI * CH(I) * WIND(I)))<a name='940'>
	        ET(I,1) = ETPFAC(I) * eth                                     &amp;<a name='941'>
	   &amp;            * PARTLND(I)<a name='942'>
	      ENDIF<a name='943'>
	    ENDDO<a name='944'>
        <font color=#447700>!!<a name='945'></font>
	    DO K = 2, KM<a name='946'>
	      DO I=1,IM<a name='947'>
	        IF(FLAG(I)) THEN<a name='948'>
		GX(I) = (SMC(I,K) - TWILT(I)) / (TREF(I) - TWILT(I))<a name='949'>
		GX(I) = MAX(GX(I),0._kind_phys)<a name='950'>
		GX(I) = MIN(GX(I),1._kind_phys)<a name='951'>
        <font color=#447700>!<a name='952'></font>
        <font color=#447700>!  resistance due to soil moisture deficit<a name='953'></font>
        <font color=#447700>!<a name='954'></font>
	        rss = GX(I) * ((ZSOIL(I,k) - ZSOIL(I,k-1))/ZSOIL(I,km))<a name='955'>
	        rss = max(rss,1.e-6_kind_phys)<a name='956'>
	        RSI = RS(I) / rss<a name='957'>
        <font color=#447700>!<a name='958'></font>
        <font color=#447700>!  transpiration a la Monteith<a name='959'></font>
        <font color=#447700>!<a name='960'></font>
	        eth = (TERM1(I) + TERM2(I)) /                                 &amp;<a name='961'>
	   &amp;          (DELTA(I) + RSMALL(I) * (1. + RSI * CH(I) * WIND(I)))<a name='962'>
		ET(I,K) = eth                                               &amp;<a name='963'>
	   &amp;               * ETPFAC(I) * PARTLND(I)<a name='964'>
	        ENDIF<a name='965'>
	      ENDDO<a name='966'>
	    ENDDO<a name='967'>
        <font color=#447700>!!<a name='968'></font>
         400  CONTINUE<a name='969'>
        <font color=#447700>!<a name='970'></font>
        <font color=#447700>!  CANOPY RE-EVAPORATION<a name='971'></font>
        <font color=#447700>!<a name='972'></font>
	    DO I=1,IM<a name='973'>
	      IF(FLAG(I)) THEN<a name='974'>
	        EC(I) = SIGMAF(I) * CANFAC(I) * EP(I) / HVAP<a name='975'>
	        EC(I) = EC(I) * PARTLND(I)<a name='976'>
	        EC(I) = min(EC(I),CANOPY(I)/delt)<a name='977'>
	      ENDIF<a name='978'>
	    ENDDO<a name='979'>
        <font color=#447700>!<a name='980'></font>
        <font color=#447700>!  SUM UP TOTAL EVAPORATION<a name='981'></font>
        <font color=#447700>!<a name='982'></font>
	    DO I = 1, IM<a name='983'>
	      IF(FLAG(I)) THEN<a name='984'>
	       EVAP(I) = EDIR(I) + EC(I)<a name='985'>
	      ENDIF<a name='986'>
	    ENDDO<a name='987'>
        <font color=#447700>!!<a name='988'></font>
	    DO K = 1, KM<a name='989'>
	      DO I=1,IM<a name='990'>
	        IF(FLAG(I)) THEN<a name='991'>
		EVAP(I) = EVAP(I) + ET(I,K)<a name='992'>
	        ENDIF<a name='993'>
	      ENDDO<a name='994'>
	    ENDDO<a name='995'>
        <font color=#447700>!!<a name='996'></font>
        <font color=#447700>!<a name='997'></font>
        <font color=#447700>!  RETURN EVAP UNIT FROM KG M-2 S-1 TO WATTS M-2<a name='998'></font>
        <font color=#447700>!<a name='999'></font>
	    DO I=1,IM<a name='1000'>
	      IF(FLAG(I)) THEN<a name='1001'>
	        EVAP(I) = MIN(EVAP(I)*HVAP,EP(I))<a name='1002'>
	      ENDIF<a name='1003'>
	    ENDDO<a name='1004'>
        <font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='1005'></font>
        <font color=#447700>!##DG    PRINT *, 'FX(I), SIGMAF, EDIR(I), ETPFAC=', FX(I)*HVAP,SIGMAF,<a name='1006'></font>
        <font color=#447700>!##DG&amp;          EDIR(I)*HVAP,ETPFAC*HVAP<a name='1007'></font>
        <font color=#447700>!##DG    PRINT *, ' ET =', (ET(K)*HVAP,K=1,KM)<a name='1008'></font>
        <font color=#447700>!##DG    PRINT *, ' CANFAC(I), EC(I), EVAP', CANFAC(I),EC(I)*HVAP,EVAP<a name='1009'></font>
        <font color=#447700>!##DG  ENDIF<a name='1010'></font>
        <font color=#447700>!<a name='1011'></font>
        <font color=#447700>!  EVAPORATION OVER BARE SEA ICE<a name='1012'></font>
        <font color=#447700>!<a name='1013'></font>
	    DO I = 1, IM<a name='1014'>
        <font color=#447700>!       IF(SLIMSK(I).EQ.2.AND.SNOWD(I).LE..001) THEN<a name='1015'></font>
	      IF(SLIMSK(I).EQ.2.) THEN<a name='1016'>
	        EVAP(I) = PARTLND(I) * EP(I)<a name='1017'>
	      ENDIF<a name='1018'>
	    ENDDO<a name='1019'>
        <font color=#447700>!<a name='1020'></font>
        <font color=#447700>!  TREAT DOWNWARD MOISTURE FLUX SITUATION<a name='1021'></font>
        <font color=#447700>!  (EVAP WAS PRESET TO ZERO SO NO UPDATE NEEDED)<a name='1022'></font>
        <font color=#447700>!  DEW IS CONVERTED FROM KG M-2 TO M TO CONFORM TO PRECIP UNIT<a name='1023'></font>
        <font color=#447700>!<a name='1024'></font>
	    DO I = 1, IM<a name='1025'>
	      FLAG(I) = SLIMSK(I).NE.0..AND.EP(I).LE.0.<a name='1026'>
	      DEW(I) = 0.<a name='1027'>
	    ENDDO<a name='1028'>
	    DO I = 1, IM<a name='1029'>
	      IF(FLAG(I)) THEN<a name='1030'>
	        DEW(I) = -EP(I) * DELT / (HVAP * RHOH2O)<a name='1031'>
	        EVAP(I) = EP(I)<a name='1032'>
	        DEW(I) = DEW(I) * PARTLND(I)<a name='1033'>
	        EVAP(I) = EVAP(I) * PARTLND(I)<a name='1034'>
	        DM(I) = 1.<a name='1035'>
	      ENDIF<a name='1036'>
	    ENDDO<a name='1037'>
        <font color=#447700>!<a name='1038'></font>
        <font color=#447700>!  SNOW COVERED LAND AND SEA ICE<a name='1039'></font>
        <font color=#447700>!<a name='1040'></font>
	    DO I = 1, IM<a name='1041'>
	      FLAG(I) = SLIMSK(I).NE.0..AND.SNOWD(I).GT.0.<a name='1042'>
	    ENDDO<a name='1043'>
        <font color=#447700>!<a name='1044'></font>
        <font color=#447700>!  CHANGE OF SNOW DEPTH DUE TO EVAPORATION OR SUBLIMATION<a name='1045'></font>
        <font color=#447700>!<a name='1046'></font>
        <font color=#447700>!  CONVERT EVAP FROM KG M-2 S-1 TO M S-1 TO DETERMINE THE REDUCTION OF S<a name='1047'></font>
        <font color=#447700>!<a name='1048'></font>
	    DO I = 1, IM<a name='1049'>
	      IF(FLAG(I)) THEN<a name='1050'>
	        BFACT = SNOWD(I) / (DELT * EP(I) / (HVAP * RHOH2O))<a name='1051'>
	        BFACT = MIN(BFACT,1._kind_phys)<a name='1052'>
        <font color=#447700>!<a name='1053'></font>
        <font color=#447700>!  THE EVAPORATION OF SNOW<a name='1054'></font>
        <font color=#447700>!<a name='1055'></font>
	        IF(EP(I).LE.0.) BFACT = 1.<a name='1056'>
	        IF(SNOWD(I).LE..001) THEN<a name='1057'>
        <font color=#447700>!           EVAP = (SNOWD(I)/.001)*BFACT*EP(I) + EVAP<a name='1058'></font>
        <font color=#447700>!           SNOEVP(I) = bfact * EP(I) * (1. - PARTLND(I))<a name='1059'></font>
        <font color=#447700>!           EVAP = EVAP + SNOEVP(I)<a name='1060'></font>
		SNOEVP(I) = bfact * EP(I)<a name='1061'>
        <font color=#447700>!           EVAP   = EVAP + SNOEVP(I) * (1. - PARTLND(I))<a name='1062'></font>
		EVAP(I)=EVAP(I)+SNOEVP(I)*(1.-PARTLND(I))<a name='1063'>
	        ELSE<a name='1064'>
        <font color=#447700>!           EVAP(I) = BFACT * EP(I)<a name='1065'></font>
		SNOEVP(I) = bfact * EP(I)<a name='1066'>
		EVAP(I) = SNOEVP(I)<a name='1067'>
	        ENDIF<a name='1068'>
	        TSURF(I) = T1(I) +                                            &amp;<a name='1069'>
	   &amp;          (RCAP(I) - GFLUX(I) - DFSNOW * (T1(I) - STSOIL(I,1))    &amp;<a name='1070'>
	   &amp;           /(FACTSNW(I) * MAX(SNOWD(I),.001_kind_phys))           &amp;<a name='1071'>
        <font color=#447700>!    &amp;           + THETA1 - T1                                          &amp;<a name='1072'></font>
        <font color=#447700>!    &amp;           - BFACT * EP(I)) / (RSMALL(I) * RCH(I)                 &amp;<a name='1073'></font>
	   &amp;           - SNOEVP(I)) / (RSMALL(I) * RCH(I)                     &amp;<a name='1074'>
	   &amp;           + DFSNOW / (FACTSNW(I)* MAX(SNOWD(I),.001_kind_phys)))<a name='1075'>
        <font color=#447700>!         SNOWD(I) = SNOWD(I) - BFACT * EP(I) * DELT / (RHOH2O * HVAP)<a name='1076'></font>
	        SNOWD(I) = SNOWD(I) - SNOEVP(I) * delt / (rhoh2o * hvap)<a name='1077'>
	        SNOWD(I) = MAX(SNOWD(I),0._kind_phys)<a name='1078'>
	      ENDIF<a name='1079'>
	    ENDDO<a name='1080'>
        <font color=#447700>!<a name='1081'></font>
        <font color=#447700>!  SNOW MELT (M)<a name='1082'></font>
        <font color=#447700>!<a name='1083'></font>
         500  CONTINUE<a name='1084'>
	    DO I = 1, IM<a name='1085'>
	      FLAG(I) = SLIMSK(I).NE.0.                                       &amp;<a name='1086'>
	   &amp;            .AND.SNOWD(I).GT..0<a name='1087'>
	    ENDDO<a name='1088'>
	    DO I = 1, IM<a name='1089'>
	      IF(FLAG(I).AND.TSURF(I).GT.T0C) THEN<a name='1090'>
	        SNOWMT(I) = RCH(I) * RSMALL(I) * DELT                         &amp;<a name='1091'>
	   &amp;              * (TSURF(I) - T0C) / (RHOH2O * HFUS)<a name='1092'>
	        SNOWMT(I) = min(SNOWMT(I),SNOWD(I))<a name='1093'>
	        SNOWD(I) = SNOWD(I) - SNOWMT(I)<a name='1094'>
	        SNOWD(I) = MAX(SNOWD(I),0._kind_phys)<a name='1095'>
	        TSURF(I) = MAX(T0C,TSURF(I)                                   &amp;<a name='1096'>
	   &amp;             -HFUS*SNOWMT(I)*RHOH2O/(RCH(I)*RSMALL(I)*DELT))<a name='1097'>
	      ENDIF<a name='1098'>
	    ENDDO<a name='1099'>
        <font color=#447700>!<a name='1100'></font>
        <font color=#447700>!  We need to re-evaluate evaporation because of snow melt<a name='1101'></font>
        <font color=#447700>!    the skin temperature is now bounded to 0 deg C<a name='1102'></font>
        <font color=#447700>!<a name='1103'></font>
        <font color=#447700>!     qss = fpvs(tsurf)<a name='1104'></font>
	    DO I = 1, IM<a name='1105'>
        <font color=#447700>!       IF (SNOWD(I) .GT. 0.0) THEN<a name='1106'></font>
	      IF (SNOWD(I) .GT. snomin) THEN<a name='1107'>
        <font color=#447700>!jfe      QSS(I) = 1000. * FPVS(TSURF(I))<a name='1108'></font>
	        qss(i) = <A href='../../html_code/phys/module_mp_wsm6.F.html#FPVS'>fpvs</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVS_9">(tsurf(i))<a name='1109'>
	        QSS(I) = EPS * QSS(I) / (PSURF(I) + EPSM1 * QSS(I))<a name='1110'>
	        EVAP(I) = elocp * RCH(I) * (QSS(I) - Q0(I))<a name='1111'>
	      ENDIF<a name='1112'>
	    ENDDO<a name='1113'>
        <font color=#447700>!<a name='1114'></font>
        <font color=#447700>!  PREPARE TENDENCY TERMS FOR THE SOIL MOISTURE FIELD WITHOUT PRECIPITAT<a name='1115'></font>
        <font color=#447700>!  THE UNIT OF MOISTURE FLUX NEEDS TO BECOME M S-1 FOR SOIL MOISTURE<a name='1116'></font>
        <font color=#447700>!   HENCE THE FACTOR OF RHOH2O<a name='1117'></font>
        <font color=#447700>!<a name='1118'></font>
	    DO I = 1, IM<a name='1119'>
	      FLAG(I) = SLIMSK(I).EQ.1.<a name='1120'>
	      if(FLAG(I)) then<a name='1121'>
	        DF1(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#FUNCDF'>FUNCDF</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FUNCDF_2">(SMCZ(I),SOILTYP(I))<a name='1122'>
	        KT1(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#FUNCKT'>FUNCKT</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FUNCKT_2">(SMCZ(I),SOILTYP(I))<a name='1123'>
	      endif<a name='1124'>
	      if(FLAG(I).and.STC(I,1).lt.t0c) then<a name='1125'>
	        DF1(I) = 0.<a name='1126'>
	        KT1(I) = 0.<a name='1127'>
	      endif<a name='1128'>
	      IF(FLAG(I)) THEN<a name='1129'>
	        RHSCNPY(I) = -EC(I) + SIGMAF(I) * RHOH2O * DEW(I) / DELT<a name='1130'>
	        SMCZ(I) = MAX(SMC(I,1), SMC(I,2))<a name='1131'>
	        DMDZ(I) = (SMC(I,1) - SMC(I,2)) / (-.5 * ZSOIL(I,2))<a name='1132'>
	        RHSMC(I,1) = (DF1(I) * DMDZ(I) + KT1(I)                       &amp;<a name='1133'>
	   &amp;        + (EDIR(I) + ET(I,1))) / (ZSOIL(I,1) * RHOH2O)<a name='1134'>
	        RHSMC(I,1) = RHSMC(I,1) - (1. - SIGMAF(I)) * DEW(I) /         &amp;<a name='1135'>
	   &amp;                 ( ZSOIL(I,1) * delt)<a name='1136'>
	        DDZ(I) = 1. / (-.5 * ZSOIL(I,2))<a name='1137'>
        <font color=#447700>!<a name='1138'></font>
        <font color=#447700>!  AIM, BIM, AND CIM ARE THE ELEMENTS OF THE TRIDIAGONAL MATRIX FOR THE<a name='1139'></font>
        <font color=#447700>!  IMPLICIT UPDATE OF THE SOIL MOISTURE<a name='1140'></font>
        <font color=#447700>!<a name='1141'></font>
	        AIM(I,1) = 0.<a name='1142'>
	        BIM(I,1) = DF1(I) * DDZ(I) / (-ZSOIL(I,1) * RHOH2O)<a name='1143'>
	        CIM(I,1) = -BIM(I,1)<a name='1144'>
	      ENDIF<a name='1145'>
	    ENDDO<a name='1146'>
        <font color=#447700>!!<a name='1147'></font>
	    DO K = 2, KM<a name='1148'>
	      IF(K.LT.KM) THEN<a name='1149'>
	        DO I=1,IM<a name='1150'>
		IF(FLAG(I)) THEN<a name='1151'>
		  DF2 = <A href='../../html_code/phys/module_sf_gfs.F.html#FUNCDF'>FUNCDF</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FUNCDF_3">(SMCZ(I),SOILTYP(I))<a name='1152'>
		  KT2(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#FUNCKT'>FUNCKT</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FUNCKT_3">(SMCZ(I),SOILTYP(I))<a name='1153'>
		ENDIF<a name='1154'>
		IF(FLAG(I).and.STC(I,k).lt.t0c) THEN<a name='1155'>
		  df2 = 0.<a name='1156'>
		  KT2(I) = 0.<a name='1157'>
		ENDIF<a name='1158'>
		IF(FLAG(I)) THEN<a name='1159'>
		  DMDZ2(I) = (SMC(I,K) - SMC(I,K+1))                        &amp;<a name='1160'>
	   &amp;                   / (.5 * (ZSOIL(I,K-1) - ZSOIL(I,K+1)))<a name='1161'>
		  SMCZ(I) = MAX(SMC(I,K), SMC(I,K+1))<a name='1162'>
		  RHSMC(I,K) = (DF2 * DMDZ2(I) + KT2(I)                     &amp;<a name='1163'>
	   &amp;             - DF1(I) * DMDZ(I) - KT1(I) + ET(I,K))               &amp;<a name='1164'>
	   &amp;                     / (RHOH2O*(ZSOIL(I,K) - ZSOIL(I,K-1)))<a name='1165'>
		  DDZ2(I) = 2. / (ZSOIL(I,K-1) - ZSOIL(I,K+1))<a name='1166'>
		  CIM(I,K) = -DF2 * DDZ2(I)                                 &amp;<a name='1167'>
	   &amp;                / ((ZSOIL(I,K-1) - ZSOIL(I,K))*RHOH2O)<a name='1168'>
		ENDIF<a name='1169'>
	        ENDDO<a name='1170'>
	      ELSE<a name='1171'>
	        DO I = 1, IM<a name='1172'>
		IF(FLAG(I)) THEN<a name='1173'>
		  KT2(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#FUNCKT'>FUNCKT</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FUNCKT_4">(SMC(I,K),SOILTYP(I))<a name='1174'>
		ENDIF<a name='1175'>
		if(FLAG(I).and.STC(I,k).lt.t0c) KT2(I) = 0.<a name='1176'>
		IF(FLAG(I)) THEN<a name='1177'>
		  RHSMC(I,K) = (KT2(I)                                      &amp;<a name='1178'>
	   &amp;             - DF1(I) * DMDZ(I) - KT1(I) + ET(I,K))               &amp;<a name='1179'>
	   &amp;                     / (RHOH2O*(ZSOIL(I,K) - ZSOIL(I,K-1)))<a name='1180'>
		  DRAIN(I) = KT2(I)<a name='1181'>
		  CIM(I,K) = 0.<a name='1182'>
		ENDIF<a name='1183'>
	        ENDDO<a name='1184'>
	      ENDIF<a name='1185'>
	      DO I = 1, IM<a name='1186'>
	        IF(FLAG(I)) THEN<a name='1187'>
		AIM(I,K) = -DF1(I) * DDZ(I)                                 &amp;<a name='1188'>
	   &amp;                / ((ZSOIL(I,K-1) - ZSOIL(I,K))*RHOH2O)<a name='1189'>
		BIM(I,K) = -(AIM(I,K) + CIM(I,K))<a name='1190'>
		DF1(I) = DF2<a name='1191'>
		KT1(I) = KT2(I)<a name='1192'>
		DMDZ(I) = DMDZ2(I)<a name='1193'>
		DDZ(I) = DDZ2(I)<a name='1194'>
	        ENDIF<a name='1195'>
	      ENDDO<a name='1196'>
	    ENDDO<a name='1197'>
        <font color=#447700>!!<a name='1198'></font>
         600  CONTINUE<a name='1199'>
        <font color=#447700>!<a name='1200'></font>
        <font color=#447700>!  UPDATE SOIL TEMPERATURE AND SEA ICE TEMPERATURE<a name='1201'></font>
        <font color=#447700>!<a name='1202'></font>
	    DO I=1,IM<a name='1203'>
	      FLAG(I) = SLIMSK(I).NE.0.<a name='1204'>
	    ENDDO<a name='1205'>
        <font color=#447700>!<a name='1206'></font>
        <font color=#447700>!  SURFACE TEMPERATURE IS PART OF THE UPDATE WHEN SNOW IS ABSENT<a name='1207'></font>
        <font color=#447700>!<a name='1208'></font>
	    DO I=1,IM<a name='1209'>
        <font color=#447700>!       IF(FLAG(I).AND.SNOWD(I).LE..001) THEN<a name='1210'></font>
	      IF(FLAG(I).AND..NOT.FLAGSNW(I)) THEN<a name='1211'>
	        YY(I) = T1(I) +                                               &amp;<a name='1212'>
        <font color=#447700>!    &amp;          (RCAP(I)-GFLUX(I) + THETA1 - T1(I)                      &amp;<a name='1213'></font>
	   &amp;          (RCAP(I)-GFLUX(I)                                       &amp;<a name='1214'>
	   &amp;           - EVAP(I)) / (RSMALL(I) * RCH(I))<a name='1215'>
	        ZZ(I) = 1. + DFT0(I) / (-.5 * ZSOIL(I,1) * RCH(I) * RSMALL(I))<a name='1216'>
	        XX(I) = DFT0(I) * (STSOIL(I,1) - YY(I)) /                     &amp;<a name='1217'>
	   &amp;            (.5 * ZSOIL(I,1) * ZZ(I))<a name='1218'>
	      ENDIF<a name='1219'>
        <font color=#447700>!       IF(FLAG(I).AND.SNOWD(I).GT..001) THEN<a name='1220'></font>
	      IF(FLAG(I).AND.FLAGSNW(I)) THEN<a name='1221'>
	        YY(I) = STSOIL(I,1)<a name='1222'>
        <font color=#447700>!<a name='1223'></font>
        <font color=#447700>!  HEAT FLUX FROM SNOW IS EXPLICIT IN TIME<a name='1224'></font>
        <font color=#447700>!<a name='1225'></font>
	        ZZ(I) = 1.<a name='1226'>
	        XX(I) = DFSNOW * (STSOIL(I,1) - TSURF(I))                     &amp;<a name='1227'>
	   &amp;            / (-FACTSNW(I) * MAX(SNOWD(I),.001_kind_phys))<a name='1228'>
	      ENDIF<a name='1229'>
	    ENDDO<a name='1230'>
        <font color=#447700>!<a name='1231'></font>
        <font color=#447700>!  COMPUTE THE FORCING AND THE IMPLICIT MATRIX ELEMENTS FOR UPDATE<a name='1232'></font>
        <font color=#447700>!<a name='1233'></font>
        <font color=#447700>!  CH2O IS THE HEAT CAPACITY OF WATER AND CSOIL IS THE HEAT CAPACITY OF<a name='1234'></font>
        <font color=#447700>!<a name='1235'></font>
	    DO I = 1, IM<a name='1236'>
	      IF(FLAG(I)) THEN<a name='1237'>
	        SMCZ(I) = MAX(SMC(I,1), SMC(I,2))<a name='1238'>
	        DTDZ1(I) = (STSOIL(I,1) - STSOIL(I,2)) / (-.5 * ZSOIL(I,2))<a name='1239'>
	        IF(SLIMSK(I).EQ.1.) THEN<a name='1240'>
		DFT1(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#KTSOIL'>KTSOIL</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KTSOIL_2">(SMCZ(I),SOILTYP(I))<a name='1241'>
		HCPCT(I) = SMC(I,1) * CH2O + (1. - SMC(I,1)) * CSOIL<a name='1242'>
	        ELSE<a name='1243'>
		DFT1(I) = DFT0(I)<a name='1244'>
		HCPCT(I) = CICE<a name='1245'>
	        ENDIF<a name='1246'>
	        DFT2(I) = DFT1(I)<a name='1247'>
	        DDZ(I) = 1. / (-.5 * ZSOIL(I,2))<a name='1248'>
        <font color=#447700>!<a name='1249'></font>
        <font color=#447700>!  AI, BI, AND CI ARE THE ELEMENTS OF THE TRIDIAGONAL MATRIX FOR THE<a name='1250'></font>
        <font color=#447700>!  IMPLICIT UPDATE OF THE SOIL TEMPERATURE<a name='1251'></font>
        <font color=#447700>!<a name='1252'></font>
	        AI(I,1) = 0.<a name='1253'>
	        BI(I,1) = DFT1(I) * DDZ(I) / (-ZSOIL(I,1) * HCPCT(I))<a name='1254'>
	        CI(I,1) = -BI(I,1)<a name='1255'>
	        BI(I,1) = BI(I,1)                                             &amp;<a name='1256'>
	   &amp;            + DFT0(I) / (.5 * ZSOIL(I,1) **2 * HCPCT(I) * ZZ(I))<a name='1257'>
        <font color=#447700>!         SS = DFT0(I) * (STSOIL(I,1) - YY(I))                          &amp;<a name='1258'></font>
        <font color=#447700>!    &amp;         / (.5 * ZSOIL(I,1) * ZZ(I))<a name='1259'></font>
        <font color=#447700>!         RHSTC(1) = (DFT1(I) * DTDZ1(I) - SS)<a name='1260'></font>
	        RHSTC(I,1) = (DFT1(I) * DTDZ1(I) - XX(I))                     &amp;<a name='1261'>
	   &amp;                 / (ZSOIL(I,1) * HCPCT(I))<a name='1262'>
	      ENDIF<a name='1263'>
	    ENDDO<a name='1264'>
        <font color=#447700>!!<a name='1265'></font>
	    DO K = 2, KM<a name='1266'>
	      DO I=1,IM<a name='1267'>
	        IF(SLIMSK(I).EQ.1.) THEN<a name='1268'>
		HCPCT(I) = SMC(I,K) * CH2O + (1. - SMC(I,K)) * CSOIL<a name='1269'>
	        ELSEIF(SLIMSK(I).EQ.2.) THEN<a name='1270'>
		HCPCT(I) = CICE<a name='1271'>
	        ENDIF<a name='1272'>
	      ENDDO<a name='1273'>
	      IF(K.LT.KM) THEN<a name='1274'>
	        DO I = 1, IM<a name='1275'>
		IF(FLAG(I)) THEN<a name='1276'>
		  DTDZ2(I) = (STSOIL(I,K) - STSOIL(I,K+1))                  &amp;<a name='1277'>
	   &amp;                   / (.5 * (ZSOIL(I,K-1) - ZSOIL(I,K+1)))<a name='1278'>
		  SMCZ(I) = MAX(SMC(I,K), SMC(I,K+1))<a name='1279'>
		  IF(SLIMSK(I).EQ.1.) THEN<a name='1280'>
		    DFT2(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#KTSOIL'>KTSOIL</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KTSOIL_3">(SMCZ(I),SOILTYP(I))<a name='1281'>
		  ENDIF<a name='1282'>
		  DDZ2(I) = 2. / (ZSOIL(I,K-1) - ZSOIL(I,K+1))<a name='1283'>
		  CI(I,K) = -DFT2(I) * DDZ2(I)                              &amp;<a name='1284'>
	   &amp;                / ((ZSOIL(I,K-1) - ZSOIL(I,K)) * HCPCT(I))<a name='1285'>
		ENDIF<a name='1286'>
	        ENDDO<a name='1287'>
	      ELSE<a name='1288'>
        <font color=#447700>!<a name='1289'></font>
        <font color=#447700>!  AT THE BOTTOM, CLIMATOLOGY IS ASSUMED AT 2M DEPTH FOR LAND AND<a name='1290'></font>
        <font color=#447700>!  FREEZING TEMPERATURE IS ASSUMED FOR SEA ICE AT Z(KM)<a name='1291'></font>
	        DO I = 1, IM<a name='1292'>
		IF(SLIMSK(I).EQ.1.) THEN<a name='1293'>
		  DTDZ2(I) = (STSOIL(I,K) - TG3(I))                         &amp;<a name='1294'>
	   &amp;              / (.5 * (ZSOIL(I,K-1) + ZSOIL(I,K)) - ZBOT)<a name='1295'>
		  DFT2(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#KTSOIL'>KTSOIL</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGTM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KTSOIL_4">(SMC(I,K),SOILTYP(I))<a name='1296'>
		  CI(I,K) = 0.<a name='1297'>
		ENDIF<a name='1298'>
		IF(SLIMSK(I).EQ.2.) THEN<a name='1299'>
		  DTDZ2(I) = (STSOIL(I,K) - TGICE)                          &amp;<a name='1300'>
	   &amp;                   / (.5 * ZSOIL(I,K-1) - .5 * ZSOIL(I,K))<a name='1301'>
		  DFT2(I) = DFT1(I)<a name='1302'>
		  CI(I,K) = 0.<a name='1303'>
		ENDIF<a name='1304'>
	        ENDDO<a name='1305'>
	      ENDIF<a name='1306'>
	      DO I = 1, IM<a name='1307'>
	        IF(FLAG(I)) THEN<a name='1308'>
		RHSTC(I,K) = (DFT2(I) * DTDZ2(I) - DFT1(I) * DTDZ1(I))      &amp;<a name='1309'>
	   &amp;                 / ((ZSOIL(I,K) - ZSOIL(I,K-1)) * HCPCT(I))<a name='1310'>
		AI(I,K) = -DFT1(I) * DDZ(I)                                 &amp;<a name='1311'>
	   &amp;                / ((ZSOIL(I,K-1) - ZSOIL(I,K)) * HCPCT(I))<a name='1312'>
		BI(I,K) = -(AI(I,K) + CI(I,K))<a name='1313'>
		DFT1(I) = DFT2(I)<a name='1314'>
		DTDZ1(I) = DTDZ2(I)<a name='1315'>
		DDZ(I) = DDZ2(I)<a name='1316'>
	        ENDIF<a name='1317'>
	      ENDDO<a name='1318'>
	    ENDDO<a name='1319'>
        <font color=#447700>!!<a name='1320'></font>
         700  CONTINUE<a name='1321'>
        <font color=#447700>!<a name='1322'></font>
        <font color=#447700>!  SOLVE THE TRI-DIAGONAL MATRIX<a name='1323'></font>
        <font color=#447700>!<a name='1324'></font>
	    DO K = 1, KM<a name='1325'>
	      DO I=1,IM<a name='1326'>
	        IF(FLAG(I))  THEN<a name='1327'>
		RHSTC(I,K) = RHSTC(I,K) * DELT2<a name='1328'>
		AI(I,K) = AI(I,K) * DELT2<a name='1329'>
		BI(I,K) = 1. + BI(I,K) * DELT2<a name='1330'>
		CI(I,K) = CI(I,K) * DELT2<a name='1331'>
	        ENDIF<a name='1332'>
	      ENDDO<a name='1333'>
	    ENDDO<a name='1334'>
        <font color=#447700>!  FORWARD ELIMINATION<a name='1335'></font>
	    DO I=1,IM<a name='1336'>
	      IF(FLAG(I)) THEN<a name='1337'>
	        CI(I,1) = -CI(I,1) / BI(I,1)<a name='1338'>
	        RHSTC(I,1) = RHSTC(I,1) / BI(I,1)<a name='1339'>
	      ENDIF<a name='1340'>
	    ENDDO<a name='1341'>
        <font color=#447700>!!<a name='1342'></font>
	    DO K = 2, KM<a name='1343'>
	      DO I=1,IM<a name='1344'>
	        IF(FLAG(I)) THEN<a name='1345'>
		CC = 1. / (BI(I,K) + AI(I,K) * CI(I,K-1))<a name='1346'>
		CI(I,K) = -CI(I,K) * CC<a name='1347'>
		RHSTC(I,K) = (RHSTC(I,K) - AI(I,K) * RHSTC(I,K-1)) * CC<a name='1348'>
	        ENDIF<a name='1349'>
	      ENDDO<a name='1350'>
	    ENDDO<a name='1351'>
        <font color=#447700>!!<a name='1352'></font>
        <font color=#447700>!  BACKWARD SUBSTITUTTION<a name='1353'></font>
	    DO I=1,IM<a name='1354'>
	      IF(FLAG(I)) THEN<a name='1355'>
	        CI(I,KM) = RHSTC(I,KM)<a name='1356'>
	      ENDIF<a name='1357'>
	    ENDDO<a name='1358'>
        <font color=#447700>!!<a name='1359'></font>
	    DO K = KM-1, 1<a name='1360'>
	      DO I=1,IM<a name='1361'>
	        IF(FLAG(I)) THEN<a name='1362'>
		CI(I,K) = CI(I,K) * CI(I,K+1) + RHSTC(I,K)<a name='1363'>
	        ENDIF<a name='1364'>
	      ENDDO<a name='1365'>
	    ENDDO<a name='1366'>
        <font color=#447700>!<a name='1367'></font>
        <font color=#447700>!  UPDATE SOIL AND ICE TEMPERATURE<a name='1368'></font>
        <font color=#447700>!<a name='1369'></font>
	    DO K = 1, KM<a name='1370'>
	      DO I=1,IM<a name='1371'>
	        IF(FLAG(I)) THEN<a name='1372'>
		STSOIL(I,K) = STSOIL(I,K) + CI(I,K)<a name='1373'>
	        ENDIF<a name='1374'>
	      ENDDO<a name='1375'>
	    ENDDO<a name='1376'>
        <font color=#447700>!<a name='1377'></font>
        <font color=#447700>!  UPDATE SURFACE TEMPERATURE FOR SNOW FREE SURFACES<a name='1378'></font>
        <font color=#447700>!<a name='1379'></font>
	    DO I=1,IM<a name='1380'>
        <font color=#447700>!       IF(SLIMSK(I).NE.0..AND.SNOWD(I).LE..001) THEN<a name='1381'></font>
	      IF(SLIMSK(I).NE.0..AND..NOT.FLAGSNW(I)) THEN<a name='1382'>
	        TSURF(I) = (YY(I) + (ZZ(I) - 1.) * STSOIL(I,1)) / ZZ(I)<a name='1383'>
	      ENDIF<a name='1384'>
        <font color=#447700>!       IF(SLIMSK(I).EQ.2..AND.SNOWD(I).LE..001) THEN<a name='1385'></font>
	      IF(SLIMSK(I).EQ.2..AND..NOT.FLAGSNW(I)) THEN<a name='1386'>
	        TSURF(I) = MIN(TSURF(I),T0C)<a name='1387'>
	      ENDIF<a name='1388'>
	    ENDDO<a name='1389'>
        <font color=#447700>!!<a name='1390'></font>
	    DO K = 1, KM<a name='1391'>
	      DO I=1,IM<a name='1392'>
	        IF(SLIMSK(I).EQ.2) THEN<a name='1393'>
		STSOIL(I,K) = MIN(STSOIL(I,K),T0C)<a name='1394'>
	        ENDIF<a name='1395'>
	      ENDDO<a name='1396'>
	    ENDDO<a name='1397'>
        <font color=#447700>!<a name='1398'></font>
        <font color=#447700>!  TIME FILTER FOR SOIL AND SKIN TEMPERATURE<a name='1399'></font>
        <font color=#447700>!<a name='1400'></font>
	    DO I=1,IM<a name='1401'>
	      IF(SLIMSK(I).NE.0.) THEN<a name='1402'>
	        TSKIN(I) = CTFIL1 * TSURF(I) + CTFIL2 * TSKIN(I)<a name='1403'>
	      ENDIF<a name='1404'>
	    ENDDO<a name='1405'>
	    DO K = 1, KM<a name='1406'>
	      DO I=1,IM<a name='1407'>
	        IF(SLIMSK(I).NE.0.) THEN<a name='1408'>
		STC(I,K) = CTFIL1 * STSOIL(I,K) + CTFIL2 * STC(I,K)<a name='1409'>
	        ENDIF<a name='1410'>
	      ENDDO<a name='1411'>
	    ENDDO<a name='1412'>
        <font color=#447700>!<a name='1413'></font>
        <font color=#447700>!  GFLUX CALCULATION<a name='1414'></font>
        <font color=#447700>!<a name='1415'></font>
	    DO I=1,IM<a name='1416'>
	      FLAG(I) = SLIMSK(I).NE.0.                                       &amp;<a name='1417'>
        <font color=#447700>!    &amp;            .AND.SNOWD(I).GT..001                                 &amp;<a name='1418'></font>
	   &amp;            .AND.FLAGSNW(I)<a name='1419'>
	    ENDDO<a name='1420'>
	    DO I = 1, IM<a name='1421'>
	      IF(FLAG(I)) THEN<a name='1422'>
	        GFLUX(I) = -DFSNOW * (TSKIN(I) - STC(I,1))                    &amp;<a name='1423'>
	   &amp;               / (FACTSNW(I) * MAX(SNOWD(I),.001_kind_phys))<a name='1424'>
	      ENDIF<a name='1425'>
	    ENDDO<a name='1426'>
	    DO I = 1, IM<a name='1427'>
        <font color=#447700>!       IF(SLIMSK(I).NE.0..AND.SNOWD(I).LE..001) THEN<a name='1428'></font>
	      IF( SLIMSK(I).NE.0..AND..NOT.FLAGSNW(I)) THEN<a name='1429'>
	        GFLUX(I) = DFT0(I) * (STC(I,1) - TSKIN(I))                    &amp;<a name='1430'>
	   &amp;               / (-.5 * ZSOIL(I,1))<a name='1431'>
	      ENDIF<a name='1432'>
	    ENDDO<a name='1433'>
<a name='1434'>
<a name='1435'>
5555  CONTINUE<a name='1436'>
<a name='1437'>
        <font color=#447700>!<a name='1438'></font>
        <font color=#447700>!  CALCULATE SENSIBLE HEAT FLUX<a name='1439'></font>
        <font color=#447700>!<a name='1440'></font>
<font color=#447700>!WRF	    DO I = 1, IM<a name='1441'></font>
<font color=#447700>!WRF      HFLX(I) = RCH(I) * (TSKIN(I) - THETA1(I))<a name='1442'></font>
<font color=#447700>!WRF	    ENDDO<a name='1443'></font>
        <font color=#447700>!<a name='1444'></font>
        <font color=#447700>!  THE REST OF THE OUTPUT<a name='1445'></font>
        <font color=#447700>!<a name='1446'></font>
<font color=#447700>!WRF	    DO I = 1, IM<a name='1447'></font>
<font color=#447700>!WRF	      QSURF(I) = Q1(I) + EVAP(I) / (ELOCP * RCH(I))<a name='1448'></font>
<font color=#447700>!WRF	      DM(I) = 1.<a name='1449'></font>
        <font color=#447700>!<a name='1450'></font>
        <font color=#447700>!  CONVERT SNOW DEPTH BACK TO MM OF WATER EQUIVALENT<a name='1451'></font>
        <font color=#447700>!<a name='1452'></font>
<font color=#447700>!WRF	      SHELEG(I) = SNOWD(I) * 1000.<a name='1453'></font>
<font color=#447700>!WRF	    ENDDO<a name='1454'></font>
        <font color=#447700>!<a name='1455'></font>
<a name='1456'>
      DO I = 1, IM<a name='1457'>
        F10M(I) = FM10(I) / FM(I)<a name='1458'>
        F10M(I) = min(F10M(I),1._kind_phys)<a name='1459'>
        U10M(I) = F10M(I) * XRCL(I) * U1(I)<a name='1460'>
        V10M(I) = F10M(I) * XRCL(I) * V1(I)<a name='1461'>
<font color=#447700>!WRF         T2M(I) = TSKIN(I) * (1. - FH2(I) / FH(I))                      &amp;<a name='1462'></font>
<font color=#447700>!WRF     &amp;          + THETA1(I) * FH2(I) / FH(I)<a name='1463'></font>
<font color=#447700>!WRF         T2M(I) = T2M(I) * SIG2K<a name='1464'></font>
<font color=#447700>!        Q2M(I) = QSURF(I) * (1. - FH2(I) / FH(I))                      &amp;<a name='1465'></font>
<font color=#447700>!    &amp;         + Q1(I) * FH2(I) / FH(I)<a name='1466'></font>
<font color=#447700>!       T2M(I) = T1<a name='1467'></font>
<font color=#447700>!       Q2M(I) = Q1<a name='1468'></font>
<font color=#447700>!WRF        IF(EVAP(I).GE.0.) THEN<a name='1469'></font>
<font color=#447700>!<a name='1470'></font>
<font color=#447700>!  IN CASE OF EVAPORATION, USE THE INFERRED QSURF TO DEDUCE Q2M<a name='1471'></font>
<font color=#447700>!<a name='1472'></font>
<font color=#447700>!WRF          Q2M(I) = QSURF(I) * (1. - FH2(I) / FH(I))                     &amp;<a name='1473'></font>
<font color=#447700>!WRF     &amp;         + Q1(I) * FH2(I) / FH(I)<a name='1474'></font>
<font color=#447700>!WRF        ELSE<a name='1475'></font>
<font color=#447700>!<a name='1476'></font>
<font color=#447700>!  FOR DEW FORMATION SITUATION, USE SATURATED Q AT TSKIN<a name='1477'></font>
<font color=#447700>!<a name='1478'></font>
<font color=#447700>!jfe      QSS(I) = 1000. * FPVS(TSKIN(I))<a name='1479'></font>
<font color=#447700>!WRF          qss(I) = fpvs(tskin(I))<a name='1480'></font>
<font color=#447700>!WRF          QSS(I) = EPS * QSS(I) / (PSURF(I) + EPSM1 * QSS(I))<a name='1481'></font>
<font color=#447700>!WRF          Q2M(I) = QSS(I) * (1. - FH2(I) / FH(I))                       &amp;<a name='1482'></font>
<font color=#447700>!WRF     &amp;         + Q1(I) * FH2(I) / FH(I)<a name='1483'></font>
<font color=#447700>!WRF        ENDIF<a name='1484'></font>
<font color=#447700>!jfe    QSS(I) = 1000. * FPVS(T2M(I))<a name='1485'></font>
<font color=#447700>!WRF        QSS(I) = fpvs(t2m(I))<a name='1486'></font>
<font color=#447700>!       QSS(I) = 1000. * T2MO(I)<a name='1487'></font>
<font color=#447700>!WRF        QSS(I) = EPS * QSS(I) / (PSURF(I) + EPSM1 * QSS(I))<a name='1488'></font>
<font color=#447700>!WRF        Q2M(I) = MIN(Q2M(I),QSS(I))<a name='1489'></font>
      ENDDO<a name='1490'>
<font color=#447700>!!<a name='1491'></font>
<font color=#447700>!     DO I = 1, IM<a name='1492'></font>
<font color=#447700>!       RNET(I) = -SLWD(I) - SIGMA * TSKIN(I) **4<a name='1493'></font>
<font color=#447700>!     ENDDO<a name='1494'></font>
<font color=#447700>!!<a name='1495'></font>
<font color=#447700>!<a name='1496'></font>
<font color=#447700>!WRF      do i=1,im<a name='1497'></font>
<font color=#447700>!WRF        tem     = 1.0 / rho(i)<a name='1498'></font>
<font color=#447700>!WRF        hflx(i) = hflx(i) * tem * cpinv<a name='1499'></font>
<font color=#447700>!WRF        evap(i) = evap(i) * tem * hvapi<a name='1500'></font>
<font color=#447700>!WRF      enddo<a name='1501'></font>
<a name='1502'>
<a name='1503'>
<font color=#447700>!<a name='1504'></font>
<font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='1505'></font>
<font color=#447700>!C       RBAL = -SLWD-SIGMA*TSKIN**4+GFLUX<a name='1506'></font>
<font color=#447700>!C    &amp;         -EVAP - HFLX<a name='1507'></font>
<font color=#447700>!##DG    PRINT 6000,HFLX,EVAP,GFLUX,<a name='1508'></font>
<font color=#447700>!##DG&amp;             STC(1), STC(2),TSKIN,RNET,SLWD<a name='1509'></font>
<font color=#447700>!##DG    PRINT *, ' T1 =', T1<a name='1510'></font>
 6000 FORMAT(8(F8.2,','))<a name='1511'>
<font color=#447700>!C     PRINT *, ' EP, ETP,T2M(I) =', EP, ETP,T2M(I)<a name='1512'></font>
<font color=#447700>!C     PRINT *, ' FH, FH2 =', FH, FH2<a name='1513'></font>
<font color=#447700>!C     PRINT *, ' PH, PH2 =', PH, PH2<a name='1514'></font>
<font color=#447700>!C     PRINT *, ' CH, RCH =', CH, RCH<a name='1515'></font>
<font color=#447700>!C     PRINT *, ' TERM1, TERM2 =', TERM1, TERM2<a name='1516'></font>
<font color=#447700>!C     PRINT *, ' RS(I), PLANTR =', RS(I), PLANTR<a name='1517'></font>
<font color=#447700>!##DG  ENDIF<a name='1518'></font>
<a name='1519'>
      RETURN<a name='1520'>
      END SUBROUTINE PROGTM<a name='1521'>
<font color=#447700>!<a name='1522'></font>
<font color=#447700>!  PROGT2 IS THE SECOND PART OF THE SOIL MODEL THAT IS EXECUTED<a name='1523'></font>
<font color=#447700>!  AFTER PRECIPITATION FOR THE TIME STEP HAS BEEN CALCULATED<a name='1524'></font>
<font color=#447700>!<a name='1525'></font>
<font color=#447700>!FPP$ NOCONCUR R<a name='1526'></font>
<font color=#447700>!FPP$ EXPAND(FUNCDF,FUNCKT,THSAT)<a name='1527'></font>
<A NAME='PROGT2'><A href='../../html_code/phys/module_sf_gfs.F.html#PROGT2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1528'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>PROGT2</font>(IM,KM,RHSCNPY,                                  &amp;,<A href='../../call_from/PROGT2.html' TARGET='index'>2</A><a name='1529'>
     &amp;                  RHSMC,AI,BI,CI,SMC,SLIMSK,                      &amp;<a name='1530'>
     &amp;                  CANOPY,PRECIP,RUNOFF,SNOWMT,                    &amp;<a name='1531'>
     &amp;                  ZSOIL,SOILTYP,SIGMAF,DELT,me)<a name='1532'>
<font color=#447700>!c<a name='1533'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_34">     , ONLY : kind_phys<a name='1534'>
      implicit none<a name='1535'>
      integer              km, IM, me<a name='1536'>
      real(kind=kind_phys) delt<a name='1537'>
      real(kind=kind_phys) RHSCNPY(IM),  RHSMC(IM,KM), AI(IM,KM),       &amp;<a name='1538'>
     &amp;                     BI(IM,KM),    CI(IM,KM),    SMC(IM,KM),      &amp;<a name='1539'>
     &amp;                     SLIMSK(IM),   CANOPY(IM),   PRECIP(IM),      &amp;<a name='1540'>
     &amp;                     RUNOFF(IM),   SNOWMT(IM),   ZSOIL(IM,KM),    &amp;<a name='1541'>
     &amp;                     SIGMAF(IM)<a name='1542'>
      INTEGER SOILTYP(IM)<a name='1543'>
<font color=#447700>!<a name='1544'></font>
      integer              k, lond, i<a name='1545'>
      real(kind=kind_phys) CNPY(IM), PRCP(IM),   TSAT(IM),              &amp;<a name='1546'>
     &amp;                     INF(IM),  INFMAX(IM), SMSOIL(IM,KM)<a name='1547'>
<font color=#447700>!<a name='1548'></font>
      real(kind=kind_phys) cc,    ctfil1, ctfil2, delt2,                &amp;<a name='1549'>
     &amp;                     drip,  rffact, rhoh2o,                       &amp;<a name='1550'>
<font color=#447700>!WRF     &amp;                     rzero, scanop, tdif, thsat, KSAT<a name='1551'></font>
     &amp;                     rzero, scanop, tdif, KSAT<a name='1552'>
<font color=#447700>!<a name='1553'></font>
      LOGICAL FLAG(IM)<a name='1554'>
<font color=#447700>!c<a name='1555'></font>
      PARAMETER (SCANOP=.5, RHOH2O=1000.)<a name='1556'>
      PARAMETER (CTFIL1=.5, CTFIL2=1.-CTFIL1)<a name='1557'>
<font color=#447700>!     PARAMETER (CTFIL1=1., CTFIL2=1.-CTFIL1)<a name='1558'></font>
      PARAMETER (RFFACT=.15)<a name='1559'>
<font color=#447700>!<a name='1560'></font>
<font color=#447700>!##DG LATD = 44<a name='1561'></font>
      LOND = 353<a name='1562'>
      DELT2 = DELT * 2.<a name='1563'>
<font color=#447700>!<a name='1564'></font>
<font color=#447700>!  PRECIPITATION RATE IS NEEDED IN UNIT OF KG M-2 S-1<a name='1565'></font>
<font color=#447700>!<a name='1566'></font>
      DO I=1,IM<a name='1567'>
        PRCP(I) = RHOH2O * (PRECIP(I)+SNOWMT(I)) / DELT<a name='1568'>
        RUNOFF(I) = 0.<a name='1569'>
        CNPY(I) = CANOPY(I)<a name='1570'>
      ENDDO<a name='1571'>
<font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='1572'></font>
<font color=#447700>!##DG    PRINT *, ' BEFORE RUNOFF CAL, RHSMC =', RHSMC(1)<a name='1573'></font>
<font color=#447700>!##DG  ENDIF<a name='1574'></font>
<font color=#447700>!<a name='1575'></font>
<font color=#447700>!  UPDATE CANOPY WATER CONTENT<a name='1576'></font>
<font color=#447700>!<a name='1577'></font>
      DO I=1,IM<a name='1578'>
        IF(SLIMSK(I).EQ.1.) THEN<a name='1579'>
          RHSCNPY(I) = RHSCNPY(I) + SIGMAF(I) * PRCP(I)<a name='1580'>
          CANOPY(I) = CANOPY(I) + DELT * RHSCNPY(I)<a name='1581'>
          CANOPY(I) = MAX(CANOPY(I),0._kind_phys)<a name='1582'>
          PRCP(I) = PRCP(I) * (1. - SIGMAF(I))<a name='1583'>
          IF(CANOPY(I).GT.SCANOP) THEN<a name='1584'>
            DRIP = CANOPY(I) - SCANOP<a name='1585'>
            CANOPY(I) = SCANOP<a name='1586'>
            PRCP(I) = PRCP(I) + DRIP / DELT<a name='1587'>
          ENDIF<a name='1588'>
<font color=#447700>!<a name='1589'></font>
<font color=#447700>!  CALCULATE INFILTRATION RATE<a name='1590'></font>
<font color=#447700>!<a name='1591'></font>
          INF(I) = PRCP(I)<a name='1592'>
          TSAT(I) = <A href='../../html_code/phys/module_sf_gfs.F.html#THSAT'>THSAT</A><A href='../../html_code/phys/module_sf_gfs.F.html#PROGT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THSAT_1">(SOILTYP(I))<a name='1593'>
<font color=#447700>!         DSAT = FUNCDF(TSAT(I),SOILTYP(I))<a name='1594'></font>
<font color=#447700>!         KSAT = FUNCKT(TSAT(I),SOILTYP(I))<a name='1595'></font>
<font color=#447700>!         INFMAX(I) = -DSAT * (TSAT(I) - SMC(I,1))<a name='1596'></font>
<font color=#447700>!    &amp;                / (.5 * ZSOIL(I,1))                               &amp;<a name='1597'></font>
<font color=#447700>!    &amp;                + KSAT<a name='1598'></font>
          INFMAX(I) = (-ZSOIL(I,1)) *                                   &amp;<a name='1599'>
     &amp;                ((TSAT(I) - SMC(I,1)) / DELT - RHSMC(I,1))        &amp;<a name='1600'>
     &amp;                * RHOH2O<a name='1601'>
          INFMAX(I) = MAX(RFFACT*INFMAX(I),0._kind_phys)<a name='1602'>
<font color=#447700>!         IF(SMC(I,1).GE.TSAT(I)) INFMAX(I) = KSAT<a name='1603'></font>
<font color=#447700>!         IF(SMC(I,1).GE.TSAT(I)) INFMAX(I) = ZSOIL(I,1) * RHSMC(I,1)<a name='1604'></font>
          IF(INF(I).GT.INFMAX(I)) THEN<a name='1605'>
            RUNOFF(I) = INF(I) - INFMAX(I)<a name='1606'>
            INF(I) = INFMAX(I)<a name='1607'>
          ENDIF<a name='1608'>
          INF(I) = INF(I) / RHOH2O<a name='1609'>
          RHSMC(I,1) = RHSMC(I,1) - INF(I) / ZSOIL(I,1)<a name='1610'>
        ENDIF<a name='1611'>
      ENDDO<a name='1612'>
<font color=#447700>!!<a name='1613'></font>
<font color=#447700>!##DG  IF(LAT.EQ.LATD) THEN<a name='1614'></font>
<font color=#447700>!##DG    PRINT *, ' PRCP(I), INFMAX(I), RUNOFF =', PRCP(I),INFMAX(I),RUNOFF<a name='1615'></font>
<font color=#447700>!##DG    PRINT *, ' SMSOIL =', SMC(1), SMC(2)<a name='1616'></font>
<font color=#447700>!##DG    PRINT *, ' RHSMC =', RHSMC(1)<a name='1617'></font>
<font color=#447700>!##DG  ENDIF<a name='1618'></font>
<font color=#447700>!<a name='1619'></font>
<font color=#447700>!  WE CURRENTLY IGNORE THE EFFECT OF RAIN ON SEA ICE<a name='1620'></font>
<font color=#447700>!<a name='1621'></font>
      DO I=1,IM<a name='1622'>
        FLAG(I) = SLIMSK(I).EQ.1.<a name='1623'>
      ENDDO<a name='1624'>
<font color=#447700>!!<a name='1625'></font>
<font color=#447700>!<a name='1626'></font>
<font color=#447700>!  SOLVE THE TRI-DIAGONAL MATRIX<a name='1627'></font>
<font color=#447700>!<a name='1628'></font>
      DO K = 1, KM<a name='1629'>
        DO I=1,IM<a name='1630'>
          IF(FLAG(I))  THEN<a name='1631'>
            RHSMC(I,K) = RHSMC(I,K) * DELT2<a name='1632'>
            AI(I,K) = AI(I,K) * DELT2<a name='1633'>
            BI(I,K) = 1. + BI(I,K) * DELT2<a name='1634'>
            CI(I,K) = CI(I,K) * DELT2<a name='1635'>
          ENDIF<a name='1636'>
        ENDDO<a name='1637'>
      ENDDO<a name='1638'>
<font color=#447700>!  FORWARD ELIMINATION<a name='1639'></font>
      DO I=1,IM<a name='1640'>
        IF(FLAG(I)) THEN<a name='1641'>
          CI(I,1) = -CI(I,1) / BI(I,1)<a name='1642'>
          RHSMC(I,1) = RHSMC(I,1) / BI(I,1)<a name='1643'>
        ENDIF<a name='1644'>
      ENDDO<a name='1645'>
      DO K = 2, KM<a name='1646'>
        DO I=1,IM<a name='1647'>
          IF(FLAG(I)) THEN<a name='1648'>
            CC = 1. / (BI(I,K) + AI(I,K) * CI(I,K-1))<a name='1649'>
            CI(I,K) = -CI(I,K) * CC<a name='1650'>
            RHSMC(I,K)=(RHSMC(I,K)-AI(I,K)*RHSMC(I,K-1))*CC<a name='1651'>
          ENDIF<a name='1652'>
        ENDDO<a name='1653'>
      ENDDO<a name='1654'>
<font color=#447700>!  BACKWARD SUBSTITUTTION<a name='1655'></font>
      DO I=1,IM<a name='1656'>
        IF(FLAG(I)) THEN<a name='1657'>
          CI(I,KM) = RHSMC(I,KM)<a name='1658'>
        ENDIF<a name='1659'>
      ENDDO<a name='1660'>
<font color=#447700>!!<a name='1661'></font>
      DO K = KM-1, 1<a name='1662'>
        DO I=1,IM<a name='1663'>
          IF(FLAG(I)) THEN<a name='1664'>
            CI(I,K) = CI(I,K) * CI(I,K+1) + RHSMC(I,K)<a name='1665'>
          ENDIF<a name='1666'>
        ENDDO<a name='1667'>
      ENDDO<a name='1668'>
 100  CONTINUE<a name='1669'>
<font color=#447700>!<a name='1670'></font>
<font color=#447700>!  UPDATE SOIL MOISTURE<a name='1671'></font>
<font color=#447700>!<a name='1672'></font>
      DO K = 1, KM<a name='1673'>
        DO I=1,IM<a name='1674'>
          IF(FLAG(I)) THEN<a name='1675'>
            SMSOIL(I,K) = SMC(I,K) + CI(I,K)<a name='1676'>
            SMSOIL(I,K) = MAX(SMSOIL(I,K),0._kind_phys)<a name='1677'>
            TDIF = MAX(SMSOIL(I,K) - TSAT(I),0._kind_phys)<a name='1678'>
            RUNOFF(I) = RUNOFF(I) -                                     &amp;<a name='1679'>
     &amp;                RHOH2O * TDIF * ZSOIL(I,K) / DELT<a name='1680'>
            SMSOIL(I,K) = SMSOIL(I,K) - TDIF<a name='1681'>
          ENDIF<a name='1682'>
        ENDDO<a name='1683'>
      ENDDO<a name='1684'>
      DO K = 1, KM<a name='1685'>
        DO I=1,IM<a name='1686'>
          IF(FLAG(I)) THEN<a name='1687'>
            SMC(I,K) = CTFIL1 * SMSOIL(I,K) + CTFIL2 * SMC(I,K)<a name='1688'>
          ENDIF<a name='1689'>
        ENDDO<a name='1690'>
      ENDDO<a name='1691'>
<font color=#447700>!       IF(FLAG(I)) THEN<a name='1692'></font>
<font color=#447700>!         CANOPY(I) = CTFIL1 * CANOPY(I) + CTFIL2 * CNPY(I)<a name='1693'></font>
<font color=#447700>!       ENDIF<a name='1694'></font>
<font color=#447700>!     I = 1<a name='1695'></font>
<font color=#447700>!     PRINT *, ' SMC'<a name='1696'></font>
<font color=#447700>!     PRINT 6000, SMC(1), SMC(2)<a name='1697'></font>
<font color=#447700>!6000 FORMAT(2(F8.5,','))<a name='1698'></font>
      RETURN<a name='1699'>
      END SUBROUTINE PROGT2<a name='1700'>
<A NAME='KTSOIL'><A href='../../html_code/phys/module_sf_gfs.F.html#KTSOIL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1701'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>KTSOIL</font>(THETA,KTYPE) <A href='../../call_to/KTSOIL.html' TARGET='index'>4</A>,<A href='../../call_from/KTSOIL.html' TARGET='index'>2</A><a name='1702'>
<font color=#447700>!<a name='1703'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_sf_gfs.F.html#KTSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_35">     , ONLY : kind_phys<a name='1704'>
      USE <A href='../../html_code/phys/module_progtm.F.html#MODULE_PROGTM'>module_progtm</A><A href='../../html_code/phys/module_sf_gfs.F.html#KTSOIL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PROGTM_1"> , ONLY : TSAT, DFKT<a name='1705'>
      implicit none<a name='1706'>
      integer              ktype,kw<a name='1707'>
      real(kind=kind_phys) ktsoil, theta, w<a name='1708'>
<font color=#447700>!<a name='1709'></font>
      W = (THETA / TSAT(KTYPE)) * 20. + 1.<a name='1710'>
      KW = W<a name='1711'>
      KW = MIN(KW,21)<a name='1712'>
      KW = MAX(KW,1)<a name='1713'>
      KTSOIL = DFKT(KW,KTYPE)                                           &amp;<a name='1714'>
     &amp;         + (W - KW) * (DFKT(KW+1,KTYPE) - DFKT(KW,KTYPE))<a name='1715'>
      RETURN<a name='1716'>
      END FUNCTION KTSOIL<a name='1717'>
<A NAME='FUNCDF'><A href='../../html_code/phys/module_sf_gfs.F.html#FUNCDF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1718'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>FUNCDF</font>(THETA,KTYPE) <A href='../../call_to/FUNCDF.html' TARGET='index'>3</A>,<A href='../../call_from/FUNCDF.html' TARGET='index'>2</A><a name='1719'>
<font color=#447700>!<a name='1720'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_sf_gfs.F.html#FUNCDF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_36">     , ONLY : kind_phys<a name='1721'>
      USE <A href='../../html_code/phys/module_progtm.F.html#MODULE_PROGTM'>module_progtm</A><A href='../../html_code/phys/module_sf_gfs.F.html#FUNCDF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PROGTM_2"> , ONLY : TSAT, DFK<a name='1722'>
      implicit none<a name='1723'>
      integer              ktype,kw<a name='1724'>
      real(kind=kind_phys) funcdf,theta,w<a name='1725'>
<font color=#447700>!<a name='1726'></font>
      W = (THETA / TSAT(KTYPE)) * 20. + 1.<a name='1727'>
      KW = W<a name='1728'>
      KW = MIN(KW,21)<a name='1729'>
      KW = MAX(KW,1)<a name='1730'>
      FUNCDF = DFK(KW,KTYPE)                                            &amp;<a name='1731'>
     &amp;         + (W - KW) * (DFK(KW+1,KTYPE) - DFK(KW,KTYPE))<a name='1732'>
      RETURN<a name='1733'>
      END FUNCTION FUNCDF<a name='1734'>
<A NAME='FUNCKT'><A href='../../html_code/phys/module_sf_gfs.F.html#FUNCKT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1735'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>FUNCKT</font>(THETA,KTYPE) <A href='../../call_to/FUNCKT.html' TARGET='index'>4</A>,<A href='../../call_from/FUNCKT.html' TARGET='index'>2</A><a name='1736'>
<font color=#447700>!<a name='1737'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_sf_gfs.F.html#FUNCKT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_37">     , ONLY : kind_phys<a name='1738'>
      USE <A href='../../html_code/phys/module_progtm.F.html#MODULE_PROGTM'>module_progtm</A><A href='../../html_code/phys/module_sf_gfs.F.html#FUNCKT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PROGTM_3"> , ONLY : TSAT, KTK<a name='1739'>
      implicit none<a name='1740'>
      integer             ktype,kw<a name='1741'>
      real(kind=kind_phys) funckt,theta,w<a name='1742'>
<font color=#447700>!<a name='1743'></font>
      W = (THETA / TSAT(KTYPE)) * 20. + 1.<a name='1744'>
      KW = W<a name='1745'>
      KW = MIN(KW,21)<a name='1746'>
      KW = MAX(KW,1)<a name='1747'>
      FUNCKT = KTK(KW,KTYPE)                                            &amp;<a name='1748'>
     &amp;         + (W - KW) * (KTK(KW+1,KTYPE) - KTK(KW,KTYPE))<a name='1749'>
      RETURN<a name='1750'>
      END FUNCTION FUNCKT<a name='1751'>
<A NAME='THSAT'><A href='../../html_code/phys/module_sf_gfs.F.html#THSAT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1752'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>THSAT</font>(KTYPE) <A href='../../call_to/THSAT.html' TARGET='index'>1</A>,<A href='../../call_from/THSAT.html' TARGET='index'>2</A><a name='1753'>
<font color=#447700>!<a name='1754'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_sf_gfs.F.html#THSAT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_38">     , ONLY : kind_phys<a name='1755'>
      USE <A href='../../html_code/phys/module_progtm.F.html#MODULE_PROGTM'>module_progtm</A><A href='../../html_code/phys/module_sf_gfs.F.html#THSAT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PROGTM_4"> , ONLY : TSAT<a name='1756'>
      implicit none<a name='1757'>
      integer             ktype<a name='1758'>
      real(kind=kind_phys) thsat<a name='1759'>
<font color=#447700>!<a name='1760'></font>
      THSAT = TSAT(KTYPE)<a name='1761'>
      RETURN<a name='1762'>
      END FUNCTION THSAT<a name='1763'>
<A NAME='TWLT'><A href='../../html_code/phys/module_sf_gfs.F.html#TWLT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1764'>
      <font color=#993300>FUNCTION </font><font color=#cc0000>TWLT</font>(KTYPE),<A href='../../call_from/TWLT.html' TARGET='index'>1</A><a name='1765'>
<a name='1766'>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_sf_gfs.F.html#TWLT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_39">     , ONLY : kind_phys<a name='1767'>
<font color=#447700>!     USE module_progtm<a name='1768'></font>
      implicit none<a name='1769'>
      integer              ktype<a name='1770'>
      real(kind=kind_phys) twlt<a name='1771'>
<font color=#447700>!<a name='1772'></font>
      TWLT = .1<a name='1773'>
      RETURN<a name='1774'>
      END FUNCTION TWLT<a name='1775'>
<a name='1776'>
 END MODULE module_sf_gfs<a name='1777'>
</pre></body></html>