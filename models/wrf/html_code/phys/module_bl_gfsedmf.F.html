<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!LWRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_BL_GFSEDMF'><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MODULE_BL_GFSEDMF' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_bl_gfsedmf</font> <A href='../../call_to/MODULE_BL_GFSEDMF.html' TARGET='index'>2</A><a name='5'>
<a name='6'>
#if (HWRF==1)<a name='7'>
<a name='8'>
CONTAINS<a name='9'>
<a name='10'>
<font color=#447700>!-------------------------------------------------------------------          <a name='11'></font>
<A NAME='BL_GFSEDMF'><A href='../../html_code/phys/module_bl_gfsedmf.F.html#BL_GFSEDMF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>BL_GFSEDMF</font>(U3D,V3D,TH3D,T3D,QV3D,QC3D,QI3D,P3D,PI3D, &amp; <A href='../../call_to/BL_GFSEDMF.html' TARGET='index'>1</A>,<A href='../../call_from/BL_GFSEDMF.html' TARGET='index'>2</A><a name='13'>
                  RUBLTEN,RVBLTEN,RTHBLTEN,                        &amp;<a name='14'>
                  RQVBLTEN,RQCBLTEN,RQIBLTEN,          	           &amp; <a name='15'>
                  CP,G,ROVCP,R,ROVG,P_QI,P_FIRST_SCALAR,           &amp;<a name='16'>
                  dz8w,z,PSFC,                                     &amp;<a name='17'>
                  UST,PBL,PSIM,PSIH,                               &amp;<a name='18'>
                  HFX,QFX,TSK,GZ1OZ0,WSPD,BR,                      &amp;<a name='19'>
                  DT,KPBL2D,EP1,KARMAN,                            &amp;<a name='20'>
                  DISHEAT,                                         &amp;<a name='21'>
                  RTHRATEN,                                        &amp;    <font color=#447700>!Kwon add RTHRATEN <a name='22'></font>
                  HPBL2D, EVAP2D, HEAT2D,                          &amp;    <font color=#447700>!Kwon add FOR SHAL. CON.<a name='23'></font>
<a name='24'>
                  U10,V10,ZNT,                                    &amp;<a name='25'>
                  DKU3D,DKT3D,                                    &amp; <a name='26'>
                  VAR_RIC,coef_ric_l,coef_ric_s,alpha,xland,        &amp;<a name='27'>
                  ids,ide, jds,jde, kds,kde,                       &amp;<a name='28'>
                  ims,ime, jms,jme, kms,kme,                       &amp;<a name='29'>
                  its,ite, jts,jte, kts,kte                        )<a name='30'>
<font color=#447700>!--------------------------------------------------------------------<a name='31'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#BL_GFSEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_6"> , ONLY : kind_phys<a name='32'>
<font color=#447700>!      USE MODULE_GFS_FUNCPHYS, only : fpvs<a name='33'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='34'></font>
      IMPLICIT NONE<a name='35'>
<font color=#447700>!-------------------------------------------------------------------<a name='36'></font>
<font color=#447700>!-- U3D         3D u-velocity interpolated to theta points (m/s)<a name='37'></font>
<font color=#447700>!-- V3D         3D v-velocity interpolated to theta points (m/s)<a name='38'></font>
<font color=#447700>!-- TH3D	3D potential temperature (K)<a name='39'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='40'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='41'></font>
<font color=#447700>!-- QC3D        3D cloud mixing ratio (Kg/Kg)<a name='42'></font>
<font color=#447700>!-- QI3D        3D ice mixing ratio (Kg/Kg)<a name='43'></font>
<font color=#447700>!-- P3D         3D pressure (Pa)<a name='44'></font>
<font color=#447700>!-- PI3D	3D exner function (dimensionless)<a name='45'></font>
<font color=#447700>!-- rr3D	3D dry air density (kg/m^3)<a name='46'></font>
<font color=#447700>!-- RUBLTEN     U tendency due to<a name='47'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='48'></font>
<font color=#447700>!-- RVBLTEN     V tendency due to<a name='49'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='50'></font>
<font color=#447700>!-- RTHBLTEN    Theta tendency due to<a name='51'></font>
<font color=#447700>!               PBL parameterization (K/s)<a name='52'></font>
<font color=#447700>!-- RQVBLTEN    Qv tendency due to<a name='53'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='54'></font>
<font color=#447700>!-- RQCBLTEN    Qc tendency due to<a name='55'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='56'></font>
<font color=#447700>!-- RQIBLTEN    Qi tendency due to<a name='57'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='58'></font>
<font color=#447700>!-- CP          heat capacity at constant pressure for dry air (J/kg/K)<a name='59'></font>
<font color=#447700>!-- G           acceleration due to gravity (m/s^2)<a name='60'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='61'></font>
<font color=#447700>!-- R           gas constant for dry air (J/kg/K)<a name='62'></font>
<font color=#447700>!-- ROVG 	R/G<a name='63'></font>
<font color=#447700>!-- P_QI	species index for cloud ice<a name='64'></font>
<font color=#447700>!-- dz8w	dz between full levels (m)<a name='65'></font>
<font color=#447700>!-- z		height above sea level (m)<a name='66'></font>
<font color=#447700>!-- PSFC        pressure at the surface (Pa)<a name='67'></font>
<font color=#447700>!-- UST		u* in similarity theory (m/s)<a name='68'></font>
<font color=#447700>!-- PBL		PBL height (m)<a name='69'></font>
<font color=#447700>!-- PSIM        similarity stability function for momentum<a name='70'></font>
<font color=#447700>!-- PSIH        similarity stability function for heat<a name='71'></font>
<font color=#447700>!-- HFX		upward heat flux at the surface (W/m^2)<a name='72'></font>
<font color=#447700>!-- QFX		upward moisture flux at the surface (kg/m^2/s)<a name='73'></font>
<font color=#447700>!-- TSK		surface temperature (K)<a name='74'></font>
<font color=#447700>!-- GZ1OZ0      log(z/z0) where z0 is roughness length<a name='75'></font>
<font color=#447700>!-- WSPD        wind speed at lowest model level (m/s)<a name='76'></font>
<font color=#447700>!-- BR          bulk Richardson number in surface layer<a name='77'></font>
<font color=#447700>!-- DT		time step (s)<a name='78'></font>
<font color=#447700>!-- rvovrd      R_v divided by R_d (dimensionless)<a name='79'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (R_v/R_d - 1) (dimensionless)<a name='80'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='81'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='82'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='83'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='84'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='85'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='86'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='87'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='88'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='89'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='90'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='91'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='92'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='93'></font>
<font color=#447700>!-- its         start index for i in tile<a name='94'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='95'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='96'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='97'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='98'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='99'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='100'></font>
<a name='101'>
      INTEGER, INTENT(IN) ::            ids,ide, jds,jde, kds,kde,      &amp;<a name='102'>
                                        ims,ime, jms,jme, kms,kme,      &amp;<a name='103'>
                                        its,ite, jts,jte, kts,kte,      &amp;<a name='104'>
                                        P_QI,P_FIRST_SCALAR<a name='105'>
<a name='106'>
#if (NMM_CORE==1)<a name='107'>
      LOGICAL , INTENT(IN)::            DISHEAT                                    <font color=#447700>!gopal's doing<a name='108'></font>
#endif<a name='109'>
      REAL,  DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) ::  RTHRATEN         <font color=#447700>!Kwon<a name='110'></font>
      REAL,  DIMENSION(ims:ime, jms:jme), INTENT(OUT) ::              &amp;<a name='111'>
                                        HPBL2D,                         &amp;    <font color=#447700>!ADDED BY KWON FOR SHALLOW CONV.<a name='112'></font>
                                        EVAP2D,                         &amp;    <font color=#447700>!ADDED BY KWON FOR SHALLOW CONV.<a name='113'></font>
                                        HEAT2D                               <font color=#447700>!ADDED BY KWON FOR SHALLOW CONV.<a name='114'></font>
<a name='115'>
<a name='116'>
<font color=#447700>!wang<a name='117'></font>
       REAL,  DIMENSION(ims:ime, jms:jme), INTENT(IN) ::              &amp;<a name='118'>
                                         U10,                         &amp;<a name='119'>
                                         V10,                   &amp;<a name='120'>
                                         ZNT, xland<a name='121'>
<a name='122'>
       REAL,  DIMENSION(ims:ime, jms:jme, kms:kme), INTENT(OUT) :: DKU3D,DKT3D<a name='123'>
<font color=#447700>!wang<a name='124'></font>
<a name='125'>
      REAL,    INTENT(IN) ::                                            &amp;<a name='126'>
                                        CP,                             &amp;<a name='127'>
                                        DT,                             &amp;<a name='128'>
                                        EP1,                            &amp;<a name='129'>
                                        G,                              &amp;<a name='130'>
                                        KARMAN,                         &amp;<a name='131'>
                                        R,                              &amp; <a name='132'>
                                        ROVCP,                          &amp;<a name='133'>
                                        ROVG <a name='134'>
<a name='135'>
      REAL,    DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) ::      &amp; <a name='136'>
                                        DZ8W,                           &amp;<a name='137'>
                                        P3D,                            &amp;<a name='138'>
                                        PI3D,                           &amp;<a name='139'>
                                        QC3D,                           &amp;<a name='140'>
                                        QI3D,                           &amp;<a name='141'>
                                        QV3D,                           &amp;<a name='142'>
                                        T3D,                            &amp;<a name='143'>
                                        TH3D,                           &amp;<a name='144'>
                                        U3D,                            &amp;<a name='145'>
                                        V3D,                            &amp;<a name='146'>
                                        Z   <a name='147'>
<a name='148'>
<a name='149'>
      REAL,    DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) ::   &amp;<a name='150'>
                                        RTHBLTEN,                       &amp;<a name='151'>
                                        RQCBLTEN,                       &amp;<a name='152'>
                                        RQIBLTEN,                       &amp;<a name='153'>
                                        RQVBLTEN,                       &amp;<a name='154'>
                                        RUBLTEN,                        &amp;<a name='155'>
                                        RVBLTEN                        <a name='156'>
<a name='157'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(IN) ::               &amp;<a name='158'>
                                        BR,                             &amp;<a name='159'>
                                        GZ1OZ0,                         &amp;<a name='160'>
                                        HFX,                            &amp;<a name='161'>
                                        PSFC,                           &amp;<a name='162'>
                                        PSIM,                           &amp;<a name='163'>
                                        PSIH,                           &amp;<a name='164'>
                                        QFX,                            &amp;<a name='165'>
                                        TSK<a name='166'>
 <a name='167'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(INOUT) ::            &amp; <a name='168'>
                                        PBL,                            &amp;<a name='169'>
                                        UST,                            &amp;<a name='170'>
                                        WSPD<a name='171'>
<a name='172'>
      INTEGER, DIMENSION(ims:ime, jms:jme), INTENT(OUT) ::              &amp;<a name='173'>
                                        KPBL2D                         <a name='174'>
<a name='175'>
<a name='176'>
<font color=#447700>!--------------------------- LOCAL VARS ------------------------------<a name='177'></font>
<a name='178'>
<a name='179'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte) ::         &amp;<a name='180'>
                                        DEL,                            &amp;<a name='181'>
                                        DU,                             &amp;<a name='182'>
                                        DV,                             &amp;<a name='183'>
                                        PHIL,                           &amp;<a name='184'>
                                        PRSL,                           &amp;<a name='185'>
                                        PRSLK,                          &amp;<a name='186'>
                                        T1,                             &amp;<a name='187'>
                                        TAU,                            &amp;<a name='188'>
                                        dishx,                          &amp;<a name='189'>
                                        THRATEN,                        &amp; <font color=#447700>!Kwon<a name='190'></font>
                                        U1,                             &amp;<a name='191'>
                                        V1<a name='192'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte-1) ::DKU,DKT<a name='193'>
<a name='194'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte+1) ::       &amp;<a name='195'>
                                        PHII,                           &amp; <a name='196'>
                                        PRSI<a name='197'>
<a name='198'>
      REAL     (kind=kind_phys), DIMENSION(its:ite, kts:kte, 3) ::      &amp;<a name='199'>
                                        Q1,                             &amp;<a name='200'>
                                        RTG<a name='201'>
<a name='202'>
      REAL     (kind=kind_phys), DIMENSION(its:ite) ::                  &amp;<a name='203'>
                                        DQSFC,                          &amp;<a name='204'>
                                        DTSFC,                          &amp;<a name='205'>
                                        DUSFC,                          &amp;<a name='206'>
                                        DVSFC,                          &amp;<a name='207'>
                                        EVAP,                           &amp;<a name='208'>
                                        FH,                             &amp;<a name='209'>
                                        FM,                             &amp;<a name='210'>
                                        HEAT,                           &amp;<a name='211'>
                                        HGAMQ,                          &amp;<a name='212'>
                                        HGAMT,                          &amp;<a name='213'>
                                        HPBL,                           &amp;<a name='214'>
                                        PSK,                            &amp;<a name='215'>
                                        QSS,                            &amp;<a name='216'>
                                        RBSOIL,                         &amp;<a name='217'>
                                        RCL,                            &amp;<a name='218'>
                                        SPD1,                           &amp;<a name='219'>
                                        STRESS,                         &amp;<a name='220'>
                                        TSEA,      &amp;<a name='221'>
                                        zorl,u10m,v10m,zol, xland1<a name='222'>
<a name='223'>
      REAL     (kind=kind_phys) ::                                      &amp;<a name='224'>
                                        CPM,                            &amp;<a name='225'>
                                        cpmikj,                         &amp;<a name='226'>
                                        DELTIM,                         &amp;<a name='227'>
                                        FMTMP,                          &amp;<a name='228'>
                                        RRHOX<a name='229'>
<a name='230'>
      INTEGER, DIMENSION( its:ite ) ::                                  &amp;<a name='231'>
                                        KPBL , kinver<a name='232'>
<a name='233'>
      INTEGER ::                                                        &amp;<a name='234'>
                                        I,                              &amp;<a name='235'>
                                        IM,                             &amp;<a name='236'>
                                        J,                              &amp;<a name='237'>
                                        K,                              &amp;<a name='238'>
                                        KM,                             &amp;<a name='239'>
                                        KTEM,                           &amp;<a name='240'>
                                        KTEP,                           &amp;<a name='241'>
                                        KX,                             &amp;<a name='242'>
                                        L,                              &amp; <a name='243'>
                                        NTRAC, ntcw<a name='244'>
<a name='245'>
      real(kind=kind_phys)xkzm_m, xkzm_h, xkzm_s   <font color=#447700>!! wang, background diff <a name='246'></font>
      real :: VAR_RIC,coef_ric_l,coef_ric_s,alpha<a name='247'>
      logical lprnt<a name='248'>
      integer ipr<a name='249'>
<a name='250'>
 <a name='251'>
   IM=ITE-ITS+1<a name='252'>
   KX=KTE-KTS+1<a name='253'>
   KTEM=KTE-1<a name='254'>
   KTEP=KTE+1<a name='255'>
   NTRAC=2<a name='256'>
   DELTIM=DT<a name='257'>
<a name='258'>
   xkzm_m=1.0<a name='259'>
   xkzm_h=1.0<a name='260'>
   xkzm_s=1.0   <a name='261'>
   lprnt=.false.<a name='262'>
   ipr=1<a name='263'>
   ntcw=2<a name='264'>
<a name='265'>
<font color=#447700>!    write(0,*)'in gfsedmf PBL'<a name='266'></font>
<a name='267'>
   IF (P_QI.ge.P_FIRST_SCALAR) NTRAC=3<a name='268'>
<a name='269'>
 <font color=#447700>!! note 2015,08-19, if we consider rain water, then ntrac=4, and set q1(i,k,4)=QR<a name='270'></font>
 <font color=#447700>!! here, we do not consider rain water<a name='271'></font>
<a name='272'>
   DO J=jts,jte<a name='273'>
<a name='274'>
      DO i=its,ite<a name='275'>
        RRHOX=(R*T3D(I,KTS,J)*(1.+EP1*QV3D(I,KTS,J)))/PSFC(I,J)<a name='276'>
        CPM=CP*(1.+0.8*QV3D(i,kts,j))<a name='277'>
        FMTMP=GZ1OZ0(i,j)-PSIM(i,j)<a name='278'>
        PSK(i)=(PSFC(i,j)*.00001)**ROVCP<a name='279'>
        FM(i)=FMTMP<a name='280'>
        FH(i)=GZ1OZ0(i,j)-PSIH(i,j)<a name='281'>
        TSEA(i)=TSK(i,j)<a name='282'>
        QSS(i)=QV3D(i,kts,j)               <font color=#447700>! not used in moninq so set to qv3d for now<a name='283'></font>
        HEAT(i)=HFX(i,j)/CPM*RRHOX<a name='284'>
        EVAP(i)=QFX(i,j)*RRHOX<a name='285'>
<font color=#447700>! Kwon FOR NEW SHALLOW CONVECTION <a name='286'></font>
        HEAT2D(i,j)=HFX(i,j)/CPM*RRHOX<a name='287'>
        EVAP2D(i,j)=QFX(i,j)*RRHOX<a name='288'>
<font color=#447700>!<a name='289'></font>
        STRESS(i)=KARMAN*KARMAN*WSPD(i,j)*WSPD(i,j)/(FMTMP*FMTMP)<a name='290'>
        SPD1(i)=WSPD(i,j)<a name='291'>
        PRSI(i,kts)=PSFC(i,j)*.001<a name='292'>
        PHII(I,kts)=0.<a name='293'>
        RCL(i)=1.<a name='294'>
        RBSOIL(I)=BR(i,j)<a name='295'>
        zorl(i)=znt(i,j) * 100.0  <font color=#447700>! m to cm<a name='296'></font>
        u10m(i)=u10(i,j)<a name='297'>
        v10m(i)=v10(i,j)<a name='298'>
        xland1(i)=xland(i,j)<a name='299'>
        kinver(i)=kx<a name='300'>
      ENDDO<a name='301'>
<a name='302'>
      DO k=kts,kte<a name='303'>
        DO i=its,ite <a name='304'>
          DV(I,K) = 0.<a name='305'>
          DU(I,K) = 0.<a name='306'>
          TAU(I,K) = 0.<a name='307'>
          U1(I,K) = U3D(i,k,j)<a name='308'>
          V1(I,K) = V3D(i,k,j)<a name='309'>
          T1(I,K) = T3D(i,k,j)<a name='310'>
#ifdef NMM_CORE<a name='311'>
          THRATEN(I,K) = RTHRATEN(I,K,J)  <font color=#447700>!! * 0.0  !!! test , removing additional diffusion<a name='312'></font>
#else<a name='313'>
          THRATEN(I,K) = 0.0<a name='314'>
#endif<a name='315'>
          Q1(I,K,1) = QV3D(i,k,j)/(1.+QV3D(i,k,j))<a name='316'>
          Q1(I,K,2) = QC3D(i,k,j)/(1.+QC3D(i,k,j))<a name='317'>
          PRSL(I,K)=P3D(i,k,j)*.001<a name='318'>
        ENDDO<a name='319'>
      ENDDO<a name='320'>
<a name='321'>
      DO k=kts,kte<a name='322'>
        DO i=its,ite <a name='323'>
          PRSLK(I,K)=(PRSL(i,k)*.01)**ROVCP<a name='324'>
        ENDDO<a name='325'>
      ENDDO<a name='326'>
<a name='327'>
<a name='328'>
      DO k=kts+1,kte<a name='329'>
        km=k-1<a name='330'>
        DO i=its,ite <a name='331'>
          DEL(i,km)=PRSL(i,km)/ROVG*dz8w(i,km,j)/T3D(i,km,j)<a name='332'>
          PRSI(i,k)=PRSI(i,km)-DEL(i,km)<a name='333'>
          PHII(I,K)=(Z(i,k,j)-Z(i,kts,j))*G<a name='334'>
          PHIL(I,KM)=0.5*(Z(i,k,j)+Z(i,km,j)-2.*Z(i,kts,j))*G<a name='335'>
        ENDDO<a name='336'>
      ENDDO<a name='337'>
<a name='338'>
      DO i=its,ite <a name='339'>
        DEL(i,kte)=DEL(i,ktem)<a name='340'>
        PRSI(i,ktep)=PRSI(i,kte)-DEL(i,ktem)<a name='341'>
        PHII(I,KTEP)=PHII(I,KTE)+dz8w(i,kte,j)*G<a name='342'>
        PHIL(I,KTE)=PHII(I,KTE)-PHIL(I,KTEM)+PHII(I,KTE)<a name='343'>
      ENDDO<a name='344'>
<a name='345'>
      IF (P_QI.ge.P_FIRST_SCALAR) THEN<a name='346'>
        DO k=kts,kte<a name='347'>
          DO i=its,ite <a name='348'>
            Q1(I,K,3) = QI3D(i,k,j)/(1.+QI3D(i,k,j))<a name='349'>
          ENDDO<a name='350'>
        ENDDO<a name='351'>
      ENDIF<a name='352'>
<a name='353'>
      DO l=1,ntrac<a name='354'>
        DO k=kts,kte<a name='355'>
          DO i=its,ite<a name='356'>
            RTG(I,K,L) = 0.<a name='357'>
          ENDDO<a name='358'>
        ENDDO<a name='359'>
      ENDDO<a name='360'>
<font color=#447700>!<a name='361'></font>
<font color=#447700>!  2010 new gfs pbl<a name='362'></font>
<font color=#447700>!<a name='363'></font>
<font color=#447700>!      call moninq(im,im,km,ntrac,dv,du,tau,rtg,                       &amp;<a name='364'></font>
<font color=#447700>!     &amp;     u1,v1,t1,q1,thraten,                                       &amp;  !kwon<a name='365'></font>
<font color=#447700>!     &amp;     psk,rbsoil,fm,fh,tsea,qss,heat,evap,stress,spd1,kpbl,      &amp;<a name='366'></font>
<font color=#447700>!     &amp;     prsi,del,prsl,prslk,phii,phil,rcl,deltim,                  &amp;<a name='367'></font>
<font color=#447700>!     &amp;     dusfc,dvsfc,dtsfc,dqsfc,hpbl,hgamt,hgamq)<a name='368'></font>
<a name='369'>
<a name='370'>
      call <A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF'>moninedmf</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#BL_GFSEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MONINEDMF_1">(im,im,kx,ntrac,ntcw,dv,du,tau,rtg,        &amp;<a name='371'>
<font color=#447700>!     &amp;   u1,v1,t1,q1,swh,hlw,xmu,                             &amp;<a name='372'></font>
     &amp;   u1,v1,t1,q1,thraten,                                  &amp;<a name='373'>
     &amp;   psk,rbsoil,zorl,u10m,v10m,fm,fh,                      &amp;<a name='374'>
     &amp;   tsea,qss,heat,evap,stress,spd1,kpbl,                  &amp;<a name='375'>
     &amp;   prsi,del,prsl,prslk,phii,phil,deltim,disheat,         &amp;  <a name='376'>
     &amp;   dusfc,dvsfc,dtsfc,dqsfc,hpbl,hgamt,hgamq,dkt,dku,     &amp;<a name='377'>
     &amp;   kinver,xkzm_m,xkzm_h,xkzm_s,lprnt,ipr,zol,            &amp;<a name='378'>
     &amp;   VAR_RIC,coef_ric_l,coef_ric_s,alpha,xland1)<a name='379'>
<a name='380'>
<a name='381'>
<font color=#447700>!============================================================================<a name='382'></font>
<font color=#447700>!    ADD  IN  DISSIPATIVE HEATING .... v*dv. This is Bob's doing<a name='383'></font>
<font color=#447700>!============================================================================<a name='384'></font>
<a name='385'>
<font color=#447700>!#if (NMM_CORE==1)<a name='386'></font>
<font color=#447700>!!! already considered in edmfpbl<a name='387'></font>
<font color=#447700>!!      IF(DISHEAT)THEN<a name='388'></font>
<font color=#447700>!!       DO k=kts,kte<a name='389'></font>
<font color=#447700>!!         DO i=its,ite<a name='390'></font>
<font color=#447700>!!          dishx(i,k)=u1(i,k)*du(i,k) + v1(i,k)*dv(i,k)<a name='391'></font>
<font color=#447700>!!          cpmikj=CP*(1.+0.8*QV3D(i,k,j))<a name='392'></font>
<font color=#447700>!!          dishx(i,k)=-dishx(i,k)/cpmikj<a name='393'></font>
<font color=#447700>!         IF(k==1)WRITE(0,*)'ADDITIONAL DISSIPATIVE HEATING',tau(i,k),dishx(i,k)<a name='394'></font>
<font color=#447700>!!          tau(i,k)=tau(i,k)+dishx(i,k)<a name='395'></font>
<font color=#447700>!!         ENDDO <a name='396'></font>
<font color=#447700>!!       ENDDO <a name='397'></font>
<font color=#447700>!!      ENDIF<a name='398'></font>
<font color=#447700>!#endif<a name='399'></font>
<a name='400'>
<font color=#447700>!=============================================================================<a name='401'></font>
<a name='402'>
<a name='403'>
      DO k=kts,kte<a name='404'>
        DO i=its,ite<a name='405'>
          RVBLTEN(I,K,J)=DV(I,K)<a name='406'>
          RUBLTEN(I,K,J)=DU(I,K)<a name='407'>
          RTHBLTEN(I,K,J)=TAU(I,K)/PI3D(I,K,J)<a name='408'>
          RQVBLTEN(I,K,J)=RTG(I,K,1)/(1.-Q1(I,K,1))**2<a name='409'>
          RQCBLTEN(I,K,J)=RTG(I,K,2)/(1.-Q1(I,K,2))**2<a name='410'>
        ENDDO<a name='411'>
      ENDDO<a name='412'>
<a name='413'>
      IF (P_QI.ge.P_FIRST_SCALAR) THEN<a name='414'>
        DO k=kts,kte<a name='415'>
          DO i=its,ite<a name='416'>
            RQIBLTEN(I,K,J)=RTG(I,K,3)/(1.-Q1(I,K,3))**2<a name='417'>
          ENDDO<a name='418'>
        ENDDO<a name='419'>
      ENDIF<a name='420'>
<a name='421'>
      DO i=its,ite<a name='422'>
        UST(i,j)=SQRT(STRESS(i))<a name='423'>
        WSPD(i,j)=SQRT(U3D(I,KTS,J)*U3D(I,KTS,J)+                       &amp;<a name='424'>
                       V3D(I,KTS,J)*V3D(I,KTS,J))+1.E-9<a name='425'>
        PBL(i,j)=HPBL(i)<a name='426'>
<font color=#447700>!Kwon For new shallow convection<a name='427'></font>
        HPBL2D(i,j)=HPBL(i)<a name='428'>
<font color=#447700>!<a name='429'></font>
        KPBL2D(i,j)=kpbl(i)<a name='430'>
      ENDDO<a name='431'>
<a name='432'>
#if (HWRF==1)<a name='433'>
     DO i=its,ite<a name='434'>
     DO k=kts,kte<a name='435'>
      DKU3D(I,J,K) = 0.<a name='436'>
      DKT3D(I,J,K) = 0.<a name='437'>
     ENDDO<a name='438'>
     ENDDO<a name='439'>
<a name='440'>
     DO i=its,ite<a name='441'>
     DO k=kts,kte-1<a name='442'>
      DKU3D(I,J,K) = DKU(I,K)<a name='443'>
      DKT3D(I,J,K) = DKT(I,K)<a name='444'>
     ENDDO<a name='445'>
<a name='446'>
     ENDDO<a name='447'>
#endif<a name='448'>
<a name='449'>
<a name='450'>
    ENDDO<a name='451'>
<a name='452'>
<a name='453'>
   END SUBROUTINE BL_GFSEDMF<a name='454'>
<a name='455'>
<font color=#447700>!===================================================================<a name='456'></font>
<A NAME='GFSEDMFINIT'><A href='../../html_code/phys/module_bl_gfsedmf.F.html#GFSEDMFINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='457'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>gfsedmfinit</font>(RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,       &amp; <A href='../../call_to/GFSEDMFINIT.html' TARGET='index'>1</A><a name='458'>
                      RQCBLTEN,RQIBLTEN,P_QI,P_FIRST_SCALAR,       &amp;<a name='459'>
                      restart,                                     &amp;<a name='460'>
                      allowed_to_read,                             &amp;<a name='461'>
                      ids, ide, jds, jde, kds, kde,                &amp;<a name='462'>
                      ims, ime, jms, jme, kms, kme,                &amp;<a name='463'>
                      its, ite, jts, jte, kts, kte                 )<a name='464'>
<font color=#447700>!-------------------------------------------------------------------          <a name='465'></font>
   IMPLICIT NONE<a name='466'>
<font color=#447700>!-------------------------------------------------------------------          <a name='467'></font>
   LOGICAL , INTENT(IN)          ::  allowed_to_read,restart<a name='468'>
   INTEGER , INTENT(IN)          ::  ids, ide, jds, jde, kds, kde, &amp;<a name='469'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='470'>
                                     its, ite, jts, jte, kts, kte<a name='471'>
   INTEGER , INTENT(IN)          ::  P_QI,P_FIRST_SCALAR<a name='472'>
<a name='473'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::         &amp;<a name='474'>
                                                         RUBLTEN, &amp;<a name='475'>
                                                         RVBLTEN, &amp;<a name='476'>
                                                         RTHBLTEN, &amp;<a name='477'>
                                                         RQVBLTEN, &amp;<a name='478'>
                                                         RQCBLTEN, &amp; <a name='479'>
                                                         RQIBLTEN<a name='480'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='481'>
<a name='482'>
   jtf=min0(jte,jde-1)<a name='483'>
   ktf=min0(kte,kde-1)<a name='484'>
   itf=min0(ite,ide-1)<a name='485'>
<a name='486'>
   IF(.not.restart)THEN<a name='487'>
     DO j=jts,jtf<a name='488'>
     DO k=kts,ktf<a name='489'>
     DO i=its,itf<a name='490'>
        RUBLTEN(i,k,j)=0.<a name='491'>
        RVBLTEN(i,k,j)=0.<a name='492'>
        RTHBLTEN(i,k,j)=0.<a name='493'>
        RQVBLTEN(i,k,j)=0.<a name='494'>
        RQCBLTEN(i,k,j)=0.<a name='495'>
     ENDDO<a name='496'>
     ENDDO<a name='497'>
     ENDDO<a name='498'>
   ENDIF<a name='499'>
<a name='500'>
   IF (P_QI .ge. P_FIRST_SCALAR .and. .not.restart) THEN<a name='501'>
      DO j=jts,jtf<a name='502'>
      DO k=kts,ktf<a name='503'>
      DO i=its,itf<a name='504'>
         RQIBLTEN(i,k,j)=0.<a name='505'>
      ENDDO<a name='506'>
      ENDDO<a name='507'>
      ENDDO<a name='508'>
   ENDIF<a name='509'>
<a name='510'>
   IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='511'>
      DO j=jts,jtf<a name='512'>
      DO k=kts,ktf<a name='513'>
      DO i=its,itf<a name='514'>
         RQIBLTEN(i,k,j)=0.<a name='515'>
      ENDDO<a name='516'>
      ENDDO<a name='517'>
      ENDDO<a name='518'>
   ENDIF<a name='519'>
<a name='520'>
<a name='521'>
   END SUBROUTINE gfsedmfinit<a name='522'>
<a name='523'>
<font color=#447700>!----------------------------------------------------------------------<a name='524'></font>
<a name='525'>
<font color=#447700>!!!!!  ==========================================================  !!!!!<a name='526'></font>
<font color=#447700>! subroutine 'moninedmf' computes subgrid vertical mixing by turbulence<a name='527'></font>
<font color=#447700>! <a name='528'></font>
<font color=#447700>! for the convective boundary layer, the scheme adopts eddy-diffusion<a name='529'></font>
<font color=#447700>!  mass-flux (edmf) parameterization (siebesma et al., 2007) to take into <a name='530'></font>
<font color=#447700>!  account nonlocal transport by large eddies. to reduce the tropical wind rmse, <a name='531'></font>
<font color=#447700>!  a hybrid scheme is used, in which the edmf scheme is used only for strongly <a name='532'></font>
<font color=#447700>!  unstable pbl while the current operational vertical diffusion scheme is called <a name='533'></font>
<font color=#447700>!  for the weakly unstable pbl.  <a name='534'></font>
<font color=#447700>!<a name='535'></font>
<A NAME='MONINEDMF'><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='536'>
      <font color=#993300>subroutine </font><font color=#cc0000>moninedmf</font>(ix,im,km,ntrac,ntcw,dv,du,tau,rtg,           &amp; <A href='../../call_to/MONINEDMF.html' TARGET='index'>1</A>,<A href='../../call_from/MONINEDMF.html' TARGET='index'>9</A><a name='537'>
<font color=#447700>!     &amp;   u1,v1,t1,q1,swh,hlw,xmu,                                      &amp;<a name='538'></font>
     &amp;   u1,v1,t1,q1,thraten,                                           &amp;<a name='539'>
     &amp;   psk,rbsoil,zorl,u10m,v10m,fm,fh,                               &amp;<a name='540'>
     &amp;   tsea,qss,heat,evap,stress,spd1,kpbl,                           &amp;<a name='541'>
     &amp;   prsi,del,prsl,prslk,phii,phil,delt,dspheat,                    &amp;<a name='542'>
     &amp;   dusfc,dvsfc,dtsfc,dqsfc,hpbl,hgamt,hgamq,dkt,dku,              &amp;<a name='543'>
     &amp;   kinver,xkzm_m,xkzm_h,xkzm_s,lprnt,ipr,zol,                     &amp;<a name='544'>
     &amp;   VAR_RIC,coef_ric_l,coef_ric_s,alpha,xland1)<a name='545'>
<font color=#447700>!<a name='546'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_7">, only : kind_phys<a name='547'>
<font color=#447700>!      USE MODULE_GFS_FUNCPHYS, only : fpvs<a name='548'></font>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_2">, grav =&gt; con_g, rd =&gt; con_rd, cp =&gt; con_cp &amp;<a name='549'>
     &amp;,             hvap =&gt; con_hvap, fv =&gt; con_fvirt<a name='550'>
      implicit none<a name='551'>
<font color=#447700>!<a name='552'></font>
<font color=#447700>!     arguments<a name='553'></font>
<font color=#447700>!<a name='554'></font>
      logical lprnt<a name='555'>
      integer ipr<a name='556'>
      integer ix, im, km, ntrac, ntcw, kpbl(im), kinver(im)<a name='557'>
<font color=#447700>!<a name='558'></font>
      real(kind=kind_phys) delt, xkzm_m, xkzm_h, xkzm_s<a name='559'>
      real(kind=kind_phys) dv(im,km),     du(im,km),                 &amp;<a name='560'>
     &amp;                     tau(im,km),    rtg(im,km,ntrac),          &amp;<a name='561'>
     &amp;                     u1(ix,km),     v1(ix,km),                 &amp;<a name='562'>
     &amp;                     t1(ix,km),     q1(ix,km,ntrac),           &amp;<a name='563'>
     &amp;                     swh(ix,km),    hlw(ix,km),                &amp;<a name='564'>
     &amp;                     xmu(im),       psk(im),                   &amp;<a name='565'>
     &amp;                     rbsoil(im),    zorl(im),                  &amp;<a name='566'>
     &amp;                     u10m(im),      v10m(im),                  &amp;<a name='567'>
     &amp;                     fm(im),        fh(im),                    &amp; <a name='568'>
     &amp;                     tsea(im),      qss(im),                   &amp;<a name='569'>
     &amp;                                    spd1(im),                  &amp;<a name='570'>
     &amp;                     prsi(ix,km+1), del(ix,km),                &amp;<a name='571'>
     &amp;                     prsl(ix,km),   prslk(ix,km),              &amp;<a name='572'>
     &amp;                     phii(ix,km+1), phil(ix,km),               &amp;<a name='573'>
     &amp;                     dusfc(im),     dvsfc(im),                 &amp;<a name='574'>
     &amp;                     dtsfc(im),     dqsfc(im),                 &amp;<a name='575'>
     &amp;                     hpbl(im),      hpblx(im),                 &amp;<a name='576'>
     &amp;                     hgamt(im),     hgamq(im)<a name='577'>
<font color=#447700>!<a name='578'></font>
      logical dspheat<a name='579'>
<font color=#447700>!          flag for tke dissipative heating<a name='580'></font>
<font color=#447700>!<a name='581'></font>
<font color=#447700>!    locals<a name='582'></font>
<font color=#447700>!<a name='583'></font>
      integer i,iprt,is,iun,k,kk,km1,kmpbl,latd,lond<a name='584'>
      integer lcld(im),icld(im),kcld(im),krad(im)<a name='585'>
      integer kx1(im), kpblx(im)<a name='586'>
<font color=#447700>!<a name='587'></font>
<font color=#447700>!     real(kind=kind_phys) betaq(im), betat(im),   betaw(im),<a name='588'></font>
      real(kind=kind_phys) evap(im),  heat(im),    phih(im),           &amp;<a name='589'>
     &amp;                     phim(im),  rbdn(im),    rbup(im),           &amp;<a name='590'>
     &amp;                     stress(im),beta(im),    sflux(im),          &amp;<a name='591'>
     &amp;                     z0(im),    crb(im),     wstar(im),          &amp;<a name='592'>
     &amp;                     zol(im),   ustmin(im),  ustar(im),          &amp;<a name='593'>
     &amp;                     thermal(im),wscale(im), wscaleu(im)<a name='594'>
<font color=#447700>!<a name='595'></font>
      real(kind=kind_phys) theta(im,km),thvx(im,km),  thlvx(im,km),    &amp;<a name='596'>
     &amp;                     thraten(im,km),                             &amp; <font color=#447700>! wang<a name='597'></font>
     &amp;                     qlx(im,km),  thetae(im,km),                 &amp;<a name='598'>
     &amp;                     qtx(im,km),  bf(im,km-1),  diss(im,km),     &amp;<a name='599'>
     &amp;                     radx(im,km-1),                              &amp;<a name='600'>
     &amp;                     govrth(im),  hrad(im),                      &amp;<a name='601'>
<font color=#447700>!    &amp;                     hradm(im),   radmin(im),   vrad(im),        &amp;<a name='602'></font>
     &amp;                     radmin(im),  vrad(im),                      &amp;<a name='603'>
     &amp;                     zd(im),      zdd(im),      thlvx1(im)       <a name='604'>
<font color=#447700>!<a name='605'></font>
      real(kind=kind_phys) rdzt(im,km-1),dktx(im,km-1),                &amp;<a name='606'>
     &amp;                     zi(im,km+1),  zl(im,km),    xkzo(im,km-1),  &amp;<a name='607'>
     &amp;                     dku(im,km-1), dkt(im,km-1), xkzmo(im,km-1), &amp;<a name='608'>
     &amp;                     cku(im,km-1), ckt(im,km-1),                 &amp;<a name='609'>
     &amp;                     ti(im,km-1),  shr2(im,km-1),                &amp;<a name='610'>
     &amp;                     al(im,km-1),  ad(im,km),                    &amp;  <a name='611'>
     &amp;                     au(im,km-1),  a1(im,km),                    &amp;<a name='612'>
     &amp;                     a2(im,km*ntrac)<a name='613'>
<a name='614'>
<a name='615'>
<font color=#447700>!<a name='616'></font>
      real(kind=kind_phys) tcko(im,km),  qcko(im,km,ntrac),            &amp;<a name='617'>
     &amp;                     ucko(im,km),  vcko(im,km),  xmf(im,km)<a name='618'>
<font color=#447700>!<a name='619'></font>
      real(kind=kind_phys) prinv(im), rent(im)<a name='620'>
<font color=#447700>!<a name='621'></font>
      logical  pblflg(im), sfcflg(im), scuflg(im), flg(im)<a name='622'>
      logical  ublflg(im), pcnvflg(im)<a name='623'>
<font color=#447700>!<a name='624'></font>
<font color=#447700>!  pcnvflg: true for convective(strongly unstable) pbl<a name='625'></font>
<font color=#447700>!  ublflg: true for unstable but not convective(strongly unstable) pbl<a name='626'></font>
<font color=#447700>!<a name='627'></font>
      real(kind=kind_phys) aphi16,  aphi5,  bvf2,   wfac,            &amp;<a name='628'>
     &amp;                     cfac,    conq,   cont,   conw,            &amp;<a name='629'>
     &amp;                     dk,      dkmax,  dkmin,                   &amp;<a name='630'>
     &amp;                     dq1,     dsdz2,  dsdzq,  dsdzt,           &amp;<a name='631'>
     &amp;                     dsdzu,   dsdzv,                           &amp;<a name='632'>
     &amp;                     dsig,    dt2,    dthe1,  dtodsd,          &amp;<a name='633'>
     &amp;                     dtodsu,  dw2,    dw2min, g,               &amp;<a name='634'>
     &amp;                     gamcrq,  gamcrt, gocp,                    &amp;<a name='635'>
     &amp;                     gravi,   f0,                              &amp;<a name='636'>
     &amp;                     prnum,   prmax,  prmin,  pfac,  crbcon,   &amp;<a name='637'>
     &amp;                     qmin,    tdzmin, qtend,  crbmin,crbmax,   &amp;<a name='638'>
     &amp;                     rbint,   rdt,    rdz,    qlmin,           &amp;<a name='639'>
     &amp;                     ri,      rimin,  rl2,    rlam,  rlamun,   &amp;<a name='640'>
     &amp;                     rone,    rzero,  sfcfrac,                 &amp;<a name='641'>
     &amp;                     spdk2,   sri,    zol1,   zolcr, zolcru,   &amp;<a name='642'>
     &amp;                     robn,    ttend,                           &amp;<a name='643'>
     &amp;                     utend,   vk,     vk2,                     &amp;<a name='644'>
     &amp;                     ust3,    wst3,                            &amp;    <a name='645'>
     &amp;                     vtend,   zfac,   vpert,  cteit,           &amp;<a name='646'>
     &amp;                     rentf1,  rentf2, radfac,                  &amp; <a name='647'>
     &amp;                     zfmin,   zk,     tem,    tem1,  tem2,     &amp;<a name='648'>
     &amp;                     xkzm,    xkzmu,  xkzminv,                 &amp;<a name='649'>
     &amp;                     ptem,    ptem1,  ptem2, tx1(im), tx2(im)  <a name='650'>
<font color=#447700>!<a name='651'></font>
      real(kind=kind_phys) zstblmax,h1,     h2,     qlcr,  actei,   &amp;<a name='652'>
     &amp;                     cldtime<a name='653'>
<a name='654'>
<font color=#447700>!! for aplha<a name='655'></font>
     real(kind=kind_phys) WSPM(IM,KM-1), xland1(IM)<a name='656'>
     integer kLOC <font color=#447700>! RGF<a name='657'></font>
     real :: xDKU, ALPHA    <font color=#447700>! RGF<a name='658'></font>
     real :: VAR_RIC,coef_ric_l,coef_ric_s<a name='659'>
     <a name='660'>
     logical:: outp<a name='661'>
     integer :: stype, useshape<a name='662'>
     real :: smax,ashape,sz2h, sksfc,skmax,ashape1,skminusk0, hmax<a name='663'>
<a name='664'>
<font color=#447700>!!<a name='665'></font>
<a name='666'>
<font color=#447700>!cc<a name='667'></font>
      parameter(gravi=1.0/grav)<a name='668'>
      parameter(g=grav)<a name='669'>
      parameter(gocp=g/cp)<a name='670'>
      parameter(cont=cp/g,conq=hvap/g,conw=1.0/g)               <font color=#447700>! for del in pa<a name='671'></font>
<font color=#447700>!     parameter(cont=1000.*cp/g,conq=1000.*hvap/g,conw=1000./g) ! for del in kpa<a name='672'></font>
      parameter(rlam=30.0,vk=0.4,vk2=vk*vk)<a name='673'>
      parameter(prmin=0.25,prmax=4.,zolcr=0.2,zolcru=-0.5)<a name='674'>
      parameter(dw2min=0.0001,dkmin=0.0,dkmax=1000.,rimin=-100.)<a name='675'>
      parameter(crbcon=0.25,crbmin=0.15,crbmax=0.35)<a name='676'>
      parameter(wfac=7.0,cfac=6.5,pfac=2.0,sfcfrac=0.1)<a name='677'>
<font color=#447700>!     parameter(qmin=1.e-8,xkzm=1.0,zfmin=1.e-8,aphi5=5.,aphi16=16.)<a name='678'></font>
      parameter(qmin=1.e-8,         zfmin=1.e-8,aphi5=5.,aphi16=16.)<a name='679'>
      parameter(tdzmin=1.e-3,qlmin=1.e-12,f0=1.e-4)<a name='680'>
      parameter(h1=0.33333333,h2=0.66666667)<a name='681'>
      parameter(cldtime=500.,xkzminv=0.3)<a name='682'>
<font color=#447700>!     parameter(cldtime=500.,xkzmu=3.0,xkzminv=0.3)<a name='683'></font>
<font color=#447700>!     parameter(gamcrt=3.,gamcrq=2.e-3,rlamun=150.0)<a name='684'></font>
      parameter(gamcrt=3.,gamcrq=0.,rlamun=150.0)<a name='685'>
      parameter(rentf1=0.2,rentf2=1.0,radfac=0.85)<a name='686'>
      parameter(iun=84)<a name='687'>
<font color=#447700>!<a name='688'></font>
<font color=#447700>!     parameter (zstblmax = 2500., qlcr=1.0e-5)<a name='689'></font>
<font color=#447700>!     parameter (zstblmax = 2500., qlcr=3.0e-5)<a name='690'></font>
<font color=#447700>!     parameter (zstblmax = 2500., qlcr=3.5e-5)<a name='691'></font>
<font color=#447700>!     parameter (zstblmax = 2500., qlcr=1.0e-4)<a name='692'></font>
      parameter (zstblmax = 2500., qlcr=3.5e-5)<a name='693'>
<font color=#447700>!     parameter (actei = 0.23)<a name='694'></font>
      parameter (actei = 0.7)<a name='695'>
<a name='696'>
<a name='697'>
<font color=#447700>! Weiguo Wang added, height-dependent ALPHA<a name='698'></font>
<font color=#447700>!       smax=0.148<a name='699'></font>
<font color=#447700>!       stype=1<a name='700'></font>
      useshape=2 <font color=#447700>!0-- no change, origincal ALPHA adjustment,1-- shape1, 2-- shape2(adjust above sfc)<a name='701'></font>
  <font color=#447700>!     useshape=1 <a name='702'></font>
<font color=#447700>!c<a name='703'></font>
<font color=#447700>!c-----------------------------------------------------------------------<a name='704'></font>
<font color=#447700>!c<a name='705'></font>
<font color=#447700>!c-----------------------------------------------------------------------<a name='706'></font>
<font color=#447700>!c<a name='707'></font>
 601  format(1x,' moninp lat lon step hour ',3i6,f6.1)<a name='708'>
 602      format(1x,'    k','        z','        t','       th',   &amp;<a name='709'>
     &amp;     '      tvh','        q','        u','        v',        &amp;<a name='710'>
     &amp;     '       sp')<a name='711'>
 603      format(1x,i5,8f9.1)<a name='712'>
 604      format(1x,'  sfc',9x,f9.1,18x,f9.1)<a name='713'>
 605      format(1x,'    k      zl    spd2   thekv   the1v'        &amp;<a name='714'>
     &amp;         ,' thermal    rbup')<a name='715'>
 606      format(1x,i5,6f8.2)<a name='716'>
 607      format(1x,' kpbl    hpbl      fm      fh   hgamt',       &amp;<a name='717'>
     &amp;         '   hgamq      ws   ustar      cd      ch')<a name='718'>
 608      format(1x,i5,9f8.2)<a name='719'>
 609      format(1x,' k pr dkt dku ',i5,3f8.2)<a name='720'>
 610      format(1x,' k pr dkt dku ',i5,3f8.2,' l2 ri t2',         &amp;<a name='721'>
     &amp;         ' sr2  ',2f8.2,2e10.2)<a name='722'>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='723'></font>
<font color=#447700>!     compute preliminary variables<a name='724'></font>
<font color=#447700>!<a name='725'></font>
      if (ix .lt. im) stop<a name='726'>
<font color=#447700>!<a name='727'></font>
<font color=#447700>!     iprt = 0<a name='728'></font>
<font color=#447700>!     if(iprt.eq.1) then<a name='729'></font>
<font color=#447700>!cc   latd = 0<a name='730'></font>
<font color=#447700>!     lond = 0<a name='731'></font>
<font color=#447700>!     else<a name='732'></font>
<font color=#447700>!cc   latd = 0<a name='733'></font>
<font color=#447700>!     lond = 0<a name='734'></font>
<font color=#447700>!     endif<a name='735'></font>
<font color=#447700>!<a name='736'></font>
      dt2   = delt<a name='737'>
      rdt   = 1. / dt2<a name='738'>
      km1   = km - 1<a name='739'>
      kmpbl = km / 2<a name='740'>
<font color=#447700>!<a name='741'></font>
      do k=1,km<a name='742'>
        do i=1,im<a name='743'>
          zi(i,k) = phii(i,k) * gravi<a name='744'>
          zl(i,k) = phil(i,k) * gravi<a name='745'>
        enddo<a name='746'>
      enddo<a name='747'>
      do i=1,im<a name='748'>
         zi(i,km+1) = phii(i,km+1) * gravi<a name='749'>
      enddo<a name='750'>
<font color=#447700>!<a name='751'></font>
      do k = 1,km1<a name='752'>
        do i=1,im<a name='753'>
          rdzt(i,k) = 1.0 / (zl(i,k+1) - zl(i,k))<a name='754'>
        enddo<a name='755'>
      enddo<a name='756'>
<font color=#447700>!<a name='757'></font>
      do i=1,im<a name='758'>
        kx1(i) = 1<a name='759'>
        tx1(i) = 1.0 / prsi(i,1)<a name='760'>
        tx2(i) = tx1(i)<a name='761'>
      enddo<a name='762'>
      do k = 1,km1<a name='763'>
        do i=1,im<a name='764'>
          xkzo(i,k)  = 0.0<a name='765'>
          xkzmo(i,k) = 0.0<a name='766'>
          if (k &lt; kinver(i)) then<a name='767'>
<font color=#447700>!                                  vertical background diffusivity<a name='768'></font>
            ptem      = prsi(i,k+1) * tx1(i)<a name='769'>
            tem1      = 1.0 - ptem<a name='770'>
            tem1      = tem1 * tem1 * 10.0<a name='771'>
            xkzo(i,k) = xkzm_h * min(1.0, exp(-tem1))<a name='772'>
<a name='773'>
<font color=#447700>!                                  vertical background diffusivity for momentum<a name='774'></font>
            if (ptem &gt;= xkzm_s) then<a name='775'>
              xkzmo(i,k) = xkzm_m<a name='776'>
              kx1(i)     = k + 1<a name='777'>
            else<a name='778'>
              if (k == kx1(i) .and. k &gt; 1) tx2(i) = 1.0 / prsi(i,k)<a name='779'>
              tem1 = 1.0 - prsi(i,k+1) * tx2(i)<a name='780'>
              tem1 = tem1 * tem1 * 5.0<a name='781'>
              xkzmo(i,k) = xkzm_m * min(1.0, exp(-tem1))<a name='782'>
            endif<a name='783'>
          endif<a name='784'>
        enddo<a name='785'>
      enddo<a name='786'>
<font color=#447700>!     if (lprnt) then<a name='787'></font>
<font color=#447700>!       print *,' xkzo=',(xkzo(ipr,k),k=1,km1)<a name='788'></font>
<font color=#447700>!       print *,' xkzmo=',(xkzmo(ipr,k),k=1,km1)<a name='789'></font>
<font color=#447700>!     endif<a name='790'></font>
<font color=#447700>!<a name='791'></font>
<font color=#447700>!  diffusivity in the inversion layer is set to be xkzminv (m^2/s)<a name='792'></font>
<font color=#447700>!<a name='793'></font>
      do k = 1,kmpbl<a name='794'>
        do i=1,im<a name='795'>
<font color=#447700>!         if(zi(i,k+1) &gt; 200..and.zi(i,k+1) &lt; zstblmax) then<a name='796'></font>
          if(zi(i,k+1) &gt; 250.) then<a name='797'>
            tem1 = (t1(i,k+1)-t1(i,k)) * rdzt(i,k)<a name='798'>
            if(tem1 &gt; 1.e-5) then<a name='799'>
               xkzo(i,k)  = min(xkzo(i,k),xkzminv)<a name='800'>
            endif<a name='801'>
          endif<a name='802'>
        enddo<a name='803'>
      enddo<a name='804'>
<font color=#447700>!<a name='805'></font>
      do i = 1,im<a name='806'>
         z0(i)    = 0.01 * zorl(i)<a name='807'>
         dusfc(i) = 0.<a name='808'>
         dvsfc(i) = 0.<a name='809'>
         dtsfc(i) = 0.<a name='810'>
         dqsfc(i) = 0.<a name='811'>
         wscale(i)= 0.<a name='812'>
         wscaleu(i)= 0.<a name='813'>
         kpbl(i)  = 1<a name='814'>
         hpbl(i)  = zi(i,1)<a name='815'>
         hpblx(i) = zi(i,1)<a name='816'>
         pblflg(i)= .true.<a name='817'>
         sfcflg(i)= .true.<a name='818'>
         if(rbsoil(i) &gt; 0.) sfcflg(i) = .false.<a name='819'>
         ublflg(i)= .false.<a name='820'>
         pcnvflg(i)= .false.<a name='821'>
         scuflg(i)= .true.<a name='822'>
         if(scuflg(i)) then<a name='823'>
           radmin(i)= 0.<a name='824'>
           rent(i)  = rentf1<a name='825'>
           hrad(i)  = zi(i,1)<a name='826'>
<font color=#447700>!          hradm(i) = zi(i,1)<a name='827'></font>
           krad(i)  = 1<a name='828'>
           icld(i)  = 0<a name='829'>
           lcld(i)  = km1<a name='830'>
           kcld(i)  = km1<a name='831'>
           zd(i)    = 0.<a name='832'>
        endif<a name='833'>
      enddo<a name='834'>
<font color=#447700>!<a name='835'></font>
      do k = 1,km<a name='836'>
        do i = 1,im<a name='837'>
          theta(i,k) = t1(i,k) * psk(i) / prslk(i,k)<a name='838'>
          qlx(i,k)   = max(q1(i,k,ntcw),qlmin)<a name='839'>
          qtx(i,k)   = max(q1(i,k,1),qmin)+qlx(i,k)<a name='840'>
          ptem       = qlx(i,k)<a name='841'>
          ptem1      = hvap*max(q1(i,k,1),qmin)/(cp*t1(i,k))<a name='842'>
          thetae(i,k)= <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_10">(i,k)*(1.+ptem1)<a name='843'>
          thvx(i,k)  = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_11">(i,k)*(1.+fv*max(q1(i,k,1),qmin)-ptem)<a name='844'>
          ptem2      = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_12">(i,k)-(hvap/cp)*ptem<a name='845'>
          thlvx(i,k) = ptem2*(1.+fv*qtx(i,k))<a name='846'>
        enddo<a name='847'>
      enddo<a name='848'>
      do k = 1,km1<a name='849'>
        do i = 1,im<a name='850'>
          dku(i,k)  = 0.<a name='851'>
          dkt(i,k)  = 0.<a name='852'>
          dktx(i,k) = 0.<a name='853'>
          cku(i,k)  = 0.<a name='854'>
          ckt(i,k)  = 0.<a name='855'>
          tem       = zi(i,k+1)-zi(i,k)<a name='856'>
<font color=#447700>!          radx(i,k) = tem*(swh(i,k)*xmu(i)+hlw(i,k))<a name='857'></font>
          radx(i,k) = tem*thraten(i,k)<a name='858'>
        enddo<a name='859'>
      enddo<a name='860'>
<font color=#447700>!<a name='861'></font>
      do i=1,im<a name='862'>
         flg(i)  = scuflg(i)<a name='863'>
      enddo<a name='864'>
      do k = 1, km1<a name='865'>
        do i=1,im<a name='866'>
          if(flg(i).and.zl(i,k) &gt;= zstblmax) then<a name='867'>
             lcld(i)=k<a name='868'>
             flg(i)=.false.<a name='869'>
          endif<a name='870'>
      enddo<a name='871'>
      enddo<a name='872'>
<font color=#447700>!<a name='873'></font>
<font color=#447700>!  compute virtual potential temp gradient (bf) and winshear square<a name='874'></font>
<font color=#447700>!<a name='875'></font>
      do k = 1, km1<a name='876'>
      do i = 1, im<a name='877'>
         rdz  = rdzt(i,k)<a name='878'>
         bf(i,k) = (thvx(i,k+1)-thvx(i,k))*rdz<a name='879'>
         ti(i,k) = 2./(t1(i,k)+t1(i,k+1))<a name='880'>
         dw2  = (u1(i,k)-u1(i,k+1))**2                        &amp;<a name='881'>
     &amp;        + (v1(i,k)-v1(i,k+1))**2<a name='882'>
         shr2(i,k) = max(dw2,dw2min)*rdz*rdz<a name='883'>
      enddo<a name='884'>
      enddo<a name='885'>
<font color=#447700>!<a name='886'></font>
      do i = 1,im<a name='887'>
        govrth(i) = g/theta(i,1)<a name='888'>
      enddo<a name='889'>
<font color=#447700>!<a name='890'></font>
      do i=1,im<a name='891'>
         beta(i)  = dt2 / (zi(i,2)-zi(i,1))<a name='892'>
      enddo<a name='893'>
<font color=#447700>!<a name='894'></font>
      do i=1,im<a name='895'>
         ustar(i) = sqrt(stress(i))<a name='896'>
      enddo<a name='897'>
<font color=#447700>!<a name='898'></font>
      do i = 1,im<a name='899'>
         sflux(i)  = heat(i) + evap(i)*fv*theta(i,1)<a name='900'>
         if(.not.sfcflg(i) .or. sflux(i) &lt;= 0.) pblflg(i)=.false.<a name='901'>
      enddo<a name='902'>
<font color=#447700>!<a name='903'></font>
<font color=#447700>!  compute the pbl height<a name='904'></font>
<font color=#447700>!<a name='905'></font>
      do i=1,im<a name='906'>
         flg(i) = .false.<a name='907'>
         rbup(i) = rbsoil(i)<a name='908'>
<font color=#447700>!<a name='909'></font>
<font color=#447700>!!         if(pblflg(i)) then<a name='910'></font>
<font color=#447700>!!           thermal(i) = thvx(i,1)<a name='911'></font>
<font color=#447700>!!           crb(i) = crbcon<a name='912'></font>
<font color=#447700>!!         else<a name='913'></font>
<font color=#447700>!!           thermal(i) = tsea(i)*(1.+fv*max(q1(i,1,1),qmin))<a name='914'></font>
<font color=#447700>!!           tem = sqrt(u10m(i)**2+v10m(i)**2)<a name='915'></font>
<font color=#447700>!!           tem = max(tem, 1.)<a name='916'></font>
<font color=#447700>!!           robn = tem / (f0 * z0(i))<a name='917'></font>
<font color=#447700>!!           tem1 = 1.e-7 * robn<a name='918'></font>
<font color=#447700>!!           crb(i) = 0.16 * (tem1 ** (-0.18))<a name='919'></font>
<font color=#447700>!!           crb(i) = max(min(crb(i), crbmax), crbmin)<a name='920'></font>
<font color=#447700>!!         endif<a name='921'></font>
<font color=#447700>!<a name='922'></font>
<font color=#447700>! use variable Ri for all conditions<a name='923'></font>
         if(pblflg(i)) then<a name='924'>
           thermal(i) = thvx(i,1)<a name='925'>
         else<a name='926'>
           thermal(i) = tsea(i)*(1.+fv*max(q1(i,1,1),qmin))<a name='927'>
         endif<a name='928'>
           tem = sqrt(u10m(i)**2+v10m(i)**2)<a name='929'>
           tem = max(tem, 1.)<a name='930'>
           robn = tem / (f0 * z0(i))<a name='931'>
           tem1 = 1.e-7 * robn<a name='932'>
<font color=#447700>!           crb(i) = 0.16 * (tem1 ** (-0.18))<a name='933'></font>
          crb(i) = crbcon<a name='934'>
        IF(var_ric.eq.1.) THEN<a name='935'>
         IF(xland1(i).eq.1)  crb(I) = coef_ric_l*(tem1)**(-0.18)<a name='936'>
         IF(xland1(i).eq.2)  crb(I) = coef_ric_s*(tem1)**(-0.18)<a name='937'>
        ENDIF<a name='938'>
           crb(i) = max(min(crb(i), crbmax), crbmin)<a name='939'>
      enddo<a name='940'>
<a name='941'>
         outp=.false.<a name='942'>
         if(outp) then<a name='943'>
          write(*,*)'var_ric,coef_ric_l,coef_ric_s,alpha'<a name='944'>
          write(*,*)var_ric,coef_ric_l,coef_ric_s,alpha<a name='945'>
          outp=.false.<a name='946'>
         endif<a name='947'>
      do k = 1, kmpbl<a name='948'>
      do i = 1, im<a name='949'>
        if(.not.flg(i)) then<a name='950'>
          rbdn(i) = rbup(i)<a name='951'>
          spdk2   = max((u1(i,k)**2+v1(i,k)**2),1.)<a name='952'>
          rbup(i) = (thvx(i,k)-thermal(i))*                        &amp;<a name='953'>
     &amp;              (g*zl(i,k)/thvx(i,1))/spdk2<a name='954'>
          kpbl(i) = k<a name='955'>
          flg(i)  = rbup(i) &gt; crb(i)<a name='956'>
        endif<a name='957'>
      enddo<a name='958'>
      enddo<a name='959'>
      do i = 1,im<a name='960'>
        if(kpbl(i) &gt; 1) then<a name='961'>
          k = kpbl(i)<a name='962'>
          if(rbdn(i) &gt;= crb(i)) then<a name='963'>
            rbint = 0.<a name='964'>
          elseif(rbup(i) &lt;= crb(i)) then<a name='965'>
            rbint = 1.<a name='966'>
          else<a name='967'>
            rbint = (crb(i)-rbdn(i))/(rbup(i)-rbdn(i))<a name='968'>
          endif<a name='969'>
          hpbl(i) = zl(i,k-1) + rbint*(zl(i,k)-zl(i,k-1))<a name='970'>
          if(hpbl(i) &lt; zi(i,kpbl(i))) kpbl(i) = kpbl(i) - 1<a name='971'>
        else<a name='972'>
          hpbl(i) = zl(i,1)<a name='973'>
          kpbl(i) = 1<a name='974'>
        endif<a name='975'>
        kpblx(i) = kpbl(i)<a name='976'>
        hpblx(i) = hpbl(i)<a name='977'>
      enddo<a name='978'>
<font color=#447700>!<a name='979'></font>
<font color=#447700>!  compute similarity parameters <a name='980'></font>
<font color=#447700>!<a name='981'></font>
      do i=1,im<a name='982'>
         zol(i) = max(rbsoil(i)*fm(i)*fm(i)/fh(i),rimin)<a name='983'>
         if(sfcflg(i)) then<a name='984'>
           zol(i) = min(zol(i),-zfmin)<a name='985'>
         else<a name='986'>
           zol(i) = max(zol(i),zfmin)<a name='987'>
         endif<a name='988'>
         zol1 = zol(i)*sfcfrac*hpbl(i)/zl(i,1)<a name='989'>
         if(sfcflg(i)) then<a name='990'>
<font color=#447700>!          phim(i) = (1.-aphi16*zol1)**(-1./4.)<a name='991'></font>
<font color=#447700>!          phih(i) = (1.-aphi16*zol1)**(-1./2.)<a name='992'></font>
           tem     = 1.0 / (1. - aphi16*zol1)<a name='993'>
           phih(i) = sqrt(tem)<a name='994'>
           phim(i) = sqrt(phih(i))<a name='995'>
         else<a name='996'>
           phim(i) = 1. + aphi5*zol1<a name='997'>
           phih(i) = phim(i)<a name='998'>
         endif<a name='999'>
         wscale(i) = ustar(i)/phim(i)<a name='1000'>
         ustmin(i) = ustar(i)/aphi5<a name='1001'>
         wscale(i) = max(wscale(i),ustmin(i))<a name='1002'>
      enddo<a name='1003'>
      do i=1,im<a name='1004'>
        if(pblflg(i)) then<a name='1005'>
          if(zol(i) &lt; zolcru .and. kpbl(i) &gt; 1) then<a name='1006'>
            pcnvflg(i) = .true.<a name='1007'>
          else<a name='1008'>
            ublflg(i) = .true.<a name='1009'>
          endif<a name='1010'>
          wst3 = govrth(i)*sflux(i)*hpbl(i)<a name='1011'>
          wstar(i)= wst3**h1<a name='1012'>
          ust3 = ustar(i)**3.<a name='1013'>
          wscaleu(i) = (ust3+wfac*vk*wst3*sfcfrac)**h1<a name='1014'>
          wscaleu(i) = max(wscaleu(i),ustmin(i))<a name='1015'>
        endif<a name='1016'>
      enddo<a name='1017'>
<font color=#447700>!<a name='1018'></font>
<font color=#447700>! compute counter-gradient mixing term for heat and moisture<a name='1019'></font>
<font color=#447700>!<a name='1020'></font>
      do i = 1,im<a name='1021'>
         if(ublflg(i)) then<a name='1022'>
           hgamt(i)  = min(cfac*heat(i)/wscaleu(i),gamcrt)<a name='1023'>
           hgamq(i)  = min(cfac*evap(i)/wscaleu(i),gamcrq)<a name='1024'>
           vpert     = hgamt(i) + hgamq(i)*fv*theta(i,1)<a name='1025'>
           vpert     = min(vpert,gamcrt)<a name='1026'>
           thermal(i)= thermal(i)+max(vpert,0.)<a name='1027'>
           hgamt(i)  = max(hgamt(i),0.0)<a name='1028'>
           hgamq(i)  = max(hgamq(i),0.0)<a name='1029'>
         endif<a name='1030'>
      enddo<a name='1031'>
<font color=#447700>!<a name='1032'></font>
<font color=#447700>!  enhance the pbl height by considering the thermal excess<a name='1033'></font>
<font color=#447700>!<a name='1034'></font>
      do i=1,im<a name='1035'>
         flg(i)  = .true.<a name='1036'>
         if(ublflg(i)) then<a name='1037'>
           flg(i)  = .false.<a name='1038'>
           rbup(i) = rbsoil(i)<a name='1039'>
         endif<a name='1040'>
      enddo<a name='1041'>
      do k = 2, kmpbl<a name='1042'>
      do i = 1, im<a name='1043'>
        if(.not.flg(i)) then<a name='1044'>
          rbdn(i) = rbup(i)<a name='1045'>
          spdk2   = max((u1(i,k)**2+v1(i,k)**2),1.)<a name='1046'>
          rbup(i) = (thvx(i,k)-thermal(i))*                       &amp;<a name='1047'>
     &amp;              (g*zl(i,k)/thvx(i,1))/spdk2<a name='1048'>
          kpbl(i) = k<a name='1049'>
          flg(i)  = rbup(i) &gt; crb(i)<a name='1050'>
        endif<a name='1051'>
      enddo<a name='1052'>
      enddo<a name='1053'>
      do i = 1,im<a name='1054'>
        if(ublflg(i)) then<a name='1055'>
           k = kpbl(i)<a name='1056'>
           if(rbdn(i) &gt;= crb(i)) then<a name='1057'>
              rbint = 0.<a name='1058'>
           elseif(rbup(i) &lt;= crb(i)) then<a name='1059'>
              rbint = 1.<a name='1060'>
           else<a name='1061'>
              rbint = (crb(i)-rbdn(i))/(rbup(i)-rbdn(i))<a name='1062'>
           endif<a name='1063'>
           hpbl(i) = zl(i,k-1) + rbint*(zl(i,k)-zl(i,k-1))<a name='1064'>
           if(hpbl(i) &lt; zi(i,kpbl(i))) kpbl(i) = kpbl(i) - 1<a name='1065'>
           if(kpbl(i) &lt;= 1) then<a name='1066'>
              ublflg(i) = .false.<a name='1067'>
              pblflg(i) = .false.<a name='1068'>
           endif<a name='1069'>
        endif<a name='1070'>
      enddo<a name='1071'>
<font color=#447700>!<a name='1072'></font>
<font color=#447700>!  look for stratocumulus<a name='1073'></font>
<font color=#447700>!<a name='1074'></font>
      do i = 1, im<a name='1075'>
        flg(i)=scuflg(i)<a name='1076'>
      enddo<a name='1077'>
      do k = kmpbl,1,-1<a name='1078'>
      do i = 1, im<a name='1079'>
        if(flg(i) .and. k &lt;= lcld(i)) then<a name='1080'>
          if(qlx(i,k).ge.qlcr) then<a name='1081'>
             kcld(i)=k<a name='1082'>
             flg(i)=.false.<a name='1083'>
          endif<a name='1084'>
        endif<a name='1085'>
      enddo<a name='1086'>
      enddo<a name='1087'>
      do i = 1, im<a name='1088'>
        if(scuflg(i) .and. kcld(i)==km1) scuflg(i)=.false.<a name='1089'>
      enddo<a name='1090'>
<font color=#447700>!<a name='1091'></font>
      do i = 1, im<a name='1092'>
        flg(i)=scuflg(i)<a name='1093'>
      enddo<a name='1094'>
      do k = kmpbl,1,-1<a name='1095'>
      do i = 1, im<a name='1096'>
        if(flg(i) .and. k &lt;= kcld(i)) then<a name='1097'>
          if(qlx(i,k) &gt;= qlcr) then<a name='1098'>
            if(radx(i,k) &lt; radmin(i)) then<a name='1099'>
              radmin(i)=radx(i,k)<a name='1100'>
              krad(i)=k<a name='1101'>
            endif<a name='1102'>
          else<a name='1103'>
            flg(i)=.false.<a name='1104'>
          endif<a name='1105'>
        endif<a name='1106'>
      enddo<a name='1107'>
      enddo<a name='1108'>
      do i = 1, im<a name='1109'>
        if(scuflg(i) .and. krad(i) &lt;= 1) scuflg(i)=.false.<a name='1110'>
        if(scuflg(i) .and. radmin(i)&gt;=0.) scuflg(i)=.false.<a name='1111'>
      enddo<a name='1112'>
<font color=#447700>!<a name='1113'></font>
      do i = 1, im<a name='1114'>
        flg(i)=scuflg(i)<a name='1115'>
      enddo<a name='1116'>
      do k = kmpbl,2,-1<a name='1117'>
      do i = 1, im<a name='1118'>
        if(flg(i) .and. k &lt;= krad(i)) then<a name='1119'>
          if(qlx(i,k) &gt;= qlcr) then<a name='1120'>
            icld(i)=icld(i)+1<a name='1121'>
          else<a name='1122'>
            flg(i)=.false.<a name='1123'>
          endif<a name='1124'>
        endif<a name='1125'>
      enddo<a name='1126'>
      enddo<a name='1127'>
      do i = 1, im<a name='1128'>
        if(scuflg(i) .and. icld(i) &lt; 1) scuflg(i)=.false.<a name='1129'>
      enddo<a name='1130'>
<font color=#447700>!<a name='1131'></font>
      do i = 1, im<a name='1132'>
        if(scuflg(i)) then<a name='1133'>
           hrad(i) = zi(i,krad(i)+1)<a name='1134'>
<font color=#447700>!          hradm(i)= zl(i,krad(i))<a name='1135'></font>
        endif<a name='1136'>
      enddo<a name='1137'>
<font color=#447700>!<a name='1138'></font>
      do i = 1, im<a name='1139'>
        if(scuflg(i) .and. hrad(i)&lt;zi(i,2)) scuflg(i)=.false.<a name='1140'>
      enddo<a name='1141'>
<font color=#447700>!<a name='1142'></font>
      do i = 1, im<a name='1143'>
        if(scuflg(i)) then<a name='1144'>
          k    = krad(i)<a name='1145'>
          tem  = zi(i,k+1)-zi(i,k)<a name='1146'>
          tem1 = cldtime*radmin(i)/tem<a name='1147'>
          thlvx1(i) = thlvx(i,k)+tem1<a name='1148'>
<font color=#447700>!         if(thlvx1(i) &gt; thlvx(i,k-1)) scuflg(i)=.false.<a name='1149'></font>
        endif<a name='1150'>
      enddo<a name='1151'>
<font color=#447700>! <a name='1152'></font>
      do i = 1, im<a name='1153'>
         flg(i)=scuflg(i)<a name='1154'>
      enddo<a name='1155'>
      do k = kmpbl,1,-1<a name='1156'>
      do i = 1, im<a name='1157'>
        if(flg(i) .and. k &lt;= krad(i))then<a name='1158'>
          if(thlvx1(i) &lt;= thlvx(i,k))then<a name='1159'>
             tem=zi(i,k+1)-zi(i,k)<a name='1160'>
             zd(i)=zd(i)+tem<a name='1161'>
          else<a name='1162'>
             flg(i)=.false.<a name='1163'>
          endif<a name='1164'>
        endif<a name='1165'>
      enddo<a name='1166'>
      enddo<a name='1167'>
      do i = 1, im<a name='1168'>
        if(scuflg(i))then<a name='1169'>
          kk = max(1, krad(i)+1-icld(i))<a name='1170'>
          zdd(i) = hrad(i)-zi(i,kk)<a name='1171'>
        endif<a name='1172'>
      enddo<a name='1173'>
      do i = 1, im<a name='1174'>
        if(scuflg(i))then<a name='1175'>
          zd(i) = max(zd(i),zdd(i))<a name='1176'>
          zd(i) = min(zd(i),hrad(i))<a name='1177'>
          tem   = govrth(i)*zd(i)*(-radmin(i))<a name='1178'>
          vrad(i)= tem**h1<a name='1179'>
        endif<a name='1180'>
      enddo<a name='1181'>
<font color=#447700>!<a name='1182'></font>
<font color=#447700>!     compute inverse prandtl number<a name='1183'></font>
<font color=#447700>!<a name='1184'></font>
      do i = 1, im<a name='1185'>
        if(ublflg(i)) then<a name='1186'>
          tem = phih(i)/phim(i)+cfac*vk*sfcfrac<a name='1187'>
        else<a name='1188'>
          tem = phih(i)/phim(i)<a name='1189'>
        endif<a name='1190'>
        prinv(i) =  1.0 / tem<a name='1191'>
        prinv(i) = min(prinv(i),prmax)<a name='1192'>
        prinv(i) = max(prinv(i),prmin)<a name='1193'>
      enddo<a name='1194'>
      do i = 1, im<a name='1195'>
        if(zol(i) &gt; zolcr) then<a name='1196'>
          kpbl(i) = 1<a name='1197'>
        endif<a name='1198'>
      enddo<a name='1199'>
<a name='1200'>
<font color=#447700>!!! 20150915 WeiguoWang added alpha and wind-dependent modification of K by RGF<a name='1201'></font>
#if (HWRF==1)<a name='1202'>
<font color=#447700>! -------------------------------------------------------------------------------------<a name='1203'></font>
<font color=#447700>! begin RGF modifications<a name='1204'></font>
<font color=#447700>! this is version MOD05<a name='1205'></font>
<a name='1206'>
<a name='1207'>
<font color=#447700>! RGF determine wspd at roughly 500 m above surface, or as close as possible,<a name='1208'></font>
<font color=#447700>! reuse SPDK2<a name='1209'></font>
<font color=#447700>!  zi(i,k) is AGL, right?  May not matter if applied only to water grid points<a name='1210'></font>
      if(ALPHA.lt.0)then<a name='1211'>
<a name='1212'>
       DO I=1,IM<a name='1213'>
         SPDK2 = 0.<a name='1214'>
         WSPM(i,1) = 0.<a name='1215'>
         DO K = 1, KMPBL <font color=#447700>! kmpbl is like a max possible pbl height<a name='1216'></font>
          if(zi(i,k).le.500.and.zi(i,k+1).gt.500.)then <font color=#447700>! find level bracketing 500 m<a name='1217'></font>
           SPDK2 = SQRT(U1(i,k)*U1(i,k)+V1(i,k)*V1(i,k)) <font color=#447700>! wspd near 500 m<a name='1218'></font>
           WSPM(i,1) = SPDK2/0.6  <font color=#447700>! now the Km limit for 500 m.  just store in K=1<a name='1219'></font>
            <font color=#447700>!wang test , limit Kmax&lt;100<a name='1220'></font>
           <font color=#447700>!  WSPM(i,1)=amin1(SPDK2/0.6, 100.0)<a name='1221'></font>
            <font color=#447700>!<a name='1222'></font>
           WSPM(i,2) = float(k)  <font color=#447700>! height of level at gridpoint i. store in K=2<a name='1223'></font>
<font color=#447700>!           if(i.eq.25) print *,' IK ',i,k,' ZI ',zi(i,k), ' WSPM1 ',wspm(i,1),'<a name='1224'></font>
<font color=#447700>!           KMPBL ',kmpbl,' KPBL ',kpbl(i)<a name='1225'></font>
          endif<a name='1226'>
         ENDDO<a name='1227'>
       ENDDO <font color=#447700>! i<a name='1228'></font>
<a name='1229'>
      endif <font color=#447700>! ALPHA &lt; 0<a name='1230'></font>
#endif<a name='1231'>
<a name='1232'>
<a name='1233'>
<a name='1234'>
<font color=#447700>!<a name='1235'></font>
<font color=#447700>!     compute diffusion coefficients below pbl<a name='1236'></font>
<font color=#447700>!<a name='1237'></font>
      do i=1,im<a name='1238'>
      do k = 1, kmpbl<a name='1239'>
         if(k &lt; kpbl(i)) then<a name='1240'>
<font color=#447700>!           zfac = max((1.-(zi(i,k+1)-zl(i,1))/<a name='1241'></font>
<font color=#447700>!    1             (hpbl(i)-zl(i,1))), zfmin)<a name='1242'></font>
            zfac = max((1.-zi(i,k+1)/hpbl(i)), zfmin)<a name='1243'>
         <font color=#447700>!   tem = zi(i,k+1) * (zfac**pfac) <a name='1244'></font>
            tem = zi(i,k+1) * (zfac**pfac) * ABS(ALPHA)<a name='1245'>
<a name='1246'>
<font color=#447700>!!!! CHANGES FOR HEIGHT-DEPENDENT K ADJUSTMENT, WANG W<a name='1247'></font>
             if(useshape .ge. 1) then<a name='1248'>
                sz2h=(ZI(I,K+1)-ZL(I,1))/(HPBL(I)-ZL(I,1))<a name='1249'>
                sz2h=max(sz2h,zfmin)<a name='1250'>
                sz2h=min(sz2h,1.0)<a name='1251'>
                    zfac=(1.0-sz2h)**pfac<a name='1252'>
<font color=#447700>!                    smax=0.148  !! max value of this shape function<a name='1253'></font>
                     smax=0.148  <font color=#447700>!! max value of this shape function<a name='1254'></font>
                     hmax=0.333  <font color=#447700>!! roughly height if max K<a name='1255'></font>
                     skmax=hmax*(1.0-hmax)**pfac<a name='1256'>
                     sksfc=min(ZI(I,2)/HPBL(I),0.05)  <font color=#447700>! surface layer top, 0.05H or ZI(2) (Zi(1)=0)<a name='1257'></font>
                     sksfc=sksfc*(1-sksfc)**pfac<a name='1258'>
<a name='1259'>
                zfac=max(zfac,zfmin)<a name='1260'>
                ashape=max(ABS(ALPHA),0.2)  <font color=#447700>! should not be smaller than 0.2, otherwise too much adjustment(?)<a name='1261'></font>
                if(useshape ==1) then <a name='1262'>
                 ashape=( 1.0 - ((sz2h*zfac/smax)**0.25) *( 1.0 - ashape )  )<a name='1263'>
                 tem = zi(i,k+1) * (zfac) * ashape<a name='1264'>
                endif<a name='1265'>
<a name='1266'>
                if (useshape == 2) then   <font color=#447700>!only adjus K that is &gt; K_surface_top<a name='1267'></font>
                  ashape1=1.0<a name='1268'>
                 if (skmax &gt; sksfc)  ashape1=(skmax*ashape-sksfc)/(skmax-sksfc)<a name='1269'>
                  skminusk0=ZI(I,K+1)*zfac - HPBL(i)*sksfc<a name='1270'>
                   tem = zi(i,k+1) * (zfac) <font color=#447700>! no adjustment<a name='1271'></font>
                  if (skminusk0 &gt; 0) then   <font color=#447700>! only adjust K which is &gt; surface top K<a name='1272'></font>
                   tem = skminusk0*ashape1 + HPBL(i)*sksfc<a name='1273'>
                  endif<a name='1274'>
                endif<a name='1275'>
             endif  <font color=#447700>! endif useshape&gt;1<a name='1276'></font>
<font color=#447700>!!!! END OF CHAGES , WANG W<a name='1277'></font>
<a name='1278'>
<font color=#447700>!!If alpha &gt;= 0, this is the only modification of K<a name='1279'></font>
<font color=#447700>! if alpha = -1, the above provides the first guess for DKU, based on assumption<a name='1280'></font>
<font color=#447700>! alpha = +1<a name='1281'></font>
<font color=#447700>!               (other values of alpha &lt; 0 can also be applied)<a name='1282'></font>
<font color=#447700>! if alpha &gt; 0, the above applies the alpha suppression factor and we are<a name='1283'></font>
<font color=#447700>! finished<a name='1284'></font>
<a name='1285'>
            if(pblflg(i)) then<a name='1286'>
              tem1 = vk * wscaleu(i) * tem<a name='1287'>
<font color=#447700>!             dku(i,k) = xkzmo(i,k) + tem1<a name='1288'></font>
<font color=#447700>!             dkt(i,k) = xkzo(i,k)  + tem1 * prinv(i)<a name='1289'></font>
              dku(i,k) = tem1<a name='1290'>
              dkt(i,k) = tem1 * prinv(i)<a name='1291'>
            else<a name='1292'>
              tem1 = vk * wscale(i) * tem<a name='1293'>
<font color=#447700>!             dku(i,k) = xkzmo(i,k) + tem1<a name='1294'></font>
<font color=#447700>!             dkt(i,k) = xkzo(i,k)  + tem1 * prinv(i)<a name='1295'></font>
              dku(i,k) = tem1<a name='1296'>
              dkt(i,k) = tem1 * prinv(i)<a name='1297'>
            endif<a name='1298'>
            dku(i,k) = min(dku(i,k),dkmax)<a name='1299'>
            dku(i,k) = max(dku(i,k),xkzmo(i,k))<a name='1300'>
            dkt(i,k) = min(dkt(i,k),dkmax)<a name='1301'>
            dkt(i,k) = max(dkt(i,k),xkzo(i,k))<a name='1302'>
            dktx(i,k)= dkt(i,k)<a name='1303'>
         endif<a name='1304'>
      enddo     <font color=#447700>!K loop<a name='1305'></font>
<a name='1306'>
#if (HWRF==1)<a name='1307'>
<font color=#447700>! possible modification of first guess DKU, under certain conditions<a name='1308'></font>
<font color=#447700>! (1) this applies only to columns over water<a name='1309'></font>
<a name='1310'>
        IF(xland1(i).eq.2)then <font color=#447700>! sea only<a name='1311'></font>
<a name='1312'>
<font color=#447700>! (2) alpha test<a name='1313'></font>
<font color=#447700>! if alpha &lt; 0, find alpha for each column and do the loop again<a name='1314'></font>
<font color=#447700>! if alpha &gt; 0, we are finished<a name='1315'></font>
<a name='1316'>
<a name='1317'>
        if(alpha.lt.0)then      <font color=#447700>! variable alpha test<a name='1318'></font>
<a name='1319'>
<font color=#447700>! k-level of layer around 500 m<a name='1320'></font>
            kLOC = INT(WSPM(i,2))<a name='1321'>
<font color=#447700>!            print *,' kLOC ',kLOC,' KPBL ',KPBL(I)<a name='1322'></font>
<a name='1323'>
<font color=#447700>! (3) only do  this IF KPBL(I) &gt;= kLOC.  Otherwise, we are finished, with DKU as<a name='1324'></font>
<font color=#447700>! if alpha = +1<a name='1325'></font>
<a name='1326'>
          if(KPBL(I).gt.kLOC)then<a name='1327'>
<a name='1328'>
            xDKU = DKU(i,kLOC)     <font color=#447700>! Km at k-level<a name='1329'></font>
<font color=#447700>! (4) DKU check.<a name='1330'></font>
<font color=#447700>! WSPM(i,1) is the KM cap for the 500-m level.<a name='1331'></font>
<font color=#447700>!  if DKU at 500-m level &lt; WSPM(i,1), do not limit Km ANYWHERE.  Alpha =<a name='1332'></font>
<font color=#447700>!  abs(alpha).  No need to recalc.<a name='1333'></font>
<font color=#447700>!  if DKU at 500-m level &gt; WSPM(i,1), then alpha = WSPM(i,1)/xDKU for entire<a name='1334'></font>
<font color=#447700>!  column<a name='1335'></font>
            if(xDKU.ge.WSPM(i,1)) then <font color=#447700>! ONLY if DKU at 500-m exceeds cap, otherwise already done<a name='1336'></font>
<a name='1337'>
            WSPM(i,3) = WSPM(i,1)/xDKU  <font color=#447700>! ratio of cap to Km at k-level, store in WSPM(i,3)<a name='1338'></font>
            <font color=#447700>!WSPM(i,4) = amin1(WSPM(I,3),1.0) ! this is new column alpha. cap at 1. ! should never be needed<a name='1339'></font>
            WSPM(i,4) = min(WSPM(I,3),1.0) <font color=#447700>! this is new column alpha. cap at 1. ! should never be needed<a name='1340'></font>
 <font color=#447700>!! recalculate K capped by WSPM(i,1)           <a name='1341'></font>
      do k = 1, kmpbl<a name='1342'>
         if(k &lt; kpbl(i)) then<a name='1343'>
<font color=#447700>!           zfac = max((1.-(zi(i,k+1)-zl(i,1))/<a name='1344'></font>
<font color=#447700>!    1             (hpbl(i)-zl(i,1))), zfmin)<a name='1345'></font>
            zfac = max((1.-zi(i,k+1)/hpbl(i)), zfmin)<a name='1346'>
         <font color=#447700>!   tem = zi(i,k+1) * (zfac**pfac) <a name='1347'></font>
            tem = zi(i,k+1) * (zfac**pfac) * WSPM(i,4)<a name='1348'>
<a name='1349'>
<font color=#447700>!!! wang use different K shape, options!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1350'></font>
<a name='1351'>
<font color=#447700>!!!! CHANGES FOR HEIGHT-DEPENDENT K ADJUSTMENT, WANG W<a name='1352'></font>
             if(useshape .ge. 1) then<a name='1353'>
                sz2h=(ZI(I,K+1)-ZL(I,1))/(HPBL(I)-ZL(I,1))<a name='1354'>
                sz2h=max(sz2h,zfmin)<a name='1355'>
                sz2h=min(sz2h,1.0)<a name='1356'>
                    zfac=(1.0-sz2h)**pfac<a name='1357'>
                     smax=0.148  <font color=#447700>!! max value of this shape function<a name='1358'></font>
                     hmax=0.333  <font color=#447700>!! roughly height if max K<a name='1359'></font>
                     skmax=hmax*(1.0-hmax)**pfac<a name='1360'>
                     sksfc=min(ZI(I,2)/HPBL(I),0.05)  <font color=#447700>! surface layer top, 0.05H or ZI(2) (Zi(1)=0)<a name='1361'></font>
                     sksfc=sksfc*(1-sksfc)**pfac<a name='1362'>
<a name='1363'>
                zfac=max(zfac,zfmin)<a name='1364'>
                ashape=max(WSPM(i,4),0.2)  <font color=#447700>!! adjustment coef should not smaller than 0.2<a name='1365'></font>
                if(useshape ==1) then <a name='1366'>
                 ashape=( 1.0 - ((sz2h*zfac/smax)**0.25) *( 1.0 - ashape )  )<a name='1367'>
                 tem = zi(i,k+1) * (zfac) * ashape<a name='1368'>
<font color=#447700>!                 if(k ==5) write(0,*)'min alf, height-depend alf',WSPM(i,4),ashape<a name='1369'></font>
                endif  <font color=#447700>! endif useshape=1<a name='1370'></font>
<a name='1371'>
                if (useshape == 2) then   <font color=#447700>!only adjus K that is &gt; K_surface_top<a name='1372'></font>
                  ashape1=1.0<a name='1373'>
                 if (skmax &gt; sksfc)  ashape1=(skmax*ashape-sksfc)/(skmax-sksfc)<a name='1374'>
<a name='1375'>
                  skminusk0=ZI(I,K+1)*zfac - HPBL(i)*sksfc<a name='1376'>
                 tem = zi(i,k+1) * (zfac) <font color=#447700>! no adjustment<a name='1377'></font>
<font color=#447700>!             if(k ==5) write(0,*)'before, dku,ashape,ashpe1',tem*wscaleu(i)*vk,ashape,ashape1<a name='1378'></font>
                  if (skminusk0 &gt; 0) then   <font color=#447700>! only adjust K which is &gt; surface top K<a name='1379'></font>
                   tem = skminusk0*ashape1 + HPBL(i)*sksfc<a name='1380'>
                  endif<a name='1381'>
<font color=#447700>!            if(k ==5) write(0,*)'after, dku,k_sfc,skmax,sksfc,zi(2),hpbl',tem*wscaleu(i)*vk,WSCALEU(I)*VK*HPBL(i)*sksfc, skmax,sksfc,ZI(I,2),HPBL(I)<a name='1382'></font>
<a name='1383'>
                endif  <font color=#447700>! endif useshape=2<a name='1384'></font>
             endif  <font color=#447700>! endif useshape&gt;1<a name='1385'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1386'></font>
<a name='1387'>
            if(pblflg(i)) then<a name='1388'>
              tem1 = vk * wscaleu(i) * tem<a name='1389'>
<font color=#447700>!             dku(i,k) = xkzmo(i,k) + tem1<a name='1390'></font>
<font color=#447700>!             dkt(i,k) = xkzo(i,k)  + tem1 * prinv(i)<a name='1391'></font>
              dku(i,k) = tem1<a name='1392'>
              dkt(i,k) = tem1 * prinv(i)<a name='1393'>
            else<a name='1394'>
              tem1 = vk * wscale(i) * tem<a name='1395'>
<font color=#447700>!             dku(i,k) = xkzmo(i,k) + tem1<a name='1396'></font>
<font color=#447700>!             dkt(i,k) = xkzo(i,k)  + tem1 * prinv(i)<a name='1397'></font>
              dku(i,k) = tem1<a name='1398'>
              dkt(i,k) = tem1 * prinv(i)<a name='1399'>
            endif<a name='1400'>
            dku(i,k) = min(dku(i,k),dkmax)<a name='1401'>
            dku(i,k) = max(dku(i,k),xkzmo(i,k))<a name='1402'>
            dkt(i,k) = min(dkt(i,k),dkmax)<a name='1403'>
            dkt(i,k) = max(dkt(i,k),xkzo(i,k))<a name='1404'>
            dktx(i,k)= dkt(i,k)<a name='1405'>
         endif<a name='1406'>
      enddo     <font color=#447700>!K loop<a name='1407'></font>
            endif <font color=#447700>! xDKU.ge.WSPM(i,1)<a name='1408'></font>
          endif <font color=#447700>! KPBL(I).ge.kLOC<a name='1409'></font>
         endif <font color=#447700>! alpha &lt; 0<a name='1410'></font>
         endif <font color=#447700>! xland1 = 2<a name='1411'></font>
<a name='1412'>
#endif<a name='1413'>
      enddo     <font color=#447700>! I loop<a name='1414'></font>
<a name='1415'>
<a name='1416'>
<font color=#447700>!<a name='1417'></font>
<font color=#447700>! compute diffusion coefficients based on local scheme above pbl<a name='1418'></font>
<font color=#447700>!<a name='1419'></font>
      do k = 1, km1<a name='1420'>
         do i=1,im<a name='1421'>
            if(k &gt;= kpbl(i)) then<a name='1422'>
               bvf2 = g*bf(i,k)*ti(i,k)<a name='1423'>
               ri   = max(bvf2/shr2(i,k),rimin)<a name='1424'>
               zk   = vk*zi(i,k+1)<a name='1425'>
               if(ri &lt; 0.) then <font color=#447700>! unstable regime<a name='1426'></font>
                  rl2      = zk*rlamun/(rlamun+zk)<a name='1427'>
                  dk       = rl2*rl2*sqrt(shr2(i,k))<a name='1428'>
                  sri      = sqrt(-ri)<a name='1429'>
<font color=#447700>!                 dku(i,k) = xkzmo(i,k) + dk*(1+8.*(-ri)/(1+1.746*sri))<a name='1430'></font>
<font color=#447700>!                 dkt(i,k) = xkzo(i,k)  + dk*(1+8.*(-ri)/(1+1.286*sri))<a name='1431'></font>
                  dku(i,k) = dk*(1+8.*(-ri)/(1+1.746*sri))<a name='1432'>
                  dkt(i,k) = dk*(1+8.*(-ri)/(1+1.286*sri))<a name='1433'>
               else             <font color=#447700>! stable regime<a name='1434'></font>
                  rl2      = zk*rlam/(rlam+zk)<a name='1435'>
<font color=#447700>!!                tem      = rlam * sqrt(0.01*prsi(i,k))<a name='1436'></font>
<font color=#447700>!!                rl2      = zk*tem/(tem+zk)<a name='1437'></font>
                  dk       = rl2*rl2*sqrt(shr2(i,k))<a name='1438'>
                  tem1     = dk/(1+5.*ri)**2<a name='1439'>
<font color=#447700>!<a name='1440'></font>
                  if(k &gt;= kpblx(i)) then<a name='1441'>
                    prnum = 1.0 + 2.1*ri<a name='1442'>
                    prnum = min(prnum,prmax)<a name='1443'>
                  else<a name='1444'>
                    prnum = 1.0<a name='1445'>
                  endif<a name='1446'>
<font color=#447700>!                 dku(i,k) = xkzmo(i,k) + tem1 * prnum<a name='1447'></font>
<font color=#447700>!                 dkt(i,k) = xkzo(i,k)  + tem1<a name='1448'></font>
                  dku(i,k) = tem1 * prnum<a name='1449'>
                  dkt(i,k) = tem1<a name='1450'>
               endif<a name='1451'>
<font color=#447700>!<a name='1452'></font>
               dku(i,k) = min(dku(i,k),dkmax)<a name='1453'>
               dku(i,k) = max(dku(i,k),xkzmo(i,k))<a name='1454'>
               dkt(i,k) = min(dkt(i,k),dkmax)<a name='1455'>
               dkt(i,k) = max(dkt(i,k),xkzo(i,k))<a name='1456'>
<font color=#447700>!<a name='1457'></font>
            endif<a name='1458'>
<font color=#447700>!<a name='1459'></font>
         enddo<a name='1460'>
      enddo<a name='1461'>
<font color=#447700>!<a name='1462'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1463'></font>
<font color=#447700>!  compute components for mass flux mixing by large thermals<a name='1464'></font>
<font color=#447700>!<a name='1465'></font>
      do k = 1, km<a name='1466'>
        do i = 1, im<a name='1467'>
          if(pcnvflg(i)) then<a name='1468'>
            tcko(i,k) = t1(i,k)<a name='1469'>
            ucko(i,k) = u1(i,k)<a name='1470'>
            vcko(i,k) = v1(i,k)<a name='1471'>
            xmf(i,k) = 0.<a name='1472'>
          endif<a name='1473'>
        enddo<a name='1474'>
      enddo<a name='1475'>
      do kk = 1, ntrac<a name='1476'>
      do k = 1, km<a name='1477'>
        do i = 1, im<a name='1478'>
          if(pcnvflg(i)) then<a name='1479'>
            qcko(i,k,kk) = q1(i,k,kk)<a name='1480'>
          endif<a name='1481'>
        enddo<a name='1482'>
      enddo<a name='1483'>
      enddo<a name='1484'>
<font color=#447700>!<a name='1485'></font>
      call <A href='../../html_code/phys/module_bl_gfsedmf.F.html#MFPBL'>mfpbl</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MFPBL_1">(im,ix,km,ntrac,dt2,pcnvflg,                  &amp;<a name='1486'>
     &amp;       zl,zi,thvx,q1,t1,u1,v1,hpbl,kpbl,                &amp;<a name='1487'>
     &amp;       sflux,ustar,wstar,xmf,tcko,qcko,ucko,vcko)<a name='1488'>
<font color=#447700>!<a name='1489'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1490'></font>
<font color=#447700>!  compute diffusion coefficients for cloud-top driven diffusion<a name='1491'></font>
<font color=#447700>!  if the condition for cloud-top instability is met,<a name='1492'></font>
<font color=#447700>!    increase entrainment flux at cloud top<a name='1493'></font>
<font color=#447700>!<a name='1494'></font>
      do i = 1, im<a name='1495'>
        if(scuflg(i)) then<a name='1496'>
           k = krad(i)<a name='1497'>
           tem = <A href='../../html_code/phys/module_diag_afwa.F.html#THETAE'>thetae</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETAE_1">(i,k) - thetae(i,k+1)<a name='1498'>
           tem1 = qtx(i,k) - qtx(i,k+1)<a name='1499'>
           if (tem &gt; 0. .and. tem1 &gt; 0.) then<a name='1500'>
             cteit= cp*tem/(hvap*tem1)<a name='1501'>
             if(cteit &gt; actei) rent(i) = rentf2<a name='1502'>
           endif<a name='1503'>
        endif<a name='1504'>
      enddo<a name='1505'>
      do i = 1, im<a name='1506'>
        if(scuflg(i)) then<a name='1507'>
           k = krad(i)<a name='1508'>
           tem1  = max(bf(i,k),tdzmin)<a name='1509'>
           ckt(i,k) = -rent(i)*radmin(i)/tem1<a name='1510'>
           cku(i,k) = ckt(i,k)<a name='1511'>
        endif<a name='1512'>
      enddo<a name='1513'>
<font color=#447700>!<a name='1514'></font>
      do k = 1, kmpbl<a name='1515'>
         do i=1,im<a name='1516'>
            if(scuflg(i) .and. k &lt; krad(i)) then<a name='1517'>
               tem1=hrad(i)-zd(i)<a name='1518'>
               tem2=zi(i,k+1)-tem1<a name='1519'>
               if(tem2 &gt; 0.) then<a name='1520'>
                  ptem= tem2/zd(i)<a name='1521'>
                  if(ptem.ge.1.) ptem= 1.<a name='1522'>
                  ptem= tem2*ptem*sqrt(1.-ptem)<a name='1523'>
                  ckt(i,k) = radfac*vk*vrad(i)*ptem<a name='1524'>
                  cku(i,k) = 0.75*ckt(i,k)<a name='1525'>
                  ckt(i,k) = max(ckt(i,k),dkmin)<a name='1526'>
                  ckt(i,k) = min(ckt(i,k),dkmax)<a name='1527'>
                  cku(i,k) = max(cku(i,k),dkmin)<a name='1528'>
                  cku(i,k) = min(cku(i,k),dkmax)<a name='1529'>
               endif<a name='1530'>
            endif<a name='1531'>
         enddo<a name='1532'>
      enddo<a name='1533'>
<font color=#447700>!<a name='1534'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1535'></font>
<font color=#447700>!<a name='1536'></font>
      do k = 1, kmpbl<a name='1537'>
        do i=1,im<a name='1538'>
          if(scuflg(i)) then<a name='1539'>
            <font color=#447700>! dkt(i,k) = dkt(i,k)+ckt(i,k)<a name='1540'></font>
            <font color=#447700>! dku(i,k) = dku(i,k)+cku(i,k)<a name='1541'></font>
         <font color=#447700>!! if K needs to be adjusted by alpha, then no need to add this term<a name='1542'></font>
            if(alpha == 1.0)  dkt(i,k) = dkt(i,k)+ckt(i,k)<a name='1543'>
            if(alpha == 1.0)  dku(i,k) = dku(i,k)+cku(i,k)<a name='1544'>
             dkt(i,k) = min(dkt(i,k),dkmax)<a name='1545'>
             dku(i,k) = min(dku(i,k),dkmax)<a name='1546'>
          endif<a name='1547'>
        enddo<a name='1548'>
      enddo<a name='1549'>
<font color=#447700>!<a name='1550'></font>
<font color=#447700>!     compute tridiagonal matrix elements for heat and moisture<a name='1551'></font>
<font color=#447700>!<a name='1552'></font>
      do i=1,im<a name='1553'>
         ad(i,1) = 1.<a name='1554'>
         a1(i,1) = t1(i,1)   + beta(i) * heat(i)<a name='1555'>
         a2(i,1) = q1(i,1,1) + beta(i) * evap(i)<a name='1556'>
      enddo<a name='1557'>
<a name='1558'>
      if(ntrac &gt;= 2) then<a name='1559'>
        do k = 2, ntrac<a name='1560'>
          is = (k-1) * km<a name='1561'>
          do i = 1, im<a name='1562'>
            a2(i,1+is) = q1(i,1,k)<a name='1563'>
          enddo<a name='1564'>
        enddo<a name='1565'>
      endif<a name='1566'>
<font color=#447700>!<a name='1567'></font>
      do k = 1,km1<a name='1568'>
        do i = 1,im<a name='1569'>
          dtodsd = dt2/del(i,k)<a name='1570'>
          dtodsu = dt2/del(i,k+1)<a name='1571'>
          dsig   = prsl(i,k)-prsl(i,k+1)<a name='1572'>
          rdz    = rdzt(i,k)<a name='1573'>
          tem1   = dsig * dkt(i,k) * rdz<a name='1574'>
          dsdz2     = tem1 * rdz<a name='1575'>
          au(i,k)   = -dtodsd*dsdz2<a name='1576'>
          al(i,k)   = -dtodsu*dsdz2<a name='1577'>
<font color=#447700>!<a name='1578'></font>
          if(pcnvflg(i) .and. k &lt; kpbl(i)) then<a name='1579'>
             tem2      = dsig * rdz<a name='1580'>
             ptem      = 0.5 * tem2 * xmf(i,k)<a name='1581'>
             ptem1     = dtodsd * ptem<a name='1582'>
             ptem2     = dtodsu * ptem<a name='1583'>
             ad(i,k)   = ad(i,k)-au(i,k)-ptem1<a name='1584'>
             ad(i,k+1) = 1.-al(i,k)+ptem2<a name='1585'>
             au(i,k)   = au(i,k)-ptem1<a name='1586'>
             al(i,k)   = al(i,k)+ptem2<a name='1587'>
             ptem      = tcko(i,k) + tcko(i,k+1)<a name='1588'>
             dsdzt     = tem1 * gocp<a name='1589'>
             a1(i,k)   = a1(i,k)+dtodsd*dsdzt-ptem1*ptem<a name='1590'>
             a1(i,k+1) = t1(i,k+1)-dtodsu*dsdzt+ptem2*ptem<a name='1591'>
             ptem      = qcko(i,k,1) + qcko(i,k+1,1)<a name='1592'>
             a2(i,k)   = a2(i,k) - ptem1 * ptem<a name='1593'>
             a2(i,k+1) = q1(i,k+1,1) + ptem2 * ptem<a name='1594'>
          elseif(ublflg(i) .and. k &lt; kpbl(i)) then<a name='1595'>
             ptem1 = dsig * dktx(i,k) * rdz<a name='1596'>
             tem   = 1.0 / hpbl(i)<a name='1597'>
             dsdzt = tem1 * gocp - ptem1 * hgamt(i) * tem<a name='1598'>
             dsdzq = - ptem1 * hgamq(i) * tem<a name='1599'>
             ad(i,k)   = ad(i,k)-au(i,k)<a name='1600'>
             ad(i,k+1) = 1.-al(i,k)<a name='1601'>
             a1(i,k)   = a1(i,k)+dtodsd*dsdzt<a name='1602'>
             a1(i,k+1) = t1(i,k+1)-dtodsu*dsdzt<a name='1603'>
             a2(i,k)   = a2(i,k)+dtodsd*dsdzq<a name='1604'>
             a2(i,k+1) = q1(i,k+1,1)-dtodsu*dsdzq<a name='1605'>
          else<a name='1606'>
             ad(i,k)   = ad(i,k)-au(i,k)<a name='1607'>
             ad(i,k+1) = 1.-al(i,k)<a name='1608'>
             dsdzt     = tem1 * gocp<a name='1609'>
             a1(i,k)   = a1(i,k)+dtodsd*dsdzt<a name='1610'>
             a1(i,k+1) = t1(i,k+1)-dtodsu*dsdzt<a name='1611'>
             a2(i,k+1) = q1(i,k+1,1)<a name='1612'>
          endif<a name='1613'>
<font color=#447700>!<a name='1614'></font>
        enddo<a name='1615'>
      enddo<a name='1616'>
<font color=#447700>!<a name='1617'></font>
      if(ntrac &gt;= 2) then<a name='1618'>
        do kk = 2, ntrac<a name='1619'>
          is = (kk-1) * km<a name='1620'>
          do k = 1, km1<a name='1621'>
            do i = 1, im<a name='1622'>
              if(pcnvflg(i) .and. k &lt; kpbl(i)) then<a name='1623'>
                dtodsd = dt2/del(i,k)<a name='1624'>
                dtodsu = dt2/del(i,k+1)<a name='1625'>
                dsig  = prsl(i,k)-prsl(i,k+1)<a name='1626'>
                tem   = dsig * rdzt(i,k)<a name='1627'>
                ptem  = 0.5 * tem * xmf(i,k)<a name='1628'>
                ptem1 = dtodsd * ptem<a name='1629'>
                ptem2 = dtodsu * ptem<a name='1630'>
                tem1  = qcko(i,k,kk) + qcko(i,k+1,kk)<a name='1631'>
                a2(i,k+is) = a2(i,k+is) - ptem1*tem1<a name='1632'>
                a2(i,k+1+is)= q1(i,k+1,kk) + ptem2*tem1<a name='1633'>
              else<a name='1634'>
                a2(i,k+1+is) = q1(i,k+1,kk)<a name='1635'>
              endif<a name='1636'>
            enddo<a name='1637'>
          enddo<a name='1638'>
        enddo<a name='1639'>
      endif<a name='1640'>
<font color=#447700>!<a name='1641'></font>
<font color=#447700>!     solve tridiagonal problem for heat and moisture<a name='1642'></font>
<font color=#447700>!<a name='1643'></font>
      call <A href='../../html_code/phys/module_bl_gfsedmf.F.html#TRIDIN'>tridin</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIN_2">(im,km,ntrac,al,ad,au,a1,a2,au,a1,a2)<a name='1644'>
<a name='1645'>
<font color=#447700>!<a name='1646'></font>
<font color=#447700>!     recover tendencies of heat and moisture<a name='1647'></font>
<font color=#447700>!<a name='1648'></font>
      do  k = 1,km<a name='1649'>
         do i = 1,im<a name='1650'>
            ttend      = (a1(i,k)-t1(i,k)) * rdt<a name='1651'>
            qtend      = (a2(i,k)-q1(i,k,1))*rdt<a name='1652'>
            tau(i,k)   = tau(i,k)+ttend<a name='1653'>
            rtg(i,k,1) = rtg(i,k,1)+qtend<a name='1654'>
            dtsfc(i)   = dtsfc(i)+cont*del(i,k)*ttend<a name='1655'>
            dqsfc(i)   = dqsfc(i)+conq*del(i,k)*qtend<a name='1656'>
         enddo<a name='1657'>
      enddo<a name='1658'>
      if(ntrac &gt;= 2) then<a name='1659'>
        do kk = 2, ntrac<a name='1660'>
          is = (kk-1) * km<a name='1661'>
          do k = 1, km <a name='1662'>
            do i = 1, im<a name='1663'>
              qtend = (a2(i,k+is)-q1(i,k,kk))*rdt<a name='1664'>
              rtg(i,k,kk) = rtg(i,k,kk)+qtend<a name='1665'>
            enddo<a name='1666'>
          enddo<a name='1667'>
        enddo<a name='1668'>
      endif<a name='1669'>
<font color=#447700>!<a name='1670'></font>
<font color=#447700>!   compute tke dissipation rate<a name='1671'></font>
<font color=#447700>!<a name='1672'></font>
      if(dspheat) then<a name='1673'>
<font color=#447700>!<a name='1674'></font>
      do k = 1,km1<a name='1675'>
        do i = 1,im<a name='1676'>
          diss(i,k) = dku(i,k)*shr2(i,k)-g*ti(i,k)*dkt(i,k)*bf(i,k)<a name='1677'>
<font color=#447700>!         diss(i,k) = dku(i,k)*shr2(i,k)<a name='1678'></font>
        enddo<a name='1679'>
      enddo<a name='1680'>
<font color=#447700>!<a name='1681'></font>
<font color=#447700>!     add dissipative heating at the first model layer<a name='1682'></font>
<font color=#447700>!<a name='1683'></font>
      do i = 1,im<a name='1684'>
         tem   = govrth(i)*sflux(i)<a name='1685'>
         tem1  = tem + stress(i)*spd1(i)/zl(i,1)<a name='1686'>
         tem2  = 0.5 * (tem1+diss(i,1)) <a name='1687'>
         tem2  = max(tem2, 0.)<a name='1688'>
         ttend = tem2 / cp<a name='1689'>
<font color=#447700>!         tau(i,1) = tau(i,1)+0.5*ttend<a name='1690'></font>
         tau(i,1) = tau(i,1)+0.7*ttend<a name='1691'>
      enddo<a name='1692'>
<font color=#447700>!<a name='1693'></font>
<font color=#447700>!     add dissipative heating above the first model layer<a name='1694'></font>
<font color=#447700>!<a name='1695'></font>
      do k = 2,km1<a name='1696'>
        do i = 1,im<a name='1697'>
          tem = 0.5 * (diss(i,k-1)+diss(i,k))<a name='1698'>
          tem  = max(tem, 0.)<a name='1699'>
          ttend = tem / cp<a name='1700'>
<font color=#447700>!          tau(i,k) = tau(i,k) + 0.5*ttend<a name='1701'></font>
          tau(i,k) = tau(i,k) + 0.7*ttend<a name='1702'>
        enddo<a name='1703'>
      enddo<a name='1704'>
<font color=#447700>!<a name='1705'></font>
      endif<a name='1706'>
<font color=#447700>!<a name='1707'></font>
<font color=#447700>!     compute tridiagonal matrix elements for momentum<a name='1708'></font>
<font color=#447700>!<a name='1709'></font>
      do i=1,im<a name='1710'>
         ad(i,1) = 1.0 + beta(i) * stress(i) / spd1(i)<a name='1711'>
         a1(i,1) = u1(i,1)<a name='1712'>
         a2(i,1) = v1(i,1)<a name='1713'>
      enddo<a name='1714'>
<font color=#447700>!<a name='1715'></font>
      do k = 1,km1<a name='1716'>
        do i=1,im<a name='1717'>
          dtodsd  = dt2/del(i,k)<a name='1718'>
          dtodsu  = dt2/del(i,k+1)<a name='1719'>
          dsig    = prsl(i,k)-prsl(i,k+1)<a name='1720'>
          rdz     = rdzt(i,k)<a name='1721'>
          tem1    = dsig*dku(i,k)*rdz<a name='1722'>
          dsdz2   = tem1 * rdz<a name='1723'>
          au(i,k) = -dtodsd*dsdz2<a name='1724'>
          al(i,k) = -dtodsu*dsdz2<a name='1725'>
<font color=#447700>!<a name='1726'></font>
          if(pcnvflg(i) .and. k &lt; kpbl(i)) then<a name='1727'>
             tem2      = dsig * rdz<a name='1728'>
             ptem      = 0.5 * tem2 * xmf(i,k)<a name='1729'>
             ptem1     = dtodsd * ptem<a name='1730'>
             ptem2     = dtodsu * ptem<a name='1731'>
             ad(i,k)   = ad(i,k)-au(i,k)-ptem1<a name='1732'>
             ad(i,k+1) = 1.-al(i,k)+ptem2<a name='1733'>
             au(i,k)   = au(i,k)-ptem1<a name='1734'>
             al(i,k)   = al(i,k)+ptem2<a name='1735'>
             ptem      = ucko(i,k) + ucko(i,k+1)<a name='1736'>
             a1(i,k)   = a1(i,k) - ptem1 * ptem<a name='1737'>
             a1(i,k+1) = u1(i,k+1) + ptem2 * ptem<a name='1738'>
             ptem      = vcko(i,k) + vcko(i,k+1)<a name='1739'>
             a2(i,k)   = a2(i,k) - ptem1 * ptem<a name='1740'>
             a2(i,k+1) = v1(i,k+1) + ptem2 * ptem<a name='1741'>
          else<a name='1742'>
             ad(i,k)   = ad(i,k)-au(i,k)<a name='1743'>
             ad(i,k+1) = 1.-al(i,k)<a name='1744'>
             a1(i,k+1) = u1(i,k+1)<a name='1745'>
             a2(i,k+1) = v1(i,k+1)<a name='1746'>
          endif<a name='1747'>
<font color=#447700>!<a name='1748'></font>
        enddo<a name='1749'>
      enddo<a name='1750'>
<font color=#447700>!<a name='1751'></font>
<font color=#447700>!     solve tridiagonal problem for momentum<a name='1752'></font>
<font color=#447700>!<a name='1753'></font>
      call <A href='../../html_code/phys/module_bl_mrf.F.html#TRIDI2'>tridi2</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MONINEDMF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDI2_2">(im,km,al,ad,au,a1,a2,au,a1,a2)<a name='1754'>
<font color=#447700>!<a name='1755'></font>
<font color=#447700>!     recover tendencies of momentum<a name='1756'></font>
<font color=#447700>!<a name='1757'></font>
      do k = 1,km<a name='1758'>
         do i = 1,im<a name='1759'>
            utend = (a1(i,k)-u1(i,k))*rdt<a name='1760'>
            vtend = (a2(i,k)-v1(i,k))*rdt<a name='1761'>
            du(i,k)  = du(i,k)  + utend<a name='1762'>
            dv(i,k)  = dv(i,k)  + vtend<a name='1763'>
            dusfc(i) = dusfc(i) + conw*del(i,k)*utend<a name='1764'>
            dvsfc(i) = dvsfc(i) + conw*del(i,k)*vtend<a name='1765'>
<font color=#447700>!<a name='1766'></font>
<font color=#447700>!  for dissipative heating for ecmwf model<a name='1767'></font>
<font color=#447700>!<a name='1768'></font>
<font color=#447700>!           tem1 = 0.5*(a1(i,k)+u1(i,k))<a name='1769'></font>
<font color=#447700>!           tem2 = 0.5*(a2(i,k)+v1(i,k))<a name='1770'></font>
<font color=#447700>!           diss(i,k) = -(tem1*utend+tem2*vtend)<a name='1771'></font>
<font color=#447700>!           diss(i,k) = max(diss(i,k),0.)<a name='1772'></font>
<font color=#447700>!           ttend = diss(i,k) / cp<a name='1773'></font>
<font color=#447700>!           tau(i,k) = tau(i,k) + ttend<a name='1774'></font>
<font color=#447700>!<a name='1775'></font>
         enddo<a name='1776'>
      enddo<a name='1777'>
<font color=#447700>!<a name='1778'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1779'></font>
<font color=#447700>!<a name='1780'></font>
      do i = 1, im<a name='1781'>
         hpbl(i) = hpblx(i)<a name='1782'>
         kpbl(i) = kpblx(i)<a name='1783'>
      enddo<a name='1784'>
<font color=#447700>!<a name='1785'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1786'></font>
      return<a name='1787'>
      end subroutine moninedmf<a name='1788'>
<font color=#447700>!c-----------------------------------------------------------------------<a name='1789'></font>
<A NAME='TRIDI2'><A href='../../html_code/phys/module_bl_gfsedmf.F.html#TRIDI2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1790'>
      <font color=#993300>subroutine </font><font color=#cc0000>tridi2</font>(l,n,cl,cm,cu,r1,r2,au,a1,a2) <A href='../../call_to/TRIDI2.html' TARGET='index'>5</A>,<A href='../../call_from/TRIDI2.html' TARGET='index'>2</A><a name='1791'>
<font color=#447700>!cc<a name='1792'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_bl_mrf.F.html#TRIDI2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_8">, only : kind_phys<a name='1793'>
      implicit none<a name='1794'>
      integer             k,n,l,i<a name='1795'>
      real(kind=kind_phys) fk<a name='1796'>
<font color=#447700>!cc<a name='1797'></font>
      real(kind=kind_phys) cl(l,2:n),cm(l,n),cu(l,n-1),r1(l,n),r2(l,n), &amp;<a name='1798'>
     &amp;          au(l,n-1),a1(l,n),a2(l,n)<a name='1799'>
<font color=#447700>!c-----------------------------------------------------------------------<a name='1800'></font>
      do i=1,l<a name='1801'>
        fk      = 1./cm(i,1)<a name='1802'>
        au(i,1) = fk*cu(i,1)<a name='1803'>
        a1(i,1) = fk*r1(i,1)<a name='1804'>
        a2(i,1) = fk*r2(i,1)<a name='1805'>
      enddo<a name='1806'>
      do k=2,n-1<a name='1807'>
        do i=1,l<a name='1808'>
          fk      = 1./(cm(i,k)-cl(i,k)*au(i,k-1))<a name='1809'>
          au(i,k) = fk*cu(i,k)<a name='1810'>
          a1(i,k) = fk*(r1(i,k)-cl(i,k)*a1(i,k-1))<a name='1811'>
          a2(i,k) = fk*(r2(i,k)-cl(i,k)*a2(i,k-1))<a name='1812'>
        enddo<a name='1813'>
      enddo<a name='1814'>
      do i=1,l<a name='1815'>
        fk      = 1./(cm(i,n)-cl(i,n)*au(i,n-1))<a name='1816'>
        a1(i,n) = fk*(r1(i,n)-cl(i,n)*a1(i,n-1))<a name='1817'>
        a2(i,n) = fk*(r2(i,n)-cl(i,n)*a2(i,n-1))<a name='1818'>
      enddo<a name='1819'>
      do k=n-1,1,-1<a name='1820'>
        do i=1,l<a name='1821'>
          a1(i,k) = a1(i,k)-au(i,k)*a1(i,k+1)<a name='1822'>
          a2(i,k) = a2(i,k)-au(i,k)*a2(i,k+1)<a name='1823'>
        enddo<a name='1824'>
      enddo<a name='1825'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1826'></font>
      return<a name='1827'>
      end subroutine tridi2<a name='1828'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1829'></font>
<A NAME='TRIDIN'><A href='../../html_code/phys/module_bl_gfsedmf.F.html#TRIDIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1830'>
      <font color=#993300>subroutine </font><font color=#cc0000>tridin</font>(l,n,nt,cl,cm,cu,r1,r2,au,a1,a2) <A href='../../call_to/TRIDIN.html' TARGET='index'>2</A>,<A href='../../call_from/TRIDIN.html' TARGET='index'>2</A><a name='1831'>
<font color=#447700>!!<a name='1832'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#TRIDIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_9">     , only : kind_phys<a name='1833'>
      implicit none<a name='1834'>
      integer             is,k,kk,n,nt,l,i<a name='1835'>
      real(kind=kind_phys) fk(l)<a name='1836'>
<font color=#447700>!!<a name='1837'></font>
      real(kind=kind_phys) cl(l,2:n), cm(l,n), cu(l,n-1),     &amp;<a name='1838'>
     &amp;                     r1(l,n),   r2(l,n*nt),             &amp;<a name='1839'>
     &amp;                     au(l,n-1), a1(l,n), a2(l,n*nt),    &amp;  <a name='1840'>
     &amp;                     fkk(l,2:n-1)<a name='1841'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1842'></font>
      do i=1,l<a name='1843'>
        fk(i)   = 1./cm(i,1)<a name='1844'>
        au(i,1) = fk(i)*cu(i,1)<a name='1845'>
        a1(i,1) = fk(i)*r1(i,1)<a name='1846'>
      enddo<a name='1847'>
      do k = 1, nt<a name='1848'>
        is = (k-1) * n<a name='1849'>
        do i = 1, l<a name='1850'>
          a2(i,1+is) = fk(i) * r2(i,1+is)<a name='1851'>
        enddo<a name='1852'>
      enddo<a name='1853'>
      do k=2,n-1<a name='1854'>
        do i=1,l<a name='1855'>
          fkk(i,k) = 1./(cm(i,k)-cl(i,k)*au(i,k-1))<a name='1856'>
          au(i,k)  = fkk(i,k)*cu(i,k)<a name='1857'>
          a1(i,k)  = fkk(i,k)*(r1(i,k)-cl(i,k)*a1(i,k-1))<a name='1858'>
        enddo<a name='1859'>
      enddo<a name='1860'>
      do kk = 1, nt<a name='1861'>
        is = (kk-1) * n<a name='1862'>
        do k=2,n-1<a name='1863'>
          do i=1,l<a name='1864'>
            a2(i,k+is) = fkk(i,k)*(r2(i,k+is)-cl(i,k)*a2(i,k+is-1))<a name='1865'>
          enddo<a name='1866'>
        enddo<a name='1867'>
      enddo<a name='1868'>
      do i=1,l<a name='1869'>
        fk(i)   = 1./(cm(i,n)-cl(i,n)*au(i,n-1))<a name='1870'>
        a1(i,n) = fk(i)*(r1(i,n)-cl(i,n)*a1(i,n-1))<a name='1871'>
      enddo<a name='1872'>
      do k = 1, nt<a name='1873'>
        is = (k-1) * n<a name='1874'>
        do i = 1, l<a name='1875'>
          a2(i,n+is) = fk(i)*(r2(i,n+is)-cl(i,n)*a2(i,n+is-1))<a name='1876'>
        enddo<a name='1877'>
      enddo<a name='1878'>
      do k=n-1,1,-1<a name='1879'>
        do i=1,l<a name='1880'>
          a1(i,k) = a1(i,k) - au(i,k)*a1(i,k+1)<a name='1881'>
        enddo<a name='1882'>
      enddo<a name='1883'>
      do kk = 1, nt<a name='1884'>
        is = (kk-1) * n<a name='1885'>
        do k=n-1,1,-1<a name='1886'>
          do i=1,l<a name='1887'>
            a2(i,k+is) = a2(i,k+is) - au(i,k)*a2(i,k+is+1)<a name='1888'>
          enddo<a name='1889'>
        enddo<a name='1890'>
      enddo<a name='1891'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1892'></font>
      return<a name='1893'>
      end subroutine tridin<a name='1894'>
<font color=#447700>!----------------------------------------------------------------------<a name='1895'></font>
<a name='1896'>
<font color=#447700>!!!!!  ==========================================================  !!!!!<a name='1897'></font>
<font color=#447700>! subroutine 'mfpbl' computes mass-flux components, called by <a name='1898'></font>
<font color=#447700>!  subroutine 'moninedmf'.<a name='1899'></font>
<font color=#447700>!<a name='1900'></font>
<A NAME='MFPBL'><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MFPBL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1901'>
      <font color=#993300>subroutine </font><font color=#cc0000>mfpbl</font>(im,ix,km,ntrac,delt,cnvflg,          &amp; <A href='../../call_to/MFPBL.html' TARGET='index'>1</A>,<A href='../../call_from/MFPBL.html' TARGET='index'>2</A><a name='1902'>
     &amp;   zl,zm,thvx,q1,t1,u1,v1,hpbl,kpbl,                  &amp;<a name='1903'>
     &amp;   sflx,ustar,wstar,xmf,tcko,qcko,ucko,vcko)<a name='1904'>
<font color=#447700>!<a name='1905'></font>
      USE <A href='../../html_code/phys/module_gfs_machine.F.html#MODULE_GFS_MACHINE'>MODULE_GFS_MACHINE</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MFPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_MACHINE_10">, only : kind_phys<a name='1906'>
      USE <A href='../../html_code/phys/module_gfs_physcons.F.html#MODULE_GFS_PHYSCONS'>MODULE_GFS_PHYSCONS</A><A href='../../html_code/phys/module_bl_gfsedmf.F.html#MFPBL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GFS_PHYSCONS_3">, grav =&gt; con_g, cp =&gt; con_cp<a name='1907'>
<font color=#447700>!<a name='1908'></font>
      implicit none<a name='1909'>
<font color=#447700>!<a name='1910'></font>
      integer              im, ix, km, ntrac<a name='1911'>
<font color=#447700>!    &amp;,                    me<a name='1912'></font>
      integer              kpbl(im)<a name='1913'>
      logical              cnvflg(im)<a name='1914'>
      real(kind=kind_phys) delt<a name='1915'>
      real(kind=kind_phys) q1(ix,km,ntrac), t1(ix,km),             &amp;<a name='1916'>
     &amp;                     u1(ix,km),  v1(ix,km),                  &amp;<a name='1917'>
     &amp;                     thvx(im,km),                            &amp;<a name='1918'>
     &amp;                     zl(im,km),  zm(im,km+1),                &amp;<a name='1919'>
     &amp;                     hpbl(im),   sflx(im),    ustar(im),     &amp;<a name='1920'>
     &amp;                     wstar(im),  xmf(im,km),                 &amp;<a name='1921'>
     &amp;                     tcko(im,km),qcko(im,km,ntrac),          &amp; <a name='1922'>
     &amp;                     ucko(im,km),vcko(im,km)                 <a name='1923'>
<font color=#447700>!<a name='1924'></font>
<font color=#447700>!c  local variables and arrays<a name='1925'></font>
<font color=#447700>!<a name='1926'></font>
      integer   i, j, k, n, kmpbl<a name='1927'>
<font color=#447700>!<a name='1928'></font>
      real(kind=kind_phys) dt2,     dz,      ce0,                 &amp;<a name='1929'>
     &amp;                     h1,      factor,  gocp,                &amp;<a name='1930'>
     &amp;                     g,       c1,      d1,                  &amp;<a name='1931'>
     &amp;                     b1,      f1,      bb1,     bb2,        &amp; <a name='1932'>
     &amp;                     alp,     a1,      qmin,    zfmin,      &amp;<a name='1933'>
     &amp;                     xmmx,    rbint,   tau,                 &amp;<a name='1934'>
<font color=#447700>!    &amp;                     rbint,   tau,                          &amp;<a name='1935'></font>
     &amp;                     tem,     tem1,    tem2,                &amp;<a name='1936'>
     &amp;                     ptem,    ptem1,   ptem2,               &amp;  <a name='1937'>
     &amp;                     pgcon<a name='1938'>
<font color=#447700>!<a name='1939'></font>
      real(kind=kind_phys) sigw1(im),   usws3(im),  xlamax(im),   &amp;<a name='1940'>
     &amp;                     rbdn(im),    rbup(im),   delz(im)<a name='1941'>
<font color=#447700>!<a name='1942'></font>
      real(kind=kind_phys) wu2(im,km),     xlamue(im,km),         &amp;<a name='1943'>
     &amp;                     thvu(im,km),    zi(im,km),             &amp;<a name='1944'>
     &amp;                     buo(im,km)<a name='1945'>
<font color=#447700>!<a name='1946'></font>
      logical totflg, flg(im)<a name='1947'>
<font color=#447700>!<a name='1948'></font>
<font color=#447700>!c  physical parameters<a name='1949'></font>
      parameter(g=grav)<a name='1950'>
      parameter(gocp=g/cp)<a name='1951'>
<font color=#447700>!     parameter(ce0=0.37,qmin=1.e-8,alp=1.0,pgcon=0.55)<a name='1952'></font>
      parameter(ce0=0.38,qmin=1.e-8,alp=1.0,pgcon=0.55)<a name='1953'>
      parameter(a1=0.08,b1=0.5,f1=0.15,c1=0.3,d1=2.58,tau=500.)<a name='1954'>
      parameter(zfmin=1.e-8,h1=0.33333333)<a name='1955'>
<font color=#447700>!<a name='1956'></font>
<font color=#447700>!c-----------------------------------------------------------------------<a name='1957'></font>
<font color=#447700>!<a name='1958'></font>
<font color=#447700>!************************************************************************<a name='1959'></font>
<font color=#447700>!<a name='1960'></font>
      kmpbl = km/2 + 1<a name='1961'>
      dt2 = delt<a name='1962'>
<font color=#447700>!!<a name='1963'></font>
      totflg = .true.<a name='1964'>
      do i=1,im<a name='1965'>
        totflg = totflg .and. (.not. cnvflg(i))<a name='1966'>
      enddo<a name='1967'>
      if(totflg) return<a name='1968'>
<font color=#447700>!!<a name='1969'></font>
      do k = 1, km<a name='1970'>
        do i=1,im<a name='1971'>
          if (cnvflg(i)) then<a name='1972'>
            zi(i,k) = zm(i,k+1)<a name='1973'>
          endif<a name='1974'>
        enddo<a name='1975'>
      enddo<a name='1976'>
<font color=#447700>!<a name='1977'></font>
      do i=1,im<a name='1978'>
        if(cnvflg(i)) then <a name='1979'>
          k = kpbl(i) / 2<a name='1980'>
          k = max(k, 1) <a name='1981'>
          delz(i) = zl(i,k+1) - zl(i,k)<a name='1982'>
          xlamax(i) = ce0 / delz(i)<a name='1983'>
        endif<a name='1984'>
      enddo<a name='1985'>
      do k = 1, kmpbl<a name='1986'>
        do i=1,im<a name='1987'>
          if(cnvflg(i)) then<a name='1988'>
            if(k &lt; kpbl(i)) then<a name='1989'>
              ptem = 1./(zi(i,k)+delz(i))<a name='1990'>
              tem = max((hpbl(i)-zi(i,k)+delz(i)) ,delz(i))<a name='1991'>
              ptem1 = 1./tem<a name='1992'>
              xlamue(i,k) = ce0 * (ptem+ptem1)<a name='1993'>
            else<a name='1994'>
              xlamue(i,k) = xlamax(i)<a name='1995'>
            endif<a name='1996'>
          endif<a name='1997'>
        enddo<a name='1998'>
      enddo<a name='1999'>
<font color=#447700>!<a name='2000'></font>
<font color=#447700>!  compute thermal excess<a name='2001'></font>
<font color=#447700>!<a name='2002'></font>
      do i=1,im<a name='2003'>
        if(cnvflg(i)) then<a name='2004'>
          tem = zl(i,1)/hpbl(i)<a name='2005'>
          usws3(i) = (ustar(i)/wstar(i))**3.<a name='2006'>
          tem1 = usws3(i) + 0.6*tem<a name='2007'>
          tem2 = max((1.-tem), zfmin)<a name='2008'>
          ptem = (tem1**h1) * sqrt(tem2)<a name='2009'>
          sigw1(i) = 1.3 * ptem * wstar(i)<a name='2010'>
          ptem1 = alp * sflx(i) / sigw1(i)<a name='2011'>
          thvu(i,1) = thvx(i,1) + ptem1<a name='2012'>
          buo(i,1) = g * (thvu(i,1)/thvx(i,1)-1.)<a name='2013'>
        endif<a name='2014'>
      enddo<a name='2015'>
<font color=#447700>!<a name='2016'></font>
<font color=#447700>!  compute potential temperature and buoyancy for updraft air parcel<a name='2017'></font>
<font color=#447700>!<a name='2018'></font>
      do k = 2, kmpbl<a name='2019'>
        do i=1,im<a name='2020'>
          if(cnvflg(i)) then<a name='2021'>
            dz = zl(i,k) - zl(i,k-1)<a name='2022'>
            tem = xlamue(i,k-1) * dz<a name='2023'>
            ptem = 2. + tem<a name='2024'>
            ptem1 = (2. - tem) / ptem<a name='2025'>
            tem1 = tem  * (thvx(i,k)+thvx(i,k-1)) / ptem<a name='2026'>
            thvu(i,k) = ptem1 * thvu(i,k-1) + tem1<a name='2027'>
            buo(i,k) = g * (thvu(i,k)/thvx(i,k)-1.)<a name='2028'>
          endif<a name='2029'>
        enddo<a name='2030'>
      enddo<a name='2031'>
<font color=#447700>!<a name='2032'></font>
<font color=#447700>!  compute updraft velocity square(wu2)<a name='2033'></font>
<font color=#447700>!<a name='2034'></font>
<font color=#447700>!     tem = 1.-2.*f1<a name='2035'></font>
<font color=#447700>!     bb1 = 2. * b1 / tem<a name='2036'></font>
<font color=#447700>!     bb2 = 2. / tem<a name='2037'></font>
<font color=#447700>!  from soares et al. (2004,qjrms)<a name='2038'></font>
<font color=#447700>!     bb1 = 2.<a name='2039'></font>
<font color=#447700>!     bb2 = 4.<a name='2040'></font>
<font color=#447700>!<a name='2041'></font>
<font color=#447700>!  from bretherton et al. (2004, mwr)<a name='2042'></font>
<font color=#447700>!     bb1 = 4.<a name='2043'></font>
<font color=#447700>!     bb2 = 2.<a name='2044'></font>
<font color=#447700>!<a name='2045'></font>
<font color=#447700>!  from our tuning<a name='2046'></font>
      bb1 = 1.8<a name='2047'>
      bb2 = 3.5 <a name='2048'>
<font color=#447700>!<a name='2049'></font>
      do i = 1, im<a name='2050'>
        if(cnvflg(i)) then<a name='2051'>
<font color=#447700>!<a name='2052'></font>
<font color=#447700>!         tem = zi(i,1)/hpbl(i)<a name='2053'></font>
<font color=#447700>!         tem1 = usws3(i) + 0.6*tem<a name='2054'></font>
<font color=#447700>!         tem2 = max((1.-tem), zfmin)<a name='2055'></font>
<font color=#447700>!         ptem = (tem1**h1) * sqrt(tem2)<a name='2056'></font>
<font color=#447700>!         ptem1 = 1.3 * ptem * wstar(i)<a name='2057'></font>
<font color=#447700>!         wu2(i,1) = d1*d1*ptem1*ptem1<a name='2058'></font>
<font color=#447700>!<a name='2059'></font>
          dz   = zi(i,1)<a name='2060'>
          tem  = 0.5*bb1*xlamue(i,1)*dz<a name='2061'>
          tem1 = bb2 * buo(i,1) * dz<a name='2062'>
          ptem1 = 1. + tem<a name='2063'>
          wu2(i,1) = tem1 / ptem1<a name='2064'>
<font color=#447700>!<a name='2065'></font>
        endif<a name='2066'>
      enddo<a name='2067'>
      do k = 2, kmpbl<a name='2068'>
        do i = 1, im<a name='2069'>
          if(cnvflg(i)) then<a name='2070'>
            dz    = zi(i,k) - zi(i,k-1)<a name='2071'>
            tem  = 0.25*bb1*(xlamue(i,k)+xlamue(i,k-1))*dz<a name='2072'>
            tem1 = bb2 * buo(i,k) * dz<a name='2073'>
            ptem = (1. - tem) * wu2(i,k-1)<a name='2074'>
            ptem1 = 1. + tem<a name='2075'>
            wu2(i,k) = (ptem + tem1) / ptem1<a name='2076'>
          endif<a name='2077'>
        enddo<a name='2078'>
      enddo<a name='2079'>
<font color=#447700>!<a name='2080'></font>
<font color=#447700>!  update pbl height as the height where updraft velocity vanishes<a name='2081'></font>
<font color=#447700>!<a name='2082'></font>
      do i=1,im<a name='2083'>
         flg(i)  = .true.<a name='2084'>
         if(cnvflg(i)) then<a name='2085'>
           flg(i)  = .false.<a name='2086'>
           rbup(i) = wu2(i,1)<a name='2087'>
         endif<a name='2088'>
      enddo<a name='2089'>
      do k = 2, kmpbl<a name='2090'>
      do i = 1, im<a name='2091'>
        if(.not.flg(i)) then<a name='2092'>
          rbdn(i) = rbup(i)<a name='2093'>
          rbup(i) = wu2(i,k)<a name='2094'>
          kpbl(i) = k<a name='2095'>
          flg(i)  = rbup(i).le.0.<a name='2096'>
        endif<a name='2097'>
      enddo<a name='2098'>
      enddo<a name='2099'>
      do i = 1,im<a name='2100'>
        if(cnvflg(i)) then<a name='2101'>
           k = kpbl(i)<a name='2102'>
           if(rbdn(i) &lt;= 0.) then<a name='2103'>
              rbint = 0.<a name='2104'>
           elseif(rbup(i) &gt;= 0.) then<a name='2105'>
              rbint = 1.<a name='2106'>
           else<a name='2107'>
              rbint = rbdn(i)/(rbdn(i)-rbup(i))<a name='2108'>
           endif<a name='2109'>
           hpbl(i) = zi(i,k-1) + rbint*(zi(i,k)-zi(i,k-1))<a name='2110'>
        endif<a name='2111'>
      enddo<a name='2112'>
<font color=#447700>!c<a name='2113'></font>
      do i=1,im<a name='2114'>
        if(cnvflg(i)) then<a name='2115'>
          k = kpbl(i) / 2<a name='2116'>
          k = max(k, 1)<a name='2117'>
          delz(i) = zl(i,k+1) - zl(i,k)<a name='2118'>
          xlamax(i) = ce0 / delz(i)<a name='2119'>
        endif<a name='2120'>
      enddo<a name='2121'>
<font color=#447700>!<a name='2122'></font>
<font color=#447700>!  update entrainment rate<a name='2123'></font>
<font color=#447700>!<a name='2124'></font>
<font color=#447700>!     do k = 1, kmpbl<a name='2125'></font>
<font color=#447700>!       do i=1,im<a name='2126'></font>
<font color=#447700>!         if(cnvflg(i)) then<a name='2127'></font>
<font color=#447700>!           if(k &lt; kpbl(i)) then<a name='2128'></font>
<font color=#447700>!             tem = tau * sqrt(wu2(i,k))<a name='2129'></font>
<font color=#447700>!             tem1 = 1. / tem<a name='2130'></font>
<font color=#447700>!             ptem = ce0 / zi(i,k)<a name='2131'></font>
<font color=#447700>!             xlamue(i,k) = max(tem1, ptem)<a name='2132'></font>
<font color=#447700>!           else<a name='2133'></font>
<font color=#447700>!             xlamue(i,k) = xlamax(i)<a name='2134'></font>
<font color=#447700>!           endif<a name='2135'></font>
<font color=#447700>!         endif<a name='2136'></font>
<font color=#447700>!       enddo<a name='2137'></font>
<font color=#447700>!     enddo<a name='2138'></font>
<font color=#447700>!<a name='2139'></font>
      do k = 1, kmpbl<a name='2140'>
        do i=1,im<a name='2141'>
          if(cnvflg(i)) then<a name='2142'>
            if(k &lt; kpbl(i)) then<a name='2143'>
              ptem = 1./(zi(i,k)+delz(i))<a name='2144'>
              tem = max((hpbl(i)-zi(i,k)+delz(i)) ,delz(i))<a name='2145'>
              ptem1 = 1./tem<a name='2146'>
              xlamue(i,k) = ce0 * (ptem+ptem1)<a name='2147'>
            else<a name='2148'>
              xlamue(i,k) = xlamax(i)<a name='2149'>
            endif<a name='2150'>
          endif<a name='2151'>
        enddo<a name='2152'>
      enddo<a name='2153'>
<font color=#447700>!<a name='2154'></font>
<font color=#447700>!  updraft mass flux as a function of sigmaw<a name='2155'></font>
<font color=#447700>!   (0.3*sigmaw[square root of vertical turbulence variance])<a name='2156'></font>
<font color=#447700>!<a name='2157'></font>
<font color=#447700>!     do k = 1, kmpbl<a name='2158'></font>
<font color=#447700>!       do i=1,im<a name='2159'></font>
<font color=#447700>!         if(cnvflg(i) .and. k &lt; kpbl(i)) then<a name='2160'></font>
<font color=#447700>!           tem = zi(i,k)/hpbl(i)<a name='2161'></font>
<font color=#447700>!           tem1 = usws3(i) + 0.6*tem<a name='2162'></font>
<font color=#447700>!           tem2 = max((1.-tem), zfmin)<a name='2163'></font>
<font color=#447700>!           ptem = (tem1**h1) * sqrt(tem2)<a name='2164'></font>
<font color=#447700>!           ptem1 = 1.3 * ptem * wstar(i)<a name='2165'></font>
<font color=#447700>!           xmf(i,k) = c1 * ptem1<a name='2166'></font>
<font color=#447700>!         endif<a name='2167'></font>
<font color=#447700>!       enddo<a name='2168'></font>
<font color=#447700>!     enddo<a name='2169'></font>
<font color=#447700>!<a name='2170'></font>
<font color=#447700>!  updraft mass flux as a function of updraft velocity profile<a name='2171'></font>
<font color=#447700>!<a name='2172'></font>
      do k = 1, kmpbl<a name='2173'>
        do i = 1, im<a name='2174'>
          if (cnvflg(i) .and. k &lt; kpbl(i)) then<a name='2175'>
             xmf(i,k) = a1 * sqrt(wu2(i,k))<a name='2176'>
             dz   = zl(i,k+1) - zl(i,k)<a name='2177'>
             xmmx = dz / dt2<a name='2178'>
             xmf(i,k) = min(xmf(i,k),xmmx)<a name='2179'>
          endif<a name='2180'>
        enddo<a name='2181'>
      enddo<a name='2182'>
<font color=#447700>!c<a name='2183'></font>
<font color=#447700>!c!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2184'></font>
<font color=#447700>!c  compute updraft property<a name='2185'></font>
<font color=#447700>!c<a name='2186'></font>
      do k = 2, kmpbl<a name='2187'>
        do i = 1, im<a name='2188'>
          if (cnvflg(i) .and. k &lt;= kpbl(i)) then<a name='2189'>
             dz   = zl(i,k) - zl(i,k-1)<a name='2190'>
             tem  = 0.5 * xlamue(i,k-1) * dz<a name='2191'>
             factor = 1. + tem<a name='2192'>
             ptem = tem + pgcon<a name='2193'>
             ptem1= tem - pgcon<a name='2194'>
<font color=#447700>!<a name='2195'></font>
             tcko(i,k) = ((1.-tem)*tcko(i,k-1)+tem*               &amp;<a name='2196'>
     &amp;                    (t1(i,k)+t1(i,k-1))-gocp*dz)/factor<a name='2197'>
             ucko(i,k) = ((1.-tem)*ucko(i,k-1)+ptem*u1(i,k)       &amp; <a name='2198'>
     &amp;                    +ptem1*u1(i,k-1))/factor                 <a name='2199'>
             vcko(i,k) = ((1.-tem)*vcko(i,k-1)+ptem*v1(i,k)       &amp;<a name='2200'>
     &amp;                    +ptem1*v1(i,k-1))/factor<a name='2201'>
          endif<a name='2202'>
        enddo<a name='2203'>
      enddo<a name='2204'>
      do n = 1, ntrac<a name='2205'>
      do k = 2, kmpbl<a name='2206'>
        do i = 1, im<a name='2207'>
          if (cnvflg(i) .and. k &lt;= kpbl(i)) then<a name='2208'>
             dz   = zl(i,k) - zl(i,k-1)<a name='2209'>
             tem  = 0.5 * xlamue(i,k-1) * dz<a name='2210'>
             factor = 1. + tem<a name='2211'>
 <a name='2212'>
             qcko(i,k,n) = ((1.-tem)*qcko(i,k-1,n)+tem*           &amp;<a name='2213'>
     &amp;                    (q1(i,k,n)+q1(i,k-1,n)))/factor<a name='2214'>
          endif<a name='2215'>
        enddo<a name='2216'>
      enddo<a name='2217'>
      enddo<a name='2218'>
<font color=#447700>!<a name='2219'></font>
      return<a name='2220'>
      end subroutine mfpbl<a name='2221'>
<font color=#447700>!----------------------------------------------------------------------<a name='2222'></font>
#endif<a name='2223'>
      END MODULE module_bl_gfsedmf<a name='2224'>
</pre></body></html>