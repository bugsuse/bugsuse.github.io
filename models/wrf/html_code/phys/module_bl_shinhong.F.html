<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:model_layer:physics<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_BL_SHINHONG'><A href='../../html_code/phys/module_bl_shinhong.F.html#MODULE_BL_SHINHONG' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>module </font><font color=#cc0000>module_bl_shinhong</font> <A href='../../call_to/MODULE_BL_SHINHONG.html' TARGET='index'>2</A><a name='5'>
<font color=#447700>!<a name='6'></font>
contains<a name='7'>
<font color=#447700>!<a name='8'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='9'></font>
<font color=#447700>!<a name='10'></font>
<A NAME='SHINHONG'><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11'>
   <font color=#993300>subroutine </font><font color=#cc0000>shinhong</font>(u3d,v3d,th3d,t3d,qv3d,qc3d,qi3d,p3d,p3di,pi3d,          &amp; <A href='../../call_to/SHINHONG.html' TARGET='index'>1</A>,<A href='../../call_from/SHINHONG.html' TARGET='index'>1</A><a name='12'>
                  rublten,rvblten,rthblten,                                    &amp;<a name='13'>
                  rqvblten,rqcblten,rqiblten,flag_qi,                          &amp;<a name='14'>
                  cp,g,rovcp,rd,rovg,ep1,ep2,karman,xlv,rv,                    &amp;<a name='15'>
                  dz8w,psfc,                                                   &amp;<a name='16'>
                  znu,znw,p_top,                                               &amp;<a name='17'>
                  znt,ust,hpbl,psim,psih,                                      &amp;<a name='18'>
                  xland,hfx,qfx,wspd,br,                                       &amp;<a name='19'>
                  dt,kpbl2d,                                                   &amp;<a name='20'>
                  exch_h,                                                      &amp;<a name='21'>
                  u10,v10,                                                     &amp;<a name='22'>
                  shinhong_tke_diag,tke_pbl,el_pbl,corf,                       &amp;<a name='23'>
                  dx,dy,                                                       &amp;<a name='24'>
                  ids,ide, jds,jde, kds,kde,                                   &amp;<a name='25'>
                  ims,ime, jms,jme, kms,kme,                                   &amp;<a name='26'>
                  its,ite, jts,jte, kts,kte,                                   &amp;<a name='27'>
                <font color=#447700>!optional<a name='28'></font>
                  ctopo,ctopo2,                                                &amp;<a name='29'>
                  wstar,delta,                                                 &amp;<a name='30'>
                  regime                                           )<a name='31'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='32'></font>
   implicit none<a name='33'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='34'></font>
<font color=#447700>!-- u3d         3d u-velocity interpolated to theta points (m/s)<a name='35'></font>
<font color=#447700>!-- v3d         3d v-velocity interpolated to theta points (m/s)<a name='36'></font>
<font color=#447700>!-- th3d        3d potential temperature (k)<a name='37'></font>
<font color=#447700>!-- t3d         temperature (k)<a name='38'></font>
<font color=#447700>!-- qv3d        3d water vapor mixing ratio (kg/kg)<a name='39'></font>
<font color=#447700>!-- qc3d        3d cloud mixing ratio (kg/kg)<a name='40'></font>
<font color=#447700>!-- qi3d        3d ice mixing ratio (kg/kg)<a name='41'></font>
<font color=#447700>!               (note: if P_QI&lt;PARAM_FIRST_SCALAR this should be zero filled)<a name='42'></font>
<font color=#447700>!-- p3d         3d pressure (pa)<a name='43'></font>
<font color=#447700>!-- p3di        3d pressure (pa) at interface level<a name='44'></font>
<font color=#447700>!-- pi3d        3d exner function (dimensionless)<a name='45'></font>
<font color=#447700>!-- rublten     u tendency due to<a name='46'></font>
<font color=#447700>!               pbl parameterization (m/s/s)<a name='47'></font>
<font color=#447700>!-- rvblten     v tendency due to<a name='48'></font>
<font color=#447700>!               pbl parameterization (m/s/s)<a name='49'></font>
<font color=#447700>!-- rthblten    theta tendency due to<a name='50'></font>
<font color=#447700>!               pbl parameterization (K/s)<a name='51'></font>
<font color=#447700>!-- rqvblten    qv tendency due to<a name='52'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='53'></font>
<font color=#447700>!-- rqcblten    qc tendency due to<a name='54'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='55'></font>
<font color=#447700>!-- rqiblten    qi tendency due to<a name='56'></font>
<font color=#447700>!               pbl parameterization (kg/kg/s)<a name='57'></font>
<font color=#447700>!-- cp          heat capacity at constant pressure for dry air (j/kg/k)<a name='58'></font>
<font color=#447700>!-- g           acceleration due to gravity (m/s^2)<a name='59'></font>
<font color=#447700>!-- rovcp       r/cp<a name='60'></font>
<font color=#447700>!-- rd          gas constant for dry air (j/kg/k)<a name='61'></font>
<font color=#447700>!-- rovg        r/g<a name='62'></font>
<font color=#447700>!-- ep1         constant for virtual temperature (r_v/r_d - 1)<a name='63'></font>
<font color=#447700>!-- ep2         constant for specific humidity calculation<a name='64'></font>
<font color=#447700>!-- karman      von karman constant<a name='65'></font>
<font color=#447700>!-- xlv         latent heat of vaporization (j/kg)<a name='66'></font>
<font color=#447700>!-- rv          gas constant for water vapor (j/kg/k)<a name='67'></font>
<font color=#447700>!-- dz8w        dz between full levels (m)<a name='68'></font>
<font color=#447700>!-- psfc        pressure at the surface (pa)<a name='69'></font>
<font color=#447700>!-- znu         eta values on half (mass) levels  <a name='70'></font>
<font color=#447700>!-- znw         eta values on full (w) levels<a name='71'></font>
<font color=#447700>!-- p_top       pressure top of the model (pa)<a name='72'></font>
<font color=#447700>!-- znt         roughness length (m)<a name='73'></font>
<font color=#447700>!-- ust	        u* in similarity theory (m/s)<a name='74'></font>
<font color=#447700>!-- hpbl        pbl height (m)<a name='75'></font>
<font color=#447700>!-- psim        similarity stability function for momentum<a name='76'></font>
<font color=#447700>!-- psih        similarity stability function for heat<a name='77'></font>
<font color=#447700>!-- xland       land mask (1 for land, 2 for water)<a name='78'></font>
<font color=#447700>!-- hfx	        upward heat flux at the surface (w/m^2)<a name='79'></font>
<font color=#447700>!-- qfx	        upward moisture flux at the surface (kg/m^2/s)<a name='80'></font>
<font color=#447700>!-- wspd        wind speed at lowest model level (m/s)<a name='81'></font>
<font color=#447700>!-- br          bulk richardson number in surface layer<a name='82'></font>
<font color=#447700>!-- u10         u-wind speed at 10 m (m/s)<a name='83'></font>
<font color=#447700>!-- v10         v-wind speed at 10 m (m/s)<a name='84'></font>
<font color=#447700>!-- dt          time step (s)<a name='85'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='86'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='87'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='88'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='89'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='90'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='91'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='92'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='93'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='94'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='95'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='96'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='97'></font>
<font color=#447700>!-- its         start index for i in tile<a name='98'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='99'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='100'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='101'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='102'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='103'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='104'></font>
<font color=#447700>!<a name='105'></font>
   integer,parameter ::  ndiff = 3<a name='106'>
   real,parameter    ::  rcl = 1.0<a name='107'>
<font color=#447700>!<a name='108'></font>
   integer,  intent(in   )   ::      ids,ide, jds,jde, kds,kde,                &amp;<a name='109'>
                                     ims,ime, jms,jme, kms,kme,                &amp;<a name='110'>
                                     its,ite, jts,jte, kts,kte<a name='111'>
   integer,  intent(in   )   ::      shinhong_tke_diag<a name='112'>
<font color=#447700>!<a name='113'></font>
   real,     intent(in   )   ::      dt,cp,g,rovcp,rovg,rd,xlv,rv<a name='114'>
   real,     intent(in   )   ::      ep1,ep2,karman<a name='115'>
   real,     intent(in   )   ::      dx,dy<a name='116'>
<font color=#447700>!<a name='117'></font>
   integer,  dimension( ims:ime, jms:jme )                                   , &amp;<a name='118'>
             intent(out  )   ::                                        kpbl2d<a name='119'>
<font color=#447700>!<a name='120'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='121'>
             intent(in   )   ::                                           u3d, &amp;<a name='122'>
                                                                          v3d<a name='123'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='124'>
             intent(in   )   ::                                          qv3d, &amp;<a name='125'>
                                                                         qc3d, &amp;<a name='126'>
                                                                         qi3d, &amp;<a name='127'>
                                                                          p3d, &amp;<a name='128'>
                                                                         pi3d, &amp;<a name='129'>
                                                                         th3d, &amp;<a name='130'>
                                                                          t3d, &amp;<a name='131'>
                                                                         dz8w<a name='132'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='133'>
             intent(in   )   ::                                          p3di<a name='134'>
<font color=#447700>!<a name='135'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='136'>
             intent(inout)   ::                                       rublten, &amp;<a name='137'>
                                                                      rvblten, &amp;<a name='138'>
                                                                     rthblten, &amp;<a name='139'>
                                                                     rqvblten, &amp;<a name='140'>
                                                                     rqcblten<a name='141'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='142'>
             intent(inout)   ::                                        exch_h<a name='143'>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='144'>
             intent(inout)   ::                                       tke_pbl, &amp;<a name='145'>
                                                                       el_pbl<a name='146'>
<font color=#447700>!<a name='147'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='148'>
             intent(in   )   ::                                         xland, &amp;<a name='149'>
                                                                          hfx, &amp;<a name='150'>
                                                                          qfx, &amp;<a name='151'>
                                                                         corf, &amp;<a name='152'>
                                                                           br, &amp;<a name='153'>
                                                                         psfc<a name='154'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='155'>
             intent(in   )   ::                                                &amp;<a name='156'>
                                                                         psim, &amp;<a name='157'>
                                                                         psih<a name='158'>
<font color=#447700>!<a name='159'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='160'>
             intent(inout)   ::                                           u10, &amp;<a name='161'>
                                                                          v10<a name='162'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='163'>
             intent(inout)   ::                                           znt, &amp;<a name='164'>
                                                                          ust, &amp;<a name='165'>
                                                                         hpbl, &amp;<a name='166'>
                                                                         wspd<a name='167'>
<font color=#447700>!<a name='168'></font>
   logical,  intent(in)      ::                                       flag_qi<a name='169'>
<font color=#447700>!<a name='170'></font>
<font color=#447700>! optional<a name='171'></font>
<font color=#447700>!<a name='172'></font>
   real,     dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='173'>
             intent(inout), optional    ::                           rqiblten<a name='174'>
<font color=#447700>!<a name='175'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='176'>
             intent(inout), optional    ::                              wstar, &amp;<a name='177'>
                                                                        delta<a name='178'>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='179'>
             intent(inout), optional    ::                             regime<a name='180'>
<font color=#447700>!<a name='181'></font>
   real,     dimension( ims:ime, jms:jme )                                   , &amp;<a name='182'>
             intent(in   ), optional    ::                              ctopo, &amp;<a name='183'>
                                                                       ctopo2<a name='184'>
<font color=#447700>!<a name='185'></font>
   real,     dimension( kms:kme )                                            , &amp;<a name='186'>
             intent(in   ), optional    ::                                znu, &amp;<a name='187'>
                                                                          znw<a name='188'>
<font color=#447700>!<a name='189'></font>
   real,     optional, intent(in   )    ::                              p_top<a name='190'>
<font color=#447700>!<a name='191'></font>
<font color=#447700>! local<a name='192'></font>
<font color=#447700>!<a name='193'></font>
   integer ::  i,j,k<a name='194'>
   real,     dimension( its:ite, kts:kte*ndiff )  ::                 rqvbl2dt, &amp;<a name='195'>
                                                                         qv2d<a name='196'>
   real,     dimension( its:ite, kts:kte )        ::                      pdh<a name='197'>
   real,     dimension( its:ite, kts:kte+1 )      ::                     pdhi<a name='198'>
   real,     dimension( its:ite )                 ::                           &amp;<a name='199'>
                                                                        dusfc, &amp;<a name='200'>
                                                                        dvsfc, &amp;<a name='201'>
                                                                        dtsfc, &amp;<a name='202'>
                                                                        dqsfc<a name='203'>
<font color=#447700>!<a name='204'></font>
   qv2d(its:ite,:) = 0.0<a name='205'>
<font color=#447700>!<a name='206'></font>
   do j = jts,jte<a name='207'>
     do k = kts,kte+1<a name='208'>
       do i = its,ite<a name='209'>
         if(k.le.kte)pdh(i,k) = p3d(i,k,j)<a name='210'>
         pdhi(i,k) = p3di(i,k,j)<a name='211'>
       enddo<a name='212'>
     enddo<a name='213'>
     do k = kts,kte<a name='214'>
       do i = its,ite<a name='215'>
         qv2d(i,k) = qv3d(i,k,j)<a name='216'>
         qv2d(i,k+kte) = qc3d(i,k,j)<a name='217'>
         if(present(rqiblten)) qv2d(i,k+kte+kte) = qi3d(i,k,j)<a name='218'>
       enddo<a name='219'>
     enddo<a name='220'>
<font color=#447700>!<a name='221'></font>
     call <A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D'>shinhong2d</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHINHONG2D_1">(J=j,ux=u3d(ims,kms,j),vx=v3d(ims,kms,j)                   &amp;<a name='222'>
             ,tx=t3d(ims,kms,j)                                                &amp;<a name='223'>
             ,qx=qv2d(its,kts)                                                 &amp;<a name='224'>
             ,p2d=pdh(its,kts),p2di=pdhi(its,kts)                              &amp;<a name='225'>
             ,pi2d=pi3d(ims,kms,j)                                             &amp;<a name='226'>
             ,utnp=rublten(ims,kms,j),vtnp=rvblten(ims,kms,j)                  &amp;<a name='227'>
             ,ttnp=rthblten(ims,kms,j),qtnp=rqvbl2dt(its,kts),ndiff=ndiff      &amp;<a name='228'>
             ,cp=cp,g=g,rovcp=rovcp,rd=rd,rovg=rovg                            &amp;<a name='229'>
             ,xlv=xlv,rv=rv                                                    &amp;<a name='230'>
             ,ep1=ep1,ep2=ep2,karman=karman                                    &amp;<a name='231'>
             ,dz8w2d=dz8w(ims,kms,j)                                           &amp;<a name='232'>
             ,psfcpa=psfc(ims,j),znt=znt(ims,j),ust=ust(ims,j)                 &amp;<a name='233'>
             ,hpbl=hpbl(ims,j)                                                 &amp;<a name='234'>
             ,regime=regime(ims,j),psim=psim(ims,j)                            &amp;<a name='235'>
             ,psih=psih(ims,j),xland=xland(ims,j)                              &amp;<a name='236'>
             ,hfx=hfx(ims,j),qfx=qfx(ims,j)                                    &amp;<a name='237'>
             ,wspd=wspd(ims,j),br=br(ims,j)                                    &amp;<a name='238'>
             ,dusfc=dusfc,dvsfc=dvsfc,dtsfc=dtsfc,dqsfc=dqsfc                  &amp;<a name='239'>
             ,dt=dt,rcl=1.0,kpbl1d=kpbl2d(ims,j)                               &amp;<a name='240'>
             ,exch_hx=exch_h(ims,kms,j)                                        &amp;<a name='241'>
             ,wstar=wstar(ims,j)                                               &amp;<a name='242'>
             ,delta=delta(ims,j)                                               &amp;<a name='243'>
             ,u10=u10(ims,j),v10=v10(ims,j)                                    &amp;<a name='244'>
             ,ctopo=ctopo(ims,j),ctopo2=ctopo2(ims,j)                          &amp;<a name='245'>
             ,shinhong_tke_diag=shinhong_tke_diag                              &amp;<a name='246'>
             ,tke=tke_pbl(ims,kms,j),el_pbl=el_pbl(ims,kms,j)                  &amp;<a name='247'>
             ,corf=corf(ims,j)                                                 &amp;<a name='248'>
             ,dx=dx,dy=dy                                                      &amp;<a name='249'>
             ,ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde                &amp;<a name='250'>
             ,ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme                &amp;<a name='251'>
             ,its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte   )<a name='252'>
<font color=#447700>!<a name='253'></font>
     do k = kts,kte<a name='254'>
       do i = its,ite<a name='255'>
         rthblten(i,k,j) = rthblten(i,k,j)/pi3d(i,k,j)<a name='256'>
         rqvblten(i,k,j) = rqvbl2dt(i,k)<a name='257'>
         rqcblten(i,k,j) = rqvbl2dt(i,k+kte)<a name='258'>
         if(present(rqiblten)) rqiblten(i,k,j) = rqvbl2dt(i,k+kte+kte)<a name='259'>
       enddo<a name='260'>
     enddo<a name='261'>
<font color=#447700>!<a name='262'></font>
   enddo<a name='263'>
<font color=#447700>!<a name='264'></font>
   end subroutine shinhong<a name='265'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='266'></font>
<font color=#447700>!<a name='267'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='268'></font>
<A NAME='SHINHONG2D'><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='269'>
   <font color=#993300>subroutine </font><font color=#cc0000>shinhong2d</font>(j,ux,vx,tx,qx,p2d,p2di,pi2d,                          &amp; <A href='../../call_to/SHINHONG2D.html' TARGET='index'>1</A>,<A href='../../call_from/SHINHONG2D.html' TARGET='index'>15</A><a name='270'>
                  utnp,vtnp,ttnp,qtnp,ndiff,                                   &amp;<a name='271'>
                  cp,g,rovcp,rd,rovg,ep1,ep2,karman,xlv,rv,                    &amp;<a name='272'>
                  dz8w2d,psfcpa,                                               &amp;<a name='273'>
                  znt,ust,hpbl,psim,psih,                                      &amp;<a name='274'>
                  xland,hfx,qfx,wspd,br,                                       &amp;<a name='275'>
                  dusfc,dvsfc,dtsfc,dqsfc,                                     &amp;<a name='276'>
                  dt,rcl,kpbl1d,                                               &amp;<a name='277'>
                  exch_hx,                                                     &amp;<a name='278'>
                  wstar,delta,                                                 &amp;<a name='279'>
                  shinhong_tke_diag,                                           &amp;<a name='280'>
                  tke,el_pbl,corf,                                             &amp;<a name='281'>
                  u10,v10,                                                     &amp;<a name='282'>
                  ctopo,ctopo2,                                                &amp;<a name='283'>
                  dx,dy,                                                       &amp;<a name='284'>
                  ids,ide, jds,jde, kds,kde,                                   &amp;<a name='285'>
                  ims,ime, jms,jme, kms,kme,                                   &amp;<a name='286'>
                  its,ite, jts,jte, kts,kte,                                   &amp;<a name='287'>
                <font color=#447700>!optional<a name='288'></font>
                  regime )<a name='289'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='290'></font>
   implicit none<a name='291'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='292'></font>
<font color=#447700>!<a name='293'></font>
<font color=#447700>!     the shinhongpbl (shin and hong 2015) is based on the les study of shin<a name='294'></font>
<font color=#447700>!     and hong (2013). the major ingredients of the shinhongpbl are<a name='295'></font>
<font color=#447700>!       1) the prescribed nonlocal heat transport profile fit to the les and <a name='296'></font>
<font color=#447700>!       2) inclusion of explicit scale dependency functions for vertical <a name='297'></font>
<font color=#447700>!          transport in convective pbl. <a name='298'></font>
<font color=#447700>!     so, the shinhongpbl works at the gray zone resolution of convective pbl.<a name='299'></font>
<font color=#447700>!     note that honnert et al. (2011) first suggested explicit scale dependency<a name='300'></font>
<font color=#447700>!     function, and shin and hong (2013) further classified the function by<a name='301'></font>
<font color=#447700>!     stability (u*/w*) in convective pbl and calculated the function for <a name='302'></font>
<font color=#447700>!     nonlocal and local transport separately.<a name='303'></font>
<font color=#447700>!     vertical mixing in the stable boundary layer and free atmosphere follows<a name='304'></font>
<font color=#447700>!     hong (2010) and hong et al. (2006), same as the ysupbl scheme.<a name='305'></font>
<font color=#447700>!<a name='306'></font>
<font color=#447700>!     shinhongpbl:<a name='307'></font>
<font color=#447700>!     coded and implemented by hyeyum hailey shin (ncar)<a name='308'></font>
<font color=#447700>!              summer 2014<a name='309'></font>
<font color=#447700>!<a name='310'></font>
<font color=#447700>!     ysupbl:<a name='311'></font>
<font color=#447700>!     coded by song-you hong (yonsei university) and implemented by<a name='312'></font>
<font color=#447700>!              song-you hong (yonsei university) and jimy dudhia (ncar)<a name='313'></font>
<font color=#447700>!              summer 2002<a name='314'></font>
<font color=#447700>!<a name='315'></font>
<font color=#447700>!     references:<a name='316'></font>
<font color=#447700>!        shin and hong (2015) mon. wea. rev.<a name='317'></font>
<font color=#447700>!        shin and hong (2013) j. atmos. sci.<a name='318'></font>
<font color=#447700>!        honnert, masson, and couvreux (2011) j. atmos. sci.<a name='319'></font>
<font color=#447700>!        hong (2010) quart. j. roy. met. soc<a name='320'></font>
<font color=#447700>!        hong, noh, and dudhia (2006), mon. wea. rev. <a name='321'></font>
<font color=#447700>!<a name='322'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='323'></font>
<font color=#447700>!<a name='324'></font>
   real,parameter    ::  xkzminm = 0.1,xkzminh = 0.01<a name='325'>
   real,parameter    ::  xkzmax = 1000.,rimin = -100.<a name='326'>
   real,parameter    ::  rlam = 30.,prmin = 0.25,prmax = 4.<a name='327'>
   real,parameter    ::  brcr_ub = 0.0,brcr_sb = 0.25,cori = 1.e-4<a name='328'>
   real,parameter    ::  afac = 6.8,bfac = 6.8,pfac = 2.0,pfac_q = 2.0<a name='329'>
   real,parameter    ::  phifac = 8.,sfcfrac = 0.1<a name='330'>
   real,parameter    ::  d1 = 0.02, d2 = 0.05, d3 = 0.001<a name='331'>
   real,parameter    ::  h1 = 0.33333335, h2 = 0.6666667<a name='332'>
   real,parameter    ::  ckz = 0.001,zfmin = 1.e-8,aphi5 = 5.,aphi16 = 16.<a name='333'>
   real,parameter    ::  tmin=1.e-2<a name='334'>
   real,parameter    ::  gamcrt = 3.,gamcrq = 2.e-3<a name='335'>
   real,parameter    ::  xka = 2.4e-5<a name='336'>
   integer,parameter ::  imvdif = 1<a name='337'>
<font color=#447700>!<a name='338'></font>
<font color=#447700>! tunable parameters for tke<a name='339'></font>
<font color=#447700>!<a name='340'></font>
   real,parameter    ::  epsq2l = 0.01,c_1 = 1.0,gamcre = 0.224<a name='341'>
<font color=#447700>!<a name='342'></font>
<font color=#447700>! tunable parameters for prescribed nonlocal transport profile<a name='343'></font>
<font color=#447700>!<a name='344'></font>
   real,parameter    ::  mltop = 1.0,sfcfracn1 = 0.075<a name='345'>
   real,parameter    ::  nlfrac = 0.7,enlfrac = -0.4<a name='346'>
   real,parameter    ::  a11 = 1.0,a12 = -1.15<a name='347'>
   real,parameter    ::  ezfac = 1.5<a name='348'>
   real,parameter    ::  cpent = -0.4,rigsmax = 100.<a name='349'>
   real,parameter    ::  entfmin = 1.0, entfmax = 5.0<a name='350'>
<font color=#447700>!<a name='351'></font>
   integer,  intent(in   )   ::     ids,ide, jds,jde, kds,kde,                 &amp;<a name='352'>
                                    ims,ime, jms,jme, kms,kme,                 &amp;<a name='353'>
                                    its,ite, jts,jte, kts,kte,                 &amp;<a name='354'>
                                    j,ndiff<a name='355'>
   integer,  intent(in   )   ::     shinhong_tke_diag<a name='356'>
<font color=#447700>!<a name='357'></font>
   real,     intent(in   )   ::     dt,rcl,cp,g,rovcp,rovg,rd,xlv,rv<a name='358'>
   real,     intent(in   )   ::     ep1,ep2,karman<a name='359'>
   real,     intent(in   )   ::     dx,dy<a name='360'>
<font color=#447700>!<a name='361'></font>
   integer,  dimension( ims:ime )                                            , &amp;<a name='362'>
             intent(out  )   ::                                        kpbl1d<a name='363'>
<font color=#447700>!<a name='364'></font>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='365'>
             intent(in   )   ::                                        dz8w2d, &amp;<a name='366'>
                                                                         pi2d<a name='367'>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='368'>
             intent(in   )   ::                                            ux, &amp;<a name='369'>
                                                                           vx<a name='370'>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='371'>
             intent(in   )   ::                                            tx<a name='372'>
<font color=#447700>!<a name='373'></font>
   real,     dimension( its:ite, kts:kte*ndiff )                             , &amp;<a name='374'>
             intent(in   )   ::                                            qx<a name='375'>
   real,     dimension( its:ite, kts:kte+1 )                                 , &amp;<a name='376'>
             intent(in   )   ::                                          p2di<a name='377'>
   real,     dimension( its:ite, kts:kte )                                   , &amp;<a name='378'>
             intent(in   )   ::                                           p2d<a name='379'>
<font color=#447700>!<a name='380'></font>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='381'>
             intent(inout)   ::                                          utnp, &amp;<a name='382'>
                                                                         vtnp, &amp;<a name='383'>
                                                                         ttnp<a name='384'>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='385'>
             intent(inout)   ::                                       exch_hx<a name='386'>
   real,     dimension( ims:ime, kms:kme )                                   , &amp;<a name='387'>
             intent(inout)   ::                                           tke, &amp;<a name='388'>
                                                                       el_pbl<a name='389'>
   real,     dimension( its:ite, kts:kte*ndiff )                             , &amp;<a name='390'>
             intent(inout)   ::                                          qtnp<a name='391'>
<font color=#447700>!<a name='392'></font>
   real,     dimension( ims:ime )                                            , &amp;<a name='393'>
             intent(in   )   ::                                         xland, &amp;<a name='394'>
                                                                          hfx, &amp;<a name='395'>
                                                                          qfx<a name='396'>
   real,     dimension( ims:ime )                                            , &amp;<a name='397'>
             intent(in   )   ::                                            br, &amp;<a name='398'>
                                                                         psim, &amp;<a name='399'>
                                                                         psih, &amp;<a name='400'>
                                                                       psfcpa<a name='401'>
   real,     dimension( ims:ime )                                            , &amp;<a name='402'>
             intent(in   )   ::                                          corf<a name='403'>
<font color=#447700>!<a name='404'></font>
   real,     dimension( ims:ime )                                            , &amp;<a name='405'>
             intent(inout)   ::                                           ust, &amp;<a name='406'>
                                                                         hpbl, &amp;<a name='407'>
                                                                          znt<a name='408'>
   real,     dimension( ims:ime )                                            , &amp;<a name='409'>
             intent(inout)   ::                                          wspd<a name='410'>
   real,     dimension( ims:ime )                                            , &amp;<a name='411'>
             intent(inout)    ::                                          u10, &amp;<a name='412'>
                                                                          v10<a name='413'>
<font color=#447700>!<a name='414'></font>
   real,     dimension( ims:ime )                                            , &amp;<a name='415'>
             optional                                                        , &amp;<a name='416'>
             intent(in   )   ::                                         ctopo, &amp;<a name='417'>
                                                                       ctopo2<a name='418'>
   real,     dimension( ims:ime )                                            , &amp;<a name='419'>
             optional                                                        , &amp;<a name='420'>
             intent(inout)   ::                                        regime<a name='421'>
   real,     dimension( its:ite )                                            , &amp;<a name='422'>
             intent(out  )   ::                                         wstar, &amp;<a name='423'>
                                                                        delta<a name='424'>
<font color=#447700>!<a name='425'></font>
<font color=#447700>! local vars<a name='426'></font>
<font color=#447700>!<a name='427'></font>
   integer ::  n,i,k,l,ic,is,nwmass<a name='428'>
   integer ::  klpbl, kqc, kqi<a name='429'>
   integer ::  lmh,lmxl<a name='430'>
<font color=#447700>!<a name='431'></font>
   real    ::  dt2,rdt,spdk2,fm,fh,hol1,gamfac,vpert,prnum,prnum0<a name='432'>
   real    ::  ss,ri,qmean,tmean,alpha,chi,zk,rl2,dk,sri<a name='433'>
   real    ::  brint,dtodsd,dtodsu,rdz,dsdzt,dsdzq,dsdz2,rlamdz<a name='434'>
   real    ::  utend,vtend,ttend,qtend<a name='435'>
   real    ::  dtstep,govrthv<a name='436'>
   real    ::  cont, conq, conw, conwrc<a name='437'>
   real    ::  delxy,pu1,pth1,pq1<a name='438'>
   real    ::  dex,hgame_c<a name='439'>
   real    ::  zfacdx<a name='440'>
   real    ::  amf1,amf2,bmf2,amf3,bmf3,amf4,bmf4,sflux0,snlflux0<a name='441'>
   real    ::  mlfrac,ezfrac,sfcfracn<a name='442'>
   real    ::  uwst,uwstx,csfac<a name='443'>
   real    ::  prnumfac,bfx0,hfx0,qfx0,delb,dux,dvx,                           &amp;<a name='444'>
               dsdzu,dsdzv,wm3,dthx,dqx,wspd10,ross,tem1,dsig,tvcon,conpr,     &amp;<a name='445'>
               prfac,prfac2,phim8z<a name='446'>
<font color=#447700>!<a name='447'></font>
   integer,  dimension( its:ite )            ::                          kpbl<a name='448'>
   real,     dimension( its:ite )            ::                           hol<a name='449'>
   real,     dimension( its:ite )            ::                       deltaoh<a name='450'>
   real,     dimension( its:ite )            ::                          rigs, &amp;<a name='451'>
                                                                     enlfrac2, &amp;<a name='452'>
                                                                        cslen<a name='453'>
   real,     dimension( its:ite )            ::                                &amp;<a name='454'>
                                                                         rhox, &amp;<a name='455'>
                                                                       govrth, &amp;<a name='456'>
                                                                  zl1,thermal, &amp;<a name='457'>
                                                                       wscale, &amp;<a name='458'>
                                                                  hgamt,hgamq, &amp;<a name='459'>
                                                                    brdn,brup, &amp;<a name='460'>
                                                                    phim,phih, &amp;<a name='461'>
                                                                  dusfc,dvsfc, &amp;<a name='462'>
                                                                  dtsfc,dqsfc, &amp;<a name='463'>
                                                                        prpbl, &amp;<a name='464'>
                                                                        wspd1<a name='465'>
   real,     dimension( its:ite )            ::                                &amp;<a name='466'>
                                                                         ust3, &amp;<a name='467'>
                                                                       wstar3, &amp;<a name='468'>
                                                                  hgamu,hgamv, &amp;<a name='469'>
                                                                      wm2, we, &amp;<a name='470'>
                                                                       bfxpbl, &amp;<a name='471'>
                                                                hfxpbl,qfxpbl, &amp;<a name='472'>
                                                                ufxpbl,vfxpbl, &amp;<a name='473'>
                                                                        dthvx<a name='474'>
   real,     dimension( its:ite )            ::                                &amp;<a name='475'>
                                                                         brcr, &amp;<a name='476'>
                                                                        sflux, &amp;<a name='477'>
                                                                         zol1, &amp;<a name='478'>
                                                                    brcr_sbro<a name='479'>
   real,     dimension( its:ite )            ::                                &amp;<a name='480'>
                                                                       efxpbl, &amp;<a name='481'>
                                                                     hpbl_cbl, &amp;<a name='482'>
                                                                       epshol, &amp;<a name='483'>
                                                                           ct<a name='484'>
<font color=#447700>!<a name='485'></font>
   real,     dimension( its:ite, kts:kte )   ::                     xkzm,xkzh, &amp;<a name='486'>
                                                                        f1,f2, &amp;<a name='487'>
                                                                        r1,r2, &amp;<a name='488'>
                                                                        ad,au, &amp;<a name='489'>
                                                                           cu, &amp;<a name='490'>
                                                                           al, &amp;<a name='491'>
                                                                         xkzq, &amp;<a name='492'>
                                                                         zfac<a name='493'>
   real,     dimension( its:ite, kts:kte )   ::                                &amp;<a name='494'>
                                                                     thx,thvx, &amp;<a name='495'>
                                                                          del, &amp;<a name='496'>
                                                                          dza, &amp;<a name='497'>
                                                                          dzq, &amp;<a name='498'>
                                                                        xkzom, &amp;<a name='499'>
                                                                        xkzoh, &amp;<a name='500'>
                                                                           za<a name='501'>
   real,     dimension( its:ite, kts:kte )   ::                                &amp;<a name='502'>
                                                                      wscalek<a name='503'>
   real,     dimension( its:ite, kts:kte )   ::                                &amp;<a name='504'>
                                                                  xkzml,xkzhl, &amp;<a name='505'>
                                                               zfacent,entfac<a name='506'>
   real,     dimension( its:ite, kts:kte )   ::                                &amp;<a name='507'>
                                                                           mf, &amp;<a name='508'>
                                                                       zfacmf, &amp;<a name='509'>
                                                                     entfacmf<a name='510'>
   real,     dimension( its:ite, kts:kte )   ::                                &amp;<a name='511'>
                                                                          q2x, &amp;<a name='512'>
                                                                      hgame2d, &amp;<a name='513'>
                                                                      tflux_e, &amp;<a name='514'>
                                                                      qflux_e, &amp;<a name='515'>
                                                                     tvflux_e<a name='516'>
   real,     dimension( its:ite, kts:kte+1 ) ::                            zq<a name='517'>
   real,     dimension( its:ite, kts:kte, ndiff ) ::                    r3,f3<a name='518'>
<font color=#447700>!<a name='519'></font>
   real,     dimension( kts:kte )            ::                                &amp;<a name='520'>
                                                                      uxk,vxk, &amp;<a name='521'>
                                                               txk,thxk,thvxk, &amp;<a name='522'>
                                                                         q2xk, &amp;<a name='523'>
                                                                        hgame<a name='524'>
   real,     dimension( kts:kte )            ::                                &amp;<a name='525'>
                                                         ps1d,pb1d,eps1d,pt1d, &amp;<a name='526'>
                                                    xkze1d,eflx_l1d,eflx_nl1d, &amp;<a name='527'>
                                                                        ptke1<a name='528'>
   real,     dimension( kts+1:kte )          ::                                &amp;<a name='529'>
                                                                 s2,gh,rig,el, &amp;<a name='530'>
                                                                    akmk,akhk, &amp;<a name='531'>
                                                  mfk,ufxpblk,vfxpblk,qfxpblk<a name='532'>
   real,     dimension( kts:kte+1 )          ::                           zqk<a name='533'>
   real,     dimension( kts:kte*ndiff )      ::                           qxk<a name='534'>
<font color=#447700>!<a name='535'></font>
   logical,  dimension( its:ite )            ::                        pblflg, &amp;<a name='536'>
                                                                       sfcflg, &amp;<a name='537'>
                                                                       stable<a name='538'>
   logical,  dimension( ndiff )              ::                        ifvmix<a name='539'>
<font color=#447700>!<a name='540'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='541'></font>
<font color=#447700>!<a name='542'></font>
   klpbl = kte<a name='543'>
   lmh = 1<a name='544'>
   lmxl = 1<a name='545'>
<font color=#447700>!<a name='546'></font>
   cont=cp/g<a name='547'>
   conq=xlv/g<a name='548'>
   conw=1./g<a name='549'>
   conwrc = conw*sqrt(rcl)<a name='550'>
   conpr = bfac*karman*sfcfrac<a name='551'>
<font color=#447700>!<a name='552'></font>
<font color=#447700>!  k-start index for cloud and rain <a name='553'></font>
<font color=#447700>!<a name='554'></font>
   kqc = 1 + kte<a name='555'>
   kqi = 1 + kte*2<a name='556'>
   nwmass = 3<a name='557'>
   ifvmix(:) = .true.<a name='558'>
<font color=#447700>!<a name='559'></font>
   do k = kts,kte<a name='560'>
     do i = its,ite<a name='561'>
       thx(i,k) = tx(i,k)/pi2d(i,k)<a name='562'>
     enddo<a name='563'>
   enddo<a name='564'>
<font color=#447700>!<a name='565'></font>
   do k = kts,kte<a name='566'>
     do i = its,ite<a name='567'>
       tvcon = (1.+ep1*qx(i,k))<a name='568'>
       thvx(i,k) = thx(i,k)*tvcon<a name='569'>
     enddo<a name='570'>
   enddo<a name='571'>
<font color=#447700>!<a name='572'></font>
   do i = its,ite<a name='573'>
     tvcon = (1.+ep1*qx(i,1))<a name='574'>
     rhox(i) = psfcpa(i)/(rd*tx(i,1)*tvcon)<a name='575'>
     govrth(i) = g/thx(i,1)<a name='576'>
   enddo<a name='577'>
<font color=#447700>!<a name='578'></font>
<font color=#447700>!-----compute the height of full- and half-sigma levels above ground<a name='579'></font>
<font color=#447700>!     level, and the layer thicknesses.<a name='580'></font>
<font color=#447700>!<a name='581'></font>
   do i = its,ite<a name='582'>
     zq(i,1) = 0.<a name='583'>
   enddo<a name='584'>
<font color=#447700>!<a name='585'></font>
   do k = kts,kte<a name='586'>
     do i = its,ite<a name='587'>
       zq(i,k+1) = dz8w2d(i,k)+zq(i,k)<a name='588'>
     enddo<a name='589'>
   enddo<a name='590'>
<font color=#447700>! <a name='591'></font>
   do k = kts,kte<a name='592'>
     do i = its,ite<a name='593'>
       za(i,k) = 0.5*(zq(i,k)+zq(i,k+1))<a name='594'>
       dzq(i,k) = zq(i,k+1)-zq(i,k)<a name='595'>
       del(i,k) = p2di(i,k)-p2di(i,k+1)<a name='596'>
     enddo<a name='597'>
   enddo<a name='598'>
<font color=#447700>!<a name='599'></font>
   do i = its,ite<a name='600'>
     dza(i,1) = za(i,1)<a name='601'>
   enddo<a name='602'>
<font color=#447700>!<a name='603'></font>
   do k = kts+1,kte<a name='604'>
     do i = its,ite<a name='605'>
       dza(i,k) = za(i,k)-za(i,k-1)<a name='606'>
     enddo<a name='607'>
   enddo<a name='608'>
<font color=#447700>!<a name='609'></font>
<font color=#447700>!<a name='610'></font>
<font color=#447700>!-----initialize vertical tendencies and<a name='611'></font>
<font color=#447700>!<a name='612'></font>
   utnp(its:ite,:) = 0.<a name='613'>
   vtnp(its:ite,:) = 0.<a name='614'>
   ttnp(its:ite,:) = 0.<a name='615'>
   qtnp(its:ite,:) = 0.<a name='616'>
<font color=#447700>!<a name='617'></font>
   do i = its,ite<a name='618'>
     wspd1(i) = sqrt(ux(i,1)*ux(i,1)+vx(i,1)*vx(i,1))+1.e-9<a name='619'>
   enddo<a name='620'>
<font color=#447700>!<a name='621'></font>
<font color=#447700>!---- compute vertical diffusion<a name='622'></font>
<font color=#447700>!<a name='623'></font>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='624'></font>
<font color=#447700>!     compute preliminary variables<a name='625'></font>
<font color=#447700>!<a name='626'></font>
   dtstep = dt<a name='627'>
   dt2 = 2.*dtstep<a name='628'>
   rdt = 1./dt2<a name='629'>
<font color=#447700>!<a name='630'></font>
   do i = its,ite<a name='631'>
     bfxpbl(i) = 0.0<a name='632'>
     hfxpbl(i) = 0.0<a name='633'>
     qfxpbl(i) = 0.0<a name='634'>
     ufxpbl(i) = 0.0<a name='635'>
     vfxpbl(i) = 0.0<a name='636'>
     hgamu(i)  = 0.0<a name='637'>
     hgamv(i)  = 0.0<a name='638'>
     delta(i)  = 0.0<a name='639'>
   enddo<a name='640'>
<font color=#447700>!<a name='641'></font>
   do i = its,ite<a name='642'>
     efxpbl(i)   = 0.0<a name='643'>
     hpbl_cbl(i) = 0.0<a name='644'>
     epshol(i)   = 0.0<a name='645'>
     ct(i)       = 0.0<a name='646'>
   enddo<a name='647'>
<font color=#447700>!<a name='648'></font>
   do i = its,ite<a name='649'>
     deltaoh(i)  = 0.0<a name='650'>
     rigs(i)     = 0.0<a name='651'>
     enlfrac2(i) = 0.0<a name='652'>
     cslen(i)    = 0.0<a name='653'>
   enddo<a name='654'>
<font color=#447700>!<a name='655'></font>
   do k = kts,klpbl<a name='656'>
     do i = its,ite<a name='657'>
       wscalek(i,k) = 0.0<a name='658'>
     enddo<a name='659'>
   enddo<a name='660'>
<font color=#447700>!<a name='661'></font>
   do k = kts,klpbl<a name='662'>
     do i = its,ite<a name='663'>
       zfac(i,k) = 0.0<a name='664'>
     enddo<a name='665'>
   enddo<a name='666'>
<font color=#447700>!<a name='667'></font>
   do k = kts,kte<a name='668'>
     do i = its,ite<a name='669'>
       q2x(i,k) = 2.*tke(i,k)<a name='670'>
     enddo<a name='671'>
   enddo<a name='672'>
<font color=#447700>!<a name='673'></font>
   do k = kts,kte<a name='674'>
     do i = its,ite<a name='675'>
       el_pbl(i,k)   = 0.0<a name='676'>
       hgame2d(i,k)  = 0.0<a name='677'>
       tflux_e(i,k)  = 0.0<a name='678'>
       qflux_e(i,k)  = 0.0<a name='679'>
       tvflux_e(i,k) = 0.0<a name='680'>
     enddo<a name='681'>
   enddo<a name='682'>
<font color=#447700>!<a name='683'></font>
   do k = kts,kte<a name='684'>
     do i = its,ite<a name='685'>
       mf(i,k)     = 0.0<a name='686'>
       zfacmf(i,k) = 0.0<a name='687'>
     enddo<a name='688'>
   enddo<a name='689'>
<font color=#447700>!<a name='690'></font>
   do k = kts,klpbl-1<a name='691'>
     do i = its,ite<a name='692'>
       xkzom(i,k) = xkzminm<a name='693'>
       xkzoh(i,k) = xkzminh<a name='694'>
     enddo<a name='695'>
   enddo<a name='696'>
<font color=#447700>!<a name='697'></font>
   do i = its,ite<a name='698'>
     dusfc(i) = 0.<a name='699'>
     dvsfc(i) = 0.<a name='700'>
     dtsfc(i) = 0.<a name='701'>
     dqsfc(i) = 0.<a name='702'>
   enddo<a name='703'>
<font color=#447700>!<a name='704'></font>
   do i = its,ite<a name='705'>
     hgamt(i)  = 0.<a name='706'>
     hgamq(i)  = 0.<a name='707'>
     wscale(i) = 0.<a name='708'>
     kpbl(i)   = 1<a name='709'>
     hpbl(i)   = zq(i,1)<a name='710'>
     hpbl_cbl(i) = zq(i,1)<a name='711'>
     zl1(i)    = za(i,1)<a name='712'>
     thermal(i)= thvx(i,1)<a name='713'>
     pblflg(i) = .true.<a name='714'>
     sfcflg(i) = .true.<a name='715'>
     sflux(i) = hfx(i)/rhox(i)/cp + qfx(i)/rhox(i)*ep1*thx(i,1)<a name='716'>
     if(br(i).gt.0.0) sfcflg(i) = .false.<a name='717'>
   enddo<a name='718'>
<font color=#447700>!<a name='719'></font>
<font color=#447700>!     compute the first guess of pbl height<a name='720'></font>
<font color=#447700>!<a name='721'></font>
   do i = its,ite<a name='722'>
     stable(i) = .false.<a name='723'>
     brup(i) = br(i)<a name='724'>
     brcr(i) = brcr_ub<a name='725'>
   enddo<a name='726'>
<font color=#447700>!<a name='727'></font>
   do k = 2,klpbl<a name='728'>
     do i = its,ite<a name='729'>
       if(.not.stable(i))then<a name='730'>
         brdn(i) = brup(i)<a name='731'>
         spdk2   = max(ux(i,k)**2+vx(i,k)**2,1.)<a name='732'>
         brup(i) = (thvx(i,k)-thermal(i))*(g*za(i,k)/thvx(i,1))/spdk2<a name='733'>
         kpbl(i) = k<a name='734'>
         stable(i) = brup(i).gt.brcr(i)<a name='735'>
       endif<a name='736'>
     enddo<a name='737'>
   enddo<a name='738'>
<font color=#447700>!<a name='739'></font>
   do i = its,ite<a name='740'>
     k = kpbl(i)<a name='741'>
     if(brdn(i).ge.brcr(i))then<a name='742'>
       brint = 0.<a name='743'>
     elseif(brup(i).le.brcr(i))then<a name='744'>
       brint = 1.<a name='745'>
     else<a name='746'>
       brint = (brcr(i)-brdn(i))/(brup(i)-brdn(i))<a name='747'>
     endif<a name='748'>
     hpbl(i) = za(i,k-1)+brint*(za(i,k)-za(i,k-1))<a name='749'>
     if(hpbl(i).lt.zq(i,2)) kpbl(i) = 1<a name='750'>
     if(kpbl(i).le.1) pblflg(i) = .false.<a name='751'>
   enddo<a name='752'>
<font color=#447700>!<a name='753'></font>
   do i = its,ite<a name='754'>
     fm = psim(i)<a name='755'>
     fh = psih(i)<a name='756'>
     zol1(i) = max(br(i)*fm*fm/fh,rimin)<a name='757'>
     if(sfcflg(i))then<a name='758'>
       zol1(i) = min(zol1(i),-zfmin)<a name='759'>
     else<a name='760'>
       zol1(i) = max(zol1(i),zfmin)<a name='761'>
     endif<a name='762'>
     hol1 = zol1(i)*hpbl(i)/zl1(i)*sfcfrac<a name='763'>
     epshol(i) = hol1<a name='764'>
     if(sfcflg(i))then<a name='765'>
       phim(i) = (1.-aphi16*hol1)**(-1./4.)<a name='766'>
       phih(i) = (1.-aphi16*hol1)**(-1./2.)<a name='767'>
       bfx0  = max(sflux(i),0.)<a name='768'>
       hfx0 = max(hfx(i)/rhox(i)/cp,0.)<a name='769'>
       qfx0 = max(ep1*thx(i,1)*qfx(i)/rhox(i),0.)<a name='770'>
       wstar3(i) = (govrth(i)*bfx0*hpbl(i))<a name='771'>
       wstar(i) = (wstar3(i))**h1<a name='772'>
     else<a name='773'>
       phim(i) = (1.+aphi5*hol1)<a name='774'>
       phih(i) = phim(i)<a name='775'>
       wstar(i)  = 0.<a name='776'>
       wstar3(i) = 0.<a name='777'>
     endif<a name='778'>
     ust3(i)   = ust(i)**3.<a name='779'>
     wscale(i) = (ust3(i)+phifac*karman*wstar3(i)*0.5)**h1<a name='780'>
     wscale(i) = min(wscale(i),ust(i)*aphi16)<a name='781'>
     wscale(i) = max(wscale(i),ust(i)/aphi5)<a name='782'>
   enddo<a name='783'>
<font color=#447700>!<a name='784'></font>
<font color=#447700>!     compute the surface variables for pbl height estimation<a name='785'></font>
<font color=#447700>!     under unstable conditions<a name='786'></font>
<font color=#447700>!<a name='787'></font>
   do i = its,ite<a name='788'>
     if(sfcflg(i).and.sflux(i).gt.0.0)then<a name='789'>
       gamfac   = bfac/rhox(i)/wscale(i)<a name='790'>
       hgamt(i) = min(gamfac*hfx(i)/cp,gamcrt)<a name='791'>
       hgamq(i) = min(gamfac*qfx(i),gamcrq)<a name='792'>
       vpert = (hgamt(i)+ep1*thx(i,1)*hgamq(i))/bfac*afac<a name='793'>
       thermal(i) = thermal(i)+max(vpert,0.)*min(za(i,1)/(sfcfrac*hpbl(i)),1.0)<a name='794'>
       hgamt(i) = max(hgamt(i),0.0)<a name='795'>
       hgamq(i) = max(hgamq(i),0.0)<a name='796'>
       brint    = -15.9*ust(i)*ust(i)/wspd(i)*wstar3(i)/(wscale(i)**4.)<a name='797'>
       hgamu(i) = brint*ux(i,1)<a name='798'>
       hgamv(i) = brint*vx(i,1)<a name='799'>
     else<a name='800'>
       pblflg(i) = .false.<a name='801'>
     endif<a name='802'>
   enddo<a name='803'>
<font color=#447700>!<a name='804'></font>
<font color=#447700>!     enhance the pbl height by considering the thermal<a name='805'></font>
<font color=#447700>!<a name='806'></font>
   do i = its,ite<a name='807'>
     if(pblflg(i))then<a name='808'>
       kpbl(i) = 1<a name='809'>
       hpbl(i) = zq(i,1)<a name='810'>
     endif<a name='811'>
   enddo<a name='812'>
<font color=#447700>!<a name='813'></font>
   do i = its,ite<a name='814'>
     if(pblflg(i))then<a name='815'>
       stable(i) = .false.<a name='816'>
       brup(i) = br(i)<a name='817'>
       brcr(i) = brcr_ub<a name='818'>
     endif<a name='819'>
   enddo<a name='820'>
<font color=#447700>!<a name='821'></font>
   do k = 2,klpbl<a name='822'>
     do i = its,ite<a name='823'>
       if(.not.stable(i).and.pblflg(i))then<a name='824'>
         brdn(i) = brup(i)<a name='825'>
         spdk2   = max(ux(i,k)**2+vx(i,k)**2,1.)<a name='826'>
         brup(i) = (thvx(i,k)-thermal(i))*(g*za(i,k)/thvx(i,1))/spdk2<a name='827'>
         kpbl(i) = k<a name='828'>
         stable(i) = brup(i).gt.brcr(i)<a name='829'>
       endif<a name='830'>
     enddo<a name='831'>
   enddo<a name='832'>
<font color=#447700>!<a name='833'></font>
   do i = its,ite<a name='834'>
     if(pblflg(i)) then<a name='835'>
       k = kpbl(i)<a name='836'>
       if(brdn(i).ge.brcr(i))then<a name='837'>
         brint = 0.<a name='838'>
       elseif(brup(i).le.brcr(i))then<a name='839'>
         brint = 1.<a name='840'>
       else<a name='841'>
         brint = (brcr(i)-brdn(i))/(brup(i)-brdn(i))<a name='842'>
       endif<a name='843'>
       hpbl(i) = za(i,k-1)+brint*(za(i,k)-za(i,k-1))<a name='844'>
       if(hpbl(i).lt.zq(i,2)) kpbl(i) = 1<a name='845'>
       if(kpbl(i).le.1) pblflg(i) = .false.<a name='846'>
       uwst  = abs(ust(i)/wstar(i)-0.5)<a name='847'>
       uwstx = -80.*uwst+14.<a name='848'>
       csfac = 0.5*(tanh(uwstx)+3.)<a name='849'>
       cslen(i) = csfac*hpbl(i)<a name='850'>
     endif<a name='851'>
   enddo<a name='852'>
<font color=#447700>!<a name='853'></font>
<font color=#447700>!     stable boundary layer<a name='854'></font>
<font color=#447700>!<a name='855'></font>
   do i = its,ite<a name='856'>
     hpbl_cbl(i) = hpbl(i)<a name='857'>
     if((.not.sfcflg(i)).and.hpbl(i).lt.zq(i,2)) then<a name='858'>
       brup(i) = br(i)<a name='859'>
       stable(i) = .false.<a name='860'>
     else<a name='861'>
       stable(i) = .true.<a name='862'>
     endif<a name='863'>
   enddo<a name='864'>
<font color=#447700>!<a name='865'></font>
   do i = its,ite<a name='866'>
     if((.not.stable(i)).and.((xland(i)-1.5).ge.0))then<a name='867'>
       wspd10 = u10(i)*u10(i) + v10(i)*v10(i)<a name='868'>
       wspd10 = sqrt(wspd10)<a name='869'>
       ross = wspd10 / (cori*znt(i))<a name='870'>
       brcr_sbro(i) = min(0.16*(1.e-7*ross)**(-0.18),.3)<a name='871'>
     endif<a name='872'>
   enddo<a name='873'>
<font color=#447700>!<a name='874'></font>
   do i = its,ite<a name='875'>
     if(.not.stable(i))then<a name='876'>
       if((xland(i)-1.5).ge.0)then<a name='877'>
         brcr(i) = brcr_sbro(i)<a name='878'>
       else<a name='879'>
         brcr(i) = brcr_sb<a name='880'>
       endif<a name='881'>
     endif<a name='882'>
   enddo<a name='883'>
<font color=#447700>!<a name='884'></font>
   do k = 2,klpbl<a name='885'>
     do i = its,ite<a name='886'>
       if(.not.stable(i))then<a name='887'>
         brdn(i) = brup(i)<a name='888'>
         spdk2   = max(ux(i,k)**2+vx(i,k)**2,1.)<a name='889'>
         brup(i) = (thvx(i,k)-thermal(i))*(g*za(i,k)/thvx(i,1))/spdk2<a name='890'>
         kpbl(i) = k<a name='891'>
         stable(i) = brup(i).gt.brcr(i)<a name='892'>
       endif<a name='893'>
     enddo<a name='894'>
   enddo<a name='895'>
<font color=#447700>!<a name='896'></font>
   do i = its,ite<a name='897'>
     if((.not.sfcflg(i)).and.hpbl(i).lt.zq(i,2)) then<a name='898'>
       k = kpbl(i)<a name='899'>
       if(brdn(i).ge.brcr(i))then<a name='900'>
         brint = 0.<a name='901'>
       elseif(brup(i).le.brcr(i))then<a name='902'>
         brint = 1.<a name='903'>
       else<a name='904'>
         brint = (brcr(i)-brdn(i))/(brup(i)-brdn(i))<a name='905'>
       endif<a name='906'>
       hpbl(i) = za(i,k-1)+brint*(za(i,k)-za(i,k-1))<a name='907'>
       if(hpbl(i).lt.zq(i,2)) kpbl(i) = 1<a name='908'>
       if(kpbl(i).le.1) pblflg(i) = .false.<a name='909'>
     endif<a name='910'>
   enddo<a name='911'>
<font color=#447700>!<a name='912'></font>
<font color=#447700>!     scale dependency for nonlocal momentum and moisture transport<a name='913'></font>
<font color=#447700>!<a name='914'></font>
   delxy=sqrt(dx*dy)<a name='915'>
<font color=#447700>!<a name='916'></font>
   do i = its,ite<a name='917'>
     pu1=<A href='../../html_code/phys/module_bl_shinhong.F.html#PU'>pu</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PU_1">(delxy,cslen(i))<a name='918'>
     pq1=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_1">(delxy,cslen(i))<a name='919'>
     if(pblflg(i)) then<a name='920'>
       hgamu(i) = hgamu(i)*pu1<a name='921'>
       hgamv(i) = hgamv(i)*pu1<a name='922'>
       hgamq(i) = hgamq(i)*pq1<a name='923'>
     endif<a name='924'>
   enddo<a name='925'>
<font color=#447700>!<a name='926'></font>
<font color=#447700>!     estimate the entrainment parameters<a name='927'></font>
<font color=#447700>!<a name='928'></font>
   delxy=sqrt(dx*dy)<a name='929'>
<font color=#447700>!<a name='930'></font>
   do i = its,ite<a name='931'>
     if(pblflg(i)) then<a name='932'>
       k = kpbl(i) - 1<a name='933'>
       prpbl(i) = 1.0<a name='934'>
       wm3       = wstar3(i) + 5. * ust3(i)<a name='935'>
       wm2(i)    = wm3**h2<a name='936'>
       bfxpbl(i) = -0.15*thvx(i,1)/g*wm3/hpbl(i)<a name='937'>
       dthvx(i)  = max(thvx(i,k+1)-thvx(i,k),tmin)<a name='938'>
       dthx  = max(thx(i,k+1)-thx(i,k),tmin)<a name='939'>
       dqx   = min(qx(i,k+1)-qx(i,k),0.0)<a name='940'>
       we(i) = max(bfxpbl(i)/dthvx(i),-sqrt(wm2(i)))<a name='941'>
       hfxpbl(i) = we(i)*dthx<a name='942'>
       pq1=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_2">(delxy,cslen(i))<a name='943'>
       qfxpbl(i) = we(i)*dqx*pq1<a name='944'>
<font color=#447700>!<a name='945'></font>
       pu1=<A href='../../html_code/phys/module_bl_shinhong.F.html#PU'>pu</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PU_2">(delxy,cslen(i))<a name='946'>
       dux = ux(i,k+1)-ux(i,k)<a name='947'>
       dvx = vx(i,k+1)-vx(i,k)<a name='948'>
       if(dux.gt.tmin) then<a name='949'>
         ufxpbl(i) = max(prpbl(i)*we(i)*dux*pu1,-ust(i)*ust(i))<a name='950'>
       elseif(dux.lt.-tmin) then<a name='951'>
         ufxpbl(i) = min(prpbl(i)*we(i)*dux*pu1,ust(i)*ust(i))<a name='952'>
       else<a name='953'>
         ufxpbl(i) = 0.0<a name='954'>
       endif<a name='955'>
       if(dvx.gt.tmin) then<a name='956'>
         vfxpbl(i) = max(prpbl(i)*we(i)*dvx*pu1,-ust(i)*ust(i))<a name='957'>
       elseif(dvx.lt.-tmin) then<a name='958'>
         vfxpbl(i) = min(prpbl(i)*we(i)*dvx*pu1,ust(i)*ust(i))<a name='959'>
       else<a name='960'>
         vfxpbl(i) = 0.0<a name='961'>
       endif<a name='962'>
       delb  = govrth(i)*d3*hpbl(i)<a name='963'>
       delta(i) = min(d1*hpbl(i) + d2*wm2(i)/delb,100.)<a name='964'>
       delb  = govrth(i)*dthvx(i)<a name='965'>
       deltaoh(i) = d1*hpbl(i) + d2*wm2(i)/delb<a name='966'>
       deltaoh(i) = max(ezfac*deltaoh(i),hpbl(i)-za(i,kpbl(i)-1)-1.)<a name='967'>
       deltaoh(i) = min(deltaoh(i)      ,hpbl(i))<a name='968'>
       rigs(i)     = govrth(i)*dthvx(i)*deltaoh(i)/(dux**2.+dvx**2.)<a name='969'>
       rigs(i)     = max(min(rigs(i), rigsmax),rimin)<a name='970'>
       enlfrac2(i) = max(min(wm3/wstar3(i)/(1.+cpent/rigs(i)),entfmax), entfmin)<a name='971'>
       enlfrac2(i) = enlfrac2(i)*enlfrac<a name='972'>
     endif<a name='973'>
   enddo<a name='974'>
<font color=#447700>!<a name='975'></font>
   do k = kts,klpbl<a name='976'>
     do i = its,ite<a name='977'>
       if(pblflg(i))then<a name='978'>
         entfacmf(i,k) = sqrt(((zq(i,k+1)-hpbl(i))/deltaoh(i))**2.)<a name='979'>
       endif<a name='980'>
       if(pblflg(i).and.k.ge.kpbl(i))then<a name='981'>
         entfac(i,k) = ((zq(i,k+1)-hpbl(i))/deltaoh(i))**2.<a name='982'>
       else<a name='983'>
         entfac(i,k) = 1.e30<a name='984'>
       endif<a name='985'>
     enddo<a name='986'>
   enddo<a name='987'>
<font color=#447700>!<a name='988'></font>
<font color=#447700>!     compute diffusion coefficients below pbl<a name='989'></font>
<font color=#447700>!<a name='990'></font>
   do k = kts,klpbl<a name='991'>
     do i = its,ite<a name='992'>
       if(k.lt.kpbl(i)) then<a name='993'>
         zfac(i,k) = min(max((1.-(zq(i,k+1)-zl1(i))/(hpbl(i)-zl1(i))),zfmin),1.)<a name='994'>
         zfacent(i,k) = (1.-zfac(i,k))**3.<a name='995'>
         wscalek(i,k) = (ust3(i)+phifac*karman*wstar3(i)*(1.-zfac(i,k)))**h1<a name='996'>
         if(sfcflg(i)) then <a name='997'>
           prfac = conpr<a name='998'>
           prfac2 = 15.9*wstar3(i)/ust3(i)/(1.+4.*karman*wstar3(i)/ust3(i))<a name='999'>
           prnumfac = -3.*(max(zq(i,k+1)-sfcfrac*hpbl(i),0.))**2./hpbl(i)**2.<a name='1000'>
         else<a name='1001'>
           prfac = 0.<a name='1002'>
           prfac2 = 0.<a name='1003'>
           prnumfac = 0.<a name='1004'>
           phim8z = 1.+aphi5*zol1(i)*zq(i,k+1)/zl1(i)<a name='1005'>
           wscalek(i,k) = ust(i)/phim8z<a name='1006'>
           wscalek(i,k) = max(wscalek(i,k),0.001)<a name='1007'>
         endif<a name='1008'>
         prnum0 = (phih(i)/phim(i)+prfac)<a name='1009'>
         prnum0 = max(min(prnum0,prmax),prmin)<a name='1010'>
         xkzm(i,k) = wscalek(i,k)*karman*zq(i,k+1)*zfac(i,k)**pfac<a name='1011'>
         prnum =  1. + (prnum0-1.)*exp(prnumfac)<a name='1012'>
         xkzq(i,k) = xkzm(i,k)/prnum*zfac(i,k)**(pfac_q-pfac)<a name='1013'>
         prnum0 = prnum0/(1.+prfac2*karman*sfcfrac)<a name='1014'>
         prnum =  1. + (prnum0-1.)*exp(prnumfac)<a name='1015'>
         xkzh(i,k) = xkzm(i,k)/prnum<a name='1016'>
         xkzm(i,k) = xkzm(i,k)+xkzom(i,k)<a name='1017'>
         xkzh(i,k) = xkzh(i,k)+xkzoh(i,k)<a name='1018'>
         xkzq(i,k) = xkzq(i,k)+xkzoh(i,k)<a name='1019'>
         xkzm(i,k) = min(xkzm(i,k),xkzmax)<a name='1020'>
         xkzh(i,k) = min(xkzh(i,k),xkzmax)<a name='1021'>
         xkzq(i,k) = min(xkzq(i,k),xkzmax)<a name='1022'>
       endif<a name='1023'>
     enddo<a name='1024'>
   enddo<a name='1025'>
<font color=#447700>!<a name='1026'></font>
<font color=#447700>!     compute diffusion coefficients over pbl (free atmosphere)<a name='1027'></font>
<font color=#447700>!<a name='1028'></font>
   do k = kts,kte-1<a name='1029'>
     do i = its,ite<a name='1030'>
       if(k.ge.kpbl(i)) then<a name='1031'>
         ss = ((ux(i,k+1)-ux(i,k))*(ux(i,k+1)-ux(i,k))                         &amp;<a name='1032'>
              +(vx(i,k+1)-vx(i,k))*(vx(i,k+1)-vx(i,k)))                        &amp;<a name='1033'>
              /(dza(i,k+1)*dza(i,k+1))+1.e-9<a name='1034'>
         govrthv = g/(0.5*(thvx(i,k+1)+thvx(i,k)))<a name='1035'>
         ri = govrthv*(thvx(i,k+1)-thvx(i,k))/(ss*dza(i,k+1))<a name='1036'>
<font color=#447700>!      in cloud<a name='1037'></font>
         if(imvdif.eq.1.and.nwmass.ge.3)then<a name='1038'>
           if((qx(i,kqc+k-1)+qx(i,kqi+k-1)).gt.0.01e-3                         &amp;<a name='1039'>
             .and.(qx(i,kqc+k)+qx(i,kqi+k)).gt.0.01e-3) then<a name='1040'>
             qmean = 0.5*(qx(i,k)+qx(i,k+1))<a name='1041'>
             tmean = 0.5*(tx(i,k)+tx(i,k+1))<a name='1042'>
             alpha = xlv*qmean/rd/tmean<a name='1043'>
             chi   = xlv*xlv*qmean/cp/rv/tmean/tmean<a name='1044'>
             ri    = (1.+alpha)*(ri-g*g/ss/tmean/cp*((chi-alpha)/(1.+chi)))<a name='1045'>
           endif<a name='1046'>
         endif<a name='1047'>
         zk = karman*zq(i,k+1)<a name='1048'>
         rlamdz = min(max(0.1*dza(i,k+1),rlam),300.)<a name='1049'>
         rlamdz = min(dza(i,k+1),rlamdz)<a name='1050'>
         rl2 = (zk*rlamdz/(rlamdz+zk))**2<a name='1051'>
         dk = rl2*sqrt(ss)<a name='1052'>
         if(ri.lt.0.)then<a name='1053'>
<font color=#447700>! unstable regime<a name='1054'></font>
           ri = max(ri, rimin)<a name='1055'>
           sri = sqrt(-ri)<a name='1056'>
           xkzm(i,k) = dk*(1+8.*(-ri)/(1+1.746*sri))<a name='1057'>
           xkzh(i,k) = dk*(1+8.*(-ri)/(1+1.286*sri))<a name='1058'>
         else<a name='1059'>
<font color=#447700>! stable regime<a name='1060'></font>
           xkzh(i,k) = dk/(1+5.*ri)**2<a name='1061'>
           prnum = 1.0+2.1*ri<a name='1062'>
           prnum = min(prnum,prmax)<a name='1063'>
           xkzm(i,k) = xkzh(i,k)*prnum<a name='1064'>
         endif<a name='1065'>
<font color=#447700>!<a name='1066'></font>
         xkzm(i,k) = xkzm(i,k)+xkzom(i,k)<a name='1067'>
         xkzh(i,k) = xkzh(i,k)+xkzoh(i,k)<a name='1068'>
         xkzm(i,k) = min(xkzm(i,k),xkzmax)<a name='1069'>
         xkzh(i,k) = min(xkzh(i,k),xkzmax)<a name='1070'>
         xkzml(i,k) = xkzm(i,k)<a name='1071'>
         xkzhl(i,k) = xkzh(i,k)<a name='1072'>
       endif<a name='1073'>
     enddo<a name='1074'>
   enddo<a name='1075'>
<font color=#447700>!<a name='1076'></font>
<font color=#447700>!     prescribe nonlocal heat transport below pbl<a name='1077'></font>
<font color=#447700>!<a name='1078'></font>
   do i = its,ite<a name='1079'>
     deltaoh(i) = deltaoh(i)/hpbl(i)<a name='1080'>
   enddo<a name='1081'>
<font color=#447700>!<a name='1082'></font>
   delxy=sqrt(dx*dy)<a name='1083'>
   do i = its,ite<a name='1084'>
     mlfrac      = mltop-deltaoh(i)<a name='1085'>
     ezfrac      = mltop+deltaoh(i)<a name='1086'>
     zfacmf(i,1) = min(max((zq(i,2)/hpbl(i)),zfmin),1.)<a name='1087'>
     sfcfracn    = max(sfcfracn1,zfacmf(i,1))<a name='1088'>
<font color=#447700>!<a name='1089'></font>
     sflux0      = (a11+a12*sfcfracn)*sflux(i)<a name='1090'>
     snlflux0    = nlfrac*sflux0<a name='1091'>
     amf1        = snlflux0/sfcfracn<a name='1092'>
     amf2        = -snlflux0/(mlfrac-sfcfracn)<a name='1093'>
     bmf2        = -mlfrac*amf2<a name='1094'>
     amf3        = snlflux0*enlfrac2(i)/deltaoh(i)<a name='1095'>
     bmf3        = -amf3*mlfrac<a name='1096'>
     hfxpbl(i)   = amf3+bmf3<a name='1097'>
     pth1=<A href='../../html_code/phys/module_bl_shinhong.F.html#PTHNL'>pthnl</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTHNL_1">(delxy,cslen(i))<a name='1098'>
     hfxpbl(i)   = hfxpbl(i)*pth1<a name='1099'>
<font color=#447700>!<a name='1100'></font>
     do k = kts,klpbl<a name='1101'>
       zfacmf(i,k) = max((zq(i,k+1)/hpbl(i)),zfmin)<a name='1102'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1103'>
         if(zfacmf(i,k).le.sfcfracn) then<a name='1104'>
           mf(i,k) = amf1*zfacmf(i,k)<a name='1105'>
         else if (zfacmf(i,k).le.mlfrac) then<a name='1106'>
           mf(i,k) = amf2*zfacmf(i,k)+bmf2<a name='1107'>
         endif<a name='1108'>
         mf(i,k) = mf(i,k)+hfxpbl(i)*exp(-entfacmf(i,k))<a name='1109'>
         mf(i,k) = mf(i,k)*pth1<a name='1110'>
       endif<a name='1111'>
     enddo<a name='1112'>
   enddo<a name='1113'>
<font color=#447700>!<a name='1114'></font>
<font color=#447700>!     compute tridiagonal matrix elements for heat<a name='1115'></font>
<font color=#447700>!<a name='1116'></font>
   do k = kts,kte<a name='1117'>
     do i = its,ite<a name='1118'>
       au(i,k) = 0.<a name='1119'>
       al(i,k) = 0.<a name='1120'>
       ad(i,k) = 0.<a name='1121'>
       f1(i,k) = 0.<a name='1122'>
     enddo<a name='1123'>
   enddo<a name='1124'>
<font color=#447700>!<a name='1125'></font>
   do i = its,ite<a name='1126'>
     ad(i,1) = 1.<a name='1127'>
     f1(i,1) = thx(i,1)-300.+hfx(i)/cont/del(i,1)*dt2<a name='1128'>
   enddo<a name='1129'>
<font color=#447700>!<a name='1130'></font>
   delxy=sqrt(dx*dy)<a name='1131'>
   do k = kts,kte-1<a name='1132'>
     do i = its,ite<a name='1133'>
       dtodsd = dt2/del(i,k)<a name='1134'>
       dtodsu = dt2/del(i,k+1)<a name='1135'>
       dsig   = p2d(i,k)-p2d(i,k+1)<a name='1136'>
       rdz    = 1./dza(i,k+1)<a name='1137'>
       tem1   = dsig*xkzh(i,k)*rdz<a name='1138'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1139'>
         dsdzt = tem1*(-mf(i,k)/xkzh(i,k))<a name='1140'>
         f1(i,k)   = f1(i,k)+dtodsd*dsdzt<a name='1141'>
         f1(i,k+1) = thx(i,k+1)-300.-dtodsu*dsdzt<a name='1142'>
       elseif(pblflg(i).and.k.ge.kpbl(i).and.entfac(i,k).lt.4.6) then<a name='1143'>
         xkzh(i,k) = -we(i)*dza(i,kpbl(i))*exp(-entfac(i,k))<a name='1144'>
         xkzh(i,k) = sqrt(xkzh(i,k)*xkzhl(i,k))<a name='1145'>
         xkzh(i,k) = max(xkzh(i,k),xkzoh(i,k))<a name='1146'>
         xkzh(i,k) = min(xkzh(i,k),xkzmax)<a name='1147'>
         f1(i,k+1) = thx(i,k+1)-300.<a name='1148'>
       else<a name='1149'>
         f1(i,k+1) = thx(i,k+1)-300.<a name='1150'>
       endif<a name='1151'>
       tem1   = dsig*xkzh(i,k)*rdz<a name='1152'>
       dsdz2     = tem1*rdz<a name='1153'>
       au(i,k)   = -dtodsd*dsdz2<a name='1154'>
       al(i,k)   = -dtodsu*dsdz2<a name='1155'>
<font color=#447700>!<a name='1156'></font>
<font color=#447700>!     scale dependency for local heat transport<a name='1157'></font>
<font color=#447700>!<a name='1158'></font>
       zfacdx=0.2*hpbl(i)/zq(i,k+1)<a name='1159'>
       delxy=sqrt(dx*dy)*max(zfacdx,1.0)<a name='1160'>
       pth1=<A href='../../html_code/phys/module_bl_shinhong.F.html#PTHL'>pthl</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTHL_7">(delxy,hpbl(i))<a name='1161'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1162'>
         au(i,k) = au(i,k)*pth1<a name='1163'>
         al(i,k) = al(i,k)*pth1<a name='1164'>
       endif<a name='1165'>
       ad(i,k)   = ad(i,k)-au(i,k)<a name='1166'>
       ad(i,k+1) = 1.-al(i,k)<a name='1167'>
       exch_hx(i,k+1) = xkzh(i,k)<a name='1168'>
     enddo<a name='1169'>
   enddo<a name='1170'>
<font color=#447700>!<a name='1171'></font>
<font color=#447700>! copies here to avoid duplicate input args for tridin<a name='1172'></font>
<font color=#447700>!<a name='1173'></font>
   do k = kts,kte<a name='1174'>
     do i = its,ite<a name='1175'>
       cu(i,k) = au(i,k)<a name='1176'>
       r1(i,k) = f1(i,k)<a name='1177'>
     enddo<a name='1178'>
   enddo<a name='1179'>
<font color=#447700>!<a name='1180'></font>
   call <A href='../../html_code/phys/module_bl_ysu.F.html#TRIDIN_YSU'>tridin_ysu</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIN_YSU_1">(al,ad,cu,r1,au,f1,its,ite,kts,kte,1)<a name='1181'>
<font color=#447700>!<a name='1182'></font>
<font color=#447700>!     recover tendencies of heat<a name='1183'></font>
<font color=#447700>!<a name='1184'></font>
   do k = kte,kts,-1<a name='1185'>
     do i = its,ite<a name='1186'>
       ttend = (f1(i,k)-thx(i,k)+300.)*rdt*pi2d(i,k)<a name='1187'>
       ttnp(i,k) = ttnp(i,k)+ttend<a name='1188'>
       dtsfc(i) = dtsfc(i)+ttend*cont*del(i,k)/pi2d(i,k)<a name='1189'>
       if(k.eq.kte) then<a name='1190'>
         tflux_e(i,k) = ttend*dz8w2d(i,k)<a name='1191'>
       else<a name='1192'>
         tflux_e(i,k) = tflux_e(i,k+1) + ttend*dz8w2d(i,k)<a name='1193'>
       endif<a name='1194'>
     enddo<a name='1195'>
   enddo<a name='1196'>
<font color=#447700>!<a name='1197'></font>
<font color=#447700>!     compute tridiagonal matrix elements for moisture, clouds, and gases<a name='1198'></font>
<font color=#447700>!<a name='1199'></font>
   do k = kts,kte<a name='1200'>
     do i = its,ite<a name='1201'>
       au(i,k) = 0.<a name='1202'>
       al(i,k) = 0.<a name='1203'>
       ad(i,k) = 0.<a name='1204'>
     enddo<a name='1205'>
   enddo<a name='1206'>
<font color=#447700>!<a name='1207'></font>
   do ic = 1,ndiff<a name='1208'>
     do i = its,ite<a name='1209'>
       do k = kts,kte<a name='1210'>
         f3(i,k,ic) = 0.<a name='1211'>
       enddo<a name='1212'>
     enddo<a name='1213'>
   enddo<a name='1214'>
<font color=#447700>!<a name='1215'></font>
   do i = its,ite<a name='1216'>
     ad(i,1) = 1.<a name='1217'>
     f3(i,1,1) = qx(i,1)+qfx(i)*g/del(i,1)*dt2<a name='1218'>
   enddo<a name='1219'>
<font color=#447700>!<a name='1220'></font>
   if(ndiff.ge.2) then<a name='1221'>
     do ic = 2,ndiff<a name='1222'>
       is = (ic-1) * kte<a name='1223'>
       do i = its,ite<a name='1224'>
         f3(i,1,ic) = qx(i,1+is)<a name='1225'>
       enddo<a name='1226'>
     enddo<a name='1227'>
   endif<a name='1228'>
<font color=#447700>!<a name='1229'></font>
   do k = kts,kte-1<a name='1230'>
     do i = its,ite<a name='1231'>
       if(k.ge.kpbl(i)) then<a name='1232'>
         xkzq(i,k) = xkzh(i,k)<a name='1233'>
       endif<a name='1234'>
     enddo<a name='1235'>
   enddo<a name='1236'>
<font color=#447700>!<a name='1237'></font>
   do k = kts,kte-1<a name='1238'>
     do i = its,ite<a name='1239'>
       dtodsd = dt2/del(i,k)<a name='1240'>
       dtodsu = dt2/del(i,k+1)<a name='1241'>
       dsig   = p2d(i,k)-p2d(i,k+1)<a name='1242'>
       rdz    = 1./dza(i,k+1)<a name='1243'>
       tem1   = dsig*xkzq(i,k)*rdz<a name='1244'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1245'>
         dsdzq = tem1*(-qfxpbl(i)*zfacent(i,k)/xkzq(i,k))<a name='1246'>
         f3(i,k,1) = f3(i,k,1)+dtodsd*dsdzq<a name='1247'>
         f3(i,k+1,1) = qx(i,k+1)-dtodsu*dsdzq<a name='1248'>
       elseif(pblflg(i).and.k.ge.kpbl(i).and.entfac(i,k).lt.4.6) then<a name='1249'>
         xkzq(i,k) = -we(i)*dza(i,kpbl(i))*exp(-entfac(i,k))<a name='1250'>
         xkzq(i,k) = sqrt(xkzq(i,k)*xkzhl(i,k))<a name='1251'>
         xkzq(i,k) = max(xkzq(i,k),xkzoh(i,k))<a name='1252'>
         xkzq(i,k) = min(xkzq(i,k),xkzmax)<a name='1253'>
         f3(i,k+1,1) = qx(i,k+1)<a name='1254'>
       else<a name='1255'>
         f3(i,k+1,1) = qx(i,k+1)<a name='1256'>
       endif<a name='1257'>
       tem1   = dsig*xkzq(i,k)*rdz<a name='1258'>
       dsdz2     = tem1*rdz<a name='1259'>
       au(i,k)   = -dtodsd*dsdz2<a name='1260'>
       al(i,k)   = -dtodsu*dsdz2<a name='1261'>
<font color=#447700>!<a name='1262'></font>
<font color=#447700>!     scale dependency for local moisture transport<a name='1263'></font>
<font color=#447700>!<a name='1264'></font>
       zfacdx=0.2*hpbl(i)/zq(i,k+1)<a name='1265'>
       delxy=sqrt(dx*dy)*max(zfacdx,1.0)<a name='1266'>
       pq1=<A href='../../html_code/phys/module_bl_shinhong.F.html#PQ'>pq</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PQ_3">(delxy,hpbl(i))<a name='1267'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1268'>
         au(i,k) = au(i,k)*pq1<a name='1269'>
         al(i,k) = al(i,k)*pq1<a name='1270'>
       endif<a name='1271'>
       ad(i,k)   = ad(i,k)-au(i,k)<a name='1272'>
       ad(i,k+1) = 1.-al(i,k)<a name='1273'>
<font color=#447700>!      exch_hx(i,k+1) = xkzh(i,k)<a name='1274'></font>
     enddo<a name='1275'>
   enddo<a name='1276'>
<font color=#447700>!<a name='1277'></font>
   if(ndiff.ge.2) then<a name='1278'>
     do ic = 2,ndiff<a name='1279'>
       is = (ic-1) * kte<a name='1280'>
       do k = kts,kte-1<a name='1281'>
         do i = its,ite<a name='1282'>
           f3(i,k+1,ic) = qx(i,k+1+is)<a name='1283'>
         enddo<a name='1284'>
       enddo<a name='1285'>
     enddo<a name='1286'>
   endif<a name='1287'>
<font color=#447700>!<a name='1288'></font>
<font color=#447700>! copies here to avoid duplicate input args for tridin<a name='1289'></font>
<font color=#447700>!<a name='1290'></font>
   do k = kts,kte<a name='1291'>
     do i = its,ite<a name='1292'>
       cu(i,k) = au(i,k)<a name='1293'>
     enddo<a name='1294'>
   enddo<a name='1295'>
<font color=#447700>!<a name='1296'></font>
   do ic = 1,ndiff<a name='1297'>
     do k = kts,kte<a name='1298'>
       do i = its,ite<a name='1299'>
         r3(i,k,ic) = f3(i,k,ic)<a name='1300'>
       enddo<a name='1301'>
     enddo<a name='1302'>
   enddo<a name='1303'>
<font color=#447700>!<a name='1304'></font>
<font color=#447700>!     solve tridiagonal problem for moisture, clouds, and gases<a name='1305'></font>
<font color=#447700>!<a name='1306'></font>
   call <A href='../../html_code/phys/module_bl_ysu.F.html#TRIDIN_YSU'>tridin_ysu</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDIN_YSU_2">(al,ad,cu,r3,au,f3,its,ite,kts,kte,ndiff)<a name='1307'>
<font color=#447700>!<a name='1308'></font>
<font color=#447700>!     recover tendencies of heat and moisture<a name='1309'></font>
<font color=#447700>!<a name='1310'></font>
   do k = kte,kts,-1<a name='1311'>
     do i = its,ite<a name='1312'>
       qtend = (f3(i,k,1)-qx(i,k))*rdt<a name='1313'>
       qtnp(i,k) = qtnp(i,k)+qtend<a name='1314'>
       dqsfc(i) = dqsfc(i)+qtend*conq*del(i,k)<a name='1315'>
       if(k.eq.kte) then<a name='1316'>
         qflux_e(i,k) = qtend*dz8w2d(i,k)<a name='1317'>
       else<a name='1318'>
         qflux_e(i,k) = qflux_e(i,k+1) + qtend*dz8w2d(i,k)<a name='1319'>
       endif<a name='1320'>
       tvflux_e(i,k) = tflux_e(i,k) + qflux_e(i,k)*ep1*thx(i,k)<a name='1321'>
     enddo<a name='1322'>
   enddo<a name='1323'>
<font color=#447700>!<a name='1324'></font>
   do k = kts,kte<a name='1325'>
     do i = its,ite<a name='1326'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1327'>
         hgame_c=c_1*0.2*2.5*(g/thvx(i,k))*wstar(i)/(0.25*(q2x(i,k+1)+q2x(i,k)))<a name='1328'>
         hgame_c=min(hgame_c,gamcre)<a name='1329'>
         if(k.eq.kte)then<a name='1330'>
           hgame2d(i,k)=hgame_c*0.5*tvflux_e(i,k)*hpbl(i)<a name='1331'>
           hgame2d(i,k)=max(hgame2d(i,k),0.0)<a name='1332'>
         else<a name='1333'>
           hgame2d(i,k)=hgame_c*0.5*(tvflux_e(i,k)+tvflux_e(i,k+1))*hpbl(i)<a name='1334'>
           hgame2d(i,k)=max(hgame2d(i,k),0.0)<a name='1335'>
         endif<a name='1336'>
       endif<a name='1337'>
     enddo<a name='1338'>
   enddo<a name='1339'>
<font color=#447700>!<a name='1340'></font>
   if(ndiff.ge.2) then<a name='1341'>
     do ic = 2,ndiff<a name='1342'>
       if(ifvmix(ic)) then<a name='1343'>
         is = (ic-1) * kte<a name='1344'>
         do k = kte,kts,-1<a name='1345'>
           do i = its,ite<a name='1346'>
             qtend = (f3(i,k,ic)-qx(i,k+is))*rdt<a name='1347'>
             qtnp(i,k+is) = qtnp(i,k+is)+qtend<a name='1348'>
           enddo<a name='1349'>
         enddo<a name='1350'>
       endif<a name='1351'>
     enddo<a name='1352'>
   endif<a name='1353'>
<font color=#447700>!<a name='1354'></font>
<font color=#447700>!     compute tridiagonal matrix elements for momentum<a name='1355'></font>
<font color=#447700>!<a name='1356'></font>
   do i = its,ite<a name='1357'>
     do k = kts,kte<a name='1358'>
       au(i,k) = 0.<a name='1359'>
       al(i,k) = 0.<a name='1360'>
       ad(i,k) = 0.<a name='1361'>
       f1(i,k) = 0.<a name='1362'>
       f2(i,k) = 0.<a name='1363'>
     enddo<a name='1364'>
   enddo<a name='1365'>
<font color=#447700>!<a name='1366'></font>
   do i = its,ite<a name='1367'>
<font color=#447700>! paj: ctopo=1 if topo_wind=0 (default)<a name='1368'></font>
<font color=#447700>! mchen add this line to make sure NMM can still work with YSU PBL<a name='1369'></font>
     ad(i,1) = 1.+ctopo(i)*ust(i)**2/wspd1(i)*rhox(i)*g/del(i,1)*dt2           &amp;<a name='1370'>
          *(wspd1(i)/wspd(i))**2<a name='1371'>
     f1(i,1) = ux(i,1)<a name='1372'>
     f2(i,1) = vx(i,1)<a name='1373'>
   enddo<a name='1374'>
<font color=#447700>!<a name='1375'></font>
   delxy=sqrt(dx*dy)<a name='1376'>
   do k = kts,kte-1<a name='1377'>
     do i = its,ite<a name='1378'>
       dtodsd = dt2/del(i,k)<a name='1379'>
       dtodsu = dt2/del(i,k+1)<a name='1380'>
       dsig   = p2d(i,k)-p2d(i,k+1)<a name='1381'>
       rdz    = 1./dza(i,k+1)<a name='1382'>
       tem1   = dsig*xkzm(i,k)*rdz<a name='1383'>
       if(pblflg(i).and.k.lt.kpbl(i))then<a name='1384'>
         dsdzu     = tem1*(-hgamu(i)/hpbl(i)-ufxpbl(i)*zfacent(i,k)/xkzm(i,k))<a name='1385'>
         dsdzv     = tem1*(-hgamv(i)/hpbl(i)-vfxpbl(i)*zfacent(i,k)/xkzm(i,k))<a name='1386'>
         f1(i,k)   = f1(i,k)+dtodsd*dsdzu<a name='1387'>
         f1(i,k+1) = ux(i,k+1)-dtodsu*dsdzu<a name='1388'>
         f2(i,k)   = f2(i,k)+dtodsd*dsdzv<a name='1389'>
         f2(i,k+1) = vx(i,k+1)-dtodsu*dsdzv<a name='1390'>
       elseif(pblflg(i).and.k.ge.kpbl(i).and.entfac(i,k).lt.4.6) then<a name='1391'>
         xkzm(i,k) = prpbl(i)*xkzh(i,k)<a name='1392'>
         xkzm(i,k) = sqrt(xkzm(i,k)*xkzml(i,k))<a name='1393'>
         xkzm(i,k) = max(xkzm(i,k),xkzom(i,k))<a name='1394'>
         xkzm(i,k) = min(xkzm(i,k),xkzmax)<a name='1395'>
         f1(i,k+1) = ux(i,k+1)<a name='1396'>
         f2(i,k+1) = vx(i,k+1)<a name='1397'>
       else<a name='1398'>
         f1(i,k+1) = ux(i,k+1)<a name='1399'>
         f2(i,k+1) = vx(i,k+1)<a name='1400'>
       endif<a name='1401'>
       tem1   = dsig*xkzm(i,k)*rdz<a name='1402'>
       dsdz2     = tem1*rdz<a name='1403'>
       au(i,k)   = -dtodsd*dsdz2<a name='1404'>
       al(i,k)   = -dtodsu*dsdz2<a name='1405'>
<font color=#447700>!<a name='1406'></font>
<font color=#447700>!     scale dependency for local momentum transport<a name='1407'></font>
<font color=#447700>!<a name='1408'></font>
       zfacdx=0.2*hpbl(i)/zq(i,k+1)<a name='1409'>
       delxy=sqrt(dx*dy)*max(zfacdx,1.0)<a name='1410'>
       pu1=<A href='../../html_code/phys/module_bl_shinhong.F.html#PU'>pu</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PU_3">(delxy,hpbl(i))<a name='1411'>
       if(pblflg(i).and.k.lt.kpbl(i)) then<a name='1412'>
         au(i,k) = au(i,k)*pu1<a name='1413'>
         al(i,k) = al(i,k)*pu1<a name='1414'>
       endif<a name='1415'>
       ad(i,k)   = ad(i,k)-au(i,k)<a name='1416'>
       ad(i,k+1) = 1.-al(i,k)<a name='1417'>
     enddo<a name='1418'>
   enddo<a name='1419'>
<font color=#447700>!<a name='1420'></font>
<font color=#447700>! copies here to avoid duplicate input args for tridin<a name='1421'></font>
<font color=#447700>!<a name='1422'></font>
   do k = kts,kte<a name='1423'>
     do i = its,ite<a name='1424'>
       cu(i,k) = au(i,k)<a name='1425'>
       r1(i,k) = f1(i,k)<a name='1426'>
       r2(i,k) = f2(i,k)<a name='1427'>
     enddo<a name='1428'>
   enddo<a name='1429'>
<font color=#447700>!<a name='1430'></font>
<font color=#447700>!     solve tridiagonal problem for momentum<a name='1431'></font>
<font color=#447700>!<a name='1432'></font>
   call <A href='../../html_code/phys/module_bl_ysu.F.html#TRIDI1N'>tridi1n</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDI1N_1">(al,ad,cu,r1,r2,au,f1,f2,its,ite,kts,kte,1)<a name='1433'>
<font color=#447700>!<a name='1434'></font>
<font color=#447700>!     recover tendencies of momentum<a name='1435'></font>
<font color=#447700>!<a name='1436'></font>
   do k = kte,kts,-1<a name='1437'>
     do i = its,ite<a name='1438'>
       utend = (f1(i,k)-ux(i,k))*rdt<a name='1439'>
       vtend = (f2(i,k)-vx(i,k))*rdt<a name='1440'>
       utnp(i,k) = utnp(i,k)+utend<a name='1441'>
       vtnp(i,k) = vtnp(i,k)+vtend<a name='1442'>
       dusfc(i) = dusfc(i) + utend*conwrc*del(i,k)<a name='1443'>
       dvsfc(i) = dvsfc(i) + vtend*conwrc*del(i,k)<a name='1444'>
     enddo<a name='1445'>
   enddo<a name='1446'>
<font color=#447700>!<a name='1447'></font>
   do i = its,ite<a name='1448'>
     kpbl1d(i) = kpbl(i)<a name='1449'>
   enddo<a name='1450'>
<font color=#447700>!<a name='1451'></font>
<font color=#447700>! paj: ctopo2=1 if topo_wind=0 (default)<a name='1452'></font>
<font color=#447700>!<a name='1453'></font>
   do i = its,ite<a name='1454'>
     u10(i) = ctopo2(i)*u10(i)+(1-ctopo2(i))*ux(i,1)<a name='1455'>
     v10(i) = ctopo2(i)*v10(i)+(1-ctopo2(i))*vx(i,1)<a name='1456'>
   enddo<a name='1457'>
<font color=#447700>!<a name='1458'></font>
<font color=#447700>!---- calculate sgs tke which is consistent with shinhongpbl algorithm<a name='1459'></font>
<font color=#447700>!<a name='1460'></font>
   if (shinhong_tke_diag.eq.1) then<a name='1461'>
<font color=#447700>!<a name='1462'></font>
   tke_calculation: do i = its,ite<a name='1463'>
     do k = kts+1,kte<a name='1464'>
       s2(k)   = 0.0<a name='1465'>
       gh(k)   = 0.0<a name='1466'>
       rig(k)  = 0.0<a name='1467'>
       el(k)   = 0.0<a name='1468'>
       akmk(k) = 0.0<a name='1469'>
       akhk(k) = 0.0<a name='1470'>
       mfk(k)      = 0.0<a name='1471'>
       ufxpblk(k)  = 0.0<a name='1472'>
       vfxpblk(k)  = 0.0<a name='1473'>
       qfxpblk(k)  = 0.0<a name='1474'>
     enddo<a name='1475'>
<font color=#447700>!<a name='1476'></font>
     do k = kts,kte<a name='1477'>
       uxk(k)   = 0.0<a name='1478'>
       vxk(k)   = 0.0<a name='1479'>
       txk(k)   = 0.0<a name='1480'>
       thxk(k)  = 0.0<a name='1481'>
       thvxk(k) = 0.0<a name='1482'>
       q2xk(k)  = 0.0<a name='1483'>
       hgame(k) = 0.0<a name='1484'>
       ps1d(k)  = 0.0<a name='1485'>
       pb1d(k)  = 0.0<a name='1486'>
       eps1d(k) = 0.0<a name='1487'>
       pt1d(k)  = 0.0<a name='1488'>
       xkze1d(k)    = 0.0<a name='1489'>
       eflx_l1d(k)  = 0.0<a name='1490'>
       eflx_nl1d(k) = 0.0<a name='1491'>
       ptke1(k)     = 1.0<a name='1492'>
     enddo<a name='1493'>
<font color=#447700>!<a name='1494'></font>
     do k = kts,kte+1<a name='1495'>
       zqk(k)   = 0.0<a name='1496'>
     enddo<a name='1497'>
<font color=#447700>!<a name='1498'></font>
     do k = kts,kte*ndiff<a name='1499'>
       qxk(k) = 0.0<a name='1500'>
     enddo<a name='1501'>
<font color=#447700>!<a name='1502'></font>
     do k = kts,kte<a name='1503'>
       uxk(k)   = ux(i,k)<a name='1504'>
       vxk(k)   = vx(i,k)<a name='1505'>
       txk(k)   = tx(i,k)<a name='1506'>
       thxk(k)  = thx(i,k)<a name='1507'>
       thvxk(k) = thvx(i,k)<a name='1508'>
       q2xk(k)  = q2x(i,k)<a name='1509'>
       hgame(k) = hgame2d(i,k)<a name='1510'>
     enddo<a name='1511'>
<font color=#447700>!<a name='1512'></font>
     do k = kts,kte-1<a name='1513'>
       if(pblflg(i).and.k.le.kpbl(i)) then<a name='1514'>
         zfacdx      = 0.2*hpbl(i)/za(i,k)<a name='1515'>
         delxy       = sqrt(dx*dy)*max(zfacdx,1.0)<a name='1516'>
         ptke1(k+1)  = <A href='../../html_code/phys/module_bl_shinhong.F.html#PTKE'>ptke</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PTKE_1">(delxy,hpbl(i))<a name='1517'>
       endif<a name='1518'>
     enddo<a name='1519'>
<font color=#447700>!<a name='1520'></font>
     do k = kts,kte+1<a name='1521'>
       zqk(k) = zq(i,k)<a name='1522'>
     enddo<a name='1523'>
<font color=#447700>!<a name='1524'></font>
     do k = kts,kte*ndiff<a name='1525'>
       qxk(k) = qx(i,k)<a name='1526'>
     enddo<a name='1527'>
<font color=#447700>!<a name='1528'></font>
     do k = kts+1,kte<a name='1529'>
       akmk(k) = xkzm(i,k-1)<a name='1530'>
       akhk(k) = xkzh(i,k-1)<a name='1531'>
       mfk(k)      = mf(i,k-1)/xkzh(i,k-1)<a name='1532'>
       ufxpblk(k)  = ufxpbl(i)*zfacent(i,k-1)/xkzm(i,k-1)<a name='1533'>
       vfxpblk(k)  = vfxpbl(i)*zfacent(i,k-1)/xkzm(i,k-1)<a name='1534'>
       qfxpblk(k)  = qfxpbl(i)*zfacent(i,k-1)/xkzq(i,k-1)<a name='1535'>
     enddo<a name='1536'>
<font color=#447700>!<a name='1537'></font>
     if(pblflg(i)) then<a name='1538'>
       k = kpbl(i) - 1<a name='1539'>
       dex = 0.25*(q2xk(k+2)-q2xk(k))<a name='1540'>
       efxpbl(i) = we(i)*dex<a name='1541'>
     endif<a name='1542'>
<font color=#447700>!<a name='1543'></font>
     delxy=sqrt(dx*dy)<a name='1544'>
<font color=#447700>!<a name='1545'></font>
<font color=#447700>!---- find the mixing length<a name='1546'></font>
<font color=#447700>!<a name='1547'></font>
     call <A href='../../html_code/phys/module_bl_shinhong.F.html#MIXLEN'>mixlen</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MIXLEN_4">(lmh,uxk,vxk,txk,thxk,qxk(kts),qxk(kte+1)                      &amp;<a name='1548'>
                     ,q2xk,zqk,ust(i),corf(i),epshol(i)                        &amp;<a name='1549'>
                     ,s2,gh,rig,el                                             &amp;<a name='1550'>
                     ,hpbl(i),kpbl(i),lmxl,ct(i)                               &amp;<a name='1551'>
                     ,hgamu(i),hgamv(i),hgamq(i),pblflg(i)                     &amp;<a name='1552'>
                     ,mfk,ufxpblk,vfxpblk,qfxpblk                              &amp;<a name='1553'>
                     ,ep1,karman,cp                                            &amp;<a name='1554'>
                     ,ids,ide,jds,jde,kds,kde                                  &amp;<a name='1555'>
                     ,ims,ime,jms,jme,kms,kme                                  &amp;<a name='1556'>
                     ,its,ite,jts,jte,kts,kte   )<a name='1557'>
<font color=#447700>!<a name='1558'></font>
<font color=#447700>!---- solve for the production/dissipation of the turbulent kinetic energy<a name='1559'></font>
<font color=#447700>!<a name='1560'></font>
     call <A href='../../html_code/phys/module_bl_shinhong.F.html#PRODQ2'>prodq2</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PRODQ2_4">(lmh,dt,ust(i),s2,rig,q2xk,el,zqk,akmk,akhk                    &amp;<a name='1561'>
                     ,uxk,vxk,thxk,thvxk                                       &amp;<a name='1562'>
                     ,hgamu(i),hgamv(i),hgamq(i),delxy                         &amp;<a name='1563'>
                     ,hpbl(i),pblflg(i),kpbl(i)                                &amp;<a name='1564'>
                     ,mfk,ufxpblk,vfxpblk,qfxpblk                              &amp;<a name='1565'>
                     ,ep1                                                      &amp;<a name='1566'>
                     ,ids,ide,jds,jde,kds,kde                                  &amp;<a name='1567'>
                     ,ims,ime,jms,jme,kms,kme                                  &amp;<a name='1568'>
                     ,its,ite,jts,jte,kts,kte   )<a name='1569'>
<font color=#447700>!<a name='1570'></font>
<font color=#447700>!<a name='1571'></font>
<font color=#447700>!---- carry out the vertical diffusion of turbulent kinetic energy<a name='1572'></font>
<font color=#447700>!<a name='1573'></font>
     call <A href='../../html_code/phys/module_bl_shinhong.F.html#VDIFQ'>vdifq</A><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONG2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VDIFQ_4">(lmh,dt,q2xk,el,zqk                                             &amp;<a name='1574'>
                    ,akhk,ptke1                                                &amp;<a name='1575'>
                    ,hgame,hpbl(i),pblflg(i),kpbl(i)                           &amp;<a name='1576'>
                    ,efxpbl(i)                                                 &amp;<a name='1577'>
                    ,ids,ide,jds,jde,kds,kde                                   &amp;<a name='1578'>
                    ,ims,ime,jms,jme,kms,kme                                   &amp;<a name='1579'>
                    ,its,ite,jts,jte,kts,kte   )<a name='1580'>
<font color=#447700>!<a name='1581'></font>
<font color=#447700>!---- save the new tke and mixing length.<a name='1582'></font>
<font color=#447700>!<a name='1583'></font>
     do k = kts,kte<a name='1584'>
       q2x(i,k) = amax1(q2xk(k),epsq2l)<a name='1585'>
       tke(i,k) = 0.5*q2x(i,k)<a name='1586'>
       if(k/=kts) el_pbl(i,k) = el(k) <font color=#447700>! el is not defined at kte<a name='1587'></font>
     enddo<a name='1588'>
<font color=#447700>!<a name='1589'></font>
   enddo tke_calculation<a name='1590'>
   endif<a name='1591'>
<font color=#447700>!<a name='1592'></font>
<font color=#447700>!---- end of tke calculation<a name='1593'></font>
<font color=#447700>!<a name='1594'></font>
<font color=#447700>!<a name='1595'></font>
<font color=#447700>!---- end of vertical diffusion<a name='1596'></font>
<font color=#447700>!<a name='1597'></font>
   end subroutine shinhong2d<a name='1598'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1599'></font>
<font color=#447700>!<a name='1600'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1601'></font>
<A NAME='TRIDI1N'><A href='../../html_code/phys/module_bl_shinhong.F.html#TRIDI1N' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1602'>
   <font color=#993300>subroutine </font><font color=#cc0000>tridi1n</font>(cl,cm,cu,r1,r2,au,f1,f2,its,ite,kts,kte,nt) <A href='../../call_to/TRIDI1N.html' TARGET='index'>2</A><a name='1603'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1604'></font>
   implicit none<a name='1605'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1606'></font>
<font color=#447700>!<a name='1607'></font>
   integer, intent(in )      ::     its,ite, kts,kte, nt<a name='1608'>
<font color=#447700>!<a name='1609'></font>
   real, dimension( its:ite, kts+1:kte+1 )                                   , &amp;<a name='1610'>
         intent(in   )  ::                                                 cl<a name='1611'>
<font color=#447700>!<a name='1612'></font>
   real, dimension( its:ite, kts:kte )                                       , &amp;<a name='1613'>
         intent(in   )  ::                                                 cm, &amp;<a name='1614'>
                                                                           r1<a name='1615'>
   real, dimension( its:ite, kts:kte,nt )                                    , &amp;<a name='1616'>
         intent(in   )  ::                                                 r2<a name='1617'>
<font color=#447700>!<a name='1618'></font>
   real, dimension( its:ite, kts:kte )                                       , &amp;<a name='1619'>
         intent(inout)  ::                                                 au, &amp;<a name='1620'>
                                                                           cu, &amp;<a name='1621'>
                                                                           f1<a name='1622'>
   real, dimension( its:ite, kts:kte,nt )                                    , &amp;<a name='1623'>
         intent(inout)  ::                                                 f2<a name='1624'>
<font color=#447700>!<a name='1625'></font>
   real    :: fk<a name='1626'>
   integer :: i,k,l,n,it<a name='1627'>
<font color=#447700>!<a name='1628'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1629'></font>
<font color=#447700>!<a name='1630'></font>
   l = ite<a name='1631'>
   n = kte<a name='1632'>
<font color=#447700>!<a name='1633'></font>
   do i = its,l<a name='1634'>
     fk = 1./cm(i,1)<a name='1635'>
     au(i,1) = fk*cu(i,1)<a name='1636'>
     f1(i,1) = fk*r1(i,1)<a name='1637'>
   enddo<a name='1638'>
<font color=#447700>!<a name='1639'></font>
   do it = 1,nt<a name='1640'>
     do i = its,l<a name='1641'>
       fk = 1./cm(i,1)<a name='1642'>
       f2(i,1,it) = fk*r2(i,1,it)<a name='1643'>
     enddo<a name='1644'>
   enddo<a name='1645'>
<font color=#447700>!<a name='1646'></font>
   do k = kts+1,n-1<a name='1647'>
     do i = its,l<a name='1648'>
       fk = 1./(cm(i,k)-cl(i,k)*au(i,k-1))<a name='1649'>
       au(i,k) = fk*cu(i,k)<a name='1650'>
       f1(i,k) = fk*(r1(i,k)-cl(i,k)*f1(i,k-1))<a name='1651'>
     enddo<a name='1652'>
   enddo<a name='1653'>
<font color=#447700>!<a name='1654'></font>
   do it = 1,nt<a name='1655'>
     do k = kts+1,n-1<a name='1656'>
       do i = its,l<a name='1657'>
         fk = 1./(cm(i,k)-cl(i,k)*au(i,k-1))<a name='1658'>
         f2(i,k,it) = fk*(r2(i,k,it)-cl(i,k)*f2(i,k-1,it))<a name='1659'>
       enddo<a name='1660'>
     enddo<a name='1661'>
   enddo<a name='1662'>
<font color=#447700>!<a name='1663'></font>
   do i = its,l<a name='1664'>
     fk = 1./(cm(i,n)-cl(i,n)*au(i,n-1))<a name='1665'>
     f1(i,n) = fk*(r1(i,n)-cl(i,n)*f1(i,n-1))<a name='1666'>
   enddo<a name='1667'>
<font color=#447700>!<a name='1668'></font>
   do it = 1,nt<a name='1669'>
     do i = its,l<a name='1670'>
       fk = 1./(cm(i,n)-cl(i,n)*au(i,n-1))<a name='1671'>
       f2(i,n,it) = fk*(r2(i,n,it)-cl(i,n)*f2(i,n-1,it))<a name='1672'>
     enddo<a name='1673'>
   enddo<a name='1674'>
<font color=#447700>!<a name='1675'></font>
   do k = n-1,kts,-1<a name='1676'>
     do i = its,l<a name='1677'>
       f1(i,k) = f1(i,k)-au(i,k)*f1(i,k+1)<a name='1678'>
     enddo<a name='1679'>
   enddo<a name='1680'>
<font color=#447700>!<a name='1681'></font>
   do it = 1,nt<a name='1682'>
     do k = n-1,kts,-1<a name='1683'>
       do i = its,l<a name='1684'>
         f2(i,k,it) = f2(i,k,it)-au(i,k)*f2(i,k+1,it)<a name='1685'>
       enddo<a name='1686'>
     enddo<a name='1687'>
   enddo<a name='1688'>
<font color=#447700>!<a name='1689'></font>
   end subroutine tridi1n<a name='1690'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1691'></font>
<font color=#447700>!<a name='1692'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1693'></font>
<A NAME='TRIDIN_YSU'><A href='../../html_code/phys/module_bl_shinhong.F.html#TRIDIN_YSU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1694'>
   <font color=#993300>subroutine </font><font color=#cc0000>tridin_ysu</font>(cl,cm,cu,r2,au,f2,its,ite,kts,kte,nt) <A href='../../call_to/TRIDIN_YSU.html' TARGET='index'>4</A><a name='1695'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1696'></font>
   implicit none<a name='1697'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1698'></font>
<font color=#447700>!<a name='1699'></font>
   integer, intent(in )      ::     its,ite, kts,kte, nt<a name='1700'>
<font color=#447700>!<a name='1701'></font>
   real, dimension( its:ite, kts+1:kte+1 )                                   , &amp;<a name='1702'>
         intent(in   )  ::                                                 cl<a name='1703'>
<font color=#447700>!<a name='1704'></font>
   real, dimension( its:ite, kts:kte )                                       , &amp;<a name='1705'>
         intent(in   )  ::                                                 cm<a name='1706'>
   real, dimension( its:ite, kts:kte,nt )                                    , &amp;<a name='1707'>
         intent(in   )  ::                                                 r2<a name='1708'>
<font color=#447700>!<a name='1709'></font>
   real, dimension( its:ite, kts:kte )                                       , &amp;<a name='1710'>
         intent(inout)  ::                                                 au, &amp;<a name='1711'>
                                                                           cu<a name='1712'>
   real, dimension( its:ite, kts:kte,nt )                                    , &amp;<a name='1713'>
         intent(inout)  ::                                                 f2<a name='1714'>
<font color=#447700>!<a name='1715'></font>
   real    :: fk<a name='1716'>
   integer :: i,k,l,n,it<a name='1717'>
<font color=#447700>!<a name='1718'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1719'></font>
<font color=#447700>!<a name='1720'></font>
   l = ite<a name='1721'>
   n = kte<a name='1722'>
<font color=#447700>!<a name='1723'></font>
   do it = 1,nt<a name='1724'>
     do i = its,l<a name='1725'>
       fk = 1./cm(i,1)<a name='1726'>
       au(i,1) = fk*cu(i,1)<a name='1727'>
       f2(i,1,it) = fk*r2(i,1,it)<a name='1728'>
     enddo<a name='1729'>
   enddo<a name='1730'>
<font color=#447700>!<a name='1731'></font>
   do it = 1,nt<a name='1732'>
     do k = kts+1,n-1<a name='1733'>
       do i = its,l<a name='1734'>
         fk = 1./(cm(i,k)-cl(i,k)*au(i,k-1))<a name='1735'>
         au(i,k) = fk*cu(i,k)<a name='1736'>
         f2(i,k,it) = fk*(r2(i,k,it)-cl(i,k)*f2(i,k-1,it))<a name='1737'>
       enddo<a name='1738'>
     enddo<a name='1739'>
   enddo<a name='1740'>
<font color=#447700>!<a name='1741'></font>
   do it = 1,nt<a name='1742'>
     do i = its,l<a name='1743'>
       fk = 1./(cm(i,n)-cl(i,n)*au(i,n-1))<a name='1744'>
       f2(i,n,it) = fk*(r2(i,n,it)-cl(i,n)*f2(i,n-1,it))<a name='1745'>
     enddo<a name='1746'>
   enddo<a name='1747'>
<font color=#447700>!<a name='1748'></font>
   do it = 1,nt<a name='1749'>
     do k = n-1,kts,-1<a name='1750'>
       do i = its,l<a name='1751'>
         f2(i,k,it) = f2(i,k,it)-au(i,k)*f2(i,k+1,it)<a name='1752'>
       enddo<a name='1753'>
     enddo<a name='1754'>
   enddo<a name='1755'>
<font color=#447700>!<a name='1756'></font>
   end subroutine tridin_ysu<a name='1757'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1758'></font>
<font color=#447700>!<a name='1759'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1760'></font>
<A NAME='MIXLEN'><A href='../../html_code/phys/module_bl_shinhong.F.html#MIXLEN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1761'>
   <font color=#993300>subroutine </font><font color=#cc0000>mixlen</font>(lmh,u,v,t,the,q,cwm,q2,z,ustar,corf,epshol,               &amp; <A href='../../call_to/MIXLEN.html' TARGET='index'>4</A><a name='1762'>
                     s2,gh,ri,el,hpbl,lpbl,lmxl,ct,                            &amp;<a name='1763'>
                     hgamu,hgamv,hgamq,pblflg,                                 &amp;<a name='1764'>
                     mf,ufxpbl,vfxpbl,qfxpbl,                                  &amp;<a name='1765'>
                     p608,vkarman,cp,                                          &amp;<a name='1766'>
                     ids,ide,jds,jde,kds,kde,                                  &amp;<a name='1767'>
                     ims,ime,jms,jme,kms,kme,                                  &amp;<a name='1768'>
                     its,ite,jts,jte,kts,kte)<a name='1769'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1770'></font>
   implicit none<a name='1771'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1772'></font>
<font color=#447700>!  qnse model constants<a name='1773'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1774'></font>
   real,parameter :: blckdr=0.0063,cn=0.75<a name='1775'>
   real,parameter :: eps1=1.e-12,epsl=0.32,epsru=1.e-7,epsrs=1.e-7<a name='1776'>
   real,parameter :: el0max=1000.,el0min=1.,elfc=0.23*0.5<a name='1777'>
   real,parameter :: alph=0.30,beta=1./273.,g=9.81,btg=beta*g<a name='1778'>
   real,parameter :: a1=0.659888514560862645,a2x=0.6574209922667784586<a name='1779'>
   real,parameter :: b1=11.87799326209552761,b2=7.226971804046074028<a name='1780'>
   real,parameter :: c1=0.000830955950095854396<a name='1781'>
   real,parameter :: adnh= 9.*a1*a2x*a2x*(12.*a1+3.*b2)*btg*btg<a name='1782'>
   real,parameter :: adnm=18.*a1*a1*a2x*(b2-3.*a2x)*btg<a name='1783'>
   real,parameter :: bdnh= 3.*a2x*(7.*a1+b2)*btg,bdnm= 6.*a1*a1<a name='1784'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1785'></font>
<font color=#447700>!  free term in the equilibrium equation for (l/q)**2<a name='1786'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1787'></font>
   real,parameter :: aeqh=9.*a1*a2x*a2x*b1*btg*btg &amp;<a name='1788'>
                         +9.*a1*a2x*a2x*(12.*a1+3.*b2)*btg*btg<a name='1789'>
   real,parameter :: aeqm=3.*a1*a2x*b1*(3.*a2x+3.*b2*c1+18.*a1*c1-b2) &amp;<a name='1790'>
                         *btg+18.*a1*a1*a2x*(b2-3.*a2x)*btg<a name='1791'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1792'></font>
<font color=#447700>!  forbidden turbulence area<a name='1793'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1794'></font>
   real,parameter :: requ=-aeqh/aeqm<a name='1795'>
   real,parameter :: epsgh=1.e-9,epsgm=requ*epsgh<a name='1796'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1797'></font>
<font color=#447700>!  near isotropy for shear turbulence, ww/q2 lower limit<a name='1798'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1799'></font>
   real,parameter :: ubryl=(18.*requ*a1*a1*a2x*b2*c1*btg &amp;<a name='1800'>
                            +9.*a1*a2x*a2x*b2*btg*btg)   &amp;<a name='1801'>
                           /(requ*adnm+adnh)<a name='1802'>
   real,parameter :: ubry=(1.+epsrs)*ubryl,ubry3=3.*ubry<a name='1803'>
   real,parameter :: aubh=27.*a1*a2x*a2x*b2*btg*btg-adnh*ubry3<a name='1804'>
   real,parameter :: aubm=54.*a1*a1*a2x*b2*c1*btg  -adnm*ubry3<a name='1805'>
   real,parameter :: bubh=(9.*a1*a2x+3.*a2x*b2)*btg-bdnh*ubry3<a name='1806'>
   real,parameter :: bubm=18.*a1*a1*c1             -bdnm*ubry3<a name='1807'>
   real,parameter :: cubr=1.-ubry3,rcubr=1./cubr<a name='1808'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1809'></font>
<font color=#447700>!  k profile constants<a name='1810'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1811'></font>
   real,parameter :: elcbl=0.77<a name='1812'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1813'></font>
<font color=#447700>!<a name='1814'></font>
   integer,  intent(in   )   ::     ids,ide, jds,jde, kds,kde,                 &amp;<a name='1815'>
                                    ims,ime, jms,jme, kms,kme,                 &amp;<a name='1816'>
                                    its,ite, jts,jte, kts,kte<a name='1817'>
   integer,  intent(in   )   ::     lmh,lmxl,lpbl<a name='1818'>
<font color=#447700>!<a name='1819'></font>
   real,     intent(in   )   ::     p608,vkarman,cp<a name='1820'>
   real,     intent(in   )   ::     hpbl,corf,ustar,hgamu,hgamv,hgamq<a name='1821'>
   real,     intent(inout)   ::     ct,epshol<a name='1822'>
<font color=#447700>!<a name='1823'></font>
   real,     dimension( kts:kte )                                            , &amp;<a name='1824'>
             intent(in   )   ::                                           cwm, &amp;<a name='1825'>
                                                                            q, &amp;<a name='1826'>
                                                                           q2, &amp;<a name='1827'>
                                                                            t, &amp;<a name='1828'>
                                                                          the, &amp;<a name='1829'>
                                                                            u, &amp;<a name='1830'>
                                                                            v<a name='1831'>
<font color=#447700>!<a name='1832'></font>
   real,     dimension( kts+1:kte )                                          , &amp;<a name='1833'>
             intent(in   )   ::                                            mf, &amp;<a name='1834'>
                                                                       ufxpbl, &amp;<a name='1835'>
                                                                       vfxpbl, &amp;<a name='1836'>
                                                                       qfxpbl<a name='1837'>
<font color=#447700>!<a name='1838'></font>
   real,     dimension( kts:kte+1 )                                          , &amp;<a name='1839'>
             intent(in   )   ::                                             z<a name='1840'>
<font color=#447700>!<a name='1841'></font>
   real,     dimension( kts+1:kte )                                          , &amp;<a name='1842'>
             intent(out  )   ::                                            el, &amp;<a name='1843'>
                                                                           ri, &amp;<a name='1844'>
                                                                           gh, &amp;<a name='1845'>
                                                                           s2<a name='1846'>
<font color=#447700>!<a name='1847'></font>
   logical,intent(in) :: pblflg<a name='1848'>
<font color=#447700>!<a name='1849'></font>
<font color=#447700>!  local vars<a name='1850'></font>
<font color=#447700>!<a name='1851'></font>
   integer :: k,lpblm<a name='1852'>
   real    :: suk,svk,elocp<a name='1853'>
   real    :: a,aden,b,bden,aubr,bubr,blmx,el0,eloq2x,ghl,s2l,                 &amp;<a name='1854'>
              qol2st,qol2un,qdzl,rdz,sq,srel,szq,tem,thm,vkrmz,rlambda,        &amp;<a name='1855'>
              rlb,rln,f<a name='1856'>
   real    :: ckp<a name='1857'>
   real,     dimension( kts:kte )   ::                                     q1, &amp;<a name='1858'>
                                                                          en2<a name='1859'>
   real,     dimension( kts+1:kte ) ::                                    dth, &amp;<a name='1860'>
                                                                          elm, &amp;<a name='1861'>
                                                                          rel<a name='1862'>
<font color=#447700>!<a name='1863'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1864'></font>
<font color=#447700>!<a name='1865'></font>
   elocp=2.72e6/cp<a name='1866'>
   ct=0.<a name='1867'>
<font color=#447700>!<a name='1868'></font>
   do k = kts,kte<a name='1869'>
     q1(k) = 0.<a name='1870'>
   enddo<a name='1871'>
<font color=#447700>!<a name='1872'></font>
   do k = kts+1,kte<a name='1873'>
     dth(k) = the(k)-the(k-1)<a name='1874'>
   enddo<a name='1875'>
<font color=#447700>!<a name='1876'></font>
   do k = kts+2,kte<a name='1877'>
     if(dth(k)&gt;0..and.dth(k-1)&lt;=0.)then<a name='1878'>
       dth(k)=dth(k)+ct<a name='1879'>
       exit<a name='1880'>
     endif<a name='1881'>
   enddo<a name='1882'>
<font color=#447700>!<a name='1883'></font>
<font color=#447700>!  compute local gradient richardson number<a name='1884'></font>
<font color=#447700>!<a name='1885'></font>
   do k = kte,kts+1,-1<a name='1886'>
     rdz=2./(z(k+1)-z(k-1))<a name='1887'>
     s2l=((u(k)-u(k-1))**2+(v(k)-v(k-1))**2)*rdz*rdz <font color=#447700>! s**2<a name='1888'></font>
     if(pblflg.and.k.le.lpbl)then<a name='1889'>
       suk=(u(k)-u(k-1))*rdz<a name='1890'>
       svk=(v(k)-v(k-1))*rdz<a name='1891'>
       s2l=(suk-hgamu/hpbl-ufxpbl(k))*suk+(svk-hgamv/hpbl-vfxpbl(k))*svk<a name='1892'>
     endif<a name='1893'>
     s2l=max(s2l,epsgm)<a name='1894'>
     s2(k)=s2l<a name='1895'>
<font color=#447700>!<a name='1896'></font>
     tem=(t(k)+t(k-1))*0.5<a name='1897'>
     thm=(the(k)+the(k-1))*0.5<a name='1898'>
     a=thm*p608<a name='1899'>
     b=(elocp/tem-1.-p608)*thm<a name='1900'>
     ghl=(dth(k)*((q(k)+q(k-1)+cwm(k)+cwm(k-1))*(0.5*p608)+1.)                 &amp;<a name='1901'>
        +(q(k)-q(k-1)+cwm(k)-cwm(k-1))*a                                       &amp;<a name='1902'>
        +(cwm(k)-cwm(k-1))*b)*rdz                                  <font color=#447700>! dtheta/dz<a name='1903'></font>
     if(pblflg.and.k.le.lpbl)then<a name='1904'>
       ghl=ghl-mf(k)-(hgamq/hpbl+qfxpbl(k))*a<a name='1905'>
     endif<a name='1906'>
     if(abs(ghl)&lt;=epsgh)ghl=epsgh<a name='1907'>
<font color=#447700>!<a name='1908'></font>
     en2(k)=ghl*g/thm                                   <font color=#447700>! n**2<a name='1909'></font>
     gh(k)=ghl<a name='1910'>
     ri(k)=en2(k)/s2l<a name='1911'>
   enddo<a name='1912'>
<font color=#447700>!<a name='1913'></font>
<font color=#447700>!  find maximum mixing lengths and the level of the pbl top<a name='1914'></font>
<font color=#447700>!<a name='1915'></font>
   do k = kte,kts+1,-1<a name='1916'>
     s2l=s2(k)<a name='1917'>
     ghl=gh(k)<a name='1918'>
     if(ghl&gt;=epsgh)then<a name='1919'>
       if(s2l/ghl&lt;=requ)then<a name='1920'>
         elm(k)=epsl<a name='1921'>
       else<a name='1922'>
         aubr=(aubm*s2l+aubh*ghl)*ghl<a name='1923'>
         bubr= bubm*s2l+bubh*ghl<a name='1924'>
         qol2st=(-0.5*bubr+sqrt(bubr*bubr*0.25-aubr*cubr))*rcubr<a name='1925'>
         eloq2x=1./qol2st<a name='1926'>
         elm(k)=max(sqrt(eloq2x*q2(k)),epsl)<a name='1927'>
       endif<a name='1928'>
     else<a name='1929'>
       aden=(adnm*s2l+adnh*ghl)*ghl<a name='1930'>
       bden= bdnm*s2l+bdnh*ghl<a name='1931'>
       qol2un=-0.5*bden+sqrt(bden*bden*0.25-aden)<a name='1932'>
       eloq2x=1./(qol2un+epsru)       <font color=#447700>! repsr1/qol2un<a name='1933'></font>
       elm(k)=max(sqrt(eloq2x*q2(k)),epsl)<a name='1934'>
     endif<a name='1935'>
   enddo<a name='1936'>
<font color=#447700>!<a name='1937'></font>
   do k = lpbl,lmh,-1<a name='1938'>
     q1(k)=sqrt(q2(k))<a name='1939'>
   enddo<a name='1940'>
<font color=#447700>!<a name='1941'></font>
   szq=0.<a name='1942'>
   sq =0.<a name='1943'>
   do k = kte,kts+1,-1<a name='1944'>
     qdzl=(q1(k)+q1(k-1))*(z(k)-z(k-1))<a name='1945'>
     szq=(z(k)+z(k-1)-z(lmh)-z(lmh))*qdzl+szq<a name='1946'>
     sq=qdzl+sq<a name='1947'>
   enddo<a name='1948'>
<font color=#447700>!<a name='1949'></font>
<font color=#447700>!  computation of asymptotic l in blackadar formula<a name='1950'></font>
<font color=#447700>!<a name='1951'></font>
   el0=min(alph*szq*0.5/sq,el0max)<a name='1952'>
   el0=max(el0            ,el0min)<a name='1953'>
<font color=#447700>!<a name='1954'></font>
<font color=#447700>!  above the pbl top<a name='1955'></font>
<font color=#447700>!<a name='1956'></font>
   lpblm=min(lpbl+1,kte)<a name='1957'>
   do k = kte,lpblm,-1<a name='1958'>
     el(k)=(z(k+1)-z(k-1))*elfc<a name='1959'>
     rel(k)=el(k)/elm(k)<a name='1960'>
   enddo<a name='1961'>
<font color=#447700>!<a name='1962'></font>
<font color=#447700>!  inside the pbl<a name='1963'></font>
<font color=#447700>!<a name='1964'></font>
   epshol=min(epshol,0.0)<a name='1965'>
   ckp=elcbl*((1.0-8.0*epshol)**(1./3.))<a name='1966'>
   if(lpbl&gt;lmh)then<a name='1967'>
     do k = lpbl,lmh+1,-1<a name='1968'>
       vkrmz=(z(k)-z(lmh))*vkarman<a name='1969'>
       if(pblflg) then<a name='1970'>
         vkrmz=ckp*(z(k)-z(lmh))*vkarman<a name='1971'>
         el(k)=vkrmz/(vkrmz/el0+1.)<a name='1972'>
       else<a name='1973'>
         el(k)=vkrmz/(vkrmz/el0+1.)<a name='1974'>
       endif<a name='1975'>
       rel(k)=el(k)/elm(k)<a name='1976'>
     enddo<a name='1977'>
   endif<a name='1978'>
<font color=#447700>!<a name='1979'></font>
   do k = lpbl-1,lmh+2,-1<a name='1980'>
     srel=min(((rel(k-1)+rel(k+1))*0.5+rel(k))*0.5,rel(k))<a name='1981'>
     el(k)=max(srel*elm(k),epsl)<a name='1982'>
   enddo<a name='1983'>
<font color=#447700>!<a name='1984'></font>
<font color=#447700>!  mixing length for the qnse model in stable case<a name='1985'></font>
<font color=#447700>!<a name='1986'></font>
   f=max(corf,eps1)<a name='1987'>
   rlambda=f/(blckdr*ustar)<a name='1988'>
   do k = kte,kts+1,-1<a name='1989'>
     if(en2(k)&gt;=0.0)then <font color=#447700>! stable case<a name='1990'></font>
       vkrmz=(z(k)-z(lmh))*vkarman<a name='1991'>
       rlb=rlambda+1./vkrmz<a name='1992'>
       rln=sqrt(2.*en2(k)/q2(k))/cn<a name='1993'>
       el(k)=1./(rlb+rln)<a name='1994'>
     endif<a name='1995'>
   enddo<a name='1996'>
<font color=#447700>!<a name='1997'></font>
   end subroutine mixlen<a name='1998'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1999'></font>
<font color=#447700>!<a name='2000'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2001'></font>
<A NAME='PRODQ2'><A href='../../html_code/phys/module_bl_shinhong.F.html#PRODQ2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2002'>
   <font color=#993300>subroutine </font><font color=#cc0000>prodq2</font>(lmh,dtturbl,ustar,s2,ri,q2,el,z,akm,akh,                  &amp; <A href='../../call_to/PRODQ2.html' TARGET='index'>4</A><a name='2003'>
                     uxk,vxk,thxk,thvxk,                                       &amp;<a name='2004'>
                     hgamu,hgamv,hgamq,delxy,                                  &amp;<a name='2005'>
                     hpbl,pblflg,kpbl,                                         &amp;<a name='2006'>
                     mf,ufxpbl,vfxpbl,qfxpbl,                                  &amp;<a name='2007'>
                     p608,                                                     &amp;<a name='2008'>
                     ids,ide,jds,jde,kds,kde,                                  &amp;<a name='2009'>
                     ims,ime,jms,jme,kms,kme,                                  &amp;<a name='2010'>
                     its,ite,jts,jte,kts,kte)<a name='2011'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2012'></font>
   implicit none<a name='2013'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2014'></font>
<font color=#447700>!<a name='2015'></font>
   real,parameter :: epsq2l = 0.01,c0 = 0.55,ceps = 16.6,g = 9.81<a name='2016'>
<font color=#447700>!<a name='2017'></font>
   integer,  intent(in   )   ::     ids,ide, jds,jde, kds,kde,                 &amp;<a name='2018'>
                                    ims,ime, jms,jme, kms,kme,                 &amp;<a name='2019'>
                                    its,ite, jts,jte, kts,kte<a name='2020'>
   integer,  intent(in   )   ::     lmh,kpbl<a name='2021'>
<font color=#447700>!<a name='2022'></font>
   real,     intent(in   )   ::     p608,dtturbl,ustar<a name='2023'>
   real,     intent(in   )   ::     hgamu,hgamv,hgamq,delxy,hpbl<a name='2024'>
<font color=#447700>!<a name='2025'></font>
   logical,  intent(in   )   ::     pblflg<a name='2026'>
<font color=#447700>!<a name='2027'></font>
   real,     dimension( kts:kte )                                            , &amp;<a name='2028'>
             intent(in   )   ::                                           uxk, &amp;<a name='2029'>
                                                                          vxk, &amp;<a name='2030'>
                                                                         thxk, &amp;<a name='2031'>
                                                                        thvxk<a name='2032'>
   real,     dimension( kts+1:kte )                                          , &amp;<a name='2033'>
             intent(in   )   ::                                            s2, &amp;<a name='2034'>
                                                                           ri, &amp;<a name='2035'>
                                                                          akm, &amp;<a name='2036'>
                                                                          akh, &amp;<a name='2037'>
                                                                           el, &amp;<a name='2038'>
                                                                           mf, &amp;<a name='2039'>
                                                                       ufxpbl, &amp;<a name='2040'>
                                                                       vfxpbl, &amp;<a name='2041'>
                                                                       qfxpbl<a name='2042'>
<font color=#447700>!<a name='2043'></font>
   real,     dimension( kts:kte+1 )                                          , &amp;<a name='2044'>
             intent(in   )   ::                                             z<a name='2045'>
<font color=#447700>!<a name='2046'></font>
   real,     dimension( kts:kte )                                            , &amp;<a name='2047'>
             intent(inout)   ::                                            q2<a name='2048'>
<font color=#447700>!<a name='2049'></font>
<font color=#447700>!  local vars<a name='2050'></font>
<font color=#447700>!<a name='2051'></font>
   integer :: k<a name='2052'>
<font color=#447700>!<a name='2053'></font>
   real    :: s2l,q2l,deltaz,akml,akhl,en2,pr,bpr,dis,rc02<a name='2054'>
   real    :: suk,svk,gthvk,govrthvk,pru,prv<a name='2055'>
   real    :: thm,disel<a name='2056'>
<font color=#447700>!<a name='2057'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2058'></font>
<font color=#447700>!<a name='2059'></font>
   rc02=2.0/(c0*c0)<a name='2060'>
<font color=#447700>!<a name='2061'></font>
<font color=#447700>!  start of production/dissipation loop<a name='2062'></font>
<font color=#447700>!<a name='2063'></font>
   main_integration: do k = kts+1,kte<a name='2064'>
     deltaz=0.5*(z(k+1)-z(k-1))<a name='2065'>
     s2l=s2(k)<a name='2066'>
     q2l=q2(k)<a name='2067'>
     suk=(uxk(k)-uxk(k-1))/deltaz<a name='2068'>
     svk=(vxk(k)-vxk(k-1))/deltaz<a name='2069'>
     gthvk=(thvxk(k)-thvxk(k-1))/deltaz<a name='2070'>
     govrthvk=g/(0.5*(thvxk(k)+thvxk(k-1)))<a name='2071'>
     akml=akm(k)<a name='2072'>
     akhl=akh(k)<a name='2073'>
     en2=ri(k)*s2l <font color=#447700>!n**2<a name='2074'></font>
     thm=(thxk(k)+thxk(k-1))*0.5<a name='2075'>
<font color=#447700>!<a name='2076'></font>
<font color=#447700>!  turbulence production term<a name='2077'></font>
<font color=#447700>!<a name='2078'></font>
     if(pblflg.and.k.le.kpbl)then<a name='2079'>
       pru=(akml*(suk-hgamu/hpbl-ufxpbl(k)))*suk<a name='2080'>
       prv=(akml*(svk-hgamv/hpbl-vfxpbl(k)))*svk<a name='2081'>
     else<a name='2082'>
       pru=akml*suk*suk<a name='2083'>
       prv=akml*svk*svk<a name='2084'>
     endif<a name='2085'>
     pr=pru+prv<a name='2086'>
<font color=#447700>!<a name='2087'></font>
<font color=#447700>!  buoyancy production<a name='2088'></font>
<font color=#447700>!<a name='2089'></font>
     if(pblflg.and.k.le.kpbl)then<a name='2090'>
       bpr=(akhl*(gthvk-mf(k)-(hgamq/hpbl+qfxpbl(k))*p608*thm))*govrthvk<a name='2091'>
     else<a name='2092'>
       bpr=akhl*gthvk*govrthvk<a name='2093'>
     endif<a name='2094'>
<font color=#447700>!<a name='2095'></font>
<font color=#447700>!  dissipation<a name='2096'></font>
<font color=#447700>!<a name='2097'></font>
     disel=min(delxy,ceps*el(k))<a name='2098'>
     dis=(q2l)**1.5/disel<a name='2099'>
<font color=#447700>!<a name='2100'></font>
     q2l=q2l+2.0*(pr-bpr-dis)*dtturbl<a name='2101'>
     q2(k)=amax1(q2l,epsq2l)<a name='2102'>
<font color=#447700>!<a name='2103'></font>
<font color=#447700>!  end of production/dissipation loop<a name='2104'></font>
<font color=#447700>!<a name='2105'></font>
   enddo main_integration<a name='2106'>
<font color=#447700>!<a name='2107'></font>
<font color=#447700>!  lower boundary condition for q2<a name='2108'></font>
<font color=#447700>!<a name='2109'></font>
   q2(kts)=amax1(rc02*ustar*ustar,epsq2l)<a name='2110'>
<font color=#447700>!<a name='2111'></font>
   end subroutine prodq2<a name='2112'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2113'></font>
<font color=#447700>!<a name='2114'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2115'></font>
<A NAME='VDIFQ'><A href='../../html_code/phys/module_bl_shinhong.F.html#VDIFQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2116'>
   <font color=#993300>subroutine </font><font color=#cc0000>vdifq</font>(lmh,dtdif,q2,el,z,                                         &amp; <A href='../../call_to/VDIFQ.html' TARGET='index'>4</A><a name='2117'>
                    akhk,ptke1,                                                &amp;<a name='2118'>
                    hgame,hpbl,pblflg,kpbl,                                    &amp;<a name='2119'>
                    efxpbl,                                                    &amp;<a name='2120'>
                    ids,ide,jds,jde,kds,kde,                                   &amp;<a name='2121'>
                    ims,ime,jms,jme,kms,kme,                                   &amp;<a name='2122'>
                    its,ite,jts,jte,kts,kte)<a name='2123'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2124'></font>
   implicit none<a name='2125'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2126'></font>
<font color=#447700>!<a name='2127'></font>
   real,parameter     :: c_k=1.0,esq=5.0<a name='2128'>
<font color=#447700>!<a name='2129'></font>
   integer,  intent(in   )   ::     ids,ide, jds,jde, kds,kde,                 &amp;<a name='2130'>
                                    ims,ime, jms,jme, kms,kme,                 &amp;<a name='2131'>
                                    its,ite, jts,jte, kts,kte<a name='2132'>
   integer,  intent(in   )   ::     lmh,kpbl<a name='2133'>
<font color=#447700>!<a name='2134'></font>
   real,     intent(in   )   ::     dtdif,hpbl,efxpbl<a name='2135'>
<font color=#447700>!<a name='2136'></font>
   logical,  intent(in   )   ::     pblflg<a name='2137'>
<font color=#447700>!<a name='2138'></font>
   real,     dimension( kts:kte )                                            , &amp;<a name='2139'>
             intent(in   )   ::                                         hgame, &amp;<a name='2140'>
                                                                        ptke1<a name='2141'>
   real,     dimension( kts+1:kte )                                          , &amp;<a name='2142'>
             intent(in   )   ::                                            el, &amp;<a name='2143'>
                                                                         akhk<a name='2144'>
   real,     dimension( kts:kte+1 )                                          , &amp;<a name='2145'>
             intent(in   )   ::                                             z<a name='2146'>
<font color=#447700>!<a name='2147'></font>
   real,     dimension( kts:kte )                                            , &amp;<a name='2148'>
             intent(inout)   ::                                            q2<a name='2149'>
<font color=#447700>!<a name='2150'></font>
<font color=#447700>!  local vars<a name='2151'></font>
<font color=#447700>!<a name='2152'></font>
   integer :: k<a name='2153'>
<font color=#447700>!<a name='2154'></font>
   real    :: aden,akqs,bden,besh,besm,cden,cf,dtozs,ell,eloq2,eloq4<a name='2155'>
   real    :: elqdz,esh,esm,esqhf,ghl,gml,q1l,rden,rdz<a name='2156'>
   real    :: zak<a name='2157'>
<font color=#447700>!<a name='2158'></font>
   real,     dimension( kts+1:kte ) ::                               zfacentk<a name='2159'>
   real,     dimension( kts+2:kte ) ::                                    akq, &amp;<a name='2160'>
                                                                           cm, &amp;<a name='2161'>
                                                                           cr, &amp;<a name='2162'>
                                                                         dtoz, &amp;<a name='2163'>
                                                                         rsq2<a name='2164'>
<font color=#447700>!<a name='2165'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2166'></font>
<font color=#447700>!<a name='2167'></font>
<font color=#447700>!  vertical turbulent diffusion<a name='2168'></font>
<font color=#447700>!<a name='2169'></font>
   esqhf=0.5*esq<a name='2170'>
   do k = kts+1,kte<a name='2171'>
     zak=0.5*(z(k)+z(k-1)) <font color=#447700>!zak of vdifq = za(k-1) of shinhong2d<a name='2172'></font>
     zfacentk(k)=(zak/hpbl)**3.0<a name='2173'>
   enddo<a name='2174'>
<font color=#447700>!<a name='2175'></font>
   do k = kte,kts+2,-1<a name='2176'>
     dtoz(k)=(dtdif+dtdif)/(z(k+1)-z(k-1))<a name='2177'>
     akq(k)=c_k*(akhk(k)/(z(k+1)-z(k-1))+akhk(k-1)/(z(k)-z(k-2)))<a name='2178'>
     akq(k)=akq(k)*ptke1(k)<a name='2179'>
     cr(k)=-dtoz(k)*akq(k)<a name='2180'>
   enddo<a name='2181'>
<font color=#447700>!<a name='2182'></font>
   akqs=c_k*akhk(kts+1)/(z(kts+2)-z(kts))<a name='2183'>
   akqs=akqs*ptke1(kts+1)<a name='2184'>
   cm(kte)=dtoz(kte)*akq(kte)+1.<a name='2185'>
   rsq2(kte)=q2(kte)<a name='2186'>
<font color=#447700>!<a name='2187'></font>
   do k = kte-1,kts+2,-1<a name='2188'>
     cf=-dtoz(k)*akq(k+1)/cm(k+1)<a name='2189'>
     cm(k)=-cr(k+1)*cf+(akq(k+1)+akq(k))*dtoz(k)+1.<a name='2190'>
     rsq2(k)=-rsq2(k+1)*cf+q2(k)<a name='2191'>
     if(pblflg.and.k.lt.kpbl) then<a name='2192'>
       rsq2(k)=rsq2(k)-dtoz(k)*(2.0*hgame(k)/hpbl)*akq(k+1)*(z(k+1)-z(k))      &amp;<a name='2193'>
                      +dtoz(k)*(2.0*hgame(k-1)/hpbl)*akq(k)*(z(k)-z(k-1))<a name='2194'>
       rsq2(k)=rsq2(k)-dtoz(k)*2.0*efxpbl*zfacentk(k+1)                        &amp;<a name='2195'>
                      +dtoz(k)*2.0*efxpbl*zfacentk(k)<a name='2196'>
     endif<a name='2197'>
   enddo<a name='2198'>
<font color=#447700>!<a name='2199'></font>
   dtozs=(dtdif+dtdif)/(z(kts+2)-z(kts))<a name='2200'>
   cf=-dtozs*akq(lmh+2)/cm(lmh+2)<a name='2201'>
<font color=#447700>!<a name='2202'></font>
   if(pblflg.and.((lmh+1).lt.kpbl)) then<a name='2203'>
     q2(lmh+1)=(dtozs*akqs*q2(lmh)-rsq2(lmh+2)*cf+q2(lmh+1)                    &amp;<a name='2204'>
               -dtozs*(2.0*hgame(lmh+1)/hpbl)*akq(lmh+2)*(z(lmh+2)-z(lmh+1))   &amp;<a name='2205'>
               +dtozs*(2.0*hgame(lmh)/hpbl)*akqs*(z(lmh+1)-z(lmh)))<a name='2206'>
     q2(lmh+1)=q2(lmh+1)-dtozs*2.0*efxpbl*zfacentk(lmh+2)                      &amp;<a name='2207'>
                        +dtozs*2.0*efxpbl*zfacentk(lmh+1)<a name='2208'>
     q2(lmh+1)=q2(lmh+1)/((akq(lmh+2)+akqs)*dtozs-cr(lmh+2)*cf+1.)<a name='2209'>
   else<a name='2210'>
     q2(lmh+1)=(dtozs*akqs*q2(lmh)-rsq2(lmh+2)*cf+q2(lmh+1))                   &amp;<a name='2211'>
              /((akq(lmh+2)+akqs)*dtozs-cr(lmh+2)*cf+1.)<a name='2212'>
   endif<a name='2213'>
<font color=#447700>!<a name='2214'></font>
   do k = lmh+2,kte<a name='2215'>
     q2(k)=(-cr(k)*q2(k-1)+rsq2(k))/cm(k)<a name='2216'>
   enddo<a name='2217'>
<font color=#447700>!<a name='2218'></font>
   end subroutine vdifq<a name='2219'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2220'></font>
<font color=#447700>!<a name='2221'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2222'></font>
<A NAME='SHINHONGINIT'><A href='../../html_code/phys/module_bl_shinhong.F.html#SHINHONGINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2223'>
   <font color=#993300>subroutine </font><font color=#cc0000>shinhonginit</font>(rublten,rvblten,rthblten,rqvblten,                  &amp; <A href='../../call_to/SHINHONGINIT.html' TARGET='index'>1</A><a name='2224'>
                      rqcblten,rqiblten,                                       &amp;<a name='2225'>
                      tke_pbl,                                                 &amp;<a name='2226'>
                      p_qi,p_first_scalar,                                     &amp;<a name='2227'>
                      restart, allowed_to_read,                                &amp;<a name='2228'>
                      ids, ide, jds, jde, kds, kde,                            &amp;<a name='2229'>
                      ims, ime, jms, jme, kms, kme,                            &amp;<a name='2230'>
                      its, ite, jts, jte, kts, kte                 )<a name='2231'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2232'></font>
   implicit none<a name='2233'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2234'></font>
<font color=#447700>!<a name='2235'></font>
   real,parameter                ::  epsq2l = 0.01<a name='2236'>
   logical , intent(in)          ::  restart, allowed_to_read<a name='2237'>
   integer , intent(in)          ::  ids, ide, jds, jde, kds, kde,             &amp;<a name='2238'>
                                     ims, ime, jms, jme, kms, kme,             &amp;<a name='2239'>
                                     its, ite, jts, jte, kts, kte<a name='2240'>
   integer , intent(in)          ::  p_qi,p_first_scalar<a name='2241'>
   real , dimension( ims:ime , kms:kme , jms:jme ), intent(out) ::             &amp;<a name='2242'>
                                                                      rublten, &amp;<a name='2243'>
                                                                      rvblten, &amp;<a name='2244'>
                                                                     rthblten, &amp;<a name='2245'>
                                                                     rqvblten, &amp;<a name='2246'>
                                                                     rqcblten, &amp;<a name='2247'>
                                                                     rqiblten<a name='2248'>
   real , dimension( ims:ime , kms:kme , jms:jme ), intent(out) ::             &amp;<a name='2249'>
                                                                      tke_pbl<a name='2250'>
   integer :: i, j, k, itf, jtf, ktf<a name='2251'>
<font color=#447700>!<a name='2252'></font>
   jtf = min0(jte,jde-1)<a name='2253'>
   ktf = min0(kte,kde-1)<a name='2254'>
   itf = min0(ite,ide-1)<a name='2255'>
<font color=#447700>!<a name='2256'></font>
   if(.not.restart)then<a name='2257'>
     do j = jts,jtf<a name='2258'>
       do k = kts,ktf<a name='2259'>
         do i = its,itf<a name='2260'>
            rublten(i,k,j) = 0.<a name='2261'>
            rvblten(i,k,j) = 0.<a name='2262'>
            rthblten(i,k,j) = 0.<a name='2263'>
            rqvblten(i,k,j) = 0.<a name='2264'>
            rqcblten(i,k,j) = 0.<a name='2265'>
            tke_pbl(i,k,j) = epsq2l/2.<a name='2266'>
         enddo<a name='2267'>
       enddo<a name='2268'>
     enddo<a name='2269'>
   endif<a name='2270'>
<font color=#447700>!<a name='2271'></font>
   if (p_qi .ge. p_first_scalar .and. .not.restart) then<a name='2272'>
     do j = jts,jtf<a name='2273'>
       do k = kts,ktf<a name='2274'>
         do i = its,itf<a name='2275'>
           rqiblten(i,k,j) = 0.<a name='2276'>
         enddo<a name='2277'>
       enddo<a name='2278'>
     enddo<a name='2279'>
   endif<a name='2280'>
<font color=#447700>!<a name='2281'></font>
   end subroutine shinhonginit<a name='2282'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2283'></font>
<font color=#447700>!<a name='2284'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2285'></font>
<A NAME='PU'><A href='../../html_code/phys/module_bl_shinhong.F.html#PU' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2286'>
   <font color=#993300>function </font><font color=#cc0000>pu</font>(d,h) <A href='../../call_to/PU.html' TARGET='index'>7</A><a name='2287'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2288'></font>
   implicit none<a name='2289'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2290'></font>
   real :: pu<a name='2291'>
   real,parameter :: pmin = 0.0,pmax = 1.0<a name='2292'>
   real,parameter :: a1 = 1.0, a2 = 0.070, a3 = 1.0, a4 = 0.142, a5 = 0.071<a name='2293'>
   real,parameter :: b1 = 2.0, b2 = 0.6666667<a name='2294'>
   real :: d,h,doh,num,den<a name='2295'>
<font color=#447700>!<a name='2296'></font>
   doh=d/h<a name='2297'>
   num=a1*(doh)**b1+a2*(doh)**b2<a name='2298'>
   den=a3*(doh)**b1+a4*(doh)**b2+a5<a name='2299'>
   pu=num/den<a name='2300'>
   pu=max(pu,pmin)<a name='2301'>
   pu=min(pu,pmax)<a name='2302'>
<font color=#447700>!<a name='2303'></font>
   return<a name='2304'>
   end function<a name='2305'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2306'></font>
<font color=#447700>!<a name='2307'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2308'></font>
<A NAME='PQ'><A href='../../html_code/phys/module_bl_shinhong.F.html#PQ' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2309'>
   <font color=#993300>function </font><font color=#cc0000>pq</font>(d,h) <A href='../../call_to/PQ.html' TARGET='index'>17</A><a name='2310'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2311'></font>
   implicit none<a name='2312'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2313'></font>
   real :: pq<a name='2314'>
   real,parameter :: pmin = 0.0,pmax = 1.0<a name='2315'>
   real,parameter :: a1 = 1.0, a2 = -0.098, a3 = 1.0, a4 = 0.106, a5 = 0.5<a name='2316'>
   real,parameter :: b1 = 2.0<a name='2317'>
   real :: d,h,doh,num,den<a name='2318'>
<font color=#447700>!<a name='2319'></font>
   doh=d/h<a name='2320'>
   num=a1*(doh)**b1+a2<a name='2321'>
   den=a3*(doh)**b1+a4<a name='2322'>
   pq=a5*num/den+(1.-a5)<a name='2323'>
   pq=max(pq,pmin)<a name='2324'>
   pq=min(pq,pmax)<a name='2325'>
<font color=#447700>!<a name='2326'></font>
   return<a name='2327'>
   end function<a name='2328'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2329'></font>
<font color=#447700>!<a name='2330'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2331'></font>
<A NAME='PTHNL'><A href='../../html_code/phys/module_bl_shinhong.F.html#PTHNL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2332'>
   <font color=#993300>function </font><font color=#cc0000>pthnl</font>(d,h) <A href='../../call_to/PTHNL.html' TARGET='index'>1</A><a name='2333'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2334'></font>
   implicit none<a name='2335'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2336'></font>
   real :: pthnl<a name='2337'>
   real,parameter :: pmin = 0.0,pmax = 1.0<a name='2338'>
   real,parameter :: a1 = 1.000, a2 = 0.936, a3 = -1.110,                      &amp;<a name='2339'>
                     a4 = 1.000, a5 = 0.312, a6 = 0.329, a7 = 0.243<a name='2340'>
   real,parameter :: b1 = 2.0, b2 = 0.875<a name='2341'>
   real :: d,h,doh,num,den<a name='2342'>
<font color=#447700>!<a name='2343'></font>
   doh=d/h<a name='2344'>
   num=a1*(doh)**b1+a2*(doh)**b2+a3<a name='2345'>
   den=a4*(doh)**b1+a5*(doh)**b2+a6<a name='2346'>
   pthnl=a7*num/den+(1.-a7)<a name='2347'>
   pthnl=max(pthnl,pmin)<a name='2348'>
   pthnl=min(pthnl,pmax)<a name='2349'>
<font color=#447700>!<a name='2350'></font>
   return<a name='2351'>
   end function<a name='2352'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2353'></font>
<font color=#447700>!<a name='2354'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2355'></font>
<A NAME='PTHL'><A href='../../html_code/phys/module_bl_shinhong.F.html#PTHL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2356'>
   <font color=#993300>function </font><font color=#cc0000>pthl</font>(d,h) <A href='../../call_to/PTHL.html' TARGET='index'>7</A><a name='2357'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2358'></font>
   implicit none<a name='2359'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2360'></font>
   real :: pthl<a name='2361'>
   real,parameter :: pmin = 0.0,pmax = 1.0<a name='2362'>
   real,parameter :: a1 = 1.000, a2 = 0.870, a3 = -0.913,                      &amp;<a name='2363'>
                     a4 = 1.000, a5 = 0.153, a6 = 0.278, a7 = 0.280<a name='2364'>
   real,parameter :: b1 = 2.0, b2 = 0.5<a name='2365'>
   real :: d,h,doh,num,den<a name='2366'>
<font color=#447700>!<a name='2367'></font>
   doh=d/h<a name='2368'>
   num=a1*(doh)**b1+a2*(doh)**b2+a3<a name='2369'>
   den=a4*(doh)**b1+a5*(doh)**b2+a6<a name='2370'>
   pthl=a7*num/den+(1.-a7)<a name='2371'>
   pthl=max(pthl,pmin)<a name='2372'>
   pthl=min(pthl,pmax)<a name='2373'>
<font color=#447700>!<a name='2374'></font>
   return<a name='2375'>
   end function<a name='2376'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2377'></font>
<font color=#447700>!<a name='2378'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2379'></font>
<A NAME='PTKE'><A href='../../html_code/phys/module_bl_shinhong.F.html#PTKE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2380'>
   <font color=#993300>function </font><font color=#cc0000>ptke</font>(d,h) <A href='../../call_to/PTKE.html' TARGET='index'>1</A><a name='2381'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2382'></font>
   implicit none<a name='2383'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2384'></font>
   real :: ptke<a name='2385'>
   real,parameter :: pmin = 0.0,pmax = 1.0<a name='2386'>
   real,parameter :: a1 = 1.000, a2 = 0.070,                                   &amp;<a name='2387'>
                     a3 = 1.000, a4 = 0.142, a5 = 0.071<a name='2388'>
   real,parameter :: b1 = 2.0, b2 = 0.6666667<a name='2389'>
   real :: d,h,doh,num,den<a name='2390'>
<font color=#447700>!<a name='2391'></font>
   doh=d/h<a name='2392'>
   num=a1*(doh)**b1+a2*(doh)**b2<a name='2393'>
   den=a3*(doh)**b1+a4*(doh)**b2+a5<a name='2394'>
   ptke=num/den<a name='2395'>
   ptke=max(ptke,pmin)<a name='2396'>
   ptke=min(ptke,pmax)<a name='2397'>
<font color=#447700>!<a name='2398'></font>
   return<a name='2399'>
   end function<a name='2400'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2401'></font>
<font color=#447700>!<a name='2402'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2403'></font>
end module module_bl_shinhong<a name='2404'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2405'></font>
</pre></body></html>