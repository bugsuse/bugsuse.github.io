<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#define MYNN_DBG_LVL 3000<a name='2'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<A NAME='MODULE_SF_MYNN'><A href='../../html_code/phys/module_sf_mynn.F.html#MODULE_SF_MYNN' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_mynn</font> <A href='../../call_to/MODULE_SF_MYNN.html' TARGET='index'>3</A><a name='6'>
<a name='7'>
<font color=#447700>!-------------------------------------------------------------------<a name='8'></font>
<font color=#447700>!Modifications implemented by Joseph Olson NOAA/GSD/AMB - CU/CIRES<a name='9'></font>
<font color=#447700>!for WRFv3.4, v3.4.1, v3.5.1, v3.6, v3.7.1, and v3.9:<a name='10'></font>
<font color=#447700>!<a name='11'></font>
<font color=#447700>!   BOTH LAND AND WATER:<a name='12'></font>
<font color=#447700>!1) Calculation of stability parameter (z/L) taken from Li et al. (2010 BLM)<a name='13'></font>
<font color=#447700>!   for first iteration of first time step; afterwards, exact calculation.<a name='14'></font>
<font color=#447700>!2) Fixed isflux=0 option to turn off scalar fluxes, but keep momentum<a name='15'></font>
<font color=#447700>!   fluxes for idealized studies (credit: Anna Fitch).<a name='16'></font>
<font color=#447700>!3) Kinematic viscosity now varies with temperature<a name='17'></font>
<font color=#447700>!4) Uses Monin-Obukhov flux-profile relationships more consistent with<a name='18'></font>
<font color=#447700>!   those used in the MYNN PBL code.<a name='19'></font>
<font color=#447700>!5) Allows negative QFX, similar to MYJ scheme<a name='20'></font>
<font color=#447700>!<a name='21'></font>
<font color=#447700>!   LAND only:<a name='22'></font>
<font color=#447700>!1) iz0tlnd option is now available with the following options:<a name='23'></font>
<font color=#447700>!   (default) =0: Zilitinkevich (1995) <a name='24'></font>
<font color=#447700>!             =1: Czil_new (modified according to Chen &amp; Zhang 2008)<a name='25'></font>
<font color=#447700>!             =2: Modified Yang et al (2002, 2008) - generalized for all landuse<a name='26'></font>
<font color=#447700>!             =3: constant zt = z0/7.4 (original form; Garratt 1992)<a name='27'></font>
<font color=#447700>!             =4: Pan et al. (1994) with RUC mods for z_q, zili for z_t<a name='28'></font>
<font color=#447700>!2) Relaxed u* minimum from 0.1 to 0.01<a name='29'></font>
<font color=#447700>!<a name='30'></font>
<font color=#447700>!   WATER only:<a name='31'></font>
<font color=#447700>!1) isftcflx option is now available with the following options:<a name='32'></font>
<font color=#447700>!   (default) =0: z0, zt, and zq from the COARE algorithm. Set COARE_OPT (below) to<a name='33'></font>
<font color=#447700>!                 3.0 (Fairall et al. 2003)<a name='34'></font>
<font color=#447700>!                 3.5 (Edson et al 2013; default) <a name='35'></font>
<font color=#447700>!             =1: z0 from Davis et al (2008), zt &amp; zq from COARE 3.0/3.5<a name='36'></font>
<font color=#447700>!             =2: z0 from Davis et al (2008), zt &amp; zq from Garratt (1992)<a name='37'></font>
<font color=#447700>!             =3: z0 from Taylor and Yelland (2004), zt and zq from COARE 3.0/3.5<a name='38'></font>
<font color=#447700>!             =4: z0 from Zilitinkevich (2001), zt &amp; zq from COARE 3.0/3.5<a name='39'></font>
<font color=#447700>!<a name='40'></font>
<font color=#447700>!   SNOW/ICE only:<a name='41'></font>
<font color=#447700>!1) Added Andreas (2002) snow/ice parameterization for thermal and<a name='42'></font>
<font color=#447700>!   moisture roughness to help reduce the cool/moist bias in the arctic<a name='43'></font>
<font color=#447700>!   region. Also added a z0 mod for snow (Andreas et al. 2005, BLM), which<a name='44'></font>
<font color=#447700>!<a name='45'></font>
<font color=#447700>! Misc:<a name='46'></font>
<font color=#447700>!   2) added a more elaborate diagnostic for u10 &amp; V10 for high vertical resolution<a name='47'></font>
<font color=#447700>!      model configurations.<a name='48'></font>
<font color=#447700>!<a name='49'></font>
<font color=#447700>! New for v3.9:<a name='50'></font>
<font color=#447700>!   - option for stochastic parameter perturbations (SPP) <a name='51'></font>
<font color=#447700>!<a name='52'></font>
<font color=#447700>!NOTE: This code was primarily tested in combination with the RUC LSM.<a name='53'></font>
<font color=#447700>!      Performance with the Noah (or other) LSM is relatively unknown.<a name='54'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='55'></font>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_sf_mynn.F.html#module_sf_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_94">, only: &amp;<a name='56'>
       &amp;p1000mb, cp, xlv, ep_2<a name='57'>
<a name='58'>
  USE <A href='../../html_code/phys/module_sf_sfclay.F.html#MODULE_SF_SFCLAY'>module_sf_sfclay</A><A href='../../html_code/phys/module_sf_mynn.F.html#module_sf_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SFCLAY_2">, ONLY: sfclayinit<a name='59'>
  USE <A href='../../html_code/phys/module_bl_mynn.F.html#MODULE_BL_MYNN'>module_bl_mynn</A><A href='../../html_code/phys/module_sf_mynn.F.html#module_sf_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BL_MYNN_5">,   only: tv0, mym_condensation<a name='60'>
  USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_sf_mynn.F.html#module_sf_mynn.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_87"><a name='61'>
<font color=#447700>!-------------------------------------------------------------------<a name='62'></font>
  IMPLICIT NONE<a name='63'>
<font color=#447700>!-------------------------------------------------------------------<a name='64'></font>
<a name='65'>
  REAL, PARAMETER :: xlvcp=xlv/cp, ep_3=1.-ep_2<a name='66'>
 <a name='67'>
  REAL, PARAMETER :: wmin=0.1    <font color=#447700>! Minimum wind speed<a name='68'></font>
  REAL, PARAMETER :: VCONVC=1.0<a name='69'>
  REAL, PARAMETER :: SNOWZ0=0.011<a name='70'>
  REAL, PARAMETER :: COARE_OPT=3.5  <font color=#447700>! 3.0 or 3.5<a name='71'></font>
<a name='72'>
  REAL, DIMENSION(0:1000 ),SAVE          :: PSIMTB,PSIHTB<a name='73'>
<a name='74'>
CONTAINS<a name='75'>
<a name='76'>
<font color=#447700>!-------------------------------------------------------------------<a name='77'></font>
<A NAME='MYNN_SF_INIT_DRIVER'><A href='../../html_code/phys/module_sf_mynn.F.html#MYNN_SF_INIT_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='78'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>mynn_sf_init_driver</font>(allowed_to_read) <A href='../../call_to/MYNN_SF_INIT_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/MYNN_SF_INIT_DRIVER.html' TARGET='index'>1</A><a name='79'>
<a name='80'>
    LOGICAL, INTENT(in) :: allowed_to_read<a name='81'>
<a name='82'>
    <font color=#447700>!Fill the PSIM and PSIH tables. The subroutine "sfclayinit" <a name='83'></font>
    <font color=#447700>!can be found in module_sf_sfclay.F. This subroutine returns<a name='84'></font>
    <font color=#447700>!the forms from Dyer and Hicks (1974).<a name='85'></font>
       <a name='86'>
    CALL <A href='../../html_code/phys/module_sf_sfclay.F.html#SFCLAYINIT'>sfclayinit</A><A href='../../html_code/phys/module_sf_mynn.F.html#MYNN_SF_INIT_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAYINIT_2">(allowed_to_read)<a name='87'>
<a name='88'>
  END SUBROUTINE mynn_sf_init_driver<a name='89'>
<a name='90'>
<font color=#447700>!-------------------------------------------------------------------<a name='91'></font>
<A NAME='SFCLAY_MYNN'><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY_MYNN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='92'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCLAY_mynn</font>(                                         &amp; <A href='../../call_to/SFCLAY_MYNN.html' TARGET='index'>3</A>,<A href='../../call_from/SFCLAY_MYNN.html' TARGET='index'>2</A><a name='93'>
                     U3D,V3D,T3D,QV3D,P3D,dz8w,                    &amp;<a name='94'>
                     CP,G,ROVCP,R,XLV,PSFCPA,CHS,CHS2,CQS2,CPM,    &amp;<a name='95'>
                     ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='96'>
                     XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='97'>
                     U10,V10,TH2,T2,Q2,SNOWH,                      &amp;<a name='98'>
                     GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='99'>
                     SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='100'>
                     KARMAN,itimestep,ch,th3d,pi3d,qc3d,rho3d,     &amp;<a name='101'>
                     tsq,qsq,cov,sh3d,el_pbl,qcg,                  &amp;<a name='102'>
                     icloud_bl,qc_bl,cldfra_bl,                    &amp;<a name='103'>
                     spp_pbl,pattern_spp_pbl,                      &amp;<a name='104'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='105'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='106'>
                     its,ite, jts,jte, kts,kte,                    &amp;<a name='107'>
                     ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,          &amp;<a name='108'>
                     bl_mynn_cloudpdf)<a name='109'>
<font color=#447700>!-------------------------------------------------------------------<a name='110'></font>
      IMPLICIT NONE<a name='111'>
<font color=#447700>!-------------------------------------------------------------------<a name='112'></font>
<font color=#447700>!-- U3D         3D u-velocity interpolated to theta points (m/s)<a name='113'></font>
<font color=#447700>!-- V3D         3D v-velocity interpolated to theta points (m/s)<a name='114'></font>
<font color=#447700>!-- T3D         3D temperature (K)<a name='115'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='116'></font>
<font color=#447700>!-- P3D         3D pressure (Pa)<a name='117'></font>
<font color=#447700>!-- RHO3D       3D density (kg/m3) <a name='118'></font>
<font color=#447700>!-- dz8w        3D dz between full levels (m)<a name='119'></font>
<font color=#447700>!-- CP          heat capacity at constant pressure for dry air (J/kg/K)<a name='120'></font>
<font color=#447700>!-- G           acceleration due to gravity (m/s^2)<a name='121'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='122'></font>
<font color=#447700>!-- R           gas constant for dry air (J/kg/K)<a name='123'></font>
<font color=#447700>!-- XLV         latent heat of vaporization for water (J/kg)<a name='124'></font>
<font color=#447700>!-- PSFCPA      surface pressure (Pa)<a name='125'></font>
<font color=#447700>!-- ZNT         roughness length (m)<a name='126'></font>
<font color=#447700>!-- UST         u* in similarity theory (m/s)<a name='127'></font>
<font color=#447700>!-- USTM        u* in similarity theory (m/s) w* added to WSPD. This is<a name='128'></font>
<font color=#447700>!               used to couple with TKE scheme but not in MYNN.<a name='129'></font>
<font color=#447700>!               (as of now, USTM = UST in this version)<a name='130'></font>
<font color=#447700>!-- PBLH        PBL height from previous time (m)<a name='131'></font>
<font color=#447700>!-- MAVAIL      surface moisture availability (between 0 and 1)<a name='132'></font>
<font color=#447700>!-- ZOL         z/L height over Monin-Obukhov length<a name='133'></font>
<font color=#447700>!-- MOL         T* (similarity theory) (K)<a name='134'></font>
<font color=#447700>!-- RMOL        Reciprocal of M-O length (/m)<a name='135'></font>
<font color=#447700>!-- REGIME      flag indicating PBL regime (stable, unstable, etc.)<a name='136'></font>
<font color=#447700>!-- PSIM        similarity stability function for momentum<a name='137'></font>
<font color=#447700>!-- PSIH        similarity stability function for heat<a name='138'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='139'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='140'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='141'></font>
<font color=#447700>!-- LH          net upward latent heat flux at surface (W/m^2)<a name='142'></font>
<font color=#447700>!-- TSK         surface temperature (K)<a name='143'></font>
<font color=#447700>!-- FLHC        exchange coefficient for heat (W/m^2/K)<a name='144'></font>
<font color=#447700>!-- FLQC        exchange coefficient for moisture (kg/m^2/s)<a name='145'></font>
<font color=#447700>!-- CHS         heat/moisture exchange coefficient for LSM (m/s)<a name='146'></font>
<font color=#447700>!-- QGH         lowest-level saturated mixing ratio<a name='147'></font>
<font color=#447700>!-- QSFC        qv (specific humidity) at the surface<a name='148'></font>
<font color=#447700>!-- QSFCMR      qv (mixing ratio) at the surface<a name='149'></font>
<font color=#447700>!-- U10         diagnostic 10m u wind<a name='150'></font>
<font color=#447700>!-- V10         diagnostic 10m v wind<a name='151'></font>
<font color=#447700>!-- TH2         diagnostic 2m theta (K)<a name='152'></font>
<font color=#447700>!-- T2          diagnostic 2m temperature (K)<a name='153'></font>
<font color=#447700>!-- Q2          diagnostic 2m mixing ratio (kg/kg)<a name='154'></font>
<font color=#447700>!-- SNOWH       Snow height (m)<a name='155'></font>
<font color=#447700>!-- GZ1OZ0      log((z1+ZNT)/ZNT) where ZNT is roughness length <a name='156'></font>
<font color=#447700>!-- WSPD        wind speed at lowest model level (m/s)<a name='157'></font>
<font color=#447700>!-- BR          bulk Richardson number in surface layer<a name='158'></font>
<font color=#447700>!-- ISFFLX      isfflx=1 for surface heat and moisture fluxes<a name='159'></font>
<font color=#447700>!-- DX          horizontal grid size (m)<a name='160'></font>
<font color=#447700>!-- SVP1        constant for saturation vapor pressure (=0.6112 kPa)<a name='161'></font>
<font color=#447700>!-- SVP2        constant for saturation vapor pressure (=17.67 dimensionless)<a name='162'></font>
<font color=#447700>!-- SVP3        constant for saturation vapor pressure (=29.65 K)<a name='163'></font>
<font color=#447700>!-- SVPT0       constant for saturation vapor pressure (=273.15 K)<a name='164'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (Rv/Rd - 1) (dimensionless)<a name='165'></font>
<font color=#447700>!-- EP2         constant for spec. hum. calc (Rd/Rv = 0.622) (dimensionless)<a name='166'></font>
<font color=#447700>!-- EP3         constant for spec. hum. calc (1 - Rd/Rv = 0.378 ) (dimensionless)<a name='167'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='168'></font>
<font color=#447700>!-- ck          enthalpy exchange coeff at 10 meters<a name='169'></font>
<font color=#447700>!-- cd          momentum exchange coeff at 10 meters<a name='170'></font>
<font color=#447700>!-- cka         enthalpy exchange coeff at the lowest model level<a name='171'></font>
<font color=#447700>!-- cda         momentum exchange coeff at the lowest model level<a name='172'></font>
<font color=#447700>!-- isftcflx    =0: z0, zt, and zq from COARE3.0/3.5 (Fairall et al 2003/Edson et al 2013)<a name='173'></font>
<font color=#447700>!   (water      =1: z0 from Davis et al (2008), zt &amp; zq from COARE3.0/3.5<a name='174'></font>
<font color=#447700>!    only)      =2: z0 from Davis et al (2008), zt &amp; zq from Garratt (1992)<a name='175'></font>
<font color=#447700>!               =3: z0 from Taylor and Yelland (2004), zt and zq from COARE 3.0/3.5<a name='176'></font>
<font color=#447700>!               =4: z0 from Zilitinkevich (2001), zt &amp; zq from COARE 3.0/3.5<a name='177'></font>
<font color=#447700>!-- iz0tlnd     =0: Zilitinkevich (1995) with Czil=0.10, <a name='178'></font>
<font color=#447700>!   (land       =1: Czil_new (modified according to Chen &amp; Zhang 2008)<a name='179'></font>
<font color=#447700>!    only)      =2: Modified Yang et al (2002, 2008) - generalized for all landuse<a name='180'></font>
<font color=#447700>!               =3: constant zt = z0/7.4 (Garratt 1992)<a name='181'></font>
<font color=#447700>!               =4: Pan et al (1994) for zq; ZIlitintevich for zt<a name='182'></font>
<font color=#447700>!-- bl_mynn_cloudpdf =0: Mellor &amp; Yamada<a name='183'></font>
<font color=#447700>!                    =1: Kuwano et al.<a name='184'></font>
<font color=#447700>!-- el_pbl      = mixing length from PBL scheme (meters)<a name='185'></font>
<font color=#447700>!-- Sh3d        = Stability finction for heat (unitless)<a name='186'></font>
<font color=#447700>!-- cov         = T'q' from PBL scheme<a name='187'></font>
<font color=#447700>!-- tsq         = T'T' from PBL scheme<a name='188'></font>
<font color=#447700>!-- qsq         = q'q' from PBL scheme<a name='189'></font>
<font color=#447700>!-- icloud_bl  = namelist option for subgrid scale cloud/radiation feedback<a name='190'></font>
<font color=#447700>!-- qc_bl       = subgrid scale (bloundary layer) clouds<a name='191'></font>
<font color=#447700>!-- cldfra_bl   = subgridscale cloud fraction<a name='192'></font>
<font color=#447700>!<a name='193'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='194'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='195'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='196'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='197'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='198'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='199'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='200'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='201'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='202'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='203'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='204'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='205'></font>
<font color=#447700>!-- its         start index for i in tile<a name='206'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='207'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='208'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='209'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='210'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='211'></font>
<font color=#447700>!=================================================================<a name='212'></font>
<font color=#447700>! SCALARS<a name='213'></font>
<font color=#447700>!===================================<a name='214'></font>
      INTEGER,  INTENT(IN)   ::        ids,ide, jds,jde, kds,kde, &amp;<a name='215'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='216'>
                                       its,ite, jts,jte, kts,kte<a name='217'>
      INTEGER,  INTENT(IN)   ::        itimestep<a name='218'>
      REAL,     INTENT(IN)   ::        SVP1,SVP2,SVP3,SVPT0<a name='219'>
      REAL,     INTENT(IN)   ::        EP1,EP2,KARMAN<a name='220'>
      REAL,     INTENT(IN)   ::        CP,G,ROVCP,R,XLV,DX<a name='221'>
<font color=#447700>!NAMELIST OPTIONS:<a name='222'></font>
      INTEGER,  INTENT(IN)   ::        ISFFLX<a name='223'>
      INTEGER,  OPTIONAL,  INTENT(IN)   ::     ISFTCFLX, IZ0TLND,&amp;<a name='224'>
                                                bl_mynn_cloudpdf,&amp;<a name='225'>
                                                icloud_bl<a name='226'>
      INTEGER,  INTENT(IN),OPTIONAL    ::    spp_pbl<a name='227'>
<a name='228'>
<font color=#447700>!===================================<a name='229'></font>
<font color=#447700>! 3D VARIABLES<a name='230'></font>
<font color=#447700>!===================================<a name='231'></font>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='232'>
                INTENT(IN   )   ::                           dz8w, &amp;<a name='233'>
                                                             QV3D, &amp;<a name='234'>
                                                              P3D, &amp;<a name='235'>
                                                              T3D, &amp;<a name='236'>
                                                             QC3D, &amp;<a name='237'>
                                                          U3D,V3D, &amp;<a name='238'>
                          RHO3D,th3d,pi3d,tsq,qsq,cov,sh3d,el_pbl<a name='239'>
<a name='240'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme ) ::   qc_bl, &amp;<a name='241'>
                                                        cldfra_bl<a name='242'>
      REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN),OPTIONAL ::pattern_spp_pbl<a name='243'>
<font color=#447700>!===================================<a name='244'></font>
<font color=#447700>! 2D VARIABLES<a name='245'></font>
<font color=#447700>!===================================<a name='246'></font>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='247'>
                INTENT(IN   )               ::             MAVAIL, &amp;<a name='248'>
                                                             PBLH, &amp;<a name='249'>
                                                            XLAND, &amp;<a name='250'>
                                                              TSK, &amp;<a name='251'>
                                                              QCG, &amp;<a name='252'>
                                                           PSFCPA ,&amp;<a name='253'>
                                                            SNOWH<a name='254'>
<a name='255'>
<a name='256'>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='257'>
                INTENT(OUT  )               ::            U10,V10, &amp;<a name='258'>
                                                        TH2,T2,Q2<a name='259'>
<a name='260'>
      REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme )              , &amp;<a name='261'>
                INTENT(OUT)     ::              ck,cka,cd,cda,ustm<a name='262'>
<font color=#447700>!<a name='263'></font>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='264'>
                INTENT(INOUT)               ::             REGIME, &amp;<a name='265'>
                                                              HFX, &amp;<a name='266'>
                                                              QFX, &amp;<a name='267'>
                                                               LH, &amp;<a name='268'>
                                                         MOL,RMOL, &amp;<a name='269'>
                                                        QSFC, QGH, &amp;<a name='270'>
                                                              ZNT, &amp;<a name='271'>
                                                              ZOL, &amp;<a name='272'>
                                                              UST, &amp;<a name='273'>
                                                              CPM, &amp;<a name='274'>
                                                             CHS2, &amp;<a name='275'>
                                                             CQS2, &amp;<a name='276'>
                                                              CHS, &amp;<a name='277'>
                                                               CH, &amp;<a name='278'>
                                                        FLHC,FLQC, &amp;<a name='279'>
                                                   GZ1OZ0,WSPD,BR, &amp;<a name='280'>
                                                        PSIM,PSIH<a name='281'>
<a name='282'>
<font color=#447700>!ADDITIONAL OUTPUT<a name='283'></font>
<font color=#447700>!JOE-begin<a name='284'></font>
      REAL,     DIMENSION( ims:ime, jms:jme )    ::    z0zt_ratio, &amp;<a name='285'>
                                 BulkRi,wstar,qstar,resist,logres<a name='286'>
<font color=#447700>!JOE-end <a name='287'></font>
<font color=#447700>!===================================<a name='288'></font>
<font color=#447700>! 1D LOCAL ARRAYS<a name='289'></font>
<font color=#447700>!===================================<a name='290'></font>
      REAL,     DIMENSION( its:ite ) ::                       U1D, &amp;<a name='291'>
                                                              V1D, &amp;<a name='292'>
                                                        U1D2,V1D2, &amp; <font color=#447700>!level2 winds<a name='293'></font>
                                                             QV1D, &amp;<a name='294'>
                                                              P1D, &amp;<a name='295'>
                                                         T1D,QC1D, &amp;<a name='296'>
                                                            RHO1D, &amp;<a name='297'>
                                                           dz8w1d, &amp; <font color=#447700>!level 1 height<a name='298'></font>
                                                           dz2w1d    <font color=#447700>!level 2 height<a name='299'></font>
<a name='300'>
      REAL,     DIMENSION( its:ite ) ::                  rstoch1D<a name='301'>
<a name='302'>
      <font color=#447700>! VARIABLE FOR PASSING TO MYM_CONDENSATION<a name='303'></font>
      REAL,     DIMENSION(kts:kts+1 ) :: dummy1,dummy2,dummy3,dummy4, &amp;<a name='304'>
                                         dummy5,dummy6,dummy7,dummy8, &amp;<a name='305'>
                                         dummy9,dummy10,dummy11,      &amp;<a name='306'>
                                         dummy12,dummy13,dummy14<a name='307'>
<a name='308'>
      REAL,     DIMENSION( its:ite ) ::  vt1,vq1<a name='309'>
      REAL,     DIMENSION(kts:kts+1) ::  thl, qw, vt, vq<a name='310'>
      REAL                           ::  ql<a name='311'>
<a name='312'>
      INTEGER ::  I,J,K,itf,jtf,ktf<a name='313'>
<font color=#447700>!-----------------------------------------------------------<a name='314'></font>
<a name='315'>
      itf=MIN0(ite,ide-1)<a name='316'>
      jtf=MIN0(jte,jde-1)<a name='317'>
      ktf=MIN0(kte,kde-1)<a name='318'>
<a name='319'>
      DO J=jts,jte<a name='320'>
        DO i=its,ite<a name='321'>
           dz8w1d(I) = dz8w(i,kts,j)<a name='322'>
           dz2w1d(I) = dz8w(i,kts+1,j)<a name='323'>
           U1D(i) =U3D(i,kts,j)<a name='324'>
           V1D(i) =V3D(i,kts,j)<a name='325'>
           <font color=#447700>!2nd model level winds - for diags with high-res grids<a name='326'></font>
           U1D2(i) =U3D(i,kts+1,j)<a name='327'>
           V1D2(i) =V3D(i,kts+1,j)<a name='328'>
           QV1D(i)=QV3D(i,kts,j)<a name='329'>
           QC1D(i)=QC3D(i,kts,j)<a name='330'>
           P1D(i) =P3D(i,kts,j)<a name='331'>
           T1D(i) =T3D(i,kts,j)<a name='332'>
           RHO1D(i)=RHO3D(i,kts,j)<a name='333'>
           if (spp_pbl==1) then<a name='334'>
               rstoch1D(i)=pattern_spp_pbl(i,kts,j)<a name='335'>
           else<a name='336'>
               rstoch1D(i)=0.0<a name='337'>
           endif<a name='338'>
        ENDDO<a name='339'>
<a name='340'>
        IF (itimestep==1) THEN<a name='341'>
           DO i=its,ite<a name='342'>
              vt1(i)=0.<a name='343'>
              vq1(i)=0.<a name='344'>
              UST(i,j)=MAX(0.025*SQRT(U1D(i)*U1D(i) + V1D(i)*V1D(i)),0.001)<a name='345'>
              MOL(i,j)=0.     <font color=#447700>! Tstar<a name='346'></font>
              QSFC(i,j)=QV3D(i,kts,j)/(1.+QV3D(i,kts,j))<a name='347'>
              qstar(i,j)=0.0<a name='348'>
           ENDDO<a name='349'>
        ELSE<a name='350'>
           DO i=its,ite<a name='351'>
              DO k = kts,kts+1<a name='352'>
                ql = qc3d(i,k,j)/(1.+qc3d(i,k,j))<a name='353'>
                qw(k) = qv3d(i,k,j)/(1.+qv3d(i,k,j)) + ql<a name='354'>
                thl(k) = th3d(i,k,j)-xlvcp*ql/pi3d(i,k,j)<a name='355'>
                dummy1(k)=dz8w(i,k,j)<a name='356'>
                dummy2(k)=thl(k)<a name='357'>
                dummy3(k)=qw(k)<a name='358'>
                dummy4(k)=p3d(i,k,j)<a name='359'>
                dummy5(k)=pi3d(i,k,j)<a name='360'>
                dummy6(k)=tsq(i,k,j)<a name='361'>
                dummy7(k)=qsq(i,k,j)<a name='362'>
                dummy8(k)=cov(i,k,j)<a name='363'>
                dummy9(k)=Sh3d(i,k,j)<a name='364'>
                dummy10(k)=el_pbl(i,k,j)<a name='365'>
                dummy14(k)=th3d(i,k,j)<a name='366'>
                if(icloud_bl &gt; 0) then<a name='367'>
                  dummy11(k)=qc_bl(i,k,j)<a name='368'>
                  dummy12(k)=cldfra_bl(i,k,j)<a name='369'>
                else<a name='370'>
                  dummy11(k)=0.0<a name='371'>
                  dummy12(k)=0.0<a name='372'>
                endif<a name='373'>
                dummy13(k)=0.0     <font color=#447700>!sgm<a name='374'></font>
              ENDDO<a name='375'>
<a name='376'>
              <font color=#447700>! NOTE: The last grid number is kts+1 instead of kte.<a name='377'></font>
              CALL <A href='../../html_code/phys/module_bl_mynn.F.html#MYM_CONDENSATION'>mym_condensation</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYM_CONDENSATION_2"> (kts,kts+1, dx,     &amp;<a name='378'>
                   &amp;            dummy1,dummy2,dummy3,   &amp;<a name='379'>
                   &amp;            dummy4,dummy5,dummy6,   &amp;<a name='380'>
                   &amp;            dummy7,dummy8,dummy9,   &amp;<a name='381'>
                   &amp;            dummy10,bl_mynn_cloudpdf,&amp;<a name='382'>
                   &amp;            dummy11,dummy12,        &amp;<a name='383'>
                   &amp;            PBLH(i,j),HFX(i,j),     &amp;<a name='384'>
                   &amp;            vt(kts:kts+1), vq(kts:kts+1), &amp;<a name='385'>
                   &amp;            dummy14,dummy13)<a name='386'>
<a name='387'>
<font color=#447700>!              ! NOTE: The last grid number is kts+1 instead of kte.<a name='388'></font>
<font color=#447700>!              CALL mym_condensation (kts,kts+1, dx,     &amp;<a name='389'></font>
<font color=#447700>!                   &amp;            dz8w(i,kts:kts+1,j),    &amp;<a name='390'></font>
<font color=#447700>!                   &amp;            thl(kts:kts+1),         &amp;<a name='391'></font>
<font color=#447700>!                   &amp;            qw(kts:kts+1),          &amp;<a name='392'></font>
<font color=#447700>!                   &amp;            p3d(i,kts:kts+1,j),     &amp;<a name='393'></font>
<font color=#447700>!                   &amp;            pi3d(i,kts:kts+1,j),    &amp;<a name='394'></font>
<font color=#447700>!                   &amp;            tsq(i,kts:kts+1,j),     &amp;<a name='395'></font>
<font color=#447700>!                   &amp;            qsq(i,kts:kts+1,j),     &amp;<a name='396'></font>
<font color=#447700>!                   &amp;            cov(i,kts:kts+1,j),     &amp;<a name='397'></font>
<font color=#447700>!                   &amp;            Sh3d(i,kts:kts+1,j),    &amp; !JOE - cloud PDF testing<a name='398'></font>
<font color=#447700>!                   &amp;            el_pbl(i,kts:kts+1,j),  &amp; !JOE - cloud PDF testing<a name='399'></font>
<font color=#447700>!                   &amp;            bl_mynn_cloudpdf,       &amp; !JOE - cloud PDF testing<a name='400'></font>
<font color=#447700>!                   &amp;            qc_bl2D(i,kts:kts+1),   &amp; !JOE-subgrid BL clouds<a name='401'></font>
<font color=#447700>!                   &amp;           cldfra_bl2D(i,kts:kts+1),&amp; !JOE-subgrid BL clouds<a name='402'></font>
<font color=#447700>!                   &amp;            PBLH(i,j),HFX(i,j),     &amp; !JOE-subgrid BL clouds<a name='403'></font>
<font color=#447700>!                   &amp;            vt(kts:kts+1), vq(kts:kts+1), &amp;<a name='404'></font>
 <font color=#447700>!                  &amp;            th,sgm)<a name='405'></font>
              vt1(i) = vt(kts)<a name='406'>
              vq1(i) = vq(kts)<a name='407'>
           ENDDO<a name='408'>
        ENDIF<a name='409'>
<a name='410'>
        CALL <A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN'>SFCLAY1D_mynn</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAY1D_MYNN_1">(                                        &amp;<a name='411'>
                J,U1D,V1D,T1D,QV1D,P1D,dz8w1d,rho1d,               &amp;<a name='412'>
                U1D2,V1D2,dz2w1d,                                  &amp;<a name='413'>
                CP,G,ROVCP,R,XLV,PSFCPA(ims,j),CHS(ims,j),CHS2(ims,j),&amp;<a name='414'>
                CQS2(ims,j),CPM(ims,j),PBLH(ims,j), RMOL(ims,j),   &amp;<a name='415'>
                ZNT(ims,j),UST(ims,j),MAVAIL(ims,j),ZOL(ims,j),    &amp;<a name='416'>
                MOL(ims,j),REGIME(ims,j),PSIM(ims,j),PSIH(ims,j),  &amp;<a name='417'>
                XLAND(ims,j),HFX(ims,j),QFX(ims,j),TSK(ims,j),     &amp;<a name='418'>
                U10(ims,j),V10(ims,j),TH2(ims,j),T2(ims,j),        &amp;<a name='419'>
                Q2(ims,j),FLHC(ims,j),FLQC(ims,j),SNOWH(ims,j),    &amp;<a name='420'>
                QGH(ims,j),QSFC(ims,j),LH(ims,j),                  &amp;<a name='421'>
                GZ1OZ0(ims,j),WSPD(ims,j),BR(ims,j),ISFFLX,DX,     &amp;<a name='422'>
                SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,               &amp;<a name='423'>
                ch(ims,j),vt1,vq1,qc1d,qcg(ims,j),                 &amp;<a name='424'>
                itimestep,                                         &amp;<a name='425'>
<font color=#447700>!JOE-begin additional output<a name='426'></font>
                z0zt_ratio(ims,j),wstar(ims,j),                    &amp;<a name='427'>
                qstar(ims,j),resist(ims,j),logres(ims,j),          &amp;<a name='428'>
<font color=#447700>!JOE-end<a name='429'></font>
                spp_pbl,rstoch1D,                                  &amp;<a name='430'>
                ids,ide, jds,jde, kds,kde,                         &amp;<a name='431'>
                ims,ime, jms,jme, kms,kme,                         &amp;<a name='432'>
                its,ite, jts,jte, kts,kte                          &amp;<a name='433'>
                ,isftcflx,iz0tlnd,                                 &amp;<a name='434'>
                USTM(ims,j),CK(ims,j),CKA(ims,j),                  &amp;<a name='435'>
                CD(ims,j),CDA(ims,j)                               &amp;<a name='436'>
                                                                   )<a name='437'>
<a name='438'>
      ENDDO<a name='439'>
<a name='440'>
    END SUBROUTINE SFCLAY_MYNN<a name='441'>
<a name='442'>
<font color=#447700>!-------------------------------------------------------------------<a name='443'></font>
<A NAME='SFCLAY1D_MYNN'><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='444'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFCLAY1D_mynn</font>(                                       &amp; <A href='../../call_to/SFCLAY1D_MYNN.html' TARGET='index'>1</A>,<A href='../../call_from/SFCLAY1D_MYNN.html' TARGET='index'>31</A><a name='445'>
                     J,U1D,V1D,T1D,QV1D,P1D,dz8w1d,rho1d,          &amp;<a name='446'>
                     U1D2,V1D2,dz2w1d,                             &amp;<a name='447'>
                     CP,G,ROVCP,R,XLV,PSFCPA,CHS,CHS2,CQS2,CPM,    &amp;<a name='448'>
                     PBLH,RMOL,ZNT,UST,MAVAIL,ZOL,MOL,REGIME,      &amp;<a name='449'>
                     PSIM,PSIH,XLAND,HFX,QFX,TSK,                  &amp;<a name='450'>
                     U10,V10,TH2,T2,Q2,FLHC,FLQC,SNOWH,QGH,        &amp;<a name='451'>
                     QSFC,LH,GZ1OZ0,WSPD,BR,ISFFLX,DX,             &amp;<a name='452'>
                     SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='453'>
                     KARMAN,ch,vt1,vq1,qc1d,qcg,                   &amp;<a name='454'>
                     itimestep,                                    &amp;<a name='455'>
<font color=#447700>!JOE-additional output<a name='456'></font>
                     zratio,wstar,qstar,resist,logres,             &amp;<a name='457'>
<font color=#447700>!JOE-end<a name='458'></font>
                     spp_pbl,rstoch1D,                             &amp;<a name='459'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='460'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='461'>
                     its,ite, jts,jte, kts,kte                     &amp;<a name='462'>
                     ,isftcflx, iz0tlnd,                           &amp;<a name='463'>
                     ustm,ck,cka,cd,cda                            &amp;<a name='464'>
                     )<a name='465'>
<a name='466'>
<font color=#447700>!-------------------------------------------------------------------<a name='467'></font>
      IMPLICIT NONE<a name='468'>
<font color=#447700>!-------------------------------------------------------------------<a name='469'></font>
<font color=#447700>! SCALARS<a name='470'></font>
<font color=#447700>!-----------------------------<a name='471'></font>
      INTEGER,  INTENT(IN) ::        ids,ide, jds,jde, kds,kde, &amp;<a name='472'>
                                     ims,ime, jms,jme, kms,kme, &amp;<a name='473'>
                                     its,ite, jts,jte, kts,kte, &amp;<a name='474'>
                                     J, itimestep<a name='475'>
<a name='476'>
      REAL,     PARAMETER  :: XKA=2.4E-5   <font color=#447700>!molecular diffusivity<a name='477'></font>
      REAL,     PARAMETER  :: PRT=1.       <font color=#447700>!prandlt number<a name='478'></font>
      REAL,     INTENT(IN) :: SVP1,SVP2,SVP3,SVPT0,EP1,EP2<a name='479'>
      REAL,     INTENT(IN) :: KARMAN,CP,G,ROVCP,R,XLV,DX<a name='480'>
<a name='481'>
<font color=#447700>!-----------------------------<a name='482'></font>
<font color=#447700>! NAMELIST OPTIONS<a name='483'></font>
<font color=#447700>!-----------------------------<a name='484'></font>
      INTEGER,  INTENT(IN) :: ISFFLX<a name='485'>
      INTEGER,  OPTIONAL,  INTENT(IN )   ::     ISFTCFLX, IZ0TLND<a name='486'>
      INTEGER,    INTENT(IN)             ::     spp_pbl<a name='487'>
<a name='488'>
<font color=#447700>!-----------------------------<a name='489'></font>
<font color=#447700>! 1D ARRAYS<a name='490'></font>
<font color=#447700>!-----------------------------<a name='491'></font>
      REAL,     DIMENSION( ims:ime ), INTENT(IN)    ::     MAVAIL, &amp;<a name='492'>
                                                             PBLH, &amp;<a name='493'>
                                                            XLAND, &amp;<a name='494'>
                                                              TSK, &amp;<a name='495'>
                                                           PSFCPA, &amp;<a name='496'>
                                                              QCG, &amp;<a name='497'>
                                                            SNOWH<a name='498'>
<a name='499'>
      REAL,     DIMENSION( its:ite ), INTENT(IN)   ::     U1D,V1D, &amp;<a name='500'>
                                                        U1D2,V1D2, &amp;<a name='501'>
                                                         QV1D,P1D, &amp;<a name='502'>
                                                         T1D,QC1d, &amp;<a name='503'>
                                                    dz8w1d,dz2w1d, &amp;<a name='504'>
                                                            RHO1D, &amp;<a name='505'>
                                                          vt1,vq1<a name='506'>
<a name='507'>
      REAL,     DIMENSION( ims:ime ), INTENT(INOUT) ::     REGIME, &amp;<a name='508'>
                                                       HFX,QFX,LH, &amp;<a name='509'>
                                                         MOL,RMOL, &amp;<a name='510'>
                                                         QGH,QSFC, &amp;<a name='511'>
                                                              ZNT, &amp;<a name='512'>
                                                              ZOL, &amp;<a name='513'>
                                                              UST, &amp;<a name='514'>
                                                              CPM, &amp;<a name='515'>
                                                        CHS2,CQS2, &amp;<a name='516'>
                                                           CHS,CH, &amp;<a name='517'>
                                                        FLHC,FLQC, &amp;<a name='518'>
                                                           GZ1OZ0, &amp;<a name='519'>
                                                             WSPD, &amp;<a name='520'>
                                                               BR, &amp;<a name='521'>
                                                        PSIM,PSIH<a name='522'>
      REAL,     DIMENSION( its:ite ), INTENT(IN)   ::     rstoch1D<a name='523'>
<a name='524'>
      <font color=#447700>! DIAGNOSTIC OUTPUT<a name='525'></font>
      REAL,     DIMENSION( ims:ime ), INTENT(OUT)   ::    U10,V10, &amp;<a name='526'>
                                                        TH2,T2,Q2<a name='527'>
<a name='528'>
      REAL, OPTIONAL, DIMENSION( ims:ime )                       , &amp;<a name='529'>
                INTENT(OUT)     ::              ck,cka,cd,cda,ustm<a name='530'>
<font color=#447700>!--------------------------------------------<a name='531'></font>
<font color=#447700>!JOE-additinal output<a name='532'></font>
      REAL,     DIMENSION( ims:ime ) ::        zratio,wstar,qstar, &amp;<a name='533'>
                                                    resist,logres<a name='534'>
<font color=#447700>!JOE-end<a name='535'></font>
<font color=#447700>!----------------------------------------------------------------<a name='536'></font>
<font color=#447700>! LOCAL VARS<a name='537'></font>
<font color=#447700>!----------------------------------------------------------------<a name='538'></font>
      REAL :: thl1,sqv1,sqc1,exner1,sqvg,sqcg,vv,ww<a name='539'>
<a name='540'>
      REAL, DIMENSION(its:ite) :: &amp;<a name='541'>
                 ZA, &amp;    <font color=#447700>!Height of lowest 1/2 sigma level(m)<a name='542'></font>
                ZA2, &amp;    <font color=#447700>!Height of 2nd lowest 1/2 sigma level(m)<a name='543'></font>
              THV1D, &amp;    <font color=#447700>!Theta-v at lowest 1/2 sigma (K)<a name='544'></font>
               TH1D, &amp;    <font color=#447700>!Theta at lowest 1/2 sigma (K)<a name='545'></font>
               TC1D, &amp;    <font color=#447700>!T at lowest 1/2 sigma (Celsius)<a name='546'></font>
               TV1D, &amp;    <font color=#447700>!Tv at lowest 1/2 sigma (K)<a name='547'></font>
               QVSH, &amp;    <font color=#447700>!qv at lowest 1/2 sigma (spec humidity)<a name='548'></font>
        PSIH2,PSIM2, &amp;    <font color=#447700>!M-O stability functions at z=2 m<a name='549'></font>
      PSIH10,PSIM10, &amp;    <font color=#447700>!M-O stability functions at z=10 m<a name='550'></font>
              WSPDI, &amp; <a name='551'>
            z_t,z_q, &amp;    <font color=#447700>!thermal &amp; moisture roughness lengths<a name='552'></font>
           ZNTstoch, &amp;<a name='553'>
             GOVRTH, &amp;    <font color=#447700>!g/theta<a name='554'></font>
               THGB, &amp;    <font color=#447700>!theta at ground<a name='555'></font>
              THVGB, &amp;    <font color=#447700>!theta-v at ground<a name='556'></font>
               PSFC, &amp;    <font color=#447700>!press at surface (Pa/1000)<a name='557'></font>
             QSFCMR, &amp;    <font color=#447700>!qv at surface (mixing ratio, kg/kg)<a name='558'></font>
             GZ2OZ0, &amp;    <font color=#447700>!LOG((2.0+ZNT(I))/ZNT(I))<a name='559'></font>
            GZ10OZ0, &amp;    <font color=#447700>!LOG((10.+ZNT(I))/ZNT(I))<a name='560'></font>
             GZ2OZt, &amp;    <font color=#447700>!LOG((2.0+z_t(i))/z_t(i))<a name='561'></font>
            GZ10OZt, &amp;    <font color=#447700>!LOG((10.+z_t(i))/z_t(i))<a name='562'></font>
             GZ1OZt       <font color=#447700>!LOG((ZA(I)+z_t(i))/z_t(i))<a name='563'></font>
<a name='564'>
      INTEGER ::  N,I,K,L,NZOL,NK,NZOL2,NZOL10, ITER, yesno<a name='565'>
      INTEGER, PARAMETER :: ITMAX=1<a name='566'>
<a name='567'>
      REAL    ::  PL,THCON,TVCON,E1<a name='568'>
      REAL    ::  DTHVDZ,DTHVM,VCONV,RZOL,RZOL2,RZOL10,ZOL2,ZOL10<a name='569'>
      REAL    ::  DTG,PSIX,DTTHX,DTHDZ,PSIX10,PSIT,PSIT2,PSIT10, &amp;<a name='570'>
                  PSIQ,PSIQ2,PSIQ10<a name='571'>
      REAL    ::  FLUXC,VSGD<a name='572'>
      REAL    ::  restar,VISC,DQG,OLDUST,OLDTST<a name='573'>
      REAL, PARAMETER :: psilim = -10.  <font color=#447700>! ONLY AFFECTS z/L &gt; 2.0<a name='574'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='575'></font>
<a name='576'>
      DO I=its,ite<a name='577'>
         <font color=#447700>! CONVERT GROUND &amp; LOWEST LAYER TEMPERATURE TO POTENTIAL TEMPERATURE:<a name='578'></font>
         <font color=#447700>! PSFC cmb<a name='579'></font>
         PSFC(I)=PSFCPA(I)/1000.<a name='580'>
         THGB(I)=TSK(I)*(100./PSFC(I))**ROVCP   <font color=#447700>!(K)              <a name='581'></font>
         <font color=#447700>! PL cmb<a name='582'></font>
         PL=P1D(I)/1000.                                                   <a name='583'>
         THCON=(100./PL)**ROVCP                                                 <a name='584'>
         TH1D(I)=T1D(I)*THCON                   <font color=#447700>!(Theta, K)<a name='585'></font>
         TC1D(I)=T1D(I)-273.15                  <font color=#447700>!(T, Celsius)    <a name='586'></font>
<a name='587'>
         <font color=#447700>! CONVERT TO VIRTUAL TEMPERATURE<a name='588'></font>
         QVSH(I)=QV1D(I)/(1.+QV1D(I))        <font color=#447700>!CONVERT TO SPEC HUM (kg/kg)<a name='589'></font>
         TVCON=(1.+EP1*QVSH(I))<a name='590'>
         THV1D(I)=TH1D(I)*TVCON                 <font color=#447700>!(K)<a name='591'></font>
         TV1D(I)=T1D(I)*TVCON   <font color=#447700>!(K)<a name='592'></font>
<a name='593'>
         <font color=#447700>!RHO1D(I)=PSFCPA(I)/(R*TV1D(I)) !now using value calculated in sfc driver<a name='594'></font>
         ZA(I)=0.5*dz8w1d(I)             <font color=#447700>!height of first half-sigma level <a name='595'></font>
         ZA2(I)=dz8w1d(I) + 0.5*dz2w1d(I)    <font color=#447700>!height of 2nd half-sigma level<a name='596'></font>
         GOVRTH(I)=G/TH1D(I)<a name='597'>
      ENDDO<a name='598'>
<a name='599'>
      DO I=its,ite<a name='600'>
         IF (TSK(I) .LT. 273.15) THEN<a name='601'>
            <font color=#447700>!SATURATION VAPOR PRESSURE WRT ICE (SVP1=.6112; 10*mb)<a name='602'></font>
            E1=SVP1*EXP(4648*(1./273.15 - 1./TSK(I)) - &amp;<a name='603'>
            &amp; 11.64*LOG(273.15/TSK(I)) + 0.02265*(273.15 - TSK(I)))<a name='604'>
         ELSE<a name='605'>
            <font color=#447700>!SATURATION VAPOR PRESSURE WRT WATER (Bolton 1980)<a name='606'></font>
            E1=SVP1*EXP(SVP2*(TSK(I)-SVPT0)/(TSK(I)-SVP3))<a name='607'>
         ENDIF<a name='608'>
         <font color=#447700>!FOR LAND POINTS, QSFC can come from LSM, ONLY RECOMPUTE OVER WATER<a name='609'></font>
         IF (xland(i).gt.1.5 .or. QSFC(i).le.0.0) THEN   <font color=#447700>!WATER<a name='610'></font>
            QSFC(I)=EP2*E1/(PSFC(I)-ep_3*E1)             <font color=#447700>!specific humidity    <a name='611'></font>
            QSFCMR(I)=EP2*E1/(PSFC(I)-E1)                <font color=#447700>!mixing ratio <a name='612'></font>
         ELSE                                            <font color=#447700>!LAND <a name='613'></font>
            QSFCMR(I)=QSFC(I)/(1.-QSFC(I))<a name='614'>
         ENDIF<a name='615'>
<a name='616'>
         <font color=#447700>! QGH CHANGED TO USE LOWEST-LEVEL AIR TEMP CONSISTENT WITH MYJSFC CHANGE<a name='617'></font>
         <font color=#447700>! Q2SAT = QGH IN LSM<a name='618'></font>
         IF (TSK(I) .LT. 273.15) THEN<a name='619'>
            <font color=#447700>!SATURATION VAPOR PRESSURE WRT ICE<a name='620'></font>
            E1=SVP1*EXP(4648*(1./273.15 - 1./T1D(I)) - &amp;<a name='621'>
            &amp;  11.64*LOG(273.15/T1D(I)) + 0.02265*(273.15 - T1D(I)))<a name='622'>
         ELSE<a name='623'>
            <font color=#447700>!SATURATION VAPOR PRESSURE WRT WATER (Bolton 1980)<a name='624'></font>
            E1=SVP1*EXP(SVP2*(T1D(I)-SVPT0)/(T1D(I)-SVP3))<a name='625'>
         ENDIF<a name='626'>
         PL=P1D(I)/1000.<a name='627'>
         <font color=#447700>!QGH(I)=EP2*E1/(PL-ep_3*E1)    !specific humidity<a name='628'></font>
         QGH(I)=EP2*E1/(PL-E1)          <font color=#447700>!mixing ratio<a name='629'></font>
         CPM(I)=CP*(1.+0.84*QV1D(I))<a name='630'>
      ENDDO<a name='631'>
<a name='632'>
      DO I=its,ite<a name='633'>
         WSPD(I)=SQRT(U1D(I)*U1D(I)+V1D(I)*V1D(I))     <a name='634'>
<a name='635'>
         <font color=#447700>!account for partial condensation<a name='636'></font>
         exner1=(p1d(I)/p1000mb)**ROVCP<a name='637'>
         sqc1=qc1d(I)/(1.+qc1d(I))         <font color=#447700>!lowest mod level cloud water spec hum<a name='638'></font>
         sqv1=QVSH(I)                      <font color=#447700>!lowest mod level water vapor spec hum<a name='639'></font>
         thl1=TH1D(I)-xlvcp/exner1*sqc1<a name='640'>
         sqvg=qsfc(I)                      <font color=#447700>!sfc water vapor spec hum<a name='641'></font>
         sqcg=qcg(I)/(1.+qcg(I))           <font color=#447700>!sfc cloud water spec hum<a name='642'></font>
<a name='643'>
         vv = thl1-THGB(I)<a name='644'>
         <font color=#447700>!TGS:ww = mavail(I)*(sqv1-sqvg) + (sqc1-sqcg)<a name='645'></font>
         ww = (sqv1-sqvg) + (sqc1-sqcg)<a name='646'>
<a name='647'>
         <font color=#447700>!TGS:THVGB(I)=THGB(I)*(1.+EP1*QSFC(I)*MAVAIL(I)) <a name='648'></font>
         THVGB(I)=THGB(I)*(1.+EP1*QSFC(I))<a name='649'>
<a name='650'>
         DTHDZ=(TH1D(I)-THGB(I))<a name='651'>
         DTHVDZ=(THV1D(I)-THVGB(I))<a name='652'>
         <font color=#447700>!DTHVDZ= (vt1(i) + 1.0)*vv + (vq1(i) + tv0)*ww<a name='653'></font>
<a name='654'>
         <font color=#447700>!--------------------------------------------------------<a name='655'></font>
         <font color=#447700>!  Calculate the convective velocity scale (WSTAR) and <a name='656'></font>
         <font color=#447700>!  subgrid-scale velocity (VSGD) following Beljaars (1995, QJRMS) <a name='657'></font>
         <font color=#447700>!  and Mahrt and Sun (1995, MWR), respectively<a name='658'></font>
         <font color=#447700>!-------------------------------------------------------<a name='659'></font>
         <font color=#447700>!       VCONV = 0.25*sqrt(g/THVGB(I)*pblh(i)*dthvm)<a name='660'></font>
         <font color=#447700>!  Use Beljaars over land, old MM5 (Wyngaard) formula over water<a name='661'></font>
         IF (xland(i).lt.1.5) then     <font color=#447700>!LAND (xland == 1)<a name='662'></font>
<a name='663'>
            fluxc = max(hfx(i)/RHO1D(i)/cp                    &amp;<a name='664'>
            &amp;    + ep1*THVGB(I)*qfx(i)/RHO1D(i),0.)<a name='665'>
            WSTAR(I) = vconvc*(g/TSK(i)*pblh(i)*fluxc)**.33<a name='666'>
<a name='667'>
         ELSE                          <font color=#447700>!WATER (xland == 2)<a name='668'></font>
<a name='669'>
            <font color=#447700>!JOE-the Wyngaard formula is ~3 times larger than the Beljaars <a name='670'></font>
            <font color=#447700>!formula, so switch to Beljaars for water, but use VCONVC = 1.25,<a name='671'></font>
            <font color=#447700>!as in the COARE 3.0/3.5 bulk parameterizations.<a name='672'></font>
            <font color=#447700>!IF(-DTHVDZ.GE.0)THEN<a name='673'></font>
            <font color=#447700>!   DTHVM=-DTHVDZ<a name='674'></font>
            <font color=#447700>!ELSE<a name='675'></font>
            <font color=#447700>!   DTHVM=0.<a name='676'></font>
            <font color=#447700>!ENDIF<a name='677'></font>
            <font color=#447700>!WSTAR(I) = 2.*SQRT(DTHVM)<a name='678'></font>
            fluxc = max(hfx(i)/RHO1D(i)/cp                    &amp;<a name='679'>
            &amp;     + ep1*THVGB(I)*qfx(i)/RHO1D(i),0.)<a name='680'>
            WSTAR(I) = 1.25*(g/TSK(i)*pblh(i)*fluxc)**.33<a name='681'>
<a name='682'>
         ENDIF<a name='683'>
<a name='684'>
         <font color=#447700>!--------------------------------------------------------<a name='685'></font>
         <font color=#447700>! Mahrt and Sun low-res correction<a name='686'></font>
         <font color=#447700>! (for 13 km ~ 0.37 m/s; for 3 km == 0 m/s)<a name='687'></font>
         <font color=#447700>!--------------------------------------------------------<a name='688'></font>
         VSGD = 0.32 * (max(dx/5000.-1.,0.))**.33<a name='689'>
         WSPD(I)=SQRT(WSPD(I)*WSPD(I)+WSTAR(I)*WSTAR(I)+vsgd*vsgd)<a name='690'>
         WSPD(I)=MAX(WSPD(I),wmin)<a name='691'>
<a name='692'>
         <font color=#447700>!--------------------------------------------------------<a name='693'></font>
         <font color=#447700>! CALCULATE THE BULK RICHARDSON NUMBER OF SURFACE LAYER, <a name='694'></font>
         <font color=#447700>! ACCORDING TO AKB(1976), EQ(12). <a name='695'></font>
         <font color=#447700>!--------------------------------------------------------<a name='696'></font>
         BR(I)=GOVRTH(I)*ZA(I)*DTHVDZ/(WSPD(I)*WSPD(I))<a name='697'>
         <font color=#447700>!SET LIMITS ACCORDING TO Li et al. (2010) Boundary-Layer Meteorol (p.158)<a name='698'></font>
         BR(I)=MAX(BR(I),-20.0)<a name='699'>
         BR(I)=MIN(BR(I),2.0)<a name='700'>
                <a name='701'>
         <font color=#447700>! IF PREVIOUSLY UNSTABLE, DO NOT LET INTO REGIMES 1 AND 2 (STABLE)<a name='702'></font>
         <font color=#447700>!if (itimestep .GT. 1) THEN<a name='703'></font>
         <font color=#447700>!    IF(MOL(I).LT.0.)BR(I)=MIN(BR(I),0.0)<a name='704'></font>
         <font color=#447700>!ENDIF<a name='705'></font>
     <a name='706'>
         <font color=#447700>!IF(I .eq. 2)THEN<a name='707'></font>
         <font color=#447700>!  write(*,1006)"BR:",BR(I)," fluxc:",fluxc," vt1:",vt1(i)," vq1:",vq1(i)<a name='708'></font>
         <font color=#447700>!  write(*,1007)"XLAND:",XLAND(I)," WSPD:",WSPD(I)," DTHVDZ:",DTHVDZ," WSTAR:",WSTAR(I)<a name='709'></font>
         <font color=#447700>!ENDIF<a name='710'></font>
<a name='711'>
      ENDDO<a name='712'>
<a name='713'>
 1006   format(A,F7.3,A,f9.4,A,f9.5,A,f9.4)<a name='714'>
 1007   format(A,F2.0,A,f6.2,A,f7.3,A,f7.2)<a name='715'>
<a name='716'>
<font color=#447700>!--------------------------------------------------------------------      <a name='717'></font>
<font color=#447700>!--------------------------------------------------------------------      <a name='718'></font>
<font color=#447700>!--- BEGIN ITERATION LOOP (ITMAX=5); USUALLY CONVERGES IN TWO PASSES<a name='719'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='720'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='721'></font>
<a name='722'>
 DO I=its,ite<a name='723'>
<a name='724'>
   ITER = 1<a name='725'>
   DO WHILE (ITER .LE. ITMAX)<a name='726'>
<a name='727'>
      <font color=#447700>!COMPUTE KINEMATIC VISCOSITY (m2/s) Andreas (1989) CRREL Rep. 89-11<a name='728'></font>
      <font color=#447700>!valid between -173 and 277 degrees C.<a name='729'></font>
      VISC=1.326e-5*(1. + 6.542e-3*TC1D(I) + 8.301e-6*TC1D(I)*TC1D(I) &amp;<a name='730'>
                        - 4.84e-9*TC1D(I)*TC1D(I)*TC1D(I))<a name='731'>
<a name='732'>
      IF((XLAND(I)-1.5).GE.0)THEN<a name='733'>
          <font color=#447700>!--------------------------------------<a name='734'></font>
          <font color=#447700>! WATER<a name='735'></font>
          <font color=#447700>!--------------------------------------<a name='736'></font>
          <font color=#447700>! CALCULATE z0 (znt)<a name='737'></font>
          <font color=#447700>!--------------------------------------<a name='738'></font>
          IF ( PRESENT(ISFTCFLX) ) THEN<a name='739'>
             IF ( ISFTCFLX .EQ. 0 ) THEN<a name='740'>
                IF (COARE_OPT .EQ. 3.0) THEN<a name='741'>
                  <font color=#447700>!COARE 3.0 (MISLEADING SUBROUTINE NAME)<a name='742'></font>
                  CALL <A href='../../html_code/phys/module_sf_mynn.F.html#CHARNOCK_1955'>charnock_1955</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHARNOCK_1955_1">(ZNT(i),UST(i),WSPD(i),visc,ZA(I))<a name='743'>
                ELSE<a name='744'>
                  <font color=#447700>!COARE 3.5<a name='745'></font>
                  CALL <A href='../../html_code/phys/module_sf_mynn.F.html#EDSON_ETAL_2013'>edson_etal_2013</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EDSON_ETAL_2013_1">(ZNT(i),UST(i),WSPD(i),visc,ZA(I))<a name='746'>
                ENDIF<a name='747'>
             ELSEIF ( ISFTCFLX .EQ. 1 .OR. ISFTCFLX .EQ. 2 ) THEN<a name='748'>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#DAVIS_ETAL_2008'>davis_etal_2008</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DAVIS_ETAL_2008_1">(ZNT(i),UST(i))<a name='749'>
             ELSEIF ( ISFTCFLX .EQ. 3 ) THEN<a name='750'>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#TAYLOR_YELLAND_2001'>Taylor_Yelland_2001</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TAYLOR_YELLAND_2001_1">(ZNT(i),UST(i),WSPD(i))<a name='751'>
             ELSEIF ( ISFTCFLX .EQ. 4 ) THEN<a name='752'>
                IF (COARE_OPT .EQ. 3.0) THEN<a name='753'>
                  <font color=#447700>!COARE 3.0 (MISLEADING SUBROUTINE NAME)<a name='754'></font>
                  CALL <A href='../../html_code/phys/module_sf_mynn.F.html#CHARNOCK_1955'>charnock_1955</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHARNOCK_1955_2">(ZNT(i),UST(i),WSPD(i),visc,ZA(I))<a name='755'>
                ELSE<a name='756'>
                  <font color=#447700>!COARE 3.5<a name='757'></font>
                  CALL <A href='../../html_code/phys/module_sf_mynn.F.html#EDSON_ETAL_2013'>edson_etal_2013</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EDSON_ETAL_2013_2">(ZNT(i),UST(i),WSPD(i),visc,ZA(I))<a name='758'>
                ENDIF<a name='759'>
             ENDIF<a name='760'>
          ELSE<a name='761'>
             <font color=#447700>!DEFAULT TO COARE 3.0/3.5<a name='762'></font>
             IF (COARE_OPT .EQ. 3.0) THEN<a name='763'>
                <font color=#447700>!COARE 3.0<a name='764'></font>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#CHARNOCK_1955'>charnock_1955</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHARNOCK_1955_3">(ZNT(i),UST(i),WSPD(i),visc,ZA(I))<a name='765'>
             ELSE<a name='766'>
                <font color=#447700>!COARE 3.5<a name='767'></font>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#EDSON_ETAL_2013'>edson_etal_2013</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EDSON_ETAL_2013_3">(ZNT(i),UST(i),WSPD(i),visc,ZA(I))<a name='768'>
             ENDIF<a name='769'>
          ENDIF<a name='770'>
<a name='771'>
          <font color=#447700>! add stochastic perturbaction of ZNT<a name='772'></font>
          if (spp_pbl==1) then<a name='773'>
             ZNTstoch(I)  = MAX(ZNT(I) + 1.5 * ZNT(I) * rstoch1D(i), 1e-6)<a name='774'>
          else<a name='775'>
             ZNTstoch(I)  = ZNT(I)<a name='776'>
          endif<a name='777'>
<a name='778'>
          <font color=#447700>!COMPUTE ROUGHNESS REYNOLDS NUMBER (restar) USING NEW ZNT<a name='779'></font>
          <font color=#447700>! AHW: Garrattt formula: Calculate roughness Reynolds number<a name='780'></font>
          <font color=#447700>!      Kinematic viscosity of air (linear approx to<a name='781'></font>
          <font color=#447700>!      temp dependence at sea level)<a name='782'></font>
          restar=MAX(ust(i)*ZNTstoch(i)/visc, 0.1)<a name='783'>
<a name='784'>
          <font color=#447700>!--------------------------------------<a name='785'></font>
          <font color=#447700>!CALCULATE z_t and z_q<a name='786'></font>
          <font color=#447700>!--------------------------------------<a name='787'></font>
          IF ( PRESENT(ISFTCFLX) ) THEN<a name='788'>
             IF ( ISFTCFLX .EQ. 0 ) THEN<a name='789'>
                IF (COARE_OPT .EQ. 3.0) THEN<a name='790'>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2003'>fairall_etal_2003</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAIRALL_ETAL_2003_1">(z_t(i),z_q(i),restar,UST(i),visc)<a name='791'>
                ELSE<a name='792'>
                   <font color=#447700>!presumably, this will be published soon, but hasn't yet<a name='793'></font>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2014'>fairall_etal_2014</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAIRALL_ETAL_2014_1">(z_t(i),z_q(i),restar,UST(i),visc,rstoch1D(i),spp_pbl)<a name='794'>
                ENDIF<a name='795'>
             ELSEIF ( ISFTCFLX .EQ. 1 ) THEN<a name='796'>
                IF (COARE_OPT .EQ. 3.0) THEN<a name='797'>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2003'>fairall_etal_2003</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAIRALL_ETAL_2003_2">(z_t(i),z_q(i),restar,UST(i),visc)<a name='798'>
                ELSE<a name='799'>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2014'>fairall_etal_2014</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAIRALL_ETAL_2014_2">(z_t(i),z_q(i),restar,UST(i),visc,rstoch1D(i),spp_pbl)<a name='800'>
                ENDIF<a name='801'>
             ELSEIF ( ISFTCFLX .EQ. 2 ) THEN<a name='802'>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#GARRATT_1992'>garratt_1992</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GARRATT_1992_1">(z_t(i),z_q(i),ZNTstoch(i),restar,XLAND(I))<a name='803'>
             ELSEIF ( ISFTCFLX .EQ. 3 ) THEN<a name='804'>
                IF (COARE_OPT .EQ. 3.0) THEN<a name='805'>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2003'>fairall_etal_2003</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAIRALL_ETAL_2003_3">(z_t(i),z_q(i),restar,UST(i),visc)<a name='806'>
                ELSE<a name='807'>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2014'>fairall_etal_2014</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAIRALL_ETAL_2014_3">(z_t(i),z_q(i),restar,UST(i),visc,rstoch1D(i),spp_pbl)<a name='808'>
                ENDIF<a name='809'>
             ELSEIF ( ISFTCFLX .EQ. 4 ) THEN<a name='810'>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#ZILITINKEVICH_1995'>zilitinkevich_1995</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZILITINKEVICH_1995_1">(ZNTstoch(i),z_t(i),z_q(i),restar,&amp;<a name='811'>
                                   UST(I),KARMAN,XLAND(I),IZ0TLND,spp_pbl,rstoch1D(i))<a name='812'>
             ENDIF<a name='813'>
          ELSE<a name='814'>
             <font color=#447700>!DEFAULT TO COARE 3.0/3.5<a name='815'></font>
             IF (COARE_OPT .EQ. 3.0) THEN<a name='816'>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2003'>fairall_etal_2003</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAIRALL_ETAL_2003_4">(z_t(i),z_q(i),restar,UST(i),visc)<a name='817'>
             ELSE<a name='818'>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2014'>fairall_etal_2014</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FAIRALL_ETAL_2014_4">(z_t(i),z_q(i),restar,UST(i),visc,rstoch1D(i),spp_pbl)<a name='819'>
             ENDIF<a name='820'>
          ENDIF<a name='821'>
 <a name='822'>
       ELSE<a name='823'>
<a name='824'>
          <font color=#447700>! add stochastic perturbaction of ZNT<a name='825'></font>
          if (spp_pbl==1) then<a name='826'>
             ZNTstoch(I)  = MAX(ZNT(I) + 1.5 * ZNT(I) * rstoch1D(i), 1e-6)<a name='827'>
          else<a name='828'>
             ZNTstoch(I)  = ZNT(I)<a name='829'>
          endif<a name='830'>
<a name='831'>
          <font color=#447700>!--------------------------------------<a name='832'></font>
          <font color=#447700>! LAND<a name='833'></font>
          <font color=#447700>!--------------------------------------<a name='834'></font>
          <font color=#447700>!COMPUTE ROUGHNESS REYNOLDS NUMBER (restar) USING DEFAULT ZNT<a name='835'></font>
          restar=MAX(ust(i)*ZNTstoch(i)/visc, 0.1)<a name='836'>
<a name='837'>
          <font color=#447700>!--------------------------------------<a name='838'></font>
          <font color=#447700>!GET z_t and z_q<a name='839'></font>
          <font color=#447700>!--------------------------------------<a name='840'></font>
          <font color=#447700>!CHECK FOR SNOW/ICE POINTS OVER LAND<a name='841'></font>
          <font color=#447700>!IF ( ZNTSTOCH(i) .LE. SNOWZ0  .AND.  TSK(I) .LE. 273.15 ) THEN<a name='842'></font>
          IF ( SNOWH(i) .GE. 0.1) THEN<a name='843'>
             CALL <A href='../../html_code/phys/module_sf_mynn.F.html#ANDREAS_2002'>Andreas_2002</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ANDREAS_2002_1">(ZNTSTOCH(i),visc,ust(i),z_t(i),z_q(i))<a name='844'>
          ELSE<a name='845'>
             IF ( PRESENT(IZ0TLND) ) THEN<a name='846'>
                IF ( IZ0TLND .LE. 1 .OR. IZ0TLND .EQ. 4) THEN<a name='847'>
                   <font color=#447700>!IF IZ0TLND==4, THEN PSIQ WILL BE RECALCULATED USING<a name='848'></font>
                   <font color=#447700>!PAN ET AL (1994), but PSIT FROM ZILI WILL BE USED.<a name='849'></font>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#ZILITINKEVICH_1995'>zilitinkevich_1995</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZILITINKEVICH_1995_2">(ZNTSTOCH(i),z_t(i),z_q(i),restar,&amp;<a name='850'>
                                  UST(I),KARMAN,XLAND(I),IZ0TLND,spp_pbl,rstoch1D(i))<a name='851'>
                ELSEIF ( IZ0TLND .EQ. 2 ) THEN<a name='852'>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#YANG_2008'>Yang_2008</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="YANG_2008_1">(ZNTSTOCH(i),z_t(i),z_q(i),UST(i),MOL(I),&amp;<a name='853'>
                                  qstar(I),restar,visc,XLAND(I))<a name='854'>
                ELSEIF ( IZ0TLND .EQ. 3 ) THEN<a name='855'>
                   <font color=#447700>!Original MYNN in WRF-ARW used this form:<a name='856'></font>
                   CALL <A href='../../html_code/phys/module_sf_mynn.F.html#GARRATT_1992'>garratt_1992</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GARRATT_1992_2">(z_t(i),z_q(i),ZNTSTOCH(i),restar,XLAND(I))<a name='857'>
                ENDIF<a name='858'>
             ELSE<a name='859'>
                <font color=#447700>!DEFAULT TO ZILITINKEVICH<a name='860'></font>
                CALL <A href='../../html_code/phys/module_sf_mynn.F.html#ZILITINKEVICH_1995'>zilitinkevich_1995</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZILITINKEVICH_1995_3">(ZNTSTOCH(i),z_t(i),z_q(i),restar,&amp;<a name='861'>
                                        UST(I),KARMAN,XLAND(I),0,spp_pbl,rstoch1D(i))<a name='862'>
             ENDIF<a name='863'>
          ENDIF<a name='864'>
<a name='865'>
       ENDIF<a name='866'>
       zratio(i)=zntstoch(i)/z_t(i)<a name='867'>
<a name='868'>
       <font color=#447700>!ADD RESISTANCE (SOMEWHAT FOLLOWING JIMENEZ ET AL. (2012)) TO PROTECT AGAINST<a name='869'></font>
       <font color=#447700>!EXCESSIVE FLUXES WHEN USING A LOW FIRST MODEL LEVEL (ZA &lt; 10 m).        <a name='870'></font>
       <font color=#447700>!Formerly: GZ1OZ0(I)= LOG(ZA(I)/ZNTstoch(I))<a name='871'></font>
       GZ1OZ0(I)= LOG((ZA(I)+ZNTstoch(I))/ZNTstoch(I))<a name='872'>
       GZ1OZt(I)= LOG((ZA(I)+z_t(i))/z_t(i))           <a name='873'>
       GZ2OZ0(I)= LOG((2.0+ZNTstoch(I))/ZNTstoch(I))                                        <a name='874'>
       GZ2OZt(I)= LOG((2.0+z_t(i))/z_t(i))                                        <a name='875'>
       GZ10OZ0(I)=LOG((10.+ZNTstoch(I))/ZNTstoch(I)) <a name='876'>
       GZ10OZt(I)=LOG((10.+z_t(i))/z_t(i)) <a name='877'>
<a name='878'>
     <font color=#447700>!--------------------------------------------------------------------      <a name='879'></font>
     <font color=#447700>!--- DIAGNOSE BASIC PARAMETERS FOR THE APPROPRIATE STABILITY CLASS:<a name='880'></font>
     <font color=#447700>!                                                                                <a name='881'></font>
     <font color=#447700>!    THE STABILITY CLASSES ARE DETERMINED BY BR (BULK RICHARDSON NO.).<a name='882'></font>
     <font color=#447700>!                                                                                <a name='883'></font>
     <font color=#447700>!    CRITERIA FOR THE CLASSES ARE AS FOLLOWS:                                   <a name='884'></font>
     <font color=#447700>!                                                                                <a name='885'></font>
     <font color=#447700>!        1. BR .GE. 0.2;                                                         <a name='886'></font>
     <font color=#447700>!               REPRESENTS NIGHTTIME STABLE CONDITIONS (REGIME=1),               <a name='887'></font>
     <font color=#447700>!                                                                                <a name='888'></font>
     <font color=#447700>!        2. BR .LT. 0.2 .AND. BR .GT. 0.0;                                       <a name='889'></font>
     <font color=#447700>!               REPRESENTS DAMPED MECHANICAL TURBULENT CONDITIONS                <a name='890'></font>
     <font color=#447700>!               (REGIME=2),                                                      <a name='891'></font>
     <font color=#447700>!                                                                                <a name='892'></font>
     <font color=#447700>!        3. BR .EQ. 0.0                                                          <a name='893'></font>
     <font color=#447700>!               REPRESENTS FORCED CONVECTION CONDITIONS (REGIME=3),              <a name='894'></font>
     <font color=#447700>!                                                                                <a name='895'></font>
     <font color=#447700>!        4. BR .LT. 0.0                                                          <a name='896'></font>
     <font color=#447700>!               REPRESENTS FREE CONVECTION CONDITIONS (REGIME=4).                <a name='897'></font>
     <font color=#447700>!                                                                                <a name='898'></font>
     <font color=#447700>!--------------------------------------------------------------------<a name='899'></font>
     IF (BR(I) .GT. 0.0) THEN<a name='900'>
        IF (BR(I) .GT. 0.2) THEN        <a name='901'>
            <font color=#447700>!---CLASS 1; STABLE (NIGHTTIME) CONDITIONS:                                    <a name='902'></font>
            REGIME(I)=1.<a name='903'>
        ELSE<a name='904'>
            <font color=#447700>!---CLASS 2; DAMPED MECHANICAL TURBULENCE:<a name='905'></font>
            REGIME(I)=2.<a name='906'>
        ENDIF<a name='907'>
<a name='908'>
        <font color=#447700>!COMPUTE z/L<a name='909'></font>
        <font color=#447700>!CALL Li_etal_2010(ZOL(I),BR(I),ZA(I)/ZNTstoch(I),zratio(I))<a name='910'></font>
<font color=#447700>!        IF (ITER .EQ. 1 .AND. itimestep .LE. 1) THEN<a name='911'></font>
           CALL <A href='../../html_code/phys/module_sf_mynn.F.html#LI_ETAL_2010'>Li_etal_2010</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LI_ETAL_2010_1">(ZOL(I),BR(I),ZA(I)/ZNTstoch(I),zratio(I))<a name='912'>
<font color=#447700>!        ELSE<a name='913'></font>
<font color=#447700>!           ZOL(I)=ZA(I)*KARMAN*G*MOL(I)/(TH1D(I)*MAX(UST(I),0.001)**2)<a name='914'></font>
<font color=#447700>!           ZOL(I)=MAX(ZOL(I),0.0)<a name='915'></font>
<font color=#447700>!           ZOL(I)=MIN(ZOL(I),2.)<a name='916'></font>
<font color=#447700>!        ENDIF<a name='917'></font>
 <a name='918'>
        <font color=#447700>!COMPUTE PSIM and PSIH<a name='919'></font>
        IF((XLAND(I)-1.5).GE.0)THEN                                            <a name='920'>
           <font color=#447700>! WATER<a name='921'></font>
           <font color=#447700>!CALL PSI_Suselj_Sood_2010(PSIM(I),PSIH(I),ZOL(I))<a name='922'></font>
           <font color=#447700>!CALL PSI_Beljaars_Holtslag_1991(PSIM(I),PSIH(I),ZOL(I))<a name='923'></font>
           <font color=#447700>!CALL PSI_Businger_1971(PSIM(I),PSIH(I),ZOL(I))<a name='924'></font>
           CALL <A href='../../html_code/phys/module_sf_mynn.F.html#PSI_DYERHICKS'>PSI_DyerHicks</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSI_DYERHICKS_1">(PSIM(I),PSIH(I),ZOL(I),z_t(I),ZNTstoch(I),ZA(I))<a name='925'>
        ELSE<a name='926'>
           <font color=#447700>! LAND  <a name='927'></font>
           <font color=#447700>!CALL PSI_Beljaars_Holtslag_1991(PSIM(I),PSIH(I),ZOL(I))<a name='928'></font>
           <font color=#447700>!CALL PSI_Businger_1971(PSIM(I),PSIH(I),ZOL(I))<a name='929'></font>
           <font color=#447700>!CALL PSI_Zilitinkevich_Esau_2007(PSIM(I),PSIH(I),ZOL(I))<a name='930'></font>
           CALL <A href='../../html_code/phys/module_sf_mynn.F.html#PSI_DYERHICKS'>PSI_DyerHicks</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSI_DYERHICKS_2">(PSIM(I),PSIH(I),ZOL(I),z_t(I),ZNTstoch(I),ZA(I))<a name='931'>
        ENDIF              <a name='932'>
<a name='933'>
        <font color=#447700>! LOWER LIMIT ON PSI IN STABLE CONDITIONS<a name='934'></font>
        PSIM(I)=MAX(PSIM(I),psilim)<a name='935'>
        PSIH(I)=MAX(PSIH(I),psilim)                                     <a name='936'>
        PSIM10(I)=MAX(10./ZA(I)*PSIM(I), psilim)<a name='937'>
        PSIH10(I)=MAX(10./ZA(I)*PSIH(I), psilim)<a name='938'>
        PSIM2(I)=MAX(2./ZA(I)*PSIM(I), psilim)<a name='939'>
        PSIH2(I)=MAX(2./ZA(I)*PSIH(I), psilim)<a name='940'>
        <font color=#447700>! 1.0 over Monin-Obukhov length<a name='941'></font>
        RMOL(I)= ZOL(I)/ZA(I)<a name='942'>
<a name='943'>
     ELSEIF(BR(I) .EQ. 0.) THEN                  <a name='944'>
        <font color=#447700>!=========================================================  <a name='945'></font>
        <font color=#447700>!-----CLASS 3; FORCED CONVECTION/NEUTRAL:                                                <a name='946'></font>
        <font color=#447700>!=========================================================<a name='947'></font>
        REGIME(I)=3.<a name='948'>
<a name='949'>
        PSIM(I)=0.0                                                              <a name='950'>
        PSIH(I)=PSIM(I)                                                          <a name='951'>
        PSIM10(I)=0.                                                   <a name='952'>
        PSIH10(I)=PSIM10(I)                                           <a name='953'>
        PSIM2(I)=0.                                                  <a name='954'>
        PSIH2(I)=PSIM2(I)                                           <a name='955'>
                                           <a name='956'>
        <font color=#447700>!ZOL(I)=0.                                             <a name='957'></font>
        IF(UST(I) .LT. 0.01)THEN                                                 <a name='958'>
          ZOL(I)=BR(I)*GZ1OZ0(I)                                               <a name='959'>
        ELSE                                                                     <a name='960'>
          ZOL(I)=KARMAN*GOVRTH(I)*ZA(I)*MOL(I)/(UST(I)*UST(I)) <a name='961'>
        ENDIF                                                                    <a name='962'>
        RMOL(I) = ZOL(I)/ZA(I)  <a name='963'>
<a name='964'>
     ELSEIF(BR(I) .LT. 0.)THEN            <a name='965'>
        <font color=#447700>!==========================================================<a name='966'></font>
        <font color=#447700>!-----CLASS 4; FREE CONVECTION:                                                  <a name='967'></font>
        <font color=#447700>!==========================================================<a name='968'></font>
        REGIME(I)=4.<a name='969'>
<a name='970'>
        <font color=#447700>!COMPUTE z/L<a name='971'></font>
        <font color=#447700>!CALL Li_etal_2010(ZOL(I),BR(I),ZA(I)/ZNTstoch(I),zratio(I))<a name='972'></font>
        IF (ITER .EQ. 1 .AND. itimestep .LE. 1) THEN<a name='973'>
           CALL <A href='../../html_code/phys/module_sf_mynn.F.html#LI_ETAL_2010'>Li_etal_2010</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LI_ETAL_2010_2">(ZOL(I),BR(I),ZA(I)/ZNTstoch(I),zratio(I))<a name='974'>
        ELSE<a name='975'>
           ZOL(I)=ZA(I)*KARMAN*G*MOL(I)/(TH1D(I)*MAX(UST(I),0.001)**2)<a name='976'>
           ZOL(I)=MAX(ZOL(I),-9.999)<a name='977'>
           ZOL(I)=MIN(ZOL(I),0.0)<a name='978'>
        ENDIF<a name='979'>
<a name='980'>
        ZOL10=10./ZA(I)*ZOL(I)<a name='981'>
        ZOL2=2./ZA(I)*ZOL(I)<a name='982'>
        ZOL(I)=MIN(ZOL(I),0.)<a name='983'>
        ZOL(I)=MAX(ZOL(I),-9.9999)<a name='984'>
        ZOL10=MIN(ZOL10,0.)<a name='985'>
        ZOL10=MAX(ZOL10,-9.9999)<a name='986'>
        ZOL2=MIN(ZOL2,0.)<a name='987'>
        ZOL2=MAX(ZOL2,-9.9999)<a name='988'>
        NZOL=INT(-ZOL(I)*100.)<a name='989'>
        RZOL=-ZOL(I)*100.-NZOL<a name='990'>
        NZOL10=INT(-ZOL10*100.)<a name='991'>
        RZOL10=-ZOL10*100.-NZOL10<a name='992'>
        NZOL2=INT(-ZOL2*100.)<a name='993'>
        RZOL2=-ZOL2*100.-NZOL2<a name='994'>
<a name='995'>
        <font color=#447700>!COMPUTE PSIM and PSIH<a name='996'></font>
        IF((XLAND(I)-1.5).GE.0)THEN                                            <a name='997'>
           <font color=#447700>! WATER<a name='998'></font>
           <font color=#447700>!CALL PSI_Suselj_Sood_2010(PSIM(I),PSIH(I),ZOL(I))<a name='999'></font>
           <font color=#447700>!CALL PSI_Hogstrom_1996(PSIM(I),PSIH(I),ZOL(I), z_t(I), ZNTstoch(I), ZA(I))<a name='1000'></font>
           <font color=#447700>!CALL PSI_Businger_1971(PSIM(I),PSIH(I),ZOL(I))<a name='1001'></font>
           CALL <A href='../../html_code/phys/module_sf_mynn.F.html#PSI_DYERHICKS'>PSI_DyerHicks</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSI_DYERHICKS_3">(PSIM(I),PSIH(I),ZOL(I),z_t(I),ZNTstoch(I),ZA(I))<a name='1002'>
        ELSE           <a name='1003'>
           <font color=#447700>! LAND  <a name='1004'></font>
           <font color=#447700>!CALL PSI_Hogstrom_1996(PSIM(I),PSIH(I),ZOL(I), z_t(I), ZNTstoch(I), ZA(I))<a name='1005'></font>
           <font color=#447700>!CALL PSI_Businger_1971(PSIM(I),PSIH(I),ZOL(I))<a name='1006'></font>
           CALL <A href='../../html_code/phys/module_sf_mynn.F.html#PSI_DYERHICKS'>PSI_DyerHicks</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSI_DYERHICKS_4">(PSIM(I),PSIH(I),ZOL(I),z_t(I),ZNTstoch(I),ZA(I))<a name='1007'>
        ENDIF              <a name='1008'>
<a name='1009'>
<font color=#447700>!!!!!JOE-test:avoid using psi tables in entirety<a name='1010'></font>
<font color=#447700>!        PSIM10(I)=PSIMTB(NZOL10)+RZOL10*(PSIMTB(NZOL10+1)-PSIMTB(NZOL10))<a name='1011'></font>
<font color=#447700>!        PSIH10(I)=PSIHTB(NZOL10)+RZOL10*(PSIHTB(NZOL10+1)-PSIHTB(NZOL10))<a name='1012'></font>
<font color=#447700>!        PSIM2(I)=PSIMTB(NZOL2)+RZOL2*(PSIMTB(NZOL2+1)-PSIMTB(NZOL2))<a name='1013'></font>
<font color=#447700>!        PSIH2(I)=PSIHTB(NZOL2)+RZOL2*(PSIHTB(NZOL2+1)-PSIHTB(NZOL2))<a name='1014'></font>
        PSIM10(I)=10./ZA(I)*PSIM(I)<a name='1015'>
        PSIH10(I)=10./ZA(I)*PSIH(I)<a name='1016'>
        PSIM2(I)=2./ZA(I)*PSIM(I)<a name='1017'>
        PSIH2(I)=2./ZA(I)*PSIH(I)<a name='1018'>
<a name='1019'>
        <font color=#447700>!---LIMIT PSIH AND PSIM IN THE CASE OF THIN LAYERS AND<a name='1020'></font>
        <font color=#447700>!---HIGH ROUGHNESS.  THIS PREVENTS DENOMINATOR IN FLUXES<a name='1021'></font>
        <font color=#447700>!---FROM GETTING TOO SMALL<a name='1022'></font>
        <font color=#447700>!PSIH(I)=MIN(PSIH(I),0.9*GZ1OZt(I))    !JOE: less restricitive over forest/urban.<a name='1023'></font>
        PSIH(I)=MIN(PSIH(I),0.9*GZ1OZ0(I))<a name='1024'>
        PSIM(I)=MIN(PSIM(I),0.9*GZ1OZ0(I))<a name='1025'>
        <font color=#447700>!PSIH2(I)=MIN(PSIH2(I),0.9*GZ2OZt(I))  !JOE: less restricitive over forest/urban.<a name='1026'></font>
        PSIH2(I)=MIN(PSIH2(I),0.9*GZ2OZ0(I))<a name='1027'>
        PSIM2(I)=MIN(PSIM2(I),0.9*GZ2OZ0(I))<a name='1028'>
        PSIM10(I)=MIN(PSIM10(I),0.9*GZ10OZ0(I))<a name='1029'>
        PSIH10(I)=MIN(PSIH10(I),0.9*GZ10OZ0(I))<a name='1030'>
<a name='1031'>
        RMOL(I) = ZOL(I)/ZA(I)  <a name='1032'>
<a name='1033'>
     ENDIF<a name='1034'>
<a name='1035'>
     <font color=#447700>!------------------------------------------------------------<a name='1036'></font>
     <font color=#447700>!-----COMPUTE THE FRICTIONAL VELOCITY:                                           <a name='1037'></font>
     <font color=#447700>!------------------------------------------------------------<a name='1038'></font>
     <font color=#447700>!     ZA(1982) EQS(2.60),(2.61).                                                 <a name='1039'></font>
      GZ1OZ0(I) =LOG((ZA(I)+ZNTstoch(I))/ZNTstoch(I))<a name='1040'>
      GZ10OZ0(I)=LOG((10.+ZNTstoch(I))/ZNTstoch(I)) <a name='1041'>
      PSIX=GZ1OZ0(I)-PSIM(I)<a name='1042'>
      PSIX10=GZ10OZ0(I)-PSIM10(I)<a name='1043'>
      <font color=#447700>! TO PREVENT OSCILLATIONS AVERAGE WITH OLD VALUE <a name='1044'></font>
      OLDUST = UST(I)<a name='1045'>
      UST(I)=0.5*UST(I)+0.5*KARMAN*WSPD(I)/PSIX <a name='1046'>
      <font color=#447700>!NON-AVERAGED: UST(I)=KARMAN*WSPD(I)/PSIX<a name='1047'></font>
     <a name='1048'>
      <font color=#447700>! Compute u* without vconv for use in HFX calc when isftcflx &gt; 0           <a name='1049'></font>
      WSPDI(I)=MAX(SQRT(U1D(I)*U1D(I)+V1D(I)*V1D(I)), wmin)<a name='1050'>
      IF ( PRESENT(USTM) ) THEN<a name='1051'>
         USTM(I)=0.5*USTM(I)+0.5*KARMAN*WSPDI(I)/PSIX<a name='1052'>
      ENDIF<a name='1053'>
<a name='1054'>
      IF ((XLAND(I)-1.5).LT.0.) THEN        <font color=#447700>!LAND<a name='1055'></font>
         UST(I)=MAX(UST(I),0.01)  <font color=#447700>!JOE:Relaxing this limit<a name='1056'></font>
         <font color=#447700>!Keep ustm = ust over land.<a name='1057'></font>
         IF ( PRESENT(USTM) ) USTM(I)=UST(I)<a name='1058'>
      ENDIF<a name='1059'>
<a name='1060'>
     <font color=#447700>!------------------------------------------------------------<a name='1061'></font>
     <font color=#447700>!-----COMPUTE THE THERMAL AND MOISTURE RESISTANCE (PSIQ AND PSIT):                                           <a name='1062'></font>
     <font color=#447700>!------------------------------------------------------------<a name='1063'></font>
      <font color=#447700>! LOWER LIMIT ADDED TO PREVENT LARGE FLHC IN SOIL MODEL<a name='1064'></font>
      <font color=#447700>! ACTIVATES IN UNSTABLE CONDITIONS WITH THIN LAYERS OR HIGH Z0<a name='1065'></font>
      GZ1OZt(I)= LOG((ZA(I)+z_t(i))/z_t(i))           <a name='1066'>
      GZ2OZt(I)= LOG((2.0+z_t(i))/z_t(i))                                        <a name='1067'>
<a name='1068'>
      <font color=#447700>!PSIT=MAX(GZ1OZ0(I)-PSIH(I),2.)<a name='1069'></font>
      PSIT=MAX(LOG((ZA(I)+z_t(i))/z_t(i))-PSIH(I) ,2.0)<a name='1070'>
      PSIT2=MAX(LOG((2.0+z_t(i))/z_t(i))-PSIH2(I) ,2.0)                                    <a name='1071'>
      resist(I)=PSIT<a name='1072'>
      logres(I)=GZ1OZt(I)<a name='1073'>
<a name='1074'>
      PSIQ=MAX(LOG((za(i)+z_q(i))/z_q(I))-PSIH(I) ,2.0)   <a name='1075'>
      PSIQ2=MAX(LOG((2.0+z_q(i))/z_q(I))-PSIH2(I) ,2.0) <a name='1076'>
<a name='1077'>
      IF((XLAND(I)-1.5).LT.0)THEN    <font color=#447700>!Land only<a name='1078'></font>
         IF ( IZ0TLND .EQ. 4 ) THEN<a name='1079'>
            CALL <A href='../../html_code/phys/module_sf_mynn.F.html#PAN_ETAL_1994'>Pan_etal_1994</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PAN_ETAL_1994_1">(PSIQ,PSIQ2,UST(I),PSIH(I),PSIH2(I),&amp;<a name='1080'>
                       &amp; KARMAN,ZA(I))<a name='1081'>
         ENDIF<a name='1082'>
      ENDIF<a name='1083'>
<a name='1084'>
      <font color=#447700>!----------------------------------------------------<a name='1085'></font>
      <font color=#447700>!COMPUTE THE TEMPERATURE SCALE (or FRICTION TEMPERATURE, T*)<a name='1086'></font>
      <font color=#447700>!----------------------------------------------------<a name='1087'></font>
      DTG=TH1D(I)-THGB(I)                                                   <a name='1088'>
      OLDTST=MOL(I)<a name='1089'>
      MOL(I)=KARMAN*DTG/PSIT/PRT<a name='1090'>
      <font color=#447700>!t_star(I) = -HFX(I)/(UST(I)*CPM(I)*RHO1D(I))<a name='1091'></font>
      <font color=#447700>!t_star(I) = MOL(I)<a name='1092'></font>
      <font color=#447700>!----------------------------------------------------<a name='1093'></font>
      <font color=#447700>!COMPUTE THE MOISTURE SCALE (or q*)<a name='1094'></font>
      DQG=(QVSH(i)-qsfc(i))*1000.   <font color=#447700>!(kg/kg -&gt; g/kg)<a name='1095'></font>
      qstar(I)=KARMAN*DQG/PSIQ/PRT<a name='1096'>
<a name='1097'>
      <font color=#447700>!-----------------------------------------------------<a name='1098'></font>
      <font color=#447700>!COMPUTE DIAGNOSTICS<a name='1099'></font>
      <font color=#447700>!-----------------------------------------------------<a name='1100'></font>
      <font color=#447700>!COMPUTE 10 M WNDS<a name='1101'></font>
      <font color=#447700>!-----------------------------------------------------<a name='1102'></font>
      <font color=#447700>! If the lowest model level is close to 10-m, use it <a name='1103'></font>
      <font color=#447700>! instead of the flux-based diagnostic formula.<a name='1104'></font>
      if (ZA(i) .le. 7.0) then<a name='1105'>
         <font color=#447700>! high vertical resolution<a name='1106'></font>
         if(ZA2(i) .gt. 7.0 .and. ZA2(i) .lt. 13.0) then<a name='1107'>
            <font color=#447700>!use 2nd model level<a name='1108'></font>
            U10(I)=U1D2(I)<a name='1109'>
            V10(I)=V1D2(I)<a name='1110'>
         else<a name='1111'>
            U10(I)=U1D(I)*log(10./ZNTstoch(I))/log(ZA(I)/ZNTstoch(I))<a name='1112'>
            V10(I)=V1D(I)*log(10./ZNTstoch(I))/log(ZA(I)/ZNTstoch(I))<a name='1113'>
         endif<a name='1114'>
      elseif(ZA(i) .gt. 7.0 .and. ZA(i) .lt. 13.0) then<a name='1115'>
         <font color=#447700>!moderate vertical resolution<a name='1116'></font>
         U10(I)=U1D(I)<a name='1117'>
         V10(I)=V1D(I)<a name='1118'>
      else<a name='1119'>
         <font color=#447700>! very coarse vertical resolution<a name='1120'></font>
         U10(I)=U1D(I)*PSIX10/PSIX<a name='1121'>
         V10(I)=V1D(I)*PSIX10/PSIX<a name='1122'>
      endif<a name='1123'>
<a name='1124'>
      <font color=#447700>!-----------------------------------------------------<a name='1125'></font>
      <font color=#447700>!COMPUTE 2m T, TH, AND Q<a name='1126'></font>
      <font color=#447700>!THESE WILL BE OVERWRITTEN FOR LAND POINTS IN THE LSM <a name='1127'></font>
      <font color=#447700>!-----------------------------------------------------<a name='1128'></font>
      TH2(I)=THGB(I)+DTG*PSIT2/PSIT<a name='1129'>
      <font color=#447700>!***  BE CERTAIN THAT THE 2-M THETA IS BRACKETED BY<a name='1130'></font>
      <font color=#447700>!***  THE VALUES AT THE SURFACE AND LOWEST MODEL LEVEL.<a name='1131'></font>
      IF ((TH1D(I)&gt;THGB(I) .AND. (TH2(I)&lt;THGB(I) .OR. TH2(I)&gt;TH1D(I))) .OR. &amp;<a name='1132'>
          (TH1D(I)&lt;THGB(I) .AND. (TH2(I)&gt;THGB(I) .OR. TH2(I)&lt;TH1D(I)))) THEN<a name='1133'>
          TH2(I)=THGB(I) + 2.*(TH1D(I)-THGB(I))/ZA(I)<a name='1134'>
      ENDIF<a name='1135'>
      T2(I)=TH2(I)*(PSFC(I)/100.)**ROVCP<a name='1136'>
<a name='1137'>
      Q2(I)=QSFCMR(I)+(QV1D(I)-QSFCMR(I))*PSIQ2/PSIQ<a name='1138'>
      <font color=#447700>!***  BE CERTAIN THAT THE 2-M MIXING RATIO IS BRACKETED BY<a name='1139'></font>
      <font color=#447700>!***  THE VALUES AT THE SURFACE AND LOWEST MODEL LEVEL.<a name='1140'></font>
      IF ((QV1D(I)&gt;QSFCMR(I) .AND. (Q2(I)&lt;QSFCMR(I) .OR. Q2(I)&gt;QV1D(I))) .OR. &amp;<a name='1141'>
          (QV1D(I)&lt;QSFCMR(I) .AND. (Q2(I)&gt;QSFCMR(I) .OR. Q2(I)&lt;QV1D(I)))) THEN<a name='1142'>
          Q2(I)=QSFCMR(I) + 2.*(QV1D(I)-QSFCMR(I))/ZA(I)<a name='1143'>
      ENDIF<a name='1144'>
<a name='1145'>
      <font color=#447700>!CHECK FOR CONVERGENCE<a name='1146'></font>
      IF (ITER .GE. 2) THEN<a name='1147'>
         <font color=#447700>!IF (ABS(OLDUST-UST(I)) .lt. 0.01) THEN<a name='1148'></font>
         IF (ABS(OLDTST-MOL(I)) .lt. 0.01) THEN<a name='1149'>
            ITER = ITER+ITMAX<a name='1150'>
         ENDIF<a name='1151'>
<a name='1152'>
         <font color=#447700>!IF () THEN<a name='1153'></font>
         <font color=#447700>!  print*,"ITER:",ITER<a name='1154'></font>
         <font color=#447700>!  write(*,1001)"REGIME:",REGIME(I)," z/L:",ZOL(I)," U*:",UST(I)," Tstar:",MOL(I)<a name='1155'></font>
         <font color=#447700>!  write(*,1002)"PSIM:",PSIM(I)," PSIH:",PSIH(I)," W*:",WSTAR(I)," DTHV:",THV1D(I)-THVGB(I)<a name='1156'></font>
         <font color=#447700>!  write(*,1003)"CPM:",CPM(I)," RHO1D:",RHO1D(I)," L:",ZOL(I)/ZA(I)," DTH:",TH1D(I)-THGB(I)<a name='1157'></font>
         <font color=#447700>!  write(*,1004)"Z0/Zt:",zratio(I)," Z0:",ZNTstoch(I)," Zt:",z_t(I)," za:",za(I)<a name='1158'></font>
         <font color=#447700>!  write(*,1005)"Re:",restar," MAVAIL:",MAVAIL(I)," QSFC(I):",QSFC(I)," QVSH(I):",QVSH(I)<a name='1159'></font>
         <font color=#447700>!  print*,"VISC=",VISC," Z0:",ZNTstoch(I)," T1D(i):",T1D(i)<a name='1160'></font>
         <font color=#447700>!  write(*,*)"============================================="<a name='1161'></font>
         <font color=#447700>!ENDIF<a name='1162'></font>
      ENDIF<a name='1163'>
<a name='1164'>
      ITER = ITER + 1<a name='1165'>
<a name='1166'>
   ENDDO  <font color=#447700>! end ITERATION-loop<a name='1167'></font>
<a name='1168'>
 ENDDO     <font color=#447700>! end i-loop<a name='1169'></font>
<a name='1170'>
 1000   format(A,F6.1, A,f6.1, A,f5.1, A,f7.1)<a name='1171'>
 1001   format(A,F2.0, A,f10.4,A,f5.3, A,f11.5)<a name='1172'>
 1002   format(A,f7.2, A,f7.2, A,f7.2, A,f10.3)<a name='1173'>
 1003   format(A,f7.2, A,f7.2, A,f10.3,A,f10.3)<a name='1174'>
 1004   format(A,f11.3,A,f9.7, A,f9.7, A,f6.2, A,f10.3)<a name='1175'>
 1005   format(A,f9.2,A,f6.4,A,f7.4,A,f7.4)<a name='1176'>
<a name='1177'>
      <font color=#447700>!----------------------------------------------------------<a name='1178'></font>
      <font color=#447700>!  COMPUTE SURFACE HEAT AND MOISTURE FLUXES<a name='1179'></font>
      <font color=#447700>!----------------------------------------------------------<a name='1180'></font>
 DO I=its,ite<a name='1181'>
<a name='1182'>
   IF (ISFFLX .LT. 1) THEN                                                <a name='1183'>
<a name='1184'>
       QFX(i)  = 0.                                                              <a name='1185'>
       HFX(i)  = 0.    <a name='1186'>
       FLHC(I) = 0.                                                             <a name='1187'>
       FLQC(I) = 0.                                                             <a name='1188'>
       LH(I)   = 0.                                                             <a name='1189'>
       CHS(I)  = 0.                                                             <a name='1190'>
       CH(I)   = 0.                                                             <a name='1191'>
       CHS2(i) = 0.                                                              <a name='1192'>
       CQS2(i) = 0.                                                              <a name='1193'>
       IF(PRESENT(ck)  .and. PRESENT(cd) .and. &amp;<a name='1194'>
         &amp;PRESENT(cka) .and. PRESENT(cda)) THEN<a name='1195'>
           Ck(I) = 0.<a name='1196'>
           Cd(I) = 0.<a name='1197'>
           Cka(I)= 0.<a name='1198'>
           Cda(I)= 0.<a name='1199'>
       ENDIF<a name='1200'>
   ELSE<a name='1201'>
<a name='1202'>
      PSIX=GZ1OZ0(I)-PSIM(I)<a name='1203'>
      PSIX10=GZ10OZ0(I)-PSIM10(I)<a name='1204'>
<a name='1205'>
      PSIT=MAX(LOG((ZA(I)+z_t(i))/z_t(i))-PSIH(I) ,2.0)<a name='1206'>
      PSIT2=MAX(LOG((2.0+z_t(i))/z_t(i))-PSIH2(I) ,2.0)        <a name='1207'>
      PSIT10=MAX(LOG((10.0+z_t(i))/z_t(i))-PSIH10(I) ,2.0)<a name='1208'>
<a name='1209'>
      PSIQ=MAX(LOG((za(i)+z_q(i))/z_q(I))-PSIH(I) ,2.0)   <a name='1210'>
      PSIQ2=MAX(LOG((2.0+z_q(i))/z_q(I))-PSIH2(I) ,2.0) <a name='1211'>
      PSIQ10=MAX(LOG((10.0+z_q(i))/z_q(I))-PSIH10(I) ,2.0)<a name='1212'>
<a name='1213'>
      IF((XLAND(I)-1.5).LT.0)THEN <font color=#447700>!LAND Only  <a name='1214'></font>
         IF ( IZ0TLND .EQ. 4 ) THEN<a name='1215'>
            CALL <A href='../../html_code/phys/module_sf_mynn.F.html#PAN_ETAL_1994'>Pan_etal_1994</A><A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY1D_MYNN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PAN_ETAL_1994_2">(PSIQ,PSIQ2,UST(I),PSIH(I),PSIH2(I),&amp;<a name='1216'>
                       &amp; KARMAN,ZA(I))<a name='1217'>
         ENDIF<a name='1218'>
      ENDIF<a name='1219'>
<a name='1220'>
      <font color=#447700>!------------------------------------------<a name='1221'></font>
      <font color=#447700>! CALCULATE THE EXCHANGE COEFFICIENTS FOR HEAT (FLHC)<a name='1222'></font>
      <font color=#447700>! AND MOISTURE (FLQC)<a name='1223'></font>
      <font color=#447700>!------------------------------------------<a name='1224'></font>
      FLQC(I)=RHO1D(I)*MAVAIL(I)*UST(I)*KARMAN/PSIQ<a name='1225'>
      FLHC(I)=RHO1D(I)*CPM(I)*UST(I)*KARMAN/PSIT<a name='1226'>
      <font color=#447700>!OLD WAY:<a name='1227'></font>
      <font color=#447700>!DTTHX=ABS(TH1D(I)-THGB(I))                                            <a name='1228'></font>
      <font color=#447700>!IF(DTTHX.GT.1.E-5)THEN                                                   <a name='1229'></font>
      <font color=#447700>!   FLHC(I)=CPM(I)*RHO1D(I)*UST(I)*MOL(I)/(TH1D(I)-THGB(I))          <a name='1230'></font>
      <font color=#447700>!ELSE                                                                     <a name='1231'></font>
      <font color=#447700>!   FLHC(I)=0.                                                             <a name='1232'></font>
      <font color=#447700>!ENDIF   <a name='1233'></font>
<a name='1234'>
      <font color=#447700>!----------------------------------<a name='1235'></font>
      <font color=#447700>! COMPUTE SURFACE MOISTURE FLUX:<a name='1236'></font>
      <font color=#447700>!----------------------------------<a name='1237'></font>
      QFX(I)=FLQC(I)*(QSFCMR(I)-QV1D(I))          <a name='1238'>
      <font color=#447700>!JOE: QFX(I)=MAX(QFX(I),0.)   !originally did not allow neg QFX           <a name='1239'></font>
      QFX(I)=MAX(QFX(I),-0.02)      <font color=#447700>!allows small neg QFX, like MYJ  <a name='1240'></font>
      LH(I)=XLV*QFX(I)<a name='1241'>
<a name='1242'>
      <font color=#447700>!----------------------------------<a name='1243'></font>
      <font color=#447700>! COMPUTE SURFACE HEAT FLUX:<a name='1244'></font>
      <font color=#447700>!----------------------------------<a name='1245'></font>
      IF(XLAND(I)-1.5.GT.0.)THEN      <font color=#447700>!WATER                                           <a name='1246'></font>
         HFX(I)=FLHC(I)*(THGB(I)-TH1D(I))                                <a name='1247'>
         IF ( PRESENT(ISFTCFLX) ) THEN<a name='1248'>
            IF ( ISFTCFLX.NE.0 ) THEN<a name='1249'>
               <font color=#447700>! AHW: add dissipative heating term<a name='1250'></font>
               HFX(I)=HFX(I)+RHO1D(I)*USTM(I)*USTM(I)*WSPDI(I)<a name='1251'>
            ENDIF<a name='1252'>
         ENDIF<a name='1253'>
      ELSEIF(XLAND(I)-1.5.LT.0.)THEN  <font color=#447700>!LAND                               <a name='1254'></font>
         HFX(I)=FLHC(I)*(THGB(I)-TH1D(I))                                <a name='1255'>
         HFX(I)=MAX(HFX(I),-250.)                                       <a name='1256'>
      ENDIF<a name='1257'>
<a name='1258'>
      <font color=#447700>!CHS(I)=UST(I)*KARMAN/(ALOG(KARMAN*UST(I)*ZA(I) &amp;<a name='1259'></font>
      <font color=#447700>!       /XKA+ZA(I)/ZL)-PSIH(I))<a name='1260'></font>
<a name='1261'>
      CHS(I)=UST(I)*KARMAN/PSIT<a name='1262'>
<a name='1263'>
      <font color=#447700>! The exchange coefficient for cloud water is assumed to be the <a name='1264'></font>
      <font color=#447700>! same as that for heat. CH is multiplied by WSPD.<a name='1265'></font>
<a name='1266'>
      <font color=#447700>!ch(i)=chs(i)<a name='1267'></font>
      ch(i)=flhc(i)/( cpm(i)*RHO1D(i) )<a name='1268'>
<a name='1269'>
      <font color=#447700>!THESE ARE USED FOR 2-M DIAGNOSTICS ONLY<a name='1270'></font>
      CQS2(I)=UST(I)*KARMAN/PSIQ2<a name='1271'>
      CHS2(I)=UST(I)*KARMAN/PSIT2<a name='1272'>
<a name='1273'>
      IF(PRESENT(ck)  .and. PRESENT(cd) .and. &amp;<a name='1274'>
        &amp;PRESENT(cka) .and. PRESENT(cda)) THEN<a name='1275'>
         Ck(I)=(karman/psix10)*(karman/psiq10)<a name='1276'>
         Cd(I)=(karman/psix10)*(karman/psix10)<a name='1277'>
         Cka(I)=(karman/psix)*(karman/psiq)<a name='1278'>
         Cda(I)=(karman/psix)*(karman/psix)<a name='1279'>
      ENDIF<a name='1280'>
<a name='1281'>
   ENDIF <font color=#447700>!end ISFFLX option<a name='1282'></font>
<a name='1283'>
   IF ( wrf_at_debug_level(3000) ) THEN<a name='1284'>
      yesno = 0<a name='1285'>
      IF (HFX(I) &gt; 1200. .OR. HFX(I) &lt; -500.)THEN<a name='1286'>
            print*,"SUSPICIOUS VALUES IN MYNN SFCLAYER",&amp;<a name='1287'>
            ITER-ITMAX," ITERATIONS",I,J, "HFX: ",HFX(I)<a name='1288'>
            yesno = 1<a name='1289'>
      ENDIF<a name='1290'>
      IF (LH(I)  &gt; 1200. .OR. LH(I)  &lt; -500.)THEN<a name='1291'>
            print*,"SUSPICIOUS VALUES IN MYNN SFCLAYER",&amp;<a name='1292'>
            ITER-ITMAX," ITERATIONS",I,J, "LH: ",LH(I)<a name='1293'>
            yesno = 1<a name='1294'>
      ENDIF<a name='1295'>
      IF (UST(I) &lt; 0.0 .OR. UST(I) &gt; 4.0 )THEN<a name='1296'>
            print*,"SUSPICIOUS VALUES IN MYNN SFCLAYER",&amp;                                                                     <a name='1297'>
            ITER-ITMAX," ITERATIONS",I,J, "UST: ",UST(I)<a name='1298'>
            yesno = 1<a name='1299'>
      ENDIF<a name='1300'>
      IF (WSTAR(I)&lt;0.0 .OR. WSTAR(I) &gt; 6.0)THEN<a name='1301'>
            print*,"SUSPICIOUS VALUES IN MYNN SFCLAYER",&amp;<a name='1302'>
            ITER-ITMAX," ITERATIONS",I,J, "WSTAR: ",WSTAR(I)<a name='1303'>
            yesno = 1<a name='1304'>
      ENDIF<a name='1305'>
      IF (RHO1D(I)&lt;0.0 .OR. RHO1D(I) &gt; 1.6 )THEN<a name='1306'>
            print*,"SUSPICIOUS VALUES IN MYNN SFCLAYER",&amp;<a name='1307'>
            ITER-ITMAX," ITERATIONS",I,J, "rho: ",RHO1D(I)<a name='1308'>
            yesno = 1<a name='1309'>
      ENDIF<a name='1310'>
      IF (QSFC(I)*1000. &lt;0.0 .OR. QSFC(I)*1000. &gt;40.)THEN<a name='1311'>
            print*,"SUSPICIOUS VALUES IN MYNN SFCLAYER",&amp;<a name='1312'>
            ITER-ITMAX," ITERATIONS",I,J, "QSFC: ",QSFC(I)<a name='1313'>
            yesno = 1<a name='1314'>
      ENDIF<a name='1315'>
      IF (PBLH(I)&lt;0. .OR. PBLH(I)&gt;6000.)THEN<a name='1316'>
            print*,"SUSPICIOUS VALUES IN MYNN SFCLAYER",&amp;                                                              <a name='1317'>
            ITER-ITMAX," ITERATIONS",I,J, "PBLH: ",PBLH(I)<a name='1318'>
            yesno = 1<a name='1319'>
      ENDIF<a name='1320'>
<a name='1321'>
      IF (yesno == 1) THEN<a name='1322'>
        print*," OTHER INFO:"<a name='1323'>
        write(*,1001)"REGIME:",REGIME(I)," z/L:",ZOL(I)," U*:",UST(I),&amp;<a name='1324'>
              " Tstar:",MOL(I)<a name='1325'>
        write(*,1002)"PSIM:",PSIM(I)," PSIH:",PSIH(I)," W*:",WSTAR(I),&amp;<a name='1326'>
              " DTHV:",THV1D(I)-THVGB(I)<a name='1327'>
        write(*,1003)"CPM:",CPM(I)," RHO1D:",RHO1D(I)," L:",&amp;<a name='1328'>
              ZOL(I)/ZA(I)," DTH:",TH1D(I)-THGB(I)<a name='1329'>
        write(*,1004)"Z0/Zt:",zratio(I)," Z0:",ZNTstoch(I)," Zt:",z_t(I),&amp;<a name='1330'>
              " za:",za(I)<a name='1331'>
        write(*,1005)"Re:",restar," MAVAIL:",MAVAIL(I)," QSFC(I):",&amp;<a name='1332'>
              QSFC(I)," QVSH(I):",QVSH(I)<a name='1333'>
        print*,"PSIX=",PSIX," Z0:",ZNTstoch(I)," T1D(i):",T1D(i)<a name='1334'>
        write(*,*)"============================================="<a name='1335'>
      ENDIF<a name='1336'>
   ENDIF<a name='1337'>
<a name='1338'>
 ENDDO <font color=#447700>!end i-loop<a name='1339'></font>
<a name='1340'>
END SUBROUTINE SFCLAY1D_mynn<a name='1341'>
<font color=#447700>!-------------------------------------------------------------------          <a name='1342'></font>
<A NAME='ZILITINKEVICH_1995'><A href='../../html_code/phys/module_sf_mynn.F.html#ZILITINKEVICH_1995' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1343'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>zilitinkevich_1995</font>(Z_0,Zt,Zq,restar,ustar,KARMAN,&amp; <A href='../../call_to/ZILITINKEVICH_1995.html' TARGET='index'>3</A><a name='1344'>
       &amp; landsea,IZ0TLND2,spp_pbl,rstoch)<a name='1345'>
<a name='1346'>
       <font color=#447700>! This subroutine returns the thermal and moisture roughness lengths<a name='1347'></font>
       <font color=#447700>! from Zilitinkevich (1995) and Zilitinkevich et al. (2001) over<a name='1348'></font>
       <font color=#447700>! land and water, respectively. <a name='1349'></font>
       <font color=#447700>!<a name='1350'></font>
       <font color=#447700>! MODS:<a name='1351'></font>
       <font color=#447700>! 20120705 : added IZ0TLND option. Note: This option was designed<a name='1352'></font>
       <font color=#447700>!            to work with the Noah LSM and may be specific for that<a name='1353'></font>
       <font color=#447700>!            LSM only. Tests with RUC LSM showed no improvements. <a name='1354'></font>
<a name='1355'>
       IMPLICIT NONE<a name='1356'>
       REAL, INTENT(IN) :: Z_0,restar,ustar,KARMAN,landsea<a name='1357'>
       INTEGER, OPTIONAL, INTENT(IN)::  IZ0TLND2<a name='1358'>
       REAL, INTENT(OUT) :: Zt,Zq<a name='1359'>
       REAL :: CZIL  <font color=#447700>!=0.100 in Chen et al. (1997)<a name='1360'></font>
                     <font color=#447700>!=0.075 in Zilitinkevich (1995)<a name='1361'></font>
                     <font color=#447700>!=0.500 in Lemone et al. (2008)<a name='1362'></font>
       INTEGER,  INTENT(IN)  ::    spp_pbl<a name='1363'>
       REAL,     INTENT(IN)  ::    rstoch<a name='1364'>
<a name='1365'>
<a name='1366'>
       IF (landsea-1.5 .GT. 0) THEN    <font color=#447700>!WATER<a name='1367'></font>
<a name='1368'>
          <font color=#447700>!THIS IS BASED ON Zilitinkevich, Grachev, and Fairall (2001;<a name='1369'></font>
          <font color=#447700>!Their equations 15 and 16).<a name='1370'></font>
          IF (restar .LT. 0.1) THEN<a name='1371'>
             Zt = Z_0*EXP(KARMAN*2.0)<a name='1372'>
             Zt = MIN( Zt, 6.0e-5)<a name='1373'>
             Zt = MAX( Zt, 2.0e-9)<a name='1374'>
             Zq = Z_0*EXP(KARMAN*3.0)<a name='1375'>
             Zq = MIN( Zq, 6.0e-5)<a name='1376'>
             Zq = MAX( Zq, 2.0e-9)<a name='1377'>
          ELSE<a name='1378'>
             Zt = Z_0*EXP(-KARMAN*(4.0*SQRT(restar)-3.2))<a name='1379'>
             Zt = MIN( Zt, 6.0e-5)<a name='1380'>
             Zt = MAX( Zt, 2.0e-9)<a name='1381'>
             Zq = Z_0*EXP(-KARMAN*(4.0*SQRT(restar)-4.2))<a name='1382'>
             Zq = MIN( Zt, 6.0e-5)<a name='1383'>
             Zq = MAX( Zt, 2.0e-9)<a name='1384'>
          ENDIF<a name='1385'>
<a name='1386'>
       ELSE                             <font color=#447700>!LAND<a name='1387'></font>
<a name='1388'>
          <font color=#447700>!Option to modify CZIL according to Chen &amp; Zhang, 2009<a name='1389'></font>
          IF ( IZ0TLND2 .EQ. 1 ) THEN<a name='1390'>
             CZIL = 10.0 ** ( -0.40 * ( Z_0 / 0.07 ) )<a name='1391'>
          ELSE<a name='1392'>
             CZIL = 0.10<a name='1393'>
          END IF<a name='1394'>
<a name='1395'>
          Zt = Z_0*EXP(-KARMAN*CZIL*SQRT(restar))<a name='1396'>
          Zt = MIN( Zt, Z_0/2.)<a name='1397'>
<a name='1398'>
          Zq = Z_0*EXP(-KARMAN*CZIL*SQRT(restar))<a name='1399'>
          Zq = MIN( Zq, Z_0/2.)<a name='1400'>
<a name='1401'>
<font color=#447700>! perturb thermal and moisture roughness lenth by +/-50%<a name='1402'></font>
<font color=#447700>! uses same perturbation pattern for perturbing cloud fraction <a name='1403'></font>
<font color=#447700>! and turbulent mixing length (module_sf_mynn.F), but <a name='1404'></font>
<font color=#447700>! twice the amplitude; <a name='1405'></font>
<font color=#447700>! multiplication with -1.0 anticorrelates patterns<a name='1406'></font>
          if (spp_pbl==1) then<a name='1407'>
             Zt = Zt + Zt * 2.0 * rstoch<a name='1408'>
             Zt = MAX(Zt, 0.001)<a name='1409'>
             Zq = Zt<a name='1410'>
          endif<a name='1411'>
<a name='1412'>
       ENDIF<a name='1413'>
                   <a name='1414'>
       return<a name='1415'>
<a name='1416'>
   END SUBROUTINE zilitinkevich_1995<a name='1417'>
<font color=#447700>!--------------------------------------------------------------------<a name='1418'></font>
<A NAME='PAN_ETAL_1994'><A href='../../html_code/phys/module_sf_mynn.F.html#PAN_ETAL_1994' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1419'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>Pan_etal_1994</font>(PSIQ,PSIQ2,ustar,psih,psih2,KARMAN,Z1) <A href='../../call_to/PAN_ETAL_1994.html' TARGET='index'>2</A><a name='1420'>
<a name='1421'>
       <font color=#447700>! This subroutine returns the resistance (PSIQ) for moisture<a name='1422'></font>
       <font color=#447700>! exchange. This is a modified form originating from Pan et al. <a name='1423'></font>
       <font color=#447700>! (1994) but modified according to tests in both the RUC model <a name='1424'></font>
       <font color=#447700>! and WRF-ARW. Note that it is very similar to Carlson and<a name='1425'></font>
       <font color=#447700>! Boland (1978) model (include below in comments) but has an<a name='1426'></font>
       <font color=#447700>! extra molecular layer (a third layer) instead of two layers. <a name='1427'></font>
<a name='1428'>
       IMPLICIT NONE<a name='1429'>
       REAL, INTENT(IN) :: Z1,ustar,KARMAN,psih,psih2<a name='1430'>
       REAL, INTENT(OUT) :: psiq,psiq2<a name='1431'>
       REAL, PARAMETER :: Cpan=1.0 <font color=#447700>!was 20.8 in Pan et al 1994<a name='1432'></font>
       REAL, PARAMETER :: ZL=0.01  <a name='1433'>
       REAL, PARAMETER :: ZMUs=0.2E-3<a name='1434'>
       REAL, PARAMETER :: XKA = 2.4E-5<a name='1435'>
<a name='1436'>
         <font color=#447700>!PAN et al. (1994): 3-layer model, as in paper:<a name='1437'></font>
         <font color=#447700>!ZMU = Cpan*XKA/(KARMAN*UST(I)) <a name='1438'></font>
         <font color=#447700>!PSIQ =MAX(KARMAN*ustar*ZMU/XKA + LOG((KARMAN*ustar*ZL + XKA)/XKA + &amp;<a name='1439'></font>
         <font color=#447700>!     &amp; Z1/ZL) - PSIH,2.0)<a name='1440'></font>
         <font color=#447700>!PSIQ2=MAX(KARMAN*ustar*ZMU/XKA + LOG((KARMAN*ustar*ZL + XKA)/XKA + &amp;<a name='1441'></font>
         <font color=#447700>!     &amp; 2./ZL) - PSIH2,2.0)                                       <a name='1442'></font>
         <font color=#447700>!MODIFIED FORM:<a name='1443'></font>
         PSIQ =MAX(KARMAN*ustar*ZMUs/XKA + LOG((KARMAN*ustar*Z1)/XKA + &amp;<a name='1444'>
              &amp; Z1/ZL) - PSIH,2.0)<a name='1445'>
         PSIQ2=MAX(KARMAN*ustar*ZMUs/XKA + LOG((KARMAN*ustar*2.0)/XKA + &amp;<a name='1446'>
              &amp; 2./ZL) - PSIH2,2.0)<a name='1447'>
<a name='1448'>
         <font color=#447700>!CARLSON AND BOLAND (1978): 2-layer model<a name='1449'></font>
         <font color=#447700>!PSIQ =MAX(LOG(KARMAN*ustar*Z1/XKA + Z1/ZL)-PSIH  ,2.0)<a name='1450'></font>
         <font color=#447700>!PSIQ2=MAX(LOG(KARMAN*ustar*2./XKA + 2./ZL)-PSIH2 ,2.0)<a name='1451'></font>
<a name='1452'>
    END SUBROUTINE Pan_etal_1994<a name='1453'>
<font color=#447700>!--------------------------------------------------------------<a name='1454'></font>
<A NAME='DAVIS_ETAL_2008'><A href='../../html_code/phys/module_sf_mynn.F.html#DAVIS_ETAL_2008' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1455'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>davis_etal_2008</font>(Z_0,ustar) <A href='../../call_to/DAVIS_ETAL_2008.html' TARGET='index'>1</A><a name='1456'>
<a name='1457'>
    <font color=#447700>!a.k.a. : Donelan et al. (2004)<a name='1458'></font>
    <font color=#447700>!This formulation for roughness length was designed to match <a name='1459'></font>
    <font color=#447700>!the labratory experiments of Donelan et al. (2004).<a name='1460'></font>
    <font color=#447700>!This is an update version from Davis et al. 2008, which<a name='1461'></font>
    <font color=#447700>!corrects a small-bias in Z_0 (AHW real-time 2012).<a name='1462'></font>
<a name='1463'>
       IMPLICIT NONE<a name='1464'>
       REAL, INTENT(IN)  :: ustar<a name='1465'>
       REAL, INTENT(OUT)  :: Z_0<a name='1466'>
       REAL :: ZW, ZN1, ZN2<a name='1467'>
       REAL, PARAMETER :: G=9.81, OZO=1.59E-5<a name='1468'>
<a name='1469'>
       <font color=#447700>!OLD FORM: Z_0 = 10.*EXP(-10./(ustar**(1./3.)))<a name='1470'></font>
       <font color=#447700>!NEW FORM:<a name='1471'></font>
<a name='1472'>
       ZW  = MIN((ustar/1.06)**(0.3),1.0)<a name='1473'>
       ZN1 = 0.011*ustar*ustar/G + OZO<a name='1474'>
       ZN2 = 10.*exp(-9.5*ustar**(-.3333)) + &amp;<a name='1475'>
             0.11*1.5E-5/AMAX1(ustar,0.01)<a name='1476'>
       Z_0 = (1.0-ZW) * ZN1 + ZW * ZN2<a name='1477'>
<a name='1478'>
       Z_0 = MAX( Z_0, 1.27e-7)  <font color=#447700>!These max/mins were suggested by<a name='1479'></font>
       Z_0 = MIN( Z_0, 2.85e-3)  <font color=#447700>!Davis et al. (2008)<a name='1480'></font>
                   <a name='1481'>
       return<a name='1482'>
<a name='1483'>
   END SUBROUTINE davis_etal_2008<a name='1484'>
<font color=#447700>!--------------------------------------------------------------------<a name='1485'></font>
<A NAME='TAYLOR_YELLAND_2001'><A href='../../html_code/phys/module_sf_mynn.F.html#TAYLOR_YELLAND_2001' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1486'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>Taylor_Yelland_2001</font>(Z_0,ustar,wsp10) <A href='../../call_to/TAYLOR_YELLAND_2001.html' TARGET='index'>1</A><a name='1487'>
<a name='1488'>
    <font color=#447700>!This formulation for roughness length was designed account for <a name='1489'></font>
    <font color=#447700>!wave steepness.<a name='1490'></font>
<a name='1491'>
       IMPLICIT NONE<a name='1492'>
       REAL, INTENT(IN)  :: ustar,wsp10<a name='1493'>
       REAL, INTENT(OUT) :: Z_0<a name='1494'>
       REAL, parameter  :: g=9.81, pi=3.14159265<a name='1495'>
       REAL :: hs, Tp, Lp<a name='1496'>
<a name='1497'>
       <font color=#447700>!hs is the significant wave height<a name='1498'></font>
        hs = 0.0248*(wsp10**2.)<a name='1499'>
       <font color=#447700>!Tp dominant wave period<a name='1500'></font>
        Tp = 0.729*MAX(wsp10,0.1)<a name='1501'>
       <font color=#447700>!Lp is the wavelength of the dominant wave<a name='1502'></font>
        Lp = g*Tp**2/(2*pi)<a name='1503'>
<a name='1504'>
       Z_0 = 1200.*hs*(hs/Lp)**4.5<a name='1505'>
       Z_0 = MAX( Z_0, 1.27e-7)  <font color=#447700>!These max/mins were suggested by<a name='1506'></font>
       Z_0 = MIN( Z_0, 2.85e-3)  <font color=#447700>!Davis et al. (2008)<a name='1507'></font>
                   <a name='1508'>
       return<a name='1509'>
<a name='1510'>
   END SUBROUTINE Taylor_Yelland_2001<a name='1511'>
<font color=#447700>!--------------------------------------------------------------------<a name='1512'></font>
<A NAME='CHARNOCK_1955'><A href='../../html_code/phys/module_sf_mynn.F.html#CHARNOCK_1955' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1513'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>charnock_1955</font>(Z_0,ustar,wsp10,visc,zu) <A href='../../call_to/CHARNOCK_1955.html' TARGET='index'>3</A><a name='1514'>
 <a name='1515'>
    <font color=#447700>!This version of Charnock's relation employs a varying<a name='1516'></font>
    <font color=#447700>!Charnock parameter, similar to COARE3.0 [Fairall et al. (2003)].<a name='1517'></font>
    <font color=#447700>!The Charnock parameter CZC is varied from .011 to .018 <a name='1518'></font>
    <font color=#447700>!between 10-m wsp = 10 and 18. <a name='1519'></font>
<a name='1520'>
       IMPLICIT NONE<a name='1521'>
       REAL, INTENT(IN)  :: ustar, visc, wsp10, zu<a name='1522'>
       REAL, INTENT(OUT) :: Z_0<a name='1523'>
       REAL, PARAMETER   :: G=9.81, CZO2=0.011<a name='1524'>
       REAL              :: CZC    <font color=#447700>!variable charnock "constant"   <a name='1525'></font>
       REAL              :: wsp10m <font color=#447700>! logarithmically calculated 10 m<a name='1526'></font>
<a name='1527'>
       wsp10m = wsp10*log(10./1e-4)/log(zu/1e-4)<a name='1528'>
       CZC = CZO2 + 0.007*MIN(MAX((wsp10m-10.)/8., 0.), 1.0)<a name='1529'>
<a name='1530'>
       Z_0 = CZC*ustar*ustar/G + (0.11*visc/MAX(ustar,0.05))<a name='1531'>
       Z_0 = MAX( Z_0, 1.27e-7)  <font color=#447700>!These max/mins were suggested by<a name='1532'></font>
       Z_0 = MIN( Z_0, 2.85e-3)  <font color=#447700>!Davis et al. (2008)<a name='1533'></font>
<a name='1534'>
       return<a name='1535'>
<a name='1536'>
   END SUBROUTINE charnock_1955<a name='1537'>
<font color=#447700>!--------------------------------------------------------------------<a name='1538'></font>
<A NAME='EDSON_ETAL_2013'><A href='../../html_code/phys/module_sf_mynn.F.html#EDSON_ETAL_2013' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1539'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>edson_etal_2013</font>(Z_0,ustar,wsp10,visc,zu) <A href='../../call_to/EDSON_ETAL_2013.html' TARGET='index'>3</A><a name='1540'>
<a name='1541'>
     <font color=#447700>!This version of Charnock's relation employs a varying<a name='1542'></font>
     <font color=#447700>!Charnock parameter, taken from COARE 3.5 [Edson et al. (2001, JPO)].<a name='1543'></font>
     <font color=#447700>!The Charnock parameter CZC is varied from about .005 to .028<a name='1544'></font>
     <font color=#447700>!between 10-m wind speeds of 6 and 19 m/s.<a name='1545'></font>
<a name='1546'>
       IMPLICIT NONE<a name='1547'>
       REAL, INTENT(IN)  :: ustar, visc, wsp10, zu<a name='1548'>
       REAL, INTENT(OUT) :: Z_0<a name='1549'>
       REAL, PARAMETER   :: G=9.81<a name='1550'>
       REAL, PARAMETER   :: m=0.017, b=-0.005<a name='1551'>
       REAL              :: CZC    <font color=#447700>! variable charnock "constant"<a name='1552'></font>
       REAL              :: wsp10m <font color=#447700>! logarithmically calculated 10 m<a name='1553'></font>
<a name='1554'>
       wsp10m = wsp10*log(10/1e-4)/log(zu/1e-4)<a name='1555'>
       wsp10m = MIN(19., wsp10m)<a name='1556'>
       CZC    = m*wsp10m + b<a name='1557'>
       CZC    = MAX(CZC, 0.0)<a name='1558'>
<a name='1559'>
       Z_0 = CZC*ustar*ustar/G + (0.11*visc/MAX(ustar,0.07))<a name='1560'>
       Z_0 = MAX( Z_0, 1.27e-7)  <font color=#447700>!These max/mins were suggested by<a name='1561'></font>
       Z_0 = MIN( Z_0, 2.85e-3)  <font color=#447700>!Davis et al. (2008)<a name='1562'></font>
<a name='1563'>
       return<a name='1564'>
<a name='1565'>
   END SUBROUTINE edson_etal_2013<a name='1566'>
<font color=#447700>!--------------------------------------------------------------------<a name='1567'></font>
<A NAME='GARRATT_1992'><A href='../../html_code/phys/module_sf_mynn.F.html#GARRATT_1992' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1568'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>garratt_1992</font>(Zt,Zq,Z_0,Ren,landsea) <A href='../../call_to/GARRATT_1992.html' TARGET='index'>2</A><a name='1569'>
<a name='1570'>
    <font color=#447700>!This formulation for the thermal and moisture roughness lengths<a name='1571'></font>
    <font color=#447700>!(Zt and Zq) relates them to Z0 via the roughness Reynolds number (Ren).<a name='1572'></font>
    <font color=#447700>!This formula comes from Fairall et al. (2003). It is modified from<a name='1573'></font>
    <font color=#447700>!the original Garratt-Brutsaert model to better fit the COARE/HEXMAX<a name='1574'></font>
    <font color=#447700>!data. The formula for land uses a constant ratio (Z_0/7.4) taken<a name='1575'></font>
    <font color=#447700>!from Garratt (1992).<a name='1576'></font>
<a name='1577'>
       IMPLICIT NONE<a name='1578'>
       REAL, INTENT(IN)  :: Ren, Z_0,landsea<a name='1579'>
       REAL, INTENT(OUT) :: Zt,Zq<a name='1580'>
       REAL :: Rq<a name='1581'>
       REAL, PARAMETER  :: e=2.71828183<a name='1582'>
<a name='1583'>
       IF (landsea-1.5 .GT. 0) THEN    <font color=#447700>!WATER<a name='1584'></font>
<a name='1585'>
          Zt = Z_0*EXP(2.0 - (2.48*(Ren**0.25)))<a name='1586'>
          Zq = Z_0*EXP(2.0 - (2.28*(Ren**0.25)))<a name='1587'>
<a name='1588'>
          Zq = MIN( Zq, 5.5e-5)<a name='1589'>
          Zq = MAX( Zq, 2.0e-9)<a name='1590'>
          Zt = MIN( Zt, 5.5e-5)<a name='1591'>
          Zt = MAX( Zt, 2.0e-9) <font color=#447700>!same lower limit as ECMWF<a name='1592'></font>
       ELSE                            <font color=#447700>!LAND<a name='1593'></font>
          Zq = Z_0/(e**2.)      <font color=#447700>!taken from Garratt (1980,1992)<a name='1594'></font>
          Zt = Zq<a name='1595'>
       ENDIF<a name='1596'>
                   <a name='1597'>
       return<a name='1598'>
<a name='1599'>
    END SUBROUTINE garratt_1992<a name='1600'>
<font color=#447700>!--------------------------------------------------------------------<a name='1601'></font>
<A NAME='FAIRALL_ETAL_2003'><A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2003' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1602'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>fairall_etal_2003</font>(Zt,Zq,Ren,ustar,visc) <A href='../../call_to/FAIRALL_ETAL_2003.html' TARGET='index'>4</A><a name='1603'>
<a name='1604'>
    <font color=#447700>!This formulation for thermal and moisture roughness length (Zt and Zq)<a name='1605'></font>
    <font color=#447700>!as a function of the roughness Reynolds number (Ren) comes from the<a name='1606'></font>
    <font color=#447700>!COARE3.0 formulation, empirically derived from COARE and HEXMAX data<a name='1607'></font>
    <font color=#447700>![Fairall et al. (2003)]. Edson et al. (2004; JGR) suspected that this<a name='1608'></font>
    <font color=#447700>!relationship overestimated the scalar roughness lengths for low Reynolds<a name='1609'></font>
    <font color=#447700>!number flows, so an optional smooth flow relationship, taken from Garratt<a name='1610'></font>
    <font color=#447700>!(1992, p. 102), is available for flows with Ren &lt; 2.<a name='1611'></font>
    <font color=#447700>!<a name='1612'></font>
    <font color=#447700>!This is for use over water only.<a name='1613'></font>
<a name='1614'>
       IMPLICIT NONE<a name='1615'>
       REAL, INTENT(IN)  :: Ren,ustar,visc<a name='1616'>
       REAL, INTENT(OUT) :: Zt,Zq<a name='1617'>
<a name='1618'>
       IF (Ren .le. 2.) then<a name='1619'>
<a name='1620'>
          Zt = (5.5e-5)*(Ren**(-0.60))<a name='1621'>
          Zq = Zt<a name='1622'>
          <font color=#447700>!FOR SMOOTH SEAS, CAN USE GARRATT<a name='1623'></font>
          <font color=#447700>!Zq = 0.2*visc/MAX(ustar,0.1)<a name='1624'></font>
          <font color=#447700>!Zq = 0.3*visc/MAX(ustar,0.1)<a name='1625'></font>
<a name='1626'>
       ELSE<a name='1627'>
<a name='1628'>
          <font color=#447700>!FOR ROUGH SEAS, USE COARE<a name='1629'></font>
          Zt = (5.5e-5)*(Ren**(-0.60))<a name='1630'>
          Zq = Zt<a name='1631'>
<a name='1632'>
       ENDIF<a name='1633'>
<a name='1634'>
       Zt = MIN(Zt,1.0e-4)<a name='1635'>
       Zt = MAX(Zt,2.0e-9)<a name='1636'>
<a name='1637'>
       Zq = MIN(Zt,1.0e-4)<a name='1638'>
       Zq = MAX(Zt,2.0e-9)<a name='1639'>
<a name='1640'>
       return<a name='1641'>
<a name='1642'>
    END SUBROUTINE fairall_etal_2003<a name='1643'>
<font color=#447700>!--------------------------------------------------------------------<a name='1644'></font>
<A NAME='FAIRALL_ETAL_2014'><A href='../../html_code/phys/module_sf_mynn.F.html#FAIRALL_ETAL_2014' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1645'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>fairall_etal_2014</font>(Zt,Zq,Ren,ustar,visc,rstoch,spp_pbl) <A href='../../call_to/FAIRALL_ETAL_2014.html' TARGET='index'>4</A><a name='1646'>
<a name='1647'>
    <font color=#447700>!This formulation for thermal and moisture roughness length (Zt and Zq)<a name='1648'></font>
    <font color=#447700>!as a function of the roughness Reynolds number (Ren) comes from the<a name='1649'></font>
    <font color=#447700>!COARE 3.5/4.0 formulation, empirically derived from COARE and HEXMAX data<a name='1650'></font>
    <font color=#447700>![Fairall et al. (2014? coming soon, not yet published as of July 2014)].<a name='1651'></font>
    <font color=#447700>!This is for use over water only.<a name='1652'></font>
<a name='1653'>
       IMPLICIT NONE<a name='1654'>
       REAL, INTENT(IN)  :: Ren,ustar,visc,rstoch<a name='1655'>
       INTEGER, INTENT(IN):: spp_pbl<a name='1656'>
       REAL, INTENT(OUT) :: Zt,Zq<a name='1657'>
<a name='1658'>
       <font color=#447700>!Zt = (5.5e-5)*(Ren**(-0.60))<a name='1659'></font>
       Zt = MIN(1.6E-4, 5.8E-5/(Ren**0.72))<a name='1660'>
       Zq = Zt<a name='1661'>
<a name='1662'>
       IF (spp_pbl ==1) THEN<a name='1663'>
          Zt = MAX(Zt + Zt*2.0*rstoch,2.0e-9)<a name='1664'>
          Zq = MAX(Zt + Zt*2.0*rstoch,2.0e-9)<a name='1665'>
       ELSE<a name='1666'>
          Zt = MAX(Zt,2.0e-9)<a name='1667'>
          Zq = MAX(Zt,2.0e-9)<a name='1668'>
       ENDIF<a name='1669'>
<a name='1670'>
       return<a name='1671'>
<a name='1672'>
    END SUBROUTINE fairall_etal_2014<a name='1673'>
<font color=#447700>!--------------------------------------------------------------------<a name='1674'></font>
<A NAME='YANG_2008'><A href='../../html_code/phys/module_sf_mynn.F.html#YANG_2008' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1675'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>Yang_2008</font>(Z_0,Zt,Zq,ustar,tstar,qst,Ren,visc,landsea) <A href='../../call_to/YANG_2008.html' TARGET='index'>1</A><a name='1676'>
<a name='1677'>
    <font color=#447700>!This is a modified version of Yang et al (2002 QJRMS, 2008 JAMC) <a name='1678'></font>
    <font color=#447700>!and Chen et al (2010, J of Hydromet). Although it was originally <a name='1679'></font>
    <font color=#447700>!designed for arid regions with bare soil, it is modified <a name='1680'></font>
    <font color=#447700>!here to perform over a broader spectrum of vegetation.<a name='1681'></font>
    <font color=#447700>!<a name='1682'></font>
    <font color=#447700>!The original formulation relates the thermal roughness length (Zt) <a name='1683'></font>
    <font color=#447700>!to u* and T*:<a name='1684'></font>
    <font color=#447700>!  <a name='1685'></font>
    <font color=#447700>! Zt = ht * EXP(-beta*(ustar**0.5)*(ABS(tstar)**0.25))<a name='1686'></font>
    <font color=#447700>!<a name='1687'></font>
    <font color=#447700>!where ht = Renc*visc/ustar and the critical Reynolds number <a name='1688'></font>
    <font color=#447700>!(Renc) = 70. Beta was originally = 10 (2002 paper) but was revised <a name='1689'></font>
    <font color=#447700>!to 7.2 (in 2008 paper). Their form typically varies the<a name='1690'></font>
    <font color=#447700>!ratio Z0/Zt by a few orders of magnitude (1-1E4).<a name='1691'></font>
    <font color=#447700>!<a name='1692'></font>
    <font color=#447700>!This modified form uses beta = 1.5 and a variable Renc (function of Z_0),<a name='1693'></font>
    <font color=#447700>!so zt generally varies similarly to the Zilitinkevich form (with Czil = 0.1)<a name='1694'></font>
    <font color=#447700>!for very small or negative surface heat fluxes but can become close to the<a name='1695'></font>
    <font color=#447700>!Zilitinkevich with Czil = 0.2 for very large HFX (large negative T*).<a name='1696'></font>
    <font color=#447700>!Also, the exponent (0.25) on tstar was changed to 1.0, since we found<a name='1697'></font>
    <font color=#447700>!Zt was reduced too much for low-moderate positive heat fluxes.<a name='1698'></font>
    <font color=#447700>!<a name='1699'></font>
    <font color=#447700>!This should only be used over land!<a name='1700'></font>
<a name='1701'>
       IMPLICIT NONE<a name='1702'>
       REAL, INTENT(IN)  :: Z_0, Ren, ustar, tstar, qst, visc, landsea<a name='1703'>
       REAL              :: ht,     &amp;<font color=#447700>! roughness height at critical Reynolds number<a name='1704'></font>
                            tstar2, &amp;<font color=#447700>! bounded T*, forced to be non-positive<a name='1705'></font>
                            qstar2, &amp;<font color=#447700>! bounded q*, forced to be non-positive<a name='1706'></font>
                            Z_02,   &amp;<font color=#447700>! bounded Z_0 for variable Renc2 calc<a name='1707'></font>
                            Renc2    <font color=#447700>! variable Renc, function of Z_0<a name='1708'></font>
       REAL, INTENT(OUT) :: Zt,Zq<a name='1709'>
       REAL, PARAMETER  :: Renc=300., &amp; <font color=#447700>!old constant Renc<a name='1710'></font>
                           beta=1.5,  &amp; <font color=#447700>!important for diurnal variation<a name='1711'></font>
                           m=170.,    &amp; <font color=#447700>!slope for Renc2 function<a name='1712'></font>
                           b=691.       <font color=#447700>!y-intercept for Renc2 function<a name='1713'></font>
<a name='1714'>
       Z_02 = MIN(Z_0,0.5)<a name='1715'>
       Z_02 = MAX(Z_02,0.04)<a name='1716'>
       Renc2= b + m*log(Z_02)<a name='1717'>
       ht     = Renc2*visc/MAX(ustar,0.01)<a name='1718'>
       tstar2 = MIN(tstar, 0.0)<a name='1719'>
       qstar2 = MIN(qst,0.0)<a name='1720'>
<a name='1721'>
       Zt     = ht * EXP(-beta*(ustar**0.5)*(ABS(tstar2)**1.0))<a name='1722'>
       Zq     = ht * EXP(-beta*(ustar**0.5)*(ABS(qstar2)**1.0))<a name='1723'>
       <font color=#447700>!Zq     = Zt<a name='1724'></font>
<a name='1725'>
       Zt = MIN(Zt, Z_0/2.0)<a name='1726'>
       Zq = MIN(Zq, Z_0/2.0)<a name='1727'>
<a name='1728'>
       return<a name='1729'>
<a name='1730'>
    END SUBROUTINE Yang_2008<a name='1731'>
<font color=#447700>!--------------------------------------------------------------------<a name='1732'></font>
<A NAME='ANDREAS_2002'><A href='../../html_code/phys/module_sf_mynn.F.html#ANDREAS_2002' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1733'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>Andreas_2002</font>(Z_0,bvisc,ustar,Zt,Zq) <A href='../../call_to/ANDREAS_2002.html' TARGET='index'>1</A><a name='1734'>
<a name='1735'>
    <font color=#447700>! This is taken from Andreas (2002; J. of Hydromet) and <a name='1736'></font>
    <font color=#447700>! Andreas et al. (2005; BLM).<a name='1737'></font>
    <font color=#447700>!<a name='1738'></font>
    <font color=#447700>! This should only be used over snow/ice!<a name='1739'></font>
<a name='1740'>
       IMPLICIT NONE<a name='1741'>
       REAL, INTENT(IN)  :: Z_0, bvisc, ustar<a name='1742'>
       REAL, INTENT(OUT) :: Zt, Zq<a name='1743'>
       REAL :: Ren2, zntsno<a name='1744'>
<a name='1745'>
       REAL, PARAMETER  :: bt0_s=1.25,  bt0_t=0.149,  bt0_r=0.317,  &amp;<a name='1746'>
                           bt1_s=0.0,   bt1_t=-0.55,  bt1_r=-0.565, &amp;<a name='1747'>
                           bt2_s=0.0,   bt2_t=0.0,    bt2_r=-0.183<a name='1748'>
<a name='1749'>
       REAL, PARAMETER  :: bq0_s=1.61,  bq0_t=0.351,  bq0_r=0.396,  &amp;<a name='1750'>
                           bq1_s=0.0,   bq1_t=-0.628, bq1_r=-0.512, &amp;<a name='1751'>
                           bq2_s=0.0,   bq2_t=0.0,    bq2_r=-0.180<a name='1752'>
<a name='1753'>
      <font color=#447700>!Calculate zo for snow (Andreas et al. 2005, BLM)                                                                     <a name='1754'></font>
       zntsno = 0.135*bvisc/ustar + &amp;<a name='1755'>
               (0.035*(ustar*ustar)/9.8) * &amp;<a name='1756'>
               (5.*exp(-1.*(((ustar - 0.18)/0.1)*((ustar - 0.18)/0.1))) + 1.)                                                <a name='1757'>
       Ren2 = ustar*zntsno/bvisc<a name='1758'>
<a name='1759'>
       <font color=#447700>! Make sure that Re is not outside of the range of validity<a name='1760'></font>
       <font color=#447700>! for using their equations<a name='1761'></font>
       IF (Ren2 .gt. 1000.) Ren2 = 1000. <a name='1762'>
<a name='1763'>
       IF (Ren2 .le. 0.135) then<a name='1764'>
<a name='1765'>
          Zt = zntsno*EXP(bt0_s + bt1_s*LOG(Ren2) + bt2_s*LOG(Ren2)**2)<a name='1766'>
          Zq = zntsno*EXP(bq0_s + bq1_s*LOG(Ren2) + bq2_s*LOG(Ren2)**2)<a name='1767'>
<a name='1768'>
       ELSE IF (Ren2 .gt. 0.135 .AND. Ren2 .lt. 2.5) then<a name='1769'>
<a name='1770'>
          Zt = zntsno*EXP(bt0_t + bt1_t*LOG(Ren2) + bt2_t*LOG(Ren2)**2)<a name='1771'>
          Zq = zntsno*EXP(bq0_t + bq1_t*LOG(Ren2) + bq2_t*LOG(Ren2)**2)<a name='1772'>
<a name='1773'>
       ELSE<a name='1774'>
<a name='1775'>
          Zt = zntsno*EXP(bt0_r + bt1_r*LOG(Ren2) + bt2_r*LOG(Ren2)**2)<a name='1776'>
          Zq = zntsno*EXP(bq0_r + bq1_r*LOG(Ren2) + bq2_r*LOG(Ren2)**2)<a name='1777'>
<a name='1778'>
       ENDIF<a name='1779'>
<a name='1780'>
       return<a name='1781'>
<a name='1782'>
    END SUBROUTINE Andreas_2002<a name='1783'>
<font color=#447700>!--------------------------------------------------------------------<a name='1784'></font>
<A NAME='PSI_HOGSTROM_1996'><A href='../../html_code/phys/module_sf_mynn.F.html#PSI_HOGSTROM_1996' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1785'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>PSI_Hogstrom_1996</font>(psi_m, psi_h, zL, Zt, Z_0, Za)<a name='1786'>
<a name='1787'>
    <font color=#447700>! This subroutine returns the stability functions based off<a name='1788'></font>
    <font color=#447700>! of Hogstrom (1996).<a name='1789'></font>
<a name='1790'>
       IMPLICIT NONE<a name='1791'>
       REAL, INTENT(IN)  :: zL, Zt, Z_0, Za<a name='1792'>
       REAL, INTENT(OUT) :: psi_m, psi_h<a name='1793'>
       REAL  :: x, x0, y, y0, zmL, zhL<a name='1794'>
<a name='1795'>
       zmL = Z_0*zL/Za  <a name='1796'>
       zhL = Zt*zL/Za<a name='1797'>
<a name='1798'>
       IF (zL .gt. 0.) THEN  <font color=#447700>!STABLE (not well tested - seem large)<a name='1799'></font>
<a name='1800'>
          psi_m = -5.3*(zL - zmL)<a name='1801'>
          psi_h = -8.0*(zL - zhL)<a name='1802'>
 <a name='1803'>
       ELSE                 <font color=#447700>!UNSTABLE<a name='1804'></font>
<a name='1805'>
          x = (1.-19.0*zL)**0.25<a name='1806'>
          x0= (1.-19.0*zmL)**0.25<a name='1807'>
          y = (1.-11.6*zL)**0.5<a name='1808'>
          y0= (1.-11.6*zhL)**0.5<a name='1809'>
<a name='1810'>
          psi_m = 2.*LOG((1.+x)/(1.+x0)) + &amp;<a name='1811'>
                    &amp;LOG((1.+x**2.)/(1.+x0**2.)) - &amp;<a name='1812'>
                    &amp;2.0*ATAN(x) + 2.0*ATAN(x0)<a name='1813'>
          psi_h = 2.*LOG((1.+y)/(1.+y0))<a name='1814'>
<a name='1815'>
       ENDIF<a name='1816'>
                   <a name='1817'>
       return<a name='1818'>
<a name='1819'>
    END SUBROUTINE PSI_Hogstrom_1996<a name='1820'>
<font color=#447700>!--------------------------------------------------------------------<a name='1821'></font>
<A NAME='PSI_DYERHICKS'><A href='../../html_code/phys/module_sf_mynn.F.html#PSI_DYERHICKS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1822'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>PSI_DyerHicks</font>(psi_m, psi_h, zL, Zt, Z_0, Za) <A href='../../call_to/PSI_DYERHICKS.html' TARGET='index'>4</A><a name='1823'>
<a name='1824'>
    <font color=#447700>! This subroutine returns the stability functions based off<a name='1825'></font>
    <font color=#447700>! of Hogstrom (1996), but with different constants compatible<a name='1826'></font>
    <font color=#447700>! with Dyer and Hicks (1970/74?). This formulation is used for<a name='1827'></font>
    <font color=#447700>! testing/development by Nakanishi (personal communication).<a name='1828'></font>
<a name='1829'>
       IMPLICIT NONE<a name='1830'>
       REAL, INTENT(IN)  :: zL, Zt, Z_0, Za<a name='1831'>
       REAL, INTENT(OUT) :: psi_m, psi_h<a name='1832'>
       REAL  :: x, x0, y, y0, zmL, zhL<a name='1833'>
<a name='1834'>
       zmL = Z_0*zL/Za  <font color=#447700>!Zo/L<a name='1835'></font>
       zhL = Zt*zL/Za   <font color=#447700>!Zt/L<a name='1836'></font>
<a name='1837'>
       IF (zL .gt. 0.) THEN  <font color=#447700>!STABLE<a name='1838'></font>
<a name='1839'>
          psi_m = -5.0*(zL - zmL)<a name='1840'>
          psi_h = -5.0*(zL - zhL)<a name='1841'>
 <a name='1842'>
       ELSE                 <font color=#447700>!UNSTABLE<a name='1843'></font>
<a name='1844'>
          x = (1.-16.*zL)**0.25<a name='1845'>
          x0= (1.-16.*zmL)**0.25<a name='1846'>
<a name='1847'>
          y = (1.-16.*zL)**0.5<a name='1848'>
          y0= (1.-16.*zhL)**0.5<a name='1849'>
<a name='1850'>
          psi_m = 2.*LOG((1.+x)/(1.+x0)) + &amp;<a name='1851'>
                    &amp;LOG((1.+x**2.)/(1.+x0**2.)) - &amp; <a name='1852'>
                    &amp;2.0*ATAN(x) + 2.0*ATAN(x0)<a name='1853'>
          psi_h = 2.*LOG((1.+y)/(1.+y0))<a name='1854'>
<a name='1855'>
       ENDIF<a name='1856'>
                   <a name='1857'>
       return<a name='1858'>
<a name='1859'>
    END SUBROUTINE PSI_DyerHicks<a name='1860'>
<font color=#447700>!--------------------------------------------------------------------<a name='1861'></font>
<A NAME='PSI_BELJAARS_HOLTSLAG_1991'><A href='../../html_code/phys/module_sf_mynn.F.html#PSI_BELJAARS_HOLTSLAG_1991' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1862'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>PSI_Beljaars_Holtslag_1991</font>(psi_m, psi_h, zL)<a name='1863'>
<a name='1864'>
    <font color=#447700>! This subroutine returns the stability functions based off<a name='1865'></font>
    <font color=#447700>! of Beljaar and Holtslag 1991, which is an extension of Holtslag<a name='1866'></font>
    <font color=#447700>! and Debruin 1989.<a name='1867'></font>
<a name='1868'>
       IMPLICIT NONE<a name='1869'>
       REAL, INTENT(IN)  :: zL<a name='1870'>
       REAL, INTENT(OUT) :: psi_m, psi_h<a name='1871'>
       REAL, PARAMETER  :: a=1., b=0.666, c=5., d=0.35<a name='1872'>
<a name='1873'>
       IF (zL .lt. 0.) THEN  <font color=#447700>!UNSTABLE<a name='1874'></font>
<a name='1875'>
          WRITE(*,*)"WARNING: Universal stability functions from"<a name='1876'>
          WRITE(*,*)"        Beljaars and Holtslag (1991) should only"<a name='1877'>
          WRITE(*,*)"        be used in the stable regime<font color=#447700>!"<a name='1878'></font>
          psi_m = 0.<a name='1879'>
          psi_h = 0.<a name='1880'>
 <a name='1881'>
       ELSE                 <font color=#447700>!STABLE<a name='1882'></font>
<a name='1883'>
          psi_m = -(a*zL + b*(zL -(c/d))*exp(-d*zL) + (b*c/d))<a name='1884'>
          psi_h = -((1.+.666*a*zL)**1.5 + &amp;<a name='1885'>
                  b*(zL - (c/d))*exp(-d*zL) + (b*c/d) -1.)<a name='1886'>
<a name='1887'>
       ENDIF<a name='1888'>
                   <a name='1889'>
       return<a name='1890'>
<a name='1891'>
    END SUBROUTINE PSI_Beljaars_Holtslag_1991<a name='1892'>
<font color=#447700>!--------------------------------------------------------------------<a name='1893'></font>
<A NAME='PSI_ZILITINKEVICH_ESAU_2007'><A href='../../html_code/phys/module_sf_mynn.F.html#PSI_ZILITINKEVICH_ESAU_2007' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1894'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>PSI_Zilitinkevich_Esau_2007</font>(psi_m, psi_h, zL)<a name='1895'>
<a name='1896'>
    <font color=#447700>! This subroutine returns the stability functions come from<a name='1897'></font>
    <font color=#447700>! Zilitinkevich and Esau (2007, BM), which are formulatioed from the<a name='1898'></font>
    <font color=#447700>! "generalized similarity theory" and tuned to the LES DATABASE64<a name='1899'></font>
    <font color=#447700>! to determine their dependence on z/L.<a name='1900'></font>
<a name='1901'>
       IMPLICIT NONE<a name='1902'>
       REAL, INTENT(IN)  :: zL<a name='1903'>
       REAL, INTENT(OUT) :: psi_m, psi_h<a name='1904'>
       REAL, PARAMETER  :: Cm=3.0, Ct=2.5<a name='1905'>
<a name='1906'>
       IF (zL .lt. 0.) THEN  <font color=#447700>!UNSTABLE<a name='1907'></font>
<a name='1908'>
          WRITE(*,*)"WARNING: Universal stability function from"<a name='1909'>
          WRITE(*,*)"        Zilitinkevich and Esau (2007) should only"<a name='1910'>
          WRITE(*,*)"        be used in the stable regime<font color=#447700>!"<a name='1911'></font>
          psi_m = 0.<a name='1912'>
          psi_h = 0.<a name='1913'>
 <a name='1914'>
       ELSE                 <font color=#447700>!STABLE<a name='1915'></font>
<a name='1916'>
          psi_m = -Cm*(zL**(5./6.))<a name='1917'>
          psi_h = -Ct*(zL**(4./5.))<a name='1918'>
<a name='1919'>
       ENDIF<a name='1920'>
                   <a name='1921'>
       return<a name='1922'>
<a name='1923'>
    END SUBROUTINE PSI_Zilitinkevich_Esau_2007<a name='1924'>
<font color=#447700>!--------------------------------------------------------------------<a name='1925'></font>
<A NAME='PSI_BUSINGER_1971'><A href='../../html_code/phys/module_sf_mynn.F.html#PSI_BUSINGER_1971' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1926'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>PSI_Businger_1971</font>(psi_m, psi_h, zL)<a name='1927'>
<a name='1928'>
    <font color=#447700>! This subroutine returns the flux-profile relationships<a name='1929'></font>
    <font color=#447700>! of Businger el al. 1971.<a name='1930'></font>
<a name='1931'>
       IMPLICIT NONE<a name='1932'>
       REAL, INTENT(IN)  :: zL<a name='1933'>
       REAL, INTENT(OUT) :: psi_m, psi_h<a name='1934'>
       REAL  :: x, y<a name='1935'>
       REAL, PARAMETER  ::  Pi180 = 3.14159265/180.<a name='1936'>
<a name='1937'>
       IF (zL .lt. 0.) THEN  <font color=#447700>!UNSTABLE<a name='1938'></font>
<a name='1939'>
          x = (1. - 15.0*zL)**0.25<a name='1940'>
          y = (1. - 9.0*zL)**0.5<a name='1941'>
<a name='1942'>
          psi_m = LOG(((1.+x)/2.)**2.) + &amp;<a name='1943'>
                 &amp;LOG((1.+x**2.)/2.) - &amp;<a name='1944'>
                 &amp;2.0*ATAN(x) + Pi180*90.<a name='1945'>
          psi_h = 2.*LOG((1.+y)/2.)<a name='1946'>
<a name='1947'>
       ELSE                 <font color=#447700>!STABLE<a name='1948'></font>
<a name='1949'>
          psi_m = -4.7*zL<a name='1950'>
          psi_h = -(4.7/0.74)*zL<a name='1951'>
<a name='1952'>
       ENDIF<a name='1953'>
                   <a name='1954'>
       return<a name='1955'>
<a name='1956'>
    END SUBROUTINE PSI_Businger_1971<a name='1957'>
<font color=#447700>!--------------------------------------------------------------------<a name='1958'></font>
<A NAME='PSI_SUSELJ_SOOD_2010'><A href='../../html_code/phys/module_sf_mynn.F.html#PSI_SUSELJ_SOOD_2010' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1959'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>PSI_Suselj_Sood_2010</font>(psi_m, psi_h, zL)<a name='1960'>
<a name='1961'>
    <font color=#447700>!This subroutine returns flux-profile relatioships based off<a name='1962'></font>
    <font color=#447700>!of Lobocki (1993), which is derived from the MY-level 2 model.<a name='1963'></font>
    <font color=#447700>!Suselj and Sood (2010) applied the surface layer length scales<a name='1964'></font>
    <font color=#447700>!from Nakanishi (2001) to get this new relationship. These functions<a name='1965'></font>
    <font color=#447700>!are more agressive (larger magnitude) than most formulations. They<a name='1966'></font>
    <font color=#447700>!showed improvement over water, but untested over land.<a name='1967'></font>
<a name='1968'>
       IMPLICIT NONE<a name='1969'>
       REAL, INTENT(IN)  :: zL<a name='1970'>
       REAL, INTENT(OUT) :: psi_m, psi_h<a name='1971'>
       REAL, PARAMETER  :: Rfc=0.19, Ric=0.183, PHIT=0.8<a name='1972'>
<a name='1973'>
       IF (zL .gt. 0.) THEN  <font color=#447700>!STABLE<a name='1974'></font>
<a name='1975'>
          psi_m = -(zL/Rfc + 1.1223*EXP(1.-1.6666/zL))<a name='1976'>
          <font color=#447700>!psi_h = -zL*Ric/((Rfc**2.)*PHIT) + 8.209*(zL**1.1091)<a name='1977'></font>
          <font color=#447700>!THEIR EQ FOR PSI_H CRASHES THE MODEL AND DOES NOT MATCH<a name='1978'></font>
          <font color=#447700>!THEIR FIG 1. THIS EQ (BELOW) MATCHES THEIR FIG 1 BETTER:<a name='1979'></font>
          psi_h = -(zL*Ric/((Rfc**2.)*5.) + 7.09*(zL**1.1091))<a name='1980'>
 <a name='1981'>
       ELSE                 <font color=#447700>!UNSTABLE<a name='1982'></font>
<a name='1983'>
          psi_m = 0.9904*LOG(1. - 14.264*zL)<a name='1984'>
          psi_h = 1.0103*LOG(1. - 16.3066*zL)<a name='1985'>
<a name='1986'>
       ENDIF<a name='1987'>
                   <a name='1988'>
       return<a name='1989'>
<a name='1990'>
    END SUBROUTINE PSI_Suselj_Sood_2010<a name='1991'>
<font color=#447700>!--------------------------------------------------------------------<a name='1992'></font>
<A NAME='LI_ETAL_2010'><A href='../../html_code/phys/module_sf_mynn.F.html#LI_ETAL_2010' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1993'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>Li_etal_2010</font>(zL, Rib, zaz0, z0zt) <A href='../../call_to/LI_ETAL_2010.html' TARGET='index'>2</A><a name='1994'>
<a name='1995'>
    <font color=#447700>!This subroutine returns a more robust z/L that best matches<a name='1996'></font>
    <font color=#447700>!the z/L from Hogstrom (1996) for unstable conditions and Beljaars<a name='1997'></font>
    <font color=#447700>!and Holtslag (1991) for stable conditions.<a name='1998'></font>
<a name='1999'>
       IMPLICIT NONE<a name='2000'>
       REAL, INTENT(OUT)  :: zL<a name='2001'>
       REAL, INTENT(IN) :: Rib, zaz0, z0zt<a name='2002'>
       REAL :: alfa, beta, zaz02, z0zt2<a name='2003'>
       REAL, PARAMETER  :: au11=0.045, bu11=0.003, bu12=0.0059, &amp;<a name='2004'>
                          &amp;bu21=-0.0828, bu22=0.8845, bu31=0.1739, &amp;<a name='2005'>
                          &amp;bu32=-0.9213, bu33=-0.1057<a name='2006'>
       REAL, PARAMETER  :: aw11=0.5738, aw12=-0.4399, aw21=-4.901,&amp;<a name='2007'>
                          &amp;aw22=52.50, bw11=-0.0539, bw12=1.540, &amp;<a name='2008'>
                          &amp;bw21=-0.669, bw22=-3.282<a name='2009'>
       REAL, PARAMETER  :: as11=0.7529, as21=14.94, bs11=0.1569,&amp;<a name='2010'>
                          &amp;bs21=-0.3091, bs22=-1.303<a name='2011'>
          <a name='2012'>
       <font color=#447700>!set limits according to Li et al (2010), p 157.<a name='2013'></font>
       zaz02=zaz0<a name='2014'>
       IF (zaz0 .lt. 100.0) zaz02=100.<a name='2015'>
       IF (zaz0 .gt. 100000.0) zaz02=100000.<a name='2016'>
<a name='2017'>
       <font color=#447700>!set more limits according to Li et al (2010)<a name='2018'></font>
       z0zt2=z0zt<a name='2019'>
       IF (z0zt .lt. 0.5) z0zt2=0.5<a name='2020'>
       IF (z0zt .gt. 100.0) z0zt2=100.<a name='2021'>
<a name='2022'>
       alfa = LOG(zaz02)<a name='2023'>
       beta = LOG(z0zt2)<a name='2024'>
<a name='2025'>
       IF (Rib .le. 0.0) THEN<a name='2026'>
          zL = au11*alfa*Rib**2 + (                   &amp;<a name='2027'>
               &amp;  (bu11*beta + bu12)*alfa**2 +        &amp;<a name='2028'>
               &amp;  (bu21*beta + bu22)*alfa    +        &amp;<a name='2029'>
               &amp;  (bu31*beta**2 + bu32*beta + bu33))*Rib<a name='2030'>
          <font color=#447700>!if(zL .LT. -15 .OR. zl .GT. 0.)print*,"VIOLATION Rib&lt;0:",zL<a name='2031'></font>
          zL = MAX(zL,-15.) <font color=#447700>!LIMITS SET ACCORDING TO Li et al (2010)<a name='2032'></font>
          zL = MIN(zL,0.)   <font color=#447700>!Figure 1.<a name='2033'></font>
       ELSEIF (Rib .gt. 0.0 .AND. Rib .le. 0.2) THEN<a name='2034'>
          zL = ((aw11*beta + aw12)*alfa +             &amp;<a name='2035'>
             &amp;  (aw21*beta + aw22))*Rib**2 +          &amp;<a name='2036'>
             &amp; ((bw11*beta + bw12)*alfa +             &amp;<a name='2037'>
             &amp;  (bw21*beta + bw22))*Rib<a name='2038'>
          <font color=#447700>!if(zL .LT. 0 .OR. zl .GT. 4)print*,"VIOLATION 0&lt;Rib&lt;0.2:",zL<a name='2039'></font>
          zL = MIN(zL,4.) <font color=#447700>!LIMITS APPROX SET ACCORDING TO Li et al (2010)<a name='2040'></font>
          zL = MAX(zL,0.) <font color=#447700>!THEIR FIGURE 1B.<a name='2041'></font>
       ELSE<a name='2042'>
          zL = (as11*alfa + as21)*Rib + bs11*alfa +   &amp;<a name='2043'>
             &amp;  bs21*beta + bs22<a name='2044'>
          <font color=#447700>!if(zL .LE. 1 .OR. zl .GT. 23)print*,"VIOLATION Rib&gt;0.2:",zL<a name='2045'></font>
          zL = MIN(zL,20.) <font color=#447700>!LIMITS ACCORDING TO Li et al (2010), THIER<a name='2046'></font>
                           <font color=#447700>!FIGUE 1C.<a name='2047'></font>
          zL = MAX(zL,1.)<a name='2048'>
       ENDIF<a name='2049'>
<a name='2050'>
       return<a name='2051'>
<a name='2052'>
    END SUBROUTINE Li_etal_2010<a name='2053'>
<font color=#447700>!--------------------------------------------------------------------<a name='2054'></font>
<a name='2055'>
END MODULE module_sf_mynn<a name='2056'>
</pre></body></html>