<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<a name='3'>
<font color=#447700>! prepocessed on "Nov 18 2016" at "14:51:08"<a name='4'></font>
<a name='5'>
<a name='6'>
<a name='7'>
<a name='8'>
<a name='9'>
<a name='10'>
<a name='11'>
<font color=#447700>!---------------------------------------------------------------------<a name='12'></font>
<font color=#447700>! IMPORTANT: Best results are attained using the new 5th-order WENO advection option (4) for scalars:<a name='13'></font>
<font color=#447700>! moist_adv_opt                       = 4,<a name='14'></font>
<font color=#447700>! scalar_adv_opt                      = 4,<a name='15'></font>
<font color=#447700>! (WENO = Weighted Essentially Non-Oscillatory)<a name='16'></font>
<font color=#447700>!<a name='17'></font>
<font color=#447700>! This module provides a 2-moment bulk microphysics scheme originally <a name='18'></font>
<font color=#447700>! developed by Conrad Ziegler (Zeigler, 1985, JAS) and modified/upgraded in <a name='19'></font>
<font color=#447700>! in Mansell, Zeigler, and Bruning (2010, JAS).  Two-moment adaptive sedimentation <a name='20'></font>
<font color=#447700>! follows Mansell (2010, JAS), using parameter infall = 4.<a name='21'></font>
<font color=#447700>!<a name='22'></font>
<font color=#447700>! Added info on graupel density and soaking is in Mansell and Ziegler (2013, JAS)<a name='23'></font>
<font color=#447700>!<a name='24'></font>
<font color=#447700>! Average graupel particle density is predicted, which affects fall speed as well. <a name='25'></font>
<font color=#447700>! Hail density prediction is by default disabled in this version, but may be enabled<a name='26'></font>
<font color=#447700>! at some point if there is interest.<a name='27'></font>
<font color=#447700>!<a name='28'></font>
<font color=#447700>! Maintainer: Ted Mansell, National Severe Storms Laboratory &lt;ted.mansell@noaa.gov&gt;<a name='29'></font>
<font color=#447700>!<a name='30'></font>
<font color=#447700>! Microphysics References:<a name='31'></font>
<font color=#447700>!<a name='32'></font>
<font color=#447700>! Mansell, E. R., C. L. Ziegler, and E. C. Bruning, 2010: Simulated electrification of a small <a name='33'></font>
<font color=#447700>!   thunderstorm with two-moment bulk microphysics. J. Atmos. Sci., 67, 171-194, doi:10. 1175/2009JAS2965.1.<a name='34'></font>
<font color=#447700>!<a name='35'></font>
<font color=#447700>!  Mansell, E. R. and C. L. Ziegler, 2013: Aerosol effects on simulated storm electrification and <a name='36'></font>
<font color=#447700>!     precipitation in a two-moment bulk microphysics model. J. Atmos. Sci., 70 (7), 2032-2050, <a name='37'></font>
<font color=#447700>!     doi:10.1175/JAS-D-12-0264.1.<a name='38'></font>
<font color=#447700>!<a name='39'></font>
<font color=#447700>! Ziegler, C. L., 1985: Retrieval of thermal and microphysical variables in observed convective storms. <a name='40'></font>
<font color=#447700>!    Part I: Model development and preliminary testing. J. Atmos. Sci., 42, 1487-1509.<a name='41'></font>
<font color=#447700>!<a name='42'></font>
<font color=#447700>! Sedimentation reference:<a name='43'></font>
<font color=#447700>!<a name='44'></font>
<font color=#447700>! Mansell, E. R., 2010: On sedimentation and advection in multimoment bulk microphysics. <a name='45'></font>
<font color=#447700>!    J. Atmos. Sci., 67, 3084-3094, doi:10.1175/2010JAS3341.1.<a name='46'></font>
<font color=#447700>!<a name='47'></font>
<font color=#447700>! Possible parameters to adjust:<a name='48'></font>
<font color=#447700>!<a name='49'></font>
<font color=#447700>!  ccn : base cloud condensation nuclei concentration (use namelist.input value "nssl_cccn")<a name='50'></font>
<font color=#447700>!  alphah, alphahl : Size distribution shape parameters for graupel (h) and hail (hl)<a name='51'></font>
<font color=#447700>!  infall : changes sedimentation options to see effects (see below)<a name='52'></font>
<font color=#447700>!<a name='53'></font>
<font color=#447700>! lightning model references:<a name='54'></font>
<font color=#447700>!<a name='55'></font>
<font color=#447700>!    Fierro, A. O., E.R. Mansell, C. Ziegler and D. R. MacGorman 2013: The<a name='56'></font>
<font color=#447700>!    implementation of an explicit charging and discharge lightning scheme<a name='57'></font>
<font color=#447700>!    within the WRF-ARW model: Benchmark simulations of a continental squall line, a<a name='58'></font>
<font color=#447700>!    tropical cyclone and a winter storm. Monthly Weather Review, Volume 141, 2390-2415 <a name='59'></font>
<font color=#447700>!<a name='60'></font>
<font color=#447700>!    Mansell et al. 2005: Charge structure and lightning sensitivity in a simulated <a name='61'></font>
<font color=#447700>!     multicell thunderstorm. J. Geophys. Res., 110, D12101, doi:10.1029/2004JD005287<a name='62'></font>
<font color=#447700>!<a name='63'></font>
<font color=#447700>! Note: Some parameters below apply to unreleased features.<a name='64'></font>
<font color=#447700>!<a name='65'></font>
<font color=#447700>! WRF 3.9 updates:<a name='66'></font>
<font color=#447700>!<a name='67'></font>
<font color=#447700>!   2-moment scheme now creates number concentration tendencies from cumulus scheme mass mixing ratio rates<a name='68'></font>
<font color=#447700>!   Renamed internal gamma function routine from 'gamma' to 'gamma_sp' to avoid name conflicts<a name='69'></font>
<font color=#447700>!   Restored older settings that allow snow aggregation starting at T &gt; -25C<a name='70'></font>
<font color=#447700>!   Adjusted Meyers number of activated nuclei by the local air density to compensate for using data at surface<a name='71'></font>
<font color=#447700>!   Minor updates to rain-ice crystal and hail-rain collection efficiencies<a name='72'></font>
<font color=#447700>!<a name='73'></font>
<font color=#447700>!   Reduced minimum mean snow diameter from 100 microns to 10 microns<a name='74'></font>
<font color=#447700>!<a name='75'></font>
<font color=#447700>! WRF 3.8 updates:<a name='76'></font>
<font color=#447700>!   Fixed issue with reflectivity conservation for graupel melting into rain. Rain number concentrations were too low,<a name='77'></font>
<font color=#447700>!       resulting in excessive reflectivity of a couple dBZ<a name='78'></font>
<font color=#447700>!   Changed default value of iusewetgraupel to 1 (turns off diagnostic meltwater on graupel for reflectivity)<a name='79'></font>
<font color=#447700>!   Apply a 70 m/s fall speed limit for sedimentation<a name='80'></font>
<font color=#447700>!   Changed vapor ice nucleation to Meyers-Ferrier method (original scheme)<a name='81'></font>
<font color=#447700>!   New method for Bigg freezing (ibiggopt=2)<a name='82'></font>
<font color=#447700>!   Reduced snow aggregration efficiency and restricted aggregation to higher temperatures (assuming dendrites and mechanical aggregation)<a name='83'></font>
<font color=#447700>!   Increased maximum graupel-droplet collection efficiency when hail is turned off (nssl_2momg)<a name='84'></font>
<font color=#447700>!   Updates for compatibility with WRF-NMM<a name='85'></font>
<font color=#447700>!   Added calculation of hail number concentration in calcnfromq (creates number concentration from mixing ratio<a name='86'></font>
<font color=#447700>!       when starting from an analysis). And fixed error in graupel intercept<a name='87'></font>
<font color=#447700>!   Bug fix in snow fall speeds<a name='88'></font>
<font color=#447700>!   Further fix in snow reflectivity<a name='89'></font>
<font color=#447700>!   Use diameter of maximum mass rather than mean diamter when checking maximum size<a name='90'></font>
<font color=#447700>!   Helped performance in sedimentation with flag "do_accurate_sedimentation" to control recalculation of fall speeds when<a name='91'></font>
<font color=#447700>!       more than one sub-time step is needed (often happens with large time steps and small dz near the ground):<a name='92'></font>
<font color=#447700>!        = .true. : recalculates fall speed after each substep (more accurate)<a name='93'></font>
<font color=#447700>!        = .false. : (default) reuses fall speeds calculated on the first substep (typical for most schemes), theoretically could cause an occasional glitch, but none seen in practice<a name='94'></font>
<font color=#447700>!   Increased maximum mean droplet radius from 40 to 60 microns, which alleviates spurious number concentration increases at low CCN concentration.<a name='95'></font>
<font color=#447700>!   Removed a duplicate factor from hail reflectivity that was causing a loss of about 6 dBZ (since WRF 3.5).<a name='96'></font>
<font color=#447700>!<a name='97'></font>
<font color=#447700>!---------------------------------------------------------------------<a name='98'></font>
<a name='99'>
<a name='100'>
<a name='101'>
<A NAME='MODULE_MP_NSSL_2MOM'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#MODULE_MP_NSSL_2MOM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='102'>
<font color=#993300>MODULE </font><font color=#cc0000>module_mp_nssl_2mom</font> <A href='../../call_to/MODULE_MP_NSSL_2MOM.html' TARGET='index'>2</A><a name='103'>
<a name='104'>
  IMPLICIT NONE<a name='105'>
  <a name='106'>
  public nssl_2mom_driver<a name='107'>
  public nssl_2mom_init<a name='108'>
  private gamma_sp,gamxinf,GAML02, GAML02d300, GAML02d500, fqvs, fqis<a name='109'>
  private gamma_dp, gamxinfdp<a name='110'>
  private delbk, delabk<a name='111'>
  private gammadp<a name='112'>
  <a name='113'>
  logical, private :: cleardiag = .false.<a name='114'>
  PRIVATE<a name='115'>
<a name='116'>
#ifdef WRF_CHEM<a name='117'>
  integer, parameter :: wrfchem_flag = 1<a name='118'>
#else<a name='119'>
  integer, parameter :: wrfchem_flag = 0<a name='120'>
#endif<a name='121'>
  <a name='122'>
  integer, private :: eqtset = 1 <font color=#447700>! Flag for use with cm1 to use alternate equation set (changes latent heating rates)<a name='123'></font>
   double precision, parameter, public :: zscale = 1.0d0 <font color=#447700>! 1.000e-10<a name='124'></font>
   double precision, parameter, public :: zscaleinv = 1.0d0/zscale <font color=#447700>! 1.000e-10<a name='125'></font>
<a name='126'>
  <a name='127'>
  real, parameter :: warmonly = 0.0 <font color=#447700>! testing parameter, set to 1.0 to reduce to warm-rain physics (ice variables stay zero)<a name='128'></font>
  <a name='129'>
  logical, parameter :: lwsm6 = .false. <font color=#447700>! act like wsm6 for some single moment interactions<a name='130'></font>
<a name='131'>
<font color=#447700>! some constants from WSM6<a name='132'></font>
  real, parameter  :: dimax = 500.e-6    <font color=#447700>! limited maximum value for the cloud-ice diamter<a name='133'></font>
  real, parameter  :: roqimax = 2.08e22*dimax**8<a name='134'>
  <a name='135'>
<font color=#447700>! Params for dbz:<a name='136'></font>
  integer  :: iuseferrier = 1  <font color=#447700>! =1: use dry graupel only from Ferrier 1994; = 0: Use Smith (wet graupel)<a name='137'></font>
  integer  :: idbzci      = 0<a name='138'>
  integer  :: iusewetgraupel = 1 <font color=#447700>! =1 to turn on use of QHW for graupel reflectivity (only for ZVDM -- mixedphase)<a name='139'></font>
                                 <font color=#447700>! =2 turn on for graupel density less than 300. only <a name='140'></font>
  integer  :: iusewethail = 0 <font color=#447700>! =1 to turn on use of QHW for graupel reflectivity (only for ZVDM -- mixedphase)<a name='141'></font>
  integer  :: iusewetsnow = 1 <font color=#447700>! =1 to turn on diagnosed bright band<a name='142'></font>
<a name='143'>
<font color=#447700>! microphysics<a name='144'></font>
<a name='145'>
  real, private :: rho_qr = 1000., cnor = 8.0e5  <font color=#447700>! cnor is set in namelist!!  rain params<a name='146'></font>
  real, private :: rho_qs =  100., cnos = 3.0e6  <font color=#447700>! set in namelist!!  snow params<a name='147'></font>
  real, private :: rho_qh =  500., cnoh = 4.0e5  <font color=#447700>! set in namelist!!  graupel params<a name='148'></font>
  real, private :: rho_qhl=  900., cnohl = 4.0e4 <font color=#447700>! set in namelist!!  hail params<a name='149'></font>
<a name='150'>
  real, private :: hdnmn  = 170.0  <font color=#447700>! minimum graupel density (for variable density graupel)<a name='151'></font>
  real, private :: hldnmn = 500.0  <font color=#447700>! minimum hail density (for variable density hail)<a name='152'></font>
<a name='153'>
  real :: cnohmn  = 1.e-2 <font color=#447700>! minimum intercept for 2-moment graupel (alphah &lt; 0.5)<a name='154'></font>
  real :: cnohlmn = 1.e-2 <font color=#447700>! minimum intercept for 2-moment hail (alphahl &lt; 0.5)<a name='155'></font>
  <a name='156'>
<font color=#447700>! Autoconversion parameters<a name='157'></font>
<a name='158'>
  real   , private :: qcmincwrn      = 2.0e-3    <font color=#447700>! qc threshold for autonconversion (LFO; for 10ICE use qminrncw for ircnw != 5)<a name='159'></font>
  real   , private :: cwdiap         = 20.0e-6   <font color=#447700>! threshold diameter of cloud drops (Ferrier 1994 autoconversion)<a name='160'></font>
  real   , private :: cwdisp         = 0.15      <font color=#447700>! assume droplet dispersion parameter (can be 0.3 for maritime)<a name='161'></font>
  real   , private  :: ccn            = 0.6e+09   <font color=#447700>! set in namelist!! Central plains CCN value<a name='162'></font>
  real   , private :: qccn             <font color=#447700>! ccn "mixing ratio"<a name='163'></font>
  integer, private :: iauttim        = 1         <font color=#447700>! 10-ice rain delay flag<a name='164'></font>
  real   , private :: auttim         = 300.      <font color=#447700>! 10-ice rain delay time<a name='165'></font>
  real   , private :: qcwmntim       = 1.0e-5    <font color=#447700>! 10-ice rain delay min qc for time accrual<a name='166'></font>
<a name='167'>
#if (NMM_CORE == 1)<a name='168'>
<font color=#447700>! NMM WRF core does not have special boundary conditions for CCN, therefore set invertccn to true<a name='169'></font>
      logical, parameter :: invertccn = .true. <font color=#447700>! =true for base state of ccn=0, =false for ccn initialized in the base state<a name='170'></font>
#else<a name='171'>
      logical, parameter :: invertccn = .false. <font color=#447700>! =true for base state of ccn=0, =false for ccn initialized in the base state<a name='172'></font>
#endif<a name='173'>
  logical :: restoreccn = .false. <font color=#447700>! whether or not to nudge CCN back to base state (qccn) (only applies if CCNA is NOT predicted)<a name='174'></font>
  real    :: ccntimeconst = 600.  <font color=#447700>! time constant for CCN restore (either for CCNA or when restoreccn = true)<a name='175'></font>
<a name='176'>
<a name='177'>
<font color=#447700>! sedimentation flags<a name='178'></font>
<font color=#447700>! itfall -&gt; 0 = 1st order fallout (other options removed)<a name='179'></font>
<font color=#447700>! iscfall, infall -&gt; fallout options for charge and number concentration, respectively<a name='180'></font>
<font color=#447700>!                    1 = mass-weighted fall speed; 2 = number-weighted fallspeed.<a name='181'></font>
  integer, private :: itfall = 0<a name='182'>
  integer, private :: iscfall = 1<a name='183'>
  integer, private :: irfall = -1<a name='184'>
  logical, private :: do_accurate_sedimentation = .false. <font color=#447700>! if true, recalculate fall speeds on sub time steps; (more expensive)<a name='185'></font>
                                                         <font color=#447700>! if false, reuse fall speeds on multiple steps (can have a noticeable speedup)<a name='186'></font>
                                                         <font color=#447700>! Mainly is an issue for small dz near the surface. <a name='187'></font>
  integer, private :: infall = 4   <font color=#447700>! 0 -&gt; uses number-wgt for N; NO correction applied (results in excessive size sorting)<a name='188'></font>
                          <font color=#447700>! 1 -&gt; uses mass-weighted fallspeed for N ALWAYS<a name='189'></font>
                          <font color=#447700>! 2 -&gt; uses number-wgt for N and mass-weighted correction for N (Method II in Mansell, 2010 JAS)<a name='190'></font>
                          <font color=#447700>! 3 -&gt; uses number-wgt for N and Z-weighted correction for N (Method I in Mansell, 2010 JAS)<a name='191'></font>
                          <font color=#447700>! 4 -&gt; Hybrid of 2 and 3: Uses minimum N from each method (z-wgt and m-wgt corrections) (Method I+II in Mansell, 2010 JAS)<a name='192'></font>
                          <font color=#447700>! 5 -&gt; uses number-wgt for N and uses average of N-wgt and q-wgt instead of Max.<a name='193'></font>
  real    :: rainfallfac = 1.0 <font color=#447700>! factor to adjust rain fall speed (single moment only)<a name='194'></font>
  integer, private :: icdx = 3 <font color=#447700>! (graupel) 0=Ferrier; 1=leave drag coef. cd fixed; 2=vary by density, 4=set by user with cdxmin,cdxmax,etc.<a name='195'></font>
  integer, private :: icdxhl = 3 <font color=#447700>! (hail) 0=Ferrier; 1=leave drag coef. cd fixed; 2=vary by density, 4=set by user with cdxmin,cdxmax,etc.<a name='196'></font>
  real   , private :: cdhmin = 0.45, cdhmax = 0.8        <font color=#447700>! defaults for graupel (icdx=4)<a name='197'></font>
  real   , private :: cdhdnmin = 500., cdhdnmax = 800.0  <font color=#447700>! defaults for graupel (icdx=4)<a name='198'></font>
  real   , private :: cdhlmin = 0.45, cdhlmax = 0.6      <font color=#447700>! defaults for hail (icdx=4)<a name='199'></font>
  real   , private :: cdhldnmin = 500., cdhldnmax = 800.0  <font color=#447700>! defaults for hail (icdx=4)<a name='200'></font>
  real   , private :: vtmaxsed = 70. <font color=#447700>! Limit on fall speed (m/s, all moments) for sedimentation calculations. Not applied to fall speeds for microphysical rates<a name='201'></font>
  <a name='202'>
  integer :: rssflg = 1   <font color=#447700>! Rain size-sorting allowed (1, default), or disallowed (0).  If 0, sets N and Z-weighted fall speeds to q-weighted value<a name='203'></font>
  integer :: sssflg = 1   <font color=#447700>! As above but for snow<a name='204'></font>
  integer :: hssflg = 1   <font color=#447700>! As above but for graupel<a name='205'></font>
  integer :: hlssflg = 1  <font color=#447700>! As above but for hail<a name='206'></font>
<a name='207'>
<font color=#447700>! input flags<a name='208'></font>
<a name='209'>
  integer, private :: ndebug = -1, ncdebug = 0<a name='210'>
  integer, private :: ipconc = 5<a name='211'>
  integer, private :: ichaff = 0<a name='212'>
  integer, private :: ilimit = 0<a name='213'>
  <a name='214'>
  real, private :: constccw = -1.<a name='215'>
<a name='216'>
  real, private :: cimn = 1.0e3, cimx = 1.0e6<a name='217'>
<a name='218'>
<a name='219'>
  real   , private :: ifrzg = 1.0 <font color=#447700>! fraction of frozen drops going to graupel. 1=freeze all rain to graupel, 0=freeze all to hail<a name='220'></font>
  real   , private :: ifrzs = 1.0 <font color=#447700>! fraction of small frozen drops going to snow. 1=freeze rain to snow, 0=freeze to cloud ice<a name='221'></font>
  real   , private :: ffrzs = 0.0 <font color=#447700>! fraction of other initiated cloud ice going to snow. 1=freeze rain to snow, 0=freeze to cloud ice<a name='222'></font>
  integer, private :: irwfrz = 1 <font color=#447700>! compute total rain that can freeze (checks heat budget)<a name='223'></font>
  integer, private :: irimtim = 0 <font color=#447700>! future use<a name='224'></font>
<font color=#447700>!  integer, private :: infdo = 1   ! 1 = calculate number-weighted fall speeds<a name='225'></font>
<a name='226'>
  real   , private :: rimc1 = 300.0, rimc2 = 0.44  <font color=#447700>! rime density coeff. and power (Default Heymsfield and Pflaum, 1985)<a name='227'></font>
  real   , private :: rimc3 = 170.0                <font color=#447700>! minimum rime density<a name='228'></font>
  real    :: rimc4 = 900.0                <font color=#447700>! maximum rime density<a name='229'></font>
  real   , private :: rimtim = 120.0               <font color=#447700>! cut-off rime time (10ICE)<a name='230'></font>
  real   , private :: eqtot = 1.0e-9               <font color=#447700>! threshold for mass budget reporting<a name='231'></font>
<a name='232'>
  integer, private :: ireadmic = 0<a name='233'>
<a name='234'>
  integer, private :: iccwflg = 1     <font color=#447700>! sets max size of first droplets in parcel to 4 micron radius (in two-moment liquid)<a name='235'></font>
                             <font color=#447700>! (first nucleation is done with a KW sat. adj. step)<a name='236'></font>
  integer, private :: issfilt = 0     <font color=#447700>! flag to turn on filtering of supersaturation field<a name='237'></font>
  integer, private :: irenuc = 2      <font color=#447700>! =1 to always allow renucleation of droplets within the cloud<a name='238'></font>
                                      <font color=#447700>! =2 renucleation following Twomey/Cohard&amp;Pinty<a name='239'></font>
                                      <font color=#447700>! =7 New renucleation that requires prediction of the number of activated nuclei<a name='240'></font>
                             <font color=#447700>! i.e., not only at cloud base<a name='241'></font>
  integer, private :: irenuc3d = 0      <font color=#447700>! =1 to include horizontal gradient in renucleation of droplets within the cloud<a name='242'></font>
  real    :: renucfrac = 0.0 <font color=#447700>! = 0 : cnuc = cwccn<a name='243'></font>
                             <font color=#447700>! = 1 : cnuc = actual available CCN<a name='244'></font>
                             <font color=#447700>! otherwise cnuc = cwccn*(1. - renufrac) + ccnc(1:ngscnt)*renucfrac<a name='245'></font>
  real   , private :: cck = 0.6       <font color=#447700>! exponent in Twomey expression<a name='246'></font>
  real   , private :: ciintmx = 1.0e6 <font color=#447700>! limit on ice concentration from primary nucleation<a name='247'></font>
<a name='248'>
  real   , private :: cwccn <font color=#447700>! , cwmasn,cwmasx<a name='249'></font>
  real   , private :: ccwmx<a name='250'>
<a name='251'>
  integer, private :: idocw = 1, idorw = 1, idoci = 1, idoir = 1, idoip = 1, idosw = 1<a name='252'>
  integer, private :: idogl = 1, idogm = 1, idogh = 1, idofw = 1, idohw = 1, idohl = 1<a name='253'>
<font color=#447700>!  integer, private :: ido(3:14) = / 12*1 /<a name='254'></font>
<a name='255'>
<a name='256'>
<font color=#447700>! 0,2, 5.00e-10, 1, 0, 0, 0      : itype1,itype2,cimas0,icfn,ihrn,ibfc,iacr<a name='257'></font>
  integer, private :: itype1 = 0, itype2 = 2  <font color=#447700>! controls Hallett-Mossop process<a name='258'></font>
  integer, private :: icenucopt = 1       <font color=#447700>! =1 Meyers/Ferrier primary ice nucleation; =2 Thompson/Cooper, =3 Phillips (Meyers/Demott)<a name='259'></font>
  integer, private :: icfn = 2                <font color=#447700>! contact freezing: 0 = off; 1 = hack (ok for single moment); 2 = full Cotton/Meyers version<a name='260'></font>
  integer, private :: ihrn = 0            <font color=#447700>! Hobbs-Rangno ice multiplication (Ferrier, 1994; use in 10-ice only)<a name='261'></font>
  integer, private :: ibfc = 1            <font color=#447700>! Flag to use Bigg freezing on droplets (0 = off (uses alternate freezing), 1 = on)<a name='262'></font>
  integer, private :: iremoveqwfrz = 1    <font color=#447700>! Whether to remove (=1) or not (=0) the newly-frozen cloud droplets (ibfc=1) from the CWC used for charge separation<a name='263'></font>
  integer, private :: iacr = 2            <font color=#447700>! Flag for drop contact freezing with crytals<a name='264'></font>
                                 <font color=#447700>! (0=off; 1=drops &gt; 500micron diameter; 2 = &gt; 300micron)<a name='265'></font>
  integer, private :: ibfr = 2            <font color=#447700>! Flag for Bigg freezing conversion of freezing drops to graupel<a name='266'></font>
                                 <font color=#447700>! (1=min graupel size is vr1mm; 2=use min size of dfrz, 5= as for 2 and apply dbz conservation)<a name='267'></font>
  integer, private :: ibiggopt = 2        <font color=#447700>! 1 = old Bigg; 2 = experimental Bigg (only for imurain = 1, however)<a name='268'></font>
  integer :: ibiggsmallrain = 0  <font color=#447700>! 1 = When rain is too small, freeze none to graupel and send all to snow (experimental)<a name='269'></font>
  integer, private :: iacrsize = 5        <font color=#447700>! assumed min size of drops freezing by capture<a name='270'></font>
                                 <font color=#447700>!  1: &gt; 500 micron diam<a name='271'></font>
                                 <font color=#447700>!  2: &gt; 300 micron<a name='272'></font>
                                 <font color=#447700>!  3: &gt; 40 micron<a name='273'></font>
                                 <font color=#447700>!  4: all sizes<a name='274'></font>
                                 <font color=#447700>!  5: &gt; 150 micron (only for imurain = 1)<a name='275'></font>
  real   , private :: cimas0 = 6.62e-11   <font color=#447700>! default mass of Hallett-Mossop crystals<a name='276'></font>
                                 <font color=#447700>! 6.62e-11kg results in half the diam. (60 microns) of old default value of 5.0e-10<a name='277'></font>
  real   , private :: cimas1 = 6.88e-13   <font color=#447700>! default mass of new ice crystals<a name='278'></font>
  real   , private :: splintermass = 6.88e-13<a name='279'>
  real   , private :: cfnfac = 0.1        <font color=#447700>! Hack factor that goes with icfn=1<a name='280'></font>
  integer, private :: iscni = 4           <font color=#447700>! default option for ice crystal aggregation/conversion to snow<a name='281'></font>
  real   , private :: fscni = 1.0         <font color=#447700>! factor for calculating cscni<a name='282'></font>
  logical, private :: imeyers5 = .false.  <font color=#447700>! .false.=off, true=on for Meyers ice nucleation for temp &gt; -5 C<a name='283'></font>
  real   , private :: dmincw = 15.0e-6    <font color=#447700>! minimum droplet diameter for collection for iehw=3<a name='284'></font>
  integer, private :: iehw = 1            <font color=#447700>! 0 -&gt; ehw=ehw0; 1 -&gt; old ehw; 2 -&gt; test ehw with Mason table data<a name='285'></font>
  integer, private :: iehlw = 1           <font color=#447700>! 0 -&gt; ehlw=ehlw0; 1 -&gt; old ehlw; 2 -&gt; test ehlw with Mason table data<a name='286'></font>
                                 <font color=#447700>! For ehw/ehlw = 1, ehw0/ehlw0 act as maximum limit on collection efficiency (defaults are 1.0)<a name='287'></font>
  integer, private :: ierw = 1            <font color=#447700>! for single-moment rain (LFO/Z)<a name='288'></font>
  real   , private :: ehw0 = 0.5          <font color=#447700>! constant or max assumed graupel-droplet collection efficiency<a name='289'></font>
  real   , private :: erw0 = 1.0          <font color=#447700>! constant assumed rain-droplet collection efficiency<a name='290'></font>
  real   , private :: ehlw0 = 0.75        <font color=#447700>! constant or max assumed hail-droplet collection efficiency<a name='291'></font>
  real    :: ehr0 = 1.0          <font color=#447700>! constant or max assumed graupel-rain collection efficiency<a name='292'></font>
  real    :: ehlr0 = 1.0         <font color=#447700>! constant or max assumed hail-rain collection efficiency<a name='293'></font>
  <a name='294'>
<a name='295'>
  real   , private :: esilfo0 = 1.0       <font color=#447700>! factor for LFO collection efficiency of snow for cloud ice.<a name='296'></font>
  real   , private :: ehslfo0 = 1.0       <font color=#447700>! factor for LFO collection efficiency of hail/graupel for snow.<a name='297'></font>
<a name='298'>
  integer, private :: ircnw    = 5        <font color=#447700>! single-moment warm-rain autoconversion option.  5= Ferrier 1994.<a name='299'></font>
  real   , private :: qminrncw = 2.0e-3   <font color=#447700>! qc threshold for rain autoconversion (NA for ircnw=5)<a name='300'></font>
<a name='301'>
  integer, private :: iqcinit = 2         <font color=#447700>! For ZVDxx schemes, flag to choose which way to initialize droplets<a name='302'></font>
                                 <font color=#447700>! 1 = Soong-Ogura adjustment<a name='303'></font>
                                 <font color=#447700>! 2 = Saturation adjustment to value of ssmxinit<a name='304'></font>
                                 <font color=#447700>! 3 = KW adjustment<a name='305'></font>
<a name='306'>
  real   , private :: ssmxinit = 0.4      <font color=#447700>! saturation percentage to adjust down to for initial cloud<a name='307'></font>
                                 <font color=#447700>! formation (ZVDxx scheme only)<a name='308'></font>
<a name='309'>
  real   , private :: ewfac = 1.0         <font color=#447700>! hack factor applied to graupel and hail collection eff. for droplets<a name='310'></font>
  real   , private :: eii0 = 0.1 ,eii1 = 0.1  <font color=#447700>! graupel-crystal coll. eff. parameters: eii0*exp(eii1*min(temcg(mgs),0.0))<a name='311'></font>
                                     <font color=#447700>! set eii1 = 0 to get a constant value of eii0<a name='312'></font>
  real   , private :: eii0hl = 0.2 ,eii1hl = 0.0  <font color=#447700>! hail-crystal coll. eff. parameters: eii0hl*exp(eii1hl*min(temcg(mgs),0.0))<a name='313'></font>
                                     <font color=#447700>! set eii1hl = 0 to get a constant value of eii0hl<a name='314'></font>
  real   , private :: eri0 = 0.1   <font color=#447700>! rain efficiency to collect ice crystals<a name='315'></font>
  real   , private :: eri_cimin = 10.e-6      <font color=#447700>! minimum ice crystal diameter for collection by rain<a name='316'></font>
  real   , private :: esi0 = 0.1              <font color=#447700>! linear factor in snow-ice collection efficiency<a name='317'></font>
  real   , private :: ehs0 = 0.1, ehs1 = 0.1  <font color=#447700>! graupel-snow coll. eff. parameters: ehs0*exp(ehs1*min(temcg(mgs),0.0))<a name='318'></font>
                                     <font color=#447700>! set ehs1 = 0 to get a constant value of ehs0<a name='319'></font>
  real   , private :: ess0 = 0.5, ess1 = 0.05 <font color=#447700>! snow aggregation coefficients: ess0*exp(ess1*min(temcg(mgs),0.0))<a name='320'></font>
                                     <font color=#447700>! set ess1 = 0 to get a constant value of ess0<a name='321'></font>
  real   , private :: esstem1 = -25.  <font color=#447700>! lower temperature where snow aggregation turns on<a name='322'></font>
  real   , private :: esstem2 = -20.  <font color=#447700>! higher temperature for linear ramp of ess from zero at esstem1 to formula value at esstem2<a name='323'></font>
  real   , private :: ehsfrac = 1.0           <font color=#447700>! multiplier for graupel collection efficiency in wet growth<a name='324'></font>
  real   , private :: ehimin = 0.0 <font color=#447700>! Minimum collection efficiency (graupel - ice crystal)<a name='325'></font>
  real   , private :: ehimax = 1.0 <font color=#447700>! Maximum collection efficiency (graupel - ice crystal)<a name='326'></font>
  real   , private :: ehsmax = 0.5 <font color=#447700>! Maximum collection efficiency (graupel - snow)<a name='327'></font>
  real   , private :: ecollmx = 0.5 <font color=#447700>! Maximum collision efficiency for graup/hail with ice; used only for charging rates<a name='328'></font>
  integer, private :: iglcnvi = 2  <font color=#447700>! flag for riming conversion from cloud ice to rimed ice/graupel<a name='329'></font>
  integer, private :: iglcnvs = 2  <font color=#447700>! flag for conversion from snow to rimed ice/graupel<a name='330'></font>
<a name='331'>
  real   , private :: rz          <font color=#447700>! reflectivity conservation factor for graupel/rain<a name='332'></font>
                         <font color=#447700>! now calculated in icezvd_dr.F from alphah and rnu<a name='333'></font>
                         <font color=#447700>! currently only used for graupel melting to rain<a name='334'></font>
  real   , private :: rzhl        <font color=#447700>! reflectivity conservation factor for hail/rain<a name='335'></font>
                         <font color=#447700>! now calculated in icezvd_dr.F from alphahl and rnu<a name='336'></font>
<a name='337'>
  real   , private :: rzs     <font color=#447700>! reflectivity conservation factor for snow(imusnow=3) with rain (imurain=1)<a name='338'></font>
<a name='339'>
  real   , private :: alphahacx = 0.0 <font color=#447700>! assumed minimum shape parameter for zhacw and zhacr<a name='340'></font>
<a name='341'>
  real   , private :: fconv = 1.0  <font color=#447700>! factor to boost max graupel depletion by riming conversions in 10ICE<a name='342'></font>
<a name='343'>
  real   , private :: rg0 = 400.0  <font color=#447700>! reference graupel density for graupel fall speed<a name='344'></font>
<a name='345'>
  integer, private :: rcond = 2    <font color=#447700>! (Z only) rcond = 2 includes rain condensation in loop with droplet condensation<a name='346'></font>
                                   <font color=#447700>! 0 = no condensation on rain; 1 = bulk condensation on rain<a name='347'></font>
  integer, parameter, private :: icond = 1    <font color=#447700>! (Z only) icond = 1 calculates ice deposition (crystals and snow) BEFORE droplet condensation<a name='348'></font>
                          <font color=#447700>! icond = 2 does not work (intended to calc. dep in loop with droplet cond.)<a name='349'></font>
  <a name='350'>
  real   , private :: dfrz = 0.15e-3 <font color=#447700>! 0.25e-3  ! minimum diameter of frozen drops from Bigg freezing (used for vfrz) for iacr &gt; 1<a name='351'></font>
                            <font color=#447700>! and for ciacrf for iacr=4<a name='352'></font>
  real   , private :: dmlt = 3.0e-3  <font color=#447700>! maximum diameter for rain melting from graupel and hail<a name='353'></font>
  real   , private :: dshd = 1.0e-3  <font color=#447700>! nominal diameter for drops shed from graupel/hail<a name='354'></font>
<a name='355'>
  integer, private :: ihmlt = 2      <font color=#447700>! 1=old melting with vmlt; 2=new melting using mean volume diam of graupel/hail<a name='356'></font>
  integer, private :: imltshddmr = 1 <font color=#447700>! 0 (default)=mean diameter of drops produced during melting+shedding as before (using mean diameter of graupel/hail<a name='357'></font>
                            <font color=#447700>! and max mean diameter of rain)<a name='358'></font>
                            <font color=#447700>! 1=new method where mean diameter of rain during melting is adjusted linearly downward <a name='359'></font>
                            <font color=#447700>! toward 3 mm for large (&gt; sheddiam) graupel and hail, to take into account shedding of <a name='360'></font>
                            <font color=#447700>! smaller drops.  sheddiam0 controls the size of graupel/hail above which the assumed <a name='361'></font>
                            <font color=#447700>! mean diameter of rain is set to 3 mm<a name='362'></font>
                            <font color=#447700>! Only valid for ihmlt = 2 for ZVD(H) but also applies to ZVD(H)M<a name='363'></font>
                            <font color=#447700>! 2 = method that sets the resulting rain size ( vshdgs ) according to the mass-weighted diameter of the ice<a name='364'></font>
<a name='365'>
<a name='366'>
  integer, private :: nsplinter = 0  <font color=#447700>! number of ice splinters per freezing drop, if negative, then per resulting graupel particle<a name='367'></font>
  real,    private :: lawson_splinter_fac = 2.5e-11  <font color=#447700>! constant in Lawson et al. (2015, JAS) for ice particle production from freezing drops<a name='368'></font>
  integer, private :: isnwfrac = 0   <font color=#447700>! 0= no snow fragmentation; 1 = turn on snow fragmentation (Schuur, 2000)<a name='369'></font>
<a name='370'>
<font color=#447700>!  integer, private :: denscale = 1  ! 1=scale num. conc. and charge by air density for advection, 0=turn off for comparison<a name='371'></font>
<a name='372'>
  logical, private :: mixedphase = .false.   <font color=#447700>! .false.=off, true=on to include mixed phase graupel<a name='373'></font>
  integer, private :: imixedphase = 0<a name='374'>
  logical, private :: qsdenmod = .false.     <font color=#447700>! true = modify snow density by linear interpolation of snow and rain density<a name='375'></font>
  logical, private :: qhdenmod = .false.     <font color=#447700>! true = modify graupel density by linear interpolation of graupel and rain density<a name='376'></font>
  logical, private :: qsvtmod = .false.      <font color=#447700>! true = modify snow fall speed by linear interpolation of snow and rain vt<a name='377'></font>
  real   , private :: sheddiam   = 8.0e-03  <font color=#447700>! minimum diameter of graupel before shedding occurs<a name='378'></font>
  real    :: sheddiamlg = 10.0e-03  <font color=#447700>! diameter of hail to use fwmlarge<a name='379'></font>
  real    :: sheddiam0  = 20.0e-03  <font color=#447700>! diameter of hail at which all water is shed<a name='380'></font>
  <a name='381'>
  integer :: ifwmhopt = 1 <font color=#447700>! option for calculating maximum liquid fraction when fwmh and/or fwmhl is set to -1<a name='382'></font>
                          <font color=#447700>! 1 = maximum based on size of maximum mass diameter<a name='383'></font>
                          <font color=#447700>! 2 = integrate over spectrum for maximum liquid (experimental)<a name='384'></font>
<a name='385'>
  real   , private :: fwms = 0.5 <font color=#447700>! maximum liquid water fraction on snow<a name='386'></font>
  real   , private :: fwmh = 0.5 <font color=#447700>! maximum liquid water fraction on graupel<a name='387'></font>
  real   , private :: fwmhl = 0.5 <font color=#447700>! maximum liquid water fraction on hail<a name='388'></font>
  real    :: fwmlarge = 0.2 <font color=#447700>! maximum liquid water fraction on hail larger than sheddiam<a name='389'></font>
  integer :: ifwmfall = 0   <font color=#447700>! whether to interpolate toward rain fall speed for graupel and hail<a name='390'></font>
                            <font color=#447700>! when diam &lt; sheddiam and liquid fraction is predicted (0=no, 1=yes)<a name='391'></font>
  <a name='392'>
  logical :: rescale_high_alpha = .false.  <font color=#447700>! whether to rescale number. conc. when alpha = alphamax (3-moment only)<a name='393'></font>
  logical :: rescale_low_alpha = .true.    <font color=#447700>! whether to rescale Z (graupel/hail) when alpha = alphamin (3-moment only)<a name='394'></font>
  logical :: rescale_low_alphar = .true.    <font color=#447700>! whether to rescale Z for rain when alpha = alphamin (3-moment only)<a name='395'></font>
<a name='396'>
  real, parameter :: alpharmax = 8. <font color=#447700>! limited for rwvent calculation<a name='397'></font>
  <a name='398'>
  integer, private ::  ihlcnh = 1  <font color=#447700>! which graupel -&gt; hail conversion to use<a name='399'></font>
                          <font color=#447700>! 1 = Milbrandt and Yau (2005) using Ziegler 1985 wet growth diameter<a name='400'></font>
                          <font color=#447700>! 2 = Straka and Mansell (2005) conversion using size threshold<a name='401'></font>
  real, private :: hlcnhdia = 1.e-3 <font color=#447700>! threshold diameter for graupel -&gt; hail conversion for ihlcnh = 1 option.<a name='402'></font>
  real, private :: hlcnhqmin = 0.1e-3 <font color=#447700>! minimum graupel mass content for graupel -&gt; hail conversion (ihlcnh = 1)<a name='403'></font>
  real   , private :: hldia1 = 20.0e-3  <font color=#447700>! threshold diameter for graupel -&gt; hail conversion for ihlcnh = 2 option.<a name='404'></font>
  integer :: icvhl2h = 0   <font color=#447700>! allow conversion of hail back to graupel when hail density gets close to minimum allowed<a name='405'></font>
<a name='406'>
  integer, private :: imurain = 1 <font color=#447700>! 3 for gamma-volume, 1 for gamma-diameter DSD for rain.<a name='407'></font>
  integer, private :: imusnow = 3 <font color=#447700>! 3 for gamma-volume, 1 for gamma-diameter DSD for snow (=1 NOT IMPLEMENTED!!).<a name='408'></font>
  integer, private :: iturbenhance = 0 <font color=#447700>! warm-rain collision enhancement<a name='409'></font>
                              <font color=#447700>! 1 = enhance autoconversion only<a name='410'></font>
                              <font color=#447700>! 2 = add rain collection of cloud<a name='411'></font>
                              <font color=#447700>! 3 = add rain self-collection<a name='412'></font>
  integer, private :: isedonly = 0 <font color=#447700>! 1= only do sedimentation and skip other microphysics<a name='413'></font>
  integer, private :: iferwisventr = 2 <font color=#447700>! =1 for Ferrier rwvent, =2 for Wisner rwvent (imurain=1)<a name='414'></font>
  integer, private :: izwisventr   = 2 <font color=#447700>! =1 for old Ziegler rwvent, =2 for Wisner-style rwvent (imurain=3)<a name='415'></font>
  integer :: iresetmoments = 0 <font color=#447700>! if &gt;0, then set all moments to zero when one of them is zero (3-moment only)<a name='416'></font>
  integer, private :: imaxdiaopt    = 3 <font color=#447700>! = 1 use mean diameter for breakup<a name='417'></font>
                               <font color=#447700>! = 2 use maximum mass diameter for breakup<a name='418'></font>
                               <font color=#447700>! = 3 use mass-weighted diameter for breakup<a name='419'></font>
  integer, private :: dmrauto       = 0 <font color=#447700>! = -1 no limiter on crcnw<a name='420'></font>
                              <font color=#447700>! =  0 limit crcnw when qr &gt; 1.2*L (Cohard-Pinty 2002)<a name='421'></font>
                              <font color=#447700>! =  1 DTD version based on MY code<a name='422'></font>
                              <font color=#447700>! =  2 DTD mass-weighted version based on MY code<a name='423'></font>
                              <font color=#447700>! =  3 Milbrandt version (from Cohard and Pinty's code<a name='424'></font>
  real, parameter :: alpharaut = 0.0 <font color=#447700>! MY2005 for autoconversion<a name='425'></font>
  real    :: cxmin = 1.e-4  <font color=#447700>! threshold cutoff for number concentration<a name='426'></font>
  real    :: zxmin = 1.e-28 <font color=#447700>! threshold cutoff for reflectivity moment<a name='427'></font>
  <a name='428'>
  integer :: ithompsoncnoh = 0 <font color=#447700>! For single moment graupel only<a name='429'></font>
                           <font color=#447700>! 0 = fixed intercept<a name='430'></font>
                           <font color=#447700>! 1 = intercept based on graupel mass<a name='431'></font>
<a name='432'>
  integer :: ivhmltsoak = 1   <font color=#447700>! 0=off, 1=on : flag to simulate soaking (graupel/hail) during melting <a name='433'></font>
                         <font color=#447700>! when liquid fraction is not predicted<a name='434'></font>
  integer, private :: ioldlimiter = 0 <font color=#447700>! test switch for new(=0) or old(=1) size limiter at the end of GS for 3-moment categories<a name='435'></font>
  integer, private :: isnowfall = 2   <font color=#447700>! Option for choosing between snow fall speed parameters<a name='436'></font>
                         <font color=#447700>! 1 = original Zrnic et al. (Mansell et al. 2010)<a name='437'></font>
                         <font color=#447700>! 2 = Ferrier 1994 (results in slower fall speeds)<a name='438'></font>
<a name='439'>
  integer, private :: isnowdens = 1   <font color=#447700>! Option for choosing between snow density options<a name='440'></font>
                             <font color=#447700>! 1 = constant of 100 kg m^-3<a name='441'></font>
                             <font color=#447700>! 2 = Option based on Cox<a name='442'></font>
  <a name='443'>
  integer, private  :: ibiggsnow   = 3 <font color=#447700>! 1 = switch conversion over to snow for small frozen drops from Bigg freezing<a name='444'></font>
                                       <font color=#447700>! 2 = switch conversion over to snow for small frozen drops from rain-ice interaction<a name='445'></font>
                                       <font color=#447700>! 3 = switch conversion over to snow for small frozen drops from both<a name='446'></font>
  <a name='447'>
  integer, private  :: ixtaltype = 1 <font color=#447700>! =1 column, =2 disk (similar to Takahashi)<a name='448'></font>
<a name='449'>
  real, private  :: takshedsize1 = 0.15 <font color=#447700>! diameter (cm) of drop shed from ice with D &gt; 1.9 cm<a name='450'></font>
  real, private  :: takshedsize2 = 0.3 <font color=#447700>! diameter (cm) of drop shed from ice with D &lt; 1.9 cm and D &gt; 0.8 cm<a name='451'></font>
  <a name='452'>
  real, private     :: evapfac     = 1.0 <font color=#447700>! Multiplier on rain evaporation rate<a name='453'></font>
  real, private     :: depfac      = 1.0 <font color=#447700>! Multiplier on graupel/hail deposition/sublimation rate<a name='454'></font>
<a name='455'>
  integer, private :: ibinhmlr = 0  <font color=#447700>! =1 use incomplete gammas to determine melting from larger and smaller sizes of graupel, and appropriate shed drop sizes <a name='456'></font>
                           <font color=#447700>! =2 to test melting by temporary bins<a name='457'></font>
  integer, private :: ibinhlmlr = 0  <font color=#447700>! =1 use incomplete gammas to determine melting from larger and smaller sizes of hail, and appropriate shed drop sizes <a name='458'></font>
                            <font color=#447700>! =2 to test melting by temporary bins<a name='459'></font>
  <a name='460'>
  integer :: iqvsopt = 0 <font color=#447700>! =0 use old default for tabqvs; =1 use Bolton formulation (Rogers and Yau)<a name='461'></font>
<a name='462'>
  integer, parameter :: icespheres = 0 <font color=#447700>! turn ice spheres (frozen droplets) on (1) or off (0). NOT COMPLETE IN WRF/ARPS/CM1 CODE!<a name='463'></font>
  integer, parameter :: lqmx = 30<a name='464'>
  integer, parameter :: lt = 1<a name='465'>
  integer, parameter :: lv = 2<a name='466'>
  integer, parameter :: lc = 3<a name='467'>
  integer, parameter :: lr = 4<a name='468'>
  integer, parameter :: li = 5<a name='469'>
  integer, private :: lis = 0<a name='470'>
  integer, private :: ls = 6<a name='471'>
  integer, private :: lh = 7<a name='472'>
  integer, private :: lhl = 0<a name='473'>
<a name='474'>
  integer, private  :: lccn = 9 <font color=#447700>! 0 or 9, other indices adjusted accordingly<a name='475'></font>
  integer, private :: lccna = 0<a name='476'>
  integer, private :: lcina = 0<a name='477'>
  integer, private :: lcin = 0<a name='478'>
  integer, private :: lnc = 9<a name='479'>
  integer, private :: lnr = 10<a name='480'>
  integer, private :: lni = 11<a name='481'>
  integer, private :: lnis = 0<a name='482'>
  integer, private :: lns = 12<a name='483'>
  integer, private :: lnh = 13<a name='484'>
  integer, private :: lnhl = 0<a name='485'>
  integer, private :: lss = 0<a name='486'>
  integer :: lvh = 15<a name='487'>
<a name='488'>
  integer, private :: lhab = 8<a name='489'>
  integer, private :: lg = 7<a name='490'>
<a name='491'>
<font color=#447700>! Particle volume<a name='492'></font>
<a name='493'>
  integer :: lvi = 0<a name='494'>
  integer :: lvs = 0<a name='495'>
  integer :: lvgl = 0<a name='496'>
  integer :: lvgm = 0<a name='497'>
  integer :: lvgh = 0<a name='498'>
  integer :: lvf = 0<a name='499'>
<font color=#447700>!  integer :: lvh = 16<a name='500'></font>
  integer :: lvhl = 0<a name='501'>
<a name='502'>
<font color=#447700>! liquid water fraction (not predicted here but tested for)<a name='503'></font>
  integer :: lhw = 0<a name='504'>
  integer :: lsw = 0<a name='505'>
  integer :: lhlw = 0<a name='506'>
<a name='507'>
<font color=#447700>! reflectivity (6th moment) ! not predicted here but may be tested against<a name='508'></font>
<a name='509'>
  integer :: lzr = 0<a name='510'>
  integer :: lzi = 0<a name='511'>
  integer :: lzs = 0<a name='512'>
  integer :: lzgl = 0<a name='513'>
  integer :: lzgm = 0<a name='514'>
  integer :: lzgh = 0<a name='515'>
  integer :: lzf = 0<a name='516'>
  integer :: lzh = 0<a name='517'>
  integer :: lzhl = 0<a name='518'>
<a name='519'>
<font color=#447700>! Space charge<a name='520'></font>
<a name='521'>
  integer :: lscw = 0<a name='522'>
  integer :: lscr = 0<a name='523'>
  integer :: lsci = 0<a name='524'>
  integer :: lscis = 0<a name='525'>
  integer :: lscs = 0<a name='526'>
  integer :: lsch = 0<a name='527'>
  integer :: lschl = 0<a name='528'>
  integer :: lscwi = 0<a name='529'>
  integer :: lscpi = 0<a name='530'>
  integer :: lscni = 0<a name='531'>
  integer :: lscpli = 0<a name='532'>
  integer :: lscnli = 0<a name='533'>
  integer :: lschab = 0<a name='534'>
<a name='535'>
  integer :: lscb = 0<a name='536'>
  integer :: lsce = 0<a name='537'>
  integer :: lsceq = 0<a name='538'>
<a name='539'>
<font color=#447700>!  integer, parameter :: lscmx = 100<a name='540'></font>
<a name='541'>
  integer :: lne = 0 <font color=#447700>! last varible for transforming<a name='542'></font>
<a name='543'>
  real :: cnoh0 = 4.0e+5<a name='544'>
  real :: hwdn1 = 700.0<a name='545'>
<a name='546'>
  real    :: alphai  = 0.0 <font color=#447700>! shape parameter for ZIEG ice crystals ! not currently used<a name='547'></font>
  real    :: alphas  = 0.0 <font color=#447700>! shape parameter for ZIEG snow         ! used only for single moment<a name='548'></font>
  real    :: alphar  = 0.0 <font color=#447700>! shape parameter for rain (imurain=1 only)<a name='549'></font>
  real, private    :: alphah  = 0.0 <font color=#447700>! set in namelist!! shape parameter for ZIEG graupel<a name='550'></font>
  real, private    :: alphahl = 1.0 <font color=#447700>! set in namelist!! shape parameter for ZIEG hail<a name='551'></font>
<a name='552'>
  real    :: dmuh    = 1.0  <font color=#447700>! power in exponential part (graupel)<a name='553'></font>
  real    :: dmuhl   = 1.0  <font color=#447700>! power in exponential part (hail)<a name='554'></font>
<a name='555'>
  real, parameter :: alphamax = 15.<a name='556'>
  real, parameter :: alphamin = 0.<a name='557'>
  real, parameter :: rnumin = -0.8<a name='558'>
  real, parameter :: rnumax = 15.0<a name='559'>
<a name='560'>
  <a name='561'>
  real            :: cnu = 0.0<a name='562'>
  real, parameter :: rnu = -0.8, snu = -0.8, cinu = 0.0<a name='563'>
<font color=#447700>!      parameter ( cnu = 0.0, rnu = -0.8, snu = -0.8, cinu = 0.0 )<a name='564'></font>
  <a name='565'>
  real xnu(lc:lqmx) <font color=#447700>! 1st shape parameter (mass)<a name='566'></font>
  real xmu(lc:lqmx) <font color=#447700>! 2nd shape parameter (mass)<a name='567'></font>
  real dnu(lc:lqmx) <font color=#447700>! 1st shape parameter (diameter)<a name='568'></font>
  real dmu(lc:lqmx) <font color=#447700>! 2nd shape parameter (diameter)<a name='569'></font>
  <a name='570'>
  real ax(lc:lqmx)<a name='571'>
  real bx(lc:lqmx)<a name='572'>
  real fx(lc:lqmx)<a name='573'>
<a name='574'>
      real da0 (lc:lqmx)          <font color=#447700>! collection coefficients from Seifert 2005<a name='575'></font>
      real dab0(lc:lqmx,lc:lqmx)  <font color=#447700>! collection coefficients from Seifert 2005<a name='576'></font>
      real dab1(lc:lqmx,lc:lqmx)  <font color=#447700>! collection coefficients from Seifert 2005<a name='577'></font>
      real da1 (lc:lqmx)          <font color=#447700>! collection coefficients from Seifert 2005<a name='578'></font>
      real bb  (lc:lqmx)<a name='579'>
<a name='580'>
<font color=#447700>! put ipelec here for now....<a name='581'></font>
  integer :: ipelec = 0<a name='582'>
  integer :: isaund = 0<a name='583'>
  logical :: idonic = .false.<a name='584'>
  integer :: jchgs = 3  <font color=#447700>! number of points near boundary where charging is turned off (to keep lightning from getting wonky)<a name='585'></font>
  integer :: jchgn = 2<a name='586'>
  integer :: ichge = 3<a name='587'>
  integer :: ichgw = 2<a name='588'>
  real    :: charging_border = 4000. <font color=#447700>! width of no-charging zone from boundary<a name='589'></font>
      real, private    :: delqnw = -1.0e-10<font color=#447700>!-1.0e-12 !<a name='590'></font>
      real, private    :: delqxw =  1.0e-10<font color=#447700>! 1.0e-12 !<a name='591'></font>
      real :: tindmn = 233, tindmx = 298.0  <font color=#447700>! min and max temperatures where inductive charging is allowed<a name='592'></font>
<a name='593'>
<font color=#447700>!<a name='594'></font>
<font color=#447700>!  gamma function lookup table<a name='595'></font>
<font color=#447700>!<a name='596'></font>
      integer ngm0,ngm1,ngm2<a name='597'>
      parameter (ngm0=3001,ngm1=500,ngm2=500)<a name='598'>
      double precision, parameter :: dgam = 0.01, dgami = 100.<a name='599'>
      double precision gmoi(0:ngm0) <font color=#447700>! ,gmod(0:ngm1,0:ngm2),gmdi(0:ngm1,0:ngm2)<a name='600'></font>
<a name='601'>
      integer, parameter :: nqiacralpha =  240 <font color=#447700>!480 ! 240 ! 120 ! 15<a name='602'></font>
      integer, parameter :: nqiacrratio =  100 <font color=#447700>! 500 !50  ! 25<a name='603'></font>
      real,    parameter :: maxratiolu = 25.<a name='604'>
      real,    parameter :: maxalphalu = 15.<a name='605'>
      real,    parameter :: dqiacralpha = maxalphalu/Float(nqiacralpha), dqiacrratio = maxratiolu/Float(nqiacrratio) <a name='606'>
      real,    parameter :: dqiacrratioinv = 1./dqiacrratio, dqiacralphainv = 1./dqiacralpha<a name='607'>
      real :: ciacrratio(0:nqiacrratio,0:nqiacralpha)<a name='608'>
      real :: qiacrratio(0:nqiacrratio,0:nqiacralpha)<a name='609'>
      real :: ziacrratio(0:nqiacrratio,0:nqiacralpha)<a name='610'>
      double precision :: gamxinflu(0:nqiacrratio,0:nqiacralpha,10,2) <font color=#447700>! last index for graupel (1) or hail (2)<a name='611'></font>
<a name='612'>
    integer, parameter :: ngdnmm = 9<a name='613'>
    real :: mmgraupvt(ngdnmm,3)  <font color=#447700>! Milbrandt and Morrison (2013) fall speed coefficients for graupel/hail<a name='614'></font>
<a name='615'>
    DATA mmgraupvt(:,1) / 50., 150., 250., 350., 450., 550., 650., 750., 850./<a name='616'>
    DATA mmgraupvt(:,2) / 62.923, 94.122, 114.74, 131.21, 145.26, 157.71, 168.98, 179.36, 189.02 /<a name='617'>
    DATA mmgraupvt(:,3) / 0.67819, 0.63789, 0.62197, 0.61240, 0.60572, 0.60066, 0.59663, 0.59330, 0.59048 /<a name='618'>
<a name='619'>
      integer lsc(lc:lqmx)<a name='620'>
      integer ln(lc:lqmx)<a name='621'>
      integer ipc(lc:lqmx)<a name='622'>
      integer lvol(lc:lqmx)<a name='623'>
      integer lz(lc:lqmx)<a name='624'>
      integer lliq(li:lqmx)<a name='625'>
      integer denscale(lc:lqmx) <font color=#447700>! flag for density scaling (mixing ratio conversion)<a name='626'></font>
<a name='627'>
      integer ido(lc:lqmx)<a name='628'>
      logical ldovol<a name='629'>
<a name='630'>
      real xdn0(lc:lqmx)<a name='631'>
      real xdnmx(lc:lqmx), xdnmn(lc:lqmx)<a name='632'>
      real cdx(lc:lqmx)<a name='633'>
      real cno(lc:lqmx)<a name='634'>
      real xvmn(lc:lqmx), xvmx(lc:lqmx)<a name='635'>
      real qxmin(lc:lqmx)<a name='636'>
<a name='637'>
      integer nqsat<a name='638'>
      parameter (nqsat=1000001) <font color=#447700>! (nqsat=20001)<a name='639'></font>
      real fqsat,fqsati<a name='640'>
      parameter (fqsat=0.002,fqsati=1./fqsat)<a name='641'>
      real tabqvs(nqsat),tabqis(nqsat),dtabqvs(nqsat),dtabqis(nqsat)<a name='642'>
<a name='643'>
<font color=#447700>!<a name='644'></font>
<font color=#447700>!  constants<a name='645'></font>
<font color=#447700>!<a name='646'></font>
      real, parameter :: cp608 = 0.608          <font color=#447700>! constant used in conversion of T to Tv<a name='647'></font>
      real, parameter :: ar = 841.99666         <font color=#447700>! rain terminal velocity power law coefficient (LFO)<a name='648'></font>
      real, parameter :: br = 0.8               <font color=#447700>! rain terminal velocity power law coefficient (LFO)<a name='649'></font>
      real, parameter :: aradcw = -0.27544      <font color=#447700>!<a name='650'></font>
      real, parameter :: bradcw = 0.26249e+06   <font color=#447700>!<a name='651'></font>
      real, parameter :: cradcw = -1.8896e+10   <font color=#447700>!<a name='652'></font>
      real, parameter :: dradcw = 4.4626e+14    <font color=#447700>!<a name='653'></font>
      real, parameter :: bta1 = 0.6             <font color=#447700>! beta-1 constant used for ice nucleation by deposition (Ferrier 94, among others)<a name='654'></font>
      real, parameter :: cnit = 1.0e-02         <font color=#447700>! No for ice nucleation by deposition (Cotton et al. 86)<a name='655'></font>
      real, parameter :: dragh = 0.60           <font color=#447700>! coefficient used to adjust fall speed for hail versus graupel (Pruppacher and Klett 78)<a name='656'></font>
      real, parameter :: dnz00 = 1.225          <font color=#447700>! reference/MSL air density<a name='657'></font>
      real, parameter :: rho00 = 1.225          <font color=#447700>! reference/MSL air density<a name='658'></font>
<font color=#447700>!      cs = 4.83607122       ! snow terminal velocity power law coefficient (LFO)<a name='659'></font>
<font color=#447700>!      ds = 0.25             ! snow terminal velocity power law coefficient (LFO)<a name='660'></font>
<font color=#447700>!  new values for  cs and ds<a name='661'></font>
      real, parameter :: cs = 12.42             <font color=#447700>! snow terminal velocity power law coefficient <a name='662'></font>
      real, parameter :: ds = 0.42              <font color=#447700>! snow terminal velocity power law coefficient <a name='663'></font>
      real, parameter :: pi = 3.141592653589793<a name='664'>
      real, parameter :: piinv = 1./pi<a name='665'>
      real, parameter :: pid4 = pi/4.0<a name='666'>
<a name='667'>
      real, parameter :: gr = 9.8<a name='668'>
<a name='669'>
<font color=#447700>!<a name='670'></font>
<font color=#447700>! max and min mean volumes<a name='671'></font>
<font color=#447700>!<a name='672'></font>
      real xvrmn, xvrmx0  <font color=#447700>! min, max rain volumes<a name='673'></font>
      real xvsmn, xvsmx  <font color=#447700>! min, max snow volumes<a name='674'></font>
      real xvfmn, xvfmx  <font color=#447700>! min, max frozen drop volumes<a name='675'></font>
      real xvgmn, xvgmx  <font color=#447700>! min, max graupel volumes<a name='676'></font>
      real xvhmn, xvhmn0, xvhmx, xvhmx0  <font color=#447700>! min, max hail volumes<a name='677'></font>
      real xvhlmn, xvhlmx  <font color=#447700>! min, max lg hail volumes<a name='678'></font>
<a name='679'>
      real, parameter :: dhlmn = 0.3e-3, dhlmx = 40.e-3<a name='680'>
      real, parameter :: dhmn0 = 0.3e-3<a name='681'>
      real, private :: dhmn = dhmn0, dhmx = -1.<a name='682'>
<a name='683'>
      real, parameter :: cwradn = 2.5e-6, xcradmn = cwradn    <font color=#447700>! minimum radius<a name='684'></font>
      real, parameter :: cwradx = 60.e-6, xcradmx = cwradx    <font color=#447700>! maximum radius<a name='685'></font>
      real, parameter :: cwc1 = 6.0/(pi*1000.)<a name='686'>
<a name='687'>
<font color=#447700>!      parameter( xvcmn=4.188e-18 )   ! mks  min volume = 3 micron radius<a name='688'></font>
      real, parameter :: xvcmn=0.523599*(2.*cwradn)**3    <font color=#447700>! mks  min volume = 2.5 micron radius<a name='689'></font>
      real, parameter :: xvcmx=0.523599*(2.*xcradmx)**3    <font color=#447700>! mks  min volume = 2.5 micron radius<a name='690'></font>
      real, parameter :: cwmasn = 1000.*xvcmn   <font color=#447700>! minimum mass, defined by radius of 5.0e-6<a name='691'></font>
      real, parameter :: cwmasx = 1000.*xvcmx   <font color=#447700>! maximum mass, defined by radius of 50.0e-6<a name='692'></font>
      real, parameter :: cwmasn5 = 1000.*0.523599*(2.*5.0e-6)**3 <font color=#447700>!  5.23e-13<a name='693'></font>
<a name='694'>
      real, parameter :: xvimn=0.523599*(2.*5.e-6)**3    <font color=#447700>! mks  min volume = 5 micron radius<a name='695'></font>
      real, parameter :: xvimx=0.523599*(2.*1.e-3)**3    <font color=#447700>! mks  max volume = 1 mm radius (solid sphere approx)<a name='696'></font>
      <a name='697'>
      real     :: xvdmx = -1.0 <font color=#447700>! 3.0e-3<a name='698'></font>
      real     :: xvrmx<a name='699'>
      parameter( xvrmn=0.523599*(80.e-6)**3, xvrmx0=0.523599*(6.e-3)**3 ) <font color=#447700>!( was 4.1887e-9 )  ! mks<a name='700'></font>
      parameter( xvsmn=0.523599*(0.01e-3)**3, xvsmx=0.523599*(10.e-3)**3 ) <font color=#447700>!( was 4.1887e-9 )  ! mks<a name='701'></font>
      parameter( xvfmn=0.523599*(0.1e-3)**3, xvfmx=0.523599*(10.e-3)**3 )  <font color=#447700>! mks xvfmx = (pi/6)*(10mm)**3<a name='702'></font>
      parameter( xvgmn=0.523599*(0.1e-3)**3, xvgmx=0.523599*(10.e-3)**3 )  <font color=#447700>! mks xvfmx = (pi/6)*(10mm)**3<a name='703'></font>
      parameter( xvhmn0=0.523599*(0.3e-3)**3, xvhmx0=0.523599*(20.e-3)**3 )  <font color=#447700>! mks xvfmx = (pi/6)*(10mm)**3<a name='704'></font>
      parameter( xvhlmn=0.523599*(dhlmn)**3, xvhlmx=0.523599*(dhlmx)**3 )  <font color=#447700>! mks xvfmx = (pi/6)*(10mm)**3<a name='705'></font>
<a name='706'>
<font color=#447700>!<a name='707'></font>
<font color=#447700>!  electrical permitivity of air C / (N m**2) -  check the units<a name='708'></font>
<font color=#447700>!<a name='709'></font>
      real eperao<a name='710'>
      parameter (eperao  = 8.8592e-12 )<a name='711'>
<a name='712'>
      real ec,eci  <font color=#447700>! fundamental unit of charge<a name='713'></font>
      parameter (ec = 1.602e-19)<a name='714'>
      parameter (eci = 1.0/ec)<a name='715'>
<a name='716'>
      real    :: scwppmx = 20.0e-12<a name='717'>
      real    :: scippmx = 20.0e-12<a name='718'>
<font color=#447700>!<a name='719'></font>
<font color=#447700>!  constants<a name='720'></font>
<font color=#447700>!<a name='721'></font>
      real, parameter :: c1f3 = 1.0/3.0<a name='722'>
<a name='723'>
      real, parameter :: cai = 21.87455<a name='724'>
      real, parameter :: caw = 17.2693882<a name='725'>
      real, parameter :: cbi = 7.66<a name='726'>
      real, parameter :: cbw = 35.86<a name='727'>
<a name='728'>
      real, parameter :: cbwbolton = 29.65 <font color=#447700>! constants for Bolton formulation<a name='729'></font>
      real, parameter :: cawbolton = 17.67<a name='730'>
<a name='731'>
      real, parameter :: tfr = 273.15, tfrh = 233.15<a name='732'>
<a name='733'>
      real, parameter :: cp = 1004.0, rd = 287.04<a name='734'>
      real, parameter :: cpi = 1./cp<a name='735'>
      real, parameter :: cap = rd/cp, poo = 1.0e+05<a name='736'>
<a name='737'>
      real, parameter :: rw = 461.5              <font color=#447700>! gas const. for water vapor<a name='738'></font>
      real, parameter :: advisc0 = 1.832e-05     <font color=#447700>! reference dynamic viscosity (SMT; see Beard &amp; Pruppacher 71)<a name='739'></font>
      real, parameter :: advisc1 = 1.718e-05     <font color=#447700>! dynamic viscosity constant used in thermal conductivity calc<a name='740'></font>
      real, parameter :: tka0 = 2.43e-02         <font color=#447700>! reference thermal conductivity<a name='741'></font>
      real, parameter :: tfrcbw = tfr - cbw<a name='742'>
      real, parameter :: tfrcbi = tfr - cbi<a name='743'>
<a name='744'>
     <font color=#447700>! GHB: Needed for eqtset=2 in cm1<a name='745'></font>
<font color=#447700>!     REAL, PRIVATE ::      cv = cp - rd<a name='746'></font>
     real, private, parameter ::      cv = 717.0             <font color=#447700>! specific heat at constant volume - air<a name='747'></font>
     REAL, PRIVATE, parameter ::      cvv = 1408.5<a name='748'>
     REAL, PRIVATE, parameter ::      cpl = 4190.0<a name='749'>
     REAL, PRIVATE, parameter ::      cpigb = 2106.0<a name='750'>
     <font color=#447700>! GHB<a name='751'></font>
<a name='752'>
      real, parameter ::  bfnu0 = (rnu + 2.0)/(rnu + 1.0) <a name='753'>
      real :: ventr, ventrn, ventc, c1sw<a name='754'>
<a name='755'>
<a name='756'>
      real :: cckm,ccne,ccnefac,cnexp,CCNE0<a name='757'>
<a name='758'>
      integer :: na = 9<a name='759'>
      integer :: nxtra = 1<a name='760'>
      real gf4p5, gf4ds, gf4br<a name='761'>
      real gsnow1, gsnow53, gsnow73<a name='762'>
      real gfcinu1, gfcinu1p47, gfcinu2p47<a name='763'>
<a name='764'>
      real :: cwchtmp0 = 1.0<a name='765'>
      real :: cwchltmp0 = 1.0<a name='766'>
<a name='767'>
      real    :: esctot = 1.0e-13<a name='768'>
<a name='769'>
      integer iexy(lc:lqmx,lc:lqmx)<a name='770'>
      integer :: ieswi = 1,  ieswc = 1, ieswr = 0<a name='771'>
      integer :: iehlsw = 1, iehli = 1,  iehlc = 1, iehlr = 0<a name='772'>
      integer :: iehwsw = 1, iehwi = 1,  iehwc = 1, iehwr = 0<a name='773'>
<a name='774'>
      logical, parameter :: do_satadj_for_wrfchem = .true.<a name='775'>
<a name='776'>
<font color=#447700>! #####################################################################<a name='777'></font>
<font color=#447700>! #####################################################################<a name='778'></font>
<a name='779'>
 CONTAINS<a name='780'>
<a name='781'>
<font color=#447700>! #####################################################################<a name='782'></font>
<font color=#447700>! #####################################################################<a name='783'></font>
<a name='784'>
<A NAME='FQVS'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FQVS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='785'>
 REAL <font color=#993300>FUNCTION </font><font color=#cc0000>fqvs</font>(t)<a name='786'>
  implicit none<a name='787'>
  real :: t<a name='788'>
  fqvs = exp(caw*(t-273.15)/(t-cbw))<a name='789'>
 END FUNCTION fqvs<a name='790'>
<a name='791'>
<A NAME='FQIS'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FQIS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='792'>
 REAL <font color=#993300>FUNCTION </font><font color=#cc0000>fqis</font>(t)<a name='793'>
  implicit none<a name='794'>
  real :: t<a name='795'>
  fqis = exp(cai*(t-273.15)/(t-cbi))<a name='796'>
 END FUNCTION fqis<a name='797'>
<a name='798'>
<font color=#447700>! #####################################################################<a name='799'></font>
 <a name='800'>
<A NAME='NSSL_2MOM_INIT'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='801'>
       <font color=#993300>SUBROUTINE </font><font color=#cc0000>nssl_2mom_init</font>(  &amp; <A href='../../call_to/NSSL_2MOM_INIT.html' TARGET='index'>5</A>,<A href='../../call_from/NSSL_2MOM_INIT.html' TARGET='index'>32</A><a name='802'>
     &amp; ims,ime, jms,jme, kms,kme, nssl_params, ipctmp, mixphase,ihvol,idonictmp)<a name='803'>
<a name='804'>
  implicit none<a name='805'>
  <a name='806'>
   integer, intent(in) :: ims,ime, jms,jme, kms,kme<a name='807'>
   real,  intent(in), dimension(20) :: nssl_params<a name='808'>
<a name='809'>
<a name='810'>
<a name='811'>
   integer, intent(in) :: ipctmp,mixphase,ihvol<a name='812'>
   logical, optional, intent(in) :: idonictmp<a name='813'>
     double precision :: arg<a name='814'>
     real    :: temq<a name='815'>
     integer :: igam<a name='816'>
     integer :: i,il,j,l<a name='817'>
     integer :: ltmp<a name='818'>
     integer :: isub<a name='819'>
     real    :: bxh,bxhl<a name='820'>
<a name='821'>
      real    :: alp,ratio,x,y,y7<a name='822'>
     <a name='823'>
<a name='824'>
<a name='825'>
<font color=#447700>!<a name='826'></font>
<font color=#447700>! set some global values from namelist input<a name='827'></font>
<font color=#447700>!<a name='828'></font>
<a name='829'>
      ccn      = nssl_params(1)<a name='830'>
      alphah   = nssl_params(2)<a name='831'>
      alphahl  = nssl_params(3)<a name='832'>
      cnoh     = nssl_params(4)<a name='833'>
      cnohl    = nssl_params(5)<a name='834'>
      cnor     = nssl_params(6)<a name='835'>
      cnos     = nssl_params(7)<a name='836'>
      rho_qh   = nssl_params(8)<a name='837'>
      rho_qhl  = nssl_params(9)<a name='838'>
      rho_qs   = nssl_params(10)<a name='839'>
<a name='840'>
<a name='841'>
      cwccn = ccn<a name='842'>
<a name='843'>
      lhab = 8<a name='844'>
      lhl = 8<a name='845'>
      IF ( icespheres &gt;= 1 ) THEN<a name='846'>
        lhab = lhab + 1<a name='847'>
        lis = li + 1<a name='848'>
        ls = ls + 1<a name='849'>
        lh = lh + 1<a name='850'>
        lhl = lhl + 1<a name='851'>
      ENDIF<a name='852'>
      IF ( ihvol &lt;= -1 .or. ihvol == 2 ) THEN<a name='853'>
        IF ( ihvol == -1 .or. ihvol == -2 ) THEN<a name='854'>
        lhab = lhab - 1  <font color=#447700>! turns off hail<a name='855'></font>
        lhl = 0<a name='856'>
        ehw0 = 0.75<a name='857'>
        iehw = 2<a name='858'>
        dfrz = Max( dfrz, 0.5e-3 )<a name='859'>
        ENDIF<a name='860'>
        IF ( ihvol == -2 .or. ihvol == 2 ) THEN <font color=#447700>! ice crystals are turned off<a name='861'></font>
         <font color=#447700>! a value of -3 means to turn off ice crystals but turn on hail<a name='862'></font>
          renucfrac = 1.0<a name='863'>
          ffrzs = 1.0<a name='864'>
          <font color=#447700>! idoci = 0 ! try this later<a name='865'></font>
        ENDIF<a name='866'>
      ENDIF<a name='867'>
<a name='868'>
<font color=#447700>!      IF ( ipelec &gt; 0 ) idonic = .true.<a name='869'></font>
<a name='870'>
<font color=#447700>!<a name='871'></font>
<font color=#447700>! Build lookup table for saturation mixing ratio (Soong and Ogura 73)<a name='872'></font>
<font color=#447700>!<a name='873'></font>
<a name='874'>
      do l = 1,nqsat<a name='875'>
      temq = 163.15 + (l-1)*fqsat<a name='876'>
      IF ( iqvsopt == 0 ) THEN<a name='877'>
      tabqvs(l) = exp(caw*(temq-273.15)/(temq-cbw))<a name='878'>
      dtabqvs(l) = ((-caw*(-273.15 + temq))/(temq - cbw)**2 + &amp;<a name='879'>
     &amp;                 caw/(temq - cbw))*tabqvs(l)<a name='880'>
      ELSE<a name='881'>
      tabqvs(l) = exp(caw*(temq-273.15)/(temq-cbw))<a name='882'>
      dtabqvs(l) = ((-cawbolton*(-273.15 + temq))/(temq - cbwbolton)**2 + &amp;<a name='883'>
     &amp;                 cawbolton/(temq - cbwbolton))*tabqvs(l)<a name='884'>
      ENDIF<a name='885'>
      tabqis(l) = exp(cai*(temq-273.15)/(temq-cbi))<a name='886'>
      dtabqis(l) = ((-cai*(-273.15 + temq))/(temq - cbi)**2 + &amp;<a name='887'>
     &amp;                 cai/(temq - cbi))*tabqis(l)<a name='888'>
      end do<a name='889'>
<a name='890'>
      bx(lr) = 0.85<a name='891'>
      ax(lr) = 1647.81<a name='892'>
      fx(lr) = 135.477<a name='893'>
      <a name='894'>
      IF ( icdx == 6 ) THEN<a name='895'>
        bx(lh) = 0.6 <font color=#447700>! Milbrandt and Morrison (2013) for density of 550.<a name='896'></font>
        ax(lh) = 157.71<a name='897'>
      ELSEIF ( icdx &gt; 0 ) THEN<a name='898'>
        bx(lh) = 0.5<a name='899'>
        ax(lh) = 75.7149<a name='900'>
      ELSE<a name='901'>
        bx(lh) = 0.37 <font color=#447700>! 0.6  ! Ferrier 1994<a name='902'></font>
        ax(lh) = 19.3<a name='903'>
      ENDIF<a name='904'>
<font color=#447700>!      bx(lh) = 0.6<a name='905'></font>
<a name='906'>
      IF ( lhl .gt. 1 ) THEN<a name='907'>
        IF ( icdxhl == 6 ) THEN<a name='908'>
          bx(lhl) = 0.593 <font color=#447700>! Milbrandt and Morrison (2013) for density of 750.<a name='909'></font>
          ax(lhl) = 179.36<a name='910'>
        ELSEIF (icdxhl &gt; 0 ) THEN<a name='911'>
          bx(lhl) = 0.5<a name='912'>
          ax(lhl) = 75.7149<a name='913'>
        ELSE<a name='914'>
          ax(lhl) = 206.984  <font color=#447700>! Ferrier 1994<a name='915'></font>
          bx(lhl) = 0.6384<a name='916'>
        ENDIF<a name='917'>
      ENDIF<a name='918'>
<a name='919'>
<font color=#447700>! fill in the complete gamma function lookup table<a name='920'></font>
     gmoi(0) = 1.d32<a name='921'>
     do igam = 1,ngm0<a name='922'>
      arg = dgam*igam<a name='923'>
      gmoi(igam) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_DP'>gamma_dp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_DP_1">(arg)<a name='924'>
     end do<a name='925'>
<a name='926'>
     <font color=#447700>! build lookup table to compute the number and mass fractions of rain drops <a name='927'></font>
     <font color=#447700>! (imurain=1) greater than a given diameter. Used for qiacr and ciacr<a name='928'></font>
     <font color=#447700>! Uses incomplete gamma functions<a name='929'></font>
     <font color=#447700>! The terms with bxh or bxhl will be off if the actual bxh or bxhl is different from the base value (icdx=6 option)<a name='930'></font>
      <a name='931'>
      bxh = bx(lh)<a name='932'>
      bxhl = bx(Max(lh,lhl))<a name='933'>
      <a name='934'>
      DO j = 0,nqiacralpha<a name='935'>
      alp = float(j)*dqiacralpha<a name='936'>
      y = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_1">(1.+alp)<a name='937'>
      DO i = 1,nqiacrratio<a name='938'>
        ratio = float(i)*dqiacrratio<a name='939'>
        x = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF'>gamxinf</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINF_1">( 1.+alp, ratio )<a name='940'>
<font color=#447700>!        write(0,*) 'i, x/y = ',i, x/y<a name='941'></font>
        ciacrratio(i,j) = x/y<a name='942'>
<a name='943'>
        <font color=#447700>! graupel (.,.,.,1)<a name='944'></font>
        gamxinflu(i,j,1,1) = x/y<a name='945'>
        gamxinflu(i,j,2,1) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF'>gamxinf</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINF_2">( 2.0+alp, ratio )/y<a name='946'>
        gamxinflu(i,j,3,1) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF'>gamxinf</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINF_3">( 2.5+alp+0.5*bxh, ratio )/y<a name='947'>
        gamxinflu(i,j,5,1) = (gamma_sp(5.0+alp) - gamxinf( 5.0+alp, ratio ))/y<a name='948'>
        gamxinflu(i,j,6,1) = (gamma_sp(5.5+alp+0.5*bxh) - gamxinf( 5.5+alp+0.5*bxh, ratio ))/y<a name='949'>
        gamxinflu(i,j,9,1) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF'>gamxinf</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINF_4">( 1.0+alp, ratio )/y<a name='950'>
        gamxinflu(i,j,10,1)= <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF'>gamxinf</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINF_5">( 4.0+alp, ratio )/y<a name='951'>
       <a name='952'>
        <font color=#447700>! hail (.,.,.,2)<a name='953'></font>
        gamxinflu(i,j,1,2) = gamxinflu(i,j,1,1)<a name='954'>
        gamxinflu(i,j,2,2) = gamxinflu(i,j,2,1)<a name='955'>
        gamxinflu(i,j,3,2) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF'>gamxinf</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINF_6">( 2.5+alp+0.5*bxhl, ratio )/y<a name='956'>
        gamxinflu(i,j,5,2) = gamxinflu(i,j,5,1)<a name='957'>
        gamxinflu(i,j,6,2) = (gamma_sp(5.5+alp+0.5*bxhl) - gamxinf( 5.5+alp+0.5*bxhl, ratio ))/y<a name='958'>
        gamxinflu(i,j,9,2) = gamxinflu(i,j,9,1)<a name='959'>
        gamxinflu(i,j,10,2)= gamxinflu(i,j,10,1)<a name='960'>
<a name='961'>
      IF ( alp &gt; 1.1 ) THEN<a name='962'>
<font color=#447700>!       gamxinflu(i,j,7,1) = gamxinf( alp - 1., ratio )/y<a name='963'></font>
       gamxinflu(i,j,7,1) = (gamma_sp(alp - 1.) - gamxinf( alp - 1., ratio ))/y<a name='964'>
<font color=#447700>!       gamxinflu(i,j,8,1) = gamxinf( alp - 0.5 + 0.5*bxh, ratio )/y<a name='965'></font>
       gamxinflu(i,j,8,1) = (gamma_sp(alp - 0.5 + 0.5*bxh) - gamxinf( alp - 0.5 + 0.5*bxh, ratio ))/y<a name='966'>
<font color=#447700>!       gamxinflu(i,j,8,2) = gamxinf( alp - 0.5 + 0.5*bxhl, ratio )/y<a name='967'></font>
       gamxinflu(i,j,8,2) = (gamma_sp(alp - 0.5 + 0.5*bxhl) - gamxinf( alp - 0.5 + 0.5*bxhl, ratio ))/y<a name='968'>
      ELSE<a name='969'>
<font color=#447700>!       gamxinflu(i,j,7,1) = gamxinf( .1, ratio )/y<a name='970'></font>
       gamxinflu(i,j,7,1) = (gamma_sp(0.1) - gamxinf( 0.1, ratio ) )/y<a name='971'>
<font color=#447700>!       gamxinflu(i,j,8,1) = gamxinf( 1.1 - 0.5 + 0.5*bxh, ratio )/y<a name='972'></font>
<font color=#447700>!       gamxinflu(i,j,8,2) = gamxinf( 1.1 - 0.5 + 0.5*bxhl, ratio )/y<a name='973'></font>
       gamxinflu(i,j,8,1) = (gamma_sp(1.1 - 0.5 + 0.5*bxh) - gamxinf( 1.1 - 0.5 + 0.5*bxh, ratio ) )/y<a name='974'>
       gamxinflu(i,j,8,2) = (gamma_sp(1.1 - 0.5 + 0.5*bxhl) - gamxinf( 1.1 - 0.5 + 0.5*bxhl, ratio ) )/y<a name='975'>
      ENDIF<a name='976'>
        <a name='977'>
        gamxinflu(i,j,7,2) = gamxinflu(i,j,7,1)<a name='978'>
<a name='979'>
      ENDDO<a name='980'>
      ENDDO<a name='981'>
      ciacrratio(0,:) = 1.0<a name='982'>
<a name='983'>
      DO j = 0,nqiacralpha<a name='984'>
      alp = float(j)*dqiacralpha<a name='985'>
      y = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_2">(4.+alp)<a name='986'>
      y7 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_3">(7.+alp)<a name='987'>
      DO i = 1,nqiacrratio<a name='988'>
        ratio = float(i)*dqiacrratio<a name='989'>
        x = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF'>gamxinf</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINF_7">( 4.+alp, ratio )<a name='990'>
<font color=#447700>!        write(0,*) 'i, x/y = ',i, x/y<a name='991'></font>
        qiacrratio(i,j) = x/y<a name='992'>
        gamxinflu(i,j,4,1) = x/y<a name='993'>
        gamxinflu(i,j,4,2) = x/y<a name='994'>
<a name='995'>
        x = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF'>gamxinf</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINF_8">( 7.+alp, ratio )<a name='996'>
        ziacrratio(i,j) = x/y7<a name='997'>
<a name='998'>
      ENDDO<a name='999'>
      ENDDO<a name='1000'>
      qiacrratio(0,:) = 1.0<a name='1001'>
<a name='1002'>
<a name='1003'>
      isub = Min( 0, Max(-1,ihvol) ) <font color=#447700>! is -1 or 0<a name='1004'></font>
<a name='1005'>
      lccn = 0<a name='1006'>
      lccna = 0<a name='1007'>
      lnc = 0<a name='1008'>
      lnr = 0<a name='1009'>
      lni = 0<a name='1010'>
      lnis = 0<a name='1011'>
      lns = 0<a name='1012'>
      lnh = 0<a name='1013'>
      lnhl = 0<a name='1014'>
      lvh = 0<a name='1015'>
      lvhl = 0<a name='1016'>
      lzr = 0<a name='1017'>
      lzh = 0<a name='1018'>
      lzhl = 0<a name='1019'>
      lsw = 0<a name='1020'>
      lhw = 0<a name='1021'>
      lhlw = 0<a name='1022'>
<a name='1023'>
      denscale(:) = 0<a name='1024'>
      <a name='1025'>
<font color=#447700>!      lccn = 9<a name='1026'></font>
<a name='1027'>
    ipconc = ipctmp<a name='1028'>
<a name='1029'>
    IF ( ipconc == 0 ) THEN<a name='1030'>
       IF ( ihvol &gt;= 0 ) THEN<a name='1031'>
       lvh = 9<a name='1032'>
       ltmp = 9<a name='1033'>
       denscale(lvh) = 1<a name='1034'>
       ELSE <font color=#447700>! no hail<a name='1035'></font>
       ltmp = lhab<a name='1036'>
       lhl = 0<a name='1037'>
       ENDIF<a name='1038'>
    ELSEIF ( ipconc == 5 ) THEN<a name='1039'>
      lccn = lhab+1 <font color=#447700>! 9<a name='1040'></font>
      lnc = lhab+2 <font color=#447700>! 10<a name='1041'></font>
      lnr = lhab+3 <font color=#447700>! 11<a name='1042'></font>
      lni = lhab+4 <font color=#447700>!12<a name='1043'></font>
      lns = lhab+5 <font color=#447700>!13<a name='1044'></font>
      lnh = lhab+6 <font color=#447700>!14<a name='1045'></font>
      IF ( ihvol &gt;= 0 ) THEN<a name='1046'>
      lnhl = lhab+7 <font color=#447700>! 15<a name='1047'></font>
      ENDIF<a name='1048'>
      lvh = lhab+8 + isub <font color=#447700>! 16 + isub ! isub adjusts to 15 if hail is off<a name='1049'></font>
      ltmp = lvh<a name='1050'>
      denscale(lccn:lvh) = 1<a name='1051'>
      IF ( ihvol &gt;= 1 ) THEN<a name='1052'>
       lvhl = ltmp+1<a name='1053'>
       ltmp = lvhl<a name='1054'>
       denscale(lvhl) = 1<a name='1055'>
      ENDIF<a name='1056'>
      IF ( mixedphase ) THEN<a name='1057'>
      lsw  = ltmp+1<a name='1058'>
      lhw  = ltmp+2<a name='1059'>
      lhlw = ltmp+3<a name='1060'>
      ltmp = lhlw<a name='1061'>
      ENDIF<a name='1062'>
    ELSEIF ( ipconc &gt;= 6 ) THEN<a name='1063'>
      write(0,*) 'NSSL microphysics has not been compiled for 3-moment. Sorry.'<a name='1064'>
        STOP<a name='1065'>
      lccn = 9<a name='1066'>
      lnc = 10<a name='1067'>
      lnr = 11<a name='1068'>
      lni = 12<a name='1069'>
      lns = 13<a name='1070'>
      lnh = 14<a name='1071'>
      IF ( ihvol &gt;= 0 ) THEN<a name='1072'>
      lnhl = 15<a name='1073'>
      ENDIF<a name='1074'>
      IF ( ipconc == 6 ) THEN<a name='1075'>
      lzh = 16 + isub<a name='1076'>
      lvh = 17 + isub<a name='1077'>
      ELSEIF ( ipconc == 7 ) THEN<a name='1078'>
      lzh = 16<a name='1079'>
      lzr = 17<a name='1080'>
      lvh = 18<a name='1081'>
      ELSEIF ( ipconc == 8 ) THEN<a name='1082'>
      lzr = 16<a name='1083'>
      lzh = 17<a name='1084'>
      lzhl = 18<a name='1085'>
      lvh = 19<a name='1086'>
      ENDIF<a name='1087'>
      ltmp = lvh<a name='1088'>
      denscale(lccn:lvh) = 1<a name='1089'>
      IF ( ihvol &gt;= 1 ) THEN<a name='1090'>
       lvhl = ltmp+1<a name='1091'>
       ltmp = lvhl<a name='1092'>
       denscale(lvhl) = 1<a name='1093'>
      ENDIF<a name='1094'>
      IF ( mixedphase ) THEN<a name='1095'>
      lsw  = ltmp+1<a name='1096'>
      lhw  = ltmp+2<a name='1097'>
      lhlw = ltmp+3<a name='1098'>
      ltmp = lhlw<a name='1099'>
      ENDIF<a name='1100'>
    ELSE<a name='1101'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_874">( 'nssl_2mom_init: Invalid value of ipctmp' )<a name='1102'>
    ENDIF<a name='1103'>
<a name='1104'>
<a name='1105'>
    <a name='1106'>
      na = ltmp<a name='1107'>
      <a name='1108'>
      ln(lc) = lnc<a name='1109'>
      ln(lr) = lnr<a name='1110'>
      ln(li) = lni<a name='1111'>
      ln(ls) = lns<a name='1112'>
      ln(lh) = lnh<a name='1113'>
      IF ( lhl .gt. 1 ) ln(lhl) = lnhl<a name='1114'>
<a name='1115'>
      ipc(lc) = 2<a name='1116'>
      ipc(lr) = 3<a name='1117'>
      ipc(li) = 1<a name='1118'>
      ipc(ls) = 4<a name='1119'>
      ipc(lh) = 5<a name='1120'>
      IF ( lhl .gt. 1 ) ipc(lhl) = 5<a name='1121'>
      <a name='1122'>
      ldovol = .false.<a name='1123'>
      lvol(:) = 0<a name='1124'>
      lvol(li) = lvi<a name='1125'>
      lvol(ls) = lvs<a name='1126'>
      lvol(lh) = lvh<a name='1127'>
      IF ( lhl .gt. 1 .and. lvhl .gt. 1 ) lvol(lhl) = lvhl<a name='1128'>
      <a name='1129'>
      lne = Max(lnh,lnhl)<a name='1130'>
      lne = Max(lne,lvh)<a name='1131'>
      lne = Max(lne,lvhl)<a name='1132'>
      lne = Max(lne,na)<a name='1133'>
<a name='1134'>
      lsc(:) = 0<a name='1135'>
      lsc(lc) = lscw<a name='1136'>
      lsc(lr) = lscr<a name='1137'>
      lsc(li) = lsci<a name='1138'>
      lsc(ls) = lscs<a name='1139'>
      lsc(lh) = lsch<a name='1140'>
      IF ( lhl .gt. 1 ) lsc(lhl) = lschl<a name='1141'>
<a name='1142'>
<a name='1143'>
      DO il = lc,lhab<a name='1144'>
        ldovol = ldovol .or. ( lvol(il) .gt. 1 )<a name='1145'>
      ENDDO<a name='1146'>
<a name='1147'>
<font color=#447700>!      write(0,*) 'nssl_2mom_init: ldovol = ',ldovol<a name='1148'></font>
<a name='1149'>
      lz(:) = 0<a name='1150'>
      lz(lr) = lzr<a name='1151'>
      lz(li) = lzi<a name='1152'>
      lz(ls) = lzs<a name='1153'>
      lz(lh) = lzh<a name='1154'>
      IF ( lhl .gt. 1 .and. lzhl &gt; 1 ) lz(lhl) = lzhl<a name='1155'>
<a name='1156'>
      lliq(:) = 0<a name='1157'>
      lliq(ls) = lsw<a name='1158'>
      lliq(lh) = lhw<a name='1159'>
      IF ( lhl .gt. 1 ) lliq(lhl) = lhlw<a name='1160'>
      IF ( mixedphase ) THEN<a name='1161'>
<font color=#447700>!       write(0,*) 'lsw,lhw,lhlw = ',lsw,lhw,lhlw<a name='1162'></font>
      ENDIF<a name='1163'>
<a name='1164'>
<a name='1165'>
<a name='1166'>
      xnu(lc) = cnu<a name='1167'>
      xmu(lc) = 1.<a name='1168'>
      <a name='1169'>
      IF ( imurain == 3 ) THEN<a name='1170'>
        xnu(lr) = rnu<a name='1171'>
        xmu(lr) = 1.<a name='1172'>
      ELSEIF ( imurain == 1 ) THEN<a name='1173'>
        xnu(lr) = (alphar - 2.0)/3.0<a name='1174'>
        xmu(lr) = 1./3.<a name='1175'>
      ENDIF<a name='1176'>
<a name='1177'>
      xnu(li) = cinu<a name='1178'>
      xmu(li) = 1.<a name='1179'>
<a name='1180'>
      IF ( lis &gt;= 1 ) THEN<a name='1181'>
      xnu(lis) = 0.0<a name='1182'>
      xmu(lis) = 1.<a name='1183'>
      ENDIF<a name='1184'>
<a name='1185'>
      dnu(lc) = 3.*xnu(lc) + 2. <font color=#447700>! alphac<a name='1186'></font>
      dmu(lc) = 3.*xmu(lc)<a name='1187'>
<a name='1188'>
      dnu(lr) = 3.*xnu(lr) + 2. <font color=#447700>! alphar<a name='1189'></font>
      dmu(lr) = 3.*xmu(lr)<a name='1190'>
<a name='1191'>
      xnu(ls) = snu<a name='1192'>
      xmu(ls) = 1.<a name='1193'>
<a name='1194'>
      dnu(ls) = 3.*xnu(ls) + 2.  <font color=#447700>! -0.4 ! alphas<a name='1195'></font>
      dmu(ls) = 3.*xmu(ls)<a name='1196'>
<a name='1197'>
<a name='1198'>
      dnu(lh) = alphah<a name='1199'>
      dmu(lh) = dmuh<a name='1200'>
<a name='1201'>
      xnu(lh) = (dnu(lh) - 2.)/3.<a name='1202'>
      xmu(lh) = dmuh/3.<a name='1203'>
<a name='1204'>
<a name='1205'>
      IF ( imurain == 3 ) THEN <font color=#447700>! rain is gamma of volume<a name='1206'></font>
      rz =  ((4. + alphah)*(5. + alphah)*(6. + alphah)*(1. + xnu(lr)))/ &amp; <a name='1207'>
     &amp;  ((1 + alphah)*(2 + alphah)*(3 + alphah)*(2. + xnu(lr)))<a name='1208'>
<a name='1209'>
<font color=#447700>!      IF ( ipconc .lt. 5 ) alphahl = alphah<a name='1210'></font>
      <a name='1211'>
      rzhl =  ((4. + alphahl)*(5. + alphahl)*(6. + alphahl)*(1. + xnu(lr)))/ &amp; <a name='1212'>
     &amp;  ((1. + alphahl)*(2. + alphahl)*(3. + alphahl)*(2. + xnu(lr)))<a name='1213'>
<a name='1214'>
      rzs =  1. <font color=#447700>! assume rain and snow are both gamma volume<a name='1215'></font>
<a name='1216'>
      ELSE <font color=#447700>! rain is gamma of diameter<a name='1217'></font>
      <a name='1218'>
      rz =  ((4. + alphah)*(5. + alphah)*(6. + alphah)*(1. + alphar)*(2. + alphar)*(3. + alphar))/ &amp; <a name='1219'>
     &amp;  ((1 + alphah)*(2 + alphah)*(3 + alphah)*(4. + alphar)*(5. + alphar)*(6. + alphar))<a name='1220'>
      <a name='1221'>
      rzhl =  ((4. + alphahl)*(5. + alphahl)*(6. + alphahl)*(1. + alphar)*(2. + alphar)*(3. + alphar))/ &amp; <a name='1222'>
     &amp;  ((1 + alphahl)*(2 + alphahl)*(3 + alphahl)*(4. + alphar)*(5. + alphar)*(6. + alphar))<a name='1223'>
<a name='1224'>
      <a name='1225'>
      rzs =   &amp; <a name='1226'>
     &amp;  ((1. + alphar)*(2. + alphar)*(3. + alphar)*(2. + xnu(ls)))/  &amp;<a name='1227'>
     &amp;  ((4. + alphar)*(5. + alphar)*(6. + alphar)*(1. + xnu(ls)))<a name='1228'>
       <a name='1229'>
<a name='1230'>
      ENDIF<a name='1231'>
<a name='1232'>
      IF ( ipconc &lt;= 5 ) THEN <a name='1233'>
        imltshddmr = Min(1, imltshddmr)<a name='1234'>
        ibinhmlr = 0<a name='1235'>
        ibinhlmlr = 0<a name='1236'>
      ENDIF<a name='1237'>
<a name='1238'>
      IF ( ipconc &gt; 5 .and. (ibinhmlr == 0 .and. ibinhlmlr == 0 ) ) THEN<a name='1239'>
        imltshddmr = Min(1, imltshddmr)<a name='1240'>
      ENDIF<a name='1241'>
<a name='1242'>
<font color=#447700>!      write(0,*) 'rz,rzhl = ', rz,rzhl<a name='1243'></font>
<a name='1244'>
      IF ( ipconc .lt. 4 ) THEN<a name='1245'>
<a name='1246'>
      dnu(ls) = alphas<a name='1247'>
      dmu(ls) = 1.<a name='1248'>
<a name='1249'>
      xnu(ls) = (dnu(ls) - 2.)/3.<a name='1250'>
      xmu(ls) = 1./3.<a name='1251'>
<a name='1252'>
<a name='1253'>
      ENDIF<a name='1254'>
<a name='1255'>
      IF ( lhl .gt. 1 ) THEN<a name='1256'>
<a name='1257'>
      dnu(lhl) = alphahl<a name='1258'>
      dmu(lhl) = dmuhl<a name='1259'>
<a name='1260'>
      xnu(lhl) = (dnu(lhl) - 2.)/3.<a name='1261'>
      xmu(lhl) = dmuhl/3.<a name='1262'>
<a name='1263'>
      ENDIF<a name='1264'>
<a name='1265'>
      cno(lc)  = 1.0e+08<a name='1266'>
      IF ( li .gt. 1 ) cno(li)  = 1.0e+08<a name='1267'>
      cno(lr)  = cnor<a name='1268'>
      IF ( ls .gt. 1 ) cno(ls)  = cnos <font color=#447700>! 8.0e+06<a name='1269'></font>
      IF ( lh .gt. 1 ) cno(lh)  = cnoh <font color=#447700>! 4.0e+05<a name='1270'></font>
      IF ( lhl .gt. 1 ) cno(lhl)  = cnohl <font color=#447700>! 4.0e+05<a name='1271'></font>
<font color=#447700>!<a name='1272'></font>
<font color=#447700>!  density maximums and minimums<a name='1273'></font>
<font color=#447700>!<a name='1274'></font>
      xdnmx(:) = 900.0<a name='1275'>
<a name='1276'>
      xdnmx(lr) = 1000.0<a name='1277'>
      xdnmx(lc) = 1000.0<a name='1278'>
      xdnmx(li) =  917.0<a name='1279'>
      xdnmx(ls) =  300.0<a name='1280'>
      xdnmx(lh) =  900.0<a name='1281'>
      IF ( lhl .gt. 1 ) xdnmx(lhl) = 900.0<a name='1282'>
<font color=#447700>!<a name='1283'></font>
      xdnmn(:) = 900.0<a name='1284'>
<a name='1285'>
      xdnmn(lr) = 1000.0<a name='1286'>
      xdnmn(lc) = 1000.0<a name='1287'>
      xdnmn(li) =  100.0<a name='1288'>
      xdnmn(ls) =  100.0<a name='1289'>
      xdnmn(lh) =  hdnmn<a name='1290'>
      IF ( lhl .gt. 1 ) xdnmn(lhl) = hldnmn<a name='1291'>
<a name='1292'>
      xdn0(:) = 900.0<a name='1293'>
<a name='1294'>
      xdn0(lc) = 1000.0<a name='1295'>
      xdn0(li) = 900.0<a name='1296'>
      xdn0(lr) = 1000.0<a name='1297'>
      xdn0(ls) = rho_qs <font color=#447700>! 100.0<a name='1298'></font>
      xdn0(lh) = rho_qh <font color=#447700>! (0.5)*(xdnmn(lh)+xdnmx(lh))<a name='1299'></font>
      IF ( lhl .gt. 1 ) xdn0(lhl) = rho_qhl <font color=#447700>! 800.0<a name='1300'></font>
<a name='1301'>
<font color=#447700>!<a name='1302'></font>
<font color=#447700>!  Set terminal velocities...<a name='1303'></font>
<font color=#447700>!    also set drag coefficients<a name='1304'></font>
<font color=#447700>!<a name='1305'></font>
      cdx(lr) = 0.60<a name='1306'>
      cdx(lh) = 0.8 <font color=#447700>! 1.0 ! 0.45<a name='1307'></font>
      cdx(ls) = 2.00<a name='1308'>
      IF ( lhl .gt. 1 ) cdx(lhl) = 0.45<a name='1309'>
<a name='1310'>
      ido(lc) = idocw<a name='1311'>
      ido(lr) = idorw<a name='1312'>
      ido(li) = idoci<a name='1313'>
      ido(ls) = idosw<a name='1314'>
      ido(lh)  = idohw<a name='1315'>
      IF ( lhl .gt. 1 ) ido(lhl) = idohl<a name='1316'>
<a name='1317'>
      IF ( irfall .lt. 0 ) irfall = infall<a name='1318'>
      IF ( lzr &gt; 0 ) irfall = 0<a name='1319'>
<a name='1320'>
      qccn = ccn/rho00<a name='1321'>
<font color=#447700>!      xvcmx = (4./3.)*pi*xcradmx**3<a name='1322'></font>
<a name='1323'>
<font color=#447700>! set max rain diameter<a name='1324'></font>
      IF ( xvdmx .gt. 0.0 ) THEN<a name='1325'>
        xvrmx = 0.523599*(xvdmx)**3<a name='1326'>
      ELSE<a name='1327'>
        xvrmx = xvrmx0<a name='1328'>
      ENDIF<a name='1329'>
<a name='1330'>
         IF ( dhmn &lt;= 0.0 ) THEN<a name='1331'>
           xvhmn = xvhmn0<a name='1332'>
<font color=#447700>!           xvhmn = Min(xvhmn0, 0.523599*(dfrz)**3 )<a name='1333'></font>
         ELSE<a name='1334'>
           xvhmn = 0.523599*(dhmn)**3<a name='1335'>
<font color=#447700>!           xvhmn = 0.523599*(Min(dhmn,dfrz))**3<a name='1336'></font>
         ENDIF<a name='1337'>
<a name='1338'>
         IF ( dhmx &lt;= 0.0 ) THEN<a name='1339'>
           xvhmx = xvhmx0<a name='1340'>
         ELSE<a name='1341'>
           xvhmx = 0.523599*(dhmx)**3<a name='1342'>
         ENDIF<a name='1343'>
<a name='1344'>
<font color=#447700>! load max/min diameters<a name='1345'></font>
      xvmn(lc) = xvcmn<a name='1346'>
      xvmn(li) = xvimn<a name='1347'>
      xvmn(lr) = xvrmn<a name='1348'>
      xvmn(ls) = xvsmn<a name='1349'>
      xvmn(lh) = xvhmn<a name='1350'>
<a name='1351'>
      xvmx(lc) = xvcmx<a name='1352'>
      xvmx(li) = xvimx<a name='1353'>
      xvmx(lr) = xvrmx<a name='1354'>
      xvmx(ls) = xvsmx<a name='1355'>
      xvmx(lh) = xvhmx<a name='1356'>
<a name='1357'>
      IF ( lhl .gt. 1 ) THEN<a name='1358'>
      xvmn(lhl) = xvhlmn<a name='1359'>
      xvmx(lhl) = xvhlmx<a name='1360'>
      ENDIF<a name='1361'>
<a name='1362'>
<font color=#447700>!<a name='1363'></font>
<font color=#447700>!  cloud water constants in mks units<a name='1364'></font>
<font color=#447700>!<a name='1365'></font>
<font color=#447700>!      cwmasn = 4.25e-15  ! radius of 1.0e-6<a name='1366'></font>
<font color=#447700>!      cwmasn = 5.23e-13   ! minimum mass, defined by radius of 5.0e-6<a name='1367'></font>
<font color=#447700>!      cwmasn5 =  5.23e-13<a name='1368'></font>
<font color=#447700>!      cwradn = 5.0e-6     ! minimum radius<a name='1369'></font>
<font color=#447700>!      cwmasx = 5.25e-10   ! maximum mass, defined by radius of 50.0e-6<a name='1370'></font>
<font color=#447700>!      mwfac = 6.0**(1./3.)<a name='1371'></font>
      IF ( ipconc .ge. 2 ) THEN<a name='1372'>
<font color=#447700>!        cwmasn = xvmn(lc)*1000.  ! minimum mass, defined by minimum droplet volume<a name='1373'></font>
<font color=#447700>!        cwradn = 1.0e-6          ! minimum radius<a name='1374'></font>
<font color=#447700>!        cwmasx = xvmx(lc)*1000.  ! maximum mass, defined by maximum droplet volume<a name='1375'></font>
        <a name='1376'>
      ENDIF<a name='1377'>
<font color=#447700>!        rwmasn = xvmn(lr)*1000.  ! minimum mass, defined by minimum rain volume<a name='1378'></font>
<font color=#447700>!        rwmasx = xvmx(lr)*1000.  ! maximum mass, defined by maximum rain volume<a name='1379'></font>
<a name='1380'>
      IF ( lhl &lt; 1 ) ifrzg = 1<a name='1381'>
<a name='1382'>
      ventr = 1.<a name='1383'>
      IF ( imurain == 3 ) THEN<a name='1384'>
<font color=#447700>!       IF ( izwisventr == 1 ) THEN<a name='1385'></font>
        ventr = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_4">(rnu + 4./3.)/((rnu + 1.)**(1./3.)*Gamma_sp(rnu + 1.)) <font color=#447700>! Ziegler 1985<a name='1386'></font>
<font color=#447700>!       ELSE<a name='1387'></font>
        ventrn =  <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_5">(rnu + 1.5 + br/6.)/(Gamma_sp(rnu + 1.)*(rnu + 1.)**((1.+br)/6. + 1./3.) ) <font color=#447700>! adapted from Wisner et al. 1972; for second term in rwvent<a name='1388'></font>
<font color=#447700>!        ventr = Gamma_sp(rnu + 4./3.)/((rnu + 1.)**(1./3.)*Gamma_sp(rnu + 1.)) ! Ziegler 1985, still use for first term in rwvent<a name='1389'></font>
<font color=#447700>!        ventr  = Gamma_sp(rnu + 4./3.)/Gamma_sp(rnu + 1.)<a name='1390'></font>
<font color=#447700>!       ENDIF<a name='1391'></font>
      ELSE <font color=#447700>! imurain == 1<a name='1392'></font>
<font color=#447700>!       IF ( iferwisventr == 1 ) THEN<a name='1393'></font>
        ventr = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_6">(2. + alphar)  <font color=#447700>! Ferrier 1994<a name='1394'></font>
<font color=#447700>!       ELSEIF ( iferwisventr == 2 ) THEN<a name='1395'></font>
        ventrn =  <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_7">(alphar + 2.5 + br/2.)/Gamma_sp(alphar + 1.) <font color=#447700>! adapted from Wisner et al. 1972<a name='1396'></font>
<font color=#447700>!       ENDIF<a name='1397'></font>
      ENDIF<a name='1398'>
      ventc   = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_8">(cnu + 4./3.)/(cnu + 1.)**(1./3.)/Gamma_sp(cnu + 1.)<a name='1399'>
      c1sw = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_9">(snu + 4./3.)*(snu + 1.0)**(-1./3.)/gamma_sp(snu + 1.0)<a name='1400'>
<a name='1401'>
  <font color=#447700>! set threshold mixing ratios<a name='1402'></font>
<a name='1403'>
      qxmin(:) = 1.0e-12<a name='1404'>
<a name='1405'>
      qxmin(lc) = 1.e-9<a name='1406'>
      qxmin(lr) = 1.e-7<a name='1407'>
      IF ( li &gt; 1 ) qxmin(li) = 1.e-12<a name='1408'>
      IF ( ls &gt; 1 ) qxmin(ls) = 1.e-7<a name='1409'>
      IF ( lh &gt; 1 ) qxmin(lh) = 1.e-7<a name='1410'>
      IF ( lhl .gt. 1 ) qxmin(lhl) = 1.e-7<a name='1411'>
<a name='1412'>
      IF ( lc .gt. 1 .and. lnc .gt. 1 ) qxmin(lc) = 1.0e-13<a name='1413'>
      IF ( lr .gt. 1 .and. lnr .gt. 1 ) qxmin(lr) = 1.0e-12<a name='1414'>
<a name='1415'>
      IF ( li .gt. 1 .and. lni .gt. 1 ) qxmin(li ) = 1.0e-13<a name='1416'>
      IF ( ls .gt. 1 .and. lns .gt. 1 ) qxmin(ls ) = 1.0e-13<a name='1417'>
      IF ( lh .gt. 1 .and. lnh .gt. 1 ) qxmin(lh ) = 1.0e-12<a name='1418'>
      IF ( lhl.gt. 1 .and. lnhl.gt. 1 ) qxmin(lhl) = 1.0e-12<a name='1419'>
<a name='1420'>
  <font color=#447700>! constants for droplet nucleation<a name='1421'></font>
<a name='1422'>
      cckm = cck-1.<a name='1423'>
      ccnefac =  (1.63/(cck * beta(3./2., cck/2.)))**(cck/(cck + 2.0))<a name='1424'>
      cnexp   = (3./2.)*cck/(cck+2.0)<a name='1425'>
<font color=#447700>! ccne is all the factors with w in eq. A7 in Mansell et al. 2010 (JAS).  The constant changes<a name='1426'></font>
<font color=#447700>! if k (cck) is changed!<a name='1427'></font>
      ccne = ccnefac*1.e6*(1.e-6*Abs(cwccn))**(2./(2.+cck))<a name='1428'>
      ccne0 = ccnefac*1.e6*(1.e-6)**(2./(2.+cck))<a name='1429'>
<font color=#447700>!      write(0,*) 'cwccn, cck, ccne = ',cwccn,cck,ccne,ccnefac,cnexp<a name='1430'></font>
      IF ( cwccn .lt. 0.0 ) THEN<a name='1431'>
      cwccn = Abs(cwccn)<a name='1432'>
      ccwmx = 50.e9 <font color=#447700>! cwccn<a name='1433'></font>
      ELSE<a name='1434'>
      ccwmx = 50.e9 <font color=#447700>! cwccn ! *1.4<a name='1435'></font>
      ENDIF<a name='1436'>
<a name='1437'>
<font color=#447700>!<a name='1438'></font>
<font color=#447700>!<a name='1439'></font>
<font color=#447700>!  Set collection coefficients (Seifert and Beheng 05)<a name='1440'></font>
<font color=#447700>!<a name='1441'></font>
      bb(:) = 1.0/3.0<a name='1442'>
      bb(li) = 0.3429<a name='1443'>
      DO il = lc,lhab<a name='1444'>
        da0(il) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#DELBK'>delbk</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DELBK_1">(bb(il), xnu(il), xmu(il), 0)<a name='1445'>
        da1(il) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#DELBK'>delbk</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DELBK_2">(bb(il), xnu(il), xmu(il), 1)<a name='1446'>
<a name='1447'>
<font color=#447700>!        write(0,*) 'il, da0, da1, xnu, xmu = ', il, da0(il), da1(il), xnu(il), xmu(il)<a name='1448'></font>
      ENDDO<a name='1449'>
<a name='1450'>
      dab0(:,:) = 0.0<a name='1451'>
      dab1(:,:) = 0.0<a name='1452'>
<a name='1453'>
      DO il = lc,lhab<a name='1454'>
        DO j = lc,lhab<a name='1455'>
          IF ( il .ne. j ) THEN<a name='1456'>
<a name='1457'>
            dab0(il,j) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#DELABK'>delabk</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DELABK_1">(bb(il), bb(j), xnu(il), xnu(j), xmu(il), xmu(j), 0)<a name='1458'>
            dab1(il,j) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#DELABK'>delabk</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DELABK_2">(bb(il), bb(j), xnu(il), xnu(j), xmu(il), xmu(j), 1)<a name='1459'>
<a name='1460'>
<font color=#447700>!           write(0,*) 'il, j, dab0, dab1 = ',il, j, dab0(il,j), dab1(il,j)<a name='1461'></font>
          ENDIF<a name='1462'>
        ENDDO<a name='1463'>
      ENDDO<a name='1464'>
<a name='1465'>
        gf4br = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_10">(4.0+br)<a name='1466'>
        gf4ds = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_11">(4.0+ds)<a name='1467'>
        gf4p5 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_12">(4.0+0.5)<a name='1468'>
        gfcinu1 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_13">(cinu + 1.0)<a name='1469'>
        gfcinu1p47 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_14">(cinu + 1.47167)<a name='1470'>
        gfcinu2p47 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_15">(cinu + 2.47167)<a name='1471'>
<a name='1472'>
        gsnow1 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_16">(snu + 1.0)<a name='1473'>
        gsnow53 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_17">(snu + 5./3.)<a name='1474'>
        gsnow73 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_18">(snu + 7./3.)<a name='1475'>
<a name='1476'>
        IF ( lh  .gt. 1 ) cwchtmp0 = 6.0/pi*gamma_sp( (xnu(lh) + 1.)/xmu(lh) )/gamma_sp( (xnu(lh) + 2.)/xmu(lh) )<a name='1477'>
        IF ( lhl .gt. 1 ) cwchltmp0 = 6.0/pi*gamma_sp( (xnu(lhl) + 1)/xmu(lhl) )/gamma_sp( (xnu(lhl) + 2)/xmu(lhl) )<a name='1478'>
<a name='1479'>
<a name='1480'>
      iexy(:,:)=0; <font color=#447700>! sets to zero the ones Imight have forgotten<a name='1481'></font>
<a name='1482'>
<font color=#447700>!     snow<a name='1483'></font>
      iexy(ls,li) = ieswi<a name='1484'>
      iexy(ls,lc) = ieswc ; iexy(ls,lr) = ieswr ;<a name='1485'>
<a name='1486'>
<font color=#447700>!     graupel<a name='1487'></font>
      iexy(lh,ls)  = iehwsw ; iexy(lh,li) = iehwi ;<a name='1488'>
      iexy(lh,lc) = iehwc ; iexy(lh,lr)  = iehwr ;<a name='1489'>
<a name='1490'>
<font color=#447700>!     hail<a name='1491'></font>
      IF (lhl .gt. 1 ) THEN<a name='1492'>
      iexy(lhl,ls)  = iehlsw ; iexy(lhl,li) = iehli ;<a name='1493'>
      iexy(lhl,lc) = iehlc ; iexy(lhl,lr)  = iehlr ;<a name='1494'>
      ENDIF<a name='1495'>
<a name='1496'>
<a name='1497'>
  RETURN<a name='1498'>
END SUBROUTINE nssl_2mom_init<a name='1499'>
<a name='1500'>
<font color=#447700>! #####################################################################<a name='1501'></font>
<font color=#447700>! #####################################################################<a name='1502'></font>
<a name='1503'>
<A NAME='NSSL_2MOM_DRIVER'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1504'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>nssl_2mom_driver</font>(qv, qc, qr, qi, qs, qh, qhl, ccw, crw, cci, csw, chw, chl,  &amp; <A href='../../call_to/NSSL_2MOM_DRIVER.html' TARGET='index'>5</A>,<A href='../../call_from/NSSL_2MOM_DRIVER.html' TARGET='index'>7</A><a name='1505'>
                              cn, vhw, vhl,                                             &amp;<a name='1506'>
                              zrw, zhw, zhl,                                            &amp;<a name='1507'>
                              qsw, qhw, qhlw,                                           &amp;<a name='1508'>
                              th, pii, p, w, dn, dz, dtp, itimestep,                    &amp;<a name='1509'>
                              RAINNC,RAINNCV,                                           &amp;<a name='1510'>
                              dx, dy,                                                   &amp;<a name='1511'>
                              SNOWNC, SNOWNCV, GRPLNC, GRPLNCV,                         &amp;<a name='1512'>
                              SR,HAILNC, HAILNCV,                                       &amp;<a name='1513'>
                              tkediss,                                                  &amp;<a name='1514'>
                              re_cloud, re_ice, re_snow,                                &amp;<a name='1515'>
                              has_reqc, has_reqi, has_reqs,                             &amp;<a name='1516'>
                              rainncw2, rainnci2,                                       &amp;<a name='1517'>
                              dbz, vzf,compdbz,                                         &amp;<a name='1518'>
                              rscghis_2d,                                               &amp;<a name='1519'>
                              scr,scw,sci,scs,sch,schl,sctot,noninduc,                  &amp;<a name='1520'>
                              induc,elec,scion,sciona,                                  &amp;<a name='1521'>
                              pcc2, pre2, depsubr,      &amp;<a name='1522'>
                              mnucf2, melr2, ctr2,     &amp;<a name='1523'>
                              rim1_2, rim2_2,rim3_2, &amp;<a name='1524'>
                              nctr2, nnuccd2, nnucf2, &amp;<a name='1525'>
                              effc2,effr2,effi2,       &amp;<a name='1526'>
                              effs2, effg2,                       &amp;<a name='1527'>
                              fc2, fr2,fi2,fs2,fg2, &amp;<a name='1528'>
                              fnc2, fnr2,fni2,fns2,fng2, &amp;<a name='1529'>
<font color=#447700>!                              qcond,qdep,qfrz,qrauto,qhcnvi,qhcollw,qscollw,            &amp;<a name='1530'></font>
<font color=#447700>!                              ncauto, niinit,nifrz,                                     &amp;<a name='1531'></font>
<font color=#447700>!                              re_liquid, re_graupel, re_hail, re_icesnow,               &amp;<a name='1532'></font>
<font color=#447700>!                              vtcloud, vtrain, vtsnow, vtgraupel, vthail,               &amp;<a name='1533'></font>
                              ipelectmp,                                                &amp;<a name='1534'>
                              diagflag,                                                 &amp;<a name='1535'>
                              nssl_progn,                                              &amp; <font color=#447700>! wrf-chem <a name='1536'></font>
<font color=#447700>! 20130903 acd_mb_washout start<a name='1537'></font>
                              rainprod, evapprod,                                       &amp; <font color=#447700>! wrf-chem <a name='1538'></font>
<font color=#447700>! 20130903 acd_mb_washout end<a name='1539'></font>
                              cu_used, qrcuten, qscuten, qicuten, qccuten,              &amp; <font color=#447700>! hm added<a name='1540'></font>
                              ids,ide, jds,jde, kds,kde,                                &amp;  <font color=#447700>! domain dims<a name='1541'></font>
                              ims,ime, jms,jme, kms,kme,                                &amp;  <font color=#447700>! memory dims<a name='1542'></font>
                              its,ite, jts,jte, kts,kte)                                   <font color=#447700>! tile dims<a name='1543'></font>
<a name='1544'>
<a name='1545'>
      implicit none<a name='1546'>
<a name='1547'>
 <font color=#447700>!Subroutine arguments:<a name='1548'></font>
<a name='1549'>
      integer, intent(in)::                                                             &amp;<a name='1550'>
                            ids,ide, jds,jde, kds,kde,                                   &amp;<a name='1551'>
                            ims,ime, jms,jme, kms,kme,                                   &amp;<a name='1552'>
                            its,ite, jts,jte, kts,kte<a name='1553'>
      real, dimension(ims:ime, kms:kme, jms:jme), intent(inout)::                        &amp;<a name='1554'>
                            qv,qc,qr,qs,qh,th<a name='1555'>
      real, dimension(ims:ime, kms:kme, jms:jme), optional, intent(inout)::                        &amp;<a name='1556'>
                              zrw, zhw, zhl,                                            &amp;<a name='1557'>
                              qsw, qhw, qhlw,                                           &amp;<a name='1558'>
                            qi,qhl,ccw,crw,cci,csw,chw,chl,vhw,vhl<a name='1559'>
      real, dimension(ims:ime, kms:kme, jms:jme), optional, intent(inout):: dbz, vzf, cn<a name='1560'>
      real, dimension(ims:ime, jms:jme), optional, intent(inout):: compdbz<a name='1561'>
      real, dimension(ims:ime, jms:jme), optional, intent(inout):: rscghis_2d<a name='1562'>
<font color=#447700>!      real, dimension(ims:ime, kms:kme, jms:jme), optional, intent(inout)::rscghis_3d<a name='1563'></font>
      real, dimension(ims:ime, kms:kme, jms:jme),  optional, intent(inout)::                   &amp;<a name='1564'>
                            scr,scw,sci,scs,sch,schl,sciona,sctot,induc,noninduc  <font color=#447700>! space charge<a name='1565'></font>
      real, dimension(ims:ime, kms:kme, jms:jme),  optional, intent(in) :: elec <font color=#447700>! elecsave = Ez     <a name='1566'></font>
      real, dimension(ims:ime, kms:kme, jms:jme,2),optional, intent(inout) :: scion  <a name='1567'>
      real, dimension(ims:ime, kms:kme, jms:jme), intent(in)::  p,w,dz,dn<a name='1568'>
<a name='1569'>
      real, dimension(ims:ime, kms:kme, jms:jme), intent(in)::  pii<a name='1570'>
      real, dimension(ims:ime, kms:kme, jms:jme), optional, intent(inout)::   &amp;<a name='1571'>
                              pcc2, pre2, depsubr,      &amp;<a name='1572'>
                              mnucf2, melr2, ctr2,     &amp;<a name='1573'>
                              rim1_2, rim2_2,rim3_2, &amp;<a name='1574'>
                              nctr2, nnuccd2, nnucf2, &amp;<a name='1575'>
                              effc2,effr2,effi2,       &amp;<a name='1576'>
                              effs2, effg2,                       &amp;<a name='1577'>
                              fc2, fr2,fi2,fs2,fg2, &amp;<a name='1578'>
                              fnc2, fnr2,fni2,fns2,fng2<a name='1579'>
<font color=#447700>!                              qcond,qdep,qfrz,qrauto,qhcnvi,qhcollw,qscollw,            &amp;<a name='1580'></font>
<font color=#447700>!                              ncauto, niinit,nifrz,                                     &amp;<a name='1581'></font>
<font color=#447700>!                              re_liquid, re_graupel, re_hail, re_icesnow,               &amp;<a name='1582'></font>
<font color=#447700>!                              vtcloud, vtrain, vtsnow, vtgraupel, vthail               <a name='1583'></font>
<a name='1584'>
      real, dimension(ims:ime, jms:jme), intent(inout)::                                 &amp;<a name='1585'>
                            RAINNC,RAINNCV    <font color=#447700>! accumulated precip (NC) and rate (NCV)<a name='1586'></font>
      real, dimension(ims:ime, jms:jme), optional, intent(inout)::                                 &amp;<a name='1587'>
                            SNOWNC,SNOWNCV,GRPLNC,GRPLNCV,SR        <font color=#447700>! accumulated precip (NC) and rate (NCV)<a name='1588'></font>
      real, dimension(ims:ime, jms:jme), optional, intent(inout)::                                 &amp;<a name='1589'>
                            HAILNC,HAILNCV <font color=#447700>! accumulated precip (NC) and rate (NCV)<a name='1590'></font>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), optional, INTENT(INOUT):: &amp;<a name='1591'>
                          re_cloud, re_ice, re_snow<a name='1592'>
      REAL, DIMENSION(ims:ime, kms:kme, jms:jme), optional, INTENT(IN):: tkediss<a name='1593'>
      INTEGER, INTENT(IN), optional :: has_reqc, has_reqi, has_reqs<a name='1594'>
      real, dimension(ims:ime, jms:jme), intent(out), optional ::                                 &amp;<a name='1595'>
                            rainncw2, rainnci2       <font color=#447700>! liquid rain, ice, accumulation rates<a name='1596'></font>
      real, optional, intent(in) :: dx,dy<a name='1597'>
      real, intent(in)::    dtp<a name='1598'>
      integer, intent(in):: itimestep <font color=#447700>!, ccntype<a name='1599'></font>
      logical, optional, intent(in) :: diagflag<a name='1600'>
      integer, optional, intent(in) :: ipelectmp<a name='1601'>
<a name='1602'>
  LOGICAL, INTENT(IN), OPTIONAL ::    nssl_progn  <font color=#447700>! wrf-chem<a name='1603'></font>
<font color=#447700>!   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), optional,INTENT(INOUT):: qndrop<a name='1604'></font>
  LOGICAL :: flag_qndrop  <font color=#447700>! wrf-chem<a name='1605'></font>
<a name='1606'>
<font color=#447700>! 20130903 acd_ck_washout start<a name='1607'></font>
<font color=#447700>! rainprod - total tendency of conversion of cloud water/ice and graupel to rain (kg kg-1 s-1)<a name='1608'></font>
<font color=#447700>! evapprod - tendency of evaporation of rain (kg kg-1 s-1)<a name='1609'></font>
<font color=#447700>! 20130903 acd_ck_washout end<a name='1610'></font>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), optional,INTENT(INOUT)::  rainprod, evapprod<a name='1611'>
<a name='1612'>
<font color=#447700>! qrcuten, rain tendency from parameterized cumulus convection<a name='1613'></font>
<font color=#447700>! qscuten, snow tendency from parameterized cumulus convection<a name='1614'></font>
<font color=#447700>! qicuten, cloud ice tendency from parameterized cumulus convection<a name='1615'></font>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme), optional, INTENT(IN):: qrcuten, qscuten, qicuten, qccuten<a name='1616'>
   INTEGER, optional, intent(in) :: cu_used<a name='1617'>
<a name='1618'>
<font color=#447700>!<a name='1619'></font>
<font color=#447700>! local variables<a name='1620'></font>
<font color=#447700>!<a name='1621'></font>
     real, dimension(its:ite, 1, kts:kte) :: elec2 <font color=#447700>! ez = elecsave slab<a name='1622'></font>
<font color=#447700>!     real, dimension(its:ite, 1, kts:kte,2) :: scion2 ! 1=- , 2=+<a name='1623'></font>
     real, dimension(its:ite, kts:kte) :: rainprod2d, evapprod2d,tke2d,qrcuten2d, qscuten2d, qicuten2d,qccuten2d<a name='1624'>
     real, dimension(its:ite, 1, kts:kte, na) :: an, ancuten<a name='1625'>
     real, dimension(its:ite, 1, kts:kte, nxtra) :: axtra<a name='1626'>
     real, dimension(its:ite, 1, kts:kte) :: t0,t1,t2,t3,t4,t5,t6,t7,t8,t9<a name='1627'>
     real, dimension(its:ite, 1, kts:kte) :: dn1,t00,t77,ssat,pn,wn,dz2d,dz2dinv,dbz2d,vzf2d<a name='1628'>
     real, dimension(its:ite, 1, na) :: xfall<a name='1629'>
     integer, parameter :: nor = 0, ng = 0<a name='1630'>
     integer :: nx,ny,nz<a name='1631'>
     integer ix,jy,kz,i,j,k,il,n<a name='1632'>
     integer :: infdo<a name='1633'>
     real :: ssival, ssifac, t8s, t9s, qvapor<a name='1634'>
     integer :: ltemq<a name='1635'>
     double precision :: dp1<a name='1636'>
     integer :: jye, lnb<a name='1637'>
     integer :: imx,kmx<a name='1638'>
     real    :: dbzmx<a name='1639'>
     integer :: vzflag0 = 0<a name='1640'>
     logical :: makediag<a name='1641'>
      real, parameter :: cnin20 = 1.0e3<a name='1642'>
      real, parameter :: cnin10 = 5.0e1<a name='1643'>
      real, parameter :: cnin1a = 4.5<a name='1644'>
      real, parameter :: cnin2a = 12.96<a name='1645'>
      real, parameter :: cnin2b = 0.639<a name='1646'>
<a name='1647'>
      real :: tmp,dv<a name='1648'>
<a name='1649'>
      double precision :: dt1,dt2<a name='1650'>
      double precision :: timesed,timesed1,timesed2,timesed3, timegs, timenucond, timedbz,zmaxsed<a name='1651'>
      double precision :: timevtcalc,timesetvt<a name='1652'>
      <a name='1653'>
<a name='1654'>
<font color=#447700>! -------------------------------------------------------------------<a name='1655'></font>
<a name='1656'>
<a name='1657'>
      <a name='1658'>
<font color=#447700>!      write(0,*) 'N2M: entering routine'<a name='1659'></font>
<a name='1660'>
     flag_qndrop = .false.<a name='1661'>
     IF ( PRESENT ( nssl_progn ) ) flag_qndrop = nssl_progn<a name='1662'>
       <a name='1663'>
     IF ( present( vzf ) ) vzflag0 = 1<a name='1664'>
     <a name='1665'>
     IF ( present( ipelectmp ) ) THEN<a name='1666'>
       ipelec = ipelectmp<a name='1667'>
     ELSE<a name='1668'>
       ipelec = 0<a name='1669'>
     ENDIF<a name='1670'>
<font color=#447700>!       IF ( present( dbz ) ) THEN<a name='1671'></font>
<font color=#447700>!       DO jy = jts,jte<a name='1672'></font>
<font color=#447700>!         DO kz = kts,kte<a name='1673'></font>
<font color=#447700>!           DO ix = its,ite<a name='1674'></font>
<font color=#447700>!             dbz(ix,kz,jy) = 0.0<a name='1675'></font>
<font color=#447700>!           ENDDO<a name='1676'></font>
<font color=#447700>!         ENDDO<a name='1677'></font>
<font color=#447700>!       ENDDO<a name='1678'></font>
<font color=#447700>!       ENDIF<a name='1679'></font>
<a name='1680'>
     <a name='1681'>
     makediag = .true.<a name='1682'>
     IF ( present( diagflag ) ) THEN<a name='1683'>
      makediag = diagflag<a name='1684'>
     ENDIF<a name='1685'>
<a name='1686'>
<font color=#447700>!     write(0,*) 'N2M: makediag = ',makediag<a name='1687'></font>
     <a name='1688'>
     <a name='1689'>
     nx = ite-its+1<a name='1690'>
     ny = 1         <font color=#447700>! set up as 2D slabs<a name='1691'></font>
     nz = kte-kts+1<a name='1692'>
     <a name='1693'>
     IF ( .not. present( cn ) ) THEN<a name='1694'>
       renucfrac = 1.0<a name='1695'>
     ENDIF<a name='1696'>
     <a name='1697'>
<font color=#447700>! set up CCN array and some other static local values<a name='1698'></font>
     IF ( itimestep == 1 .and. .not. invertccn .and.  present( cn ) ) THEN<a name='1699'>
     <font color=#447700>! this is not needed for WRF 3.8 and later because it is done in physics_init, <a name='1700'></font>
     <font color=#447700>! but kept for backwards compatibility with earlier versions<a name='1701'></font>
      IF ( cn((ite+its)/2,(kte+kts)/2,(jte+jts)/2) &lt; 10.0 ) THEN <font color=#447700>! initialize ccn if not already done<a name='1702'></font>
        DO jy = jts,jte<a name='1703'>
         DO kz = kts,kte<a name='1704'>
          DO ix = its,ite<a name='1705'>
            cn(ix,kz,jy) = qccn<a name='1706'>
          ENDDO<a name='1707'>
         ENDDO<a name='1708'>
        ENDDO<a name='1709'>
      ENDIF<a name='1710'>
     ENDIF<a name='1711'>
<a name='1712'>
     IF ( itimestep == 1 .and. invertccn .and.  present( cn ) ) THEN<a name='1713'>
     <font color=#447700>! this is not needed for WRF 3.8 and later because it is done in physics_init,<a name='1714'></font>
     <font color=#447700>! but kept for backwards compatibility with earlier versions<a name='1715'></font>
        DO jy = jts,jte<a name='1716'>
         DO kz = kts,kte<a name='1717'>
          DO ix = its,ite<a name='1718'>
            cn(ix,kz,jy) = 0.0<a name='1719'>
          ENDDO<a name='1720'>
         ENDDO<a name='1721'>
        ENDDO<a name='1722'>
      ENDIF<a name='1723'>
     <a name='1724'>
      IF ( invertccn .and.  present( cn ) ) THEN <font color=#447700>! hack for WRF to convert activated ccn to unactivated, then don't have to <a name='1725'></font>
                                              <font color=#447700>! worry about initial and boundary conditions - they are zero<a name='1726'></font>
        DO jy = jts,jte<a name='1727'>
         DO kz = kts,kte<a name='1728'>
           DO ix = its,ite<a name='1729'>
             cn(ix,kz,jy) = Max( 0.0, qccn - cn(ix,kz,jy) )<a name='1730'>
           ENDDO<a name='1731'>
         ENDDO<a name='1732'>
       ENDDO<a name='1733'>
       ENDIF<a name='1734'>
<a name='1735'>
<font color=#447700>!     ENDIF ! itimestep == 1<a name='1736'></font>
<a name='1737'>
<font color=#447700>! sedimentation settings<a name='1738'></font>
<a name='1739'>
      infdo = 2<a name='1740'>
      <a name='1741'>
      IF ( infall .ne. 1 .or. iscfall .ge. 2 ) THEN<a name='1742'>
         infdo = 1<a name='1743'>
      ELSE<a name='1744'>
         infdo = 0<a name='1745'>
      ENDIF<a name='1746'>
<a name='1747'>
      IF ( infall .ge. 3 .or. ipconc .ge. 6 ) THEN<a name='1748'>
         infdo = 2<a name='1749'>
      ENDIF<a name='1750'>
     <a name='1751'>
<a name='1752'>
      IF ( present( HAILNCV ) .and. lhl &lt; 1 ) THEN <font color=#447700>! for WRF 3.1 compatibility<a name='1753'></font>
        HAILNCV(its:ite,jts:jte) = 0.<a name='1754'>
      ENDIF<a name='1755'>
<a name='1756'>
      tke2d(:,:) = 0.0 <font color=#447700>! initialize if not used<a name='1757'></font>
<a name='1758'>
     lnb = Max(lh,lhl)+1 <font color=#447700>! lnc<a name='1759'></font>
<font color=#447700>!     IF ( lccn &gt; 1 ) lnb = lccn<a name='1760'></font>
<a name='1761'>
       jye = jte<a name='1762'>
<a name='1763'>
     IF ( present( compdbz ) .and. makediag ) THEN<a name='1764'>
     DO jy = jts,jye<a name='1765'>
       DO ix = its,ite<a name='1766'>
        compdbz(ix,jy) = -3.0<a name='1767'>
       ENDDO<a name='1768'>
     ENDDO<a name='1769'>
     ENDIF<a name='1770'>
<a name='1771'>
      zmaxsed = 0.0d0<a name='1772'>
      timevtcalc = 0.0d0<a name='1773'>
      timesetvt = 0.0d0<a name='1774'>
      timesed = 0.0d0<a name='1775'>
      timesed1 = 0.0d0<a name='1776'>
      timesed2 = 0.0d0<a name='1777'>
      timesed3 = 0.0d0<a name='1778'>
      timegs = 0.0d0<a name='1779'>
      timenucond = 0.0d0<a name='1780'>
<a name='1781'>
<a name='1782'>
<font color=#447700>!     write(0,*) 'N2M: jy loop 1, lhl,na = ',lhl,na,present(qhl)<a name='1783'></font>
<a name='1784'>
          qrcuten2d(its:ite,kts:kte) = 0.0<a name='1785'>
          qscuten2d(its:ite,kts:kte) = 0.0<a name='1786'>
          qicuten2d(its:ite,kts:kte) = 0.0<a name='1787'>
          qccuten2d(its:ite,kts:kte) = 0.0<a name='1788'>
          ancuten(its:ite,1,kts:kte,:) = 0.0<a name='1789'>
<a name='1790'>
     DO jy = jts,jye<a name='1791'>
     <a name='1792'>
     xfall(:,:,:) = 0.0<a name='1793'>
<a name='1794'>
<font color=#447700>!     write(0,*) 'N2M: load an, jy,lccn = ',jy,lccn,qccn<a name='1795'></font>
<a name='1796'>
     IF ( present( pcc2 ) .and. makediag ) THEN<a name='1797'>
         axtra(its:ite,1,kts:kte,:) = 0.0<a name='1798'>
     ENDIF<a name='1799'>
   <font color=#447700>! copy from 3D array to 2D slab<a name='1800'></font>
   <a name='1801'>
       DO kz = kts,kte<a name='1802'>
        DO ix = its,ite<a name='1803'>
        <a name='1804'>
          an(ix,1,kz,lt)   = th(ix,kz,jy)<a name='1805'>
          an(ix,1,kz,lv)   = qv(ix,kz,jy)<a name='1806'>
          an(ix,1,kz,lc)   = qc(ix,kz,jy)<a name='1807'>
          an(ix,1,kz,lr)   = qr(ix,kz,jy)<a name='1808'>
          IF ( present( qi ) ) THEN<a name='1809'>
            an(ix,1,kz,li)   = qi(ix,kz,jy)<a name='1810'>
          ELSE<a name='1811'>
            an(ix,1,kz,li) = 0.0<a name='1812'>
          ENDIF<a name='1813'>
          an(ix,1,kz,ls)   = qs(ix,kz,jy)<a name='1814'>
          an(ix,1,kz,lh)   = qh(ix,kz,jy)<a name='1815'>
          IF ( lhl &gt; 1 ) an(ix,1,kz,lhl)  = qhl(ix,kz,jy)<a name='1816'>
          IF ( lccn &gt; 1 ) THEN<a name='1817'>
           IF ( present( cn ) ) THEN<a name='1818'>
            an(ix,1,kz,lccn) = cn(ix,kz,jy)<a name='1819'>
           ELSE<a name='1820'>
            an(ix,1,kz,lccn) = qccn - ccw(ix,kz,jy)<a name='1821'>
           ENDIF<a name='1822'>
          ENDIF<a name='1823'>
          IF ( ipconc &gt;= 5 ) THEN<a name='1824'>
             an(ix,1,kz,lnc)  = ccw(ix,kz,jy)<a name='1825'>
          IF ( constccw &gt; 0.0 ) THEN<a name='1826'>
            an(ix,1,kz,lnc)  = constccw<a name='1827'>
          ENDIF<a name='1828'>
          an(ix,1,kz,lnr)  = crw(ix,kz,jy)<a name='1829'>
          IF ( present( cci ) ) THEN<a name='1830'>
            an(ix,1,kz,lni)  = cci(ix,kz,jy)<a name='1831'>
          ELSE<a name='1832'>
            an(ix,1,kz,lni) = 0.0<a name='1833'>
          ENDIF<a name='1834'>
          an(ix,1,kz,lns)  = csw(ix,kz,jy)<a name='1835'>
          an(ix,1,kz,lnh)  = chw(ix,kz,jy)<a name='1836'>
          IF ( lhl &gt; 1 ) an(ix,1,kz,lnhl) = chl(ix,kz,jy)<a name='1837'>
          ENDIF<a name='1838'>
          IF ( lvh &gt; 0 ) an(ix,1,kz,lvh)  = vhw(ix,kz,jy)<a name='1839'>
          IF ( lvhl &gt; 0 .and. present( vhl ) ) an(ix,1,kz,lvhl)  = vhl(ix,kz,jy)<a name='1840'>
<a name='1841'>
          <a name='1842'>
<a name='1843'>
<a name='1844'>
<a name='1845'>
          <a name='1846'>
          t0(ix,1,kz) = th(ix,kz,jy)*pii(ix,kz,jy) <font color=#447700>! temperature (Kelvin)<a name='1847'></font>
          t1(ix,1,kz) = 0.0<a name='1848'>
          t2(ix,1,kz) = 0.0<a name='1849'>
          t3(ix,1,kz) = 0.0<a name='1850'>
          t4(ix,1,kz) = 0.0<a name='1851'>
          t5(ix,1,kz) = 0.0<a name='1852'>
          t6(ix,1,kz) = 0.0<a name='1853'>
          t7(ix,1,kz) = 0.0<a name='1854'>
          t8(ix,1,kz) = 0.0<a name='1855'>
          t9(ix,1,kz) = 0.0<a name='1856'>
          t00(ix,1,kz) = 380.0/p(ix,kz,jy)<a name='1857'>
          t77(ix,1,kz) = pii(ix,kz,jy)<a name='1858'>
          dbz2d(ix,1,kz) = 0.0<a name='1859'>
          vzf2d(ix,1,kz) = 0.0<a name='1860'>
<a name='1861'>
          dn1(ix,1,kz) = dn(ix,kz,jy)<a name='1862'>
          pn(ix,1,kz) = p(ix,kz,jy)<a name='1863'>
          wn(ix,1,kz) = w(ix,kz,jy)<a name='1864'>
          dz2d(ix,1,kz) = dz(ix,kz,jy)<a name='1865'>
          dz2dinv(ix,1,kz) = 1./dz(ix,kz,jy)<a name='1866'>
          <a name='1867'>
         ltemq = Int( (t0(ix,1,kz)-163.15)/fqsat+1.5 )<a name='1868'>
         ltemq = Min( nqsat, Max(1,ltemq) )<a name='1869'>
<font color=#447700>!<a name='1870'></font>
<font color=#447700>! saturation mixing ratio<a name='1871'></font>
<font color=#447700>!<a name='1872'></font>
      t8s = t00(ix,1,kz)*tabqvs(ltemq)  <font color=#447700>!saturation mixing ratio wrt water<a name='1873'></font>
      t9s = t00(ix,1,kz)*tabqis(ltemq)  <font color=#447700>!saturation mixing ratio wrt ice<a name='1874'></font>
<a name='1875'>
<font color=#447700>!<a name='1876'></font>
<font color=#447700>!  calculate rate of nucleation<a name='1877'></font>
<font color=#447700>!<a name='1878'></font>
      ssival = Min(t8s,max(an(ix,1,kz,lv),0.0))/t9s  <font color=#447700>! qv/qvi<a name='1879'></font>
<a name='1880'>
      if ( ssival .gt. 1.0 ) then<a name='1881'>
<font color=#447700>!<a name='1882'></font>
      IF ( icenucopt == 1 ) THEN<a name='1883'>
<a name='1884'>
      if ( t0(ix,1,kz).le.268.15 ) then<a name='1885'>
<a name='1886'>
       dp1 = dn1(ix,1,kz)/rho00*cnin20*exp( Min( 57.0 ,(cnin2a*(ssival-1.0)-cnin2b) ) )<a name='1887'>
       t7(ix,1,kz) = Min(dp1, 1.0d30)<a name='1888'>
      end if<a name='1889'>
<a name='1890'>
<font color=#447700>!<a name='1891'></font>
<font color=#447700>!   Default value of imeyers5 turns off nucleation by Meyer at higher temperatures<a name='1892'></font>
<font color=#447700>!  This is really from Ferrier (1994), eq. 4.31 - 4.34<a name='1893'></font>
      IF ( imeyers5 ) THEN<a name='1894'>
      if ( t0(ix,1,kz).lt.tfr .and. t0(ix,1,kz).gt.268.15 ) then<a name='1895'>
      qvapor = max(an(ix,1,kz,lv),0.0)<a name='1896'>
      ssifac = 0.0<a name='1897'>
      if ( (qvapor-t9s) .gt. 1.0e-5 ) then<a name='1898'>
      if ( (t8s-t9s) .gt. 1.0e-5 ) then<a name='1899'>
      ssifac = (qvapor-t9s) /(t8s-t9s)<a name='1900'>
      ssifac = ssifac**cnin1a<a name='1901'>
      end if<a name='1902'>
      end if<a name='1903'>
      t7(ix,1,kz) = dn(ix,1,kz)/rho00*cnin10*ssifac*exp(-(t0(ix,1,kz)-tfr)*bta1)<a name='1904'>
      end if<a name='1905'>
      ENDIF<a name='1906'>
<a name='1907'>
      ELSEIF ( icenucopt == 2 ) THEN <font color=#447700>! Thompson/Cooper; Note Thompson 2004 has constants of<a name='1908'></font>
                                     <font color=#447700>! 0.005 and 0.304 because the line function was estimated from Cooper's plot<a name='1909'></font>
                                     <font color=#447700>! Here, the fit line values from Cooper 1986 are converted. Very little difference <a name='1910'></font>
                                     <font color=#447700>! in practice<a name='1911'></font>
      <a name='1912'>
        t7(ix,1,kz) = 1000.*0.00446684*exp(0.3108*(273.16 - Max(233.0, t0(ix,1,kz) ) ) ) <font color=#447700>! factor of 1000 to convert L**-1 to m**-3<a name='1913'></font>
<a name='1914'>
<font color=#447700>!        write(0,*) 'Cooper t7,ssival = ',ix,kz,t7(ix,1,kz),ssival<a name='1915'></font>
      <a name='1916'>
      ELSEIF ( icenucopt == 3 ) THEN <font color=#447700>! Phillips (Meyers/DeMott)<a name='1917'></font>
<a name='1918'>
      if ( t0(ix,1,kz).le.268.15 .and.  t0(ix,1,kz) &gt; 243.15 ) then <font color=#447700>! Meyers with factor of Psi=0.06<a name='1919'></font>
        <a name='1920'>
       dp1 = 0.06*cnin20*exp( Min( 57.0 ,(cnin2a*(ssival-1.0)-cnin2b) ) )<a name='1921'>
       t7(ix,1,kz) = Min(dp1, 1.0d30)<a name='1922'>
      elseif ( t0(ix,1,kz) &lt;= 243.15 ) then <font color=#447700>! Phillips estimate of DeMott et al (2003) data<a name='1923'></font>
       dp1 = 1000.*( exp( Min( 57.0 ,cnin2a*(ssival-1.1) ) ) )**0.3<a name='1924'>
       t7(ix,1,kz) = Min(dp1, 1.0d30)<a name='1925'>
      <a name='1926'>
      end if<a name='1927'>
      <a name='1928'>
      ENDIF <font color=#447700>! icenucopt<a name='1929'></font>
<a name='1930'>
<a name='1931'>
<font color=#447700>!<a name='1932'></font>
      end if <font color=#447700>! ( ssival .gt. 1.0 )<a name='1933'></font>
<font color=#447700>!<a name='1934'></font>
<a name='1935'>
        ENDDO <font color=#447700>! ix<a name='1936'></font>
       ENDDO <font color=#447700>! kz<a name='1937'></font>
<a name='1938'>
         IF ( wrfchem_flag &gt; 0 ) THEN<a name='1939'>
           IF ( PRESENT( rainprod ) ) rainprod2d(its:ite,kts:kte) = 0<a name='1940'>
           IF ( PRESENT( evapprod ) ) evapprod2d(its:ite,kts:kte) = 0<a name='1941'>
         ENDIF<a name='1942'>
         <a name='1943'>
<a name='1944'>
   <font color=#447700>! transform from number mixing ratios to number conc.<a name='1945'></font>
     <a name='1946'>
     DO il = lnb,na<a name='1947'>
       IF ( denscale(il) == 1 ) THEN<a name='1948'>
         DO kz = kts,kte<a name='1949'>
          DO ix = its,ite<a name='1950'>
           an(ix,1,kz,il) = an(ix,1,kz,il)*dn(ix,kz,jy)<a name='1951'>
          ENDDO<a name='1952'>
         ENDDO<a name='1953'>
       ENDIF<a name='1954'>
     ENDDO <font color=#447700>! il<a name='1955'></font>
        <a name='1956'>
<font color=#447700>! sedimentation<a name='1957'></font>
      xfall(:,:,:) = 0.0<a name='1958'>
       <a name='1959'>
      IF ( .true. ) THEN<a name='1960'>
<a name='1961'>
<a name='1962'>
<font color=#447700>! for real cases when hydrometeor mixing ratios have been initialized without concentrations<a name='1963'></font>
       IF ( itimestep == 1 .and. ipconc &gt; 0 ) THEN<a name='1964'>
         call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALCNFROMQ'>calcnfromq</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCNFROMQ_1">(nx,ny,nz,an,na,nor,nor,dn1)<a name='1965'>
       ENDIF<a name='1966'>
<a name='1967'>
      IF ( present(cu_used) .and.         &amp;<a name='1968'>
           ( present( qrcuten ) .or. present( qscuten ) .or.  &amp;<a name='1969'>
             present( qicuten ) .or. present( qccuten ) ) ) THEN<a name='1970'>
<a name='1971'>
       IF ( cu_used == 1 ) THEN<a name='1972'>
       DO kz = kts,kte<a name='1973'>
        DO ix = its,ite<a name='1974'>
<font color=#447700>!         IF ( present( qrcuten ) ) qrcuten2d(ix,kz)   = qrcuten(ix,kz,jy)<a name='1975'></font>
<font color=#447700>!         IF ( present( qscuten ) ) qscuten2d(ix,kz)   = qscuten(ix,kz,jy)<a name='1976'></font>
<font color=#447700>!         IF ( present( qicuten ) ) qicuten2d(ix,kz)   = qicuten(ix,kz,jy)<a name='1977'></font>
<font color=#447700>!         IF ( present( qccuten ) ) qccuten2d(ix,kz)   = qccuten(ix,kz,jy)<a name='1978'></font>
<a name='1979'>
         IF ( present( qrcuten ) ) ancuten(ix,1,kz,lr) = dtp*qrcuten(ix,kz,jy)<a name='1980'>
         IF ( present( qscuten ) ) ancuten(ix,1,kz,ls) = dtp*qscuten(ix,kz,jy)<a name='1981'>
         IF ( present( qicuten ) ) ancuten(ix,1,kz,li) = dtp*qicuten(ix,kz,jy)<a name='1982'>
         IF ( present( qccuten ) ) ancuten(ix,1,kz,lc) = dtp*qccuten(ix,kz,jy)<a name='1983'>
         <a name='1984'>
        ENDDO<a name='1985'>
       ENDDO<a name='1986'>
       <a name='1987'>
         call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALCNFROMCUTEN'>calcnfromcuten</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCNFROMCUTEN_1">(nx,ny,nz,ancuten,an,na,nor,nor,dn1)<a name='1988'>
<a name='1989'>
<font color=#447700>!      DO kz = kts,kte<a name='1990'></font>
<font color=#447700>!       DO ix = its,ite<a name='1991'></font>
<font color=#447700>!           an(ix,1,kz,lnr)  = an(ix,1,kz,lnr) + ancuten(ix,1,kz,lnr)<a name='1992'></font>
<font color=#447700>!           an(ix,1,kz,lns)  = an(ix,1,kz,lns) + ancuten(ix,1,kz,lns)<a name='1993'></font>
<font color=#447700>!           an(ix,1,kz,lni)  = an(ix,1,kz,lni) + ancuten(ix,1,kz,lni)<a name='1994'></font>
<font color=#447700>!           an(ix,1,kz,lnc)  = an(ix,1,kz,lnc) + ancuten(ix,1,kz,lnc)<a name='1995'></font>
<font color=#447700>!       ENDDO<a name='1996'></font>
<font color=#447700>!      ENDDO<a name='1997'></font>
       <a name='1998'>
       ENDIF<a name='1999'>
       <a name='2000'>
      ENDIF<a name='2001'>
<a name='2002'>
<a name='2003'>
      call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D'>sediment1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEDIMENT1D_1">(dtp,nx,ny,nz,an,na,nor,nor,xfall,dn1,dz2d,dz2dinv, &amp;<a name='2004'>
     &amp;                    t0,t7,infdo,jy,its,jts &amp;<a name='2005'>
     &amp;   ,timesed1,timesed2,timesed3,zmaxsed,timesetvt)<a name='2006'>
<a name='2007'>
<a name='2008'>
<font color=#447700>! copy xfall to appropriate places...<a name='2009'></font>
<a name='2010'>
<font color=#447700>!     write(0,*) 'N2M: end sediment, jy = ',jy<a name='2011'></font>
<a name='2012'>
       DO ix = its,ite<a name='2013'>
         IF ( lhl &gt; 1 ) THEN<a name='2014'>
         RAINNCV(ix,jy) = dtp*dn1(ix,1,1)*(xfall(ix,1,lr) + xfall(ix,1,ls)*1000./xdn0(lr) + &amp;<a name='2015'>
              &amp;            xfall(ix,1,lh)*1000./xdn0(lr) + xfall(ix,1,lhl)*1000./xdn0(lr) )<a name='2016'>
         ELSE<a name='2017'>
         RAINNCV(ix,jy) = dtp*dn1(ix,1,1)*(xfall(ix,1,lr) + xfall(ix,1,ls)*1000./xdn0(lr) + &amp;<a name='2018'>
              &amp;            xfall(ix,1,lh)*1000./xdn0(lr) )<a name='2019'>
         ENDIF<a name='2020'>
         IF ( present ( rainncw2 ) ) THEN <font color=#447700>! rain only<a name='2021'></font>
           rainncw2(ix,jy) =  rainncw2(ix,jy) +  dtp*dn1(ix,1,1)*xfall(ix,1,lr)<a name='2022'>
         ENDIF<a name='2023'>
         IF ( present ( rainnci2 ) ) THEN <font color=#447700>! ice only<a name='2024'></font>
           IF ( lhl &gt; 1 ) THEN<a name='2025'>
             rainnci2(ix,jy) =rainnci2(ix,jy) + dtp*dn1(ix,1,1)*(xfall(ix,1,ls)*1000./xdn0(lr) + &amp;<a name='2026'>
     &amp;            xfall(ix,1,lh)*1000./xdn0(lr) + xfall(ix,1,lhl)*1000./xdn0(lr) )<a name='2027'>
           ELSE<a name='2028'>
             rainnci2(ix,jy) = rainnci2(ix,jy) + dtp*dn1(ix,1,1)*(xfall(ix,1,ls)*1000./xdn0(lr) + &amp;<a name='2029'>
     &amp;            xfall(ix,1,lh)*1000./xdn0(lr) )<a name='2030'>
           ENDIF<a name='2031'>
         ENDIF<a name='2032'>
         IF ( present( SNOWNCV ) ) SNOWNCV(ix,jy) = dtp*dn1(ix,1,1)*xfall(ix,1,ls)*1000./xdn0(lr)<a name='2033'>
         IF ( present( GRPLNCV ) ) GRPLNCV(ix,jy) = dtp*dn1(ix,1,1)*xfall(ix,1,lh)*1000./xdn0(lr)<a name='2034'>
         RAINNC(ix,jy)  = RAINNC(ix,jy) + RAINNCV(ix,jy)<a name='2035'>
<a name='2036'>
         IF ( present (SNOWNC) .and. present (SNOWNCV) ) SNOWNC(ix,jy)  = SNOWNC(ix,jy) + SNOWNCV(ix,jy)<a name='2037'>
         IF ( lhl &gt; 1 ) THEN<a name='2038'>
<font color=#447700>!#ifdef CM1<a name='2039'></font>
<font color=#447700>!           IF ( .true. ) THEN<a name='2040'></font>
<font color=#447700>!#else<a name='2041'></font>
           IF ( present( HAILNC ) ) THEN<a name='2042'>
<font color=#447700>!#endif<a name='2043'></font>
             HAILNCV(ix,jy) = dtp*dn1(ix,1,1)*xfall(ix,1,lhl)*1000./xdn0(lr)<a name='2044'>
             HAILNC(ix,jy)  = HAILNC(ix,jy) + HAILNCV(ix,jy)<a name='2045'>
           ELSEIF ( present( GRPLNCV ) ) THEN<a name='2046'>
             GRPLNCV(ix,jy) = dtp*dn1(ix,1,1)*xfall(ix,1,lhl)*1000./xdn0(lr)<a name='2047'>
           ENDIF<a name='2048'>
         ENDIF<a name='2049'>
         IF ( present( GRPLNCV ) ) GRPLNC(ix,jy)  = GRPLNC(ix,jy) + GRPLNCV(ix,jy)<a name='2050'>
        IF ( present( SR ) .and. present (SNOWNCV) .and. present(GRPLNCV) ) THEN<a name='2051'>
         IF ( present( HAILNC ) ) THEN<a name='2052'>
           SR(ix,jy)      = (SNOWNCV(ix,jy)+HAILNCV(ix,jy)+GRPLNCV(ix,jy))/(RAINNCV(ix,jy)+1.e-12)<a name='2053'>
         ELSE<a name='2054'>
           SR(ix,jy)      = (SNOWNCV(ix,jy)+GRPLNCV(ix,jy))/(RAINNCV(ix,jy)+1.e-12)<a name='2055'>
         ENDIF<a name='2056'>
        ENDIF<a name='2057'>
       ENDDO<a name='2058'>
       <a name='2059'>
      ENDIF <font color=#447700>! .false.<a name='2060'></font>
 <a name='2061'>
      IF ( isedonly /= 1 ) THEN<a name='2062'>
   <font color=#447700>! call nssl_2mom_gs: main gather-scatter routine to calculate microphysics<a name='2063'></font>
<a name='2064'>
<font color=#447700>!     write(0,*) 'N2M: gs, jy = ',jy<a name='2065'></font>
<font color=#447700>!      IF ( isedonly /= 2 ) THEN<a name='2066'></font>
<a name='2067'>
<a name='2068'>
      <a name='2069'>
      call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS'>nssl_2mom_gs</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NSSL_2MOM_GS_1">   &amp;<a name='2070'>
     &amp;  (nx,ny,nz,na,jy   &amp;<a name='2071'>
     &amp;  ,nor,nor          &amp;<a name='2072'>
     &amp;  ,dtp,dz2d       &amp;<a name='2073'>
     &amp;  ,t0,t1,t2,t3,t4,t5,t6,t7,t8,t9     &amp;<a name='2074'>
     &amp;  ,an,dn1,t77                        &amp;<a name='2075'>
     &amp;  ,pn,wn,0                           &amp;<a name='2076'>
     &amp;  ,t00,t77,                          &amp;<a name='2077'>
     &amp;   ventr,ventc,c1sw,1,ido,           &amp;<a name='2078'>
     &amp;   xdnmx,xdnmn,                      &amp;<a name='2079'>
<font color=#447700>!     &amp;   ln,ipc,lvol,lz,lliq,              &amp;<a name='2080'></font>
     &amp;   cdx,                              &amp;<a name='2081'>
     &amp;   xdn0,dbz2d,tke2d,                 &amp;<a name='2082'>
     &amp;   timevtcalc,axtra, makediag        &amp;<a name='2083'>
     &amp;   ,rainprod2d, evapprod2d           &amp;<a name='2084'>
     &amp; ,elec2,its,ids,ide,jds,jde          &amp;<a name='2085'>
     &amp; )<a name='2086'>
<a name='2087'>
<a name='2088'>
<a name='2089'>
<a name='2090'>
<a name='2091'>
   ENDIF <font color=#447700>! isedonly /= 1<a name='2092'></font>
   <a name='2093'>
 <font color=#447700>! droplet nucleation/condensation/evaporation<a name='2094'></font>
   IF ( .true. ) THEN<a name='2095'>
   CALL <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NUCOND'>NUCOND</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NUCOND_1">    &amp;<a name='2096'>
     &amp;  (nx,ny,nz,na,jy &amp; <a name='2097'>
     &amp;  ,nor,nor,dtp,nx  &amp;<a name='2098'>
     &amp;  ,dz2d &amp; <a name='2099'>
     &amp;  ,t0,t9 &amp; <a name='2100'>
     &amp;  ,an,dn1,t77 &amp; <a name='2101'>
     &amp;  ,pn,wn &amp; <a name='2102'>
     &amp;  ,axtra, makediag  &amp;<a name='2103'>
     &amp;  ,ssat,t00,t77,flag_qndrop)<a name='2104'>
<a name='2105'>
<a name='2106'>
   ENDIF<a name='2107'>
<a name='2108'>
<a name='2109'>
<a name='2110'>
<font color=#447700>! compute diagnostic S-band reflectivity if needed<a name='2111'></font>
     IF ( present( dbz ) .and. makediag ) THEN<a name='2112'>
   <font color=#447700>! calc dbz<a name='2113'></font>
      <a name='2114'>
      IF ( .true. ) THEN<a name='2115'>
      call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#RADARDD02'>radardd02</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADARDD02_1">(nx,ny,nz,nor,na,an,t0,         &amp;<a name='2116'>
     &amp;    dbz2d,dn1,nz,cnoh,rho_qh,ipconc, 0)<a name='2117'>
      ENDIF <font color=#447700>! .false.<a name='2118'></font>
<a name='2119'>
     <a name='2120'>
       DO kz = kts,kte<a name='2121'>
        DO ix = its,ite<a name='2122'>
         dbz(ix,kz,jy) = dbz2d(ix,1,kz)<a name='2123'>
         IF ( present( vzf ) ) THEN<a name='2124'>
           vzf(ix,kz,jy) = vzf2d(ix,1,kz)<a name='2125'>
         ENDIF<a name='2126'>
          IF ( present( compdbz ) ) THEN<a name='2127'>
            compdbz(ix,jy) = Max( compdbz(ix,jy), dbz2d(ix,1,kz) )<a name='2128'>
          ENDIF<a name='2129'>
        ENDDO<a name='2130'>
       ENDDO<a name='2131'>
<a name='2132'>
<a name='2133'>
<font color=#447700>! Following Greg Thompson, calculation for effective radii. Used by RRTMG LW/SW schemes if enabled in module_physics_init.F<a name='2134'></font>
      IF ( present( has_reqc ).and. present( has_reqi ) .and. present( has_reqs ) .and.  &amp;<a name='2135'>
           present( re_cloud ).and. present( re_ice ) .and. present( re_snow ) ) THEN<a name='2136'>
       IF ( has_reqc.ne.0 .or. has_reqi.ne.0 .or. has_reqs.ne.0) THEN<a name='2137'>
         DO kz = kts,kte<a name='2138'>
          DO ix = its,ite<a name='2139'>
             re_cloud(ix,kz,jy)  = 2.51E-6<a name='2140'>
             re_ice(ix,kz,jy)    = 10.01E-6<a name='2141'>
             re_snow(ix,kz,jy)   = 25.E-6<a name='2142'>
             t1(ix,1,kz) = 2.51E-6<a name='2143'>
             t2(ix,1,kz) = 10.01E-6<a name='2144'>
             t3(ix,1,kz) = 25.E-6<a name='2145'>
          ENDDO<a name='2146'>
         ENDDO<a name='2147'>
<a name='2148'>
          call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALC_EFF_RADIUS'>calc_eff_radius</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_EFF_RADIUS_1">   &amp;<a name='2149'>
     &amp;         (nx,ny,nz,na,jy &amp; <a name='2150'>
     &amp;          ,nor,nor &amp; <a name='2151'>
     &amp;          ,t1,t2,t3  &amp; <a name='2152'>
     &amp;          ,an,dn1 )<a name='2153'>
<a name='2154'>
        DO kz = kts,kte<a name='2155'>
          DO ix = its,ite<a name='2156'>
             re_cloud(ix,kz,jy) = MAX(2.51E-6, MIN(t1(ix,1,kz), 50.E-6))<a name='2157'>
             re_ice(ix,kz,jy)   = MAX(10.01E-6, MIN(t2(ix,1,kz), 125.E-6))<a name='2158'>
             re_snow(ix,kz,jy)  = MAX(25.E-6, MIN(t3(ix,1,kz), 999.E-6))<a name='2159'>
             <font color=#447700>! check for case where snow needs to be treated as cloud ice (for rrtmg radiation)<a name='2160'></font>
             IF ( .not. present(qi) ) re_snow(ix,kz,jy)  = MAX(10.E-6, MIN(t3(ix,1,kz), 125.E-6))<a name='2161'>
          ENDDO<a name='2162'>
         ENDDO<a name='2163'>
       <a name='2164'>
         ENDIF<a name='2165'>
        ENDIF<a name='2166'>
<a name='2167'>
<a name='2168'>
<a name='2169'>
       ENDIF<a name='2170'>
   <a name='2171'>
<font color=#447700>! transform concentrations back to mixing ratios<a name='2172'></font>
     DO il = lnb,na<a name='2173'>
      IF ( denscale(il) == 1 ) THEN<a name='2174'>
       DO kz = kts,kte<a name='2175'>
        DO ix = its,ite<a name='2176'>
         an(ix,1,kz,il) = an(ix,1,kz,il)/dn(ix,kz,jy)<a name='2177'>
        ENDDO<a name='2178'>
       ENDDO<a name='2179'>
      ENDIF<a name='2180'>
     ENDDO <font color=#447700>! il<a name='2181'></font>
   <a name='2182'>
   <font color=#447700>! copy 2D slabs back to 3D<a name='2183'></font>
<a name='2184'>
   <a name='2185'>
       DO kz = kts,kte<a name='2186'>
        DO ix = its,ite<a name='2187'>
        <a name='2188'>
         th(ix,kz,jy)  = an(ix,1,kz,lt)<a name='2189'>
         qv(ix,kz,jy)  = an(ix,1,kz,lv)<a name='2190'>
         qc(ix,kz,jy)  = an(ix,1,kz,lc)<a name='2191'>
         qr(ix,kz,jy)  = an(ix,1,kz,lr)<a name='2192'>
         IF ( present(qi) ) qi(ix,kz,jy)  = an(ix,1,kz,li)<a name='2193'>
         qs(ix,kz,jy)  = an(ix,1,kz,ls)<a name='2194'>
         qh(ix,kz,jy)  = an(ix,1,kz,lh)<a name='2195'>
         IF ( lhl &gt; 1 ) qhl(ix,kz,jy) = an(ix,1,kz,lhl)<a name='2196'>
         IF ( present( cn ) .and. lccn &gt; 1 .and. .not. flag_qndrop) THEN<a name='2197'>
           cn(ix,kz,jy) = an(ix,1,kz,lccn)<a name='2198'>
         ENDIF<a name='2199'>
         IF ( ipconc &gt;= 5 ) THEN<a name='2200'>
<a name='2201'>
          ccw(ix,kz,jy) = an(ix,1,kz,lnc)<a name='2202'>
          crw(ix,kz,jy) = an(ix,1,kz,lnr)<a name='2203'>
          IF ( present( cci ) ) cci(ix,kz,jy) = an(ix,1,kz,lni)<a name='2204'>
          csw(ix,kz,jy) = an(ix,1,kz,lns)<a name='2205'>
          chw(ix,kz,jy) = an(ix,1,kz,lnh)<a name='2206'>
          IF ( lhl &gt; 1 ) chl(ix,kz,jy) = an(ix,1,kz,lnhl)<a name='2207'>
         ENDIF<a name='2208'>
<a name='2209'>
<a name='2210'>
<a name='2211'>
<a name='2212'>
         IF ( lvh &gt; 0 )  vhw(ix,kz,jy) = an(ix,1,kz,lvh)<a name='2213'>
         IF ( lvhl &gt; 0 .and. present( vhl ) ) vhl(ix,kz,jy) = an(ix,1,kz,lvhl)<a name='2214'>
<a name='2215'>
#ifdef WRF_CHEM<a name='2216'>
         IF ( wrfchem_flag &gt; 0 ) THEN<a name='2217'>
           IF ( PRESENT( rainprod ) ) rainprod(ix,kz,jy) = rainprod2d(ix,kz)<a name='2218'>
           IF ( PRESENT( evapprod ) ) evapprod(ix,kz,jy) = evapprod2d(ix,kz)<a name='2219'>
         ENDIF<a name='2220'>
#endif<a name='2221'>
        ENDDO<a name='2222'>
       ENDDO<a name='2223'>
  <a name='2224'>
     ENDDO <font color=#447700>! jy<a name='2225'></font>
<a name='2226'>
      IF (  invertccn .and. present( cn ) ) THEN <font color=#447700>! hack to convert unactivated ccn  back to activated<a name='2227'></font>
        DO jy = jts,jte<a name='2228'>
         DO kz = kts,kte<a name='2229'>
           DO ix = its,ite<a name='2230'>
             cn(ix,kz,jy) = Max( 0.0, qccn - cn(ix,kz,jy) )<a name='2231'>
           ENDDO<a name='2232'>
         ENDDO<a name='2233'>
       ENDDO<a name='2234'>
       ENDIF<a name='2235'>
<a name='2236'>
<a name='2237'>
<a name='2238'>
<a name='2239'>
<a name='2240'>
  RETURN<a name='2241'>
END SUBROUTINE nssl_2mom_driver<a name='2242'>
<a name='2243'>
<font color=#447700>! #####################################################################<a name='2244'></font>
<font color=#447700>! #####################################################################<a name='2245'></font>
<a name='2246'>
<A NAME='GAMMA_SP'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2247'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>GAMMA_SP</font>(xx) <A href='../../call_to/GAMMA_SP.html' TARGET='index'>27</A><a name='2248'>
<a name='2249'>
      implicit none<a name='2250'>
      real xx<a name='2251'>
      integer j<a name='2252'>
<a name='2253'>
<font color=#447700>! Double precision ser,stp,tmp,x,y,cof(6)<a name='2254'></font>
<a name='2255'>
      real*8 ser,stp,tmp,x,y,cof(6)<a name='2256'>
      SAVE cof,stp<a name='2257'>
      DATA cof,stp/76.18009172947146d+0,  &amp;<a name='2258'>
     &amp;            -86.50532032941677d0,   &amp;<a name='2259'>
     &amp;             24.01409824083091d0,   &amp;<a name='2260'>
     &amp;             -1.231739572450155d0,  &amp;<a name='2261'>
     &amp;              0.1208650973866179d-2,&amp;<a name='2262'>
     &amp;             -0.5395239384953d-5,   &amp;<a name='2263'>
     &amp;              2.5066282746310005d0/<a name='2264'>
<a name='2265'>
      IF ( xx &lt;= 0.0 ) THEN<a name='2266'>
        write(0,*) 'Argument to gamma must be &gt; 0<font color=#447700>!! xx = ',xx<a name='2267'></font>
        STOP<a name='2268'>
      ENDIF<a name='2269'>
      <a name='2270'>
      x = xx<a name='2271'>
      y = x<a name='2272'>
      tmp = x + 5.5d0<a name='2273'>
      tmp = (x + 0.5d0)*Log(tmp) - tmp<a name='2274'>
      ser = 1.000000000190015d0<a name='2275'>
      DO j=1,6<a name='2276'>
        y = y + 1.0d0<a name='2277'>
        ser = ser + cof(j)/y<a name='2278'>
      END DO<a name='2279'>
      gamma_sp = Exp(tmp + log(stp*ser/x))<a name='2280'>
<a name='2281'>
      RETURN<a name='2282'>
      END FUNCTION GAMMA_SP<a name='2283'>
<a name='2284'>
<font color=#447700>! #####################################################################<a name='2285'></font>
<a name='2286'>
<A NAME='GAMXINF'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2287'>
        real <font color=#993300>function </font><font color=#cc0000>GAMXINF</font>(A1,X1) <A href='../../call_to/GAMXINF.html' TARGET='index'>8</A>,<A href='../../call_from/GAMXINF.html' TARGET='index'>2</A><a name='2288'>
<a name='2289'>
<font color=#447700>!       ===================================================<a name='2290'></font>
<font color=#447700>!       Purpose: Compute the incomplete gamma function<a name='2291'></font>
<font color=#447700>!                from x to infinity<a name='2292'></font>
<font color=#447700>!       Input :  a   --- Parameter ( a  170 )<a name='2293'></font>
<font color=#447700>!                x   --- Argument <a name='2294'></font>
<font color=#447700>!       Output:  GIM --- gamma(a,x) t=x,Infinity<a name='2295'></font>
<font color=#447700>!       Routine called: GAMMA for computing gamma(x)<a name='2296'></font>
<font color=#447700>!       ===================================================<a name='2297'></font>
<a name='2298'>
<font color=#447700>!        IMPLICIT DOUBLE PRECISION (A-H,O-Z)<a name='2299'></font>
        implicit none<a name='2300'>
        real :: a1,x1<a name='2301'>
        double precision :: xam,dlog,s,r,ga,t0,a,x<a name='2302'>
        integer :: k<a name='2303'>
        double precision :: gin, gim<a name='2304'>
        <a name='2305'>
        a = a1<a name='2306'>
        x = x1<a name='2307'>
        XAM=-X+A*DLOG(X)<a name='2308'>
        IF (XAM.GT.700.0.OR.A.GT.170.0) THEN<a name='2309'>
           WRITE(*,*)'a and/or x too large'<a name='2310'>
           STOP<a name='2311'>
        ENDIF<a name='2312'>
        IF (X.EQ.0.0) THEN<a name='2313'>
           GIN=0.0<a name='2314'>
           GIM = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>GAMMA_SP</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_19">(A1)<a name='2315'>
        ELSE IF (X.LE.1.0+A) THEN<a name='2316'>
           S=1.0D0/A<a name='2317'>
           R=S<a name='2318'>
           DO 10 K=1,60<a name='2319'>
              R=R*X/(A+K)<a name='2320'>
              S=S+R<a name='2321'>
              IF (DABS(R/S).LT.1.0D-15) GO TO 15<a name='2322'>
10         CONTINUE<a name='2323'>
15         GIN=DEXP(XAM)*S<a name='2324'>
           ga = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>GAMMA_SP</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_20">(A1)<a name='2325'>
           GIM=GA-GIN<a name='2326'>
        ELSE IF (X.GT.1.0+A) THEN<a name='2327'>
           T0=0.0D0<a name='2328'>
           DO 20 K=60,1,-1<a name='2329'>
              T0=(K-A)/(1.0D0+K/(X+T0))<a name='2330'>
20         CONTINUE<a name='2331'>
           GIM=DEXP(XAM)/(X+T0)<a name='2332'>
<font color=#447700>!           GA = GAMMA_SP(A1)<a name='2333'></font>
<font color=#447700>!           GIN=GA-GIM<a name='2334'></font>
        ENDIF<a name='2335'>
        <a name='2336'>
        gamxinf = GIM<a name='2337'>
        return<a name='2338'>
        END function GAMXINF<a name='2339'>
<a name='2340'>
<font color=#447700>! #####################################################################<a name='2341'></font>
<a name='2342'>
<A NAME='GAMXINFDP'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINFDP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2343'>
        double precision <font color=#993300>function </font><font color=#cc0000>GAMXINFDP</font>(A1,X1) <A href='../../call_to/GAMXINFDP.html' TARGET='index'>4</A>,<A href='../../call_from/GAMXINFDP.html' TARGET='index'>2</A><a name='2344'>
<a name='2345'>
<font color=#447700>!       ===================================================<a name='2346'></font>
<font color=#447700>!       Purpose: Compute the incomplete gamma function<a name='2347'></font>
<font color=#447700>!                from x to infinity<a name='2348'></font>
<font color=#447700>!       Input :  a   --- Parameter ( a &lt; 170 )<a name='2349'></font>
<font color=#447700>!                x   --- Argument <a name='2350'></font>
<font color=#447700>!       Output:  GIM --- Gamma(a,x) t=x,Infinity<a name='2351'></font>
<font color=#447700>!       Routine called: GAMMA for computing Ahat(x)<a name='2352'></font>
<font color=#447700>!       ===================================================<a name='2353'></font>
<a name='2354'>
<font color=#447700>!        IMPLICIT DOUBLE PRECISION (A-H,O-Z)<a name='2355'></font>
        implicit none<a name='2356'>
        real :: a1,x1<a name='2357'>
<font color=#447700>! dont declare gamma_dp because it is within the module<a name='2358'></font>
<font color=#447700>!        double precision :: gamma_dp<a name='2359'></font>
        double precision :: xam,dlog,s,r,ga,t0,a,x<a name='2360'>
        integer :: k<a name='2361'>
        double precision :: gin, gim<a name='2362'>
        <a name='2363'>
        a = a1<a name='2364'>
        x = x1<a name='2365'>
        XAM=-X+A*DLOG(X)<a name='2366'>
        IF (XAM.GT.700.0.OR.A.GT.170.0) THEN<a name='2367'>
           WRITE(*,*)'a and/or x too large'<a name='2368'>
           STOP<a name='2369'>
        ENDIF<a name='2370'>
        IF (X.EQ.0.0) THEN<a name='2371'>
           GIN=0.0<a name='2372'>
           GIM = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_DP'>GAMMA_dp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINFDP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_DP_2">(A)<a name='2373'>
        ELSE IF (X.LE.1.0+A) THEN<a name='2374'>
           S=1.0D0/A<a name='2375'>
           R=S<a name='2376'>
           DO 10 K=1,60<a name='2377'>
              R=R*X/(A+K)<a name='2378'>
              S=S+R<a name='2379'>
              IF (DABS(R/S).LT.1.0D-15) GO TO 15<a name='2380'>
10         CONTINUE<a name='2381'>
15         GIN=DEXP(XAM)*S<a name='2382'>
           ga = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_DP'>GAMMA_DP</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINFDP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_DP_3">(A)<a name='2383'>
           GIM=GA-GIN<a name='2384'>
        ELSE IF (X.GT.1.0+A) THEN<a name='2385'>
           T0=0.0D0<a name='2386'>
           DO 20 K=60,1,-1<a name='2387'>
              T0=(K-A)/(1.0D0+K/(X+T0))<a name='2388'>
20         CONTINUE<a name='2389'>
           GIM=DEXP(XAM)/(X+T0)<a name='2390'>
<font color=#447700>!           GA = GAMMA_dp(A)<a name='2391'></font>
<font color=#447700>!           GIN=GA-GIM<a name='2392'></font>
        ENDIF<a name='2393'>
        <a name='2394'>
        gamxinfdp = GIM<a name='2395'>
        return<a name='2396'>
        END function GAMXINFDP<a name='2397'>
<a name='2398'>
<a name='2399'>
<font color=#447700>! #####################################################################<a name='2400'></font>
<a name='2401'>
<font color=#447700>! #####################################################################<a name='2402'></font>
<a name='2403'>
<font color=#447700>!**************************** GAML02 *********************** <a name='2404'></font>
<font color=#447700>!  This calculates Gamma(0.2,x)/Gamma[0.2], where is a ratio<a name='2405'></font>
<font color=#447700>!   It is used for qiacr with the gamma of volume to calculate what <a name='2406'></font>
<font color=#447700>!   fraction of drops exceed a certain size (this version is for 40 micron drops)<a name='2407'></font>
<font color=#447700>! **********************************************************<a name='2408'></font>
<A NAME='GAML02'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAML02' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2409'>
      real <font color=#993300>FUNCTION </font><font color=#cc0000>GAML02</font>(x) <a name='2410'>
      implicit none<a name='2411'>
      integer ig, i, ii, n, np<a name='2412'>
      real x<a name='2413'>
      integer ng<a name='2414'>
      parameter(ng=12)<a name='2415'>
      real gamxg(ng), xg(ng)<a name='2416'>
      DATA xg/0.01,0.02,0.025,0.04,0.075,0.1,0.25,0.5,0.75,1.,2.,10./ <a name='2417'>
      DATA gamxg/  &amp;<a name='2418'>
     &amp;  7.391019203578037e-8,0.02212726874591478,0.06959352407989682, &amp;<a name='2419'>
     &amp;  0.2355654024970809,0.46135930387500346,0.545435791452399,     &amp;<a name='2420'>
     &amp;  0.7371571313308203,                                           &amp;<a name='2421'>
     &amp;  0.8265676632204345,0.8640182781845841,0.8855756211304151,     &amp;<a name='2422'>
     &amp;  0.9245079225301251,                                           &amp;<a name='2423'>
     &amp;  0.9712578342732681/<a name='2424'>
      IF ( x .ge. xg(ng) ) THEN<a name='2425'>
        gaml02 = xg(ng)<a name='2426'>
        RETURN<a name='2427'>
      ENDIF<a name='2428'>
      IF ( x .lt. xg(1) ) THEN<a name='2429'>
        gaml02 = 0.0<a name='2430'>
        RETURN<a name='2431'>
      ENDIF<a name='2432'>
      DO ii = 1,ng-1<a name='2433'>
        i = ng - ii<a name='2434'>
        n = i<a name='2435'>
        np = n + 1<a name='2436'>
        IF ( x .ge. xg(i) ) THEN<a name='2437'>
<font color=#447700>!         GOTO 2 <a name='2438'></font>
          gaml02 = gamxg(N)+((X-XG(N))/(XG(NP)-XG(N)))* &amp;<a name='2439'>
     &amp;            ( gamxg(NP) - gamxg(N) ) <a name='2440'>
          RETURN<a name='2441'>
        ENDIF<a name='2442'>
      ENDDO<a name='2443'>
      RETURN<a name='2444'>
      END FUNCTION GAML02<a name='2445'>
<a name='2446'>
<font color=#447700>!**************************** GAML02d300 *********************** <a name='2447'></font>
<font color=#447700>!  This calculates Gamma(0.2,x)/Gamma[0.2], where is a ratio<a name='2448'></font>
<font color=#447700>!   It is used for qiacr with the gamma of volume to calculate what <a name='2449'></font>
<font color=#447700>!   fraction of drops exceed a certain size (this version is for 300 micron drops) (see zieglerstuff.nb)<a name='2450'></font>
<font color=#447700>! **********************************************************<a name='2451'></font>
<A NAME='GAML02D300'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAML02D300' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2452'>
      real <font color=#993300>FUNCTION </font><font color=#cc0000>GAML02d300</font>(x) <a name='2453'>
      implicit none<a name='2454'>
      integer ig, i, ii, n, np<a name='2455'>
      real x<a name='2456'>
      integer ng<a name='2457'>
      parameter(ng=9)<a name='2458'>
      real gamxg(ng), xg(ng)<a name='2459'>
      DATA xg/0.04,0.075,0.1,0.25,0.5,0.75,1.,2.,10./ <a name='2460'>
      DATA gamxg/                           &amp;<a name='2461'>
     &amp;  0.0,                                  &amp;<a name='2462'>
     &amp;  7.391019203578011e-8,0.0002260640810600053,  &amp;<a name='2463'>
     &amp;  0.16567071824457152,                         &amp;<a name='2464'>
     &amp;  0.4231369044918005,0.5454357914523988,       &amp;<a name='2465'>
     &amp;  0.6170290936864555,                           &amp;<a name='2466'>
     &amp;  0.7471346054110058,0.9037156157718299 /<a name='2467'>
      IF ( x .ge. xg(ng) ) THEN<a name='2468'>
        GAML02d300 = xg(ng)<a name='2469'>
        RETURN<a name='2470'>
      ENDIF<a name='2471'>
      IF ( x .lt. xg(1) ) THEN<a name='2472'>
        GAML02d300 = 0.0<a name='2473'>
        RETURN<a name='2474'>
      ENDIF<a name='2475'>
      DO ii = 1,ng-1<a name='2476'>
        i = ng - ii<a name='2477'>
        n = i<a name='2478'>
        np = n + 1<a name='2479'>
        IF ( x .ge. xg(i) ) THEN<a name='2480'>
<font color=#447700>!         GOTO 2 <a name='2481'></font>
          GAML02d300 = gamxg(N)+((X-XG(N))/(XG(NP)-XG(N)))*  &amp;<a name='2482'>
     &amp;            ( gamxg(NP) - gamxg(N) ) <a name='2483'>
          RETURN<a name='2484'>
        ENDIF<a name='2485'>
      ENDDO<a name='2486'>
      RETURN<a name='2487'>
      END FUNCTION GAML02d300<a name='2488'>
<font color=#447700>!c<a name='2489'></font>
<a name='2490'>
<font color=#447700>! #####################################################################<a name='2491'></font>
<font color=#447700>! #####################################################################<a name='2492'></font>
<a name='2493'>
<font color=#447700>!**************************** GAML02 *********************** <a name='2494'></font>
<font color=#447700>!  This calculates Gamma(0.2,x)/Gamma[0.2], where is a ratio<a name='2495'></font>
<font color=#447700>!   It is used for qiacr with the gamma of volume to calculate what <a name='2496'></font>
<font color=#447700>!   fraction of drops exceed a certain size (this version is for 500 micron drops) (see zieglerstuff.nb)<a name='2497'></font>
<font color=#447700>! **********************************************************<a name='2498'></font>
<A NAME='GAML02D500'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAML02D500' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2499'>
      real <font color=#993300>FUNCTION </font><font color=#cc0000>GAML02d500</font>(x) <a name='2500'>
      implicit none<a name='2501'>
      integer ig, i, ii, n, np<a name='2502'>
      real x<a name='2503'>
      integer ng<a name='2504'>
      parameter(ng=9)<a name='2505'>
      real gamxg(ng), xg(ng)<a name='2506'>
      DATA xg/0.04,0.075,0.1,0.25,0.5,0.75,1.,2.,10./ <a name='2507'>
      DATA gamxg/  &amp;<a name='2508'>
     &amp;  0.0,0.0,   &amp;<a name='2509'>
     &amp;  2.2346039e-13, 0.0221272687459,  &amp;<a name='2510'>
     &amp;  0.23556540,  0.38710348,         &amp;<a name='2511'>
     &amp;  0.48136183,0.6565833,            &amp;<a name='2512'>
     &amp;  0.86918315 /<a name='2513'>
      IF ( x .ge. xg(ng) ) THEN<a name='2514'>
        GAML02d500 = xg(ng)<a name='2515'>
        RETURN<a name='2516'>
      ENDIF<a name='2517'>
      IF ( x .lt. xg(1) ) THEN<a name='2518'>
        GAML02d500 = 0.0<a name='2519'>
        RETURN<a name='2520'>
      ENDIF<a name='2521'>
      DO ii = 1,ng-1<a name='2522'>
        i = ng - ii<a name='2523'>
        n = i<a name='2524'>
        np = n + 1<a name='2525'>
        IF ( x .ge. xg(i) ) THEN<a name='2526'>
<font color=#447700>!         GOTO 2 <a name='2527'></font>
          GAML02d500 = gamxg(N)+((X-XG(N))/(XG(NP)-XG(N)))*  &amp;<a name='2528'>
     &amp;            ( gamxg(NP) - gamxg(N) ) <a name='2529'>
          RETURN<a name='2530'>
        ENDIF<a name='2531'>
      ENDDO<a name='2532'>
      RETURN<a name='2533'>
      END FUNCTION GAML02d500<a name='2534'>
<font color=#447700>!c<a name='2535'></font>
<a name='2536'>
<font color=#447700>! #####################################################################<a name='2537'></font>
<a name='2538'>
<font color=#447700>! #####################################################################<a name='2539'></font>
<a name='2540'>
<a name='2541'>
<A NAME='BETA'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#BETA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2542'>
        real <font color=#993300>function </font><font color=#cc0000>BETA</font>(P,Q) <A href='../../call_to/BETA.html' TARGET='index'>3</A>,<A href='../../call_from/BETA.html' TARGET='index'>3</A><a name='2543'>
<font color=#447700>!<a name='2544'></font>
<font color=#447700>!       ==========================================<a name='2545'></font>
<font color=#447700>!       Purpose: Compute the beta function B(p,q)<a name='2546'></font>
<font color=#447700>!       Input :  p  --- Parameter  ( p &gt; 0 )<a name='2547'></font>
<font color=#447700>!                q  --- Parameter  ( q &gt; 0 )<a name='2548'></font>
<font color=#447700>!       Output:  BT --- B(p,q)<a name='2549'></font>
<font color=#447700>!       Routine called: GAMMA for computing gamma(x)<a name='2550'></font>
<font color=#447700>!       ==========================================<a name='2551'></font>
<font color=#447700>!<a name='2552'></font>
<font color=#447700>!        IMPLICIT real (A-H,O-Z)<a name='2553'></font>
        implicit none<a name='2554'>
        double precision p1,gp,q1,gq, ppq,gpq<a name='2555'>
        real p,q<a name='2556'>
        <a name='2557'>
        p1 = p<a name='2558'>
        q1 = q<a name='2559'>
        CALL <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMADP'>GAMMADP</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#BETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMADP_1">(P1,GP)<a name='2560'>
        CALL <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMADP'>GAMMADP</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#BETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMADP_2">(Q1,GQ)<a name='2561'>
        PPQ=P1+Q1<a name='2562'>
        CALL <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMADP'>GAMMADP</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#BETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMADP_3">(PPQ,GPQ)<a name='2563'>
        beta=GP*GQ/GPQ<a name='2564'>
        RETURN<a name='2565'>
        END function BETA<a name='2566'>
<a name='2567'>
<font color=#447700>! #####################################################################<a name='2568'></font>
<font color=#447700>! #####################################################################<a name='2569'></font>
<a name='2570'>
<A NAME='GAMMA_DP'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_DP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2571'>
      DOUBLE PRECISION <font color=#993300>FUNCTION </font><font color=#cc0000>GAMMA_DP</font>(xx) <A href='../../call_to/GAMMA_DP.html' TARGET='index'>3</A><a name='2572'>
<a name='2573'>
      implicit none<a name='2574'>
      double precision xx<a name='2575'>
      integer j<a name='2576'>
<a name='2577'>
<font color=#447700>! Double precision ser,stp,tmp,x,y,cof(6)<a name='2578'></font>
<a name='2579'>
      real*8 ser,stp,tmp,x,y,cof(6)<a name='2580'>
      SAVE cof,stp<a name='2581'>
      DATA cof,stp/76.18009172947146d+0,  &amp;<a name='2582'>
     &amp;            -86.50532032941677d0,   &amp;<a name='2583'>
     &amp;             24.01409824083091d0,   &amp;<a name='2584'>
     &amp;             -1.231739572450155d0,  &amp;<a name='2585'>
     &amp;              0.1208650973866179d-2,&amp;<a name='2586'>
     &amp;             -0.5395239384953d-5,   &amp;<a name='2587'>
     &amp;              2.5066282746310005d0/<a name='2588'>
<a name='2589'>
      x = xx<a name='2590'>
      y = x<a name='2591'>
      tmp = x + 5.5d0<a name='2592'>
      tmp = (x + 0.5d0)*Log(tmp) - tmp<a name='2593'>
      ser = 1.000000000190015d0<a name='2594'>
      DO j=1,6<a name='2595'>
        y = y + 1.0d0<a name='2596'>
        ser = ser + cof(j)/y<a name='2597'>
      END DO<a name='2598'>
      gamma_dp = Exp(tmp + log(stp*ser/x))<a name='2599'>
<a name='2600'>
      RETURN<a name='2601'>
      END function gamma_dp<a name='2602'>
<font color=#447700>! #####################################################################<a name='2603'></font>
<a name='2604'>
<A NAME='GAMMADP'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMADP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2605'>
        <font color=#993300>SUBROUTINE </font><font color=#cc0000>GAMMADP</font>(X,GA) <A href='../../call_to/GAMMADP.html' TARGET='index'>3</A><a name='2606'>
<font color=#447700>!<a name='2607'></font>
<font color=#447700>!       ==================================================<a name='2608'></font>
<font color=#447700>!       Purpose: Compute gamma function Gamma(x)<a name='2609'></font>
<font color=#447700>!       Input :  x  --- Argument of Gamma(x)<a name='2610'></font>
<font color=#447700>!                       ( x is not equal to 0,-1,-2,...)<a name='2611'></font>
<font color=#447700>!       Output:  GA --- gamma(x)<a name='2612'></font>
<font color=#447700>!       ==================================================<a name='2613'></font>
<font color=#447700>!<a name='2614'></font>
<font color=#447700>!        IMPLICIT DOUBLE PRECISION (A-H,O-Z)<a name='2615'></font>
        implicit none<a name='2616'>
        <a name='2617'>
        double precision, parameter :: PI=3.141592653589793D0<a name='2618'>
        double precision :: x,ga,z,r,gr<a name='2619'>
        integer :: k,m1,m<a name='2620'>
        <a name='2621'>
        double precision :: G(26)<a name='2622'>
        <a name='2623'>
        IF (X.EQ.INT(X)) THEN<a name='2624'>
           IF (X.GT.0.0D0) THEN<a name='2625'>
              GA=1.0D0<a name='2626'>
              M1=X-1<a name='2627'>
              DO K=2,M1<a name='2628'>
                GA=GA*K<a name='2629'>
              ENDDO<a name='2630'>
           ELSE<a name='2631'>
              GA=1.0D+300<a name='2632'>
           ENDIF<a name='2633'>
        ELSE<a name='2634'>
           IF (DABS(X).GT.1.0D0) THEN<a name='2635'>
              Z=DABS(X)<a name='2636'>
              M=INT(Z)<a name='2637'>
              R=1.0D0<a name='2638'>
              DO K=1,M<a name='2639'>
                 R=R*(Z-K)<a name='2640'>
              ENDDO<a name='2641'>
              Z=Z-M<a name='2642'>
           ELSE<a name='2643'>
              Z=X<a name='2644'>
           ENDIF<a name='2645'>
           DATA G/1.0D0,0.5772156649015329D0,                  &amp;<a name='2646'>
     &amp;          -0.6558780715202538D0, -0.420026350340952D-1,  &amp;<a name='2647'>
     &amp;          0.1665386113822915D0,-.421977345555443D-1,     &amp;<a name='2648'>
     &amp;          -.96219715278770D-2, .72189432466630D-2,       &amp;<a name='2649'>
     &amp;          -.11651675918591D-2, -.2152416741149D-3,       &amp;<a name='2650'>
     &amp;          .1280502823882D-3, -.201348547807D-4,          &amp;<a name='2651'>
     &amp;          -.12504934821D-5, .11330272320D-5,             &amp;<a name='2652'>
     &amp;          -.2056338417D-6, .61160950D-8,                 &amp;<a name='2653'>
     &amp;          .50020075D-8, -.11812746D-8,                   &amp;<a name='2654'>
     &amp;          .1043427D-9, .77823D-11,                       &amp;<a name='2655'>
     &amp;          -.36968D-11, .51D-12,                          &amp;<a name='2656'>
     &amp;          -.206D-13, -.54D-14, .14D-14, .1D-15/<a name='2657'>
           GR=G(26)<a name='2658'>
           DO K=25,1,-1<a name='2659'>
             GR=GR*Z+G(K)<a name='2660'>
           ENDDO<a name='2661'>
           GA=1.0D0/(GR*Z)<a name='2662'>
           IF (DABS(X).GT.1.0D0) THEN<a name='2663'>
              GA=GA*R<a name='2664'>
              IF (X.LT.0.0D0) GA=-PI/(X*GA*DSIN(PI*X))<a name='2665'>
           ENDIF<a name='2666'>
        ENDIF<a name='2667'>
        RETURN<a name='2668'>
        END SUBROUTINE GAMMADP<a name='2669'>
<a name='2670'>
<a name='2671'>
<font color=#447700>! #####################################################################<a name='2672'></font>
<font color=#447700>! #####################################################################<a name='2673'></font>
<font color=#447700>!<a name='2674'></font>
<font color=#447700>!<a name='2675'></font>
<font color=#447700>! #####################################################################<a name='2676'></font>
<A NAME='DELBK'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#DELBK' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2677'>
      <font color=#993300>Function </font><font color=#cc0000>delbk</font>(bb,nu,mu,k) <A href='../../call_to/DELBK.html' TARGET='index'>2</A><a name='2678'>
<font color=#447700>!   <a name='2679'></font>
<font color=#447700>!  Purpose: Caluculates collection coefficients following Siefert (2006)<a name='2680'></font>
<font color=#447700>!<a name='2681'></font>
<font color=#447700>!  delbk is equation (90) (b collecting b -- self-collection)<a name='2682'></font>
<font color=#447700>!  mass-diameter relationship: D = a*x**(b), where x = particle mass<a name='2683'></font>
<font color=#447700>!  general distribution: n(x) = A*x**(nu)*Exp(-lam*x**(mu))<a name='2684'></font>
<font color=#447700>!  where<a name='2685'></font>
<font color=#447700>!      A = mu*N/(Gamma((nu+1)/mu)) *lam**((nu+1)/mu)<a name='2686'></font>
<font color=#447700>!<a name='2687'></font>
<font color=#447700>!      lam = ( Gamma((nu+1)/mu)/Gamma((nu+2)/mu) * xbar )**(-mu)<a name='2688'></font>
<font color=#447700>!<a name='2689'></font>
<font color=#447700>!     where  xbar = L/N  (mass content)/(number concentration) = q*rhoa/N<a name='2690'></font>
<font color=#447700>!<a name='2691'></font>
<a name='2692'>
      implicit none<a name='2693'>
      real delbk<a name='2694'>
      real nu, mu, bb<a name='2695'>
      integer k<a name='2696'>
      <a name='2697'>
      real tmp, del<a name='2698'>
      real x1, x2, x3, x4<a name='2699'>
      integer i<a name='2700'>
<a name='2701'>
        tmp = ((1.0 + nu)/mu)<a name='2702'>
        i = Int(dgami*(tmp))<a name='2703'>
        del = tmp - dgam*i<a name='2704'>
        x1 = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2705'>
<a name='2706'>
        tmp = ((2.0 + nu)/mu)<a name='2707'>
        i = Int(dgami*(tmp))<a name='2708'>
        del = tmp - dgam*i<a name='2709'>
        x2 = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2710'>
<a name='2711'>
        tmp = ((1.0 + 2.0*bb + k + nu)/mu)<a name='2712'>
        i = Int(dgami*(tmp))<a name='2713'>
        del = tmp - dgam*i<a name='2714'>
        x3 = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2715'>
      <a name='2716'>
<font color=#447700>!      delbk =  &amp;<a name='2717'></font>
<font color=#447700>!     &amp;  ((Gamma_sp((1.0 + nu)/mu)/Gamma_sp((2.0 + nu)/mu))**(2.0*bb + k)* &amp;<a name='2718'></font>
<font color=#447700>!     &amp;    Gamma_sp((1.0 + 2.0*bb + k + nu)/mu))/Gamma_sp((1.0 + nu)/mu)<a name='2719'></font>
<a name='2720'>
      delbk =  &amp;<a name='2721'>
     &amp;  ((x1/x2)**(2.0*bb + k)* &amp;<a name='2722'>
     &amp;    x3)/x1<a name='2723'>
      <a name='2724'>
      RETURN<a name='2725'>
      END  Function delbk<a name='2726'>
      <a name='2727'>
<font color=#447700>! #####################################################################<a name='2728'></font>
<font color=#447700>!<a name='2729'></font>
<font color=#447700>!<a name='2730'></font>
<font color=#447700>! #####################################################################<a name='2731'></font>
<font color=#447700>! Equation (91) in Seifert and Beheng (2006) ("a" collecting "b")<a name='2732'></font>
<A NAME='DELABK'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#DELABK' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2733'>
      <font color=#993300>Function </font><font color=#cc0000>delabk</font>(ba,bb,nua,nub,mua,mub,k) <A href='../../call_to/DELABK.html' TARGET='index'>2</A><a name='2734'>
      <a name='2735'>
      implicit none<a name='2736'>
      real delabk<a name='2737'>
      real nua, mua, ba<a name='2738'>
      integer k<a name='2739'>
      real nub, mub, bb<a name='2740'>
      <a name='2741'>
      integer i<a name='2742'>
      real tmp,del<a name='2743'>
      <a name='2744'>
      real g1pnua, g2pnua, g1pbapnua, g1pbbpk, g1pnub, g2pnub<a name='2745'>
      <a name='2746'>
        tmp = (1. + nua)/mua<a name='2747'>
        i = Int(dgami*(tmp))<a name='2748'>
        del = tmp - dgam*i<a name='2749'>
        IF ( i+1 &gt; ngm0 ) THEN<a name='2750'>
          write(0,*) 'delabk: i+1 &gt; ngm0<font color=#447700>!!!!',i,ngm0,nua,mua,tmp<a name='2751'></font>
          STOP<a name='2752'>
        ENDIF<a name='2753'>
        g1pnua = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2754'>
<font color=#447700>!        write(91,*) 'delabk: g1pnua,gamma = ',g1pnua,Gamma_sp((1. + nua)/mua)<a name='2755'></font>
<a name='2756'>
        tmp = ((2. + nua)/mua)<a name='2757'>
        i = Int(dgami*(tmp))<a name='2758'>
        del = tmp - dgam*i<a name='2759'>
        g2pnua = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2760'>
<a name='2761'>
        tmp = ((1. + ba + nua)/mua)<a name='2762'>
        i = Int(dgami*(tmp))<a name='2763'>
        del = tmp - dgam*i<a name='2764'>
        g1pbapnua = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2765'>
<a name='2766'>
        tmp = ((1. + nub)/mub)<a name='2767'>
        i = Int(dgami*(tmp))<a name='2768'>
        del = tmp - dgam*i<a name='2769'>
        g1pnub = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2770'>
<a name='2771'>
        tmp = ((2 + nub)/mub)<a name='2772'>
        i = Int(dgami*(tmp))<a name='2773'>
        del = tmp - dgam*i<a name='2774'>
        g2pnub = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2775'>
<a name='2776'>
        tmp = ((1. + bb + k + nub)/mub)<a name='2777'>
        i = Int(dgami*(tmp))<a name='2778'>
        del = tmp - dgam*i<a name='2779'>
        g1pbbpk = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='2780'>
<a name='2781'>
      delabk =  &amp;<a name='2782'>
     &amp;  (2.*(g1pnua/g2pnua)**ba*     &amp;<a name='2783'>
     &amp;    g1pbapnua*                                               &amp;<a name='2784'>
     &amp;    (g1pnub/g2pnub)**(bb + k)*                                &amp;<a name='2785'>
     &amp;    g1pbbpk)/                                                &amp;<a name='2786'>
     &amp;  (g1pnua*g1pnub)              <a name='2787'>
      <a name='2788'>
      RETURN<a name='2789'>
      END Function delabk<a name='2790'>
      <a name='2791'>
<a name='2792'>
<font color=#447700>! #####################################################################<a name='2793'></font>
<font color=#447700>!<a name='2794'></font>
<font color=#447700>! #####################################################################<a name='2795'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='2796'></font>
<A NAME='CLD_CPU'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CLD_CPU' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2797'>
      <font color=#993300>subroutine </font><font color=#cc0000>cld_cpu</font>(string)<a name='2798'>
<a name='2799'>
      implicit none<a name='2800'>
      character( LEN = * ) string<a name='2801'>
      <a name='2802'>
      return<a name='2803'>
      <a name='2804'>
      end subroutine cld_cpu<a name='2805'>
<a name='2806'>
<font color=#447700>!<a name='2807'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='2808'></font>
<font color=#447700>!<a name='2809'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='2810'></font>
<font color=#447700>!<a name='2811'></font>
<A NAME='SEDIMENT1D'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2812'>
      <font color=#993300>subroutine </font><font color=#cc0000>sediment1d</font>(dtp,nx,ny,nz,an,na,nor,norz,xfall,dn,dz3d,dz3dinv, &amp; <A href='../../call_to/SEDIMENT1D.html' TARGET='index'>1</A>,<A href='../../call_from/SEDIMENT1D.html' TARGET='index'>10</A><a name='2813'>
     &amp;                    t0,t7,infdo,jslab,its,jts,  &amp;<a name='2814'>
     &amp;   timesed1,timesed2,timesed3,zmaxsed,timesetvt) <font color=#447700>! used for timing<a name='2815'></font>
<font color=#447700>!<a name='2816'></font>
<font color=#447700>! Sedimentation driver -- column by column<a name='2817'></font>
<font color=#447700>!<a name='2818'></font>
<font color=#447700>!  Written by ERM 10/2011<a name='2819'></font>
<font color=#447700>!<a name='2820'></font>
<font color=#447700>!<a name='2821'></font>
<font color=#447700>!<a name='2822'></font>
      implicit none<a name='2823'>
<a name='2824'>
      integer nx,ny,nz,nor,norz,ngt,jgs,na,ia<a name='2825'>
      integer id <font color=#447700>! =1 use density, =0 no density<a name='2826'></font>
      integer :: its,jts <font color=#447700>! SW point of local tile<a name='2827'></font>
      <a name='2828'>
      integer ng1<a name='2829'>
      parameter(ng1 = 1)<a name='2830'>
<a name='2831'>
      real an(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz,na)<a name='2832'>
      real dn(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='2833'>
      real dz3d(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='2834'>
      real dz3dinv(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='2835'>
      real t0(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='2836'>
      real t7(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='2837'>
<a name='2838'>
<font color=#447700>!      real gz(-nor+ng1:nz+nor),z1d(-nor+ng1:nz+nor,4)<a name='2839'></font>
      real dtp<a name='2840'>
      real xfall(nx,ny,na)  <font color=#447700>! array for stuff landing on the ground<a name='2841'></font>
      real xfall0(nx,ny)    <font color=#447700>! dummy array<a name='2842'></font>
      integer infdo<a name='2843'>
      integer jslab <font color=#447700>! which line of xfall to use<a name='2844'></font>
            <a name='2845'>
      integer ix,jy,kz,ndfall,n,k,il,in<a name='2846'>
      real tmp, vtmax, dtptmp, dtfrac<a name='2847'>
      real, parameter :: dz = 200.<a name='2848'>
<a name='2849'>
      real :: xvt(nz+1,nx,3,lc:lhab) <font color=#447700>! (nx,nz,2,lc:lhab) ! 1=mass-weighted, 2=number-weighted<a name='2850'></font>
      real :: tmpn(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='2851'>
      real :: tmpn2(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='2852'>
      real :: z(-nor+ng1:nx+nor,-norz+ng1:nz+norz,lr:lhab)<a name='2853'>
      real :: db1(nx,nz+1),dtz1(nz+1,nx,0:1),dz2dinv(nz+1,nx),db1inv(nx,nz+1)<a name='2854'>
      <a name='2855'>
      real :: rhovtzx(nz,nx)<a name='2856'>
      <a name='2857'>
      double precision :: timesed1,timesed2,timesed3, zmaxsed,timesetvt,dummy<a name='2858'>
      double precision :: dt1,dt2,dt3,dt4<a name='2859'>
<a name='2860'>
      integer,parameter :: ngs = 128 <a name='2861'>
      integer :: ngscnt,mgs,ipconc0<a name='2862'>
      <a name='2863'>
      real ::  qx(ngs,lv:lhab) <a name='2864'>
      real ::  qxw(ngs,ls:lhab) <a name='2865'>
      real ::  cx(ngs,lc:lhab) <a name='2866'>
      real ::  xv(ngs,lc:lhab) <a name='2867'>
      real ::  vtxbar(ngs,lc:lhab,3) <a name='2868'>
      real ::  xmas(ngs,lc:lhab) <a name='2869'>
      real ::  xdn(ngs,lc:lhab) <a name='2870'>
      real ::  xdia(ngs,lc:lhab,3) <a name='2871'>
      real ::  vx(ngs,li:lhab) <a name='2872'>
      real ::  alpha(ngs,lc:lhab) <a name='2873'>
      real ::  zx(ngs,lr:lhab) <a name='2874'>
      logical :: hasmass(nx,lc+1:lhab)<a name='2875'>
<a name='2876'>
      integer igs(ngs),kgs(ngs)<a name='2877'>
      <a name='2878'>
      real rho0(ngs),temcg(ngs)<a name='2879'>
<a name='2880'>
      real temg(ngs)<a name='2881'>
      <a name='2882'>
      real rhovt(ngs)<a name='2883'>
      <a name='2884'>
      real cwnc(ngs),cinc(ngs)<a name='2885'>
      real fadvisc(ngs),cwdia(ngs),cipmas(ngs)<a name='2886'>
      <a name='2887'>
      real cimasn,cimasx,cnina(ngs),cimas(ngs)<a name='2888'>
      <a name='2889'>
      real cnostmp(ngs)<a name='2890'>
      <a name='2891'>
<a name='2892'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2893'></font>
<a name='2894'>
      integer :: ixb, jyb, kzb<a name='2895'>
      integer :: ixe, jye, kze<a name='2896'>
      integer :: plo, phi<a name='2897'>
<a name='2898'>
      logical :: debug_mpi = .TRUE.<a name='2899'>
<a name='2900'>
<font color=#447700>! ###################################################################<a name='2901'></font>
<a name='2902'>
<a name='2903'>
<a name='2904'>
<a name='2905'>
      kzb = 1<a name='2906'>
      kze = nz<a name='2907'>
<a name='2908'>
      ixb = 1<a name='2909'>
      ixe = nx<a name='2910'>
<a name='2911'>
<a name='2912'>
      jy = 1<a name='2913'>
      jgs = jy<a name='2914'>
<a name='2915'>
<a name='2916'>
<font color=#447700>!<a name='2917'></font>
<font color=#447700>!  zero the precip flux arrays (2d)<a name='2918'></font>
<font color=#447700>!<a name='2919'></font>
<a name='2920'>
      xvt(:,:,:,:) = 0.0<a name='2921'>
<a name='2922'>
      if ( ndebug .gt. 0 ) write(0,*) 'dbg = 3a'<a name='2923'>
<a name='2924'>
<a name='2925'>
      DO kz = kzb,kze<a name='2926'>
      DO ix = ixb,ixe<a name='2927'>
       db1(ix,kz) = dn(ix,jy,kz)<a name='2928'>
       db1inv(ix,kz) = 1./dn(ix,jy,kz)<a name='2929'>
       rhovtzx(kz,ix) = Sqrt(rho00*db1inv(ix,kz) )<a name='2930'>
      ENDDO<a name='2931'>
      ENDDO<a name='2932'>
<a name='2933'>
      DO kz = kzb,kze<a name='2934'>
      DO ix = ixb,ixe<a name='2935'>
       dtz1(kz,ix,0) = dz3dinv(ix,jy,kz)<a name='2936'>
       dtz1(kz,ix,1) = dz3dinv(ix,jy,kz)*db1inv(ix,kz) <a name='2937'>
       dz2dinv(kz,ix) = dz3dinv(ix,jy,kz)<a name='2938'>
      ENDDO<a name='2939'>
      ENDDO<a name='2940'>
<a name='2941'>
      IF ( lzh .gt. 1 ) THEN<a name='2942'>
      DO kz = kzb,kze<a name='2943'>
      DO ix = ixb,ixe<a name='2944'>
        an(ix,jy,kz,lzh) = Max( 0., an(ix,jy,kz,lzh) )<a name='2945'>
      ENDDO<a name='2946'>
      ENDDO<a name='2947'>
      ENDIF<a name='2948'>
<a name='2949'>
      <a name='2950'>
      DO il = lc+1,lhab<a name='2951'>
       DO ix = ixb,ixe<a name='2952'>
<font color=#447700>!        hasmass(ix,il) = Any( an(ix,jy,:,il) &gt; qxmin(il) )<a name='2953'></font>
       ENDDO<a name='2954'>
      ENDDO<a name='2955'>
<a name='2956'>
<a name='2957'>
<a name='2958'>
<a name='2959'>
      if (ndebug .gt. 0 ) write(0,*) 'dbg = 3a2'<a name='2960'>
<a name='2961'>
<font color=#447700>! loop over columns<a name='2962'></font>
      DO ix = ixb,ixe<a name='2963'>
      <a name='2964'>
      dummy = 0.d0<a name='2965'>
<a name='2966'>
      <a name='2967'>
      call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#ZIEGFALL1D'>ziegfall1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZIEGFALL1D_1">(nx,ny,nz,nor,norz,na,dtp,jgs,ix, &amp; <a name='2968'>
     &amp;  xvt, rhovtzx, &amp; <a name='2969'>
     &amp;  an,dn,ipconc,t0,t7,cwmasn,cwmasx, &amp; <a name='2970'>
     &amp;  cwradn, &amp; <a name='2971'>
     &amp;  qxmin,xdnmx,xdnmn,cdx,cno,xdn0,xvmn,xvmx, &amp; <a name='2972'>
     &amp;  ngs,qx,qxw,cx,xv,vtxbar,xmas,xdn,xdia,vx,alpha,zx,igs,kgs, &amp;<a name='2973'>
     &amp;  rho0,temcg,temg,rhovt,cwnc,cinc,fadvisc,cwdia,cipmas,cnina,cimas, &amp;<a name='2974'>
     &amp;  cnostmp,              &amp;<a name='2975'>
     &amp;  infdo,0               &amp;<a name='2976'>
     &amp; )<a name='2977'>
<a name='2978'>
<a name='2979'>
<font color=#447700>! loop over each species and do sedimentation for all moments<a name='2980'></font>
     DO il = lc,lhab<a name='2981'>
       IF ( ido(il) == 0 ) CYCLE<a name='2982'>
<a name='2983'>
<font color=#447700>!       IF ( .not. hasmass(ix,il) ) CYCLE<a name='2984'></font>
<a name='2985'>
<font color=#447700>!      plo = nz<a name='2986'></font>
<font color=#447700>!      phi = 0<a name='2987'></font>
<a name='2988'>
<a name='2989'>
      vtmax = 0.0<a name='2990'>
      <a name='2991'>
      do kz = kzb,kze<a name='2992'>
<a name='2993'>
      <font color=#447700>! apply limit vtmaxsed (08/20/2015)<a name='2994'></font>
      xvt(kz,ix,1,il) = Min( vtmaxsed,  xvt(kz,ix,1,il) )<a name='2995'>
      xvt(kz,ix,2,il) = Min( vtmaxsed,  xvt(kz,ix,2,il) )<a name='2996'>
      xvt(kz,ix,3,il) = Min( vtmaxsed,  xvt(kz,ix,3,il) )<a name='2997'>
      <a name='2998'>
      vtmax = Max(vtmax,xvt(kz,ix,1,il)*dz2dinv(kz,ix))<a name='2999'>
      vtmax = Max(vtmax,xvt(kz,ix,2,il)*dz2dinv(kz,ix))<a name='3000'>
      vtmax = Max(vtmax,xvt(kz,ix,3,il)*dz2dinv(kz,ix))<a name='3001'>
<a name='3002'>
<font color=#447700>!      IF ( dtp*xvt(kz,ix,1,il)*dz2dinv(kz,ix) &gt;= 0.7 .or. &amp;<a name='3003'></font>
<font color=#447700>!     &amp;     dtp*xvt(kz,ix,2,il)*dz2dinv(kz,ix) &gt;= 0.7 .or. &amp;<a name='3004'></font>
<font color=#447700>!     &amp;     dtp*xvt(kz,ix,3,il)*dz2dinv(kz,ix) &gt;= 0.7 ) THEN<a name='3005'></font>
<font color=#447700>!          <a name='3006'></font>
<font color=#447700>!          zmaxsed = Max(zmaxsed, float(kz) )<a name='3007'></font>
<font color=#447700>!!          plo = Min(plo,kz)<a name='3008'></font>
<font color=#447700>!!          phi = Max(phi,kz)<a name='3009'></font>
<font color=#447700>!           <a name='3010'></font>
<font color=#447700>!      ENDIF<a name='3011'></font>
      <a name='3012'>
      ENDDO<a name='3013'>
      <a name='3014'>
      IF ( vtmax == 0.0 ) CYCLE<a name='3015'>
<a name='3016'>
<a name='3017'>
      <a name='3018'>
      IF ( dtp*vtmax .lt. 0.7 ) THEN <font color=#447700>! check whether multiple steps are needed.<a name='3019'></font>
        ndfall = 1<a name='3020'>
      ELSE<a name='3021'>
       IF ( dtp &gt; 20.0 ) THEN <font color=#447700>! more stringent subdivision for large time steps<a name='3022'></font>
         ndfall = Max(2, Int(dtp*vtmax/0.7) + 1)<a name='3023'>
       ELSE <font color=#447700>! more relaxed for small time steps, but might still be a problem for very thin vertical layers near the ground<a name='3024'></font>
         ndfall = 1+Int(dtp*vtmax + 0.301)<a name='3025'>
       ENDIF<a name='3026'>
      ENDIF<a name='3027'>
      <a name='3028'>
      IF ( ndfall .gt. 1 ) THEN<a name='3029'>
        dtptmp = dtp/Real(ndfall)<a name='3030'>
<font color=#447700>!        write(0,*) 'subdivide fallout on its,jts,ix,plo,phi = ',its,jts,ix,plo,phi<a name='3031'></font>
<font color=#447700>!        write(0,*) 'for il,jsblab,c,ndfall = ',il,jslab,dtp*vtmax,ndfall<a name='3032'></font>
      ELSE<a name='3033'>
        dtptmp = dtp<a name='3034'>
      ENDIF<a name='3035'>
      <a name='3036'>
      dtfrac = dtptmp/dtp<a name='3037'>
<a name='3038'>
<a name='3039'>
      DO n = 1,ndfall<a name='3040'>
<a name='3041'>
      IF ( do_accurate_sedimentation .and. n .ge. 2 ) THEN<a name='3042'>
<font color=#447700>!<a name='3043'></font>
<font color=#447700>!  zero the precip flux arrays (2d)<a name='3044'></font>
<font color=#447700>!<a name='3045'></font>
      <a name='3046'>
<font color=#447700>!      xvt(:,:,:,il) = 0.0<a name='3047'></font>
      dummy = 0.d0<a name='3048'>
      call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#ZIEGFALL1D'>ziegfall1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZIEGFALL1D_2">(nx,ny,nz,nor,norz,na,dtp,jgs,ix, &amp; <a name='3049'>
     &amp;  xvt, rhovtzx, &amp; <a name='3050'>
     &amp;  an,dn,ipconc,t0,t7,cwmasn,cwmasx, &amp; <a name='3051'>
     &amp;  cwradn, &amp; <a name='3052'>
     &amp;  qxmin,xdnmx,xdnmn,cdx,cno,xdn0,xvmn,xvmx, &amp; <a name='3053'>
     &amp;  ngs,qx,qxw,cx,xv,vtxbar,xmas,xdn,xdia,vx,alpha,zx,igs,kgs, &amp;<a name='3054'>
     &amp;  rho0,temcg,temg,rhovt,cwnc,cinc,fadvisc,cwdia,cipmas,cnina,cimas, &amp;<a name='3055'>
     &amp;  cnostmp,             &amp;<a name='3056'>
     &amp;  infdo,il)<a name='3057'>
<a name='3058'>
<a name='3059'>
      DO kz = kzb,kze<a name='3060'>
      <font color=#447700>! apply limit vtmaxsed (08/20/2015)<a name='3061'></font>
        xvt(kz,ix,1,il) = Min( vtmaxsed,  xvt(kz,ix,1,il) )<a name='3062'>
        xvt(kz,ix,2,il) = Min( vtmaxsed,  xvt(kz,ix,2,il) )<a name='3063'>
        xvt(kz,ix,3,il) = Min( vtmaxsed,  xvt(kz,ix,3,il) )<a name='3064'>
      ENDDO<a name='3065'>
<a name='3066'>
<a name='3067'>
<a name='3068'>
<a name='3069'>
      ENDIF <font color=#447700>! (n .ge. 2)<a name='3070'></font>
<a name='3071'>
<a name='3072'>
        IF ( il &gt;= lr .and. ( infall .eq. 3 .or. infall .eq. 4 ) .and. ln(il) &gt; 0 ) THEN<a name='3073'>
           IF ( (il .eq. lr .and. irfall .eq. infall .and. lzr &lt; 1) .or. (il .ge. lh .and. lz(il) .lt. 1 ) ) THEN<a name='3074'>
            call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALCZGR1D'>calczgr1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCZGR1D_1">(nx,ny,nz,nor,na,an,ixe,kze, &amp; <a name='3075'>
     &amp;         z,db1,jgs,ipconc, dnu(il), il, ln(il), qxmin(il), xvmn(il), xvmx(il), lvol(il), xdn0(il), ix )<a name='3076'>
           ENDIF<a name='3077'>
        ENDIF<a name='3078'>
<a name='3079'>
      if (ndebug .gt. 0 ) write(0,*) 'dbg = 1b'<a name='3080'>
<a name='3081'>
<font color=#447700>! mixing ratio<a name='3082'></font>
<a name='3083'>
      call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FALLOUT1D'>fallout1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FALLOUT1D_1">(nx,ny,nz,nor,na,dtptmp,dtfrac,jgs,xvt(1,1,1,il), &amp; <a name='3084'>
     &amp;             an,db1,il,1,xfall,dtz1,ix)<a name='3085'>
<a name='3086'>
<a name='3087'>
      if (ndebug .gt. 0 ) write(0,*) 'dbg = 3c'<a name='3088'>
<a name='3089'>
<font color=#447700>! volume<a name='3090'></font>
<a name='3091'>
      IF ( ldovol .and. il &gt;= li ) THEN<a name='3092'>
        IF ( lvol(il) .gt. 1 ) THEN<a name='3093'>
         call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FALLOUT1D'>fallout1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FALLOUT1D_2">(nx,ny,nz,nor,na,dtptmp,dtfrac,jgs,xvt(1,1,1,il), &amp; <a name='3094'>
     &amp;              an,db1,lvol(il),0,xfall,dtz1,ix)<a name='3095'>
        ENDIF<a name='3096'>
      ENDIF<a name='3097'>
<a name='3098'>
<a name='3099'>
      if (ndebug .gt. 0 ) write(0,*) 'dbg = 3d'<a name='3100'>
<a name='3101'>
      <a name='3102'>
      IF ( ipconc .gt. 0 ) THEN <font color=#447700>!{<a name='3103'></font>
        IF ( ipconc .ge. ipc(il) ) THEN<a name='3104'>
<a name='3105'>
      IF ( ( infall .ge. 2 .or. (infall .eq. 0 .and. il .lt. lh) ) .and. lz(il) .lt. 1) THEN <font color=#447700>!{<a name='3106'></font>
<font color=#447700>!<a name='3107'></font>
<font color=#447700>! load number conc. into tmpn to do fallout by mass-weighted mean fall speed<a name='3108'></font>
<font color=#447700>!  to put a lower bound on number conc.<a name='3109'></font>
<font color=#447700>!<a name='3110'></font>
<a name='3111'>
        IF ( ( infall .eq. 3 .or. infall .eq. 4 ) .and. ( il .eq. lh .or. il .eq. lhl .or.  &amp; <a name='3112'>
     &amp;      ( il .eq. lr .and. irfall .eq. infall) ) ) THEN<a name='3113'>
<a name='3114'>
          DO kz = kzb,kze<a name='3115'>
<font color=#447700>!            DO ix = ixb,ixe<a name='3116'></font>
              tmpn2(ix,jy,kz) = z(ix,kz,il)<a name='3117'>
<font color=#447700>!            ENDDO<a name='3118'></font>
          ENDDO<a name='3119'>
          DO kz = kzb,kze<a name='3120'>
<font color=#447700>!            DO ix = ixb,ixe<a name='3121'></font>
              tmpn(ix,jy,kz) = an(ix,jy,kz,ln(il))<a name='3122'>
<font color=#447700>!            ENDDO<a name='3123'></font>
          ENDDO<a name='3124'>
        <a name='3125'>
        ELSE<a name='3126'>
          <a name='3127'>
          DO kz = kzb,kze<a name='3128'>
<font color=#447700>!            DO ix = ixb,ixe<a name='3129'></font>
              tmpn(ix,jy,kz) = an(ix,jy,kz,ln(il))<a name='3130'>
<font color=#447700>!            ENDDO<a name='3131'></font>
          ENDDO<a name='3132'>
<a name='3133'>
        ENDIF<a name='3134'>
<a name='3135'>
      ENDIF <font color=#447700>!}<a name='3136'></font>
<a name='3137'>
<a name='3138'>
      if (ndebug .gt. 0 ) write(0,*) 'dbg = 3f'<a name='3139'>
<a name='3140'>
       in = 2<a name='3141'>
       IF ( infall .eq. 1 ) in = 1<a name='3142'>
<a name='3143'>
         call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FALLOUT1D'>fallout1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FALLOUT1D_3">(nx,ny,nz,nor,na,dtptmp,dtfrac,jgs,xvt(1,1,in,il), &amp; <a name='3144'>
     &amp;        an,db1,ln(il),0,xfall,dtz1,ix)<a name='3145'>
<a name='3146'>
<a name='3147'>
         IF ( lz(il) .lt. 1 ) THEN <font color=#447700>! if not 3-moment, run one of the correction schemes<a name='3148'></font>
         IF ( (infall .ge. 2 .or. infall .eq. 3) .and. .not. (infall .eq. 0 .and. il .ge. lh) &amp; <a name='3149'>
     &amp;       .and. ( il .eq. lr .or. (il .ge. li .and. il .le. lhab) )) THEN<a name='3150'>
<font color=#447700>!     :        .or. il .eq. lhl )) THEN<a name='3151'></font>
           <a name='3152'>
           xfall0(:,jgs) = 0.0<a name='3153'>
<a name='3154'>
           IF ( ( infall .eq. 3 .or. infall .eq. 4 ) .and.  &amp; <a name='3155'>
     &amp;        ( il .ge. lh .or. (il .eq. lr .and. irfall .eq. infall) ) ) THEN<a name='3156'>
             call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FALLOUT1D'>fallout1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FALLOUT1D_4">(nx,ny,nz,nor,1,dtptmp,dtfrac,jgs,xvt(1,1,3,il), &amp; <a name='3157'>
     &amp;         tmpn2,db1,1,0,xfall0,dtz1,ix)<a name='3158'>
             call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FALLOUT1D'>fallout1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FALLOUT1D_5">(nx,ny,nz,nor,1,dtptmp,dtfrac,jgs,xvt(1,1,1,il), &amp; <a name='3159'>
     &amp;         tmpn,db1,1,0,xfall0,dtz1,ix)<a name='3160'>
           ELSE<a name='3161'>
             call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FALLOUT1D'>fallout1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FALLOUT1D_6">(nx,ny,nz,nor,1,dtptmp,dtfrac,jgs,xvt(1,1,1,il), &amp; <a name='3162'>
     &amp;         tmpn,db1,1,0,xfall0,dtz1,ix)<a name='3163'>
           ENDIF<a name='3164'>
<a name='3165'>
           IF ( ( infall .eq. 3 .or. infall .eq. 4 ) .and. ( (il .eq. lr .and. irfall .eq. infall) &amp; <a name='3166'>
     &amp;            .or. il .ge. lh ) ) THEN<a name='3167'>
<font color=#447700>! "Method I" - dbz correction<a name='3168'></font>
<a name='3169'>
             call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALCNFROMZ1D'>calcnfromz1d</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SEDIMENT1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCNFROMZ1D_1">(nx,ny,nz,nor,na,an,tmpn2,ixe,kze, &amp; <a name='3170'>
     &amp;       z,db1,jgs,ipconc, dnu(il), il, ln(il), qxmin(il), xvmn(il), xvmx(il),tmpn,  &amp; <a name='3171'>
     &amp;       lvol(il), rho_qh, infall, ix)<a name='3172'>
<a name='3173'>
           ELSEIF ( infall .eq. 5 .and. il .ge. lh .or. ( il == lr .and. irfall == 5 ) ) THEN<a name='3174'>
<a name='3175'>
             DO kz = kzb,kze<a name='3176'>
<font color=#447700>!              DO ix = ixb,ixe<a name='3177'></font>
               an(ix,jgs,kz,ln(il)) = Max( an(ix,jgs,kz,ln(il)), 0.5* ( an(ix,jgs,kz,ln(il)) + tmpn(ix,jy,kz) ))<a name='3178'>
              <a name='3179'>
<font color=#447700>!              ENDDO<a name='3180'></font>
             ENDDO           <a name='3181'>
<a name='3182'>
           ELSEIF ( .not. (il .eq. lr .and. irfall .eq. 0) ) THEN<a name='3183'>
<font color=#447700>! "Method II" M-wgt N-fallout correction<a name='3184'></font>
<a name='3185'>
             DO kz = kzb,kze<a name='3186'>
<font color=#447700>!              DO ix = ixb,ixe<a name='3187'></font>
<a name='3188'>
               an(ix,jgs,kz,ln(il)) = Max( an(ix,jgs,kz,ln(il)), tmpn(ix,jy,kz) )<a name='3189'>
              <a name='3190'>
<font color=#447700>!              ENDDO<a name='3191'></font>
             ENDDO<a name='3192'>
           ENDIF <a name='3193'>
           ENDIF <font color=#447700>! lz(il) .lt. 1<a name='3194'></font>
           <a name='3195'>
<a name='3196'>
         ENDIF<a name='3197'>
        ENDIF<a name='3198'>
<a name='3199'>
<a name='3200'>
      ENDIF <font color=#447700>!}<a name='3201'></font>
<a name='3202'>
<a name='3203'>
      ENDDO <font color=#447700>! n=1,ndfall<a name='3204'></font>
      ENDDO <font color=#447700>! il<a name='3205'></font>
      <a name='3206'>
      ENDDO <font color=#447700>! ix<a name='3207'></font>
<a name='3208'>
<a name='3209'>
<a name='3210'>
      <a name='3211'>
      RETURN<a name='3212'>
      END SUBROUTINE SEDIMENT1D<a name='3213'>
<a name='3214'>
<a name='3215'>
<font color=#447700>! #####################################################################<a name='3216'></font>
<a name='3217'>
<font color=#447700>!<a name='3218'></font>
<font color=#447700>! #####################################################################<a name='3219'></font>
<a name='3220'>
<a name='3221'>
<font color=#447700>!<a name='3222'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='3223'></font>
<font color=#447700>!<a name='3224'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='3225'></font>
<font color=#447700>!<a name='3226'></font>
<A NAME='FALLOUT1D'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#FALLOUT1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3227'>
      <font color=#993300>subroutine </font><font color=#cc0000>fallout1d</font>(nx,ny,nz,nor,na,dtp,dtfrac,jgs,vt,   &amp; <A href='../../call_to/FALLOUT1D.html' TARGET='index'>6</A><a name='3228'>
     &amp;  a,db1,ia,id,xfall,dtz1,ixcol)<a name='3229'>
<font color=#447700>!<a name='3230'></font>
<font color=#447700>! First-order, upwind fallout scheme<a name='3231'></font>
<font color=#447700>!<a name='3232'></font>
<font color=#447700>!  Written by ERM 6/10/2011<a name='3233'></font>
<font color=#447700>!<a name='3234'></font>
<font color=#447700>!<a name='3235'></font>
<font color=#447700>!<a name='3236'></font>
      implicit none<a name='3237'>
<a name='3238'>
      integer nx,ny,nz,nor,ngt,jgs,na,ia<a name='3239'>
      integer id <font color=#447700>! =1 use density, =0 no density<a name='3240'></font>
      integer ng1<a name='3241'>
      parameter(ng1 = 1)<a name='3242'>
      integer :: ixcol<a name='3243'>
<a name='3244'>
<font color=#447700>!      real dz3dinv(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor)<a name='3245'></font>
<font color=#447700>!      real a(nx,ny,nz,na)<a name='3246'></font>
      real a(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor,na) <font color=#447700>! quantity to be 'advected'<a name='3247'></font>
      real vt(nz+1,nx)  <font color=#447700>! terminal speed for a<a name='3248'></font>
      real dtp,dtfrac<a name='3249'>
      real cmax<a name='3250'>
      real xfall(nx,ny,na)  <font color=#447700>! array for stuff landing on the ground<a name='3251'></font>
      real db1(nx,nz+1),dtz1(nz+1,nx,0:1)<a name='3252'>
<a name='3253'>
<font color=#447700>! Local<a name='3254'></font>
           <a name='3255'>
      integer ix,jy,kz,n,k<a name='3256'>
      integer iv1,iv2<a name='3257'>
      real tmp<a name='3258'>
      integer imn,imx,kmn,kmx<a name='3259'>
      real qtmp1(nz+1)<a name='3260'>
<a name='3261'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='3262'></font>
<a name='3263'>
      integer :: ixb, jyb, kzb<a name='3264'>
      integer :: ixe, jye, kze<a name='3265'>
<a name='3266'>
      logical :: debug_mpi = .TRUE.<a name='3267'>
<a name='3268'>
<font color=#447700>! ###################################################################<a name='3269'></font>
<a name='3270'>
      jy = 1<a name='3271'>
<a name='3272'>
      iv1 = 0<a name='3273'>
      iv2 = 0<a name='3274'>
<a name='3275'>
      imn = nx<a name='3276'>
      imx = 1<a name='3277'>
      kmn = nz<a name='3278'>
      kmx = 1<a name='3279'>
<a name='3280'>
      cmax = 0.0<a name='3281'>
<a name='3282'>
      kzb = 1<a name='3283'>
      kze = nz<a name='3284'>
<a name='3285'>
      ixb = ixcol<a name='3286'>
      ixe = ixcol<a name='3287'>
      ix  = ixcol<a name='3288'>
<a name='3289'>
      qtmp1(nz+1) = 0.0<a name='3290'>
      <a name='3291'>
      DO kz = kzb,kze<a name='3292'>
<font color=#447700>!        DO ix = ixb,ixe<a name='3293'></font>
<font color=#447700>!         cmax = Max(cmax, vt(ix,kz)*dz3dinv(ix,jy,kz)) <a name='3294'></font>
         <a name='3295'>
         IF ( id == 1 ) THEN<a name='3296'>
         qtmp1(kz) = a(ix,jgs,kz,ia)*vt(kz,ix)*db1(ix,kz)<a name='3297'>
         ELSE<a name='3298'>
         qtmp1(kz) = a(ix,jgs,kz,ia)*vt(kz,ix)<a name='3299'>
         ENDIF<a name='3300'>
         <a name='3301'>
         IF ( a(ix,jgs,kz,ia) .ne. 0.0 ) THEN<a name='3302'>
<font color=#447700>!           imn = Min(ix,imn)<a name='3303'></font>
<font color=#447700>!           imx = Max(ix,imx)<a name='3304'></font>
           kmn = Min(kz,kmn)<a name='3305'>
           kmx = Max(kz,kmx)<a name='3306'>
         ENDIF<a name='3307'>
<font color=#447700>!        ENDDO<a name='3308'></font>
      ENDDO<a name='3309'>
      <a name='3310'>
      kmn = Max(1,kmn-1)<a name='3311'>
      <a name='3312'>
<font color=#447700>! first check if fallout is worth doing<a name='3313'></font>
<font color=#447700>!      IF ( cmax .eq. 0.0 .or. imn .gt. imx ) THEN<a name='3314'></font>
<font color=#447700>!        RETURN<a name='3315'></font>
<font color=#447700>!      ENDIF<a name='3316'></font>
      <a name='3317'>
      IF ( kmn == 1 ) THEN<a name='3318'>
      <a name='3319'>
      kz = 1<a name='3320'>
<font color=#447700>!      do ix = imn,imx ! 1,nx-1<a name='3321'></font>
         xfall(ix,jy,ia) = xfall(ix,jy,ia) + a(ix,jgs,kz,ia)*vt(kz,ix)*dtfrac<a name='3322'>
<font color=#447700>!      enddo<a name='3323'></font>
      <a name='3324'>
      ENDIF<a name='3325'>
<a name='3326'>
      do kz = 1,nz<a name='3327'>
<font color=#447700>!      do ix = 1,nx<a name='3328'></font>
        a(ix,jgs,kz,ia) =  a(ix,jgs,kz,ia) + dtp*dtz1(kz,ix,id)*(qtmp1(kz+1) - qtmp1(kz) )<a name='3329'>
<font color=#447700>!      enddo<a name='3330'></font>
      enddo<a name='3331'>
<a name='3332'>
      <a name='3333'>
      RETURN<a name='3334'>
      END SUBROUTINE FALLOUT1D<a name='3335'>
<a name='3336'>
<font color=#447700>! ##############################################################################<a name='3337'></font>
<font color=#447700>! ##############################################################################<a name='3338'></font>
<a name='3339'>
<A NAME='CALCZGR1D'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALCZGR1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3340'>
      <font color=#993300>subroutine </font><font color=#cc0000>calczgr1d</font>(nx,ny,nz,nor,na,a,ixe,kze,              &amp; <A href='../../call_to/CALCZGR1D.html' TARGET='index'>1</A><a name='3341'>
     &amp;    z,db,jgs,ipconc, alpha, l,ln, qmin, xvmn,xvmx, lvol, rho_qx, ixcol)<a name='3342'>
<a name='3343'>
<a name='3344'>
      implicit none<a name='3345'>
<a name='3346'>
      integer nx,ny,nz,nor,na,ngt,jgs<a name='3347'>
      integer :: ixcol<a name='3348'>
      integer, parameter :: norz = 3<a name='3349'>
      real a(-nor+1:nx+nor,-nor+1:ny+nor,-nor+1:nz+nor,na)<a name='3350'>
      real z(-nor+1:nx+nor,-nor+1:nz+nor,lr:lhab)   <font color=#447700>! reflectivity<a name='3351'></font>
      real db(nx,nz+1)  <font color=#447700>! air density<a name='3352'></font>
<font color=#447700>!      real gt(-nor+1:nx+nor,-nor+1:ny+nor,-nor+1:nz+nor,ngt)<a name='3353'></font>
<a name='3354'>
      integer ixe,kze<a name='3355'>
      real    alpha<a name='3356'>
      real    qmin<a name='3357'>
      real    xvmn,xvmx<a name='3358'>
      integer ipconc<a name='3359'>
      integer l   <font color=#447700>! index for q<a name='3360'></font>
      integer ln  <font color=#447700>! index for N<a name='3361'></font>
      integer lvol <font color=#447700>! index for volume<a name='3362'></font>
      real    rho_qx<a name='3363'>
<a name='3364'>
<a name='3365'>
      integer ix,jy,kz<a name='3366'>
      real vr,qr,nrx,rd,xv,g1,zx,chw,xdn<a name='3367'>
      <a name='3368'>
      <a name='3369'>
      jy = jgs<a name='3370'>
      ix = ixcol<a name='3371'>
      <a name='3372'>
      IF ( l .eq. lh .or. l .eq. lhl .or. ( l .eq. lr .and. imurain == 1 )  ) THEN<a name='3373'>
      <a name='3374'>
      <a name='3375'>
      DO kz = 1,kze<a name='3376'>
          <a name='3377'>
          <a name='3378'>
          <a name='3379'>
          IF (  a(ix,jy,kz,l) .gt. qmin .and. a(ix,jy,kz,ln) .gt. 1.e-15 ) THEN<a name='3380'>
            <a name='3381'>
            IF ( lvol .gt. 1 ) THEN<a name='3382'>
                IF ( a(ix,jy,kz,lvol) .gt. 0.0 ) THEN<a name='3383'>
                  xdn = db(ix,kz)*a(ix,jy,kz,l)/a(ix,jy,kz,lvol)<a name='3384'>
                  xdn = Min( 900., Max( hdnmn, xdn ) )<a name='3385'>
                ELSE<a name='3386'>
                  xdn = rho_qx<a name='3387'>
                ENDIF<a name='3388'>
            ELSE<a name='3389'>
                xdn = rho_qx<a name='3390'>
            ENDIF<a name='3391'>
<a name='3392'>
            IF ( l == lr ) xdn = 1000.<a name='3393'>
<a name='3394'>
            qr = a(ix,jy,kz,l)<a name='3395'>
            xv = db(ix,kz)*a(ix,jy,kz,l)/(xdn*a(ix,jy,kz,ln))<a name='3396'>
            chw = a(ix,jy,kz,ln)<a name='3397'>
<a name='3398'>
             IF ( xv .lt. xvmn .or. xv .gt. xvmx ) THEN<a name='3399'>
              xv = Min( xvmx, Max( xvmn,xv ) )<a name='3400'>
              chw = db(ix,kz)*a(ix,jy,kz,l)/(xv*xdn)<a name='3401'>
             ENDIF<a name='3402'>
<a name='3403'>
             g1 = (6.0 + alpha)*(5.0 + alpha)*(4.0 + alpha)/  &amp;<a name='3404'>
     &amp;            ((3.0 + alpha)*(2.0 + alpha)*(1.0 + alpha))<a name='3405'>
             zx = g1*db(ix,kz)**2*(a(ix,jy,kz,l))*a(ix,jy,kz,l)/chw<a name='3406'>
<font color=#447700>!             z(ix,kz,l)  = 1.e18*zx*(6./(pi*1000.))**2<a name='3407'></font>
             z(ix,kz,l)  = zx*(6./(pi*1000.))**2<a name='3408'>
<a name='3409'>
<a name='3410'>
<font color=#447700>!          IF ( ny.eq.2 .and. kz .ge. 25 .and. kz .le. 29 .and. z(ix,kz,l) .gt. 0. ) THEN<a name='3411'></font>
<font color=#447700>!             write(*,*) 'calczgr: z,dbz,xdn = ',ix,kz,z(ix,kz,l),10*log10(z(ix,kz,l)),xdn<a name='3412'></font>
<font color=#447700>!          ENDIF<a name='3413'></font>
          <a name='3414'>
          ELSE<a name='3415'>
           <a name='3416'>
            z(ix,kz,l) = 0.0<a name='3417'>
           <a name='3418'>
          ENDIF<a name='3419'>
          <a name='3420'>
      ENDDO<a name='3421'>
      <a name='3422'>
      ELSEIF ( l .eq. lr .and. imurain == 3) THEN<a name='3423'>
<a name='3424'>
      xdn = 1000.<a name='3425'>
      <a name='3426'>
      DO kz = 1,kze<a name='3427'>
          IF (  a(ix,jy,kz,l) .gt. qmin .and. a(ix,jy,kz,ln) .gt. 1.e-15 ) THEN<a name='3428'>
<a name='3429'>
            vr = db(ix,kz)*a(ix,jy,kz,l)/(xdn*a(ix,jy,kz,ln))<a name='3430'>
<font color=#447700>!            z(ix,kz,l) = 3.6e18*(rnu+2.0)*a(ix,jy,kz,ln)*vr**2/(rnu+1.0)<a name='3431'></font>
            z(ix,kz,l) = 3.6*(rnu+2.0)*a(ix,jy,kz,ln)*vr**2/(rnu+1.0)<a name='3432'>
<font color=#447700>!            qr = a(ix,jy,kz,lr)<a name='3433'></font>
<font color=#447700>!            nrx = a(ix,jy,kz,lnr)<a name='3434'></font>
          <a name='3435'>
          ELSE<a name='3436'>
           <a name='3437'>
            z(ix,kz,l) = 0.0<a name='3438'>
           <a name='3439'>
          ENDIF<a name='3440'>
      <a name='3441'>
          <a name='3442'>
      ENDDO<a name='3443'>
      <a name='3444'>
      ENDIF<a name='3445'>
      <a name='3446'>
      RETURN<a name='3447'>
      <a name='3448'>
      END subroutine calczgr1d<a name='3449'>
<a name='3450'>
<font color=#447700>! ##############################################################################<a name='3451'></font>
<font color=#447700>! ##############################################################################<a name='3452'></font>
<font color=#447700>!<a name='3453'></font>
<font color=#447700>!  Subroutine to correct number concentration to prevent reflectivity growth by <a name='3454'></font>
<font color=#447700>!  sedimentation in 2-moment ZXX scheme.<a name='3455'></font>
<font color=#447700>!  Calculation is in a slab (constant jgs)<a name='3456'></font>
<font color=#447700>!<a name='3457'></font>
<a name='3458'>
<A NAME='CALCNFROMZ1D'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALCNFROMZ1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3459'>
      <font color=#993300>subroutine </font><font color=#cc0000>calcnfromz1d</font>(nx,ny,nz,nor,na,a,t0,ixe,kze,    &amp; <A href='../../call_to/CALCNFROMZ1D.html' TARGET='index'>1</A><a name='3460'>
     &amp;    z0,db,jgs,ipconc, alpha, l,ln, qmin, xvmn,xvmx,t1, &amp;<a name='3461'>
     &amp;    lvol, rho_qx, infall, ixcol)<a name='3462'>
<a name='3463'>
      <a name='3464'>
      implicit none<a name='3465'>
<a name='3466'>
      integer nx,ny,nz,nor,na,ngt,jgs,ixcol<a name='3467'>
<a name='3468'>
      real a(-nor+1:nx+nor,-nor+1:ny+nor,-nor+1:nz+nor,na)  <font color=#447700>! sedimented N and q<a name='3469'></font>
      real t0(-nor+1:nx+nor,-nor+1:ny+nor,-nor+1:nz+nor)    <font color=#447700>! sedimented reflectivity<a name='3470'></font>
      real t1(-nor+1:nx+nor,-nor+1:ny+nor,-nor+1:nz+nor)    <font color=#447700>! sedimented N (by Vm)<a name='3471'></font>
<font color=#447700>!      real gt(-nor+1:nx+nor,-nor+1:ny+nor,-nor+1:nz+nor,ngt)<a name='3472'></font>
      real z0(-nor+1:nx+nor,-nor+1:nz+nor,lr:lhab)   <font color=#447700>! initial reflectivity<a name='3473'></font>
<a name='3474'>
      real db(nx,nz+1)  <font color=#447700>! air density<a name='3475'></font>
      <a name='3476'>
      integer ixe,kze<a name='3477'>
      real    alpha<a name='3478'>
      real    qmin<a name='3479'>
      real    xvmn,xvmx<a name='3480'>
      integer ipconc<a name='3481'>
      integer l   <font color=#447700>! index for q<a name='3482'></font>
      integer ln  <font color=#447700>! index for N<a name='3483'></font>
      integer lvol <font color=#447700>! index for volume<a name='3484'></font>
      real    rho_qx<a name='3485'>
      integer infall<a name='3486'>
      <a name='3487'>
      <a name='3488'>
      integer ix,jy,kz<a name='3489'>
      double precision vr,qr,nrx,rd,g1,zx,chw,z,znew,zt,zxt<a name='3490'>
      real xv,xdn<a name='3491'>
      integer :: ndbz, nmwgt, nnwgt, nwlessthanz<a name='3492'>
      <a name='3493'>
      ndbz = 0<a name='3494'>
      nmwgt = 0<a name='3495'>
      nnwgt = 0<a name='3496'>
      nwlessthanz = 0<a name='3497'>
      <a name='3498'>
<a name='3499'>
      <a name='3500'>
      jy = jgs<a name='3501'>
      ix = ixcol<a name='3502'>
      <a name='3503'>
      IF ( l .eq. lh .or. l .eq. lhl .or. ( l == lr .and. imurain == 1 ) ) THEN<a name='3504'>
      <a name='3505'>
             g1 = (6.0 + alpha)*(5.0 + alpha)*(4.0 + alpha)/  &amp;<a name='3506'>
     &amp;            ((3.0 + alpha)*(2.0 + alpha)*(1.0 + alpha))<a name='3507'>
      <a name='3508'>
      DO kz = 1,kze<a name='3509'>
<a name='3510'>
         <a name='3511'>
          IF (   t0(ix,jy,kz) .gt. 0. ) THEN <font color=#447700>! {<a name='3512'></font>
            <a name='3513'>
            IF ( lvol .gt. 1 ) THEN<a name='3514'>
               IF ( a(ix,jy,kz,lvol) .gt. 0.0 ) THEN<a name='3515'>
                 xdn = db(ix,kz)*a(ix,jy,kz,l)/a(ix,jy,kz,lvol)<a name='3516'>
                 xdn = Min( 900., Max( hdnmn, xdn ) )<a name='3517'>
               ELSE <a name='3518'>
                 xdn = rho_qx<a name='3519'>
               ENDIF<a name='3520'>
            ELSE<a name='3521'>
               xdn = rho_qx<a name='3522'>
            ENDIF<a name='3523'>
            <a name='3524'>
            IF ( l == lr ) xdn = 1000.<a name='3525'>
          <a name='3526'>
            qr = a(ix,jy,kz,l)<a name='3527'>
            xv = db(ix,kz)*a(ix,jy,kz,l)/(xdn*a(ix,jy,kz,ln))<a name='3528'>
            chw = a(ix,jy,kz,ln)<a name='3529'>
<a name='3530'>
             IF ( xv .lt. xvmn .or. xv .gt. xvmx ) THEN<a name='3531'>
              xv = Min( xvmx, Max( xvmn,xv ) )<a name='3532'>
              chw = db(ix,kz)*a(ix,jy,kz,l)/(xv*xdn)<a name='3533'>
             ENDIF<a name='3534'>
<a name='3535'>
             zx = g1*db(ix,kz)**2*( a(ix,jy,kz,l))*a(ix,jy,kz,l)/chw<a name='3536'>
             z  = zx*(6./(pi*1000.))**2<a name='3537'>
<a name='3538'>
            <a name='3539'>
           IF ( (z .gt. t0(ix,jy,kz) .and. z .gt. 0.0 .and.  &amp;<a name='3540'>
     &amp;           t0(ix,jy,kz) .gt. z0(ix,kz,l) )) THEN <font color=#447700>!{<a name='3541'></font>
           <a name='3542'>
            zx = t0(ix,jy,kz)/((6./(pi*1000.))**2)<a name='3543'>
            <a name='3544'>
            nrx =  g1*db(ix,kz)**2*( a(ix,jy,kz,l))*a(ix,jy,kz,l)/zx<a name='3545'>
            IF ( infall .eq. 3 ) THEN<a name='3546'>
              IF ( nrx .gt. a(ix,jy,kz,ln) ) THEN<a name='3547'>
                ndbz = ndbz + 1<a name='3548'>
                IF ( t1(ix,jy,kz) .lt. ndbz ) nwlessthanz = nwlessthanz + 1<a name='3549'>
              ELSE<a name='3550'>
                nnwgt = nnwgt + 1<a name='3551'>
              ENDIF<a name='3552'>
              a(ix,jy,kz,ln) = Max( real(nrx), a(ix,jy,kz,ln) )<a name='3553'>
            ELSE<a name='3554'>
             IF (  nrx .gt. a(ix,jy,kz,ln) .and. t1(ix,jy,kz) .gt. a(ix,jy,kz,ln) ) THEN<a name='3555'>
              IF ( nrx .lt. t1(ix,jy,kz)  ) THEN<a name='3556'>
                ndbz = ndbz + 1<a name='3557'>
              ELSE<a name='3558'>
                nmwgt = nmwgt + 1<a name='3559'>
                IF ( t1(ix,jy,kz) .lt. ndbz ) nwlessthanz = nwlessthanz + 1<a name='3560'>
              ENDIF<a name='3561'>
             ELSE<a name='3562'>
              nnwgt = nnwgt + 1<a name='3563'>
             ENDIF<a name='3564'>
              <a name='3565'>
              a(ix,jy,kz,ln) = Max(Min( real(nrx), t1(ix,jy,kz) ), a(ix,jy,kz,ln) )<a name='3566'>
            ENDIF<a name='3567'>
<a name='3568'>
           ELSE <font color=#447700>! } {<a name='3569'></font>
             IF ( t1(ix,jy,kz) .gt. 0 .and. a(ix,jy,kz,ln) .gt. 0 ) THEN<a name='3570'>
              IF ( t1(ix,jy,kz) .gt. a(ix,jy,kz,ln) ) THEN<a name='3571'>
                nmwgt = nmwgt + 1<a name='3572'>
              ELSE<a name='3573'>
                nnwgt = nnwgt + 1<a name='3574'>
              ENDIF<a name='3575'>
            ENDIF<a name='3576'>
            a(ix,jy,kz,ln) = Max(t1(ix,jy,kz), a(ix,jy,kz,ln) )<a name='3577'>
            nrx = a(ix,jy,kz,ln)<a name='3578'>
<a name='3579'>
<a name='3580'>
<a name='3581'>
           ENDIF <font color=#447700>! }<a name='3582'></font>
<a name='3583'>
           <font color=#447700>! }<a name='3584'></font>
          ELSE <font color=#447700>! {<a name='3585'></font>
            IF ( t1(ix,jy,kz) .gt. 0 .and. a(ix,jy,kz,ln) .gt. 0 ) THEN<a name='3586'>
              IF ( t1(ix,jy,kz) .gt. a(ix,jy,kz,ln) ) THEN<a name='3587'>
                nmwgt = nmwgt + 1<a name='3588'>
              ELSE<a name='3589'>
                nnwgt = nnwgt + 1<a name='3590'>
              ENDIF<a name='3591'>
            ENDIF<a name='3592'>
          ENDIF<font color=#447700>! }<a name='3593'></font>
          <a name='3594'>
      ENDDO<a name='3595'>
      <a name='3596'>
      <a name='3597'>
      ELSEIF ( l .eq. lr .and. imurain == 3) THEN<a name='3598'>
<a name='3599'>
      xdn = 1000.<a name='3600'>
      <a name='3601'>
      DO kz = 1,kze<a name='3602'>
          IF (  t0(ix,jy,kz) .gt. 0. ) THEN<a name='3603'>
<a name='3604'>
            vr = db(ix,kz)*a(ix,jy,kz,l)/(xdn*a(ix,jy,kz,ln))<a name='3605'>
            z = 3.6*(rnu+2.0)*a(ix,jy,kz,ln)*vr**2/(rnu+1.0)<a name='3606'>
          <a name='3607'>
             IF ( z .gt. t0(ix,jy,kz) .and. z .gt. 0.0 .and.  &amp;<a name='3608'>
     &amp;          t0(ix,jy,kz) .gt. 0.0                         &amp;<a name='3609'>
     &amp;          .and. t0(ix,jy,kz) .gt. z0(ix,kz,l) ) THEN<a name='3610'>
<a name='3611'>
            vr = db(ix,kz)*a(ix,jy,kz,l)/(xdn)<a name='3612'>
             chw =  a(ix,jy,kz,ln)<a name='3613'>
            nrx =   3.6*(rnu+2.0)*vr**2/((rnu+1.0)*t0(ix,jy,kz))<a name='3614'>
             IF ( infall .eq. 3 ) THEN<a name='3615'>
              a(ix,jy,kz,ln) = Max( real(nrx), a(ix,jy,kz,ln) )<a name='3616'>
            ELSEIF ( infall .eq. 4 ) THEN<a name='3617'>
              a(ix,jy,kz,ln) = Max( Min( real(nrx), t1(ix,jy,kz)), a(ix,jy,kz,ln) )<a name='3618'>
            ENDIF<a name='3619'>
<a name='3620'>
           ELSE<a name='3621'>
<a name='3622'>
            a(ix,jy,kz,ln) = Max(t1(ix,jy,kz), a(ix,jy,kz,ln) )<a name='3623'>
<a name='3624'>
           ENDIF<a name='3625'>
<a name='3626'>
          ELSE<a name='3627'>
<a name='3628'>
            a(ix,jy,kz,ln) = Max(t1(ix,jy,kz), a(ix,jy,kz,ln) )<a name='3629'>
<a name='3630'>
          ENDIF<a name='3631'>
<a name='3632'>
<a name='3633'>
      ENDDO<a name='3634'>
<a name='3635'>
      ENDIF<a name='3636'>
<a name='3637'>
      RETURN<a name='3638'>
<a name='3639'>
      END subroutine calcnfromz1d<a name='3640'>
<a name='3641'>
<a name='3642'>
<font color=#447700>! ##############################################################################<a name='3643'></font>
<font color=#447700>! ##############################################################################<a name='3644'></font>
<font color=#447700>!<a name='3645'></font>
<font color=#447700>!  Subroutine to calculate number concentrations from initial state that has only mixing ratio.<a name='3646'></font>
<font color=#447700>!  N will be in #/kg, NOT #/m^3, since sedimentation is done next.<a name='3647'></font>
<font color=#447700>!<a name='3648'></font>
<a name='3649'>
<font color=#447700>!<a name='3650'></font>
<font color=#447700>! 10.27.2015: Added hail calculation<a name='3651'></font>
<font color=#447700>!<a name='3652'></font>
<A NAME='CALCNFROMQ'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALCNFROMQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3653'>
      <font color=#993300>subroutine </font><font color=#cc0000>calcnfromq</font>(nx,ny,nz,an,na,nor,norz,dn) <A href='../../call_to/CALCNFROMQ.html' TARGET='index'>1</A><a name='3654'>
<a name='3655'>
      <a name='3656'>
      implicit none<a name='3657'>
<a name='3658'>
      integer nx,ny,nz,nor,norz,na,ngt,jgs,ixcol<a name='3659'>
<a name='3660'>
      real an(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz,na)  <font color=#447700>! scalars (q, N, Z)<a name='3661'></font>
<a name='3662'>
      real dn(nx,nz+1)  <font color=#447700>! air density<a name='3663'></font>
      <a name='3664'>
      integer ixe,kze<a name='3665'>
      real    alpha<a name='3666'>
      real    qmin<a name='3667'>
      real    xvmn,xvmx<a name='3668'>
      integer ipconc<a name='3669'>
      integer lvol <font color=#447700>! index for volume<a name='3670'></font>
      integer infall<a name='3671'>
      <a name='3672'>
      <a name='3673'>
      integer ix,jy,kz<a name='3674'>
      double precision vr,q,nrx,rd,g1h,g1hl,g1r,g1s,zx,chw,z,znew,zt,zxt,n1,laminv1<a name='3675'>
      double precision :: zr, zs, zh, dninv<a name='3676'>
      real, parameter :: xn0s = 3.0e6, xn0r = 8.0e6, xn0h = 4.0e4, xn0hl = 4.0e4<a name='3677'>
      real, parameter :: xdnr = 1000., xdns = 100. ,xdnh = 700.0, xdnhl = 900.0<a name='3678'>
      real, parameter :: zhlfac = 1./(pi*xdnhl*xn0hl)<a name='3679'>
      real, parameter :: zhfac = 1./(pi*xdnh*xn0h)<a name='3680'>
      real, parameter :: zrfac = 1./(pi*xdnr*xn0r)<a name='3681'>
      real, parameter :: zsfac = 1./(pi*xdns*xn0s)<a name='3682'>
      real, parameter :: g0 = (6.0)*(5.0)*(4.0)/((3.0)*(2.0)*(1.0))<a name='3683'>
      real, parameter :: xims=900.*0.523599*(2.*50.e-6)**3    <font color=#447700>! mks   (100 micron diam solid sphere approx)<a name='3684'></font>
<a name='3685'>
      real xv,xdn<a name='3686'>
      integer :: ndbz, nmwgt, nnwgt, nwlessthanz<a name='3687'>
<a name='3688'>
<font color=#447700>! ------------------------------------------------------------------<a name='3689'></font>
      <a name='3690'>
      <a name='3691'>
      jy = 1<a name='3692'>
      <a name='3693'>
      <a name='3694'>
         g1h = (6.0 + alphah)*(5.0 + alphah)*(4.0 + alphah)/  &amp;<a name='3695'>
     &amp;        ((3.0 + alphah)*(2.0 + alphah)*(1.0 + alphah))<a name='3696'>
<a name='3697'>
         g1hl = (6.0 + alphahl)*(5.0 + alphahl)*(4.0 + alphahl)/  &amp;<a name='3698'>
     &amp;        ((3.0 + alphahl)*(2.0 + alphahl)*(1.0 + alphahl))<a name='3699'>
     <a name='3700'>
         IF ( imurain == 3 ) THEN<a name='3701'>
         g1r = (rnu+2.0)/(rnu+1.0)<a name='3702'>
         ELSE <font color=#447700>! imurain == 1<a name='3703'></font>
         g1r = (6.0 + alphar)*(5.0 + alphar)*(4.0 + alphar)/  &amp;<a name='3704'>
     &amp;        ((3.0 + alphar)*(2.0 + alphar)*(1.0 + alphar))<a name='3705'>
         ENDIF<a name='3706'>
<a name='3707'>
         g1s = (snu+2.0)/(snu+1.0)<a name='3708'>
      <a name='3709'>
      DO kz = 1,nz<a name='3710'>
       DO ix = 1,nx <font color=#447700>! ixcol<a name='3711'></font>
<a name='3712'>
         dninv = 1./dn(ix,kz)<a name='3713'>
         <a name='3714'>
   <font color=#447700>!  Cloud droplets<a name='3715'></font>
         <a name='3716'>
         IF ( lnc &gt; 1 ) THEN<a name='3717'>
           IF ( an(ix,jy,kz,lnc) &lt;= 0.1*cxmin .and. an(ix,jy,kz,lc) &gt; qxmin(lc) ) THEN<a name='3718'>
             an(ix,jy,kz,lnc) = qccn<a name='3719'>
           ENDIF<a name='3720'>
         ENDIF<a name='3721'>
<a name='3722'>
   <font color=#447700>!  Cloud ice<a name='3723'></font>
         <a name='3724'>
         IF ( lni &gt; 1 ) THEN<a name='3725'>
           IF ( an(ix,jy,kz,lni) &lt;= 0.1*cxmin .and. an(ix,jy,kz,li) &gt; qxmin(li) ) THEN<a name='3726'>
             an(ix,jy,kz,lni) = an(ix,jy,kz,li)/xims<a name='3727'>
           ENDIF<a name='3728'>
         ENDIF<a name='3729'>
<a name='3730'>
   <font color=#447700>!  rain<a name='3731'></font>
         <a name='3732'>
         IF ( lnr &gt; 1 ) THEN<a name='3733'>
           IF ( an(ix,jy,kz,lnr) &lt;= 0.1*cxmin .and. an(ix,jy,kz,lr) &gt; qxmin(lr) ) THEN<a name='3734'>
<a name='3735'>
             q = an(ix,jy,kz,lr)<a name='3736'>
             <a name='3737'>
             laminv1 = (dn(ix,kz) * q * zrfac)**(0.25)  <font color=#447700>! inverse of slope<a name='3738'></font>
             <a name='3739'>
             n1 = laminv1*xn0r  <font color=#447700>! number concentration for inv. exponential single moment input<a name='3740'></font>
             <a name='3741'>
             nrx =  n1*g1r/g0   <font color=#447700>! number concentration for different shape parameter<a name='3742'></font>
<a name='3743'>
             an(ix,jy,kz,lnr) = nrx <font color=#447700>! *dninv ! convert to number mixing ratio<a name='3744'></font>
             <a name='3745'>
           ENDIF<a name='3746'>
         ENDIF<a name='3747'>
<a name='3748'>
  <font color=#447700>! snow<a name='3749'></font>
         IF ( lns &gt; 1 ) THEN<a name='3750'>
           IF ( an(ix,jy,kz,lns) &lt;= 0.1*cxmin .and. an(ix,jy,kz,ls) &gt; qxmin(ls) ) THEN<a name='3751'>
<a name='3752'>
             q = an(ix,jy,kz,ls)<a name='3753'>
             <a name='3754'>
             laminv1 = (dn(ix,kz) * q * zsfac)**(0.25)  <font color=#447700>! inverse of slope<a name='3755'></font>
             <a name='3756'>
             n1 = laminv1*xn0s  <font color=#447700>! number concentration for inv. exponential single moment input<a name='3757'></font>
             <a name='3758'>
             nrx =  n1*g1s/g0   <font color=#447700>! number concentration for different shape parameter<a name='3759'></font>
<a name='3760'>
             an(ix,jy,kz,lns) = nrx <font color=#447700>! *dninv ! convert to number mixing ratio<a name='3761'></font>
             <a name='3762'>
           ENDIF<a name='3763'>
         ENDIF<a name='3764'>
         <a name='3765'>
    <font color=#447700>! graupel<a name='3766'></font>
<a name='3767'>
         IF ( lnh &gt; 1 ) THEN<a name='3768'>
           IF ( an(ix,jy,kz,lnh) &lt;= 0.1*cxmin .and. an(ix,jy,kz,lh) &gt; qxmin(lh) ) THEN<a name='3769'>
             IF ( lvh &gt; 1 ) THEN<a name='3770'>
               IF ( an(ix,jy,kz,lvh) &lt;= 0.0 ) THEN<a name='3771'>
                 an(ix,jy,kz,lvh) = an(ix,jy,kz,lh)/xdnh<a name='3772'>
               ENDIF<a name='3773'>
             ENDIF<a name='3774'>
<a name='3775'>
             q = an(ix,jy,kz,lh)<a name='3776'>
             <a name='3777'>
             laminv1 = (dn(ix,kz) * q * zhfac)**(0.25)  <font color=#447700>! inverse of slope<a name='3778'></font>
             <a name='3779'>
             n1 = laminv1*xn0h  <font color=#447700>! number concentration for inv. exponential single moment input<a name='3780'></font>
             <a name='3781'>
             nrx =  n1*g1h/g0   <font color=#447700>! number concentration for different shape parameter<a name='3782'></font>
<a name='3783'>
             an(ix,jy,kz,lnh) = nrx <font color=#447700>! *dninv ! convert to number mixing ratio<a name='3784'></font>
<a name='3785'>
           ENDIF<a name='3786'>
         ENDIF<a name='3787'>
<a name='3788'>
    <font color=#447700>! hail<a name='3789'></font>
<a name='3790'>
         IF ( lnhl &gt; 1 .and. lhl &gt; 1 ) THEN<a name='3791'>
           IF ( an(ix,jy,kz,lnhl) &lt;= 0.1*cxmin .and. an(ix,jy,kz,lhl) &gt; qxmin(lhl) ) THEN<a name='3792'>
             IF ( lvhl &gt; 1 ) THEN<a name='3793'>
               IF ( an(ix,jy,kz,lvhl) &lt;= 0.0 ) THEN<a name='3794'>
                 an(ix,jy,kz,lvhl) = an(ix,jy,kz,lhl)/xdnhl<a name='3795'>
               ENDIF<a name='3796'>
             ENDIF<a name='3797'>
<a name='3798'>
             q = an(ix,jy,kz,lhl)<a name='3799'>
             <a name='3800'>
             laminv1 = (dn(ix,kz) * q * zhlfac)**(0.25)  <font color=#447700>! inverse of slope<a name='3801'></font>
             <a name='3802'>
             n1 = laminv1*xn0hl  <font color=#447700>! number concentration for inv. exponential single moment input<a name='3803'></font>
             <a name='3804'>
             nrx =  n1*g1hl/g0   <font color=#447700>! number concentration for different shape parameter<a name='3805'></font>
<a name='3806'>
             an(ix,jy,kz,lnhl) = nrx <font color=#447700>! *dninv ! convert to number mixing ratio<a name='3807'></font>
<a name='3808'>
           ENDIF<a name='3809'>
         ENDIF<a name='3810'>
 <a name='3811'>
      ENDDO <font color=#447700>! ix<a name='3812'></font>
      ENDDO <font color=#447700>! kz<a name='3813'></font>
      <a name='3814'>
      RETURN<a name='3815'>
      <a name='3816'>
      END subroutine calcnfromq<a name='3817'>
<a name='3818'>
<font color=#447700>! ##############################################################################<a name='3819'></font>
<font color=#447700>! ##############################################################################<a name='3820'></font>
<font color=#447700>!<a name='3821'></font>
<font color=#447700>!  Subroutine to calculate number concentrations from convection parameterization rates that have only mixing ratio.<a name='3822'></font>
<font color=#447700>!  N will be in #/kg, NOT #/m^3, since sedimentation is done next.<a name='3823'></font>
<font color=#447700>!<a name='3824'></font>
<a name='3825'>
<font color=#447700>!<a name='3826'></font>
<font color=#447700>! 10.27.2015: Added hail calculation<a name='3827'></font>
<font color=#447700>!<a name='3828'></font>
<A NAME='CALCNFROMCUTEN'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALCNFROMCUTEN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3829'>
      <font color=#993300>subroutine </font><font color=#cc0000>calcnfromcuten</font>(nx,ny,nz,an,anold,na,nor,norz,dn) <A href='../../call_to/CALCNFROMCUTEN.html' TARGET='index'>1</A><a name='3830'>
<a name='3831'>
      <a name='3832'>
      implicit none<a name='3833'>
<a name='3834'>
      integer nx,ny,nz,nor,norz,na,ngt,jgs,ixcol<a name='3835'>
<a name='3836'>
      real an(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz,na)  <font color=#447700>! scalars (q, N, Z) from CUTEN arrays<a name='3837'></font>
      real anold(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz,na)  <font color=#447700>! scalars (q, N, Z)<a name='3838'></font>
<a name='3839'>
      real dn(nx,nz+1)  <font color=#447700>! air density<a name='3840'></font>
      <a name='3841'>
      integer ixe,kze<a name='3842'>
      real    alpha<a name='3843'>
      real    qmin<a name='3844'>
      real    xvmn,xvmx<a name='3845'>
      integer ipconc<a name='3846'>
      integer lvol <font color=#447700>! index for volume<a name='3847'></font>
      integer infall<a name='3848'>
      <a name='3849'>
      <a name='3850'>
      integer ix,jy,kz<a name='3851'>
      double precision vr,q,nrx,rd,g1h,g1hl,g1r,g1s,zx,chw,z,znew,zt,zxt,n1,laminv1<a name='3852'>
      double precision :: zr, zs, zh, dninv<a name='3853'>
      real, parameter :: xn0s = 3.0e6, xn0r = 8.0e6, xn0h = 4.0e4, xn0hl = 4.0e4<a name='3854'>
      real, parameter :: xdnr = 1000., xdns = 100. ,xdnh = 700.0, xdnhl = 900.0<a name='3855'>
      real, parameter :: zhlfac = 1./(pi*xdnhl*xn0hl)<a name='3856'>
      real, parameter :: zhfac = 1./(pi*xdnh*xn0h)<a name='3857'>
      real, parameter :: zrfac = 1./(pi*xdnr*xn0r)<a name='3858'>
      real, parameter :: zsfac = 1./(pi*xdns*xn0s)<a name='3859'>
      real, parameter :: g0 = (6.0)*(5.0)*(4.0)/((3.0)*(2.0)*(1.0))<a name='3860'>
      real, parameter :: xims=900.*0.523599*(2.*50.e-6)**3    <font color=#447700>! mks   (100 micron diam solid sphere approx)<a name='3861'></font>
      real, parameter :: xcms=1000.*0.523599*(2.*7.5e-6)**3    <font color=#447700>! mks   (100 micron diam solid sphere approx)<a name='3862'></font>
<a name='3863'>
      real :: xmass,xv,xdn<a name='3864'>
      integer :: ndbz, nmwgt, nnwgt, nwlessthanz<a name='3865'>
<a name='3866'>
<font color=#447700>! ------------------------------------------------------------------<a name='3867'></font>
      <a name='3868'>
      <a name='3869'>
      jy = 1<a name='3870'>
      <a name='3871'>
      <a name='3872'>
         g1h = (6.0 + alphah)*(5.0 + alphah)*(4.0 + alphah)/  &amp;<a name='3873'>
     &amp;        ((3.0 + alphah)*(2.0 + alphah)*(1.0 + alphah))<a name='3874'>
<a name='3875'>
         g1hl = (6.0 + alphahl)*(5.0 + alphahl)*(4.0 + alphahl)/  &amp;<a name='3876'>
     &amp;        ((3.0 + alphahl)*(2.0 + alphahl)*(1.0 + alphahl))<a name='3877'>
     <a name='3878'>
         IF ( imurain == 3 ) THEN<a name='3879'>
         g1r = (rnu+2.0)/(rnu+1.0)<a name='3880'>
         ELSE <font color=#447700>! imurain == 1<a name='3881'></font>
         g1r = (6.0 + alphar)*(5.0 + alphar)*(4.0 + alphar)/  &amp;<a name='3882'>
     &amp;        ((3.0 + alphar)*(2.0 + alphar)*(1.0 + alphar))<a name='3883'>
         ENDIF<a name='3884'>
<a name='3885'>
         g1s = (snu+2.0)/(snu+1.0)<a name='3886'>
      <a name='3887'>
      DO kz = 1,nz<a name='3888'>
       DO ix = 1,nx <font color=#447700>! ixcol<a name='3889'></font>
<a name='3890'>
         dninv = 1./dn(ix,kz)<a name='3891'>
         <a name='3892'>
   <font color=#447700>!  Cloud droplets<a name='3893'></font>
         <a name='3894'>
         IF ( lnc &gt; 1 ) THEN<a name='3895'>
<font color=#447700>!           IF ( an(ix,jy,kz,lnc) &lt;= 0.1*cxmin .and. an(ix,jy,kz,lc) &gt; qxmin(lc) ) THEN<a name='3896'></font>
           IF ( an(ix,jy,kz,lnc) &gt; qxmin(lc) ) THEN<a name='3897'>
             anold(ix,jy,kz,lnc) = anold(ix,jy,kz,lnc) + an(ix,jy,kz,lc)/xcms<a name='3898'>
           ENDIF<a name='3899'>
         ENDIF<a name='3900'>
<a name='3901'>
   <font color=#447700>!  Cloud ice<a name='3902'></font>
         <a name='3903'>
         IF ( lni &gt; 1 ) THEN<a name='3904'>
           IF ( an(ix,jy,kz,lni) &gt; qxmin(li) ) THEN<a name='3905'>
             anold(ix,jy,kz,lni) = anold(ix,jy,kz,lni) + an(ix,jy,kz,li)/xims<a name='3906'>
           ENDIF<a name='3907'>
         ENDIF<a name='3908'>
<a name='3909'>
   <font color=#447700>!  rain<a name='3910'></font>
         <a name='3911'>
         IF ( lnr &gt; 1 ) THEN<a name='3912'>
           IF ( an(ix,jy,kz,lr) &gt; qxmin(lr) ) THEN <font color=#447700>! adding rain mass from CU scheme<a name='3913'></font>
<a name='3914'>
            IF ( .true. .or. (anold(ix,jy,kz,lr) - an(ix,jy,kz,lr)) &lt; qxmin(lr) .or. anold(ix,jy,kz,lnr) &lt; cxmin ) THEN <a name='3915'>
<a name='3916'>
             q = an(ix,jy,kz,lr)<a name='3917'>
             <a name='3918'>
             laminv1 = (dn(ix,kz) * q * zrfac)**(0.25)  <font color=#447700>! inverse of slope<a name='3919'></font>
             <a name='3920'>
             n1 = laminv1*xn0r  <font color=#447700>! number concentration for inv. exponential single moment input<a name='3921'></font>
             <a name='3922'>
             nrx =  n1*g1r/g0   <font color=#447700>! number concentration for different shape parameter<a name='3923'></font>
<a name='3924'>
             anold(ix,jy,kz,lnr) = anold(ix,jy,kz,lnr) + nrx <font color=#447700>! *dninv ! convert to number mixing ratio<a name='3925'></font>
<a name='3926'>
            ELSE<a name='3927'>
             <font color=#447700>! assume mean particle mass of pre-existing snow<a name='3928'></font>
                xmass = anold(ix,jy,kz,lr)/anold(ix,jy,kz,lnr)<a name='3929'>
                anold(ix,jy,kz,lnr) = anold(ix,jy,kz,lnr) + an(ix,jy,kz,lr)/xmass<a name='3930'>
            ENDIF<a name='3931'>
             <a name='3932'>
           ENDIF<a name='3933'>
         ENDIF<a name='3934'>
<a name='3935'>
  <font color=#447700>! snow<a name='3936'></font>
         IF ( lns &gt; 1 ) THEN<a name='3937'>
           IF ( an(ix,jy,kz,ls) &gt; qxmin(ls) ) THEN <font color=#447700>! adding snow mass from CU scheme<a name='3938'></font>
<a name='3939'>
             IF ( .true. .or. (anold(ix,jy,kz,ls) - an(ix,jy,kz,ls)) &lt; qxmin(ls) .or. anold(ix,jy,kz,lns) &lt; cxmin ) THEN <a name='3940'>
             <a name='3941'>
             <font color=#447700>! assume that there was no snow before this<a name='3942'></font>
             <a name='3943'>
             q = an(ix,jy,kz,ls)<a name='3944'>
             <a name='3945'>
             laminv1 = (dn(ix,kz) * q * zsfac)**(0.25)  <font color=#447700>! inverse of slope<a name='3946'></font>
             <a name='3947'>
             n1 = laminv1*xn0s  <font color=#447700>! number concentration for inv. exponential single moment input<a name='3948'></font>
             <a name='3949'>
             nrx =  n1*g1s/g0   <font color=#447700>! number concentration for different shape parameter<a name='3950'></font>
<a name='3951'>
             anold(ix,jy,kz,lns) = anold(ix,jy,kz,lns) + nrx <font color=#447700>! *dninv ! convert to number mixing ratio<a name='3952'></font>
             <a name='3953'>
             ELSE<a name='3954'>
             <font color=#447700>! assume mean particle mass of pre-existing snow<a name='3955'></font>
                xmass = anold(ix,jy,kz,ls)/anold(ix,jy,kz,lns)<a name='3956'>
                anold(ix,jy,kz,lns) = anold(ix,jy,kz,lns) + an(ix,jy,kz,ls)/xmass<a name='3957'>
             ENDIF<a name='3958'>
             <a name='3959'>
           ENDIF<a name='3960'>
         ENDIF<a name='3961'>
         <a name='3962'>
    <font color=#447700>! graupel<a name='3963'></font>
<a name='3964'>
<font color=#447700>!         IF ( lnh &gt; 1 ) THEN<a name='3965'></font>
<font color=#447700>!           IF ( an(ix,jy,kz,lnh) &lt;= 0.1*cxmin .and. an(ix,jy,kz,lh) &gt; qxmin(lh) ) THEN<a name='3966'></font>
<font color=#447700>!             IF ( lvh &gt; 1 ) THEN<a name='3967'></font>
<font color=#447700>!               IF ( an(ix,jy,kz,lvh) &lt;= 0.0 ) THEN<a name='3968'></font>
<font color=#447700>!                 an(ix,jy,kz,lvh) = an(ix,jy,kz,lh)/xdnh<a name='3969'></font>
<font color=#447700>!               ENDIF<a name='3970'></font>
<font color=#447700>!             ENDIF<a name='3971'></font>
<font color=#447700>!<a name='3972'></font>
<font color=#447700>!             q = an(ix,jy,kz,lh)<a name='3973'></font>
<font color=#447700>!             <a name='3974'></font>
<font color=#447700>!             laminv1 = (dn(ix,kz) * q * zhfac)**(0.25)  ! inverse of slope<a name='3975'></font>
<font color=#447700>!             <a name='3976'></font>
<font color=#447700>!             n1 = laminv1*xn0h  ! number concentration for inv. exponential single moment input<a name='3977'></font>
<font color=#447700>!             <a name='3978'></font>
<font color=#447700>!             nrx =  n1*g1h/g0   ! number concentration for different shape parameter<a name='3979'></font>
<font color=#447700>!<a name='3980'></font>
<font color=#447700>!             an(ix,jy,kz,lnh) = nrx ! *dninv ! convert to number mixing ratio<a name='3981'></font>
<font color=#447700>!<a name='3982'></font>
<font color=#447700>!           ENDIF<a name='3983'></font>
<font color=#447700>!         ENDIF<a name='3984'></font>
<font color=#447700>!<a name='3985'></font>
<font color=#447700>!    ! hail<a name='3986'></font>
<font color=#447700>!<a name='3987'></font>
<font color=#447700>!         IF ( lnhl &gt; 1 .and. lhl &gt; 1 ) THEN<a name='3988'></font>
<font color=#447700>!           IF ( an(ix,jy,kz,lnhl) &lt;= 0.1*cxmin .and. an(ix,jy,kz,lhl) &gt; qxmin(lhl) ) THEN<a name='3989'></font>
<font color=#447700>!             IF ( lvhl &gt; 1 ) THEN<a name='3990'></font>
<font color=#447700>!               IF ( an(ix,jy,kz,lvhl) &lt;= 0.0 ) THEN<a name='3991'></font>
<font color=#447700>!                 an(ix,jy,kz,lvhl) = an(ix,jy,kz,lhl)/xdnhl<a name='3992'></font>
<font color=#447700>!               ENDIF<a name='3993'></font>
<font color=#447700>!             ENDIF<a name='3994'></font>
<font color=#447700>!<a name='3995'></font>
<font color=#447700>!             q = an(ix,jy,kz,lhl)<a name='3996'></font>
<font color=#447700>!             <a name='3997'></font>
<font color=#447700>!             laminv1 = (dn(ix,kz) * q * zhlfac)**(0.25)  ! inverse of slope<a name='3998'></font>
<font color=#447700>!             <a name='3999'></font>
<font color=#447700>!             n1 = laminv1*xn0hl  ! number concentration for inv. exponential single moment input<a name='4000'></font>
<font color=#447700>!             <a name='4001'></font>
<font color=#447700>!             nrx =  n1*g1hl/g0   ! number concentration for different shape parameter<a name='4002'></font>
<font color=#447700>!<a name='4003'></font>
<font color=#447700>!             an(ix,jy,kz,lnhl) = nrx ! *dninv ! convert to number mixing ratio<a name='4004'></font>
<font color=#447700>!<a name='4005'></font>
<font color=#447700>!           ENDIF<a name='4006'></font>
<font color=#447700>!         ENDIF<a name='4007'></font>
 <a name='4008'>
      ENDDO <font color=#447700>! ix<a name='4009'></font>
      ENDDO <font color=#447700>! kz<a name='4010'></font>
      <a name='4011'>
      RETURN<a name='4012'>
      <a name='4013'>
      END subroutine calcnfromcuten<a name='4014'>
<a name='4015'>
<font color=#447700>! #####################################################################<a name='4016'></font>
<font color=#447700>! #####################################################################<a name='4017'></font>
<a name='4018'>
<A NAME='CALC_EFF_RADIUS'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALC_EFF_RADIUS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4019'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_eff_radius</font>    &amp; <A href='../../call_to/CALC_EFF_RADIUS.html' TARGET='index'>1</A>,<A href='../../call_from/CALC_EFF_RADIUS.html' TARGET='index'>4</A><a name='4020'>
     &amp;  (nx,ny,nz,na,jyslab &amp; <a name='4021'>
     &amp;  ,nor,norz &amp; <a name='4022'>
     &amp;  ,t1,t2,t3  &amp; <a name='4023'>
     &amp;  ,an,dn )<a name='4024'>
<a name='4025'>
   implicit none<a name='4026'>
<a name='4027'>
      integer, parameter :: ng1 = 1<a name='4028'>
      integer :: nx,ny,nz,na<a name='4029'>
      integer :: ng<a name='4030'>
      integer :: nor,norz, jyslab <font color=#447700>! ,nht,ngt,igsr<a name='4031'></font>
      real    :: dtp  <font color=#447700>! time step<a name='4032'></font>
<a name='4033'>
<a name='4034'>
<font color=#447700>!<a name='4035'></font>
<font color=#447700>! external temporary arrays<a name='4036'></font>
<font color=#447700>!<a name='4037'></font>
<a name='4038'>
      real t1(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='4039'>
      real t2(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='4040'>
      real t3(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='4041'>
      <a name='4042'>
<a name='4043'>
      real an(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz,na)<a name='4044'>
      real dn(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='4045'>
<a name='4046'>
      <a name='4047'>
<a name='4048'>
<a name='4049'>
      <a name='4050'>
    <font color=#447700>! local<a name='4051'></font>
    <a name='4052'>
      real pb(-norz+ng1:nz+norz)<a name='4053'>
      real pinit(-norz+ng1:nz+norz)<a name='4054'>
<a name='4055'>
<font color=#447700>! <a name='4056'></font>
<font color=#447700>!  declarations microphysics and for gather/scatter<a name='4057'></font>
<font color=#447700>!<a name='4058'></font>
      integer nxmpb,nzmpb,nxz<a name='4059'>
      integer mgs,ngs,numgs,inumgs<a name='4060'>
      parameter (ngs=1)<a name='4061'>
      integer ngscnt,igs(ngs),kgs(ngs)<a name='4062'>
      real rho0(ngs)<a name='4063'>
<a name='4064'>
      integer ix,kz,i,n, kp1<a name='4065'>
      integer :: jy, jgs<a name='4066'>
      integer ixb,ixe,jyb,jye,kzb,kze<a name='4067'>
    <a name='4068'>
      integer itile,jtile,ktile<a name='4069'>
      integer ixend,jyend,kzend,kzbeg<a name='4070'>
      integer nxend,nyend,nzend,nzbeg<a name='4071'>
<a name='4072'>
      real :: qx(ngs,lv:lhab)<a name='4073'>
      real :: cx(ngs,lc:lhab)<a name='4074'>
      real :: xv(ngs,lc:lhab)<a name='4075'>
      real :: xmas(ngs,lc:lhab)<a name='4076'>
      real :: xdn(ngs,lc:lhab)<a name='4077'>
      real :: xdia(ngs,lc:lhab,3)<a name='4078'>
      real :: alpha(ngs,lc:lhab)<a name='4079'>
      <a name='4080'>
      real :: gamc1,gamc2,gami1,gami2,gams1,gams2, factor_c, factor_i, factor_s<a name='4081'>
      real :: lam_c, lam_i, lam_s<a name='4082'>
      integer :: il<a name='4083'>
<a name='4084'>
<a name='4085'>
<font color=#447700>! -------------------------------------------------------------------------------<a name='4086'></font>
      itile = nx<a name='4087'>
      jtile = ny<a name='4088'>
      ktile = nz<a name='4089'>
      ixend = nx<a name='4090'>
      jyend = ny<a name='4091'>
      kzend = nz<a name='4092'>
      nxend = nx + 1<a name='4093'>
      nyend = ny + 1<a name='4094'>
      nzend = nz<a name='4095'>
      kzbeg = 1<a name='4096'>
      nzbeg = 1<a name='4097'>
<a name='4098'>
       jy = 1<a name='4099'>
       pb(:) = 0.0<a name='4100'>
       pinit(:) = 0.0<a name='4101'>
<a name='4102'>
     gamc1 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALC_EFF_RADIUS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_21">(2. + cnu)<a name='4103'>
     gamc2 = 1. <font color=#447700>! Gamma[1 + alphac]<a name='4104'></font>
     gami1 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALC_EFF_RADIUS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_22">(2. + cinu)<a name='4105'>
     gami2 = 1. <font color=#447700>! Gamma[1 + alphac]<a name='4106'></font>
     gams1 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALC_EFF_RADIUS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_23">(2. + cinu)<a name='4107'>
     gams2 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#CALC_EFF_RADIUS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_24">(1. + snu)<a name='4108'>
<a name='4109'>
     factor_c = (1. + cnu)*Gamma_sp(1. + cnu)/Gamma_sp(5./3. + cnu)<a name='4110'>
     factor_i = (1. + cinu)*Gamma_sp(1. + cinu)/Gamma_sp(5./3. + cinu)<a name='4111'>
     factor_s = (1. + snu)*Gamma_sp(1. + snu)/Gamma_sp(5./3. + snu)<a name='4112'>
<a name='4113'>
<font color=#447700>!<a name='4114'></font>
<font color=#447700>!     jy = 1 ! working on a 2d slab<a name='4115'></font>
<font color=#447700>!!  VERY IMPORTANT:  SET jgs = jy<a name='4116'></font>
<a name='4117'>
      jgs = jy<a name='4118'>
<a name='4119'>
      mgs = 1<a name='4120'>
      DO kz = 1,nz<a name='4121'>
       DO ix = 1,nx <font color=#447700>! ixcol<a name='4122'></font>
<a name='4123'>
         rho0(mgs) = dn(ix,jy,kz)<a name='4124'>
         DO il = lc,ls<a name='4125'>
          qx(mgs,il) = max(an(ix,jy,kz,il), 0.0) <a name='4126'>
          cx(mgs,il) = max(an(ix,jy,kz,ln(il)), 0.0) <a name='4127'>
         ENDDO<a name='4128'>
         <a name='4129'>
         IF ( qx(mgs,lc) &gt; qxmin(lc) ) THEN<a name='4130'>
<font color=#447700>! Lambda for cloud droplets <a name='4131'></font>
         lam_c = ((cx(mgs,lc)*(Pi/6.)*xdn0(lc)*Gamc1)/(qx(mgs,lc)*rho0(mgs)*Gamc2))**(1./3.)<a name='4132'>
          t1(ix,jy,kz) = 0.5*factor_c/lam_c<a name='4133'>
         ENDIF<a name='4134'>
<a name='4135'>
         IF ( qx(mgs,li) &gt; qxmin(li) ) THEN<a name='4136'>
<font color=#447700>! Lambda for cloud ice <a name='4137'></font>
         lam_i = ((cx(mgs,li)*(Pi/6.)*xdn0(li)*Gami1)/(qx(mgs,li)*rho0(mgs)*Gami2))**(1./3.)<a name='4138'>
          t2(ix,jy,kz) = 0.5*factor_i/lam_i<a name='4139'>
         ENDIF<a name='4140'>
<a name='4141'>
         IF ( qx(mgs,ls) &gt; qxmin(ls) ) THEN<a name='4142'>
<font color=#447700>! Lambda for snow<a name='4143'></font>
         lam_s = ((cx(mgs,ls)*(Pi/6.)*xdn0(ls)*Gams1)/(qx(mgs,ls)*rho0(mgs)*Gams2))**(1./3.)<a name='4144'>
          t3(ix,jy,kz) = 0.5*factor_s/lam_s<a name='4145'>
         ENDIF<a name='4146'>
<a name='4147'>
      <a name='4148'>
       ENDDO <font color=#447700>! ix<a name='4149'></font>
      ENDDO <font color=#447700>! kz<a name='4150'></font>
<a name='4151'>
   RETURN<a name='4152'>
   END SUBROUTINE calc_eff_radius<a name='4153'>
<a name='4154'>
<a name='4155'>
<font color=#447700>! #####################################################################<a name='4156'></font>
<font color=#447700>! #####################################################################<a name='4157'></font>
<a name='4158'>
<A NAME='QVEXCESS'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#QVEXCESS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4159'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>QVEXCESS</font>(ngs,mgs,qwvp0,qv0,qcw1,pres,thetap0,theta0, &amp; <A href='../../call_to/QVEXCESS.html' TARGET='index'>2</A>,<A href='../../call_from/QVEXCESS.html' TARGET='index'>2</A><a name='4160'>
     &amp;    qvex,pi0,tabqvs,nqsat,fqsat,cbw,fcqv1,felvcp,ss1,pk,ngscnt)<a name='4161'>
      <a name='4162'>
<font color=#447700>!#####################################################################<a name='4163'></font>
<font color=#447700>!  Purpose: find the amount of vapor that can be condensed to liquid<a name='4164'></font>
<font color=#447700>!#####################################################################<a name='4165'></font>
<a name='4166'>
      implicit none<a name='4167'>
<a name='4168'>
      integer ngs,mgs,ngscnt<a name='4169'>
      <a name='4170'>
      real theta2temp<a name='4171'>
      <a name='4172'>
      real qvex<a name='4173'>
      <a name='4174'>
      integer nqsat<a name='4175'>
      real fqsat, cbw<a name='4176'>
      <a name='4177'>
      real ss1  <font color=#447700>! 'target' supersaturation<a name='4178'></font>
<font color=#447700>!<a name='4179'></font>
<font color=#447700>!  input arrays<a name='4180'></font>
<font color=#447700>!<a name='4181'></font>
      real qv0(ngs), qcw1(ngscnt), pres(ngs), qwvp0(mgs)<a name='4182'>
      real thetap0(ngs), theta0(ngs)<a name='4183'>
      real fcqv1(ngs), felvcp(ngs), pi0(ngs)<a name='4184'>
      real pk(ngs)<a name='4185'>
      <a name='4186'>
      real tabqvs(nqsat)<a name='4187'>
<font color=#447700>!<a name='4188'></font>
<font color=#447700>! Local stuff<a name='4189'></font>
<font color=#447700>!<a name='4190'></font>
      <a name='4191'>
      integer itertd<a name='4192'>
      integer ltemq<a name='4193'>
      real gamss<a name='4194'>
      real theta(ngs), qvap(ngs), pqs(ngs), qcw(ngs), qwv(ngs)<a name='4195'>
      real qcwtmp(ngs), qss(ngs), qvs(ngs), qwvp(ngs)<a name='4196'>
      real dqcw(ngs), dqwv(ngs), dqvcnd(ngs)<a name='4197'>
      real temg(ngs), temcg(ngs), thetap(ngs)<a name='4198'>
      <a name='4199'>
      real tfr<a name='4200'>
      parameter ( tfr = 273.15 )<a name='4201'>
            <a name='4202'>
<font color=#447700>!      real poo,cap<a name='4203'></font>
<font color=#447700>!      parameter ( cap = rd/cp, poo = 1.0e+05 )<a name='4204'></font>
<font color=#447700>!<a name='4205'></font>
<font color=#447700>!<a name='4206'></font>
<font color=#447700>!  Modified Straka adjustment (nearly identical to Tao et al. 1989 MWR)<a name='4207'></font>
<font color=#447700>!<a name='4208'></font>
<font color=#447700>!<a name='4209'></font>
<font color=#447700>!<a name='4210'></font>
<font color=#447700>!  set up temperature and vapor arrays<a name='4211'></font>
<font color=#447700>!<a name='4212'></font>
      pqs(mgs) = (380.0)/(pres(mgs))<a name='4213'>
      thetap(mgs) = thetap0(mgs)<a name='4214'>
      theta(mgs) = thetap(mgs) + theta0(mgs)<a name='4215'>
      qwvp(mgs) = qwvp0(mgs)<a name='4216'>
      qvap(mgs) = max( (qwvp0(mgs) + qv0(mgs)), 0.0 )<a name='4217'>
      temg(mgs) = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#QVEXCESS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_15">(mgs)*pk(mgs) <font color=#447700>! ( pres(mgs) / poo ) ** cap<a name='4218'></font>
<font color=#447700>!      temg(mgs) = theta2temp( theta(mgs), pres(mgs) )<a name='4219'></font>
<font color=#447700>!<a name='4220'></font>
<font color=#447700>!<a name='4221'></font>
<font color=#447700>!<a name='4222'></font>
<font color=#447700>!  reset temporaries for cloud particles and vapor<a name='4223'></font>
<font color=#447700>!<a name='4224'></font>
      <a name='4225'>
      qwv(mgs) = max( 0.0, qvap(mgs) )<a name='4226'>
      qcw(mgs) = max( 0.0, qcw1(mgs) )<a name='4227'>
<font color=#447700>!<a name='4228'></font>
<font color=#447700>!<a name='4229'></font>
      qcwtmp(mgs) = qcw(mgs)<a name='4230'>
      temcg(mgs) = temg(mgs) - tfr<a name='4231'>
      ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='4232'>
      ltemq = Min( nqsat, Max(1,ltemq) )<a name='4233'>
<a name='4234'>
      qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='4235'>
      qss(mgs) = (0.01*ss1 + 1.0)*qvs(mgs)<a name='4236'>
<font color=#447700>!<a name='4237'></font>
<font color=#447700>!  iterate  adjustment<a name='4238'></font>
<font color=#447700>!<a name='4239'></font>
      do itertd = 1,2<a name='4240'>
<font color=#447700>!<a name='4241'></font>
<font color=#447700>!<a name='4242'></font>
<font color=#447700>!  calculate super-saturation<a name='4243'></font>
<font color=#447700>!<a name='4244'></font>
      dqcw(mgs) = 0.0<a name='4245'>
      dqwv(mgs) = ( qwv(mgs) - qss(mgs) )<a name='4246'>
<font color=#447700>!<a name='4247'></font>
<font color=#447700>!  evaporation and sublimation adjustment<a name='4248'></font>
<font color=#447700>!<a name='4249'></font>
      if( dqwv(mgs) .lt. 0. ) then           <font color=#447700>!  subsaturated<a name='4250'></font>
        if( qcw(mgs) .gt. -dqwv(mgs) ) then  <font color=#447700>! check if qc can make up all of the deficit<a name='4251'></font>
          dqcw(mgs) = dqwv(mgs)<a name='4252'>
          dqwv(mgs) = 0.<a name='4253'>
        else                                 <font color=#447700>!  otherwise make all qc available for evap<a name='4254'></font>
          dqcw(mgs) = -qcw(mgs)<a name='4255'>
          dqwv(mgs) = dqwv(mgs) + qcw(mgs)<a name='4256'>
        end if<a name='4257'>
<font color=#447700>!<a name='4258'></font>
        qwvp(mgs) = qwvp(mgs) - ( dqcw(mgs)  )  <font color=#447700>! add to perturbation vapor<a name='4259'></font>
<font color=#447700>!<a name='4260'></font>
        qcw(mgs) = qcw(mgs) + dqcw(mgs)<a name='4261'>
<a name='4262'>
        thetap(mgs) = thetap(mgs) +  &amp;<a name='4263'>
     &amp;                1./pi0(mgs)*  &amp;<a name='4264'>
     &amp;                (felvcp(mgs)*dqcw(mgs) )<a name='4265'>
<a name='4266'>
      end if  <font color=#447700>! dqwv(mgs) .lt. 0. (end of evap/sublim)<a name='4267'></font>
<font color=#447700>!<a name='4268'></font>
<font color=#447700>! condensation/deposition<a name='4269'></font>
<font color=#447700>!<a name='4270'></font>
      IF ( dqwv(mgs) .ge. 0. ) THEN<a name='4271'>
<font color=#447700>!<a name='4272'></font>
      dqvcnd(mgs) = dqwv(mgs)/(1. + fcqv1(mgs)*qss(mgs)/  &amp;<a name='4273'>
     &amp;  ((temg(mgs)-cbw)**2))<a name='4274'>
<font color=#447700>!<a name='4275'></font>
<font color=#447700>!<a name='4276'></font>
      dqcw(mgs) = dqvcnd(mgs)<a name='4277'>
<font color=#447700>!<a name='4278'></font>
      thetap(mgs) = thetap(mgs) +  &amp;<a name='4279'>
     &amp;   (felvcp(mgs)*dqcw(mgs) )    &amp;<a name='4280'>
     &amp; / (pi0(mgs))<a name='4281'>
      qwvp(mgs) = qwvp(mgs) - ( dqvcnd(mgs) )<a name='4282'>
      qcw(mgs) = qcw(mgs) + dqcw(mgs)<a name='4283'>
<font color=#447700>!<a name='4284'></font>
      END IF <font color=#447700>!  dqwv(mgs) .ge. 0.<a name='4285'></font>
<a name='4286'>
      theta(mgs) = thetap(mgs) + theta0(mgs)<a name='4287'>
      temg(mgs) = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#QVEXCESS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_16">(mgs)*pk(mgs) <font color=#447700>! ( pres(mgs) / poo ) ** cap<a name='4288'></font>
<font color=#447700>!      temg(mgs) = theta2temp( theta(mgs), pres(mgs) )<a name='4289'></font>
      qvap(mgs) = Max((qwvp(mgs) + qv0(mgs)), 0.0)<a name='4290'>
      temcg(mgs) = temg(mgs) - tfr<a name='4291'>
<font color=#447700>!      tqvcon = temg(mgs)-cbw<a name='4292'></font>
      ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='4293'>
      ltemq = Min( nqsat, Max(1,ltemq) )<a name='4294'>
      qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='4295'>
      qcw(mgs) = max( 0.0, qcw(mgs) )<a name='4296'>
      qwv(mgs) = max( 0.0, qvap(mgs))<a name='4297'>
      qss(mgs) = (0.01*ss1 + 1.0)*qvs(mgs)<a name='4298'>
      end do<a name='4299'>
<font color=#447700>!<a name='4300'></font>
<font color=#447700>!  end the saturation adjustment iteration loop<a name='4301'></font>
<font color=#447700>!<a name='4302'></font>
<font color=#447700>!<a name='4303'></font>
      qvex = Max(0.0, qcw(mgs) - qcw1(mgs) )<a name='4304'>
<a name='4305'>
      RETURN<a name='4306'>
      END SUBROUTINE QVEXCESS<a name='4307'>
<a name='4308'>
<font color=#447700>! #####################################################################<a name='4309'></font>
<font color=#447700>! #####################################################################<a name='4310'></font>
<a name='4311'>
<a name='4312'>
<a name='4313'>
<a name='4314'>
<a name='4315'>
<font color=#447700>!<a name='4316'></font>
<font color=#447700>! ##############################################################################<a name='4317'></font>
<font color=#447700>!<a name='4318'></font>
<A NAME='SETVTZ'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SETVTZ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4319'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>setvtz</font>(ngscnt,qx,qxmin,qxw,cx,rho0,rhovt,xdia,cno,cnostmp, &amp; <A href='../../call_to/SETVTZ.html' TARGET='index'>2</A><a name='4320'>
     &amp;                 xmas,vtxbar,xdn,xvmn0,xvmx0,xv,cdx,            &amp;<a name='4321'>
     &amp;                 ipconc1,ndebug1,ngs,nz,kgs,fadvisc,   &amp;<a name='4322'>
     &amp;                 cwmasn,cwmasx,cwradn,cnina,cimna,cimxa,      &amp;<a name='4323'>
     &amp;                 itype1a,itype2a,temcg,infdo,alpha,ildo,axh,bxh,axhl,bxhl)<a name='4324'>
<a name='4325'>
<a name='4326'>
      implicit none<a name='4327'>
      <a name='4328'>
      integer ngscnt,ngs0,ngs,nz<a name='4329'>
<font color=#447700>!      integer infall    ! whether to calculate number-weighted fall speeds<a name='4330'></font>
      <a name='4331'>
      real xv(ngs,lc:lhab)<a name='4332'>
      real qx(ngs,lv:lhab)<a name='4333'>
      real qxw(ngs,ls:lhab)<a name='4334'>
      real cx(ngs,lc:lhab)<a name='4335'>
      real vtxbar(ngs,lc:lhab,3)<a name='4336'>
      real xmas(ngs,lc:lhab)<a name='4337'>
      real xdn(ngs,lc:lhab)<a name='4338'>
      real xdia(ngs,lc:lhab,3)<a name='4339'>
      real xvmn0(lc:lhab), xvmx0(lc:lhab)<a name='4340'>
      real qxmin(lc:lhab)<a name='4341'>
      real cdx(lc:lhab)<a name='4342'>
      real alpha(ngs,lc:lhab)<a name='4343'>
      <a name='4344'>
      real rho0(ngs),rhovt(ngs),temcg(ngs)<a name='4345'>
      real cno(lc:lhab)<a name='4346'>
      real cnostmp(ngs)<a name='4347'>
      <a name='4348'>
      real cwc1, cimna, cimxa<a name='4349'>
      real cnina(ngs)<a name='4350'>
      integer kgs(ngs)<a name='4351'>
      real fadvisc(ngs)<a name='4352'>
      real fsw<a name='4353'>
      <a name='4354'>
      integer ipconc1<a name='4355'>
      integer ndebug1<a name='4356'>
      <a name='4357'>
      integer, intent (in) :: itype1a,itype2a,infdo<a name='4358'>
      integer, intent (in) :: ildo <font color=#447700>! which species to do, or all if ildo=0<a name='4359'></font>
<a name='4360'>
      real :: axh(ngs),bxh(ngs)<a name='4361'>
      real :: axhl(ngs),bxhl(ngs)<a name='4362'>
      <a name='4363'>
<font color=#447700>! Local vars<a name='4364'></font>
<a name='4365'>
      <a name='4366'>
      <a name='4367'>
      real swmasmx, dtmp<a name='4368'>
      real cd<a name='4369'>
      real cwc0 <font color=#447700>! ,cwc1<a name='4370'></font>
      real :: cwch(ngscnt), cwchl(ngscnt)<a name='4371'>
      real :: cwchtmp,cwchltmp,xnutmp<a name='4372'>
      real pii<a name='4373'>
      real cimasx,cimasn<a name='4374'>
      real cwmasn,cwmasx,cwradn<a name='4375'>
      real cwrad<a name='4376'>
      real vr,rnux<a name='4377'>
      real alp<a name='4378'>
      <a name='4379'>
      real ccimx<a name='4380'>
<a name='4381'>
      integer mgs<a name='4382'>
      <a name='4383'>
      real arx,frx,vtrain,fw<a name='4384'>
      real fwlo,fwhi,rfwdiff<a name='4385'>
      real ar,br,cs,ds<a name='4386'>
<font color=#447700>!      real gf4p5, gf4ds, gf4br, ifirst, gf1ds<a name='4387'></font>
<font color=#447700>!      real gfcinu1, gfcinu1p47, gfcinu2p47<a name='4388'></font>
      real gr<a name='4389'>
      real rwrad,rwdia<a name='4390'>
      real mwfac<a name='4391'>
      integer il<a name='4392'>
<a name='4393'>
<font color=#447700>!      save gf4p5, gf4ds, gf4br, ifirst, gf1ds<a name='4394'></font>
<font color=#447700>!      save gfcinu1, gfcinu1p47, gfcinu2p47<a name='4395'></font>
<font color=#447700>!      data ifirst /0/<a name='4396'></font>
      <a name='4397'>
      real bta1,cnit<a name='4398'>
      parameter ( bta1 = 0.6, cnit = 1.0e-02 )<a name='4399'>
      real x,y,tmp,del<a name='4400'>
      real aax,bbx,delrho<a name='4401'>
      integer :: indxr<a name='4402'>
      real mwt, nwt<a name='4403'>
      real, parameter :: rho00 = 1.225<a name='4404'>
      integer i<a name='4405'>
      real xvbarmax<a name='4406'>
<a name='4407'>
      integer l1, l2<a name='4408'>
<a name='4409'>
<a name='4410'>
<font color=#447700>!<a name='4411'></font>
<font color=#447700>! set values<a name='4412'></font>
<font color=#447700>!<a name='4413'></font>
<font color=#447700>!      cwmasn = 5.23e-13  ! radius of 5.0e-6<a name='4414'></font>
<font color=#447700>!      cwradn = 5.0e-6<a name='4415'></font>
<font color=#447700>!      cwmasx = 5.25e-10  ! radius of 50.0e-6<a name='4416'></font>
<a name='4417'>
      fwlo = 0.2                <font color=#447700>! water fraction to start weighting toward rain fall speed<a name='4418'></font>
      fwhi = 0.4                <font color=#447700>! water fraction at which rain fall speed only is used<a name='4419'></font>
      rfwdiff = 1./(fwhi - fwlo)<a name='4420'>
      <a name='4421'>
<font color=#447700>!      pi = 4.0*atan(1.0)<a name='4422'></font>
      pii = piinv <font color=#447700>! 1.0/pi<a name='4423'></font>
<a name='4424'>
      arx = 10.<a name='4425'>
      frx = 516.575 <font color=#447700>! raind fit parameters for arx*(1 - Exp(-fx*d)), where d is rain diameter in meters.<a name='4426'></font>
<a name='4427'>
      ar = 841.99666  <a name='4428'>
      br = 0.8<a name='4429'>
      gr = 9.8<a name='4430'>
<font color=#447700>!  new values for  cs and ds<a name='4431'></font>
      cs = 12.42<a name='4432'>
      ds = 0.42<a name='4433'>
<a name='4434'>
      IF ( ildo == 0 ) THEN<a name='4435'>
        l1 = lc<a name='4436'>
        l2 = lhab<a name='4437'>
      ELSE<a name='4438'>
        l1 = ildo<a name='4439'>
        l2 = ildo<a name='4440'>
      ENDIF<a name='4441'>
<a name='4442'>
<font color=#447700>!      IF ( ifirst .eq. 0 ) THEN<a name='4443'></font>
<font color=#447700>!        ifirst = 1<a name='4444'></font>
<font color=#447700>!        gf4br = gamma(4.0+br)<a name='4445'></font>
<font color=#447700>!        gf4ds = gamma(4.0+ds)<a name='4446'></font>
<font color=#447700>!!        gf1ds = gamma(1.0+ds)<a name='4447'></font>
<font color=#447700>!        gf4p5 = gamma(4.0+0.5)<a name='4448'></font>
<font color=#447700>!        gfcinu1 = gamma(cinu + 1.0)<a name='4449'></font>
<font color=#447700>!        gfcinu1p47 = gamma(cinu + 1.47167)<a name='4450'></font>
<font color=#447700>!        gfcinu2p47 = gamma(cinu + 2.47167)<a name='4451'></font>
        <a name='4452'>
        IF ( lh  .gt. 1 ) THEN<a name='4453'>
          IF ( dmuh == 1.0 ) THEN<a name='4454'>
            cwchtmp = ((3. + dnu(lh))*(2. + dnu(lh))*(1.0 + dnu(lh)))**(-1./3.)<a name='4455'>
          ELSE<a name='4456'>
            cwchtmp = 6.0*pii*gamma_sp( (xnu(lh) + 1.)/xmu(lh) )/gamma_sp( (xnu(lh) + 2.)/xmu(lh) )<a name='4457'>
          ENDIF<a name='4458'>
        ENDIF<a name='4459'>
        IF ( lhl .gt. 1 ) THEN<a name='4460'>
          IF ( dmuhl == 1.0 ) THEN<a name='4461'>
            cwchltmp = ((3. + dnu(lhl))*(2. + dnu(lhl))*(1.0 + dnu(lhl)))**(-1./3.)<a name='4462'>
          ELSE<a name='4463'>
            cwchltmp = 6.0*pii*gamma_sp( (xnu(lhl) + 1)/xmu(lhl) )/gamma_sp( (xnu(lhl) + 2)/xmu(lhl) )<a name='4464'>
          ENDIF<a name='4465'>
        ENDIF<a name='4466'>
<a name='4467'>
        IF ( ipconc .le. 5 ) THEN<a name='4468'>
          IF ( lh  .gt. 1 ) cwch(:) =  cwchtmp <a name='4469'>
          IF ( lhl .gt. 1 ) cwchl(:) = cwchltmp<a name='4470'>
        ELSE<a name='4471'>
          DO mgs = 1,ngscnt<a name='4472'>
          <a name='4473'>
          IF ( lh  .gt. 1 .and. ( ildo == 0 .or. ildo == lh ) ) THEN<a name='4474'>
           IF ( qx(mgs,lh) .gt. qxmin(lh) ) THEN<a name='4475'>
            IF ( dmuh == 1.0 ) THEN<a name='4476'>
              cwch(mgs) = ((3. + alpha(mgs,lh))*(2. + alpha(mgs,lh))*(1.0 + alpha(mgs,lh)))**(-1./3.)<a name='4477'>
             ELSE<a name='4478'>
             xnutmp = (alpha(mgs,lh) - 2.0)/3.0<a name='4479'>
             cwch(mgs) =  6.0*pii*gamma_sp( (xnutmp + 1.)/xmu(lh) )/gamma_sp( (xnutmp + 2.)/xmu(lh) )<a name='4480'>
            ENDIF<a name='4481'>
           ELSE<a name='4482'>
             cwch(mgs) = cwchtmp<a name='4483'>
           ENDIF<a name='4484'>
          ENDIF<a name='4485'>
          IF ( lhl .gt. 1 .and. ( ildo == 0 .or. ildo == lhl ) ) THEN<a name='4486'>
           IF ( qx(mgs,lhl) .gt. qxmin(lhl) ) THEN<a name='4487'>
            IF ( dmuhl == 1.0 ) THEN<a name='4488'>
              cwchl(mgs) = ((3. + alpha(mgs,lhl))*(2. + alpha(mgs,lhl))*(1.0 + alpha(mgs,lhl)))**(-1./3.)<a name='4489'>
             ELSE<a name='4490'>
             xnutmp = (alpha(mgs,lhl) - 2.0)/3.0<a name='4491'>
             cwchl(mgs) = 6.0*pii*gamma_sp( (xnutmp + 1)/xmu(lhl) )/gamma_sp( (xnutmp + 2)/xmu(lhl) )<a name='4492'>
            ENDIF<a name='4493'>
           ELSE<a name='4494'>
             cwchl(mgs) = cwchltmp<a name='4495'>
           ENDIF<a name='4496'>
          ENDIF<a name='4497'>
          <a name='4498'>
          ENDDO<a name='4499'>
        <a name='4500'>
        ENDIF<a name='4501'>
       <a name='4502'>
<a name='4503'>
      cimasn = Min( cimas0, 6.88e-13)<a name='4504'>
      cimasx = 1.0e-8<a name='4505'>
      ccimx = 5000.0e3   <font color=#447700>! max of 5000 per liter<a name='4506'></font>
<a name='4507'>
      cwc1 = 6.0/(pi*1000.)<a name='4508'>
      cwc0 = pii <font color=#447700>! 6.0*pii<a name='4509'></font>
      mwfac = 6.0**(1./3.)<a name='4510'>
<a name='4511'>
      <a name='4512'>
      if (ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set scale diameter'<a name='4513'>
<font color=#447700>!<a name='4514'></font>
<a name='4515'>
<a name='4516'>
<font color=#447700>!<a name='4517'></font>
<font color=#447700>!  cloud water variables<a name='4518'></font>
<font color=#447700>! ################################################################<a name='4519'></font>
<font color=#447700>!<a name='4520'></font>
<font color=#447700>!  DROPLETS<a name='4521'></font>
<font color=#447700>!<a name='4522'></font>
<font color=#447700>!<a name='4523'></font>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set cloud water variables'<a name='4524'>
      <a name='4525'>
      IF ( ildo == 0 .or. ildo == lc ) THEN<a name='4526'>
      <a name='4527'>
      do mgs = 1,ngscnt<a name='4528'>
      xv(mgs,lc) = 0.0<a name='4529'>
      <a name='4530'>
      IF ( qx(mgs,lc) .gt. qxmin(lc) ) THEN <font color=#447700>!{<a name='4531'></font>
      <a name='4532'>
      IF ( ipconc .ge. 2 .and. cx(mgs,lc) .gt. 1.0e-9 ) THEN <font color=#447700>!{<a name='4533'></font>
        xmas(mgs,lc) =  &amp;<a name='4534'>
     &amp;    min( max(qx(mgs,lc)*rho0(mgs)/cx(mgs,lc),cwmasn),cwmasx )<a name='4535'>
        xv(mgs,lc) = xmas(mgs,lc)/xdn(mgs,lc)<a name='4536'>
      ELSE<a name='4537'>
       IF ( ipconc .lt. 2 ) THEN<a name='4538'>
         cx(mgs,lc) = rho0(mgs)*ccn/rho00 <font color=#447700>! scales to local density, relative to standard air density<a name='4539'></font>
       ENDIF<a name='4540'>
       IF ( qx(mgs,lc) .gt. qxmin(lc) .and. cx(mgs,lc) .gt. 0.01 ) THEN <font color=#447700>!{<a name='4541'></font>
        xmas(mgs,lc) =  &amp;<a name='4542'>
     &amp;     min( max(qx(mgs,lc)*rho0(mgs)/cx(mgs,lc),xdn(mgs,lc)*xvmn(lc)), &amp;<a name='4543'>
     &amp;      xdn(mgs,lc)*xvmx(lc) )<a name='4544'>
        <a name='4545'>
        xv(mgs,lc) = xmas(mgs,lc)/xdn(mgs,lc)<a name='4546'>
        cx(mgs,lc) = qx(mgs,lc)*rho0(mgs)/xmas(mgs,lc)<a name='4547'>
        <a name='4548'>
       ELSEIF ( qx(mgs,lc) .gt. qxmin(lc) .and. cx(mgs,lc) .le. 0.01 ) THEN<a name='4549'>
        xmas(mgs,lc) = xdn(mgs,lc)*4.*pi/3.*(5.0e-6)**3<a name='4550'>
        cx(mgs,lc) = rho0(mgs)*qx(mgs,lc)/xmas(mgs,lc)<a name='4551'>
        xv(mgs,lc) = xmas(mgs,lc)/xdn(mgs,lc)<a name='4552'>
        <a name='4553'>
       ELSE<a name='4554'>
        xmas(mgs,lc) = cwmasn<a name='4555'>
        xv(mgs,lc) = xmas(mgs,lc)/1000.<a name='4556'>
<font color=#447700>! do not define ccw here! it can feed back to ccn!!!    cx(mgs,lc) = 0.0 ! cwnc(mgs)<a name='4557'></font>
       ENDIF <font color=#447700>!}<a name='4558'></font>
      ENDIF <font color=#447700>!}<a name='4559'></font>
<font color=#447700>!      IF ( ipconc .lt. 2 ) THEN<a name='4560'></font>
<font color=#447700>!        xmas(mgs,lc) = &amp;<a name='4561'></font>
<font color=#447700>!     &amp;    min( max(qx(mgs,lc)*rho0(mgs)/cwnc(mgs),cwmasn),cwmasx )<a name='4562'></font>
<font color=#447700>!        cx(mgs,lc) = Max(1.0,qx(mgs,lc)*rho0(mgs)/xmas(mgs,lc))<a name='4563'></font>
<font color=#447700>!      ELSE<a name='4564'></font>
<font color=#447700>!        cwnc(mgs) = an(igs(mgs),jgs,kgs(mgs),lnc)<a name='4565'></font>
<font color=#447700>!        cx(mgs,lc) = cwnc(mgs)<a name='4566'></font>
<font color=#447700>!      ENDIF<a name='4567'></font>
      xdia(mgs,lc,1) = (xmas(mgs,lc)*cwc1)**(1./3.)<a name='4568'>
      xdia(mgs,lc,2) = xdia(mgs,lc,1)**2<a name='4569'>
      xdia(mgs,lc,3) = xdia(mgs,lc,1)<a name='4570'>
      cwrad = 0.5*xdia(mgs,lc,1)<a name='4571'>
      IF ( fadvisc(mgs) &gt; 0.0 ) THEN<a name='4572'>
      vtxbar(mgs,lc,1) =  &amp;<a name='4573'>
     &amp;   (2.0*gr*xdn(mgs,lc) *(cwrad**2)) &amp;<a name='4574'>
     &amp;  /(9.0*fadvisc(mgs))<a name='4575'>
      ELSE<a name='4576'>
       vtxbar(mgs,lc,1) = 0.0<a name='4577'>
      ENDIF<a name='4578'>
<a name='4579'>
      <a name='4580'>
      ELSE<a name='4581'>
       xmas(mgs,lc) = cwmasn<a name='4582'>
       IF ( ipconc .le. 1 ) cx(mgs,lc) = 0.01<a name='4583'>
       xdia(mgs,lc,1) = 2.*cwradn<a name='4584'>
       xdia(mgs,lc,2) = 4.*cwradn**2<a name='4585'>
       xdia(mgs,lc,3) = xdia(mgs,lc,1)<a name='4586'>
       vtxbar(mgs,lc,1) = 0.0<a name='4587'>
       <a name='4588'>
      ENDIF <font color=#447700>!} qcw .gt. qxmin(lc)<a name='4589'></font>
      <a name='4590'>
      end do<a name='4591'>
      <a name='4592'>
      ENDIF<a name='4593'>
<a name='4594'>
<a name='4595'>
<a name='4596'>
<font color=#447700>!<a name='4597'></font>
<font color=#447700>! cloud ice variables<a name='4598'></font>
<font color=#447700>! columns<a name='4599'></font>
<font color=#447700>!<a name='4600'></font>
<font color=#447700>! ################################################################<a name='4601'></font>
<font color=#447700>!<a name='4602'></font>
<font color=#447700>!  CLOUD ICE<a name='4603'></font>
<font color=#447700>!<a name='4604'></font>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set cip'<a name='4605'>
      <a name='4606'>
      IF ( li .gt. 1 .and. ( ildo == 0 .or. ildo == li ) ) THEN<a name='4607'>
      do mgs = 1,ngscnt<a name='4608'>
       xdn(mgs,li)  = 900.0<a name='4609'>
      IF ( ipconc .eq. 0 ) THEN<a name='4610'>
<font color=#447700>!       cx(mgs,li) = min(cnit*exp(-temcg(mgs)*bta1),1.e+09)<a name='4611'></font>
        cx(mgs,li) = cnina(mgs)<a name='4612'>
       IF ( cimna .gt. 1.0 ) THEN<a name='4613'>
         cx(mgs,li) = Max(cimna,cx(mgs,li))<a name='4614'>
       ENDIF<a name='4615'>
       IF ( cimxa .gt. 1.0 ) THEN<a name='4616'>
         cx(mgs,li) = Min(cimxa,cx(mgs,li))<a name='4617'>
       ENDIF<a name='4618'>
<font color=#447700>! erm 3/28/2002<a name='4619'></font>
       IF ( itype1a .ge. 1 .or. itype2a .ge. 1 ) THEN<a name='4620'>
        cx(mgs,li) = Max(cx(mgs,li),qx(mgs,li)*rho0(mgs)/cimasx)<a name='4621'>
        cx(mgs,li) = Min(cx(mgs,li),qx(mgs,li)*rho0(mgs)/cimasn)<a name='4622'>
       ENDIF<a name='4623'>
<font color=#447700>!<a name='4624'></font>
       cx(mgs,li) = max(1.0e-20,cx(mgs,li))<a name='4625'>
<font color=#447700>!       cx(mgs,li) = Min(ccimx, cx(mgs,li))<a name='4626'></font>
<a name='4627'>
      <a name='4628'>
      ELSEIF ( ipconc .ge. 1 ) THEN<a name='4629'>
        IF ( qx(mgs,li) .gt. qxmin(li) ) THEN<a name='4630'>
         cx(mgs,li) = Max(cx(mgs,li),qx(mgs,li)*rho0(mgs)/cimasx)<a name='4631'>
         cx(mgs,li) = Min(cx(mgs,li),qx(mgs,li)*rho0(mgs)/cimasn)<a name='4632'>
<font color=#447700>!         cx(mgs,li) = Max(1.0,cx(mgs,li))<a name='4633'></font>
        ENDIF<a name='4634'>
      ENDIF<a name='4635'>
      <a name='4636'>
      IF ( qx(mgs,li) .gt. qxmin(li) ) THEN<a name='4637'>
      xmas(mgs,li) = &amp;<a name='4638'>
     &amp;     max( qx(mgs,li)*rho0(mgs)/cx(mgs,li), cimasn )<a name='4639'>
<font color=#447700>!     &amp;  min( max(qx(mgs,li)*rho0(mgs)/cx(mgs,li),cimasn),cimasx )<a name='4640'></font>
      <a name='4641'>
<font color=#447700>!      if ( temcg(mgs) .gt. 0.0 ) then<a name='4642'></font>
<font color=#447700>!      xdia(mgs,li,1) = 0.0<a name='4643'></font>
<font color=#447700>!      else<a name='4644'></font>
      if ( xmas(mgs,li) .gt. 0.0 ) THEN <font color=#447700>! cimasn ) then<a name='4645'></font>
<font color=#447700>!c      xdia(mgs,li,1) = 0.4892*(xmas(mgs,li)**(0.4554))<a name='4646'></font>
<font color=#447700>!       xdia(mgs,li,1) = 0.1871*(xmas(mgs,li)**(0.3429))<a name='4647'></font>
<a name='4648'>
<font color=#447700>!       xdia(mgs,li,1) = (132.694*5.40662/xmas(mgs,li))**(-1./2.9163)  ! for inverse exponential distribution<a name='4649'></font>
       IF ( ixtaltype == 1 ) THEN <font color=#447700>! column<a name='4650'></font>
       xdia(mgs,li,1) = 0.1871*(xmas(mgs,li)**(0.3429))<a name='4651'>
       xdia(mgs,li,3) = 0.1871*(xmas(mgs,li)**(0.3429))<a name='4652'>
       ELSEIF  ( ixtaltype == 2 ) THEN <font color=#447700>! disk<a name='4653'></font>
        xdia(mgs,li,1) = 0.277823*xmas(mgs,li)**0.359971<a name='4654'>
        xdia(mgs,li,3) = 0.277823*xmas(mgs,li)**0.359971<a name='4655'>
       ENDIF<a name='4656'>
      end if<a name='4657'>
<font color=#447700>!      end if<a name='4658'></font>
<font color=#447700>!      xdia(mgs,li,1) = max(xdia(mgs,li,1), 5.e-6)<a name='4659'></font>
<font color=#447700>!      xdia(mgs,li,1) = min(xdia(mgs,li,1), 1000.e-6)<a name='4660'></font>
<a name='4661'>
       IF ( ipconc .ge. 0 ) THEN<a name='4662'>
<font color=#447700>!      vtxbar(mgs,li,1) = rhovt(mgs)*49420.*40.0005/5.40662*xdia(mgs,li,1)**(1.415) ! mass-weighted<a name='4663'></font>
<font color=#447700>!      vtxbar(mgs,li,1) = (4.942e4)*(xdia(mgs,li,1)**(1.4150))<a name='4664'></font>
        xv(mgs,li) = xmas(mgs,li)/xdn(mgs,li)<a name='4665'>
        IF ( ixtaltype == 1 ) THEN <font color=#447700>! column<a name='4666'></font>
        tmp = (67056.6300748612*rhovt(mgs))/  &amp;<a name='4667'>
     &amp;   (((1.0 + cinu)/xv(mgs,li))**0.4716666666666667*gfcinu1)<a name='4668'>
        vtxbar(mgs,li,2) = tmp*gfcinu1p47<a name='4669'>
        vtxbar(mgs,li,1) = tmp*gfcinu2p47/(1. + cinu)<a name='4670'>
        vtxbar(mgs,li,3) = vtxbar(mgs,li,1) <a name='4671'>
        ELSEIF  ( ixtaltype == 2 ) THEN <font color=#447700>! disk -- but just use column fall speed for now<a name='4672'></font>
        tmp = (67056.6300748612*rhovt(mgs))/  &amp;<a name='4673'>
     &amp;   (((1.0 + cinu)/xv(mgs,li))**0.4716666666666667*gfcinu1)<a name='4674'>
        vtxbar(mgs,li,2) = tmp*gfcinu1p47<a name='4675'>
        vtxbar(mgs,li,1) = tmp*gfcinu2p47/(1. + cinu)<a name='4676'>
        vtxbar(mgs,li,3) = vtxbar(mgs,li,1) <a name='4677'>
        <a name='4678'>
        ENDIF<a name='4679'>
<font color=#447700>!      vtxbar(mgs,li,1) = vtxbar(mgs,li,2)*(1.+cinu)/(1. + cinu)<a name='4680'></font>
<font color=#447700>!      xdn(mgs,li)   = min(max(769.8*xdia(mgs,li,1)**(-0.0140),300.0),900.0)<a name='4681'></font>
<font color=#447700>!      xdn(mgs,li) = 900.0<a name='4682'></font>
        xdia(mgs,li,2) = xdia(mgs,li,1)**2<a name='4683'>
<font color=#447700>!      vtxbar(mgs,li,1) = vtxbar(mgs,li,1)*rhovt(mgs)<a name='4684'></font>
       ELSE<a name='4685'>
         xdia(mgs,li,1) = max(xdia(mgs,li,1), 10.e-6)<a name='4686'>
         xdia(mgs,li,1) = min(xdia(mgs,li,1), 1000.e-6)<a name='4687'>
         vtxbar(mgs,li,1) = (4.942e4)*(xdia(mgs,li,1)**(1.4150))<a name='4688'>
<font color=#447700>!      xdn(mgs,li)   = min(max(769.8*xdia(mgs,li,1)**(-0.0140),300.0),900.0)<a name='4689'></font>
         xdn(mgs,li) = 900.0<a name='4690'>
         xdia(mgs,li,2) = xdia(mgs,li,1)**2<a name='4691'>
         vtxbar(mgs,li,1) = vtxbar(mgs,li,1)*rhovt(mgs)<a name='4692'>
         xv(mgs,li) = xmas(mgs,li)/xdn(mgs,li)<a name='4693'>
       ENDIF <font color=#447700>! ipconc gt 3<a name='4694'></font>
      ELSE<a name='4695'>
       xmas(mgs,li) = 1.e-13<a name='4696'>
       xdn(mgs,li)  = 900.0<a name='4697'>
       xdia(mgs,li,1) = 1.e-7<a name='4698'>
       xdia(mgs,li,2) = (1.e-14)<a name='4699'>
       xdia(mgs,li,3) = 1.e-7<a name='4700'>
       vtxbar(mgs,li,1) = 0.0<a name='4701'>
<font color=#447700>!       cicap(mgs) = 0.0<a name='4702'></font>
<font color=#447700>!       ciat(mgs) = 0.0<a name='4703'></font>
      ENDIF<a name='4704'>
      end do<a name='4705'>
      <a name='4706'>
      ENDIF <font color=#447700>! li .gt. 1<a name='4707'></font>
<a name='4708'>
<a name='4709'>
<font color=#447700>! ################################################################<a name='4710'></font>
<font color=#447700>!<a name='4711'></font>
<font color=#447700>!  RAIN<a name='4712'></font>
<font color=#447700>!<a name='4713'></font>
      <a name='4714'>
<font color=#447700>!<a name='4715'></font>
      IF ( ildo == 0 .or. ildo == lr ) THEN<a name='4716'>
      do mgs = 1,ngscnt<a name='4717'>
      if ( qx(mgs,lr) .gt. qxmin(lr) ) then<a name='4718'>
      <a name='4719'>
<font color=#447700>!      IF ( qx(mgs,lr) .gt. 10.0e-3 ) &amp;<a name='4720'></font>
<font color=#447700>!     &amp;  write(0,*)  'RAIN1: ',igs(mgs),kgs(mgs),qx(mgs,lr)<a name='4721'></font>
      <a name='4722'>
      if ( ipconc .ge. 3 ) then<a name='4723'>
        xv(mgs,lr) = rho0(mgs)*qx(mgs,lr)/(xdn(mgs,lr)*Max(1.0e-11,cx(mgs,lr)))<a name='4724'>
        xvbarmax = xvmx(lr)<a name='4725'>
        IF ( imaxdiaopt == 1 ) THEN<a name='4726'>
          xvbarmax = xvmx(lr)<a name='4727'>
        ELSEIF ( imaxdiaopt == 2 ) THEN <font color=#447700>! test against maximum mass diameter<a name='4728'></font>
         IF ( imurain == 1 ) THEN<a name='4729'>
           xvbarmax = xvmx(lr)/((3. + alpha(mgs,lr))**3/((3. + alpha(mgs,lr))*(2. + alpha(mgs,lr))*(1. + alpha(mgs,lr))))<a name='4730'>
         ELSEIF ( imurain == 3 ) THEN<a name='4731'>
           <a name='4732'>
         ENDIF<a name='4733'>
        ELSEIF ( imaxdiaopt == 3 ) THEN <font color=#447700>! test against mass-weighted diameter<a name='4734'></font>
         IF ( imurain == 1 ) THEN<a name='4735'>
           xvbarmax = xvmx(lr)/((4. + alpha(mgs,lr))**3/((3. + alpha(mgs,lr))*(2. + alpha(mgs,lr))*(1. + alpha(mgs,lr))))<a name='4736'>
         ELSEIF ( imurain == 3 ) THEN<a name='4737'>
           <a name='4738'>
         ENDIF<a name='4739'>
        ENDIF<a name='4740'>
       <a name='4741'>
        IF ( xv(mgs,lr) .gt. xvbarmax ) THEN<a name='4742'>
          xv(mgs,lr) = xvbarmax<a name='4743'>
          cx(mgs,lr) = rho0(mgs)*qx(mgs,lr)/(xvbarmax*xdn(mgs,lr))<a name='4744'>
        ELSEIF ( xv(mgs,lr) .lt. xvmn(lr) ) THEN<a name='4745'>
          xv(mgs,lr) = xvmn(lr)<a name='4746'>
          cx(mgs,lr) = rho0(mgs)*qx(mgs,lr)/(xvmn(lr)*xdn(mgs,lr))<a name='4747'>
        ENDIF<a name='4748'>
<a name='4749'>
<a name='4750'>
        xmas(mgs,lr) = xv(mgs,lr)*xdn(mgs,lr)<a name='4751'>
        xdia(mgs,lr,3) = (xmas(mgs,lr)*cwc1)**(1./3.) <font color=#447700>! xdia(mgs,lr,1)<a name='4752'></font>
        IF ( imurain == 3 ) THEN<a name='4753'>
<font color=#447700>!          xdia(mgs,lr,1) = (6.*pii*xv(mgs,lr)/(alpha(mgs,lr)+1.))**(1./3.)<a name='4754'></font>
          xdia(mgs,lr,1) = xdia(mgs,lr,3) <font color=#447700>! formulae for Ziegler (1985) use mean volume diameter, not lambda**(-1)<a name='4755'></font>
        ELSE <font color=#447700>! imurain == 1, Characteristic diameter (1/lambda)<a name='4756'></font>
          xdia(mgs,lr,1) = (6.*pii*xv(mgs,lr)/((alpha(mgs,lr)+3.)*(alpha(mgs,lr)+2.)*(alpha(mgs,lr)+1.)))**(1./3.)<a name='4757'>
        ENDIF<a name='4758'>
<font color=#447700>!        rwrad(mgs) = 0.5*xdia(mgs,lr,1)<a name='4759'></font>
<a name='4760'>
<font color=#447700>! Inverse exponential version:<a name='4761'></font>
<font color=#447700>!        xdia(mgs,lr,1) =<a name='4762'></font>
<font color=#447700>!     &amp;  (qx(mgs,lr)*rho0(mgs)<a name='4763'></font>
<font color=#447700>!     &amp; /(pi*xdn(mgs,lr)*cx(mgs,lr)))**(0.333333)<a name='4764'></font>
      ELSE<a name='4765'>
        xdia(mgs,lr,1) = &amp;<a name='4766'>
     &amp;  (qx(mgs,lr)*rho0(mgs)/(pi*xdn(mgs,lr)*cno(lr)))**(0.25) <a name='4767'>
        xmas(mgs,lr) = xdn(mgs,lr)*(pi/6.)*xdia(mgs,lr,1)**3<a name='4768'>
        xdia(mgs,lr,3) = (xmas(mgs,lr)*cwc1)**(1./3.)<a name='4769'>
        cx(mgs,lr) = cno(lr)*xdia(mgs,lr,1)<a name='4770'>
        xv(mgs,lr) = rho0(mgs)*qx(mgs,lr)/(xdn(mgs,lr)*cx(mgs,lr))<a name='4771'>
      end if<a name='4772'>
      else<a name='4773'>
        xdia(mgs,lr,1) = 1.e-9<a name='4774'>
        xdia(mgs,lr,3) = 1.e-9<a name='4775'>
        xmas(mgs,lr) = xdn(mgs,lr)*(pi/6.)*xdia(mgs,lr,1)**3<a name='4776'>
<font color=#447700>!        rwrad(mgs) = 0.5*xdia(mgs,lr,1)<a name='4777'></font>
      end if<a name='4778'>
      xdia(mgs,lr,2) = xdia(mgs,lr,1)**2<a name='4779'>
<font color=#447700>!      xmas(mgs,lr) = xdn(mgs,lr)*(pi/6.)*xdia(mgs,lr,1)**3<a name='4780'></font>
      end do<a name='4781'>
      <a name='4782'>
      ENDIF<a name='4783'>
<font color=#447700>! ################################################################<a name='4784'></font>
<font color=#447700>!<a name='4785'></font>
<font color=#447700>!  SNOW<a name='4786'></font>
<font color=#447700>!<a name='4787'></font>
<a name='4788'>
      IF ( ls .gt. 1 .and. ( ildo == 0 .or. ildo == ls ) ) THEN<a name='4789'>
      <a name='4790'>
      do mgs = 1,ngscnt <a name='4791'>
      if ( qx(mgs,ls) .gt. qxmin(ls) ) then<a name='4792'>
      if ( ipconc .ge. 4 ) then <font color=#447700>! <a name='4793'></font>
<a name='4794'>
<font color=#447700>!        xv(mgs,ls) = rho0(mgs)*qx(mgs,ls)/(xdn(mgs,ls)*Max(1.0e-9,cx(mgs,ls)))<a name='4795'></font>
<font color=#447700>!      parameter( xvmn(lr)=2.8866e-13, xvmx(lr)=4.1887e-9 )  ! mks<a name='4796'></font>
<font color=#447700>!        xmas(mgs,ls) = xv(mgs,ls)*xdn(mgs,ls)<a name='4797'></font>
<a name='4798'>
        xmas(mgs,ls) =  rho0(mgs)*qx(mgs,ls)/(Max(1.0e-9,cx(mgs,ls)))<a name='4799'>
<a name='4800'>
        IF ( isnowdens == 2 ) THEN <font color=#447700>! Set values according to Cox relationship<a name='4801'></font>
        <a name='4802'>
          xdn(mgs,ls) = 0.0346159*Sqrt(cx(mgs,ls)/(qx(mgs,ls)*rho0(mgs)) )<a name='4803'>
          xdn(mgs,ls) = Max( 100.0, xdn(mgs,ls) )  <font color=#447700>! limit snow to 100. to keep other equations in line<a name='4804'></font>
          <a name='4805'>
          IF ( xdn(mgs,ls) &lt;= 900. ) THEN<a name='4806'>
             dtmp = Sqrt( xmas(mgs,ls)/0.069 ) <font color=#447700>! diameter (meters) of mean mass particle using Cox 1998 relation (m = p d^2)<a name='4807'></font>
             xv(mgs,ls) = 28.8887*xmas(mgs,ls)**(3./2.)<a name='4808'>
          ELSE <font color=#447700>! at small sizes, assume ice spheres<a name='4809'></font>
             xdn(mgs,ls) = 900.<a name='4810'>
             xv(mgs,ls) = rho0(mgs)*qx(mgs,ls)/(xdn(mgs,ls)*Max(1.0e-9,cx(mgs,ls)))<a name='4811'>
             dtmp = (xv(mgs,ls)*cwc0*6.0)**(1./3.)<a name='4812'>
          ENDIF<a name='4813'>
          <a name='4814'>
        ELSE <font color=#447700>! leave xdn(ls) at default value<a name='4815'></font>
             xv(mgs,ls) = rho0(mgs)*qx(mgs,ls)/(xdn(mgs,ls)*Max(1.0e-9,cx(mgs,ls)))<a name='4816'>
             dtmp = (xv(mgs,ls)*cwc0*6.0)**(1./3.)<a name='4817'>
        ENDIF<a name='4818'>
<a name='4819'>
        xdia(mgs,ls,1) = dtmp <font color=#447700>! (xv(mgs,ls)*cwc0*6.0)**(1./3.)<a name='4820'></font>
<a name='4821'>
        IF ( xv(mgs,ls) .lt. xvmn(ls) .and. isnowdens == 1) THEN<a name='4822'>
          xv(mgs,ls) = Max( xvmn(ls),xv(mgs,ls) )<a name='4823'>
          xmas(mgs,ls) = xv(mgs,ls)*xdn(mgs,ls)<a name='4824'>
          cx(mgs,ls) = rho0(mgs)*qx(mgs,ls)/(xmas(mgs,ls))<a name='4825'>
          xdia(mgs,ls,1) = (xv(mgs,ls)*cwc0*6.0)**(1./3.)<a name='4826'>
        ENDIF<a name='4827'>
<a name='4828'>
        IF ( xv(mgs,ls) .gt. xvmx(ls)*Max(1.,100./Min(100.,xdn(mgs,ls))) ) THEN<a name='4829'>
          xv(mgs,ls) = Min( xvmx(ls), Max( xvmn(ls),xv(mgs,ls) ) )<a name='4830'>
          xmas(mgs,ls) = 0.106214*xv(mgs,ls)**(2./3.)<a name='4831'>
          cx(mgs,ls) = rho0(mgs)*qx(mgs,ls)/(xmas(mgs,ls))<a name='4832'>
          xdn(mgs,ls) = 0.0346159*Sqrt(cx(mgs,ls)/(qx(mgs,ls)*rho0(mgs)) )<a name='4833'>
          xdia(mgs,ls,1) = Sqrt( xmas(mgs,ls)/0.069 ) <a name='4834'>
        ENDIF<a name='4835'>
<a name='4836'>
        xdia(mgs,ls,1) = (xv(mgs,ls)*cwc0*6.0)**(1./3.)<a name='4837'>
        xdia(mgs,ls,3) = xdia(mgs,ls,1)<a name='4838'>
<a name='4839'>
      ELSE<a name='4840'>
        xdia(mgs,ls,1) =  &amp;<a name='4841'>
     &amp;    (qx(mgs,ls)*rho0(mgs)/(pi*xdn(mgs,ls)*cnostmp(mgs)))**(0.25) <a name='4842'>
        cx(mgs,ls) = cnostmp(mgs)*xdia(mgs,ls,1)<a name='4843'>
        xv(mgs,ls) = rho0(mgs)*qx(mgs,ls)/(xdn(mgs,ls)*cx(mgs,ls))<a name='4844'>
        xdia(mgs,ls,3) = (xv(mgs,ls)*cwc0*6.0)**(1./3.)<a name='4845'>
      end if<a name='4846'>
      else<a name='4847'>
      xdia(mgs,ls,1) = 1.e-9<a name='4848'>
      xdia(mgs,ls,3) = 1.e-9<a name='4849'>
      cx(mgs,ls) = 0.0<a name='4850'>
      <a name='4851'>
       IF ( isnowdens == 2 ) THEN <font color=#447700>! Set values according to Cox relationship<a name='4852'></font>
         xdn(mgs,ls) = 90.<a name='4853'>
       ENDIF<a name='4854'>
<a name='4855'>
      end if<a name='4856'>
      xdia(mgs,ls,2) = xdia(mgs,ls,1)**2<a name='4857'>
<font color=#447700>!      swdia3(mgs) = xdia(mgs,ls,2)*xdia(mgs,ls,1)<a name='4858'></font>
<font color=#447700>!      xmas(mgs,ls) = xdn(mgs,ls)*(pi/6.)*swdia3(mgs)<a name='4859'></font>
      end do<a name='4860'>
      <a name='4861'>
      ENDIF <font color=#447700>! ls .gt 1<a name='4862'></font>
<font color=#447700>!<a name='4863'></font>
<font color=#447700>!<a name='4864'></font>
<font color=#447700>! ################################################################<a name='4865'></font>
<font color=#447700>!<a name='4866'></font>
<font color=#447700>!  GRAUPEL<a name='4867'></font>
<font color=#447700>!<a name='4868'></font>
<a name='4869'>
      IF ( lh .gt. 1 .and. ( ildo == 0 .or. ildo == lh ) ) THEN<a name='4870'>
      <a name='4871'>
      do mgs = 1,ngscnt <a name='4872'>
      if ( qx(mgs,lh) .gt. qxmin(lh) ) then<a name='4873'>
      if ( ipconc .ge. 5 ) then<a name='4874'>
<a name='4875'>
        xv(mgs,lh) = rho0(mgs)*qx(mgs,lh)/(xdn(mgs,lh)*Max(1.0e-9,cx(mgs,lh)))<a name='4876'>
        xmas(mgs,lh) = xv(mgs,lh)*xdn(mgs,lh)<a name='4877'>
<a name='4878'>
        IF ( xv(mgs,lh) .lt. xvmn(lh) .or. xv(mgs,lh) .gt. xvmx(lh) ) THEN<a name='4879'>
          xv(mgs,lh) = Min( xvmx(lh), Max( xvmn(lh),xv(mgs,lh) ) )<a name='4880'>
          xmas(mgs,lh) = xv(mgs,lh)*xdn(mgs,lh)<a name='4881'>
          cx(mgs,lh) = rho0(mgs)*qx(mgs,lh)/(xmas(mgs,lh))<a name='4882'>
        ENDIF<a name='4883'>
<a name='4884'>
         xdia(mgs,lh,3) = (xv(mgs,lh)*6.*pii)**(1./3.) <font color=#447700>! mwfac*xdia(mgs,lh,1) ! (xv(mgs,lh)*cwc0*6.0)**(1./3.)<a name='4885'></font>
         IF ( dmuh == 1.0 ) THEN<a name='4886'>
           xdia(mgs,lh,1) = cwch(mgs)*xdia(mgs,lh,3)<a name='4887'>
         ELSE<a name='4888'>
           xdia(mgs,lh,1) = (xv(mgs,lh)*cwch(mgs))**(1./3.)<a name='4889'>
         ENDIF<a name='4890'>
<a name='4891'>
      ELSE<a name='4892'>
      xdia(mgs,lh,1) =  &amp;<a name='4893'>
     &amp;  (qx(mgs,lh)*rho0(mgs)/(pi*xdn(mgs,lh)*cno(lh)))**(0.25) <a name='4894'>
      cx(mgs,lh) = cno(lh)*xdia(mgs,lh,1)<a name='4895'>
      xv(mgs,lh) = Max(xvmn(lh), rho0(mgs)*qx(mgs,lh)/(xdn(mgs,lh)*cx(mgs,lh)) )<a name='4896'>
      xdia(mgs,lh,3) = (xv(mgs,lh)*6./pi)**(1./3.) <a name='4897'>
      end if<a name='4898'>
      else<a name='4899'>
      xdia(mgs,lh,1) = 1.e-9<a name='4900'>
      xdia(mgs,lh,3) = 1.e-9<a name='4901'>
      end if<a name='4902'>
      xdia(mgs,lh,2) = xdia(mgs,lh,1)**2<a name='4903'>
<font color=#447700>!      hwdia3(mgs) = xdia(mgs,lh,2)*xdia(mgs,lh,1)<a name='4904'></font>
<font color=#447700>!      xmas(mgs,lh) = xdn(mgs,lh)*(pi/6.)*hwdia3(mgs)<a name='4905'></font>
      end do<a name='4906'>
      <a name='4907'>
      ENDIF<a name='4908'>
<a name='4909'>
<font color=#447700>!<a name='4910'></font>
<font color=#447700>! ################################################################<a name='4911'></font>
<font color=#447700>!<a name='4912'></font>
<font color=#447700>!  HAIL<a name='4913'></font>
<font color=#447700>!<a name='4914'></font>
<a name='4915'>
      IF ( lhl .gt. 1 .and. ( ildo == 0 .or. ildo == lhl ) ) THEN<a name='4916'>
      <a name='4917'>
      do mgs = 1,ngscnt <a name='4918'>
      if ( qx(mgs,lhl) .gt. qxmin(lhl) ) then<a name='4919'>
      if ( ipconc .ge. 5 ) then<a name='4920'>
<a name='4921'>
        xv(mgs,lhl) = rho0(mgs)*qx(mgs,lhl)/(xdn(mgs,lhl)*Max(1.0e-9,cx(mgs,lhl)))<a name='4922'>
        xmas(mgs,lhl) = xv(mgs,lhl)*xdn(mgs,lhl)<a name='4923'>
<font color=#447700>!        write(0,*) 'setvt: xv = ',xv(mgs,lhl),xdn(mgs,lhl),cx(mgs,lhl),xmas(mgs,lhl),qx(mgs,lhl)<a name='4924'></font>
<a name='4925'>
        IF ( xv(mgs,lhl) .lt. xvmn(lhl) .or. xv(mgs,lhl) .gt. xvmx(lhl) ) THEN<a name='4926'>
          xv(mgs,lhl) = Min( xvmx(lhl), Max( xvmn(lhl),xv(mgs,lhl) ) )<a name='4927'>
          xmas(mgs,lhl) = xv(mgs,lhl)*xdn(mgs,lhl)<a name='4928'>
          cx(mgs,lhl) = rho0(mgs)*qx(mgs,lhl)/(xmas(mgs,lhl))<a name='4929'>
        ENDIF<a name='4930'>
<a name='4931'>
        xdia(mgs,lhl,3) = (xv(mgs,lhl)*6./pi)**(1./3.) <font color=#447700>! mwfac*xdia(mgs,lh,1) ! (xv(mgs,lh)*cwc0*6.0)**(1./3.)<a name='4932'></font>
         IF ( dmuhl == 1.0 ) THEN<a name='4933'>
           xdia(mgs,lhl,1) = cwchl(mgs)*xdia(mgs,lhl,3)<a name='4934'>
         ELSE<a name='4935'>
           xdia(mgs,lhl,1) = (xv(mgs,lhl)*cwchl(mgs))**(1./3.)<a name='4936'>
         ENDIF<a name='4937'>
        <a name='4938'>
<font color=#447700>!        write(0,*) 'setvt: xv = ',xv(mgs,lhl),xdn(mgs,lhl),cx(mgs,lhl),xdia(mgs,lhl,3)<a name='4939'></font>
      ELSE<a name='4940'>
      xdia(mgs,lhl,1) = &amp;<a name='4941'>
     &amp;  (qx(mgs,lhl)*rho0(mgs)/(pi*xdn(mgs,lhl)*cno(lhl)))**(0.25) <a name='4942'>
      cx(mgs,lhl) = cno(lhl)*xdia(mgs,lhl,1)<a name='4943'>
      xv(mgs,lhl) = Max(xvmn(lhl), rho0(mgs)*qx(mgs,lhl)/(xdn(mgs,lhl)*cx(mgs,lhl)) )<a name='4944'>
      xdia(mgs,lhl,3) = (xv(mgs,lhl)*6./pi)**(1./3.) <a name='4945'>
      end if<a name='4946'>
      else<a name='4947'>
      xdia(mgs,lhl,1) = 1.e-9<a name='4948'>
      xdia(mgs,lhl,3) = 1.e-9<a name='4949'>
      end if<a name='4950'>
      xdia(mgs,lhl,2) = xdia(mgs,lhl,1)**2<a name='4951'>
<font color=#447700>!      hwdia3(mgs) = xdia(mgs,lh,2)*xdia(mgs,lh,1)<a name='4952'></font>
<font color=#447700>!      xmas(mgs,lh) = xdn(mgs,lh)*(pi/6.)*hwdia3(mgs)<a name='4953'></font>
      end do<a name='4954'>
      <a name='4955'>
      ENDIF<a name='4956'>
<font color=#447700>!      <a name='4957'></font>
<font color=#447700>!<a name='4958'></font>
<font color=#447700>!<a name='4959'></font>
<font color=#447700>!  Set terminal velocities...<a name='4960'></font>
<font color=#447700>!    also set drag coefficients (moved to start of subroutine)<a name='4961'></font>
<font color=#447700>!<a name='4962'></font>
<font color=#447700>!      cdx(lr) = 0.60<a name='4963'></font>
<font color=#447700>!      cdx(lh) = 0.45<a name='4964'></font>
<font color=#447700>!      cdx(lhl) = 0.45<a name='4965'></font>
<font color=#447700>!      cdx(lf) = 0.45<a name='4966'></font>
<font color=#447700>!      cdx(lgh) = 0.60<a name='4967'></font>
<font color=#447700>!      cdx(lgm) = 0.80<a name='4968'></font>
<font color=#447700>!      cdx(lgl) = 0.80<a name='4969'></font>
<font color=#447700>!      cdx(lir) = 2.00<a name='4970'></font>
<font color=#447700>!<a name='4971'></font>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set terminal velocities'<a name='4972'>
<font color=#447700>!<a name='4973'></font>
<font color=#447700>!<a name='4974'></font>
<font color=#447700>! ################################################################<a name='4975'></font>
<font color=#447700>!<a name='4976'></font>
<font color=#447700>!  RAIN<a name='4977'></font>
<font color=#447700>!<a name='4978'></font>
      IF ( ildo == 0 .or. ildo == lr ) THEN<a name='4979'>
      do mgs = 1,ngscnt<a name='4980'>
      if ( qx(mgs,lr) .gt. qxmin(lr) ) then<a name='4981'>
      IF ( ipconc .lt. 3 ) THEN<a name='4982'>
        vtxbar(mgs,lr,1) = rainfallfac*(ar*gf4br/6.0)*(xdia(mgs,lr,1)**br)*rhovt(mgs)<a name='4983'>
<font color=#447700>!        write(91,*) 'vtxbar: ',vtxbar(mgs,lr,1),mgs,gf4br,xdia(mgs,lr,1),rhovt(mgs)<a name='4984'></font>
      ELSE<a name='4985'>
        <a name='4986'>
        IF ( imurain == 1 ) THEN <font color=#447700>! DSD of Diameter<a name='4987'></font>
        <a name='4988'>
        <font color=#447700>! using functional form of  arx*(1 - Exp(-frx*diameter) ), with arx =       arx = 10.<a name='4989'></font>
        <font color=#447700>!  and frx = 516.575 ! raind fit parameters for arx*(1 - Exp(-fx*d)), where d is rain diameter in meters.<a name='4990'></font>
<a name='4991'>
        <a name='4992'>
          alp = alpha(mgs,lr)<a name='4993'>
          <a name='4994'>
          vtxbar(mgs,lr,1) = rhovt(mgs)*arx*(1.0 - (1.0 + frx*xdia(mgs,lr,1))**(-alp - 4.0) ) <font color=#447700>! mass weighted<a name='4995'></font>
          <a name='4996'>
          IF ( infdo .ge. 1 .and. rssflg == 1 ) THEN<a name='4997'>
            vtxbar(mgs,lr,2) = rhovt(mgs)*arx*(1.0 - (1.0 + frx*xdia(mgs,lr,1))**(-alp - 1.0) ) <font color=#447700>! number weighted<a name='4998'></font>
          ELSE<a name='4999'>
            vtxbar(mgs,lr,2) = vtxbar(mgs,lr,1)<a name='5000'>
          ENDIF<a name='5001'>
          <a name='5002'>
          IF ( infdo .ge. 2 .and. rssflg == 1 ) THEN<a name='5003'>
            vtxbar(mgs,lr,3) = rhovt(mgs)*arx*(1.0 - (1.0 + frx*xdia(mgs,lr,1))**(-alp - 7.0) ) <font color=#447700>! z-weighted<a name='5004'></font>
          ELSE<a name='5005'>
            vtxbar(mgs,lr,3) = vtxbar(mgs,lr,1)<a name='5006'>
          ENDIF<a name='5007'>
          <a name='5008'>
<font color=#447700>!          write(91,*) 'setvt: alp,vn,vm,vz = ',alp,vtxbar(mgs,lr,2), vtxbar(mgs,lr,1), vtxbar(mgs,lr,3),alpha(mgs,lr)<a name='5009'></font>
<a name='5010'>
        ELSEIF ( imurain == 3 ) THEN <font color=#447700>! DSD of Volume<a name='5011'></font>
        <a name='5012'>
        IF ( lzr &lt; 1 ) THEN <font color=#447700>! not 3-moment rain<a name='5013'></font>
        rwdia = Min( xdia(mgs,lr,1), 8.0e-3 )<a name='5014'>
        <a name='5015'>
         vtxbar(mgs,lr,1) = rhovt(mgs)*6.0*pii*( 0.04771 + 3788.0*rwdia -  &amp;<a name='5016'>
     &amp;        1.105e6*rwdia**2 + 1.412e8*rwdia**3 - 6.527e9*rwdia**4)<a name='5017'>
        <a name='5018'>
        IF ( infdo .ge. 1 ) THEN<a name='5019'>
         vtxbar(mgs,lr,2) = (0.09112 + 2714.0*rwdia - 4.872e5*rwdia**2 +  &amp;<a name='5020'>
     &amp;            4.495e7*rwdia**3 - 1.626e9*rwdia**4)*rhovt(mgs)<a name='5021'>
        ENDIF<a name='5022'>
        <a name='5023'>
        IF ( infdo .ge. 2 ) THEN <font color=#447700>! Z-weighted fall speed<a name='5024'></font>
        vtxbar(mgs,lr,3)  = rhovt(mgs)*(  &amp;<a name='5025'>
     &amp;       0.0911229 +                  &amp;<a name='5026'>
     &amp;  9246.494*(rwdia) -               &amp;<a name='5027'>
     &amp;  3.2839926e6*(rwdia**2) +          &amp;<a name='5028'>
     &amp;  4.944093e8*(rwdia**3) -          &amp;<a name='5029'>
     &amp;  2.631718e10*(rwdia**4) )<a name='5030'>
        ENDIF<a name='5031'>
        <a name='5032'>
        ELSE <font color=#447700>! 3-moment rain, gamma-volume<a name='5033'></font>
<a name='5034'>
        vr = xv(mgs,lr)<a name='5035'>
        rnux = alpha(mgs,lr)<a name='5036'>
        <a name='5037'>
        IF ( infdo .ge. 1 .and. rssflg == 1) THEN <font color=#447700>! number-weighted; DTD: added size-sorting flag<a name='5038'></font>
        vtxbar(mgs,lr,2) = rhovt(mgs)*                             &amp;<a name='5039'>
     &amp;     (((1. + rnux)/vr)**(-1.333333)*                         &amp;<a name='5040'>
     &amp;    (0.0911229*((1. + rnux)/vr)**1.333333*Gamma_sp(1. + rnux) + &amp;<a name='5041'>
     &amp;      (5430.3131*(1. + rnux)*Gamma_sp(4./3. + rnux))/           &amp;<a name='5042'>
     &amp;       vr - 1.0732802e6*((1. + rnux)/vr)**0.6666667*         &amp;<a name='5043'>
     &amp;       Gamma_sp(1.666667 + rnux) +                              &amp;<a name='5044'>
     &amp;      8.584110982429507e7*((1. + rnux)/vr)**(1./3.)*         &amp;<a name='5045'>
     &amp;       Gamma_sp(2. + rnux) -                                    &amp;<a name='5046'>
     &amp;      2.3303765697228556e9*Gamma_sp(7./3. + rnux)))/            &amp;<a name='5047'>
     &amp;  Gamma_sp(1. + rnux)<a name='5048'>
        ENDIF<a name='5049'>
<a name='5050'>
<font color=#447700>!  mass-weighted<a name='5051'></font>
       vtxbar(mgs,lr,1)  = rhovt(mgs)*                                                 &amp;<a name='5052'>
     &amp;   (0.0911229*(1 + rnux)**1.3333333333333333*Gamma_sp(2. + rnux) +                  &amp;<a name='5053'>
     &amp;    5430.313059683277*(1 + rnux)*vr**0.3333333333333333*                         &amp;<a name='5054'>
     &amp;     Gamma_sp(2.333333333333333 + rnux) -                                           &amp;<a name='5055'>
     &amp;    1.0732802065650471e6*(1 + rnux)**0.6666666666666666*vr**0.6666666666666666*  &amp;<a name='5056'>
     &amp;     Gamma_sp(2.6666666666666667 + rnux) +                                          &amp;<a name='5057'>
     &amp;    8.584110982429507e7*(1 + rnux)**0.3333333333333333*vr*Gamma_sp(3 + rnux) -      &amp;<a name='5058'>
     &amp;    2.3303765697228556e9*vr**1.3333333333333333*                                 &amp;<a name='5059'>
     &amp;     Gamma_sp(3.333333333333333 + rnux))/                                           &amp;<a name='5060'>
     &amp;  ((1 + rnux)**2.333333333333333*Gamma_sp(1 + rnux)) <a name='5061'>
     <a name='5062'>
        IF(infdo .ge. 1 .and. rssflg == 0) THEN <font color=#447700>! No size-sorting, set N-weighted fall speed to mass-weighted<a name='5063'></font>
          vtxbar(mgs,lr,2) = vtxbar(mgs,lr,1)<a name='5064'>
        ENDIF     <a name='5065'>
      <a name='5066'>
        IF ( infdo .ge. 2 .and. rssflg == 1) THEN <font color=#447700>! Z-weighted fall speed<a name='5067'></font>
        vtxbar(mgs,lr,3)  =   rhovt(mgs)*                                          &amp;<a name='5068'>
     &amp;  ((1. + rnux)*(0.0911229*(1 + rnux)**1.3333333333333333*Gamma_sp(3. + rnux) +  &amp;<a name='5069'>
     &amp;      5430.313059683277*(1 + rnux)*vr**0.3333333333333333*                   &amp;<a name='5070'>
     &amp;       Gamma_sp(3.3333333333333335 + rnux) -                                    &amp;<a name='5071'>
     &amp;      1.0732802065650471e6*(1 + rnux)**0.6666666666666666*                   &amp;<a name='5072'>
     &amp;       vr**0.6666666666666666*Gamma_sp(3.6666666666666665 + rnux) +             &amp;<a name='5073'>
     &amp;      8.5841109824295e7*(1 + rnux)**0.3333333333333333*vr*Gamma_sp(4. + rnux) - &amp;<a name='5074'>
     &amp;      2.3303765697228556e9*vr**1.3333333333333333*                           &amp;<a name='5075'>
     &amp;       Gamma_sp(4.333333333333333 + rnux)))/                                    &amp;<a name='5076'>
     &amp;  ((1 + rnux)**3.3333333333333335*(2 + rnux)*Gamma_sp(1 + rnux))<a name='5077'>
        <a name='5078'>
<font color=#447700>!         write(0,*) 'setvt: mgs,lzr,infdo = ',mgs,lzr,infdo<a name='5079'></font>
<font color=#447700>!         write(0,*) 'vt1,2,3 = ',vtxbar(mgs,lr,1),vtxbar(mgs,lr,2),vtxbar(mgs,lr,3)<a name='5080'></font>
        <a name='5081'>
        ELSEIF (infdo .ge. 2) THEN <font color=#447700>! No size-sorting, set Z-weighted fall speed to mass-weighted<a name='5082'></font>
          vtxbar(mgs,lr,3) = vtxbar(mgs,lr,1)<a name='5083'>
        ENDIF<a name='5084'>
        <a name='5085'>
        <a name='5086'>
        ENDIF<a name='5087'>
       ENDIF <font color=#447700>! imurain<a name='5088'></font>
<a name='5089'>
<font color=#447700>!        IF ( rwrad*mwfac .gt. 6.0e-4  ) THEN<a name='5090'></font>
<font color=#447700>!          vtxbar(mgs,lr,1) = 20.1*Sqrt(100.*rwrad*mwfac)*rhovt(mgs)<a name='5091'></font>
<font color=#447700>!        ELSE<a name='5092'></font>
<font color=#447700>!          vtxbar(mgs,lr,1) = 80.0e2*rwrad*rhovt(mgs)*mwfac<a name='5093'></font>
<font color=#447700>!        ENDIF<a name='5094'></font>
<font color=#447700>!        IF ( rwrad .gt. 6.0e-4  ) THEN<a name='5095'></font>
<font color=#447700>!          vtxbar(mgs,lr,2) = 20.1*Sqrt(100.*rwrad)*rhovt(mgs)<a name='5096'></font>
<font color=#447700>!        ELSE<a name='5097'></font>
<font color=#447700>!          vtxbar(mgs,lr,2) = 80.0e2*rwrad*rhovt(mgs)<a name='5098'></font>
<font color=#447700>!        ENDIF<a name='5099'></font>
      ENDIF <font color=#447700>! ipconc<a name='5100'></font>
      else  <font color=#447700>! qr &lt; qrmin<a name='5101'></font>
      vtxbar(mgs,lr,1) = 0.0<a name='5102'>
      vtxbar(mgs,lr,2) = 0.0<a name='5103'>
      end if<a name='5104'>
      end do<a name='5105'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set rain vt'<a name='5106'>
      <a name='5107'>
      ENDIF<a name='5108'>
<font color=#447700>!<a name='5109'></font>
<font color=#447700>! ################################################################<a name='5110'></font>
<font color=#447700>!<a name='5111'></font>
<font color=#447700>!  SNOW !Zrnic et al. (1993)<a name='5112'></font>
<font color=#447700>!<a name='5113'></font>
      IF ( ls .gt. 1 .and. ( ildo == 0 .or. ildo == ls ) ) THEN<a name='5114'>
      do mgs = 1,ngscnt<a name='5115'>
      if ( qx(mgs,ls) .gt. qxmin(ls) ) then<a name='5116'>
        IF ( ipconc .ge. 4 ) THEN<a name='5117'>
         if ( mixedphase .and. qsvtmod ) then<a name='5118'>
         else<a name='5119'>
          IF ( isnowfall == 1 ) THEN<a name='5120'>
           <font color=#447700>! original (Zrnic et al. 1993)<a name='5121'></font>
           vtxbar(mgs,ls,1) = 5.72462*rhovt(mgs)*(xv(mgs,ls))**(1./12.)<a name='5122'>
          ELSEIF ( isnowfall == 2 ) THEN<a name='5123'>
          <font color=#447700>! Ferrier:<a name='5124'></font>
            IF ( isnowdens == 1 ) THEN<a name='5125'>
              vtxbar(mgs,ls,1) = 11.9495*rhovt(mgs)*(xv(mgs,ls))**(0.14)<a name='5126'>
            ELSE<a name='5127'>
              vtxbar(mgs,ls,1) = 11.9495*rhovt(mgs)*(xv(mgs,ls)*xdn(mgs,ls)/100.)**(0.14) <a name='5128'>
            ENDIF<a name='5129'>
          ENDIF<a name='5130'>
          <a name='5131'>
          IF(sssflg == 1) THEN<a name='5132'>
            IF ( isnowfall == 1 ) THEN<a name='5133'>
              vtxbar(mgs,ls,2) = 4.04091*rhovt(mgs)*(xv(mgs,ls))**(1./12.)<a name='5134'>
            ELSEIF ( isnowfall == 2 ) THEN<a name='5135'>
            <font color=#447700>! Ferrier:<a name='5136'></font>
              IF ( isnowdens == 1 ) THEN<a name='5137'>
                vtxbar(mgs,ls,2) = 7.02909*rhovt(mgs)*(xv(mgs,ls))**(0.14)  <font color=#447700>! bug fix 11/15/2015: was rewriting to mass fall speed vtxbar(mgs,ls,1)<a name='5138'></font>
              ELSE<a name='5139'>
                vtxbar(mgs,ls,2) = 7.02909*rhovt(mgs)*(xv(mgs,ls)*xdn(mgs,ls)/100.)**(0.14)  <font color=#447700>! bug fix 11/15/2015: was rewriting to mass fall speed vtxbar(mgs,ls,1)<a name='5140'></font>
              ENDIF<a name='5141'>
            ENDIF<a name='5142'>
          ELSE<a name='5143'>
            vtxbar(mgs,ls,2) = vtxbar(mgs,ls,1)<a name='5144'>
          ENDIF<a name='5145'>
          vtxbar(mgs,ls,3) = vtxbar(mgs,ls,1)<a name='5146'>
         endif<a name='5147'>
        ELSE<a name='5148'>
         vtxbar(mgs,ls,1) = (cs*gf4ds/6.0)*(xdia(mgs,ls,1)**ds)*rhovt(mgs)<a name='5149'>
         vtxbar(mgs,ls,2) = vtxbar(mgs,ls,1)<a name='5150'>
        ENDIF<a name='5151'>
      else<a name='5152'>
      vtxbar(mgs,ls,1) = 0.0<a name='5153'>
      end if<a name='5154'>
      end do<a name='5155'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set snow vt'<a name='5156'>
      <a name='5157'>
      ENDIF <font color=#447700>! ls .gt. 1<a name='5158'></font>
<font color=#447700>!<a name='5159'></font>
<font color=#447700>!<a name='5160'></font>
<font color=#447700>! ################################################################<a name='5161'></font>
<font color=#447700>!<a name='5162'></font>
<font color=#447700>!  GRAUPEL !Wisner et al. (1972)<a name='5163'></font>
<font color=#447700>!<a name='5164'></font>
      IF ( lh .gt. 1 .and. ( ildo == 0 .or. ildo == lh ) ) THEN<a name='5165'>
      <a name='5166'>
      do mgs = 1,ngscnt<a name='5167'>
      vtxbar(mgs,lh,1) = 0.0<a name='5168'>
      if ( qx(mgs,lh) .gt. qxmin(lh) ) then<a name='5169'>
       IF ( icdx .eq. 1 ) THEN<a name='5170'>
         cd = cdx(lh)<a name='5171'>
       ELSEIF ( icdx .eq. 2 ) THEN<a name='5172'>
<font color=#447700>!         cd = Max(0.6, Min(1.0, 0.6 + 0.4*(xdnmx(lh) - xdn(mgs,lh))/(xdnmx(lh)-xdnmn(lh)) ) )<a name='5173'></font>
<font color=#447700>!         cd = Max(0.6, Min(1.0, 0.6 + 0.4*(900.0 - xdn(mgs,lh))/(900. - 300.) ) )<a name='5174'></font>
         cd = Max(0.45, Min(1.0, 0.45 + 0.35*(800.0 - Max( 500., Min( 800.0, xdn(mgs,lh) ) ) )/(800. - 500.) ) )<a name='5175'>
<font color=#447700>!         cd = Max(0.55, Min(1.0, 0.55 + 0.25*(800.0 - Max( 500., Min( 800.0, xdn(mgs,lh) ) ) )/(800. - 500.) ) )<a name='5176'></font>
       ELSEIF ( icdx .eq. 3 ) THEN<a name='5177'>
<font color=#447700>!         cd = Max(0.45, Min(1.0, 0.45 + 0.55*(800.0 - Max( 300., Min( 800.0, xdn(mgs,lh) ) ) )/(800. - 300.) ) )<a name='5178'></font>
         cd = Max(0.45, Min(1.2, 0.45 + 0.55*(800.0 - Max( hdnmn, Min( 800.0, xdn(mgs,lh) ) ) )/(800. - 170.0) ) )<a name='5179'>
       ELSEIF ( icdx .eq. 4 ) THEN<a name='5180'>
         cd = Max(cdhmin, Min(cdhmax, cdhmin + (cdhmax-cdhmin)* &amp;<a name='5181'>
     &amp;        (cdhdnmax - Max( cdhdnmin, Min( cdhdnmax, xdn(mgs,lh) ) ) )/(cdhdnmax - cdhdnmin) ) )<a name='5182'>
       ELSEIF ( icdx .eq. 5 ) THEN<a name='5183'>
         cd = cdx(lh)*(xdn(mgs,lh)/rho_qh)**(2./3.)<a name='5184'>
       ELSEIF ( icdx .eq. 6 ) THEN <font color=#447700>! Milbrandt and Morrison (2013)<a name='5185'></font>
         indxr = Int( (xdn(mgs,lh)-50.)/100. ) + 1<a name='5186'>
         indxr = Min( ngdnmm, Max(1,indxr) )<a name='5187'>
         <a name='5188'>
         <a name='5189'>
         delrho = Max( 0.0, 0.01*(xdn(mgs,lh) - mmgraupvt(indxr,1)) )<a name='5190'>
         IF ( indxr &lt; ngdnmm ) THEN<a name='5191'>
          <a name='5192'>
          axh(mgs) = mmgraupvt(indxr,2) + delrho*(mmgraupvt(indxr+1,2) - mmgraupvt(indxr,2) )<a name='5193'>
          bxh(mgs) = mmgraupvt(indxr,3) + delrho*(mmgraupvt(indxr+1,3) - mmgraupvt(indxr,3) )<a name='5194'>
<a name='5195'>
          <a name='5196'>
         ELSE<a name='5197'>
          axh(mgs) = mmgraupvt(indxr,2)<a name='5198'>
          bxh(mgs) = mmgraupvt(indxr,3)<a name='5199'>
         ENDIF<a name='5200'>
         <a name='5201'>
         aax = axh(mgs)<a name='5202'>
         bbx = bxh(mgs)<a name='5203'>
         <a name='5204'>
       ENDIF<a name='5205'>
       <a name='5206'>
      IF ( alpha(mgs,lh) .eq. 0.0 .and. icdx &gt; 0 .and. icdx /= 6 ) THEN<a name='5207'>
      vtxbar(mgs,lh,1) = (gf4p5/6.0)*  &amp;<a name='5208'>
     &amp;  Sqrt( (xdn(mgs,lh)*xdia(mgs,lh,1)*4.0*gr) /  &amp;<a name='5209'>
     &amp;    (3.0*cd*rho0(mgs)) )<a name='5210'>
      ELSE<a name='5211'>
        IF ( icdx /= 6 ) bbx = bx(lh)<a name='5212'>
        tmp = 4. + alpha(mgs,lh) + bbx<a name='5213'>
        i = Int(dgami*(tmp))<a name='5214'>
        del = tmp - dgam*i<a name='5215'>
        x = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='5216'>
<a name='5217'>
        tmp = 4. + alpha(mgs,lh)<a name='5218'>
        i = Int(dgami*(tmp))<a name='5219'>
        del = tmp - dgam*i<a name='5220'>
        y = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='5221'>
        <a name='5222'>
<font color=#447700>!        aax = Max( 1.0, Min(2.0, (xdn(mgs,lh)/400.) ) )<a name='5223'></font>
<font color=#447700>!        vtxbar(mgs,lh,1) =  rhovt(mgs)*aax*ax(lh)*(xdia(mgs,lh,1)**bx(lh)*x)/y<a name='5224'></font>
        <a name='5225'>
        IF ( icdx &gt; 0 .and. icdx /= 6) THEN<a name='5226'>
          aax = Sqrt(4.0*xdn(mgs,lh)*gr/(3.0*cd*rho00))<a name='5227'>
          vtxbar(mgs,lh,1) =  rhovt(mgs)*aax* Sqrt(xdia(mgs,lh,1)) * x/y<a name='5228'>
          axh(mgs) = aax<a name='5229'>
          bxh(mgs) = bbx<a name='5230'>
        ELSEIF (icdx == 6 ) THEN<a name='5231'>
          vtxbar(mgs,lh,1) =  rhovt(mgs)*aax* xdia(mgs,lh,1)**bbx * x/y<a name='5232'>
        ELSE<a name='5233'>
          axh(mgs) = ax(lh)<a name='5234'>
          bxh(mgs) = bx(lh)<a name='5235'>
          vtxbar(mgs,lh,1) =  rhovt(mgs)*ax(lh)*(xdia(mgs,lh,1)**bx(lh)*x)/y          <a name='5236'>
        ENDIF<a name='5237'>
<a name='5238'>
<font color=#447700>!     &amp;    Gamma_sp(4.0 + dnu(lh) + 0.6))/Gamma_sp(4. + dnu(lh))<a name='5239'></font>
      ENDIF<a name='5240'>
<a name='5241'>
      IF ( lwsm6 .and. ipconc == 0 ) THEN<a name='5242'>
<font color=#447700>!         vtxbar(mgs,lh,1) = (330.*gf4ds/6.0)*(xdia(mgs,ls,1)**ds)*rhovt(mgs)<a name='5243'></font>
         vtxbar(mgs,lh,1) = (330.*gf4br/6.0)*(xdia(mgs,lh,1)**br)*rhovt(mgs)<a name='5244'>
      ENDIF<a name='5245'>
      <a name='5246'>
      end if<a name='5247'>
      end do<a name='5248'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set hail vt'<a name='5249'>
      <a name='5250'>
      ENDIF <font color=#447700>! lh .gt. 1<a name='5251'></font>
<font color=#447700>!<a name='5252'></font>
<font color=#447700>!<a name='5253'></font>
<font color=#447700>! ################################################################<a name='5254'></font>
<font color=#447700>!<a name='5255'></font>
<font color=#447700>!  HAIL<a name='5256'></font>
<font color=#447700>!<a name='5257'></font>
      IF ( lhl .gt. 1 .and. ( ildo == 0 .or. ildo == lhl ) ) THEN<a name='5258'>
      <a name='5259'>
      do mgs = 1,ngscnt<a name='5260'>
      vtxbar(mgs,lhl,1) = 0.0<a name='5261'>
      if ( qx(mgs,lhl) .gt. qxmin(lhl) ) then<a name='5262'>
<a name='5263'>
       IF ( icdxhl .eq. 1 ) THEN<a name='5264'>
         cd = cdx(lhl)<a name='5265'>
       ELSEIF ( icdxhl .eq. 3 ) THEN<a name='5266'>
<font color=#447700>!         cd = Max(0.45, Min(1.0, 0.45 + 0.55*(800.0 - Max( 300., Min( 800.0, xdn(mgs,lhl) ) ) )/(800. - 300.) ) )<a name='5267'></font>
         cd = Max(0.45, Min(1.2, 0.45 + 0.55*(800.0 - Max( hldnmn, Min( 800.0, xdn(mgs,lhl) ) ) )/(800. - 170.0) ) )<a name='5268'>
       ELSEIF ( icdxhl .eq. 4 ) THEN<a name='5269'>
         cd = Max(cdhlmin, Min(cdhlmax, cdhlmin + (cdhlmax-cdhlmin)*  &amp;<a name='5270'>
     &amp;       (cdhldnmax - Max( cdhldnmin, Min( cdhldnmax, xdn(mgs,lhl) ) ) )/(cdhldnmax - cdhldnmin) ) )<a name='5271'>
       ELSEIF ( icdxhl .eq. 5 ) THEN<a name='5272'>
         cd = cdx(lh)*(xdn(mgs,lhl)/rho_qh)**(2./3.)<a name='5273'>
       ELSEIF ( icdxhl .eq. 6 ) THEN <font color=#447700>! Milbrandt and Morrison (2013)<a name='5274'></font>
         indxr = Int( (xdn(mgs,lhl)-50.)/100. ) + 1<a name='5275'>
         indxr = Min( ngdnmm, Max(1,indxr) )<a name='5276'>
         <a name='5277'>
         <a name='5278'>
         delrho = Max( 0.0, 0.01*(xdn(mgs,lhl) - mmgraupvt(indxr,1)) )<a name='5279'>
         IF ( indxr &lt; ngdnmm ) THEN<a name='5280'>
          <a name='5281'>
          axhl(mgs) = mmgraupvt(indxr,2) + delrho*(mmgraupvt(indxr+1,2) - mmgraupvt(indxr,2) )<a name='5282'>
          bxhl(mgs) = mmgraupvt(indxr,3) + delrho*(mmgraupvt(indxr+1,3) - mmgraupvt(indxr,3) )<a name='5283'>
<a name='5284'>
          <a name='5285'>
         ELSE<a name='5286'>
          axhl(mgs) = mmgraupvt(indxr,2)<a name='5287'>
          bxhl(mgs) = mmgraupvt(indxr,3)<a name='5288'>
         ENDIF<a name='5289'>
         <a name='5290'>
         aax = axhl(mgs)<a name='5291'>
         bbx = bxhl(mgs)<a name='5292'>
         <a name='5293'>
       ELSE<a name='5294'>
<font color=#447700>!         cd = Max(0.6, Min(1.0, 0.6 + 0.4*(900.0 - xdn(mgs,lhl))/(900. - 300.) ) )<a name='5295'></font>
<font color=#447700>!        cd = Max(0.5, Min(0.8, 0.5 + 0.3*(xdnmx(lhl) - xdn(mgs,lhl))/(xdnmx(lhl)-xdnmn(lhl)) ) )<a name='5296'></font>
         cd = Max(0.45, Min(0.6, 0.45 + 0.15*(800.0 - Max( 500., Min( 800.0, xdn(mgs,lhl) ) ) )/(800. - 500.) ) )<a name='5297'>
       ENDIF<a name='5298'>
<a name='5299'>
      IF ( alpha(mgs,lhl) .eq. 0.0 .and. icdxhl &gt; 0 .and. icdxhl /= 6) THEN<a name='5300'>
      vtxbar(mgs,lhl,1) = (gf4p5/6.0)* &amp;<a name='5301'>
     &amp;  Sqrt( (xdn(mgs,lhl)*xdia(mgs,lhl,1)*4.0*gr) / &amp;<a name='5302'>
     &amp;    (3.0*cd*rho0(mgs)) )<a name='5303'>
      ELSE<a name='5304'>
        IF ( icdxhl /= 6 ) bbx = bx(lhl)<a name='5305'>
        tmp = 4. + alpha(mgs,lhl) + bbx<a name='5306'>
        i = Int(dgami*(tmp))<a name='5307'>
        del = tmp - dgam*i<a name='5308'>
        x = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='5309'>
<a name='5310'>
        tmp = 4. + alpha(mgs,lhl)<a name='5311'>
        i = Int(dgami*(tmp))<a name='5312'>
        del = tmp - dgam*i<a name='5313'>
        y = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='5314'>
<a name='5315'>
        IF ( icdxhl &gt; 0 .and. icdxhl /= 6) THEN<a name='5316'>
          aax = Sqrt(4.0*xdn(mgs,lhl)*gr/(3.0*cd*rho00))<a name='5317'>
          vtxbar(mgs,lhl,1) =  rhovt(mgs)*aax* Sqrt(xdia(mgs,lhl,1)) * x/y<a name='5318'>
          axhl(mgs) = aax<a name='5319'>
          bxhl(mgs) = bbx<a name='5320'>
        ELSEIF ( icdxhl == 6 ) THEN<a name='5321'>
          vtxbar(mgs,lhl,1) =  rhovt(mgs)*aax* (xdia(mgs,lhl,1))**bbx * x/y<a name='5322'>
        ELSE<a name='5323'>
          axhl(mgs) = ax(lhl)<a name='5324'>
          bxhl(mgs) = bx(lhl)<a name='5325'>
         vtxbar(mgs,lhl,1) =  rhovt(mgs)*(ax(lhl)*xdia(mgs,lhl,1)**bx(lhl)*x)/y<a name='5326'>
        ENDIF<a name='5327'>
        <a name='5328'>
<font color=#447700>!     &amp;    Gamma_sp(4.0 + dnu(lh) + 0.6))/Gamma_sp(4. + dnu(lh))<a name='5329'></font>
      ENDIF<a name='5330'>
<a name='5331'>
<a name='5332'>
      end if<a name='5333'>
      end do<a name='5334'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set hail vt'<a name='5335'>
      <a name='5336'>
      ENDIF <font color=#447700>! lhl .gt. 1<a name='5337'></font>
<a name='5338'>
<a name='5339'>
      IF ( infdo .ge. 1 ) THEN<a name='5340'>
<a name='5341'>
<font color=#447700>!      DO il = lc,lhab<a name='5342'></font>
<font color=#447700>!      IF ( il .ne. lr ) THEN<a name='5343'></font>
        DO mgs = 1,ngscnt<a name='5344'>
          vtxbar(mgs,lc,2) = vtxbar(mgs,lc,1)<a name='5345'>
        IF ( li .gt. 1 ) THEN<a name='5346'>
<font color=#447700>!          vtxbar(mgs,li,2) = rhovt(mgs)*49420.*1.25447*xdia(mgs,li,1)**(1.415) ! n-wgt (Ferrier 94)<a name='5347'></font>
<font color=#447700>!          vtxbar(mgs,li,2) = vtxbar(mgs,li,1)<a name='5348'></font>
<a name='5349'>
<font color=#447700>! test print stuff...<a name='5350'></font>
<font color=#447700>!          IF ( xdia(mgs,li,1) .gt. 200.e-6 ) THEN<a name='5351'></font>
<font color=#447700>!            tmp = (xv(mgs,li)*cwc0)**(1./3.)<a name='5352'></font>
<font color=#447700>!            x = rhovt(mgs)*49420.*40.0005/5.40662*tmp**(1.415)<a name='5353'></font>
<font color=#447700>!            y = rhovt(mgs)*49420.*1.25447*tmp**(1.415)<a name='5354'></font>
<font color=#447700>!            write(6,*) 'Ice fall: ',vtxbar(mgs,li,1),x,y,tmp,xdia(mgs,li,1)<a name='5355'></font>
<font color=#447700>!          ENDIF<a name='5356'></font>
        ENDIF<a name='5357'>
<font color=#447700>!          vtxbar(mgs,ls,2) = vtxbar(mgs,ls,1)<a name='5358'></font>
        ENDDO<a name='5359'>
<a name='5360'>
        IF ( lg .gt. lr ) THEN<a name='5361'>
<a name='5362'>
        DO il = lg,lhab<a name='5363'>
         IF ( ildo == 0 .or. ildo == il ) THEN<a name='5364'>
<a name='5365'>
            DO mgs = 1,ngscnt<a name='5366'>
             IF ( qx(mgs,il) .gt. qxmin(il) ) THEN<a name='5367'>
              IF ( (il .eq. lh .and. hssflg == 1) .or. ( lhl .gt. 1 .and. il .eq. lhl .and. hlssflg == 1) ) THEN <font color=#447700>! DTD: added flag for size-sorting<a name='5368'></font>
              <a name='5369'>
              <font color=#447700>! DTD: allow for setting of number-weighted and z-weighted fall speeds to the mass-weighted value,<a name='5370'></font>
              <font color=#447700>! effectively turning off size-sorting<a name='5371'></font>
<a name='5372'>
              IF ( il .eq. lh ) THEN <font color=#447700>! {<a name='5373'></font>
             <a name='5374'>
               IF ( icdx .eq. 1 ) THEN<a name='5375'>
                 cd = cdx(lh)<a name='5376'>
               ELSEIF ( icdx .eq. 2 ) THEN<a name='5377'>
<font color=#447700>!                 cd = Max(0.6, Min(1.0, 0.6 + 0.4*(xdnmx(lh) - xdn(mgs,lh))/(xdnmx(lh)-xdnmn(lh)) ) )<a name='5378'></font>
<font color=#447700>!                 cd = Max(0.6, Min(1.0, 0.6 + 0.4*(900.0 - xdn(mgs,lh))/(900. - 300.) ) )<a name='5379'></font>
                 cd = Max(0.45, Min(1.0, 0.45 + 0.35*(800.0 - Max( 500., Min( 800.0, xdn(mgs,lh) ) ) )/(800. - 500.) ) )<a name='5380'>
<font color=#447700>!                 cd = Max(0.55, Min(1.0, 0.55 + 0.25*(800.0 - Max( 500., Min( 800.0, xdn(mgs,lh) ) ) )/(800. - 500.) ) )<a name='5381'></font>
               ELSEIF ( icdx .eq. 3 ) THEN<a name='5382'>
<font color=#447700>!                 cd = Max(0.45, Min(1.0, 0.45 + 0.55*(800.0 - Max( 170.0, Min( 800.0, xdn(mgs,lh) ) ) )/(800. - 170.0) ) )<a name='5383'></font>
                 cd = Max(0.45, Min(1.2, 0.45 + 0.55*(800.0 - Max( hdnmn, Min( 800.0, xdn(mgs,lh) ) ) )/(800. - 170.0) ) )<a name='5384'>
               ELSEIF ( icdx .eq. 4 ) THEN<a name='5385'>
                 cd = Max(cdhmin, Min(cdhmax, cdhmin + (cdhmax-cdhmin)* &amp;<a name='5386'>
     &amp;            (cdhdnmax - Max( cdhdnmin, Min( cdhdnmax, xdn(mgs,lh) ) ) )/(cdhdnmax - cdhdnmin) ) )<a name='5387'>
               ELSEIF ( icdx .eq. 5 ) THEN<a name='5388'>
                 cd = cdx(lh)*(xdn(mgs,lh)/rho_qh)**(2./3.)<a name='5389'>
               ELSEIF ( icdx .eq. 6 ) THEN <font color=#447700>! Milbrandt and Morrison (2013)<a name='5390'></font>
                  aax = axh(mgs)<a name='5391'>
                  bbx = bxh(mgs)<a name='5392'>
               ENDIF<a name='5393'>
               <a name='5394'>
              ELSEIF ( lhl .gt. 1 .and. il .eq. lhl ) THEN<a name='5395'>
             <a name='5396'>
               IF ( icdxhl .eq. 1 ) THEN<a name='5397'>
                 cd = cdx(lhl)<a name='5398'>
               ELSEIF ( icdxhl .eq. 3 ) THEN<a name='5399'>
<font color=#447700>!               cd = Max(0.45, Min(1.0, 0.45 + 0.55*(800.0 - Max( 300., Min( 800.0, xdn(mgs,lhl) ) ) )/(800. - 300.) ) )<a name='5400'></font>
                cd = Max(0.45, Min(1.2, 0.45 + 0.55*(800.0 - Max( hldnmn, Min( 800.0, xdn(mgs,lhl) ) ) )/(800. - 170.0) ) )<a name='5401'>
               ELSEIF ( icdxhl .eq. 4 ) THEN<a name='5402'>
                cd = Max(cdhlmin, Min(cdhlmax, cdhlmin + (cdhlmax-cdhlmin)*  &amp;<a name='5403'>
     &amp;               (cdhldnmax - Max( cdhldnmin, Min( cdhldnmax, xdn(mgs,lhl) ) ) )/(cdhldnmax - cdhldnmin) ) )<a name='5404'>
               ELSEIF ( icdxhl == 5 ) THEN<a name='5405'>
<font color=#447700>!                cd = Max(0.6, Min(1.0, 0.6 + 0.4*(900.0 - xdn(mgs,lhl))/(900. - 300.) ) )<a name='5406'></font>
<font color=#447700>!                cd = Max(0.5, Min(0.8, 0.5 + 0.3*(xdnmx(lhl) - xdn(mgs,lhl))/(xdnmx(lhl)-xdnmn(lhl)) ) )<a name='5407'></font>
                 cd = Max(0.45, Min(0.6, 0.45 + 0.15*(800.0 - Max( 500., Min( 800.0, xdn(mgs,lhl) ) ) )/(800. - 500.) ) )<a name='5408'>
               ELSEIF ( icdxhl .eq. 6 ) THEN <font color=#447700>! Milbrandt and Morrison (2013)<a name='5409'></font>
                  aax = axhl(mgs)<a name='5410'>
                  bbx = bxhl(mgs)<a name='5411'>
               ENDIF<a name='5412'>
               <a name='5413'>
              ENDIF <font color=#447700>! }<a name='5414'></font>
<a name='5415'>
               IF ( alpha(mgs,il) .eq. 0. .and. infdo .lt. 2 .and.   &amp;<a name='5416'>
               ( ( il==lh .and. icdx &gt; 0 .and. icdx /= 6) .or. ( il==lhl .and. icdxhl &gt; 0 .and. icdxhl /= 6 ) ) ) THEN <font color=#447700>! {<a name='5417'></font>
                 vtxbar(mgs,il,2) =   &amp;<a name='5418'>
     &amp;              Sqrt( (xdn(mgs,il)*xdia(mgs,il,1)*pi*gr) / &amp;<a name='5419'>
     &amp;                (3.0*cd*rho0(mgs)) )<a name='5420'>
<a name='5421'>
               ELSE<a name='5422'>
               IF ( il == lh  .and. icdx   /= 6 ) bbx = bx(il)<a name='5423'>
               IF ( il == lhl .and. icdxhl /= 6 ) bbx = bx(il)<a name='5424'>
               tmp = 1. + alpha(mgs,il) + bbx<a name='5425'>
               i = Int(dgami*(tmp))<a name='5426'>
               del = tmp - dgam*i<a name='5427'>
               x = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='5428'>
  <a name='5429'>
               tmp = 1. + alpha(mgs,il)<a name='5430'>
               i = Int(dgami*(tmp))<a name='5431'>
               del = tmp - dgam*i<a name='5432'>
               y = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='5433'>
<a name='5434'>
                 IF ( il .eq. lh  .or. il .eq. lhl) THEN <font color=#447700>! {<a name='5435'></font>
                   IF ( ( il==lh .and. icdx &gt; 0 ) ) THEN<a name='5436'>
                     IF ( icdx /= 6 ) THEN<a name='5437'>
                      aax = Sqrt(4.0*xdn(mgs,il)*gr/(3.0*cd*rho00))<a name='5438'>
                      vtxbar(mgs,il,2) =  rhovt(mgs)*aax* xdia(mgs,il,1)**0.5 * x/y<a name='5439'>
                     ELSE <font color=#447700>!  (icdx == 6 ) THEN<a name='5440'></font>
                       vtxbar(mgs,il,2) =  rhovt(mgs)*aax* xdia(mgs,il,1)**bbx * x/y<a name='5441'>
                     ENDIF<a name='5442'>
<font color=#447700>!                   ELSE<a name='5443'></font>
<font color=#447700>!                     aax = ax(il)<a name='5444'></font>
<font color=#447700>!                     vtxbar(mgs,il,2) =  rhovt(mgs)*ax(il)*(xdia(mgs,il,1)**bx(il)*x)/y<a name='5445'></font>
<font color=#447700>!                   ENDIF<a name='5446'></font>
<a name='5447'>
                   ELSEIF ( ( il==lhl .and. icdxhl &gt; 0 ) ) THEN<a name='5448'>
                     IF ( icdxhl /= 6 ) THEN<a name='5449'>
                       aax = Sqrt(4.0*xdn(mgs,il)*gr/(3.0*cd*rho00))<a name='5450'>
                       vtxbar(mgs,il,2) =  rhovt(mgs)*aax* xdia(mgs,il,1)**0.5 * x/y<a name='5451'>
                     ELSE <font color=#447700>! ( icdxhl == 6 )<a name='5452'></font>
                       vtxbar(mgs,il,2) =  rhovt(mgs)*aax* xdia(mgs,il,1)**bbx * x/y<a name='5453'>
                     ENDIF<a name='5454'>
                   ELSE<a name='5455'>
                     aax = ax(il)<a name='5456'>
                     vtxbar(mgs,il,2) =  rhovt(mgs)*ax(il)*(xdia(mgs,il,1)**bx(il)*x)/y<a name='5457'>
                   ENDIF<a name='5458'>
<a name='5459'>
<font color=#447700>!                  vtxbar(mgs,il,2) =  &amp;<a name='5460'></font>
<font color=#447700>!     &amp;               rhovt(mgs)*(xdn(mgs,il)/400.)*(75.715*xdia(mgs,il,1)**0.6* &amp;<a name='5461'></font>
<font color=#447700>!     &amp;               x)/y<a name='5462'></font>
<font color=#447700>!                  vtxbar(mgs,il,2) =  &amp;<a name='5463'></font>
<font color=#447700>!     &amp;               rhovt(mgs)*(xdn(mgs,il)/400.)*(ax(il)*xdia(mgs,il,1)**bx(il)* &amp;<a name='5464'></font>
<font color=#447700>!     &amp;               x)/y<a name='5465'></font>
                  IF ( infdo .ge. 2 ) THEN <font color=#447700>! Z-weighted<a name='5466'></font>
                   vtxbar(mgs,il,3) = rhovt(mgs)*                 &amp;<a name='5467'>
     &amp;                (aax*(1.0/xdia(mgs,il,1) )**(- bbx)*  &amp;<a name='5468'>
     &amp;                 Gamma_sp(7.0 + alpha(mgs,il) + bbx))/Gamma_sp(7. + alpha(mgs,il))<a name='5469'>
<font color=#447700>!     &amp;                (aax*(1.0/xdia(mgs,il,1) )**(- bx(il))*  &amp;<a name='5470'></font>
<font color=#447700>!     &amp;                 Gamma_sp(7.0 + alpha(mgs,il) + bx(il)))/Gamma_sp(7. + alpha(mgs,il))<a name='5471'></font>
                  ENDIF<a name='5472'>
<a name='5473'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set hail vt3'<a name='5474'>
<a name='5475'>
                 ELSE <font color=#447700>! hail<a name='5476'></font>
                  vtxbar(mgs,il,2) =  &amp;<a name='5477'>
     &amp;               rhovt(mgs)*(ax(il)*xdia(mgs,il,1)**bx(il)* &amp;<a name='5478'>
     &amp;               x)/y<a name='5479'>
<a name='5480'>
                 IF ( infdo .ge. 2 ) THEN <font color=#447700>! Z-weighted<a name='5481'></font>
                  vtxbar(mgs,il,3) = rhovt(mgs)*                 &amp;<a name='5482'>
     &amp;              (aax*(1.0/xdia(mgs,il,1) )**(- bbx)*  &amp;<a name='5483'>
     &amp;               Gamma_sp(7.0 + alpha(mgs,il) + bbx))/Gamma_sp(7. + alpha(mgs,il))<a name='5484'>
<font color=#447700>!     &amp;              (ax(il)*(1.0/xdia(mgs,il,1) )**(- bx(il))*  &amp;<a name='5485'></font>
<font color=#447700>!     &amp;               Gamma_sp(7.0 + alpha(mgs,il) + bx(il)))/Gamma_sp(7. + alpha(mgs,il))<a name='5486'></font>
                  ENDIF<a name='5487'>
<a name='5488'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set hail vt4'<a name='5489'>
<a name='5490'>
                 ENDIF <font color=#447700>! }<a name='5491'></font>
<font color=#447700>!     &amp;             Gamma_sp(1.0 + dnu(il) + 0.6)/Gamma_sp(1. + dnu(il))<a name='5492'></font>
               ENDIF <font color=#447700>! }<a name='5493'></font>
<a name='5494'>
<font color=#447700>!              IF ( infdo .ge. 2 ) THEN ! Z-weighted<a name='5495'></font>
<font color=#447700>!               vtxbar(mgs,il,3) = rhovt(mgs)*                 &amp;<a name='5496'></font>
<font color=#447700>!     &amp;            (ax(il)*(1.0/xdia(mgs,il,1) )**(- bx(il))*  &amp;<a name='5497'></font>
<font color=#447700>!     &amp;             Gamma_sp(7.0 + alpha(mgs,il) + bx(il)))/Gamma_sp(7. + alpha(mgs,il))<a name='5498'></font>
<font color=#447700>!              ENDIF<a name='5499'></font>
<a name='5500'>
<font color=#447700>!               IF ( lhl .gt. 1 .and. il .eq. lhl ) THEN<a name='5501'></font>
<font color=#447700>!                write(0,*) 'setvt: ',qx(mgs,il),xdia(mgs,il,1),xdia(mgs,il,3),dnu(il),ax(il),bx(il)<a name='5502'></font>
<font color=#447700>!               ENDIF<a name='5503'></font>
             ELSEIF ( (il .eq. lh .and. hssflg == 0) .or. ( lhl .gt. 1 .and. il .eq. lhl .and. hlssflg == 0) ) THEN <font color=#447700>! no size-sorting for graupel or hail<a name='5504'></font>
              vtxbar(mgs,il,2) = vtxbar(mgs,il,1)<a name='5505'>
              vtxbar(mgs,il,3) = vtxbar(mgs,il,1)<a name='5506'>
             ELSE <font color=#447700>! not lh or lhl<a name='5507'></font>
              vtxbar(mgs,il,2) = &amp;<a name='5508'>
     &amp;            Sqrt( (xdn(mgs,il)*xdia(mgs,il,1)*pi*gr) /  &amp;<a name='5509'>
     &amp;              (3.0*cdx(il)*rho0(mgs)) )<a name='5510'>
              vtxbar(mgs,il,3) = vtxbar(mgs,il,1)<a name='5511'>
<a name='5512'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set graupel vt5'<a name='5513'>
<a name='5514'>
<a name='5515'>
              ENDIF<a name='5516'>
             ELSE <font color=#447700>! qx &lt; qxmin<a name='5517'></font>
              vtxbar(mgs,il,2) = 0.0<a name='5518'>
<a name='5519'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set graupel vt6'<a name='5520'>
<a name='5521'>
             ENDIF<a name='5522'>
           ENDDO <font color=#447700>! mgs<a name='5523'></font>
<a name='5524'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set graupel vt7'<a name='5525'>
<a name='5526'>
        ENDIF<a name='5527'>
        ENDDO <font color=#447700>! il<a name='5528'></font>
<a name='5529'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set graupel vt8'<a name='5530'>
<a name='5531'>
        ENDIF <font color=#447700>! lg .gt. 1 <a name='5532'></font>
        <a name='5533'>
<font color=#447700>!      ENDIF<a name='5534'></font>
<font color=#447700>!      ENDDO<a name='5535'></font>
<a name='5536'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: Set graupel vt9'<a name='5537'>
<a name='5538'>
<font color=#447700>!       DO mgs = 1,ngscnt<a name='5539'></font>
<font color=#447700>!        IF ( qx(mgs,lr) &gt; qxmin(lr) ) THEN<a name='5540'></font>
<font color=#447700>!         write(0,*) 'setvt2: mgs,lzr,infdo = ',mgs,lzr,infdo<a name='5541'></font>
<font color=#447700>!         write(0,*) 'vt1,2,3 = ',vtxbar(mgs,lr,1),vtxbar(mgs,lr,2),vtxbar(mgs,lr,3)<a name='5542'></font>
<font color=#447700>!        ENDIF<a name='5543'></font>
<font color=#447700>!       ENDDO<a name='5544'></font>
<a name='5545'>
      ENDIF <font color=#447700>! infdo .ge. 1 <a name='5546'></font>
      <a name='5547'>
      if ( ndebug1 .gt. 0 ) write(0,*) 'SETVTZ: END OF ROUTINE'<a name='5548'>
<a name='5549'>
<font color=#447700>!############ SETVTZ ############################<a name='5550'></font>
<a name='5551'>
      RETURN<a name='5552'>
      END SUBROUTINE setvtz<a name='5553'>
<font color=#447700>!--------------------------------------------------------------------------<a name='5554'></font>
<a name='5555'>
<font color=#447700>!<a name='5556'></font>
<font color=#447700>! ##############################################################################<a name='5557'></font>
<a name='5558'>
<font color=#447700>!<a name='5559'></font>
<font color=#447700>!  subroutine to calculate fall speeds of hydrometeors<a name='5560'></font>
<font color=#447700>!<a name='5561'></font>
<a name='5562'>
<A NAME='ZIEGFALL1D'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#ZIEGFALL1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5563'>
      <font color=#993300>subroutine </font><font color=#cc0000>ziegfall1d</font>(nx,ny,nz,nor,norz,na,dtp,jgs,ixcol, &amp; <A href='../../call_to/ZIEGFALL1D.html' TARGET='index'>2</A>,<A href='../../call_from/ZIEGFALL1D.html' TARGET='index'>1</A><a name='5564'>
     &amp;  xvt, rhovtzx,                                           &amp;<a name='5565'>
     &amp;  an,dn,ipconc0,t0,t7,cwmasn,cwmasx,       &amp;<a name='5566'>
     &amp;  cwradn,                                   &amp;<a name='5567'>
     &amp;  qxmin,xdnmx,xdnmn,cdx,cno,xdn0,xvmn,xvmx,  &amp;<a name='5568'>
     &amp;  ngs,qx,qxw,cx,xv,vtxbar,xmas,xdn,xdia,vx,alpha,zx,igs,kgs, &amp;<a name='5569'>
     &amp;  rho0,temcg,temg,rhovt,cwnc,cinc,fadvisc,cwdia,cipmas,cnina,cimas, &amp;<a name='5570'>
     &amp;  cnostmp,                     &amp;<a name='5571'>
     &amp;  infdo,ildo,timesetvt)<a name='5572'>
<a name='5573'>
<font color=#447700>! 12.16.2005: .F version use in transitional SWM model<a name='5574'></font>
<font color=#447700>!<a name='5575'></font>
<font color=#447700>! 10.10.2003: Added cimn and cimx to setting for cci and cip.<a name='5576'></font>
<font color=#447700>!<a name='5577'></font>
<font color=#447700>! TO DO LIST:<a name='5578'></font>
<font color=#447700>!<a name='5579'></font>
<font color=#447700>! need to set up values for:<a name='5580'></font>
<font color=#447700>!     :  cipdia,cidia,cwdia,cwmas,vtwbar,<a name='5581'></font>
<font color=#447700>!     :  rho0,temcg,cip,cci<a name='5582'></font>
<font color=#447700>!<a name='5583'></font>
<font color=#447700>! and need to put fallspeed values in cwvt etc.<a name='5584'></font>
<font color=#447700>!<a name='5585'></font>
      <a name='5586'>
      implicit none<a name='5587'>
      integer ng1<a name='5588'>
      parameter(ng1 = 1)<a name='5589'>
      <a name='5590'>
      integer, intent(in) :: ixcol <font color=#447700>! which column to return<a name='5591'></font>
      integer, intent(in) :: ildo<a name='5592'>
      <a name='5593'>
      integer nx,ny,nz,nor,norz,ngt,jgs,na<a name='5594'>
      real an(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor,na)<a name='5595'>
      real dn(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor)<a name='5596'>
      real t0(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor)<a name='5597'>
      real t7(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor)<a name='5598'>
      real dtp,dtz1<a name='5599'>
      <a name='5600'>
      real :: rhovtzx(nz,nx)<a name='5601'>
      <a name='5602'>
      integer ndebugzf<a name='5603'>
      parameter (ndebugzf = 0)<a name='5604'>
<a name='5605'>
      integer ix,jy,kz,i,j,k,il<a name='5606'>
      integer infdo<a name='5607'>
<font color=#447700>!<a name='5608'></font>
<font color=#447700>!<a name='5609'></font>
      real xvt(nz+1,nx,3,lc:lhab) <font color=#447700>! 1=mass-weighted, 2=number-weighted<a name='5610'></font>
<a name='5611'>
      real qxmin(lc:lhab)<a name='5612'>
      real xdn0(lc:lhab)<a name='5613'>
      real xvmn(lc:lhab), xvmx(lc:lhab)<a name='5614'>
      double precision,optional :: timesetvt<a name='5615'>
<a name='5616'>
      integer :: ngs<a name='5617'>
      integer :: ngscnt,mgs,ipconc0<a name='5618'>
<font color=#447700>!      parameter ( ngs=200 )<a name='5619'></font>
      <a name='5620'>
      real ::  qx(ngs,lv:lhab) <a name='5621'>
      real ::  qxw(ngs,ls:lhab) <a name='5622'>
      real ::  cx(ngs,lc:lhab) <a name='5623'>
      real ::  xv(ngs,lc:lhab) <a name='5624'>
      real ::  vtxbar(ngs,lc:lhab,3) <a name='5625'>
      real ::  xmas(ngs,lc:lhab) <a name='5626'>
      real ::  xdn(ngs,lc:lhab) <a name='5627'>
      real ::  xdia(ngs,lc:lhab,3) <a name='5628'>
      real ::  vx(ngs,li:lhab) <a name='5629'>
      real ::  alpha(ngs,lc:lhab) <a name='5630'>
      real ::  zx(ngs,lr:lhab) <a name='5631'>
<a name='5632'>
      real xdnmx(lc:lhab), xdnmn(lc:lhab)<a name='5633'>
      real axh(ngs),bxh(ngs),axhl(ngs),bxhl(ngs)<a name='5634'>
<a name='5635'>
<font color=#447700>!<a name='5636'></font>
<font color=#447700>!   drag coefficients<a name='5637'></font>
<font color=#447700>!<a name='5638'></font>
      real cdx(lc:lhab)<a name='5639'>
<font color=#447700>!<a name='5640'></font>
<font color=#447700>! Fixed intercept values for single moment scheme<a name='5641'></font>
<font color=#447700>!<a name='5642'></font>
      real cno(lc:lhab)<a name='5643'>
      <a name='5644'>
      real cwccn0,cwmasn,cwmasx,cwradn<a name='5645'>
<font color=#447700>!      real cwc0<a name='5646'></font>
<a name='5647'>
      integer nxmpb,nzmpb,nxz,numgs,inumgs<a name='5648'>
      integer kstag<a name='5649'>
      parameter (kstag=1)<a name='5650'>
<a name='5651'>
      integer igs(ngs),kgs(ngs)<a name='5652'>
      <a name='5653'>
      real rho0(ngs),temcg(ngs)<a name='5654'>
<a name='5655'>
      real temg(ngs)<a name='5656'>
      <a name='5657'>
      real rhovt(ngs)<a name='5658'>
      <a name='5659'>
      real cwnc(ngs),cinc(ngs)<a name='5660'>
      real fadvisc(ngs),cwdia(ngs),cipmas(ngs)<a name='5661'>
      <a name='5662'>
<font color=#447700>!      real cimasn,cimasx,<a name='5663'></font>
      real :: cnina(ngs),cimas(ngs)<a name='5664'>
      <a name='5665'>
      real :: cnostmp(ngs)<a name='5666'>
<a name='5667'>
<font color=#447700>!      real pii<a name='5668'></font>
<font color=#447700>!<a name='5669'></font>
<font color=#447700>!<a name='5670'></font>
<font color=#447700>!  general constants for microphysics<a name='5671'></font>
<font color=#447700>!<a name='5672'></font>
<a name='5673'>
<font color=#447700>! <a name='5674'></font>
<font color=#447700>! Miscellaneous<a name='5675'></font>
<font color=#447700>!<a name='5676'></font>
      <a name='5677'>
      logical flag<a name='5678'>
      logical ldoliq<a name='5679'>
      <a name='5680'>
    <a name='5681'>
      real chw, qr, z, rd, alp, z1, g1, vr, nrx, tmp<a name='5682'>
      <a name='5683'>
      real vtmax<a name='5684'>
      real xvbarmax<a name='5685'>
      <a name='5686'>
      integer l1, l2<a name='5687'>
      <a name='5688'>
      double precision :: dpt1, dpt2<a name='5689'>
<a name='5690'>
<a name='5691'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='5692'></font>
<font color=#447700>! MPI LOCAL VARIABLES <a name='5693'></font>
<a name='5694'>
      integer :: ixb, jyb, kzb<a name='5695'>
      integer :: ixe, jye, kze<a name='5696'>
<a name='5697'>
      logical :: debug_mpi = .false.<a name='5698'>
<a name='5699'>
<a name='5700'>
      if (ndebugzf .gt. 0 ) write(0,*) "ZIEGFALL: ENTERED SUBROUTINE"<a name='5701'>
<a name='5702'>
<font color=#447700>! #####################################################################<a name='5703'></font>
<font color=#447700>! BEGIN EXECUTABLE<a name='5704'></font>
<font color=#447700>! #####################################################################<a name='5705'></font>
<font color=#447700>!<a name='5706'></font>
<a name='5707'>
<font color=#447700>!  constants<a name='5708'></font>
<font color=#447700>!<a name='5709'></font>
<a name='5710'>
      ldoliq = .false.<a name='5711'>
      IF ( ls .gt. 1 ) THEN<a name='5712'>
      DO il = ls,lhab<a name='5713'>
        ldoliq = ldoliq .or. ( lliq(il) .gt. 1 )<a name='5714'>
      ENDDO<a name='5715'>
      ENDIF<a name='5716'>
      <a name='5717'>
<font color=#447700>!      poo = 1.0e+05<a name='5718'></font>
<font color=#447700>!      cp608 = 0.608<a name='5719'></font>
<font color=#447700>!      cp = 1004.0<a name='5720'></font>
<font color=#447700>!      cv = 717.0<a name='5721'></font>
<font color=#447700>!      dnz00 = 1.225<a name='5722'></font>
<font color=#447700>!      rho00 = 1.225<a name='5723'></font>
<font color=#447700>!      cs = 4.83607122<a name='5724'></font>
<font color=#447700>!      ds = 0.25<a name='5725'></font>
<font color=#447700>!  new values for  cs and ds<a name='5726'></font>
<font color=#447700>!      cs = 12.42<a name='5727'></font>
<font color=#447700>!      ds = 0.42<a name='5728'></font>
<font color=#447700>!      pi = 4.0*atan(1.0)<a name='5729'></font>
<font color=#447700>!      pii = piinv ! 1./pi<a name='5730'></font>
<font color=#447700>!      pid4 = pi/4.0 <a name='5731'></font>
<font color=#447700>!      qccrit = 2.0e-03<a name='5732'></font>
<font color=#447700>!      qscrit = 6.0e-04<a name='5733'></font>
<font color=#447700>!      cwc0 = pii<a name='5734'></font>
      <a name='5735'>
<font color=#447700>!<a name='5736'></font>
<font color=#447700>!<a name='5737'></font>
<font color=#447700>!  general constants for microphysics<a name='5738'></font>
<font color=#447700>!<a name='5739'></font>
      <a name='5740'>
<font color=#447700>!<a name='5741'></font>
<font color=#447700>!  ci constants in mks units<a name='5742'></font>
<font color=#447700>!<a name='5743'></font>
<font color=#447700>!      cimasn = 6.88e-13 <a name='5744'></font>
<font color=#447700>!      cimasx = 1.0e-8<a name='5745'></font>
<font color=#447700>!<a name='5746'></font>
<font color=#447700>!  Set terminal velocities...<a name='5747'></font>
<font color=#447700>!    also set drag coefficients<a name='5748'></font>
<font color=#447700>!<a name='5749'></font>
      jy = jgs<a name='5750'>
      nxmpb = ixcol<a name='5751'>
      nzmpb = 1<a name='5752'>
      nxz = 1*nz<a name='5753'>
<font color=#447700>!      ngs = nz<a name='5754'></font>
      numgs = 1<a name='5755'>
<a name='5756'>
      IF ( ildo == 0 ) THEN<a name='5757'>
        l1 = lc<a name='5758'>
        l2 = lhab<a name='5759'>
      ELSE<a name='5760'>
        l1 = ildo<a name='5761'>
        l2 = ildo<a name='5762'>
      ENDIF<a name='5763'>
<a name='5764'>
<a name='5765'>
      do inumgs = 1,numgs<a name='5766'>
       ngscnt = 0<a name='5767'>
<a name='5768'>
<a name='5769'>
       do kz = nzmpb,nz<a name='5770'>
        do ix = ixcol,ixcol<a name='5771'>
        flag = .false.<a name='5772'>
<a name='5773'>
        <a name='5774'>
        DO il = l1,l2<a name='5775'>
          flag =  flag .or. ( an(ix,jy,kz,il)  .gt. qxmin(il) ) <a name='5776'>
        ENDDO<a name='5777'>
<a name='5778'>
        if ( flag ) then<a name='5779'>
<font color=#447700>! load temp quantities<a name='5780'></font>
<a name='5781'>
        ngscnt = ngscnt + 1<a name='5782'>
        igs(ngscnt) = ix<a name='5783'>
        kgs(ngscnt) = kz<a name='5784'>
        if ( ngscnt .eq. ngs ) goto 1100<a name='5785'>
        end if<a name='5786'>
        end do <font color=#447700>!!ix<a name='5787'></font>
        nxmpb = 1<a name='5788'>
       end do <font color=#447700>!! kz<a name='5789'></font>
<a name='5790'>
<font color=#447700>!      if ( jy .eq. (ny-jstag) ) iend = 1<a name='5791'></font>
<a name='5792'>
 1100 continue<a name='5793'>
<a name='5794'>
      if ( ngscnt .eq. 0 ) go to 9998<a name='5795'>
<font color=#447700>!<a name='5796'></font>
<font color=#447700>!  set temporaries for microphysics variables<a name='5797'></font>
<font color=#447700>!<a name='5798'></font>
<a name='5799'>
<a name='5800'>
<font color=#447700>!<a name='5801'></font>
<font color=#447700>!  Reconstruct various quantities <a name='5802'></font>
<font color=#447700>!<a name='5803'></font>
      do mgs = 1,ngscnt<a name='5804'>
<a name='5805'>
       rho0(mgs) = dn(igs(mgs),jy,kgs(mgs))<a name='5806'>
       rhovt(mgs) = rhovtzx(kgs(mgs),ixcol) <font color=#447700>!  Sqrt(rho00/rho0(mgs))<a name='5807'></font>
       temg(mgs) = t0(igs(mgs),jy,kgs(mgs))<a name='5808'>
       temcg(mgs) = temg(mgs) - tfr<a name='5809'>
<a name='5810'>
        <a name='5811'>
<font color=#447700>!<a name='5812'></font>
      end do<a name='5813'>
<font color=#447700>!<a name='5814'></font>
<font color=#447700>! only need fadvisc for <a name='5815'></font>
      IF ( lc .gt. 1 .and. (ildo == 0 .or. ildo == lc ) ) then<a name='5816'>
        do mgs = 1,ngscnt<a name='5817'>
         fadvisc(mgs) = advisc0*(416.16/(temg(mgs)+120.0))* &amp;<a name='5818'>
     &amp;   (temg(mgs)/296.0)**(1.5)<a name='5819'>
        end do<a name='5820'>
      ENDIF<a name='5821'>
<a name='5822'>
      IF ( ipconc .eq. 0 ) THEN<a name='5823'>
      do mgs = 1,ngscnt<a name='5824'>
      cnina(mgs) = t7(igs(mgs),jgs,kgs(mgs))<a name='5825'>
      end do<a name='5826'>
      ENDIF<a name='5827'>
<a name='5828'>
<a name='5829'>
      IF ( ildo &gt; 0 ) THEN<a name='5830'>
        vtxbar(:,ildo,:) = 0.0<a name='5831'>
      ELSE<a name='5832'>
        vtxbar(:,:,:) = 0.0<a name='5833'>
      ENDIF<a name='5834'>
      <a name='5835'>
<font color=#447700>!      do mgs = 1,ngscnt<a name='5836'></font>
<font color=#447700>!        qx(mgs,lv) = max(an(igs(mgs),jy,kgs(mgs),lv), 0.0) <a name='5837'></font>
<font color=#447700>!      ENDDO<a name='5838'></font>
      DO il = l1,l2<a name='5839'>
      do mgs = 1,ngscnt<a name='5840'>
        qx(mgs,il) = max(an(igs(mgs),jy,kgs(mgs),il), 0.0) <a name='5841'>
      ENDDO<a name='5842'>
      end do<a name='5843'>
      <a name='5844'>
      cnostmp(:) = cno(ls)<a name='5845'>
      IF ( ipconc &lt; 1 .and. lwsm6 .and. (ildo == 0 .or. ildo == ls )) THEN<a name='5846'>
        DO mgs = 1,ngscnt<a name='5847'>
          tmp = Min( 0.0, temcg(mgs) )<a name='5848'>
          cnostmp(mgs) = Min( 2.e8, 2.e6*exp(0.12*tmp) )<a name='5849'>
        ENDDO<a name='5850'>
      ENDIF<a name='5851'>
<a name='5852'>
<a name='5853'>
<font color=#447700>!<a name='5854'></font>
<font color=#447700>!  set concentrations<a name='5855'></font>
<font color=#447700>!<a name='5856'></font>
      cx(:,:) = 0.0<a name='5857'>
      <a name='5858'>
      if ( ipconc .ge. 1 .and. li .gt. 1 .and. (ildo == 0 .or. ildo == li ) ) then<a name='5859'>
       do mgs = 1,ngscnt<a name='5860'>
        cx(mgs,li) = Max(an(igs(mgs),jy,kgs(mgs),lni), 0.0)<a name='5861'>
       end do<a name='5862'>
      end if<a name='5863'>
      if ( ipconc .ge. 2 .and. lc .gt. 1 .and. (ildo == 0 .or. ildo == lc ) ) then<a name='5864'>
       do mgs = 1,ngscnt<a name='5865'>
        cx(mgs,lc) = Max(an(igs(mgs),jy,kgs(mgs),lnc), 0.0)<a name='5866'>
<font color=#447700>!        cx(mgs,lc) = Min( ccwmx, cx(mgs,lc) )<a name='5867'></font>
       end do<a name='5868'>
      end if<a name='5869'>
      if ( ipconc .ge. 3 .and. lr .gt. 1 .and. (ildo == 0 .or. ildo == lr ) ) then<a name='5870'>
       do mgs = 1,ngscnt<a name='5871'>
        cx(mgs,lr) = Max(an(igs(mgs),jy,kgs(mgs),lnr), 0.0)<a name='5872'>
<font color=#447700>!        IF ( qx(mgs,lr) .le. qxmin(lr) ) THEN<a name='5873'></font>
<font color=#447700>!        ELSE<a name='5874'></font>
<font color=#447700>!          cx(mgs,lr) = Max( 0.0, cx(mgs,lr) )<a name='5875'></font>
<font color=#447700>!        ENDIF<a name='5876'></font>
       end do<a name='5877'>
      end if<a name='5878'>
      if ( ipconc .ge. 4  .and. ls .gt. 1 .and. (ildo == 0 .or. ildo == ls ) ) then<a name='5879'>
       do mgs = 1,ngscnt<a name='5880'>
        cx(mgs,ls) = Max(an(igs(mgs),jy,kgs(mgs),lns), 0.0)<a name='5881'>
<font color=#447700>!        IF ( qx(mgs,ls) .le. qxmin(ls) ) THEN<a name='5882'></font>
<font color=#447700>!        ELSE<a name='5883'></font>
<font color=#447700>!          cx(mgs,ls) = Max( 0.0, cx(mgs,ls) )<a name='5884'></font>
<font color=#447700>!        ENDIF<a name='5885'></font>
       end do<a name='5886'>
      end if<a name='5887'>
<a name='5888'>
      if ( ipconc .ge. 5  .and. lh .gt. 1 .and. (ildo == 0 .or. ildo == lh ) ) then<a name='5889'>
       do mgs = 1,ngscnt<a name='5890'>
<a name='5891'>
        cx(mgs,lh) = Max(an(igs(mgs),jy,kgs(mgs),lnh), 0.0)<a name='5892'>
<font color=#447700>!        IF ( qx(mgs,lh) .le. qxmin(lh) ) THEN<a name='5893'></font>
<font color=#447700>!        ELSE<a name='5894'></font>
<font color=#447700>!          cx(mgs,lh) = Max( 0.0, cx(mgs,lh) )<a name='5895'></font>
<font color=#447700>!        ENDIF<a name='5896'></font>
<a name='5897'>
       end do<a name='5898'>
      ENDIF<a name='5899'>
<a name='5900'>
      if ( ipconc .ge. 5  .and. lhl .gt. 1 .and. (ildo == 0 .or. ildo == lhl ) ) then<a name='5901'>
       do mgs = 1,ngscnt<a name='5902'>
<a name='5903'>
        cx(mgs,lhl) = Max(an(igs(mgs),jy,kgs(mgs),lnhl), 0.0)<a name='5904'>
<font color=#447700>!        IF ( qx(mgs,lhl) .le. qxmin(lhl) ) THEN<a name='5905'></font>
<font color=#447700>!          cx(mgs,lhl) = 0.0<a name='5906'></font>
<font color=#447700>!        ELSEIF ( cx(mgs,lhl) .eq. 0.0 .and. qx(mgs,lhl) .lt. 3.0*qxmin(lhl) ) THEN<a name='5907'></font>
<font color=#447700>!          qx(mgs,lhl) = 0.0<a name='5908'></font>
<font color=#447700>!        ELSE<a name='5909'></font>
<font color=#447700>!          cx(mgs,lhl) = Max( 0.0, cx(mgs,lhl) )<a name='5910'></font>
<font color=#447700>!        ENDIF<a name='5911'></font>
<a name='5912'>
       end do<a name='5913'>
      end if<a name='5914'>
       <a name='5915'>
      do mgs = 1,ngscnt<a name='5916'>
        xdn(mgs,lc) = xdn0(lc)<a name='5917'>
        xdn(mgs,lr) = xdn0(lr)<a name='5918'>
<font color=#447700>!        IF ( ls .gt. 1 .and. lvs .eq. 0 ) xdn(mgs,ls) = xdn0(ls)<a name='5919'></font>
<font color=#447700>!        IF ( lh .gt. 1 .and. lvh .eq. 0 ) xdn(mgs,lh) = xdn0(lh)<a name='5920'></font>
        IF ( li .gt. 1 )  xdn(mgs,li) = xdn0(li)<a name='5921'>
        IF ( ls .gt. 1 )  xdn(mgs,ls) = xdn0(ls)<a name='5922'>
        IF ( lh .gt. 1 )  xdn(mgs,lh) = xdn0(lh)<a name='5923'>
        IF ( lhl .gt. 1 ) xdn(mgs,lhl) = xdn0(lhl)<a name='5924'>
      end do<a name='5925'>
<a name='5926'>
<font color=#447700>!<a name='5927'></font>
<font color=#447700>! Set mean particle volume<a name='5928'></font>
<font color=#447700>!<a name='5929'></font>
      IF ( ldovol .and. (ildo == 0 .or. ildo &gt;= li ) ) THEN<a name='5930'>
      <a name='5931'>
      vx(:,:) = 0.0<a name='5932'>
      <a name='5933'>
       DO il = l1,l2<a name='5934'>
        <a name='5935'>
        IF ( lvol(il) .ge. 1 ) THEN<a name='5936'>
        <a name='5937'>
          DO mgs = 1,ngscnt<a name='5938'>
            vx(mgs,il) = Max(an(igs(mgs),jy,kgs(mgs),lvol(il)), 0.0)<a name='5939'>
            IF ( vx(mgs,il) .gt. rho0(mgs)*qxmin(il)*1.e-3 .and. qx(mgs,il) .gt. qxmin(il) ) THEN<a name='5940'>
              xdn(mgs,il) = Min( xdnmx(il), Max( xdnmn(il), rho0(mgs)*qx(mgs,il)/vx(mgs,il) ) )<a name='5941'>
            ENDIF<a name='5942'>
          ENDDO<a name='5943'>
          <a name='5944'>
        ENDIF<a name='5945'>
      <a name='5946'>
       ENDDO<a name='5947'>
      <a name='5948'>
      ENDIF<a name='5949'>
<a name='5950'>
      DO il = lg,lhab<a name='5951'>
      DO mgs = 1,ngscnt<a name='5952'>
        alpha(mgs,il) = dnu(il)<a name='5953'>
      ENDDO<a name='5954'>
      ENDDO<a name='5955'>
      <a name='5956'>
      IF ( imurain == 1 ) THEN<a name='5957'>
        alpha(:,lr) = alphar<a name='5958'>
      ELSEIF ( imurain == 3 ) THEN<a name='5959'>
        alpha(:,lr) = xnu(lr)<a name='5960'>
      ENDIF<a name='5961'>
       <a name='5962'>
<a name='5963'>
<a name='5964'>
<a name='5965'>
<a name='5966'>
<a name='5967'>
<a name='5968'>
<font color=#447700>!<a name='5969'></font>
<font color=#447700>!  Set density<a name='5970'></font>
<font color=#447700>!<a name='5971'></font>
      if (ndebugzf .gt. 0 ) write(0,*)  'ZIEGFALL: call setvtz'<a name='5972'>
<font color=#447700>!<a name='5973'></font>
      <a name='5974'>
      call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SETVTZ'>setvtz</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#ZIEGFALL1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETVTZ_1">(ngscnt,qx,qxmin,qxw,cx,rho0,rhovt,xdia,cno,cnostmp,   &amp;<a name='5975'>
     &amp;                 xmas,vtxbar,xdn,xvmn,xvmx,xv,cdx,        &amp;<a name='5976'>
     &amp;                 ipconc,ndebugzf,ngs,nz,kgs,fadvisc, &amp;<a name='5977'>
     &amp;                 cwmasn,cwmasx,cwradn,cnina,cimn,cimx,    &amp;<a name='5978'>
     &amp;                 itype1,itype2,temcg,infdo,alpha,ildo,axh,bxh,axhl,bxhl)<a name='5979'>
<a name='5980'>
<a name='5981'>
<a name='5982'>
<font color=#447700>!<a name='5983'></font>
<font color=#447700>! put fall speeds into the x-z arrays<a name='5984'></font>
<font color=#447700>!<a name='5985'></font>
      DO il = l1,l2<a name='5986'>
      do mgs = 1,ngscnt<a name='5987'>
       <a name='5988'>
       vtmax = 150.0<a name='5989'>
<a name='5990'>
       <a name='5991'>
       IF ( vtxbar(mgs,il,2) .gt. vtxbar(mgs,il,1)  .or. &amp;<a name='5992'>
     &amp;      ( vtxbar(mgs,il,1) .gt. vtxbar(mgs,il,3) .and. vtxbar(mgs,il,3) &gt; 0.0) ) THEN<a name='5993'>
          <a name='5994'>
          <a name='5995'>
          <a name='5996'>
          vtxbar(mgs,il,1) = Max( vtxbar(mgs,il,1), vtxbar(mgs,il,2) )<a name='5997'>
          vtxbar(mgs,il,3) = Max( vtxbar(mgs,il,3), vtxbar(mgs,il,1) )<a name='5998'>
          <a name='5999'>
       ENDIF<a name='6000'>
<a name='6001'>
       <a name='6002'>
       IF ( vtxbar(mgs,il,1) .gt. vtmax .or. vtxbar(mgs,il,2) .gt. vtmax .or. &amp;<a name='6003'>
     &amp;      vtxbar(mgs,il,3) .gt. vtmax ) THEN<a name='6004'>
       <a name='6005'>
        vtxbar(mgs,il,1) = Min(vtmax,vtxbar(mgs,il,1) )<a name='6006'>
        vtxbar(mgs,il,2) = Min(vtmax,vtxbar(mgs,il,2) )<a name='6007'>
        vtxbar(mgs,il,3) = Min(vtmax,vtxbar(mgs,il,3) )<a name='6008'>
        <a name='6009'>
<font color=#447700>!        call commasmpi_abort()<a name='6010'></font>
       ENDIF<a name='6011'>
<a name='6012'>
<a name='6013'>
       xvt(kgs(mgs),igs(mgs),1,il) = vtxbar(mgs,il,1)<a name='6014'>
       xvt(kgs(mgs),igs(mgs),2,il) = vtxbar(mgs,il,2)<a name='6015'>
       IF ( infdo .ge. 2 ) THEN<a name='6016'>
       xvt(kgs(mgs),igs(mgs),3,il) = vtxbar(mgs,il,3)<a name='6017'>
       ELSE<a name='6018'>
       xvt(kgs(mgs),igs(mgs),3,il) = 0.0<a name='6019'>
       ENDIF<a name='6020'>
<a name='6021'>
<font color=#447700>!       xvt(kgs(mgs),igs(mgs),2,il) = xvt(kgs(mgs),igs(mgs),1,il)<a name='6022'></font>
<a name='6023'>
      enddo<a name='6024'>
      ENDDO<a name='6025'>
<a name='6026'>
<a name='6027'>
      if (ndebugzf .gt. 0 ) write(0,*)  'ZIEGFALL: COPIED FALL SPEEDS'<a name='6028'>
<a name='6029'>
<a name='6030'>
<a name='6031'>
 9998 continue<a name='6032'>
<a name='6033'>
      if (ndebugzf .gt. 0 ) write(0,*)  'ZIEGFALL: DONE WITH LOOP'<a name='6034'>
<a name='6035'>
      if ( kz .gt. nz-1 ) then<a name='6036'>
        go to 1200<a name='6037'>
      else<a name='6038'>
        nzmpb = kz <a name='6039'>
      end if<a name='6040'>
<a name='6041'>
      if (ndebugzf .gt. 0 ) write(0,*) 'ZIEGFALL: SET NZMPB'<a name='6042'>
<a name='6043'>
      end do <font color=#447700>!! inumgs<a name='6044'></font>
<a name='6045'>
      if (ndebugzf .gt. 0 ) write(0,*) 'ZIEGFALL: SET NXMPB'<a name='6046'>
<a name='6047'>
 1200 continue<a name='6048'>
<a name='6049'>
<a name='6050'>
<font color=#447700>!       ENDDO ! ix<a name='6051'></font>
<font color=#447700>!      ENDDO ! kz<a name='6052'></font>
<a name='6053'>
<a name='6054'>
      if (ndebugzf .gt. 0 ) write(0,*) "ZIEGFALL: EXITING SUBROUTINE"<a name='6055'>
<a name='6056'>
<a name='6057'>
      RETURN<a name='6058'>
      END subroutine ziegfall1d<a name='6059'>
<a name='6060'>
<font color=#447700>! #####################################################################<a name='6061'></font>
<font color=#447700>! #####################################################################<a name='6062'></font>
<a name='6063'>
<a name='6064'>
<font color=#447700>! #####################################################################<a name='6065'></font>
<font color=#447700>! #####################################################################<a name='6066'></font>
<a name='6067'>
<font color=#447700>! ##############################################################################<a name='6068'></font>
<A NAME='RADARDD02'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#RADARDD02' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6069'>
      <font color=#993300>subroutine </font><font color=#cc0000>radardd02</font>(nx,ny,nz,nor,na,an,temk,         &amp; <A href='../../call_to/RADARDD02.html' TARGET='index'>1</A><a name='6070'>
     &amp;    dbz,db,nzdbz,cnoh0t,hwdn1t,ipconc, iunit)<a name='6071'>
<font color=#447700>!<a name='6072'></font>
<font color=#447700>! 11.13.2005: Changed values of indices for reordering of lip<a name='6073'></font>
<font color=#447700>!<a name='6074'></font>
<font color=#447700>! 07.13.2005: Fixed an error where cnoh was being used for graupel and frozen drops<a name='6075'></font>
<font color=#447700>!<a name='6076'></font>
<font color=#447700>! 01.24.2005: add ice crystal reflectivity using parameterization of<a name='6077'></font>
<font color=#447700>!             Heymsfield (JAS, 1977).  Could also try Ferrier for this, too.<a name='6078'></font>
<font color=#447700>!<a name='6079'></font>
<font color=#447700>!  09.28.2002 Test alterations for dry ice following Ferrier (1994)<a name='6080'></font>
<font color=#447700>!      for equivalent melted diameter reflectivity.<a name='6081'></font>
<font color=#447700>!      Converted to Fortran by ERM.<a name='6082'></font>
<font color=#447700>!      <a name='6083'></font>
<font color=#447700>!Date: Tue, 21 Nov 2000 10:13:36 -0600 (CST)<a name='6084'></font>
<font color=#447700>!From: Matthew Gilmore &lt;gilmore@hesston.met.tamu.edu&gt;<a name='6085'></font>
<font color=#447700>!<a name='6086'></font>
<font color=#447700>!PRO RF_SPEC ; Computes Radar Reflectivity<a name='6087'></font>
<font color=#447700>!COMMON MAINB, data, x1d, y1d, z1d, iconst, rconst, labels, nx, ny, nz, dshft<a name='6088'></font>
<font color=#447700>!<a name='6089'></font>
<font color=#447700>!;MODIFICATION HISTORY<a name='6090'></font>
<font color=#447700>!; 5/99  -Svelta Veleva introduces variable dielf (const_ki_x) as a (weak)<a name='6091'></font>
<font color=#447700>!;   function of density.  This leads to slight modification of dielf such<a name='6092'></font>
<font color=#447700>!;   that the snow reflectivity is slightly increased - not a big effect.<a name='6093'></font>
<font color=#447700>!;   This is believed to be more accurate than assuming the dielectric<a name='6094'></font>
<font color=#447700>!;   constant for snow is the same as for hail in previous versions.<a name='6095'></font>
<font color=#447700>!<a name='6096'></font>
<font color=#447700>!;On 6/13/99 I added the VIL computation (k=0 in vil array)<a name='6097'></font>
<font color=#447700>!;On 6/15/99 I removed the number concentration dependencies as a function<a name='6098'></font>
<font color=#447700>!;           of temperature (only use for ferrier!)<a name='6099'></font>
<font color=#447700>!;On 6/15/99 I added the Composite reflectivity (k=1 in VIL array)<a name='6100'></font>
<font color=#447700>!;On 6/15/99 I added the Severe Hail Index computation (k=2 in vil array)<a name='6101'></font>
<font color=#447700>!;<a name='6102'></font>
<font color=#447700>!; 6/99 - Veleva and Seo argue that since graupel is more similar to<a name='6103'></font>
<font color=#447700>!;   snow (in number conc and size density) than it is to hail, we<a name='6104'></font>
<font color=#447700>!;   should not weight wetted graupel with the .95 exponent correction<a name='6105'></font>
<font color=#447700>!;   factor as in the case of hail.  An if-statement checks the size<a name='6106'></font>
<font color=#447700>!;   density for wet hail/graupel and treats them appropriately.<a name='6107'></font>
<font color=#447700>!;<a name='6108'></font>
<font color=#447700>!; 6/22/99 - Added function to compute height of max rf and 40 dbz echo top<a name='6109'></font>
<font color=#447700>!;           Also added vilqr which is the model vertical integrated liquid only<a name='6110'></font>
<font color=#447700>!;           using qr.  Will need to check...doesn't seem consistent with vilZ<a name='6111'></font>
<font color=#447700>!;<a name='6112'></font>
<a name='6113'>
<a name='6114'>
      implicit none<a name='6115'>
      <a name='6116'>
      character(LEN=15), parameter :: microp = 'ZVD'<a name='6117'>
      integer nx,ny,nz,nor,na,ngt<a name='6118'>
      integer nzdbz    <font color=#447700>!  how many levels actually to process<a name='6119'></font>
      <a name='6120'>
      integer ng1,n10<a name='6121'>
      integer iunit<a name='6122'>
      integer, parameter :: printyn = 0<a name='6123'>
<a name='6124'>
      parameter( ng1 = 1 )<a name='6125'>
      <a name='6126'>
      real cnoh0t,hwdn1t<a name='6127'>
      integer ipconc<a name='6128'>
      real vr<a name='6129'>
<a name='6130'>
<a name='6131'>
      integer imapz,mzdist<a name='6132'>
      <a name='6133'>
      integer vzflag<a name='6134'>
      integer, parameter :: norz = 3<a name='6135'>
      real an(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor,na)<a name='6136'>
      real db(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor)  <font color=#447700>! air density<a name='6137'></font>
<font color=#447700>!      real gt(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor,ngt)<a name='6138'></font>
      real temk(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor)  <font color=#447700>! air temperature (kelvin)<a name='6139'></font>
      real dbz(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-nor+ng1:nz+nor)   <font color=#447700>! reflectivity<a name='6140'></font>
      real gz(-nor+1:nz+nor) <font color=#447700>! ,z1d(-nor+1:nz+nor,4)<a name='6141'></font>
      <a name='6142'>
<font color=#447700>!      real g,rgas,eta,inveta<a name='6143'></font>
      real cr1, cr2 ,  hwdnsq,swdnsq<a name='6144'>
      real rwdnsq, dhmin, qrmin, qsmin, qhmin, qhlmin, tfr, tfrh, zrc<a name='6145'>
      real reflectmin,  kw_sq<a name='6146'>
      real const_ki_sn, const_ki_h, ki_sq_sn<a name='6147'>
      real ki_sq_h, dielf_sn, dielf_h<a name='6148'>
      real pi<a name='6149'>
      logical ltest<a name='6150'>
<a name='6151'>
<font color=#447700>!  Other data arrays<a name='6152'></font>
       real gtmp     (nx,nz)<a name='6153'>
       real dtmp     (nx,nz)<a name='6154'>
       real tmp<a name='6155'>
<a name='6156'>
       real*8 dtmps, dtmpr, dtmph, dtmphl, g1, zx, ze, x<a name='6157'>
<a name='6158'>
       integer i,j,k,ix,jy,kz,ihcnt<a name='6159'>
<a name='6160'>
        real*8 xcnoh, xcnos, dadh, dads, zhdryc, zsdryc, zhwetc,zswetc<a name='6161'>
        real*8 dadr<a name='6162'>
        real dbzmax,dbzmin<a name='6163'>
        parameter ( dbzmin = 0 )<a name='6164'>
<a name='6165'>
      real cnow,cnoi,cnoip,cnoir,cnor,cnos<a name='6166'>
      real cnogl,cnogm,cnogh,cnof,cnoh,cnohl<a name='6167'>
<a name='6168'>
      real swdn, rwdn ,hwdn,gldn,gmdn,ghdn,fwdn,hldn<a name='6169'>
      real swdn0<a name='6170'>
<a name='6171'>
      real rwdnmx,cwdnmx,cidnmx,xidnmx,swdnmx,gldnmx,gmdnmx<a name='6172'>
      real ghdnmx,fwdnmx,hwdnmx,hldnmx<a name='6173'>
      real rwdnmn,cwdnmn,cidnmn,xidnmn,swdnmn,gldnmn,gmdnmn<a name='6174'>
      real ghdnmn,fwdnmn,hwdnmn,hldnmn<a name='6175'>
 <a name='6176'>
      real gldnsq,gmdnsq,ghdnsq,fwdnsq,hldnsq<a name='6177'>
<a name='6178'>
      real dadgl,dadgm,dadgh,dadhl,dadf<a name='6179'>
      real zgldryc,zglwetc,zgmdryc, zgmwetc,zghdryc,zghwetc<a name='6180'>
      real zhldryc,zhlwetc,zfdryc,zfwetc<a name='6181'>
<a name='6182'>
      real dielf_gl,dielf_gm,dielf_gh,dielf_hl,dielf_fw<a name='6183'>
      <a name='6184'>
      integer imx,jmx,kmx<a name='6185'>
      <a name='6186'>
      real swdia,gldia,gmdia,ghdia,fwdia,hwdia,hldia<a name='6187'>
      <a name='6188'>
      real csw,cgl,cgm,cgh,cfw,chw,chl<a name='6189'>
      real xvs,xvgl,xvgm,xvgh,xvf,xvh,xvhl<a name='6190'>
      <a name='6191'>
      real cwc0<a name='6192'>
      integer izieg<a name='6193'>
      integer ice10<a name='6194'>
      real rhos<a name='6195'>
      parameter ( rhos = 0.1 )<a name='6196'>
      <a name='6197'>
      real qxw,qxw1    <font color=#447700>! temp value for liquid water on ice mixing ratio<a name='6198'></font>
      real :: dnsnow<a name='6199'>
      real qh<a name='6200'>
<a name='6201'>
      real, parameter :: cwmasn = 5.23e-13   <font color=#447700>! minimum mass, defined by radius of 5.0e-6<a name='6202'></font>
      real, parameter :: cwmasx = 5.25e-10   <font color=#447700>! maximum mass, defined by radius of 50.0e-6<a name='6203'></font>
      real, parameter :: cwradn = 5.0e-6     <font color=#447700>! minimum radius<a name='6204'></font>
<a name='6205'>
      real cwnccn(nz)<a name='6206'>
      <a name='6207'>
      real :: vzsnow, vzrain, vzgraupel, vzhail<a name='6208'>
      real :: ksq<a name='6209'>
      real :: dtp<a name='6210'>
<a name='6211'>
<a name='6212'>
<font color=#447700>! #########################################################################      <a name='6213'></font>
<a name='6214'>
      vzflag = 0<a name='6215'>
      <a name='6216'>
      izieg = 0<a name='6217'>
      ice10 = 0<a name='6218'>
<font color=#447700>!      g=9.806                 ! g: gravity constant<a name='6219'></font>
<font color=#447700>!      rgas=287.04             ! rgas: gas constant for dry air<a name='6220'></font>
<font color=#447700>!      rcp=rgas/cp             ! rcp: gamma constant<a name='6221'></font>
<font color=#447700>!      eta=0.622<a name='6222'></font>
<font color=#447700>!      inveta = 1./eta<a name='6223'></font>
<font color=#447700>!      rcpinv = 1./rcp<a name='6224'></font>
<font color=#447700>!      cpr=cp/rgas<a name='6225'></font>
<font color=#447700>!      cvr=cv/rgas<a name='6226'></font>
      pi = 4.0*ATan(1.)<a name='6227'>
      cwc0 = piinv <font color=#447700>! 1./pi ! 6.0/pi<a name='6228'></font>
      <a name='6229'>
      cnoh = cnoh0t<a name='6230'>
      hwdn = hwdn1t<a name='6231'>
<a name='6232'>
      rwdn = 1000.0<a name='6233'>
      swdn = 100.0<a name='6234'>
<a name='6235'>
      qrmin = 1.0e-05<a name='6236'>
      qsmin = 1.0e-06<a name='6237'>
      qhmin = 1.0e-05<a name='6238'>
<a name='6239'>
<font color=#447700>!<a name='6240'></font>
<font color=#447700>!  default slope intercepts<a name='6241'></font>
<font color=#447700>!<a name='6242'></font>
      cnow  = 1.0e+08<a name='6243'>
      cnoi  = 1.0e+08<a name='6244'>
      cnoip = 1.0e+08 <a name='6245'>
      cnoir = 1.0e+08 <a name='6246'>
      cnor  = 8.0e+06 <a name='6247'>
      cnos  = 8.0e+06 <a name='6248'>
      cnogl = 4.0e+05 <a name='6249'>
      cnogm = 4.0e+05 <a name='6250'>
      cnogh = 4.0e+05 <a name='6251'>
      cnof  = 4.0e+05<a name='6252'>
      cnohl = 1.0e+03<a name='6253'>
<a name='6254'>
<a name='6255'>
      imx = 1<a name='6256'>
      jmx = 1<a name='6257'>
      kmx = 1<a name='6258'>
      i = 1<a name='6259'>
<a name='6260'>
<a name='6261'>
       IF ( microp(1:4) .eq. 'ZIEG' ) THEN <font color=#447700>!  na .ge. 14 .and. ipconc .ge. 3 ) THEN <a name='6262'></font>
<a name='6263'>
<font color=#447700>!        write(0,*)  'Set reflectivity for ZIEG'<a name='6264'></font>
         izieg = 1<a name='6265'>
<a name='6266'>
         hwdn = hwdn1t <font color=#447700>! 500.<a name='6267'></font>
<a name='6268'>
<a name='6269'>
         cnor  = cno(lr)<a name='6270'>
         cnos  = cno(ls)<a name='6271'>
         cnoh  = cno(lh)<a name='6272'>
         qrmin = qxmin(lr)<a name='6273'>
         qsmin = qxmin(ls)<a name='6274'>
         qhmin = qxmin(lh)<a name='6275'>
         IF ( lhl .gt. 1 ) THEN<a name='6276'>
            cnohl  = cno(lhl)<a name='6277'>
            qhlmin = qxmin(lhl)<a name='6278'>
         ENDIF<a name='6279'>
<a name='6280'>
       ELSEIF ( microp(1:3) .eq. 'ZVD' ) THEN <font color=#447700>!  na .ge. 14 .and. ipconc .ge. 3 ) THEN <a name='6281'></font>
<a name='6282'>
         izieg = 1<a name='6283'>
         <a name='6284'>
         swdn0 = swdn<a name='6285'>
<a name='6286'>
         cnor  = cno(lr)<a name='6287'>
         cnos  = cno(ls)<a name='6288'>
         cnoh  = cno(lh)<a name='6289'>
         <a name='6290'>
         qrmin = qxmin(lr)<a name='6291'>
         qsmin = qxmin(ls)<a name='6292'>
         qhmin = qxmin(lh)<a name='6293'>
         IF ( lhl .gt. 1 ) THEN<a name='6294'>
            cnohl  = cno(lhl)<a name='6295'>
            qhlmin = qxmin(lhl)<a name='6296'>
         ENDIF<a name='6297'>
<font color=#447700>!         write(*,*) 'radardbz: ',db(1,1,1),temk(1,1,1),an(1,1,1,lr),an(1,1,1,ls),an(1,1,1,lh)<a name='6298'></font>
<a name='6299'>
<a name='6300'>
        ENDIF<a name='6301'>
<a name='6302'>
<a name='6303'>
<font color=#447700>!      cdx(lr) = 0.60<a name='6304'></font>
<font color=#447700>!      <a name='6305'></font>
<font color=#447700>!      IF ( lh &gt; 1 ) THEN<a name='6306'></font>
<font color=#447700>!      cdx(lh) = 0.8 ! 1.0 ! 0.45<a name='6307'></font>
<font color=#447700>!      cdx(ls) = 2.00<a name='6308'></font>
<font color=#447700>!      ENDIF<a name='6309'></font>
<font color=#447700>!<a name='6310'></font>
<font color=#447700>!      IF ( lhl .gt. 1 ) cdx(lhl) = 0.45<a name='6311'></font>
<font color=#447700>!<a name='6312'></font>
<font color=#447700>!      xvmn(lc) = xvcmn<a name='6313'></font>
<font color=#447700>!      xvmn(lr) = xvrmn<a name='6314'></font>
<font color=#447700>!<a name='6315'></font>
<font color=#447700>!      xvmx(lc) = xvcmx<a name='6316'></font>
<font color=#447700>!      xvmx(lr) = xvrmx<a name='6317'></font>
<font color=#447700>!<a name='6318'></font>
<font color=#447700>!      IF ( lh &gt; 1 ) THEN<a name='6319'></font>
<font color=#447700>!      xvmn(ls) = xvsmn<a name='6320'></font>
<font color=#447700>!      xvmn(lh) = xvhmn<a name='6321'></font>
<font color=#447700>!      xvmx(ls) = xvsmx<a name='6322'></font>
<font color=#447700>!      xvmx(lh) = xvhmx<a name='6323'></font>
<font color=#447700>!      ENDIF<a name='6324'></font>
<font color=#447700>!<a name='6325'></font>
<font color=#447700>!      IF ( lhl .gt. 1 ) THEN<a name='6326'></font>
<font color=#447700>!      xvmn(lhl) = xvhlmn<a name='6327'></font>
<font color=#447700>!      xvmx(lhl) = xvhlmx<a name='6328'></font>
<font color=#447700>!      ENDIF<a name='6329'></font>
<font color=#447700>!<a name='6330'></font>
<font color=#447700>!      xdnmx(lr) = 1000.0<a name='6331'></font>
<font color=#447700>!      xdnmx(lc) = 1000.0<a name='6332'></font>
<font color=#447700>!      IF ( lh &gt; 1 ) THEN<a name='6333'></font>
<font color=#447700>!      xdnmx(li) =  917.0<a name='6334'></font>
<font color=#447700>!      xdnmx(ls) =  300.0<a name='6335'></font>
<font color=#447700>!      xdnmx(lh) =  900.0<a name='6336'></font>
<font color=#447700>!      ENDIF<a name='6337'></font>
<font color=#447700>!      IF ( lhl .gt. 1 ) xdnmx(lhl) = 900.0<a name='6338'></font>
<font color=#447700>!!<a name='6339'></font>
<font color=#447700>!      xdnmn(:) = 900.0<a name='6340'></font>
<font color=#447700>!      <a name='6341'></font>
<font color=#447700>!      xdnmn(lr) = 1000.0<a name='6342'></font>
<font color=#447700>!      xdnmn(lc) = 1000.0<a name='6343'></font>
<font color=#447700>!      IF ( lh &gt; 1 ) THEN<a name='6344'></font>
<font color=#447700>!      xdnmn(li) =  100.0<a name='6345'></font>
<font color=#447700>!      xdnmn(ls) =  100.0<a name='6346'></font>
<font color=#447700>!      xdnmn(lh) =  hdnmn<a name='6347'></font>
<font color=#447700>!      ENDIF<a name='6348'></font>
<font color=#447700>!      IF ( lhl .gt. 1 ) xdnmn(lhl) = 500.0<a name='6349'></font>
<font color=#447700>!<a name='6350'></font>
<font color=#447700>!      xdn0(:) = 900.0<a name='6351'></font>
<font color=#447700>!      <a name='6352'></font>
<font color=#447700>!      xdn0(lc) = 1000.0<a name='6353'></font>
<font color=#447700>!      xdn0(lr) = 1000.0<a name='6354'></font>
<font color=#447700>!      IF ( lh &gt; 1 ) THEN<a name='6355'></font>
<font color=#447700>!      xdn0(li) = 900.0<a name='6356'></font>
<font color=#447700>!      xdn0(ls) = 100.0 ! 100.0<a name='6357'></font>
<font color=#447700>!      xdn0(lh) = hwdn1t ! (0.5)*(xdnmn(lh)+xdnmx(lh))<a name='6358'></font>
<font color=#447700>!      ENDIF<a name='6359'></font>
<font color=#447700>!      IF ( lhl .gt. 1 ) xdn0(lhl) = 800.0<a name='6360'></font>
<a name='6361'>
<font color=#447700>!<a name='6362'></font>
<font color=#447700>!  slope intercepts<a name='6363'></font>
<font color=#447700>!<a name='6364'></font>
<font color=#447700>!      cnow  = 1.0e+08<a name='6365'></font>
<font color=#447700>!      cnoi  = 1.0e+08<a name='6366'></font>
<font color=#447700>!      cnoip = 1.0e+08 <a name='6367'></font>
<font color=#447700>!      cnoir = 1.0e+08 <a name='6368'></font>
<font color=#447700>!      cnor  = 8.0e+06 <a name='6369'></font>
<font color=#447700>!      cnos  = 8.0e+06 <a name='6370'></font>
<font color=#447700>!      cnogl = 4.0e+05 <a name='6371'></font>
<font color=#447700>!      cnogm = 4.0e+05 <a name='6372'></font>
<font color=#447700>!      cnogh = 4.0e+05 <a name='6373'></font>
<font color=#447700>!      cnof  = 4.0e+05<a name='6374'></font>
<font color=#447700>!c      cnoh  = 4.0e+04<a name='6375'></font>
<font color=#447700>!      cnohl = 1.0e+03<a name='6376'></font>
<font color=#447700>!<a name='6377'></font>
<font color=#447700>!<a name='6378'></font>
<font color=#447700>!  density maximums and minimums<a name='6379'></font>
<font color=#447700>!<a name='6380'></font>
      rwdnmx = 1000.0<a name='6381'>
      cwdnmx = 1000.0<a name='6382'>
      cidnmx =  917.0<a name='6383'>
      xidnmx =  917.0<a name='6384'>
      swdnmx =  200.0<a name='6385'>
      gldnmx =  400.0<a name='6386'>
      gmdnmx =  600.0<a name='6387'>
      ghdnmx =  800.0<a name='6388'>
      fwdnmx =  900.0<a name='6389'>
      hwdnmx =  900.0<a name='6390'>
      hldnmx =  900.0<a name='6391'>
<font color=#447700>!<a name='6392'></font>
      rwdnmn = 1000.0<a name='6393'>
      cwdnmn = 1000.0<a name='6394'>
      xidnmn =  001.0<a name='6395'>
      cidnmn =  001.0<a name='6396'>
      swdnmn =  001.0<a name='6397'>
      gldnmn =  200.0<a name='6398'>
      gmdnmn =  400.0<a name='6399'>
      ghdnmn =  600.0<a name='6400'>
      fwdnmn =  700.0<a name='6401'>
      hwdnmn =  700.0<a name='6402'>
      hldnmn =  900.0<a name='6403'>
<a name='6404'>
      <a name='6405'>
      gldn = (0.5)*(gldnmn+gldnmx)  <font color=#447700>! 300.<a name='6406'></font>
      gmdn = (0.5)*(gmdnmn+gmdnmx)  <font color=#447700>! 500.<a name='6407'></font>
      ghdn = (0.5)*(ghdnmn+ghdnmx)  <font color=#447700>! 700.<a name='6408'></font>
      fwdn = (0.5)*(fwdnmn+fwdnmx)  <font color=#447700>! 800.<a name='6409'></font>
      hldn = (0.5)*(hldnmn+hldnmx)  <font color=#447700>! 900.<a name='6410'></font>
<a name='6411'>
<a name='6412'>
      cr1  = 7.2e+20<a name='6413'>
      cr2  = 7.295e+19<a name='6414'>
      hwdnsq = hwdn**2<a name='6415'>
      swdnsq = swdn**2<a name='6416'>
      rwdnsq = rwdn**2<a name='6417'>
<a name='6418'>
      gldnsq = gldn**2<a name='6419'>
      gmdnsq = gmdn**2<a name='6420'>
      ghdnsq = ghdn**2<a name='6421'>
      fwdnsq = fwdn**2<a name='6422'>
      hldnsq = hldn**2<a name='6423'>
      <a name='6424'>
      dhmin = 0.005<a name='6425'>
      tfr   = 273.16<a name='6426'>
      tfrh  = tfr - 8.0<a name='6427'>
      zrc   = cr1*cnor<a name='6428'>
      reflectmin = 0.0<a name='6429'>
      kw_sq = 0.93<a name='6430'>
      dbzmax = dbzmin<a name='6431'>
      <a name='6432'>
      ihcnt=0<a name='6433'>
<a name='6434'>
            <a name='6435'>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6436'></font>
<font color=#447700>!  Dielectric Factor  - Formulas implemented by Svetla Veleva<a name='6437'></font>
<font color=#447700>!                       following Battan, "Radar Meteorology" - p. 40<a name='6438'></font>
<font color=#447700>!  The result of these calculations is that the dielf numerator (ki_sq) without<a name='6439'></font>
<font color=#447700>!  the density ratio is  .2116 for hail if using 917 density and .25 for<a name='6440'></font>
<font color=#447700>!  snow if using 220 density.<a name='6441'></font>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6442'></font>
      const_ki_sn = 0.5 - (0.5-0.46)/(917.-220.)*(swdn-220.)<a name='6443'>
      const_ki_h  = 0.5 - (0.5-0.46)/(917.-220.)*(hwdn-220.)<a name='6444'>
      ki_sq_sn = (swdnsq/rwdnsq) * const_ki_sn**2<a name='6445'>
      ki_sq_h  = (hwdnsq/rwdnsq) * const_ki_h**2<a name='6446'>
      dielf_sn = ki_sq_sn / kw_sq<a name='6447'>
      dielf_h  = ki_sq_h  / kw_sq<a name='6448'>
            <a name='6449'>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6450'></font>
<font color=#447700>!  Use the next line if you want to hardwire dielf for dry hail for both dry<a name='6451'></font>
<font color=#447700>!  snow and dry hail.<a name='6452'></font>
<font color=#447700>!  This would be equivalent to what Straka had originally. (i.e, .21/.93)<a name='6453'></font>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6454'></font>
      dielf_sn = (swdnsq/rwdnsq)*.21/ kw_sq<a name='6455'>
      dielf_h  = (hwdnsq/rwdnsq)*.21/ kw_sq<a name='6456'>
<a name='6457'>
      dielf_gl  = (gldnsq/rwdnsq)*.21/ kw_sq<a name='6458'>
      dielf_gm  = (gmdnsq/rwdnsq)*.21/ kw_sq<a name='6459'>
      dielf_gh  = (ghdnsq/rwdnsq)*.21/ kw_sq<a name='6460'>
      dielf_hl  = (hldnsq/rwdnsq)*.21/ kw_sq<a name='6461'>
      dielf_fw  = (fwdnsq/rwdnsq)*.21/ kw_sq<a name='6462'>
<a name='6463'>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6464'></font>
<font color=#447700>!  Notes on dielectric factors  - from Eun-Kyoung Seo<a name='6465'></font>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6466'></font>
<font color=#447700>! constants for both snow and hail would be (x=s,h).....<a name='6467'></font>
<font color=#447700>!       xwdnsq/rwdnsq *0.21/kw_sq   ! Straka/Smith - the original<a name='6468'></font>
<font color=#447700>!       xwdnsq/rwdnsq *0.224        ! Ferrier - for particle sizes in equiv. drop diam<a name='6469'></font>
<font color=#447700>!       xwdnsq/rwdnsq *0.176/kw_sq  ! =0.189 in Smith - for particle sizes in equiv <a name='6470'></font>
<font color=#447700>!                       ice spheres<a name='6471'></font>
<font color=#447700>!       xwdnsq/rwdnsq *0.208/kw_sq  ! Smith '84 - for particle sizes in equiv melted drop diameter<a name='6472'></font>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6473'></font>
<a name='6474'>
<a name='6475'>
<font color=#447700>! VIL algorithm constants<a name='6476'></font>
<font color=#447700>!      Ztop = 10.**(56./10)           !56 dbz is the max rf used by WATADS in cell vil<a name='6477'></font>
<a name='6478'>
<a name='6479'>
<font color=#447700>! Hail detection algorithm constants<a name='6480'></font>
<font color=#447700>!      ZL = 40.<a name='6481'></font>
<font color=#447700>!      ZU = 50.<a name='6482'></font>
<font color=#447700>!      Ho = 3400.  !WATADS Defaults<a name='6483'></font>
<font color=#447700>!      Hm20 = 6200.      !WATADS Defaults<a name='6484'></font>
<a name='6485'>
<font color=#447700>!      DO kz = 1,Min(nzdbz,nz-1)<a name='6486'></font>
<a name='6487'>
      DO jy=1,1<a name='6488'>
<a name='6489'>
        DO kz = 1,nz<a name='6490'>
         <a name='6491'>
          DO ix=1,nx<a name='6492'>
            dbz(ix,jy,kz) = 0.0<a name='6493'>
                      <a name='6494'>
          vzsnow = 0.0<a name='6495'>
          vzrain = 0.0<a name='6496'>
          vzgraupel = 0.0<a name='6497'>
          vzhail = 0.0<a name='6498'>
          <a name='6499'>
          dtmph = 0.0<a name='6500'>
          dtmps = 0.0<a name='6501'>
          dtmphl = 0.0<a name='6502'>
          dtmpr = 0.0<a name='6503'>
           dadr = (db(ix,jy,kz)/(pi*rwdn*cnor))**(0.25)<a name='6504'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6505'></font>
<font color=#447700>! Compute Rain Radar Reflectivity<a name='6506'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6507'></font>
           <a name='6508'>
           dtmp(ix,kz) = 0.0<a name='6509'>
           gtmp(ix,kz) = 0.0<a name='6510'>
           IF ( an(ix,jy,kz,lr) .ge. qrmin ) THEN<a name='6511'>
             IF ( ipconc .le. 2 ) THEN<a name='6512'>
               gtmp(ix,kz) = dadr*an(ix,jy,kz,lr)**(0.25)<a name='6513'>
               dtmp(ix,kz) = zrc*gtmp(ix,kz)**7<a name='6514'>
             ELSEIF ( an(ix,jy,kz,lnr) .gt. 1.e-3 ) THEN<a name='6515'>
               IF ( imurain == 3 ) THEN<a name='6516'>
                 vr = db(ix,jy,kz)*an(ix,jy,kz,lr)/(1000.*an(ix,jy,kz,lnr))<a name='6517'>
                 dtmp(ix,kz) = 3.6e18*(rnu+2.)*an(ix,jy,kz,lnr)*vr**2/(rnu+1.)<a name='6518'>
               ELSE <font color=#447700>! imurain == 1<a name='6519'></font>
                g1 = (6.0 + alphar)*(5.0 + alphar)*(4.0 + alphar)/((3.0 + alphar)*(2.0 + alphar)*(1.0 + alphar))<a name='6520'>
                zx = g1*(db(ix,jy,kz)*an(ix,jy,kz,lr))**2/an(ix,jy,kz,lnr)<a name='6521'>
                ze =1.e18*zx*(6./(pi*1000.))**2 <font color=#447700>! note: using 1000. here for water density<a name='6522'></font>
                dtmp(ix,kz) = ze<a name='6523'>
               ENDIF<a name='6524'>
             ENDIF<a name='6525'>
             dtmpr = dtmp(ix,kz)<a name='6526'>
           ENDIF<a name='6527'>
           <a name='6528'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6529'></font>
<font color=#447700>! Compute snow and graupel reflectivity<a name='6530'></font>
<font color=#447700>!<a name='6531'></font>
<font color=#447700>! Lou modified to look at parcel temperature rather than base state<a name='6532'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6533'></font>
<a name='6534'>
          IF( lhab .gt. lr ) THEN<a name='6535'>
<a name='6536'>
<font color=#447700>!    qs2d   = reform(data[*,*,k,10],[nx*ny])<a name='6537'></font>
<font color=#447700>!    qh2d   = reform(data[*,*,k,11],[nx*ny])<a name='6538'></font>
<a name='6539'>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6540'></font>
<font color=#447700>! Only use the following lines if running Straka's GEMS microphysics<a name='6541'></font>
<font color=#447700>!  (Sam 1-d version modified by L Wicker does not use this)<a name='6542'></font>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6543'></font>
<font color=#447700>!    ;xcnoh    = cnoh*exp(-0.025*(temp-tfr))<a name='6544'></font>
<font color=#447700>!    ;xcnos    = cnos*exp(-0.038*(temp-tfr))<a name='6545'></font>
<font color=#447700>!    ;good = where(temp GT tfr, n_elements)<a name='6546'></font>
<font color=#447700>!    ;IF n_elements NE 0 THEN xcnoh(good) = cnoh*exp(-0.075*(temp(good)-tfr))<a name='6547'></font>
<font color=#447700>!    ;IF n_elements NE 0 THEN xcnos(good) = cnos*exp(-0.088*(temp(good)-tfr))<a name='6548'></font>
<a name='6549'>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6550'></font>
<font color=#447700>! Only use the following lines if running Ferrier micro with No=No(T)<a name='6551'></font>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6552'></font>
<font color=#447700>!    ;  NOSE = -.15<a name='6553'></font>
<font color=#447700>!    ;  NOGE =  .0<a name='6554'></font>
<font color=#447700>!    ;  xcnoh = cnoh*(1.&gt;exp(NOGE*(temp-tfr)) )<a name='6555'></font>
<font color=#447700>!    ;  xcnos = cnos*(1.&gt;exp(NOSE*(temp-tfr)) )<a name='6556'></font>
<a name='6557'>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6558'></font>
<font color=#447700>! Use the following lines if Nos and Noh are constant<a name='6559'></font>
<font color=#447700>!  (As in Svetla's version of Ferrier, GCE Tao, and SAM 1-d)<a name='6560'></font>
<font color=#447700>!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<a name='6561'></font>
        xcnoh    = cnoh<a name='6562'>
        xcnos    = cnos<a name='6563'>
<a name='6564'>
<font color=#447700>!<a name='6565'></font>
<font color=#447700>! Temporary fix for predicted number concentration -- need a <a name='6566'></font>
<font color=#447700>! more appropriate reflectivity equation!<a name='6567'></font>
<font color=#447700>!<a name='6568'></font>
<font color=#447700>!        IF ( an(ix,jy,kz,lns) .lt. 0.1 ) THEN<a name='6569'></font>
<font color=#447700>!         swdia = (xvrmn*cwc0)**(1./3.)<a name='6570'></font>
<font color=#447700>!         xcnos = an(ix,jy,kz,ls)*db(ix,jy,kz)/(xvrmn*swdn*swdia)<a name='6571'></font>
<font color=#447700>!        ELSE<a name='6572'></font>
<font color=#447700>!      ! changed back to diameter of mean volume!!!<a name='6573'></font>
<font color=#447700>!         swdia =<a name='6574'></font>
<font color=#447700>!     &gt;  (an(ix,jy,kz,ls)*db(ix,jy,kz)<a name='6575'></font>
<font color=#447700>!     &gt; /(pi*swdn*an(ix,jy,kz,lns)))**(1./3.)<a name='6576'></font>
<font color=#447700>!<a name='6577'></font>
<font color=#447700>!        xcnos = an(ix,jy,kz,lns)/swdia<a name='6578'></font>
<font color=#447700>!        ENDIF<a name='6579'></font>
<a name='6580'>
        IF ( ls .gt. 1 ) THEN <font color=#447700>! {<a name='6581'></font>
        <a name='6582'>
        IF ( lvs .gt. 1 ) THEN<a name='6583'>
          IF ( an(ix,jy,kz,lvs) .gt. 0.0 ) THEN<a name='6584'>
            swdn = db(ix,jy,kz)*an(ix,jy,kz,ls)/an(ix,jy,kz,lvs)<a name='6585'>
            swdn = Min( 300., Max( 100., swdn ) )<a name='6586'>
          ELSE <a name='6587'>
            swdn = swdn0<a name='6588'>
          ENDIF<a name='6589'>
        <a name='6590'>
        ENDIF <a name='6591'>
        <a name='6592'>
        IF ( ipconc .ge. 5 ) THEN <font color=#447700>! {<a name='6593'></font>
<a name='6594'>
        xvs = db(ix,jy,kz)*an(ix,jy,kz,ls)/  &amp;<a name='6595'>
     &amp;      (swdn*Max(1.0e-3,an(ix,jy,kz,lns)))<a name='6596'>
        IF ( xvs .lt. xvsmn .or. xvs .gt. xvsmx ) THEN<a name='6597'>
          xvs = Min( xvsmx, Max( xvsmn,xvs ) )<a name='6598'>
          csw = db(ix,jy,kz)*an(ix,jy,kz,ls)/(xvs*swdn)<a name='6599'>
        ENDIF<a name='6600'>
<a name='6601'>
         swdia = (xvs*cwc0)**(1./3.)<a name='6602'>
         xcnos = an(ix,jy,kz,ls)*db(ix,jy,kz)/(xvs*swdn*swdia)<a name='6603'>
         <a name='6604'>
         ENDIF <font color=#447700>! }<a name='6605'></font>
         ENDIF  <font color=#447700>! }<a name='6606'></font>
<a name='6607'>
<font color=#447700>!        IF ( an(ix,jy,kz,lnh) .lt. 0.1 ) THEN<a name='6608'></font>
<font color=#447700>!         hwdia = (xvrmn*cwc0)**(1./3.)<a name='6609'></font>
<font color=#447700>!         xcnoh = an(ix,jy,kz,lh)*db(ix,jy,kz)/(xvrmn*hwdn*hwdia)<a name='6610'></font>
<font color=#447700>!        ELSE<a name='6611'></font>
<font color=#447700>!      ! changed back to diameter of mean volume!!!<a name='6612'></font>
<font color=#447700>!         hwdia =<a name='6613'></font>
<font color=#447700>!     &gt;  (an(ix,jy,kz,lh)*db(ix,jy,kz)<a name='6614'></font>
<font color=#447700>!     &gt; /(pi*hwdn*an(ix,jy,kz,lnh)))**(1./3.)<a name='6615'></font>
<font color=#447700>!        <a name='6616'></font>
<font color=#447700>!         xcnoh = an(ix,jy,kz,lnh)/hwdia<a name='6617'></font>
<font color=#447700>!        ENDIF<a name='6618'></font>
<a name='6619'>
        IF ( lh .gt. 1 ) THEN <font color=#447700>! {<a name='6620'></font>
<a name='6621'>
        IF ( lvh .gt. 1 ) THEN<a name='6622'>
          IF ( an(ix,jy,kz,lvh) .gt. 0.0 ) THEN<a name='6623'>
            hwdn = db(ix,jy,kz)*an(ix,jy,kz,lh)/an(ix,jy,kz,lvh)<a name='6624'>
            hwdn = Min( 900., Max( hdnmn, hwdn ) )<a name='6625'>
          ELSE <a name='6626'>
            hwdn = 500. <font color=#447700>! hwdn1t<a name='6627'></font>
          ENDIF<a name='6628'>
        ELSE<a name='6629'>
          hwdn = hwdn1t<a name='6630'>
        ENDIF <a name='6631'>
        <a name='6632'>
        IF ( ipconc .ge. 5 ) THEN <font color=#447700>! {<a name='6633'></font>
<a name='6634'>
        xvh = db(ix,jy,kz)*an(ix,jy,kz,lh)/       &amp;<a name='6635'>
     &amp;      (hwdn*Max(1.0e-3,an(ix,jy,kz,lnh)))<a name='6636'>
        IF ( xvh .lt. xvhmn .or. xvh .gt. xvhmx ) THEN<a name='6637'>
          xvh = Min( xvhmx, Max( xvhmn,xvh ) )<a name='6638'>
          chw = db(ix,jy,kz)*an(ix,jy,kz,lh)/(xvh*hwdn)<a name='6639'>
        ENDIF<a name='6640'>
<a name='6641'>
         hwdia = (xvh*cwc0)**(1./3.)<a name='6642'>
         xcnoh = an(ix,jy,kz,lh)*db(ix,jy,kz)/(xvh*hwdn*hwdia)<a name='6643'>
         <a name='6644'>
        ENDIF <font color=#447700>! } ipconc .ge. 5<a name='6645'></font>
 <a name='6646'>
        ENDIF <font color=#447700>! }<a name='6647'></font>
<a name='6648'>
        dadh = 0.0<a name='6649'>
        dadhl = 0.0<a name='6650'>
        dads = 0.0<a name='6651'>
        IF ( xcnoh .gt. 0.0 ) THEN <a name='6652'>
          dadh = ( db(ix,jy,kz) /(pi*hwdn*xcnoh) )**(.25)<a name='6653'>
          zhdryc = 0.224*cr2*(db(ix,jy,kz)/rwdn)**2/xcnoh <font color=#447700>! dielf_h*cr1*xcnoh          ! SV - equiv formula as before but<a name='6654'></font>
                                        <font color=#447700>! ratio of densities included in<a name='6655'></font>
                                        <font color=#447700>! dielf_h rather than here following<a name='6656'></font>
                                        <font color=#447700>! Battan.<a name='6657'></font>
        ELSE<a name='6658'>
          dadh = 0.0<a name='6659'>
          zhdryc = 0.0<a name='6660'>
        ENDIF<a name='6661'>
        <a name='6662'>
        IF ( xcnos .gt. 0.0 ) THEN<a name='6663'>
          dads = ( db(ix,jy,kz) /(pi*swdn*xcnos) )**(.25)<a name='6664'>
          zsdryc = 0.224*cr2*(db(ix,jy,kz)/rwdn)**2/xcnos <font color=#447700>! dielf_sn*cr1*xcnos         ! SV - similar change as above<a name='6665'></font>
        ELSE<a name='6666'>
          dads = 0.0<a name='6667'>
          zsdryc = 0.0<a name='6668'>
        ENDIF<a name='6669'>
        zhwetc = zhdryc <font color=#447700>! cr1*xcnoh      !Hail/graupel version with .95 power bug removed<a name='6670'></font>
        zswetc = zsdryc <font color=#447700>! cr1*xcnos<a name='6671'></font>
<font color=#447700>!           <a name='6672'></font>
<font color=#447700>! snow contribution<a name='6673'></font>
<font color=#447700>!<a name='6674'></font>
          IF ( ls .gt. 1 ) THEN<a name='6675'>
          <a name='6676'>
          gtmp(ix,kz) = 0.0 <a name='6677'>
          qxw = 0.0 <a name='6678'>
          qxw1 = 0.0<a name='6679'>
          dtmps = 0.0<a name='6680'>
           IF ( an(ix,jy,kz,ls) .ge. qsmin ) THEN <font color=#447700>!{<a name='6681'></font>
            IF ( ipconc .ge. 4 ) THEN  <font color=#447700>! (Ferrier 94) !{<a name='6682'></font>
<a name='6683'>
             if (lsw .gt. 1) THEN <a name='6684'>
               qxw = an(ix,jy,kz,lsw)<a name='6685'>
               qxw1 = 0.0<a name='6686'>
             ELSEIF ( iusewetsnow == 1 .and. temk(ix,jy,kz) .gt. tfr+1. .and. an(ix,jy,kz,ls) &gt; an(ix,jy,kz,lr) &amp;<a name='6687'>
     &amp;              .and. an(ix,jy,kz,lr) &gt; qsmin) THEN<a name='6688'>
               qxw = Min(0.5*an(ix,jy,kz,ls), an(ix,jy,kz,lr))<a name='6689'>
               qxw1 = qxw<a name='6690'>
             ENDIF<a name='6691'>
<a name='6692'>
             vr = xvs <font color=#447700>! db(ix,jy,kz)*an(ix,jy,kz,lr)/(1000.*an(ix,jy,kz,lnr))<a name='6693'></font>
<font color=#447700>!             gtmp(ix,kz) = 3.6e18*(0.243*rhos**2/0.93)*(snu+2.)*an(ix,jy,kz,lns)*vr**2/(snu+1.)<a name='6694'></font>
             <a name='6695'>
             ksq = 0.189 <font color=#447700>! Smith (1984, JAMC) for equiv. ice sphere<a name='6696'></font>
             IF ( an(ix,jy,kz,lns) .gt. 1.e-7 ) THEN<a name='6697'>
               IF ( qxw &gt; qsmin ) THEN <font color=#447700>! old version<a name='6698'></font>
<font color=#447700>!                gtmp(ix,kz) = 3.6e18*(snu+2.)*( 0.224*an(ix,jy,kz,ls) + 0.776*qxw)*an(ix,jy,kz,ls)/ &amp;<a name='6699'></font>
<font color=#447700>!     &amp;              (an(ix,jy,kz,lns)*(snu+1.)*rwdn**2)*db(ix,jy,kz)**2<a name='6700'></font>
                gtmp(ix,kz) = 3.6e18*(snu+2.)*( 0.224*(an(ix,jy,kz,ls)+qxw1) + 0.776*qxw)*(an(ix,jy,kz,ls)+qxw1)/ &amp;<a name='6701'>
     &amp;              (an(ix,jy,kz,lns)*(snu+1.)*rwdn**2)*db(ix,jy,kz)**2<a name='6702'>
<a name='6703'>
               ELSE <font color=#447700>! new form using a mass relationship m = p d^2 (instead of d^3 -- Cox 1988 QJRMS) so that density depends on size<a name='6704'></font>
                    <font color=#447700>! p = 0.106214 for m = p v^(2/3)<a name='6705'></font>
                 dnsnow = 0.346159*sqrt(an(ix,jy,kz,lns)/(an(ix,jy,kz,ls)*db(ix,jy,kz)) )<a name='6706'>
                 IF ( .true. .or. dnsnow &lt; 900. ) THEN<a name='6707'>
                  gtmp(ix,kz) = 1.e18*323.3226* 0.106214**2*(ksq*an(ix,jy,kz,ls) + &amp;<a name='6708'>
     &amp;             (1.-ksq)*qxw)*an(ix,jy,kz,ls)*db(ix,jy,kz)**2*gsnow73/         &amp;<a name='6709'>
     &amp;                   (an(ix,jy,kz,lns)*(917.)**2* gsnow1*(1.0+snu)**(4./3.))<a name='6710'>
                 ELSE <font color=#447700>! otherwise small enough to assume ice spheres?<a name='6711'></font>
                  gtmp(ix,kz) = (36./pi**2) * 1.e18*(snu+2.)*( 0.224*(an(ix,jy,kz,ls)+qxw1) + 0.776*qxw)*(an(ix,jy,kz,ls)+qxw1)/ &amp;<a name='6712'>
     &amp;              (an(ix,jy,kz,lns)*(snu+1.)*rwdn**2)*db(ix,jy,kz)**2<a name='6713'>
                 ENDIF<a name='6714'>
               ENDIF<a name='6715'>
             <a name='6716'>
             ENDIF<a name='6717'>
             <a name='6718'>
<font color=#447700>!             tmp = Min(1.0,1.e3*(an(ix,jy,kz,ls))*db(ix,jy,kz))<a name='6719'></font>
<font color=#447700>!             gtmp(ix,kz) = Max( 1.0*gtmp(ix,kz), 750.0*(tmp)**1.98)<a name='6720'></font>
             dtmps = gtmp(ix,kz)<a name='6721'>
             dtmp(ix,kz) = dtmp(ix,kz) + gtmp(ix,kz)<a name='6722'>
            ELSE <font color=#447700>! }{ single-moment snow:<a name='6723'></font>
             gtmp(ix,kz) = dads*an(ix,jy,kz,ls)**(0.25)<a name='6724'>
             <a name='6725'>
             IF ( gtmp(ix,kz) .gt. 0.0 ) THEN <font color=#447700>!{<a name='6726'></font>
             dtmps = zsdryc*an(ix,jy,kz,ls)**2/gtmp(ix,kz)<a name='6727'>
             IF ( temk(ix,jy,kz) .lt. tfr ) THEN<a name='6728'>
               dtmp(ix,kz) = dtmp(ix,kz) +          &amp;<a name='6729'>
     &amp;                   zsdryc*an(ix,jy,kz,ls)**2/gtmp(ix,kz)<a name='6730'>
             ELSE<a name='6731'>
               dtmp(ix,kz) = dtmp(ix,kz) +          &amp;<a name='6732'>
     &amp;                  zswetc*an(ix,jy,kz,ls)**2/gtmp(ix,kz)<a name='6733'>
             ENDIF<a name='6734'>
             ENDIF <font color=#447700>!}<a name='6735'></font>
            ENDIF <font color=#447700>!}<a name='6736'></font>
           <a name='6737'>
           ENDIF <font color=#447700>!}<a name='6738'></font>
           <a name='6739'>
           ENDIF<a name='6740'>
<a name='6741'>
<a name='6742'>
<font color=#447700>!<a name='6743'></font>
<font color=#447700>! ice crystal contribution (Heymsfield, 1977, JAS)<a name='6744'></font>
<font color=#447700>!<a name='6745'></font>
         IF ( li .gt. 1 .and. idbzci .ne. 0 ) THEN<a name='6746'>
          <a name='6747'>
          gtmp(ix,kz) = 0.0 <a name='6748'>
           IF ( an(ix,jy,kz,li) .ge. 0.1e-3 ) THEN<a name='6749'>
             gtmp(ix,kz) = Min(1.0,1.e3*(an(ix,jy,kz,li))*db(ix,jy,kz))<a name='6750'>
             dtmp(ix,kz) = dtmp(ix,kz) + 750.0*(gtmp(ix,kz))**1.98<a name='6751'>
           ENDIF<a name='6752'>
           <a name='6753'>
          ENDIF<a name='6754'>
          <a name='6755'>
<font color=#447700>!           <a name='6756'></font>
<font color=#447700>! graupel/hail contribution<a name='6757'></font>
<font color=#447700>!<a name='6758'></font>
         IF ( lh .gt. 1 ) THEN <font color=#447700>! {<a name='6759'></font>
           gtmp(ix,kz) = 0.0 <a name='6760'>
           dtmph = 0.0<a name='6761'>
           qxw = 0.0<a name='6762'>
<a name='6763'>
          IF ( izieg .ge. 1 .and. ipconc .ge. 5 ) THEN<a name='6764'>
<a name='6765'>
           ltest = .false.<a name='6766'>
           <a name='6767'>
           IF ( ltest .or. (an(ix,jy,kz,lh) .ge. qhmin .and. an(ix,jy,kz,lnh) .gt. 1.e-6 )) THEN<a name='6768'>
            <a name='6769'>
            IF ( lvh .gt. 1 ) THEN<a name='6770'>
             <a name='6771'>
             IF ( an(ix,jy,kz,lvh) .gt. 0.0 ) THEN<a name='6772'>
               hwdn = db(ix,jy,kz)*an(ix,jy,kz,lh)/an(ix,jy,kz,lvh)<a name='6773'>
               hwdn = Min( 900., Max( 100., hwdn ) )<a name='6774'>
              ELSE <a name='6775'>
               hwdn = 500. <font color=#447700>! hwdn1t<a name='6776'></font>
              ENDIF<a name='6777'>
<a name='6778'>
             ENDIF<a name='6779'>
<a name='6780'>
             chw = an(ix,jy,kz,lnh)<a name='6781'>
            IF ( chw .gt. 0.0 ) THEN                                         <font color=#447700>! (Ferrier 94)<a name='6782'></font>
             xvh = db(ix,jy,kz)*an(ix,jy,kz,lh)/(hwdn*Max(1.0e-3,chw))<a name='6783'>
             IF ( xvh .lt. xvhmn .or. xvh .gt. xvhmx ) THEN<a name='6784'>
              xvh = Min( xvhmx, Max( xvhmn,xvh ) )<a name='6785'>
              chw = db(ix,jy,kz)*an(ix,jy,kz,lh)/(xvh*hwdn)<a name='6786'>
             ENDIF<a name='6787'>
             <a name='6788'>
             qh = an(ix,jy,kz,lh)<a name='6789'>
             <a name='6790'>
             IF ( lhw .gt. 1 ) THEN<a name='6791'>
               IF ( iusewetgraupel .eq. 1 ) THEN<a name='6792'>
                  qxw = an(ix,jy,kz,lhw)<a name='6793'>
               ELSEIF ( iusewetgraupel .eq. 2 ) THEN<a name='6794'>
                  IF ( hwdn .lt. 300. ) THEN<a name='6795'>
                    qxw = an(ix,jy,kz,lhw)<a name='6796'>
                  ENDIF<a name='6797'>
               ENDIF<a name='6798'>
             ELSEIF ( iusewetgraupel .eq. 3 ) THEN<a name='6799'>
                  IF ( hwdn .lt. 300. .and. temk(ix,jy,kz) &gt; tfr .and. an(ix,jy,kz,lr) &gt; qhmin ) THEN<a name='6800'>
                    qxw = Min( an(ix,jy,kz,lh), an(ix,jy,kz,lr))<a name='6801'>
                    qh = qh + qxw<a name='6802'>
                  ENDIF<a name='6803'>
             ELSEIF ( iusewetgraupel == 4 .and. temk(ix,jy,kz) .gt. tfr+0.25 .and. an(ix,jy,kz,lh) &gt; an(ix,jy,kz,lr) &amp;<a name='6804'>
     &amp;              .and. an(ix,jy,kz,lr) &gt; qhmin) THEN<a name='6805'>
               qxw = Min(0.5*an(ix,jy,kz,lh), an(ix,jy,kz,lr))<a name='6806'>
               qh = qh + qxw<a name='6807'>
<a name='6808'>
             ENDIF<a name='6809'>
             <a name='6810'>
             IF ( lzh .gt. 1 ) THEN<a name='6811'>
             ELSE<a name='6812'>
             g1 = (6.0 + alphah)*(5.0 + alphah)*(4.0 + alphah)/((3.0 + alphah)*(2.0 + alphah)*(1.0 + alphah))<a name='6813'>
<font color=#447700>!             zx = g1*(db(ix,jy,kz)*an(ix,jy,kz,lh))**2/chw<a name='6814'></font>
<font color=#447700>!             ze = 0.224*1.e18*zx*(6./(pi*1000.))**2<a name='6815'></font>
             zx = g1*db(ix,jy,kz)**2*( 0.224*qh + 0.776*qxw)*qh/chw<a name='6816'>
             ze =1.e18*zx*(6./(pi*1000.))**2<a name='6817'>
             dtmp(ix,kz) = dtmp(ix,kz) + ze<a name='6818'>
             dtmph = ze<a name='6819'>
             ENDIF<a name='6820'>
             <a name='6821'>
            ENDIF<a name='6822'>
             <a name='6823'>
        <font color=#447700>!     IF ( an(ix,jy,kz,lh) .gt. 1.0e-3 ) write(0,*)  'Graupel Z : ',dtmph,ze<a name='6824'></font>
           ENDIF<a name='6825'>
          <a name='6826'>
          ELSE<a name='6827'>
          <a name='6828'>
          dtmph = 0.0<a name='6829'>
          <a name='6830'>
           IF ( an(ix,jy,kz,lh) .ge. qhmin ) THEN<a name='6831'>
             gtmp(ix,kz) = dadh*an(ix,jy,kz,lh)**(0.25)<a name='6832'>
             IF ( gtmp(ix,kz) .gt. 0.0 ) THEN<a name='6833'>
             dtmph =  zhdryc*an(ix,jy,kz,lh)**2/gtmp(ix,kz)<a name='6834'>
             IF ( temk(ix,jy,kz) .lt. tfr ) THEN<a name='6835'>
               dtmp(ix,kz) = dtmp(ix,kz) +                   &amp;<a name='6836'>
     &amp;                  zhdryc*an(ix,jy,kz,lh)**2/gtmp(ix,kz)<a name='6837'>
             ELSE<a name='6838'>
<font color=#447700>!               IF ( hwdn .gt. 700.0 ) THEN<a name='6839'></font>
                 dtmp(ix,kz) = dtmp(ix,kz) +                   &amp;<a name='6840'>
     &amp;                  zhdryc*an(ix,jy,kz,lh)**2/gtmp(ix,kz)<a name='6841'>
<font color=#447700>! <a name='6842'></font>
<font color=#447700>!     &amp;                               (zhwetc*gtmp(ix,kz)**7)**0.95<a name='6843'></font>
<font color=#447700>!               ELSE<a name='6844'></font>
<font color=#447700>!                 dtmp(ix,kz) = dtmp(ix,kz) + zhwetc*gtmp(ix,kz)**7<a name='6845'></font>
<font color=#447700>!               ENDIF<a name='6846'></font>
             ENDIF<a name='6847'>
             ENDIF<a name='6848'>
           ENDIF<a name='6849'>
          <a name='6850'>
         <a name='6851'>
          <a name='6852'>
          ENDIF<a name='6853'>
 <a name='6854'>
<a name='6855'>
          ENDIF <font color=#447700>! }<a name='6856'></font>
          <a name='6857'>
          ENDIF <font color=#447700>! na .gt. 5<a name='6858'></font>
<a name='6859'>
        <a name='6860'>
        IF ( izieg .ge. 1 .and. lhl .gt. 1 ) THEN<a name='6861'>
<a name='6862'>
        hldn = 900.0<a name='6863'>
        gtmp(ix,kz) = 0.0<a name='6864'>
        dtmphl = 0.0<a name='6865'>
        qxw = 0.0<a name='6866'>
        <a name='6867'>
<a name='6868'>
        IF ( lvhl .gt. 1 ) THEN<a name='6869'>
          IF ( an(ix,jy,kz,lvhl) .gt. 0.0 ) THEN<a name='6870'>
            hldn = db(ix,jy,kz)*an(ix,jy,kz,lhl)/an(ix,jy,kz,lvhl)<a name='6871'>
            hldn = Min( 900., Max( 300., hldn ) )<a name='6872'>
          ELSE <a name='6873'>
            hldn = 900. <a name='6874'>
          ENDIF<a name='6875'>
        ELSE<a name='6876'>
          hldn = rho_qhl<a name='6877'>
        ENDIF <a name='6878'>
<a name='6879'>
<a name='6880'>
        IF ( ipconc .ge. 5 ) THEN<a name='6881'>
<a name='6882'>
           ltest = .false.<a name='6883'>
<a name='6884'>
          IF ( ltest .or. ( an(ix,jy,kz,lhl) .ge. qhlmin .and. an(ix,jy,kz,lnhl) .gt. 0.) ) THEN <font color=#447700>!{<a name='6885'></font>
            chl = an(ix,jy,kz,lnhl)<a name='6886'>
            IF ( chl .gt. 0.0 ) THEN <font color=#447700>!{<a name='6887'></font>
             xvhl = db(ix,jy,kz)*an(ix,jy,kz,lhl)/         &amp;<a name='6888'>
     &amp;        (hldn*Max(1.0e-9,an(ix,jy,kz,lnhl)))<a name='6889'>
            IF ( xvhl .lt. xvhlmn .or. xvhl .gt. xvhlmx ) THEN <font color=#447700>! {<a name='6890'></font>
              xvhl = Min( xvhlmx, Max( xvhlmn,xvhl ) )<a name='6891'>
              chl = db(ix,jy,kz)*an(ix,jy,kz,lhl)/(xvhl*hldn)<a name='6892'>
              an(ix,jy,kz,lnhl) = chl<a name='6893'>
            ENDIF <font color=#447700>! }<a name='6894'></font>
<a name='6895'>
             IF ( lhlw .gt. 1 ) THEN<a name='6896'>
               IF ( iusewethail .eq. 1 ) THEN<a name='6897'>
                  qxw = an(ix,jy,kz,lhlw)<a name='6898'>
               ELSEIF ( iusewethail .eq. 2 ) THEN<a name='6899'>
                  IF ( hldn .lt. 300. ) THEN<a name='6900'>
                    qxw = an(ix,jy,kz,lhlw)<a name='6901'>
                  ENDIF<a name='6902'>
               ENDIF<a name='6903'>
             ENDIF<a name='6904'>
            <a name='6905'>
             IF ( lzhl .gt. 1 ) THEN <font color=#447700>!{<a name='6906'></font>
             ELSE <font color=#447700>!}<a name='6907'></font>
<a name='6908'>
             g1 = (6.0 + alphahl)*(5.0 + alphahl)*(4.0 + alphahl)/((3.0 + alphahl)*(2.0 + alphahl)*(1.0 + alphahl))<a name='6909'>
             zx = g1*db(ix,jy,kz)**2*( 0.224*an(ix,jy,kz,lhl) + 0.776*qxw)*an(ix,jy,kz,lhl)/chl<a name='6910'>
<font color=#447700>!             zx = g1*(db(ix,jy,kz)*an(ix,jy,kz,lhl))**2/chl<a name='6911'></font>
             ze = 1.e18*zx*(6./(pi*1000.))**2 <font color=#447700>! 3/28/2016 removed extra factor of 0.224<a name='6912'></font>
             dtmp(ix,kz) = dtmp(ix,kz) + ze<a name='6913'>
             dtmphl = ze<a name='6914'>
             <a name='6915'>
             ENDIF <font color=#447700>!}<a name='6916'></font>
            ENDIF<font color=#447700>!}<a name='6917'></font>
        <font color=#447700>!     IF ( an(ix,jy,kz,lh) .gt. 1.0e-3 ) write(0,*)  'Graupel Z : ',dtmph,ze<a name='6918'></font>
           ENDIF<a name='6919'>
<a name='6920'>
          <a name='6921'>
          ELSE<a name='6922'>
          <a name='6923'>
          <a name='6924'>
           IF ( an(ix,jy,kz,lhl) .ge. qhlmin ) THEN <font color=#447700>! {<a name='6925'></font>
            dadhl = ( db(ix,jy,kz) /(pi*hldn*cnohl) )**(.25)<a name='6926'>
             gtmp(ix,kz) = dadhl*an(ix,jy,kz,lhl)**(0.25)<a name='6927'>
             IF ( gtmp(ix,kz) .gt. 0.0 ) THEN <font color=#447700>! {<a name='6928'></font>
<a name='6929'>
              zhldryc = 0.224*cr2*( db(ix,jy,kz)/rwdn)**2/cnohl <a name='6930'>
<a name='6931'>
             dtmphl =  zhldryc*an(ix,jy,kz,lhl)**2/gtmp(ix,kz)<a name='6932'>
<a name='6933'>
             IF ( temk(ix,jy,kz) .lt. tfr ) THEN<a name='6934'>
               dtmp(ix,kz) = dtmp(ix,kz) +                   &amp;<a name='6935'>
     &amp;                  zhldryc*an(ix,jy,kz,lhl)**2/gtmp(ix,kz)<a name='6936'>
             ELSE<a name='6937'>
<font color=#447700>!               IF ( hwdn .gt. 700.0 ) THEN<a name='6938'></font>
                 dtmp(ix,kz) = dtmp(ix,kz) +                   &amp;<a name='6939'>
     &amp;                  zhldryc*an(ix,jy,kz,lhl)**2/gtmp(ix,kz)<a name='6940'>
<font color=#447700>! <a name='6941'></font>
<font color=#447700>!     :                               (zhwetc*gtmp(ix,kz)**7)**0.95<a name='6942'></font>
<font color=#447700>!               ELSE<a name='6943'></font>
<font color=#447700>!                 dtmp(ix,kz) = dtmp(ix,kz) + zhwetc*gtmp(ix,kz)**7<a name='6944'></font>
<font color=#447700>!               ENDIF<a name='6945'></font>
             ENDIF<a name='6946'>
             ENDIF <font color=#447700>! }<a name='6947'></font>
           <a name='6948'>
           ENDIF <font color=#447700>! }<a name='6949'></font>
          <a name='6950'>
         ENDIF <font color=#447700>! ipconc .ge. 5<a name='6951'></font>
<a name='6952'>
<a name='6953'>
        ENDIF <font color=#447700>! izieg .ge. 1 .and. lhl .gt. 1 <a name='6954'></font>
<a name='6955'>
          <a name='6956'>
           <a name='6957'>
          IF ( dtmp(ix,kz) .gt. 0.0 ) THEN<a name='6958'>
            dbz(ix,jy,kz) = Max(dbzmin, 10.0*Log10(dtmp(ix,kz)) )<a name='6959'>
            <a name='6960'>
            IF ( dbz(ix,jy,kz) .gt. dbzmax ) THEN<a name='6961'>
              dbzmax = Max(dbzmax,dbz(ix,jy,kz))<a name='6962'>
              imx = ix<a name='6963'>
              jmx = jy<a name='6964'>
              kmx = kz<a name='6965'>
            ENDIF<a name='6966'>
          ELSE <a name='6967'>
             dbz(ix,jy,kz) = dbzmin<a name='6968'>
             IF ( lh &gt; 1 .and. lhl &gt; 1) THEN<a name='6969'>
               IF ( an(ix,jy,kz,lh) &gt; 1.0e-3 ) THEN<a name='6970'>
                 write(0,*) 'radardbz: qr,qh,qhl = ',an(ix,jy,kz,lr), an(ix,jy,kz,lh),an(ix,jy,kz,lhl)<a name='6971'>
                 write(0,*) 'radardbz: dtmps,dtmph,dadh,dadhl,dtmphl = ',dtmps,dtmph,dadh,dadhl,dtmphl<a name='6972'>
                 <a name='6973'>
                 IF ( lzh&gt;1 .and. lzhl&gt;1 ) write(0,*) 'radardbz: zh, zhl = ',an(ix,jy,kz,lzh),an(ix,jy,kz,lzhl)<a name='6974'>
               ENDIF<a name='6975'>
             ENDIF<a name='6976'>
          ENDIF<a name='6977'>
<a name='6978'>
<font color=#447700>!         IF ( an(ix,jy,kz,lh) .gt. 1.e-4 .and. <a name='6979'></font>
<font color=#447700>!     &amp;        dbz(ix,jy,kz) .le. 0.0 ) THEN<a name='6980'></font>
<font color=#447700>!          write(0,*) 'dbz = ',dbz(ix,jy,kz)<a name='6981'></font>
<font color=#447700>!          write(0,*) 'Hail intercept: ',xcnoh,ix,kz<a name='6982'></font>
<font color=#447700>!          write(0,*) 'Hail,snow q: ',an(ix,jy,kz,lh),an(ix,jy,kz,ls)<a name='6983'></font>
<font color=#447700>!          write(0,*) 'Hail,snow c: ',an(ix,jy,kz,lnh),an(ix,jy,kz,lns)<a name='6984'></font>
<font color=#447700>!          write(0,*) 'dtmps,dtmph = ',dtmps,dtmph<a name='6985'></font>
<font color=#447700>!         ENDIF<a name='6986'></font>
        IF ( .not. dtmp(ix,kz) .lt. 1.e30 .or. dbz(ix,jy,kz) &gt; 190.0 ) THEN<a name='6987'>
<font color=#447700>!        IF ( ix == 31 .and. kz == 20 .and. jy == 23 ) THEN<a name='6988'></font>
<font color=#447700>!          write(0,*) 'my_rank = ',my_rank<a name='6989'></font>
          write(0,*) 'ix,jy,kz = ',ix,jy,kz<a name='6990'>
          write(0,*) 'dbz = ',dbz(ix,jy,kz)<a name='6991'>
          write(0,*) 'db, zhdryc = ',db(ix,jy,kz),zhdryc<a name='6992'>
          write(0,*) 'Hail intercept: ',xcnoh,ix,kz<a name='6993'>
          write(0,*) 'Hail,snow q: ',an(ix,jy,kz,lh),an(ix,jy,kz,ls)<a name='6994'>
          write(0,*) 'graupel density hwdn = ',hwdn<a name='6995'>
          write(0,*) 'rain q: ',an(ix,jy,kz,lr)<a name='6996'>
          write(0,*) 'ice q: ',an(ix,jy,kz,li)<a name='6997'>
          IF ( lhl .gt. 1 ) write(0,*) 'Hail (lhl): ',an(ix,jy,kz,lhl)<a name='6998'>
          IF (ipconc .ge. 3 ) write(0,*) 'rain c: ',an(ix,jy,kz,lnr)<a name='6999'>
          IF ( lzr &gt; 1 ) write(0,*) 'rain Z: ',an(ix,jy,kz,lzr)<a name='7000'>
          IF ( ipconc .ge. 5 ) THEN<a name='7001'>
          write(0,*) 'Hail,snow c: ',an(ix,jy,kz,lnh),an(ix,jy,kz,lns)<a name='7002'>
          IF ( lhl .gt. 1 ) write(0,*) 'Hail (lnhl): ',an(ix,jy,kz,lnhl)<a name='7003'>
          IF ( lzhl .gt. 1 ) THEN <a name='7004'>
            write(0,*) 'Hail (lzhl): ',an(ix,jy,kz,lzhl)<a name='7005'>
            write(0,*) 'chl,xvhl,dhl = ',chl,xvhl,(xvhl*6./3.14159)**(1./3.)<a name='7006'>
            write(0,*) 'xvhlmn,xvhlmx = ',xvhlmn,xvhlmx<a name='7007'>
          ENDIF<a name='7008'>
          ENDIF<a name='7009'>
          write(0,*) 'chw,xvh = ', chw,xvh<a name='7010'>
          write(0,*) 'dtmps,dtmph,dadh,dadhl,dtmphl = ',dtmps,dtmph,dadh,dadhl,dtmphl<a name='7011'>
          write(0,*) 'dtmpr = ',dtmpr<a name='7012'>
          write(0,*) 'gtmp = ',gtmp(ix,kz),dtmp(ix,kz)<a name='7013'>
          IF ( .not. (dbz(ix,jy,kz) .gt. -100 .and. dbz(ix,jy,kz) .lt. 200 ) ) THEN<a name='7014'>
            write(0,*) 'dbz out of bounds<font color=#447700>! STOP!'<a name='7015'></font>
<font color=#447700>!            STOP<a name='7016'></font>
          ENDIF<a name='7017'>
         ENDIF<a name='7018'>
<a name='7019'>
           <a name='7020'>
          ENDDO <font color=#447700>! ix<a name='7021'></font>
         ENDDO <font color=#447700>! kz<a name='7022'></font>
      ENDDO <font color=#447700>! jy<a name='7023'></font>
            <a name='7024'>
      <a name='7025'>
      <a name='7026'>
      <a name='7027'>
<font color=#447700>!      write(0,*)  'na,lr = ',na,lr<a name='7028'></font>
      IF ( printyn .eq. 1 ) THEN<a name='7029'>
<font color=#447700>!      IF ( dbzmax .gt. dbzmin ) THEN<a name='7030'></font>
        write(iunit,*) 'maxdbz,ijk = ',dbzmax,imx,jmx,kmx<a name='7031'>
        write(iunit,*) 'qrw = ',an(imx,jmx,kmx,lr)<a name='7032'>
        <a name='7033'>
        IF ( lh .gt. 1 ) THEN<a name='7034'>
          write(iunit,*) 'qi  = ',an(imx,jmx,kmx,li)<a name='7035'>
          write(iunit,*) 'qsw = ',an(imx,jmx,kmx,ls)<a name='7036'>
          write(iunit,*) 'qhw = ',an(imx,jmx,kmx,lh)<a name='7037'>
          IF ( lhl .gt. 1 ) write(iunit,*) 'qhl = ',an(imx,jmx,kmx,lhl)<a name='7038'>
        ENDIF<a name='7039'>
<a name='7040'>
      <a name='7041'>
      ENDIF<a name='7042'>
      <a name='7043'>
      <a name='7044'>
      RETURN<a name='7045'>
      END subroutine radardd02<a name='7046'>
      <a name='7047'>
<a name='7048'>
<font color=#447700>! ##############################################################################<a name='7049'></font>
<font color=#447700>! ##############################################################################<a name='7050'></font>
<a name='7051'>
<a name='7052'>
<font color=#447700>! #####################################################################<a name='7053'></font>
<font color=#447700>! #####################################################################<a name='7054'></font>
<font color=#447700>!<a name='7055'></font>
<font color=#447700>! Subroutine for explicit cloud condensation and droplet nucleation<a name='7056'></font>
<font color=#447700>!<a name='7057'></font>
<A NAME='NUCOND'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NUCOND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7058'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>NUCOND</font>    &amp; <A href='../../call_to/NUCOND.html' TARGET='index'>1</A>,<A href='../../call_from/NUCOND.html' TARGET='index'>4</A><a name='7059'>
     &amp;  (nx,ny,nz,na,jyslab &amp; <a name='7060'>
     &amp;  ,nor,norz,dtp,nxi &amp; <a name='7061'>
     &amp;  ,dz3d &amp; <a name='7062'>
     &amp;  ,t0,t9 &amp; <a name='7063'>
     &amp;  ,an,dn,p2 &amp; <a name='7064'>
     &amp;  ,pn,w &amp; <a name='7065'>
     &amp;  ,axtra,io_flag &amp;<a name='7066'>
     &amp;  ,ssfilt,t00,t77,flag_qndrop  &amp;<a name='7067'>
     &amp; )<a name='7068'>
<a name='7069'>
<a name='7070'>
   implicit none<a name='7071'>
<a name='7072'>
      integer :: nx,ny,nz,na,nxi<a name='7073'>
      integer :: nor,norz, jyslab <font color=#447700>! ,nht,ngt,igsr<a name='7074'></font>
      real    :: dtp  <font color=#447700>! time step<a name='7075'></font>
      logical :: flag_qndrop<a name='7076'>
<a name='7077'>
      integer, parameter :: ng1 = 1<a name='7078'>
<a name='7079'>
<a name='7080'>
<font color=#447700>!<a name='7081'></font>
<font color=#447700>! external temporary arrays<a name='7082'></font>
<font color=#447700>!<a name='7083'></font>
      real t00(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7084'>
      real t77(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7085'>
<a name='7086'>
      real t0(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7087'>
<font color=#447700>!      real t1(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7088'></font>
<font color=#447700>!      real t2(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7089'></font>
<font color=#447700>!      real t3(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7090'></font>
<font color=#447700>!      real t4(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7091'></font>
<font color=#447700>!      real t5(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7092'></font>
<font color=#447700>!      real t6(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7093'></font>
<font color=#447700>!      real t7(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7094'></font>
<font color=#447700>!      real t8(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7095'></font>
      real t9(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7096'>
      <a name='7097'>
<a name='7098'>
      real p2(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)  <font color=#447700>! perturbation Pi<a name='7099'></font>
      real pn(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7100'>
      real an(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz,na)<a name='7101'>
      real dn(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7102'>
<a name='7103'>
      real w(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7104'>
<font color=#447700>!      real qv(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7105'></font>
<a name='7106'>
      real ssfilt(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7107'>
      <a name='7108'>
<a name='7109'>
      real pb(-norz+ng1:nz+norz)<a name='7110'>
      real pinit(-norz+ng1:nz+norz)<a name='7111'>
<a name='7112'>
      real dz3d(-nor+1:nx+nor,-nor+1:ny+nor,-norz+1:nz+norz)<a name='7113'>
<a name='7114'>
      <a name='7115'>
    <font color=#447700>! local<a name='7116'></font>
<a name='7117'>
<a name='7118'>
      real axtra(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz,nxtra)<a name='7119'>
      logical :: io_flag<a name='7120'>
      <a name='7121'>
      real :: dv<a name='7122'>
<a name='7123'>
<font color=#447700>! <a name='7124'></font>
<font color=#447700>!  declarations microphysics and for gather/scatter<a name='7125'></font>
<font color=#447700>!<a name='7126'></font>
      integer nxmpb,nzmpb,nxz<a name='7127'>
      integer mgs,ngs,numgs,inumgs<a name='7128'>
      parameter (ngs=500)<a name='7129'>
      integer ngscnt,igs(ngs),kgs(ngs)<a name='7130'>
      integer kgsp(ngs),kgsm(ngs)<a name='7131'>
      integer nsvcnt<a name='7132'>
      <a name='7133'>
      integer ix,kz,i,n, kp1, km1<a name='7134'>
      integer :: jy, jgs<a name='7135'>
      integer ixb,ixe,jyb,jye,kzb,kze<a name='7136'>
    <a name='7137'>
      integer itile,jtile,ktile<a name='7138'>
      integer ixend,jyend,kzend,kzbeg<a name='7139'>
      integer nxend,nyend,nzend,nzbeg<a name='7140'>
<a name='7141'>
<font color=#447700>!<a name='7142'></font>
<font color=#447700>! Variables for Ziegler warm rain microphysics<a name='7143'></font>
<font color=#447700>!      <a name='7144'></font>
<a name='7145'>
<a name='7146'>
      real ccnc(ngs), ccna(ngs), cnuc(ngs), cwnccn(ngs)<a name='7147'>
      real sscb  <font color=#447700>! 'cloud base' SS threshold<a name='7148'></font>
      parameter ( sscb = 2.0 )<a name='7149'>
      integer idecss  <font color=#447700>! flag to turn on (=1) decay of ssmax when no cloud or ice crystals<a name='7150'></font>
      parameter ( idecss = 1 )<a name='7151'>
      integer iba <font color=#447700>! flag to do condensation/nucleation in 1st or 2nd loop<a name='7152'></font>
                  <font color=#447700>! =0 to use ad to calculate SS<a name='7153'></font>
                  <font color=#447700>! =1 to use an at end of main jy loop to calculate SS<a name='7154'></font>
      parameter (iba = 1)<a name='7155'>
      integer ifilt   <font color=#447700>! =1 to filter ssat, =0 to set ssfilt=ssat<a name='7156'></font>
      parameter ( ifilt = 0 ) <a name='7157'>
      real temp1,temp2 <font color=#447700>! ,ssold<a name='7158'></font>
      real :: ssmax(ngs) = 0.0       <font color=#447700>! maximum SS experienced by a parcel<a name='7159'></font>
      real ssmx<a name='7160'>
      real dnnet,dqnet<a name='7161'>
<font color=#447700>!      real cnu,rnu,snu,cinu<a name='7162'></font>
<font color=#447700>!      parameter ( cnu = 0.0, rnu = -0.8, snu = -0.8, cinu = 0.0 )<a name='7163'></font>
      real ventrx(ngs)<a name='7164'>
      real ventrxn(ngs)<a name='7165'>
      real volb, t2s<a name='7166'>
      real, parameter :: aa1 = 9.44e15, aa2 = 5.78e3  <font color=#447700>! a1 in Ziegler<a name='7167'></font>
<a name='7168'>
      real ec0, ex1, ft, rhoinv(ngs)<a name='7169'>
      <a name='7170'>
      real chw, g1, rd1<a name='7171'>
<a name='7172'>
      real ac1,bc, taus, c1,d1,e1,f1,p380,tmp,tmp2 <font color=#447700>! , sstdy, super<a name='7173'></font>
      real tmpmx, fw<a name='7174'>
      real x,y,del,r,alpr<a name='7175'>
      double precision :: vent1,vent2<a name='7176'>
      real g1palp<a name='7177'>
      real bs<a name='7178'>
      real v1, v2<a name='7179'>
      real d1r, d1i, d1s, e1i<a name='7180'>
      integer nc <font color=#447700>! condensation step<a name='7181'></font>
      real dtcon,dtcon1,dtcon2 <font color=#447700>! condensation time step (dtcon*nc = dtp)<a name='7182'></font>
      real delta<a name='7183'>
      integer ltemq1,ltemq1m <font color=#447700>! ,ltemq1m2<a name='7184'></font>
      real dqv,qv1,ss1,ss2,qvs1,dqvs,dtemp,dt1   <font color=#447700>! temporaries for condensation<a name='7185'></font>
<a name='7186'>
      real ssi1, ssi2, dqvi, dqvis, dqvii,qis1<a name='7187'>
      real dqvr, dqc, dqr, dqi, dqs<a name='7188'>
      real qv1m,qvs1m,ss1m,ssi1m,qis1m<a name='7189'>
      real cwmastmp <a name='7190'>
      real  dcloud,dcloud2 <font color=#447700>! ,as, bs<a name='7191'></font>
      real dcrit<a name='7192'>
      real cn(ngs) <a name='7193'>
<a name='7194'>
      integer ltemq<a name='7195'>
      <a name='7196'>
      integer il<a name='7197'>
<a name='7198'>
      real  es(ngs) <font color=#447700>! ss(ngs),<a name='7199'></font>
<font color=#447700>!      real  eis(ngs)<a name='7200'></font>
      real ssf(ngs),ssfkp1(ngs),ssfkm1(ngs),ssat0(ngs)<a name='7201'>
      real, parameter :: ssfcut = 4.0<a name='7202'>
      real ssfjp1(ngs),ssfjm1(ngs)<a name='7203'>
      real ssfip1(ngs),ssfim1(ngs)<a name='7204'>
<a name='7205'>
      real supcb, supmx<a name='7206'>
      parameter (supcb=0.5,supmx=238.0)<a name='7207'>
      real r2dxm, r2dym, r2dzm<a name='7208'>
      real dssdz, dssdy, dssdx<a name='7209'>
<font color=#447700>!      real tqvcon<a name='7210'></font>
      real epsi,d<a name='7211'>
      parameter (epsi = 0.622, d = 0.266)<a name='7212'>
      real r1,qevap <font color=#447700>! ,slv<a name='7213'></font>
      <a name='7214'>
      real vr,nrx,qr,z1,z2,rdi,alp,xnutmp,xnuc<a name='7215'>
      real ctmp, ccwtmp<a name='7216'>
      real f5, qvs0  <font color=#447700>! Kessler condensation factor<a name='7217'></font>
      real    :: t0p1, t0p3<a name='7218'>
      real qvex<a name='7219'>
      <a name='7220'>
<font color=#447700>!      real, dimension(ngs) :: temp, tempc, elv, elf, els, pqs, theta, temg, temcg<a name='7221'></font>
      real dqvcnd(ngs),dqwv(ngs),dqcw(ngs),dqci(ngs)<a name='7222'>
      real temp(ngs),tempc(ngs)<a name='7223'>
      real temg(ngs),temcg(ngs),theta(ngs),qvap(ngs) <font color=#447700>! ,tembzg(ngs)<a name='7224'></font>
      real temgx(ngs),temcgx(ngs)<a name='7225'>
      real qvs(ngs),qis(ngs),qss(ngs),pqs(ngs)<a name='7226'>
      real felv(ngs),felf(ngs),fels(ngs)<a name='7227'>
      real felvcp(ngs),felvpi(ngs)<a name='7228'>
      real gamw(ngs),gams(ngs)   <font color=#447700>!   qciavl(ngs),<a name='7229'></font>
      real tsqr(ngs),ssi(ngs),ssw(ngs)<a name='7230'>
      real cc3(ngs),cqv1(ngs),cqv2(ngs)<a name='7231'>
      real qcwtmp(ngs),qtmp<a name='7232'>
<a name='7233'>
      real fvent(ngs) <font color=#447700>!,fraci(ngs),fracl(ngs)<a name='7234'></font>
      real fwvdf(ngs),ftka(ngs),fthdf(ngs)<a name='7235'>
      real fadvisc(ngs),fakvisc(ngs)<a name='7236'>
      real fci(ngs),fcw(ngs)<a name='7237'>
      real fschm(ngs),fpndl(ngs)<a name='7238'>
<a name='7239'>
      real pres(ngs),pipert(ngs)<a name='7240'>
      real pk(ngs)<a name='7241'>
      real rho0(ngs),pi0(ngs)<a name='7242'>
      real rhovt(ngs)<a name='7243'>
      real thetap(ngs),theta0(ngs),qwvp(ngs),qv0(ngs)<a name='7244'>
      real thsave(ngs)<a name='7245'>
      real qss0(ngs)<a name='7246'>
      real fcqv1(ngs)<a name='7247'>
      real wvel(ngs),wvelkm1(ngs)<a name='7248'>
<a name='7249'>
      real wvdf(ngs),tka(ngs)<a name='7250'>
      real advisc(ngs)<a name='7251'>
<a name='7252'>
      real rwvent(ngs)<a name='7253'>
      <a name='7254'>
<a name='7255'>
      real :: qx(ngs,lv:lhab)<a name='7256'>
      real :: cx(ngs,lc:lhab)<a name='7257'>
      real :: xv(ngs,lc:lhab)<a name='7258'>
      real :: xmas(ngs,lc:lhab)<a name='7259'>
      real :: xdn(ngs,lc:lhab)<a name='7260'>
      real :: xdia(ngs,lc:lhab,3)<a name='7261'>
      real :: alpha(ngs,lc:lhab)<a name='7262'>
      real :: zx(ngs,lr:lhab)<a name='7263'>
<a name='7264'>
<a name='7265'>
      logical zerocx(lc:lqmx)<a name='7266'>
      <a name='7267'>
      logical :: lprint<a name='7268'>
<a name='7269'>
      integer, parameter :: iunit = 0<a name='7270'>
      <a name='7271'>
      real :: frac, hwdn, tmpg<a name='7272'>
      <a name='7273'>
      real :: cvm,cpm,rmm<a name='7274'>
<a name='7275'>
      real, parameter :: rovcp = rd/cp<a name='7276'>
      real, parameter ::      cpv = 1885.0       <font color=#447700>! specific heat of water vapor at constant pressure<a name='7277'></font>
      <a name='7278'>
      integer :: kstag<a name='7279'>
      <a name='7280'>
      integer :: count<a name='7281'>
      <a name='7282'>
<a name='7283'>
<font color=#447700>! -------------------------------------------------------------------------------<a name='7284'></font>
      itile = nxi<a name='7285'>
      jtile = ny<a name='7286'>
      ktile = nz<a name='7287'>
      ixend = nxi<a name='7288'>
      jyend = ny<a name='7289'>
      kzend = nz<a name='7290'>
      nxend = nxi + 1<a name='7291'>
      nyend = ny + 1<a name='7292'>
      nzend = nz<a name='7293'>
      kzbeg = 1<a name='7294'>
      nzbeg = 1<a name='7295'>
<a name='7296'>
      f5 = 237.3 * 17.27 * 2.5e6 / cp <font color=#447700>! combined constants for rain condensation (Soong and Ogura 73)<a name='7297'></font>
<a name='7298'>
       jy = 1<a name='7299'>
       kstag = 0<a name='7300'>
       pb(:) = 0.0<a name='7301'>
       pinit(:) = 0.0<a name='7302'>
      <a name='7303'>
      IF ( ipconc &lt;= 1 .or. isedonly == 2 ) GOTO 2200<a name='7304'>
<a name='7305'>
<font color=#447700>!<a name='7306'></font>
<font color=#447700>!  Ziegler nucleation <a name='7307'></font>
<font color=#447700>!<a name='7308'></font>
<a name='7309'>
<font color=#447700>!      ssfilt(:,:,:) = 0.0<a name='7310'></font>
      ssmx = 0<a name='7311'>
      count = 0<a name='7312'>
<a name='7313'>
      do kz = 1,nz-kstag<a name='7314'>
        do ix = 1,nxi<a name='7315'>
<a name='7316'>
         temp1 = an(ix,jy,kz,lt)*t77(ix,jy,kz)<a name='7317'>
          t0(ix,jy,kz) = temp1<a name='7318'>
          ltemq = Int( (temp1-163.15)/fqsat+1.5 )<a name='7319'>
         ltemq = Min( nqsat, Max(1,ltemq) )<a name='7320'>
<a name='7321'>
          c1 = t00(ix,jy,kz)*tabqvs(ltemq)<a name='7322'>
<a name='7323'>
          IF ( c1 &gt; 0. ) THEN<a name='7324'>
            ssfilt(ix,jy,kz) = 100.*(an(ix,jy,kz,lv)/c1 - 1.0)  <font color=#447700>! from "new" values<a name='7325'></font>
          ENDIF<a name='7326'>
<a name='7327'>
        ENDDO<a name='7328'>
      ENDDO<a name='7329'>
<a name='7330'>
<a name='7331'>
<font color=#447700>!<a name='7332'></font>
<font color=#447700>!     jy = 1 ! working on a 2d slab<a name='7333'></font>
<font color=#447700>!!  VERY IMPORTANT:  SET jgs = jy<a name='7334'></font>
<a name='7335'>
      jgs = jy<a name='7336'>
<a name='7337'>
<font color=#447700>!<a name='7338'></font>
<font color=#447700>!..Gather microphysics<a name='7339'></font>
<font color=#447700>!<a name='7340'></font>
      if ( ndebug .gt. 0 ) write(0,*) 'ICEZVD_DR: Gather stage'<a name='7341'>
<a name='7342'>
      nxmpb = 1<a name='7343'>
      nzmpb = 1<a name='7344'>
      nxz = nxi*nz<a name='7345'>
      numgs = nxz/ngs + 1<a name='7346'>
<a name='7347'>
<a name='7348'>
      do 2000 inumgs = 1,numgs<a name='7349'>
<a name='7350'>
      ngscnt = 0<a name='7351'>
<a name='7352'>
<a name='7353'>
      kzb = nzmpb<a name='7354'>
      kze = nz-kstag<a name='7355'>
 <font color=#447700>!     if (kzbeg .le. nzmpb .and. kzend .gt. nzmpb) kzb = nzmpb<a name='7356'></font>
<a name='7357'>
      ixb = nxmpb<a name='7358'>
      ixe = itile<a name='7359'>
<a name='7360'>
      do kz = kzb,kze<a name='7361'>
      do ix = nxmpb,nxi<a name='7362'>
<a name='7363'>
      pqs(1) = 380.0/(pn(ix,jy,kz) + pb(kz))<a name='7364'>
      theta(1) = an(ix,jy,kz,lt)<a name='7365'>
      temg(1) = t0(ix,jy,kz)<a name='7366'>
<a name='7367'>
      temcg(1) = temg(1) - tfr<a name='7368'>
      ltemq = (temg(1)-163.15)/fqsat+1.5<a name='7369'>
      ltemq = Min( nqsat, Max(1,ltemq) )<a name='7370'>
      qvs(1) = pqs(1)*tabqvs(ltemq)<a name='7371'>
      qis(1) = pqs(1)*tabqis(ltemq)<a name='7372'>
<a name='7373'>
      qss(1) = qvs(1)<a name='7374'>
<a name='7375'>
<a name='7376'>
      if ( temg(1) .lt. tfr ) then<a name='7377'>
      end if<a name='7378'>
<font color=#447700>!<a name='7379'></font>
      if ( (temg(1) .gt. tfrh ) .and.  &amp;<a name='7380'>
     &amp;   ( an(ix,jy,kz,lv)  .gt. qss(1) .or. &amp;<a name='7381'>
     &amp;     an(ix,jy,kz,lc)  .gt. qxmin(lc)   .or.  &amp;<a name='7382'>
     &amp;     ( an(ix,jy,kz,lr)  .gt. qxmin(lr) .and. rcond == 2 )  &amp;<a name='7383'>
     &amp;     )) then<a name='7384'>
      ngscnt = ngscnt + 1<a name='7385'>
      igs(ngscnt) = ix<a name='7386'>
      kgs(ngscnt) = kz<a name='7387'>
      if ( ngscnt .eq. ngs ) goto 2100<a name='7388'>
      end if<a name='7389'>
<a name='7390'>
      end do  <font color=#447700>!ix<a name='7391'></font>
<a name='7392'>
      nxmpb = 1<a name='7393'>
      end do  <font color=#447700>!kz<a name='7394'></font>
<font color=#447700>!      if ( jy .eq. (ny-jstag) ) iend = 1<a name='7395'></font>
 2100 continue<a name='7396'>
<a name='7397'>
      if ( ngscnt .eq. 0 ) go to 29998<a name='7398'>
<a name='7399'>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_DR: dbg = 8'<a name='7400'>
      <a name='7401'>
<font color=#447700>!      write(0,*) 'NUCOND: dbg = 8, ngscnt,ssmx = ',ngscnt,ssmx<a name='7402'></font>
<a name='7403'>
      <a name='7404'>
      qx(:,:) = 0.0<a name='7405'>
      cx(:,:) = 0.0<a name='7406'>
<a name='7407'>
      xv(:,:) = 0.0<a name='7408'>
      xmas(:,:) = 0.0<a name='7409'>
<a name='7410'>
      IF ( imurain == 1 ) THEN<a name='7411'>
        alpha(:,lr) = alphar<a name='7412'>
      ELSEIF ( imurain == 3 ) THEN<a name='7413'>
        alpha(:,lr) = xnu(lr)<a name='7414'>
      ENDIF<a name='7415'>
<a name='7416'>
<font color=#447700>!<a name='7417'></font>
<font color=#447700>!  define temporaries for state variables to be used in calculations<a name='7418'></font>
<font color=#447700>!<a name='7419'></font>
      DO mgs = 1,ngscnt<a name='7420'>
      qx(mgs,lv) = an(igs(mgs),jy,kgs(mgs),lv)<a name='7421'>
       DO il = lc,lhab<a name='7422'>
        qx(mgs,il) = max(an(igs(mgs),jy,kgs(mgs),il), 0.0)<a name='7423'>
       ENDDO<a name='7424'>
<a name='7425'>
       qcwtmp(mgs) = qx(mgs,lc)<a name='7426'>
<a name='7427'>
<a name='7428'>
      theta0(mgs) = an(igs(mgs),jy,kgs(mgs),lt) <font color=#447700>!<a name='7429'></font>
      thetap(mgs) = 0.0<a name='7430'>
      theta(mgs) = an(igs(mgs),jy,kgs(mgs),lt)<a name='7431'>
      qv0(mgs) =  qx(mgs,lv)<a name='7432'>
      qwvp(mgs) = qx(mgs,lv) - qv0(mgs)<a name='7433'>
<a name='7434'>
       pres(mgs) = pn(igs(mgs),jy,kgs(mgs)) + pb(kgs(mgs))<a name='7435'>
       pipert(mgs) = p2(igs(mgs),jy,kgs(mgs))<a name='7436'>
       rho0(mgs) = dn(igs(mgs),jy,kgs(mgs))<a name='7437'>
       rhoinv(mgs) = 1.0/rho0(mgs)<a name='7438'>
       rhovt(mgs) = Sqrt(rho00/rho0(mgs))<a name='7439'>
       pi0(mgs) = p2(igs(mgs),jy,kgs(mgs)) + pinit(kgs(mgs))<a name='7440'>
       temg(mgs) = t0(igs(mgs),jy,kgs(mgs))<a name='7441'>
<font color=#447700>!       pk(mgs) = t77(igs(mgs),jy,kgs(mgs)) ! ( pres(mgs) / poo ) ** cap<a name='7442'></font>
       pk(mgs)   = p2(igs(mgs),jy,kgs(mgs)) + pinit(kgs(mgs)) <font color=#447700>! t77(igs(mgs),jy,kgs(mgs))<a name='7443'></font>
       temcg(mgs) = temg(mgs) - tfr<a name='7444'>
       qss0(mgs) = (380.0)/(pres(mgs))<a name='7445'>
       pqs(mgs) = (380.0)/(pres(mgs))<a name='7446'>
       ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='7447'>
       ltemq = Min( nqsat, Max(1,ltemq) )<a name='7448'>
       qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='7449'>
       qis(mgs) = pqs(mgs)*tabqis(ltemq)<a name='7450'>
<font color=#447700>!<a name='7451'></font>
        qvap(mgs) = max( (qwvp(mgs) + qv0(mgs)), 0.0 )<a name='7452'>
        es(mgs) = 6.1078e2*tabqvs(ltemq)<a name='7453'>
        qss(mgs) = qvs(mgs)<a name='7454'>
<a name='7455'>
<a name='7456'>
        temgx(mgs) = min(temg(mgs),313.15)<a name='7457'>
        temgx(mgs) = max(temgx(mgs),233.15)<a name='7458'>
        felv(mgs) = 2500837.367 * (273.15/temgx(mgs))**((0.167)+(3.67e-4)*temgx(mgs))<a name='7459'>
<font color=#447700>!<a name='7460'></font>
        IF ( eqtset &lt;= 1 ) THEN<a name='7461'>
          felvcp(mgs) = felv(mgs)*cpi<a name='7462'>
        ELSE <font color=#447700>! equation set 2 in cm1<a name='7463'></font>
          tmp = qx(mgs,li)+qx(mgs,ls)+qx(mgs,lh)<a name='7464'>
          IF ( lhl &gt; 1 ) tmp = tmp + qx(mgs,lhl)<a name='7465'>
          cvm = cv+cvv*qx(mgs,lv)+cpl*(qx(mgs,lc)+qx(mgs,lr))   &amp;<a name='7466'>
                                  +cpigb*(tmp)<a name='7467'>
          cpm = cp+cpv*qx(mgs,lv)+cpl*(qx(mgs,lc)+qx(mgs,lr))   &amp;<a name='7468'>
                                  +cpigb*(tmp)<a name='7469'>
          rmm=rd+rw*qx(mgs,lv)<a name='7470'>
          <a name='7471'>
          IF ( eqtset == 2 ) THEN<a name='7472'>
<a name='7473'>
           felvcp(mgs) = (felv(mgs)-rw*temg(mgs))/cvm<a name='7474'>
<a name='7475'>
          ELSE<a name='7476'>
            felvcp(mgs) = (felv(mgs)*cv/(cp) - rw*temg(mgs)*(1.0-rovcp*cpm/rmm))/cvm<a name='7477'>
            felvpi(mgs) = pi0(mgs)*rovcp*(felv(mgs)/(temg(mgs)) - rw*cpm/rmm)/cvm<a name='7478'>
          ENDIF<a name='7479'>
<a name='7480'>
        ENDIF<a name='7481'>
<a name='7482'>
        temcgx(mgs) = min(temg(mgs),273.15)<a name='7483'>
        temcgx(mgs) = max(temcgx(mgs),223.15)<a name='7484'>
        temcgx(mgs) = temcgx(mgs)-273.15<a name='7485'>
        felf(mgs) = 333690.6098 + (2030.61425)*temcgx(mgs) - (10.46708312)*temcgx(mgs)**2<a name='7486'>
<font color=#447700>!<a name='7487'></font>
        fels(mgs) = felv(mgs) + felf(mgs)<a name='7488'>
        fcqv1(mgs) = 4098.0258*felv(mgs)*cpi<a name='7489'>
<a name='7490'>
      wvdf(mgs) = (2.11e-05)*((temg(mgs)/tfr)**1.94)* &amp;<a name='7491'>
     &amp;  (101325.0/(pb(kgs(mgs)) + pn(igs(mgs),jgs,kgs(mgs))))                            <font color=#447700>! diffusivity of water vapor, Hall and Pruppacher (76)<a name='7492'></font>
      advisc(mgs) = advisc0*(416.16/(temg(mgs)+120.0))* &amp;<a name='7493'>
     &amp;  (temg(mgs)/296.0)**(1.5)                         <font color=#447700>! dynamic viscosity (SMT; see Beard &amp; Pruppacher 71)<a name='7494'></font>
      tka(mgs) = tka0*advisc(mgs)/advisc1                 <font color=#447700>! thermal conductivity<a name='7495'></font>
<a name='7496'>
<a name='7497'>
      ENDDO<a name='7498'>
<a name='7499'>
<a name='7500'>
<a name='7501'>
<font color=#447700>!<a name='7502'></font>
<font color=#447700>! load concentrations<a name='7503'></font>
<font color=#447700>!<a name='7504'></font>
      if ( ipconc .ge. 1 ) then<a name='7505'>
       do mgs = 1,ngscnt<a name='7506'>
        cx(mgs,li) = Max(an(igs(mgs),jy,kgs(mgs),lni), 0.0)<a name='7507'>
       end do<a name='7508'>
      end if<a name='7509'>
      if ( ipconc .ge. 2 ) then<a name='7510'>
       do mgs = 1,ngscnt<a name='7511'>
        cx(mgs,lc) = Max(an(igs(mgs),jy,kgs(mgs),lnc), 0.0)<a name='7512'>
        cwnccn(mgs) = cwccn*rho0(mgs)/rho00<a name='7513'>
        cn(mgs) = 0.0<a name='7514'>
        IF ( lss &gt; 1 ) ssmax(mgs) = an(igs(mgs),jy,kgs(mgs),lss)<a name='7515'>
        IF ( lccn .gt. 1 ) THEN<a name='7516'>
          ccnc(mgs) = an(igs(mgs),jy,kgs(mgs),lccn)<a name='7517'>
        ELSE<a name='7518'>
          ccnc(mgs) = cwnccn(mgs)<a name='7519'>
        ENDIF<a name='7520'>
        IF ( lccna &gt; 1 ) THEN<a name='7521'>
          ccna(mgs) = an(igs(mgs),jy,kgs(mgs),lccna)<a name='7522'>
        ELSE<a name='7523'>
          IF ( lccn &gt; 1 ) THEN<a name='7524'>
            ccna(mgs) = cwnccn(mgs) - ccnc(mgs)<a name='7525'>
          ELSE<a name='7526'>
            ccna(mgs) = cx(mgs,lc) <font color=#447700>! approximation of number of activated ccn<a name='7527'></font>
          ENDIF<a name='7528'>
        ENDIF<a name='7529'>
       end do<a name='7530'>
      end if<a name='7531'>
      if ( ipconc .ge. 3 ) then<a name='7532'>
       do mgs = 1,ngscnt<a name='7533'>
        cx(mgs,lr) = Max(an(igs(mgs),jy,kgs(mgs),lnr), 0.0)<a name='7534'>
       end do<a name='7535'>
      end if<a name='7536'>
<a name='7537'>
<font color=#447700>!        cnuc(1:ngscnt) = cwccn*rho0(mgs)/rho00*(1. - renucfrac) + ccnc(1:ngscnt)*renucfrac<a name='7538'></font>
       DO mgs = 1,ngscnt<a name='7539'>
        IF ( irenuc /= 6 ) THEN<a name='7540'>
        cnuc(mgs) = Max(ccnc(mgs),cwnccn(mgs))*(1. - renucfrac) + ccnc(mgs)*renucfrac<a name='7541'>
        ELSE<a name='7542'>
        cnuc(mgs) = Max(ccnc(mgs),cwnccn(mgs))*(1. - renucfrac) + Max(0.0,ccnc(mgs) - ccna(mgs))*renucfrac<a name='7543'>
        ENDIF<a name='7544'>
        IF ( renucfrac &gt;= 0.999 ) THEN<a name='7545'>
          IF ( temg(mgs) &lt; 265. ) THEN<a name='7546'>
            IF ( qx(mgs,lc) &gt; 10.*qxmin(lc) .and. w(igs(mgs),jgs,kgs(mgs)) &gt; 2.0 ) THEN<a name='7547'>
             cnuc(mgs) = 0.0 <font color=#447700>!  Min(cnuc(mgs), 0.5*cx(mgs,lc) ) ! Hack to reduce nucleation at low temp in updraft when ccn are not predicted<a name='7548'></font>
            ELSE<a name='7549'>
             cnuc(mgs) = 0.1*cnuc(mgs)<a name='7550'>
            ENDIF<a name='7551'>
          ENDIF<a name='7552'>
        ENDIF<a name='7553'>
       ENDDO<a name='7554'>
<a name='7555'>
<font color=#447700>!  Set density<a name='7556'></font>
<font color=#447700>!<a name='7557'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_DR: Set density'<a name='7558'>
<a name='7559'>
      do mgs = 1,ngscnt<a name='7560'>
        xdn(mgs,lc) = xdn0(lc)<a name='7561'>
        xdn(mgs,lr) = xdn0(lr)<a name='7562'>
      end do<a name='7563'>
<a name='7564'>
      ventrx(:) = ventr<a name='7565'>
      ventrxn(:) = ventrn<a name='7566'>
      <a name='7567'>
<a name='7568'>
<a name='7569'>
<font color=#447700>!       write(0,*) 'NUCOND: Set ssf variables, ssmxinit =',ssmxinit<a name='7570'></font>
      ssmx = 0.0<a name='7571'>
      DO mgs = 1,ngscnt<a name='7572'>
      <a name='7573'>
      kp1 = Min(nz, kgs(mgs)+1 )<a name='7574'>
      wvel(mgs) = (0.5)*(w(igs(mgs),jgs,kp1) &amp; <a name='7575'>
     &amp;                  +w(igs(mgs),jgs,kgs(mgs)))<a name='7576'>
      wvelkm1(mgs) = (0.5)*(w(igs(mgs),jgs,kgs(mgs)) &amp; <a name='7577'>
     &amp;                  +w(igs(mgs),jgs,Max(1,kgs(mgs)-1)))<a name='7578'>
<a name='7579'>
      ssat0(mgs)  = ssfilt(igs(mgs),jgs,kgs(mgs))<a name='7580'>
      ssf(mgs)    = ssfilt(igs(mgs),jgs,kgs(mgs))<a name='7581'>
<font color=#447700>!      ssmx = Max( ssmx, ssf(mgs) )<a name='7582'></font>
<a name='7583'>
      <a name='7584'>
      ssfkp1(mgs) = ssfilt(igs(mgs),jgs,Min(nz-1,kgs(mgs)+1))<a name='7585'>
      ssfkm1(mgs) = ssfilt(igs(mgs),jgs,Max(1,kgs(mgs)-1))<a name='7586'>
<a name='7587'>
<a name='7588'>
      ENDDO<a name='7589'>
<a name='7590'>
<a name='7591'>
<a name='7592'>
<font color=#447700>!<a name='7593'></font>
<font color=#447700>!  cloud water variables<a name='7594'></font>
<font color=#447700>!<a name='7595'></font>
<a name='7596'>
      if ( ndebug .gt. 0 )write(0,*) 'ICEZVD_DR: Set cloud water variables'<a name='7597'>
<a name='7598'>
      do mgs = 1,ngscnt<a name='7599'>
      xv(mgs,lc) = 0.0<a name='7600'>
      IF ( ipconc .ge. 2 .and. cx(mgs,lc) .gt. 1.0e6 ) THEN<a name='7601'>
        xmas(mgs,lc) = &amp;<a name='7602'>
     &amp;    min( max(qx(mgs,lc)*rho0(mgs)/cx(mgs,lc),cwmasn),cwmasx )<a name='7603'>
        xv(mgs,lc) = xmas(mgs,lc)/xdn(mgs,lc)<a name='7604'>
      ELSE<a name='7605'>
       IF ( qx(mgs,lc) .gt. qxmin(lc) .and. cx(mgs,lc) .gt. 0.01 ) THEN<a name='7606'>
        xmas(mgs,lc) = &amp;<a name='7607'>
     &amp;     min( max(qx(mgs,lc)*rho0(mgs)/cx(mgs,lc),xdn(mgs,lc)*xvmn(lc)), &amp;<a name='7608'>
     &amp;      xdn(mgs,lc)*xvmx(lc) )<a name='7609'>
<a name='7610'>
        cx(mgs,lc) = qx(mgs,lc)*rho0(mgs)/xmas(mgs,lc)<a name='7611'>
<a name='7612'>
       ELSEIF ( qx(mgs,lc) .gt. qxmin(lc) .and. cx(mgs,lc) .le. 0.01 ) THEN<a name='7613'>
        xmas(mgs,lc) = xdn(mgs,lc)*4.*pi/3.*(5.0e-6)**3<a name='7614'>
        cx(mgs,lc) = rho0(mgs)*qx(mgs,lc)/xmas(mgs,lc)<a name='7615'>
<a name='7616'>
       ELSE<a name='7617'>
        xmas(mgs,lc) = cwmasn<a name='7618'>
       ENDIF<a name='7619'>
      ENDIF<a name='7620'>
      xdia(mgs,lc,1) = (xmas(mgs,lc)*cwc1)**c1f3<a name='7621'>
<a name='7622'>
<a name='7623'>
      end do<a name='7624'>
<font color=#447700>!<a name='7625'></font>
<font color=#447700>! rain<a name='7626'></font>
<font color=#447700>!<a name='7627'></font>
      do mgs = 1,ngscnt<a name='7628'>
      if ( qx(mgs,lr) .gt. qxmin(lr) ) then<a name='7629'>
<a name='7630'>
      if ( ipconc .ge. 3 ) then<a name='7631'>
        xv(mgs,lr) = rho0(mgs)*qx(mgs,lr)/(xdn(mgs,lr)*Max(1.0e-9,cx(mgs,lr)))<a name='7632'>
<font color=#447700>!      parameter( xvmn(lr)=2.8866e-13, xvmx(lr)=4.1887e-9 )  ! mks<a name='7633'></font>
        IF ( xv(mgs,lr) .gt. xvmx(lr) ) THEN<a name='7634'>
          xv(mgs,lr) = xvmx(lr)<a name='7635'>
          cx(mgs,lr) = rho0(mgs)*qx(mgs,lr)/(xvmx(lr)*xdn(mgs,lr))<a name='7636'>
        ELSEIF ( xv(mgs,lr) .lt. xvmn(lr) ) THEN<a name='7637'>
          xv(mgs,lr) = xvmn(lr)<a name='7638'>
          cx(mgs,lr) = rho0(mgs)*qx(mgs,lr)/(xvmn(lr)*xdn(mgs,lr))<a name='7639'>
        ENDIF<a name='7640'>
<a name='7641'>
        xmas(mgs,lr) = xv(mgs,lr)*xdn(mgs,lr)<a name='7642'>
        xdia(mgs,lr,3) = (xmas(mgs,lr)*cwc1)**(1./3.) <font color=#447700>! xdia(mgs,lr,1)<a name='7643'></font>
        IF ( imurain == 3 ) THEN<a name='7644'>
<font color=#447700>!          xdia(mgs,lr,1) = (6.*pii*xv(mgs,lr)/(alpha(mgs,lr)+1.))**(1./3.)<a name='7645'></font>
          xdia(mgs,lr,1) = xdia(mgs,lr,3) <font color=#447700>! formulae for Ziegler (1985) use mean volume diameter, not lambda**(-1)<a name='7646'></font>
        ELSE <font color=#447700>! imurain == 1, Characteristic diameter (1/lambda)<a name='7647'></font>
          xdia(mgs,lr,1) = (6.*piinv*xv(mgs,lr)/((alpha(mgs,lr)+3.)*(alpha(mgs,lr)+2.)*(alpha(mgs,lr)+1.)))**(1./3.)<a name='7648'>
        ENDIF<a name='7649'>
<font color=#447700>!        rwrad(mgs) = 0.5*xdia(mgs,lr,1)<a name='7650'></font>
<a name='7651'>
<font color=#447700>! Inverse exponential version:<a name='7652'></font>
<font color=#447700>!        xdia(mgs,lr,1) =<a name='7653'></font>
<font color=#447700>!     &gt;  (qx(mgs,lr)*rho0(mgs)<a name='7654'></font>
<font color=#447700>!     &gt; /(pi*xdn(mgs,lr)*cx(mgs,lr)))**(0.333333)<a name='7655'></font>
      ELSE<a name='7656'>
        xdia(mgs,lr,1) = &amp;<a name='7657'>
     &amp;  (qx(mgs,lr)*rho0(mgs)/(pi*xdn(mgs,lr)*cno(lr)))**(0.25)<a name='7658'>
      end if<a name='7659'>
      else<a name='7660'>
        xdia(mgs,lr,1) = 1.e-9<a name='7661'>
<font color=#447700>!        rwrad(mgs) = 0.5*xdia(mgs,lr,1)<a name='7662'></font>
      end if<a name='7663'>
<a name='7664'>
      end do<a name='7665'>
<a name='7666'>
<a name='7667'>
<font color=#447700>!<a name='7668'></font>
<font color=#447700>!  Ventilation coefficients<a name='7669'></font>
<a name='7670'>
      do mgs = 1,ngscnt<a name='7671'>
<a name='7672'>
<a name='7673'>
      fadvisc(mgs) = advisc0*(416.16/(temg(mgs)+120.0))* &amp; <a name='7674'>
     &amp;  (temg(mgs)/296.0)**(1.5)<a name='7675'>
<a name='7676'>
      fakvisc(mgs) = fadvisc(mgs)*rhoinv(mgs)<a name='7677'>
<a name='7678'>
      fwvdf(mgs) = (2.11e-05)*((temg(mgs)/tfr)**1.94)* &amp; <a name='7679'>
     &amp;  (101325.0/(pres(mgs)))<a name='7680'>
      <a name='7681'>
      fschm(mgs) = (fakvisc(mgs)/fwvdf(mgs))<a name='7682'>
<a name='7683'>
      fvent(mgs) = (fschm(mgs)**(1./3.)) * (fakvisc(mgs)**(-0.5))<a name='7684'>
<a name='7685'>
      end do<a name='7686'>
<font color=#447700>!<a name='7687'></font>
<font color=#447700>!<a name='7688'></font>
<font color=#447700>!  Ziegler nucleation <a name='7689'></font>
<font color=#447700>!<a name='7690'></font>
<font color=#447700>!<a name='7691'></font>
<font color=#447700>! cloud evaporation, condensation, and nucleation<a name='7692'></font>
<font color=#447700>!  sqsat -&gt; qss(mgs)<a name='7693'></font>
<a name='7694'>
      DO mgs=1,ngscnt<a name='7695'>
        dcloud = 0.0<a name='7696'>
        IF ( temg(mgs) .le. tfrh ) THEN<a name='7697'>
         CYCLE<a name='7698'>
        ENDIF<a name='7699'>
<a name='7700'>
      IF( ssat0(mgs) .GT. 0. .OR. ssf(mgs) .GT. 0. ) GO TO 620<a name='7701'>
<font color=#447700>!6/4      IF( qvap(mgs) .EQ. qss(mgs) ) GO TO 631<a name='7702'></font>
<font color=#447700>!<a name='7703'></font>
<font color=#447700>!.... EVAPORATION. QV IS LESS THAN qss(mgs).<a name='7704'></font>
<font color=#447700>!.... EVAPORATE CLOUD FIRST<a name='7705'></font>
<font color=#447700>!<a name='7706'></font>
      IF ( qx(mgs,lc) .LE. 0. ) GO TO 631<a name='7707'>
<font color=#447700>!.... CLOUD EVAPORATION.<a name='7708'></font>
<font color=#447700>! convert input 'cp' to cgs<a name='7709'></font>
      R1=1./(1. + caw*(273.15 - cbw)*qss(mgs)*felv(mgs)/ &amp;<a name='7710'>
     &amp;            (cp*(temg(mgs) - cbw)**2))<a name='7711'>
      QEVAP= Min( qx(mgs,lc), R1*(qss(mgs)-qvap(mgs)) )<a name='7712'>
<a name='7713'>
<a name='7714'>
      IF ( qx(mgs,lc) .LT. QEVAP ) THEN <font color=#447700>! GO TO 63<a name='7715'></font>
        qwvp(mgs) = qwvp(mgs) + qx(mgs,lc)<a name='7716'>
        thetap(mgs) = thetap(mgs) - felv(mgs)*qx(mgs,lc)/(cp*pi0(mgs))<a name='7717'>
        IF ( io_flag .and. nxtra &gt; 1 ) THEN<a name='7718'>
           axtra(igs(mgs),jy,kgs(mgs),1) = -qx(mgs,lc)/dtp<a name='7719'>
        ENDIF<a name='7720'>
        qx(mgs,lc) = 0.<a name='7721'>
        cx(mgs,lc) = 0.<a name='7722'>
      ELSE<a name='7723'>
        qwvp(mgs) = qwvp(mgs) + QEVAP<a name='7724'>
        qx(mgs,lc) = qx(mgs,lc) - QEVAP<a name='7725'>
        IF ( qx(mgs,lc) .le. 0. ) cx(mgs,lc) = 0.<a name='7726'>
        thetap(mgs) = thetap(mgs) - felv(mgs)*QEVAP/(CP*pi0(mgs))<a name='7727'>
        IF ( io_flag .and. nxtra &gt; 1 ) THEN<a name='7728'>
           axtra(igs(mgs),jy,kgs(mgs),1) = -QEVAP/dtp<a name='7729'>
        ENDIF<a name='7730'>
<a name='7731'>
      ENDIF<a name='7732'>
<a name='7733'>
      GO TO 631<a name='7734'>
<a name='7735'>
<a name='7736'>
  620 CONTINUE<a name='7737'>
<a name='7738'>
<font color=#447700>!.... CLOUD CONDENSATION<a name='7739'></font>
<a name='7740'>
        IF ( qx(mgs,lc) .GT. qxmin(lc) .and. cx(mgs,lc) .ge. 1. ) THEN<a name='7741'>
<a name='7742'>
<a name='7743'>
<a name='7744'>
<font color=#447700>!       ac1 =  xdn(mgs,lc)*elv(kgs(mgs))**2*epsi/<a name='7745'></font>
<font color=#447700>!     :        (tka(kgs(mgs))*rw*temg(mgs)**2)<a name='7746'></font>
<font color=#447700>! took out xdn factor because it cancels later...<a name='7747'></font>
       ac1 =  felv(mgs)**2/(tka(mgs)*rw*temg(mgs)**2)<a name='7748'>
<a name='7749'>
<a name='7750'>
<font color=#447700>!       bc = xdn(mgs,lc)*rw*temg(mgs)/<a name='7751'></font>
<font color=#447700>!     :       (epsi*wvdf(kgs(mgs))*es(mgs))<a name='7752'></font>
<font color=#447700>! took out xdn factor because it cancels later...<a name='7753'></font>
       bc =   rw*temg(mgs)/(wvdf(mgs)*es(mgs))<a name='7754'>
<a name='7755'>
<font color=#447700>!       bs = rho0(mgs)*((rd*temg(mgs)/(epsi*es(mgs)))+<a name='7756'></font>
<font color=#447700>!     :             (epsi*elv(kgs(mgs))**2/(pres(mgs)*temg(mgs)*cp)))<a name='7757'></font>
<a name='7758'>
<font color=#447700>!       taus = Min(dtp, xdn(mgs,lc)*rho0(mgs)*(ac1+bc)/<a name='7759'></font>
<font color=#447700>!     :        (4*pi*0.89298*BS*0.5*xdia(mgs,lc,1)*cx(mgs,lc)*xdn(mgs,lc)))<a name='7760'></font>
<a name='7761'>
<font color=#447700>!<a name='7762'></font>
      IF ( ssf(mgs) .gt. 0.0 .or. ssat0(mgs) .gt. 0.0 ) THEN<a name='7763'>
       IF ( ny .le. 2 ) THEN<a name='7764'>
<font color=#447700>!        write(0,*)  'undershoot: ',ssf(mgs),<a name='7765'></font>
<font color=#447700>!     :   ( (qx(mgs,lv) - dcloud)/c1 - 1.0)*100.<a name='7766'></font>
       ENDIF<a name='7767'>
<a name='7768'>
<a name='7769'>
<a name='7770'>
       IF ( qx(mgs,lc) .gt. qxmin(lc) ) THEN<a name='7771'>
<a name='7772'>
         IF ( xdia(mgs,lc,1) .le. 0.0 ) THEN<a name='7773'>
          xmas(mgs,lc) = cwmasn<a name='7774'>
          xdia(mgs,lc,1) = (xmas(mgs,lc)*cwc1)**c1f3<a name='7775'>
         ENDIF<a name='7776'>
        d1 = (1./(ac1 + bc))*4.0*pi*ventc &amp;<a name='7777'>
     &amp;        *0.5*xdia(mgs,lc,1)*cx(mgs,lc)*rhoinv(mgs)<a name='7778'>
<a name='7779'>
       ELSE<a name='7780'>
         d1 = 0.0<a name='7781'>
       ENDIF<a name='7782'>
<a name='7783'>
       IF ( rcond .eq. 2 .and. qx(mgs,lr) .gt. qxmin(lr) .and. cx(mgs,lr) &gt; 1.e-9 ) THEN<a name='7784'>
          IF ( imurain == 3 ) THEN<a name='7785'>
           IF ( izwisventr == 1 ) THEN<a name='7786'>
            rwvent(mgs) = ventrx(mgs)*(1.6 + 124.9*(1.e-3*rho0(mgs)*qx(mgs,lr))**.2046)<a name='7787'>
           ELSE <font color=#447700>! izwisventr = 2<a name='7788'></font>
<font color=#447700>!  Following Wisner et al. (1972) but using gamma of volume. Note that Ferrier's rain fall speed does not integrate with gamma of volume, so using Vr = ar*d^br<a name='7789'></font>
          rwvent(mgs) =   &amp;<a name='7790'>
     &amp;  (0.78*ventrx(mgs) + 0.308*ventrxn(mgs)*fvent(mgs)   &amp;<a name='7791'>
     &amp;   *Sqrt((ar*rhovt(mgs)))   &amp;<a name='7792'>
     &amp;    *(xdia(mgs,lr,1)**((1.0+br)/2.0)) )<a name='7793'>
           ENDIF<a name='7794'>
<a name='7795'>
          ELSE <font color=#447700>! imurain == 1<a name='7796'></font>
<a name='7797'>
           IF ( iferwisventr == 1 ) THEN<a name='7798'>
             alpr = Min(alpharmax,alpha(mgs,lr) )<a name='7799'>
<font color=#447700>!             alpr = alpha(mgs,lr)<a name='7800'></font>
             x =  1. + alpr<a name='7801'>
<a name='7802'>
              tmp = 1 + alpr<a name='7803'>
              i = Int(dgami*(tmp))<a name='7804'>
              del = tmp - dgam*i<a name='7805'>
              g1palp = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='7806'>
<a name='7807'>
              tmp = 2.5 + alpr + 0.5*bx(lr)<a name='7808'>
              i = Int(dgami*(tmp))<a name='7809'>
              del = tmp - dgam*i<a name='7810'>
              y = (gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami)/g1palp <font color=#447700>! ratio of gamma functions<a name='7811'></font>
<a name='7812'>
<font color=#447700>!         vent1 = dble(xdia(mgs,lr,1))**(-2. - alpr) ! Actually OK<a name='7813'></font>
<font color=#447700>!         vent2 = dble(1./xdia(mgs,lr,1) + 0.5*fx(lr))**dble(2.5+alpr+0.5*bx(lr))  ! Actually OK<a name='7814'></font>
         vent1 = dble(xdia(mgs,lr,1))**(0.5 + 0.5*bx(lr)) <font color=#447700>! 2016.2.26 Changed for consistency with derivation (recast formula)<a name='7815'></font>
         vent2 = dble(1. + 0.5*fx(lr)*xdia(mgs,lr,1))**dble(2.5+alpr+0.5*bx(lr))<a name='7816'>
        <a name='7817'>
        <a name='7818'>
        rwvent(mgs) =    &amp;<a name='7819'>
     &amp;    0.78*x +    &amp;<a name='7820'>
     &amp;    0.308*fvent(mgs)*y*   &amp;<a name='7821'>
     &amp;            Sqrt(ax(lr)*rhovt(mgs))*(vent1/vent2)<a name='7822'>
<a name='7823'>
           ELSEIF ( iferwisventr == 2 ) THEN<a name='7824'>
          <a name='7825'>
<font color=#447700>!  Following Wisner et al. (1972) but using gamma of volume. Note that Ferrier's rain fall speed does not integrate with gamma of volume, so using Vr = ar*d^br<a name='7826'></font>
            x =  1. + alpha(mgs,lr)<a name='7827'>
<a name='7828'>
            rwvent(mgs) =   &amp;<a name='7829'>
     &amp;        (0.78*x + 0.308*ventrxn(mgs)*fvent(mgs)   &amp;<a name='7830'>
     &amp;         *Sqrt((ar*rhovt(mgs)))   &amp;<a name='7831'>
     &amp;         *(xdia(mgs,lr,1)**((1.0+br)/2.0)) )<a name='7832'>
<a name='7833'>
          <a name='7834'>
          ENDIF <font color=#447700>! iferwisventr<a name='7835'></font>
          <a name='7836'>
       ENDIF <font color=#447700>! imurain<a name='7837'></font>
<a name='7838'>
       d1r = (1./(ac1 + bc))*4.0*pi*rwvent(mgs) &amp; <a name='7839'>
     &amp;        *0.5*xdia(mgs,lr,1)*cx(mgs,lr)*rhoinv(mgs)<a name='7840'>
       ELSE<a name='7841'>
       d1r = 0.0<a name='7842'>
       ENDIF<a name='7843'>
       <a name='7844'>
       <a name='7845'>
       e1  = felvcp(mgs)/(pi0(mgs))<a name='7846'>
       f1 = pk(mgs) <font color=#447700>! (pres(mgs)/poo)**cap<a name='7847'></font>
<a name='7848'>
<font color=#447700>!<a name='7849'></font>
<font color=#447700>!  fifth trial to see what happens:<a name='7850'></font>
<font color=#447700>!<a name='7851'></font>
       ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='7852'>
       ltemq = Min( nqsat, Max(1,ltemq) )<a name='7853'>
       ltemq1 = ltemq<a name='7854'>
       temp1 = temg(mgs)<a name='7855'>
       p380 = 380.0/pres(mgs)<a name='7856'>
<a name='7857'>
<font color=#447700>!       taus = Max( 0.05*dtp, Min(taus, 0.25*dtp ) )<a name='7858'></font>
<font color=#447700>!       nc = NInt(dtp/Min(1.0,0.5*taus))<a name='7859'></font>
<font color=#447700>!       dtcon = dtp/float(nc)<a name='7860'></font>
       ss1 = qx(mgs,lv)/qvs(mgs)<a name='7861'>
       ss2 = ss1<a name='7862'>
       temp2 = temp1<a name='7863'>
       qv1 = qx(mgs,lv)<a name='7864'>
       qvs1 = qvs(mgs)<a name='7865'>
       qis1 = qis(mgs)<a name='7866'>
       dt1 = 0.0<a name='7867'>
<a name='7868'>
<a name='7869'>
<font color=#447700>!          dtcon = Max(dtcon,0.2)<a name='7870'></font>
<font color=#447700>!          nc = Nint(dtp/dtcon)<a name='7871'></font>
<a name='7872'>
       ltemq1 = ltemq<a name='7873'>
<font color=#447700>! want to start out with a small time step to handle the steep slope<a name='7874'></font>
<font color=#447700>! and fast changes, then can switch to a larger step (dtcon2) for the<a name='7875'></font>
<font color=#447700>! rest of the big time step.<a name='7876'></font>
<font color=#447700>! base the initial time step (dtcon1) on the slope (delta)<a name='7877'></font>
       IF ( Abs(ss1 - 1.0) .gt. 1.e-5 ) THEN<a name='7878'>
         delta = 0.5*(qv1-qvs1)/(d1*(ss1 - 1.0))<a name='7879'>
       ELSE<a name='7880'>
         delta = 0.1*dtp<a name='7881'>
       ENDIF<a name='7882'>
<font color=#447700>! delta is the extrapolated time to get halfway from qv1 to qvs1<a name='7883'></font>
<font color=#447700>! want at least 5 time steps to the halfway point, so multiply by 0.2<a name='7884'></font>
<font color=#447700>! for the initial time step<a name='7885'></font>
       dtcon1 = Min(0.05,0.2*delta)<a name='7886'>
       nc = Max(5,2*NInt( (dtp-4.0*dtcon1)/delta))<a name='7887'>
       dtcon2 = (dtp-4.0*dtcon1)/nc<a name='7888'>
<a name='7889'>
       n = 1<a name='7890'>
       dt1 = 0.0<a name='7891'>
       nc = 0<a name='7892'>
       dqc = 0.0<a name='7893'>
       dqr = 0.0<a name='7894'>
       dqi = 0.0<a name='7895'>
       dqs = 0.0<a name='7896'>
       dqvii = 0.0<a name='7897'>
       dqvis = 0.0<a name='7898'>
<a name='7899'>
       RK2c: DO WHILE ( dt1 .lt. dtp )<a name='7900'>
          nc = 0<a name='7901'>
          IF ( n .le. 4 ) THEN<a name='7902'>
            dtcon = dtcon1<a name='7903'>
          ELSE<a name='7904'>
            dtcon = dtcon2<a name='7905'>
          ENDIF<a name='7906'>
 609       dqv  = -(ss1 - 1.)*d1*dtcon<a name='7907'>
           dqvr = -(ss1 - 1.)*d1r*dtcon<a name='7908'>
            dtemp = -0.5*e1*f1*(dqv + dqvr)<a name='7909'>
<font color=#447700>!          write(0,*) 'RK2c dqv1 = ',dqv<a name='7910'></font>
<font color=#447700>! calculate midpoint values:<a name='7911'></font>
     <font color=#447700>!      ltemq1m = ltemq1 + Nint(dtemp*fqsat + 0.5)<a name='7912'></font>
<a name='7913'>
         <font color=#447700>! 7.6.2016: Test full calc of ltemq<a name='7914'></font>
           ltemq1m = (temp1+dtemp-163.15)*fqsati+1.5<a name='7915'>
           ltemq1m = Min( nqsat, Max(1,ltemq1m) )<a name='7916'>
<a name='7917'>
           IF ( ltemq1m .lt. 1 .or. ltemq1m .gt. nqsat ) THEN<a name='7918'>
             write(0,*) 'STOP in nucond line 1192 '<a name='7919'>
             write(0,*) ' ltemq1m,icond = ',ltemq1m,icond<a name='7920'>
             write(0,*) ' dtemp,e1,f1,dqv,dqvr = ', dtemp,e1,f1,dqv,dqvr<a name='7921'>
             write(0,*) ' d1,d1r,dtcon,ss1 = ',d1,d1r,dtcon,ss1<a name='7922'>
             write(0,*) ' dqc, dqr = ',dqc,dqr<a name='7923'>
             write(0,*) ' qv,qc,qr = ',qx(mgs,lv)*1000.,qx(mgs,lc)*1000.,qx(mgs,lr)*1000.<a name='7924'>
             write(0,*) ' i, j, k = ',igs(mgs),jy,kgs(mgs)<a name='7925'>
             write(0,*) ' dtcon1,dtcon2,delta = ',dtcon1,dtcon2,delta<a name='7926'>
             write(0,*) ' nc,dtp = ',nc,dtp<a name='7927'>
             write(0,*) ' rwvent,xdia,crw,ccw = ', rwvent(mgs),xdia(mgs,lr,1),cx(mgs,lr),cx(mgs,lc)<a name='7928'>
             write(0,*) ' fvent,alphar = ',fvent(mgs),alpha(mgs,lr)<a name='7929'>
             write(0,*) ' xvr,xmasr,xdnr,cwc1 = ',xv(mgs,lr),xmas(mgs,lr),xdn(mgs,lr),cwc1<a name='7930'>
           ENDIF<a name='7931'>
            dqvs = dtemp*p380*dtabqvs(ltemq1m)<a name='7932'>
            qv1m = qv1 + dqv + dqvr<a name='7933'>
<font color=#447700>!          qv1mr = qv1r + dqvr<a name='7934'></font>
<a name='7935'>
            qvs1m = qvs1 + dqvs<a name='7936'>
            ss1m = qv1m/qvs1m<a name='7937'>
<a name='7938'>
    <font color=#447700>! check for undersaturation when no ice is present, if so, then reduce time step<a name='7939'></font>
          IF ( ss1m .lt. 1.  .and. (dqvii + dqvis) .eq. 0.0 ) THEN<a name='7940'>
            dtcon = (0.5*dtcon)<a name='7941'>
            IF ( dtcon .ge. dtcon1 ) THEN<a name='7942'>
             GOTO 609<a name='7943'>
            ELSE<a name='7944'>
             EXIT<a name='7945'>
            ENDIF<a name='7946'>
          ENDIF<a name='7947'>
<font color=#447700>! calculate full step:<a name='7948'></font>
          dqv  = -(ss1m - 1.)*d1*dtcon<a name='7949'>
          dqvr = -(ss1m - 1.)*d1r*dtcon<a name='7950'>
<a name='7951'>
<a name='7952'>
<font color=#447700>!          write(0,*) 'RK2a dqv1m = ',dqv<a name='7953'></font>
          dtemp = -e1*f1*(dqv + dqvr)<a name='7954'>
          <a name='7955'>
         <font color=#447700>! ltemq1 = ltemq1 + Nint(dtemp*fqsat + 0.5)<a name='7956'></font>
<a name='7957'>
         <font color=#447700>! 7.6.2016: Test full calc of ltemq<a name='7958'></font>
           ltemq1 = (temp1+dtemp-163.15)*fqsati+1.5<a name='7959'>
           ltemq1 = Min( nqsat, Max(1,ltemq1) )<a name='7960'>
<a name='7961'>
           IF ( ltemq1 .lt. 1 .or. ltemq1 .gt. nqsat ) THEN<a name='7962'>
             write(0,*) 'STOP in nucond line 1230 '<a name='7963'>
             write(0,*) ' ltemq1m,icond = ',ltemq1m,icond<a name='7964'>
             write(0,*) ' dtemp,e1,dqv,dqvr = ', dtemp,e1,dqv,dqvr<a name='7965'>
           ENDIF<a name='7966'>
          dqvs = dtemp*p380*dtabqvs(ltemq1)<a name='7967'>
<a name='7968'>
          qv1 = qv1 + dqv + dqvr<a name='7969'>
<a name='7970'>
          dqc = dqc - dqv<a name='7971'>
          dqr = dqr - dqvr<a name='7972'>
<a name='7973'>
          qvs1 = qvs1 + dqvs<a name='7974'>
          ss1 = qv1/qvs1<a name='7975'>
          temp1 = temp1 + dtemp<a name='7976'>
          IF ( temp2 .eq. temp1 .or. ss2 .eq. ss1 .or.  &amp;<a name='7977'>
     &amp;           ss1 .eq. 1.00 .or.  &amp;<a name='7978'>
     &amp;      ( n .gt. 10 .and. ss1 .lt. 1.0005 ) ) THEN<a name='7979'>
<font color=#447700>!           write(0,*) 'RK2c break'<a name='7980'></font>
           EXIT<a name='7981'>
          ELSE<a name='7982'>
           ss2 = ss1<a name='7983'>
           temp2 = temp1<a name='7984'>
           dt1 = dt1 + dtcon<a name='7985'>
           n = n + 1<a name='7986'>
          ENDIF<a name='7987'>
       ENDDO RK2c<a name='7988'>
<a name='7989'>
<a name='7990'>
        dcloud = dqc <font color=#447700>! qx(mgs,lv) - qv1<a name='7991'></font>
        thetap(mgs) = thetap(mgs) + e1*(DCLOUD + dqr)<a name='7992'>
<a name='7993'>
<a name='7994'>
        IF ( eqtset &gt; 2 ) THEN<a name='7995'>
           pipert(mgs) = pipert(mgs) + felvpi(mgs)*(DCLOUD + dqr)<a name='7996'>
        ENDIF<a name='7997'>
        IF ( io_flag .and. nxtra &gt; 1 ) THEN<a name='7998'>
           axtra(igs(mgs),jy,kgs(mgs),1) = DCLOUD/dtp<a name='7999'>
           axtra(igs(mgs),jy,kgs(mgs),2) = axtra(igs(mgs),jy,kgs(mgs),2) + dqr/dtp<a name='8000'>
        ENDIF<a name='8001'>
        qwvp(mgs) = qwvp(mgs) - (DCLOUD + dqr)<a name='8002'>
        qx(mgs,lc) = qx(mgs,lc) + DCLOUD<a name='8003'>
        qx(mgs,lr) = qx(mgs,lr) + dqr<a name='8004'>
<font color=#447700>!        t9(igs(mgs),jy,kgs(mgs)) = t9(igs(mgs),jy,kgs(mgs)) + (DCLOUD + dqr)/dtp*felv(mgs)/(cp*pi0(mgs)) !* &amp;<a name='8005'></font>
<font color=#447700>!!     &amp;                 dx*dy*dz3d(igs(mgs),jy,kgs(mgs))<a name='8006'></font>
<a name='8007'>
<a name='8008'>
        theta(mgs) = thetap(mgs) + theta0(mgs)<a name='8009'>
        temg(mgs) = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NUCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_17">(mgs)*f1<a name='8010'>
        ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='8011'>
        ltemq = Min( nqsat, Max(1,ltemq) )<a name='8012'>
        qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='8013'>
<font color=#447700>!        es(mgs) = 6.1078e2*tabqvs(ltemq)<a name='8014'></font>
<a name='8015'>
<font color=#447700>!<a name='8016'></font>
<a name='8017'>
      ENDIF  <font color=#447700>! dcloud .gt. 0.<a name='8018'></font>
<a name='8019'>
<a name='8020'>
      ELSE  <font color=#447700>! qc .le. qxmin(lc)<a name='8021'></font>
<a name='8022'>
<font color=#447700>!        IF ( ssf(mgs) .gt. 0.0 .and. .not. flag_qndrop ) THEN ! flag_qndrop turns off primary nucleation when using wrf-chem with progn=1<a name='8023'></font>
        IF ( ssf(mgs) .gt. 0.0 ) THEN <font color=#447700>! .and.  ssmax(mgs) .lt. sscb ) THEN ! except that wrf-chem does not seem to initialize qc for activated aerosols, so keep this, after all<a name='8024'></font>
<a name='8025'>
          IF ( iqcinit == 1 ) THEN<a name='8026'>
<a name='8027'>
         qvs0   = 380.*exp(17.27*(temg(mgs)-273.)/(temg(mgs)- 36.))/pk(mgs)<a name='8028'>
<a name='8029'>
         dcloud = Max(0.0, (qx(mgs,lv)-qvs0) / (1.+qvs0*f5/(temg(mgs)-36.)**2) )<a name='8030'>
<a name='8031'>
          ELSEIF ( iqcinit == 3 ) THEN<a name='8032'>
              R1=1./(1. + caw*(273.15 - cbw)*qss(mgs)*felvcp(mgs)/ &amp; <a name='8033'>
     &amp;             ((temg(mgs) - cbw)**2))<a name='8034'>
            DCLOUD=R1*(qvap(mgs) - qvs(mgs))  <font color=#447700>! KW model adjustment; <a name='8035'></font>
                              <font color=#447700>! this will put mass into qc if qv &gt; sqsat exists<a name='8036'></font>
          <a name='8037'>
          ELSEIF ( iqcinit == 2 ) THEN<a name='8038'>
<font color=#447700>!              R1=1./(1. + caw*(273.15 - cbw)*qss(mgs)*felv(mgs)/<a name='8039'></font>
<font color=#447700>!     :             (cp*(temg(mgs) - cbw)**2))<a name='8040'></font>
<font color=#447700>!            DCLOUD=R1*(qvap(mgs) - qvs(mgs))  ! KW model adjustment; <a name='8041'></font>
                              <font color=#447700>! this will put mass into qc if qv &gt; sqsat exists<a name='8042'></font>
         ssmx = ssmxinit<a name='8043'>
<a name='8044'>
          IF ( ssf(mgs) &gt; ssmx ) THEN<a name='8045'>
           CALL <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#QVEXCESS'>QVEXCESS</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NUCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QVEXCESS_1">(ngs,mgs,qwvp,qv0,qx(1,lc),pres,thetap,theta0,dcloud, &amp; <a name='8046'>
     &amp;      pi0,tabqvs,nqsat,fqsat,cbw,fcqv1,felvcp,ssmx,pk,ngscnt)<a name='8047'>
          ELSE<a name='8048'>
            dcloud = 0.0<a name='8049'>
          ENDIF<a name='8050'>
         ENDIF<a name='8051'>
        ELSE<a name='8052'>
            dcloud = 0.0<a name='8053'>
        ENDIF<a name='8054'>
<a name='8055'>
        thetap(mgs) = thetap(mgs) + felvcp(mgs)*DCLOUD/(pi0(mgs))<a name='8056'>
        qwvp(mgs) = qwvp(mgs) - DCLOUD<a name='8057'>
        qx(mgs,lc) = qx(mgs,lc) + DCLOUD<a name='8058'>
        IF ( io_flag .and. nxtra &gt; 1 ) THEN<a name='8059'>
           axtra(igs(mgs),jy,kgs(mgs),1) = DCLOUD/dtp<a name='8060'>
        ENDIF<a name='8061'>
        theta(mgs) = thetap(mgs) + theta0(mgs)<a name='8062'>
        temg(mgs) = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NUCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_18">(mgs)*pk(mgs) <font color=#447700>!( pres(mgs) / poo ) ** cap<a name='8063'></font>
<font color=#447700>!        temg(mgs) = theta2temp( theta(mgs), pres(mgs) )<a name='8064'></font>
        ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='8065'>
        ltemq = Min( nqsat, Max(1,ltemq) )<a name='8066'>
        qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='8067'>
<font color=#447700>!        es(mgs) = 6.1078e2*tabqvs(ltemq)<a name='8068'></font>
<a name='8069'>
<font color=#447700>!.... S. TWOMEY (1959)<a name='8070'></font>
<font color=#447700>! Note: get here if there is no previous cloud water and w &gt; 0.<a name='8071'></font>
      cn(mgs) = 0.0<a name='8072'>
      <a name='8073'>
      IF ( ncdebug .ge. 1 ) THEN<a name='8074'>
        write(iunit,*) 'at 613: ',qx(mgs,lc),cx(mgs,lc),wvel(mgs),ssmax(mgs),kgs(mgs)<a name='8075'>
      ENDIF<a name='8076'>
      <a name='8077'>
      IF (  .not. flag_qndrop ) THEN <font color=#447700>! { only calculate mass change when using wrf-chem<a name='8078'></font>
<a name='8079'>
      <a name='8080'>
<font color=#447700>!      IF ( ssmax(mgs) .lt. sscb .and. qx(mgs,lc) .gt. qxmin(lc)) THEN<a name='8081'></font>
      IF ( dcloud .gt. qxmin(lc) .and. wvel(mgs) &gt; 0.0) THEN<a name='8082'>
<font color=#447700>!       CN(mgs) =   CCNE*wvel(mgs)**cnexp ! *Min(1.0,1./dtp) ! 0.3465<a name='8083'></font>
       CN(mgs) =   CCNE0*cnuc(mgs)**(2./(2.+cck))*wvel(mgs)**cnexp <font color=#447700>! *Min(1.0,1./dtp) ! 0.3465<a name='8084'></font>
        IF ( ny .le. 2 .and. cn(mgs) .gt. 0.0    &amp;<a name='8085'>
     &amp;                    .and. ncdebug .ge. 1 ) THEN <a name='8086'>
          write(iunit,*) 'CN: ',cn(mgs)*1.e-6, cx(mgs,lc)*1.e-6, qx(mgs,lc)*1.e3,   &amp;<a name='8087'>
     &amp;       wvel(mgs), dcloud*1.e3<a name='8088'>
          IF ( cn(mgs) .gt. 1.0 ) write(iunit,*) 'cwrad = ',   &amp;<a name='8089'>
     &amp;       1.e6*(rho0(mgs)*qx(mgs,lc)/cn(mgs)*cwc1)**c1f3,   &amp;<a name='8090'>
     &amp;   igs(mgs),kgs(mgs),temcg(mgs),    &amp;<a name='8091'>
     &amp;   1.e3*an(igs(mgs),jgs,kgs(mgs)-1,lc)<a name='8092'>
        ENDIF<a name='8093'>
        IF ( iccwflg .eq. 1 ) THEN<a name='8094'>
          cn(mgs) = Min(cwccn*rho0(mgs)/rho00, Max(cn(mgs),   &amp;<a name='8095'>
     &amp;       rho0(mgs)*qx(mgs,lc)/(xdn(mgs,lc)*(4.*pi/3.)*(4.e-6)**3)))<a name='8096'>
        ENDIF<a name='8097'>
      ELSE<a name='8098'>
       cn(mgs) = 0.0<a name='8099'>
       dcloud = 0.0<a name='8100'>
<font color=#447700>!          cn(mgs) = Min(cwccn,    &amp;<a name='8101'></font>
<font color=#447700>!     &amp;       rho0(mgs)*dcloud/(xdn(mgs,lc)*(4.*pi/3.)*(4.e-6)**3) )<a name='8102'></font>
      ENDIF<a name='8103'>
<a name='8104'>
      IF ( cn(mgs) .gt. 0.0 ) THEN<a name='8105'>
       IF ( cn(mgs) .gt. ccnc(mgs) ) THEN<a name='8106'>
         cn(mgs) = ccnc(mgs)<a name='8107'>
<font color=#447700>!         ccnc(mgs) = 0.0<a name='8108'></font>
       ENDIF<a name='8109'>
<font color=#447700>!      cx(mgs,lc) = cx(mgs,lc) + cn(mgs)<a name='8110'></font>
      IF ( irenuc &lt;= 2 ) ccnc(mgs) = Max(0.0, ccnc(mgs) - cn(mgs))<a name='8111'>
      ccna(mgs) = ccna(mgs) + cn(mgs)<a name='8112'>
      ENDIF<a name='8113'>
<a name='8114'>
<font color=#447700>!       write(91,*) 'nuc1: cn, ix, kz = ',cn(mgs),igs(mgs),kgs(mgs),wvel(mgs),cnexp,ccnc(mgs)<a name='8115'></font>
<a name='8116'>
      IF( CN(mgs) .GT. cx(mgs,lc) ) cx(mgs,lc) = CN(mgs)<a name='8117'>
      IF( cx(mgs,lc) .GT. 0. .AND. qx(mgs,lc) .le. qxmin(lc) ) THEN<a name='8118'>
        cx(mgs,lc) = 0.<a name='8119'>
      ELSE<a name='8120'>
        cx(mgs,lc) = Min(cx(mgs,lc),rho0(mgs)*Max(0.0,qx(mgs,lc))/cwmasn)<a name='8121'>
      ENDIF<a name='8122'>
      <a name='8123'>
      ENDIF <font color=#447700>! }.not. flag_qndrop<a name='8124'></font>
<a name='8125'>
        GOTO 613<a name='8126'>
        <a name='8127'>
        END IF <font color=#447700>! qc .gt. 0.<a name='8128'></font>
<a name='8129'>
<font color=#447700>!        ES=EES(PIB(K)*PT)<a name='8130'></font>
<font color=#447700>!        SQSAT=EPSI*ES/(PB(K)*1000.-ES)<a name='8131'></font>
<a name='8132'>
<font color=#447700>!.... CLOUD NUCLEATION<a name='8133'></font>
<font color=#447700>!      T=PIB(K)*PT<a name='8134'></font>
<font color=#447700>!      ES=1.E3*PB(K)*QV/EPSI<a name='8135'></font>
<a name='8136'>
      IF ( wvel(mgs) .le. 0. ) GO TO 616<a name='8137'>
      IF ( cx(mgs,lc) .le. 0. )  GO TO 613                             <font color=#447700>!TWOMEY (1959) Nucleation<a name='8138'></font>
      IF ( kzbeg-1+kgs(mgs) .GT. 1 .and. qx(mgs,lc) .le. qxmin(lc)) GO TO 613  <font color=#447700>!TWOMEY (1959) Nucleation<a name='8139'></font>
      IF ( kzbeg-1+kgs(mgs) .eq. 1 .and. wvel(mgs) .gt. 0. ) GO TO 613         <font color=#447700>!TWOMEY (1959) Nucleation<a name='8140'></font>
<font color=#447700>!.... ATTEMPT ZIEGLER CLOUD NUCLEATION IN CLOUD INTERIOR UNLESS...<a name='8141'></font>
  616 IF ( ssf(mgs) .LE. SUPCB .AND. wvel(mgs) .GT. 0. ) GO TO 631 <font color=#447700>!... weakly saturated updraft<a name='8142'></font>
      IF ( kzbeg-1+kgs(mgs) .GT. 1 .AND. kzbeg-1+kgs(mgs) .LT. nzend-1 .AND.  &amp;<a name='8143'>
     &amp;    (ssfkp1(mgs) .GE. SUPMX .OR. &amp;<a name='8144'>
     &amp;     ssf(mgs)    .GE. SUPMX .OR. &amp;<a name='8145'>
     &amp;     ssfkm1(mgs) .GE. SUPMX)) GO TO 631                      <font color=#447700>!... too much vapour<a name='8146'></font>
      IF (ssf(mgs) .LT. 1.E-10 .OR. ssf(mgs) .GE. SUPMX) GO TO 631 <font color=#447700>!... at the extremes for ss<a name='8147'></font>
<a name='8148'>
<font color=#447700>!<a name='8149'></font>
<font color=#447700>! get here if ( qc &gt; 0 and ss &gt; supcb) or (w &lt; 0)<a name='8150'></font>
<font color=#447700>!<a name='8151'></font>
<a name='8152'>
      if (ndebug .gt. 0) write(0,*) "ICEZVD_DR: Entered Ziegler Cloud Nucleation" <font color=#447700>!mpidebug<a name='8153'></font>
<a name='8154'>
      DSSDZ=0.<a name='8155'>
      r2dzm=0.50/dz3d(igs(mgs),jy,kgs(mgs))<a name='8156'>
      IF ( irenuc &gt;= 0 .and. .not. flag_qndrop) THEN <font color=#447700>! turn off nucleation when flag_qndrop (using WRF-CHEM for activation)<a name='8157'></font>
<a name='8158'>
      IF ( irenuc &lt; 2 ) THEN <font color=#447700>!{<a name='8159'></font>
<a name='8160'>
        IF ( kzend == nzend ) THEN<a name='8161'>
          t0p3 = t0(igs(mgs),jgs,Min(kze,kgs(mgs)+3))<a name='8162'>
          t0p1 = t0(igs(mgs),jgs,Min(kze,kgs(mgs)+1))<a name='8163'>
        ELSE<a name='8164'>
          t0p3 = t0(igs(mgs),jgs,kgs(mgs)+3)<a name='8165'>
          t0p1 = t0(igs(mgs),jgs,kgs(mgs)+1)<a name='8166'>
        ENDIF<a name='8167'>
<a name='8168'>
      IF ( ( ssf(mgs) .gt. ssmax(mgs) .or.  irenuc .eq. 1 ) &amp;<a name='8169'>
     &amp;   .and.  ( ( lccn .lt. 1 .and.  &amp;<a name='8170'>
     &amp;            cx(mgs,lc) .lt. cwccn*(Min(1.0,rho0(mgs)))) .or. &amp;<a name='8171'>
     &amp;    ( lccn .gt. 1 .and. ccnc(mgs) .gt. 0. )   ) &amp;<a name='8172'>
     &amp;    ) THEN<a name='8173'>
      IF( kzbeg-1+kgs(mgs) .GT. 1 .AND. kzbeg-1+kgs(mgs) .LT. nzend-1 &amp;<a name='8174'>
     &amp;  .and. ssf(mgs) .gt. 0.0 &amp;<a name='8175'>
     &amp;  .and. ssfkp1(mgs) .LT. SUPMX .and. ssfkp1(mgs) .ge. 0.0  &amp;<a name='8176'>
     &amp;  .AND. ssfkm1(mgs) .LT. SUPMX .AND. ssfkm1(mgs) .ge. 0.0  &amp;<a name='8177'>
     &amp;  .AND. ssfkp1(mgs) .gt. ssfkm1(mgs)  &amp;<a name='8178'>
     &amp;  .and. t0p3 .gt. 233.2) THEN<a name='8179'>
          DSSDZ = (ssfkp1(mgs) - ssfkm1(mgs))*R2DZM<a name='8180'>
<font color=#447700>!<a name='8181'></font>
<font color=#447700>! otherwise check for cloud base condition with updraft:<a name='8182'></font>
<font color=#447700>!<a name='8183'></font>
        ELSEIF( kzbeg-1+kgs(mgs) .GT. 1 .AND. kzbeg-1+kgs(mgs) .LT. nzend-1 &amp;<a name='8184'>
<font color=#447700>!        IF( kgs(mgs) .GT. 1 .AND. kgs(mgs) .LT. NZ-1 &amp; !)<a name='8185'></font>
     &amp;  .and. ssf(mgs) .gt. 0.0  .and. wvel(mgs) .gt. 0.0 &amp;<a name='8186'>
     &amp;  .and. ssfkp1(mgs) .gt. 0.0   &amp;<a name='8187'>
     &amp;  .AND. ssfkm1(mgs) .le. 0.0 .and. wvelkm1(mgs) .gt. 0.0 &amp;<a name='8188'>
     &amp;  .AND. ssf(mgs) .gt. ssfkm1(mgs)  &amp;<a name='8189'>
     &amp;  .and. t0p1 .gt. 233.2) THEN<a name='8190'>
         DSSDZ = 2.*(ssf(mgs) - ssfkm1(mgs))*R2DZM  <font color=#447700>! 1-sided difference<a name='8191'></font>
        ENDIF<a name='8192'>
<a name='8193'>
       ENDIF<a name='8194'>
<font color=#447700>!<a name='8195'></font>
<font color=#447700>!CLZ  IF(wijk.LE.0.) CN=CCN*ssfilt(ix,jy,kz)**CCK<a name='8196'></font>
<font color=#447700>! note: CCN -&gt; cwccn, DELT -&gt; dtp<a name='8197'></font>
      c1 = Max(0.0, rho0(mgs)*(qx(mgs,lv) - qss(mgs))/ &amp;<a name='8198'>
     &amp;        (xdn(mgs,lc)*(4.*pi/3.)*(4.e-6)**3))<a name='8199'>
      IF ( lccn .lt. 1 ) THEN<a name='8200'>
       CN(mgs) = cwccn*rho0(mgs)/rho00*CCK*ssf(mgs)**CCKM*dtp*   &amp;<a name='8201'>
     &amp; Max(0.0,    &amp;<a name='8202'>
     &amp;         (wvel(mgs)*DSSDZ) )      <font color=#447700>! probably the vertical gradient dominates<a name='8203'></font>
      ELSE<a name='8204'>
      CN(mgs) =  &amp;<a name='8205'>
     &amp;    Min(ccnc(mgs), cnuc(mgs)*CCK*ssf(mgs)**CCKM*dtp*   &amp;<a name='8206'>
     &amp; Max(0.0,    &amp;<a name='8207'>
     &amp;         ( wvel(mgs)*DSSDZ) )  )<a name='8208'>
<font color=#447700>!      IF ( cn(mgs) .gt. 0 ) ccnc(mgs) = ccnc(mgs) - cn(mgs)<a name='8209'></font>
      ENDIF<a name='8210'>
<a name='8211'>
      IF ( cn(mgs) .gt. 0.0 ) THEN<a name='8212'>
       IF ( ccnc(mgs) .lt. 5.e7 .and. cn(mgs) .ge. 5.e7 ) THEN<a name='8213'>
          cn(mgs) = 5.e7<a name='8214'>
          ccnc(mgs) = 0.0<a name='8215'>
       ELSEIF ( cn(mgs) .gt. ccnc(mgs) ) THEN<a name='8216'>
         cn(mgs) = ccnc(mgs)<a name='8217'>
         ccnc(mgs) = 0.0<a name='8218'>
       ENDIF<a name='8219'>
      cx(mgs,lc) = cx(mgs,lc) + cn(mgs)<a name='8220'>
      ccnc(mgs) = Max(0.0, ccnc(mgs) - cn(mgs))<a name='8221'>
      ENDIF<a name='8222'>
<a name='8223'>
      ELSEIF ( irenuc == 2 ) THEN <font color=#447700>!} { <a name='8224'></font>
      <font color=#447700>! simple Twomey scheme<a name='8225'></font>
<font color=#447700>!      if (ndebug .gt. 0) write(0,*) 'ICEZVD_DR:  Cloud reNucleation, wvel = ',wvel(mgs)<a name='8226'></font>
       CN(mgs) =   CCNE0*cnuc(mgs)**(2./(2.+cck))*Max(0.0,wvel(mgs))**cnexp <font color=#447700>! *Min(1.0,1./dtp) ! 0.3465<a name='8227'></font>
<font color=#447700>!      ccne = ccnefac*1.e6*(1.e-6*Abs(cwccn))**(2./(2.+cck))<a name='8228'></font>
<font color=#447700>!!!       CN(mgs) = Max( 0.0, CN(mgs) - ccna(mgs) ) ! this was from<a name='8229'></font>
               <font color=#447700>! Philips, Donner et al. 2007, but results in too much limitation of<a name='8230'></font>
               <font color=#447700>! nucleation<a name='8231'></font>
       CN(mgs) = Min(cn(mgs), ccnc(mgs))<a name='8232'>
       cn(mgs) = Min(cn(mgs), 0.5*dqc/cwmasn) <font color=#447700>! limit the nucleation mass to half of the condensation mass<a name='8233'></font>
       <a name='8234'>
       cx(mgs,lc) = cx(mgs,lc) + cn(mgs)<a name='8235'>
       <a name='8236'>
       ccnc(mgs) = Max(0.0, ccnc(mgs) - cn(mgs))<a name='8237'>
<a name='8238'>
      ELSEIF ( irenuc == 7 ) THEN <font color=#447700>!} { <a name='8239'></font>
<a name='8240'>
      <font color=#447700>! simple Twomey scheme but limit activation to try to do most activation near cloud base, but keep some CCN available for renuclation<a name='8241'></font>
<font color=#447700>!      if (ndebug .gt. 0) write(0,*) 'ICEZVD_DR:  Cloud reNucleation, wvel = ',wvel(mgs)<a name='8242'></font>
       cn(mgs) = 0.0<a name='8243'>
<font color=#447700>!       IF ( ccna(mgs) &lt; 0.7*cnuc(mgs) .and. ccnc(mgs) &gt; 0.69*cnuc(mgs) - ccna(mgs)) THEN ! here, assume we are near cloud base and use Twomey formulation<a name='8244'></font>
       IF ( ccna(mgs) &lt; 0.9*cnuc(mgs) ) THEN <font color=#447700>! { here, assume we are near cloud base and use Twomey formulation<a name='8245'></font>
         CN(mgs) =  Min( 0.91*cnuc(mgs), CCNE0*cnuc(mgs)**(2./(2.+cck))*Max(0.0,wvel(mgs))**cnexp )<font color=#447700>! *Min(1.0,1./dtp) ! 0.3465<a name='8246'></font>
<font color=#447700>!         IF ( cn(mgs) + ccna(mgs) &gt; 0.71*cnuc ) THEN<a name='8247'></font>
         <font color=#447700>! prevent this branch from activating more than 70% of CCN<a name='8248'></font>
           CN(mgs) = Min( CN(mgs), Max(0.0, (0.9*cnuc(mgs) - ccna(mgs) )) )<a name='8249'>
<font color=#447700>!           CN(mgs) = Min( CN(mgs), Max(0.0, 0.71*ccnc(mgs) - ccna(mgs) ) )<a name='8250'></font>
           <a name='8251'>
       ELSE <font color=#447700>! }{<a name='8252'></font>
        <font color=#447700>! if a large fraction of CCN have been activated, then assume we are in the cloud interior and use local SSw as in Phillips et al. 2007.<a name='8253'></font>
<a name='8254'>
         temp1 = (theta0(mgs)+thetap(mgs))*pk(mgs) <font color=#447700>! t77(ix,jy,kz)<a name='8255'></font>
<font color=#447700>!          t0(ix,jy,kz) = temp1<a name='8256'></font>
          ltemq = Int( (temp1-163.15)/fqsat+1.5 )<a name='8257'>
         ltemq = Min( nqsat, Max(1,ltemq) )<a name='8258'>
<a name='8259'>
        <font color=#447700>!  c1 = t00(igs(mgs),jy,kgs(mgs))*tabqvs(ltemq)<a name='8260'></font>
          c1= pqs(mgs)*tabqvs(ltemq)<a name='8261'>
<a name='8262'>
          ssf(mgs) = 0.0<a name='8263'>
          IF ( c1 &gt; 0. ) THEN<a name='8264'>
            ssf(mgs) = 100.*(qx(mgs,lv)/c1 - 1.0)  <font color=#447700>! from "new" values<a name='8265'></font>
          ENDIF<a name='8266'>
<a name='8267'>
<font color=#447700>!          IF ( ssf(mgs) &lt;= 1.0 .or. cnuc(mgs) &gt; ccna(mgs) ) THEN<a name='8268'></font>
          IF ( ssf(mgs) &lt;= 1.0 ) THEN<a name='8269'>
          CN(mgs) =   cnuc(mgs)*Min(1.0, Max(0.0,ssf(mgs))**cck ) <font color=#447700>! <a name='8270'></font>
          ELSE<a name='8271'>
          CN(mgs) =   cnuc(mgs)*Min(2.0, Max(0.0,0.03*(ssf(mgs)-1.0)+1.)**cck ) <font color=#447700>!           <a name='8272'></font>
<font color=#447700>!          write(0,*) 'iren7: ssf,ssmx = ',ssf(mgs),ssmax(mgs),cn(mgs),ccna(mgs),cnuc(mgs)<a name='8273'></font>
<font color=#447700>!          write(0,*) 'c1,qv = ',c1,qx(mgs,lv),temp1,ltemq<a name='8274'></font>
          ENDIF<a name='8275'>
          <a name='8276'>
<a name='8277'>
<font color=#447700>!        CN(mgs) = Min( Min(0.1,ssf(mgs)-1.)*cnuc(mgs), Max( 0.0, CN(mgs) - ccna(mgs) ) ) ! this was from<a name='8278'></font>
<font color=#447700>!        CN(mgs) = Min( Min(0.5*cx(mgs,lc), Min(0.1,ssf(mgs)/100.)*cnuc(mgs)), Max( 0.0, CN(mgs) - ccna(mgs) ) ) ! this was from<a name='8279'></font>
        CN(mgs) = Min(0.01*cnuc(mgs), Max( 0.0, CN(mgs) - ccna(mgs) ) ) <font color=#447700>! this was from<a name='8280'></font>
<a name='8281'>
       ENDIF <font color=#447700>! }<a name='8282'></font>
<font color=#447700>!      ccne = ccnefac*1.e6*(1.e-6*Abs(cwccn))**(2./(2.+cck))<a name='8283'></font>
<font color=#447700>!!!       CN(mgs) = Max( 0.0, CN(mgs) - ccna(mgs) ) ! this was from<a name='8284'></font>
               <font color=#447700>! Philips, Donner et al. 2007, but results in too much limitation of<a name='8285'></font>
               <font color=#447700>! nucleation<a name='8286'></font>
<font color=#447700>!       CN(mgs) = Min(cn(mgs), ccnc(mgs))<a name='8287'></font>
<font color=#447700>!       cn(mgs) = Min(cn(mgs), 0.5*dqc/cwmasn) ! limit the nucleation mass to half of the condensation mass<a name='8288'></font>
       <a name='8289'>
       IF ( cn(mgs) &gt; 0.0 ) THEN<a name='8290'>
       cx(mgs,lc) = cx(mgs,lc) + cn(mgs)<a name='8291'>
       <a name='8292'>
       <font color=#447700>! create some small droplets at minimum size (CP 2000), although it adds very little liquid<a name='8293'></font>
       <a name='8294'>
       dcrit = 2.0*2.5e-7<a name='8295'>
       <a name='8296'>
       dcloud = 1000.*dcrit**3*Pi/6.*cn(mgs)<a name='8297'>
        qx(mgs,lc) = qx(mgs,lc) + DCLOUD<a name='8298'>
        thetap(mgs) = thetap(mgs) + felvcp(mgs)*DCLOUD/(pi0(mgs))<a name='8299'>
        qwvp(mgs) = qwvp(mgs) - DCLOUD<a name='8300'>
  <font color=#447700>!      ccnc(mgs) = Max(0.0, ccnc(mgs) - cn(mgs))<a name='8301'></font>
        ENDIF<a name='8302'>
<a name='8303'>
      ELSEIF ( irenuc == 8 ) THEN <font color=#447700>!} { <a name='8304'></font>
      <font color=#447700>! simple Twomey scheme<a name='8305'></font>
<font color=#447700>!      if (ndebug .gt. 0) write(0,*) 'ICEZVD_DR:  Cloud reNucleation, wvel = ',wvel(mgs)<a name='8306'></font>
       <a name='8307'>
       cn(mgs) = 0.0<a name='8308'>
       <a name='8309'>
       IF ( ccnc(mgs) &gt; 0. ) THEN<a name='8310'>
       CN(mgs) =   CCNE0*ccnc(mgs)**(2./(2.+cck))*Max(0.0,wvel(mgs))**cnexp <font color=#447700>! *Min(1.0,1./dtp) ! 0.3465<a name='8311'></font>
<font color=#447700>!      ccne = ccnefac*1.e6*(1.e-6*Abs(cwccn))**(2./(2.+cck))<a name='8312'></font>
<font color=#447700>!!!       CN(mgs) = Max( 0.0, CN(mgs) - ccna(mgs) ) ! this was from<a name='8313'></font>
               <font color=#447700>! Philips, Donner et al. 2007, but results in too much limitation of<a name='8314'></font>
               <font color=#447700>! nucleation<a name='8315'></font>
       CN(mgs) = Min(cn(mgs), ccnc(mgs))<a name='8316'>
       <a name='8317'>
       ELSEIF ( cx(mgs,lc) &lt; 0.01e9 ) THEN<a name='8318'>
<a name='8319'>
        <font color=#447700>! if a large fraction of CCN have been activated, then assume we are in the cloud interior and use local SSw as in Phillips et al. 2007.<a name='8320'></font>
<a name='8321'>
         temp1 = (theta0(mgs)+thetap(mgs))*pk(mgs) <font color=#447700>! t77(ix,jy,kz)<a name='8322'></font>
<font color=#447700>!          t0(ix,jy,kz) = temp1<a name='8323'></font>
          ltemq = Int( (temp1-163.15)/fqsat+1.5 )<a name='8324'>
         ltemq = Min( nqsat, Max(1,ltemq) )<a name='8325'>
<a name='8326'>
        <font color=#447700>!  c1 = t00(igs(mgs),jy,kgs(mgs))*tabqvs(ltemq)<a name='8327'></font>
          c1= pqs(mgs)*tabqvs(ltemq)<a name='8328'>
<a name='8329'>
          ssf(mgs) = 0.0<a name='8330'>
          IF ( c1 &gt; 0. ) THEN<a name='8331'>
            ssf(mgs) = 100.*(qx(mgs,lv)/c1 - 1.0)  <font color=#447700>! from "new" values<a name='8332'></font>
          ENDIF<a name='8333'>
<a name='8334'>
<font color=#447700>!          IF ( ssf(mgs) &lt;= 1.0 .or. cnuc(mgs) &gt; ccna(mgs) ) THEN<a name='8335'></font>
          IF ( ssf(mgs) &lt;= 1.0 ) THEN<a name='8336'>
          CN(mgs) = 0.0<a name='8337'>
          ELSE<a name='8338'>
<font color=#447700>!          CN(mgs) = 0.01e9*rho0(mgs)/rho00*Min(2.0, Max(0.0,0.03*(ssf(mgs)-1.0)+1.)**cck ) - cx(mgs,lc)<a name='8339'></font>
           CN(mgs) = 0.01e9*Min(2.0, Max(0.0,0.03*(ssf(mgs)-1.0)+1.)**cck ) - cx(mgs,lc)<a name='8340'>
          ENDIF<a name='8341'>
       <a name='8342'>
       ENDIF<a name='8343'>
<a name='8344'>
       IF ( cn(mgs) &gt; 0.0 ) THEN<a name='8345'>
       cx(mgs,lc) = cx(mgs,lc) + cn(mgs)<a name='8346'>
       <a name='8347'>
       ccnc(mgs) = Max(0.0, ccnc(mgs) - cn(mgs))<a name='8348'>
       <a name='8349'>
       <font color=#447700>! create some small droplets at minimum size (CP 2000), although it adds very little liquid<a name='8350'></font>
       <a name='8351'>
       dcrit = 2.0*2.5e-7<a name='8352'>
       <a name='8353'>
       dcloud = 1000.*dcrit**3*Pi/6.*cn(mgs)<a name='8354'>
        qx(mgs,lc) = qx(mgs,lc) + DCLOUD<a name='8355'>
        thetap(mgs) = thetap(mgs) + felvcp(mgs)*DCLOUD/(pi0(mgs))<a name='8356'>
        qwvp(mgs) = qwvp(mgs) - DCLOUD<a name='8357'>
  <font color=#447700>!      ccnc(mgs) = Max(0.0, ccnc(mgs) - cn(mgs))<a name='8358'></font>
        ENDIF<a name='8359'>
       <a name='8360'>
<a name='8361'>
<a name='8362'>
      ENDIF <font color=#447700>! }<a name='8363'></font>
<a name='8364'>
      ccna(mgs) = ccna(mgs) + cn(mgs)<a name='8365'>
<a name='8366'>
<a name='8367'>
<a name='8368'>
      ENDIF <font color=#447700>! irenuc &gt;= 0 .and. .not. flag_qndrop<a name='8369'></font>
<a name='8370'>
      IF( cx(mgs,lc) .GT. 0. .AND. qx(mgs,lc) .LE. qxmin(lc)) cx(mgs,lc)=0.<a name='8371'>
      GO TO 631<a name='8372'>
<font color=#447700>!.... NUCLEATION ON CLOUD INFLOW BOUNDARY POINT<a name='8373'></font>
<a name='8374'>
  613 CONTINUE<a name='8375'>
<a name='8376'>
  631  CONTINUE<a name='8377'>
<a name='8378'>
<font color=#447700>!<a name='8379'></font>
<font color=#447700>! Check for supersaturation greater than ssmx and adjust down<a name='8380'></font>
<font color=#447700>!<a name='8381'></font>
       ssmx = 1.9<a name='8382'>
       qv1 = qv0(mgs) + qwvp(mgs)<a name='8383'>
       qvs1 = qvs(mgs)<a name='8384'>
       <a name='8385'>
<font color=#447700>!       IF ( flag_qndrop .and. do_satadj_for_wrfchem ) ssmx = 1.04 ! set lower threshold for progn=1 when using WRF-CHEM<a name='8386'></font>
<a name='8387'>
       IF ( qv1 .gt. (ssmx*qvs1) ) THEN<a name='8388'>
<font color=#447700>! use line below to disable saturation adjustment when flag_qndrop is true<a name='8389'></font>
<font color=#447700>!       IF ( qv1 .gt. (ssmx*qvs1) .and. .not. flag_qndrop ) THEN<a name='8390'></font>
        <a name='8391'>
         ss1 = qv1/qvs1<a name='8392'>
<a name='8393'>
        ssmx = 100.*(ssmx - 1.0)<a name='8394'>
        <a name='8395'>
        qvex = 0.0<a name='8396'>
<a name='8397'>
        CALL <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#QVEXCESS'>QVEXCESS</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NUCOND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QVEXCESS_2">(ngs,mgs,qwvp,qv0,qx(1,lc),pres,thetap,theta0,qvex,   &amp;<a name='8398'>
     &amp;    pi0,tabqvs,nqsat,fqsat,cbw,fcqv1,felvcp,ssmx,pk,ngscnt)<a name='8399'>
<a name='8400'>
<a name='8401'>
<a name='8402'>
        IF ( qvex .gt. 0.0 ) THEN<a name='8403'>
        thetap(mgs) = thetap(mgs) + felvcp(mgs)*qvex/(pi0(mgs))<a name='8404'>
        IF ( io_flag .and. nxtra &gt; 1 ) THEN<a name='8405'>
           axtra(igs(mgs),jy,kgs(mgs),1) = axtra(igs(mgs),jy,kgs(mgs),1) + qvex/dtp<a name='8406'>
        ENDIF<a name='8407'>
        qwvp(mgs) = qwvp(mgs) - qvex<a name='8408'>
        qx(mgs,lc) = qx(mgs,lc) + qvex<a name='8409'>
        IF ( .not. flag_qndrop) THEN<a name='8410'>
        cn(mgs) = Min( Max(ccnc(mgs),cwnccn(mgs)), rho0(mgs)*qvex/Max( cwmasn5, xmas(mgs,lc) )  )<a name='8411'>
        ccnc(mgs) = Max( 0.0, ccnc(mgs) - cn(mgs) )<a name='8412'>
        cx(mgs,lc) = cx(mgs,lc) + cn(mgs)<a name='8413'>
        ENDIF<a name='8414'>
        <a name='8415'>
<font color=#447700>!        write(iunit,*) 'theta = ',theta0(mgs) + thetap(mgs)<a name='8416'></font>
<a name='8417'>
<font color=#447700>!        temg(mgs) = theta(mgs)*( pres(mgs) / poo ) ** cap<a name='8418'></font>
<a name='8419'>
        ENDIF<a name='8420'>
<a name='8421'>
       <a name='8422'>
       ENDIF<a name='8423'>
<a name='8424'>
<font color=#447700>!<a name='8425'></font>
<font color=#447700>! Calculate droplet volume and check if it is within bounds.<a name='8426'></font>
<font color=#447700>!  Adjust if necessary<a name='8427'></font>
<font color=#447700>!  <a name='8428'></font>
<font color=#447700>!      if (ndebug .gt. 0) write(0,*) "ICEZVD_DR: check droplet volume" <a name='8429'></font>
<a name='8430'>
<a name='8431'>
<font color=#447700>!      cx(mgs,lc) = Min( cwnccn(mgs), cx(mgs,lc) )<a name='8432'></font>
      IF( cx(mgs,lc) &gt; cxmin .AND. qx(mgs,lc) .GT. qxmin(lc)) THEN<a name='8433'>
<font color=#447700>!        SVC(mgs) = rho0(mgs)*qx(mgs,lc)/(cx(mgs,lc)*xdn(mgs,lc))<a name='8434'></font>
        xmas(mgs,lc) = rho0(mgs)*qx(mgs,lc)/(cx(mgs,lc))<a name='8435'>
        <a name='8436'>
       IF (  xmas(mgs,lc) &lt; cwmasn .or.  xmas(mgs,lc) &gt; cwmasx ) THEN<a name='8437'>
        xmas(mgs,lc) = Min( xmas(mgs,lc), cwmasx )<a name='8438'>
        xmas(mgs,lc) = Max( xmas(mgs,lc), cwmasn )<a name='8439'>
        cx(mgs,lc) = rho0(mgs)*qx(mgs,lc)/xmas(mgs,lc)<a name='8440'>
       ENDIF<a name='8441'>
      ENDIF<a name='8442'>
<a name='8443'>
<a name='8444'>
<font color=#447700>!      IF( cx(mgs,lc) .GT. 10.e6 .AND. qx(mgs,lc) .GT. qxmin(lc) ) GO TO 681<a name='8445'></font>
<font color=#447700>!        ccwtmp = cx(mgs,lc)<a name='8446'></font>
<font color=#447700>!        cwmastmp = xmas(mgs,lc)<a name='8447'></font>
<font color=#447700>!       xmas(mgs,lc) = Max(xmas(mgs,lc), cwmasn)<a name='8448'></font>
<font color=#447700>!       IF (qx(mgs,lc) .GT. qxmin(lc) .AND. cx(mgs,lc) .le. 0.) THEN<a name='8449'></font>
<font color=#447700>!          cx(mgs,lc) = Min(0.5*cwccn,rho0(mgs)*qx(mgs,lc)/xmas(mgs,lc))<a name='8450'></font>
<font color=#447700>!          xmas(mgs,lc) = rho0(mgs)*qx(mgs,lc)/cx(mgs,lc)<a name='8451'></font>
<font color=#447700>!       ENDIF<a name='8452'></font>
<font color=#447700>!      IF (cx(mgs,lc) .GT. 0. .AND. qx(mgs,lc) .GT. qxmin(lc))    &amp;<a name='8453'></font>
<font color=#447700>!     &amp;        xmas(mgs,lc) = rho0(mgs)*qx(mgs,lc)/cx(mgs,lc)<a name='8454'></font>
<font color=#447700>!      IF (qx(mgs,lc) .GT. qxmin(lc) .AND. xmas(mgs,lc) .LT. cwmasn)    &amp;<a name='8455'></font>
<font color=#447700>!     &amp;          xmas(mgs,lc) = cwmasn<a name='8456'></font>
<font color=#447700>!      IF (qx(mgs,lc) .GT. qxmin(lc) .AND. xmas(mgs,lc) .GT. cwmasx)    &amp;<a name='8457'></font>
<font color=#447700>!     &amp;    xmas(mgs,lc) = cwmasx<a name='8458'></font>
<font color=#447700>!      IF ( qx(mgs,lc) .gt. qxmin(lc) ) THEN<a name='8459'></font>
<font color=#447700>!        cx(mgs,lc) = rho0(mgs)*qx(mgs,lc)/Max(cwmasn,xmas(mgs,lc))<a name='8460'></font>
<font color=#447700>!      ENDIF<a name='8461'></font>
<font color=#447700>!        <a name='8462'></font>
<font color=#447700>!<a name='8463'></font>
<font color=#447700>! 681  CONTINUE<a name='8464'></font>
<a name='8465'>
        <a name='8466'>
      IF ( ipconc .ge. 3 .and. rcond == 2 ) THEN<a name='8467'>
<a name='8468'>
        <a name='8469'>
        IF (cx(mgs,lr) .GT. 0. .AND. qx(mgs,lr) .GT. qxmin(lr))    &amp;<a name='8470'>
     &amp;       xv(mgs,lr)=rho0(mgs)*qx(mgs,lr)/(xdn(mgs,lr)*cx(mgs,lr))<a name='8471'>
        IF (xv(mgs,lr) .GT. xvmx(lr)) xv(mgs,lr) = xvmx(lr)<a name='8472'>
        IF (xv(mgs,lr) .LT. xvmn(lr)) xv(mgs,lr) = xvmn(lr)<a name='8473'>
<a name='8474'>
      ENDIF<a name='8475'>
<a name='8476'>
<a name='8477'>
<a name='8478'>
      ENDDO <font color=#447700>! mgs<a name='8479'></font>
<a name='8480'>
<a name='8481'>
<font color=#447700>! ################################################################<a name='8482'></font>
      DO mgs=1,ngscnt<a name='8483'>
      IF ( ssf(mgs) .gt. ssmax(mgs)    &amp;<a name='8484'>
     &amp;  .and. ( idecss .eq. 0 .or. qx(mgs,lc) .gt. qxmin(lc)) ) THEN<a name='8485'>
        ssmax(mgs) = ssf(mgs)<a name='8486'>
      ENDIF<a name='8487'>
      ENDDO<a name='8488'>
<font color=#447700>!<a name='8489'></font>
<a name='8490'>
      do mgs = 1,ngscnt<a name='8491'>
      an(igs(mgs),jy,kgs(mgs),lt) = theta0(mgs) + thetap(mgs)<a name='8492'>
      an(igs(mgs),jy,kgs(mgs),lv) =  qv0(mgs) + qwvp(mgs)<a name='8493'>
<font color=#447700>!      tmp3d(igs(mgs),jy,kgs(mgs)) = tmp3d(igs(mgs),jy,kgs(mgs)) + t9(igs(mgs),jy,kgs(mgs)) !  pi0(mgs) ! wvdf(mgs) ! ssf(mgs) ! cn(mgs)<a name='8494'></font>
<font color=#447700>!<a name='8495'></font>
      IF ( eqtset &gt; 2 ) THEN<a name='8496'>
        p2(igs(mgs),jy,kgs(mgs)) = pipert(mgs)<a name='8497'>
      ENDIF<a name='8498'>
<a name='8499'>
       if ( ido(lc) .eq. 1 )  then<a name='8500'>
        an(igs(mgs),jy,kgs(mgs),lc) = qx(mgs,lc) +    &amp;<a name='8501'>
     &amp;    min( an(igs(mgs),jy,kgs(mgs),lc), 0.0 )<a name='8502'>
<font color=#447700>!        qx(mgs,lc) = an(igs(mgs),jy,kgs(mgs),lc)<a name='8503'></font>
       end if<a name='8504'>
<font color=#447700>!<a name='8505'></font>
<a name='8506'>
       if ( ido(lr) .eq. 1 .and. rcond == 2 )  then<a name='8507'>
        an(igs(mgs),jy,kgs(mgs),lr) = qx(mgs,lr) +    &amp;<a name='8508'>
     &amp;    min( an(igs(mgs),jy,kgs(mgs),lr), 0.0 )<a name='8509'>
<font color=#447700>!        qx(mgs,lr) = an(igs(mgs),jy,kgs(mgs),lr)<a name='8510'></font>
       end if<a name='8511'>
<a name='8512'>
<a name='8513'>
<a name='8514'>
       IF (  ipconc .ge. 2 ) THEN<a name='8515'>
        an(igs(mgs),jy,kgs(mgs),lnc) = Max(cx(mgs,lc) , 0.0)<a name='8516'>
        IF ( lss &gt; 1 ) an(igs(mgs),jy,kgs(mgs),lss) = Max( 0.0, ssmax(mgs) )<a name='8517'>
        IF ( lccn .gt. 1 ) THEN<a name='8518'>
          an(igs(mgs),jy,kgs(mgs),lccn) = Max(0.0,  ccnc(mgs) )<a name='8519'>
        ENDIF<a name='8520'>
        IF ( lccna .gt. 1 ) THEN<a name='8521'>
          an(igs(mgs),jy,kgs(mgs),lccna) = Max(0.0, ccna(mgs) )<a name='8522'>
        ENDIF<a name='8523'>
       ENDIF<a name='8524'>
       IF (  ipconc .ge. 3 .and. rcond == 2 ) THEN<a name='8525'>
        an(igs(mgs),jy,kgs(mgs),lnr) = Max(cx(mgs,lr) , 0.0)<a name='8526'>
       ENDIF<a name='8527'>
      end do<a name='8528'>
<a name='8529'>
<a name='8530'>
29998 continue<a name='8531'>
<a name='8532'>
<a name='8533'>
      if ( kz .gt. nz-1 .and. ix .ge. nxi) then<a name='8534'>
        if ( ix .ge. nxi ) then<a name='8535'>
         go to 2200 <font color=#447700>! exit gather scatter<a name='8536'></font>
        else<a name='8537'>
         nzmpb = kz<a name='8538'>
        endif<a name='8539'>
      else<a name='8540'>
        nzmpb = kz<a name='8541'>
      end if<a name='8542'>
<a name='8543'>
      if ( ix .ge. nxi ) then<a name='8544'>
        nxmpb = 1<a name='8545'>
        nzmpb = kz+1<a name='8546'>
      else<a name='8547'>
       nxmpb = ix+1<a name='8548'>
      end if<a name='8549'>
<a name='8550'>
 2000 continue <font color=#447700>! inumgs<a name='8551'></font>
 2200 continue<a name='8552'>
<font color=#447700>!<a name='8553'></font>
<font color=#447700>!  end of gather scatter (for this jy slice)<a name='8554'></font>
<a name='8555'>
<a name='8556'>
<font color=#447700>!#ifdef COMMAS<a name='8557'></font>
<font color=#447700>!    GOTO 9999<a name='8558'></font>
<font color=#447700>!#endif<a name='8559'></font>
<a name='8560'>
<font color=#447700>! Redistribute inappreciable cloud particles and charge<a name='8561'></font>
<font color=#447700>!<a name='8562'></font>
<font color=#447700>! Redistribution everywhere in the domain...<a name='8563'></font>
<font color=#447700>!<a name='8564'></font>
      frac = 1.0 <font color=#447700>! 0.25 ! 1.0 ! 0.2<a name='8565'></font>
<font color=#447700>!<a name='8566'></font>
<font color=#447700>!  alternate test version for ipconc .ge. 3<a name='8567'></font>
<font color=#447700>!  just vaporize stuff to prevent noise in the number concentrations<a name='8568'></font>
<a name='8569'>
<a name='8570'>
      do kz = 1,nz<a name='8571'>
<font color=#447700>!      do jy = 1,1<a name='8572'></font>
      do ix = 1,nxi<a name='8573'>
      <a name='8574'>
      t0(ix,jy,kz) = an(ix,jy,kz,lt)*t77(ix,jy,kz)<a name='8575'>
      <a name='8576'>
      zerocx(:) = .false.<a name='8577'>
      DO il = lc,lhab<a name='8578'>
       IF ( iresetmoments == 1 .or. iresetmoments == il ) THEN<a name='8579'>
        IF ( ln(il) &gt; 1 ) zerocx(il) = ( an(ix,jy,kz,ln(il)) &lt; cxmin )<a name='8580'>
        IF ( lz(il) &gt; 1 ) zerocx(il) = ( zerocx(il) .or. an(ix,jy,kz,lz(il)) &lt; zxmin )<a name='8581'>
       ELSE<a name='8582'>
        IF ( il == lc ) THEN<a name='8583'>
          IF ( ln(il) &gt; 1 ) zerocx(il) = ( an(ix,jy,kz,ln(il)) &lt;= 0 ) .and. .not. flag_qndrop <font color=#447700>! don't reset if progn=1 (WRF-CHEM)<a name='8584'></font>
        ELSE<a name='8585'>
         IF ( ln(il) &gt; 1 ) zerocx(il) = ( an(ix,jy,kz,ln(il)) &lt;= 0 )<a name='8586'>
        ENDIF<a name='8587'>
       ENDIF<a name='8588'>
      ENDDO<a name='8589'>
<a name='8590'>
      IF ( lhl .gt. 1 ) THEN<a name='8591'>
      <a name='8592'>
      <a name='8593'>
      if ( an(ix,jy,kz,lhl) .lt. frac*qxmin(lhl) .or. zerocx(lhl) ) then<a name='8594'>
<a name='8595'>
<font color=#447700>!        IF ( an(ix,jy,kz,lhl) .gt. 0 ) THEN<a name='8596'></font>
          an(ix,jy,kz,lv) = an(ix,jy,kz,lv) + an(ix,jy,kz,lhl)<a name='8597'>
          an(ix,jy,kz,lhl) = 0.0<a name='8598'>
<font color=#447700>!        ENDIF<a name='8599'></font>
<a name='8600'>
        IF ( ipconc .ge. 5 ) THEN <font color=#447700>! .and. an(ix,jy,kz,lnh) .gt. 0.0 ) THEN<a name='8601'></font>
          an(ix,jy,kz,lnhl) = 0.0<a name='8602'>
        ENDIF<a name='8603'>
<a name='8604'>
        IF ( lvhl .gt. 1 ) THEN<a name='8605'>
           an(ix,jy,kz,lvhl) = 0.0<a name='8606'>
        ENDIF<a name='8607'>
<a name='8608'>
        IF ( lhlw .gt. 1 ) THEN<a name='8609'>
           an(ix,jy,kz,lhlw) = 0.0<a name='8610'>
        ENDIF<a name='8611'>
      <a name='8612'>
        IF ( lzhl .gt. 1 ) THEN<a name='8613'>
           an(ix,jy,kz,lzhl) = 0.0<a name='8614'>
        ENDIF<a name='8615'>
<a name='8616'>
      ELSE<a name='8617'>
       IF ( lvol(lhl) .gt. 1 ) THEN  <font color=#447700>! check density<a name='8618'></font>
        IF ( an(ix,jy,kz,lvhl) .gt. 0.0 ) THEN<a name='8619'>
         tmp = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/an(ix,jy,kz,lvhl)<a name='8620'>
        ELSE <font color=#447700>! in case volume is zero but mass is above threshold (should not happen, of course)<a name='8621'></font>
          tmp = rho_qhl<a name='8622'>
          an(ix,jy,kz,lvhl) = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/tmp<a name='8623'>
        ENDIF<a name='8624'>
<a name='8625'>
        IF (  tmp .lt. xdnmn(lhl) ) THEN<a name='8626'>
          tmp = Max( xdnmn(lhl), tmp )<a name='8627'>
          an(ix,jy,kz,lvhl) = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/tmp<a name='8628'>
        ENDIF<a name='8629'>
<a name='8630'>
        IF ( tmp .gt. xdnmx(lhl) .and. lhlw .le. 0 ) THEN <font color=#447700>! no liquid allowed on hail<a name='8631'></font>
          tmp = Min( xdnmx(lhl), tmp )<a name='8632'>
          an(ix,jy,kz,lvhl) = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/tmp<a name='8633'>
        ELSEIF ( tmp .gt. xdnmx(lhl) .and. lhlw .gt. 1 ) THEN  <font color=#447700>! allow for liquid on hail<a name='8634'></font>
          fw = an(ix,jy,kz,lhlw)/an(ix,jy,kz,lhl)<a name='8635'>
<font color=#447700>!          tmpmx = xdnmx(lhl) + fw*(xdnmx(lr) - xdnmx(lhl)) ! maximum possible average density<a name='8636'></font>
                                                           <font color=#447700>! it is not exactly linear, but approx. is close enough for this<a name='8637'></font>
<font color=#447700>!          tmpmx = 1./( (1. - fw)/900. + fw/1000. ) is exact max, where 900 is xdnmx<a name='8638'></font>
<a name='8639'>
          tmpmx = xdnmx(lhl)/( 1. - fw*(1. - xdnmx(lhl)/xdnmx(lr) )) <a name='8640'>
<a name='8641'>
          IF ( tmp .gt. tmpmx  ) THEN<a name='8642'>
            an(ix,jy,kz,lvhl) = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/tmpmx<a name='8643'>
          ENDIF<a name='8644'>
<a name='8645'>
<font color=#447700>!          IF ( tmp .gt. xdnmx(lhl) .and. an(ix,jy,kz,lhlw) .lt. qxmin(lhl) ) THEN<a name='8646'></font>
<font color=#447700>!            tmp = Min( xdnmx(lhl), tmp )<a name='8647'></font>
<font color=#447700>!            an(ix,jy,kz,lvhl) = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/tmp<a name='8648'></font>
<font color=#447700>!          ELSEIF ( tmp .gt. xdnmx(lr) ) THEN<a name='8649'></font>
<font color=#447700>!            tmp =  xdnmx(lr)<a name='8650'></font>
<font color=#447700>!            an(ix,jy,kz,lvhl) = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/tmp<a name='8651'></font>
<font color=#447700>!          ENDIF<a name='8652'></font>
        ENDIF<a name='8653'>
<a name='8654'>
        IF ( lhlw .gt. 1 ) THEN <font color=#447700>! check if basically pure water<a name='8655'></font>
          IF ( an(ix,jy,kz,lhlw) .gt. 0.98*an(ix,jy,kz,lhl) ) THEN<a name='8656'>
           tmp = xdnmx(lr)<a name='8657'>
           an(ix,jy,kz,lvhl) = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/tmp<a name='8658'>
          ENDIF<a name='8659'>
        ENDIF<a name='8660'>
        <a name='8661'>
       ENDIF<a name='8662'>
       <a name='8663'>
       <a name='8664'>
<font color=#447700>!  CHECK INTERCEPT<a name='8665'></font>
       IF ( ipconc == 5 .and.  an(ix,jy,kz,lhl) .gt. qxmin(lhl) .and.  alphahl .le. 0.1 .and. lnhl .gt. 1 .and. lzhl == 0 ) THEN<a name='8666'>
       <a name='8667'>
         IF ( lvhl .gt. 1 ) THEN<a name='8668'>
           hwdn = dn(ix,jy,kz)*an(ix,jy,kz,lhl)/an(ix,jy,kz,lvhl)<a name='8669'>
         ELSE<a name='8670'>
           hwdn = xdn0(lhl)<a name='8671'>
         ENDIF<a name='8672'>
           tmp = (hwdn*an(ix,jy,kz,lnhl))/(dn(ix,jy,kz)*an(ix,jy,kz,lhl))<a name='8673'>
           tmpg = an(ix,jy,kz,lnhl)*(tmp*(3.14159))**(1./3.)<a name='8674'>
           IF ( tmpg .lt. cnohlmn ) THEN<a name='8675'>
             tmp = ( (hwdn)/(dn(ix,jy,kz)*an(ix,jy,kz,lhl))*(3.14159))**(1./3.)<a name='8676'>
              an(ix,jy,kz,lnhl) = (cnohlmn/tmp)**(3./4.)<a name='8677'>
           ENDIF<a name='8678'>
       <a name='8679'>
       ENDIF<a name='8680'>
<font color=#447700>!      ELSE  ! check mean size here?<a name='8681'></font>
<a name='8682'>
      end if<a name='8683'>
<a name='8684'>
<a name='8685'>
<a name='8686'>
      ENDIF <font color=#447700>!lhl<a name='8687'></font>
<a name='8688'>
<a name='8689'>
      if ( an(ix,jy,kz,lh) .lt. frac*qxmin(lh) .or. zerocx(lh) ) then<a name='8690'>
<a name='8691'>
<font color=#447700>!        IF ( an(ix,jy,kz,lh) .gt. 0 ) THEN<a name='8692'></font>
          an(ix,jy,kz,lv) = an(ix,jy,kz,lv) + an(ix,jy,kz,lh)<a name='8693'>
          an(ix,jy,kz,lh) = 0.0<a name='8694'>
<font color=#447700>!        ENDIF<a name='8695'></font>
<a name='8696'>
        IF ( ipconc .ge. 5 ) THEN <font color=#447700>! .and. an(ix,jy,kz,lnh) .gt. 0.0 ) THEN<a name='8697'></font>
          an(ix,jy,kz,lnh) = 0.0<a name='8698'>
        ENDIF<a name='8699'>
<a name='8700'>
        IF ( lvh .gt. 1 ) THEN<a name='8701'>
           an(ix,jy,kz,lvh) = 0.0<a name='8702'>
        ENDIF<a name='8703'>
      <a name='8704'>
        IF ( lhw .gt. 1 ) THEN<a name='8705'>
           an(ix,jy,kz,lhw) = 0.0<a name='8706'>
        ENDIF<a name='8707'>
      <a name='8708'>
        IF ( lzh .gt. 1 ) THEN<a name='8709'>
           an(ix,jy,kz,lzh) = 0.0<a name='8710'>
        ENDIF<a name='8711'>
<a name='8712'>
      ELSE<a name='8713'>
       IF ( lvol(lh) .gt. 1 ) THEN  <font color=#447700>! check density<a name='8714'></font>
        IF ( an(ix,jy,kz,lvh) .gt. 0.0 ) THEN<a name='8715'>
         tmp = dn(ix,jy,kz)*an(ix,jy,kz,lh)/an(ix,jy,kz,lvh)<a name='8716'>
        ELSE<a name='8717'>
         tmp = rho_qh<a name='8718'>
          an(ix,jy,kz,lvh) = dn(ix,jy,kz)*an(ix,jy,kz,lh)/tmp<a name='8719'>
        ENDIF<a name='8720'>
<a name='8721'>
        IF (  tmp .lt. xdnmn(lh) ) THEN<a name='8722'>
          tmp = Max( xdnmn(lh), tmp )<a name='8723'>
          an(ix,jy,kz,lvh) = dn(ix,jy,kz)*an(ix,jy,kz,lh)/tmp<a name='8724'>
        ENDIF<a name='8725'>
<a name='8726'>
        IF ( tmp .gt. xdnmx(lh) .and. lhw .le. 0 ) THEN <font color=#447700>! no liquid allowed on graupel<a name='8727'></font>
          tmp = Min( xdnmx(lh), tmp )<a name='8728'>
          an(ix,jy,kz,lvh) = dn(ix,jy,kz)*an(ix,jy,kz,lh)/tmp<a name='8729'>
        ELSEIF ( tmp .gt. xdnmx(lh) .and. lhw .gt. 1 ) THEN  <font color=#447700>! allow for liquid on graupel<a name='8730'></font>
          fw = an(ix,jy,kz,lhw)/an(ix,jy,kz,lh)<a name='8731'>
<font color=#447700>!          tmpmx = xdnmx(lh) + fw*(xdnmx(lr) - xdnmx(lh)) ! maximum possible average density<a name='8732'></font>
                                                           <font color=#447700>! it is not exactly linear, but approx. is close enough for this<a name='8733'></font>
<font color=#447700>!          tmpmx = 1./( (1. - fw)/900. + fw/1000. ) is exact max, where 900 is xdnmx<a name='8734'></font>
          tmpmx = xdnmx(lh)/( 1. - fw*(1. - xdnmx(lh)/xdnmx(lr) )) <a name='8735'>
<a name='8736'>
          IF ( tmp .gt. tmpmx  ) THEN<a name='8737'>
            an(ix,jy,kz,lvh) = dn(ix,jy,kz)*an(ix,jy,kz,lh)/tmpmx<a name='8738'>
          ENDIF<a name='8739'>
<a name='8740'>
<font color=#447700>!          IF ( tmp .gt. xdnmx(lh) .and. an(ix,jy,kz,lhw) .lt. qxmin(lh) ) THEN<a name='8741'></font>
<font color=#447700>!            tmp = Min( xdnmx(lh), tmp )<a name='8742'></font>
<font color=#447700>!            an(ix,jy,kz,lvh) = dn(ix,jy,kz)*an(ix,jy,kz,lh)/tmp<a name='8743'></font>
<font color=#447700>!          ELSEIF ( tmp .gt. xdnmx(lr) ) THEN<a name='8744'></font>
<font color=#447700>!            tmp =  xdnmx(lr)<a name='8745'></font>
<font color=#447700>!            an(ix,jy,kz,lvh) = dn(ix,jy,kz)*an(ix,jy,kz,lh)/tmp<a name='8746'></font>
<font color=#447700>!          ENDIF<a name='8747'></font>
<a name='8748'>
        ENDIF<a name='8749'>
<a name='8750'>
        IF ( lhw .gt. 1 ) THEN <font color=#447700>! check if basically pure water<a name='8751'></font>
          IF ( an(ix,jy,kz,lhw) .gt. 0.98*an(ix,jy,kz,lh) ) THEN<a name='8752'>
           tmp = xdnmx(lr)<a name='8753'>
           an(ix,jy,kz,lvh) = dn(ix,jy,kz)*an(ix,jy,kz,lh)/tmp<a name='8754'>
          ENDIF<a name='8755'>
        ENDIF<a name='8756'>
        <a name='8757'>
       ENDIF<a name='8758'>
<a name='8759'>
<font color=#447700>!  CHECK INTERCEPT<a name='8760'></font>
       IF ( ipconc == 5 .and.  an(ix,jy,kz,lh) .gt. qxmin(lh) .and.  alphah .le. 0.1 .and. lnh .gt. 1 .and. lzh == 0 ) THEN<a name='8761'>
       <a name='8762'>
         IF ( lvh .gt. 1 ) THEN<a name='8763'>
           IF ( an(ix,jy,kz,lvh) .gt. 0.0 ) THEN<a name='8764'>
             hwdn = dn(ix,jy,kz)*an(ix,jy,kz,lh)/an(ix,jy,kz,lvh)<a name='8765'>
           ELSE<a name='8766'>
             hwdn = xdn0(lh)<a name='8767'>
           ENDIF<a name='8768'>
           hwdn = Max( xdnmn(lh), hwdn )<a name='8769'>
         ELSE<a name='8770'>
           hwdn = xdn0(lh)<a name='8771'>
         ENDIF<a name='8772'>
           tmp = (hwdn*an(ix,jy,kz,lnh))/(dn(ix,jy,kz)*an(ix,jy,kz,lh))<a name='8773'>
           tmpg = an(ix,jy,kz,lnh)*(tmp*(3.14159))**(1./3.)<a name='8774'>
           IF ( tmpg .lt. cnohmn ) THEN<a name='8775'>
<font color=#447700>!           tmpg = an(ix,jy,kz,lnh)*( (hwdn*an(ix,jy,kz,lnh))/(dn(ix,jy,kz)*an(ix,jy,kz,lh))*(3.14159))**(1./3.)<a name='8776'></font>
<font color=#447700>!           tmpg = an(ix,jy,kz,lnh)**(4./3.)*( (hwdn)/(dn(ix,jy,kz)*an(ix,jy,kz,lh))*(3.14159))**(1./3.)<a name='8777'></font>
             tmp = ( (hwdn)/(dn(ix,jy,kz)*an(ix,jy,kz,lh))*(3.14159))**(1./3.)<a name='8778'>
              an(ix,jy,kz,lnh) = (cnohmn/tmp)**(3./4.)<a name='8779'>
           ENDIF<a name='8780'>
       <a name='8781'>
       ENDIF<a name='8782'>
        <a name='8783'>
      end if<a name='8784'>
<a name='8785'>
<a name='8786'>
      if ( an(ix,jy,kz,ls) .lt.  frac*qxmin(ls)  .or. zerocx(ls)  &amp; <font color=#447700>! .or.  an(ix,jy,kz,lns) .lt. 0.1 ! .and.<a name='8787'></font>
     &amp;         ) then<a name='8788'>
      IF ( t0(ix,jy,kz) .lt. 273.15 ) THEN<a name='8789'>
<font color=#447700>!        IF ( an(ix,jy,kz,ls) .gt. 0 ) THEN<a name='8790'></font>
          an(ix,jy,kz,lv) = an(ix,jy,kz,lv) + an(ix,jy,kz,ls)<a name='8791'>
          an(ix,jy,kz,ls) = 0.0<a name='8792'>
<font color=#447700>!        ENDIF<a name='8793'></font>
      <a name='8794'>
        IF ( ipconc .ge. 4 ) THEN <font color=#447700>! .and. an(ix,jy,kz,lns) .gt. 0.0  ) THEN ! <a name='8795'></font>
<font color=#447700>!          an(ix,jy,kz,lni) = an(ix,jy,kz,lni) + an(ix,jy,kz,lns)<a name='8796'></font>
          an(ix,jy,kz,lns) = 0.0<a name='8797'>
        ENDIF<a name='8798'>
        <a name='8799'>
        IF ( lvs .gt. 1 ) THEN<a name='8800'>
           an(ix,jy,kz,lvs) = 0.0<a name='8801'>
        ENDIF<a name='8802'>
<a name='8803'>
        IF ( lsw .gt. 1 ) THEN<a name='8804'>
           an(ix,jy,kz,lsw) = 0.0<a name='8805'>
        ENDIF<a name='8806'>
<a name='8807'>
      ELSE<a name='8808'>
<font color=#447700>!        IF ( an(ix,jy,kz,ls) .gt. 0 ) THEN<a name='8809'></font>
          an(ix,jy,kz,lv) = an(ix,jy,kz,lv) + an(ix,jy,kz,ls)<a name='8810'>
          an(ix,jy,kz,ls) = 0.0<a name='8811'>
<font color=#447700>!        ENDIF<a name='8812'></font>
<a name='8813'>
        IF ( lvs .gt. 1 ) THEN<a name='8814'>
           an(ix,jy,kz,lvs) = 0.0<a name='8815'>
        ENDIF<a name='8816'>
<a name='8817'>
        IF ( lsw .gt. 1 ) THEN<a name='8818'>
           an(ix,jy,kz,lsw) = 0.0<a name='8819'>
        ENDIF<a name='8820'>
<a name='8821'>
        IF ( ipconc .ge. 4 ) THEN <font color=#447700>! .and. an(ix,jy,kz,lns) .gt. 0.0  ) THEN ! <a name='8822'></font>
<font color=#447700>!          an(ix,jy,kz,lnr) = an(ix,jy,kz,lnr) + an(ix,jy,kz,lns)<a name='8823'></font>
          an(ix,jy,kz,lns) = 0.0<a name='8824'>
        ENDIF<a name='8825'>
<a name='8826'>
      ENDIF<a name='8827'>
      <a name='8828'>
<a name='8829'>
      ELSEIF ( lvol(ls) .gt. 1 ) THEN  <font color=#447700>! check density<a name='8830'></font>
        IF ( an(ix,jy,kz,lvs) .gt. 0.0 ) THEN<a name='8831'>
          tmp = dn(ix,jy,kz)*an(ix,jy,kz,ls)/an(ix,jy,kz,lvs)<a name='8832'>
          IF ( tmp .gt. xdnmx(ls) .or. tmp .lt. xdnmn(ls) ) THEN<a name='8833'>
            tmp = Min( xdnmx(ls), Max( xdnmn(ls), tmp ) )<a name='8834'>
            an(ix,jy,kz,lvs) = dn(ix,jy,kz)*an(ix,jy,kz,ls)/tmp<a name='8835'>
          ENDIF<a name='8836'>
        ELSE<a name='8837'>
          tmp = rho_qs<a name='8838'>
          an(ix,jy,kz,lvs) = dn(ix,jy,kz)*an(ix,jy,kz,ls)/tmp<a name='8839'>
        ENDIF<a name='8840'>
<a name='8841'>
<a name='8842'>
      end if<a name='8843'>
<a name='8844'>
<a name='8845'>
      if ( an(ix,jy,kz,lr) .lt. frac*qxmin(lr)  .or. zerocx(lr)  &amp;<a name='8846'>
     &amp;  ) then<a name='8847'>
        an(ix,jy,kz,lv) = an(ix,jy,kz,lv) + an(ix,jy,kz,lr)<a name='8848'>
        an(ix,jy,kz,lr) = 0.0<a name='8849'>
        IF ( ipconc .ge. 3 ) THEN<a name='8850'>
<font color=#447700>!          an(ix,jy,kz,lnc) = an(ix,jy,kz,lnc) + an(ix,jy,kz,lnr)<a name='8851'></font>
          an(ix,jy,kz,lnr) = 0.0<a name='8852'>
        ENDIF<a name='8853'>
        <a name='8854'>
      end if<a name='8855'>
<a name='8856'>
<font color=#447700>!<a name='8857'></font>
<font color=#447700>!  for qci<a name='8858'></font>
<font color=#447700>!<a name='8859'></font>
      IF ( an(ix,jy,kz,li) .le. frac*qxmin(li) .or. zerocx(li)   &amp; <font color=#447700>! .or.  an(ix,jy,kz,lni) .lt. 0.1<a name='8860'></font>
     &amp;    ) THEN<a name='8861'>
      an(ix,jy,kz,lv) = an(ix,jy,kz,lv) + an(ix,jy,kz,li)<a name='8862'>
      an(ix,jy,kz,li)= 0.0<a name='8863'>
       IF ( ipconc .ge. 1 ) THEN<a name='8864'>
         an(ix,jy,kz,lni) = 0.0<a name='8865'>
       ENDIF<a name='8866'>
      ENDIF<a name='8867'>
<a name='8868'>
<font color=#447700>!<a name='8869'></font>
<font color=#447700>!  for qis<a name='8870'></font>
<font color=#447700>!<a name='8871'></font>
      IF ( lis &gt; 1 ) THEN <font color=#447700>! {<a name='8872'></font>
      IF ( an(ix,jy,kz,lis) .le. frac*qxmin(lis) .or. zerocx(lis)   &amp; <font color=#447700>! .or.  an(ix,jy,kz,lni) .lt. 0.1<a name='8873'></font>
     &amp;    ) THEN <font color=#447700>! { {<a name='8874'></font>
      an(ix,jy,kz,lv) = an(ix,jy,kz,lv) + an(ix,jy,kz,lis)<a name='8875'>
      an(ix,jy,kz,lis)= 0.0<a name='8876'>
       IF ( ipconc .ge. 1 ) THEN<a name='8877'>
         an(ix,jy,kz,lnis) = 0.0<a name='8878'>
       ENDIF<a name='8879'>
      <a name='8880'>
      ELSEIF ( icespheres &gt;= 2 ) THEN <font color=#447700>! } {<a name='8881'></font>
       km1 = Max(1, kz-1)<a name='8882'>
       IF ( 0.5*( w(ix,jy,kz) + w(ix,jy,kz+1)) &lt; -1.0 .or.    &amp;<a name='8883'>
     &amp;      (icespheres == 3 .and. ( t0(ix,jy,kz) &lt; 232.15 .or. an(ix,jy,kz,lc) &lt; qxmin(lc) ) ) .or. &amp;<a name='8884'>
     &amp;      (icespheres == 5 .and. ( t0(ix,jy,kz) &lt; 232.15 .or. ( an(ix,jy,kz,lc) &lt; qxmin(lc) .and. an(ix,jy,km1,lc) &lt; qxmin(lc)  )) ) .or. &amp;<a name='8885'>
     &amp;      (icespheres == 4 .and. ( t0(ix,jy,kz) &lt; 235.15 )) ) THEN <font color=#447700>! transfer to regular ice crystals in downdraft or at low temp<a name='8886'></font>
         an(ix,jy,kz,li) = an(ix,jy,kz,li) + an(ix,jy,kz,lis)<a name='8887'>
         an(ix,jy,kz,lni) = an(ix,jy,kz,lni) + an(ix,jy,kz,lnis)<a name='8888'>
         an(ix,jy,kz,lis)= 0.0<a name='8889'>
         an(ix,jy,kz,lnis)= 0.0<a name='8890'>
         <a name='8891'>
       ENDIF<a name='8892'>
       <a name='8893'>
      ENDIF <font color=#447700>! } }<a name='8894'></font>
      ENDIF <font color=#447700>! }<a name='8895'></font>
<a name='8896'>
<font color=#447700>!<a name='8897'></font>
<font color=#447700>!  for qcw<a name='8898'></font>
<font color=#447700>!<a name='8899'></font>
<a name='8900'>
      IF ( an(ix,jy,kz,lc) .le. frac*qxmin(lc) .or. zerocx(lc)   &amp;<a name='8901'>
     &amp;       ) THEN<a name='8902'>
      an(ix,jy,kz,lv) = an(ix,jy,kz,lv) + an(ix,jy,kz,lc)<a name='8903'>
      an(ix,jy,kz,lc)= 0.0<a name='8904'>
       IF ( ipconc .ge. 2 ) THEN<a name='8905'>
        IF ( lccn .gt. 1 ) THEN<a name='8906'>
         an(ix,jy,kz,lccn) =     &amp;<a name='8907'>
     &amp;       an(ix,jy,kz,lccn) + Max(0.0,an(ix,jy,kz,lnc))<a name='8908'>
        ENDIF<a name='8909'>
         an(ix,jy,kz,lnc) = 0.0<a name='8910'>
         <a name='8911'>
         IF ( lccna &gt; 0  ) THEN <font color=#447700>! apply exponential decay to activated CCN to restore to environmental value<a name='8912'></font>
           tmp = an(ix,jy,kz,li) + an(ix,jy,kz,ls)  <a name='8913'>
           <a name='8914'>
           IF ( an(ix,jy,kz,lccna) &gt; 1. .and. tmp &lt; qxmin(li) ) an(ix,jy,kz,lccna) = an(ix,jy,kz,lccna)*Exp(-dtp/ccntimeconst)<a name='8915'>
<a name='8916'>
         ELSEIF ( lccn &gt; 1 .and. restoreccn ) THEN<a name='8917'>
           <font color=#447700>! in this case, we are treating the ccn field as ccna<a name='8918'></font>
           tmp = an(ix,jy,kz,li) + an(ix,jy,kz,ls)  <a name='8919'>
           <a name='8920'>
           IF ( an(ix,jy,kz,lccn) &gt; 1. .and. tmp &lt; qxmin(li) ) an(ix,jy,kz,lccn) =  &amp;<a name='8921'>
                    dn(ix,jy,kz)*qccn - Max(0.0 , dn(ix,jy,kz)*qccn - an(ix,jy,kz,lccn))*Exp(-dtp/ccntimeconst)<a name='8922'>
         <a name='8923'>
         ENDIF<a name='8924'>
<a name='8925'>
       ENDIF<a name='8926'>
<a name='8927'>
      ENDIF<a name='8928'>
<a name='8929'>
      end do<a name='8930'>
<font color=#447700>!      end do<a name='8931'></font>
      end do<a name='8932'>
      <a name='8933'>
      <a name='8934'>
      IF ( ndebug .ge. 1 ) write(6,*) 'END OF ICEZVD_DR'<a name='8935'>
<font color=#447700>!<a name='8936'></font>
<font color=#447700>!<a name='8937'></font>
   <a name='8938'>
   <a name='8939'>
   9999 RETURN<a name='8940'>
   <a name='8941'>
   END SUBROUTINE NUCOND<a name='8942'>
<a name='8943'>
<a name='8944'>
<font color=#447700>! #####################################################################<a name='8945'></font>
<font color=#447700>! #####################################################################<a name='8946'></font>
<a name='8947'>
<a name='8948'>
<a name='8949'>
<font color=#447700>!c--------------------------------------------------------------------------<a name='8950'></font>
<font color=#447700>!<a name='8951'></font>
<font color=#447700>!<a name='8952'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='8953'></font>
<font color=#447700>!<a name='8954'></font>
<a name='8955'>
<A NAME='NSSL_2MOM_GS'><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8956'>
      <font color=#993300>subroutine </font><font color=#cc0000>nssl_2mom_gs</font>   &amp; <A href='../../call_to/NSSL_2MOM_GS.html' TARGET='index'>1</A>,<A href='../../call_from/NSSL_2MOM_GS.html' TARGET='index'>12</A><a name='8957'>
     &amp;  (nx,ny,nz,na,jyslab  &amp;<a name='8958'>
     &amp;  ,nor,norz          &amp;<a name='8959'>
     &amp;  ,dtp,gz       &amp;<a name='8960'>
     &amp;  ,t0,t1,t2,t3,t4,t5,t6,t7,t8,t9      &amp;<a name='8961'>
     &amp;  ,an,dn,p2                  &amp;<a name='8962'>
     &amp;  ,pn,w,iunit                   &amp;<a name='8963'>
     &amp;  ,t00,t77,                             &amp;<a name='8964'>
     &amp;   ventr,ventc,c1sw,jgs,ido,    &amp;<a name='8965'>
     &amp;   xdnmx,xdnmn,               &amp;<a name='8966'>
<font color=#447700>!     &amp;   ln,ipc,lvol,lz,lliq,   &amp;<a name='8967'></font>
     &amp;   cdx,                              &amp;<a name='8968'>
     &amp;   xdn0,tmp3d,tkediss  &amp;<a name='8969'>
     &amp; ,timevtcalc,axtra,io_flag  &amp;<a name='8970'>
     &amp; ,rainprod2d, evapprod2d &amp;<a name='8971'>
     &amp; ,elec,its,ids,ide,jds,jde &amp;<a name='8972'>
     &amp; )<a name='8973'>
<a name='8974'>
<a name='8975'>
<font color=#447700>!<a name='8976'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='8977'></font>
<font color=#447700>!                                <a name='8978'></font>
<font color=#447700>!     Ziegler 1985 parameterized microphysics (also Zrnic et al. 1993)<a name='8979'></font>
<font color=#447700>!     1)  cloud water<a name='8980'></font>
<font color=#447700>!     2)  rain<a name='8981'></font>
<font color=#447700>!     3)  column ice <a name='8982'></font>
<font color=#447700>!     6)  snow<a name='8983'></font>
<font color=#447700>!     11) graupel/hail<a name='8984'></font>
<font color=#447700>!<a name='8985'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='8986'></font>
<font color=#447700>!<a name='8987'></font>
<font color=#447700>! Notes:<a name='8988'></font>
<font color=#447700>!<a name='8989'></font>
<font color=#447700>!  4/27/2009: allows for liquid water to be advected on snow and graupel particles using flag "mixedphase"<a name='8990'></font>
<font color=#447700>!<a name='8991'></font>
<font color=#447700>!  3/14/2007: (APS) added qproc temp to make microphysic process timeseries<a name='8992'></font>
<font color=#447700>!<a name='8993'></font>
<font color=#447700>!  10/17/2006: added flag (iehw) to select how to calculate ehw<a name='8994'></font>
<font color=#447700>!<a name='8995'></font>
<font color=#447700>!  10/5/2006: switched chacr to integrated version rather than assuming that average rain<a name='8996'></font>
<font color=#447700>!             drop mass does not change.  This acts to reduce rain size somewhat via graupel<a name='8997'></font>
<font color=#447700>!             collection.<a name='8998'></font>
<font color=#447700>!             Use Mason data for ehw, with scaling toward ehw=1 as air density decreases.<a name='8999'></font>
<font color=#447700>!<a name='9000'></font>
<font color=#447700>!  10/3/2006: Turned off Meyers nucleation for T &gt; -5 (can turn on with imeyers5 flag)<a name='9001'></font>
<font color=#447700>!             Turned off contact nucleation in updrafts<a name='9002'></font>
<font color=#447700>!<a name='9003'></font>
<font color=#447700>!  7/24/2006:  Turned on Meyers nucleation for -5 &lt; T &lt; 0<a name='9004'></font>
<font color=#447700>!<a name='9005'></font>
<font color=#447700>!  5/12/2006:  Converted qsacw/csacw and qsaci/csaci to Z93<a name='9006'></font>
<font color=#447700>!<a name='9007'></font>
<font color=#447700>!  5/12/2006:  Put a threshold on Bigg rain freezing.  If the frozen drops<a name='9008'></font>
<font color=#447700>!              have an average volume less than xvhmn, then the drops are put<a name='9009'></font>
<font color=#447700>!              into snow instead of graupel/hail.<a name='9010'></font>
<font color=#447700>!<a name='9011'></font>
<font color=#447700>!              Fixed bug when vapor deposition was limited.<a name='9012'></font>
<font color=#447700>!<a name='9013'></font>
<font color=#447700>!  5/13/2006:  Note that qhacr has a large effect, but Z85 did not include it.<a name='9014'></font>
<font color=#447700>!              Turned off qsacr (set to zero).<a name='9015'></font>
<font color=#447700>!<a name='9016'></font>
<font color=#447700>!  9/14/2007: erm: recalculate vx(lh) after setting xdn(lh) in case xdn was out of allowed range.<a name='9017'></font>
<font color=#447700>!             added parameter rimc3 for minimum rime density.  Default value set at 170. kg/m**3<a name='9018'></font>
<font color=#447700>!             instead of previous use of 100.  (Farley, 1987)<a name='9019'></font>
<font color=#447700>!<a name='9020'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='9021'></font>
<font color=#447700>!<a name='9022'></font>
<font color=#447700>!  general declarations<a name='9023'></font>
<font color=#447700>!<a name='9024'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='9025'></font>
<font color=#447700>!<a name='9026'></font>
<font color=#447700>!<a name='9027'></font>
<font color=#447700>!<a name='9028'></font>
<a name='9029'>
<a name='9030'>
      implicit none<a name='9031'>
<font color=#447700>!<a name='9032'></font>
<font color=#447700>!      integer icond <a name='9033'></font>
<font color=#447700>!      parameter ( icond = 2 )<a name='9034'></font>
<a name='9035'>
      integer, parameter :: ng1 = 1<a name='9036'>
<a name='9037'>
      integer nx,ny,nz,na,nba,nv<a name='9038'>
      integer nor,norz,istag,jstag,kstag <font color=#447700>! ,nht,ngt,igsr<a name='9039'></font>
      integer iwrite<a name='9040'>
      real dtp,dx,dy,dz<a name='9041'>
<a name='9042'>
      logical, intent(in) :: io_flag<a name='9043'>
<a name='9044'>
      integer itile,jtile,ktile<a name='9045'>
      integer ixbeg,jybeg<a name='9046'>
      integer ixend,jyend,kzend,kzbeg<a name='9047'>
      integer nxend,nyend,nzend,nzbeg<a name='9048'>
      integer :: my_rank = 0<a name='9049'>
      integer, parameter :: myprock = 1, nprock = 1<a name='9050'>
      real rainprod2d(-nor+1:nx+nor,-norz+ng1:nz+norz)<a name='9051'>
      real evapprod2d(-nor+1:nx+nor,-norz+ng1:nz+norz)<a name='9052'>
<a name='9053'>
<a name='9054'>
      real tkediss(-nor+1:nx+nor,-norz+ng1:nz+norz)<a name='9055'>
      real axtra(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz,nxtra)<a name='9056'>
<a name='9057'>
      real :: galpharaut<a name='9058'>
      real :: xvbarmax<a name='9059'>
      <a name='9060'>
      integer jyslab,its,ids,ide,jds,jde <font color=#447700>! domain boundaries<a name='9061'></font>
      integer, intent(in) :: iunit <font color=#447700>!,iunit0<a name='9062'></font>
      real qvex<a name='9063'>
      integer iraincv, icgxconv<a name='9064'>
      parameter ( iraincv = 1, icgxconv = 1)<a name='9065'>
      real ffrz<a name='9066'>
<a name='9067'>
      real qcitmp,cirdiatmp <font color=#447700>! ,qiptmp,qirtmp<a name='9068'></font>
      real ccwtmp,ccitmp <font color=#447700>! ,ciptmp,cirtmp<a name='9069'></font>
      real cpqc,cpci <font color=#447700>! ,cpip,cpir<a name='9070'></font>
      real cpqc0,cpci0 <font color=#447700>! ,cpip0,cpir0<a name='9071'></font>
      real scfac <font color=#447700>! ,cpip1<a name='9072'></font>
      <a name='9073'>
      double precision dp1<a name='9074'>
      <a name='9075'>
      double precision frac, frach, xvfrz<a name='9076'>
      <a name='9077'>
      double precision :: timevtcalc<a name='9078'>
      double precision :: dpt1,dpt2<a name='9079'>
            <a name='9080'>
      <a name='9081'>
      logical, parameter :: usegamxinf = .false.<a name='9082'>
      logical, parameter :: usegamxinf2 = .false.<a name='9083'>
      logical, parameter :: usegamxinf3 = .false.<a name='9084'>
<font color=#447700>!      real rar  ! rime accretion rate as calculated from qxacw<a name='9085'></font>
<a name='9086'>
<a name='9087'>
<font color=#447700>! a few vars for time-split fallout      <a name='9088'></font>
      real vtmax<a name='9089'>
      integer n,ndfall<a name='9090'>
      <a name='9091'>
      double precision chgneg,chgpos,sctot<a name='9092'>
      <a name='9093'>
      real temgtmp<a name='9094'>
<a name='9095'>
      real pb(-norz+ng1:nz+norz)<a name='9096'>
      real pinit(-norz+ng1:nz+norz)<a name='9097'>
<a name='9098'>
      real gz(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz) <font color=#447700>! dz<a name='9099'></font>
      <a name='9100'>
      real qimax,xni0,roqi0<a name='9101'>
<a name='9102'>
<a name='9103'>
      real dv<a name='9104'>
<a name='9105'>
      real dtptmp<a name='9106'>
      integer itest,nidx,id1,jd1,kd1<a name='9107'>
      parameter (itest=1)<a name='9108'>
      parameter (nidx=10)<a name='9109'>
      parameter (id1=1,jd1=1,kd1=1)<a name='9110'>
      integer ierr<a name='9111'>
      integer iend<a name='9112'>
<a name='9113'>
      integer ix,kz, il, ic, ir, icp1, irp1, ip1,jp1,kp1<a name='9114'>
      integer :: jy<a name='9115'>
      integer i,j,k,i1<a name='9116'>
      integer kzb,kze<a name='9117'>
      real slope1, slope2<a name='9118'>
      real x1, x2, x3<a name='9119'>
      real eps,eps2<a name='9120'>
      parameter (eps=1.e-20,eps2=1.e-5)<a name='9121'>
<font color=#447700>!<a name='9122'></font>
<font color=#447700>!  Other elec. vars<a name='9123'></font>
<font color=#447700>!<a name='9124'></font>
      real  temele<a name='9125'>
      real  trev<a name='9126'>
      <a name='9127'>
      logical ldovol, ishail, ltest<a name='9128'>
<font color=#447700>!<a name='9129'></font>
<font color=#447700>!<a name='9130'></font>
<font color=#447700>!  wind indicies<a name='9131'></font>
<font color=#447700>!<a name='9132'></font>
      integer mu,mv,mw<a name='9133'>
      parameter (mu=1,mv=2,mw=3)<a name='9134'>
<font color=#447700>!<a name='9135'></font>
<font color=#447700>!  conversion parameters<a name='9136'></font>
<font color=#447700>!<a name='9137'></font>
      integer mqcw,mqxw,mtem,mrho,mtim<a name='9138'>
      parameter (mqcw=21,mqxw=21,mtem=21,mrho=5,mtim=6)<a name='9139'>
<a name='9140'>
      real xftim,xftimi,yftim, xftem,yftem, xfqcw,yfqcw, xfqxw,yfqxw<a name='9141'>
      parameter (xftim=0.05,xftimi = 1./xftim,yftim=1.)<a name='9142'>
      parameter (xftem=0.5,yftem=1.)<a name='9143'>
      parameter (xfqcw=2000.,yfqcw=1.)<a name='9144'>
      parameter (xfqxw=2000.,yfqxw=1.)<a name='9145'>
      real dtfac<a name='9146'>
      parameter ( dtfac = 1.0 )<a name='9147'>
      integer ido(lc:lqmx)<a name='9148'>
<a name='9149'>
<font color=#447700>!      integer iexy(lc:lqmx,lc:lqmx)<a name='9150'></font>
<font color=#447700>!      integer ieswi, ieswir, ieswip, ieswc, ieswr<a name='9151'></font>
<font color=#447700>!      integer ieglsw, iegli, ieglir, ieglip, ieglc, ieglr<a name='9152'></font>
<font color=#447700>!      integer iegmsw, iegmi, iegmir, iegmip, iegmc, iegmr<a name='9153'></font>
<font color=#447700>!      integer ieghsw, ieghi, ieghir, ieghip, ieghc, ieghr<a name='9154'></font>
<font color=#447700>!      integer iefwsw, iefwi, iefwir, iefwip, iefwc, iefwr<a name='9155'></font>
<font color=#447700>!      integer iehwsw, iehwi, iehwir, iehwip, iehwc, iehwr<a name='9156'></font>
<font color=#447700>!      integer iehlsw, iehli, iehlir, iehlip, iehlc, iehlr<a name='9157'></font>
<font color=#447700>!      real delqnsa, delqxsa, delqnsb, delqxsb, delqnia, delqxia<a name='9158'></font>
<font color=#447700>!      real delqnra, delqxra<a name='9159'></font>
<a name='9160'>
       real delqnxa(lc:lqmx)<a name='9161'>
       real delqxxa(lc:lqmx)<a name='9162'>
<font color=#447700>!<a name='9163'></font>
<font color=#447700>! external temporary arrays<a name='9164'></font>
<font color=#447700>!<a name='9165'></font>
      real t00(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9166'>
      real t77(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9167'>
<a name='9168'>
      real t0(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9169'>
      real t1(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9170'>
      real t2(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9171'>
      real t3(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9172'>
      real t4(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9173'>
      real t5(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9174'>
      real t6(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9175'>
      real t7(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9176'>
      real t8(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9177'>
      real t9(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9178'>
<a name='9179'>
      real p2(-nor+1:nx+nor,-nor+1:ny+nor,-norz+ng1:nz+norz)  <font color=#447700>! perturbation Pi<a name='9180'></font>
      real pn(-nor+1:nx+nor,-nor+1:ny+nor,-norz+ng1:nz+norz)<a name='9181'>
      real an(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz,na)<a name='9182'>
      real dn(-nor+1:nx+nor,-nor+1:ny+nor,-norz+ng1:nz+norz)<a name='9183'>
      real w(-nor+1:nx+nor,-nor+1:ny+nor,-norz+ng1:nz+norz)<a name='9184'>
<a name='9185'>
      real tmp3d(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz)<a name='9186'>
<a name='9187'>
<font color=#447700>! <a name='9188'></font>
<font color=#447700>!  declarations microphyscs and for gather/scatter<a name='9189'></font>
<font color=#447700>!<a name='9190'></font>
      integer nxmpb,nzmpb,nxz<a name='9191'>
      integer jgs,mgs,ngs,numgs<a name='9192'>
      parameter (ngs=500) <font color=#447700>!500)<a name='9193'></font>
      integer, parameter :: ngsz = 500<a name='9194'>
      integer ntt<a name='9195'>
      parameter (ntt=300)<a name='9196'>
<a name='9197'>
      real dvmgs(ngs)<a name='9198'>
      <a name='9199'>
      integer ngscnt,igs(ngs),kgs(ngs)<a name='9200'>
      integer kgsp(ngs),kgsm(ngs),kgsm2(ngs)<a name='9201'>
      integer ncuse<a name='9202'>
      parameter (ncuse=0)<a name='9203'>
      integer il0(ngs),il5(ngs),il2(ngs),il3(ngs)<a name='9204'>
<font color=#447700>!      integer il1m(ngs),il2m(ngs),il3m(ngs),il4m(ngs),il5m(ngs)<a name='9205'></font>
<font color=#447700>!<a name='9206'></font>
      real tdtol,temsav,tfrcbw,tfrcbi<a name='9207'>
      real, parameter :: thnuc = 235.15<a name='9208'>
<font color=#447700>!<a name='9209'></font>
<font color=#447700>!  Ice Multiplication Arrays.<a name='9210'></font>
<font color=#447700>!<a name='9211'></font>
      real  fimt1(ngs),fimta(ngs),fimt2(ngs) <font color=#447700>!,qmul1(ngs),qmul2(ngs)<a name='9212'></font>
      real xcwmas<a name='9213'>
<font color=#447700>!<a name='9214'></font>
<font color=#447700>!<a name='9215'></font>
<font color=#447700>! Variables for Ziegler warm rain microphysics<a name='9216'></font>
<font color=#447700>!      <a name='9217'></font>
<a name='9218'>
<a name='9219'>
      real ccnc(ngs),ccin(ngs),cina(ngs),ccna(ngs)<a name='9220'>
      real cwnccn(ngs)<a name='9221'>
      real sscb  <font color=#447700>! 'cloud base' SS threshold<a name='9222'></font>
      parameter ( sscb = 2.0 )<a name='9223'>
      integer idecss  <font color=#447700>! flag to turn on (=1) decay of ssmax when no cloud or ice crystals<a name='9224'></font>
      parameter ( idecss = 1 )<a name='9225'>
      integer iba <font color=#447700>! flag to do condensation/nucleation in 1st or 2nd loop<a name='9226'></font>
                  <font color=#447700>! =0 to use ad to calculate SS<a name='9227'></font>
                  <font color=#447700>! =1 to use an at end of main jy loop to calculate SS<a name='9228'></font>
      parameter (iba = 1)<a name='9229'>
      integer ifilt   <font color=#447700>! =1 to filter ssat, =0 to set ssfilt=ssat<a name='9230'></font>
      parameter ( ifilt = 0 ) <a name='9231'>
      real temp1,temp2 <font color=#447700>! ,ssold<a name='9232'></font>
      real :: mwat, mice, dice, mwshed, fwmax, fw, mwcrit, massfactor, tmpdiam<a name='9233'>
      real, parameter :: shedalp = 3.  <font color=#447700>! set 3 for maximum mass diameter (same as area-weighted diameter), 4 for mass-weighted diameter<a name='9234'></font>
      real ssmax(ngs)       <font color=#447700>! maximum SS experienced by a parcel<a name='9235'></font>
      real ssmx<a name='9236'>
      real dnnet,dqnet<a name='9237'>
<font color=#447700>!      real cnu,rnu,snu,cinu<a name='9238'></font>
<font color=#447700>!      parameter ( cnu = 0.0, rnu = -0.8, snu = -0.8, cinu = 0.0 )<a name='9239'></font>
      real bfnu, bfnu0, bfnu1<a name='9240'>
      parameter ( bfnu0 = (rnu + 2.0)/(rnu + 1.0)  )<a name='9241'>
      real ventr, ventc<a name='9242'>
      real volb, aa1, aa2<a name='9243'>
      double precision t2s, xdp<a name='9244'>
      double precision xl2p(ngs),rb(ngs)<a name='9245'>
      parameter ( aa1 = 9.44e15, aa2 = 5.78e3 ) <font color=#447700>! a1 in Ziegler<a name='9246'></font>
<font color=#447700>! snow parameters:<a name='9247'></font>
      real cexs, cecs<a name='9248'>
      parameter ( cexs = 0.1, cecs = 0.5 )<a name='9249'>
      real rvt      <font color=#447700>! ratio of collection kernels (Zrnic et al, 1993)<a name='9250'></font>
      parameter ( rvt = 0.104 )<a name='9251'>
      real kfrag    <font color=#447700>! rate coefficent for collisional splintering (Schuur &amp; Rutledge 00b)<a name='9252'></font>
      parameter ( kfrag = 1.0e-6 )<a name='9253'>
      real mfrag    <font color=#447700>! assumed ice fragment mass for collisional splintering (Schuur &amp; Rutledge 00b)<a name='9254'></font>
      parameter ( mfrag = 1.0e-10)<a name='9255'>
      double precision cautn(ngs), rh(ngs), nh(ngs)<a name='9256'>
      real ex1, ft, rhoinv(ngs)<a name='9257'>
      double precision ec0(ngs)<a name='9258'>
      <a name='9259'>
      real ac1,bc, taus, c1,d1,e1,f1,p380,tmp,tmp1,tmp2,tmp3,tmp4,tmp5 <font color=#447700>! , sstdy, super<a name='9260'></font>
      real ratio, delx, dely<a name='9261'>
      real dbigg,volt<a name='9262'>
      real chgtmp,fac,mixedphasefac<a name='9263'>
      real x,y,y2,del,r,rtmp,alpr<a name='9264'>
      double precision :: vent1,vent2<a name='9265'>
      real g1palp,g4palp<a name='9266'>
      real fqt <font color=#447700>!charge separation as fn of temperature from Dong and Hallett 1992<a name='9267'></font>
      real bs<a name='9268'>
      real v1, v2<a name='9269'>
      real d1r, d1i, d1s, e1i<a name='9270'>
      real c1sw   <font color=#447700>! integration factor for snow melting with snu = -0.8<a name='9271'></font>
      real, parameter :: vr1mm = 5.23599e-10 <font color=#447700>! volume of 1mm diameter sphere (m**3)<a name='9272'></font>
      real, parameter :: vr3mm = 5.23599e-10*(3.0/1.)**3   <font color=#447700>! volume of a 3 mm diameter sphere (m**3) (Rasmussen et al. 1984b, JAS)<a name='9273'></font>
      real, parameter :: vr4p5mm = 5.23599e-10*(4.5/1.)**3 <font color=#447700>! volume of 4.5mm diameter sphere (m**3) (Rasmussen et al. 1984b, JAS)<a name='9274'></font>
      real vmlt,vshd, vshdgs(ngs,lh:lhab), maxmassfac(lc:lhab)<a name='9275'>
      real rhosm<a name='9276'>
      parameter ( rhosm = 500. )<a name='9277'>
      integer nc <font color=#447700>! condensation step<a name='9278'></font>
      real dtcon,dtcon1,dtcon2 <font color=#447700>! condensation time step (dtcon*nc = dtp)<a name='9279'></font>
      real delta<a name='9280'>
      integer ltemq1,ltemq1m <font color=#447700>! ,ltemq1m2<a name='9281'></font>
      real dqv,qv1,ss1,ss2,qvs1,dqvs,dtemp,dt1   <font color=#447700>! temporaries for condensation<a name='9282'></font>
      real ssi1, ssi2, dqvi, dqvis, dqvii,qis1<a name='9283'>
      real dqvr, dqc, dqr, dqi, dqs<a name='9284'>
      real qv1m,qvs1m,ss1m,ssi1m,qis1m<a name='9285'>
      real cwmastmp<a name='9286'>
      real  dcloud,dcloud2 <font color=#447700>! ,as, bs<a name='9287'></font>
      real cn(ngs)<a name='9288'>
      double precision xvc, xvr<a name='9289'>
      real mwfac<a name='9290'>
<font color=#447700>!      real  es(ngs) ! ss(ngs),<a name='9291'></font>
<font color=#447700>!      real  eis(ngs)<a name='9292'></font>
<a name='9293'>
      real rwmasn,rwmasx<a name='9294'>
<a name='9295'>
      real vgra,vfrz<a name='9296'>
      parameter ( vgra = 0.523599*(1.0e-3)**3 )<a name='9297'>
     <a name='9298'>
      real epsi,d<a name='9299'>
      parameter (epsi = 0.622, d = 0.266)<a name='9300'>
      real r1,qevap <font color=#447700>! ,slv<a name='9301'></font>
      <a name='9302'>
      real vr,nrx,chw,g1,qr,z,z1,rdi,alp,xnutmp,xnuc,g1r,rd1,rdia<a name='9303'>
      <a name='9304'>
      real, parameter :: rhofrz = 900.   <font color=#447700>! density of graupel from newly-frozen rain<a name='9305'></font>
      real, parameter :: rimedens = 500. <font color=#447700>! default rime density<a name='9306'></font>
<a name='9307'>
<font color=#447700>!      real svc(ngs)  !  droplet volume<a name='9308'></font>
<font color=#447700>!<a name='9309'></font>
<font color=#447700>!  contact freezing nucleation<a name='9310'></font>
<font color=#447700>!<a name='9311'></font>
      real raero,kaero <font color=#447700>!assumd aerosol radius, thermal conductivity<a name='9312'></font>
      parameter ( raero = 3.e-7, kaero = 5.39e-3 )<a name='9313'>
      real kb   <font color=#447700>! Boltzman constant  J K-1<a name='9314'></font>
      parameter (kb = 1.3807e-23)<a name='9315'>
      <a name='9316'>
      real knud(ngs),knuda(ngs) <font color=#447700>!knudsen number and correction factor<a name='9317'></font>
      real gtp(ngs)  <font color=#447700>!G(T,p) = 1/(a' + b')  Cotton 72b<a name='9318'></font>
      real dfar(ngs) <font color=#447700>!aerosol diffusivity<a name='9319'></font>
      real fn1(ngs),fn2(ngs),fnft(ngs)<a name='9320'>
      <a name='9321'>
      real ccia(ngs)<a name='9322'>
      real ctfzbd(ngs),ctfzth(ngs),ctfzdi(ngs)<a name='9323'>
<font color=#447700>!<a name='9324'></font>
<font color=#447700>!  misc<a name='9325'></font>
<font color=#447700>!<a name='9326'></font>
      real ni,nis,nr,d0<a name='9327'>
      real dqvcnd(ngs),dqwv(ngs),dqcw(ngs),dqci(ngs)<a name='9328'>
      real tempc(ngs)<a name='9329'>
      real temg(ngs),temcg(ngs),theta(ngs),qvap(ngs) <a name='9330'>
      real temgkm1(ngs), temgkm2(ngs)<a name='9331'>
      real temgx(ngs),temcgx(ngs)<a name='9332'>
      real qvs(ngs),qis(ngs),qss(ngs),pqs(ngs)<a name='9333'>
      real elv(ngs),elf(ngs),els(ngs)<a name='9334'>
      real tsqr(ngs),ssi(ngs),ssw(ngs)<a name='9335'>
      real qcwtmp(ngs),qtmp,qtot(ngs) <a name='9336'>
      real qcond(ngs)<a name='9337'>
      real ctmp, sctmp<a name='9338'>
      real cimasn,cimasx,ccimx<a name='9339'>
      real pid4<a name='9340'>
      real cs,ds,gf7,gf6,gf5,gf4,gf3,gf2,gf1<a name='9341'>
      real gcnup1,gcnup2<a name='9342'>
      real gf73rds, gf83rds<a name='9343'>
      real gamice73fac, gamsnow73fac<a name='9344'>
      real gf43rds, gf53rds<a name='9345'>
      real aradcw,bradcw,cradcw,dradcw,cwrad,rwrad,rwradmn<a name='9346'>
      parameter ( rwradmn = 50.e-6 )<a name='9347'>
      real dh0<a name='9348'>
      <a name='9349'>
      real clionpmx,clionnmx<a name='9350'>
      parameter (clionpmx=1.e9,clionnmx=1.e9) <font color=#447700>! Takahashi 84<a name='9351'></font>
<font color=#447700>!<a name='9352'></font>
<font color=#447700>!  other arrays<a name='9353'></font>
<a name='9354'>
      real fwet1(ngs),fwet2(ngs)   <a name='9355'>
      real fmlt1(ngs),fmlt2(ngs)  <a name='9356'>
      real fvds(ngs),fvce(ngs),fiinit(ngs) <a name='9357'>
      real fvent(ngs),fraci(ngs),fracl(ngs)<a name='9358'>
<font color=#447700>!<a name='9359'></font>
      real fai(ngs),fav(ngs),fbi(ngs),fbv(ngs)<a name='9360'>
      real felv(ngs),fels(ngs),felf(ngs)<a name='9361'>
      real felvcp(ngs),felscp(ngs),felfcp(ngs)<a name='9362'>
      real felvpi(ngs),felspi(ngs),felfpi(ngs)<a name='9363'>
      real felvs(ngs),felss(ngs)      <font color=#447700>!   ,felfs(ngs)<a name='9364'></font>
      real fwvdf(ngs),ftka(ngs),fthdf(ngs)<a name='9365'>
      real fadvisc(ngs),fakvisc(ngs)<a name='9366'>
      real fci(ngs),fcw(ngs)<a name='9367'>
      real fschm(ngs),fpndl(ngs)<a name='9368'>
      real fgamw(ngs),fgams(ngs)<a name='9369'>
      real fcqv1(ngs),fcqv2(ngs),fcc3(ngs) <a name='9370'>
      <a name='9371'>
      real cvm,cpm,rmm<a name='9372'>
<a name='9373'>
      real, parameter :: rovcp = rd/cp<a name='9374'>
      real, parameter ::      cpv = 1885.0       <font color=#447700>! specific heat of water vapor at constant pressure<a name='9375'></font>
<font color=#447700>!<a name='9376'></font>
      real fcci(ngs), fcip(ngs)<a name='9377'>
<font color=#447700>!<a name='9378'></font>
      real :: sfm1(ngs),sfm2(ngs)<a name='9379'>
      real :: gfm1(ngs),gfm2(ngs)<a name='9380'>
      real :: hfm1(ngs),hfm2(ngs)<a name='9381'>
<a name='9382'>
      logical :: wetsfc(ngs),wetsfchl(ngs)<a name='9383'>
      logical :: wetgrowth(ngs), wetgrowthhl(ngs)<a name='9384'>
<a name='9385'>
       real qitmp(ngs),qistmp(ngs)<a name='9386'>
       <a name='9387'>
      real rzxh(ngs), rzxhl(ngs), rzxhlh(ngs)<a name='9388'>
      real rzxs(ngs)<a name='9389'>
      real axh(ngs),bxh(ngs),axhl(ngs),bxhl(ngs)<a name='9390'>
      real vt2ave(ngs)<a name='9391'>
<a name='9392'>
      real ::  qx(ngs,lv:lhab)<a name='9393'>
      real ::  qxw(ngs,ls:lhab)<a name='9394'>
      real ::  cx(ngs,lc:lhab)<a name='9395'>
      real ::  cxmxd(ngs,lc:lhab)<a name='9396'>
      real ::  qxmxd(ngs,lv:lhab)<a name='9397'>
      real ::  scx(ngs,lc:lhab)<a name='9398'>
      real ::  xv(ngs,lc:lhab)<a name='9399'>
      real ::  vtxbar(ngs,lc:lhab,3)<a name='9400'>
      real ::  xmas(ngs,lc:lhab)<a name='9401'>
      real ::  xdn(ngs,lc:lhab)<a name='9402'>
      real ::  xdia(ngs,lc:lhab,3)<a name='9403'>
      real ::  rarx(ngs,ls:lhab)<a name='9404'>
      real ::  vx(ngs,li:lhab)<a name='9405'>
      real ::  rimdn(ngs,li:lhab)<a name='9406'>
      real ::  raindn(ngs,li:lhab)<a name='9407'>
      real ::  alpha(ngs,lc:lhab)<a name='9408'>
      real ::  dab0lh(ngs,lc:lhab,lr:lhab)<a name='9409'>
      real ::  dab1lh(ngs,lc:lhab,lr:lhab)<a name='9410'>
      <a name='9411'>
      real :: galphrout<a name='9412'>
      <a name='9413'>
      real ventrx(ngs)<a name='9414'>
      real ventrxn(ngs)<a name='9415'>
      real g1shr, alphashr<a name='9416'>
      real g1mlr, alphamlr<a name='9417'>
      real massfacshr, massfacmlr<a name='9418'>
      <a name='9419'>
      real :: qhgt8mm <font color=#447700>! ice mass greater than 8mm<a name='9420'></font>
      real :: qhwgt8mm <font color=#447700>! ice + max water mass greater than 8mm<a name='9421'></font>
      real :: qhgt10mm <font color=#447700>! mass greater than 10mm<a name='9422'></font>
      real :: qhgt20mm <font color=#447700>! mass greater than 20mm<a name='9423'></font>
      real :: fwmhtmp<a name='9424'>
      real, parameter :: fwmhtmptem = -15. <font color=#447700>! temperature at which fwmhtmp fully switches to liquid water only being on large particles<a name='9425'></font>
      real, parameter :: d1t = (6.0 * 0.268e-3/(917.* pi))**(1./3.) <font color=#447700>! d1t is the diameter of the ice sphere with the mass of an 8mm spherical drop<a name='9426'></font>
      real, parameter :: srasheym = 0.1389 <font color=#447700>! slope fraction from Rasmussen and Heymsfield <a name='9427'></font>
<font color=#447700>!<a name='9428'></font>
      real swvent(ngs),hwvent(ngs),rwvent(ngs),hlvent(ngs),hwventy(ngs),hlventy(ngs),rwventz(ngs)<a name='9429'>
      integer, parameter :: ndiam = 10<a name='9430'>
      integer :: numdiam<a name='9431'>
      real hwvent0(ndiam+3),hlvent0 <font color=#447700>! 0 to d1<a name='9432'></font>
      real hwvent1,hlvent1 <font color=#447700>! d1 to infinity<a name='9433'></font>
      real hwvent2,hlvent2 <font color=#447700>! d2 to infinity<a name='9434'></font>
      real gama0,gamb0<a name='9435'>
      real gama1,gamb1<a name='9436'>
      real gama2,gamb2<a name='9437'>
      real, parameter :: mltdiam1 = 9.0e-3, mltdiam2 = 19.0e-3, mltdiam3 = 200.0e-3, mltdiam05 = 4.5e-3<a name='9438'>
      real :: mltdiam(ndiam+3)<a name='9439'>
      real mltmass1inv,mltmass2inv, mltmass1cgs, mltmass2cgs<a name='9440'>
      real qhmlr0, qhmlr05, qhmlr1, qhmlr2, qhmlr12<a name='9441'>
      real qhlmlr0, qhlmlr05, qhlmlr1, qhlmlr2, qhlmlr12<a name='9442'>
      real qxd1, cxd1 <font color=#447700>! mass and number up to mltdiam1<a name='9443'></font>
      real qxd05, cxd05 <font color=#447700>! mass and number up to mltdiam1/2<a name='9444'></font>
      <a name='9445'>
      real :: qxd(ndiam+3), cxd(ndiam+3), qhml(ndiam+3), qhml0(ndiam+3)<a name='9446'>
      real :: dqxd(ndiam+3), dcxd(ndiam+3), dqhml(ndiam+3)<a name='9447'>
      <a name='9448'>
      <a name='9449'>
      real civent(ngs)<a name='9450'>
      real isvent(ngs)<a name='9451'>
<font color=#447700>!<a name='9452'></font>
      real xmascw(ngs)<a name='9453'>
      real xdnmx(lc:lhab), xdnmn(lc:lhab)<a name='9454'>
      real dnmx<a name='9455'>
      real :: xdiamxmas(ngs,lc:lhab)<a name='9456'>
<font color=#447700>!<a name='9457'></font>
      real cilen(ngs) <font color=#447700>! ,ciplen(ngs)<a name='9458'></font>
<font color=#447700>!<a name='9459'></font>
<font color=#447700>!<a name='9460'></font>
      real rwcap(ngs),swcap(ngs)<a name='9461'>
      real hwcap(ngs)<a name='9462'>
      real hlcap(ngs)<a name='9463'>
      real cicap(ngs)<a name='9464'>
      real iscap(ngs)<a name='9465'>
<a name='9466'>
      real qvimxd(ngs)<a name='9467'>
      real qimxd(ngs),qismxd(ngs),qcmxd(ngs),qrmxd(ngs),qsmxd(ngs),qhmxd(ngs),qhlmxd(ngs)<a name='9468'>
      real cimxd(ngs),ccmxd(ngs),crmxd(ngs),csmxd(ngs),chmxd(ngs)<a name='9469'>
      real cionpmxd(ngs),cionnmxd(ngs)<a name='9470'>
      real clionpmxd(ngs),clionnmxd(ngs)<a name='9471'>
<a name='9472'>
<a name='9473'>
      real elec(-nor+ng1:nx+nor,-nor+ng1:ny+nor,-norz+ng1:nz+norz) <font color=#447700>! Ez (elecsave)<a name='9474'></font>
<a name='9475'>
<font color=#447700>!<a name='9476'></font>
<font color=#447700>!<a name='9477'></font>
      <font color=#447700>! Hallett-Mossop arrays<a name='9478'></font>
      real chmul1(ngs),chlmul1(ngs),csmul1(ngs),csmul(ngs)<a name='9479'>
      real qhmul1(ngs),qhlmul1(ngs),qsmul1(ngs),qsmul(ngs)<a name='9480'>
      <a name='9481'>
      <font color=#447700>! splinters from drop freezing<a name='9482'></font>
      real csplinter(ngs),qsplinter(ngs)<a name='9483'>
      real csplinter2(ngs),qsplinter2(ngs)<a name='9484'>
<font color=#447700>!<a name='9485'></font>
<font color=#447700>!<a name='9486'></font>
<font color=#447700>!  concentration arrays...<a name='9487'></font>
<font color=#447700>!<a name='9488'></font>
      real :: chlcnh(ngs), vhlcnh(ngs), vhlcnhl(ngs)<a name='9489'>
      real cracif(ngs), ciacrf(ngs)<a name='9490'>
      real cracr(ngs)<a name='9491'>
<a name='9492'>
<font color=#447700>!<a name='9493'></font>
      real ciint(ngs), crfrz(ngs), crfrzf(ngs), crfrzs(ngs)<a name='9494'>
      real cicint(ngs)<a name='9495'>
      real cipint(ngs)<a name='9496'>
      real ciacw(ngs), cwacii(ngs) <a name='9497'>
      real ciacr(ngs), craci(ngs)<a name='9498'>
      real csacw(ngs)<a name='9499'>
      real csacr(ngs)<a name='9500'>
      real csaci(ngs),   csacs(ngs)<a name='9501'>
      real cracw(ngs) <a name='9502'>
      real chacw(ngs), chacr(ngs)<a name='9503'>
      real :: chlacw(ngs) <font color=#447700>! = 0.0<a name='9504'></font>
      real chaci(ngs), chacs(ngs)<a name='9505'>
<font color=#447700>!<a name='9506'></font>
      real :: chlacr(ngs)<a name='9507'>
      real :: chlaci(ngs), chlacs(ngs)<a name='9508'>
      real crcnw(ngs) <a name='9509'>
      real cidpv(ngs),cisbv(ngs)<a name='9510'>
      real cisdpv(ngs),cissbv(ngs)<a name='9511'>
      real cimlr(ngs),cismlr(ngs)<a name='9512'>
<a name='9513'>
      real chlsbv(ngs), chldpv(ngs)<a name='9514'>
      real chlmlr(ngs), chlmlrr(ngs) <a name='9515'>
      real chlshr(ngs), chlshrr(ngs)<a name='9516'>
<a name='9517'>
      real chdpv(ngs),chsbv(ngs)<a name='9518'>
      real chmlr(ngs),chcev(ngs)<a name='9519'>
      real chmlrr(ngs)<a name='9520'>
      real chshr(ngs), chshrr(ngs)<a name='9521'>
<a name='9522'>
      real csdpv(ngs),cssbv(ngs)<a name='9523'>
      real csmlr(ngs),cscev(ngs)<a name='9524'>
      real csshr(ngs)<a name='9525'>
<a name='9526'>
      real crcev(ngs)<a name='9527'>
      real crshr(ngs)<a name='9528'>
<font color=#447700>!<a name='9529'></font>
<font color=#447700>!<a name='9530'></font>
<font color=#447700>! arrays for w-ac-x ;  x-ac-w<a name='9531'></font>
<font color=#447700>!<a name='9532'></font>
<font color=#447700>!<a name='9533'></font>
<font color=#447700>!<a name='9534'></font>
      real qrcnw(ngs), qwcnr(ngs)<a name='9535'>
      real zrcnw(ngs),zracr(ngs),zracw(ngs),zrcev(ngs)<a name='9536'>
<a name='9537'>
<a name='9538'>
      real qracw(ngs) <font color=#447700>! qwacr(ngs),<a name='9539'></font>
      real qiacw(ngs) <font color=#447700>!, qwaci(ngs)<a name='9540'></font>
<a name='9541'>
      real qsacw(ngs) <font color=#447700>! ,qwacs(ngs),<a name='9542'></font>
      real qhacw(ngs) <font color=#447700>! qwach(ngs),<a name='9543'></font>
      real :: qhlacw(ngs) <font color=#447700>! = 0.0<a name='9544'></font>
      real vhacw(ngs), vsacw(ngs), vhlacw(ngs), vhlacr(ngs)<a name='9545'>
<a name='9546'>
<font color=#447700>!<a name='9547'></font>
      real qsacws(ngs)<a name='9548'>
<a name='9549'>
<font color=#447700>!<a name='9550'></font>
<font color=#447700>!  arrays for x-ac-r and r-ac-x; <a name='9551'></font>
<font color=#447700>!<a name='9552'></font>
      real qsacr(ngs),qracs(ngs)<a name='9553'>
      real qhacr(ngs),qhacrmlr(ngs) <font color=#447700>! ,qrach(ngs)<a name='9554'></font>
      real vhacr(ngs), zhacr(ngs), zhacrf(ngs), zrach(ngs), zrachl(ngs)<a name='9555'>
      real qiacr(ngs),qraci(ngs)<a name='9556'>
      <a name='9557'>
      real ziacr(ngs)<a name='9558'>
<a name='9559'>
      real qracif(ngs),qiacrf(ngs),qiacrs(ngs),ciacrs(ngs)<a name='9560'>
<a name='9561'>
      real :: qhlacr(ngs),qhlacrmlr(ngs) <font color=#447700>! = 0.0<a name='9562'></font>
      real qsacrs(ngs) <font color=#447700>!,qracss(ngs)<a name='9563'></font>
<font color=#447700>!<a name='9564'></font>
<font color=#447700>!  ice - ice interactions<a name='9565'></font>
<font color=#447700>!<a name='9566'></font>
      real qsaci(ngs)<a name='9567'>
      real qsacis(ngs)<a name='9568'>
      real qhaci(ngs)<a name='9569'>
      real qhacs(ngs)<a name='9570'>
<a name='9571'>
      real :: qhacis(ngs) = 0.0<a name='9572'>
      real :: chacis(ngs) = 0.0<a name='9573'>
      real :: chacis0(ngs) = 0.0<a name='9574'>
<a name='9575'>
      real :: csaci0(ngs) <font color=#447700>! collision rate only<a name='9576'></font>
      real :: chaci0(ngs) <font color=#447700>! collision rate only<a name='9577'></font>
      real :: chacs0(ngs) <font color=#447700>! collision rate only<a name='9578'></font>
      real :: chlaci0(ngs) <font color=#447700>! = 0.0<a name='9579'></font>
      real :: chlacis(ngs) = 0.0<a name='9580'>
      real :: chlacis0(ngs) = 0.0<a name='9581'>
      real :: chlacs0(ngs) <font color=#447700>! = 0.0<a name='9582'></font>
<a name='9583'>
      real :: qsaci0(ngs) <font color=#447700>! collision rate only<a name='9584'></font>
      real :: qsacis0(ngs) <font color=#447700>! collision rate only<a name='9585'></font>
      real :: qhaci0(ngs) <font color=#447700>! collision rate only<a name='9586'></font>
      real :: qhacis0(ngs) <font color=#447700>! collision rate only<a name='9587'></font>
      real :: qhacs0(ngs) <font color=#447700>! collision rate only<a name='9588'></font>
      real :: qhlaci0(ngs) <font color=#447700>! = 0.0<a name='9589'></font>
      real :: qhlacis0(ngs) <font color=#447700>! = 0.0<a name='9590'></font>
      real :: qhlacs0(ngs) <font color=#447700>! = 0.0<a name='9591'></font>
<a name='9592'>
      real :: qhlaci(ngs) <font color=#447700>! = 0.0<a name='9593'></font>
      real :: qhlacis(ngs) <font color=#447700>! = 0.0<a name='9594'></font>
      real :: qhlacs(ngs) <font color=#447700>! = 0.0<a name='9595'></font>
<font color=#447700>!<a name='9596'></font>
<font color=#447700>!  conversions<a name='9597'></font>
<font color=#447700>!<a name='9598'></font>
      real qrfrz(ngs) <font color=#447700>! , qirirhr(ngs)<a name='9599'></font>
      real zrfrz(ngs), zrfrzf(ngs), zrfrzs(ngs)<a name='9600'>
      real ziacrf(ngs), zhcnsh(ngs), zhcnih(ngs)<a name='9601'>
      real zhacw(ngs), zhacs(ngs), zhaci(ngs)<a name='9602'>
      real zhmlr(ngs), zhdsv(ngs), zhsbv(ngs), zhlcnh(ngs), zhshr(ngs)<a name='9603'>
      real zhmlrtmp,zhmlr0inf,zhlmlr0inf<a name='9604'>
      real zhmlrr(ngs),zhlmlrr(ngs),zhshrr(ngs),zhlshrr(ngs)<a name='9605'>
      real zsmlr(ngs), zsmlrr(ngs), zsshr(ngs)<a name='9606'>
      real zhcns(ngs), zhcni(ngs)<a name='9607'>
      real zhwdn(ngs) <font color=#447700>! change in Z due to density changes<a name='9608'></font>
      real zhldn(ngs) <font color=#447700>! change in Z due to density changes<a name='9609'></font>
<a name='9610'>
      real zhlacw(ngs), zhlacs(ngs), zhlacr(ngs)<a name='9611'>
      real zhlmlr(ngs), zhldsv(ngs), zhlsbv(ngs), zhlshr(ngs)<a name='9612'>
<a name='9613'>
      <a name='9614'>
      real vrfrzf(ngs), viacrf(ngs)<a name='9615'>
      real qrfrzs(ngs), qrfrzf(ngs)<a name='9616'>
      real qwfrz(ngs), qwctfz(ngs)<a name='9617'>
      real cwfrz(ngs), cwctfz(ngs)<a name='9618'>
      real qwfrzis(ngs), qwctfzis(ngs) <font color=#447700>! droplet freezing to ice spheres<a name='9619'></font>
      real cwfrzis(ngs), cwctfzis(ngs)<a name='9620'>
      real qwfrzc(ngs), qwctfzc(ngs) <font color=#447700>! droplet freezing to columns<a name='9621'></font>
      real cwfrzc(ngs), cwctfzc(ngs)<a name='9622'>
      real qwfrzp(ngs), qwctfzp(ngs) <font color=#447700>! droplet freezing to plates<a name='9623'></font>
      real cwfrzp(ngs), cwctfzp(ngs)<a name='9624'>
      real xcolmn(ngs), xplate(ngs)<a name='9625'>
      real ciihr(ngs), qiihr(ngs)<a name='9626'>
      real cicichr(ngs), qicichr(ngs)<a name='9627'>
      real cipiphr(ngs), qipiphr(ngs)<a name='9628'>
      real qscni(ngs), cscni(ngs), cscnis(ngs)<a name='9629'>
      real qscnvi(ngs), cscnvi(ngs), cscnvis(ngs)<a name='9630'>
      real qhcns(ngs), chcns(ngs), chcnsh(ngs), vhcns(ngs)<a name='9631'>
      real qscnh(ngs), cscnh(ngs), vscnh(ngs)<a name='9632'>
      real qhcni(ngs), chcni(ngs), chcnih(ngs), vhcni(ngs)<a name='9633'>
      real qiint(ngs),qipipnt(ngs),qicicnt(ngs)<a name='9634'>
      real cninm(ngs),cnina(ngs),cninp(ngs),wvel(ngs),wvelkm1(ngs)<a name='9635'>
      real tke(ngs)<a name='9636'>
      real uvel(ngs),vvel(ngs)<a name='9637'>
<font color=#447700>!<a name='9638'></font>
      real qidpv(ngs),qisbv(ngs) <font color=#447700>! qicnv(ngs),qievv(ngs),<a name='9639'></font>
      real qimlr(ngs),qidsv(ngs),qisdsv(ngs),qidsvp(ngs) <font color=#447700>! ,qicev(ngs)<a name='9640'></font>
      real qismlr(ngs)<a name='9641'>
<a name='9642'>
<font color=#447700>!<a name='9643'></font>
      real qfdpv(ngs),qfsbv(ngs) <font color=#447700>! qfcnv(ngs),qfevv(ngs),<a name='9644'></font>
      real qfmlr(ngs),qfdsv(ngs) <font color=#447700>! ,qfcev(ngs)<a name='9645'></font>
      real qfwet(ngs),qfdry(ngs),qfshr(ngs)<a name='9646'>
      real qfshrp(ngs)<a name='9647'>
<font color=#447700>!<a name='9648'></font>
      real :: qhldpv(ngs), qhlsbv(ngs) <font color=#447700>! qhlcnv(ngs),qhlevv(ngs),<a name='9649'></font>
      real :: qhlmlr(ngs), qhldsv(ngs) <a name='9650'>
      real :: qhlwet(ngs), qhldry(ngs), qhlshr(ngs) <a name='9651'>
<font color=#447700>!<a name='9652'></font>
      real :: qrfz(ngs),qsfz(ngs),qhfz(ngs),qhlfz(ngs)<a name='9653'>
<font color=#447700>!<a name='9654'></font>
      real qhdpv(ngs),qhsbv(ngs) <font color=#447700>! qhcnv(ngs),qhevv(ngs),<a name='9655'></font>
      real qhmlr(ngs),qhdsv(ngs),qhcev(ngs),qhcndv(ngs),qhevv(ngs)<a name='9656'>
      real qhmlrlg(ngs),qhlmlrlg(ngs) <font color=#447700>! melting from the larger diameters<a name='9657'></font>
      real qhlcev(ngs), chlcev(ngs)<a name='9658'>
      real qhwet(ngs),qhdry(ngs),qhshr(ngs)<a name='9659'>
      real qhshrp(ngs)<a name='9660'>
      real qhshh(ngs) <font color=#447700>!accreted water that remains on graupel<a name='9661'></font>
      real qhmlh(ngs) <font color=#447700>!melt water that remains on graupel<a name='9662'></font>
      real qhfzh(ngs) <font color=#447700>!water that freezes on mixed-phase graupel<a name='9663'></font>
      real qhlfzhl(ngs) <font color=#447700>!water that freezes on mixed-phase hail<a name='9664'></font>
<a name='9665'>
      real vhfzh(ngs) <font color=#447700>! change in volume from water that freezes on mixed-phase graupel<a name='9666'></font>
      real vhlfzhl(ngs) <font color=#447700>!  change in volume from water that freezes on mixed-phase hail<a name='9667'></font>
<a name='9668'>
      real vhshdr(ngs) <font color=#447700>!accreted water that leaves on graupel (mixedphase)<a name='9669'></font>
      real vhlshdr(ngs) <font color=#447700>!accreted water that leaves on hail (mixedphase)<a name='9670'></font>
      real vhmlr(ngs) <font color=#447700>!melt water that leaves graupel (single phase)<a name='9671'></font>
      real vhlmlr(ngs) <font color=#447700>!melt water that leaves hail (single phase)<a name='9672'></font>
      real vhsoak(ngs) <font color=#447700>!  aquired water that seeps into graupel.<a name='9673'></font>
      real vhlsoak(ngs) <font color=#447700>!  aquired water that seeps into hail.<a name='9674'></font>
<font color=#447700>!<a name='9675'></font>
      real qsdpv(ngs),qssbv(ngs) <font color=#447700>! qscnv(ngs),qsevv(ngs),<a name='9676'></font>
      real qsmlr(ngs),qsdsv(ngs),qscev(ngs),qscndv(ngs),qsevv(ngs)<a name='9677'>
      real qswet(ngs),qsdry(ngs),qsshr(ngs)<a name='9678'>
      real qsshrp(ngs)<a name='9679'>
      real qsfzs(ngs)<a name='9680'>
<font color=#447700>!<a name='9681'></font>
<font color=#447700>!<a name='9682'></font>
      real qipdpv(ngs),qipsbv(ngs)<a name='9683'>
      real qipmlr(ngs),qipdsv(ngs)<a name='9684'>
<font color=#447700>!<a name='9685'></font>
      real qirdpv(ngs),qirsbv(ngs)<a name='9686'>
      real qirmlr(ngs),qirdsv(ngs),qirmlw(ngs)<a name='9687'>
<font color=#447700>!<a name='9688'></font>
      real qgldpv(ngs),qglsbv(ngs)<a name='9689'>
      real qglmlr(ngs),qgldsv(ngs)<a name='9690'>
      real qglwet(ngs),qgldry(ngs),qglshr(ngs)<a name='9691'>
      real qglshrp(ngs)<a name='9692'>
<font color=#447700>!<a name='9693'></font>
      real qgmdpv(ngs),qgmsbv(ngs)<a name='9694'>
      real qgmmlr(ngs),qgmdsv(ngs)<a name='9695'>
      real qgmwet(ngs),qgmdry(ngs),qgmshr(ngs)<a name='9696'>
      real qgmshrp(ngs)<a name='9697'>
      real qghdpv(ngs),qghsbv(ngs)<a name='9698'>
      real qghmlr(ngs),qghdsv(ngs) <a name='9699'>
      real qghwet(ngs),qghdry(ngs),qghshr(ngs)<a name='9700'>
      real qghshrp(ngs)<a name='9701'>
<font color=#447700>!<a name='9702'></font>
      real qrztot(ngs),qrzmax(ngs),qrzfac(ngs)<a name='9703'>
      real qrcev(ngs)<a name='9704'>
      real qrshr(ngs)<a name='9705'>
      real fsw(ngs),fhw(ngs),fhlw(ngs) <font color=#447700>!liquid water fractions<a name='9706'></font>
      real qhcnf(ngs) <a name='9707'>
      real :: qhlcnh(ngs) <font color=#447700>! = 0.0<a name='9708'></font>
      real qhcngh(ngs),qhcngm(ngs),qhcngl(ngs)<a name='9709'>
      <a name='9710'>
      real :: qhcnhl(ngs), chcnhl(ngs), zhcnhl(ngs), vhcnhl(ngs) <font color=#447700>! conversion of low-density hail back to graupel<a name='9711'></font>
<a name='9712'>
      real eiw(ngs),eii(ngs),eiri(ngs),eipir(ngs),eisw(ngs)<a name='9713'>
      real erw(ngs),esw(ngs),eglw(ngs),eghw(ngs),efw(ngs)<a name='9714'>
      real ehxw(ngs),ehlw(ngs),egmw(ngs),ehw(ngs)<a name='9715'>
      real err(ngs),esr(ngs),eglr(ngs),eghr(ngs),efr(ngs)<a name='9716'>
      real ehxr(ngs),ehlr(ngs),egmr(ngs) <a name='9717'>
      real eri(ngs),esi(ngs),egli(ngs),eghi(ngs),efi(ngs)<a name='9718'>
      real ehxi(ngs),ehli(ngs),egmi(ngs),ehi(ngs),ehis(ngs),ehlis(ngs)<a name='9719'>
      real ers(ngs),ess(ngs),egls(ngs),eghs(ngs),efs(ngs),ehs(ngs)<a name='9720'>
      real ehscnv(ngs)<a name='9721'>
      real ehxs(ngs),ehls(ngs),egms(ngs),egmip(ngs) <a name='9722'>
<a name='9723'>
      real ehsclsn(ngs),ehiclsn(ngs),ehisclsn(ngs)<a name='9724'>
      real ehlsclsn(ngs),ehliclsn(ngs),ehlisclsn(ngs)<a name='9725'>
      real esiclsn(ngs)<a name='9726'>
<a name='9727'>
      real :: ehs_collsn = 0.5, ehi_collsn = 1.0<a name='9728'>
      real :: ehls_collsn = 1.0, ehli_collsn = 1.0<a name='9729'>
      real :: esi_collsn = 1.0<a name='9730'>
      <a name='9731'>
      real ew(8,6)<a name='9732'>
      real cwr(8,2)  <font color=#447700>! radius and inverse of interval<a name='9733'></font>
      data cwr / 2.0, 3.0, 4.0, 6.0,  8.0,  10.0, 15.0,  20.0 , &amp; <font color=#447700>! radius<a name='9734'></font>
     &amp;           1.0, 1.0, 0.5, 0.5,  0.5,   0.2,  0.2,  1.  /   <font color=#447700>! inverse of interval<a name='9735'></font>
      integer icwr(ngs), igwr(ngs), irwr(ngs), ihlr(ngs)<a name='9736'>
      real grad(6,2) <font color=#447700>! graupel radius and inverse of interval<a name='9737'></font>
      data grad / 100., 200., 300., 400., 600., 1000.,   &amp;<a name='9738'>
     &amp;            1.e-2,1.e-2,1.e-2,5.e-3,2.5e-3, 1.    /<a name='9739'>
<font color=#447700>!droplet radius: 2     3     4     6     8    10    15    20<a name='9740'></font>
      data ew /0.03, 0.07, 0.17, 0.41, 0.58, 0.69, 0.82, 0.88,  &amp; <font color=#447700>! 100<a name='9741'></font>
<font color=#447700>!     :         0.07, 0.13, 0.27, 0.48, 0.65, 0.73, 0.84, 0.91,  ! 150<a name='9742'></font>
     &amp;         0.10, 0.20, 0.34, 0.58, 0.70, 0.78, 0.88, 0.92,  &amp; <font color=#447700>! 200<a name='9743'></font>
     &amp;         0.15, 0.31, 0.44, 0.65, 0.75, 0.83, 0.96, 0.91,  &amp; <font color=#447700>! 300<a name='9744'></font>
     &amp;         0.17, 0.37, 0.50, 0.70, 0.81, 0.87, 0.93, 0.96,  &amp; <font color=#447700>! 400<a name='9745'></font>
     &amp;         0.17, 0.40, 0.54, 0.71, 0.83, 0.88, 0.94, 0.98,  &amp; <font color=#447700>! 600<a name='9746'></font>
     &amp;         0.15, 0.37, 0.52, 0.74, 0.82, 0.88, 0.94, 0.98 / <font color=#447700>! 1000<a name='9747'></font>
<font color=#447700>!     :         0.11, 0.34, 0.49, 0.71, 0.83, 0.88, 0.94, 0.95 / ! 1400<a name='9748'></font>
<a name='9749'>
<a name='9750'>
      real da0lr(ngs)<a name='9751'>
      real da0lh(ngs)<a name='9752'>
      real da0lhl(ngs)<a name='9753'>
      <a name='9754'>
      real va0 (lc:lqmx)          <font color=#447700>! collection coefficients from Seifert 2005<a name='9755'></font>
      real vab0(lc:lqmx,lc:lqmx)  <font color=#447700>! collection coefficients from Seifert 2005<a name='9756'></font>
      real vab1(lc:lqmx,lc:lqmx)  <font color=#447700>! collection coefficients from Seifert 2005<a name='9757'></font>
      real va1 (lc:lqmx)          <font color=#447700>! collection coefficients from Seifert 2005<a name='9758'></font>
      real ehip(ngs),ehlip(ngs),ehlir(ngs)<a name='9759'>
      real erir(ngs),esir(ngs),eglir(ngs),egmir(ngs),eghir(ngs)<a name='9760'>
      real efir(ngs),ehir(ngs),eirw(ngs),eirir(ngs),ehr(ngs)<a name='9761'>
      real erip(ngs),esip(ngs),eglip(ngs),eghip(ngs)<a name='9762'>
      real efip(ngs),eipi(ngs),eipw(ngs),eipip(ngs)<a name='9763'>
<font color=#447700>!<a name='9764'></font>
<font color=#447700>!  arrays for production terms<a name='9765'></font>
<font color=#447700>!<a name='9766'></font>
      real ptotal(ngs) <font color=#447700>! , pqtot(ngs)<a name='9767'></font>
<font color=#447700>!<a name='9768'></font>
      real pqcwi(ngs),pqcii(ngs),pqrwi(ngs),pqisi(ngs)<a name='9769'>
      real pqswi(ngs),pqhwi(ngs),pqwvi(ngs)<a name='9770'>
      real pqgli(ngs),pqghi(ngs),pqfwi(ngs)<a name='9771'>
      real pqgmi(ngs),pqhli(ngs) <font color=#447700>! ,pqhxi(ngs)<a name='9772'></font>
      real pqiri(ngs),pqipi(ngs) <font color=#447700>! pqwai(ngs),<a name='9773'></font>
      real pqlwsi(ngs),pqlwhi(ngs),pqlwhli(ngs)<a name='9774'>
      <a name='9775'>
      real pvhwi(ngs), pvhwd(ngs)<a name='9776'>
      real pvhli(ngs), pvhld(ngs)<a name='9777'>
      real pvswi(ngs), pvswd(ngs)<a name='9778'>
<font color=#447700>!<a name='9779'></font>
      real pqcwd(ngs),pqcid(ngs),pqrwd(ngs),pqisd(ngs)<a name='9780'>
      real pqswd(ngs),pqhwd(ngs),pqwvd(ngs)<a name='9781'>
      real pqgld(ngs),pqghd(ngs),pqfwd(ngs)<a name='9782'>
      real pqgmd(ngs),pqhld(ngs) <font color=#447700>! ,pqhxd(ngs)<a name='9783'></font>
      real pqird(ngs),pqipd(ngs) <font color=#447700>! pqwad(ngs),<a name='9784'></font>
      real pqlwsd(ngs),pqlwhd(ngs),pqlwhld(ngs)<a name='9785'>
<font color=#447700>!<a name='9786'></font>
<font color=#447700>!      real pqxii(ngs,nhab),pqxid(ngs,nhab)<a name='9787'></font>
<font color=#447700>!<a name='9788'></font>
      real  pctot(ngs)<a name='9789'>
      real  pcipi(ngs), pcipd(ngs)<a name='9790'>
      real  pciri(ngs), pcird(ngs)<a name='9791'>
      real  pccwi(ngs), pccwd(ngs)<a name='9792'>
      real  pccii(ngs), pccid(ngs)<a name='9793'>
      real  pcisi(ngs), pcisd(ngs)<a name='9794'>
      real  pccin(ngs)<a name='9795'>
      real  pcrwi(ngs), pcrwd(ngs)<a name='9796'>
      real  pcswi(ngs), pcswd(ngs)<a name='9797'>
      real  pchwi(ngs), pchwd(ngs)<a name='9798'>
      real  pchli(ngs), pchld(ngs)<a name='9799'>
      real  pcfwi(ngs), pcfwd(ngs)<a name='9800'>
      real  pcgli(ngs), pcgld(ngs)<a name='9801'>
      real  pcgmi(ngs), pcgmd(ngs)<a name='9802'>
      real  pcghi(ngs), pcghd(ngs)<a name='9803'>
<a name='9804'>
      real  pzrwi(ngs), pzrwd(ngs)<a name='9805'>
      real  pzhwi(ngs), pzhwd(ngs)<a name='9806'>
      real  pzhli(ngs), pzhld(ngs)<a name='9807'>
      real  pzswi(ngs), pzswd(ngs)<a name='9808'>
<a name='9809'>
<font color=#447700>!<a name='9810'></font>
<font color=#447700>!  other arrays<a name='9811'></font>
<font color=#447700>!<a name='9812'></font>
      real dqisdt(ngs) <font color=#447700>!,advisc(ngs) !dqwsdt(ngs), ,schm(ngs),pndl(ngs)<a name='9813'></font>
<a name='9814'>
      real qss0(ngs)<a name='9815'>
<a name='9816'>
      real qsacip(ngs)<a name='9817'>
      real pres(ngs),pipert(ngs)<a name='9818'>
      real pk(ngs)<a name='9819'>
      real rho0(ngs),pi0(ngs)<a name='9820'>
      real rhovt(ngs),sqrtrhovt<a name='9821'>
      real thetap(ngs),theta0(ngs),qwvp(ngs),qv0(ngs)<a name='9822'>
      real thsave(ngs)<a name='9823'>
      real ptwfzi(ngs),ptimlw(ngs)<a name='9824'>
      real psub(ngs),pvap(ngs),pfrz(ngs),ptem(ngs),pmlt(ngs),pevap(ngs),pdep(ngs)<a name='9825'>
      <a name='9826'>
      real cnostmp(ngs)   <font color=#447700>! for diagnosed snow intercept<a name='9827'></font>
<font color=#447700>!<a name='9828'></font>
<font color=#447700>!  iholef = 1 to do hole filling technique version 1<a name='9829'></font>
<font color=#447700>!  which uses all hydrometerors to do hole filling of all hydrometeors<a name='9830'></font>
<font color=#447700>!  iholef = 2 to do hole filling technique version 2<a name='9831'></font>
<font color=#447700>!  which uses an individual hydrometeror species to do hole<a name='9832'></font>
<font color=#447700>!  filling of a species of a hydrometeor<a name='9833'></font>
<font color=#447700>!<a name='9834'></font>
<font color=#447700>!  iholen = interval that hole filling is done<a name='9835'></font>
<font color=#447700>!<a name='9836'></font>
      integer  iholef<a name='9837'>
      integer  iholen<a name='9838'>
      parameter (iholef = 1)<a name='9839'>
      parameter (iholen = 1)<a name='9840'>
      real  cqtotn,cqtotn1<a name='9841'>
      real  cctotn<a name='9842'>
      real  citotn<a name='9843'>
      real  crtotn<a name='9844'>
      real  cstotn<a name='9845'>
      real  cvtotn<a name='9846'>
      real  cftotn<a name='9847'>
      real  cgltotn<a name='9848'>
      real  cghtotn<a name='9849'>
      real  chtotn<a name='9850'>
      real  cqtotp,cqtotp1<a name='9851'>
      real  cctotp<a name='9852'>
      real  citotp<a name='9853'>
      real  ciptotp<a name='9854'>
      real  crtotp<a name='9855'>
      real  cstotp<a name='9856'>
      real  cvtotp<a name='9857'>
      real  cftotp<a name='9858'>
      real  chltotp<a name='9859'>
      real  cgltotp<a name='9860'>
      real  cgmtotp<a name='9861'>
      real  cghtotp<a name='9862'>
      real  chtotp<a name='9863'>
      real  cqfac<a name='9864'>
      real  ccfac<a name='9865'>
      real  cifac<a name='9866'>
      real  cipfac<a name='9867'>
      real  crfac<a name='9868'>
      real  csfac<a name='9869'>
      real  cvfac<a name='9870'>
      real  cffac<a name='9871'>
      real  cglfac<a name='9872'>
      real  cghfac<a name='9873'>
      real  chfac<a name='9874'>
      <a name='9875'>
      real ssifac, qvapor<a name='9876'>
<font color=#447700>!<a name='9877'></font>
<font color=#447700>!   Miscellaneous variables<a name='9878'></font>
<font color=#447700>!<a name='9879'></font>
      integer ireadqf,lrho,lqsw,lqgl,lqgm ,lqgh <a name='9880'>
      integer lqrw<a name='9881'>
      real vt<a name='9882'>
      real arg  <font color=#447700>! gamma is a function<a name='9883'></font>
      real erbnd1, fdgt1, costhe1<a name='9884'>
      real qeps<a name='9885'>
      real dyi2,dzi2,cp608,bta1,cnit,dragh,dnz00,pii<a name='9886'>
      real qccrit,gf4br,gf4ds,gf4p5, gf3ds, gf1ds,gr<a name='9887'>
      real gf1palp(ngs) <font color=#447700>! for storing Gamma[1.0 + alphar]<a name='9888'></font>
<a name='9889'>
      <a name='9890'>
      real xdn0(lc:lhab)<a name='9891'>
      real xdn_new,drhodt<a name='9892'>
      <a name='9893'>
      integer l ,ltemq,inumgs, idelq<a name='9894'>
<a name='9895'>
      real brz,arz,temq<a name='9896'>
<a name='9897'>
      real ssival,tqvcon<a name='9898'>
      real cdx(lc:lhab)<a name='9899'>
      real cnox<a name='9900'>
      real cval,aval,eval,fval,gval ,qsign,ftelwc,qconkq<a name='9901'>
      real qconm,qconn,cfce15,gf8,gf4i,gf3p5,gf1a,gf1p5,qdiff,argrcnw<a name='9902'>
      real c4,bradp,bl2,bt2,dtrh,hrifac, hdia0,hdia1,civenta,civentb<a name='9903'>
      real civentc,civentd,civente,civentf,civentg,cireyn,xcivent<a name='9904'>
      real cipventa,cipventb,cipventc,cipventd,cipreyn,cirventa<a name='9905'>
      real cirventb<a name='9906'>
      integer igmrwa,igmrwb,igmswa, igmswb,igmfwa,igmfwb,igmhwa,igmhwb<a name='9907'>
      real rwventa ,rwventb,swventa,swventb,fwventa,fwventb,fwventc<a name='9908'>
      real hwventa,hwventb<a name='9909'>
      real    hwventc, hlventa, hlventb,  hlventc<a name='9910'>
      real  glventa, glventb, glventc<a name='9911'>
      real   gmventa, gmventb,  gmventc, ghventa, ghventb, ghventc<a name='9912'>
      real  dzfacp,  dzfacm,  cmassin,  cwdiar <a name='9913'>
      real  rimmas, rhobar<a name='9914'>
      real   argtim, argqcw, argqxw, argtem<a name='9915'>
      real   frcswsw, frcswgl, frcswgm, frcswgh, frcswfw, frcswsw1<a name='9916'>
      real   frcglgl, frcglgm, frcglgh,  frcglfw, frcglgl1<a name='9917'>
      real   frcgmgl, frcgmgm, frcgmgh,  frcgmfw, frcgmgm1<a name='9918'>
      real   frcghgl, frcghgm, frcghgh,  frcghfw,  frcghgh1<a name='9919'>
      real   frcfwgl, frcfwgm, frcfwgh, frcfwfw,  frcfwfw1<a name='9920'>
      real   frcswrsw, frcswrgl,  frcswrgm,  frcswrgh, frcswrfw<a name='9921'>
      real   frcswrsw1<a name='9922'>
      real   frcrswsw, frcrswgl, frcrswgm, frcrswgh, frcrswfw<a name='9923'>
      real  frcrswsw1<a name='9924'>
      real  frcglrgl, frcglrgm, frcglrgh,  frcglrfw, frcglrgl1<a name='9925'>
      real  frcrglgl<a name='9926'>
      real  frcrglgm,  frcrglgh, frcrglfw, frcrglgl1<a name='9927'>
      real  frcgmrgl, frcgmrgm, frcgmrgh, frcgmrfw,  frcgmrgm1<a name='9928'>
      real  frcrgmgl, frcrgmgm,  frcrgmgh, frcrgmfw, frcrgmgm1<a name='9929'>
      real  sum,  qweps,  gf2a, gf4a, dqldt, dqidt, dqdt<a name='9930'>
      real frcghrgl, frcghrgm, frcghrgh, frcghrfw, frcghrgh1, frcrghgl<a name='9931'>
      real frcrghgm, frcrghgh,  frcrghfw, frcrghgh1<a name='9932'>
      real    a1,a2,a3,a4,a5,a6<a name='9933'>
      real   gamss<a name='9934'>
      real cdw, cdi, denom1, denom2, delqci1, delqip1<a name='9935'>
      real cirtotn,  ciptotn, cgmtotn, chltotn,  cirtotp<a name='9936'>
      real  cgmfac, chlfac,  cirfac<a name='9937'>
      integer igmhla, igmhlb, igmgla, igmglb, igmgma,  igmgmb<a name='9938'>
      integer igmgha, igmghb<a name='9939'>
      integer idqis, item, itim0 <a name='9940'>
      integer  iqgl, iqgm, iqgh, iqrw, iqsw <a name='9941'>
      integer  itertd, ia<a name='9942'>
      <a name='9943'>
      integer :: infdo<a name='9944'>
      <a name='9945'>
      real tau, ewtmp<a name='9946'>
      <a name='9947'>
      integer cntnic_noliq<a name='9948'>
      real     q_noliqmn, q_noliqmx<a name='9949'>
      real     scsacimn, scsacimx<a name='9950'>
      <a name='9951'>
      real :: dtpinv<a name='9952'>
      <a name='9953'>
<font color=#447700>!   arrays for temporary bin space<a name='9954'></font>
<a name='9955'>
      real :: qhmlrtmp,qhmlrtmp2, chmlrtmp, chmlrtmpd1inf, chlmlrtmp, zhlmlrtmp, zhlmlrrtmp, qvs0,tmpcmlt<a name='9956'>
<a name='9957'>
      real :: term1,term2,term3,term4<a name='9958'>
      real :: qaacw <font color=#447700>! combined qsacw-qhacw for WSM6 variation<a name='9959'></font>
<a name='9960'>
<a name='9961'>
<a name='9962'>
<font color=#447700>!<a name='9963'></font>
<font color=#447700>! ####################################################################<a name='9964'></font>
<font color=#447700>!<a name='9965'></font>
<font color=#447700>!  Start routine<a name='9966'></font>
<font color=#447700>!<a name='9967'></font>
<font color=#447700>! ####################################################################<a name='9968'></font>
<a name='9969'>
<a name='9970'>
<a name='9971'>
<font color=#447700>!<a name='9972'></font>
<a name='9973'>
       pb(:) = 0.0<a name='9974'>
       pinit(:) = 0.0<a name='9975'>
      itile = nx<a name='9976'>
      jtile = ny<a name='9977'>
      ktile = nz<a name='9978'>
      ixend = nx<a name='9979'>
      jyend = ny<a name='9980'>
      kzend = nz<a name='9981'>
      nxend = nx + 1<a name='9982'>
      nyend = ny + 1<a name='9983'>
      nzend = nz<a name='9984'>
      kzbeg = 1<a name='9985'>
      nzbeg = 1<a name='9986'>
<a name='9987'>
      istag = 0<a name='9988'>
      jstag = 0<a name='9989'>
      kstag = 1<a name='9990'>
<a name='9991'>
<a name='9992'>
<font color=#447700>!<a name='9993'></font>
<font color=#447700>!  slope intercepts<a name='9994'></font>
<font color=#447700>!<a name='9995'></font>
<a name='9996'>
      IF ( ngs .lt. nz ) THEN<a name='9997'>
<font color=#447700>!       write(0,*) 'Error in ICEZVD: Must have ngs .ge. nz!'<a name='9998'></font>
<font color=#447700>!       STOP<a name='9999'></font>
      ENDIF<a name='10000'>
<a name='10001'>
      cntnic_noliq = 0<a name='10002'>
      q_noliqmn = 0.0<a name='10003'>
      q_noliqmx = 0.0<a name='10004'>
      scsacimn = 0.0<a name='10005'>
      scsacimx = 0.0<a name='10006'>
<a name='10007'>
      ldovol = .false.<a name='10008'>
<a name='10009'>
      DO il = lc,lhab<a name='10010'>
        ldovol = ldovol .or. ( lvol(il) .gt. 1 )<a name='10011'>
      ENDDO<a name='10012'>
<a name='10013'>
<a name='10014'>
<font color=#447700>!      DO il = lc,lhab<a name='10015'></font>
<font color=#447700>!        write(iunit,*) 'delqnxa(',il,') = ',delqnxa(il)<a name='10016'></font>
<font color=#447700>!      ENDDO<a name='10017'></font>
      <a name='10018'>
<font color=#447700>!<a name='10019'></font>
<font color=#447700>!  density maximums and minimums<a name='10020'></font>
<font color=#447700>!<a name='10021'></font>
<a name='10022'>
<font color=#447700>!<a name='10023'></font>
<font color=#447700>!  Set terminal velocities...<a name='10024'></font>
<font color=#447700>!    also set drag coefficients<a name='10025'></font>
<font color=#447700>!<a name='10026'></font>
<a name='10027'>
      dtpinv = 1.d0/dtp<a name='10028'>
<a name='10029'>
<font color=#447700>!<a name='10030'></font>
<a name='10031'>
<font color=#447700>!<a name='10032'></font>
<font color=#447700>!  electricity constants<a name='10033'></font>
<font color=#447700>!<a name='10034'></font>
<font color=#447700>!  mixing ratio epsilon<a name='10035'></font>
<font color=#447700>!<a name='10036'></font>
      qeps  = 1.0e-20<a name='10037'>
<a name='10038'>
<font color=#447700>!  rebound efficiency (erbnd)<a name='10039'></font>
<font color=#447700>!<a name='10040'></font>
<font color=#447700>!<a name='10041'></font>
<font color=#447700>!<a name='10042'></font>
<font color=#447700>!  constants<a name='10043'></font>
<font color=#447700>!<a name='10044'></font>
<a name='10045'>
      cp608 = 0.608<a name='10046'>
      aradcw = -0.27544<a name='10047'>
      bradcw = 0.26249e+06<a name='10048'>
      cradcw = -1.8896e+10<a name='10049'>
      dradcw = 4.4626e+14<a name='10050'>
      bta1 = 0.6<a name='10051'>
      cnit = 1.0e-02<a name='10052'>
      dragh = 0.60<a name='10053'>
      dnz00 = 1.225<a name='10054'>
<font color=#447700>!      cs = 4.83607122<a name='10055'></font>
<font color=#447700>!      ds = 0.25<a name='10056'></font>
<font color=#447700>!  new values for  cs and ds<a name='10057'></font>
      cs = 12.42<a name='10058'>
      ds = 0.42<a name='10059'>
      pii = piinv <font color=#447700>! 1./pi<a name='10060'></font>
      pid4 = pi/4.0 <a name='10061'>
<font color=#447700>!      qscrit = 6.0e-04<a name='10062'></font>
      gf1 = 1.0 <font color=#447700>! gamma(1.0)<a name='10063'></font>
      gf1p5 = 0.8862269255  <font color=#447700>! gamma(1.5)<a name='10064'></font>
      gf2 = 1.0 <font color=#447700>! gamma(2.0)<a name='10065'></font>
      gf3 = 2.0 <font color=#447700>! gamma(3.0)<a name='10066'></font>
      gf3p5 = 3.32335097 <font color=#447700>! gamma(3.5)<a name='10067'></font>
      gf4 = 6.00 <font color=#447700>! gamma(4.0)<a name='10068'></font>
      gf5 = 24.0 <font color=#447700>! gamma(5.0)<a name='10069'></font>
      gf6 = 120.0 <font color=#447700>! gamma(6.0)<a name='10070'></font>
      gf7 = 720.0 <font color=#447700>! gamma(7.0)<a name='10071'></font>
      gf4br = 17.837861981813607 <font color=#447700>! gamma(4.0+br)<a name='10072'></font>
      gf4ds = 10.41688578110938 <font color=#447700>! gamma(4.0+ds)<a name='10073'></font>
      gf4p5 = 11.63172839656745 <font color=#447700>! gamma(4.0+0.5)<a name='10074'></font>
      gf3ds = 3.0458730354120997 <font color=#447700>! gamma(3.0+ds)<a name='10075'></font>
      gf1ds = 0.8863557896089221 <font color=#447700>! gamma(1.0+ds)<a name='10076'></font>
      gr = 9.8<a name='10077'>
      gf43rds = 0.8929795116 <font color=#447700>! gamma(4./3.)<a name='10078'></font>
      gf53rds = 0.9027452930 <font color=#447700>! gamma(5./3.)<a name='10079'></font>
      gf73rds = 1.190639349 <font color=#447700>! gamma(7./3.)<a name='10080'></font>
      gf83rds = 1.504575488 <font color=#447700>! gamma(8./3.)<a name='10081'></font>
      <a name='10082'>
      gamice73fac =  (Gamma_sp(7./3. + cinu))**3/ (Gamma_sp(1. + cinu)**3 * (1. + cinu)**4)<a name='10083'>
      gamsnow73fac =  (Gamma_sp(7./3. + snu))**3/ (Gamma_sp(1. + snu)**3 * (1. + snu)**4)<a name='10084'>
      <a name='10085'>
      gcnup1 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_25">(cnu + 1.)<a name='10086'>
      gcnup2 = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>Gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_26">(cnu + 2.)<a name='10087'>
<font color=#447700>!<a name='10088'></font>
<font color=#447700>!  constants<a name='10089'></font>
<font color=#447700>!<a name='10090'></font>
<font color=#447700>!<a name='10091'></font>
<font color=#447700>!  general constants for microphysics<a name='10092'></font>
<font color=#447700>!<a name='10093'></font>
      brz = 100.0<a name='10094'>
      arz = 0.66<a name='10095'>
      <a name='10096'>
      bfnu1 = (4. + alphar)*(5. + alphar)*(6. + alphar)/ &amp;<a name='10097'>
     &amp;       ((1. + alphar)*(2. + alphar)*(3. + alphar))<a name='10098'>
<a name='10099'>
       galpharaut = (6.+alpharaut)*(5.+alpharaut)*(4.+alpharaut)/ &amp;<a name='10100'>
     &amp;             ((3.+alpharaut)*(2.+alpharaut)*(1.+alpharaut))<a name='10101'>
      <a name='10102'>
      vfrz = 0.523599*(dfrz)**3 <a name='10103'>
      vmlt = Min(xvmx(lr), 0.523599*(dmlt)**3 )<a name='10104'>
      vshd = Min(xvmx(lr), 0.523599*(dshd)**3 )<a name='10105'>
<a name='10106'>
     <a name='10107'>
<a name='10108'>
      tdtol = 1.0e-05<a name='10109'>
      tfrcbw = tfr - cbw<a name='10110'>
      tfrcbi = tfr - cbi<a name='10111'>
<font color=#447700>!<a name='10112'></font>
<font color=#447700>!<a name='10113'></font>
<font color=#447700>! #ifdef COMMAS<a name='10114'></font>
<font color=#447700>!      print*,'ventr,ventc = ',ventr,ventc<a name='10115'></font>
<a name='10116'>
<font color=#447700>!<a name='10117'></font>
<font color=#447700>!  Set up look up tables for supersaturation w.r.t. liq and ice<a name='10118'></font>
<font color=#447700>!<a name='10119'></font>
<font color=#447700>!VD$L SKIP<a name='10120'></font>
<font color=#447700>!      do l = 1,nqsat<a name='10121'></font>
<font color=#447700>!      temq = 163.15 + (l-1)*fqsat<a name='10122'></font>
<font color=#447700>!      tabqvs(l) = exp(caw*(temq-273.15)/(temq-cbw))<a name='10123'></font>
<font color=#447700>!      tabqis(l) = exp(cai*(temq-273.15)/(temq-cbi))<a name='10124'></font>
<font color=#447700>!      end do<a name='10125'></font>
<a name='10126'>
      mltmass1inv = 1.0/( 1000.0*(4.0*pi/3.0)*((0.01*0.5*takshedsize1)**3) ) <font color=#447700>! for drops melting from ice with diameter &gt; 1.9cm<a name='10127'></font>
      mltmass2inv = 1.0/( 1000.0*(4.0*pi/3.0)*((0.01*0.5*takshedsize2)**3) ) <font color=#447700>! for drops melting from ice with 0.9cm &lt; d &lt; 1.9cm<a name='10128'></font>
      mltmass1cgs =  1.0*(4.0*pi/3.0)*((0.5*takshedsize1)**3) <a name='10129'>
      mltmass2cgs =  1.0*(4.0*pi/3.0)*((0.5*takshedsize2)**3) <a name='10130'>
      <a name='10131'>
<font color=#447700>!      real, parameter :: mltdiam1 = 9.0e-3, mltdiam2 = 19.0e-3, mltdiam05 = 4.5e-3<a name='10132'></font>
<a name='10133'>
      IF ( .false. ) THEN<a name='10134'>
        numdiam = 1 <font color=#447700>! must have numdiam &lt; ndiam because numdiam+1 holds values for the interval of mltdiam(numdiam) to mltdiam(ndiam+1)<a name='10135'></font>
        mltdiam(1) = 4.5e-3<a name='10136'>
      ELSEIF ( .true. ) THEN<a name='10137'>
        numdiam = 2 <font color=#447700>! must have numdiam &lt; ndiam because numdiam+1 holds values for the interval of mltdiam(numdiam) to mltdiam(ndiam+1)<a name='10138'></font>
        mltdiam(1) = 1.5e-3<a name='10139'>
        mltdiam(2) = 4.5e-3<a name='10140'>
      ELSE<a name='10141'>
        numdiam = 5 <font color=#447700>! must have numdiam &lt; ndiam because numdiam+1 holds values for the interval of mltdiam(numdiam) to mltdiam(ndiam+1)<a name='10142'></font>
        mltdiam(1) = 0.5e-3<a name='10143'>
        mltdiam(2) = 1.0e-3<a name='10144'>
        mltdiam(3) = 2.0e-3<a name='10145'>
        mltdiam(4) = 4.0e-3<a name='10146'>
        mltdiam(5) = 6.0e-3<a name='10147'>
      ENDIF<a name='10148'>
<a name='10149'>
<a name='10150'>
      mltdiam(ndiam+1) = mltdiam1 <font color=#447700>!  9.0e-3<a name='10151'></font>
      mltdiam(ndiam+2) = mltdiam2 <font color=#447700>! 19.0e-3<a name='10152'></font>
      mltdiam(ndiam+3) = mltdiam3 <font color=#447700>!100.0e-3<a name='10153'></font>
<a name='10154'>
      kzb = 1<a name='10155'>
      kze = ktile<a name='10156'>
<font color=#447700>!      if (kzend .eq. nzend) kze = kzend-kzbeg+1-kstag<a name='10157'></font>
<a name='10158'>
<font color=#447700>!<a name='10159'></font>
<font color=#447700>!  cw constants in mks units<a name='10160'></font>
<font color=#447700>!<a name='10161'></font>
<font color=#447700>!      cwmasn = 4.25e-15  ! radius of 1.0e-6<a name='10162'></font>
      mwfac = 6.0**(1./3.)<a name='10163'>
      IF ( ipconc .ge. 2 ) THEN<a name='10164'>
<font color=#447700>!        cwmasn = xvmn(lc)*1000.<a name='10165'></font>
<font color=#447700>!        cwradn = 1.0e-6<a name='10166'></font>
<font color=#447700>!        cwmasx = xvmx(lc)*1000.<a name='10167'></font>
      ENDIF<a name='10168'>
        rwmasn = xvmn(lr)*1000.<a name='10169'>
        rwmasx = xvmx(lr)*1000.<a name='10170'>
<a name='10171'>
<font color=#447700>!<a name='10172'></font>
<font color=#447700>!  ci constants in mks units<a name='10173'></font>
<font color=#447700>!<a name='10174'></font>
      cimasn = Min(cimas0, cimas1) <font color=#447700>! 12 microns for  0.1871*(xmas(mgs,li)**(0.3429))<a name='10175'></font>
      cimasx = 1.0e-8   <font color=#447700>! 338 microns<a name='10176'></font>
      ccimx = 5000.0e3   <font color=#447700>! max of 5000 per liter<a name='10177'></font>
<a name='10178'>
<font color=#447700>!<a name='10179'></font>
<font color=#447700>!  constants for paramerization<a name='10180'></font>
<font color=#447700>!<a name='10181'></font>
<font color=#447700>!<a name='10182'></font>
<font color=#447700>!  set save counter (number of saves):  nsvcnt<a name='10183'></font>
<font color=#447700>!<a name='10184'></font>
<font color=#447700>!      nsvcnt = 0<a name='10185'></font>
      iend = 0<a name='10186'>
<a name='10187'>
<a name='10188'>
<font color=#447700>!      timetd1 = etime(tarray)<a name='10189'></font>
<font color=#447700>!      timetd1 = tarray(1)<a name='10190'></font>
<a name='10191'>
<font color=#447700>!<a name='10192'></font>
<font color=#447700>!***********************************************************<a name='10193'></font>
<font color=#447700>!  start jy loop<a name='10194'></font>
<font color=#447700>!***********************************************************<a name='10195'></font>
<font color=#447700>!<a name='10196'></font>
<a name='10197'>
<font color=#447700>!      do 9999 jy = 1,ny-jstag<a name='10198'></font>
<font color=#447700>!<a name='10199'></font>
<font color=#447700>!  VERY IMPORTANT:  SET jy = jgs<a name='10200'></font>
<font color=#447700>!<a name='10201'></font>
      jy = jgs<a name='10202'>
     <a name='10203'>
     <a name='10204'>
<font color=#447700>!      t1(:,:,:) = 0<a name='10205'></font>
<font color=#447700>!      t2(:,:,:) = 0<a name='10206'></font>
<font color=#447700>!      t3(:,:,:) = 0<a name='10207'></font>
<font color=#447700>!      t4(:,:,:) = 0<a name='10208'></font>
<font color=#447700>!      t5(:,:,:) = 0<a name='10209'></font>
<font color=#447700>!      t6(:,:,:) = 0<a name='10210'></font>
<font color=#447700>!      t8(:,:,:) = 0<a name='10211'></font>
      <a name='10212'>
      IF ( ipconc &lt; 2 ) THEN <font color=#447700>! Make a copy of cloud droplet mixing ratio to use for homogeneous freezing<a name='10213'></font>
        DO kz = 1,kze<a name='10214'>
         DO ix = 1,itile<a name='10215'>
           t9(ix,jy,kz) = an(ix,jy,kz,lc)<a name='10216'>
         ENDDO<a name='10217'>
        ENDDO<a name='10218'>
      ENDIF<a name='10219'>
      <a name='10220'>
<font color=#447700>!<a name='10221'></font>
<font color=#447700>!..Gather microphysics  <a name='10222'></font>
<font color=#447700>!<a name='10223'></font>
      if ( ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: ENTER GATHER STAGE'<a name='10224'>
<a name='10225'>
<a name='10226'>
      <a name='10227'>
      nxmpb = 1<a name='10228'>
      nzmpb = 1<a name='10229'>
      nxz = itile*nz<a name='10230'>
      numgs = nxz/ngs + 1<a name='10231'>
<font color=#447700>!      write(0,*) 'ICEZVD_GS: ENTER GATHER STAGE: nx,nz,nxz,numgs,ngs = ',nx,nz,nxz,numgs,ngs<a name='10232'></font>
<a name='10233'>
      do 1000 inumgs = 1,numgs<a name='10234'>
      ngscnt = 0<a name='10235'>
      <a name='10236'>
      do kz = nzmpb,kze<a name='10237'>
      do ix = nxmpb,itile<a name='10238'>
<a name='10239'>
      pqs(1) = t00(ix,jy,kz)<a name='10240'>
<font color=#447700>!      pqs(kz) = t00(ix,jy,kz)<a name='10241'></font>
<a name='10242'>
      theta(1) = an(ix,jy,kz,lt)<a name='10243'>
      temg(1) = t0(ix,jy,kz)<a name='10244'>
      temcg(1) = temg(1) - tfr<a name='10245'>
      tqvcon = temg(1)-cbw<a name='10246'>
      ltemq = (temg(1)-163.15)/fqsat+1.5<a name='10247'>
      ltemq = Min( nqsat, Max(1,ltemq) )<a name='10248'>
      qvs(1) = pqs(1)*tabqvs(ltemq)<a name='10249'>
      qis(1) = pqs(1)*tabqis(ltemq)<a name='10250'>
<a name='10251'>
      qss(1) = qvs(1)<a name='10252'>
<a name='10253'>
<font color=#447700>!      IF ( jy .eq. 1 .and. ix .eq. 24 ) THEN<a name='10254'></font>
<font color=#447700>!       write(91,*) 'kz,qv,th: ',kz,an(ix,jy,kz,lv),an(ix,jy,kz,lt),pqs(kz),tabqvs(ltemq),qvs(kz)<a name='10255'></font>
<font color=#447700>!      ENDIF<a name='10256'></font>
<a name='10257'>
      if ( temg(1) .lt. tfr ) then<a name='10258'>
<font color=#447700>!      if( qcw(kz) .le. qxmin(lc) .and. qci(kz) .gt. qxmin(li))<a name='10259'></font>
<font color=#447700>!     &gt;  qss(kz) = qis(kz)<a name='10260'></font>
<font color=#447700>!      if( qcw(kz) .gt. qxmin(lc) .and. qci(kz) .gt. qxmin(li))<a name='10261'></font>
<font color=#447700>!     &gt;   qss(kz) = (qcw(kz)*qvs(kz) + qci(kz)*qis(kz)) /<a name='10262'></font>
<font color=#447700>!     &gt;   (qcw(kz) + qci(kz))<a name='10263'></font>
      qss(1) = qis(1)<a name='10264'>
      else<a name='10265'>
<font color=#447700>!       IF ( an(ix,jy,kz,lv)  .gt. qss(kz) ) THEN<a name='10266'></font>
<font color=#447700>!       write(iunit,*) 'qss exceeded at ',ix,jy,kz,qss(kz),an(ix,jy,kz,lv),temg(kz)<a name='10267'></font>
<font color=#447700>!       write(iunit,*) 'other temg = ',theta(kz)*(pinit(kz)+p2(ix,jy,kz))<a name='10268'></font>
<font color=#447700>!       ENDIF<a name='10269'></font>
      end if<a name='10270'>
<font color=#447700>!<a name='10271'></font>
      ishail = .false.<a name='10272'>
      IF ( lhl &gt; 1 ) THEN<a name='10273'>
        IF ( an(ix,jy,kz,lhl)  .gt. qxmin(lhl) ) ishail = .true.<a name='10274'>
      ENDIF<a name='10275'>
      <a name='10276'>
      if ( an(ix,jy,kz,lv)  .gt. qss(1) .or.   &amp;<a name='10277'>
     &amp;     an(ix,jy,kz,lc)  .gt. qxmin(lc)   .or.    &amp;<a name='10278'>
     &amp;     an(ix,jy,kz,li)  .gt. qxmin(li)   .or.   &amp;<a name='10279'>
     &amp;     an(ix,jy,kz,lr)  .gt. qxmin(lr)   .or.   &amp;<a name='10280'>
     &amp;     an(ix,jy,kz,ls)  .gt. qxmin(ls)   .or.   &amp;<a name='10281'>
     &amp;     an(ix,jy,kz,lh)  .gt. qxmin(lh)   .or.  ishail ) then<a name='10282'>
      ngscnt = ngscnt + 1<a name='10283'>
      igs(ngscnt) = ix<a name='10284'>
      kgs(ngscnt) = kz<a name='10285'>
      if ( ngscnt .eq. ngs ) goto 1100<a name='10286'>
      end if<a name='10287'>
      enddo <font color=#447700>!ix<a name='10288'></font>
      nxmpb = 1<a name='10289'>
      enddo <font color=#447700>!kz<a name='10290'></font>
 1100 continue<a name='10291'>
<a name='10292'>
      if ( ngscnt .eq. 0 ) go to 9998<a name='10293'>
<a name='10294'>
      if ( ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: dbg = 5'<a name='10295'>
<a name='10296'>
<font color=#447700>!      write(0,*) 'allocating qc<a name='10297'></font>
<a name='10298'>
      <a name='10299'>
      xv(:,:) = 0.0<a name='10300'>
      xmas(:,:) = 0.0<a name='10301'>
      vtxbar(:,:,:) = 0.0<a name='10302'>
      xdia(:,:,:) = 0.0<a name='10303'>
      raindn(:,:) = 900.<a name='10304'>
      cx(:,:) = 0.0<a name='10305'>
      alpha(:,:) = 0.0<a name='10306'>
      DO il = li,lhab<a name='10307'>
        DO mgs = 1,ngscnt<a name='10308'>
          rimdn(mgs,il)  = rimedens <font color=#447700>! xdn0(il)<a name='10309'></font>
        ENDDO<a name='10310'>
      ENDDO<a name='10311'>
<font color=#447700>!<a name='10312'></font>
<font color=#447700>!  define temporaries for state variables to be used in calculations<a name='10313'></font>
<font color=#447700>!<a name='10314'></font>
      do mgs = 1,ngscnt<a name='10315'>
      kgsm(mgs) = max(kgs(mgs)-1,1)<a name='10316'>
      kgsp(mgs) = min(kgs(mgs)+1,nz-1)<a name='10317'>
      kgsm2(mgs) = Max(kgs(mgs)-2,1)<a name='10318'>
      theta0(mgs) = an(igs(mgs),jy,kgs(mgs),lt)<a name='10319'>
      thetap(mgs) = an(igs(mgs),jy,kgs(mgs),lt) - theta0(mgs)<a name='10320'>
      theta(mgs) = an(igs(mgs),jy,kgs(mgs),lt)<a name='10321'>
      qv0(mgs) = an(igs(mgs),jy,kgs(mgs),lv)<a name='10322'>
      qwvp(mgs) = an(igs(mgs),jy,kgs(mgs),lv)  - qv0(mgs) <font color=#447700>! qv0(mgs) is full qv, so qwvp starts as zero!<a name='10323'></font>
<a name='10324'>
      pres(mgs) = pn(igs(mgs),jy,kgs(mgs)) + pb(kgs(mgs))<a name='10325'>
      pipert(mgs) = p2(igs(mgs),jy,kgs(mgs))<a name='10326'>
      rho0(mgs) = dn(igs(mgs),jy,kgs(mgs))<a name='10327'>
      rhoinv(mgs) = 1.0/rho0(mgs)<a name='10328'>
      rhovt(mgs) = Sqrt(rho00/rho0(mgs))<a name='10329'>
      pi0(mgs) = p2(igs(mgs),jy,kgs(mgs)) + pinit(kgs(mgs))<a name='10330'>
      temg(mgs) = t0(igs(mgs),jy,kgs(mgs))<a name='10331'>
      temgkm1(mgs) = t0(igs(mgs),jy,kgsm(mgs))<a name='10332'>
      temgkm2(mgs) = t0(igs(mgs),jy,kgsm2(mgs))<a name='10333'>
      pk(mgs)   = p2(igs(mgs),jy,kgs(mgs)) + pinit(kgs(mgs)) <font color=#447700>! t77(igs(mgs),jy,kgs(mgs))<a name='10334'></font>
      temcg(mgs) = temg(mgs) - tfr<a name='10335'>
      qss0(mgs) = (380.0)/(pres(mgs))<a name='10336'>
      pqs(mgs) = (380.0)/(pres(mgs))<a name='10337'>
      ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='10338'>
      ltemq = Min( nqsat, Max(1,ltemq) )<a name='10339'>
      qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='10340'>
      qis(mgs) = pqs(mgs)*tabqis(ltemq)<a name='10341'>
<font color=#447700>!      es(mgs)  = 6.1078e2*tabqvs(ltemq)<a name='10342'></font>
<font color=#447700>!      eis(mgs) = 6.1078e2*tabqis(ltemq)<a name='10343'></font>
      cnostmp(mgs) = cno(ls)<a name='10344'>
<font color=#447700>!<a name='10345'></font>
<a name='10346'>
      il5(mgs) = 0<a name='10347'>
      if ( temg(mgs) .lt. tfr ) then<a name='10348'>
      il5(mgs) = 1<a name='10349'>
      end if<a name='10350'>
      enddo <font color=#447700>!mgs<a name='10351'></font>
      <a name='10352'>
      IF ( ipconc &lt; 1 .and. lwsm6 ) THEN<a name='10353'>
        DO mgs = 1,ngscnt<a name='10354'>
          tmp = Min( 0.0, temcg(mgs) )<a name='10355'>
          cnostmp(mgs) = Min( 2.e8, 2.e6*exp(0.12*tmp) )<a name='10356'>
        ENDDO<a name='10357'>
      ENDIF<a name='10358'>
<a name='10359'>
<a name='10360'>
<font color=#447700>!<a name='10361'></font>
<font color=#447700>! zero arrays that are used but not otherwise set (tm)<a name='10362'></font>
<font color=#447700>!<a name='10363'></font>
      do mgs = 1,ngscnt<a name='10364'>
         qhshr(mgs) = 0.0 <a name='10365'>
       end do<a name='10366'>
<font color=#447700>!<a name='10367'></font>
<font color=#447700>!  set temporaries for microphysics variables<a name='10368'></font>
<font color=#447700>!<a name='10369'></font>
      DO il = lv,lhab<a name='10370'>
      do mgs = 1,ngscnt<a name='10371'>
        qx(mgs,il) = max(an(igs(mgs),jy,kgs(mgs),il), 0.0) <a name='10372'>
      ENDDO<a name='10373'>
      end do<a name='10374'>
<a name='10375'>
      qxw(:,:) = 0.0<a name='10376'>
<a name='10377'>
<a name='10378'>
<a name='10379'>
        scx(:,:) = 0.0<a name='10380'>
<font color=#447700>!<a name='10381'></font>
<font color=#447700>!  set shape parameters<a name='10382'></font>
<font color=#447700>!<a name='10383'></font>
      IF ( imurain == 1 ) THEN<a name='10384'>
        alpha(:,lr) = alphar<a name='10385'>
      ELSEIF ( imurain == 3 ) THEN<a name='10386'>
        alpha(:,lr) = xnu(lr)<a name='10387'>
      ENDIF<a name='10388'>
      <a name='10389'>
      alpha(:,li) = xnu(li)<a name='10390'>
<a name='10391'>
      IF ( imusnow == 1 ) THEN<a name='10392'>
        alpha(:,ls) = alphas<a name='10393'>
      ELSEIF ( imusnow == 3 ) THEN<a name='10394'>
        alpha(:,ls) = xnu(ls)<a name='10395'>
      ENDIF<a name='10396'>
      <a name='10397'>
      DO il = lc,lhab<a name='10398'>
      do mgs = 1,ngscnt<a name='10399'>
        IF ( il .ge. lg ) alpha(mgs,il) = dnu(il)<a name='10400'>
        DO ic = lr,lhab<a name='10401'>
        dab0lh(mgs,il,ic) = dab0(ic,il)<a name='10402'>
        dab1lh(mgs,il,ic) = dab1(ic,il)<a name='10403'>
        ENDDO<a name='10404'>
      ENDDO<a name='10405'>
      end do<a name='10406'>
      <a name='10407'>
      <a name='10408'>
<font color=#447700>!      DO mgs = 1,ngscnt<a name='10409'></font>
        da0lh(:) = da0(lh)<a name='10410'>
        da0lr(:) = da0(lr)<a name='10411'>
        IF ( lzh &lt; 1 .or. lzhl &lt; 1 ) THEN<a name='10412'>
          rzxhlh(:) = rzhl/rz<a name='10413'>
        ELSEIF ( lzh &gt; 1 .and. lzhl &gt; 1 ) THEN<a name='10414'>
          rzxhlh(:) = 1.<a name='10415'>
        ENDIF<a name='10416'>
        IF ( lzr &gt; 1 ) THEN<a name='10417'>
          rzxh(:) = 1.<a name='10418'>
          rzxhl(:) = 1.<a name='10419'>
        ELSE<a name='10420'>
          rzxh(:) = rz<a name='10421'>
          rzxhl(:) = rzhl<a name='10422'>
        ENDIF<a name='10423'>
        <a name='10424'>
        IF ( imurain == 1 .and. imusnow == 3 ) THEN<a name='10425'>
          rzxs(:) = rzs<a name='10426'>
        ELSEIF ( imurain == imusnow ) THEN<a name='10427'>
          rzxs(:) = 1.<a name='10428'>
        ENDIF<a name='10429'>
 <font color=#447700>!     ENDDO<a name='10430'></font>
      <a name='10431'>
      IF ( lhl .gt. 1 ) THEN<a name='10432'>
      DO mgs = 1,ngscnt<a name='10433'>
        da0lhl(mgs) = da0(lhl)<a name='10434'>
      ENDDO<a name='10435'>
      ENDIF<a name='10436'>
      <a name='10437'>
      ventrx(:) = ventr<a name='10438'>
      ventrxn(:) = ventrn<a name='10439'>
      gf1palp(:) = <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMMA_SP'>gamma_sp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_SP_27">(1.0 + alphar)<a name='10440'>
<a name='10441'>
<font color=#447700>!<a name='10442'></font>
<font color=#447700>!  set concentrations<a name='10443'></font>
<font color=#447700>!<a name='10444'></font>
<font color=#447700>!      ssmax = 0.0<a name='10445'></font>
      <a name='10446'>
      <a name='10447'>
      <a name='10448'>
      if ( ipconc .ge. 1 ) then<a name='10449'>
       do mgs = 1,ngscnt<a name='10450'>
        cx(mgs,li) = Max(an(igs(mgs),jy,kgs(mgs),lni), 0.0)<a name='10451'>
        IF ( lcina .gt. 1 ) THEN<a name='10452'>
         cina(mgs) = an(igs(mgs),jy,kgs(mgs),lcina)<a name='10453'>
        ELSE<a name='10454'>
         cina(mgs) = cx(mgs,li)<a name='10455'>
        ENDIF<a name='10456'>
        IF ( lcin &gt; 1 ) THEN<a name='10457'>
         ccin(mgs) = an(igs(mgs),jy,kgs(mgs),lcin)<a name='10458'>
        ENDIF<a name='10459'>
       end do<a name='10460'>
      end if<a name='10461'>
      if ( ipconc .ge. 2 ) then<a name='10462'>
       do mgs = 1,ngscnt<a name='10463'>
        cx(mgs,lc) = Max(an(igs(mgs),jy,kgs(mgs),lnc), 0.0)<a name='10464'>
<font color=#447700>!        cx(mgs,lc) = Min( ccwmx, cx(mgs,lc) )<a name='10465'></font>
        IF ( lss &gt; 1 ) THEN<a name='10466'>
        ssmax(mgs) = an(igs(mgs),jy,kgs(mgs),lss)<a name='10467'>
        ENDIF<a name='10468'>
        IF ( lccn .gt. 1 ) THEN<a name='10469'>
         ccnc(mgs) = an(igs(mgs),jy,kgs(mgs),lccn)<a name='10470'>
        ELSE<a name='10471'>
         ccnc(mgs) = 0.0<a name='10472'>
        ENDIF<a name='10473'>
        IF ( lccna .gt. 1 ) THEN<a name='10474'>
         ccna(mgs) = an(igs(mgs),jy,kgs(mgs),lccna)<a name='10475'>
        ELSE<a name='10476'>
         ccna(mgs) = cx(mgs,lc)<a name='10477'>
        ENDIF<a name='10478'>
       end do<a name='10479'>
<font color=#447700>!       ELSE<a name='10480'></font>
<font color=#447700>!       cx(mgs,lc) = Abs(ccn)<a name='10481'></font>
      end if<a name='10482'>
      if ( ipconc .ge. 3 ) then<a name='10483'>
       do mgs = 1,ngscnt<a name='10484'>
        cx(mgs,lr) = Max(an(igs(mgs),jy,kgs(mgs),lnr), 0.0)<a name='10485'>
        IF ( qx(mgs,lr) .le. qxmin(lr) ) THEN<a name='10486'>
<font color=#447700>!          cx(mgs,lr) = 0.0<a name='10487'></font>
        ELSEIF ( cx(mgs,lr) .eq. 0.0 .and. qx(mgs,lr) .lt. 3.0*qxmin(lr) ) THEN<a name='10488'>
          qx(mgs,lv) = qx(mgs,lv) + qx(mgs,lr)<a name='10489'>
          qx(mgs,lr) = 0.0<a name='10490'>
        ELSE<a name='10491'>
          cx(mgs,lr) = Max( 1.e-9, cx(mgs,lr) )<a name='10492'>
        ENDIF<a name='10493'>
       end do<a name='10494'>
      end if<a name='10495'>
      if ( ipconc .ge. 4 ) then<a name='10496'>
       do mgs = 1,ngscnt<a name='10497'>
        cx(mgs,ls) = Max(an(igs(mgs),jy,kgs(mgs),lns), 0.0)<a name='10498'>
        IF ( qx(mgs,ls) .le. qxmin(ls) ) THEN<a name='10499'>
<font color=#447700>!          cx(mgs,ls) = 0.0<a name='10500'></font>
        ELSEIF ( cx(mgs,ls) .eq. 0.0 .and. qx(mgs,ls) .lt. 3.0*qxmin(ls) ) THEN<a name='10501'>
          qx(mgs,lv) = qx(mgs,lv) + qx(mgs,ls)<a name='10502'>
          qx(mgs,ls) = 0.0<a name='10503'>
        ELSE<a name='10504'>
          cx(mgs,ls) = Max( 1.e-9, cx(mgs,ls) )<a name='10505'>
<a name='10506'>
         IF ( ilimit .ge. ipc(ls) ) THEN<a name='10507'>
            tmp = (xdn0(ls)*cx(mgs,ls))/(rho0(mgs)*qx(mgs,ls))<a name='10508'>
            tmp2 = (tmp*(3.14159))**(1./3.)<a name='10509'>
            cnox = cx(mgs,ls)*(tmp2)<a name='10510'>
         IF ( cnox .gt. 3.0*cno(ls) ) THEN<a name='10511'>
           cx(mgs,ls) = 3.0*cno(ls)/tmp2<a name='10512'>
         ENDIF<a name='10513'>
         ENDIF<a name='10514'>
        ENDIF<a name='10515'>
       end do<a name='10516'>
      end if<a name='10517'>
      if ( ipconc .ge. 5 ) then<a name='10518'>
       do mgs = 1,ngscnt<a name='10519'>
<a name='10520'>
        cx(mgs,lh) = Max(an(igs(mgs),jy,kgs(mgs),lnh), 0.0)<a name='10521'>
        IF ( qx(mgs,lh) .le. qxmin(lh) ) THEN<a name='10522'>
<font color=#447700>!          cx(mgs,lh) = 0.0<a name='10523'></font>
        ELSEIF ( cx(mgs,lh) .eq. 0.0 .and. qx(mgs,lh) .lt. 3.0*qxmin(lh) ) THEN<a name='10524'>
          qx(mgs,lv) = qx(mgs,lv) + qx(mgs,lh) <a name='10525'>
          qx(mgs,lh) = 0.0<a name='10526'>
        ELSE<a name='10527'>
          cx(mgs,lh) = Max( 1.e-9, cx(mgs,lh) )<a name='10528'>
         IF ( ilimit .ge. ipc(lh) ) THEN<a name='10529'>
            tmp = (xdn0(lh)*cx(mgs,lh))/(rho0(mgs)*qx(mgs,lh))<a name='10530'>
            tmp2 = (tmp*(3.14159))**(1./3.)<a name='10531'>
            cnox = cx(mgs,lh)*(tmp2)<a name='10532'>
         IF ( cnox .gt. 3.0*cno(lh) ) THEN<a name='10533'>
           cx(mgs,lh) = 3.0*cno(lh)/tmp2<a name='10534'>
         ENDIF<a name='10535'>
         ENDIF<a name='10536'>
        ENDIF<a name='10537'>
       end do<a name='10538'>
      end if<a name='10539'>
<a name='10540'>
      if ( lhl .gt. 1 .and. ipconc .ge. 5 ) then<a name='10541'>
       do mgs = 1,ngscnt<a name='10542'>
<a name='10543'>
        cx(mgs,lhl) = Max(an(igs(mgs),jy,kgs(mgs),lnhl), 0.0)<a name='10544'>
        IF ( qx(mgs,lhl) .le. qxmin(lhl) ) THEN<a name='10545'>
          cx(mgs,lhl) = 0.0<a name='10546'>
        ELSEIF ( cx(mgs,lhl) .eq. 0.0 .and. qx(mgs,lhl) .lt. 3.0*qxmin(lhl) ) THEN<a name='10547'>
          qx(mgs,lv) = qx(mgs,lv) + qx(mgs,lhl) <a name='10548'>
          qx(mgs,lhl) = 0.0<a name='10549'>
        ELSE<a name='10550'>
          cx(mgs,lhl) = Max( 1.e-9, cx(mgs,lhl) )<a name='10551'>
         IF ( ilimit .ge. ipc(lhl) ) THEN<a name='10552'>
            tmp = (xdn0(lhl)*cx(mgs,lhl))/(rho0(mgs)*qx(mgs,lhl))<a name='10553'>
            tmp2 = (tmp*(3.14159))**(1./3.)<a name='10554'>
            cnox = cx(mgs,lhl)*(tmp2)<a name='10555'>
         IF ( cnox .gt. 3.0*cno(lhl) ) THEN<a name='10556'>
           cx(mgs,lhl) = 3.0*cno(lhl)/tmp2<a name='10557'>
         ENDIF<a name='10558'>
         ENDIF<a name='10559'>
        ENDIF<a name='10560'>
       end do<a name='10561'>
      end if<a name='10562'>
<a name='10563'>
<font color=#447700>!<a name='10564'></font>
<font color=#447700>! Set mean particle volume<a name='10565'></font>
<font color=#447700>!<a name='10566'></font>
      IF ( ldovol ) THEN<a name='10567'>
      <a name='10568'>
      vx(:,:) = 0.0<a name='10569'>
      <a name='10570'>
       DO il = li,lhab<a name='10571'>
        <a name='10572'>
        IF ( lvol(il) .ge. 1 ) THEN<a name='10573'>
        <a name='10574'>
          DO mgs = 1,ngscnt<a name='10575'>
            vx(mgs,il) = Max(an(igs(mgs),jy,kgs(mgs),lvol(il)), 0.0)<a name='10576'>
          ENDDO<a name='10577'>
<a name='10578'>
        ENDIF<a name='10579'>
<a name='10580'>
       ENDDO<a name='10581'>
<a name='10582'>
      ENDIF<a name='10583'>
<a name='10584'>
<a name='10585'>
<a name='10586'>
<a name='10587'>
<a name='10588'>
<font color=#447700>!<a name='10589'></font>
<font color=#447700>!  set factors<a name='10590'></font>
<font color=#447700>!<a name='10591'></font>
      do mgs = 1,ngscnt<a name='10592'>
<font color=#447700>!<a name='10593'></font>
      ssi(mgs) = qx(mgs,lv)/qis(mgs)<a name='10594'>
      ssw(mgs) = qx(mgs,lv)/qvs(mgs)<a name='10595'>
<font color=#447700>!<a name='10596'></font>
      tsqr(mgs) = temg(mgs)**2<a name='10597'>
<font color=#447700>!<a name='10598'></font>
      temgx(mgs) = min(temg(mgs),313.15)<a name='10599'>
      temgx(mgs) = max(temgx(mgs),233.15)<a name='10600'>
      felv(mgs) = 2500837.367 * (273.15/temgx(mgs))**((0.167)+(3.67e-4)*temgx(mgs))<a name='10601'>
<font color=#447700>!<a name='10602'></font>
      temcgx(mgs) = min(temg(mgs),273.15)<a name='10603'>
      temcgx(mgs) = max(temcgx(mgs),223.15)<a name='10604'>
      temcgx(mgs) = temcgx(mgs)-273.15<a name='10605'>
<a name='10606'>
<font color=#447700>! felf = latent heat of fusion, fels = LH of sublimation, felv = LH of vaporization<a name='10607'></font>
      felf(mgs) = 333690.6098 + (2030.61425)*temcgx(mgs) - (10.46708312)*temcgx(mgs)**2<a name='10608'>
<font color=#447700>!<a name='10609'></font>
      fels(mgs) = felv(mgs) + felf(mgs)<a name='10610'>
<font color=#447700>!<a name='10611'></font>
      felvs(mgs) = felv(mgs)*felv(mgs)<a name='10612'>
      felss(mgs) = fels(mgs)*fels(mgs)<a name='10613'>
      <a name='10614'>
        IF ( eqtset &lt;= 1 ) THEN<a name='10615'>
          felvcp(mgs) = felv(mgs)*cpi<a name='10616'>
          felscp(mgs) = fels(mgs)*cpi<a name='10617'>
          felfcp(mgs) = felf(mgs)*cpi<a name='10618'>
        ELSE<a name='10619'>
          <a name='10620'>
          <font color=#447700>! equations from appendix in Bryan and Morrison (2012, MWR)<a name='10621'></font>
          <font color=#447700>! note that rw is Rv in the paper, and rd is R.<a name='10622'></font>
          <a name='10623'>
          tmp = qx(mgs,li)+qx(mgs,ls)+qx(mgs,lh)<a name='10624'>
          IF ( lhl &gt; 1 ) tmp = tmp + qx(mgs,lhl)<a name='10625'>
          cvm = cv+cvv*qx(mgs,lv)+cpl*(qx(mgs,lc)+qx(mgs,lr))   &amp;<a name='10626'>
                                  +cpigb*(tmp)<a name='10627'>
<a name='10628'>
          IF ( eqtset == 2 ) THEN <font color=#447700>! compact form from treating dT/dt = theta*d(pi)/dt + pi*d(theta)dt and then applied to theta assuming constant pi<a name='10629'></font>
          felvcp(mgs) = (felv(mgs)-rw*temg(mgs))/cvm<a name='10630'>
          felscp(mgs) = (fels(mgs)-rw*temg(mgs))/cvm<a name='10631'>
          felfcp(mgs) = felf(mgs)/cvm<a name='10632'>
          <a name='10633'>
          ELSE<a name='10634'>
           <font color=#447700>! equivalent version that applies separate updates of latent heating to theta and pi, when both are returned.<a name='10635'></font>
<a name='10636'>
          cpm = cp+cpv*qx(mgs,lv)+cpl*(qx(mgs,lc)+qx(mgs,lr))   &amp;<a name='10637'>
                                  +cpigb*(tmp)<a name='10638'>
          rmm=rd+rw*qx(mgs,lv)<a name='10639'>
          <a name='10640'>
          felvcp(mgs) = (felv(mgs)*cv/(cp) - rw*temg(mgs)*(1.0-rovcp*cpm/rmm))/cvm<a name='10641'>
          felscp(mgs) = (fels(mgs)*cv/(cp) - rw*temg(mgs)*(1.0-rovcp*cpm/rmm))/cvm<a name='10642'>
          felfcp(mgs) = felf(mgs)*cv/(cp*cvm)<a name='10643'>
<a name='10644'>
          felvpi(mgs) = pi0(mgs)*rovcp*(felv(mgs)/(temg(mgs)) - rw*cpm/rmm)/cvm<a name='10645'>
          felspi(mgs) = pi0(mgs)*rovcp*(fels(mgs)/(temg(mgs)) - rw*cpm/rmm)/cvm <a name='10646'>
          felfpi(mgs) = pi0(mgs)*rovcp*(felf(mgs)/(cvm*temg(mgs)))<a name='10647'>
          <a name='10648'>
          ENDIF<a name='10649'>
<a name='10650'>
        ENDIF<a name='10651'>
<font color=#447700>!<a name='10652'></font>
      fgamw(mgs) = felvcp(mgs)/pi0(mgs)<a name='10653'>
      fgams(mgs) = felscp(mgs)/pi0(mgs)<a name='10654'>
<font color=#447700>!<a name='10655'></font>
      fcqv1(mgs) = 4098.0258*pi0(mgs)*fgamw(mgs)<a name='10656'>
      fcqv2(mgs) = 5807.6953*pi0(mgs)*fgams(mgs)<a name='10657'>
      fcc3(mgs) = felfcp(mgs)/pi0(mgs)<a name='10658'>
<font color=#447700>!<a name='10659'></font>
<font color=#447700>!  fwvdf = water vapor diffusivity<a name='10660'></font>
      fwvdf(mgs) = (2.11e-05)*((temg(mgs)/tfr)**1.94)*(101325.0/(pres(mgs)))<a name='10661'>
<font color=#447700>!<a name='10662'></font>
<font color=#447700>! fadvisc = kinematic viscosity<a name='10663'></font>
      fadvisc(mgs) = advisc0*(416.16/(temg(mgs)+120.0))*(temg(mgs)/296.0)**(1.5) <font color=#447700>! dynamic visc.<a name='10664'></font>
<font color=#447700>!<a name='10665'></font>
      fakvisc(mgs) = fadvisc(mgs)*rhoinv(mgs) <font color=#447700>! divide by rho_air to get kinematic visc. (note the 'k' vs. 'd')<a name='10666'></font>
<font color=#447700>!<a name='10667'></font>
      temcgx(mgs) = min(temg(mgs),273.15)<a name='10668'>
      temcgx(mgs) = max(temcgx(mgs),233.15)<a name='10669'>
      temcgx(mgs) = temcgx(mgs)-273.15<a name='10670'>
      fci(mgs) = (2.118636 + 0.007371*(temcgx(mgs)))*(1.0e+03)<a name='10671'>
<font color=#447700>!<a name='10672'></font>
      if ( temg(mgs) .lt. 273.15 ) then<a name='10673'>
      temcgx(mgs) = min(temg(mgs),273.15)<a name='10674'>
      temcgx(mgs) = max(temcgx(mgs),233.15)<a name='10675'>
      temcgx(mgs) = temcgx(mgs)-273.15<a name='10676'>
      fcw(mgs) = 4203.1548  + (1.30572e-2)*((temcgx(mgs)-35.)**2)   &amp;<a name='10677'>
     &amp;                 + (1.60056e-5)*((temcgx(mgs)-35.)**4)<a name='10678'>
      end if<a name='10679'>
      if ( temg(mgs) .ge. 273.15 ) then<a name='10680'>
      temcgx(mgs) = min(temg(mgs),308.15)<a name='10681'>
      temcgx(mgs) = max(temcgx(mgs),273.15)<a name='10682'>
      temcgx(mgs) = temcgx(mgs)-273.15<a name='10683'>
      fcw(mgs) = 4243.1688  + (3.47104e-1)*(temcgx(mgs)**2)<a name='10684'>
      end if<a name='10685'>
<font color=#447700>!<a name='10686'></font>
      ftka(mgs) = tka0*fadvisc(mgs)/advisc1  <font color=#447700>! thermal conductivity: proportional to dynamic viscosity<a name='10687'></font>
      fthdf(mgs) = ftka(mgs)*cpi*rhoinv(mgs)<a name='10688'>
<font color=#447700>!<a name='10689'></font>
      fschm(mgs) = (fakvisc(mgs)/fwvdf(mgs))  <font color=#447700>! Schmidt number<a name='10690'></font>
      fpndl(mgs) = (fakvisc(mgs)/fthdf(mgs))  <font color=#447700>! Prandl number (not used)<a name='10691'></font>
<font color=#447700>!<a name='10692'></font>
      fai(mgs) = (fels(mgs)**2)/(ftka(mgs)*rw*temg(mgs)**2)<a name='10693'>
      fbi(mgs) = (1.0/(rho0(mgs)*fwvdf(mgs)*qis(mgs)))<a name='10694'>
      fav(mgs) = (felv(mgs)**2)/(ftka(mgs)*rw*temg(mgs)**2)<a name='10695'>
      fbv(mgs) = (1.0/(rho0(mgs)*fwvdf(mgs)*qvs(mgs)))<a name='10696'>
<font color=#447700>!<a name='10697'></font>
      end do<a name='10698'>
<font color=#447700>!<a name='10699'></font>
<font color=#447700>!<a name='10700'></font>
<font color=#447700>!   ice habit fractions<a name='10701'></font>
<font color=#447700>!<a name='10702'></font>
<font color=#447700>!<a name='10703'></font>
<font color=#447700>!<a name='10704'></font>
<font color=#447700>!  Set density<a name='10705'></font>
<font color=#447700>!<a name='10706'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: Set density'<a name='10707'>
<font color=#447700>!<a name='10708'></font>
<a name='10709'>
      do mgs = 1,ngscnt<a name='10710'>
        xdn(mgs,li) = xdn0(li)<a name='10711'>
        xdn(mgs,lc) = xdn0(lc)<a name='10712'>
        xdn(mgs,lr) = xdn0(lr)<a name='10713'>
        xdn(mgs,ls) = xdn0(ls)<a name='10714'>
        xdn(mgs,lh) = xdn0(lh)<a name='10715'>
        IF ( lvol(ls) .gt. 1 ) THEN<a name='10716'>
         IF ( vx(mgs,ls) .gt. 0.0 .and. qx(mgs,ls) .gt. qxmin(ls) ) THEN<a name='10717'>
           xdn(mgs,ls) = Min( xdnmx(ls), Max( xdnmn(ls), rho0(mgs)*qx(mgs,ls)/vx(mgs,ls) ) )<a name='10718'>
         ENDIF<a name='10719'>
        ENDIF<a name='10720'>
<a name='10721'>
        IF ( lvol(lh) .gt. 1 ) THEN<a name='10722'>
         IF ( vx(mgs,lh) .gt. 0.0 .and. qx(mgs,lh) .gt. qxmin(lh) ) THEN<a name='10723'>
           IF ( mixedphase ) THEN<a name='10724'>
           ELSE<a name='10725'>
             dnmx = xdnmx(lh)<a name='10726'>
           ENDIF<a name='10727'>
           xdn(mgs,lh) = Min( dnmx, Max( xdnmn(lh), rho0(mgs)*qx(mgs,lh)/vx(mgs,lh) ) )<a name='10728'>
           vx(mgs,lh) = rho0(mgs)*qx(mgs,lh)/xdn(mgs,lh)<a name='10729'>
         <a name='10730'>
         ELSEIF ( vx(mgs,lh) == 0.0 .and. qx(mgs,lh) .gt. qxmin(lh) ) THEN <font color=#447700>! if volume is zero, need to initialize the default value<a name='10731'></font>
<a name='10732'>
           vx(mgs,lh) = rho0(mgs)*qx(mgs,lh)/xdn(mgs,lh)<a name='10733'>
         <a name='10734'>
         ENDIF<a name='10735'>
        ENDIF<a name='10736'>
<a name='10737'>
        IF ( lhl .gt. 1 ) THEN<a name='10738'>
<a name='10739'>
          xdn(mgs,lhl) = xdn0(lhl)<a name='10740'>
<a name='10741'>
          IF ( lvol(lhl) .gt. 1 ) THEN<a name='10742'>
           IF ( vx(mgs,lhl) .gt. 0.0 .and. qx(mgs,lhl) .gt. qxmin(lhl) ) THEN<a name='10743'>
<a name='10744'>
           IF ( mixedphase .and. lhlw &gt; 1 ) THEN<a name='10745'>
           ELSE<a name='10746'>
             dnmx = xdnmx(lhl)<a name='10747'>
           ENDIF<a name='10748'>
<a name='10749'>
             xdn(mgs,lhl) = Min( dnmx, Max( xdnmn(lhl), rho0(mgs)*qx(mgs,lhl)/vx(mgs,lhl) ) )<a name='10750'>
             vx(mgs,lhl) = rho0(mgs)*qx(mgs,lhl)/xdn(mgs,lhl)<a name='10751'>
         <a name='10752'>
           ELSEIF ( vx(mgs,lhl) == 0.0 .and. qx(mgs,lhl) .gt. qxmin(lhl) ) THEN <font color=#447700>! if volume is zero, need to initialize the default value<a name='10753'></font>
<a name='10754'>
             vx(mgs,lhl) = rho0(mgs)*qx(mgs,lhl)/xdn(mgs,lhl)<a name='10755'>
         <a name='10756'>
           ENDIF<a name='10757'>
          ENDIF<a name='10758'>
<a name='10759'>
        ENDIF<a name='10760'>
<a name='10761'>
<font color=#447700>! adjust density for wet snow and graupel (Ferrier 94)<a name='10762'></font>
<font color=#447700>! (aps): for the time being, do not adjust density until we keep track of fully melted snow/graupel<a name='10763'></font>
<font color=#447700>!<a name='10764'></font>
<font color=#447700>!        IF (mixedphase) THEN<a name='10765'></font>
          IF (qsdenmod) THEN<a name='10766'>
           IF(fsw(mgs) .gt. 0.01) THEN<a name='10767'>
            xdn(mgs,ls) = (1.-fsw(mgs))*rho_qs + fsw(mgs)*rho_qr        <font color=#447700>!Ferrier: 100./(1.-fsw(mgs))<a name='10768'></font>
            IF(fsw(mgs) .eq. 1.) xdn(mgs,ls) = rho_qr   <font color=#447700>! fsw = 1 means it's liquid water, yo!<a name='10769'></font>
           ENDIF<a name='10770'>
          ENDIF<a name='10771'>
<a name='10772'>
          IF (qhdenmod) THEN<a name='10773'>
<font color=#447700>!          IF(fhw(mgs) .gt. 0.01) THEN<a name='10774'></font>
<font color=#447700>!           IF(fhw(mgs) .lt. 1.) xdn(mgs,lh) = rho_qh / (1. - fhw(mgs))       !Ferrier: 400./(1.-fsw(mgs))<a name='10775'></font>
<font color=#447700>!           IF(fhw(mgs) .eq. 1.) xdn(mgs,lh) = rho_qr   ! fhw = 1 means it's liquid water, yo!<a name='10776'></font>
<font color=#447700>!          ENDIF<a name='10777'></font>
          ENDIF<a name='10778'>
<font color=#447700>!        ENDIF<a name='10779'></font>
<a name='10780'>
      end do<a name='10781'>
<a name='10782'>
<a name='10783'>
       IF ( imurain == 3 ) THEN<a name='10784'>
         IF ( lzr &gt; 1 ) THEN<a name='10785'>
           alphashr = 0.0<a name='10786'>
           alphamlr = -2.0/3.0<a name='10787'>
         ELSE<a name='10788'>
           alphashr = xnu(lr)<a name='10789'>
           alphamlr = xnu(lr)<a name='10790'>
         ENDIF<a name='10791'>
<font color=#447700>!         massfacshr = ( (2. + 3.*(1. +alphashr) )/( 3.*(1. + alphashr) ) )**(1./3.) ! this is the diameter factor<a name='10792'></font>
<font color=#447700>!         massfacmlr = ( (2. + 3.*(1. +alphamlr) )/( 3.*(1. + alphamlr) ) )**(1./3.)<a name='10793'></font>
         massfacshr = ( (2. + 3.*(1. +alphashr) )**3/( 3.*(1. + alphashr) ) )  <font color=#447700>! this is the mass or volume factor<a name='10794'></font>
         massfacmlr = ( (2. + 3.*(1. +alphamlr) )**3/( 3.*(1. + alphamlr) ) )<a name='10795'>
       ELSEIF ( imurain == 1 ) THEN<a name='10796'>
         IF ( lzr &gt; 1 ) THEN<a name='10797'>
           alphashr = 4.0<a name='10798'>
           alphamlr = 4.0<a name='10799'>
         ELSE<a name='10800'>
           alphashr = alphar<a name='10801'>
           alphamlr = alphar<a name='10802'>
         ENDIF<a name='10803'>
<font color=#447700>!         massfacshr = (3.0 + alphashr)*((3.+alphashr)*(2.+alphashr)*(1. + alphashr) )**(-1./3.) ! this is the diameter factor<a name='10804'></font>
<font color=#447700>!         massfacmlr = (3.0 + alphamlr)*((3.+alphamlr)*(2.+alphamlr)*(1. + alphamlr) )**(-1./3.)<a name='10805'></font>
         massfacshr = (3.0 + alphashr)**3/((3.+alphashr)*(2.+alphashr)*(1. + alphashr) ) <font color=#447700>! this is the mass or volume factor<a name='10806'></font>
         massfacmlr = (3.0 + alphamlr)**3/((3.+alphamlr)*(2.+alphamlr)*(1. + alphamlr) )<a name='10807'>
       ENDIF<a name='10808'>
       <a name='10809'>
<a name='10810'>
<font color=#447700>!<a name='10811'></font>
<font color=#447700>!  set some values for ice nucleation<a name='10812'></font>
<font color=#447700>!<a name='10813'></font>
      do mgs = 1,ngscnt<a name='10814'>
      kp1 = Min(nz, kgs(mgs)+1 )<a name='10815'>
      wvel(mgs) = (0.5)*(w(igs(mgs),jgs,kp1)   &amp;<a name='10816'>
     &amp;                  +w(igs(mgs),jgs,kgs(mgs)))<a name='10817'>
<a name='10818'>
      <a name='10819'>
        wvelkm1(mgs) = (0.5)*(w(igs(mgs),jgs,kgs(mgs))   &amp;<a name='10820'>
     &amp;                    +w(igs(mgs),jgs,kgsm(mgs)))<a name='10821'>
      cninm(mgs) = t7(igs(mgs),jgs,kgsm(mgs))<a name='10822'>
      cnina(mgs) = t7(igs(mgs),jgs,kgs(mgs))<a name='10823'>
      cninp(mgs) = t7(igs(mgs),jgs,kgsp(mgs))<a name='10824'>
      end do<a name='10825'>
<a name='10826'>
<font color=#447700>!<a name='10827'></font>
<font color=#447700>!  Set a couple of cloud variables...<a name='10828'></font>
<font color=#447700>!<a name='10829'></font>
<a name='10830'>
<font color=#447700>!      SUBROUTINE setvt(ngscnt,qx,qxmin,cx,rho0,rhovt,xdia,cno,<a name='10831'></font>
<font color=#447700>!     :                 xmas,xdn,xvmn,xvmx,xv,cdx,<a name='10832'></font>
<font color=#447700>!     :                 ipconc,ndebug)<a name='10833'></font>
<font color=#447700>!      SUBROUTINE setvtz(ngscnt,qx,qxmin,qxw,cx,rho0,rhovt,xdia,cno, &amp;<a name='10834'></font>
<font color=#447700>!     &amp;                 xmas,vtxbar,xdn,xvmn,xvmx,xv,cdx,            &amp;<a name='10835'></font>
<font color=#447700>!     &amp;                 ipconc1,ndebug1,ngs,nz,kgs,cwnccn,fadvisc,   &amp;<a name='10836'></font>
<font color=#447700>!     &amp;                 cwmasn,cwmasx,cwradn,cnina,cimna,cimxa,      &amp;<a name='10837'></font>
<font color=#447700>!     &amp;                 itype1a,itype2a,temcg,infdo,alpha)<a name='10838'></font>
<a name='10839'>
<a name='10840'>
      infdo = 0<a name='10841'>
      IF ( io_flag .and. nxtra &gt; 1 ) infdo = 1<a name='10842'>
<a name='10843'>
      call <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#SETVTZ'>setvtz</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETVTZ_2">(ngscnt,qx,qxmin,qxw,cx,rho0,rhovt,xdia,cno,cnostmp,   &amp;<a name='10844'>
     &amp;                 xmas,vtxbar,xdn,xvmn,xvmx,xv,cdx,   &amp;<a name='10845'>
     &amp;                 ipconc,ndebug,ngs,nz,kgs,fadvisc,   &amp;<a name='10846'>
     &amp;                 cwmasn,cwmasx,cwradn,cnina,cimn,cimx,   &amp;<a name='10847'>
     &amp;                 itype1,itype2,temcg,infdo,alpha,0,axh,bxh,axhl,bxhl)<a name='10848'>
<a name='10849'>
<a name='10850'>
       IF ( lwsm6 .and. ipconc == 0 ) THEN<a name='10851'>
         tmp = Max(qxmin(lh), qxmin(ls))<a name='10852'>
         DO mgs = 1,ngscnt<a name='10853'>
           sum = qx(mgs,lh) + qx(mgs,ls)<a name='10854'>
           IF ( sum &gt; tmp ) THEN<a name='10855'>
             vt2ave(mgs) = (qx(mgs,lh)*vtxbar(mgs,lh,1) + qx(mgs,ls)*vtxbar(mgs,ls,1))/sum<a name='10856'>
           ELSE<a name='10857'>
             vt2ave(mgs) = 0.0<a name='10858'>
           ENDIF<a name='10859'>
         ENDDO<a name='10860'>
       ENDIF<a name='10861'>
<a name='10862'>
<a name='10863'>
<font color=#447700>!<a name='10864'></font>
<font color=#447700>!  Set number concentrations (need xdia from setvt)<a name='10865'></font>
<font color=#447700>!<a name='10866'></font>
      if ( ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: Set concentration'<a name='10867'>
      IF ( ipconc .lt. 1 ) THEN<a name='10868'>
         cina(1:ngscnt) = cx(1:ngscnt,li)<a name='10869'>
      ENDIF<a name='10870'>
      if ( ipconc .lt. 5 ) then<a name='10871'>
      do mgs = 1,ngscnt<a name='10872'>
<a name='10873'>
<a name='10874'>
      IF ( ipconc .lt. 3 ) THEN<a name='10875'>
<font color=#447700>!      cx(mgs,lr) = 0.0<a name='10876'></font>
      if ( qx(mgs,lr) .gt. qxmin(lh) )  then<a name='10877'>
<font color=#447700>!      cx(mgs,lr) = cno(lr)*xdia(mgs,lr,1)<a name='10878'></font>
<font color=#447700>!      xv(mgs,lr) = rho0(mgs)*qx(mgs,lr)/(xdn(mgs,lr)*cx(mgs,lr))<a name='10879'></font>
      end if<a name='10880'>
      ENDIF<a name='10881'>
<a name='10882'>
      IF ( ipconc .lt. 4 ) THEN<a name='10883'>
<font color=#447700>!      tmp = cx(mgs,ls)<a name='10884'></font>
<font color=#447700>!      cx(mgs,ls) = 0.0<a name='10885'></font>
      if ( qx(mgs,ls) .gt. qxmin(ls) )  then<a name='10886'>
<font color=#447700>!      cx(mgs,ls) = cno(ls)*xdia(mgs,ls,1)<a name='10887'></font>
<font color=#447700>!      xv(mgs,ls) = rho0(mgs)*qx(mgs,ls)/(xdn(mgs,ls)*cx(mgs,ls))<a name='10888'></font>
      end if<a name='10889'>
      ENDIF <font color=#447700>! ( ipconc .lt. 4 )<a name='10890'></font>
<a name='10891'>
      IF ( ipconc .lt. 5 ) THEN<a name='10892'>
<a name='10893'>
<a name='10894'>
<font color=#447700>!      cx(mgs,lh) = 0.0<a name='10895'></font>
      if ( qx(mgs,lh) .gt. qxmin(lh) )  then<a name='10896'>
<font color=#447700>!      cx(mgs,lh) = cno(lh)*xdia(mgs,lh,1)<a name='10897'></font>
<font color=#447700>!      xv(mgs,lh) = Max(xvmn(lh), rho0(mgs)*qx(mgs,lh)/(xdn(mgs,lh)*cx(mgs,lh)) )<a name='10898'></font>
<font color=#447700>!      xdia(mgs,lh,3) = (xv(mgs,lh)*6./pi)**(1./3.) <a name='10899'></font>
      end if<a name='10900'>
<a name='10901'>
      ENDIF <font color=#447700>! ( ipconc .lt. 5 )<a name='10902'></font>
<a name='10903'>
      end do<a name='10904'>
      end if<a name='10905'>
      <a name='10906'>
      IF ( ipconc .ge. 2 ) THEN<a name='10907'>
      DO mgs = 1,ngscnt<a name='10908'>
        rb(mgs) = 0.5*xdia(mgs,lc,1)*((1./(1.+cnu)))**(1./6.)<a name='10909'>
        xl2p(mgs) = Max(0.0d0, 2.7e-2*xdn(mgs,lc)*cx(mgs,lc)*xv(mgs,lc)*   &amp;<a name='10910'>
     &amp;           ((0.5e20*rb(mgs)**3*xdia(mgs,lc,1))-0.4) )<a name='10911'>
        IF ( rb(mgs) .gt. 3.51e-6 ) THEN<a name='10912'>
<font color=#447700>!          rh(mgs) = Max( 0.5d0*xdia(mgs,lc,1), 6.3d-4/(1.d6*(rb(mgs) - 3.5d-6)) )<a name='10913'></font>
          rh(mgs) = Max( 41.d-6, 6.3d-4/(1.d6*(rb(mgs) - 3.5d-6)) )<a name='10914'>
        ELSE<a name='10915'>
          rh(mgs) = 41.d-6<a name='10916'>
        ENDIF<a name='10917'>
        IF ( xl2p(mgs) .gt. 0.0 ) THEN<a name='10918'>
          nh(mgs) = 4.2d9*xl2p(mgs)<a name='10919'>
        ELSE<a name='10920'>
          nh(mgs) = 1.e30<a name='10921'>
        ENDIF<a name='10922'>
      ENDDO<a name='10923'>
      ENDIF<a name='10924'>
      <a name='10925'>
<font color=#447700>!<a name='10926'></font>
<font color=#447700>!<a name='10927'></font>
<font color=#447700>!              <a name='10928'></font>
<font color=#447700>!<a name='10929'></font>
<font color=#447700>!  maximum depletion tendency by any one source<a name='10930'></font>
<font color=#447700>!<a name='10931'></font>
<font color=#447700>!<a name='10932'></font>
      if( ndebug .ge. 0 ) THEN<a name='10933'>
<font color=#447700>!mpi!        write(0,*) 'Set depletion max/min1'<a name='10934'></font>
      endif<a name='10935'>
      do mgs = 1,ngscnt<a name='10936'>
      qvimxd(mgs) = 0.70*(qx(mgs,lv)-qis(mgs))/dtp <font color=#447700>! depletion by all vap. dep to ice.<a name='10937'></font>
      <a name='10938'>
      IF ( qx(mgs,lc) &lt; qxmin(lc) ) qvimxd(mgs) = 0.99*(qx(mgs,lv)-qis(mgs))/dtp <font color=#447700>! this makes virtually no difference whatsoever, but what the heck<a name='10939'></font>
      <a name='10940'>
      qvimxd(mgs) = max(qvimxd(mgs), 0.0)<a name='10941'>
<font color=#447700>!      qimxd(mgs)  = 0.20*qx(mgs,li)/dtp<a name='10942'></font>
<font color=#447700>!      qcmxd(mgs)  = 0.20*qx(mgs,lc)/dtp<a name='10943'></font>
<font color=#447700>!      qrmxd(mgs)  = 0.20*qx(mgs,lr)/dtp<a name='10944'></font>
<font color=#447700>!      qsmxd(mgs)  = 0.20*qx(mgs,ls)/dtp<a name='10945'></font>
<font color=#447700>!      qhmxd(mgs)  = 0.20*qx(mgs,lh)/dtp<a name='10946'></font>
<a name='10947'>
      frac = 0.1d0<a name='10948'>
      qimxd(mgs)  = frac*qx(mgs,li)/dtp<a name='10949'>
      qcmxd(mgs)  = frac*qx(mgs,lc)/dtp<a name='10950'>
      qrmxd(mgs)  = frac*qx(mgs,lr)/dtp<a name='10951'>
      qsmxd(mgs)  = frac*qx(mgs,ls)/dtp<a name='10952'>
      qhmxd(mgs)  = frac*qx(mgs,lh)/dtp<a name='10953'>
      IF ( lhl &gt; 1 ) qhlmxd(mgs)  = frac*qx(mgs,lhl)/dtp<a name='10954'>
      end do<a name='10955'>
<font color=#447700>!<a name='10956'></font>
      if( ndebug .ge. 0 ) THEN<a name='10957'>
<font color=#447700>!mpi!        write(0,*) 'Set depletion max/min2'<a name='10958'></font>
      endif<a name='10959'>
<a name='10960'>
      do mgs = 1,ngscnt<a name='10961'>
<font color=#447700>!<a name='10962'></font>
      if ( qx(mgs,lc) .le. qxmin(lc) ) then<a name='10963'>
      ccmxd(mgs)  = 0.20*cx(mgs,lc)/dtp<a name='10964'>
      else<a name='10965'>
      IF ( ipconc .ge. 2 ) THEN<a name='10966'>
        ccmxd(mgs)  = frac*cx(mgs,lc)/dtp<a name='10967'>
      ELSE<a name='10968'>
        ccmxd(mgs)  = frac*qx(mgs,lc)/(xmas(mgs,lc)*rho0(mgs)*dtp)<a name='10969'>
      ENDIF<a name='10970'>
      end if<a name='10971'>
<font color=#447700>!<a name='10972'></font>
      if ( qx(mgs,li) .le. qxmin(li) ) then<a name='10973'>
      cimxd(mgs)  = frac*cx(mgs,li)/dtp<a name='10974'>
      else<a name='10975'>
      IF ( ipconc .ge. 1 ) THEN<a name='10976'>
        cimxd(mgs)  = frac*cx(mgs,li)/dtp<a name='10977'>
      ELSE<a name='10978'>
        cimxd(mgs)  = frac*qx(mgs,li)/(xmas(mgs,li)*rho0(mgs)*dtp)<a name='10979'>
      ENDIF<a name='10980'>
      end if<a name='10981'>
<font color=#447700>!<a name='10982'></font>
<font color=#447700>!<a name='10983'></font>
      crmxd(mgs)  = 0.10*cx(mgs,lr)/dtp<a name='10984'>
      csmxd(mgs)  = frac*cx(mgs,ls)/dtp<a name='10985'>
      chmxd(mgs)  = frac*cx(mgs,lh)/dtp<a name='10986'>
<a name='10987'>
      ccmxd(mgs)  = frac*cx(mgs,lc)/dtp<a name='10988'>
      cimxd(mgs)  = frac*cx(mgs,li)/dtp<a name='10989'>
      crmxd(mgs)  = frac*cx(mgs,lr)/dtp<a name='10990'>
      csmxd(mgs)  = frac*cx(mgs,ls)/dtp<a name='10991'>
      chmxd(mgs)  = frac*cx(mgs,lh)/dtp<a name='10992'>
<a name='10993'>
      qxmxd(mgs,lv) = Max(0.0, 0.1*(qx(mgs,lv) - qvs(mgs))/dtp)<a name='10994'>
<a name='10995'>
      DO il = lc,lhab<a name='10996'>
       qxmxd(mgs,il) = frac*qx(mgs,il)/dtp<a name='10997'>
       cxmxd(mgs,il) = frac*cx(mgs,il)/dtp<a name='10998'>
      ENDDO<a name='10999'>
<a name='11000'>
      end do<a name='11001'>
<a name='11002'>
<a name='11003'>
<a name='11004'>
<a name='11005'>
<a name='11006'>
    <font color=#447700>! default factors between mean volume and maximum mass volume<a name='11007'></font>
      maxmassfac(lc) = ( (2. + 3.*(1. + xnu(lc)) )**3/( 3.*(1. + xnu(lc)) ) )<a name='11008'>
      maxmassfac(li) = ( (2. + 3.*(1. + xnu(li)) )**3/( 3.*(1. + xnu(li)) ) )<a name='11009'>
<a name='11010'>
      IF ( imurain == 3 ) THEN<a name='11011'>
        maxmassfac(lr) = ( (2. + 3.*(1. + xnu(lr)) )**3/( 3.*(1. + xnu(lr)) ) )<a name='11012'>
      ELSE<a name='11013'>
        maxmassfac(lr) =  (3.0 + alphar)**3/    &amp;<a name='11014'>
     &amp;                  ((3.+alphar)*(2.+alphar)*(1. + alphar) )<a name='11015'>
      ENDIF<a name='11016'>
<a name='11017'>
      IF ( imusnow == 3 ) THEN<a name='11018'>
        maxmassfac(ls) = ( (2. + 3.*(1. + alphas) )**3/( 3.*(1. + alphas) ) )<a name='11019'>
      ELSE<a name='11020'>
        maxmassfac(ls) =  (3.0 + alphas)**3/    &amp;<a name='11021'>
     &amp;                  ((3.+alphas)*(2.+alphas)*(1. + alphas) )<a name='11022'>
      ENDIF<a name='11023'>
      <a name='11024'>
        maxmassfac(lh) =  (3.0 + alphah)**3/    &amp;<a name='11025'>
     &amp;                  ((3.+alphah)*(2.+alphah)*(1. + alphah) )<a name='11026'>
<a name='11027'>
       IF ( lhl &gt; 1 ) THEN<a name='11028'>
        maxmassfac(lhl) =  (3.0 + alphahl)**3/    &amp;<a name='11029'>
     &amp;                  ((3.+alphahl)*(2.+alphahl)*(1. + alphahl) )<a name='11030'>
       ENDIF<a name='11031'>
      <a name='11032'>
<a name='11033'>
<a name='11034'>
       DO mgs = 1,ngscnt<a name='11035'>
          DO il = lh,lhab <font color=#447700>! graupel and hail only<a name='11036'></font>
            <a name='11037'>
            vshdgs(mgs,il) = vshd <font color=#447700>! base value<a name='11038'></font>
            <a name='11039'>
            IF ( qx(mgs,il) &gt; qxmin(il) ) THEN<a name='11040'>
              <a name='11041'>
              tmpdiam = (shedalp+alpha(mgs,il))*xdia(mgs,il,1)*( xdn(mgs,il)/917. )**(1./3.) <font color=#447700>! erm added density factor for equiv. solid ice sphere 10.12.2015<a name='11042'></font>
              <a name='11043'>
              IF ( tmpdiam &gt; sheddiam0 ) THEN<a name='11044'>
                vshdgs(mgs,il) = 0.523599*(1.5e-3)**3/massfacshr <font color=#447700>! 1.5mm drops from very large ice<a name='11045'></font>
              ELSEIF ( tmpdiam &gt; sheddiam ) THEN <font color=#447700>! intermediate size<a name='11046'></font>
                vshdgs(mgs,il) = 0.523599*(3.0e-3)**3/massfacshr <font color=#447700>! 3.0mm drops from medium-large ice<a name='11047'></font>
              ELSE<a name='11048'>
<font color=#447700>!                vshdgs(mgs,il) = Min( xvmx(lr), xv(mgs,il)*xdn(mgs,il)*0.001 ) ! size of drop from melted mean ice particle<a name='11049'></font>
                vshdgs(mgs,il) = Min( xvmx(lr), 6./pi*xdn(mgs,il)*0.001*tmpdiam**3 )/massfacshr <font color=#447700>! size of drop from melted mean ice particle<a name='11050'></font>
              ENDIF<a name='11051'>
            ENDIF<a name='11052'>
          ENDDO<a name='11053'>
       ENDDO<a name='11054'>
<a name='11055'>
<font color=#447700>!<a name='11056'></font>
<font color=#447700>!<a name='11057'></font>
<font color=#447700>!  microphysics source terms (1/s) for mixing ratios <a name='11058'></font>
<font color=#447700>!<a name='11059'></font>
<font color=#447700>!<a name='11060'></font>
<font color=#447700>!<a name='11061'></font>
<font color=#447700>!  Collection efficiencies:<a name='11062'></font>
<font color=#447700>!<a name='11063'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: Set collection efficiencies'<a name='11064'>
<font color=#447700>!<a name='11065'></font>
      do mgs = 1,ngscnt<a name='11066'>
<font color=#447700>!<a name='11067'></font>
<font color=#447700>!<a name='11068'></font>
<font color=#447700>!<a name='11069'></font>
      erw(mgs) = 0.0<a name='11070'>
      esw(mgs) = 0.0<a name='11071'>
      ehw(mgs) = 0.0<a name='11072'>
      ehlw(mgs) = 0.0<a name='11073'>
<font color=#447700>!      ehxw(mgs) = 0.0<a name='11074'></font>
<font color=#447700>!<a name='11075'></font>
      err(mgs) = 0.0<a name='11076'>
      esr(mgs) = 0.0<a name='11077'>
      il2(mgs) = 0<a name='11078'>
      il3(mgs) = 0<a name='11079'>
      ehr(mgs) = 0.0<a name='11080'>
      ehlr(mgs) = 0.0<a name='11081'>
<font color=#447700>!      ehxr(mgs) = 0.0<a name='11082'></font>
<font color=#447700>!<a name='11083'></font>
      eri(mgs) = 0.0<a name='11084'>
      esi(mgs) = 0.0<a name='11085'>
      ehi(mgs) = 0.0 <font color=#447700>! used as sticking efficiency, so collection efficiency is ehi*ehiclsn<a name='11086'></font>
      ehis(mgs) = 0.0 <font color=#447700>! used as sticking efficiency, so collection efficiency is ehi*ehiclsn<a name='11087'></font>
      ehli(mgs) = 0.0 <font color=#447700>! used as sticking efficiency, so collection efficiency is ehli*ehliclsn<a name='11088'></font>
      ehlis(mgs) = 0.0 <font color=#447700>! used as sticking efficiency, so collection efficiency is ehli*ehliclsn<a name='11089'></font>
<font color=#447700>!      ehxi(mgs) = 0.0<a name='11090'></font>
<font color=#447700>!<a name='11091'></font>
      ers(mgs) = 0.0<a name='11092'>
      ess(mgs) = 0.0<a name='11093'>
      ehs(mgs) = 0.0 <font color=#447700>! used as sticking efficiency, so collection efficiency is ehs*ehsclsn<a name='11094'></font>
      ehls(mgs) = 0.0 <font color=#447700>! used as sticking efficiency, so collection efficiency is ehls*ehlsclsn<a name='11095'></font>
      ehscnv(mgs) = 0.0<a name='11096'>
<font color=#447700>!      ehxs(mgs) = 0.0<a name='11097'></font>
<font color=#447700>!<a name='11098'></font>
      eiw(mgs) = 0.0<a name='11099'>
      eii(mgs) = 0.0<a name='11100'>
<a name='11101'>
      ehsclsn(mgs) = 0.0<a name='11102'>
      ehiclsn(mgs) = 0.0<a name='11103'>
      ehlsclsn(mgs) = 0.0<a name='11104'>
      ehliclsn(mgs) = 0.0<a name='11105'>
      esiclsn(mgs) = 0.0<a name='11106'>
<a name='11107'>
<a name='11108'>
      icwr(mgs) = 1<a name='11109'>
      IF ( qx(mgs,lc) .gt. qxmin(lc) ) THEN<a name='11110'>
       cwrad = 0.5*xdia(mgs,lc,1)<a name='11111'>
      DO il = 1,8<a name='11112'>
         IF ( cwrad .ge. 1.e-6*cwr(il,1) ) icwr(mgs) = il<a name='11113'>
      ENDDO<a name='11114'>
      ENDIF<a name='11115'>
<a name='11116'>
<a name='11117'>
      irwr(mgs) = 1<a name='11118'>
      IF ( qx(mgs,lr) .gt. qxmin(lr) ) THEN<a name='11119'>
         rwrad = 0.5*xdia(mgs,lr,3)  <font color=#447700>! changed to mean volume diameter (10/6/06)<a name='11120'></font>
      DO il = 1,6<a name='11121'>
         IF ( rwrad .ge. 1.e-6*grad(il,1) ) irwr(mgs) = il<a name='11122'>
      ENDDO<a name='11123'>
      ENDIF<a name='11124'>
<a name='11125'>
<a name='11126'>
      igwr(mgs) = 1<a name='11127'>
<font color=#447700>!      IF ( qx(mgs,lr) .gt. qxmin(lr) ) THEN<a name='11128'></font>
<font color=#447700>!         rwrad = 0.5*xdia(mgs,lr,1)<a name='11129'></font>
<font color=#447700>! setting erw = 1 always, so now use igwr for graupel<a name='11130'></font>
      IF ( qx(mgs,lh) .gt. qxmin(lh) ) THEN<a name='11131'>
         rwrad = 0.5*xdia(mgs,lh,3)  <font color=#447700>! changed to mean volume diameter (10/6/06)<a name='11132'></font>
      DO il = 1,6<a name='11133'>
         IF ( rwrad .ge. 1.e-6*grad(il,1) ) igwr(mgs) = il<a name='11134'>
      ENDDO<a name='11135'>
      ENDIF<a name='11136'>
<a name='11137'>
      IF ( lhl .gt. 1 ) THEN <font color=#447700>! hail is turned on<a name='11138'></font>
      ihlr(mgs) = 1<a name='11139'>
      IF ( qx(mgs,lhl) .gt. qxmin(lhl) ) THEN<a name='11140'>
         rwrad = 0.5*xdia(mgs,lhl,3)  <font color=#447700>! changed to mean volume diameter (10/6/06)<a name='11141'></font>
      DO il = 1,6<a name='11142'>
         IF ( rwrad .ge. 1.e-6*grad(il,1) ) ihlr(mgs) = il<a name='11143'>
      ENDDO<a name='11144'>
      ENDIF<a name='11145'>
      ENDIF<a name='11146'>
<a name='11147'>
<font color=#447700>!<a name='11148'></font>
<font color=#447700>!<a name='11149'></font>
<font color=#447700>!  Ice-Ice: Collection (cxc) efficiencies<a name='11150'></font>
<font color=#447700>!<a name='11151'></font>
<font color=#447700>!<a name='11152'></font>
      if ( qx(mgs,li) .gt. qxmin(li) ) then<a name='11153'>
<font color=#447700>!      IF ( ipconc .ge. 14 ) THEN<a name='11154'></font>
<font color=#447700>!       eii(mgs)=0.1*exp(0.1*temcg(mgs))<a name='11155'></font>
<font color=#447700>!       if ( temg(mgs) .lt. 243.15 .and. qx(mgs,lc) .gt. 1.e-6 ) then<a name='11156'></font>
<font color=#447700>!        eii(mgs)=0.1<a name='11157'></font>
<font color=#447700>!       end if<a name='11158'></font>
<font color=#447700>!      <a name='11159'></font>
<font color=#447700>!      ELSE<a name='11160'></font>
        eii(mgs) = exp(0.025*Min(temcg(mgs),0.0))  <font color=#447700>! alpha1 from LFO83 (21)<a name='11161'></font>
<font color=#447700>!      ENDIF<a name='11162'></font>
      if ( temg(mgs) .gt. 273.15 ) eii(mgs) = 1.0<a name='11163'>
      end if<a name='11164'>
<font color=#447700>!<a name='11165'></font>
<font color=#447700>!<a name='11166'></font>
<font color=#447700>!<a name='11167'></font>
<font color=#447700>!  Ice-cloud water: Collection (cxc) efficiencies<a name='11168'></font>
<font color=#447700>!<a name='11169'></font>
<font color=#447700>!<a name='11170'></font>
      eiw(mgs) = 0.0<a name='11171'>
      if ( qx(mgs,li).gt.qxmin(li) .and. qx(mgs,lc).gt.qxmin(lc) ) then<a name='11172'>
      <a name='11173'>
      <a name='11174'>
      if (xdia(mgs,lc,1).gt.15.0e-06 .and. xdia(mgs,li,1).gt.30.0e-06) then<a name='11175'>
<font color=#447700>! erm 5/10/2007 test following change:<a name='11176'></font>
<font color=#447700>!      if (xdia(mgs,lc,1).gt.12.0e-06 .and. xdia(mgs,li,1).gt.50.0e-06) then<a name='11177'></font>
      eiw(mgs) = 0.5<a name='11178'>
      end if<a name='11179'>
      if ( temg(mgs) .ge. 273.15 ) eiw(mgs) = 0.0<a name='11180'>
      end if<a name='11181'>
<a name='11182'>
<font color=#447700>!<a name='11183'></font>
<font color=#447700>!<a name='11184'></font>
<font color=#447700>!<a name='11185'></font>
<font color=#447700>!  Rain: Collection (cxc) efficiencies<a name='11186'></font>
<font color=#447700>!<a name='11187'></font>
<font color=#447700>!<a name='11188'></font>
      if ( qx(mgs,lr).gt.qxmin(lr) .and. qx(mgs,lc).gt.qxmin(lc) ) then<a name='11189'>
<a name='11190'>
       IF ( lnr .gt. 1 ) THEN<a name='11191'>
       erw(mgs) = 1.0<a name='11192'>
<a name='11193'>
       ELSE<a name='11194'>
<a name='11195'>
<font color=#447700>!      cwrad = 0.5*xdia(mgs,lc,1)<a name='11196'></font>
<font color=#447700>!      erw(mgs) =<a name='11197'></font>
<font color=#447700>!     &gt;  min((aradcw + cwrad*(bradcw + cwrad*<a name='11198'></font>
<font color=#447700>!     &lt;  (cradcw + cwrad*(dradcw)))), 1.0)<a name='11199'></font>
<font color=#447700>!       IF ( xdia(mgs,lc,1) .lt. 2.4e-06 .or. xdia(mgs,lr,1) .le. 50.0e-6 ) THEN<a name='11200'></font>
<font color=#447700>!          erw(mgs)=0.0<a name='11201'></font>
<font color=#447700>!       ENDIF<a name='11202'></font>
<font color=#447700>!       erw(mgs) = ew(icwr(mgs),igwr(mgs))<a name='11203'></font>
<font color=#447700>! interpolate along droplet radius<a name='11204'></font>
       ic = icwr(mgs)<a name='11205'>
       icp1 = Min( 8, ic+1 )<a name='11206'>
       ir = irwr(mgs)<a name='11207'>
       irp1 = Min( 6, ir+1 )<a name='11208'>
       cwrad = 0.5*xdia(mgs,lc,3)<a name='11209'>
       rwrad = 0.5*xdia(mgs,lr,3)<a name='11210'>
       <a name='11211'>
       slope1 = (ew(icp1, ir  ) - ew(ic,ir  ))*cwr(ic,2)<a name='11212'>
       slope2 = (ew(icp1, irp1) - ew(ic,irp1))*cwr(ic,2)<a name='11213'>
<a name='11214'>
<font color=#447700>!       write(iunit,*) 'slop1: ',slope1,slope2,ew(ic,ir),cwr(ic,2)<a name='11215'></font>
<a name='11216'>
       x1 = ew(ic,  ir) + slope1*Max(0.0, (cwrad - cwr(ic,1)) )<a name='11217'>
       x2 = ew(icp1,ir) + slope2*Max(0.0, (cwrad - cwr(ic,1)) )<a name='11218'>
<a name='11219'>
       slope1 = (x2 - x1)*grad(ir,2)<a name='11220'>
<a name='11221'>
       erw(mgs) = Max(0.0, x1 + slope1*Max(0.0, (rwrad - grad(ir,1)) ))<a name='11222'>
<a name='11223'>
<font color=#447700>!       write(iunit,*) 'erw: ',erw(mgs),1.e6*cwrad,1.e6*rwrad,ic,ir,x1,x2<a name='11224'></font>
<font color=#447700>!       write(iunit,*)<a name='11225'></font>
<a name='11226'>
       erw(mgs) = Max(0.0, erw(mgs) )<a name='11227'>
       IF ( rwrad .lt. 50.e-6 ) THEN<a name='11228'>
         erw(mgs) = 0.0<a name='11229'>
       ELSEIF (  rwrad .lt. 100.e-6 ) THEN  <font color=#447700>! linear change from zero at 50 to erw at 100 microns<a name='11230'></font>
         erw(mgs) = erw(mgs)*(rwrad - 50.e-6)/50.e-6<a name='11231'>
       ENDIF<a name='11232'>
<a name='11233'>
       ENDIF<a name='11234'>
      end if<a name='11235'>
      IF ( cx(mgs,lc) .le. 0.0 ) erw(mgs) = 0.0<a name='11236'>
<font color=#447700>!<a name='11237'></font>
      if ( qx(mgs,lr).gt.qxmin(lr) .and. qx(mgs,lr).gt.qxmin(lr) ) then<a name='11238'>
      err(mgs)=1.0<a name='11239'>
      end if<a name='11240'>
<font color=#447700>!<a name='11241'></font>
      if ( qx(mgs,lr).gt.qxmin(lr) .and. qx(mgs,ls).gt.qxmin(ls) ) then<a name='11242'>
      ers(mgs)=1.0<a name='11243'>
      end if<a name='11244'>
<font color=#447700>!<a name='11245'></font>
      if ( qx(mgs,lr).gt.qxmin(lr) .and. qx(mgs,li).gt.qxmin(li) ) then<a name='11246'>
<font color=#447700>!        IF ( vtxbar(mgs,lr,1) .gt. vtxbar(mgs,li,1) .and.<a name='11247'></font>
<font color=#447700>!     :       xdia(mgs,lr,3) .gt. 200.e-6 .and. xdia(mgs,li,3) .gt. 100.e-6 ) THEN<a name='11248'></font>
         eri(mgs) = eri0<a name='11249'>
<font color=#447700>!      cwrad = 0.5*xdia(mgs,li,3)<a name='11250'></font>
<font color=#447700>!      eri(mgs) =<a name='11251'></font>
<font color=#447700>!     &gt;  1.0*min((aradcw + cwrad*(bradcw + cwrad*<a name='11252'></font>
<font color=#447700>!     &lt;  (cradcw + cwrad*(dradcw)))), 1.0)<a name='11253'></font>
<font color=#447700>!         ENDIF<a name='11254'></font>
<font color=#447700>!       if ( xdia(mgs,li,1) .lt. 10.e-6 ) eri(mgs)=0.0<a name='11255'></font>
       if ( xdia(mgs,li,3) .lt. eri_cimin ) eri(mgs)=0.0<a name='11256'>
      end if<a name='11257'>
<font color=#447700>!<a name='11258'></font>
<font color=#447700>!<a name='11259'></font>
<font color=#447700>!  Snow aggregates: Collection (cxc) efficiencies<a name='11260'></font>
<font color=#447700>!<a name='11261'></font>
<font color=#447700>! Modified by ERM with a linear function for small droplets and large<a name='11262'></font>
<font color=#447700>! snow agg. based numerical data from Wang and Ji (1992) in P&amp;K 1997 (Fig. 14-13), which<a name='11263'></font>
<font color=#447700>! allows collection of very small droplets, albeit at low efficiency.  But slow<a name='11264'></font>
<font color=#447700>! fall speeds of snow make up for the efficiency.<a name='11265'></font>
<font color=#447700>!<a name='11266'></font>
      esw(mgs) = 0.0<a name='11267'>
      if ( qx(mgs,ls).gt.qxmin(ls) .and. qx(mgs,lc).gt.qxmin(lc) ) then<a name='11268'>
        esw(mgs) = 0.5<a name='11269'>
        if ( xdia(mgs,lc,1) .gt. 15.e-6 .and. xdia(mgs,ls,1) .gt. 100.e-6) then<a name='11270'>
          esw(mgs) = 0.5<a name='11271'>
        ELSEIF ( xdia(mgs,ls,1) .ge. 500.e-6 ) THEN<a name='11272'>
          esw(mgs) = Min(0.5, 0.05 + (0.8-0.05)/(40.e-6)*xdia(mgs,lc,1) )<a name='11273'>
        ENDIF<a name='11274'>
      end if<a name='11275'>
<font color=#447700>!<a name='11276'></font>
      if ( qx(mgs,ls).gt.qxmin(ls) .and. qx(mgs,lr).gt.qxmin(lr)  &amp;<a name='11277'>
     &amp;     .and. temg(mgs) .lt. tfr - 1.   &amp;<a name='11278'>
     &amp;                               ) then<a name='11279'>
      esr(mgs)=Exp(-(40.e-6)**3/xv(mgs,lr))*Exp(-40.e-6/xdia(mgs,ls,1))<a name='11280'>
      IF ( qx(mgs,ls) &lt; 1.e-4 .and. qx(mgs,lr) &lt; 1.e-4 ) il2(mgs) = 1<a name='11281'>
      end if<a name='11282'>
      <a name='11283'>
      IF ( ipconc &lt; 3 .and. temg(mgs) &lt; tfr .and. qx(mgs,lr).gt.qxmin(lr) .and. qx(mgs,lr) &lt; 1.e-4 ) THEN<a name='11284'>
        il3(mgs) = 1<a name='11285'>
      ENDIF<a name='11286'>
<font color=#447700>!<a name='11287'></font>
<font color=#447700>!      if ( qx(mgs,ls).gt.qxmin(ls) ) then<a name='11288'></font>
      if ( temcg(mgs) &lt; 0.0 ) then<a name='11289'>
            <a name='11290'>
      IF ( ipconc .lt. 4 .or. temcg(mgs) &lt; esstem1 ) THEN<a name='11291'>
        ess(mgs) = 0.0<a name='11292'>
<font color=#447700>!        ess(mgs)=0.1*exp(0.1*min(temcg(mgs),0.0))<a name='11293'></font>
<font color=#447700>!        ess(mgs)=min(0.1,ess(mgs))<a name='11294'></font>
      <a name='11295'>
      ELSE<a name='11296'>
      <a name='11297'>
        fac = Abs(ess0)<a name='11298'>
        IF ( .true. .and. ess0 &lt; 0.0 ) THEN<a name='11299'>
<font color=#447700>!         IF ( wvel(mgs) &gt; 2.0 .or. wvel(mgs) &lt; -0.5 .or. ssi(mgs) &lt; 1.0 ) THEN<a name='11300'></font>
         IF ( wvel(mgs) &gt; 2.0 ) THEN<a name='11301'>
          <font color=#447700>! assume convective cell or downdraft<a name='11302'></font>
           fac = 0.0<a name='11303'>
         ELSEIF ( wvel(mgs) &gt; 1.0 ) THEN <font color=#447700>! transition to stratiform range of values<a name='11304'></font>
           fac = Max(0.0, 2.0 - wvel(mgs))*fac<a name='11305'>
         ENDIF<a name='11306'>
        ENDIF<a name='11307'>
        <a name='11308'>
        IF ( temcg(mgs) &gt; esstem1 .and. temcg(mgs) &lt; esstem2 ) THEN  <font color=#447700>! only nonzero for T &gt; -25<a name='11309'></font>
          ess(mgs) = fac*Exp(ess1*(esstem2) )*(temcg(mgs) - esstem1)/(esstem2 - esstem1) <font color=#447700>! linear ramp up from zero at esstem1 to value at esstem2<a name='11310'></font>
        ELSEIF ( temcg(mgs) &gt;= esstem2 ) THEN<a name='11311'>
          ess(mgs) = fac*Exp(ess1*Min( temcg(mgs), 0.0 ) )<a name='11312'>
        ENDIF<a name='11313'>
        <a name='11314'>
      ENDIF<a name='11315'>
      end if<a name='11316'>
<font color=#447700>!<a name='11317'></font>
      if ( qx(mgs,ls).gt.qxmin(ls) .and. qx(mgs,li).gt.qxmin(li) ) then<a name='11318'>
       esiclsn(mgs) = esi_collsn<a name='11319'>
<font color=#447700>!      IF ( ipconc .lt. 4 ) THEN<a name='11320'></font>
      IF ( ipconc &lt; 1 .and. lwsm6 ) THEN<a name='11321'>
        esi(mgs) = exp(0.7*min(temcg(mgs),0.0))<a name='11322'>
      ELSE<a name='11323'>
        esi(mgs) = esi0*exp(0.1*min(temcg(mgs),0.0))<a name='11324'>
        esi(mgs) = Min(0.1,esi(mgs))<a name='11325'>
      ENDIF<a name='11326'>
      IF ( ipconc .le. 3 ) THEN<a name='11327'>
       esi(mgs) =  exp(0.025*min(temcg(mgs),0.0)) <font color=#447700>! LFO<a name='11328'></font>
<font color=#447700>!       esi(mgs) =  Min(0.5, exp(0.025*min(temcg(mgs),0.0)) ) ! LFO<a name='11329'></font>
<font color=#447700>!       esi(mgs)=0.5*exp(0.1*min(temcg(mgs),0.0))  ! 10ice<a name='11330'></font>
      ENDIF<a name='11331'>
<font color=#447700>!      ELSE ! zrnic/ziegler 1993<a name='11332'></font>
<font color=#447700>!      esi(mgs)= 0.1 ! 0.5*exp(0.1*min(temcg(mgs),0.0))<a name='11333'></font>
<font color=#447700>!      ENDIF<a name='11334'></font>
      if ( temg(mgs) .gt. 273.15 ) esi(mgs) = 0.0<a name='11335'>
      end if<a name='11336'>
<font color=#447700>!<a name='11337'></font>
<font color=#447700>!<a name='11338'></font>
<font color=#447700>!<a name='11339'></font>
<font color=#447700>!<a name='11340'></font>
<font color=#447700>!  Graupel: Collection (cxc) efficiencies<a name='11341'></font>
<font color=#447700>!<a name='11342'></font>
<font color=#447700>!<a name='11343'></font>
       xmascw(mgs) = xmas(mgs,lc)<a name='11344'>
      if ( qx(mgs,lh).gt.qxmin(lh) .and. qx(mgs,lc).gt.qxmin(lc) ) then<a name='11345'>
       ehw(mgs) = 1.0<a name='11346'>
       IF ( iehw .eq. 0 ) THEN<a name='11347'>
       ehw(mgs) = ehw0  <font color=#447700>! default value is 1.0<a name='11348'></font>
       ELSEIF ( iehw .eq. 1 .or. iehw .eq. 10 ) THEN<a name='11349'>
      cwrad = 0.5*xdia(mgs,lc,1)<a name='11350'>
      ehw(mgs) = Min( ehw0,    &amp;<a name='11351'>
     &amp;  ewfac*min((aradcw + cwrad*(bradcw + cwrad*   &amp;<a name='11352'>
     &amp;  (cradcw + cwrad*(dradcw)))), 1.0) )<a name='11353'>
      <a name='11354'>
       ELSEIF ( iehw .eq. 2 .or. iehw .eq. 10 ) THEN<a name='11355'>
       ic = icwr(mgs)<a name='11356'>
       icp1 = Min( 8, ic+1 )<a name='11357'>
       ir = igwr(mgs)<a name='11358'>
       irp1 = Min( 6, ir+1 )<a name='11359'>
       cwrad = 0.5*xdia(mgs,lc,1)<a name='11360'>
       rwrad = 0.5*xdia(mgs,lh,3)  <font color=#447700>! changed to mean volume diameter<a name='11361'></font>
       <a name='11362'>
       slope1 = (ew(icp1, ir  ) - ew(ic,ir  ))*cwr(ic,2)<a name='11363'>
       slope2 = (ew(icp1, irp1) - ew(ic,irp1))*cwr(ic,2)<a name='11364'>
 <a name='11365'>
<font color=#447700>!        write(iunit,*) 'slop1: ',slope1,slope2,ew(ic,ir),cwr(ic,2)<a name='11366'></font>
<a name='11367'>
       x1 = ew(ic,  ir) + slope1*Max(0.0, (cwrad - cwr(ic,1)) )<a name='11368'>
       x2 = ew(icp1,ir) + slope2*Max(0.0, (cwrad - cwr(ic,1)) )<a name='11369'>
       <a name='11370'>
       slope1 = (x2 - x1)*grad(ir,2)<a name='11371'>
       <a name='11372'>
       tmp = Max( 0.0, Min( 1.0, x1 + slope1*Max(0.0, (rwrad - grad(ir,1)) ) ) )<a name='11373'>
       ehw(mgs) = Min( ehw(mgs), tmp )<a name='11374'>
<a name='11375'>
<font color=#447700>!       write(iunit,*) 'ehw: ',ehw(mgs),1.e6*cwrad,1.e6*rwrad,ic,ir,x1,x2<a name='11376'></font>
<font color=#447700>!       write(iunit,*)<a name='11377'></font>
<a name='11378'>
<font color=#447700>!       ehw(mgs) = Max( 0.2, ehw(mgs) )<a name='11379'></font>
<font color=#447700>!  assume that ehw = 1 for zero air resistance (rho0 = 0.0) and extrapolate toward that<a name='11380'></font>
<font color=#447700>!      ehw(mgs) = ehw(mgs) + (ehw(mgs) - 1.0)*(rho0(mgs) - rho00)/rho00<a name='11381'></font>
<font color=#447700>!      ehw(mgs) = ehw(mgs) + (1.0 - ehw(mgs))*((Max(0.0,rho00 - rho0(mgs)))/rho00)**2<a name='11382'></font>
<a name='11383'>
       ELSEIF ( iehw .eq. 3 .or. iehw .eq. 10 ) THEN <font color=#447700>! use fraction of droplets greater than dmincw diameter<a name='11384'></font>
         tmp = Exp(- (dmincw/xdia(mgs,lc,1))**3)<a name='11385'>
         xmascw(mgs) = xmas(mgs,lc) + xdn0(lc)*(pi*dmincw**3/6.0) <font color=#447700>! this is the average mass of the droplets with d &gt; dmincw<a name='11386'></font>
         ehw(mgs) = Min( ehw(mgs), tmp )<a name='11387'>
       ELSEIF ( iehw .eq. 4 .or. iehw .eq. 10 ) THEN <font color=#447700>! Cober and List 1993<a name='11388'></font>
         tmp =  &amp;<a name='11389'>
     &amp;   2.0*xdn(mgs,lc)*vtxbar(mgs,lh,1)*(0.5*xdia(mgs,lc,1))**2 &amp;<a name='11390'>
     &amp;  /(9.0*fadvisc(mgs)*0.5*xdia(mgs,lh,3))<a name='11391'>
         tmp = Max( 1.5, Min(10.0, tmp) )<a name='11392'>
         ehw(mgs) = Min( ehw(mgs), 0.55*Log10(2.51*tmp) )<a name='11393'>
       ENDIF<a name='11394'>
      if ( xdia(mgs,lc,1) .lt. 2.4e-06 ) ehw(mgs)=0.0<a name='11395'>
<a name='11396'>
       ehw(mgs) = Min( ehw0, ehw(mgs) )<a name='11397'>
       <a name='11398'>
       IF ( ibfc == -1 .and. temcg(mgs) &lt; -41.0 ) THEN<a name='11399'>
        ehw(mgs) = 0.0<a name='11400'>
       ENDIF <a name='11401'>
<a name='11402'>
      end if<a name='11403'>
<font color=#447700>!<a name='11404'></font>
      if ( qx(mgs,lh).gt.qxmin(lh) .and. qx(mgs,lr).gt.qxmin(lr)    &amp;<a name='11405'>
<font color=#447700>!     &amp;     .and. temg(mgs) .lt. tfr    &amp;<a name='11406'></font>
     &amp;                               ) then<a name='11407'>
<font color=#447700>!      ehr(mgs) = Exp(-(40.e-6)**3/xv(mgs,lr))*Exp(-40.e-6/xdia(mgs,lh,1))<a name='11408'></font>
<font color=#447700>!      ehr(mgs) = 1.0<a name='11409'></font>
       ehr(mgs) = Exp(-(40.e-6)/xdia(mgs,lr,3))*Exp(-40.e-6/xdia(mgs,lh,3))<a name='11410'>
       ehr(mgs) = Min( ehr0, ehr(mgs) )<a name='11411'>
      end if<a name='11412'>
<font color=#447700>!<a name='11413'></font>
      IF ( qx(mgs,ls).gt.qxmin(ls) ) THEN<a name='11414'>
        IF ( ipconc .ge. 4 ) THEN<a name='11415'>
        ehscnv(mgs) = ehs0*exp(ehs1*min(temcg(mgs),0.0)) <font color=#447700>! for 2-moment, used as default for ehs and ehls. Otherwise not used for snow-&gt;graupel conversion<a name='11416'></font>
        ELSE<a name='11417'>
        ehscnv(mgs) = exp(0.09*min(temcg(mgs),0.0))<a name='11418'>
        ENDIF<a name='11419'>
        if ( qx(mgs,lh).gt.qxmin(lh) .and. qx(mgs,lc) &gt; qxmin(lc)  ) then<a name='11420'>
          ehsclsn(mgs) = ehs_collsn<a name='11421'>
          IF ( xdia(mgs,ls,3) &lt; 40.e-6 ) THEN<a name='11422'>
            ehsclsn(mgs) = 0.0<a name='11423'>
          ELSEIF ( xdia(mgs,ls,3) &lt; 150.e-6 ) THEN<a name='11424'>
            ehsclsn(mgs) =  ehs_collsn*(xdia(mgs,ls,3) - 40.e-6)/(150.e-6 - 40.e-6)<a name='11425'>
          ELSE<a name='11426'>
            ehsclsn(mgs) = ehs_collsn<a name='11427'>
          ENDIF<a name='11428'>
<font color=#447700>!          ehs(mgs) = ehscnv(mgs)*Min(1.0, Max(0., xdn(mgs,lh) - xdnmn(lh)*1.2)/xdnmn(lh)  ) ! shut off qhacs as graupel goes to lowest density<a name='11429'></font>
          ehs(mgs) = ehscnv(mgs)*Min(1.0, Max(0.0,xdn(mgs,lh) - 300.)/300.  ) <font color=#447700>! shut off qhacs as graupel goes to low density<a name='11430'></font>
          ehs(mgs) = Min(ehs(mgs),ehsmax)<a name='11431'>
          IF ( qx(mgs,lc) &lt; qxmin(lc) ) ehs(mgs) = 0.0<a name='11432'>
        end if<a name='11433'>
      ENDIF<a name='11434'>
<font color=#447700>!<a name='11435'></font>
      if ( qx(mgs,lh).gt.qxmin(lh) .and. qx(mgs,li).gt.qxmin(li) ) then<a name='11436'>
      ehiclsn(mgs) = ehi_collsn<a name='11437'>
      ehi(mgs)=eii0*exp(eii1*min(temcg(mgs),0.0))<a name='11438'>
      ehi(mgs) = Min( ehimax, Max( ehi(mgs), ehimin ) )<a name='11439'>
      if ( temg(mgs) .gt. 273.15 .or. ( qx(mgs,lc) &lt; qxmin(lc)) ) ehi(mgs) = 0.0<a name='11440'>
      end if<a name='11441'>
<a name='11442'>
      IF ( lis &gt; 1 ) THEN<a name='11443'>
      if ( qx(mgs,lh).gt.qxmin(lh) .and. qx(mgs,lis).gt.qxmin(lis) ) then<a name='11444'>
      ehisclsn(mgs) = ehi_collsn<a name='11445'>
      ehis(mgs)=eii0*exp(eii1*min(temcg(mgs),0.0))<a name='11446'>
      ehis(mgs) = Min( ehimax, Max( ehis(mgs), ehimin ) )<a name='11447'>
      if ( temg(mgs) .gt. 273.15 .or. ( qx(mgs,lc) &lt; qxmin(lc)) ) ehis(mgs) = 0.0<a name='11448'>
      end if<a name='11449'>
      ENDIF<a name='11450'>
<a name='11451'>
<a name='11452'>
<font color=#447700>!<a name='11453'></font>
<font color=#447700>!<a name='11454'></font>
<font color=#447700>!  Hail: Collection (cxc) efficiencies<a name='11455'></font>
<font color=#447700>!<a name='11456'></font>
<font color=#447700>!<a name='11457'></font>
      IF ( lhl .gt. 1 ) THEN<a name='11458'>
<a name='11459'>
      if ( qx(mgs,lhl).gt.qxmin(lhl) .and. qx(mgs,lc).gt.qxmin(lc) ) then<a name='11460'>
       IF ( iehw == 3 ) iehlw = 3<a name='11461'>
       IF ( iehw == 4 ) iehlw = 4<a name='11462'>
       ehlw(mgs) = ehlw0<a name='11463'>
       IF ( iehlw .eq. 0 ) THEN<a name='11464'>
       ehlw(mgs) = ehlw0  <font color=#447700>! default value is 1.0<a name='11465'></font>
       ELSEIF ( iehlw .eq. 1 .or. iehlw .eq. 10 ) THEN<a name='11466'>
      cwrad = 0.5*xdia(mgs,lc,1)<a name='11467'>
      ehlw(mgs) = Min( ehlw0,    &amp;<a name='11468'>
     &amp;  ewfac*min((aradcw + cwrad*(bradcw + cwrad*   &amp;<a name='11469'>
     &amp;  (cradcw + cwrad*(dradcw)))), 1.0) )<a name='11470'>
      <a name='11471'>
       ELSEIF ( iehlw .eq. 2 .or. iehlw .eq. 10 ) THEN<a name='11472'>
       ic = icwr(mgs)<a name='11473'>
       icp1 = Min( 8, ic+1 )<a name='11474'>
       ir = ihlr(mgs)<a name='11475'>
       irp1 = Min( 6, ir+1 )<a name='11476'>
       cwrad = 0.5*xdia(mgs,lc,1)<a name='11477'>
       rwrad = 0.5*xdia(mgs,lhl,3)  <font color=#447700>! changed to mean volume diameter<a name='11478'></font>
       <a name='11479'>
       slope1 = (ew(icp1, ir  ) - ew(ic,ir  ))*cwr(ic,2)<a name='11480'>
       slope2 = (ew(icp1, irp1) - ew(ic,irp1))*cwr(ic,2)<a name='11481'>
       <a name='11482'>
       x1 = ew(ic,  ir) + slope1*(cwrad - cwr(ic,1))<a name='11483'>
       x2 = ew(icp1,ir) + slope2*(cwrad - cwr(ic,1))<a name='11484'>
       <a name='11485'>
       slope1 = (x2 - x1)*grad(ir,2)<a name='11486'>
       <a name='11487'>
       tmp = Max( 0.0, Min( 1.0, x1 + slope1*(rwrad - grad(ir,1)) ) )<a name='11488'>
         ehlw(mgs) = Min( ehlw(mgs), tmp )<a name='11489'>
       ehlw(mgs) = Min( ehlw0, ehlw(mgs) )<a name='11490'>
<font color=#447700>!       ehw(mgs) = Max( 0.2, ehw(mgs) )<a name='11491'></font>
<font color=#447700>!  assume that ehw = 1 for zero air resistance (rho0 = 0.0) and extrapolate toward that<a name='11492'></font>
<font color=#447700>!      ehw(mgs) = ehw(mgs) + (ehw(mgs) - 1.0)*(rho0(mgs) - rho00)/rho00<a name='11493'></font>
<font color=#447700>!      ehlw(mgs) = ehlw(mgs) + (1.0 - ehlw(mgs))*((Max(0.0,rho00 - rho0(mgs)))/rho00)**2<a name='11494'></font>
<a name='11495'>
       ELSEIF ( iehlw .eq. 3 .or. iehlw .eq. 10 ) THEN <font color=#447700>! use fraction of droplets greater than 15 micron diameter<a name='11496'></font>
         tmp = Exp(- (dmincw/xdia(mgs,lc,1))**3)<a name='11497'>
         ehlw(mgs) = Min( ehlw(mgs), tmp )<a name='11498'>
       ELSEIF ( iehlw .eq. 4 .or. iehlw .eq. 10 ) THEN <font color=#447700>! Cober and List 1993<a name='11499'></font>
         tmp =  &amp;<a name='11500'>
     &amp;   2.0*xdn(mgs,lc)*vtxbar(mgs,lhl,1)*(0.5*xdia(mgs,lc,1))**2 &amp;<a name='11501'>
     &amp;  /(9.0*fadvisc(mgs)*0.5*xdia(mgs,lhl,3))<a name='11502'>
         tmp = Max( 1.5, Min(10.0, tmp) )<a name='11503'>
         ehlw(mgs) = Min( ehlw(mgs), 0.55*Log10(2.51*tmp) )<a name='11504'>
       ENDIF<a name='11505'>
      if ( xdia(mgs,lc,1) .lt. 2.4e-06 ) ehlw(mgs)=0.0<a name='11506'>
       ehlw(mgs) = Min( ehlw0, ehlw(mgs) )<a name='11507'>
<a name='11508'>
       IF ( ibfc == -1 .and. temcg(mgs) &lt; -41.0 ) THEN <a name='11509'>
        ehlw(mgs) = 0.0<a name='11510'>
       ENDIF <a name='11511'>
<a name='11512'>
      end if<a name='11513'>
<font color=#447700>!<a name='11514'></font>
      if ( qx(mgs,lhl).gt.qxmin(lhl) .and. qx(mgs,lr).gt.qxmin(lr)    &amp;<a name='11515'>
<font color=#447700>!     &amp;     .and. temg(mgs) .lt. tfr    &amp;<a name='11516'></font>
     &amp;                               ) then<a name='11517'>
        ehlr(mgs) = 1.0<a name='11518'>
       ehlr(mgs) = Min( ehlr0, ehlr(mgs) )<a name='11519'>
      end if<a name='11520'>
<font color=#447700>!<a name='11521'></font>
      IF ( qx(mgs,ls).gt.qxmin(ls) ) THEN<a name='11522'>
        if ( qx(mgs,lhl).gt.qxmin(lhl)  ) then<a name='11523'>
          ehlsclsn(mgs) = ehls_collsn<a name='11524'>
          ehls(mgs) = ehscnv(mgs)<a name='11525'>
          ehls(mgs) = Min(ehls(mgs),ehsmax)<a name='11526'>
        end if<a name='11527'>
      ENDIF<a name='11528'>
<font color=#447700>!<a name='11529'></font>
      if ( qx(mgs,lhl).gt.qxmin(lhl) .and. qx(mgs,li).gt.qxmin(li) ) then<a name='11530'>
      ehliclsn(mgs) = ehli_collsn<a name='11531'>
      ehli(mgs)=eii0hl*exp(eii1hl*min(temcg(mgs),0.0))<a name='11532'>
      ehli(mgs) = Min( ehimax, Max( ehli(mgs), ehimin ) )<a name='11533'>
      if ( temg(mgs) .gt. 273.15 .or. ( qx(mgs,lc) &lt; qxmin(lc)) ) ehli(mgs) = 0.0<a name='11534'>
      end if<a name='11535'>
<a name='11536'>
      IF ( lis &gt; 1 ) THEN<a name='11537'>
      if ( qx(mgs,lhl).gt.qxmin(lhl) .and. qx(mgs,lis).gt.qxmin(lis) ) then<a name='11538'>
      ehlisclsn(mgs) = ehli_collsn<a name='11539'>
      ehlis(mgs)=eii0*exp(eii1*min(temcg(mgs),0.0))<a name='11540'>
      ehlis(mgs) = Min( ehimax, Max( ehlis(mgs), ehimin ) )<a name='11541'>
      if ( temg(mgs) .gt. 273.15 .or. ( qx(mgs,lc) &lt; qxmin(lc)) ) ehlis(mgs) = 0.0<a name='11542'>
      end if<a name='11543'>
      ENDIF<a name='11544'>
<a name='11545'>
<a name='11546'>
      ENDIF <font color=#447700>! lhl .gt. 1<a name='11547'></font>
<a name='11548'>
      ENDDO  <font color=#447700>! mgs loop for collection efficiencies<a name='11549'></font>
<a name='11550'>
<font color=#447700>!<a name='11551'></font>
<font color=#447700>!<a name='11552'></font>
<font color=#447700>!<a name='11553'></font>
<font color=#447700>!  Set flags for plates vs. columns<a name='11554'></font>
<font color=#447700>!<a name='11555'></font>
<font color=#447700>!<a name='11556'></font>
      do mgs = 1,ngscnt<a name='11557'>
<font color=#447700>!<a name='11558'></font>
      xplate(mgs) = 0.0<a name='11559'>
      xcolmn(mgs) = 1.0<a name='11560'>
<font color=#447700>!<a name='11561'></font>
<font color=#447700>!      if ( temcg(mgs) .lt. 0. .and. temcg(mgs) .ge. -4. ) then<a name='11562'></font>
<font color=#447700>!      xplate(mgs) = 1.0<a name='11563'></font>
<font color=#447700>!      xcolmn(mgs) = 0.0<a name='11564'></font>
<font color=#447700>!      end if<a name='11565'></font>
<font color=#447700>!c<a name='11566'></font>
<font color=#447700>!      if ( temcg(mgs) .lt. -4. .and. temcg(mgs) .ge. -9. ) then<a name='11567'></font>
<font color=#447700>!      xplate(mgs) = 0.0<a name='11568'></font>
<font color=#447700>!      xcolmn(mgs) = 1.0<a name='11569'></font>
<font color=#447700>!      end if<a name='11570'></font>
<font color=#447700>!c<a name='11571'></font>
<font color=#447700>!      if ( temcg(mgs) .lt. -9. .and. temcg(mgs) .ge. -22.5 ) then<a name='11572'></font>
<font color=#447700>!      xplate(mgs) = 1.0<a name='11573'></font>
<font color=#447700>!      xcolmn(mgs) = 0.0<a name='11574'></font>
<font color=#447700>!      end if<a name='11575'></font>
<font color=#447700>!c<a name='11576'></font>
<font color=#447700>!      if ( temcg(mgs) .lt. -22.5 .and. temcg(mgs) .ge. -90. ) then<a name='11577'></font>
<font color=#447700>!      xplate(mgs) = 0.0<a name='11578'></font>
<font color=#447700>!      xcolmn(mgs) = 1.0<a name='11579'></font>
<font color=#447700>!      end if<a name='11580'></font>
<font color=#447700>!<a name='11581'></font>
      end do<a name='11582'>
<font color=#447700>!<a name='11583'></font>
<font color=#447700>!<a name='11584'></font>
<font color=#447700>!<a name='11585'></font>
<font color=#447700>!  Collection growth equations....<a name='11586'></font>
<font color=#447700>!<a name='11587'></font>
<font color=#447700>!<a name='11588'></font>
      if (ndebug .gt. 0 ) write(0,*) 'Collection: rain collects xxxxx'<a name='11589'>
<font color=#447700>!<a name='11590'></font>
      do mgs = 1,ngscnt<a name='11591'>
      qracw(mgs) =  0.0<a name='11592'>
      IF ( qx(mgs,lr) .gt. qxmin(lr) .and. erw(mgs) .gt. 0.0 ) THEN<a name='11593'>
      IF ( ipconc .lt. 3 ) THEN<a name='11594'>
       IF ( erw(mgs) .gt. 0.0 .and. qx(mgs,lr) .gt. 1.e-7 ) THEN<a name='11595'>
       vt = (ar*(xdia(mgs,lc,1)**br))*rhovt(mgs)<a name='11596'>
       qracw(mgs) =    &amp;<a name='11597'>
     &amp;   (0.25)*pi*erw(mgs)*qx(mgs,lc)*cx(mgs,lr) &amp;<a name='11598'>
<font color=#447700>!     &gt;  *abs(vtxbar(mgs,lr,1)-vtxbar(mgs,lc,1))   &amp;<a name='11599'></font>
     &amp;  *Max(0.0, vtxbar(mgs,lr,1)-vt)   &amp;<a name='11600'>
     &amp;  *(  gf3*xdia(mgs,lr,2)    &amp;<a name='11601'>
     &amp;    + 2.0*gf2*xdia(mgs,lr,1)*xdia(mgs,lc,1)    &amp;<a name='11602'>
     &amp;    + gf1*xdia(mgs,lc,2) )<a name='11603'>
<font color=#447700>!       qracw(mgs) = 0.0<a name='11604'></font>
<font color=#447700>!      write(iunit,*) 'qracw,cx =',qracw(mgs),1.e6*xdia(mgs,lr,1),erw(mgs)<a name='11605'></font>
<font color=#447700>!      write(iunit,*) 'qracw,cx =',qracw(mgs),cx(mgs,lc),kgs(mgs),cx(mgs,lr),1.e6*xdia(mgs,lr,1),vtxbar(mgs,lr,1),vt<a name='11606'></font>
<font color=#447700>!      write(iunit,*) 'vtr: ',vtxbar(mgs,lr,1), ar*gf4br/6.0*xdia(mgs,lr,1)**br, rhovt(mgs),<a name='11607'></font>
<font color=#447700>!     :         ar*gf4br/6.0*xdia(mgs,lr,1)**br * rhovt(mgs)<a name='11608'></font>
       ENDIF<a name='11609'>
      ELSE<a name='11610'>
<a name='11611'>
      IF ( dmrauto &lt;= 0 .or.  rho0(mgs)*qx(mgs,lr) &gt; 1.2*xl2p(mgs) ) THEN <a name='11612'>
       rwrad = 0.5*xdia(mgs,lr,3)<a name='11613'>
        IF ( rwrad .gt. rh(mgs) ) THEN <font color=#447700>! .or. cx(mgs,lr) .gt. nh(mgs) ) THEN<a name='11614'></font>
         IF ( rwrad .gt. rwradmn ) THEN<a name='11615'>
<font color=#447700>!      DM1CCC=A2*XNC*XNR*XVC*(((CNU+2.)/(CNU+1.))*XVC+XVR)       ! (A12)<a name='11616'></font>
<font color=#447700>!     NOTE: Result is independent of imurain, assumes mucloud = 3<a name='11617'></font>
           qracw(mgs) = erw(mgs)*aa2*cx(mgs,lr)*cx(mgs,lc)*xmas(mgs,lc)*   &amp;<a name='11618'>
     &amp;        ((cnu + 2.)*xv(mgs,lc)/(cnu + 1.) + xv(mgs,lr))/rho0(mgs) <font color=#447700>!*rhoinv(mgs)<a name='11619'></font>
         ELSE<a name='11620'>
<a name='11621'>
          IF ( imurain == 3 ) THEN<a name='11622'>
<a name='11623'>
<font color=#447700>!      DM1CCC=A1*XNC*XNR*(((CNU+3.)*(CNU+2.)/(CNU+1.)**2)*XVC**3+ ! (A14)<a name='11624'></font>
<font color=#447700>!     1 ((RNU+2.)/(RNU+1.))*XVC*XVR**2)<a name='11625'></font>
<a name='11626'>
<font color=#447700>!           qracw(mgs) = aa1*cx(mgs,lr)*cx(mgs,lc)*xdn(mgs,lc)*   &amp;<a name='11627'></font>
<font color=#447700>!     &amp;        ((cnu + 3.)*(cnu + 2.)*xv(mgs,lc)**3/(cnu + 1.)**2 +    &amp;<a name='11628'></font>
<font color=#447700>!     &amp;         (alpha(mgs,lr) + 2.)*xv(mgs,lc)*xv(mgs,lr)**2/(alpha(mgs,lr) + 1.))/rho0(mgs) !*rhoinv(mgs)<a name='11629'></font>
<font color=#447700>! save multiplies by converting cx*xdn*xv/rho0 to qx<a name='11630'></font>
           qracw(mgs) = aa1*cx(mgs,lr)*qx(mgs,lc)*   &amp;<a name='11631'>
     &amp;        ((cnu + 3.)*(cnu + 2.)*xv(mgs,lc)**2/(cnu + 1.)**2 +    &amp;<a name='11632'>
     &amp;         (alpha(mgs,lr) + 2.)*xv(mgs,lr)**2/(alpha(mgs,lr) + 1.)) <a name='11633'>
           <a name='11634'>
           ELSE <font color=#447700>! imurain == 1<a name='11635'></font>
<a name='11636'>
           qracw(mgs) = aa1*cx(mgs,lr)*qx(mgs,lc)*   &amp;<a name='11637'>
     &amp;        ((cnu + 3.)*(cnu + 2.)*xv(mgs,lc)**2/(cnu + 1.)**2 +    &amp;<a name='11638'>
     &amp;         (alpha(mgs,lr) + 6.)*(alpha(mgs,lr) + 5.)*(alpha(mgs,lr) + 4.)*xv(mgs,lr)**2/ &amp;<a name='11639'>
     &amp;          ((alpha(mgs,lr) + 3.)*(alpha(mgs,lr) + 2.)*(alpha(mgs,lr) + 1.))) <a name='11640'>
           <a name='11641'>
           ENDIF<a name='11642'>
           <a name='11643'>
         ENDIF<a name='11644'>
        ENDIF<a name='11645'>
        ENDIF<a name='11646'>
       ENDIF<a name='11647'>
<font color=#447700>!       qracw(mgs) = Min(qracw(mgs), qx(mgs,lc))<a name='11648'></font>
       qracw(mgs) = Min(qracw(mgs), qcmxd(mgs))<a name='11649'>
       ENDIF<a name='11650'>
      end do<a name='11651'>
<font color=#447700>!<a name='11652'></font>
      do mgs = 1,ngscnt<a name='11653'>
      qraci(mgs) = 0.0<a name='11654'>
      craci(mgs) = 0.0<a name='11655'>
      IF ( eri(mgs) .gt. 0.0 .and. iacr .ge. 1 .and. xdia(mgs,lr,3) .gt. 2.*rwradmn ) THEN<a name='11656'>
        IF ( ipconc .ge. 3 ) THEN<a name='11657'>
<a name='11658'>
           tmp = eri(mgs)*aa2*cx(mgs,lr)*cx(mgs,li)*   &amp;<a name='11659'>
     &amp;        ((cinu + 2.)*xv(mgs,li)/(cinu + 1.) + xv(mgs,lr))<a name='11660'>
<a name='11661'>
        qraci(mgs) = Min( qxmxd(mgs,li), tmp*xmas(mgs,li)*rhoinv(mgs) )<a name='11662'>
        craci(mgs) = Min( cxmxd(mgs,li), tmp )<a name='11663'>
<a name='11664'>
<font color=#447700>!       vt = Sqrt((vtxbar(mgs,lr,1)-vtxbar(mgs,li,1))**2 +<a name='11665'></font>
<font color=#447700>!     :            0.04*vtxbar(mgs,lr,1)*vtxbar(mgs,li,1) )<a name='11666'></font>
<font color=#447700>!<a name='11667'></font>
<font color=#447700>!          qraci(mgs) = 0.25*pi*eri(mgs)*cx(mgs,lr)*qx(mgs,li)*vt*<a name='11668'></font>
<font color=#447700>!     :         (  da0(lr)*xdia(mgs,lr,3)**2 +<a name='11669'></font>
<font color=#447700>!     :            dab1(lr,li)*xdia(mgs,lr,3)*xdia(mgs,li,3) +<a name='11670'></font>
<font color=#447700>!     :            da1(li)*xdia(mgs,li,3)**2 )<a name='11671'></font>
<font color=#447700>!<a name='11672'></font>
<font color=#447700>!<a name='11673'></font>
<font color=#447700>!       vt = Sqrt((vtxbar(mgs,lr,1)-vtxbar(mgs,li,1))**2 +<a name='11674'></font>
<font color=#447700>!     :            0.04*vtxbar(mgs,lr,1)*vtxbar(mgs,li,1) )<a name='11675'></font>
<font color=#447700>!<a name='11676'></font>
<font color=#447700>!          craci(mgs) = 0.25*pi*eri(mgs)*cx(mgs,lr)*cx(mgs,li)*vt*<a name='11677'></font>
<font color=#447700>!     :         (  da0(lr)*xdia(mgs,lr,3)**2 +<a name='11678'></font>
<font color=#447700>!     :            dab0(lr,li)*xdia(mgs,lr,3)*xdia(mgs,li,3) +<a name='11679'></font>
<font color=#447700>!     :            da0(li)*xdia(mgs,li,3)**2 )<a name='11680'></font>
<font color=#447700>!<a name='11681'></font>
<font color=#447700>!          qraci(mgs) = Min( qraci(mgs), qxmxd(mgs,li) )<a name='11682'></font>
<font color=#447700>!          craci(mgs) = Min( craci(mgs), cxmxd(mgs,li) )<a name='11683'></font>
<a name='11684'>
        ELSE<a name='11685'>
          qraci(mgs) =    &amp;<a name='11686'>
     &amp;     min(   &amp;<a name='11687'>
     &amp;     (0.25)*pi*eri(mgs)*qx(mgs,li)*cx(mgs,lr)   &amp;<a name='11688'>
     &amp;    *abs(vtxbar(mgs,lr,1)-vtxbar(mgs,li,1))   &amp;<a name='11689'>
     &amp;    *(  gf3*xdia(mgs,lr,2)    &amp;<a name='11690'>
     &amp;      + 2.0*gf2*xdia(mgs,lr,1)*xdia(mgs,li,1)    &amp;<a name='11691'>
     &amp;      + gf1*xdia(mgs,li,2) )     &amp;<a name='11692'>
     &amp;    , qimxd(mgs))<a name='11693'>
        ENDIF<a name='11694'>
      if ( temg(mgs) .gt. 268.15 ) then<a name='11695'>
      qraci(mgs) = 0.0<a name='11696'>
      end if<a name='11697'>
      ENDIF<a name='11698'>
      end do<a name='11699'>
<font color=#447700>!<a name='11700'></font>
      do mgs = 1,ngscnt<a name='11701'>
      qracs(mgs) =  0.0<a name='11702'>
      IF ( ers(mgs) .gt. 0.0 .and. ipconc &lt; 3 ) THEN<a name='11703'>
       IF ( lwsm6 .and. ipconc == 0 ) THEN<a name='11704'>
         vt = vt2ave(mgs)<a name='11705'>
       ELSE<a name='11706'>
         vt = vtxbar(mgs,ls,1)<a name='11707'>
       ENDIF<a name='11708'>
      qracs(mgs) =      &amp;<a name='11709'>
     &amp;   min(     &amp;<a name='11710'>
     &amp;   ((0.25)*pi/gf4)*ers(mgs)*qx(mgs,ls)*cx(mgs,lr)     &amp;<a name='11711'>
     &amp;  *abs(vtxbar(mgs,lr,1)-vt)     &amp;<a name='11712'>
     &amp;  *(  gf6*gf1*xdia(mgs,ls,2)     &amp;<a name='11713'>
     &amp;    + 2.0*gf5*gf2*xdia(mgs,ls,1)*xdia(mgs,lr,1)      &amp;<a name='11714'>
     &amp;    + gf4*gf3*xdia(mgs,lr,2) )      &amp;<a name='11715'>
     &amp;  , qsmxd(mgs))<a name='11716'>
      ENDIF<a name='11717'>
      end do<a name='11718'>
<a name='11719'>
<font color=#447700>!<a name='11720'></font>
<font color=#447700>!<a name='11721'></font>
      if (ndebug .gt. 0 ) write(0,*) 'Collection: snow collects xxxxx'<a name='11722'>
<font color=#447700>!<a name='11723'></font>
      do mgs = 1,ngscnt<a name='11724'>
      qsacw(mgs) =  0.0<a name='11725'>
      csacw(mgs) =  0.0<a name='11726'>
      vsacw(mgs) =  0.0<a name='11727'>
      IF ( esw(mgs) .gt. 0.0 ) THEN<a name='11728'>
<a name='11729'>
       IF ( ipconc .ge. 4 ) THEN<a name='11730'>
<font color=#447700>!      QSACC=CECS*RVT*A2*XNC*XNS*XVC*ROS*<a name='11731'></font>
<font color=#447700>!     *    (((CNU+2.)/(CNU+1.))*XVC+XVS)/RO<a name='11732'></font>
<a name='11733'>
<font color=#447700>!        tmp = esw(mgs)*rvt*aa2*cx(mgs,ls)*cx(mgs,lc)*<a name='11734'></font>
<font color=#447700>!     :        ((cnu + 2.)*xv(mgs,lc)/(cnu + 1.) + xv(mgs,ls))<a name='11735'></font>
        tmp = 1.0*rvt*aa2*cx(mgs,ls)*cx(mgs,lc)*   &amp;<a name='11736'>
     &amp;        ((cnu + 2.)*xv(mgs,lc)/(cnu + 1.) + xv(mgs,ls))<a name='11737'>
<a name='11738'>
        qsacw(mgs) = Min( qxmxd(mgs,lc), tmp*xmas(mgs,lc)*rhoinv(mgs) )<a name='11739'>
        csacw(mgs) = Min( cxmxd(mgs,lc), tmp )<a name='11740'>
<a name='11741'>
          IF ( lvol(ls) .gt. 1 ) THEN<a name='11742'>
             IF ( temg(mgs) .lt. 273.15) THEN<a name='11743'>
             rimdn(mgs,ls) = rimc1*(-((0.5)*(1.e+06)*xdia(mgs,lc,1))   &amp;<a name='11744'>
     &amp;                *((0.60)*vtxbar(mgs,ls,1))   &amp;<a name='11745'>
     &amp;                /(temg(mgs)-273.15))**(rimc2)<a name='11746'>
             rimdn(mgs,ls) = Min( Max( rimc3, rimdn(mgs,ls) ), rimc4 )<a name='11747'>
             ELSE<a name='11748'>
             rimdn(mgs,ls) = 1000.<a name='11749'>
             ENDIF<a name='11750'>
<a name='11751'>
           vsacw(mgs) = rho0(mgs)*qsacw(mgs)/rimdn(mgs,ls)<a name='11752'>
<a name='11753'>
          ENDIF<a name='11754'>
<a name='11755'>
<a name='11756'>
<font color=#447700>!        qsacw(mgs) = cecs*aa2*cx(mgs,ls)*cx(mgs,lc)*xmas(mgs,lc)*<a name='11757'></font>
<font color=#447700>!     :        ((cnu + 2.)*xv(mgs,lc)/(cnu + 1.) + xv(mgs,ls))*rhoinv(mgs)<a name='11758'></font>
       ELSE<a name='11759'>
<font color=#447700>!      qsacw(mgs) =<a name='11760'></font>
<font color=#447700>!     &gt;   min(<a name='11761'></font>
<font color=#447700>!     &gt;   ((0.25)*pi)*esw(mgs)*qx(mgs,lc)*cx(mgs,ls)<a name='11762'></font>
<font color=#447700>!     &gt;  *abs(vtxbar(mgs,ls,1)-vtxbar(mgs,lc,1))<a name='11763'></font>
<font color=#447700>!     &gt;  *(  gf3*xdia(mgs,ls,2)<a name='11764'></font>
<font color=#447700>!     &gt;    + 2.0*gf2*xdia(mgs,ls,1)*xdia(mgs,lc,1)<a name='11765'></font>
<font color=#447700>!     &gt;    + gf1*xdia(mgs,lc,2) )<a name='11766'></font>
<font color=#447700>!     &lt;  , qcmxd(mgs))<a name='11767'></font>
<a name='11768'>
            vt = abs(vtxbar(mgs,ls,1)-vtxbar(mgs,lc,1))<a name='11769'>
<a name='11770'>
          qsacw(mgs) = 0.25*pi*esw(mgs)*cx(mgs,ls)*qx(mgs,lc)*vt*   &amp;<a name='11771'>
     &amp;         (  da0(ls)*xdia(mgs,ls,3)**2 +     &amp;<a name='11772'>
     &amp;            dab1(ls,lc)*xdia(mgs,ls,3)*xdia(mgs,lc,3) +    &amp;<a name='11773'>
     &amp;            da1(lc)*xdia(mgs,lc,3)**2 )<a name='11774'>
        qsacw(mgs) = Min( qsacw(mgs), qxmxd(mgs,ls) )<a name='11775'>
        csacw(mgs) = rho0(mgs)*qsacw(mgs)/xmas(mgs,lc)<a name='11776'>
       ENDIF<a name='11777'>
      ENDIF<a name='11778'>
      end do<a name='11779'>
<font color=#447700>!<a name='11780'></font>
<font color=#447700>!<a name='11781'></font>
      do mgs = 1,ngscnt<a name='11782'>
      qsaci(mgs) = 0.0<a name='11783'>
      csaci(mgs) = 0.0<a name='11784'>
      csaci0(mgs) = 0.0<a name='11785'>
      IF ( ipconc .ge. 4 ) THEN<a name='11786'>
      IF ( esi(mgs) .gt. 0.0 .or. ( ipelec &gt; 0 .and. esiclsn(mgs) &gt; 0.0 )) THEN<a name='11787'>
<font color=#447700>!      QSCOI=CEXS*RVT*A2*XNCI*XNS*XVCI*ROS*<a name='11788'></font>
<font color=#447700>!     *  (((CINU+2.)/(CINU+1.))*VCIP+XVS)/RO<a name='11789'></font>
<a name='11790'>
        tmp = esiclsn(mgs)*rvt*aa2*cx(mgs,ls)*cx(mgs,li)*   &amp;<a name='11791'>
     &amp;        ((cinu + 2.)*xv(mgs,li)/(cinu + 1.) + xv(mgs,ls))<a name='11792'>
<a name='11793'>
        qsaci(mgs) = Min( qxmxd(mgs,li), esi(mgs)*tmp*xmas(mgs,li)*rhoinv(mgs) )<a name='11794'>
        csaci0(mgs) = tmp<a name='11795'>
        csaci(mgs) = Min(cxmxd(mgs,li), esi(mgs)*tmp )<a name='11796'>
<a name='11797'>
<font color=#447700>!      qsaci(mgs) =<a name='11798'></font>
<font color=#447700>!     &gt;   min(<a name='11799'></font>
<font color=#447700>!     &gt;   ((0.25)*pi)*esi(mgs)*qx(mgs,li)*cx(mgs,ls)<a name='11800'></font>
<font color=#447700>!     &gt;  *abs(vtxbar(mgs,ls,1)-vtxbar(mgs,li,1))<a name='11801'></font>
<font color=#447700>!     &gt;  *(  gf3*xdia(mgs,ls,2)<a name='11802'></font>
<font color=#447700>!     &gt;    + 2.0*gf2*xdia(mgs,ls,1)*xdia(mgs,li,1)<a name='11803'></font>
<font color=#447700>!     &gt;    + gf1*xdia(mgs,li,2) )<a name='11804'></font>
<font color=#447700>!     &lt;  , qimxd(mgs))<a name='11805'></font>
      ENDIF<a name='11806'>
      ELSE <font color=#447700>! <a name='11807'></font>
      IF ( esi(mgs) .gt. 0.0 ) THEN<a name='11808'>
         qsaci(mgs) =    &amp;<a name='11809'>
     &amp;   min(   &amp;<a name='11810'>
     &amp;   ((0.25)*pi)*esi(mgs)*qx(mgs,li)*cx(mgs,ls)   &amp;<a name='11811'>
     &amp;  *abs(vtxbar(mgs,ls,1)-vtxbar(mgs,li,1))   &amp;<a name='11812'>
     &amp;  *(  gf3*xdia(mgs,ls,2)    &amp;<a name='11813'>
     &amp;    + 2.0*gf2*xdia(mgs,ls,1)*xdia(mgs,li,1)    &amp;<a name='11814'>
     &amp;    + gf1*xdia(mgs,li,2) )     &amp;<a name='11815'>
     &amp;  , qimxd(mgs))<a name='11816'>
      ENDIF<a name='11817'>
      ENDIF<a name='11818'>
      end do<a name='11819'>
<font color=#447700>!<a name='11820'></font>
<font color=#447700>!<a name='11821'></font>
<font color=#447700>!<a name='11822'></font>
      do mgs = 1,ngscnt<a name='11823'>
      qsacr(mgs) = 0.0<a name='11824'>
      qsacrs(mgs) = 0.0<a name='11825'>
      csacr(mgs) = 0.0<a name='11826'>
      IF ( esr(mgs) .gt. 0.0 ) THEN<a name='11827'>
      IF ( ipconc .ge. 3 ) THEN<a name='11828'>
<font color=#447700>!       vt = Sqrt((vtxbar(mgs,ls,1)-vtxbar(mgs,lr,1))**2 + <a name='11829'></font>
<font color=#447700>!     :            0.04*vtxbar(mgs,ls,1)*vtxbar(mgs,lr,1) )<a name='11830'></font>
<font color=#447700>!       qsacr(mgs) = esr(mgs)*cx(mgs,ls)*vt*<a name='11831'></font>
<font color=#447700>!     :     qx(mgs,lr)*0.25*pi*<a name='11832'></font>
<font color=#447700>!     :      (3.02787*xdia(mgs,lr,2) + <a name='11833'></font>
<font color=#447700>!     :       3.30669*xdia(mgs,ls,1)*xdia(mgs,lr,1) + <a name='11834'></font>
<font color=#447700>!     :       2.*xdia(mgs,ls,2))<a name='11835'></font>
<font color=#447700>!        qsacr(mgs) = Min( qsacr(mgs), qrmxd(mgs) )<a name='11836'></font>
<font color=#447700>!        csacr(mgs) = qsacr(mgs)*cx(mgs,lr)/qx(mgs,lr)<a name='11837'></font>
<font color=#447700>!        csacr(mgs) = min(csacr(mgs),crmxd(mgs))<a name='11838'></font>
      ELSE<a name='11839'>
       IF ( lwsm6 .and. ipconc == 0 ) THEN<a name='11840'>
         vt = vt2ave(mgs)<a name='11841'>
       ELSE<a name='11842'>
         vt = vtxbar(mgs,ls,1)<a name='11843'>
       ENDIF<a name='11844'>
       <a name='11845'>
       qsacr(mgs) =   &amp;<a name='11846'>
     &amp;   min(   &amp;<a name='11847'>
     &amp;   ((0.25)*pi/gf4)*esr(mgs)*qx(mgs,lr)*cx(mgs,ls)   &amp;<a name='11848'>
     &amp;  *abs(vtxbar(mgs,lr,1)-vt)   &amp;<a name='11849'>
     &amp;  *(  gf6*gf1*xdia(mgs,lr,2)   &amp;<a name='11850'>
     &amp;    + 2.0*gf5*gf2*xdia(mgs,lr,1)*xdia(mgs,ls,1)    &amp;<a name='11851'>
     &amp;    + gf4*gf3*xdia(mgs,ls,2) )    &amp;<a name='11852'>
     &amp;  , qrmxd(mgs))<a name='11853'>
      ENDIF<a name='11854'>
      ENDIF<a name='11855'>
      end do<a name='11856'>
<font color=#447700>!<a name='11857'></font>
<font color=#447700>!<a name='11858'></font>
<font color=#447700>!<a name='11859'></font>
      if (ndebug .gt. 0 ) write(0,*) 'Collection: graupel collects xxxxx'<a name='11860'>
<font color=#447700>!<a name='11861'></font>
      do mgs = 1,ngscnt<a name='11862'>
      qhacw(mgs) = 0.0<a name='11863'>
      rarx(mgs,lh) = 0.0<a name='11864'>
      vhacw(mgs) = 0.0<a name='11865'>
      vhsoak(mgs) = 0.0<a name='11866'>
      zhacw(mgs) = 0.0<a name='11867'>
      <a name='11868'>
      IF ( .false. ) THEN<a name='11869'>
        vtmax = (gz(igs(mgs),jgs,kgs(mgs))/dtp)<a name='11870'>
        vtxbar(mgs,lh,1) = Min( vtmax, vtxbar(mgs,lh,1))<a name='11871'>
        vtxbar(mgs,lh,2) = Min( vtmax, vtxbar(mgs,lh,2))<a name='11872'>
        vtxbar(mgs,lh,3) = Min( vtmax, vtxbar(mgs,lh,3))<a name='11873'>
      ENDIF<a name='11874'>
      IF ( ehw(mgs) .gt. 0.0 ) THEN<a name='11875'>
<a name='11876'>
        IF ( ipconc .ge. 2 ) THEN<a name='11877'>
<a name='11878'>
        IF ( .false. ) THEN  <a name='11879'>
        qhacw(mgs) = (ehw(mgs)*qx(mgs,lc)*cx(mgs,lh)*pi*   &amp;<a name='11880'>
     &amp;    abs(vtxbar(mgs,lh,1)-vtxbar(mgs,lc,1))*   &amp;<a name='11881'>
     &amp;    (2.0*xdia(mgs,lh,1)*(xdia(mgs,lh,1) +    &amp;<a name='11882'>
     &amp;         xdia(mgs,lc,1)*gf73rds) +    &amp;<a name='11883'>
     &amp;      xdia(mgs,lc,2)*gf83rds))/4.     <a name='11884'>
     <a name='11885'>
         ELSE  <font color=#447700>! using Seifert coefficients<a name='11886'></font>
            vt = abs(vtxbar(mgs,lh,1)-vtxbar(mgs,lc,1)) <a name='11887'>
<a name='11888'>
          qhacw(mgs) = 0.25*pi*ehw(mgs)*cx(mgs,lh)*qx(mgs,lc)*vt*   &amp;<a name='11889'>
     &amp;         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +     &amp;<a name='11890'>
     &amp;            dab1lh(mgs,lc,lh)*xdia(mgs,lh,3)*xdia(mgs,lc,3) +    &amp;<a name='11891'>
     &amp;            da1(lc)*xdia(mgs,lc,3)**2 ) <a name='11892'>
         <a name='11893'>
         ENDIF<a name='11894'>
          qhacw(mgs) = Min( qhacw(mgs), 0.5*qx(mgs,lc)/dtp )<a name='11895'>
        <a name='11896'>
         IF ( lzh .gt. 1 ) THEN<a name='11897'>
          tmp = qx(mgs,lh)/cx(mgs,lh)<a name='11898'>
          <a name='11899'>
<font color=#447700>!!          g1 = (6.0 + alpha(mgs,lh))*(5.0 + alpha(mgs,lh))*(4.0 + alpha(mgs,lh))/<a name='11900'></font>
<font color=#447700>!!     :         ((3.0 + alpha(mgs,lh))*(2.0 + alpha(mgs,lh))*(1.0 + alpha(mgs,lh)))<a name='11901'></font>
<font color=#447700>!          alp = Max( 1.0, alpha(mgs,lh)+1. )<a name='11902'></font>
<font color=#447700>!          g1 = (6.0 + alp)*(5.0 + alp)*(4.0 + alp)/<a name='11903'></font>
<font color=#447700>!     :         ((3.0 + alp)*(2.0 + alp)*(1.0 + alp))<a name='11904'></font>
<font color=#447700>!          zhacw(mgs) =  g1*(6.*rho0(mgs)/(pi*1000.))**2*( 2.*( qx(mgs,lh)/cx(mgs,lh)) * qhacw(mgs) )<a name='11905'></font>
         ENDIF<a name='11906'>
        <a name='11907'>
        ELSE<a name='11908'>
         qhacw(mgs) =    &amp;<a name='11909'>
     &amp;   min(   &amp;<a name='11910'>
     &amp;   ((0.25)*pi)*ehw(mgs)*qx(mgs,lc)*cx(mgs,lh)   &amp;<a name='11911'>
     &amp;  *abs(vtxbar(mgs,lh,1)-vtxbar(mgs,lc,1))   &amp;<a name='11912'>
     &amp;  *(  gf3*xdia(mgs,lh,2)    &amp;<a name='11913'>
     &amp;    + 2.0*gf2*xdia(mgs,lh,1)*xdia(mgs,lc,1)    &amp;<a name='11914'>
     &amp;    + gf1*xdia(mgs,lc,2) )     &amp;<a name='11915'>
     &amp;    , 0.5*qx(mgs,lc)/dtp)<a name='11916'>
<font color=#447700>!     &lt;  , qxmxd(mgs,lc))<a name='11917'></font>
<font color=#447700>!     &lt;  , qcmxd(mgs))<a name='11918'></font>
       <a name='11919'>
       <a name='11920'>
         IF ( lwsm6 .and. qsacw(mgs) &gt; 0.0 .and.  qhacw(mgs) &gt; 0.0) THEN<a name='11921'>
           qaacw = ( qx(mgs,ls)*qsacw(mgs) + qx(mgs,lh)*qhacw(mgs) )/(qx(mgs,ls) + qx(mgs,lh))<a name='11922'>
<font color=#447700>!           qaacw = Min( qaacw, 0.5*(qsacw(mgs) + qhacw(mgs) ) )<a name='11923'></font>
           qsacw(mgs) = qaacw<a name='11924'>
           qhacw(mgs) = qaacw<a name='11925'>
         ENDIF<a name='11926'>
         <a name='11927'>
       ENDIF<a name='11928'>
<a name='11929'>
          IF ( lvol(lh) .gt. 1 .or. lhl .gt. 1 ) THEN <font color=#447700>! calculate rime density for graupel volume and/or for graupel conversion to hail<a name='11930'></font>
             <a name='11931'>
             IF ( temg(mgs) .lt. 273.15) THEN<a name='11932'>
             rimdn(mgs,lh) = rimc1*(-((0.5)*(1.e+06)*xdia(mgs,lc,1))   &amp;<a name='11933'>
     &amp;                *((0.60)*vtxbar(mgs,lh,1))   &amp;<a name='11934'>
     &amp;                /(temg(mgs)-273.15))**(rimc2)<a name='11935'>
<font color=#447700>!             rimdn(mgs,lh) = Min( Max( hdnmn, rimc3, rimdn(mgs,lh) ), rimc4 )<a name='11936'></font>
             rimdn(mgs,lh) = Min( Max( rimc3, rimdn(mgs,lh) ), rimc4 )<a name='11937'>
             ELSE<a name='11938'>
             rimdn(mgs,lh) = 1000.<a name='11939'>
             ENDIF<a name='11940'>
             <a name='11941'>
             IF ( lvol(lh) &gt; 1 ) vhacw(mgs) = rho0(mgs)*qhacw(mgs)/rimdn(mgs,lh)<a name='11942'>
<a name='11943'>
          ENDIF<a name='11944'>
      <a name='11945'>
        IF ( qx(mgs,lh) .gt. qxmin(lh) .and. ipelec .ge. 1 ) THEN<a name='11946'>
         rarx(mgs,lh) =     &amp;<a name='11947'>
     &amp;    qhacw(mgs)*1.0e3*rho0(mgs)/((pi/2.0)*xdia(mgs,lh,2)*cx(mgs,lh))<a name='11948'>
        ENDIF<a name='11949'>
      <a name='11950'>
      ENDIF  <a name='11951'>
      end do   <a name='11952'>
<font color=#447700>!<a name='11953'></font>
<font color=#447700>!<a name='11954'></font>
      do mgs = 1,ngscnt<a name='11955'>
      qhaci(mgs) = 0.0<a name='11956'>
      qhaci0(mgs) = 0.0<a name='11957'>
      IF ( ehi(mgs) .gt. 0.0 ) THEN<a name='11958'>
       IF (  ipconc .ge. 5 ) THEN<a name='11959'>
<a name='11960'>
       vt = Sqrt((vtxbar(mgs,lh,1)-vtxbar(mgs,li,1))**2 +    &amp;<a name='11961'>
     &amp;            0.04*vtxbar(mgs,lh,1)*vtxbar(mgs,li,1) )<a name='11962'>
<a name='11963'>
          qhaci0(mgs) = 0.25*pi*ehiclsn(mgs)*cx(mgs,lh)*qx(mgs,li)*vt*   &amp;<a name='11964'>
     &amp;         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +     &amp;<a name='11965'>
     &amp;            dab1lh(mgs,li,lh)*xdia(mgs,lh,3)*xdia(mgs,li,3) +    &amp;<a name='11966'>
     &amp;            da1(li)*xdia(mgs,li,3)**2 ) <a name='11967'>
          qhaci(mgs) = Min( ehi(mgs)*qhaci0(mgs), qimxd(mgs) )<a name='11968'>
       ELSE<a name='11969'>
        qhaci(mgs) =    &amp;<a name='11970'>
     &amp;  min(   &amp;<a name='11971'>
     &amp;  ((0.25)*pi)*ehi(mgs)*ehiclsn(mgs)*qx(mgs,li)*cx(mgs,lh)   &amp;<a name='11972'>
     &amp;  *abs(vtxbar(mgs,lh,1)-vtxbar(mgs,li,1))   &amp;<a name='11973'>
     &amp;  *(  gf3*xdia(mgs,lh,2)    &amp;<a name='11974'>
     &amp;    + 2.0*gf2*xdia(mgs,lh,1)*xdia(mgs,li,1)    &amp;<a name='11975'>
     &amp;    + gf1*xdia(mgs,li,2) )     &amp;<a name='11976'>
     &amp;  , qimxd(mgs))<a name='11977'>
       ENDIF<a name='11978'>
      ENDIF<a name='11979'>
      end do   <a name='11980'>
<a name='11981'>
<a name='11982'>
      IF ( lis &gt; 1 .and. ipconc &gt;= 5 ) THEN<a name='11983'>
      do mgs = 1,ngscnt<a name='11984'>
      qhacis(mgs) = 0.0<a name='11985'>
      qhacis0(mgs) = 0.0<a name='11986'>
      IF ( ehis(mgs) .gt. 0.0 ) THEN<a name='11987'>
<a name='11988'>
       vt = Sqrt((vtxbar(mgs,lh,1)-vtxbar(mgs,lis,1))**2 +    &amp;<a name='11989'>
     &amp;            0.04*vtxbar(mgs,lh,1)*vtxbar(mgs,lis,1) )<a name='11990'>
<a name='11991'>
          qhacis0(mgs) = 0.25*pi*ehisclsn(mgs)*cx(mgs,lh)*qx(mgs,lis)*vt*   &amp;<a name='11992'>
     &amp;         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +     &amp;<a name='11993'>
     &amp;            dab1lh(mgs,lis,lh)*xdia(mgs,lh,3)*xdia(mgs,lis,3) +    &amp;<a name='11994'>
     &amp;            da1(li)*xdia(mgs,lis,3)**2 ) <a name='11995'>
          qhacis(mgs) = Min( ehis(mgs)*qhacis0(mgs), qxmxd(mgs,lis) )<a name='11996'>
      ENDIF<a name='11997'>
      end do<a name='11998'>
      ENDIF<a name='11999'>
<a name='12000'>
<font color=#447700>!<a name='12001'></font>
<font color=#447700>!<a name='12002'></font>
      do mgs = 1,ngscnt<a name='12003'>
      qhacs(mgs) = 0.0<a name='12004'>
      qhacs0(mgs) = 0.0<a name='12005'>
      IF ( ehs(mgs) .gt. 0.0 ) THEN<a name='12006'>
       IF ( ipconc .ge. 5 ) THEN<a name='12007'>
<a name='12008'>
       vt = Sqrt((vtxbar(mgs,lh,1)-vtxbar(mgs,ls,1))**2 +    &amp;<a name='12009'>
     &amp;            0.04*vtxbar(mgs,lh,1)*vtxbar(mgs,ls,1) )<a name='12010'>
<a name='12011'>
          qhacs0(mgs) = 0.25*pi*ehsclsn(mgs)*cx(mgs,lh)*qx(mgs,ls)*vt*   &amp;<a name='12012'>
     &amp;         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +     &amp;<a name='12013'>
     &amp;            dab1lh(mgs,ls,lh)*xdia(mgs,lh,3)*xdia(mgs,ls,3) +    &amp;<a name='12014'>
     &amp;            da1(ls)*xdia(mgs,ls,3)**2 ) <a name='12015'>
      <a name='12016'>
          qhacs(mgs) = Min( ehs(mgs)*qhacs0(mgs), qsmxd(mgs) )<a name='12017'>
<a name='12018'>
       ELSE<a name='12019'>
         qhacs(mgs) =   &amp;<a name='12020'>
     &amp;   min(   &amp;<a name='12021'>
     &amp;   ((0.25)*pi/gf4)*ehs(mgs)*ehsclsn(mgs)*qx(mgs,ls)*cx(mgs,lh)   &amp;<a name='12022'>
     &amp;  *abs(vtxbar(mgs,lh,1)-vtxbar(mgs,ls,1))   &amp;<a name='12023'>
     &amp;  *(  gf6*gf1*xdia(mgs,ls,2)   &amp;<a name='12024'>
     &amp;    + 2.0*gf5*gf2*xdia(mgs,ls,1)*xdia(mgs,lh,1)   &amp;<a name='12025'>
     &amp;    + gf4*gf3*xdia(mgs,lh,2) )   &amp;<a name='12026'>
     &amp;  , qsmxd(mgs))<a name='12027'>
        ENDIF<a name='12028'>
      ENDIF<a name='12029'>
      end do   <a name='12030'>
<font color=#447700>!<a name='12031'></font>
      do mgs = 1,ngscnt<a name='12032'>
      qhacr(mgs) = 0.0<a name='12033'>
      qhacrmlr(mgs) = 0.0<a name='12034'>
      vhacr(mgs) = 0.0<a name='12035'>
      chacr(mgs) = 0.0<a name='12036'>
      zhacr(mgs) = 0.0<a name='12037'>
      IF ( temg(mgs) .gt. tfr ) raindn(mgs,lh) = 1000.0<a name='12038'>
<a name='12039'>
      IF ( ehr(mgs) .gt. 0.0 ) THEN<a name='12040'>
      IF ( ipconc .ge. 3 ) THEN<a name='12041'>
       vt = Sqrt((vtxbar(mgs,lh,1)-vtxbar(mgs,lr,1))**2 +    &amp;<a name='12042'>
     &amp;            0.04*vtxbar(mgs,lh,1)*vtxbar(mgs,lr,1) )<a name='12043'>
<font color=#447700>!       qhacr(mgs) = ehr(mgs)*cx(mgs,lh)*vt*<a name='12044'></font>
<font color=#447700>!     :     qx(mgs,lr)*0.25*pi*<a name='12045'></font>
<font color=#447700>!     :      (3.02787*xdia(mgs,lr,2) + <a name='12046'></font>
<font color=#447700>!     :       3.30669*xdia(mgs,lh,1)*xdia(mgs,lr,1) + <a name='12047'></font>
<font color=#447700>!     :       2.*xdia(mgs,lh,2))<a name='12048'></font>
     <a name='12049'>
       qhacr(mgs) = 0.25*pi*ehr(mgs)*cx(mgs,lh)*qx(mgs,lr)*vt*   &amp;<a name='12050'>
     &amp;         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +     &amp;<a name='12051'>
     &amp;            dab1lh(mgs,lr,lh)*xdia(mgs,lh,3)*xdia(mgs,lr,3) +    &amp;<a name='12052'>
     &amp;            da1(lr)*xdia(mgs,lr,3)**2 )<a name='12053'>
<font color=#447700>!       IF ( qhacr(mgs) .gt. 0. .or. tmp .gt. 0.0 ) write(0,*) 'qhacr= ',qhacr(mgs),tmp<a name='12054'></font>
<font color=#447700>!!        qhacr(mgs) = Min( qhacr(mgs), qrmxd(mgs) )<a name='12055'></font>
<font color=#447700>!!        chacr(mgs) = qhacr(mgs)*cx(mgs,lr)/qx(mgs,lr)<a name='12056'></font>
<font color=#447700>!!        chacr(mgs) = min(chacr(mgs),crmxd(mgs))<a name='12057'></font>
<a name='12058'>
        qhacr(mgs) = Min( qhacr(mgs), qxmxd(mgs,lr) )<a name='12059'>
<a name='12060'>
        IF ( temg(mgs) &gt; tfr ) THEN<a name='12061'>
          qhacrmlr(mgs) = qhacr(mgs)<a name='12062'>
          qhacr(mgs) = 0.0<a name='12063'>
        ELSE<a name='12064'>
<font color=#447700>!        chacr(mgs) = Min( qhacr(mgs)*rho0(mgs)/xmas(mgs,lr), cxmxd(mgs,lr) )<a name='12065'></font>
<a name='12066'>
<font color=#447700>!       chacr(mgs) = ehr(mgs)*cx(mgs,lh)*vt*<a name='12067'></font>
<font color=#447700>!     :     cx(mgs,lr)*0.25*pi*<a name='12068'></font>
<font color=#447700>!     :      (0.69874*xdia(mgs,lr,2) +<a name='12069'></font>
<font color=#447700>!     :       1.24001*xdia(mgs,lh,1)*xdia(mgs,lr,1) +<a name='12070'></font>
<font color=#447700>!     :       2.*xdia(mgs,lh,2))<a name='12071'></font>
<a name='12072'>
<font color=#447700>!        chacr(mgs) = 0.25*pi*ehr(mgs)*cx(mgs,lh)*cx(mgs,lr)*vt*<a name='12073'></font>
<font color=#447700>!     :         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +<a name='12074'></font>
<font color=#447700>!     :            dab0lh(mgs,lr)*xdia(mgs,lh,3)*xdia(mgs,lr,3) +<a name='12075'></font>
<font color=#447700>!     :            da0(lr)*xdia(mgs,lr,3)**2 )<a name='12076'></font>
<a name='12077'>
<font color=#447700>!       IF ( qhacr(mgs) .gt. 0. .or. tmp .gt. 0.0 ) write(0,*) 'chacr= ',chacr(mgs),tmp<a name='12078'></font>
<a name='12079'>
        chacr(mgs) = qhacr(mgs)*cx(mgs,lr)/qx(mgs,lr)<a name='12080'>
        chacr(mgs) = min(chacr(mgs),crmxd(mgs))<a name='12081'>
<a name='12082'>
      IF ( lzh .gt. 1 ) THEN<a name='12083'>
          tmp = qx(mgs,lh)/cx(mgs,lh)<a name='12084'>
<a name='12085'>
<font color=#447700>!          g1 = (6.0 + alpha(mgs,lh))*(5.0 + alpha(mgs,lh))*(4.0 + alpha(mgs,lh))/<a name='12086'></font>
<font color=#447700>!     :         ((3.0 + alpha(mgs,lh))*(2.0 + alpha(mgs,lh))*(1.0 + alpha(mgs,lh)))<a name='12087'></font>
<font color=#447700>!          alp = Max( 1.0, alpha(mgs,lh)+1. )<a name='12088'></font>
<font color=#447700>!          g1 = (6.0 + alp)*(5.0 + alp)*(4.0 + alp)/<a name='12089'></font>
<font color=#447700>!     :         ((3.0 + alp)*(2.0 + alp)*(1.0 + alp))<a name='12090'></font>
<font color=#447700>!        zhacr(mgs) =  g1*(6.*rho0(mgs)/(pi*1000.))**2*( 2.*( tmp ) * qhacr(mgs) - tmp**2 * chacr(mgs) )<a name='12091'></font>
<font color=#447700>!        zhacr(mgs) =  g1*(6.*rho0(mgs)/(pi*xdn(mgs,lh)))**2*( 2.*( tmp ) * qhacr(mgs) )<a name='12092'></font>
      ENDIF<a name='12093'>
      ENDIF <font color=#447700>! temg &gt; tfr<a name='12094'></font>
      <a name='12095'>
      ELSE<a name='12096'>
       IF ( lwsm6 .and. ipconc == 0 ) THEN<a name='12097'>
         vt = vt2ave(mgs)<a name='12098'>
       ELSE<a name='12099'>
         vt = vtxbar(mgs,lh,1)<a name='12100'>
       ENDIF<a name='12101'>
<a name='12102'>
      qhacr(mgs) =   &amp;<a name='12103'>
     &amp;   min(   &amp;<a name='12104'>
     &amp;   ((0.25)*pi/gf4)*ehr(mgs)*qx(mgs,lr)*cx(mgs,lh)   &amp;<a name='12105'>
     &amp;  *abs(vt-vtxbar(mgs,lr,1))   &amp;<a name='12106'>
     &amp;  *(  gf6*gf1*xdia(mgs,lr,2)   &amp;<a name='12107'>
     &amp;    + 2.0*gf5*gf2*xdia(mgs,lr,1)*xdia(mgs,lh,1)   &amp;<a name='12108'>
     &amp;    + gf4*gf3*xdia(mgs,lh,2) )   &amp;<a name='12109'>
     &amp;  , qrmxd(mgs))<a name='12110'>
      <a name='12111'>
        IF ( temg(mgs) &gt; tfr ) THEN<a name='12112'>
          qhacrmlr(mgs) = qhacr(mgs)<a name='12113'>
          qhacr(mgs) = 0.0<a name='12114'>
        ENDIF<a name='12115'>
      <a name='12116'>
      ENDIF<a name='12117'>
        IF ( lvol(lh) .gt. 1 ) THEN<a name='12118'>
         vhacr(mgs) = rho0(mgs)*qhacr(mgs)/raindn(mgs,lh)<a name='12119'>
        ENDIF<a name='12120'>
      ENDIF<a name='12121'>
      end do<a name='12122'>
<a name='12123'>
<font color=#447700>!<a name='12124'></font>
<font color=#447700>!<a name='12125'></font>
      if (ndebug .gt. 0 ) write(0,*) 'Collection: hail collects xxxxx'<a name='12126'>
<font color=#447700>!<a name='12127'></font>
<a name='12128'>
      do mgs = 1,ngscnt<a name='12129'>
      qhlacw(mgs) = 0.0<a name='12130'>
      vhlacw(mgs) = 0.0<a name='12131'>
      vhlsoak(mgs) = 0.0<a name='12132'>
      IF ( lhl &gt; 1 .and. .true.) THEN<a name='12133'>
        vtmax = (gz(igs(mgs),jgs,kgs(mgs))/dtp)<a name='12134'>
        vtxbar(mgs,lhl,1) = Min( vtmax, vtxbar(mgs,lhl,1))<a name='12135'>
        vtxbar(mgs,lhl,2) = Min( vtmax, vtxbar(mgs,lhl,2))<a name='12136'>
        vtxbar(mgs,lhl,3) = Min( vtmax, vtxbar(mgs,lhl,3))<a name='12137'>
      ENDIF<a name='12138'>
<a name='12139'>
      IF ( lhl &gt; 0 ) THEN<a name='12140'>
      rarx(mgs,lhl) = 0.0<a name='12141'>
      ENDIF<a name='12142'>
<a name='12143'>
      IF ( lhl .gt. 1 .and. ehlw(mgs) .gt. 0.0 ) THEN<a name='12144'>
<a name='12145'>
<a name='12146'>
<font color=#447700>!        IF ( ipconc .ge. 2 ) THEN<a name='12147'></font>
<a name='12148'>
            vt = abs(vtxbar(mgs,lhl,1)-vtxbar(mgs,lc,1))<a name='12149'>
<a name='12150'>
          qhlacw(mgs) = 0.25*pi*ehlw(mgs)*cx(mgs,lhl)*qx(mgs,lc)*vt*   &amp;<a name='12151'>
     &amp;         (  da0lhl(mgs)*xdia(mgs,lhl,3)**2 +     &amp;<a name='12152'>
     &amp;            dab1lh(mgs,lc,lhl)*xdia(mgs,lhl,3)*xdia(mgs,lc,3) +    &amp;<a name='12153'>
     &amp;            da1(lc)*xdia(mgs,lc,3)**2 )<a name='12154'>
<a name='12155'>
<a name='12156'>
          qhlacw(mgs) = Min( qhlacw(mgs), 0.5*qx(mgs,lc)/dtp )<a name='12157'>
<a name='12158'>
          IF ( lvol(lhl) .gt. 1 ) THEN<a name='12159'>
<a name='12160'>
             IF ( temg(mgs) .lt. 273.15) THEN<a name='12161'>
             rimdn(mgs,lhl) = rimc1*(-((0.5)*(1.e+06)*xdia(mgs,lc,1))   &amp;<a name='12162'>
     &amp;                *((0.60)*vtxbar(mgs,lhl,1))   &amp;<a name='12163'>
     &amp;                /(temg(mgs)-273.15))**(rimc2)<a name='12164'>
             rimdn(mgs,lhl) = Min( Max( hldnmn, rimc3, rimdn(mgs,lhl) ), rimc4 )<a name='12165'>
             ELSE<a name='12166'>
             rimdn(mgs,lhl) = 1000.<a name='12167'>
             ENDIF<a name='12168'>
<a name='12169'>
             vhlacw(mgs) = rho0(mgs)*qhlacw(mgs)/rimdn(mgs,lhl)<a name='12170'>
<a name='12171'>
          ENDIF<a name='12172'>
<a name='12173'>
<a name='12174'>
        IF ( qx(mgs,lhl) .gt. qxmin(lhl) .and. ipelec .ge. 1 ) THEN<a name='12175'>
         rarx(mgs,lhl) =     &amp;<a name='12176'>
     &amp;    qhlacw(mgs)*1.0e3*rho0(mgs)/((pi/2.0)*xdia(mgs,lhl,2)*cx(mgs,lhl))<a name='12177'>
        ENDIF<a name='12178'>
<a name='12179'>
      ENDIF<a name='12180'>
      end do<a name='12181'>
<a name='12182'>
      qhlaci(:) = 0.0<a name='12183'>
      qhlaci0(:) = 0.0<a name='12184'>
      IF ( lhl .gt. 1  ) THEN<a name='12185'>
      do mgs = 1,ngscnt<a name='12186'>
      IF ( ehli(mgs) .gt. 0.0 ) THEN<a name='12187'>
       IF (  ipconc .ge. 5 ) THEN<a name='12188'>
<a name='12189'>
       vt = Sqrt((vtxbar(mgs,lhl,1)-vtxbar(mgs,li,1))**2 +    &amp;<a name='12190'>
     &amp;            0.04*vtxbar(mgs,lhl,1)*vtxbar(mgs,li,1) )<a name='12191'>
<a name='12192'>
          qhlaci0(mgs) = 0.25*pi*ehliclsn(mgs)*cx(mgs,lhl)*qx(mgs,li)*vt*   &amp;<a name='12193'>
     &amp;         (  da0lhl(mgs)*xdia(mgs,lhl,3)**2 +     &amp;<a name='12194'>
     &amp;            dab1lh(mgs,li,lhl)*xdia(mgs,lhl,3)*xdia(mgs,li,3) +    &amp;<a name='12195'>
     &amp;            da1(li)*xdia(mgs,li,3)**2 )<a name='12196'>
        <font color=#447700>! qhlaci(mgs) = Min( qhlaci(mgs), qimxd(mgs) )<a name='12197'></font>
          qhlaci(mgs) = Min( ehli(mgs)*qhlaci0(mgs), qimxd(mgs) )<a name='12198'>
       ENDIF<a name='12199'>
      ENDIF<a name='12200'>
      end do<a name='12201'>
      ENDIF<a name='12202'>
<font color=#447700>!<a name='12203'></font>
      qhlacs(:) = 0.0<a name='12204'>
      qhlacs0(:) = 0.0<a name='12205'>
      IF ( lhl .gt. 1 ) THEN<a name='12206'>
      do mgs = 1,ngscnt<a name='12207'>
      IF ( ehls(mgs) .gt. 0.0) THEN<a name='12208'>
       IF ( ipconc .ge. 5 ) THEN<a name='12209'>
<a name='12210'>
       vt = Sqrt((vtxbar(mgs,lhl,1)-vtxbar(mgs,ls,1))**2 +    &amp;<a name='12211'>
     &amp;            0.04*vtxbar(mgs,lhl,1)*vtxbar(mgs,ls,1) )<a name='12212'>
<a name='12213'>
          qhlacs0(mgs) = 0.25*pi*ehlsclsn(mgs)*cx(mgs,lhl)*qx(mgs,ls)*vt*   &amp;<a name='12214'>
     &amp;         (  da0lhl(mgs)*xdia(mgs,lhl,3)**2 +     &amp;<a name='12215'>
     &amp;            dab1lh(mgs,ls,lhl)*xdia(mgs,lhl,3)*xdia(mgs,ls,3) +    &amp;<a name='12216'>
     &amp;            da1(ls)*xdia(mgs,ls,3)**2 )<a name='12217'>
<a name='12218'>
          qhlacs(mgs) = Min( ehls(mgs)*qhlacs0(mgs), qsmxd(mgs) )<a name='12219'>
        ENDIF<a name='12220'>
      ENDIF<a name='12221'>
      end do<a name='12222'>
      ENDIF<a name='12223'>
<a name='12224'>
<a name='12225'>
      do mgs = 1,ngscnt<a name='12226'>
      qhlacr(mgs) = 0.0<a name='12227'>
      qhlacrmlr(mgs) = 0.0<a name='12228'>
      chlacr(mgs) = 0.0<a name='12229'>
      vhlacr(mgs) = 0.0<a name='12230'>
      IF ( lhl .gt. 1 .and. temg(mgs) .gt. tfr ) raindn(mgs,lhl) = 1000.0<a name='12231'>
<a name='12232'>
      IF ( lhl .gt. 1 .and. ehlr(mgs) .gt. 0.0 ) THEN<a name='12233'>
      IF ( ipconc .ge. 3 ) THEN<a name='12234'>
       vt = Sqrt((vtxbar(mgs,lhl,1)-vtxbar(mgs,lr,1))**2 +    &amp;<a name='12235'>
     &amp;            0.04*vtxbar(mgs,lhl,1)*vtxbar(mgs,lr,1) )<a name='12236'>
<a name='12237'>
       qhlacr(mgs) = 0.25*pi*ehlr(mgs)*cx(mgs,lhl)*qx(mgs,lr)*vt*   &amp;<a name='12238'>
     &amp;         (  da0lhl(mgs)*xdia(mgs,lhl,3)**2 +     &amp;<a name='12239'>
     &amp;            dab1lh(mgs,lr,lhl)*xdia(mgs,lhl,3)*xdia(mgs,lr,3) +    &amp;<a name='12240'>
     &amp;            da1(lr)*xdia(mgs,lr,3)**2 )<a name='12241'>
<font color=#447700>!       IF ( qhacr(mgs) .gt. 0. .or. tmp .gt. 0.0 ) write(0,*) 'qhacr= ',qhacr(mgs),tmp<a name='12242'></font>
<font color=#447700>!!        qhacr(mgs) = Min( qhacr(mgs), qrmxd(mgs) )<a name='12243'></font>
<font color=#447700>!!        chacr(mgs) = qhacr(mgs)*cx(mgs,lr)/qx(mgs,lr)<a name='12244'></font>
<font color=#447700>!!        chacr(mgs) = min(chacr(mgs),crmxd(mgs))<a name='12245'></font>
<a name='12246'>
        qhlacr(mgs) = Min( qhlacr(mgs), qxmxd(mgs,lr) )<a name='12247'>
<a name='12248'>
     <a name='12249'>
        qhlacrmlr(mgs) = qhlacr(mgs)<a name='12250'>
        IF ( temg(mgs) &gt; tfr ) THEN<a name='12251'>
        qhlacr(mgs) = 0.0<a name='12252'>
        ELSE<a name='12253'>
        chlacr(mgs) = 0.25*pi*ehlr(mgs)*cx(mgs,lhl)*cx(mgs,lr)*vt*   &amp;<a name='12254'>
     &amp;         (  da0lhl(mgs)*xdia(mgs,lhl,3)**2 +     &amp;<a name='12255'>
     &amp;            dab0(lhl,lr)*xdia(mgs,lhl,3)*xdia(mgs,lr,3) +    &amp;<a name='12256'>
     &amp;            da0(lr)*xdia(mgs,lr,3)**2 )<a name='12257'>
<a name='12258'>
        chlacr(mgs) = min(chlacr(mgs),crmxd(mgs))<a name='12259'>
<a name='12260'>
        IF ( lvol(lhl) .gt. 1 ) THEN<a name='12261'>
         vhlacr(mgs) = rho0(mgs)*qhlacr(mgs)/raindn(mgs,lhl)<a name='12262'>
        ENDIF<a name='12263'>
        ENDIF<a name='12264'>
      ENDIF<a name='12265'>
      ENDIF<a name='12266'>
      end do<a name='12267'>
<a name='12268'>
<a name='12269'>
<a name='12270'>
<font color=#447700>!<a name='12271'></font>
<font color=#447700>!<a name='12272'></font>
<font color=#447700>!<a name='12273'></font>
<font color=#447700>!<a name='12274'></font>
<font color=#447700>!      if (ndebug .gt. 0 ) write(0,*) 'Collection: Cloud collects xxxxx'<a name='12275'></font>
<a name='12276'>
      if (ndebug .gt. 0 ) write(0,*) 'Collection: cloud ice collects xxxx2'<a name='12277'>
<font color=#447700>!<a name='12278'></font>
      do mgs = 1,ngscnt<a name='12279'>
      qiacw(mgs) = 0.0<a name='12280'>
      IF ( eiw(mgs) .gt. 0.0 ) THEN<a name='12281'>
<a name='12282'>
       vt = Sqrt((vtxbar(mgs,li,1)-vtxbar(mgs,lc,1))**2 +    &amp;<a name='12283'>
     &amp;            0.04*vtxbar(mgs,li,1)*vtxbar(mgs,lc,1) )<a name='12284'>
<a name='12285'>
          qiacw(mgs) = 0.25*pi*eiw(mgs)*cx(mgs,li)*qx(mgs,lc)*vt*   &amp;<a name='12286'>
     &amp;         (  da0(li)*xdia(mgs,li,3)**2 +     &amp;<a name='12287'>
     &amp;            dab1(li,lc)*xdia(mgs,li,3)*xdia(mgs,lc,3) +    &amp;<a name='12288'>
     &amp;            da1(lc)*xdia(mgs,lc,3)**2 )<a name='12289'>
<a name='12290'>
       qiacw(mgs) = Min( qiacw(mgs), qxmxd(mgs,lc) )<a name='12291'>
      ENDIF<a name='12292'>
      end do<a name='12293'>
<a name='12294'>
<a name='12295'>
<font color=#447700>!<a name='12296'></font>
<font color=#447700>!<a name='12297'></font>
      if (ndebug .gt. 0 ) write(0,*) 'Collection: cloud ice collects xxxx8'<a name='12298'>
<font color=#447700>!<a name='12299'></font>
      do mgs = 1,ngscnt<a name='12300'>
      qiacr(mgs) = 0.0<a name='12301'>
      qiacrf(mgs) = 0.0<a name='12302'>
      qiacrs(mgs) = 0.0<a name='12303'>
      ciacrs(mgs) = 0.0<a name='12304'>
      ciacr(mgs) = 0.0<a name='12305'>
      ciacrf(mgs) = 0.0<a name='12306'>
      viacrf(mgs) = 0.0<a name='12307'>
      csplinter(mgs) = 0.0<a name='12308'>
      qsplinter(mgs) = 0.0<a name='12309'>
      csplinter2(mgs) = 0.0<a name='12310'>
      qsplinter2(mgs) = 0.0<a name='12311'>
      IF ( iacr .ge. 1 .and. eri(mgs) .gt. 0.0    &amp;<a name='12312'>
     &amp;     .and. temg(mgs) .le. 270.15 ) THEN<a name='12313'>
      IF ( ipconc .ge. 3 ) THEN<a name='12314'>
       ni = 0.0<a name='12315'>
         IF ( xdia(mgs,li,1) .ge. 10.e-6 ) THEN<a name='12316'>
          ni = ni + cx(mgs,li)*Exp(- (40.e-6/xdia(mgs,li,1))**3 )<a name='12317'>
         ENDIF<a name='12318'>
       IF ( imurain == 1 ) THEN <font color=#447700>! gamma of diameter<a name='12319'></font>
           IF ( iacrsize /= 4 ) THEN<a name='12320'>
           IF ( iacrsize .eq. 1 ) THEN<a name='12321'>
             ratio = 500.e-6/xdia(mgs,lr,1)<a name='12322'>
           ELSEIF ( iacrsize .eq. 2 ) THEN<a name='12323'>
             ratio = 300.e-6/xdia(mgs,lr,1)<a name='12324'>
           ELSEIF ( iacrsize .eq. 3 ) THEN<a name='12325'>
             ratio = 40.e-6/xdia(mgs,lr,1)<a name='12326'>
           ELSEIF ( iacrsize .eq. 5 ) THEN<a name='12327'>
             ratio = 150.e-6/xdia(mgs,lr,1)<a name='12328'>
           ENDIF<a name='12329'>
           i = Min(nqiacrratio,Int(ratio*dqiacrratioinv))<a name='12330'>
           j = Int(Max(0.0,Min(15.,alpha(mgs,lr)))*dqiacralphainv)<a name='12331'>
           delx = ratio - float(i)*dqiacrratio<a name='12332'>
           dely = alpha(mgs,lr) - float(j)*dqiacralpha<a name='12333'>
           ip1 = Min( i+1, nqiacrratio )<a name='12334'>
           jp1 = Min( j+1, nqiacralpha )<a name='12335'>
<a name='12336'>
           <font color=#447700>! interpolate along x, i.e., ratio<a name='12337'></font>
           tmp1 = ciacrratio(i,j) + delx*dqiacrratioinv*(ciacrratio(ip1,j) - ciacrratio(i,j))<a name='12338'>
           tmp2 = ciacrratio(i,jp1) + delx*dqiacrratioinv*(ciacrratio(ip1,jp1) - ciacrratio(i,jp1))<a name='12339'>
           <a name='12340'>
           <font color=#447700>! interpolate along alpha<a name='12341'></font>
           <a name='12342'>
           nr = (tmp1 + dely*dqiacralphainv*(tmp2 - tmp1))*cx(mgs,lr)<a name='12343'>
           <a name='12344'>
           <font color=#447700>! interpolate along x, i.e., ratio; <a name='12345'></font>
           tmp1 = qiacrratio(i,j) + delx*dqiacrratioinv*(qiacrratio(ip1,j) - qiacrratio(i,j))<a name='12346'>
           tmp2 = qiacrratio(i,jp1) + delx*dqiacrratioinv*(qiacrratio(ip1,jp1) - qiacrratio(i,jp1))<a name='12347'>
           <a name='12348'>
           <font color=#447700>! interpolate along alpha; <a name='12349'></font>
           <a name='12350'>
           qr = (tmp1 + dely*dqiacralphainv*(tmp2 - tmp1))*qx(mgs,lr)<a name='12351'>
           <a name='12352'>
           ELSE <font color=#447700>! iacrsize == 4 : use all<a name='12353'></font>
             nr = cx(mgs,lr)<a name='12354'>
             qr = qx(mgs,lr)<a name='12355'>
           ENDIF<a name='12356'>
<a name='12357'>
          vt = Sqrt((vtxbar(mgs,lr,1)-vtxbar(mgs,li,1))**2 +     &amp;<a name='12358'>
     &amp;            0.04*vtxbar(mgs,lr,1)*vtxbar(mgs,li,1) )<a name='12359'>
<a name='12360'>
          qiacr(mgs) = 0.25*pi*eri(mgs)*ni*qr*vt*   &amp;<a name='12361'>
     &amp;         (  da0(li)*xdia(mgs,li,3)**2 +     &amp;<a name='12362'>
     &amp;            dab1lh(mgs,lr,li)*xdia(mgs,lh,3)*xdia(mgs,li,3) +    &amp;<a name='12363'>
     &amp;            da1(lr)*xdia(mgs,lr,3)**2 ) <a name='12364'>
          <a name='12365'>
          qiacr(mgs) = Min( qrmxd(mgs), qiacr(mgs) )<a name='12366'>
          <a name='12367'>
<a name='12368'>
          ciacr(mgs) = 0.25*pi*eri(mgs)*ni*nr*vt*   &amp;<a name='12369'>
     &amp;         (  da0(li)*xdia(mgs,li,3)**2 +     &amp;<a name='12370'>
     &amp;            dab0lh(mgs,lr,li)*xdia(mgs,lr,3)*xdia(mgs,li,3) +    &amp;<a name='12371'>
     &amp;            da0(lr)*xdia(mgs,lr,3)**2 ) <a name='12372'>
<a name='12373'>
          ciacr(mgs) = Min( crmxd(mgs), ciacr(mgs) )<a name='12374'>
          <a name='12375'>
<font color=#447700>!          write(iunit,*) 'qiacr: ',cx(mgs,lr),nr,qx(mgs,lr),qr,qiacr(mgs),ciacr(mgs)<a name='12376'></font>
<font color=#447700>!          write(iunit,*) 'xdia r li = ',xdia(mgs,lr,3),xdia(mgs,li,3),xdia(mgs,lr,1),xdia(mgs,li,1)<a name='12377'></font>
<font color=#447700>!          write(iunit,*) 'i,j,ratio = ',i,j,ciacrratio(i,j),qiacrratio(i,j)<a name='12378'></font>
<font color=#447700>!          write(iunit,*) 'ni,ci = ',ni,cx(mgs,li),qx(mgs,li)<a name='12379'></font>
<a name='12380'>
       ELSEIF ( imurain == 3 ) THEN <font color=#447700>! gamma of volume<a name='12381'></font>
<font color=#447700>!   Set nr to the number of drops greater than 40 microns.<a name='12382'></font>
         arg = 1000.*xdia(mgs,lr,3)<a name='12383'>
<font color=#447700>!         nr = cx(mgs,lr)*gaml02( arg )<a name='12384'></font>
<font color=#447700>!        IF ( iacr .eq. 1 ) THEN<a name='12385'></font>
         IF ( ipconc .ge. 3 ) THEN<a name='12386'>
           IF ( iacrsize .eq. 1 ) THEN<a name='12387'>
            nr = cx(mgs,lr)*gaml02d500( arg )  <font color=#447700>! number greater than 500 microns in diameter<a name='12388'></font>
           ELSEIF ( iacrsize .eq. 2 .or. iacrsize .eq. 5 ) THEN<a name='12389'>
            nr = cx(mgs,lr)*gaml02d300( arg )  <font color=#447700>! number greater than 300 microns in diameter<a name='12390'></font>
           ELSEIF ( iacrsize .eq. 3 ) THEN<a name='12391'>
            nr = cx(mgs,lr)*gaml02( arg ) <font color=#447700>! number greater than 40 microns in diameter<a name='12392'></font>
           ELSEIF ( iacrsize .eq. 4 ) THEN<a name='12393'>
            nr = cx(mgs,lr) <font color=#447700>! all raindrops<a name='12394'></font>
           ENDIF<a name='12395'>
         ELSE<a name='12396'>
         nr = cx(mgs,lr)*gaml02( arg )<a name='12397'>
         ENDIF<a name='12398'>
<font color=#447700>!        ELSEIF ( iacr .eq. 2 ) THEN<a name='12399'></font>
<font color=#447700>!         nr = cx(mgs,lr)*gaml02d300( arg )  ! number greater than 300 microns in diameter<a name='12400'></font>
<font color=#447700>!        ENDIF<a name='12401'></font>
       IF ( ni .gt. 0.0 .and. nr .gt. 0.0 ) THEN<a name='12402'>
       d0 = xdia(mgs,lr,3)<a name='12403'>
       qiacr(mgs) = xdn(mgs,lr)*rhoinv(mgs)*   &amp;<a name='12404'>
     &amp;     (0.217239*(0.522295*(d0**5) +    &amp;<a name='12405'>
     &amp;      49711.81*(d0**6) -    &amp;<a name='12406'>
     &amp;      1.673016e7*(d0**7)+    &amp;<a name='12407'>
     &amp;      2.404471e9*(d0**8) -    &amp;<a name='12408'>
     &amp;      1.22872e11*(d0**9))*ni*nr)<a name='12409'>
      qiacr(mgs) = Min( qrmxd(mgs), qiacr(mgs) )<a name='12410'>
      ciacr(mgs) =   &amp;<a name='12411'>
     &amp;   (0.217239*(0.2301947*(d0**2) +    &amp;<a name='12412'>
     &amp;      15823.76*(d0**3) -    &amp;<a name='12413'>
     &amp;      4.167685e6*(d0**4) +    &amp;<a name='12414'>
     &amp;      4.920215e8*(d0**5) -    &amp;<a name='12415'>
     &amp;      2.133344e10*(d0**6))*ni*nr)<a name='12416'>
      ciacr(mgs) = Min( crmxd(mgs), ciacr(mgs) )<a name='12417'>
<font color=#447700>!      ciacr(mgs) = qiacr(mgs)*cx(mgs,lr)/qx(mgs,lr)<a name='12418'></font>
      ENDIF<a name='12419'>
      ENDIF<a name='12420'>
       IF ( iacr .eq. 1 .or. iacr .eq. 3 ) THEN<a name='12421'>
         ciacrf(mgs) = Min(ciacr(mgs), qiacr(mgs)/(1.0*vr1mm*1000.0)*rho0(mgs) ) <font color=#447700>! *rzxh(mgs)<a name='12422'></font>
       ELSEIF ( iacr .eq. 2 ) THEN<a name='12423'>
         ciacrf(mgs) = ciacr(mgs) <font color=#447700>! *rzxh(mgs)<a name='12424'></font>
       ELSEIF ( iacr .eq. 4 ) THEN<a name='12425'>
         ciacrf(mgs) = Min(ciacr(mgs), qiacr(mgs)/(1.0*vfrz*1000.0)*rho0(mgs) ) <font color=#447700>! *rzxh(mgs)<a name='12426'></font>
       ELSEIF ( iacr .eq. 5 ) THEN<a name='12427'>
         ciacrf(mgs) = ciacr(mgs)*rzxh(mgs)<a name='12428'>
       ENDIF <a name='12429'>
<font color=#447700>!      crfrzf(mgs) = Min(crfrz(mgs), qrfrz(mgs)/(bfnu*27.0*vr1mm*1000.0)*rho0(mgs) ) ! rzxh(mgs)*crfrz(mgs)<a name='12430'></font>
       ENDIF<a name='12431'>
      <a name='12432'>
      <a name='12433'>
      ELSE <font color=#447700>! single-moment rain<a name='12434'></font>
      qiacr(mgs) =    &amp;<a name='12435'>
     &amp;  min(        &amp;<a name='12436'>
     &amp;   ((0.25/gf4)*pi)*eri(mgs)*cx(mgs,li)*qx(mgs,lr)   &amp;<a name='12437'>
     &amp;  *abs(vtxbar(mgs,lr,1)-vtxbar(mgs,li,1))   &amp;<a name='12438'>
     &amp;  *(  gf6*gf1*xdia(mgs,lr,2)    &amp;<a name='12439'>
     &amp;    + 2.0*gf5*gf2*xdia(mgs,lr,1)*xdia(mgs,li,1)    &amp;<a name='12440'>
     &amp;    + gf4*gf3*xdia(mgs,li,2) )     &amp;<a name='12441'>
     &amp;  , qrmxd(mgs))<a name='12442'>
      ENDIF<a name='12443'>
<font color=#447700>!      if ( temg(mgs) .gt. 268.15 ) then<a name='12444'></font>
<font color=#447700>!      qiacr(mgs) = 0.0<a name='12445'></font>
<font color=#447700>!      ciacr(mgs) = 0.0<a name='12446'></font>
<font color=#447700>!      end if<a name='12447'></font>
<a name='12448'>
      IF ( ipconc .ge. 1 ) THEN<a name='12449'>
        IF ( nsplinter .ge. 1000 ) THEN<a name='12450'>
        <font color=#447700>! Lawson et al. 2015 JAS<a name='12451'></font>
         <font color=#447700>! ave. diam of freezing drops in microns<a name='12452'></font>
           IF ( qiacr(mgs)*dtp &gt; qxmin(lh) .and. ciacr(mgs) &gt; 1.e-3 ) THEN<a name='12453'>
             tmpdiam = 1.e6*( 6.*qiacr(mgs)/(1000.*pi*ciacr(mgs) ) )**(1./3.) <font color=#447700>! avg. diameter of newly frozen drops in microns<a name='12454'></font>
             csplinter(mgs) = lawson_splinter_fac*tmpdiam**4*ciacr(mgs)<a name='12455'>
           ENDIF<a name='12456'>
        ELSEIF ( nsplinter .ge. 0 ) THEN<a name='12457'>
          csplinter(mgs) = nsplinter*ciacr(mgs)<a name='12458'>
        ELSE<a name='12459'>
          csplinter(mgs) = -nsplinter*ciacrf(mgs)<a name='12460'>
        ENDIF<a name='12461'>
        qsplinter(mgs) = Min(0.1*qiacr(mgs), csplinter(mgs)*splintermass/rho0(mgs) ) <font color=#447700>! makes splinters smaller if too much mass is taken from graupel<a name='12462'></font>
      ENDIF<a name='12463'>
      <a name='12464'>
      frach = 1.0<a name='12465'>
           IF ( ibiggsnow == 2 .or. ibiggsnow == 3 ) THEN<a name='12466'>
           IF ( ciacr(mgs) &gt; qxmin(lh) ) THEN<a name='12467'>
           xvfrz = rho0(mgs)*qiacr(mgs)/(ciacr(mgs)*900.) <font color=#447700>! mean volume of frozen drops; 900. for frozen drop density<a name='12468'></font>
           frach = 0.5 *(1. +  Tanh(0.2e12 *( xvfrz - 1.15*xvmn(lh))))<a name='12469'>
<a name='12470'>
             qiacrs(mgs) = (1.-frach)*qiacr(mgs)<a name='12471'>
             ciacrs(mgs) = (1.-frach)*ciacr(mgs) <font color=#447700>! *rzxh(mgs)<a name='12472'></font>
           <a name='12473'>
           ENDIF<a name='12474'>
           ENDIF<a name='12475'>
<a name='12476'>
      qiacrf(mgs) = frach*qiacr(mgs)<a name='12477'>
      ciacrf(mgs) = frach*ciacrf(mgs)<a name='12478'>
<a name='12479'>
      IF ( lvol(lh) &gt; 1 ) THEN<a name='12480'>
         viacrf(mgs) = rho0(mgs)*qiacrf(mgs)/rhofrz<a name='12481'>
      ENDIF<a name='12482'>
      <a name='12483'>
      end do<a name='12484'>
<font color=#447700>!<a name='12485'></font>
<font color=#447700>!<a name='12486'></font>
<font color=#447700>!<a name='12487'></font>
<font color=#447700>!<a name='12488'></font>
<a name='12489'>
<font color=#447700>! snow aggregation here<a name='12490'></font>
      if ( ipconc .ge. 4 ) then <font color=#447700>!<a name='12491'></font>
      do mgs = 1,ngscnt<a name='12492'>
      csacs(mgs) = 0.0<a name='12493'>
      IF ( qx(mgs,ls) &gt; qxmin(ls) .and. ess(mgs) .gt. 0.0 .and. xv(mgs,ls) &lt; 0.25*xvmx(ls)*Max(1.,100./Min(100.,xdn(mgs,ls)))  ) THEN<a name='12494'>
      csacs(mgs) = rvt*aa2*ess(mgs)*cx(mgs,ls)**2*xv(mgs,ls) *Min(1.,xdn(mgs,ls)/100. ) <font color=#447700>! Min func tries to recalibrate for low diagnosed density <a name='12495'></font>
      csacs(mgs) = min(csacs(mgs),csmxd(mgs))<a name='12496'>
      ENDIF<a name='12497'>
      end do<a name='12498'>
      end if<a name='12499'>
<font color=#447700>!<a name='12500'></font>
<font color=#447700>!<a name='12501'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 11'<a name='12502'>
      if ( ipconc .ge. 2 .or. ipelec .ge. 9 ) then<a name='12503'>
      do mgs = 1,ngscnt<a name='12504'>
      ciacw(mgs) = 0.0<a name='12505'>
      IF ( eiw(mgs) .gt. 0.0 ) THEN<a name='12506'>
        ciacw(mgs) = qiacw(mgs)*rho0(mgs)/xmas(mgs,lc)<a name='12507'>
        ciacw(mgs) = min(ciacw(mgs),ccmxd(mgs))<a name='12508'>
      ENDIF<a name='12509'>
      end do<a name='12510'>
<a name='12511'>
      end if<a name='12512'>
<a name='12513'>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 18'<a name='12514'>
      if ( ipconc .ge. 2 .or. ipelec .ge. 1 ) then<a name='12515'>
      do mgs = 1,ngscnt<a name='12516'>
       cracw(mgs) = 0.0<a name='12517'>
       cracr(mgs) = 0.0<a name='12518'>
       ec0(mgs) = 1.e9<a name='12519'>
      IF ( qx(mgs,lc) .gt. qxmin(lc) .and. qx(mgs,lr) .gt. qxmin(lr)    &amp;<a name='12520'>
     &amp;      .and. qracw(mgs) .gt. 0.0 ) THEN<a name='12521'>
<a name='12522'>
       IF ( ipconc .lt. 3 ) THEN<a name='12523'>
        IF ( erw(mgs) .gt. 0.0 ) THEN<a name='12524'>
        cracw(mgs) =   &amp;<a name='12525'>
     &amp;   ((0.25)*pi)*erw(mgs)*cx(mgs,lc)*cx(mgs,lr)   &amp;<a name='12526'>
     &amp;  *abs(vtxbar(mgs,lr,1)-vtxbar(mgs,lc,1))   &amp;<a name='12527'>
     &amp;  *(  gf1*xdia(mgs,lc,2)   &amp;<a name='12528'>
     &amp;    + 2.0*gf2*xdia(mgs,lc,1)*xdia(mgs,lr,1)   &amp;<a name='12529'>
     &amp;    + gf3*xdia(mgs,lr,2) )<a name='12530'>
        ENDIF<a name='12531'>
       ELSE <font color=#447700>! IF ( ipconc .ge. 3 .and. <a name='12532'></font>
        IF ( dmrauto &lt;= 0 .or.  rho0(mgs)*qx(mgs,lr) &gt; 1.2*xl2p(mgs) ) THEN  <font color=#447700>!{<a name='12533'></font>
        IF ( 0.5*xdia(mgs,lr,3) .gt. rh(mgs) ) THEN <font color=#447700>! { .or. cx(mgs,lr) .gt. nh(mgs) <a name='12534'></font>
<font color=#447700>!        IF ( qx(mgs,lc) .gt. qxmin(lc) .and. qx(mgs,lr) .gt. qxmin(lr) ) THEN<a name='12535'></font>
          IF ( 0.5*xdia(mgs,lr,3) .gt. rwradmn ) THEN <font color=#447700>! r &gt; 50.e-6 <a name='12536'></font>
<font color=#447700>!          DM0CCC=A2*XNC*XNR*(XVC+XVR)                               ! (A11)<a name='12537'></font>
<font color=#447700>!         NOTE: murain drops out, so same result for imurain = 1 and 3<a name='12538'></font>
            cracw(mgs) = aa2*cx(mgs,lr)*cx(mgs,lc)*(xv(mgs,lc) + xv(mgs,lr))<a name='12539'>
          ELSE<a name='12540'>
            IF ( imurain == 3 ) THEN<a name='12541'>
<font color=#447700>!          DM0CCC=A1*XNC*XNR*(((CNU+2.)/(CNU+1.))*XVC**2+((RNU+2.)/(RNU+1.))*XVR**2) ! (A13)<a name='12542'></font>
            cracw(mgs) = aa1*cx(mgs,lr)*cx(mgs,lc)*   &amp;<a name='12543'>
     &amp;          ((cnu + 2.)*xv(mgs,lc)**2/(cnu + 1.) +    &amp;<a name='12544'>
     &amp;          (alpha(mgs,lr) + 2.)*xv(mgs,lr)**2/(alpha(mgs,lr) + 1.))<a name='12545'>
            ELSE <font color=#447700>! imurain == 1 USE CP00 for rain DSD in diameter<a name='12546'></font>
            cracw(mgs) = aa1*cx(mgs,lr)*cx(mgs,lc)*   &amp;<a name='12547'>
     &amp;          ((cnu + 2.)*xv(mgs,lc)**2/(cnu + 1.) +    &amp;<a name='12548'>
     &amp;          (alpha(mgs,lr) + 6.)*(alpha(mgs,lr) + 5.)*(alpha(mgs,lr) + 4.)*xv(mgs,lr)**2/  &amp;<a name='12549'>
     &amp;             ((alpha(mgs,lr) + 3.)*(alpha(mgs,lr) + 2.)*(alpha(mgs,lr) + 1.)) )<a name='12550'>
            ENDIF <font color=#447700>! imurain<a name='12551'></font>
          ENDIF<a name='12552'>
        ENDIF <font color=#447700>! } rh<a name='12553'></font>
        ENDIF <font color=#447700>! } dmrauto<a name='12554'></font>
       ENDIF <font color=#447700>! ipconc<a name='12555'></font>
      ENDIF <font color=#447700>! qc &gt; qcmin &amp; qr &gt; qrmin<a name='12556'></font>
        <a name='12557'>
<font color=#447700>! Rain self collection (cracr) and break-up (factor of ec0)<a name='12558'></font>
<font color=#447700>!<a name='12559'></font>
<font color=#447700>!       <a name='12560'></font>
        ec0(mgs) = 2.e9<a name='12561'>
        IF ( qx(mgs,lr) .gt. qxmin(lr) ) THEN<a name='12562'>
        rwrad = 0.5*xdia(mgs,lr,3)<a name='12563'>
        IF ( xdia(mgs,lr,3) .gt. 2.0e-3 ) THEN<a name='12564'>
          ec0(mgs) = 0.0<a name='12565'>
          cracr(mgs) = 0.0<a name='12566'>
        ELSE<a name='12567'>
         IF ( dmrauto &lt;= 0 .or.  rho0(mgs)*qx(mgs,lr) &gt; 1.2*xl2p(mgs) ) THEN <a name='12568'>
          IF ( xdia(mgs,lr,3) .lt. 6.1e-4 ) THEN<a name='12569'>
            ec0(mgs) = 1.0<a name='12570'>
          ELSE<a name='12571'>
            ec0(mgs) = Exp(-50.0*(50.0*(xdia(mgs,lr,3) - 6.0e-4)))<a name='12572'>
          ENDIF<a name='12573'>
          <a name='12574'>
<a name='12575'>
          IF ( rwrad .ge. 50.e-6 ) THEN<a name='12576'>
              cracr(mgs) = ec0(mgs)*aa2*cx(mgs,lr)**2*xv(mgs,lr)<a name='12577'>
          ELSE<a name='12578'>
            IF ( imurain == 3 ) THEN<a name='12579'>
             cracr(mgs) = ec0(mgs)*aa1*(cx(mgs,lr)*xv(mgs,lr))**2*   &amp;<a name='12580'>
     &amp;                   (alpha(mgs,lr) + 2.)/(alpha(mgs,lr) + 1.)<a name='12581'>
            ELSE <font color=#447700>! imurain == 1<a name='12582'></font>
             cracr(mgs) = ec0(mgs)*aa1*(cx(mgs,lr)*xv(mgs,lr))**2*   &amp;<a name='12583'>
     &amp;                   (alpha(mgs,lr) + 6.)*(alpha(mgs,lr) + 5.)*(alpha(mgs,lr) + 4.)/ &amp;<a name='12584'>
     &amp;                  ((alpha(mgs,lr) + 3.)*(alpha(mgs,lr) + 2.)*(alpha(mgs,lr) + 1.))<a name='12585'>
              <a name='12586'>
            ENDIF<a name='12587'>
          ENDIF<a name='12588'>
<font color=#447700>!          cracr(mgs) = Min(cracr(mgs),crmxd(mgs))<a name='12589'></font>
         ENDIF<a name='12590'>
        ENDIF<a name='12591'>
        ENDIF<a name='12592'>
<a name='12593'>
<font color=#447700>!      cracw(mgs) = min(cracw(mgs),cxmxd(mgs,lc)) <a name='12594'></font>
      end do<a name='12595'>
      end if<a name='12596'>
<font color=#447700>!<a name='12597'></font>
<font color=#447700>!<a name='12598'></font>
<font color=#447700>!<a name='12599'></font>
<font color=#447700>!  Graupel<a name='12600'></font>
<font color=#447700>!<a name='12601'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 22ii'<a name='12602'>
      chacw(:) = 0.0<a name='12603'>
      if ( ipconc .ge. 1 .or. ipelec .ge. 1 ) then<a name='12604'>
      do mgs = 1,ngscnt<a name='12605'>
<a name='12606'>
      IF ( ipconc .ge. 5 ) THEN<a name='12607'>
       IF ( qhacw(mgs) .gt. 0.0 .and. xmas(mgs,lc) .gt. 0.0 ) THEN<a name='12608'>
<a name='12609'>
<font color=#447700>!  This is the explict version of chacw, which turns out to be very close to the<a name='12610'></font>
<font color=#447700>!  approximation that the droplet size does not change, to within a few percent.<a name='12611'></font>
<font color=#447700>!  This may _not_ be the case for cnu other than zero!<a name='12612'></font>
<font color=#447700>!          chacw(mgs) = (ehw(mgs)*cx(mgs,lc)*cx(mgs,lh)*(pi/4.)*<a name='12613'></font>
<font color=#447700>!     :    abs(vtxbar(mgs,lh,1)-vtxbar(mgs,lc,1))*<a name='12614'></font>
<font color=#447700>!     :    (2.0*xdia(mgs,lh,1)*(xdia(mgs,lh,1) +<a name='12615'></font>
<font color=#447700>!     :         xdia(mgs,lc,1)*gf43rds) +<a name='12616'></font>
<font color=#447700>!     :      xdia(mgs,lc,2)*gf53rds))<a name='12617'></font>
<a name='12618'>
<font color=#447700>!          chacw(mgs) = Min( chacw(mgs), 0.6*cx(mgs,lc)/dtp )<a name='12619'></font>
<a name='12620'>
<font color=#447700>!        chacw(mgs) = qhacw(mgs)*rho0(mgs)/xmas(mgs,lc)<a name='12621'></font>
        chacw(mgs) = qhacw(mgs)*rho0(mgs)/xmascw(mgs)<a name='12622'>
<font color=#447700>!        chacw(mgs) = min(chacw(mgs),cxmxd(mgs,lc))<a name='12623'></font>
        chacw(mgs) = Min( chacw(mgs), 0.5*cx(mgs,lc)/dtp )<a name='12624'>
       ELSE<a name='12625'>
        qhacw(mgs) = 0.0<a name='12626'>
       ENDIF<a name='12627'>
      ELSE<a name='12628'>
      chacw(mgs) =   &amp;<a name='12629'>
     &amp;   ((0.25)*pi)*ehw(mgs)*cx(mgs,lc)*cx(mgs,lh)   &amp;<a name='12630'>
     &amp;  *abs(vtxbar(mgs,lh,1)-vtxbar(mgs,lc,1))   &amp;<a name='12631'>
     &amp;  *(  gf1*xdia(mgs,lc,2)   &amp;<a name='12632'>
     &amp;    + 2.0*gf2*xdia(mgs,lc,1)*xdia(mgs,lh,1)   &amp;<a name='12633'>
     &amp;    + gf3*xdia(mgs,lh,2) )<a name='12634'>
      chacw(mgs) = min(chacw(mgs),0.5*cx(mgs,lc)/dtp)<a name='12635'>
<font color=#447700>!      chacw(mgs) = min(chacw(mgs),cxmxd(mgs,lc))<a name='12636'></font>
<font color=#447700>!      chacw(mgs) = min(chacw(mgs),ccmxd(mgs))<a name='12637'></font>
      ENDIF<a name='12638'>
      end do<a name='12639'>
      end if<a name='12640'>
<font color=#447700>!<a name='12641'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 22kk'<a name='12642'>
      chaci(:) = 0.0<a name='12643'>
      if ( ipconc .ge. 1 .or. ipelec .ge. 1 ) then<a name='12644'>
      do mgs = 1,ngscnt<a name='12645'>
      IF ( ehi(mgs) .gt. 0.0 .or. ( ehiclsn(mgs) &gt; 0.0 .and. ipelec &gt; 0 )) THEN<a name='12646'>
       IF ( ipconc .ge. 5 ) THEN<a name='12647'>
<a name='12648'>
       vt = Sqrt((vtxbar(mgs,lh,1)-vtxbar(mgs,li,1))**2 +    &amp;<a name='12649'>
     &amp;            0.04*vtxbar(mgs,lh,1)*vtxbar(mgs,li,1) )<a name='12650'>
<a name='12651'>
          chaci0(mgs) = 0.25*pi*ehiclsn(mgs)*cx(mgs,lh)*cx(mgs,li)*vt*   &amp;<a name='12652'>
     &amp;         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +     &amp;<a name='12653'>
     &amp;            dab0lh(mgs,li,lh)*xdia(mgs,lh,3)*xdia(mgs,li,3) +    &amp;<a name='12654'>
     &amp;            da0(li)*xdia(mgs,li,3)**2 )<a name='12655'>
<a name='12656'>
       ELSE<a name='12657'>
        chaci0(mgs) =   &amp;<a name='12658'>
     &amp;   ((0.25)*pi)*ehiclsn(mgs)*cx(mgs,li)*cx(mgs,lh)   &amp;<a name='12659'>
     &amp;  *abs(vtxbar(mgs,lh,1)-vtxbar(mgs,li,1))   &amp;<a name='12660'>
     &amp;  *(  gf1*xdia(mgs,li,2)   &amp;<a name='12661'>
     &amp;    + 2.0*gf2*xdia(mgs,li,1)*xdia(mgs,lh,1)   &amp;<a name='12662'>
     &amp;    + gf3*xdia(mgs,lh,2) )<a name='12663'>
        ENDIF<a name='12664'>
<a name='12665'>
        chaci(mgs) = min(ehi(mgs)*chaci0(mgs),cimxd(mgs))<a name='12666'>
       ENDIF<a name='12667'>
      end do<a name='12668'>
      end if<a name='12669'>
<a name='12670'>
<a name='12671'>
      chacis(:) = 0.0<a name='12672'>
      if ( lis &gt; 1 .and. ipconc .ge. 5 .or. ipelec .ge. 1 ) then<a name='12673'>
      do mgs = 1,ngscnt<a name='12674'>
      IF ( ehis(mgs) .gt. 0.0 .or. ( ehisclsn(mgs) &gt; 0.0 .and. ipelec &gt; 0 )) THEN<a name='12675'>
<a name='12676'>
       vt = Sqrt((vtxbar(mgs,lh,1)-vtxbar(mgs,lis,1))**2 +    &amp;<a name='12677'>
     &amp;            0.04*vtxbar(mgs,lh,1)*vtxbar(mgs,lis,1) )<a name='12678'>
<a name='12679'>
          chacis0(mgs) = 0.25*pi*ehisclsn(mgs)*cx(mgs,lh)*cx(mgs,lis)*vt*   &amp;<a name='12680'>
     &amp;         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +     &amp;<a name='12681'>
     &amp;            dab0lh(mgs,lis,lh)*xdia(mgs,lh,3)*xdia(mgs,lis,3) +    &amp;<a name='12682'>
     &amp;            da0(lis)*xdia(mgs,lis,3)**2 )<a name='12683'>
<a name='12684'>
<a name='12685'>
        chacis(mgs) = min(ehis(mgs)*chacis0(mgs),cxmxd(mgs,lis))<a name='12686'>
       ENDIF<a name='12687'>
      end do<a name='12688'>
      end if<a name='12689'>
<font color=#447700>!<a name='12690'></font>
<font color=#447700>!<a name='12691'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 22nn'<a name='12692'>
      chacs(:) = 0.0<a name='12693'>
      if ( ipconc .ge. 1 .or. ipelec .ge. 1 ) then<a name='12694'>
      do mgs = 1,ngscnt<a name='12695'>
      IF ( ehs(mgs) .gt. 0 ) THEN<a name='12696'>
       IF ( ipconc .ge. 5 .or. ( ehsclsn(mgs) &gt; 0.0 .and. ipelec &gt; 0 ) ) THEN<a name='12697'>
<a name='12698'>
       vt = Sqrt((vtxbar(mgs,lh,1)-vtxbar(mgs,ls,1))**2 +    &amp;<a name='12699'>
     &amp;            0.04*vtxbar(mgs,lh,1)*vtxbar(mgs,ls,1) )<a name='12700'>
<a name='12701'>
          chacs0(mgs) = 0.25*pi*ehsclsn(mgs)*cx(mgs,lh)*cx(mgs,ls)*vt*   &amp;<a name='12702'>
     &amp;         (  da0lh(mgs)*xdia(mgs,lh,3)**2 +     &amp;<a name='12703'>
     &amp;            dab0lh(mgs,ls,lh)*xdia(mgs,lh,3)*xdia(mgs,ls,3) +    &amp;<a name='12704'>
     &amp;            da0(ls)*xdia(mgs,ls,3)**2 )<a name='12705'>
<a name='12706'>
       ELSE<a name='12707'>
      chacs0(mgs) =   &amp;<a name='12708'>
     &amp;   ((0.25)*pi)*ehsclsn(mgs)*cx(mgs,ls)*cx(mgs,lh)   &amp;<a name='12709'>
     &amp;  *abs(vtxbar(mgs,lh,1)-vtxbar(mgs,ls,1))   &amp;<a name='12710'>
     &amp;  *(  gf3*gf1*xdia(mgs,ls,2)   &amp;<a name='12711'>
     &amp;    + 2.0*gf2*gf2*xdia(mgs,ls,1)*xdia(mgs,lh,1)   &amp;<a name='12712'>
     &amp;    + gf1*gf3*xdia(mgs,lh,2) )<a name='12713'>
      ENDIF<a name='12714'>
      chacs(mgs) = min(ehs(mgs)*chacs0(mgs),csmxd(mgs))<a name='12715'>
      ENDIF<a name='12716'>
      end do<a name='12717'>
      end if<a name='12718'>
<a name='12719'>
<a name='12720'>
<font color=#447700>!<a name='12721'></font>
<font color=#447700>!<a name='12722'></font>
<font color=#447700>!  Hail<a name='12723'></font>
<font color=#447700>!<a name='12724'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 22ii'<a name='12725'>
      chlacw(:) = 0.0<a name='12726'>
      if ( ipconc .ge. 1 .or. ipelec .ge. 1 ) then<a name='12727'>
      do mgs = 1,ngscnt<a name='12728'>
<a name='12729'>
      IF ( lhl .gt. 1 .and. ipconc .ge. 5 ) THEN<a name='12730'>
       IF ( qhlacw(mgs) .gt. 0.0 .and. xmas(mgs,lc) .gt. 0.0 ) THEN<a name='12731'>
<a name='12732'>
<font color=#447700>!  This is the explict version of chacw, which turns out to be very close to the<a name='12733'></font>
<font color=#447700>!  approximation that the droplet size does not change, to within a few percent.<a name='12734'></font>
<font color=#447700>!  This may _not_ be the case for cnu other than zero!<a name='12735'></font>
<font color=#447700>!          chlacw(mgs) = (ehlw(mgs)*cx(mgs,lc)*cx(mgs,lhl)*(pi/4.)*<a name='12736'></font>
<font color=#447700>!     :    abs(vtxbar(mgs,lhl,1)-vtxbar(mgs,lc,1))*<a name='12737'></font>
<font color=#447700>!     :    (2.0*xdia(mgs,lhl,1)*(xdia(mgs,lhl,1) +<a name='12738'></font>
<font color=#447700>!     :         xdia(mgs,lc,1)*gf43rds) +<a name='12739'></font>
<font color=#447700>!     :      xdia(mgs,lc,2)*gf53rds))<a name='12740'></font>
<a name='12741'>
<font color=#447700>!          chlacw(mgs) = Min( chlacw(mgs), 0.6*cx(mgs,lc)/dtp )<a name='12742'></font>
<a name='12743'>
<font color=#447700>!        chlacw(mgs) = qhlacw(mgs)*rho0(mgs)/xmas(mgs,lc)<a name='12744'></font>
        chlacw(mgs) = qhlacw(mgs)*rho0(mgs)/xmascw(mgs)<a name='12745'>
<font color=#447700>!        chlacw(mgs) = min(chlacw(mgs),cxmxd(mgs,lc))<a name='12746'></font>
        chlacw(mgs) = Min( chlacw(mgs), 0.5*cx(mgs,lc)/dtp )<a name='12747'>
       ELSE<a name='12748'>
        qhlacw(mgs) = 0.0<a name='12749'>
       ENDIF<a name='12750'>
<font color=#447700>!      ELSE<a name='12751'></font>
<font color=#447700>!      chlacw(mgs) =<a name='12752'></font>
<font color=#447700>!     &gt;   ((0.25)*pi)*ehlw(mgs)*cx(mgs,lc)*cx(mgs,lhl)<a name='12753'></font>
<font color=#447700>!     &gt;  *abs(vtxbar(mgs,lhl,1)-vtxbar(mgs,lc,1))<a name='12754'></font>
<font color=#447700>!     &gt;  *(  gf1*xdia(mgs,lc,2)<a name='12755'></font>
<font color=#447700>!     &gt;    + 2.0*gf2*xdia(mgs,lc,1)*xdia(mgs,lhl,1)<a name='12756'></font>
<font color=#447700>!     &gt;    + gf3*xdia(mgs,lhl,2) )<a name='12757'></font>
<font color=#447700>!      chlacw(mgs) = min(chlacw(mgs),0.5*cx(mgs,lc)/dtp)<a name='12758'></font>
<font color=#447700>!      chlacw(mgs) = min(chlacw(mgs),cxmxd(mgs,lc))<a name='12759'></font>
<font color=#447700>!      chlacw(mgs) = min(chlacw(mgs),ccmxd(mgs))<a name='12760'></font>
      ENDIF<a name='12761'>
      end do<a name='12762'>
      end if<a name='12763'>
<font color=#447700>!<a name='12764'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 22kk'<a name='12765'>
      chlaci(:) = 0.0<a name='12766'>
      chlaci0(:) = 0.0<a name='12767'>
      if ( ipconc .ge. 1 .or. ipelec .ge. 1 ) then<a name='12768'>
      do mgs = 1,ngscnt<a name='12769'>
      IF ( lhl .gt. 1 .and. ( ehli(mgs) .gt. 0.0 .or. (ipelec &gt; 0 .and. ehliclsn(mgs) &gt; 0.0) )  ) THEN<a name='12770'>
       IF ( ipconc .ge. 5 ) THEN<a name='12771'>
<a name='12772'>
       vt = Sqrt((vtxbar(mgs,lhl,1)-vtxbar(mgs,li,1))**2 +    &amp;<a name='12773'>
     &amp;            0.04*vtxbar(mgs,lhl,1)*vtxbar(mgs,li,1) )<a name='12774'>
<a name='12775'>
          chlaci0(mgs) = 0.25*pi*ehliclsn(mgs)*cx(mgs,lhl)*cx(mgs,li)*vt*   &amp;<a name='12776'>
     &amp;         (  da0lhl(mgs)*xdia(mgs,lhl,3)**2 +     &amp;<a name='12777'>
     &amp;            dab0(lhl,li)*xdia(mgs,lhl,3)*xdia(mgs,li,3) +    &amp;<a name='12778'>
     &amp;            da0(li)*xdia(mgs,li,3)**2 )<a name='12779'>
<a name='12780'>
<font color=#447700>!       ELSE<a name='12781'></font>
<font color=#447700>!        chlaci(mgs) =<a name='12782'></font>
<font color=#447700>!     &gt;   ((0.25)*pi)*ehli(mgs)*cx(mgs,li)*cx(mgs,lhl)<a name='12783'></font>
<font color=#447700>!     &gt;  *abs(vtxbar(mgs,lhl,1)-vtxbar(mgs,li,1))<a name='12784'></font>
<font color=#447700>!     &gt;  *(  gf1*xdia(mgs,li,2)<a name='12785'></font>
<font color=#447700>!     &gt;    + 2.0*gf2*xdia(mgs,li,1)*xdia(mgs,lhl,1)<a name='12786'></font>
<font color=#447700>!     &gt;    + gf3*xdia(mgs,lhl,2) )<a name='12787'></font>
        ENDIF<a name='12788'>
<a name='12789'>
        chlaci(mgs) = min(ehli(mgs)*chlaci0(mgs),cimxd(mgs))<a name='12790'>
       ENDIF<a name='12791'>
      end do<a name='12792'>
      end if<a name='12793'>
<a name='12794'>
<a name='12795'>
      IF ( lis &gt; 1 .and. ipconc .ge. 5) THEN<a name='12796'>
      <a name='12797'>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 22kk'<a name='12798'>
      chlacis(:) = 0.0<a name='12799'>
      chlacis0(:) = 0.0<a name='12800'>
       do mgs = 1,ngscnt<a name='12801'>
      IF ( lhl .gt. 1 .and. ( ehlis(mgs) .gt. 0.0 .or. (ipelec &gt; 0 .and. ehlisclsn(mgs) &gt; 0.0) )  ) THEN<a name='12802'>
<a name='12803'>
       vt = Sqrt((vtxbar(mgs,lhl,1)-vtxbar(mgs,lis,1))**2 +    &amp;<a name='12804'>
     &amp;            0.04*vtxbar(mgs,lhl,1)*vtxbar(mgs,lis,1) )<a name='12805'>
<a name='12806'>
          chlacis0(mgs) = 0.25*pi*ehlisclsn(mgs)*cx(mgs,lhl)*cx(mgs,lis)*vt*   &amp;<a name='12807'>
     &amp;         (  da0lhl(mgs)*xdia(mgs,lhl,3)**2 +     &amp;<a name='12808'>
     &amp;            dab0(lhl,lis)*xdia(mgs,lhl,3)*xdia(mgs,lis,3) +    &amp;<a name='12809'>
     &amp;            da0(lis)*xdia(mgs,lis,3)**2 )<a name='12810'>
<a name='12811'>
<a name='12812'>
        chlacis(mgs) = min(ehlis(mgs)*chlacis0(mgs),cxmxd(mgs,lis))<a name='12813'>
       ENDIF<a name='12814'>
      end do<a name='12815'>
      ENDIF<a name='12816'>
<a name='12817'>
<font color=#447700>!<a name='12818'></font>
<font color=#447700>!<a name='12819'></font>
      if (ndebug .gt. 0 ) write(0,*) 'ICEZVD_GS: conc 22jj'<a name='12820'>
      chlacs(:) = 0.0<a name='12821'>
      chlacs0(:) = 0.0<a name='12822'>
      if ( ipconc .ge. 1 .or. ipelec .ge. 1 ) then<a name='12823'>
      do mgs = 1,ngscnt<a name='12824'>
      IF ( lhl .gt. 1 .and. ( ehls(mgs) .gt. 0.0 .or. (ipelec &gt; 0 .and. ehlsclsn(mgs) &gt; 0.0) ) ) THEN<a name='12825'>
       IF ( ipconc .ge. 5 ) THEN<a name='12826'>
<a name='12827'>
       vt = Sqrt((vtxbar(mgs,lhl,1)-vtxbar(mgs,ls,1))**2 +    &amp;<a name='12828'>
     &amp;            0.04*vtxbar(mgs,lhl,1)*vtxbar(mgs,ls,1) )<a name='12829'>
<a name='12830'>
          chlacs0(mgs) = 0.25*pi*ehlsclsn(mgs)*cx(mgs,lhl)*cx(mgs,ls)*vt*   &amp;<a name='12831'>
     &amp;         (  da0lhl(mgs)*xdia(mgs,lhl,3)**2 +     &amp;<a name='12832'>
     &amp;            dab0(lhl,ls)*xdia(mgs,lhl,3)*xdia(mgs,ls,3) +    &amp;<a name='12833'>
     &amp;            da0(ls)*xdia(mgs,ls,3)**2 )<a name='12834'>
<a name='12835'>
<font color=#447700>!       ELSE<a name='12836'></font>
<font color=#447700>!      chlacs(mgs) =<a name='12837'></font>
<font color=#447700>!     &gt;   ((0.25)*pi)*ehls(mgs)*cx(mgs,ls)*cx(mgs,lhl)<a name='12838'></font>
<font color=#447700>!     &gt;  *abs(vtxbar(mgs,lhl,1)-vtxbar(mgs,ls,1))<a name='12839'></font>
<font color=#447700>!     &gt;  *(  gf3*gf1*xdia(mgs,ls,2)<a name='12840'></font>
<font color=#447700>!     &gt;    + 2.0*gf2*gf2*xdia(mgs,ls,1)*xdia(mgs,lhl,1)<a name='12841'></font>
<font color=#447700>!     &gt;    + gf1*gf3*xdia(mgs,lhl,2) )<a name='12842'></font>
      ENDIF<a name='12843'>
      chlacs(mgs) = min(ehls(mgs)*chlacs0(mgs),csmxd(mgs))<a name='12844'>
      ENDIF<a name='12845'>
      end do<a name='12846'>
      end if<a name='12847'>
<a name='12848'>
<font color=#447700>!<a name='12849'></font>
<font color=#447700>! Ziegler (1985) autoconversion<a name='12850'></font>
<font color=#447700>!<a name='12851'></font>
<font color=#447700>!<a name='12852'></font>
      IF ( ipconc .ge. 2 .and. ircnw /= -1) THEN <font color=#447700>! DTD: added flag for autoconversion.  If -1, turns off autoconversion<a name='12853'></font>
      if (ndebug .gt. 0 ) write(0,*) 'conc 26a'<a name='12854'>
      <a name='12855'>
      DO mgs = 1,ngscnt<a name='12856'>
        zrcnw(mgs) = 0.0<a name='12857'>
        qrcnw(mgs) = 0.0<a name='12858'>
        crcnw(mgs) = 0.0<a name='12859'>
        cautn(mgs) = 0.0<a name='12860'>
      ENDDO<a name='12861'>
      <a name='12862'>
      DO mgs = 1,ngscnt<a name='12863'>
<font color=#447700>!      qracw(mgs) = 0.0<a name='12864'></font>
<font color=#447700>!      cracw(mgs) = 0.0<a name='12865'></font>
       IF ( qx(mgs,lc) .gt. qxmin(lc) .and. cx(mgs,lc) .gt. 1000. .and. temg(mgs) .gt. tfrh+4.) THEN<a name='12866'>
       <font color=#447700>! .and. w(igs(mgs),jgs,kgs(mgs)) &gt; 5.0) THEN ! DTD: added w threshold for testing                                                                                                            <a name='12867'></font>
         volb = xv(mgs,lc)*(1./(1.+CNU))**(1./2.)<a name='12868'>
         cautn(mgs) = Min(ccmxd(mgs),   &amp;<a name='12869'>
     &amp;      ((CNU+2.)/(CNU+1.))*aa1*cx(mgs,lc)**2*xv(mgs,lc)**2)<a name='12870'>
         cautn(mgs) = Max( 0.0d0, cautn(mgs) )<a name='12871'>
         IF ( rb(mgs) .le. 7.51d-6 ) THEN<a name='12872'>
           t2s = 1.d30<a name='12873'>
<font color=#447700>!           cautn(mgs) = 0.0<a name='12874'></font>
         ELSE<a name='12875'>
<font color=#447700>!         XL2P=2.7E-2*XNC*XVC*((1.E12*RB**3*RC)-0.4)<a name='12876'></font>
         <a name='12877'>
<font color=#447700>!        T2S=3.72E-3/(((1.E4*RB)-7.5)*XNC*XVC) <a name='12878'></font>
<font color=#447700>!           t2s = 3.72E-3/(((1.e6*rb)-7.5)*cx(mgs,lc)*xv(mgs,lc))<a name='12879'></font>
<font color=#447700>!           t2s = 3.72/(((1.e6*rb(mgs))-7.5)*rho0(mgs)*qx(mgs,lc))<a name='12880'></font>
           t2s = 3.72/(1.e6*(rb(mgs)-7.500d-6)*rho0(mgs)*qx(mgs,lc))<a name='12881'>
<a name='12882'>
           qrcnw(mgs) = Max( 0.0d0, xl2p(mgs)/(t2s*rho0(mgs)) )<a name='12883'>
           crcnw(mgs) = Max( 0.0d0, Min(3.5e9*xl2p(mgs)/t2s,0.5*cautn(mgs)) )<a name='12884'>
           <a name='12885'>
           IF ( dmrauto == 0 ) THEN<a name='12886'>
             IF ( qx(mgs,lr)*rho0(mgs) &gt; 1.2*xl2p(mgs) .and. cx(mgs,lr) &gt; cxmin ) THEN <font color=#447700>! Cohard and Pinty (2000a) switch over from (18) to (19)<a name='12887'></font>
               crcnw(mgs) = cx(mgs,lr)/qx(mgs,lr)*qrcnw(mgs)<a name='12888'>
             ENDIF<a name='12889'>
           ELSEIF ( dmrauto == 1  .and. cx(mgs,lr) &gt; cxmin) THEN<a name='12890'>
             IF ( qx(mgs,lr) &gt; qxmin(lr) ) THEN<a name='12891'>
               tmp = qrcnw(mgs)*cx(mgs,lr)/qx(mgs,lr)<a name='12892'>
               crcnw(mgs) = Min(tmp,crcnw(mgs) )<a name='12893'>
             ENDIF<a name='12894'>
           ELSEIF ( dmrauto == 2  .and. cx(mgs,lr) &gt; cxmin) THEN<a name='12895'>
               tmp = crcnw(mgs)<a name='12896'>
               tmp2 = qrcnw(mgs)*cx(mgs,lr)/qx(mgs,lr)<a name='12897'>
               <font color=#447700>! try mass-weighted average of old and new Dmr<a name='12898'></font>
               crcnw(mgs) = (tmp*qrcnw(mgs)+tmp2*qx(mgs,lr))/(qrcnw(mgs)+qx(mgs,lr))<a name='12899'>
           ELSEIF ( dmrauto == 3  .and. cx(mgs,lr) &gt; cxmin) THEN <font color=#447700>! adapted from MY/CP code<a name='12900'></font>
              tmp = Max( 2.d0*rh(mgs), dble( xdia(mgs,lr,3) ) )<a name='12901'>
              crcnw(mgs) = rho0(mgs)*qrcnw(mgs)/(pi/6.*1000.*tmp**3)<a name='12902'>
           ENDIF<a name='12903'>
           <a name='12904'>
           IF ( crcnw(mgs) &lt; 1.e-30 ) qrcnw(mgs) = 0.0<a name='12905'>
<a name='12906'>
<font color=#447700>!           IF (  crcnw(mgs) .gt. cautn(mgs) .and. crcnw(mgs) .gt. 1.0 )<a name='12907'></font>
<font color=#447700>!     :          THEN<a name='12908'></font>
<font color=#447700>!             write(0,*)  'crcnw,cautn ',crcnw(mgs)/cautn(mgs),<a name='12909'></font>
<font color=#447700>!     :          crcnw(mgs),cautn(mgs),igs(mgs),kgs(mgs),t2s,qx(mgs,lr)<a name='12910'></font>
<font color=#447700>!             write(0,*)  '            ',qx(mgs,lc),cx(mgs,lc),0.5e6*xdia(mgs,lc,1)<a name='12911'></font>
<font color=#447700>!             write(0,*)  '            ',rho0(mgs)*qrcnw(mgs)/crcnw(mgs),<a name='12912'></font>
<font color=#447700>!     :         1.e6*(( 3/(4.*pi))*rho0(mgs)*qrcnw(mgs)/<a name='12913'></font>
<font color=#447700>!     :       (crcnw(mgs)*xdn(mgs,lr)))**(1./3.),rh(mgs)*1.e6,rwrad(mgs)<a name='12914'></font>
<font color=#447700>!           ELSEIF ( crcnw(mgs) .gt. 1.0 .and. cautn(mgs) .gt. 0.) THEN<a name='12915'></font>
<font color=#447700>!             write(0,*)  'crcnw,cautn ',crcnw(mgs)/cautn(mgs),<a name='12916'></font>
<font color=#447700>!     :          crcnw(mgs),cautn(mgs),igs(mgs),kgs(mgs),t2s<a name='12917'></font>
<font color=#447700>!             write(0,*)  '            ',rho0(mgs)*qrcnw(mgs)/crcnw(mgs),<a name='12918'></font>
<font color=#447700>!     :  1.e6*(( 3*pi/4.)*rho0(mgs)*qrcnw(mgs)/<a name='12919'></font>
<font color=#447700>!     :   (crcnw(mgs)*xdn(mgs,lr)))**(1./3.)<a name='12920'></font>
<font color=#447700>!           ENDIF<a name='12921'></font>
<font color=#447700>!           crcnw(mgs) = Min(cautn(mgs),3.5e9*xl2p(mgs)/t2s)<a name='12922'></font>
<a name='12923'>
<font color=#447700>!           IF ( qrcnw(mgs) .gt. 0.3e-2 ) THEN<a name='12924'></font>
<font color=#447700>!            write(0,*)  'QRCNW'<a name='12925'></font>
<font color=#447700>!            write(0,*)  qrcnw(mgs),crcnw(mgs),cautn(mgs)<a name='12926'></font>
<font color=#447700>!            write(0,*)  xl2p,t2s,rho0(mgs),xv(mgs,lc),cx(mgs,lc),qx(mgs,lc)<a name='12927'></font>
<font color=#447700>!            write(0,*)  rb,0.5*xdia(mgs,lc,1),mgs,igs(mgs),kgs(mgs)<a name='12928'></font>
<font color=#447700>!           ENDIF<a name='12929'></font>
<font color=#447700>!           qrcnw(mgs) = Min(qrcnw(mgs),qcmxd(mgs))<a name='12930'></font>
         ENDIF<a name='12931'>
<a name='12932'>
<a name='12933'>
       ENDIF<a name='12934'>
      ENDDO<a name='12935'>
<a name='12936'>
<a name='12937'>
<a name='12938'>
      ELSE<a name='12939'>
<a name='12940'>
<font color=#447700>!<a name='12941'></font>
<font color=#447700>!  Berry 1968 auto conversion for rain (Orville &amp; Kopp 1977)<a name='12942'></font>
<font color=#447700>!<a name='12943'></font>
<font color=#447700>!<a name='12944'></font>
      if ( ircnw .eq. 4 ) then<a name='12945'>
      do mgs = 1,ngscnt<a name='12946'>
<font color=#447700>!      sconvmix(lcw,mgs) = 0.0<a name='12947'></font>
      qrcnw(mgs) =  0.0<a name='12948'>
      qdiff = max((qx(mgs,lc)-qminrncw),0.0)<a name='12949'>
      if ( qdiff .gt. 0.0 .and. xdia(mgs,lc,1) .gt. 20.0e-6 ) then<a name='12950'>
      argrcnw =   &amp;<a name='12951'>
     &amp;  ((1.2e-4)+(1.596e-12)*(cx(mgs,lc)*1.0e-6)   &amp;<a name='12952'>
     &amp;  /(cwdisp*qdiff*1.0e-3*rho0(mgs)))<a name='12953'>
      qrcnw(mgs) = (rho0(mgs)*1e-3)*(qdiff**2)/argrcnw<a name='12954'>
<font color=#447700>!      sconvmix(lcw,mgs) = max(sconvmix(lcw,mgs),0.0)<a name='12955'></font>
      qrcnw(mgs) = (max(qrcnw(mgs),0.0))<a name='12956'>
      end if<a name='12957'>
      end do<a name='12958'>
<a name='12959'>
      ENDIF<a name='12960'>
<font color=#447700>!<a name='12961'></font>
<font color=#447700>!<a name='12962'></font>
<font color=#447700>!<a name='12963'></font>
<font color=#447700>!  Berry 1968 auto conversion for rain (Ferrier 1994)<a name='12964'></font>
<font color=#447700>!<a name='12965'></font>
<font color=#447700>!<a name='12966'></font>
      if ( ircnw .eq. 5 ) then<a name='12967'>
      do mgs = 1,ngscnt<a name='12968'>
      qrcnw(mgs) = 0.0<a name='12969'>
      qrcnw(mgs) =  0.0<a name='12970'>
      qccrit = (pi/6.)*(cx(mgs,lc)*cwdiap**3)*xdn(mgs,lc)/rho0(mgs)<a name='12971'>
      qdiff = max((qx(mgs,lc)-qccrit),0.)<a name='12972'>
      if ( qdiff .gt. 0.0 .and. cx(mgs,lc) .gt. 1.0 ) then<a name='12973'>
      argrcnw = &amp;<a name='12974'>
<font color=#447700>!     &gt;  ((1.2e-4)+(1.596e-12)*cx(mgs,lc)/(cwdisp*rho0(mgs)*qdiff))   &amp;<a name='12975'></font>
     &amp;  ((1.2e-4)+(1.596e-12)*cx(mgs,lc)*1.0e-3/(cwdisp*rho0(mgs)*qdiff))<a name='12976'>
      qrcnw(mgs) = &amp;<a name='12977'>
<font color=#447700>!     &gt;  timflg(mgs)*rho0(mgs)*(qdiff**2)/argrcnw   &amp;<a name='12978'></font>
     &amp;  1.0e-3*rho0(mgs)*(qdiff**2)/argrcnw<a name='12979'>
      qrcnw(mgs) = Min(qxmxd(mgs,lc), (max(qrcnw(mgs),0.0)) )<a name='12980'>
<a name='12981'>
<font color=#447700>!      write(iunit,*) 'qrcnw,cx =',qrcnw(mgs),cx(mgs,lc),mgs,1.e3*qx(mgs,lc),cno(lr)<a name='12982'></font>
      end if<a name='12983'>
      end do<a name='12984'>
      end if<a name='12985'>
<a name='12986'>
<font color=#447700>!<a name='12987'></font>
<font color=#447700>!<a name='12988'></font>
<font color=#447700>!  kessler auto conversion for rain.<a name='12989'></font>
<font color=#447700>!<a name='12990'></font>
      if ( ircnw .eq. 2 ) then<a name='12991'>
      do mgs = 1,ngscnt<a name='12992'>
      qrcnw(mgs) = 0.0<a name='12993'>
      qrcnw(mgs) = (0.001)*max((qx(mgs,lc)-qminrncw),0.0)<a name='12994'>
      end do<a name='12995'>
      end if<a name='12996'>
<font color=#447700>!<a name='12997'></font>
<font color=#447700>!  c4 = pi/6<a name='12998'></font>
<font color=#447700>!  c1 = 0.12-0.32 for colorado storms...typically 0.3-0.4<a name='12999'></font>
<font color=#447700>!  berry reinhart type conversion (proctor 1988)<a name='13000'></font>
<font color=#447700>!<a name='13001'></font>
      if ( ircnw .eq. 1 ) then<a name='13002'>
      do mgs = 1,ngscnt<a name='13003'>
      qrcnw(mgs) = 0.0<a name='13004'>
      c1 = 0.2<a name='13005'>
      c4 = pi/(6.0)<a name='13006'>
      bradp =    &amp;<a name='13007'>
     &amp; (1.e+06) * ((c1/(0.38))**(1./3.)) * (xdia(mgs,lc,1)*(0.5))<a name='13008'>
      bl2 =   &amp;<a name='13009'>
     &amp; (0.027) * ((100.0)*(bradp**3)*(xdia(mgs,lc,1)*(0.5)) - (0.4))<a name='13010'>
      bt2 = (bradp -7.5) / (3.72)<a name='13011'>
      qrcnw(mgs) = 0.0<a name='13012'>
      if ( bl2 .gt. 0.0 .and. bt2 .gt. 0.0 ) then<a name='13013'>
      qrcnw(mgs) = bl2 * bt2 * rho0(mgs)   &amp;<a name='13014'>
     &amp;  * qx(mgs,lc) * qx(mgs,lc)<a name='13015'>
      end if<a name='13016'>
      end do<a name='13017'>
      end if<a name='13018'>
<a name='13019'>
<a name='13020'>
<a name='13021'>
      ENDIF  <font color=#447700>!  ( ipconc .ge. 2 )<a name='13022'></font>
<a name='13023'>
<font color=#447700>!<a name='13024'></font>
<font color=#447700>!<a name='13025'></font>
<font color=#447700>!<a name='13026'></font>
<font color=#447700>!  Bigg Freezing of Rain<a name='13027'></font>
<font color=#447700>!<a name='13028'></font>
      if (ndebug .gt. 0 ) write(0,*) 'conc 27a'<a name='13029'>
      qrfrz(:) = 0.0<a name='13030'>
      qrfrzs(:) = 0.0<a name='13031'>
      qrfrzf(:) = 0.0<a name='13032'>
      vrfrzf(:) = 0.0<a name='13033'>
      crfrz(:) = 0.0<a name='13034'>
      crfrzs(:) = 0.0<a name='13035'>
      crfrzf(:) = 0.0<a name='13036'>
      zrfrz(:)  = 0.0<a name='13037'>
      zrfrzs(:)  = 0.0<a name='13038'>
      zrfrzf(:)  = 0.0<a name='13039'>
      qwcnr(:) = 0.0<a name='13040'>
      <a name='13041'>
      IF ( .not. ( ipconc == 0 .and. lwsm6 ) ) THEN<a name='13042'>
      <a name='13043'>
      do mgs = 1,ngscnt <a name='13044'>
      if ( qx(mgs,lr) .gt. qxmin(lr) .and. temcg(mgs) .lt. -5. .and. ibiggopt &gt; 0 ) then<a name='13045'>
<font color=#447700>!      brz = 100.0<a name='13046'></font>
<font color=#447700>!      arz = 0.66<a name='13047'></font>
       IF ( ipconc .lt. 3 ) THEN<a name='13048'>
       qrfrz(mgs) =    &amp;<a name='13049'>
     &amp;  min(   &amp;<a name='13050'>
     &amp;  (20.0)*(pi**2)*brz*(xdn(mgs,lr)/rho0(mgs))   &amp;<a name='13051'>
     &amp;   *cx(mgs,lr)*(xdia(mgs,lr,1)**6)   &amp;<a name='13052'>
     &amp;   *(exp(max(-arz*temcg(mgs), 0.0))-1.0)   &amp;<a name='13053'>
     &amp;  , qrmxd(mgs))<a name='13054'>
        qrfrzf(mgs) = qrfrz(mgs)<a name='13055'>
<a name='13056'>
<font color=#447700>!       ELSEIF ( ipconc .ge. 3 .and. xv(mgs,lr) .gt. 1.1*xvmn(lr) ) THEN<a name='13057'></font>
       ELSEIF ( ipconc .ge. 3 ) THEN<a name='13058'>
<font color=#447700>!         tmp = brz*cx(mgs,lr)*(Exp(Max( -arz*temcg(mgs), 0.0 )) - 1.0)<a name='13059'></font>
<font color=#447700>!         crfrz(mgs) = xv(mgs,lr)*tmp<a name='13060'></font>
<a name='13061'>
         frach = 1.0d0<a name='13062'>
         <a name='13063'>
<font color=#447700>!         IF ( ibiggopt == 2 .and. imurain == 1 .and. lzr &lt; 1 ) THEN ! lzr check because results are weird for 3-moment<a name='13064'></font>
         IF ( ibiggopt == 2 .and. imurain == 1 ) THEN <font color=#447700>!<a name='13065'></font>
         <font color=#447700>! integrate from Bigg diameter (for given supercooling Ts) to infinity<a name='13066'></font>
           <a name='13067'>
           volt = exp( 16.2 + 1.0*temcg(mgs) )* 1.0e-6 <font color=#447700>!  Ts == -temcg ; volt comes from the fit in Fig. 1 in Bigg 1953 <a name='13068'></font>
                                               <font color=#447700>! for mean temperature for freezing: -ln (V) = a*Ts - b, where a = 6.9/6.8, or approx a = 1.0, and b = 16.2<a name='13069'></font>
                                               <font color=#447700>! volt is given in cm**3, so convert to m**3<a name='13070'></font>
           dbigg = (6./pi* volt )**(1./3.) <a name='13071'>
           <a name='13072'>
           <font color=#447700>! perhaps should also test that W &gt; V_t_dbigg, i.e., that drops the size of dbigg are being lifted and cooled. <a name='13073'></font>
           <a name='13074'>
             ratio = Min(maxratiolu, dbigg/xdia(mgs,lr,1) )<a name='13075'>
           <a name='13076'>
           i = Min(nqiacrratio,Int(ratio*dqiacrratioinv))<a name='13077'>
<font color=#447700>!           j = Int(Max(0.0,Min(15.,alpha(mgs,lr))))<a name='13078'></font>
           j = Int(Max(0.0,Min(15.,alpha(mgs,lr)))*dqiacralphainv)<a name='13079'>
           delx = ratio - float(i)*dqiacrratio<a name='13080'>
           dely = alpha(mgs,lr) - float(j)*dqiacralpha<a name='13081'>
           ip1 = Min( i+1, nqiacrratio )<a name='13082'>
           jp1 = Min( j+1, nqiacralpha )<a name='13083'>
<a name='13084'>
           <font color=#447700>! interpolate along x, i.e., ratio; <a name='13085'></font>
           tmp1 = ciacrratio(i,j) + delx*dqiacrratioinv*(ciacrratio(ip1,j) - ciacrratio(i,j))<a name='13086'>
           tmp2 = ciacrratio(i,jp1) + delx*dqiacrratioinv*(ciacrratio(ip1,jp1) - ciacrratio(i,jp1))<a name='13087'>
           <a name='13088'>
           <font color=#447700>! interpolate along alpha; <a name='13089'></font>
           <a name='13090'>
           crfrz(mgs) = (tmp1 + dely*dqiacralphainv*(tmp2 - tmp1))*cx(mgs,lr)/dtp<a name='13091'>
           crfrzf(mgs) = crfrz(mgs)<a name='13092'>
           <font color=#447700>! interpolate along x, i.e., ratio; <a name='13093'></font>
           tmp1 = qiacrratio(i,j) + delx*dqiacrratioinv*(qiacrratio(ip1,j) - qiacrratio(i,j))<a name='13094'>
           tmp2 = qiacrratio(i,jp1) + delx*dqiacrratioinv*(qiacrratio(ip1,jp1) - qiacrratio(i,jp1))<a name='13095'>
           <a name='13096'>
           <font color=#447700>! interpolate along alpha; <a name='13097'></font>
           <a name='13098'>
           qrfrz(mgs) = (tmp1 + dely*dqiacralphainv*(tmp2 - tmp1))*qx(mgs,lr)/dtp<a name='13099'>
           qrfrzf(mgs) = qrfrz(mgs)<a name='13100'>
           <a name='13101'>
           <a name='13102'>
            IF ( ibiggsmallrain &gt; 0 .and. xv(mgs,lr) &lt; 2.*xvmn(lr) .and. ( ibiggsnow == 1 .or. ibiggsnow == 3 ) ) THEN<a name='13103'>
             <font color=#447700>! rain drops are so small that they can't be pushed smaller, so put into snow (or cloud ice, depending on ifrzs)<a name='13104'></font>
              crfrzf(mgs) = 0.0<a name='13105'>
              qrfrzf(mgs) = 0.0<a name='13106'>
              crfrzs(mgs) = crfrz(mgs)<a name='13107'>
              qrfrzs(mgs) = qrfrz(mgs)<a name='13108'>
<a name='13109'>
              IF ( lzr &gt; 1 ) THEN<a name='13110'>
                zrfrzs(mgs) = zrfrz(mgs)<a name='13111'>
                zrfrzf(mgs) = 0.<a name='13112'>
              ENDIF<a name='13113'>
           ELSEIF ( dbigg &lt; Max(dfrz,dhmn) .and. ( ibiggsnow == 1 .or. ibiggsnow == 3 ) ) THEN <font color=#447700>! { convert some to snow or ice crystals<a name='13114'></font>
            <font color=#447700>! temporarily store qrfrz and crfrz in snow terms and caclulate new crfrzf, qrfrzf, and zrfrzf. Leave crfrz etc. alone!<a name='13115'></font>
            <a name='13116'>
            crfrzs(mgs) = crfrz(mgs)<a name='13117'>
            qrfrzs(mgs) = qrfrz(mgs)<a name='13118'>
            <a name='13119'>
            IF ( ibiggsmallrain &gt; 0 .and. xv(mgs,lr) &lt; 1.2*xvmn(lr) ) THEN<a name='13120'>
             <font color=#447700>! rain drops are so small that they can't be pushed smaller, so put into snow (or cloud ice, depending on ifrzs)<a name='13121'></font>
            crfrzf(mgs) = 0.0<a name='13122'>
            qrfrzf(mgs) = 0.0<a name='13123'>
<a name='13124'>
             <a name='13125'>
            ELSE <font color=#447700>!{<a name='13126'></font>
            <a name='13127'>
           <font color=#447700>! recalculate using dhmn for ratio<a name='13128'></font>
           ratio = Min( maxratiolu, Max(dfrz,dhmn)/xdia(mgs,lr,1) )<a name='13129'>
           <a name='13130'>
           i = Min(nqiacrratio,Int(ratio*dqiacrratioinv))<a name='13131'>
<font color=#447700>!           j = Int(Max(0.0,Min(15.,alpha(mgs,lr))))<a name='13132'></font>
           j = Int(Max(0.0,Min(15.,alpha(mgs,lr)))*dqiacralphainv)<a name='13133'>
           delx = ratio - float(i)*dqiacrratio<a name='13134'>
           dely = alpha(mgs,lr) - float(j)*dqiacralpha<a name='13135'>
           ip1 = Min( i+1, nqiacrratio )<a name='13136'>
           jp1 = Min( j+1, nqiacralpha )<a name='13137'>
<a name='13138'>
           <font color=#447700>! interpolate along x, i.e., ratio; <a name='13139'></font>
           tmp1 = ciacrratio(i,j) + delx*dqiacrratioinv*(ciacrratio(ip1,j) - ciacrratio(i,j))<a name='13140'>
           tmp2 = ciacrratio(i,jp1) + delx*dqiacrratioinv*(ciacrratio(ip1,jp1) - ciacrratio(i,jp1))<a name='13141'>
<a name='13142'>
<a name='13143'>
           <font color=#447700>! interpolate along alpha; <a name='13144'></font>
           <a name='13145'>
           crfrzf(mgs) = (tmp1 + dely*dqiacralphainv*(tmp2 - tmp1))*cx(mgs,lr)/dtp<a name='13146'>
           <a name='13147'>
           <font color=#447700>! interpolate along x, i.e., ratio; <a name='13148'></font>
           tmp1 = qiacrratio(i,j) + delx*dqiacrratioinv*(qiacrratio(ip1,j) - qiacrratio(i,j))<a name='13149'>
           tmp2 = qiacrratio(i,jp1) + delx*dqiacrratioinv*(qiacrratio(ip1,jp1) - qiacrratio(i,jp1))<a name='13150'>
           <a name='13151'>
           <font color=#447700>! interpolate along alpha; <a name='13152'></font>
           <a name='13153'>
           qrfrzf(mgs) = (tmp1 + dely*dqiacralphainv*(tmp2 - tmp1))*qx(mgs,lr)/dtp<a name='13154'>
<a name='13155'>
           <font color=#447700>! now subtract off the difference<a name='13156'></font>
            crfrzs(mgs) = crfrzs(mgs) - crfrzf(mgs)<a name='13157'>
            qrfrzs(mgs) = qrfrzs(mgs) - qrfrzf(mgs)<a name='13158'>
<a name='13159'>
            ENDIF <font color=#447700>! }<a name='13160'></font>
           ELSE<a name='13161'>
            crfrzs(mgs) = 0.0<a name='13162'>
            qrfrzs(mgs) = 0.0<a name='13163'>
           ENDIF <font color=#447700>! }<a name='13164'></font>
           <a name='13165'>
           IF ( (qrfrz(mgs))*dtp &gt; qx(mgs,lr) ) THEN<a name='13166'>
             fac = ( qrfrz(mgs) )*dtp/qx(mgs,lr)<a name='13167'>
             qrfrz(mgs) = fac*qrfrz(mgs)<a name='13168'>
             qrfrzs(mgs) = fac*qrfrzs(mgs)<a name='13169'>
             qrfrzf(mgs) = fac*qrfrzf(mgs)<a name='13170'>
             crfrz(mgs) = fac*crfrz(mgs)<a name='13171'>
             crfrzs(mgs) = fac*crfrzs(mgs)<a name='13172'>
             crfrzf(mgs) = fac*crfrzf(mgs)<a name='13173'>
           ENDIF<a name='13174'>
<font color=#447700>!           IF ( (crfrzs(mgs) + crfrz(mgs))*dtp &gt; cx(mgs,lr) ) THEN<a name='13175'></font>
<font color=#447700>!             fac = ( crfrzs(mgs) + crfrz(mgs) )*dtp/cx(mgs,lr)<a name='13176'></font>
<font color=#447700>!             crfrz(mgs) = fac*crfrz(mgs)<a name='13177'></font>
<font color=#447700>!             crfrzs(mgs) = fac*crfrzs(mgs)<a name='13178'></font>
<font color=#447700>!           ENDIF<a name='13179'></font>
           <a name='13180'>
<font color=#447700>!           qrfrzf(mgs) = qrfrz(mgs)<a name='13181'></font>
<font color=#447700>!           crfrzf(mgs) = crfrz(mgs)<a name='13182'></font>
           <a name='13183'>
   <font color=#447700>!        qrfrz(mgs) = qrfrzf(mgs) + qrfrzs(mgs)<a name='13184'></font>
   <font color=#447700>!        crfrz(mgs) = crfrzf(mgs) + crfrzs(mgs)<a name='13185'></font>
<a name='13186'>
           <a name='13187'>
         ELSE <font color=#447700>! ibiggopt == 1 <a name='13188'></font>
         <a name='13189'>
         tmp = xv(mgs,lr)*brz*cx(mgs,lr)*(Exp(Max( -arz*temcg(mgs), 0.0 )) - 1.0)<a name='13190'>
         IF ( .false. .and. tmp .gt. cxmxd(mgs,lr) ) THEN <font color=#447700>! {<a name='13191'></font>
<font color=#447700>!           write(iunit,*) 'Bigg Freezing problem!',mgs,igs(mgs),kgs(mgs)<a name='13192'></font>
<font color=#447700>!           write(iunit,*)  'tmp, cx(lr), xv = ',tmp, cx(mgs,lr), xv(mgs,lr), (Exp(Max( -arz*temcg(mgs), 0.0 )) - 1.0)<a name='13193'></font>
<font color=#447700>!           write(iunit,*)  'qr,temcg = ',qx(mgs,lr)*1000.,temcg(mgs)<a name='13194'></font>
           crfrz(mgs) = cxmxd(mgs,lr) <font color=#447700>! cx(mgs,lr)/dtp<a name='13195'></font>
           qrfrz(mgs) = qxmxd(mgs,lr) <font color=#447700>! qx(mgs,lr)/dtp<a name='13196'></font>
<font color=#447700>!           STOP<a name='13197'></font>
         ELSE <font color=#447700>! } {<a name='13198'></font>
         crfrz(mgs) = tmp<a name='13199'>
 <font color=#447700>!        crfrzfmx = cx(mgs,lr)*Exp(-4./3.*pi*(40.e-6)**3/xv(mgs,lr))<a name='13200'></font>
 <font color=#447700>!        IF ( crfrz(mgs) .gt. crfrzmx ) THEN<a name='13201'></font>
 <font color=#447700>!          crfrz(mgs) = crfrzmx<a name='13202'></font>
 <font color=#447700>!          qrfrz(mgs) = bfnu*xmas(mgs,lr)*rhoinv(mgs)*crfrzmx<a name='13203'></font>
 <font color=#447700>!          qwcnr(mgs) = cx(mgs,lr) - crfrzmx<a name='13204'></font>
 <font color=#447700>!        ELSE<a name='13205'></font>
         IF ( lzr &lt; 1 ) THEN<a name='13206'>
           IF ( imurain == 3 ) THEN<a name='13207'>
             bfnu = bfnu0<a name='13208'>
           ELSE <font color=#447700>!imurain == 1<a name='13209'></font>
             bfnu = bfnu1<a name='13210'>
           ENDIF<a name='13211'>
         ELSE<a name='13212'>
 <font color=#447700>!         bfnu = 1.0 ! (alpha(mgs,lr)+2.0)/(alpha(mgs,lr)+1.)<a name='13213'></font>
           IF ( imurain == 3 ) THEN<a name='13214'>
             bfnu = (alpha(mgs,lr)+2.0)/(alpha(mgs,lr)+1.)<a name='13215'>
           ELSE <font color=#447700>!imurain == 1<a name='13216'></font>
<font color=#447700>!             bfnu = bfnu1<a name='13217'></font>
            bfnu = (4. + alpha(mgs,lr))*(5. + alpha(mgs,lr))*(6. + alpha(mgs,lr))/  &amp;<a name='13218'>
     &amp;            ((1. + alpha(mgs,lr))*(2. + alpha(mgs,lr))*(3. + alpha(mgs,lr)))<a name='13219'>
<font color=#447700>!            bfnu = 1.<a name='13220'></font>
           ENDIF<a name='13221'>
         ENDIF <a name='13222'>
         qrfrz(mgs) = bfnu*xmas(mgs,lr)*rhoinv(mgs)*crfrz(mgs)<a name='13223'>
<a name='13224'>
         qrfrz(mgs) = Min( qrfrz(mgs), 1.*qx(mgs,lr)/dtp ) <font color=#447700>! qxmxd(mgs,lr) <a name='13225'></font>
         crfrz(mgs) = Min( crfrz(mgs), 1.*cx(mgs,lr)/dtp ) <font color=#447700>!cxmxd(mgs,lr) <a name='13226'></font>
         qrfrz(mgs) = Min( qrfrz(mgs), qx(mgs,lr) )<a name='13227'>
         qrfrzf(mgs) = qrfrz(mgs)<a name='13228'>
         ENDIF <font color=#447700>!}<a name='13229'></font>
<a name='13230'>
         <a name='13231'>
         <a name='13232'>
         <a name='13233'>
         IF ( crfrz(mgs) .gt. qxmin(lh) ) THEN <font color=#447700>!{<a name='13234'></font>
<font color=#447700>!          IF ( xdia(mgs,lr,1) .lt. 200.e-6 ) THEN<a name='13235'></font>
<font color=#447700>!           IF ( xv(mgs,lr) .lt. xvmn(lh) ) THEN<a name='13236'></font>
           <a name='13237'>
           IF ( (ibiggsnow == 1 .or. ibiggsnow == 3 ) .and. ibiggopt /= 2 ) THEN<a name='13238'>
           xvfrz = rho0(mgs)*qrfrz(mgs)/(crfrz(mgs)*900.) <font color=#447700>! mean volume of frozen drops; 900. for frozen drop density<a name='13239'></font>
           frach = 0.5 *(1. +  Tanh(0.2e12 *( xvfrz - 1.15*xvmn(lh))))<a name='13240'>
<a name='13241'>
             qrfrzs(mgs) = (1.-frach)*qrfrz(mgs)<a name='13242'>
             crfrzs(mgs) = (1.-frach)*crfrz(mgs) <font color=#447700>! *rzxh(mgs)<a name='13243'></font>
<font color=#447700>!             qrfrzf(mgs) = frach*qrfrz(mgs)<a name='13244'></font>
           <a name='13245'>
           ENDIF<a name='13246'>
           <a name='13247'>
           IF ( ipconc .ge. 14 .and. 1.e-3*rho0(mgs)*qrfrz(mgs)/crfrz(mgs) .lt. xvmn(lh) ) THEN<a name='13248'>
             qrfrzs(mgs) = qrfrz(mgs)<a name='13249'>
             crfrzs(mgs) = crfrz(mgs) <font color=#447700>! *rzxh(mgs)<a name='13250'></font>
           ELSE<a name='13251'>
<font color=#447700>!           crfrz(mgs) = Min( crfrz(mgs), 0.1*cx(mgs,lr)/dtp ) ! cxmxd(mgs,lr) <a name='13252'></font>
<font color=#447700>!           qrfrz(mgs) = Min( qrfrz(mgs), 0.1*qx(mgs,lr)/dtp ) ! qxmxd(mgs,lr) <a name='13253'></font>
             qrfrzf(mgs) = frach*qrfrz(mgs)<a name='13254'>
<font color=#447700>!             crfrzf(mgs) = Min( qrfrz(mgs)*rho0(mgs)/(xdn(mgs,lh)*vgra), crfrz(mgs) )<a name='13255'></font>
            IF ( ibfr .le. 1 ) THEN<a name='13256'>
             crfrzf(mgs) = frach*Min(crfrz(mgs), qrfrz(mgs)/(bfnu*1.0*vr1mm*1000.0)*rho0(mgs) ) <font color=#447700>! rzxh(mgs)*crfrz(mgs)<a name='13257'></font>
            ELSEIF ( ibfr .eq. 5 ) THEN<a name='13258'>
             crfrzf(mgs) = frach*Min(crfrz(mgs), qrfrz(mgs)/(bfnu*vfrz*1000.0)*rho0(mgs) )*rzxh(mgs)  <font color=#447700>!*crfrz(mgs)<a name='13259'></font>
            ELSEIF ( ibfr .eq. 2 ) THEN<a name='13260'>
             crfrzf(mgs) = frach*Min(crfrz(mgs), qrfrz(mgs)/(bfnu*vfrz*1000.0)*rho0(mgs) ) <font color=#447700>! rzxh(mgs)*crfrz(mgs)<a name='13261'></font>
            ELSEIF ( ibfr .eq. 6 ) THEN<a name='13262'>
             crfrzf(mgs) = frach*Max(crfrz(mgs), qrfrz(mgs)/(bfnu*9.*xv(mgs,lr)*1000.0)*rho0(mgs) ) <font color=#447700>! rzxh(mgs)*crfrz(mgs)<a name='13263'></font>
            ELSE<a name='13264'>
             crfrzf(mgs) = frach*crfrz(mgs)<a name='13265'>
            ENDIF <a name='13266'>
<font color=#447700>!             crfrzf(mgs) = Min(crfrz(mgs), qrfrz(mgs)/(bfnu*xvmn(lh)*1000.0)*rho0(mgs) ) ! rzxh(mgs)*crfrz(mgs)<a name='13267'></font>
<font color=#447700>!            IF ( lz(lr) &gt; 1 .and. lz(lh) &gt; 1 ) THEN<a name='13268'></font>
<font color=#447700>!              crfrzf(mgs) = crfrz(mgs)<a name='13269'></font>
<font color=#447700>!            ENDIF<a name='13270'></font>
            <a name='13271'>
           ENDIF<a name='13272'>
<font color=#447700>!         crfrz(mgs) = Min( cxmxd(mgs,lr), rho0(mgs)*qrfrz(mgs)/xmas(mgs,lr) )<a name='13273'></font>
         ELSE<a name='13274'>
          crfrz(mgs) = 0.0<a name='13275'>
          qrfrz(mgs) = 0.0<a name='13276'>
         ENDIF <font color=#447700>!}<a name='13277'></font>
<a name='13278'>
         ENDIF <font color=#447700>! ibiggopt<a name='13279'></font>
<a name='13280'>
          IF ( lvol(lh) .gt. 1 ) THEN<a name='13281'>
           vrfrzf(mgs) = rho0(mgs)*qrfrzf(mgs)/rhofrz<a name='13282'>
          ENDIF<a name='13283'>
<a name='13284'>
        <a name='13285'>
        IF ( nsplinter .ne. 0 ) THEN<a name='13286'>
          IF ( nsplinter .ge. 1000 ) THEN<a name='13287'>
           <font color=#447700>! Lawson et al. 2015 JAS<a name='13288'></font>
           <font color=#447700>! ave. diam of freezing drops in microns<a name='13289'></font>
            tmp = 0<a name='13290'>
            IF ( qrfrz(mgs)*dtp &gt; qxmin(lh) .and. crfrz(mgs) &gt; 1.e-3 ) THEN<a name='13291'>
              tmpdiam = 1.e6*( 6.*qrfrz(mgs)/(1000.*pi*crfrz(mgs) ))**(1./3.)  <font color=#447700>! avg. diameter of newly frozen drops in microns<a name='13292'></font>
              tmp = lawson_splinter_fac*tmpdiam**4*crfrz(mgs)<a name='13293'>
            ENDIF<a name='13294'>
          ELSEIF ( nsplinter .gt. 0 ) THEN<a name='13295'>
            tmp = nsplinter*crfrz(mgs)<a name='13296'>
          ELSE<a name='13297'>
            tmp = -nsplinter*crfrzf(mgs)<a name='13298'>
          ENDIF<a name='13299'>
          csplinter2(mgs) = tmp<a name='13300'>
          qsplinter2(mgs) = Min(0.1*qrfrz(mgs), tmp*splintermass/rho0(mgs) ) <font color=#447700>! makes splinters smaller if too much mass is taken from graupel<a name='13301'></font>
<a name='13302'>
<font color=#447700>!          csplinter(mgs) = csplinter(mgs) + tmp<a name='13303'></font>
<font color=#447700>!          qsplinter(mgs) = qsplinter(mgs) + Min(0.1*qrfrz(mgs), tmp*splintermass/rho0(mgs) ) ! makes splinters smaller if too much mass is taken from graupel<a name='13304'></font>
        ENDIF<a name='13305'>
<font color=#447700>!         IF ( temcg(mgs) .lt. -31.0 ) THEN<a name='13306'></font>
<font color=#447700>!           qrfrz(mgs) = qx(mgs,lr)/dtp + qrcnw(mgs)<a name='13307'></font>
<font color=#447700>!           qrfrzf(mgs) = qrfrz(mgs)<a name='13308'></font>
<font color=#447700>!           crfrz(mgs) = cx(mgs,lr)/dtp + crcnw(mgs)<a name='13309'></font>
<font color=#447700>!           crfrzf(mgs) = Min(crfrz(mgs), qrfrz(mgs)/(bfnu*1.0*vr1mm*1000.0)*rho0(mgs) ) ! rzxh(mgs)*crfrz(mgs)<a name='13310'></font>
<font color=#447700>!         ENDIF<a name='13311'></font>
<font color=#447700>!         qrfrz(mgs) = 6.0*xdn(mgs,lr)*xv(mgs,lr)**2*tmp*rhoinv(mgs)<a name='13312'></font>
<font color=#447700>!         qrfrz(mgs) = Min( qrfrz(mgs), ffrz*qrmxd(mgs) )<a name='13313'></font>
<font color=#447700>!         crfrz(mgs) = Min( crmxd(mgs), ffrz*crfrz(mgs))<a name='13314'></font>
<font color=#447700>!         crfrz(mgs) = Min(crmxd(mgs),qrfrz(mgs)*rho0(mgs)/xmas(mgs,lr))<a name='13315'></font>
       ENDIF<a name='13316'>
<font color=#447700>!      if ( temg(mgs) .gt. 268.15 ) then<a name='13317'></font>
      else<a name='13318'>
<font color=#447700>!      end if<a name='13319'></font>
      end if<a name='13320'>
      end do<a name='13321'>
      <a name='13322'>
      ENDIF<a name='13323'>
<font color=#447700>!<a name='13324'></font>
<font color=#447700>!  Homogeneous freezing of cloud drops to ice crystals<a name='13325'></font>
<font color=#447700>!  following Bigg (1953) and Ferrier (1994).<a name='13326'></font>
<font color=#447700>!<a name='13327'></font>
      if (ndebug .gt. 0 ) write(0,*) 'conc 25b'<a name='13328'>
      do mgs = 1,ngscnt<a name='13329'>
      qwfrz(mgs) = 0.0<a name='13330'>
      cwfrz(mgs) = 0.0<a name='13331'>
      qwfrzc(mgs) = 0.0<a name='13332'>
      cwfrzc(mgs) = 0.0<a name='13333'>
      qwfrzp(mgs) = 0.0<a name='13334'>
      cwfrzp(mgs) = 0.0<a name='13335'>
      IF ( ibfc .ge. 1 .and. ibfc /= 3 .and. temg(mgs) &lt; 268.15 ) THEN<a name='13336'>
<font color=#447700>!      if ( qx(mgs,lc) .gt. qxmin(lc) .and. cx(mgs,lc) .gt. 1.  .and.   &amp;<a name='13337'></font>
<font color=#447700>!     &amp;     .not. (ipconc .ge. 2 .and. xdia(mgs,lc,1) .lt. 10.e-6) ) then<a name='13338'></font>
      if ( qx(mgs,lc) .gt. qxmin(lc) .and. cx(mgs,lc) .gt. cxmin ) THEN<a name='13339'>
      IF ( ipconc &lt; 2 ) THEN<a name='13340'>
      qwfrz(mgs) = ((2.0)*(brz)/(xdn(mgs,lc)*cx(mgs,lc)))   &amp;<a name='13341'>
     &amp;  *(exp(max(-arz*temcg(mgs), 0.0))-1.0)   &amp;<a name='13342'>
     &amp;  *rho0(mgs)*(qx(mgs,lc)**2)<a name='13343'>
      qwfrz(mgs) = max(qwfrz(mgs), 0.0)<a name='13344'>
      qwfrz(mgs) = min(qwfrz(mgs),qcmxd(mgs))<a name='13345'>
         cwfrz(mgs) = qwfrz(mgs)*rho0(mgs)/xmas(mgs,li)<a name='13346'>
       ELSEIF ( ipconc .ge. 2 ) THEN<a name='13347'>
         IF ( xdia(mgs,lc,3) &gt; 0.e-6 ) THEN<a name='13348'>
          volt = exp( 16.2 + 1.0*temcg(mgs) )* 1.0e-6 <font color=#447700>!  Ts == -temcg ; volt comes from the fit in Fig. 1 in Bigg 1953 <a name='13349'></font>
                                               <font color=#447700>! for mean temperature for freezing: -ln (V) = a*Ts - b<a name='13350'></font>
                                               <font color=#447700>! volt is given in cm**3, so factor of 1.e-6 to convert to m**3<a name='13351'></font>
<font color=#447700>!           dbigg = (6./pi* volt )**(1./3.) <a name='13352'></font>
<a name='13353'>
         IF ( .true. .and. cnu == 0.0 ) THEN<a name='13354'>
         cwfrz(mgs) = cx(mgs,lc)*Exp(-volt/xv(mgs,lc))/dtp <font color=#447700>! number of droplets with volume greater than volt<a name='13355'></font>
<font color=#447700>!turn off limit so that all can freeze at low temp<a name='13356'></font>
<font color=#447700>!!!       cwfrz(mgs) = Min(cwfrz(mgs),ccmxd(mgs))<a name='13357'></font>
<a name='13358'>
         qwfrz(mgs) = cwfrz(mgs)*xdn0(lc)*rhoinv(mgs)*(volt + xv(mgs,lc))<a name='13359'>
<font color=#447700>!         cwfrz(mgs) = cx(mgs,lc)*qwfrz(mgs)/qx(mgs,lc) ! reset number frozen to same fraction as mass. This makes <a name='13360'></font>
                                                       <font color=#447700>! sure that cwfrz and qwfrz are consistent and prevents <a name='13361'></font>
                                                       <font color=#447700>! spurious creation of ice crystals.<a name='13362'></font>
          ELSE<a name='13363'>
            ratio = (1. + cnu)*volt/xv(mgs,lc)<a name='13364'>
            cwfrz(mgs) = cx(mgs,lc)*Gamxinf(1.+cnu, ratio)/(dtp*gcnup1)<a name='13365'>
          <a name='13366'>
            qwfrz(mgs) = cx(mgs,lc)*xdn0(lc)*rhoinv(mgs)*Gamxinf(2.+cnu, ratio)/(dtp*gcnup2)<a name='13367'>
          <a name='13368'>
          ENDIF<a name='13369'>
<a name='13370'>
<font color=#447700>!         IF ( temg(mgs) &lt; tfrh - 3 ) THEN<a name='13371'></font>
<font color=#447700>!          cwfrz(mgs) = cx(mgs,lc)<a name='13372'></font>
<font color=#447700>!          qwfrz(mgs) = qx(mgs,lc)<a name='13373'></font>
<font color=#447700>!         ENDIF<a name='13374'></font>
<font color=#447700>!         IF ( qwfrz(mgs) &gt; 0.5*qx(mgs,lc) ) THEN<a name='13375'></font>
<font color=#447700>!           write(0,*) 'Problem with qwfrz(mgs): qwfrz,temcg,volt,xv,cx = ',qwfrz(mgs),qx(mgs,lc),temcg(mgs),volt,xv(mgs,lc),cx(mgs,lc),cwfrz(mgs)<a name='13376'></font>
<font color=#447700>!           STOP<a name='13377'></font>
<font color=#447700>!         ENDIF<a name='13378'></font>
<font color=#447700>!turn off limit so that all can freeze at low temp<a name='13379'></font>
<font color=#447700>!!!         qwfrz(mgs) = Min( qwfrz(mgs), qxmxd(mgs,lc) )<a name='13380'></font>
         ENDIF<a name='13381'>
       ENDIF<a name='13382'>
      if ( temg(mgs) .gt. 268.15 ) then<a name='13383'>
      qwfrz(mgs) = 0.0<a name='13384'>
      cwfrz(mgs) = 0.0<a name='13385'>
      end if<a name='13386'>
      end if<a name='13387'>
      ENDIF<a name='13388'>
<font color=#447700>!<a name='13389'></font>
        if ( xplate(mgs) .eq. 1 ) then<a name='13390'>
          qwfrzp(mgs) = qwfrz(mgs)<a name='13391'>
          cwfrzp(mgs) = cwfrz(mgs)<a name='13392'>
        end if<a name='13393'>
<font color=#447700>!  <a name='13394'></font>
        if ( xcolmn(mgs) .eq. 1 ) then<a name='13395'>
          qwfrzc(mgs) = qwfrz(mgs)<a name='13396'>
          cwfrzc(mgs) = cwfrz(mgs)<a name='13397'>
        end if<a name='13398'>
      <a name='13399'>
<font color=#447700>!<a name='13400'></font>
<font color=#447700>!     qwfrzp(mgs) = 0.0<a name='13401'></font>
<font color=#447700>!     qwfrzc(mgs) = qwfrz(mgs)<a name='13402'></font>
<font color=#447700>!<a name='13403'></font>
      end do<a name='13404'>
<font color=#447700>!<a name='13405'></font>
<font color=#447700>!<a name='13406'></font>
<font color=#447700>!  Contact freezing nucleation:  factor is to convert from L-1<a name='13407'></font>
<font color=#447700>!  T &lt; -2C:  via Meyers et al. JAM July, 1992 (31, 708-721)<a name='13408'></font>
<font color=#447700>!<a name='13409'></font>
      if (ndebug .gt. 0 ) write(0,*) 'conc 25a'<a name='13410'>
      do mgs = 1,ngscnt<a name='13411'>
<a name='13412'>
       ccia(mgs) = 0.0<a name='13413'>
<a name='13414'>
       cwctfz(mgs) = 0.0<a name='13415'>
       qwctfz(mgs) = 0.0<a name='13416'>
       ctfzbd(mgs) = 0.0<a name='13417'>
       ctfzth(mgs) = 0.0<a name='13418'>
       ctfzdi(mgs) = 0.0<a name='13419'>
<a name='13420'>
       cwctfzc(mgs) = 0.0<a name='13421'>
       qwctfzc(mgs) = 0.0<a name='13422'>
       cwctfzp(mgs) = 0.0<a name='13423'>
       qwctfzp(mgs) = 0.0<a name='13424'>
       IF ( icfn .ge. 1 ) THEN<a name='13425'>
<a name='13426'>
       IF ( temg(mgs) .lt. 271.15  .and. qx(mgs,lc) .gt. qxmin(lc)) THEN<a name='13427'>
<a name='13428'>
<font color=#447700>!       find available # of ice nuclei &amp; limit value to max depletion of cloud water<a name='13429'></font>
<a name='13430'>
        IF ( icfn .ge. 2 ) THEN<a name='13431'>
         ccia(mgs) = exp( 4.11 - (0.262)*temcg(mgs) )  <font color=#447700>! in m-3, see Walko et al. 1995<a name='13432'></font>
         <font color=#447700>!ccia(mgs) = Min(cwctfz(mgs), ccmxd(mgs) )<a name='13433'></font>
<a name='13434'>
<font color=#447700>!       now find how many of these collect cloud water to form IN<a name='13435'></font>
<font color=#447700>!       Cotton et al 1986<a name='13436'></font>
<a name='13437'>
         knud(mgs) = 2.28e-5 * temg(mgs) / ( pres(mgs)*raero ) <font color=#447700>!Walko et al. 1995<a name='13438'></font>
         knuda(mgs) = 1.257 + 0.4*exp(-1.1/knud(mgs))          <font color=#447700>!Pruppacher &amp; Klett 1997 eqn 11-16<a name='13439'></font>
         gtp(mgs) = 1. / ( fai(mgs) + fbi(mgs) )               <font color=#447700>!Byers 65 / Cotton 72b<a name='13440'></font>
         dfar(mgs) = kb*temg(mgs)*(1.+knuda(mgs)*knud(mgs))/(6.*pi*fadvisc(mgs)*raero) <font color=#447700>!P&amp;K 1997 eqn 11-15<a name='13441'></font>
         fn1(mgs) = 2.*pi*xdia(mgs,lc,1)*cx(mgs,lc)*ccia(mgs)<a name='13442'>
         fn2(mgs) = -gtp(mgs)*(ssw(mgs)-1.)*felv(mgs)/pres(mgs)<a name='13443'>
         fnft(mgs) = 0.4*(1.+1.45*knud(mgs)+0.4*knud(mgs)*exp(-1./knud(mgs)))*(ftka(mgs)+2.5*knud(mgs)*kaero)      &amp;<a name='13444'>
     &amp;              / ( (1.+3.*knud(mgs))*(2*ftka(mgs)+5.*knud(mgs)*kaero+kaero) )<a name='13445'>
<a name='13446'>
<a name='13447'>
<font color=#447700>!      Brownian diffusion<a name='13448'></font>
         ctfzbd(mgs) = fn1(mgs)*dfar(mgs)<a name='13449'>
<a name='13450'>
<font color=#447700>!      Thermophoretic contact nucleation<a name='13451'></font>
         ctfzth(mgs) = fn1(mgs)*fn2(mgs)*fnft(mgs)/rho0(mgs)<a name='13452'>
<a name='13453'>
<font color=#447700>!      Diffusiophoretic contact nucleation<a name='13454'></font>
         ctfzdi(mgs) = fn1(mgs)*fn2(mgs)*rw*temg(mgs)/(felv(mgs)*rho0(mgs))<a name='13455'>
<a name='13456'>
         cwctfz(mgs) = max( ctfzbd(mgs) + ctfzth(mgs) + ctfzdi(mgs) , 0.)<a name='13457'>
<a name='13458'>
<font color=#447700>!      Sum of the contact nucleation processes<a name='13459'></font>
<font color=#447700>!         IF ( cx(mgs,lc) .gt. 50.e6) write(6,*) 'ctfzbd,etc = ',ctfzbd(mgs),ctfzth(mgs),ctfzdi(mgs)<a name='13460'></font>
<font color=#447700>!         IF ( wvel(mgs) .lt. -0.05 ) write(6,*) 'ctfzbd,etc = ',ctfzbd(mgs),ctfzth(mgs),ctfzdi(mgs),cx(mgs,lc)*1e-6,wvel(mgs)<a name='13461'></font>
<font color=#447700>!         IF ( ssw(mgs) .lt. 1.0 .and. cx(mgs,lc) .gt. 1.e6 .and. cwctfz(mgs) .gt. 1. ) THEN<a name='13462'></font>
<font color=#447700>!          write(6,*) 'ctfzbd,etc = ',ctfzbd(mgs),ctfzth(mgs),ctfzdi(mgs),cx(mgs,lc)*1e-6,wvel(mgs),fn1(mgs),fn2(mgs)<a name='13463'></font>
<font color=#447700>!          write(6,*) 'more = ',nstep,ssw(mgs),dfar(mgs),gtp(mgs),felv(mgs),pres(mgs)<a name='13464'></font>
<font color=#447700>!         ENDIF<a name='13465'></font>
<a name='13466'>
        ELSEIF ( icfn .eq. 1 ) THEN<a name='13467'>
         IF ( wvel(mgs) .lt. -0.05 ) THEN <font color=#447700>! older kludgy version<a name='13468'></font>
           cwctfz(mgs) = cfnfac*exp( (-2.80) - (0.262)*temcg(mgs) )<a name='13469'>
           cwctfz(mgs) = Min((1.0e3)*cwctfz(mgs), ccmxd(mgs) )  <font color=#447700>!convert to m-3<a name='13470'></font>
         ENDIF<a name='13471'>
        ENDIF   <font color=#447700>! icfn<a name='13472'></font>
<a name='13473'>
        IF ( ipconc .ge. 2 ) THEN<a name='13474'>
         cwctfz(mgs) = Min( cwctfz(mgs)/dtp, ccmxd(mgs) )<a name='13475'>
         qwctfz(mgs) = xmas(mgs,lc)*cwctfz(mgs)/rho0(mgs)<a name='13476'>
        ELSE<a name='13477'>
         qwctfz(mgs) = (cimasn)*cwctfz(mgs)/(dtp*rho0(mgs))<a name='13478'>
         qwctfz(mgs) = max(qwctfz(mgs), 0.0)<a name='13479'>
         qwctfz(mgs) = min(qwctfz(mgs),qcmxd(mgs))<a name='13480'>
        ENDIF<a name='13481'>
<a name='13482'>
<font color=#447700>!<a name='13483'></font>
        if ( xplate(mgs) .eq. 1 ) then<a name='13484'>
         qwctfzp(mgs) = qwctfz(mgs)<a name='13485'>
         cwctfzp(mgs) = cwctfz(mgs)<a name='13486'>
        end if<a name='13487'>
<font color=#447700>!<a name='13488'></font>
        if ( xcolmn(mgs) .eq. 1 ) then<a name='13489'>
         qwctfzc(mgs) = qwctfz(mgs)<a name='13490'>
         cwctfzc(mgs) = cwctfz(mgs)<a name='13491'>
        end if<a name='13492'>
       <a name='13493'>
<font color=#447700>!<a name='13494'></font>
<font color=#447700>!     qwctfzc(mgs) = qwctfz(mgs)<a name='13495'></font>
<font color=#447700>!     qwctfzp(mgs) = 0.0<a name='13496'></font>
<font color=#447700>!<a name='13497'></font>
       end if<a name='13498'>
<a name='13499'>
       ENDIF <font color=#447700>! icfn<a name='13500'></font>
<a name='13501'>
      end do<a name='13502'>
<font color=#447700>!<a name='13503'></font>
<font color=#447700>!<a name='13504'></font>
<font color=#447700>!<a name='13505'></font>
<font color=#447700>! Hobbs-Rangno ice enhancement (Ferrier, 1994)<a name='13506'></font>
<font color=#447700>!<a name='13507'></font>
      if (ndebug .gt. 0 ) write(0,*) 'conc 23a'<a name='13508'>
      dtrh = 300.0<a name='13509'>
      hrifac = (1.e-3)*((0.044)*(0.01**3))<a name='13510'>
      do mgs = 1,ngscnt<a name='13511'>
      ciihr(mgs) = 0.0<a name='13512'>
      qiihr(mgs) = 0.0<a name='13513'>
      cicichr(mgs) = 0.0<a name='13514'>
      qicichr(mgs) = 0.0<a name='13515'>
      cipiphr(mgs) = 0.0<a name='13516'>
      qipiphr(mgs) = 0.0<a name='13517'>
      IF ( ihrn .ge. 1 ) THEN<a name='13518'>
      if ( qx(mgs,lc) .gt. qxmin(lc) ) then<a name='13519'>
      if ( temg(mgs) .lt. 273.15 ) then<a name='13520'>
<font color=#447700>!      write(iunit,'(3(1x,i3),3(1x,1pe12.5))')<a name='13521'></font>
<font color=#447700>!     : igs(mgs),jgs,kgs(mgs),cx(mgs,lc),rho0(mgs),qx(mgs,lc)<a name='13522'></font>
<font color=#447700>!      write(iunit,'(1pe15.6)')<a name='13523'></font>
<font color=#447700>!     :  log(cx(mgs,lc)*(1.e-6)/(3.0)),<a name='13524'></font>
<font color=#447700>!     :  ((1.e-3)*rho0(mgs)*qx(mgs,lc)),<a name='13525'></font>
<font color=#447700>!     :  (cx(mgs,lc)*(1.e-6)),<a name='13526'></font>
<font color=#447700>!     : ((1.e-3)*rho0(mgs)*qx(mgs,lc))/(cx(mgs,lc)*(1.e-6)),<a name='13527'></font>
<font color=#447700>!     : (alog(cx(mgs,lc)*(1.e-6)/(3.0)) *<a name='13528'></font>
<font color=#447700>!     &gt;  ((1.e-3)*rho0(mgs)*qx(mgs,lc))/(cx(mgs,lc)*(1.e-6)))<a name='13529'></font>
<a name='13530'>
      IF ( Log(cx(mgs,lc)*(1.e-6)/(3.0)) .gt. 0.0 ) THEN<a name='13531'>
      ciihr(mgs) = ((1.69e17)/dtrh)   &amp;<a name='13532'>
     &amp; *(log(cx(mgs,lc)*(1.e-6)/(3.0)) *   &amp;<a name='13533'>
     &amp;  ((1.e-3)*rho0(mgs)*qx(mgs,lc))/(cx(mgs,lc)*(1.e-6)))**(7./3.)<a name='13534'>
      ciihr(mgs) = ciihr(mgs)*(1.0e6)<a name='13535'>
      qiihr(mgs) = hrifac*ciihr(mgs)/rho0(mgs)<a name='13536'>
      qiihr(mgs) = max(qiihr(mgs), 0.0)<a name='13537'>
      qiihr(mgs) = min(qiihr(mgs),qcmxd(mgs))<a name='13538'>
      ENDIF<a name='13539'>
<font color=#447700>!<a name='13540'></font>
      if ( xplate(mgs) .eq. 1 ) then<a name='13541'>
      qipiphr(mgs) = qiihr(mgs)<a name='13542'>
      cipiphr(mgs) = ciihr(mgs)<a name='13543'>
      end if<a name='13544'>
<font color=#447700>!<a name='13545'></font>
      if ( xcolmn(mgs) .eq. 1 ) then<a name='13546'>
      qicichr(mgs) = qiihr(mgs)<a name='13547'>
      cicichr(mgs) = ciihr(mgs)<a name='13548'>
      end if<a name='13549'>
<font color=#447700>!<a name='13550'></font>
<font color=#447700>!     qipiphr(mgs) = 0.0<a name='13551'></font>
<font color=#447700>!     qicichr(mgs) = qiihr(mgs)<a name='13552'></font>
<font color=#447700>!<a name='13553'></font>
      end if<a name='13554'>
      end if<a name='13555'>
      ENDIF <font color=#447700>! ihrn<a name='13556'></font>
      end do<a name='13557'>
<font color=#447700>!<a name='13558'></font>
<font color=#447700>!<a name='13559'></font>
<font color=#447700>!<a name='13560'></font>
<font color=#447700>!  simple frozen rain to hail conversion.  All of the<a name='13561'></font>
<font color=#447700>!  frozen rain larger than 5.0e-3 m in diameter are converted<a name='13562'></font>
<font color=#447700>!  to hail.  This is done by considering the equation for<a name='13563'></font>
<font color=#447700>!  frozen rain mixing ratio:<a name='13564'></font>
<font color=#447700>!<a name='13565'></font>
<font color=#447700>!<a name='13566'></font>
<font color=#447700>!  qfw = [ cno(lf) * pi * fwdn / (6 rhoair) ]<a name='13567'></font>
<font color=#447700>!<a name='13568'></font>
<font color=#447700>!         /inf<a name='13569'></font>
<font color=#447700>!      *  |     fwdia*3 exp(-dia/fwdia) d(dia)<a name='13570'></font>
<font color=#447700>!         /Do<a name='13571'></font>
<font color=#447700>!<a name='13572'></font>
<font color=#447700>!  The amount to be reclassified as hail is the integral above from<a name='13573'></font>
<font color=#447700>!  Do to inf where Do is 5.0e-3 m.<a name='13574'></font>
<font color=#447700>!<a name='13575'></font>
<font color=#447700>!<a name='13576'></font>
<font color=#447700>!  qfauh = [ cno(lf) * pi * fwdn / (6 rhoair) ]<a name='13577'></font>
<font color=#447700>!<a name='13578'></font>
<font color=#447700>!<a name='13579'></font>
<a name='13580'>
<a name='13581'>
      hdia0 = 300.0e-6<a name='13582'>
      do mgs = 1,ngscnt<a name='13583'>
      qscnvi(mgs) = 0.0<a name='13584'>
      cscnvi(mgs) = 0.0<a name='13585'>
      cscnvis(mgs) = 0.0<a name='13586'>
<font color=#447700>!      IF ( .false. ) THEN<a name='13587'></font>
<font color=#447700>!      IF ( temg(mgs) .lt. tfr .and. ssi(mgs) .gt. 1.01 .and. qx(mgs,li) .gt. qxmin(li) ) THEN<a name='13588'></font>
      IF ( temg(mgs) .lt. tfr .and. qx(mgs,li) .gt. qxmin(li) ) THEN<a name='13589'>
        IF ( ipconc .ge. 4 .and. .false. ) THEN<a name='13590'>
         if ( cx(mgs,li) .gt. 10. .and. xdia(mgs,li,1) .gt. 50.e-6 ) then <font color=#447700>!{<a name='13591'></font>
         cirdiatmp =   &amp;<a name='13592'>
     &amp;  (qx(mgs,li)*rho0(mgs)   &amp;<a name='13593'>
     &amp; /(pi*xdn(mgs,li)*cx(mgs,li)))**(1./3.)<a name='13594'>
          IF ( cirdiatmp .gt. 100.e-6 ) THEN <font color=#447700>!{<a name='13595'></font>
          qscnvi(mgs) =   &amp;<a name='13596'>
     &amp;  ((pi*xdn(mgs,li)*cx(mgs,li)) / (6.0*rho0(mgs)*dtp))   &amp;<a name='13597'>
     &amp; *exp(-hdia0/cirdiatmp)   &amp;<a name='13598'>
     &amp; *( (hdia0**3) + 3.0*(hdia0**2)*cirdiatmp   &amp;<a name='13599'>
     &amp;  + 6.0*(hdia0)*(cirdiatmp**2) + 6.0*(cirdiatmp**3) )<a name='13600'>
      qscnvi(mgs) =   &amp;<a name='13601'>
     &amp;  min(qscnvi(mgs),qimxd(mgs))<a name='13602'>
          IF ( ipconc .ge. 4 ) THEN<a name='13603'>
            cscnvi(mgs) = Min( cimxd(mgs), cx(mgs,li)*Exp(-hdia0/cirdiatmp))<a name='13604'>
          ENDIF<a name='13605'>
         ENDIF  <font color=#447700>! }<a name='13606'></font>
        end if <font color=#447700>! }<a name='13607'></font>
<a name='13608'>
       ELSEIF ( ipconc .lt. 4 ) THEN<a name='13609'>
<a name='13610'>
        qscnvi(mgs) = 0.001*eii(mgs)*max((qx(mgs,li)-1.e-3),0.0)<a name='13611'>
        qscnvi(mgs) = min(qscnvi(mgs),qxmxd(mgs,li))<a name='13612'>
        cscnvi(mgs) = qscnvi(mgs)*rho0(mgs)/xmas(mgs,li)<a name='13613'>
        cscnvis(mgs) = 0.5*cscnvi(mgs)<a name='13614'>
<a name='13615'>
       ENDIF<a name='13616'>
      ENDIF<a name='13617'>
<font color=#447700>!      ENDIF<a name='13618'></font>
      end do<a name='13619'>
<a name='13620'>
<font color=#447700>!<a name='13621'></font>
<font color=#447700>!  Ventilation coeficients<a name='13622'></font>
<font color=#447700>!<a name='13623'></font>
      do mgs = 1,ngscnt<a name='13624'>
      fvent(mgs) = (fschm(mgs)**(1./3.)) * (fakvisc(mgs)**(-0.5))<a name='13625'>
      end do<a name='13626'>
<font color=#447700>!<a name='13627'></font>
<font color=#447700>!<a name='13628'></font>
      if ( ndebug .gt. 0 ) write(0,*) 'civent'<a name='13629'>
<font color=#447700>!<a name='13630'></font>
      civenta = 1.258e4<a name='13631'>
      civentb = 2.331<a name='13632'>
      civentc = 5.662e4<a name='13633'>
      civentd = 2.373<a name='13634'>
      civente = 0.8241<a name='13635'>
      civentf = -0.042<a name='13636'>
      civentg = 1.70<a name='13637'>
<a name='13638'>
      do mgs = 1,ngscnt<a name='13639'>
      IF ( icond .eq. 1 .or. temg(mgs) .le. tfrh    &amp;<a name='13640'>
     &amp;      .or. (qx(mgs,lr) .le. qxmin(lr) .and. qx(mgs,lc) .le. qxmin(lc)) ) THEN<a name='13641'>
      IF ( qx(mgs,li) .gt. qxmin(li) ) THEN<a name='13642'>
      cireyn =   &amp;<a name='13643'>
     &amp;  (civenta*xdia(mgs,li,1)**civentb   &amp;<a name='13644'>
     &amp;  +civentc*xdia(mgs,li,1)**civentd)   &amp;<a name='13645'>
     &amp;  /   &amp;<a name='13646'>
     &amp;  (civente*xdia(mgs,li,1)**civentf+civentg)<a name='13647'>
      xcivent = (fschm(mgs)**(1./3.))*((cireyn/fakvisc(mgs))**0.5)<a name='13648'>
      if ( xcivent .lt. 1.0 ) then<a name='13649'>
      civent(mgs) = 1.0 + 0.14*xcivent**2<a name='13650'>
      end if<a name='13651'>
      if ( xcivent .ge. 1.0 ) then<a name='13652'>
      civent(mgs) = 0.86 + 0.28*xcivent<a name='13653'>
      end if<a name='13654'>
      ELSE<a name='13655'>
       civent(mgs) = 0.0<a name='13656'>
      ENDIF<a name='13657'>
<a name='13658'>
<a name='13659'>
      ENDIF <font color=#447700>! icond .eq. 1<a name='13660'></font>
      end do<a name='13661'>
<a name='13662'>
<font color=#447700>!<a name='13663'></font>
<font color=#447700>!<a name='13664'></font>
      igmrwa = 100.0*2.0<a name='13665'>
      igmrwb = 100.*((5.0+br)/2.0)<a name='13666'>
      rwventa = (0.78)*gmoi(igmrwa)  <font color=#447700>! 0.78<a name='13667'></font>
      rwventb = (0.308)*gmoi(igmrwb) <font color=#447700>! 0.562825<a name='13668'></font>
      do mgs = 1,ngscnt<a name='13669'>
      IF ( qx(mgs,lr) .gt. qxmin(lr) ) THEN<a name='13670'>
        IF ( ipconc .ge. 3 ) THEN<a name='13671'>
          IF ( imurain == 3 ) THEN<a name='13672'>
           IF ( izwisventr == 1 ) THEN<a name='13673'>
            rwvent(mgs) = ventrx(mgs)*(1.6 + 124.9*(1.e-3*rho0(mgs)*qx(mgs,lr))**.2046)<a name='13674'>
           ELSE <font color=#447700>! izwisventr = 2<a name='13675'></font>
<font color=#447700>!  Following Wisner et al. (1972) but using gamma of volume. Note that Ferrier's rain fall speed does not integrate with gamma of volume, so using Vr = ar*d^br<a name='13676'></font>
          rwvent(mgs) =   &amp;<a name='13677'>
     &amp;  (0.78*ventrx(mgs) + 0.308*ventrxn(mgs)*fvent(mgs)   &amp;<a name='13678'>
     &amp;   *Sqrt((ar*rhovt(mgs)))   &amp;<a name='13679'>
     &amp;    *(xdia(mgs,lr,1)**((1.0+br)/2.0)) )<a name='13680'>
           ENDIF<a name='13681'>
<a name='13682'>
          ELSE <font color=#447700>! imurain == 1<a name='13683'></font>
       <font color=#447700>! linear interpolation of complete gamma function<a name='13684'></font>
<font color=#447700>!        tmp = 2. + alpha(mgs,lr)<a name='13685'></font>
<font color=#447700>!        i = Int(dgami*(tmp))<a name='13686'></font>
<font color=#447700>!        del = tmp - dgam*i<a name='13687'></font>
<font color=#447700>!        x = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='13688'></font>
<a name='13689'>
        IF ( iferwisventr == 1 ) THEN<a name='13690'>
<a name='13691'>
  <font color=#447700>! Ferrier fall speed in the ventillation term [uses fx(lr) ]<a name='13692'></font>
  <a name='13693'>
        alpr = Min(alpharmax,alpha(mgs,lr) )<a name='13694'>
<a name='13695'>
        x =  1. + alpha(mgs,lr)<a name='13696'>
<a name='13697'>
        IF ( lzr &gt; 1 ) THEN <font color=#447700>! 3 moment<a name='13698'></font>
        ELSE<a name='13699'>
         y = ventrxn(mgs)<a name='13700'>
        ENDIF<a name='13701'>
<a name='13702'>
<font color=#447700>!         vent1 = dble(xdia(mgs,lr,1))**(-2. - alpr) ! Actually OK<a name='13703'></font>
<font color=#447700>!         vent2 = dble(1./xdia(mgs,lr,1) + 0.5*fx(lr))**dble(2.5+alpr+0.5*bx(lr))  ! Actually OK<a name='13704'></font>
         vent1 = dble(xdia(mgs,lr,1))**(0.5 + 0.5*bx(lr)) <font color=#447700>! 2016.2.26 Changed for consistency with derivation (recast formula -- should be equivalent)<a name='13705'></font>
         vent2 = dble(1. + 0.5*fx(lr)*xdia(mgs,lr,1))**dble(2.5+alpr+0.5*bx(lr))<a name='13706'>
        <a name='13707'>
        <a name='13708'>
        rwvent(mgs) =    &amp;<a name='13709'>
     &amp;    0.78*x +    &amp;<a name='13710'>
     &amp;    0.308*fvent(mgs)*y*   &amp;<a name='13711'>
     &amp;            Sqrt(ax(lr)*rhovt(mgs))*(vent1/vent2)<a name='13712'>
       <a name='13713'>
<a name='13714'>
        ELSEIF ( iferwisventr == 2 ) THEN<a name='13715'>
          <a name='13716'>
<font color=#447700>!  Following Wisner et al. (1972) but using gamma of volume. Note that Ferrier's rain fall speed does not integrate with gamma of volume, so using Vr = ar*d^br<a name='13717'></font>
         x =  1. + alpha(mgs,lr)<a name='13718'>
<a name='13719'>
           rwvent(mgs) =   &amp;<a name='13720'>
     &amp;  (0.78*x + 0.308*ventrxn(mgs)*fvent(mgs)   &amp;<a name='13721'>
     &amp;   *Sqrt((ar*rhovt(mgs)))   &amp;<a name='13722'>
     &amp;    *(xdia(mgs,lr,1)**((1.0+br)/2.0)) )<a name='13723'>
<a name='13724'>
<a name='13725'>
          <a name='13726'>
          ENDIF <font color=#447700>! iferwisventr<a name='13727'></font>
          <a name='13728'>
          ENDIF <font color=#447700>! imurain<a name='13729'></font>
        ELSE<a name='13730'>
         rwvent(mgs) =   &amp;<a name='13731'>
     &amp;  (rwventa + rwventb*fvent(mgs)   &amp;<a name='13732'>
     &amp;   *Sqrt((ar*rhovt(mgs)))   &amp;<a name='13733'>
     &amp;    *(xdia(mgs,lr,1)**((1.0+br)/2.0)) )<a name='13734'>
        ENDIF<a name='13735'>
      ELSE<a name='13736'>
       rwvent(mgs) = 0.0<a name='13737'>
      ENDIF<a name='13738'>
      end do<a name='13739'>
<font color=#447700>!<a name='13740'></font>
      igmswa = 100.0*2.0<a name='13741'>
      igmswb = 100.*((5.0+ds)/2.0)<a name='13742'>
      swventa = (0.78)*gmoi(igmswa)<a name='13743'>
      swventb = (0.308)*gmoi(igmswb)<a name='13744'>
      do mgs = 1,ngscnt<a name='13745'>
      IF ( qx(mgs,ls) .gt. qxmin(ls) ) THEN<a name='13746'>
      IF ( ipconc .ge. 4 ) THEN<a name='13747'>
      swvent(mgs) = 0.65 + 0.44*fvent(mgs)*Sqrt(vtxbar(mgs,ls,1)*xdia(mgs,ls,1))<a name='13748'>
      ELSE<a name='13749'>
<font color=#447700>! 10-ice version:<a name='13750'></font>
       swvent(mgs) =   &amp;<a name='13751'>
     &amp;  (swventa + swventb*fvent(mgs)   &amp;<a name='13752'>
     &amp;   *Sqrt((cs*rhovt(mgs)))   &amp;<a name='13753'>
     &amp;   *(xdia(mgs,ls,1)**((1.0+ds)/2.0)) )<a name='13754'>
      ENDIF<a name='13755'>
      ELSE<a name='13756'>
      swvent(mgs) = 0.0<a name='13757'>
      ENDIF<a name='13758'>
      end do<a name='13759'>
<font color=#447700>!<a name='13760'></font>
<font color=#447700>!<a name='13761'></font>
<a name='13762'>
      igmhwa = 100.0*2.0<a name='13763'>
      igmhwb = 100.0*2.75<a name='13764'>
      hwventa = (0.78)*gmoi(igmhwa)<a name='13765'>
      hwventb = (0.308)*gmoi(igmhwb)<a name='13766'>
      hwventc = (4.0*gr/(3.0*cdx(lh)))**(0.25)<a name='13767'>
      do mgs = 1,ngscnt<a name='13768'>
      IF ( qx(mgs,lh) .gt. qxmin(lh) ) THEN<a name='13769'>
       IF ( .false. .or. alpha(mgs,lh) .eq. 0.0 ) THEN<a name='13770'>
        hwvent(mgs) =   &amp;<a name='13771'>
     &amp;  ( hwventa + hwventb*hwventc*fvent(mgs)   &amp;<a name='13772'>
     &amp;    *((xdn(mgs,lh)/rho0(mgs))**(0.25))   &amp;<a name='13773'>
     &amp;    *(xdia(mgs,lh,1)**(0.75)))<a name='13774'>
       ELSE <font color=#447700>! Ferrier 1994, eq. B.36<a name='13775'></font>
       <font color=#447700>! linear interpolation of complete gamma function<a name='13776'></font>
<font color=#447700>!        tmp = 2. + alpha(mgs,lh)<a name='13777'></font>
<font color=#447700>!        i = Int(dgami*(tmp))<a name='13778'></font>
<font color=#447700>!        del = tmp - dgam*i<a name='13779'></font>
<font color=#447700>!        x = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='13780'></font>
        <a name='13781'>
<font color=#447700>! note that hwvent includes a division by Gamma(1+alpha), so Gamma(2+alpha)/Gamma(1+alpha) = 1 + alpha<a name='13782'></font>
<font color=#447700>! and g1palp = Gamma(1+alpha) divides into y<a name='13783'></font>
        x =  1. + alpha(mgs,lh)<a name='13784'>
<a name='13785'>
        tmp = 1 + alpha(mgs,lh)<a name='13786'>
        i = Int(dgami*(tmp))<a name='13787'>
        del = tmp - dgam*i<a name='13788'>
        g1palp = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='13789'>
<a name='13790'>
        tmp = 2.5 + alpha(mgs,lh) + 0.5*bxh(mgs)<a name='13791'>
        i = Int(dgami*(tmp))<a name='13792'>
        del = tmp - dgam*i<a name='13793'>
        y = (gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami)/g1palp<a name='13794'>
        <a name='13795'>
        <a name='13796'>
        hwventy(mgs) = 0.308*fvent(mgs)*(xdia(mgs,lh,1)**(0.5 + 0.5*bxh(mgs)))*Sqrt(axh(mgs)*rhovt(mgs)) <a name='13797'>
        hwvent(mgs) =    &amp;<a name='13798'>
     &amp;  ( 0.78*x +  y*hwventy(mgs) ) <font color=#447700>!   &amp;<a name='13799'></font>
<font color=#447700>!     &amp;    0.308*fvent(mgs)*y*(xdia(mgs,lh,1)**(0.5 + 0.5*bxh(mgs)))*   &amp;<a name='13800'></font>
<font color=#447700>!     &amp;            Sqrt(axh(mgs)*rhovt(mgs)) )<a name='13801'></font>
       <a name='13802'>
       ENDIF<a name='13803'>
      ELSE<a name='13804'>
      hwvent(mgs) = 0.0<a name='13805'>
      hwventy(mgs) = 0.0<a name='13806'>
      ENDIF<a name='13807'>
      end do<a name='13808'>
      <a name='13809'>
      hlvent(:) = 0.0<a name='13810'>
      hlventy(:) = 0.0<a name='13811'>
<a name='13812'>
      IF ( lhl .gt. 1 ) THEN<a name='13813'>
      igmhwa = 100.0*2.0<a name='13814'>
      igmhwb = 100.0*2.75<a name='13815'>
      hwventa = (0.78)*gmoi(igmhwa)<a name='13816'>
      hwventb = (0.308)*gmoi(igmhwb)<a name='13817'>
      hwventc = (4.0*gr/(3.0*cdx(lhl)))**(0.25)<a name='13818'>
      do mgs = 1,ngscnt<a name='13819'>
      IF ( qx(mgs,lhl) .gt. qxmin(lhl) ) THEN<a name='13820'>
<a name='13821'>
       IF ( .false. .or. alpha(mgs,lhl) .eq. 0.0 ) THEN<a name='13822'>
        hlvent(mgs) =   &amp;<a name='13823'>
     &amp;  ( hwventa + hwventb*hwventc*fvent(mgs)   &amp;<a name='13824'>
     &amp;    *((xdn(mgs,lhl)/rho0(mgs))**(0.25))   &amp;<a name='13825'>
     &amp;    *(xdia(mgs,lhl,1)**(0.75)))<a name='13826'>
       ELSE <font color=#447700>! Ferrier 1994, eq. B.36<a name='13827'></font>
       <font color=#447700>! linear interpolation of complete gamma function<a name='13828'></font>
<font color=#447700>!        tmp = 2. + alpha(mgs,lhl)<a name='13829'></font>
<font color=#447700>!        i = Int(dgami*(tmp))<a name='13830'></font>
<font color=#447700>!        del = tmp - dgam*i<a name='13831'></font>
<font color=#447700>!        x = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='13832'></font>
<a name='13833'>
<font color=#447700>! note that hlvent includes a division by Gamma(1+alpha), so x = Gamma(2+alpha)/Gamma(1+alpha) = 1 + alpha<a name='13834'></font>
<font color=#447700>! and g1palp = Gamma(1+alpha) divides into y<a name='13835'></font>
<a name='13836'>
        x =  1. + alpha(mgs,lhl)<a name='13837'>
<a name='13838'>
        tmp = 1 + alpha(mgs,lhl)<a name='13839'>
        i = Int(dgami*(tmp))<a name='13840'>
        del = tmp - dgam*i<a name='13841'>
        g1palp = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='13842'>
<a name='13843'>
        tmp = 2.5 + alpha(mgs,lhl) + 0.5*bxhl(mgs)<a name='13844'>
        i = Int(dgami*(tmp))<a name='13845'>
        del = tmp - dgam*i<a name='13846'>
        y = (gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami)/g1palp <font color=#447700>! ratio of gamma functions<a name='13847'></font>
<a name='13848'>
        hlventy(mgs) = 0.308*fvent(mgs)*(xdia(mgs,lhl,1)**(0.5 + 0.5*bxhl(mgs)))*Sqrt(axhl(mgs)*rhovt(mgs)) <a name='13849'>
        <a name='13850'>
        hlvent(mgs) =  0.78*x + y*hlventy(mgs)  <font color=#447700>!   &amp;<a name='13851'></font>
<font color=#447700>!     &amp;    0.308*fvent(mgs)*y*(xdia(mgs,lhl,1)**(0.5 + 0.5*bxhl(mgs)))*   &amp;<a name='13852'></font>
<font color=#447700>!     &amp;            Sqrt(axhl(mgs)*rhovt(mgs)))<a name='13853'></font>
<font color=#447700>!     :            Sqrt(xdn(mgs,lhl)*ax(lhl)*rhovt(mgs)/rg0))/tmp<a name='13854'></font>
<a name='13855'>
        ENDIF<a name='13856'>
       ENDIF<a name='13857'>
      end do<a name='13858'>
      ENDIF<a name='13859'>
<a name='13860'>
<font color=#447700>!<a name='13861'></font>
<font color=#447700>!<a name='13862'></font>
<font color=#447700>!<a name='13863'></font>
<font color=#447700>!  Wet growth constants<a name='13864'></font>
<font color=#447700>!<a name='13865'></font>
      do mgs = 1,ngscnt<a name='13866'>
      fwet1(mgs) =   &amp;<a name='13867'>
     &amp; (2.0*pi)*   &amp;<a name='13868'>
     &amp; ( felv(mgs)*fwvdf(mgs)*rho0(mgs)*(qss0(mgs)-qx(mgs,lv))   &amp;<a name='13869'>
     &amp;  -ftka(mgs)*temcg(mgs) )   &amp;<a name='13870'>
     &amp; / ( rho0(mgs)*(felf(mgs)+fcw(mgs)*temcg(mgs)) )<a name='13871'>
      fwet2(mgs) =   &amp;<a name='13872'>
     &amp;  (1.0)-fci(mgs)*temcg(mgs)   &amp;<a name='13873'>
     &amp; / ( felf(mgs)+fcw(mgs)*temcg(mgs) )<a name='13874'>
      end do<a name='13875'>
<font color=#447700>!<a name='13876'></font>
<font color=#447700>!  Melting constants<a name='13877'></font>
<font color=#447700>!<a name='13878'></font>
      do mgs = 1,ngscnt<a name='13879'>
      fmlt1(mgs) = (2.0*pi)*   &amp;<a name='13880'>
     &amp;  ( felv(mgs)*fwvdf(mgs)*(qss0(mgs)-qx(mgs,lv))   &amp;<a name='13881'>
     &amp;   -ftka(mgs)*temcg(mgs)/rho0(mgs) )    &amp;<a name='13882'>
     &amp;  / (felf(mgs))<a name='13883'>
      fmlt2(mgs) = -fcw(mgs)*temcg(mgs)/felf(mgs)<a name='13884'>
      end do<a name='13885'>
<font color=#447700>!<a name='13886'></font>
<font color=#447700>!  Vapor Deposition constants<a name='13887'></font>
<font color=#447700>!<a name='13888'></font>
      do mgs = 1,ngscnt<a name='13889'>
      fvds(mgs) =    &amp;<a name='13890'>
     &amp;  (4.0*pi/rho0(mgs))*(ssi(mgs)-1.0)*   &amp;<a name='13891'>
     &amp;  (1.0/(fai(mgs)+fbi(mgs)))<a name='13892'>
      end do<a name='13893'>
      do mgs = 1,ngscnt<a name='13894'>
      fvce(mgs) =    &amp;<a name='13895'>
     &amp;  (4.0*pi/rho0(mgs))*(ssw(mgs)-1.0)*   &amp;<a name='13896'>
     &amp;  (1.0/(fav(mgs)+fbv(mgs)))<a name='13897'>
      end do<a name='13898'>
<a name='13899'>
<font color=#447700>!<a name='13900'></font>
<font color=#447700>!  deposition, sublimation, and melting of snow, graupel and hail<a name='13901'></font>
<font color=#447700>!<a name='13902'></font>
      qsmlr(:) = 0.0<a name='13903'>
      qimlr(:) = 0.0 <font color=#447700>! this is not used. qi melts to qc way down in the code.<a name='13904'></font>
      qhmlr(:) = 0.0<a name='13905'>
      qhlmlr(:) = 0.0<a name='13906'>
      qhmlrlg(:) = 0.0<a name='13907'>
      qhlmlrlg(:) = 0.0<a name='13908'>
      qhfzh(:) = 0.0<a name='13909'>
      qhlfzhl(:) = 0.0<a name='13910'>
      vhfzh(:) = 0.0<a name='13911'>
      vhlfzhl(:) = 0.0<a name='13912'>
      qsfzs(:) = 0.0<a name='13913'>
      zsmlr(:) = 0.0<a name='13914'>
      zhmlr(:) = 0.0<a name='13915'>
      zhmlrr(:) = 0.0<a name='13916'>
      zhshr(:) = 0.0<a name='13917'>
      zhlmlr(:) = 0.0<a name='13918'>
      zhlshr(:) = 0.0<a name='13919'>
<a name='13920'>
      zhshrr(:) = 0.0<a name='13921'>
      zhlmlrr(:) = 0.0<a name='13922'>
      zhlshrr(:) = 0.0<a name='13923'>
<a name='13924'>
      csmlr(:) = 0.0<a name='13925'>
      chmlr(:) = 0.0<a name='13926'>
      chmlrr(:) = 0.0<a name='13927'>
      chlmlr(:) = 0.0<a name='13928'>
      chlmlrr(:) = 0.0<a name='13929'>
<a name='13930'>
      if ( .not. mixedphase ) then <font color=#447700>!{<a name='13931'></font>
      do mgs = 1,ngscnt<a name='13932'>
<font color=#447700>!<a name='13933'></font>
      IF ( temg(mgs) .gt. tfr ) THEN<a name='13934'>
      <a name='13935'>
      IF (  qx(mgs,ls) .gt. qxmin(ls) ) THEN<a name='13936'>
      qsmlr(mgs) =   &amp;<a name='13937'>
     &amp;   min(   &amp;<a name='13938'>
     &amp;  (c1sw*fmlt1(mgs)*cx(mgs,ls)*swvent(mgs)*xdia(mgs,ls,1) ) &amp; <font color=#447700>! /rhosm    &amp;<a name='13939'></font>
     &amp;   , 0.0 )<a name='13940'>
      ENDIF<a name='13941'>
      <a name='13942'>
<font color=#447700>!       IF ( qx(mgs,ls) .gt. 0.1e-4 ) write(0,*) 'qsmlr: ',qsmlr(mgs),qx(mgs,ls),cx(mgs,ls),fmlt1(mgs),<a name='13943'></font>
<font color=#447700>!     :        temcg(mgs),swvent(mgs),xdia(mgs,ls,1),qss0(mgs)-qx(mgs,lv)<a name='13944'></font>
<font color=#447700>!      ELSE<a name='13945'></font>
<font color=#447700>!       qsmlr(mgs) = 0.0<a name='13946'></font>
<font color=#447700>!      ENDIF<a name='13947'></font>
<font color=#447700>! 10ice version:<a name='13948'></font>
<font color=#447700>!     &gt;   min(<a name='13949'></font>
<font color=#447700>!     &gt;  (fmlt1(mgs)*cx(mgs,ls)*swvent(mgs)*xdia(mgs,ls,1) +<a name='13950'></font>
<font color=#447700>!     &gt;   fmlt2(mgs)*(qsacr(mgs)+qsacw(mgs)) )<a name='13951'></font>
<font color=#447700>!     &lt;   , 0.0 )<a name='13952'></font>
<a name='13953'>
      IF (  qx(mgs,lh) .gt. qxmin(lh) ) THEN<a name='13954'>
<a name='13955'>
      IF ( ibinhmlr == 0 .or. lzh &lt; 1 ) THEN<a name='13956'>
       qhmlr(mgs) =   &amp;<a name='13957'>
     &amp;   min(   &amp;<a name='13958'>
     &amp;  fmlt1(mgs)*cx(mgs,lh)*hwvent(mgs)*xdia(mgs,lh,1)   &amp;<a name='13959'>
     &amp;  + fmlt2(mgs)*(qhacrmlr(mgs)+qhacw(mgs))    &amp;<a name='13960'>
     &amp;   , 0.0 )<a name='13961'>
       ELSEIF ( ibinhmlr == 1 ) THEN <font color=#447700>! use incomplete gamma functions to approximate the bin results<a name='13962'></font>
<a name='13963'>
         write(0,*) 'ibinhmlr = 1 not available for 2-moment'<a name='13964'>
         STOP<a name='13965'>
         <a name='13966'>
       ELSEIF ( ibinhmlr == 2 ) THEN<a name='13967'>
<a name='13968'>
       ENDIF<a name='13969'>
       <a name='13970'>
       <a name='13971'>
       IF ( ivhmltsoak &gt; 0 .and. qhmlr(mgs) &lt; 0.0 .and. lvol(lh) &gt; 1 .and. xdn(mgs,lh) .lt. xdnmx(lh) ) THEN<a name='13972'>
         <font color=#447700>! act as if 100% of the meltwater were soaked into the graupel<a name='13973'></font>
           v1 = (1. - xdn(mgs,lh)/xdnmx(lh))*(vx(mgs,lh) + rho0(mgs)*qhmlr(mgs)/xdn(mgs,lh) )/(dtp) <font color=#447700>! volume available for filling<a name='13974'></font>
           v2 = -1.0*rho0(mgs)*qhmlr(mgs)/xdnmx(lh)  <font color=#447700>! volume of melted ice if it were refrozen in the matrix<a name='13975'></font>
           <a name='13976'>
           vhsoak(mgs) = Min(v1,v2)<a name='13977'>
           <a name='13978'>
       ENDIF<a name='13979'>
<a name='13980'>
      ENDIF <font color=#447700>!  qx(mgs,lh) .gt. qxmin(lh)<a name='13981'></font>
<a name='13982'>
      <a name='13983'>
      IF ( lhl .gt. 1  .and. lhlw &lt; 1 ) THEN<a name='13984'>
<a name='13985'>
       IF ( qx(mgs,lhl) .gt. qxmin(lhl) ) THEN<a name='13986'>
         IF ( ibinhlmlr == 0  .or. lzhl &lt; 1) THEN<a name='13987'>
       qhlmlr(mgs) =   &amp;<a name='13988'>
     &amp;   min(   &amp;<a name='13989'>
     &amp;  fmlt1(mgs)*cx(mgs,lhl)*hlvent(mgs)*xdia(mgs,lhl,1)   &amp;<a name='13990'>
     &amp;  + fmlt2(mgs)*(qhlacrmlr(mgs)+qhlacw(mgs))    &amp;<a name='13991'>
     &amp;   , 0.0 )<a name='13992'>
<a name='13993'>
       ELSEIF ( ibinhlmlr == 1 ) THEN <font color=#447700>! use incomplete gamma functions to approximate the bin results<a name='13994'></font>
<a name='13995'>
<a name='13996'>
       ELSEIF ( ibinhlmlr == -1 ) THEN <font color=#447700>! OLD VERSION use incomplete gamma functions to approximate the bin results<a name='13997'></font>
<a name='13998'>
        ENDIF <font color=#447700>! ibinhlmlr<a name='13999'></font>
<a name='14000'>
<a name='14001'>
       IF ( ivhmltsoak &gt; 0 .and.  qhlmlr(mgs) &lt; 0.0 .and. lvol(lhl) &gt; 1 .and. xdn(mgs,lhl) .lt. xdnmx(lhl) ) THEN<a name='14002'>
         <font color=#447700>! act as if 50% of the meltwater were soaked into the graupel<a name='14003'></font>
           v1 = (1. - xdn(mgs,lhl)/xdnmx(lhl))*(vx(mgs,lhl) + rho0(mgs)*qhlmlr(mgs)/xdn(mgs,lhl) )/(dtp) <font color=#447700>! volume available for filling<a name='14004'></font>
           v2 = -1.0*rho0(mgs)*qhlmlr(mgs)/xdnmx(lhl)  <font color=#447700>! volume of melted ice if it were refrozen in the matrix<a name='14005'></font>
           <a name='14006'>
           vhlsoak(mgs) = Min(v1,v2)<a name='14007'>
           <a name='14008'>
       ENDIF<a name='14009'>
        <a name='14010'>
        ENDIF<a name='14011'>
       ENDIF<a name='14012'>
<a name='14013'>
      ENDIF<a name='14014'>
      <a name='14015'>
<font color=#447700>!<a name='14016'></font>
<font color=#447700>!      qimlr(mgs)  = max( qimlr(mgs), -qimxd(mgs) ) <a name='14017'></font>
<font color=#447700>!      qsmlr(mgs)  = max( qsmlr(mgs),  -qsmxd(mgs) ) <a name='14018'></font>
<font color=#447700>! erm 5/10/2007 changed to next line:<a name='14019'></font>
      if ( .not. mixedphase ) qsmlr(mgs)  = max( qsmlr(mgs),  Min( -qsmxd(mgs), -0.7*qx(mgs,ls)*dtpinv ) ) <a name='14020'>
      if ( .not. mixedphase ) qhmlr(mgs)  = max( qhmlr(mgs),  Min( -qhmxd(mgs), -0.5*qx(mgs,lh)*dtpinv ) ) <a name='14021'>
<font color=#447700>!      qhmlr(mgs)  = max( max( qhmlr(mgs),  -qhmxd(mgs) ) , -0.5*qx(mgs,lh)/dtp ) !limits to 1/2 qh or max depletion<a name='14022'></font>
      qhmlh(mgs)  = 0.<a name='14023'>
<a name='14024'>
<a name='14025'>
      <font color=#447700>! Rasmussen and Heymsfield say melt water remains on graupel up to 9 mm before shedding<a name='14026'></font>
<a name='14027'>
<a name='14028'>
      IF ( lhl .gt. 1 .and. lhlw &lt; 1 ) qhlmlr(mgs)  = max( qhlmlr(mgs),  Min( -qxmxd(mgs,lhl), -0.5*qx(mgs,lhl)/dtp ) )<a name='14029'>
<a name='14030'>
<font color=#447700>!<a name='14031'></font>
      end do<a name='14032'>
<a name='14033'>
      endif  <font color=#447700>! } not mixedphase<a name='14034'></font>
<font color=#447700>!<a name='14035'></font>
      if ( ipconc .ge. 1 ) then<a name='14036'>
      do mgs = 1,ngscnt<a name='14037'>
      cimlr(mgs)  = (cx(mgs,li)/(qx(mgs,li)+1.e-20))*qimlr(mgs)<a name='14038'>
      IF ( .not. mixedphase ) THEN <font color=#447700>!{<a name='14039'></font>
        IF ( xdia(mgs,ls,1) .gt. 1.e-6 .and. -qsmlr(mgs) .ge. 0.5*qxmin(ls) .and. ipconc .ge. 4 ) THEN <a name='14040'>
<font color=#447700>!         csmlr(mgs)  = rho0(mgs)*qsmlr(mgs)/(xv(mgs,ls)*rhosm)<a name='14041'></font>
         csmlr(mgs)  = (cx(mgs,ls)/(qx(mgs,ls)))*qsmlr(mgs)<a name='14042'>
        ELSEIF ( qx(mgs,ls) &gt; qxmin(ls) ) THEN<a name='14043'>
         csmlr(mgs)  = (cx(mgs,ls)/(qx(mgs,ls)))*qsmlr(mgs)<a name='14044'>
        ENDIF<a name='14045'>
<a name='14046'>
<a name='14047'>
<font color=#447700>!        IF ( xdia(mgs,lh,1) .gt. 1.e-6 .and. Abs(qhmlr(mgs)) .ge. qxmin(lh) ) THEN<a name='14048'></font>
<font color=#447700>!          chmlr(mgs) = rho0(mgs)*qhmlr(mgs)/(pi*xdn(mgs,lh)*xdia(mgs,lh,1)**3)  ! out of hail<a name='14049'></font>
<font color=#447700>!          chmlr(mgs) = Max( chmlr(mgs), -chmxd(mgs) )<a name='14050'></font>
<font color=#447700>!        ELSE<a name='14051'></font>
         IF ( ibinhmlr == 0 ) THEN<a name='14052'>
           chmlr(mgs)  = (cx(mgs,lh)/(qx(mgs,lh)+1.e-20))*qhmlr(mgs)<a name='14053'>
           IF ( imltshddmr == 3 .and. qhmlr(mgs) &lt; -qxmin(lh) ) THEN<a name='14054'>
            <font color=#447700>!  tmpdiam = (shedalp+alpha(mgs,lh))*xdia(mgs,lh,1)<a name='14055'></font>
            <font color=#447700>!  <a name='14056'></font>
            <font color=#447700>!  IF ( tmpdiam &gt; sheddiam ) THEN ! let size get smaller until it reaches sheddiam<a name='14057'></font>
            <font color=#447700>!   chmlr(mgs) = 0.0<a name='14058'></font>
            <font color=#447700>!  ENDIF<a name='14059'></font>
            <a name='14060'>
            <font color=#447700>! test to remove the part of the melting associated with large ice particles so they get smaller<a name='14061'></font>
<a name='14062'>
            tmp = 1. + alpha(mgs,lh)<a name='14063'>
            i = Int(dgami*(tmp))<a name='14064'>
            del = tmp - dgam*i<a name='14065'>
            g1palp = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='14066'>
<a name='14067'>
            ratio = Min( maxratiolu,  mltdiam1/xdia(mgs,lh,1) )<a name='14068'>
<a name='14069'>
            x =  <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINFDP'>gamxinfdp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINFDP_1">(2. + alpha(mgs,lh), ratio)/g1palp<a name='14070'>
            y =  <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINFDP'>gamxinfdp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINFDP_2">(2.5 + alpha(mgs,lh) + 0.5*bxh(mgs), ratio)/g1palp<a name='14071'>
<a name='14072'>
            hwvent1 =  0.78*x + y*hwventy(mgs) <a name='14073'>
<a name='14074'>
            qhlmlr1 = min( fmlt1(mgs)*cx(mgs,lh)*hwvent1*xdia(mgs,lh,1), 0.0 )<a name='14075'>
<a name='14076'>
            chmlr(mgs)  = (cx(mgs,lh)/(qx(mgs,lh)+1.e-20))*(qhmlr(mgs) - qhlmlr1)<a name='14077'>
           <a name='14078'>
           <a name='14079'>
           ENDIF<a name='14080'>
<font color=#447700>!           IF ( igs(mgs) == 40 ) THEN<a name='14081'></font>
<font color=#447700>!             write(0,*) 'is this running? chmlr = ',kgs(mgs), chmlr(mgs)<a name='14082'></font>
<font color=#447700>!           ENDIF<a name='14083'></font>
         ENDIF<a name='14084'>
<font color=#447700>!        ENDIF<a name='14085'></font>
<a name='14086'>
<a name='14087'>
<a name='14088'>
     IF ( chmlr(mgs) &lt; 0.0 .and. ibinhmlr &lt; 1) THEN <font color=#447700>! { already done if ibinhmlr &gt; 0<a name='14089'></font>
      <a name='14090'>
      IF ( ibinhmlr == 0 ) THEN<a name='14091'>
      IF ( ihmlt .eq. 1 ) THEN<a name='14092'>
        chmlrr(mgs)  = Min( chmlr(mgs), rho0(mgs)*qhmlr(mgs)/(xdn(mgs,lr)*vmlt) ) <font color=#447700>! into rain <a name='14093'></font>
      ELSEIF ( ihmlt .eq. 2 ) THEN<a name='14094'>
        IF ( xv(mgs,lh) .gt. 0.0 .and. chmlr(mgs) .lt. 0.0 ) THEN<a name='14095'>
<font color=#447700>!        chmlrr(mgs) = Min( chmlr(mgs), rho0(mgs)*qhmlr(mgs)/(xdn(mgs,lh)*xv(mgs,lh)) ) ! into rain <a name='14096'></font>
<font color=#447700>! guess what, this is the same as chmlr: rho0*qhmlr/xmas(lh) --&gt; cx/qx = rho0/xmas<a name='14097'></font>
          IF(imltshddmr == 1) THEN<a name='14098'>
            <font color=#447700>! DTD: If Dmg &lt; sheddiam, then assume complete melting into<a name='14099'></font>
            <font color=#447700>! maximal raindrop.  Between sheddiam and sheddiam0 mm, linearly ramp down to a 3 mm shed drop<a name='14100'></font>
            tmp = -rho0(mgs)*qhmlr(mgs)/(Min(xdn(mgs,lr)*xvmx(lr), xdn(mgs,lh)*xv(mgs,lh))) <font color=#447700>! Min of Maximum raindrop size/mean hail size<a name='14101'></font>
            tmp2 = -rho0(mgs)*qhmlr(mgs)/(xdn(mgs,lr)*vr3mm) <font color=#447700>! conc. change for a 3 mm mean drop diameter<a name='14102'></font>
            <a name='14103'>
            chmlrr(mgs) = tmp*(sheddiam0-xdia(mgs,lh,3))/(sheddiam0-sheddiam)+tmp2*(xdia(mgs,lh,3)-sheddiam)/(sheddiam0-sheddiam)  <font color=#447700>! old version<a name='14104'></font>
            chmlrr(mgs) = -Max(tmp,Min(tmp2,chmlrr(mgs)))<a name='14105'>
          ELSEIF ( imltshddmr == 2 .or. imltshddmr == 3 ) THEN<a name='14106'>
            <font color=#447700>! 8/26/2015 ERM updated to use shedalp and tmpdiam<a name='14107'></font>
            <font color=#447700>! tmpdiam = (shedalp+alpha(mgs,lh))*xdia(mgs,lh,1)<a name='14108'></font>
            chmlrr(mgs) =  rho0(mgs)*qhmlr(mgs)/(xdn(mgs,lr)*vshdgs(mgs,lh))  <font color=#447700>! into rain <a name='14109'></font>
          ELSE <font color=#447700>! Old method<a name='14110'></font>
            chmlrr(mgs) =  rho0(mgs)*qhmlr(mgs)/(Min(xdn(mgs,lr)*xvmx(lr), xdn(mgs,lh)*xv(mgs,lh)))  <font color=#447700>! into rain <a name='14111'></font>
          ENDIF<a name='14112'>
        ELSE<a name='14113'>
        chmlrr(mgs) = chmlr(mgs)<a name='14114'>
        ENDIF<a name='14115'>
      ELSEIF ( ihmlt .eq. 0 ) THEN<a name='14116'>
        chmlrr(mgs) = chmlr(mgs)<a name='14117'>
      ENDIF<a name='14118'>
<a name='14119'>
      ELSE <font color=#447700>! ibinhmlr &lt; 0? Already have an outer IF test for ibinhmlr &lt; 1<a name='14120'></font>
        chmlrr(mgs)  = Min( chmlrr(mgs), rho0(mgs)*qhmlr(mgs)/(xdn(mgs,lr)*xvmx(lr)) ) <font color=#447700>! into rain <a name='14121'></font>
      ENDIF<a name='14122'>
      <a name='14123'>
      ENDIF <font color=#447700>! } ( chmlr(mgs) &lt; 0.0 .and. ibinhmlr &lt; 1)<a name='14124'></font>
<a name='14125'>
      IF ( lhl .gt. 1 .and. lhlw &lt; 1 .and. .not. mixedphase .and. qhlmlr(mgs) &lt; 0.0 ) THEN <font color=#447700>! {<a name='14126'></font>
      <a name='14127'>
      IF ( ibinhlmlr == 0 ) THEN<a name='14128'>
<font color=#447700>!      IF ( xdia(mgs,lhl,1) .gt. 1.e-6 .and. Abs(qhlmlr(mgs)) .ge. qxmin(lhl) ) THEN<a name='14129'></font>
<font color=#447700>!      chlmlr(mgs) = rho0(mgs)*qhlmlr(mgs)/(pi*xdn(mgs,lhl)*xdia(mgs,lhl,1)**3)  ! out of hail<a name='14130'></font>
<font color=#447700>!      chlmlr(mgs) = Max( chlmlr(mgs), -cxmxd(mgs,lhl) )<a name='14131'></font>
<font color=#447700>!      ELSE<a name='14132'></font>
      chlmlr(mgs)  = (cx(mgs,lhl)/(qx(mgs,lhl)+1.e-20))*qhlmlr(mgs)<a name='14133'>
           IF ( imltshddmr == 3 .and. qhlmlr(mgs) &lt; -qxmin(lhl) ) THEN<a name='14134'>
<font color=#447700>!           IF ( .false. .and. imltshddmr == 3  ) THEN<a name='14135'></font>
<font color=#447700>!              tmpdiam = (shedalp+alpha(mgs,lhl))*xdia(mgs,lhl,1)<a name='14136'></font>
<font color=#447700>!              <a name='14137'></font>
<font color=#447700>!              IF ( tmpdiam &gt; sheddiam ) THEN ! let size get smaller until it reaches sheddiam<a name='14138'></font>
<font color=#447700>!                chlmlr(mgs) = 0.0<a name='14139'></font>
<font color=#447700>!              ENDIF<a name='14140'></font>
 <a name='14141'>
            <font color=#447700>! test to remove the part of the melting associated with large ice particles so they get smaller<a name='14142'></font>
<font color=#447700>!<a name='14143'></font>
            tmp = 1. + alpha(mgs,lhl)<a name='14144'>
            i = Int(dgami*(tmp))<a name='14145'>
            del = tmp - dgam*i<a name='14146'>
            g1palp = gmoi(i) + (gmoi(i+1) - gmoi(i))*del*dgami<a name='14147'>
<a name='14148'>
            ratio = Min( maxratiolu,  mltdiam1/xdia(mgs,lhl,1) )<a name='14149'>
<a name='14150'>
            x =  <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINFDP'>gamxinfdp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINFDP_3">(2. + alpha(mgs,lhl), ratio)/g1palp<a name='14151'>
            y =  <A href='../../html_code/phys/module_mp_nssl_2mom.F.html#GAMXINFDP'>gamxinfdp</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMXINFDP_4">(2.5 + alpha(mgs,lhl) + 0.5*bxhl(mgs), ratio)/g1palp<a name='14152'>
<a name='14153'>
            hwvent1 =  0.78*x + y*hlventy(mgs) <a name='14154'>
<a name='14155'>
            qhlmlr1 = min( fmlt1(mgs)*cx(mgs,lhl)*hwvent1*xdia(mgs,lhl,1), 0.0 )<a name='14156'>
<a name='14157'>
            chlmlr(mgs)  = (cx(mgs,lhl)/(qx(mgs,lhl)+1.e-20))*Min(0.0, qhlmlr(mgs) - qhlmlr1)<a name='14158'>
<a name='14159'>
            ENDIF<a name='14160'>
<font color=#447700>!      ENDIF<a name='14161'></font>
      ENDIF<a name='14162'>
      <a name='14163'>
      IF ( ibinhlmlr == 0 ) THEN <font color=#447700>!{<a name='14164'></font>
      IF ( ihmlt .eq. 1 ) THEN<a name='14165'>
        chlmlrr(mgs)  = Min( chlmlr(mgs), rho0(mgs)*qhlmlr(mgs)/(xdn(mgs,lr)*vmlt) ) <font color=#447700>! into rain <a name='14166'></font>
      ELSEIF ( ihmlt .eq. 2 ) THEN<a name='14167'>
        IF ( xv(mgs,lhl) .gt. 0.0 .and. chlmlr(mgs) .lt. 0.0 ) THEN<a name='14168'>
<font color=#447700>!        chlmlrr(mgs) = rho0(mgs)*qhlmlr(mgs)/(Min(xdn(mgs,lr)*xvmx(lr), xdn(mgs,lhl)*xv(mgs,lhl)))  ! into rain <a name='14169'></font>
<font color=#447700>!        chlmlrr(mgs) = Min( chlmlr(mgs), rho0(mgs)*qhlmlr(mgs)/(xdn(mgs,lhl)*xv(mgs,lhl)) ) ! into rain <a name='14170'></font>
          IF(imltshddmr == 1 ) THEN<a name='14171'>
            tmp = -rho0(mgs)*qhlmlr(mgs)/(Min(xdn(mgs,lr)*xvmx(lr), xdn(mgs,lhl)*xv(mgs,lhl))) <font color=#447700>! Min of Maximum raindrop size/mean hail size<a name='14172'></font>
            tmp2 = -rho0(mgs)*qhlmlr(mgs)/(xdn(mgs,lr)*vr3mm) <font color=#447700>! conc. change for a 3 mm mean drop diameter<a name='14173'></font>
            chlmlrr(mgs) = tmp*(20.e-3-xdia(mgs,lhl,3))/(20.e-3-sheddiam)+tmp2*(xdia(mgs,lhl,3)-sheddiam)/(20.e-3-sheddiam)<a name='14174'>
            chlmlrr(mgs) = -Max(tmp,Min(tmp2,chlmlrr(mgs)))<a name='14175'>
          ELSEIF ( imltshddmr == 2 .or. imltshddmr == 3 ) THEN<a name='14176'>
            <font color=#447700>! 8/26/2015 ERM updated to use shedalp and tmpdiam<a name='14177'></font>
            <font color=#447700>! tmpdiam = (shedalp+alpha(mgs,lh))*xdia(mgs,lh,1)<a name='14178'></font>
            chlmlrr(mgs) =  rho0(mgs)*qhlmlr(mgs)/(xdn(mgs,lr)*vshdgs(mgs,lhl))  <font color=#447700>! into rain <a name='14179'></font>
          ELSE<a name='14180'>
            chlmlrr(mgs) = rho0(mgs)*qhlmlr(mgs)/(Min(xdn(mgs,lr)*xvmx(lr), xdn(mgs,lhl)*xv(mgs,lhl)))  <font color=#447700>! into rain <a name='14181'></font>
          ENDIF<a name='14182'>
        ELSE<a name='14183'>
        chlmlrr(mgs) = chlmlr(mgs)<a name='14184'>
        ENDIF<a name='14185'>
      ELSEIF ( ihmlt .eq. 0 ) THEN<a name='14186'>
        chlmlrr(mgs) = chlmlr(mgs)<a name='14187'>
      ENDIF<a name='14188'>
<a name='14189'>
      ELSE <font color=#447700>! } { ibinhlmlr &gt; 0<a name='14190'></font>
        chlmlrr(mgs)  = Min( chlmlrr(mgs), rho0(mgs)*qhlmlr(mgs)/(xdn(mgs,lr)*xvmx(lr)) ) <font color=#447700>! into rain <a name='14191'></font>
      ENDIF <font color=#447700>!}<a name='14192'></font>
        <a name='14193'>
      ENDIF <font color=#447700>! }<a name='14194'></font>
<a name='14195'>
      ENDIF <font color=#447700>! }.not. mixedphase <a name='14196'></font>
<a name='14197'>
<font color=#447700>! 10ice versions:<a name='14198'></font>
<font color=#447700>!      chmlr(mgs)  = (cx(mgs,lh)/(qx(mgs,lh)+1.e-20))*qhmlr(mgs)<a name='14199'></font>
<font color=#447700>!      chmlrr(mgs) = chmlr(mgs)<a name='14200'></font>
      end do<a name='14201'>
      end if<a name='14202'>
<a name='14203'>
<font color=#447700>!<a name='14204'></font>
<font color=#447700>!  deposition/sublimation of ice<a name='14205'></font>
<font color=#447700>!<a name='14206'></font>
      DO mgs = 1,ngscnt<a name='14207'>
<a name='14208'>
      rwcap(mgs) = (0.5)*xdia(mgs,lr,1)<a name='14209'>
      swcap(mgs) = (0.5)*xdia(mgs,ls,1)<a name='14210'>
      hwcap(mgs) = (0.5)*xdia(mgs,lh,1)<a name='14211'>
      IF ( lhl .gt. 1 ) hlcap(mgs) = (0.5)*xdia(mgs,lhl,1)<a name='14212'>
<a name='14213'>
      if ( qx(mgs,li).gt.qxmin(li) .and. xdia(mgs,li,1) .gt. 0.0 ) then<a name='14214'>
<font color=#447700>!<a name='14215'></font>
<font color=#447700>! from Cotton, 1972 (Part II)<a name='14216'></font>
<font color=#447700>!<a name='14217'></font>
        cilen(mgs)   = 0.4764*(xdia(mgs,li,1))**(0.958)<a name='14218'>
        cval = xdia(mgs,li,1)<a name='14219'>
        aval = cilen(mgs)<a name='14220'>
        eval = Sqrt(1.0-(aval**2)/(cval**2))<a name='14221'>
        fval = min(0.99,eval)<a name='14222'>
        gval = alog( abs( (1.+fval)/(1.-fval) ) )<a name='14223'>
        cicap(mgs) = cval*fval / gval<a name='14224'>
      ELSE<a name='14225'>
       cicap(mgs) = 0.0<a name='14226'>
      end if<a name='14227'>
      ENDDO<a name='14228'>
<font color=#447700>!<a name='14229'></font>
<font color=#447700>!<a name='14230'></font>
      qhldsv(:) = 0.0<a name='14231'>
<a name='14232'>
      do mgs = 1,ngscnt<a name='14233'>
      IF ( icond .eq. 1 .or. temg(mgs) .le. tfrh    &amp;<a name='14234'>
     &amp;      .or. (qx(mgs,lr) .le. qxmin(lr) .and. qx(mgs,lc) .le. qxmin(lc)) ) THEN<a name='14235'>
        qidsv(mgs) =   &amp;<a name='14236'>
     &amp;    fvds(mgs)*cx(mgs,li)*civent(mgs)*cicap(mgs)<a name='14237'>
        qsdsv(mgs) =   &amp;<a name='14238'>
     &amp;    fvds(mgs)*cx(mgs,ls)*swvent(mgs)*swcap(mgs)<a name='14239'>
<font color=#447700>!        IF ( ny .eq. 2 .and. igs(mgs) .eq. 302 .and. temg(mgs) .le. tfrh+10 .and. qx(mgs,lv) .gt. qis(mgs)<a name='14240'></font>
<font color=#447700>!     :       .and. qx(mgs,li) .gt. qxmin(li) ) THEN<a name='14241'></font>
<font color=#447700>!         write(0,*) 'qidsv = ',nstep,kgs(mgs),qidsv(mgs),temg(mgs)-tfrh,100.*(qx(mgs,lv)/qis(mgs) - 1.),1.e6*xdia(mgs,li,1),<a name='14242'></font>
<font color=#447700>!     :            fvds(mgs),civent(mgs),cicap(mgs)<a name='14243'></font>
<font color=#447700>!        ENDIF<a name='14244'></font>
      ELSE<a name='14245'>
        qidsv(mgs) = 0.0<a name='14246'>
        qsdsv(mgs) = 0.0<a name='14247'>
      ENDIF<a name='14248'>
        qhdsv(mgs) =   &amp;<a name='14249'>
     &amp;    fvds(mgs)*cx(mgs,lh)*hwvent(mgs)*hwcap(mgs)*depfac<a name='14250'>
<a name='14251'>
        IF ( lhl .gt. 1 ) qhldsv(mgs) = fvds(mgs)*cx(mgs,lhl)*hlvent(mgs)*hlcap(mgs)*depfac<a name='14252'>
<font color=#447700>!<a name='14253'></font>
<font color=#447700>!<a name='14254'></font>
      end do<a name='14255'>
<font color=#447700>!<a name='14256'></font>
      do mgs = 1,ngscnt<a name='14257'>
      qisbv(mgs) = 0.0<a name='14258'>
      qssbv(mgs) = 0.0<a name='14259'>
      qidpv(mgs) = 0.0<a name='14260'>
      qsdpv(mgs) = 0.0<a name='14261'>
      IF ( icond .eq. 1 .or. temg(mgs) .le. tfrh    &amp;<a name='14262'>
     &amp;      .or. (qx(mgs,lr) .le. qxmin(lr) .and. qx(mgs,lc) .le. qxmin(lc)) ) THEN<a name='14263'>
<font color=#447700>!        qisbv(mgs) = max( min(qidsv(mgs), 0.0), -qimxd(mgs) )<a name='14264'></font>
<font color=#447700>!        qssbv(mgs) = max( min(qsdsv(mgs), 0.0), -qsmxd(mgs) )<a name='14265'></font>
<font color=#447700>! erm 5/10/2007:<a name='14266'></font>
        qisbv(mgs) = max( min(qidsv(mgs), 0.0),  Min( -qimxd(mgs), -0.7*qx(mgs,li)/dtp ) )<a name='14267'>
        qssbv(mgs) = max( min(qsdsv(mgs), 0.0),  Min( -qsmxd(mgs), -0.7*qx(mgs,ls)/dtp ) )<a name='14268'>
        qidpv(mgs) = Max(qidsv(mgs), 0.0)<a name='14269'>
        qsdpv(mgs) = Max(qsdsv(mgs), 0.0)<a name='14270'>
      ELSE<a name='14271'>
        qisbv(mgs) = 0.0<a name='14272'>
        qssbv(mgs) = 0.0<a name='14273'>
        qidpv(mgs) = 0.0<a name='14274'>
        qsdpv(mgs) = 0.0<a name='14275'>
      ENDIF<a name='14276'>
<a name='14277'>
      qhsbv(mgs) = max( min(qhdsv(mgs), 0.0), -qhmxd(mgs) )<a name='14278'>
<a name='14279'>
<a name='14280'>
      qhdpv(mgs) = Max(qhdsv(mgs), 0.0)<a name='14281'>
<a name='14282'>
      qhlsbv(mgs) = 0.0<a name='14283'>
      qhldpv(mgs) = 0.0<a name='14284'>
      IF ( lhl .gt. 1 ) THEN<a name='14285'>
        qhlsbv(mgs) = max( min(qhldsv(mgs), 0.0), -qxmxd(mgs,lhl) )<a name='14286'>
        qhldpv(mgs) = Max(qhldsv(mgs), 0.0)<a name='14287'>
      ENDIF<a name='14288'>
      <a name='14289'>
      temp1 = qidpv(mgs) + qsdpv(mgs) + qhdpv(mgs) + qhldpv(mgs)<a name='14290'>
<a name='14291'>
      IF ( temp1 .gt. qvimxd(mgs) ) THEN<a name='14292'>
<a name='14293'>
      frac = qvimxd(mgs)/temp1<a name='14294'>
<a name='14295'>
      qidpv(mgs) = frac*qidpv(mgs)<a name='14296'>
      qsdpv(mgs) = frac*qsdpv(mgs)<a name='14297'>
      qhdpv(mgs) = frac*qhdpv(mgs)<a name='14298'>
      qhldpv(mgs) = frac*qhldpv(mgs)<a name='14299'>
<a name='14300'>
<font color=#447700>!        IF ( ny .eq. 2 .and. igs(mgs) .eq. 302 .and. temg(mgs) .le. tfrh+10 .and. qx(mgs,lv) .gt. qis(mgs)<a name='14301'></font>
<font color=#447700>!     :       .and. qx(mgs,li) .gt. qxmin(li) ) THEN<a name='14302'></font>
<font color=#447700>!         write(0,*) 'qidpv,frac = ',kgs(mgs),qidpv(mgs),frac<a name='14303'></font>
<font color=#447700>!        ENDIF<a name='14304'></font>
<a name='14305'>
      ENDIF<a name='14306'>
<a name='14307'>
      end do<a name='14308'>
<font color=#447700>!<a name='14309'></font>
<font color=#447700>!<a name='14310'></font>
      if ( ipconc .ge. 1 ) then<a name='14311'>
      do mgs = 1,ngscnt<a name='14312'>
      cssbv(mgs)  = (cx(mgs,ls)/(qx(mgs,ls)+1.e-20))*qssbv(mgs)<a name='14313'>
      cisbv(mgs)  = (cx(mgs,li)/(qx(mgs,li)+1.e-20))*qisbv(mgs)<a name='14314'>
      chsbv(mgs)  = (cx(mgs,lh)/(qx(mgs,lh)+1.e-20))*qhsbv(mgs)<a name='14315'>
      IF ( lhl .gt. 1 ) chlsbv(mgs)  = (cx(mgs,lhl)/(qx(mgs,lhl)+1.e-20))*qhlsbv(mgs)<a name='14316'>
      csdpv(mgs)  = 0.0 <font color=#447700>! (cx(mgs,ls)/(qx(mgs,ls)+1.e-20))*qsdpv(mgs)<a name='14317'></font>
      cidpv(mgs) =  0.0 <font color=#447700>! (cx(mgs,li)/(qx(mgs,li)+1.e-20))*qidpv(mgs)<a name='14318'></font>
      cisdpv(mgs) = 0.0<a name='14319'>
      chdpv(mgs)  = 0.0 <font color=#447700>! (cx(mgs,lh)/(qx(mgs,lh)+1.e-20))*qhdpv(mgs)<a name='14320'></font>
      chldpv(mgs) = 0.0<a name='14321'>
      end do<a name='14322'>
      end if<a name='14323'>
<a name='14324'>
<font color=#447700>!<a name='14325'></font>
<font color=#447700>!  Aggregation or size conversion of small crystals to snow<a name='14326'></font>
<font color=#447700>!<a name='14327'></font>
      if (ndebug .gt. 0 ) write(0,*) 'conc 29a'<a name='14328'>
      do mgs = 1,ngscnt<a name='14329'>
      qscni(mgs) =  0.0<a name='14330'>
      cscni(mgs) = 0.0<a name='14331'>
      cscnis(mgs) = 0.0<a name='14332'>
      if ( ipconc .ge. 4 .and. iscni .ge. 1 .and. qx(mgs,li) .gt. qxmin(li) ) then<a name='14333'>
        IF ( iscni .eq. 1 ) THEN<a name='14334'>
         qscni(mgs) =    &amp;<a name='14335'>
     &amp;      pi*rho0(mgs)*((0.25)/(6.0))   &amp;<a name='14336'>
     &amp;      *eii(mgs)*(qx(mgs,li)**2)*(xdia(mgs,li,2))   &amp;<a name='14337'>
     &amp;      *vtxbar(mgs,li,1)/xmas(mgs,li)<a name='14338'>
         cscni(mgs) = Min(cimxd(mgs),qscni(mgs)*rho0(mgs)/xmas(mgs,li))<a name='14339'>
         cscnis(mgs) = 0.5*cscni(mgs)<a name='14340'>
        ELSEIF ( iscni .eq. 2 .or. iscni .eq. 4 .or. iscni .eq. 5 ) THEN  <font color=#447700>! Zeigler 1985/Zrnic 1993, sort of<a name='14341'></font>
          IF ( iscni .ne. 5 .and. qidpv(mgs) .gt. 0.0 .and.  xdia(mgs,li,3) .ge. 100.e-6 ) THEN<a name='14342'>
          <font color=#447700>! convert larger crystals to snow<a name='14343'></font>
<font color=#447700>!            IF ( xdia(mgs,ls,3) .gt. xdia(mgs,li,3) ) THEN<a name='14344'></font>
<font color=#447700>!              qscni(mgs) = Max(0.1,xdia(mgs,li,3)/xdia(mgs,ls,3))*qidpv(mgs)<a name='14345'></font>
<font color=#447700>! erm 9/5/08 changed max to min<a name='14346'></font>
              qscni(mgs) = Min(0.5, xdia(mgs,li,3)/200.e-6)*qidpv(mgs)<a name='14347'>
<font color=#447700>!            ELSE<a name='14348'></font>
<font color=#447700>!              qscni(mgs) = 0.1*qidpv(mgs)<a name='14349'></font>
<font color=#447700>!            ENDIF<a name='14350'></font>
            cscni(mgs) = fscni*qscni(mgs)*rho0(mgs)/Max(xdn(mgs,ls)*xvmn(ls),xmas(mgs,li))<a name='14351'>
<font color=#447700>!            cscni(mgs) = fscni*Min(cimxd(mgs),qscni(mgs)*rho0(mgs)/Max(xdn(mgs,ls)*xvmn(ls),xmas(mgs,li)))<a name='14352'></font>
<font color=#447700>!            cscni(mgs) = Min(cimxd(mgs),qscni(mgs)*rho0(mgs)/xmas(mgs,li) )<a name='14353'></font>
<font color=#447700>!            IF ( xdia(mgs,ls,3) .le. 200.e-6 ) THEN<a name='14354'></font>
              cscnis(mgs) = cscni(mgs)<a name='14355'>
<font color=#447700>!            ELSE<a name='14356'></font>
<font color=#447700>!              cscnis(mgs) = 0.0<a name='14357'></font>
<font color=#447700>!            ENDIF<a name='14358'></font>
          ENDIF<a name='14359'>
<a name='14360'>
           IF ( iscni .ne. 4 ) THEN<a name='14361'>
           <font color=#447700>! crystal aggregation to become snow<a name='14362'></font>
<font color=#447700>! erm 9/5/08 commented second line and added xv to 1st line (zrnic et al 1993)<a name='14363'></font>
             tmp = ess(mgs)*rvt*aa2*cx(mgs,li)*cx(mgs,li)*xv(mgs,li)<a name='14364'>
<font color=#447700>!     :         ((cinu + 2.)*xv(mgs,li)/(cinu + 1.) + xv(mgs,li))<a name='14365'></font>
<a name='14366'>
<font color=#447700>!           csacs(mgs) = rvt*aa2*ess(mgs)*cx(mgs,ls)**2*xv(mgs,ls)<a name='14367'></font>
<a name='14368'>
             qscni(mgs) = qscni(mgs) + Min( qxmxd(mgs,li), 2.0*tmp*xmas(mgs,li)*rhoinv(mgs) )<a name='14369'>
             cscni(mgs) = cscni(mgs) + Min( cxmxd(mgs,li), 2.0*tmp )<a name='14370'>
             cscnis(mgs) = cscnis(mgs) + Min( cxmxd(mgs,li), tmp )<a name='14371'>
           ENDIF<a name='14372'>
        ELSEIF ( iscni .eq. 3 ) THEN <font color=#447700>! LFO<a name='14373'></font>
           qscni(mgs) = 0.001*eii(mgs)*max((qx(mgs,li)-1.e-3),0.0)<a name='14374'>
           qscni(mgs) = min(qscni(mgs),qxmxd(mgs,li))<a name='14375'>
           cscni(mgs) = qscni(mgs)*rho0(mgs)/xmas(mgs,li)<a name='14376'>
           cscnis(mgs) = 0.5*cscni(mgs)<a name='14377'>
<font color=#447700>!           write(iunit,*) 'qscni, qi = ',qscni(mgs),qx(mgs,li),igs(mgs),kgs(mgs)<a name='14378'></font>
        ENDIF<a name='14379'>
<a name='14380'>
      ELSEIF ( ipconc &lt; 4 ) THEN <font color=#447700>! LFO<a name='14381'></font>
           IF ( lwsm6 ) THEN<a name='14382'>
             qimax = rhoinv(mgs)*roqimax<a name='14383'>
             qscni(mgs) = Min(0.90*qx(mgs,li), Max( 0.0, (qx(mgs,li) - qimax)*dtpinv ) )<a name='14384'>
           ELSE<a name='14385'>
             qscni(mgs) = 0.001*eii(mgs)*max((qx(mgs,li)-1.e-3),0.0)<a name='14386'>
             qscni(mgs) = min(qscni(mgs),qxmxd(mgs,li))<a name='14387'>
           ENDIF<a name='14388'>
      else <font color=#447700>! 10-ice version<a name='14389'></font>
      if ( iscni &gt; 0 .and. qx(mgs,li) .gt. qxmin(li) ) then<a name='14390'>
          qscni(mgs) =    &amp;<a name='14391'>
     &amp;    pi*rho0(mgs)*((0.25)/(6.0))   &amp;<a name='14392'>
     &amp;    *eii(mgs)*(qx(mgs,li)**2)*(xdia(mgs,li,2))   &amp;<a name='14393'>
     &amp;    *vtxbar(mgs,li,1)/xmas(mgs,li)<a name='14394'>
         cscni(mgs) = Min(cimxd(mgs),qscni(mgs)*rho0(mgs)/xmas(mgs,li))<a name='14395'>
        end if<a name='14396'>
<a name='14397'>
      end if<a name='14398'>
      end do<a name='14399'>
<a name='14400'>
<font color=#447700>!<a name='14401'></font>
<font color=#447700>!<a name='14402'></font>
<font color=#447700>!  compute dry growth rate of snow, graupel, and hail<a name='14403'></font>
<font color=#447700>!<a name='14404'></font>
      do mgs = 1,ngscnt<a name='14405'>
<font color=#447700>!<a name='14406'></font>
      qsdry(mgs)  = qsacr(mgs)    + qsacw(mgs)   &amp;<a name='14407'>
     &amp;            + qsaci(mgs)<a name='14408'>
<font color=#447700>!<a name='14409'></font>
      qhdry(mgs)  = qhaci(mgs)    + qhacs(mgs)   &amp;<a name='14410'>
     &amp;            + qhacr(mgs)   &amp;<a name='14411'>
     &amp;            + qhacw(mgs)<a name='14412'>
<font color=#447700>!<a name='14413'></font>
      qhldry(mgs) = 0.0<a name='14414'>
      IF ( lhl .gt. 1 ) THEN<a name='14415'>
      qhldry(mgs)  = qhlaci(mgs)    + qhlacs(mgs)   &amp;<a name='14416'>
     &amp;               + qhlacr(mgs)   &amp;<a name='14417'>
     &amp;               + qhlacw(mgs)<a name='14418'>
      ENDIF<a name='14419'>
      end do<a name='14420'>
<font color=#447700>!<a name='14421'></font>
<font color=#447700>!  set wet growth and shedding<a name='14422'></font>
<font color=#447700>!<a name='14423'></font>
      do mgs = 1,ngscnt<a name='14424'>
      <a name='14425'>
      IF ( temg(mgs) &lt; tfr ) THEN<a name='14426'>
<font color=#447700>!<a name='14427'></font>
<font color=#447700>!      qswet(mgs) =<a name='14428'></font>
<font color=#447700>!     &gt;  ( xdia(mgs,ls,1)*swvent(mgs)*cx(mgs,ls)*fwet1(mgs)<a name='14429'></font>
<font color=#447700>!     &gt;  + fwet2(mgs)*(qsaci(mgs)+qsacir(mgs)<a name='14430'></font>
<font color=#447700>!     &gt;               +qsacip(mgs)) )<a name='14431'></font>
<font color=#447700>!      qswet(mgs) = max( 0.0, qswet(mgs))<a name='14432'></font>
<font color=#447700>!<a name='14433'></font>
<font color=#447700>!      IF ( dnu(lh) .ne. 0. ) THEN<a name='14434'></font>
<font color=#447700>!        qhwet(mgs) = qhdry(mgs)<a name='14435'></font>
<font color=#447700>!      ELSE<a name='14436'></font>
        qhwet(mgs) =   &amp;<a name='14437'>
     &amp;    ( xdia(mgs,lh,1)*hwvent(mgs)*cx(mgs,lh)*fwet1(mgs)   &amp;<a name='14438'>
     &amp;   + fwet2(mgs)*(qhaci(mgs) + qhacs(mgs)) )<a name='14439'>
       qhwet(mgs) = max( 0.0, qhwet(mgs))<a name='14440'>
<font color=#447700>!      ENDIF<a name='14441'></font>
<a name='14442'>
       qhlwet(mgs) = 0.0<a name='14443'>
       IF ( lhl .gt. 1 ) THEN<a name='14444'>
       qhlwet(mgs) =   &amp;<a name='14445'>
     &amp;    ( xdia(mgs,lhl,1)*hlvent(mgs)*cx(mgs,lhl)*fwet1(mgs)   &amp;<a name='14446'>
     &amp;   + fwet2(mgs)*(qhlaci(mgs) + qhlacs(mgs)) )<a name='14447'>
       qhlwet(mgs) = max( 0.0, qhlwet(mgs))<a name='14448'>
       ENDIF<a name='14449'>
       <a name='14450'>
       ELSE<a name='14451'>
       <a name='14452'>
        qhwet(mgs) = qhdry(mgs)<a name='14453'>
        qhlwet(mgs) = qhldry(mgs)<a name='14454'>
        <a name='14455'>
       ENDIF<a name='14456'>
<font color=#447700>!<a name='14457'></font>
<font color=#447700>!      qhlwet(mgs) = qhldry(mgs)<a name='14458'></font>
<a name='14459'>
      end do<a name='14460'>
<font color=#447700>!<a name='14461'></font>
<font color=#447700>! shedding rate<a name='14462'></font>
<font color=#447700>!<a name='14463'></font>
      qsshr(:)  =  0.0<a name='14464'>
      qhshr(:)  =  0.0<a name='14465'>
      qhlshr(:) =  0.0<a name='14466'>
      qhshh(:)  =  0.0<a name='14467'>
      csshr(:)  =  0.0<a name='14468'>
      chshr(:)  =  0.0<a name='14469'>
      chlshr(:)  =  0.0<a name='14470'>
      chshrr(:)  =  0.0<a name='14471'>
      chlshrr(:)  =  0.0<a name='14472'>
      vhshdr(:)  = 0.0<a name='14473'>
      vhlshdr(:)  = 0.0<a name='14474'>
      wetsfc(:)  = .false.<a name='14475'>
      wetgrowth(:)  = .false.<a name='14476'>
      wetsfchl(:)  = .false.<a name='14477'>
      wetgrowthhl(:)  = .false.<a name='14478'>
<a name='14479'>
<a name='14480'>
      do mgs = 1,ngscnt<a name='14481'>
<font color=#447700>!<a name='14482'></font>
<font color=#447700>!<a name='14483'></font>
<font color=#447700>!<a name='14484'></font>
      qhshr(mgs)  = Min( 0.0, qhwet(mgs) - qhdry(mgs) )  <font color=#447700>! water that freezes should never be more than what sheds<a name='14485'></font>
      <a name='14486'>
<a name='14487'>
<a name='14488'>
      qhlshr(mgs)  =  Min( 0.0, qhlwet(mgs) - qhldry(mgs) )<a name='14489'>
<a name='14490'>
<font color=#447700>!<a name='14491'></font>
<font color=#447700>! limit wet growth to only higher density particles<a name='14492'></font>
<font color=#447700>!<a name='14493'></font>
      qsshr(mgs)  =  0.0<a name='14494'>
<font color=#447700>!<a name='14495'></font>
<font color=#447700>!<a name='14496'></font>
<font color=#447700>!  no shedding for temperatures &lt; 243.15 <a name='14497'></font>
<font color=#447700>!<a name='14498'></font>
      if ( temg(mgs) .lt. 243.15 ) then<a name='14499'>
       qsshr(mgs)  =  0.0<a name='14500'>
       qhshr(mgs)  =  0.0<a name='14501'>
       qhlshr(mgs) =  0.0<a name='14502'>
       vhshdr(mgs)  = 0.0<a name='14503'>
       vhlshdr(mgs)  = 0.0<a name='14504'>
       wetsfc(mgs) = .false.<a name='14505'>
       wetgrowth(mgs) = .false.<a name='14506'>
       wetsfchl(mgs) = .false.<a name='14507'>
       wetgrowthhl(mgs) = .false.<a name='14508'>
      end if<a name='14509'>
<font color=#447700>!<a name='14510'></font>
<font color=#447700>!  shed all at temperatures &gt; 273.15<a name='14511'></font>
<font color=#447700>!<a name='14512'></font>
      if ( temg(mgs) .gt. tfr ) then<a name='14513'>
<a name='14514'>
       qsshr(mgs)   = -qsdry(mgs)<a name='14515'>
       qhlshr(mgs)  = -qhldry(mgs)<a name='14516'>
<a name='14517'>
       qhshr(mgs)  = -qhdry(mgs)<a name='14518'>
       vhshdr(mgs)  = -vhacw(mgs) - vhacr(mgs)<a name='14519'>
       vhlshdr(mgs)  = -vhlacw(mgs)<a name='14520'>
       qhwet(mgs)  = 0.0<a name='14521'>
       qhlwet(mgs) = 0.0<a name='14522'>
      end if<a name='14523'>
<font color=#447700>!<a name='14524'></font>
<font color=#447700>!      if (qhshr(mgs) .lt. 0.0 .and. temg(mgs) &lt; tfr  ) THEN<a name='14525'></font>
        wetsfc(mgs) =  (qhshr(mgs) .lt. 0.0 .and. temg(mgs) &lt; tfr ) .or. ( qhmlr(mgs) &lt; -qxmin(lh) .and.  temg(mgs) &gt; tfr )<a name='14526'>
        wetgrowth(mgs) = (qhshr(mgs) .lt. 0.0 .and. temg(mgs) &lt; tfr )<a name='14527'>
<font color=#447700>!      ENDIF<a name='14528'></font>
<a name='14529'>
      if (qhlshr(mgs) .lt. 0.0 .and. temg(mgs) &lt; tfr ) THEN<a name='14530'>
        wetsfchl(mgs) = (qhlshr(mgs) .lt. 0.0 .and. temg(mgs) &lt; tfr ) .or. ( qhlmlr(mgs) &lt; -qxmin(lhl) .and.  temg(mgs) &gt; tfr )<a name='14531'>
        wetgrowthhl(mgs) = (qhlshr(mgs) .lt. 0.0 .and. temg(mgs) &lt; tfr )<a name='14532'>
      ENDIF<a name='14533'>
<a name='14534'>
      end do<a name='14535'>
<font color=#447700>!<a name='14536'></font>
      if ( ipconc .ge. 1 ) then<a name='14537'>
      do mgs = 1,ngscnt<a name='14538'>
      csshr(mgs)  = 0.0 <font color=#447700>! (cx(mgs,ls)/(qx(mgs,ls)+1.e-20))*Min(0.0,qsshr(mgs))<a name='14539'></font>
      <font color=#447700>! why is there a number loss for graupel for shedding? NEED TO CHECK THIS<a name='14540'></font>
       <font color=#447700>! chshr(mgs)  = (cx(mgs,lh)/(qx(mgs,lh)+1.e-20))*qhshr(mgs)<a name='14541'></font>
       <font color=#447700>! IF ( temg(mgs) &lt; tfr ) chshr(mgs) = 0.0 ! no change to graupel number concentration for wet-growth shedding<a name='14542'></font>
       <a name='14543'>
       chshr(mgs) = 0.0 <font color=#447700>! no change to graupel number concentration for wet-growth shedding<a name='14544'></font>
       <a name='14545'>
      <font color=#447700>!   tmpdiam = (shedalp+alpha(mgs,lh))*xdia(mgs,lh,1)<a name='14546'></font>
        <font color=#447700>! Base the drop size on the shedding regime<a name='14547'></font>
            <font color=#447700>! 8/26/2015 ERM updated to use shedalp and tmpdiam<a name='14548'></font>
            <font color=#447700>! tmpdiam = (shedalp+alpha(mgs,lh))*xdia(mgs,lh,1)<a name='14549'></font>
            chshrr(mgs) =  rho0(mgs)*qhshr(mgs)/(xdn(mgs,lr)*vshdgs(mgs,lh))  <font color=#447700>! into rain <a name='14550'></font>
      <a name='14551'>
      IF ( .false. ) THEN<a name='14552'>
      IF ( temg(mgs) &lt; tfr ) THEN<a name='14553'>
         chshrr(mgs) = Min( chshr(mgs), rho0(mgs)*qhshr(mgs)/(xdn0(lr)*vshd) ) <font color=#447700>! maximum of dshd from shedding<a name='14554'></font>
      ELSE<a name='14555'>
        IF(imltshddmr &gt; 0) THEN<a name='14556'>
          <font color=#447700>! DTD: If Dmg &lt; sheddiam, then assume complete melting into<a name='14557'></font>
          <font color=#447700>! maximal raindrop.  Between sheddiam and sheddiam0, linearly ramp down to a 3 mm shed drop<a name='14558'></font>
          tmp = -Min( chshr(mgs), rho0(mgs)*qhshr(mgs)/(xdn(mgs,lr)*xvmx(lr)) ) <font color=#447700>! limit to maximum size allowed for rain<a name='14559'></font>
          tmp2 = -rho0(mgs)*qhshr(mgs)/(xdn(mgs,lr)*vr3mm) <font color=#447700>! conc. change for a 3 mm mean drop diameter<a name='14560'></font>
          chshrr(mgs) = tmp*(sheddiam0-xdia(mgs,lh,3))/(sheddiam0-sheddiam)+tmp2*(xdia(mgs,lh,3)-sheddiam)/(sheddiam0-sheddiam)<a name='14561'>
          chshrr(mgs) = -Max(tmp,Min(tmp2,chshrr(mgs)))<a name='14562'>
        ELSE<a name='14563'>
         chshrr(mgs) = Min( chshr(mgs), rho0(mgs)*qhshr(mgs)/(xdn(mgs,lr)*Min(vr4p5mm,xvmx(lr))) ) <font color=#447700>! limit to maximum size allowed for rain or 4.5mm diameter, whichever is smaller<a name='14564'></font>
<font color=#447700>!        chlmlrr(mgs) = rho0(mgs)*qhlmlr(mgs)/(Min(xdn(mgs,lr)*xvmx(lr), xdn(mgs,lhl)*xv(mgs,lhl)))  ! into rain <a name='14565'></font>
        ENDIF<a name='14566'>
      ENDIF<a name='14567'>
      ENDIF<a name='14568'>
      <a name='14569'>
      <a name='14570'>
      chlshr(mgs) = 0.0<a name='14571'>
      chlshrr(mgs) = 0.0<a name='14572'>
      IF ( lhl .gt. 1 ) THEN <a name='14573'>
<font color=#447700>!         chlshr(mgs)  = (cx(mgs,lhl)/(qx(mgs,lhl)+1.e-20))*qhlshr(mgs)<a name='14574'></font>
<a name='14575'>
<a name='14576'>
       chlshr(mgs) = 0.0 <font color=#447700>! no change to hail number concentration for wet-growth shedding<a name='14577'></font>
       <a name='14578'>
      <font color=#447700>!   tmpdiam = (shedalp+alpha(mgs,lh))*xdia(mgs,lh,1)<a name='14579'></font>
        <font color=#447700>! Base the drop size on the shedding regime<a name='14580'></font>
            <font color=#447700>! 8/26/2015 ERM updated to use shedalp and tmpdiam<a name='14581'></font>
            <font color=#447700>! tmpdiam = (shedalp+alpha(mgs,lh))*xdia(mgs,lh,1)<a name='14582'></font>
            chlshrr(mgs) =  rho0(mgs)*qhlshr(mgs)/(xdn(mgs,lr)*vshdgs(mgs,lhl))  <font color=#447700>! into rain <a name='14583'></font>
<a name='14584'>
<a name='14585'>
      IF ( .false. ) THEN<a name='14586'>
        IF ( temg(mgs) &lt; tfr ) THEN<a name='14587'>
          chlshrr(mgs) = Min( chlshr(mgs), rho0(mgs)*qhlshr(mgs)/(xdn0(lr)*vshd) ) <font color=#447700>! maximum of dshd from shedding<a name='14588'></font>
<font color=#447700>!         chlshrr(mgs) = Min( chlshr(mgs), rho0(mgs)*qhlshr(mgs)/(xdn0(lr)*vr1mm) ) ! maximum of 1mm drops from shedding<a name='14589'></font>
        ELSE<a name='14590'>
          IF(imltshddmr &gt; 0) THEN<a name='14591'>
            <font color=#447700>! DTD: If Dmg &lt; sheddiam, then assume complete melting into<a name='14592'></font>
            <font color=#447700>! maximal raindrop.  Between sheddiam and sheddiam0, linearly ramp down to a 3 mm shed drop<a name='14593'></font>
            tmp = -Min( chlshr(mgs), rho0(mgs)*qhlshr(mgs)/(xdn(mgs,lr)*xvmx(lr)) ) <font color=#447700>! limit to maximum size allowed for rain<a name='14594'></font>
            tmp2 = -rho0(mgs)*qhlshr(mgs)/(xdn(mgs,lr)*vr3mm) <font color=#447700>! conc. change for a 3 mm mean drop diameter<a name='14595'></font>
            chlshrr(mgs) = tmp*(sheddiam0-xdia(mgs,lhl,3))/(sheddiam0-sheddiam)+tmp2*(xdia(mgs,lhl,3)-sheddiam)/(sheddiam0-sheddiam)<a name='14596'>
            chlshrr(mgs) = -Max(tmp,Min(tmp2,chlshrr(mgs)))<a name='14597'>
          ELSE<a name='14598'>
           chlshrr(mgs) = Min( chlshr(mgs), rho0(mgs)*qhlshr(mgs)/(xdn(mgs,lr)*Min(vr4p5mm,xvmx(lr))) ) <font color=#447700>! limit to 4.5mm diameter or maximum size allowed for rain, whichever is smaller<a name='14599'></font>
<font color=#447700>!        chlmlrr(mgs) = rho0(mgs)*qhlmlr(mgs)/(Min(xdn(mgs,lr)*xvmx(lr), xdn(mgs,lhl)*xv(mgs,lhl)))  ! into rain <a name='14600'></font>
          ENDIF<a name='14601'>
        ENDIF<a name='14602'>
      ENDIF<a name='14603'>
<a name='14604'>
      ENDIF <font color=#447700>! ( lhl &gt; 1 )<a name='14605'></font>
      <a name='14606'>
      end do<a name='14607'>
      end if<a name='14608'>
<a name='14609'>
<a name='14610'>
<a name='14611'>
<font color=#447700>!<a name='14612'></font>
<font color=#447700>!  final decisions<a name='14613'></font>
<font color=#447700>!<a name='14614'></font>
      do mgs = 1,ngscnt<a name='14615'>
<font color=#447700>!<a name='14616'></font>
<font color=#447700>!  Snow<a name='14617'></font>
<font color=#447700>!<a name='14618'></font>
      if ( qsshr(mgs) .lt. 0.0 ) then<a name='14619'>
      qsdpv(mgs) = 0.0<a name='14620'>
      qssbv(mgs) = 0.0<a name='14621'>
      else<a name='14622'>
      qsshr(mgs) = 0.0<a name='14623'>
      end if<a name='14624'>
<font color=#447700>!<a name='14625'></font>
<font color=#447700>!     if ( qsdry(mgs) .lt. qswet(mgs) ) then<a name='14626'></font>
<font color=#447700>!     qswet(mgs) = 0.0<a name='14627'></font>
<font color=#447700>!     else<a name='14628'></font>
<font color=#447700>!     qsdry(mgs) = 0.0<a name='14629'></font>
<font color=#447700>!     end if<a name='14630'></font>
<font color=#447700>!<a name='14631'></font>
<a name='14632'>
<font color=#447700>! zero the shedding rates when wet snow/graupel included.<a name='14633'></font>
<font color=#447700>! shedding of wet snow/graupel is calculated after summing other sources/sinks.<a name='14634'></font>
      if (mixedphase) then<a name='14635'>
        qsshr(mgs) = 0.0<a name='14636'>
        qhshr(mgs) = 0.0<a name='14637'>
        csshr(mgs) = 0.0<a name='14638'>
        chshr(mgs) = 0.0<a name='14639'>
        chshrr(mgs) = 0.0<a name='14640'>
        vhshdr(mgs) = 0.0<a name='14641'>
        IF ( lhlw &gt; 1 ) THEN<a name='14642'>
          qhlshr(mgs) = 0.0<a name='14643'>
          vhlshdr(mgs) = 0.0<a name='14644'>
          chlshr(mgs) = 0.0<a name='14645'>
          chlshrr(mgs) = 0.0<a name='14646'>
        ENDIF<a name='14647'>
      end if<a name='14648'>
<a name='14649'>
<font color=#447700>!  graupel<a name='14650'></font>
<font color=#447700>!<a name='14651'></font>
<font color=#447700>!<a name='14652'></font>
      if ( wetgrowth(mgs) .or. (mixedphase .and. fhw(mgs) .gt. 0.05 .and. temg(mgs) .gt. 243.15) ) then<a name='14653'>
      <a name='14654'>
<a name='14655'>
<font color=#447700>! soaking (when not advected liquid water film with graupel)<a name='14656'></font>
<a name='14657'>
        IF ( lvol(lh) .gt. 1 .and. .not. mixedphase) THEN<a name='14658'>
        <font color=#447700>! rescale volumes to maximum density<a name='14659'></font>
         rimdn(mgs,lh) = xdnmx(lh)<a name='14660'>
         raindn(mgs,lh) = xdnmx(lh)<a name='14661'>
         vhacw(mgs) = qhacw(mgs)*rho0(mgs)/rimdn(mgs,lh)<a name='14662'>
         vhacr(mgs) = qhacr(mgs)*rho0(mgs)/raindn(mgs,lh)<a name='14663'>
<font color=#447700>!        IF ( lvol(lh) .gt. 1 .and. wetgrowth(mgs) ) THEN<a name='14664'></font>
         IF ( xdn(mgs,lh) .lt. xdnmx(lh) ) THEN<a name='14665'>
         <font color=#447700>! soak some liquid into the graupel<a name='14666'></font>
<font color=#447700>!           v1 = xdnmx(lh)*vx(mgs,lh)/(xdn(mgs,lh)*dtp) ! volume available for filling<a name='14667'></font>
           v1 = (1. - xdn(mgs,lh)/xdnmx(lh))*vx(mgs,lh)/(dtp) <font color=#447700>! volume available for filling<a name='14668'></font>
<font color=#447700>!            tmp = (vx(mgs,lh)/rho0(mgs))*(xdnmx(lh) - xdn(mgs,lh)) ! max mixing ratio of liquid water that can be added<a name='14669'></font>
           v2 = rho0(mgs)*qhwet(mgs)/xdnmx(lh)  <font color=#447700>! volume of frozen accretion<a name='14670'></font>
           <a name='14671'>
           vhsoak(mgs) = Min(v1,v2)<a name='14672'>
           <a name='14673'>
         ENDIF<a name='14674'>
<a name='14675'>
         vhshdr(mgs) = Min(0.0, rho0(mgs)*qhwet(mgs)/xdnmx(lh) - vhacw(mgs) - vhacr(mgs) )<a name='14676'>
         <a name='14677'>
        ELSEIF ( lvol(lh) .gt. 1  .and. mixedphase ) THEN<a name='14678'>
<font color=#447700>!         vhacw(mgs) = rho0(mgs)*qhacw(mgs)/xdn0(lr)<a name='14679'></font>
<font color=#447700>!         vhacr(mgs) = rho0(mgs)*qhacr(mgs)/xdn0(lr)<a name='14680'></font>
        ENDIF<a name='14681'>
        <a name='14682'>
<a name='14683'>
      qhdpv(mgs) = 0.0<a name='14684'>
<font color=#447700>!      qhsbv(mgs) = 0.0<a name='14685'></font>
      chdpv(mgs) = 0.0<a name='14686'>
<font color=#447700>!      chsbv(mgs) = 0.0<a name='14687'></font>
<a name='14688'>
<font color=#447700>! collection efficiency modification<a name='14689'></font>
<a name='14690'>
      IF ( ehi(mgs) .gt. 0.0 ) THEN<a name='14691'>
        qhaci(mgs) = Min(qimxd(mgs),qhaci0(mgs))  <font color=#447700>! effectively sets collection eff to 1<a name='14692'></font>
        chaci(mgs) = Min(cimxd(mgs),chaci0(mgs))  <font color=#447700>! effectively sets collection eff to 1<a name='14693'></font>
      ENDIF<a name='14694'>
      IF ( ehs(mgs) .gt. 0.0 ) THEN<a name='14695'>
<font color=#447700>!        qhacs(mgs) = Min(qsmxd(mgs),qhacs(mgs)/ehs(mgs))  ! effectively sets collection eff to 1<a name='14696'></font>
        qhacs(mgs) = Min(qsmxd(mgs),qhacs0(mgs)) <font color=#447700>!/ehs(mgs)                   ! divide out the collection efficiency<a name='14697'></font>
        chacs(mgs) = Min(csmxd(mgs),chacs0(mgs)) <font color=#447700>!/ehs(mgs)                   ! divide out the collection efficiency<a name='14698'></font>
        ehs(mgs) = ehsmax <font color=#447700>! 1.0 ! min(ehsfrac*ehs(mgs),ehsmax)            ! modify it<a name='14699'></font>
        qhacs(mgs) = Min(qsmxd(mgs),qhacs(mgs))   <font color=#447700>! plug it back in<a name='14700'></font>
      ENDIF<a name='14701'>
<a name='14702'>
<font color=#447700>! be sure to catch particles with wet surfaces but not in wet growth to turn off Hallett-Mossop<a name='14703'></font>
      wetsfc(mgs) = .true.<a name='14704'>
<a name='14705'>
      else<a name='14706'>
<font color=#447700>!        qhshr(mgs) = 0.0<a name='14707'></font>
      end if<a name='14708'>
<font color=#447700>!<a name='14709'></font>
<font color=#447700>!<a name='14710'></font>
<font color=#447700>!  hail<a name='14711'></font>
<font color=#447700>!<a name='14712'></font>
<font color=#447700>!      if ( lhl .gt. 1 .and. qhlshr(mgs) .lt. 0.0 ) then<a name='14713'></font>
      if ( lhl &gt; 1 .and. ( wetgrowthhl(mgs) .or. (mixedphase .and. fhlw(mgs) .gt. 0.05 .and. temg(mgs) .gt. 243.15) ) ) then<a name='14714'>
<font color=#447700>!      if ( wetgrowthhl(mgs) ) then<a name='14715'></font>
       <a name='14716'>
<a name='14717'>
      qhldpv(mgs) = 0.0<a name='14718'>
<font color=#447700>!      qhlsbv(mgs) = 0.0<a name='14719'></font>
      chldpv(mgs) = 0.0<a name='14720'>
<font color=#447700>!      chlsbv(mgs) = 0.0<a name='14721'></font>
<a name='14722'>
<a name='14723'>
<a name='14724'>
<a name='14725'>
        IF ( lvol(lhl) .gt. 1  .and. .not. mixedphase ) THEN<a name='14726'>
<font color=#447700>!        IF ( lvol(lhl) .gt. 1 .and. wetgrowthhl(mgs) ) THEN<a name='14727'></font>
<a name='14728'>
         rimdn(mgs,lhl) = xdnmx(lhl) <a name='14729'>
         raindn(mgs,lhl) = xdnmx(lhl) <a name='14730'>
         vhlacw(mgs) = qhlacw(mgs)*rho0(mgs)/rimdn(mgs,lhl)<a name='14731'>
         vhlacr(mgs) = qhlacr(mgs)*rho0(mgs)/raindn(mgs,lhl)<a name='14732'>
<a name='14733'>
         IF ( xdn(mgs,lhl) .lt. xdnmx(lhl) ) THEN<a name='14734'>
         <font color=#447700>! soak some liquid into the hail<a name='14735'></font>
<font color=#447700>!           v1 = xdnmx(lhl)*vx(mgs,lhl)/(xdn(mgs,lhl)*dtp) ! volume available for filling<a name='14736'></font>
           v1 = (1. - xdn(mgs,lhl)/xdnmx(lhl))*vx(mgs,lhl)/(dtp) <font color=#447700>! volume available for filling<a name='14737'></font>
<font color=#447700>!            tmp = (vx(mgs,lhl)/rho0(mgs))*(xdnmx(lhl) - xdn(mgs,lhl)) ! max mixing ratio of liquid water that can be added<a name='14738'></font>
           v2 = rho0(mgs)*qhlwet(mgs)/xdnmx(lhl)  <font color=#447700>! volume of frozen accretion<a name='14739'></font>
           IF ( v1 &gt; v2 ) THEN <font color=#447700>! all the frozen stuff fits in<a name='14740'></font>
             vhlsoak(mgs) = v2<a name='14741'>
           ELSE  <font color=#447700>! fill up the available space<a name='14742'></font>
             vhlsoak(mgs) = v1<a name='14743'>
           ENDIF<a name='14744'>
<font color=#447700>!           vhlacw(mgs) = 0.0<a name='14745'></font>
<font color=#447700>!           vhlacr(mgs) = Max( 0.0, v2 - v1 )<a name='14746'></font>
         ELSE<a name='14747'>
           vhlsoak(mgs) = 0.0<a name='14748'>
<font color=#447700>!           vhlacw(mgs) = 0.0<a name='14749'></font>
<font color=#447700>!           vhlacr(mgs) = rho0(mgs)*qhlwet(mgs)/raindn(mgs,lhl)<a name='14750'></font>
         <a name='14751'>
         ENDIF<a name='14752'>
<a name='14753'>
         vhlshdr(mgs) = Min(0.0, rho0(mgs)*qhlwet(mgs)/xdnmx(lhl) - vhlacw(mgs) - vhlacr(mgs) )<a name='14754'>
<a name='14755'>
<a name='14756'>
        ELSEIF ( lvol(lhl) .gt. 1  .and. mixedphase ) THEN<a name='14757'>
<font color=#447700>!         vhlacw(mgs) = rho0(mgs)*qhlacw(mgs)/xdn0(lr)<a name='14758'></font>
<font color=#447700>!         vhlacr(mgs) = rho0(mgs)*qhlacr(mgs)/xdn0(lr)<a name='14759'></font>
        ENDIF<a name='14760'>
<a name='14761'>
      IF ( ehli(mgs) .gt. 0.0 ) THEN<a name='14762'>
        qhlaci(mgs) = Min(qimxd(mgs),qhlaci0(mgs))  <font color=#447700>! effectively sets collection eff to 1<a name='14763'></font>
        chlaci(mgs) = Min(cimxd(mgs),chlaci0(mgs))  <font color=#447700>! effectively sets collection eff to 1<a name='14764'></font>
      ENDIF<a name='14765'>
<a name='14766'>
<font color=#447700>!      IF ( ehls(mgs) .gt. 0.0 ) THEN<a name='14767'></font>
<font color=#447700>!        qhlacs(mgs) = Min(qsmxd(mgs),qhlacs(mgs)/ehls(mgs))<a name='14768'></font>
<font color=#447700>!      ENDIF<a name='14769'></font>
      IF ( ehls(mgs) .gt. 0.0 ) THEN<a name='14770'>
        qhlacs(mgs) = Min(qsmxd(mgs),qhlacs0(mgs)) <font color=#447700>!/ehls(mgs)                   ! divide out the collection efficiency<a name='14771'></font>
        chlacs(mgs) = Min(csmxd(mgs),chlacs0(mgs)) <font color=#447700>!/ehls(mgs)                   ! divide out the collection efficiency<a name='14772'></font>
        ehls(mgs) = ehsmax <font color=#447700>! 1.0 ! min(ehsfrac*ehs(mgs),ehsmax)            ! modify it<a name='14773'></font>
<font color=#447700>!        qhlacs(mgs) = Min(qsmxd(mgs),qhlacs(mgs))   ! plug it back in<a name='14774'></font>
      ENDIF<a name='14775'>
<a name='14776'>
      <a name='14777'>
<font color=#447700>!      qhlwet(mgs) = 1.0<a name='14778'></font>
<a name='14779'>
<font color=#447700>! be sure to catch particles with wet surfaces but not in wet growth to turn off Hallett-Mossop<a name='14780'></font>
      wetsfchl(mgs) = .true.<a name='14781'>
<a name='14782'>
<a name='14783'>
      else<a name='14784'>
<font color=#447700>!      qhlshr(mgs) = 0.0<a name='14785'></font>
<font color=#447700>!      qhlwet(mgs) = 0.0<a name='14786'></font>
      end if<a name='14787'>
<a name='14788'>
<a name='14789'>
      end do<a name='14790'>
<font color=#447700>!<a name='14791'></font>
<font color=#447700>! Ice -&gt; graupel conversion<a name='14792'></font>
<font color=#447700>!<a name='14793'></font>
      DO mgs = 1,ngscnt<a name='14794'>
      <a name='14795'>
      qhcni(mgs) = 0.0<a name='14796'>
      chcni(mgs) = 0.0<a name='14797'>
      chcnih(mgs) = 0.0<a name='14798'>
      vhcni(mgs) = 0.0<a name='14799'>
      <a name='14800'>
      IF ( iglcnvi .ge. 1 ) THEN<a name='14801'>
      IF ( temg(mgs) .lt. 273.0 .and. qiacw(mgs) - qidpv(mgs) .gt. 0.0 ) THEN<a name='14802'>
      <a name='14803'>
        <a name='14804'>
        tmp = rimc1*(-((0.5)*(1.e+06)*xdia(mgs,lc,1))   &amp;<a name='14805'>
     &amp;                *((0.60)*vtxbar(mgs,li,1))   &amp;<a name='14806'>
     &amp;                /(temg(mgs)-273.15))**(rimc2)<a name='14807'>
        tmp = Min( Max( rimc3, tmp ), 900.0 )<a name='14808'>
        <a name='14809'>
        <font color=#447700>!  Assume that half the volume of the embryo is rime with density 'tmp'<a name='14810'></font>
        <font color=#447700>!  m = rhoi*(V/2) + rhorime*(V/2) = (rhoi + rhorime)*V/2<a name='14811'></font>
        <font color=#447700>!  V = 2*m/(rhoi + rhorime)<a name='14812'></font>
        <a name='14813'>
<font color=#447700>!        write(0,*)  'rime dens = ',tmp<a name='14814'></font>
        <a name='14815'>
        IF ( tmp .ge. 200.0 .or. iglcnvi &gt;= 2 ) THEN<a name='14816'>
          r = Max( 0.5*(xdn(mgs,li) + tmp), xdnmn(lh) )<a name='14817'>
<font color=#447700>!          r = Max( r, 400. )<a name='14818'></font>
          qhcni(mgs) = (qiacw(mgs) - qidpv(mgs)) <font color=#447700>! *float(iglcnvi)<a name='14819'></font>
          chcni(mgs) = cx(mgs,li)*qhcni(mgs)/qx(mgs,li)<a name='14820'>
<font color=#447700>!          chcnih(mgs) = rho0(mgs)*qhcni(mgs)/(1.6e-10)<a name='14821'></font>
          chcnih(mgs) = Min(chcni(mgs), rho0(mgs)*qhcni(mgs)/(r*xvmn(lh)) )<a name='14822'>
<font color=#447700>!          vhcni(mgs) = rho0(mgs)*2.0*qhcni(mgs)/(xdn(mgs,li) + tmp)<a name='14823'></font>
          vhcni(mgs) = rho0(mgs)*qhcni(mgs)/r<a name='14824'>
        ENDIF<a name='14825'>
      <a name='14826'>
      ELSEIF ( iglcnvi == 3 ) THEN<a name='14827'>
<a name='14828'>
       IF ( temg(mgs) .lt. 273.0 .and. qiacw(mgs)*dtp &gt; 2.*qxmin(lh) .and. gamice73fac*xmas(mgs,li) &gt; xdnmn(lh)*xvmn(lh) ) THEN<a name='14829'>
      <a name='14830'>
        <a name='14831'>
        tmp = rimc1*(-((0.5)*(1.e+06)*xdia(mgs,lc,1))   &amp;<a name='14832'>
     &amp;                *((0.60)*vtxbar(mgs,li,1))   &amp;<a name='14833'>
     &amp;                /(temg(mgs)-273.15))**(rimc2)<a name='14834'>
        tmp = Min( Max( rimc3, tmp ), 900.0 )<a name='14835'>
        <a name='14836'>
        <font color=#447700>!  Assume that half the volume of the embryo is rime with density 'tmp'<a name='14837'></font>
        <font color=#447700>!  m = rhoi*(V/2) + rhorime*(V/2) = (rhoi + rhorime)*V/2<a name='14838'></font>
        <font color=#447700>!  V = 2*m/(rhoi + rhorime)<a name='14839'></font>
        <a name='14840'>
<font color=#447700>!        write(0,*)  'rime dens = ',tmp<a name='14841'></font>
        <font color=#447700>! convert to particles with the mass of the mass-weighted diameter<a name='14842'></font>
      <font color=#447700>!  massofmwr = gamice73fac*xmas(mgs,li)<a name='14843'></font>
        <a name='14844'>
        IF ( tmp .ge. xdnmn(lh)  ) THEN<a name='14845'>
          r = Max( 0.5*(xdn(mgs,li) + tmp), xdnmn(lh) )<a name='14846'>
<font color=#447700>!          r = Max( r, 400. )<a name='14847'></font>
          qhcni(mgs) = 0.5*qiacw(mgs)<a name='14848'>
          chcni(mgs) = qhcni(mgs)/(gamice73fac*xmas(mgs,li))<a name='14849'>
          chcnih(mgs) = Min(chcni(mgs), rho0(mgs)*qhcni(mgs)/(r*xvmn(lh)) )<a name='14850'>
<font color=#447700>!          vhcni(mgs) = rho0(mgs)*2.0*qhcni(mgs)/(xdn(mgs,li) + tmp)<a name='14851'></font>
          vhcni(mgs) = rho0(mgs)*qhcni(mgs)/r<a name='14852'>
        ENDIF<a name='14853'>
      <a name='14854'>
      ENDIF<a name='14855'>
<a name='14856'>
      <a name='14857'>
      ENDIF<a name='14858'>
      ENDIF<a name='14859'>
      <a name='14860'>
      <a name='14861'>
      ENDDO<a name='14862'>
      <a name='14863'>
      <a name='14864'>
      qhlcnh(:) = 0.0<a name='14865'>
      chlcnh(:) = 0.0<a name='14866'>
      vhlcnh(:) = 0.0<a name='14867'>
      vhlcnhl(:) = 0.0<a name='14868'>
      zhlcnh(:) = 0.0<a name='14869'>
<a name='14870'>
      qhcnhl(:) = 0.0<a name='14871'>
      chcnhl(:) = 0.0<a name='14872'>
      vhcnhl(:) = 0.0<a name='14873'>
      zhcnhl(:) = 0.0<a name='14874'>
      <a name='14875'>
<a name='14876'>
      IF ( lhl .gt. 1  ) THEN<a name='14877'>
      <a name='14878'>
      IF ( ihlcnh == 1 ) THEN<a name='14879'>
<a name='14880'>
<font color=#447700>!<a name='14881'></font>
<font color=#447700>!  Graupel (h) conversion to hail (hl) based on Milbrandt and Yau 2005b<a name='14882'></font>
<font color=#447700>!<a name='14883'></font>
      DO mgs = 1,ngscnt<a name='14884'>
<a name='14885'>
<font color=#447700>!        IF ( lhl .gt. 1 .and. ipconc .ge. 5 .and. qx(mgs,lh) .gt. 1.0e-3 .and.<a name='14886'></font>
<font color=#447700>!     :        xdn(mgs,lh) .gt. 750. .and. qhshr(mgs) .lt. 0.0 .and.<a name='14887'></font>
<font color=#447700>!     :        xdia(mgs,lh,3) .gt. 1.e-3 ) THEN<a name='14888'></font>
        IF (  wetgrowth(mgs) .and. (xdn(mgs,lh) .gt. hldnmn .or. lvh &lt; 1 ) .and.  &amp; <font color=#447700>! correct this when hail gets turned on<a name='14889'></font>
<font color=#447700>!        IF (  ( qhshr(mgs) .lt. 0.0 .or. rimdn(mgs,lh) .gt. 800. ) .and.   &amp;<a name='14890'></font>
     &amp;        rimdn(mgs,lh) .gt. 800. .and.   &amp;<a name='14891'>
     &amp;        xdia(mgs,lh,3) .gt. hlcnhdia .and. qx(mgs,lh) .gt. hlcnhqmin ) THEN<a name='14892'>
<font color=#447700>!     :        xdia(mgs,lh,3) .gt. 2.e-3 .and. qx(mgs,lh) .gt. 1.0e-3 ) THEN ! 0823.2008 erm test<a name='14893'></font>
<font color=#447700>!        IF ( xdia(mgs,lh,3) .gt. 1.e-3 ) THEN<a name='14894'></font>
        IF ( qhacw(mgs) .gt. 0.0 .and. qhacw(mgs) .gt. qhaci(mgs) .and. temg(mgs) .le. tfr-2.0 ) THEN<a name='14895'>
        <font color=#447700>! dh0 is the diameter dividing wet growth from dry growth (Ziegler 1985), modified by MY05<a name='14896'></font>
<font color=#447700>!          dh0 = 0.01*(exp(temcg(mgs)/(1.1e4*(qx(mgs,lc)+qx(mgs,lr)) - <a name='14897'></font>
<font color=#447700>!     :           1.3e3*qx(mgs,li) + 1.0e-3 ) ) - 1.0)<a name='14898'></font>
          x = (1.1e4*(rho0(mgs)*qx(mgs,lc)) - 1.3e3*rho0(mgs)*qx(mgs,li) + 1.0e-3 )<a name='14899'>
          IF ( x &gt; 1.e-20 ) THEN<a name='14900'>
          arg = Min(70.0, (-temcg(mgs)/x )) <font color=#447700>! prevent overflow of the exp function in 32 bit<a name='14901'></font>
          dh0 = 0.01*(exp(arg) - 1.0)<a name='14902'>
          ELSE<a name='14903'>
           dh0 = 1.e30<a name='14904'>
          ENDIF<a name='14905'>
<font color=#447700>!          dh0 = Max( dh0, 5.e-3 )<a name='14906'></font>
          <a name='14907'>
<font color=#447700>!         IF ( dh0 .gt. 0.0 ) write(0,*) 'dh0 = ',dh0<a name='14908'></font>
<font color=#447700>!         IF ( dh0 .gt. 1.0e-4 ) THEN<a name='14909'></font>
         IF ( xdia(mgs,lh,3)/dh0 .gt. 0.1 ) THEN <a name='14910'>
<font color=#447700>!         IF ( xdia(mgs,lh,3) .lt. 20.*dh0 .and. dh0 .lt. 2.0*xdia(mgs,lh,3) ) THEN <a name='14911'></font>
           tmp = qhacw(mgs) + qhacr(mgs) + qhaci(mgs) + qhacs(mgs)<a name='14912'>
<font color=#447700>!           qtmp = Min( 1.0, xdia(mgs,lh,3)/(2.0*dh0) )*(tmp)<a name='14913'></font>
           qtmp = Min( 100.0, xdia(mgs,lh,3)/(2.0*dh0) )*(tmp)<a name='14914'>
           IF ( .false. .and. qx(mgs,lhl) + qtmp*dtp .lt. 0.5e-3 ) THEN<a name='14915'>
             hdia1 = Max(dh0, xdia(mgs,lh,3) )<a name='14916'>
            qtmp = qtmp + Min(qxmxd(mgs,lh), Max( 0.0,   &amp;<a name='14917'>
     &amp;      ((pi*xdn(mgs,lh)*cx(mgs,lh)) / (6.0*rho0(mgs)*dtp))   &amp;<a name='14918'>
     &amp;      *exp(-hdia1/xdia(mgs,lh,1))   &amp;<a name='14919'>
     &amp;      *( (hdia1**3) + 3.0*(hdia1**2)*xdia(mgs,lh,1)   &amp;<a name='14920'>
     &amp;      + 6.0*(hdia1)*(xdia(mgs,lh,1)**2) + 6.0*(xdia(mgs,lh,1)**3) ) ) )<a name='14921'>
<a name='14922'>
<font color=#447700>!c           qtmp = Min( qxmxd(mgs,lh), qtmp )<a name='14923'></font>
<font color=#447700>!c           tmp = tmp + Min( 0.5e-3/dtp, qtmp )<a name='14924'></font>
           ENDIF<a name='14925'>
<font color=#447700>!           write(0,*) 'dh0 = ',dh0,tmp,qx(mgs,lh)*1000.<a name='14926'></font>
<font color=#447700>!           qhlcnh(mgs) = Min( 0.5*(qx(mgs,lh))+tmp, xdia(mgs,lh,3)/(2.0*dh0)*(tmp) )<a name='14927'></font>
<font color=#447700>!           qhlcnh(mgs) = Min(  qxmxd(mgs,lh), xdia(mgs,lh,3)/(2.0*dh0)*(tmp) )<a name='14928'></font>
           qhlcnh(mgs) = Min(  qxmxd(mgs,lh), qtmp )<a name='14929'>
           <a name='14930'>
           IF ( ipconc .ge. 5 ) THEN<a name='14931'>
<font color=#447700>!           dh0 = Max( xdia(mgs,lh,3), Min( dh0, 5.e-3 ) ) ! don't create hail greater than 5mm diam. unless the graupel is larger<a name='14932'></font>
           dh0 = Min( dh0, 10.e-3 ) <font color=#447700>! don't create hail greater than 10mm diam., which is the max graupel size<a name='14933'></font>
<font color=#447700>!           IF ( qx(mgs,lhl) &gt; 0.1e-3 ) dh0 = xdia(mgs,lhl,3) ! when enough hail is established, don't dilute the size<a name='14934'></font>
           chlcnh(mgs) = Min( cxmxd(mgs,lh), rho0(mgs)*qhlcnh(mgs)/(pi*xdn(mgs,lh)*dh0**3/6.0) )<a name='14935'>
<font color=#447700>!           chlcnh(mgs) = Min( chlcnh(mgs), (1./8.)*rho0(mgs)*qhlcnh(mgs)/(xdn(mgs,lh)*xv(mgs,lh)) )<a name='14936'></font>
<font color=#447700>!           chlcnh(mgs) = Min( chlcnh(mgs), (1./2.)*rho0(mgs)*qhlcnh(mgs)/(xdn(mgs,lh)*xv(mgs,lh)) )<a name='14937'></font>
           r = rho0(mgs)*qhlcnh(mgs)/(xdn(mgs,lh)*xv(mgs,lh))  <font color=#447700>! number of graupel particles at mean volume diameter<a name='14938'></font>
<font color=#447700>!           chlcnh(mgs) = Min( Max( 1./8.*r , chlcnh(mgs)), r )<a name='14939'></font>
<font color=#447700>!           chlcnh(mgs) = Min( chlcnh(mgs), r )<a name='14940'></font>
           chlcnh(mgs) = Max( chlcnh(mgs), r )<a name='14941'>
<font color=#447700>!           chlcnh(mgs) =  r <a name='14942'></font>
           ENDIF<a name='14943'>
           <a name='14944'>
           vhlcnh(mgs) = rho0(mgs)*qhlcnh(mgs)/xdn(mgs,lh)<a name='14945'>
           vhlcnhl(mgs) = rho0(mgs)*qhlcnh(mgs)/Max(xdnmn(lhl), xdn(mgs,lh))<a name='14946'>
<font color=#447700>!           write(0,*) 'qhlcnh = ',qhlcnh(mgs)*1000.,chlcnh(mgs)<a name='14947'></font>
          ENDIF<a name='14948'>
<font color=#447700>!         write(0,*) 'graupel to hail conversion not complete! STOP!'<a name='14949'></font>
<font color=#447700>!         STOP<a name='14950'></font>
        ENDIF<a name='14951'>
        ENDIF<a name='14952'>
      <a name='14953'>
      ENDDO<a name='14954'>
      <a name='14955'>
      ELSEIF ( ihlcnh == 2 ) THEN <font color=#447700>! 10-ice type conversion <a name='14956'></font>
<a name='14957'>
<font color=#447700>!<a name='14958'></font>
<font color=#447700>! Staka and Mansell (2005) type conversion -- assuming alphah = 0 for now!<a name='14959'></font>
<font color=#447700>!<a name='14960'></font>
<font color=#447700>!      hldia1 is set in micro_module and namelist<a name='14961'></font>
      do mgs = 1,ngscnt<a name='14962'>
<font color=#447700>!      qhlcnh(mgs) = 0.0<a name='14963'></font>
<font color=#447700>!      chlcnh(mgs) = 0.0<a name='14964'></font>
      if ( wetgrowth(mgs) .and. temg(mgs) .lt. tfr-5. .and. qx(mgs,lh) &gt; qxmin(lh) ) then<a name='14965'>
      if ( qhacw(mgs).gt.1.e-6 .and. xdn(mgs,lh) &gt; 700. ) then<a name='14966'>
      qhlcnh(mgs) =                                                   &amp;<a name='14967'>
        ((pi*xdn(mgs,lh)*cx(mgs,lh)) / (6.0*rho0(mgs)*dtp))           &amp;<a name='14968'>
       *exp(-hldia1/xdia(mgs,lh,1))                                    &amp;<a name='14969'>
       *( (hldia1**3) + 3.0*(hldia1**2)*xdia(mgs,lh,1)                  &amp;<a name='14970'>
        + 6.0*(hldia1)*(xdia(mgs,lh,1)**2) + 6.0*(xdia(mgs,lh,1)**3) )<a name='14971'>
      qhlcnh(mgs) =   min(qhlcnh(mgs),qhmxd(mgs))<a name='14972'>
      IF ( ipconc .ge. 5 ) THEN<a name='14973'>
        chlcnh(mgs) = Min( cxmxd(mgs,lh), cx(mgs,lh)*Exp(-hldia1/xdia(mgs,lh,1)))<a name='14974'>
<font color=#447700>!        chlcnh(mgs) = Min( cxmxd(mgs,lh), rho0(mgs)*qhlcnh(mgs)/(2.0*xmas(mgs,lh) ))<a name='14975'></font>
      ENDIF<a name='14976'>
           vhlcnh(mgs) = rho0(mgs)*qhlcnh(mgs)/xdn(mgs,lh)<a name='14977'>
           vhlcnhl(mgs) = rho0(mgs)*qhlcnh(mgs)/Max(xdnmn(lhl), xdn(mgs,lh))<a name='14978'>
      end if<a name='14979'>
      end if<a name='14980'>
      end do<a name='14981'>
      <a name='14982'>
      ENDIF<a name='14983'>
      <a name='14984'>
     <font color=#447700>! convert low-density hail to graupel<a name='14985'></font>
      IF ( icvhl2h &gt;= 1 ) THEN<a name='14986'>
      DO mgs = 1,ngscnt<a name='14987'>
        IF (  qx(mgs,lhl) &gt; qxmin(lhl) .and. xdn(mgs,lhl) &lt; 0.5*(xdnmn(lhl) + xdnmx(lhl)) ) THEN<a name='14988'>
          tmp = Min(0.95, 1. - 0.5*(1. + tanh(0.125*(xdn(mgs,lhl) - 1.01*xdnmn(lhl) )) ))<a name='14989'>
          qhcnhl(mgs) = tmp*qx(mgs,lhl)/dtp<a name='14990'>
          chcnhl(mgs) = cx(mgs,lhl)*qhcnhl(mgs)/qx(mgs,lhl)<a name='14991'>
          vhcnhl(mgs) = vx(mgs,lhl)*qhcnhl(mgs)/qx(mgs,lhl)<a name='14992'>
          <a name='14993'>
        ENDIF<a name='14994'>
      ENDDO<a name='14995'>
      <a name='14996'>
      ENDIF<a name='14997'>
      <a name='14998'>
      <a name='14999'>
      ENDIF <font color=#447700>! lhl &gt; 1<a name='15000'></font>
<a name='15001'>
<a name='15002'>
<font color=#447700>!<a name='15003'></font>
<font color=#447700>! Ziegler snow conversion to graupel<a name='15004'></font>
<font color=#447700>!<a name='15005'></font>
      DO mgs = 1,ngscnt<a name='15006'>
<a name='15007'>
      qhcns(mgs) = 0.0<a name='15008'>
      chcns(mgs) = 0.0<a name='15009'>
      chcnsh(mgs) = 0.0<a name='15010'>
      vhcns(mgs) = 0.0<a name='15011'>
<a name='15012'>
      qscnh(mgs) = 0.0<a name='15013'>
      cscnh(mgs) = 0.0<a name='15014'>
      vscnh(mgs) = 0.0<a name='15015'>
<a name='15016'>
      IF ( ipconc .ge. 5 ) THEN<a name='15017'>
<a name='15018'>
        <font color=#447700>! test attempt at converting graupel to snow when not riming but growing by deposition<a name='15019'></font>
        IF ( temg(mgs) &lt; tfr .and. qx(mgs,lh) .gt. qxmin(lh) .and. qhdpv(mgs) &gt; qxmin(lh)*dtpinv  &amp;<a name='15020'>
     &amp;       .and. qhacw(mgs) &lt; qxmin(lh)*dtpinv ) THEN<a name='15021'>
          IF ( xdn(mgs,lh) &lt; 290. ) THEN<a name='15022'>
<font color=#447700>!          qscnh(mgs) = 2.*qhdpv(mgs)<a name='15023'></font>
<font color=#447700>!          cscnh(mgs) = cx(mgs,lh)*qscnh(mgs)/qx(mgs,lh)<a name='15024'></font>
<font color=#447700>!          vscnh(mgs) = rho0(mgs)*qscnh(mgs)/xdn(mgs,lh)<a name='15025'></font>
          ENDIF<a name='15026'>
        ENDIF<a name='15027'>
<a name='15028'>
<a name='15029'>
        IF ( qx(mgs,ls) .gt. qxmin(ls) .and. qsacw(mgs) .gt. 0.0 ) THEN<a name='15030'>
<a name='15031'>
<font color=#447700>!      DATA VGRA/1.413E-2/  ! this is the volume (cm**3) of a 3mm diam. sphere<a name='15032'></font>
<font color=#447700>!    vgra = 1.4137e-8 m**3<a name='15033'></font>
<a name='15034'>
<font color=#447700>!      DNNET=DNCNV-DNAGG<a name='15035'></font>
<font color=#447700>!      DQNET=QXCON+QSACC+SDEP<a name='15036'></font>
<font color=#447700>!<a name='15037'></font>
<font color=#447700>!      DNSCNV=EXP(-(ROS*XNS*VGRA/(RO*QI)))*((1.-(XNS*VGRA*ROS/<a name='15038'></font>
<font color=#447700>!     / (RO*QI)))*DNNET + (XNS**2*VGRA*ROS/(RO*QI**2))*DQNET)<a name='15039'></font>
<font color=#447700>!      IF(DNSCNV.LT.0.) DNSCNV=0.<a name='15040'></font>
<font color=#447700>!<a name='15041'></font>
<font color=#447700>!      QIHC=(ROS*VGRA/RO)*DNSCNV<a name='15042'></font>
<font color=#447700>!<a name='15043'></font>
<font color=#447700>!      QH=QH+DT*QIHC<a name='15044'></font>
<font color=#447700>!      QI=QI-DT*QIHC<a name='15045'></font>
<font color=#447700>!      XNH=XNH+DT*DNSCNV<a name='15046'></font>
<font color=#447700>!      XNS=XNS-DT*DNSCNV<a name='15047'></font>
<a name='15048'>
        IF ( iglcnvs .eq. 1 ) THEN  <font color=#447700>! Zrnic, Ziegler et al (1993)<a name='15049'></font>
<a name='15050'>
        dnnet = cscnvis(mgs) + cscnis(mgs) - csacs(mgs)<a name='15051'>
        dqnet = qscnvi(mgs) + qscni(mgs) + qsacw(mgs) + qsdpv(mgs) + qssbv(mgs)<a name='15052'>
<a name='15053'>
        a3 = 1./(rho0(mgs)*qx(mgs,ls))<a name='15054'>
        a1 = Exp( - xdn(mgs,ls)*cx(mgs,ls)*vgra*a3 )  <font color=#447700>! EXP(-(ROS*XNS*VGRA/(RO*QI)))<a name='15055'></font>
<font color=#447700>! (1.-(XNS*VGRA*ROS/(RO*QI)))*DNNET<a name='15056'></font>
        a2 =  (1.-(cx(mgs,ls)*vgra*xdn(mgs,ls)*a3))*dnnet<a name='15057'>
<font color=#447700>! (XNS**2*VGRA*ROS/(RO*QI**2))*DQNET<a name='15058'></font>
        a4 = cx(mgs,ls)**2*vgra*xdn(mgs,ls)*a3/qx(mgs,ls)*dqnet<a name='15059'>
<a name='15060'>
        chcns(mgs) = Max( 0.0, a1*(a2 + a4) )<a name='15061'>
        chcns(mgs) = Min( chcns(mgs), cxmxd(mgs,ls) )<a name='15062'>
        chcnsh(mgs) = chcns(mgs)<a name='15063'>
<a name='15064'>
        qhcns(mgs) = Min( xdn(mgs,ls)*vgra*rhoinv(mgs)*chcns(mgs), qxmxd(mgs,ls) )<a name='15065'>
        vhcns(mgs) = rho0(mgs)*qhcns(mgs)/Max(xdn(mgs,ls),xdnmn(lh))<a name='15066'>
<font color=#447700>!        vhcns(mgs) = rho0(mgs)*qhcns(mgs)/Max(xdn(mgs,ls),400.)<a name='15067'></font>
<a name='15068'>
        ELSEIF ( iglcnvs .ge. 2  ) THEN  <font color=#447700>! treat like ice crystals, i.e., check for rime density (ERM)<a name='15069'></font>
<a name='15070'>
          IF ( temg(mgs) .lt. 273.0 .and. ( qsacw(mgs) - qsdpv(mgs) .gt. 0.0 .or. &amp;<a name='15071'>
              ( iglcnvs &gt;= 3 .and. qsacw(mgs) &gt; 2.*qxmin(lh) .and. gamsnow73fac*xmas(mgs,ls) &gt; xdnmn(lh)*xvmn(lh)  ) ) ) THEN <font color=#447700>!{<a name='15072'></font>
<a name='15073'>
<a name='15074'>
        tmp = rimc1*(-((0.5)*(1.e+06)*xdia(mgs,lc,1))   &amp;<a name='15075'>
     &amp;                *((0.60)*vtxbar(mgs,ls,1))   &amp;<a name='15076'>
     &amp;                /(temg(mgs)-273.15))**(rimc2)<a name='15077'>
<font color=#447700>!        tmp = Min( Max( rimc3, tmp ), 900.0 )<a name='15078'></font>
        tmp = Min( tmp , 900.0 )<a name='15079'>
<a name='15080'>
        <font color=#447700>!  Assume that half the volume of the embryo is rime with density 'tmp'<a name='15081'></font>
        <font color=#447700>!  m = rhoi*(V/2) + rhorime*(V/2) = (rhoi + rhorime)*V/2<a name='15082'></font>
        <font color=#447700>!  V = 2*m/(rhoi + rhorime)<a name='15083'></font>
<a name='15084'>
<font color=#447700>!        write(0,*)  'rime dens = ',tmp<a name='15085'></font>
<a name='15086'>
        IF ( iglcnvs == 2 ) THEN <font color=#447700>!{<a name='15087'></font>
        IF ( tmp .ge. 200.0  ) THEN<a name='15088'>
          r = Max( 0.5*(xdn(mgs,ls) + tmp), xdnmn(lh) )<a name='15089'>
<font color=#447700>!          r = Max( r, 400. )<a name='15090'></font>
          qhcns(mgs) = (qsacw(mgs) - qsdpv(mgs))<a name='15091'>
          chcns(mgs) = cx(mgs,ls)*qhcns(mgs)/qx(mgs,ls)<a name='15092'>
<font color=#447700>!          chcnih(mgs) = rho0(mgs)*qhcni(mgs)/(1.6e-10)<a name='15093'></font>
          chcnsh(mgs) = Min(chcns(mgs), rho0(mgs)*qhcns(mgs)/(r*xvmn(lh)) )<a name='15094'>
<font color=#447700>!          vhcni(mgs) = rho0(mgs)*2.0*qhcni(mgs)/(xdn(mgs,li) + tmp)<a name='15095'></font>
          vhcns(mgs) = rho0(mgs)*qhcns(mgs)/r<a name='15096'>
        ENDIF<a name='15097'>
        <a name='15098'>
        ELSEIF ( iglcnvs == 3 ) THEN<a name='15099'>
 <a name='15100'>
         <font color=#447700>! convert to particles with the mass of the mass-weighted diameter<a name='15101'></font>
      <font color=#447700>!  massofmwr = gamice73fac*xmas(mgs,li)<a name='15102'></font>
        <a name='15103'>
        IF ( tmp &gt; xdnmn(lh) ) THEN<a name='15104'>
          r = Max( 0.5*(xdn(mgs,ls) + tmp), xdnmn(lh) )<a name='15105'>
<font color=#447700>!          r = Max( r, 400. )<a name='15106'></font>
          qhcns(mgs) = 0.5*qsacw(mgs)<a name='15107'>
          chcns(mgs) = qhcns(mgs)/(gamsnow73fac*xmas(mgs,ls))<a name='15108'>
          chcns(mgs) = Min( chcns(mgs), cx(mgs,ls)*qhcns(mgs)/qx(mgs,ls))<a name='15109'>
          chcnsh(mgs) = Min(chcns(mgs), rho0(mgs)*qhcns(mgs)/(r*xvmn(lh)) )<a name='15110'>
          vhcns(mgs) = rho0(mgs)*qhcns(mgs)/r<a name='15111'>
        ENDIF<a name='15112'>
<a name='15113'>
        ENDIF <font color=#447700>!}<a name='15114'></font>
<a name='15115'>
      ENDIF <font color=#447700>!}<a name='15116'></font>
<a name='15117'>
        ENDIF<a name='15118'>
<a name='15119'>
<a name='15120'>
        ENDIF<a name='15121'>
<a name='15122'>
       ELSE <font color=#447700>! single moment lfo<a name='15123'></font>
<a name='15124'>
        qhcns(mgs) = 0.001*ehscnv(mgs)*max((qx(mgs,ls)-6.e-4),0.0)<a name='15125'>
        qhcns(mgs) = min(qhcns(mgs),qxmxd(mgs,ls))<a name='15126'>
        IF ( lvol(lh) .ge. 1 ) vhcns(mgs) = rho0(mgs)*qhcns(mgs)/Max(xdn(mgs,ls),400.)<a name='15127'>
<a name='15128'>
       ENDIF<a name='15129'>
      ENDDO<a name='15130'>
<font color=#447700>!<a name='15131'></font>
<font color=#447700>!<a name='15132'></font>
<font color=#447700>!  heat budget for rain---not all rain that collects ice can freeze<a name='15133'></font>
<font color=#447700>!<a name='15134'></font>
<font color=#447700>!<a name='15135'></font>
<font color=#447700>!<a name='15136'></font>
      if ( irwfrz .gt. 0 .and. .not. mixedphase) then<a name='15137'>
<font color=#447700>!<a name='15138'></font>
      do mgs = 1,ngscnt<a name='15139'>
<font color=#447700>!<a name='15140'></font>
<font color=#447700>!  compute total rain that freeze when it interacts with cloud ice<a name='15141'></font>
<font color=#447700>!<a name='15142'></font>
      qrztot(mgs) = qrfrz(mgs) + qiacr(mgs) + qsacr(mgs)<a name='15143'>
<font color=#447700>!<a name='15144'></font>
<font color=#447700>!  compute the maximum amount of rain that can freeze<a name='15145'></font>
<font color=#447700>!  Used to limit freezing to 4*qrmxd, but now allow all rain to freeze if possible<a name='15146'></font>
<font color=#447700>!<a name='15147'></font>
      qrzmax(mgs) =   &amp;<a name='15148'>
     &amp;  ( xdia(mgs,lr,1)*rwvent(mgs)*cx(mgs,lr)*fwet1(mgs) )<a name='15149'>
      qrzmax(mgs) = max(qrzmax(mgs), 0.0)<a name='15150'>
      qrzmax(mgs) = min(qrztot(mgs), qrzmax(mgs))<a name='15151'>
      qrzmax(mgs) = min(qx(mgs,lr)/dtp, qrzmax(mgs))<a name='15152'>
<a name='15153'>
      IF ( temcg(mgs) &lt; -30. ) THEN <font color=#447700>! allow all to freeze if T &lt; -30 because fwet becomes invalid (negative)<a name='15154'></font>
        qrzmax(mgs) = qx(mgs,lr)/dtp<a name='15155'>
      ENDIF<a name='15156'>
<font color=#447700>!      qrzmax(mgs) = min(4.*qrmxd(mgs), qrzmax(mgs))<a name='15157'></font>
<font color=#447700>!<a name='15158'></font>
<font color=#447700>!  compute the correction factor<a name='15159'></font>
<font color=#447700>!<a name='15160'></font>
<font color=#447700>!      IF ( qrztot(mgs) .gt. qxmin(lr) ) THEN<a name='15161'></font>
      IF ( qrztot(mgs) .gt. qrzmax(mgs) .and. qrztot(mgs) .gt. qxmin(lr) ) THEN<a name='15162'>
        qrzfac(mgs) = qrzmax(mgs)/(qrztot(mgs))<a name='15163'>
      ELSE<a name='15164'>
        qrzfac(mgs) = 1.0<a name='15165'>
      ENDIF<a name='15166'>
      qrzfac(mgs) = min(1.0, qrzfac(mgs))<a name='15167'>
<font color=#447700>!<a name='15168'></font>
      end do<a name='15169'>
<font color=#447700>!<a name='15170'></font>
<font color=#447700>!<a name='15171'></font>
<font color=#447700>! now correct the above sources<a name='15172'></font>
<font color=#447700>!<a name='15173'></font>
<font color=#447700>!<a name='15174'></font>
      do mgs = 1,ngscnt<a name='15175'>
      if ( temg(mgs) .le. 273.15 .and. qrzfac(mgs) .lt. 1.0 ) then<a name='15176'>
      qrfrz(mgs)   = qrzfac(mgs)*qrfrz(mgs)<a name='15177'>
      qrfrzs(mgs)  = qrzfac(mgs)*qrfrzs(mgs)<a name='15178'>
      qrfrzf(mgs)  = qrzfac(mgs)*qrfrzf(mgs)<a name='15179'>
      qiacr(mgs)   = qrzfac(mgs)*qiacr(mgs)<a name='15180'>
      qsacr(mgs)   = qrzfac(mgs)*qsacr(mgs)<a name='15181'>
      qiacrf(mgs)  = qrzfac(mgs)*qiacrf(mgs)<a name='15182'>
      qiacrs(mgs)  = qrzfac(mgs)*qiacrs(mgs)<a name='15183'>
      crfrz(mgs)   = qrzfac(mgs)*crfrz(mgs)<a name='15184'>
      crfrzf(mgs)  = qrzfac(mgs)*crfrzf(mgs)<a name='15185'>
      crfrzs(mgs)  = qrzfac(mgs)*crfrzs(mgs)<a name='15186'>
      ciacr(mgs)   = qrzfac(mgs)*ciacr(mgs)<a name='15187'>
      ciacrf(mgs)  = qrzfac(mgs)*ciacrf(mgs)<a name='15188'>
      ciacrs(mgs)  = qrzfac(mgs)*ciacrs(mgs)<a name='15189'>
<a name='15190'>
      <a name='15191'>
       vrfrzf(mgs)  = qrzfac(mgs)*vrfrzf(mgs)<a name='15192'>
       viacrf(mgs)  = qrzfac(mgs)*viacrf(mgs)<a name='15193'>
      end if<a name='15194'>
      end do<a name='15195'>
<font color=#447700>!<a name='15196'></font>
<font color=#447700>!<a name='15197'></font>
<font color=#447700>!<a name='15198'></font>
      end if<a name='15199'>
<font color=#447700>!<a name='15200'></font>
<font color=#447700>!<a name='15201'></font>
<font color=#447700>!<a name='15202'></font>
<font color=#447700>!  evaporation of rain<a name='15203'></font>
<font color=#447700>!<a name='15204'></font>
<font color=#447700>!<a name='15205'></font>
<font color=#447700>!<a name='15206'></font>
      qrcev(:) = 0.0<a name='15207'>
      crcev(:) = 0.0<a name='15208'>
<a name='15209'>
<a name='15210'>
      do mgs = 1,ngscnt<a name='15211'>
<font color=#447700>!<a name='15212'></font>
      IF ( qx(mgs,lr) .gt. qxmin(lr) ) THEN<a name='15213'>
<a name='15214'>
      qrcev(mgs) =   &amp;<a name='15215'>
     &amp;  fvce(mgs)*cx(mgs,lr)*rwvent(mgs)*rwcap(mgs)*evapfac<a name='15216'>
<font color=#447700>! this line to allow condensation on rain:<a name='15217'></font>
      IF ( rcond .eq. 1 ) THEN<a name='15218'>
        qrcev(mgs) = min(qrcev(mgs), qxmxd(mgs,lv))<a name='15219'>
<font color=#447700>! this line to have evaporation only:<a name='15220'></font>
      ELSE<a name='15221'>
        qrcev(mgs) = min(qrcev(mgs), 0.0)<a name='15222'>
      ENDIF<a name='15223'>
<a name='15224'>
      qrcev(mgs) = max(qrcev(mgs), -qrmxd(mgs))<a name='15225'>
<font color=#447700>!      if ( temg(mgs) .lt. 273.15 ) qrcev(mgs) = 0.0<a name='15226'></font>
      IF ( qrcev(mgs) .lt. 0. .and. lnr &gt; 1 ) THEN<a name='15227'>
<font color=#447700>!        qrcev(mgs) =   -qrmxd(mgs)<a name='15228'></font>
<font color=#447700>!        crcev(mgs) = (rho0(mgs)/(xmas(mgs,lr)+1.e-20))*qrcev(mgs)<a name='15229'></font>
      crcev(mgs) = (cx(mgs,lr)/(qx(mgs,lr)))*qrcev(mgs)<a name='15230'>
      ELSE<a name='15231'>
         crcev(mgs) = 0.0<a name='15232'>
      ENDIF<a name='15233'>
<font color=#447700>!      if ( temg(mgs) .lt. 273.15 ) crcev(mgs) = 0.0<a name='15234'></font>
<font color=#447700>!<a name='15235'></font>
      ENDIF<a name='15236'>
<a name='15237'>
      end do<a name='15238'>
<font color=#447700>!<a name='15239'></font>
<font color=#447700>! evaporation/condensation of wet graupel and snow<a name='15240'></font>
<font color=#447700>!<a name='15241'></font>
      qscev(:) = 0.0<a name='15242'>
      cscev(:) = 0.0<a name='15243'>
      qhcev(:) = 0.0<a name='15244'>
      chcev(:) = 0.0<a name='15245'>
      qhlcev(:) = 0.0<a name='15246'>
      chlcev(:) = 0.0<a name='15247'>
<a name='15248'>
<font color=#447700>!<a name='15249'></font>
<font color=#447700>!<a name='15250'></font>
<font color=#447700>!<a name='15251'></font>
<font color=#447700>!  ICE MULTIPLICATION: Two modes (rimpa, and rimpb)<a name='15252'></font>
<font color=#447700>!  (following Cotton et al. 1986)<a name='15253'></font>
<font color=#447700>!<a name='15254'></font>
 <a name='15255'>
      chmul1(:) =  0.0<a name='15256'>
      chlmul1(:) =  0.0<a name='15257'>
      csmul1(:) = 0.0<a name='15258'>
<font color=#447700>!<a name='15259'></font>
      qhmul1(:) =  0.0<a name='15260'>
      qhlmul1(:) =  0.0<a name='15261'>
      qsmul1(:) =  0.0<a name='15262'>
<a name='15263'>
      do mgs = 1,ngscnt<a name='15264'>
 <a name='15265'>
       ltest =  qx(mgs,lh) .gt. qxmin(lh)<a name='15266'>
       IF ( lhl &gt; 1 )  ltest =  ltest .or. qx(mgs,lhl) .gt. qxmin(lhl)<a name='15267'>
       <a name='15268'>
      IF ( (itype1 .ge. 1 .or. itype2 .ge. 1 )   &amp;<a name='15269'>
     &amp;              .and. qx(mgs,lc) .gt. qxmin(lc)) THEN<a name='15270'>
      if ( temg(mgs) .ge. 265.15 .and. temg(mgs) .le. 271.15 ) then<a name='15271'>
       IF ( ipconc .ge. 2 ) THEN<a name='15272'>
        IF ( xv(mgs,lc) .gt. 0.0     &amp;<a name='15273'>
     &amp;     .and.  ltest &amp;<a name='15274'>
<font color=#447700>!     .and. itype2 .ge. 2    &amp;<a name='15275'></font>
     &amp;       ) THEN<a name='15276'>
<font color=#447700>!<a name='15277'></font>
<font color=#447700>!  Ziegler et al. 1986 Hallett-Mossop process.  VSTAR = 7.23e-15 (vol of 12micron radius)<a name='15278'></font>
<font color=#447700>!<a name='15279'></font>
         IF ( .true. .and. cnu == 0.0 ) THEN<a name='15280'>
           ex1 = (1./250.)*Exp(-7.23e-15/xv(mgs,lc))<a name='15281'>
         ELSE<a name='15282'>
            ratio = (1. + cnu)*(7.23e-15)/xv(mgs,lc)<a name='15283'>
            ex1 = (1./250.)*Gamxinf(1.+cnu, ratio)/(gcnup1)<a name='15284'>
         ENDIF<a name='15285'>
       IF ( itype2 .le. 2 ) THEN<a name='15286'>
         ft = Max(0.0,Min(1.0,-0.11*temcg(mgs)**2 - 1.1*temcg(mgs)-1.7))<a name='15287'>
       ELSE<a name='15288'>
        IF ( temg(mgs) .ge. 265.15 .and. temg(mgs) .le. 267.15 ) THEN<a name='15289'>
          ft = 0.5<a name='15290'>
        ELSEIF (temg(mgs) .ge. 267.15 .and. temg(mgs) .le. 269.15 ) THEN<a name='15291'>
          ft = 1.0<a name='15292'>
        ELSEIF (temg(mgs) .ge. 269.15 .and. temg(mgs) .le. 271.15 ) THEN<a name='15293'>
          ft = 0.5<a name='15294'>
        ELSE <a name='15295'>
          ft = 0.0<a name='15296'>
        ENDIF<a name='15297'>
       ENDIF<a name='15298'>
<font color=#447700>!        rhoinv = 1./rho0(mgs)<a name='15299'></font>
<font color=#447700>!        DNSTAR = ex1*cglacw(mgs)<a name='15300'></font>
        <a name='15301'>
       IF ( ft &gt; 0.0 ) THEN<a name='15302'>
        <a name='15303'>
        IF ( itype2 &gt; 0 ) THEN<a name='15304'>
         IF ( qx(mgs,lh) .gt. qxmin(lh) .and. (.not. wetsfc(mgs))  ) THEN<a name='15305'>
          chmul1(mgs) = ft*ex1*chacw(mgs)<a name='15306'>
<font color=#447700>!          chmul1(mgs) = Min( ft*ex1*chacw(mgs), ft*(30.*1.e+06)*rho0(mgs)*qhacw(mgs) ) ! 1.e+6 converts kg to mg; Saunders &amp; Hosseini (2001) average of about 30 crystals per mg<a name='15307'></font>
          qhmul1(mgs) = cimas0*chmul1(mgs)*rhoinv(mgs)<a name='15308'>
         ENDIF<a name='15309'>
         IF ( lhl .gt. 1 ) THEN<a name='15310'>
           IF ( qx(mgs,lhl) .gt. qxmin(lhl) .and. (.not. wetsfchl(mgs))  ) THEN<a name='15311'>
            chlmul1(mgs) = (ft*ex1*chlacw(mgs))<a name='15312'>
            qhlmul1(mgs) = cimas0*chlmul1(mgs)*rhoinv(mgs)<a name='15313'>
           ENDIF<a name='15314'>
         ENDIF<a name='15315'>
        ENDIF <font color=#447700>! itype2<a name='15316'></font>
<a name='15317'>
        IF ( itype1 &gt; 0 ) THEN<a name='15318'>
         IF ( qx(mgs,lh) .gt. qxmin(lh) .and. (.not. wetsfc(mgs))  ) THEN<a name='15319'>
          tmp = ft*(3.5e+08)*rho0(mgs)*qhacw(mgs)<a name='15320'>
          chmul1(mgs) = chmul1(mgs) + tmp<a name='15321'>
          qhmul1(mgs) = qhmul1(mgs) + cimas0*tmp*rhoinv(mgs)<a name='15322'>
         ENDIF<a name='15323'>
         IF ( lhl .gt. 1 ) THEN<a name='15324'>
           IF ( qx(mgs,lhl) .gt. qxmin(lhl) .and. (.not. wetsfchl(mgs)) ) THEN<a name='15325'>
            tmp = ft*(3.5e+08)*rho0(mgs)*qhlacw(mgs)<a name='15326'>
            chlmul1(mgs) = chlmul1(mgs) + tmp<a name='15327'>
            qhlmul1(mgs) = qhlmul1(mgs) + cimas0*tmp*rhoinv(mgs)<a name='15328'>
           ENDIF<a name='15329'>
         ENDIF<a name='15330'>
        ENDIF <font color=#447700>! itype1<a name='15331'></font>
        <a name='15332'>
        ENDIF <font color=#447700>! ft<a name='15333'></font>
<a name='15334'>
        ENDIF <font color=#447700>! xv(mgs,lc) .gt. 0.0 .and.<a name='15335'></font>
<a name='15336'>
       ELSE <font color=#447700>! ipconc .lt. 2<a name='15337'></font>
<font color=#447700>!<a name='15338'></font>
<font color=#447700>!  define the temperature function<a name='15339'></font>
<font color=#447700>!<a name='15340'></font>
      fimt1(mgs) = 0.0<a name='15341'>
<font color=#447700>!<a name='15342'></font>
<font color=#447700>! Cotton et al. (1986) version<a name='15343'></font>
<font color=#447700>!<a name='15344'></font>
      if ( temg(mgs) .ge. 268.15 .and. temg(mgs) .le. 270.15 ) then<a name='15345'>
        fimt1(mgs) = 1.0 -(temg(mgs)-268.15)/2.0<a name='15346'>
      elseif (temg(mgs) .le. 268.15 .and. temg(mgs) .ge. 265.15 ) then<a name='15347'>
        fimt1(mgs) = 1.0 +(temg(mgs)-268.15)/3.0<a name='15348'>
      ELSE <a name='15349'>
        fimt1(mgs) = 0.0<a name='15350'>
      end if<a name='15351'>
<font color=#447700>!<a name='15352'></font>
<font color=#447700>! Ferrier (1994) version<a name='15353'></font>
<font color=#447700>!<a name='15354'></font>
      if ( temg(mgs) .ge. 265.15 .and. temg(mgs) .le. 267.15 ) then<a name='15355'>
        fimt1(mgs) = 0.5<a name='15356'>
      elseif (temg(mgs) .ge. 267.15 .and. temg(mgs) .le. 269.15 ) then<a name='15357'>
        fimt1(mgs) = 1.0<a name='15358'>
      elseif (temg(mgs) .ge. 269.15 .and. temg(mgs) .le. 271.15 ) then<a name='15359'>
        fimt1(mgs) = 0.5<a name='15360'>
      ELSE <a name='15361'>
        fimt1(mgs) = 0.0<a name='15362'>
      end if<a name='15363'>
<font color=#447700>!<a name='15364'></font>
<font color=#447700>!<a name='15365'></font>
<font color=#447700>!   type I:  350 splinters are formed for every 1e-3 grams of cloud<a name='15366'></font>
<font color=#447700>!            water accreted by graupel/hail (note converted to MKS units)<a name='15367'></font>
<font color=#447700>!            3.5e+8 has units of 1/kg<a name='15368'></font>
<font color=#447700>!<a name='15369'></font>
      IF ( itype1 .ge. 1 ) THEN<a name='15370'>
       fimta(mgs) = (3.5e+08)*rho0(mgs)<a name='15371'>
      ELSE<a name='15372'>
       fimta(mgs) = 0.0<a name='15373'>
      ENDIF<a name='15374'>
<a name='15375'>
<font color=#447700>!<a name='15376'></font>
<font color=#447700>!<a name='15377'></font>
<font color=#447700>!   type II:  1 splinter formed for every 250 cloud droplets larger than<a name='15378'></font>
<font color=#447700>!             24 micons in diameter (12 microns in radius) accreted by<a name='15379'></font>
<font color=#447700>!             graupel/hail<a name='15380'></font>
<font color=#447700>!<a name='15381'></font>
<font color=#447700>!<a name='15382'></font>
      fimt2(mgs) = 0.0<a name='15383'>
      xcwmas = xmas(mgs,lc) * 1000.<a name='15384'>
<font color=#447700>!<a name='15385'></font>
      IF ( itype2 .ge. 1 ) THEN<a name='15386'>
      if ( xcwmas.lt.1.26e-9 ) then<a name='15387'>
        fimt2(mgs) = 0.0<a name='15388'>
      end if<a name='15389'>
      if ( xcwmas .le. 3.55e-9 .and. xcwmas .ge. 1.26e-9 ) then<a name='15390'>
        fimt2(mgs) = (2.27)*alog(xcwmas) + 13.39<a name='15391'>
      end if<a name='15392'>
      if ( xcwmas .gt. 3.55e-9 ) then<a name='15393'>
        fimt2(mgs) = 1.0<a name='15394'>
      end if<a name='15395'>
<a name='15396'>
      fimt2(mgs) = min(fimt2(mgs),1.0)<a name='15397'>
      fimt2(mgs) = max(fimt2(mgs),0.0)<a name='15398'>
      <a name='15399'>
      ENDIF<a name='15400'>
<font color=#447700>!<a name='15401'></font>
<font color=#447700>!     qhmul2 = 0.0<a name='15402'></font>
<font color=#447700>!     qsmul2 = 0.0<a name='15403'></font>
<font color=#447700>!<a name='15404'></font>
<font color=#447700>!     qhmul2 =<a name='15405'></font>
<font color=#447700>!    &gt;  (4.0e-03)*fimt1(mgs)*fimt2(mgs)*qhacw(mgs)<a name='15406'></font>
<font color=#447700>!     qsmul2 =<a name='15407'></font>
<font color=#447700>!    &gt;  (4.0e-03)*fimt1(mgs)*fimt2(mgs)*qsacw(mgs)<a name='15408'></font>
<font color=#447700>!<a name='15409'></font>
<font color=#447700>!      cimas0 = (1.0e-12)<a name='15410'></font>
<font color=#447700>!      cimas0 = 2.5e-10<a name='15411'></font>
      IF ( .not. wetsfc(mgs) ) THEN<a name='15412'>
      chmul1(mgs) =  fimt1(mgs)*(fimta(mgs) +   &amp;<a name='15413'>
     &amp;                           (4.0e-03)*fimt2(mgs))*qhacw(mgs)<a name='15414'>
      ENDIF<a name='15415'>
<font color=#447700>!<a name='15416'></font>
      qhmul1(mgs) =  chmul1(mgs)*(cimas0/rho0(mgs))<a name='15417'>
<a name='15418'>
<a name='15419'>
         IF ( lhl .gt. 1 ) THEN<a name='15420'>
           IF ( qx(mgs,lhl) .gt. qxmin(lhl) .and. (.not. wetsfchl(mgs)) ) THEN<a name='15421'>
            tmp = fimt1(mgs)*(fimta(mgs) +   &amp;<a name='15422'>
     &amp;                           (4.0e-03)*fimt2(mgs))*qhlacw(mgs)<a name='15423'>
            chlmul1(mgs) =  tmp<a name='15424'>
            qhlmul1(mgs) = cimas0*tmp*rhoinv(mgs)<a name='15425'>
           ENDIF<a name='15426'>
         ENDIF<a name='15427'>
<a name='15428'>
<font color=#447700>!      qsmul1(mgs) =  csmul1(mgs)*(cimas0/rho0(mgs))<a name='15429'></font>
<font color=#447700>!<a name='15430'></font>
      ENDIF <font color=#447700>! ( ipconc .ge. 2 )<a name='15431'></font>
      <a name='15432'>
      end if <font color=#447700>! (in temperature range)<a name='15433'></font>
      <a name='15434'>
      ENDIF <font color=#447700>! ( itype1 .eq. 1 .or. itype2 .eq. 1)<a name='15435'></font>
<font color=#447700>!<a name='15436'></font>
      end do<a name='15437'>
<font color=#447700>!<a name='15438'></font>
<font color=#447700>!<a name='15439'></font>
<font color=#447700>!<a name='15440'></font>
<font color=#447700>!     end if<a name='15441'></font>
<font color=#447700>!<a name='15442'></font>
<font color=#447700>!     end do<a name='15443'></font>
<font color=#447700>!<a name='15444'></font>
<font color=#447700>!<a name='15445'></font>
<font color=#447700>! ICE MULTIPLICATION FROM SNOW<a name='15446'></font>
<font color=#447700>!   Lo and Passarelli 82 / Willis and Heymsfield 89 / Schuur and Rutledge 00b<a name='15447'></font>
<font color=#447700>!   using kfrag as fragmentation rate (s-1) / 500 microns as char mean diam for max snow mix ratio<a name='15448'></font>
<font color=#447700>!<a name='15449'></font>
      csmul(:) = 0.0<a name='15450'>
      qsmul(:) = 0.0<a name='15451'>
      <a name='15452'>
      IF ( isnwfrac /= 0 ) THEN<a name='15453'>
      do mgs = 1,ngscnt<a name='15454'>
       IF (temg(mgs) .gt. 265.0) THEN <font color=#447700>!{<a name='15455'></font>
        if (xdia(mgs,ls,1) .gt. 100.e-6 .and. xdia(mgs,ls,1) .lt. 2.0e-3) then  <font color=#447700>! equiv diameter 100microns to 2mm<a name='15456'></font>
<a name='15457'>
        tmp = rhoinv(mgs)*pi*xdn(mgs,ls)*cx(mgs,ls)*(500.e-6)**3<a name='15458'>
        qsmul(mgs) = Max( kfrag*( qx(mgs,ls) - tmp ) , 0.0 )<a name='15459'>
<a name='15460'>
        qsmul(mgs) = Min( qxmxd(mgs,li), qsmul(mgs) )<a name='15461'>
        csmul(mgs) = Min( cxmxd(mgs,li), rho0(mgs)*qsmul(mgs)/mfrag )<a name='15462'>
<a name='15463'>
        endif<a name='15464'>
       ENDIF <font color=#447700>!}<a name='15465'></font>
      enddo<a name='15466'>
      ENDIF<a name='15467'>
<a name='15468'>
<font color=#447700>!<a name='15469'></font>
<font color=#447700>!  frozen rain-rain interaction....<a name='15470'></font>
<font color=#447700>!<a name='15471'></font>
<font color=#447700>!<a name='15472'></font>
<font color=#447700>!<a name='15473'></font>
<font color=#447700>!<a name='15474'></font>
<font color=#447700>!  rain-ice interaction<a name='15475'></font>
<font color=#447700>!<a name='15476'></font>
<font color=#447700>!<a name='15477'></font>
      do mgs = 1,ngscnt<a name='15478'>
      qracif(mgs) = qraci(mgs)<a name='15479'>
      cracif(mgs) = craci(mgs)<a name='15480'>
<font color=#447700>!      ciacrf(mgs) = ciacr(mgs)<a name='15481'></font>
      end do<a name='15482'>
<font color=#447700>!<a name='15483'></font>
<font color=#447700>! <a name='15484'></font>
<font color=#447700>!  vapor to pristine ice crystals   UP<a name='15485'></font>
<font color=#447700>!<a name='15486'></font>
<font color=#447700>!<a name='15487'></font>
<font color=#447700>!<a name='15488'></font>
<font color=#447700>!  compute the nucleation rate<a name='15489'></font>
<font color=#447700>!<a name='15490'></font>
<font color=#447700>!     do mgs = 1,ngscnt<a name='15491'></font>
<font color=#447700>!     idqis = 0<a name='15492'></font>
<font color=#447700>!     if ( ssi(mgs) .gt. 1.0 ) idqis = 1<a name='15493'></font>
<font color=#447700>!     fiinit(mgs) = (felv(mgs)**2)/(cp*rw)<a name='15494'></font>
<font color=#447700>!     dqisdt(mgs) = (qx(mgs,lv)-qis(mgs))/<a name='15495'></font>
<font color=#447700>!    &gt;  (1.0 + fiinit(mgs)*qis(mgs)/tsqr(mgs))<a name='15496'></font>
<font color=#447700>!     qidsvp(mgs) = dqisdt(mgs)<a name='15497'></font>
<font color=#447700>!     cnnt = min(cnit*exp(-temcg(mgs)*bta1),1.0e+09)<a name='15498'></font>
<font color=#447700>!     qiint(mgs) = <a name='15499'></font>
<font color=#447700>!    &gt;  il5(mgs)*idqis*(1.0/dtp)<a name='15500'></font>
<font color=#447700>!    &lt;  *min((6.88e-13)*cnnt/rho0(mgs), 0.25*dqisdt(mgs)) <a name='15501'></font>
<font color=#447700>!     end do<a name='15502'></font>
<font color=#447700>!<a name='15503'></font>
<font color=#447700>!  Meyers et al. (1992; JAS) and Ferrier (1994) primary ice nucleation<a name='15504'></font>
<font color=#447700>!<a name='15505'></font>
      cmassin = cimasn  <font color=#447700>! 6.88e-13<a name='15506'></font>
      do mgs = 1,ngscnt<a name='15507'>
      qiint(mgs) = 0.0<a name='15508'>
      ciint(mgs) = 0.0<a name='15509'>
      qicicnt(mgs) = 0.0<a name='15510'>
      cicint(mgs) = 0.0<a name='15511'>
      qipipnt(mgs) = 0.0<a name='15512'>
      cipint(mgs) = 0.0<a name='15513'>
      ccitmp = 0.0<a name='15514'>
      IF ( icenucopt == 1 .or. icenucopt == -10 .or. icenucopt == -11 ) THEN<a name='15515'>
      if ( ( temg(mgs) .lt. 268.15 .or.  &amp;<a name='15516'>
<font color=#447700>!     : ( imeyers5 .and. temg(mgs) .lt.  273.0) ) .and.    &amp;<a name='15517'></font>
     &amp; ( imeyers5 .and. temg(mgs) .lt.  272.0 .and. temgkm2(mgs) .lt. tfr) ) .and.    &amp;<a name='15518'>
     &amp;    ciintmx .gt. (cx(mgs,li)+ccitmp)  &amp;<a name='15519'>
<font color=#447700>!     :    .and. cninm(mgs) .gt. 0.   &amp;<a name='15520'></font>
     &amp;     ) then<a name='15521'>
      fiinit(mgs) = (felv(mgs)**2)/(cp*rw)<a name='15522'>
      dqisdt(mgs) = (qx(mgs,lv)-qis(mgs))/   &amp;<a name='15523'>
     &amp;  (1.0 + fiinit(mgs)*qis(mgs)/tsqr(mgs))<a name='15524'>
<font color=#447700>!      qidsvp(mgs) = dqisdt(mgs)<a name='15525'></font>
      idqis = 0<a name='15526'>
      if ( ssi(mgs) .gt. 1.0 ) THEN<a name='15527'>
      idqis = 1 <a name='15528'>
      dzfacp = max( float(kgsp(mgs)-kgs(mgs)), 0.0 )<a name='15529'>
      dzfacm = max( float(kgs(mgs)-kgsm(mgs)), 0.0 )<a name='15530'>
      qiint(mgs) =   &amp;<a name='15531'>
     &amp;  idqis*il5(mgs)   &amp;<a name='15532'>
     &amp;  *(cmassin/rho0(mgs))   &amp;<a name='15533'>
     &amp;  *max(0.0,wvel(mgs))   &amp;<a name='15534'>
     &amp;  *max((cninp(mgs)-cninm(mgs)),0.0)/gz(igs(mgs),jgs,kgs(mgs))   &amp;<a name='15535'>
     &amp;  /((dzfacp+dzfacm))<a name='15536'>
<a name='15537'>
      qiint(mgs) = min(qiint(mgs), max(0.25*dqisdt(mgs),0.0)) <a name='15538'>
      ciint(mgs) = qiint(mgs)*rho0(mgs)/cmassin<a name='15539'>
<font color=#447700>!<a name='15540'></font>
<font color=#447700>! limit new crystals so it does not increase the current concentration<a name='15541'></font>
<font color=#447700>!  above ciintmx 20,000 per liter (2.e7 per m**3)<a name='15542'></font>
<font color=#447700>!<a name='15543'></font>
<font color=#447700>!      ciintmx = 1.e9<a name='15544'></font>
<font color=#447700>!      ciintmx = 1.e9<a name='15545'></font>
      IF ( icenucopt /= -10 ) THEN<a name='15546'>
      <a name='15547'>
        IF ( lcin &gt; 1 ) THEN<a name='15548'>
          ciint(mgs) = Min(ciint(mgs), ccin(mgs))<a name='15549'>
          ccin(mgs) = ccin(mgs) - ciint(mgs)<a name='15550'>
          qiint(mgs) = ciint(mgs)*cmassin/rho0(mgs)<a name='15551'>
        ELSEIF ( lcina &gt; 1 ) THEN<a name='15552'>
          ciint(mgs) = Max(0.0, Min( ciint(mgs), Min( cnina(mgs), ciintmx ) - cina(mgs) ))<a name='15553'>
          qiint(mgs) = ciint(mgs)*cmassin/rho0(mgs)<a name='15554'>
      <a name='15555'>
        ELSEIF ( icenucopt == 1 .and. ciint(mgs) .gt. Max(0.0, ciintmx - cx(mgs,li) - ccitmp )*dtpinv  ) THEN<a name='15556'>
          ciint(mgs) = Max(0.0, ciintmx - (cx(mgs,li)) )*dtpinv <a name='15557'>
          qiint(mgs) = ciint(mgs)*cmassin/rho0(mgs)<a name='15558'>
<a name='15559'>
        ELSEIF ( icenucopt == -11 .and. dtp*ciint(mgs) .gt. ( cnina(mgs) - (cx(mgs,li) - ccitmp))) THEN<a name='15560'>
          ciint(mgs) = Max(0.0,  cnina(mgs) - (cx(mgs,li)+ccitmp)*dtpinv )<a name='15561'>
          qiint(mgs) = ciint(mgs)*cmassin/rho0(mgs)<a name='15562'>
<a name='15563'>
        ENDIF<a name='15564'>
      ENDIF<a name='15565'>
      <a name='15566'>
      end if<a name='15567'>
      endif<a name='15568'>
<a name='15569'>
      ELSEIF ( icenucopt == 2 .or. icenucopt == -1 .or. icenucopt == -2 ) THEN<a name='15570'>
      <a name='15571'>
        IF ( ( temg(mgs) .lt. 268.15 .and. ssw(mgs) &gt; 1.0 ) .or. ssi(mgs) &gt; 1.25 ) THEN<a name='15572'>
          IF ( lcin &gt; 1 ) THEN<a name='15573'>
           ciint(mgs) = Min(cnina(mgs), ccin(mgs))<a name='15574'>
           ciint(mgs) = Min( ciint(mgs), Max(0.0, ciintmx - (cx(mgs,li) - ccitmp) ) ) <font color=#447700>! do not initiate ice beyond concentration of ciintmx<a name='15575'></font>
           ccin(mgs) = ccin(mgs) - ciint(mgs)<a name='15576'>
           ciint(mgs) = ciint(mgs)*dtpinv <font color=#447700>! convert total initiation to a rate<a name='15577'></font>
          ELSE<a name='15578'>
           ciint(mgs) = Max( 0.0, cnina(mgs) - cina(mgs) )*dtpinv<a name='15579'>
          ENDIF<a name='15580'>
          qiint(mgs) = ciint(mgs)*cmassin/rho0(mgs)<a name='15581'>
<a name='15582'>
          fiinit(mgs) = (felv(mgs)**2)/(cp*rw)<a name='15583'>
          dqisdt(mgs) = (qx(mgs,lv)-qis(mgs))/(1.0 + fiinit(mgs)*qis(mgs)/tsqr(mgs))<a name='15584'>
          qiint(mgs) = min(qiint(mgs), max(0.25*dqisdt(mgs),0.0))<a name='15585'>
          ciint(mgs) = qiint(mgs)*rho0(mgs)/cmassin<a name='15586'>
        ENDIF<a name='15587'>
      <a name='15588'>
      <a name='15589'>
      <a name='15590'>
      ELSEIF ( icenucopt == 3 ) THEN<a name='15591'>
        IF (  temg(mgs) .lt. 268.15 ) THEN<a name='15592'>
          IF ( lcin &gt; 1 ) THEN<a name='15593'>
           ciint(mgs) = Min(cnina(mgs), ccin(mgs))<a name='15594'>
           ciint(mgs) = Min( ciint(mgs), Max(0.0, ciintmx - (cx(mgs,li) + ccitmp) ) ) <font color=#447700>! do not initiate ice beyond concentration of ciintmx<a name='15595'></font>
           ccin(mgs) = ccin(mgs) - ciint(mgs)<a name='15596'>
           ciint(mgs) = ciint(mgs)*dtpinv <font color=#447700>! convert total initiation to a rate<a name='15597'></font>
          ELSE<a name='15598'>
           ciint(mgs) = Max( 0.0, cnina(mgs) - cina(mgs) )*dtpinv<a name='15599'>
          ENDIF<a name='15600'>
          qiint(mgs) = ciint(mgs)*cmassin/rho0(mgs)<a name='15601'>
        ENDIF<a name='15602'>
<a name='15603'>
      ENDIF<a name='15604'>
<font color=#447700>!<a name='15605'></font>
      if ( xplate(mgs) .eq. 1 ) then<a name='15606'>
      qipipnt(mgs) = qiint(mgs)<a name='15607'>
      cipint(mgs) = ciint(mgs)<a name='15608'>
      end if<a name='15609'>
<font color=#447700>!<a name='15610'></font>
      if ( xcolmn(mgs) .eq. 1 ) then<a name='15611'>
      qicicnt(mgs) = qiint(mgs)<a name='15612'>
      cicint(mgs) = ciint(mgs)<a name='15613'>
      end if<a name='15614'>
<font color=#447700>!<a name='15615'></font>
<font color=#447700>!     qipipnt(mgs) = 0.0<a name='15616'></font>
<font color=#447700>!     qicicnt(mgs) = qiint(mgs)<a name='15617'></font>
<font color=#447700>!<a name='15618'></font>
      end do<a name='15619'>
<font color=#447700>!<a name='15620'></font>
<font color=#447700>! <a name='15621'></font>
<a name='15622'>
<font color=#447700>!<a name='15623'></font>
<font color=#447700>!  vapor to cloud droplets   UP<a name='15624'></font>
<font color=#447700>!<a name='15625'></font>
      if (ndebug .gt. 0 ) write(0,*) 'dbg = 8'<a name='15626'>
<font color=#447700>!<a name='15627'></font>
<font color=#447700>!<a name='15628'></font>
      if (ndebug .gt. 0 ) write(0,*) 'Collection: set 3-component'<a name='15629'>
<font color=#447700>!<a name='15630'></font>
<font color=#447700>!  time for riming....<a name='15631'></font>
<font color=#447700>!<a name='15632'></font>
<font color=#447700>!     rimtim = 240.0<a name='15633'></font>
<font color=#447700>!     dtrim = rimtim<a name='15634'></font>
<font color=#447700>!     xacrtim  = 120.0<a name='15635'></font>
<font color=#447700>!     tranfr = 0.50<a name='15636'></font>
<font color=#447700>!     tranfw = 0.50<a name='15637'></font>
<font color=#447700>!<a name='15638'></font>
<font color=#447700>!  coefficients for riming<a name='15639'></font>
<font color=#447700>!<a name='15640'></font>
<font color=#447700>!     rimc1 = 300.00<a name='15641'></font>
<font color=#447700>!     rimc2 = 0.44<a name='15642'></font>
<font color=#447700>!<a name='15643'></font>
<font color=#447700>! <a name='15644'></font>
<font color=#447700>!  zero som arrays<a name='15645'></font>
<font color=#447700>!<a name='15646'></font>
<font color=#447700>!<a name='15647'></font>
      do mgs = 1,ngscnt<a name='15648'>
      qrshr(mgs) = 0.0<a name='15649'>
      qsshrp(mgs) = 0.0<a name='15650'>
      qhshrp(mgs) = 0.0<a name='15651'>
      end do<a name='15652'>
<font color=#447700>!<a name='15653'></font>
<font color=#447700>!<a name='15654'></font>
<font color=#447700>!  first sum all of the shed rain<a name='15655'></font>
<font color=#447700>!<a name='15656'></font>
<font color=#447700>!<a name='15657'></font>
      do mgs = 1,ngscnt<a name='15658'>
      qrshr(mgs) = qsshr(mgs) + qhshr(mgs) + qhlshr(mgs)<a name='15659'>
      crshr(mgs) = chshrr(mgs)/rzxh(mgs) + chlshrr(mgs)/rzxhl(mgs)<a name='15660'>
      IF ( ipconc .ge. 3 ) THEN<a name='15661'>
<font color=#447700>!       crshr(mgs) = Max(crshr(mgs), rho0(mgs)*qrshr(mgs)/(xdn(mgs,lr)*vr1mm) )<a name='15662'></font>
      ENDIF<a name='15663'>
      end do <a name='15664'>
<font color=#447700>!<a name='15665'></font>
<font color=#447700>!<a name='15666'></font>
<font color=#447700>!<a name='15667'></font>
<a name='15668'>
<font color=#447700>!<a name='15669'></font>
<font color=#447700>!<a name='15670'></font>
<font color=#447700>!<a name='15671'></font>
<font color=#447700>!<a name='15672'></font>
      IF ( ipconc .ge. 1 ) THEN<a name='15673'>
<font color=#447700>!<a name='15674'></font>
<font color=#447700>!<a name='15675'></font>
<font color=#447700>!  concentration production terms<a name='15676'></font>
<font color=#447700>!<a name='15677'></font>
<font color=#447700>!  YYY<a name='15678'></font>
<font color=#447700>!<a name='15679'></font>
<font color=#447700>!<a name='15680'></font>
<font color=#447700>!       DO mgs = 1,ngscnt<a name='15681'></font>
       pccwi(:) = 0.0<a name='15682'>
       pccwd(:) = 0.0<a name='15683'>
       pccii(:) = 0.0<a name='15684'>
       pccin(:) = 0.0<a name='15685'>
       pccid(:) = 0.0<a name='15686'>
       pcisi(:) = 0.0<a name='15687'>
       pcisd(:) = 0.0<a name='15688'>
       pcrwi(:) = 0.0<a name='15689'>
       pcrwd(:) = 0.0<a name='15690'>
       pcswi(:) = 0.0<a name='15691'>
       pcswd(:) = 0.0<a name='15692'>
       pchwi(:) = 0.0<a name='15693'>
       pchwd(:) = 0.0<a name='15694'>
       pchli(:) = 0.0<a name='15695'>
       pchld(:) = 0.0<a name='15696'>
<font color=#447700>!       ENDDO<a name='15697'></font>
<font color=#447700>!<a name='15698'></font>
<font color=#447700>!  Cloud ice<a name='15699'></font>
<font color=#447700>!<a name='15700'></font>
<font color=#447700>!      IF ( ipconc .ge. 1 ) THEN<a name='15701'></font>
<a name='15702'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='15703'>
      IF ( ffrzs &lt; 1.0 ) THEN<a name='15704'>
      do mgs = 1,ngscnt<a name='15705'>
      pccii(mgs) =   &amp;<a name='15706'>
     &amp;   il5(mgs)*cicint(mgs)  &amp;<a name='15707'>
     &amp;  +il5(mgs)*(cwfrzc(mgs)+cwctfzc(mgs)   &amp;<a name='15708'>
     &amp;  +cicichr(mgs))   &amp;<a name='15709'>
     &amp;  +chmul1(mgs)   &amp;<a name='15710'>
     &amp;  +chlmul1(mgs)    &amp;<a name='15711'>
     &amp;  + csplinter(mgs) + csplinter2(mgs)   &amp;<a name='15712'>
     &amp;  +csmul(mgs)<a name='15713'>
     <a name='15714'>
       pccii(mgs) = pccii(mgs)*(1.0 - ffrzs)<a name='15715'>
       <a name='15716'>
<font color=#447700>!     &gt;  + nsplinter*(crfrzf(mgs) + crfrz(mgs))<a name='15717'></font>
      pccid(mgs) =   &amp;<a name='15718'>
     &amp;   il5(mgs)*(-cscni(mgs) - cscnvi(mgs) &amp; <font color=#447700>! - cwaci(mgs)   &amp;<a name='15719'></font>
     &amp;  -craci(mgs)    &amp;<a name='15720'>
     &amp;  -csaci(mgs)   &amp;<a name='15721'>
     &amp;  -chaci(mgs) - chlaci(mgs)   &amp;<a name='15722'>
     &amp;  -chcni(mgs))   &amp;<a name='15723'>
     &amp;  +il5(mgs)*cisbv(mgs)   &amp;<a name='15724'>
     &amp;  -(1.-il5(mgs))*cimlr(mgs)<a name='15725'>
<a name='15726'>
      pccin(mgs) = ciint(mgs)<a name='15727'>
      <a name='15728'>
<a name='15729'>
      end do<a name='15730'>
      ENDIF <font color=#447700>! ffrzs<a name='15731'></font>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='15732'>
      do mgs = 1,ngscnt<a name='15733'>
      <a name='15734'>
<font color=#447700>!      qiint(mgs) = 0.0<a name='15735'></font>
<font color=#447700>!      cicint(mgs) = 0.0<a name='15736'></font>
<font color=#447700>!      qicicnt(mgs) = 0.0<a name='15737'></font>
      <a name='15738'>
      pccii(mgs) =   &amp;<a name='15739'>
     &amp;   il5(mgs)*cicint(mgs)   &amp;<a name='15740'>
     &amp;  +il5(mgs)*(cwfrzc(mgs)+cwctfzc(mgs)   &amp;<a name='15741'>
     &amp;  +cicichr(mgs))   &amp;<a name='15742'>
     &amp;  +chmul1(mgs)   &amp;<a name='15743'>
     &amp;  +chlmul1(mgs)    &amp;<a name='15744'>
     &amp;  + csplinter(mgs) + csplinter2(mgs)   &amp;<a name='15745'>
     &amp;  +csmul(mgs)<a name='15746'>
     <a name='15747'>
       pccii(mgs) = pccii(mgs)*(1. - ffrzs)<a name='15748'>
      pccid(mgs) =   &amp;<a name='15749'>
<font color=#447700>!     &amp;   il5(mgs)*(-cscni(mgs) - cscnvi(mgs) &amp; ! - cwaci(mgs)   &amp;<a name='15750'></font>
<font color=#447700>!     &amp;  -craci(mgs)    &amp;<a name='15751'></font>
<font color=#447700>!     &amp;  -csaci(mgs)   &amp;<a name='15752'></font>
<font color=#447700>!     &amp;  -chaci(mgs) - chlaci(mgs)   &amp;<a name='15753'></font>
<font color=#447700>!     &amp;  -chcni(mgs))   &amp;<a name='15754'></font>
     &amp;  +il5(mgs)*cisbv(mgs)   &amp;<a name='15755'>
     &amp;  -(1.-il5(mgs))*cimlr(mgs)<a name='15756'>
<a name='15757'>
      pccin(mgs) = ciint(mgs)<a name='15758'>
<a name='15759'>
      end do<a name='15760'>
      ENDIF <font color=#447700>! warmonly<a name='15761'></font>
<a name='15762'>
      <a name='15763'>
<font color=#447700>!      ENDIF ! ( ipconc .ge. 1 )<a name='15764'></font>
<font color=#447700>!<a name='15765'></font>
<font color=#447700>!  Cloud water<a name='15766'></font>
<font color=#447700>!<a name='15767'></font>
      IF ( ipconc .ge. 2 ) THEN<a name='15768'>
      <a name='15769'>
      do mgs = 1,ngscnt<a name='15770'>
      pccwi(mgs) =  (0.0) <font color=#447700>! + (1-il5(mgs))*(-cirmlw(mgs))<a name='15771'></font>
      <a name='15772'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='15773'>
      pccwd(mgs) =    &amp;<a name='15774'>
     &amp;  - cautn(mgs) +   &amp;<a name='15775'>
     &amp;  il5(mgs)*(-ciacw(mgs)-cwfrzp(mgs)-cwctfzp(mgs)   &amp;<a name='15776'>
     &amp;  -cwfrzc(mgs)-cwctfzc(mgs)   &amp;<a name='15777'>
     &amp;   )   &amp;<a name='15778'>
     &amp;  -cracw(mgs) -csacw(mgs)  -chacw(mgs) - chlacw(mgs)<a name='15779'>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='15780'>
      pccwd(mgs) =    &amp;<a name='15781'>
     &amp;  - cautn(mgs) +   &amp;<a name='15782'>
     &amp;  il5(mgs)*(  &amp;<a name='15783'>
     &amp; -ciacw(mgs)-cwfrzp(mgs)-cwctfzp(mgs)   &amp;<a name='15784'>
     &amp;  -cwfrzc(mgs)-cwctfzc(mgs)   &amp;<a name='15785'>
     &amp;   )   &amp;<a name='15786'>
     &amp;  -cracw(mgs) -chacw(mgs) -chlacw(mgs) <a name='15787'>
      ELSE<a name='15788'>
      <a name='15789'>
<font color=#447700>!       tmp3d(igs(mgs),jy,kgs(mgs)) = crcnw(mgs)<a name='15790'></font>
<a name='15791'>
<font color=#447700>!       cracw(mgs) = 0.0 ! turn off accretion<a name='15792'></font>
<font color=#447700>!       qracw(mgs) = 0.0<a name='15793'></font>
<font color=#447700>!       crcev(mgs) = 0.0 ! turn off evap<a name='15794'></font>
<font color=#447700>!       qrcev(mgs) = 0.0 ! turn off evap<a name='15795'></font>
<font color=#447700>!       cracr(mgs) = 0.0 ! turn off self collection<a name='15796'></font>
       <a name='15797'>
       <a name='15798'>
<font color=#447700>!       cautn(mgs) = 0.0 <a name='15799'></font>
<font color=#447700>!       crcnw(mgs) = 0.0<a name='15800'></font>
<font color=#447700>!       qrcnw(mgs) = 0.0<a name='15801'></font>
<a name='15802'>
      pccwd(mgs) =    &amp;<a name='15803'>
     &amp;  - cautn(mgs) -cracw(mgs)<a name='15804'>
      ENDIF<a name='15805'>
<a name='15806'>
<a name='15807'>
      IF ( -pccwd(mgs)*dtp .gt. cx(mgs,lc) ) THEN<a name='15808'>
<font color=#447700>!       write(0,*) 'OUCH! pccwd(mgs)*dtp .gt. ccw(mgs) ',pccwd(mgs),cx(mgs,lc)<a name='15809'></font>
<font color=#447700>!       write(0,*) 'qc = ',qx(mgs,lc)<a name='15810'></font>
<font color=#447700>!       write(0,*) -ciacw(mgs)-cwfrzp(mgs)-cwctfzp(mgs)-cwfrzc(mgs)-cwctfzc(mgs)<a name='15811'></font>
<font color=#447700>!       write(0,*)  -cracw(mgs) -csacw(mgs)  -chacw(mgs)<a name='15812'></font>
<font color=#447700>!       write(0,*) - cautn(mgs)<a name='15813'></font>
<a name='15814'>
       frac = -cx(mgs,lc)/(pccwd(mgs)*dtp)<a name='15815'>
       pccwd(mgs) = -cx(mgs,lc)/dtp<a name='15816'>
<a name='15817'>
        ciacw(mgs)   = frac*ciacw(mgs)<a name='15818'>
        cwfrzp(mgs)  = frac*cwfrzp(mgs)<a name='15819'>
        cwctfzp(mgs) = frac*cwctfzp(mgs)<a name='15820'>
        cwfrzc(mgs)  = frac*cwfrzc(mgs)<a name='15821'>
        cwctfzc(mgs) = frac*cwctfzc(mgs)<a name='15822'>
        cwctfz(mgs) = frac*cwctfz(mgs)<a name='15823'>
        cracw(mgs)   = frac*cracw(mgs)<a name='15824'>
        csacw(mgs)   = frac*csacw(mgs)<a name='15825'>
        chacw(mgs)   = frac*chacw(mgs)<a name='15826'>
        cautn(mgs)   = frac*cautn(mgs)<a name='15827'>
       <a name='15828'>
        pccii(mgs) = pccii(mgs) - (1.-frac)*il5(mgs)*(cwfrzc(mgs)+cwctfzc(mgs))*(1. - ffrzs)<a name='15829'>
        IF ( lhl .gt. 1 ) chlacw(mgs)   = frac*chlacw(mgs)<a name='15830'>
<a name='15831'>
<font color=#447700>!       STOP<a name='15832'></font>
      ENDIF<a name='15833'>
<a name='15834'>
      end do<a name='15835'>
<a name='15836'>
      ENDIF <font color=#447700>! ipconc<a name='15837'></font>
<a name='15838'>
<font color=#447700>!<a name='15839'></font>
<font color=#447700>!  Rain<a name='15840'></font>
<font color=#447700>!<a name='15841'></font>
      IF ( ipconc .ge. 3 ) THEN<a name='15842'>
<a name='15843'>
      do mgs = 1,ngscnt<a name='15844'>
<a name='15845'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='15846'>
      pcrwi(mgs) = &amp;<a name='15847'>
<font color=#447700>!     &gt;   cracw(mgs) +    &amp;<a name='15848'></font>
     &amp;   crcnw(mgs)   &amp;<a name='15849'>
     &amp;  +(1-il5(mgs))*(   &amp;<a name='15850'>
     &amp;    -chmlrr(mgs)/rzxh(mgs)   &amp;<a name='15851'>
     &amp;    -chlmlrr(mgs)/rzxhl(mgs)   &amp;<a name='15852'>
     &amp;    -csmlr(mgs)/rzxs(mgs)     &amp;<a name='15853'>
     &amp;   - cimlr(mgs) )   &amp;<a name='15854'>
     &amp;  -crshr(mgs)             <font color=#447700>!null at this point when wet snow/graupel included<a name='15855'></font>
      pcrwd(mgs) =   &amp;<a name='15856'>
     &amp;   il5(mgs)*(-ciacr(mgs) - crfrz(mgs) ) &amp; <font color=#447700>! - cipacr(mgs))<a name='15857'></font>
<font color=#447700>!     &gt;  -csacr(mgs)   &amp;<a name='15858'></font>
     &amp;  - chacr(mgs) - chlacr(mgs)   &amp;<a name='15859'>
     &amp;  +crcev(mgs)   &amp;<a name='15860'>
     &amp;  - cracr(mgs)<a name='15861'>
<font color=#447700>!     &gt;  -il5(mgs)*ciracr(mgs)<a name='15862'></font>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='15863'>
       pcrwi(mgs) = &amp;<a name='15864'>
     &amp;   crcnw(mgs)   &amp;<a name='15865'>
     &amp;  +(1-il5(mgs))*(   &amp;<a name='15866'>
     &amp;    -chmlrr(mgs)/rzxh(mgs)    &amp;<a name='15867'>
     &amp;    -chlmlrr(mgs)/rzxhl(mgs)   &amp;<a name='15868'>
     &amp;    -csmlr(mgs)     &amp;<a name='15869'>
     &amp;   - cimlr(mgs) )   &amp;<a name='15870'>
     &amp;  -crshr(mgs)             <font color=#447700>!null at this point when wet snow/graupel included<a name='15871'></font>
      pcrwd(mgs) =   &amp;<a name='15872'>
     &amp;   il5(mgs)*( - crfrz(mgs) ) &amp; <font color=#447700>! - cipacr(mgs))<a name='15873'></font>
     &amp;  - chacr(mgs)    &amp;<a name='15874'>
     &amp;  - chlacr(mgs)    &amp;<a name='15875'>
     &amp;  +crcev(mgs)   &amp;<a name='15876'>
     &amp;  - cracr(mgs)<a name='15877'>
      ELSE<a name='15878'>
      pcrwi(mgs) =   &amp;<a name='15879'>
     &amp;   crcnw(mgs)<a name='15880'>
      pcrwd(mgs) =   &amp;<a name='15881'>
     &amp;  +crcev(mgs)   &amp;<a name='15882'>
     &amp;  - cracr(mgs)<a name='15883'>
<a name='15884'>
<font color=#447700>!        tmp3d(igs(mgs),jy,kgs(mgs)) = vtxbar(mgs,lr,1) ! crcnw(mgs) ! (pcrwi(mgs) + pcrwd(mgs))<a name='15885'></font>
<font color=#447700>!        pcrwi(mgs) = 0.0<a name='15886'></font>
<font color=#447700>!        pcrwd(mgs) = 0.0<a name='15887'></font>
<font color=#447700>!        qrcnw(mgs) = 0.0<a name='15888'></font>
<a name='15889'>
      ENDIF<a name='15890'>
<a name='15891'>
<a name='15892'>
      frac = 0.0<a name='15893'>
      IF ( -pcrwd(mgs)*dtp .gt. cx(mgs,lr) ) THEN<a name='15894'>
<font color=#447700>!       write(0,*) 'OUCH! pcrwd(mgs)*dtp .gt. crw(mgs) ',pcrwd(mgs)*dtp,cx(mgs,lr),mgs,igs(mgs),kgs(mgs)<a name='15895'></font>
<font color=#447700>!       write(0,*) -ciacr(mgs)<a name='15896'></font>
<font color=#447700>!       write(0,*) -crfrz(mgs)<a name='15897'></font>
<font color=#447700>!       write(0,*) -chacr(mgs)<a name='15898'></font>
<font color=#447700>!       write(0,*)  crcev(mgs)<a name='15899'></font>
<font color=#447700>!       write(0,*)  -cracr(mgs)<a name='15900'></font>
<a name='15901'>
       frac =  -cx(mgs,lr)/(pcrwd(mgs)*dtp)<a name='15902'>
       pcrwd(mgs) = -cx(mgs,lr)/dtp<a name='15903'>
<a name='15904'>
        ciacr(mgs) = frac*ciacr(mgs)<a name='15905'>
        ciacrf(mgs) = frac*ciacrf(mgs)<a name='15906'>
        ciacrs(mgs) = frac*ciacrs(mgs)<a name='15907'>
        crfrz(mgs) = frac*crfrz(mgs)<a name='15908'>
        crfrzf(mgs) = frac*crfrzf(mgs)<a name='15909'>
        crfrzs(mgs) = frac*crfrzs(mgs)<a name='15910'>
        chacr(mgs) = frac*chacr(mgs)<a name='15911'>
        crcev(mgs) = frac*crcev(mgs)<a name='15912'>
        cracr(mgs) = frac*cracr(mgs)<a name='15913'>
<a name='15914'>
<font color=#447700>!       STOP<a name='15915'></font>
      ENDIF<a name='15916'>
<a name='15917'>
      end do<a name='15918'>
<a name='15919'>
      ENDIF<a name='15920'>
<a name='15921'>
<a name='15922'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='15923'>
<a name='15924'>
<font color=#447700>!<a name='15925'></font>
<font color=#447700>!  Snow<a name='15926'></font>
<font color=#447700>!<a name='15927'></font>
      IF ( ipconc .ge. 4 ) THEN <font color=#447700>!<a name='15928'></font>
<a name='15929'>
      do mgs = 1,ngscnt<a name='15930'>
      pcswi(mgs) =   &amp;<a name='15931'>
     &amp;   il5(mgs)*(cscnis(mgs) + cscnvis(mgs) )    &amp;<a name='15932'>
     &amp;  + cscnh(mgs)<a name='15933'>
      <a name='15934'>
      IF (  ffrzs &gt; 0.0 ) THEN<a name='15935'>
       pcswi(mgs) =  pcswi(mgs) + ffrzs* (  &amp;<a name='15936'>
     &amp;   il5(mgs)*cicint(mgs)   &amp;<a name='15937'>
     &amp;  +il5(mgs)*(cwfrzc(mgs)+cwctfzc(mgs)   &amp;<a name='15938'>
     &amp;  +cicichr(mgs))  &amp;<a name='15939'>
     &amp;  +chmul1(mgs)   &amp;<a name='15940'>
     &amp;  +chlmul1(mgs)    &amp;<a name='15941'>
     &amp;  + csplinter(mgs) + csplinter2(mgs)   &amp;<a name='15942'>
     &amp;  +csmul(mgs) )<a name='15943'>
      ENDIF<a name='15944'>
<a name='15945'>
      <a name='15946'>
      IF ( ess0 &lt; 0.0 ) THEN<a name='15947'>
         csacs(mgs) = Max(0.0, csacs(mgs) - (ifrzs)*(crfrzs(mgs) + ciacrs(mgs)))<a name='15948'>
      ENDIF<a name='15949'>
      <a name='15950'>
      pcswd(mgs) = &amp;<a name='15951'>
<font color=#447700>!     :  cracs(mgs)     &amp;<a name='15952'></font>
     &amp;  -chacs(mgs) - chlacs(mgs)   &amp;<a name='15953'>
     &amp;  -chcns(mgs)   &amp;<a name='15954'>
     &amp;  +(1-il5(mgs))*csmlr(mgs) + csshr(mgs) &amp; <font color=#447700>! + csshrp(mgs)<a name='15955'></font>
<font color=#447700>!     &gt;  +il5(mgs)*(cssbv(mgs))   &amp;<a name='15956'></font>
     &amp;   + cssbv(mgs)   &amp;<a name='15957'>
     &amp;  - csacs(mgs)<a name='15958'>
<a name='15959'>
      frac = 0.0<a name='15960'>
      IF ( imixedphase == 0 ) THEN<a name='15961'>
        IF ( cx(mgs,ls) + dtp*(pcswi(mgs) + pcswd(mgs)) &lt; 0.0 ) THEN<a name='15962'>
         frac = (-cx(mgs,ls) + pcswi(mgs)*dtp)/(pcswd(mgs)*dtp)<a name='15963'>
         <a name='15964'>
           pqswd(mgs) = frac*pqswd(mgs)<a name='15965'>
           <a name='15966'>
           chacs(mgs)  = frac*chacs(mgs) <a name='15967'>
           chlacs(mgs) = frac*chlacs(mgs)<a name='15968'>
           chcns(mgs)  = frac*chcns(mgs) <a name='15969'>
           csmlr(mgs)  = frac*csmlr(mgs) <a name='15970'>
           csshr(mgs)  = frac*csshr(mgs) <a name='15971'>
           cssbv(mgs)  = frac*cssbv(mgs) <a name='15972'>
           csacs(mgs)  = frac*csacs(mgs)<a name='15973'>
      <a name='15974'>
        ENDIF<a name='15975'>
      ENDIF<a name='15976'>
<a name='15977'>
<a name='15978'>
      <a name='15979'>
      pccii(mgs) =  pccii(mgs) &amp;<a name='15980'>
     &amp;  + (1. - ifrzs)*crfrzs(mgs) &amp;<a name='15981'>
     &amp;  + (1. - ifrzs)*ciacrs(mgs)<a name='15982'>
<a name='15983'>
      pcswi(mgs) =  pcswi(mgs) &amp;<a name='15984'>
     &amp;  + (ifrzs)*crfrzs(mgs) &amp;<a name='15985'>
     &amp;  + (ifrzs)*ciacrs(mgs)<a name='15986'>
<a name='15987'>
      end do<a name='15988'>
<a name='15989'>
      ENDIF<a name='15990'>
<a name='15991'>
<font color=#447700>!<a name='15992'></font>
<font color=#447700>!  Graupel<a name='15993'></font>
<font color=#447700>!<a name='15994'></font>
      IF ( ipconc .ge. 5 ) THEN <font color=#447700>!<a name='15995'></font>
      do mgs = 1,ngscnt<a name='15996'>
      pchwi(mgs) =   &amp;<a name='15997'>
     &amp;  +ifrzg*(crfrzf(mgs)   &amp;<a name='15998'>
     &amp; +il5(mgs)*(ciacrf(mgs) ))    &amp;<a name='15999'>
     &amp; + chcnsh(mgs) + chcnih(mgs) + chcnhl(mgs)<a name='16000'>
<a name='16001'>
      pchwd(mgs) =   &amp;<a name='16002'>
     &amp;  (1-il5(mgs))*chmlr(mgs) &amp;<a name='16003'>
<font color=#447700>!     &gt;  + il5(mgs)*chsbv(mgs)   &amp;<a name='16004'></font>
     &amp;  + chsbv(mgs)   &amp;<a name='16005'>
     &amp;  - il5(mgs)*chlcnh(mgs) &amp;<a name='16006'>
     &amp;  - cscnh(mgs)<a name='16007'>
      end do<a name='16008'>
<font color=#447700>!<a name='16009'></font>
<a name='16010'>
<font color=#447700>!<a name='16011'></font>
<font color=#447700>!  Hail<a name='16012'></font>
<font color=#447700>!<a name='16013'></font>
      IF ( lhl .gt. 1 ) THEN <font color=#447700>!<a name='16014'></font>
      do mgs = 1,ngscnt<a name='16015'>
      pchli(mgs) = (1.0-ifrzg)*(crfrzf(mgs) +il5(mgs)*(ciacrf(mgs) ))  &amp;<a name='16016'>
     &amp; + chlcnh(mgs) *rzxhlh(mgs)<a name='16017'>
<a name='16018'>
      pchld(mgs) =   &amp;<a name='16019'>
     &amp;  (1-il5(mgs))*chlmlr(mgs)   &amp;<a name='16020'>
<font color=#447700>!     &gt;  + il5(mgs)*chlsbv(mgs)   &amp;<a name='16021'></font>
     &amp;  + chlsbv(mgs) - chcnhl(mgs)<a name='16022'>
      <a name='16023'>
<font color=#447700>!      IF ( pchli(mgs) .ne. 0. .or. pchld(mgs) .ne. 0 ) THEN<a name='16024'></font>
<font color=#447700>!       write(0,*) 'dr: pchli,pchld = ', pchli(mgs),pchld(mgs), igs(mgs),kgs(mgs)<a name='16025'></font>
<font color=#447700>!      ENDIF<a name='16026'></font>
      end do<a name='16027'>
      <a name='16028'>
      ENDIF<a name='16029'>
<font color=#447700>!<a name='16030'></font>
<a name='16031'>
      ENDIF <font color=#447700>! (ipconc .ge. 5 )<a name='16032'></font>
<a name='16033'>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='16034'>
<a name='16035'>
<font color=#447700>!<a name='16036'></font>
<font color=#447700>!  Graupel<a name='16037'></font>
<font color=#447700>!<a name='16038'></font>
      IF ( ipconc .ge. 5 ) THEN <font color=#447700>!<a name='16039'></font>
      do mgs = 1,ngscnt<a name='16040'>
      pchwi(mgs) =   &amp;<a name='16041'>
     &amp;  +ifrzg*(crfrzf(mgs) )<a name='16042'>
<a name='16043'>
      pchwd(mgs) =   &amp;<a name='16044'>
     &amp;  (1-il5(mgs))*chmlr(mgs) &amp;<a name='16045'>
     &amp;  - il5(mgs)*chlcnh(mgs)<a name='16046'>
      end do<a name='16047'>
<font color=#447700>!<a name='16048'></font>
<font color=#447700>!  Hail<a name='16049'></font>
<font color=#447700>!<a name='16050'></font>
      IF ( lhl .gt. 1 ) THEN <font color=#447700>!<a name='16051'></font>
      do mgs = 1,ngscnt<a name='16052'>
      pchli(mgs) = (1.0-ifrzg)*(crfrzf(mgs) +il5(mgs)*(ciacrf(mgs) ))  &amp;<a name='16053'>
     &amp; + chlcnh(mgs) *rzxhl(mgs)/rzxh(mgs)<a name='16054'>
<a name='16055'>
      pchld(mgs) =   &amp;<a name='16056'>
     &amp;  (1-il5(mgs))*chlmlr(mgs) <font color=#447700>!  &amp;<a name='16057'></font>
<font color=#447700>!     &gt;  + il5(mgs)*chlsbv(mgs)   &amp;<a name='16058'></font>
<font color=#447700>!     &amp;  + chlsbv(mgs)<a name='16059'></font>
<a name='16060'>
<font color=#447700>!      IF ( pchli(mgs) .ne. 0. .or. pchld(mgs) .ne. 0 ) THEN<a name='16061'></font>
<font color=#447700>!       write(0,*) 'dr: pchli,pchld = ', pchli(mgs),pchld(mgs), igs(mgs),kgs(mgs)<a name='16062'></font>
<font color=#447700>!      ENDIF<a name='16063'></font>
      end do<a name='16064'>
<a name='16065'>
      ENDIF<a name='16066'>
<a name='16067'>
      ENDIF <font color=#447700>! ipconc &gt;= 5<a name='16068'></font>
<a name='16069'>
      ENDIF <font color=#447700>! warmonly<a name='16070'></font>
<a name='16071'>
<font color=#447700>!<a name='16072'></font>
<a name='16073'>
<font color=#447700>!<a name='16074'></font>
<font color=#447700>!  Balance and checks for continuity.....within machine precision...<a name='16075'></font>
<font color=#447700>!<a name='16076'></font>
      do mgs = 1,ngscnt<a name='16077'>
      pctot(mgs)   = pccwi(mgs) +pccwd(mgs) +   &amp;<a name='16078'>
     &amp;               pccii(mgs) +pccid(mgs) +   &amp;<a name='16079'>
     &amp;               pcrwi(mgs) +pcrwd(mgs) +   &amp;<a name='16080'>
     &amp;               pcswi(mgs) +pcswd(mgs) +   &amp;<a name='16081'>
     &amp;               pchwi(mgs) +pchwd(mgs) +   &amp;<a name='16082'>
     &amp;               pchli(mgs) +pchld(mgs)<a name='16083'>
      end do<a name='16084'>
<font color=#447700>!<a name='16085'></font>
<font color=#447700>!<a name='16086'></font>
      ENDIF <font color=#447700>! ( ipconc .ge. 1 )<a name='16087'></font>
<font color=#447700>!<a name='16088'></font>
<font color=#447700>!<a name='16089'></font>
<font color=#447700>!<a name='16090'></font>
<font color=#447700>!<a name='16091'></font>
<font color=#447700>!<a name='16092'></font>
<font color=#447700>!  GOGO<a name='16093'></font>
<font color=#447700>!  production terms for mass<a name='16094'></font>
<font color=#447700>!<a name='16095'></font>
<font color=#447700>!<a name='16096'></font>
       pqwvi(:) = 0.0<a name='16097'>
       pqwvd(:) = 0.0<a name='16098'>
       pqcwi(:) = 0.0<a name='16099'>
       pqcwd(:) = 0.0<a name='16100'>
       pqcii(:) = 0.0<a name='16101'>
       pqcid(:) = 0.0<a name='16102'>
       pqrwi(:) = 0.0<a name='16103'>
       pqrwd(:) = 0.0<a name='16104'>
       pqswi(:) = 0.0<a name='16105'>
       pqswd(:) = 0.0<a name='16106'>
       pqhwi(:) = 0.0<a name='16107'>
       pqhwd(:) = 0.0<a name='16108'>
       pqhli(:) = 0.0<a name='16109'>
       pqhld(:) = 0.0<a name='16110'>
       pqlwsi(:) = 0.0<a name='16111'>
       pqlwsd(:) = 0.0<a name='16112'>
       pqlwhi(:) = 0.0<a name='16113'>
       pqlwhd(:) = 0.0<a name='16114'>
       pqlwhli(:) = 0.0<a name='16115'>
       pqlwhld(:) = 0.0<a name='16116'>
<font color=#447700>!<a name='16117'></font>
<font color=#447700>!  Vapor<a name='16118'></font>
<font color=#447700>!<a name='16119'></font>
      IF ( warmonly &lt; 0.5 ) THEN<a name='16120'>
      do mgs = 1,ngscnt<a name='16121'>
      <a name='16122'>
<font color=#447700>! NOTE: ANY CHANGES HERE ALSO NEED TO GO INTO THE RESUM FARTHER DOWN!<a name='16123'></font>
      pqwvi(mgs) =    &amp;<a name='16124'>
     &amp;  -Min(0.0, qrcev(mgs))   &amp;<a name='16125'>
     &amp;  -Min(0.0, qhcev(mgs))   &amp;<a name='16126'>
     &amp;  -Min(0.0, qhlcev(mgs))   &amp;<a name='16127'>
     &amp;  -Min(0.0, qscev(mgs))   &amp;<a name='16128'>
<font color=#447700>!     &gt;  +il5(mgs)*(-qhsbv(mgs) - qhlsbv(mgs) )   &amp;<a name='16129'></font>
     &amp;  -qhsbv(mgs) - qhlsbv(mgs)   &amp;<a name='16130'>
     &amp;  -qssbv(mgs)    &amp;<a name='16131'>
     &amp;  -il5(mgs)*qisbv(mgs)<a name='16132'>
      <a name='16133'>
      pqwvd(mgs) =     &amp;<a name='16134'>
     &amp;  -Max(0.0, qrcev(mgs))   &amp;<a name='16135'>
     &amp;  -Max(0.0, qhcev(mgs))   &amp;<a name='16136'>
     &amp;  -Max(0.0, qhlcev(mgs))   &amp;<a name='16137'>
     &amp;  -Max(0.0, qscev(mgs))   &amp;<a name='16138'>
     &amp;  +il5(mgs)*(-qiint(mgs)   &amp;<a name='16139'>
     &amp;  -qhdpv(mgs) -qsdpv(mgs) - qhldpv(mgs))   &amp;<a name='16140'>
     &amp;  -il5(mgs)*qidpv(mgs)  <a name='16141'>
      <a name='16142'>
      end do<a name='16143'>
<a name='16144'>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='16145'>
      do mgs = 1,ngscnt<a name='16146'>
      pqwvi(mgs) =    &amp;<a name='16147'>
     &amp;  -Min(0.0, qrcev(mgs)) &amp;<a name='16148'>
     &amp;  -il5(mgs)*qisbv(mgs)<a name='16149'>
      pqwvd(mgs) =     &amp;<a name='16150'>
     &amp;  +il5(mgs)*(-qiint(mgs)   &amp;<a name='16151'>
<font color=#447700>!     &amp;  -qhdpv(mgs) ) &amp; !- qhldpv(mgs))   &amp;<a name='16152'></font>
     &amp;  -qhdpv(mgs) - qhldpv(mgs))   &amp;<a name='16153'>
<font color=#447700>!     &amp;  -qhdpv(mgs) -qsdpv(mgs) - qhldpv(mgs))   &amp;<a name='16154'></font>
     &amp;  -Max(0.0, qrcev(mgs))     &amp;<a name='16155'>
     &amp;  -il5(mgs)*qidpv(mgs)  <a name='16156'>
      end do<a name='16157'>
<a name='16158'>
      ELSE<a name='16159'>
      do mgs = 1,ngscnt<a name='16160'>
      pqwvi(mgs) =    &amp;<a name='16161'>
     &amp;  -Min(0.0, qrcev(mgs))<a name='16162'>
      pqwvd(mgs) =     &amp;<a name='16163'>
     &amp;  -Max(0.0, qrcev(mgs))<a name='16164'>
      end do<a name='16165'>
<a name='16166'>
      ENDIF <font color=#447700>! warmonly<a name='16167'></font>
<font color=#447700>!<a name='16168'></font>
<font color=#447700>!  Cloud water<a name='16169'></font>
<font color=#447700>!<a name='16170'></font>
      do mgs = 1,ngscnt<a name='16171'>
<a name='16172'>
      pqcwi(mgs) =  (0.0) + qwcnr(mgs)<a name='16173'>
<a name='16174'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='16175'>
      pqcwd(mgs) =    &amp;<a name='16176'>
     &amp;  il5(mgs)*(-qiacw(mgs)-qwfrz(mgs)-qwctfz(mgs))   &amp;<a name='16177'>
     &amp;  -il5(mgs)*(qiihr(mgs))   &amp;<a name='16178'>
     &amp;  -qracw(mgs) -qsacw(mgs) -qrcnw(mgs) -qhacw(mgs) - qhlacw(mgs)  <font color=#447700>!&amp;<a name='16179'></font>
<font color=#447700>!     &amp;  -il5(mgs)*(qwfrzp(mgs))<a name='16180'></font>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='16181'>
      pqcwd(mgs) =    &amp;<a name='16182'>
     &amp;  il5(mgs)*(-qiacw(mgs)-qwfrz(mgs)-qwctfz(mgs))   &amp;<a name='16183'>
     &amp;  -il5(mgs)*(qiihr(mgs))   &amp;<a name='16184'>
     &amp;  -qracw(mgs) -qrcnw(mgs) -qhacw(mgs) -qhlacw(mgs)<a name='16185'>
      ELSE<a name='16186'>
      pqcwd(mgs) =    &amp;<a name='16187'>
     &amp;  -qracw(mgs) - qrcnw(mgs)<a name='16188'>
      ENDIF<a name='16189'>
<a name='16190'>
      IF ( pqcwd(mgs) .lt. 0.0 .and. -pqcwd(mgs)*dtp .gt. qx(mgs,lc) ) THEN<a name='16191'>
<a name='16192'>
       frac = -Max(0.0,qx(mgs,lc))/(pqcwd(mgs)*dtp)<a name='16193'>
       pqcwd(mgs) = -qx(mgs,lc)/dtp<a name='16194'>
<a name='16195'>
        qiacw(mgs)   = frac*qiacw(mgs)<a name='16196'>
<font color=#447700>!        qwfrzp(mgs)  = frac*qwfrzp(mgs)<a name='16197'></font>
<font color=#447700>!        qwctfzp(mgs) = frac*qwctfzp(mgs)<a name='16198'></font>
        qwfrzc(mgs)  = frac*qwfrzc(mgs)<a name='16199'>
        qwfrzis(mgs)  = frac*qwfrzis(mgs)<a name='16200'>
        qwfrz(mgs)  = frac*qwfrz(mgs)<a name='16201'>
        qwctfzc(mgs) = frac*qwctfzc(mgs)<a name='16202'>
        qwctfzis(mgs) = frac*qwctfzis(mgs)<a name='16203'>
        qwctfz(mgs) = frac*qwctfz(mgs)<a name='16204'>
        qracw(mgs)   = frac*qracw(mgs)<a name='16205'>
        qsacw(mgs)   = frac*qsacw(mgs)<a name='16206'>
        qhacw(mgs)   = frac*qhacw(mgs)<a name='16207'>
        vhacw(mgs)   = frac*vhacw(mgs)<a name='16208'>
        qrcnw(mgs)   = frac*qrcnw(mgs)<a name='16209'>
        qwfrzp(mgs)  = frac*qwfrzp(mgs)<a name='16210'>
        IF ( lhl .gt. 1 ) THEN<a name='16211'>
          qhlacw(mgs)   = frac*qhlacw(mgs)<a name='16212'>
          vhlacw(mgs)   = frac*vhlacw(mgs)<a name='16213'>
        ENDIF<a name='16214'>
<font color=#447700>!        IF ( lzh .gt. 1 ) zhacw(mgs) = frac*zhacw(mgs)<a name='16215'></font>
<a name='16216'>
<font color=#447700>!       STOP<a name='16217'></font>
      ENDIF<a name='16218'>
      <a name='16219'>
<a name='16220'>
      end do<a name='16221'>
<font color=#447700>!<a name='16222'></font>
<font color=#447700>!  Cloud ice<a name='16223'></font>
<font color=#447700>!<a name='16224'></font>
      IF ( warmonly &lt; 0.5 ) THEN<a name='16225'>
<a name='16226'>
      do mgs = 1,ngscnt<a name='16227'>
      IF ( ffrzs &lt; 1.0 ) THEN<a name='16228'>
      pqcii(mgs) =     &amp;<a name='16229'>
     &amp;   il5(mgs)*qicicnt(mgs)    &amp;<a name='16230'>
     &amp;  +il5(mgs)*(qwfrzc(mgs)+qwctfzc(mgs))   &amp;<a name='16231'>
     &amp;  +il5(mgs)*(qicichr(mgs))  &amp;<a name='16232'>
     &amp;  +qsmul(mgs)               &amp;<a name='16233'>
     &amp;  +qhmul1(mgs) + qhlmul1(mgs)   &amp;<a name='16234'>
     &amp; + qsplinter(mgs) + qsplinter2(mgs)<a name='16235'>
<font color=#447700>!     &gt; + cimas0*nsplinter*(crfrzf(mgs) + crfrz(mgs))/rho0(mgs)<a name='16236'></font>
      ENDIF<a name='16237'>
       <a name='16238'>
       pqcii(mgs) = pqcii(mgs)*(1.0 - ffrzs) &amp;<a name='16239'>
     &amp;  +il5(mgs)*qidpv(mgs)    &amp;<a name='16240'>
     &amp;  +il5(mgs)*qiacw(mgs)<a name='16241'>
       <a name='16242'>
      pqcid(mgs) =     &amp;<a name='16243'>
     &amp;   il5(mgs)*(-qscni(mgs) - qscnvi(mgs)    &amp; <font color=#447700>! -qwaci(mgs)    &amp;<a name='16244'></font>
     &amp;  -qraci(mgs)    &amp;<a name='16245'>
     &amp;  -qsaci(mgs) )   &amp;<a name='16246'>
     &amp;  -qhaci(mgs)   &amp;<a name='16247'>
     &amp;  -qhlaci(mgs)    &amp;<a name='16248'>
     &amp;  +il5(mgs)*qisbv(mgs)    &amp;<a name='16249'>
     &amp;  +(1.-il5(mgs))*qimlr(mgs)   &amp;<a name='16250'>
     &amp;  - qhcni(mgs)<a name='16251'>
      end do<a name='16252'>
<a name='16253'>
      <a name='16254'>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='16255'>
<a name='16256'>
      do mgs = 1,ngscnt<a name='16257'>
      pqcii(mgs) =     &amp;<a name='16258'>
     &amp;   il5(mgs)*qicicnt(mgs)*(1. - ffrzs)    &amp;<a name='16259'>
     &amp;  +il5(mgs)*(qwfrzc(mgs)+qwctfzc(mgs))*(1. - ffrzs)   &amp;<a name='16260'>
     &amp;  +il5(mgs)*(qicichr(mgs))*(1. - ffrzs)   &amp;<a name='16261'>
<font color=#447700>!     &amp;  +il5(mgs)*(qicichr(mgs))   &amp;<a name='16262'></font>
<font color=#447700>!     &amp;  +qsmul(mgs)               &amp;<a name='16263'></font>
     &amp;  +qhmul1(mgs) + qhlmul1(mgs)   &amp;<a name='16264'>
     &amp; + qsplinter(mgs) + qsplinter2(mgs) &amp;<a name='16265'>
     &amp;  +il5(mgs)*qidpv(mgs)    &amp;<a name='16266'>
     &amp;  +il5(mgs)*qiacw(mgs)  <font color=#447700>! &amp; ! (qiacwi(mgs)+qwacii(mgs))   &amp;<a name='16267'></font>
<font color=#447700>!     &amp;  +il5(mgs)*(qwfrzc(mgs)+qwctfzc(mgs))   &amp;<a name='16268'></font>
<font color=#447700>!     &amp;  +il5(mgs)*(qicichr(mgs))   &amp;<a name='16269'></font>
<font color=#447700>!     &amp;  +qsmul(mgs)               &amp;<a name='16270'></font>
<font color=#447700>!     &amp;  +qhmul1(mgs) + qhlmul1(mgs)   &amp;<a name='16271'></font>
<font color=#447700>!     &amp; + qsplinter(mgs) + qsplinter2(mgs)<a name='16272'></font>
<a name='16273'>
      pqcid(mgs) =     &amp;<a name='16274'>
<font color=#447700>!     &amp;   il5(mgs)*(-qscni(mgs) - qscnvi(mgs)    &amp; ! -qwaci(mgs)    &amp;<a name='16275'></font>
<font color=#447700>!     &amp;  -qraci(mgs)    &amp;<a name='16276'></font>
<font color=#447700>!     &amp;  -qsaci(mgs) )   &amp;<a name='16277'></font>
<font color=#447700>!     &amp;  -qhaci(mgs)   &amp;<a name='16278'></font>
<font color=#447700>!     &amp;  -qhlaci(mgs)    &amp;<a name='16279'></font>
     &amp;  +il5(mgs)*qisbv(mgs)    &amp;<a name='16280'>
     &amp;  +(1.-il5(mgs))*qimlr(mgs)  <font color=#447700>! &amp;<a name='16281'></font>
<font color=#447700>!     &amp;  - qhcni(mgs)<a name='16282'></font>
      end do<a name='16283'>
<a name='16284'>
      ENDIF<a name='16285'>
<font color=#447700>!<a name='16286'></font>
<font color=#447700>!  Rain<a name='16287'></font>
<font color=#447700>!<a name='16288'></font>
<a name='16289'>
      do mgs = 1,ngscnt<a name='16290'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='16291'>
      pqrwi(mgs) =     &amp;<a name='16292'>
     &amp;   qracw(mgs) + qrcnw(mgs) + Max(0.0, qrcev(mgs))   &amp;<a name='16293'>
     &amp;  +(1-il5(mgs))*(   &amp;<a name='16294'>
     &amp;    -qhmlr(mgs)                 &amp;            <font color=#447700>!null at this point when wet snow/graupel included<a name='16295'></font>
     &amp;    -qsmlr(mgs)  - qhlmlr(mgs)     &amp;<a name='16296'>
     &amp;    -qimlr(mgs))   &amp;<a name='16297'>
     &amp;    -qsshr(mgs)       &amp;                      <font color=#447700>!null at this point when wet snow/graupel included<a name='16298'></font>
     &amp;    -qhshr(mgs)       &amp;                      <font color=#447700>!null at this point when wet snow/graupel included<a name='16299'></font>
     &amp;    -qhlshr(mgs)<a name='16300'>
      pqrwd(mgs) =     &amp;<a name='16301'>
     &amp;  il5(mgs)*(-qiacr(mgs)-qrfrz(mgs))    &amp;<a name='16302'>
     &amp;  - qsacr(mgs) - qhacr(mgs) - qhlacr(mgs) - qwcnr(mgs)   &amp;<a name='16303'>
     &amp;  + Min(0.0,qrcev(mgs))<a name='16304'>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='16305'>
      pqrwi(mgs) =     &amp;<a name='16306'>
     &amp;   qracw(mgs) + qrcnw(mgs) + Max(0.0, qrcev(mgs))   &amp;<a name='16307'>
     &amp;  +(1-il5(mgs))*(   &amp;<a name='16308'>
     &amp;    -qhmlr(mgs)                 &amp;            <font color=#447700>!null at this point when wet snow/graupel included<a name='16309'></font>
     &amp;    -qhshr(mgs)                 &amp;           <font color=#447700>!null at this point when wet snow/graupel included<a name='16310'></font>
     &amp;    -qhlmlr(mgs)                 &amp;            <font color=#447700>!null at this point when wet snow/graupel included<a name='16311'></font>
     &amp;    -qhlshr(mgs) )                           <font color=#447700>!null at this point when wet snow/graupel included<a name='16312'></font>
      pqrwd(mgs) =     &amp;<a name='16313'>
     &amp;  il5(mgs)*(-qrfrz(mgs))    &amp;<a name='16314'>
     &amp;   - qhacr(mgs)    &amp;<a name='16315'>
     &amp;   - qhlacr(mgs)    &amp;<a name='16316'>
     &amp;  + Min(0.0,qrcev(mgs))<a name='16317'>
      ELSE<a name='16318'>
      pqrwi(mgs) =     &amp;<a name='16319'>
     &amp;   qracw(mgs) + qrcnw(mgs) + Max(0.0, qrcev(mgs))<a name='16320'>
      pqrwd(mgs) =  Min(0.0,qrcev(mgs))<a name='16321'>
      ENDIF <font color=#447700>! warmonly<a name='16322'></font>
<a name='16323'>
<a name='16324'>
 <font color=#447700>!      IF ( pqrwd(mgs) .lt. 0.0 .and. -(pqrwd(mgs) + pqrwi(mgs))*dtp .gt. qx(mgs,lr)  ) THEN<a name='16325'></font>
      IF ( pqrwd(mgs) .lt. 0.0 .and. -(pqrwd(mgs) + pqrwi(mgs))*dtp .gt. qx(mgs,lr)  ) THEN<a name='16326'>
<a name='16327'>
       frac = (-qx(mgs,lr) + pqrwi(mgs)*dtp)/(pqrwd(mgs)*dtp)<a name='16328'>
<font color=#447700>!       pqrwd(mgs) = -qx(mgs,lr)/dtp  + pqrwi(mgs)<a name='16329'></font>
<a name='16330'>
       pqwvi(mgs) = pqwvi(mgs)    &amp;<a name='16331'>
     &amp;  + Min(0.0, qrcev(mgs))   &amp;<a name='16332'>
     &amp;  - frac*Min(0.0, qrcev(mgs))<a name='16333'>
       pqwvd(mgs) =  pqwvd(mgs)   &amp;<a name='16334'>
     &amp;  + Max(0.0, qrcev(mgs))   &amp;<a name='16335'>
     &amp;  - frac*Max(0.0, qrcev(mgs))<a name='16336'>
<a name='16337'>
       qiacr(mgs)  = frac*qiacr(mgs)<a name='16338'>
       qiacrf(mgs) = frac*qiacrf(mgs)<a name='16339'>
       qiacrs(mgs) = frac*qiacrs(mgs)<a name='16340'>
       viacrf(mgs) = frac*viacrf(mgs)<a name='16341'>
       qrfrz(mgs)  = frac*qrfrz(mgs) <a name='16342'>
       qrfrzs(mgs) = frac*qrfrzs(mgs) <a name='16343'>
       qrfrzf(mgs) = frac*qrfrzf(mgs)<a name='16344'>
       vrfrzf(mgs) = frac*vrfrzf(mgs)<a name='16345'>
       qsacr(mgs)  = frac*qsacr(mgs)<a name='16346'>
       qhacr(mgs)  = frac*qhacr(mgs)<a name='16347'>
       vhacr(mgs)  = frac*vhacr(mgs)<a name='16348'>
       qrcev(mgs)  = frac*qrcev(mgs)<a name='16349'>
       qhlacr(mgs) = frac*qhlacr(mgs)<a name='16350'>
       vhlacr(mgs) = frac*vhlacr(mgs)<a name='16351'>
<font color=#447700>!       qhcev(mgs)  = frac*qhcev(mgs)<a name='16352'></font>
<a name='16353'>
<a name='16354'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='16355'>
       pqrwd(mgs) =     &amp;<a name='16356'>
     &amp;  il5(mgs)*(-qiacr(mgs)-qrfrz(mgs) - qsacr(mgs))    &amp;<a name='16357'>
     &amp;  - qhacr(mgs) - qhlacr(mgs) - qwcnr(mgs)   &amp;<a name='16358'>
     &amp;  + Min(0.0,qrcev(mgs))<a name='16359'>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='16360'>
      pqrwd(mgs) =     &amp;<a name='16361'>
     &amp;  il5(mgs)*(-qrfrz(mgs))    &amp;<a name='16362'>
     &amp;   - qhacr(mgs)    &amp;<a name='16363'>
     &amp;   - qhlacr(mgs)    &amp;<a name='16364'>
     &amp;  + Min(0.0,qrcev(mgs))<a name='16365'>
      ELSE<a name='16366'>
       pqrwd(mgs) =  Min(0.0,qrcev(mgs))<a name='16367'>
      ENDIF <font color=#447700>! warmonly<a name='16368'></font>
<a name='16369'>
<font color=#447700>!<a name='16370'></font>
<font color=#447700>! Resum for vapor since qrcev has changed<a name='16371'></font>
<font color=#447700>!<a name='16372'></font>
      IF ( qrcev(mgs) .ne. 0.0 ) THEN<a name='16373'>
       pqwvi(mgs) =    &amp;<a name='16374'>
     &amp;  -Min(0.0, qrcev(mgs))   &amp;<a name='16375'>
     &amp;  -Min(0.0, qhcev(mgs))   &amp;<a name='16376'>
     &amp;  -Min(0.0, qhlcev(mgs))   &amp;<a name='16377'>
     &amp;  -Min(0.0, qscev(mgs))   &amp;<a name='16378'>
<font color=#447700>!     &gt;  +il5(mgs)*(-qhsbv(mgs)  - qhlsbv(mgs) )   &amp;<a name='16379'></font>
     &amp;  -qhsbv(mgs)  - qhlsbv(mgs)   &amp;<a name='16380'>
     &amp;  -qssbv(mgs)    &amp;<a name='16381'>
     &amp;  -il5(mgs)*qisbv(mgs) <a name='16382'>
     <a name='16383'>
       pqwvd(mgs) =     &amp;<a name='16384'>
     &amp;  -Max(0.0, qrcev(mgs))   &amp;<a name='16385'>
     &amp;  -Max(0.0, qhcev(mgs))   &amp;<a name='16386'>
     &amp;  -Max(0.0, qhlcev(mgs))   &amp;<a name='16387'>
     &amp;  -Max(0.0, qscev(mgs))   &amp;<a name='16388'>
     &amp;  +il5(mgs)*(-qiint(mgs)   &amp;<a name='16389'>
     &amp;  -qhdpv(mgs) -qsdpv(mgs) - qhldpv(mgs))   &amp;<a name='16390'>
     &amp;  -il5(mgs)*qidpv(mgs)  <a name='16391'>
<a name='16392'>
       ENDIF<a name='16393'>
<a name='16394'>
<a name='16395'>
<font color=#447700>!       STOP<a name='16396'></font>
      ENDIF<a name='16397'>
      end do<a name='16398'>
<a name='16399'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='16400'>
<a name='16401'>
<font color=#447700>!<a name='16402'></font>
<font color=#447700>!  Snow<a name='16403'></font>
<font color=#447700>!<a name='16404'></font>
      do mgs = 1,ngscnt<a name='16405'>
      pqswi(mgs) =     &amp;<a name='16406'>
     &amp;   il5(mgs)*(qscni(mgs)+qsaci(mgs)+qsdpv(mgs)   &amp;<a name='16407'>
     &amp;   + qscnvi(mgs)                        &amp;<a name='16408'>
     &amp;   + ifrzs*(qiacrs(mgs) + qrfrzs(mgs))  &amp;<a name='16409'>
     &amp;   + il5(mgs)*( qwfrzc(mgs) + qwctfzc(mgs) + qicichr(mgs) )*ffrzs   &amp;<a name='16410'>
     &amp;   + il2(mgs)*qsacr(mgs))   &amp;<a name='16411'>
     &amp;   + il5(mgs)*qicicnt(mgs)*ffrzs        &amp;<a name='16412'>
     &amp;   + il3(mgs)*(qiacrf(mgs)+qracif(mgs)) &amp;<a name='16413'>
     &amp;   + Max(0.0, qscev(mgs))   &amp;<a name='16414'>
     &amp;   + qsacw(mgs) + qscnh(mgs) &amp;<a name='16415'>
     &amp;  + ffrzs*(qsmul(mgs)               &amp;<a name='16416'>
     &amp;  +qhmul1(mgs) + qhlmul1(mgs)   &amp;<a name='16417'>
     &amp; + qsplinter(mgs) + qsplinter2(mgs))<a name='16418'>
      pqswd(mgs) =    &amp;<a name='16419'>
<font color=#447700>!     &gt;  -qfacs(mgs) ! -qwacs(mgs)   &amp;<a name='16420'></font>
     &amp;  -qracs(mgs)*(1-il2(mgs)) -qhacs(mgs) - qhlacs(mgs)   &amp;<a name='16421'>
     &amp;  -qhcns(mgs)   &amp;<a name='16422'>
     &amp;  +(1-il5(mgs))*qsmlr(mgs) + qsshr(mgs)    &amp;    <font color=#447700>!null at this point when wet snow included<a name='16423'></font>
<font color=#447700>!     &gt;  +il5(mgs)*(qssbv(mgs))   &amp;<a name='16424'></font>
     &amp;  + (qssbv(mgs))   &amp;<a name='16425'>
     &amp;  + Min(0.0, qscev(mgs))  &amp;<a name='16426'>
     &amp;  -qsmul(mgs)<a name='16427'>
      <a name='16428'>
      <a name='16429'>
      IF ( imixedphase == 0 .and. pqswd(mgs) .lt. 0.0  ) THEN<a name='16430'>
        IF ( qx(mgs,ls) + dtp*(pqswi(mgs) + pqswd(mgs)) &lt; 0.0 ) THEN<a name='16431'>
         frac = (-qx(mgs,ls) + pqswi(mgs)*dtp)/(pqswd(mgs)*dtp)<a name='16432'>
         <a name='16433'>
           pqswd(mgs) = frac*pqswd(mgs)<a name='16434'>
           <a name='16435'>
           qracs(mgs)  = frac*qracs(mgs) <font color=#447700>! only used for single moment at this time<a name='16436'></font>
           qhacs(mgs)  = frac*qhacs(mgs) <a name='16437'>
           qhlacs(mgs) = frac*qhlacs(mgs)<a name='16438'>
           qhcns(mgs)  = frac*qhcns(mgs) <a name='16439'>
           qsmlr(mgs)  = frac*qsmlr(mgs) <a name='16440'>
           qsshr(mgs)  = frac*qsshr(mgs) <a name='16441'>
           qssbv(mgs)  = frac*qssbv(mgs) <a name='16442'>
           qsmul(mgs)  = frac*qsmul(mgs) <a name='16443'>
           IF ( qscev(mgs) &lt; 0.0 ) qscev(mgs) = frac*qscev(mgs)<a name='16444'>
<a name='16445'>
        ENDIF<a name='16446'>
      ENDIF<a name='16447'>
      <a name='16448'>
      pqcii(mgs) =  pqcii(mgs) &amp;<a name='16449'>
     &amp;  + (1. - ifrzs)*qrfrzs(mgs) &amp;<a name='16450'>
     &amp;  + (1. - ifrzs)*qiacrs(mgs)<a name='16451'>
      <a name='16452'>
      end do <a name='16453'>
      <a name='16454'>
<font color=#447700>!<a name='16455'></font>
<font color=#447700>!  Graupel<a name='16456'></font>
<font color=#447700>!<a name='16457'></font>
      do mgs = 1,ngscnt<a name='16458'>
      pqhwi(mgs) =    &amp;<a name='16459'>
     &amp;  +il5(mgs)*ifrzg*(qrfrzf(mgs)  + (1-il3(mgs))*(qiacrf(mgs)+qracif(mgs)))   &amp;<a name='16460'>
     &amp;  + (1-il2(mgs))*(qracs(mgs) + qsacr(mgs))  &amp;<a name='16461'>
     &amp;  +il5(mgs)*(qhdpv(mgs))   &amp;<a name='16462'>
     &amp;  +Max(0.0, qhcev(mgs))   &amp;<a name='16463'>
     &amp;  +qhacr(mgs)+qhacw(mgs)   &amp;<a name='16464'>
     &amp;  +qhacs(mgs)+qhaci(mgs)   &amp;<a name='16465'>
     &amp;  + qhcns(mgs) + qhcni(mgs) + qhcnhl(mgs)<a name='16466'>
      pqhwd(mgs) =     &amp;<a name='16467'>
     &amp;   qhshr(mgs)                &amp;    <font color=#447700>!null at this point when wet graupel included<a name='16468'></font>
     &amp;  +(1-il5(mgs))*qhmlr(mgs)   &amp;    <font color=#447700>!null at this point when wet graupel included<a name='16469'></font>
<font color=#447700>!     &gt;  +il5(mgs)*qhsbv(mgs)   &amp;<a name='16470'></font>
     &amp;  + qhsbv(mgs)   &amp;<a name='16471'>
     &amp;  + Min(0.0, qhcev(mgs))   &amp;<a name='16472'>
     &amp;  -qhmul1(mgs) - qhlcnh(mgs) - qscnh(mgs)  &amp;<a name='16473'>
     &amp;  - qsplinter(mgs) - qsplinter2(mgs)<a name='16474'>
<font color=#447700>!     &gt; - cimas0*nsplinter*(crfrzf(mgs) + crfrz(mgs))/rho0(mgs)<a name='16475'></font>
      end do<a name='16476'>
<a name='16477'>
<font color=#447700>!<a name='16478'></font>
<font color=#447700>!  Hail<a name='16479'></font>
<font color=#447700>!<a name='16480'></font>
      IF ( lhl .gt. 1 ) THEN<a name='16481'>
<a name='16482'>
      do mgs = 1,ngscnt<a name='16483'>
      pqhli(mgs) =    &amp;<a name='16484'>
     &amp;  +il5(mgs)*(qhldpv(mgs) + (1.0-ifrzg)*(qiacrf(mgs)+qrfrzf(mgs)  + qracif(mgs)))   &amp;<a name='16485'>
     &amp;  +Max(0.0, qhlcev(mgs))   &amp;<a name='16486'>
     &amp;  +qhlacr(mgs)+qhlacw(mgs)   &amp;<a name='16487'>
     &amp;  +qhlacs(mgs)+qhlaci(mgs)   &amp;<a name='16488'>
     &amp;  + qhlcnh(mgs)<a name='16489'>
      pqhld(mgs) =     &amp;<a name='16490'>
     &amp;   qhlshr(mgs)    &amp;<a name='16491'>
     &amp;  +(1-il5(mgs))*qhlmlr(mgs)    &amp;<a name='16492'>
<font color=#447700>!     &gt;  +il5(mgs)*qhlsbv(mgs)   &amp;<a name='16493'></font>
     &amp;  + qhlsbv(mgs)   &amp;<a name='16494'>
     &amp;  + Min(0.0, qhlcev(mgs))   &amp;<a name='16495'>
     &amp;  -qhlmul1(mgs) - qhcnhl(mgs)<a name='16496'>
      end do<a name='16497'>
      <a name='16498'>
      ENDIF <font color=#447700>! lhl<a name='16499'></font>
<a name='16500'>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='16501'>
<font color=#447700>!<a name='16502'></font>
<font color=#447700>!  Graupel<a name='16503'></font>
<font color=#447700>!<a name='16504'></font>
      do mgs = 1,ngscnt<a name='16505'>
      pqhwi(mgs) =    &amp;<a name='16506'>
     &amp;  +il5(mgs)*ifrzg*(qrfrzf(mgs) )   &amp;<a name='16507'>
     &amp;  +il5(mgs)*(qhdpv(mgs))   &amp;<a name='16508'>
     &amp;  +qhacr(mgs)+qhacw(mgs)   <a name='16509'>
      pqhwd(mgs) =     &amp;<a name='16510'>
     &amp;   qhshr(mgs)                &amp;    <font color=#447700>!null at this point when wet graupel included<a name='16511'></font>
     &amp;  - qhlcnh(mgs)   &amp;<a name='16512'>
     &amp;  - qhmul1(mgs)   &amp;<a name='16513'>
     &amp;  - qsplinter(mgs) - qsplinter2(mgs) &amp;<a name='16514'>
     &amp;  +(1-il5(mgs))*qhmlr(mgs)        <font color=#447700>!null at this point when wet graupel included<a name='16515'></font>
       end do<a name='16516'>
<a name='16517'>
<font color=#447700>!<a name='16518'></font>
<font color=#447700>!  Hail<a name='16519'></font>
<font color=#447700>!<a name='16520'></font>
      IF ( lhl .gt. 1 ) THEN<a name='16521'>
<a name='16522'>
      do mgs = 1,ngscnt<a name='16523'>
      pqhli(mgs) =    &amp;<a name='16524'>
     &amp;  +il5(mgs)*(qhldpv(mgs) ) &amp; <font color=#447700>! + (1.0-ifrzg)*(qiacrf(mgs)+qrfrzf(mgs)  + qracif(mgs)))   &amp;<a name='16525'></font>
     &amp;  +qhlacr(mgs)+qhlacw(mgs)   &amp;<a name='16526'>
<font color=#447700>!     &amp;  +qhlacs(mgs)+qhlaci(mgs)   &amp;<a name='16527'></font>
     &amp;  + qhlcnh(mgs)<a name='16528'>
      pqhld(mgs) =     &amp;<a name='16529'>
     &amp;   qhlshr(mgs)    &amp;<a name='16530'>
     &amp;  +(1-il5(mgs))*qhlmlr(mgs)    &amp;<a name='16531'>
<font color=#447700>!     &gt;  +il5(mgs)*qhlsbv(mgs)   &amp;<a name='16532'></font>
     &amp;  + qhlsbv(mgs)   &amp;<a name='16533'>
     &amp;  -qhlmul1(mgs) - qhcnhl(mgs)<a name='16534'>
<a name='16535'>
      end do<a name='16536'>
<a name='16537'>
      ENDIF <font color=#447700>! lhl<a name='16538'></font>
<a name='16539'>
      ENDIF <font color=#447700>! warmonly<a name='16540'></font>
<a name='16541'>
<font color=#447700>!<a name='16542'></font>
<font color=#447700>!  Liquid water on snow and graupel<a name='16543'></font>
<font color=#447700>!<a name='16544'></font>
<a name='16545'>
      vhmlr(:) = 0.0<a name='16546'>
      vhlmlr(:) = 0.0<a name='16547'>
      vhfzh(:) = 0.0<a name='16548'>
      vhlfzhl(:) = 0.0<a name='16549'>
<a name='16550'>
      IF ( mixedphase ) THEN<a name='16551'>
      ELSE <font color=#447700>! set arrays for non-mixedphase graupel<a name='16552'></font>
      <a name='16553'>
<font color=#447700>!        vhshdr(:) = 0.0<a name='16554'></font>
        vhmlr(:) = qhmlr(:) <font color=#447700>! not actually volume, but treated as q in rate equation<a name='16555'></font>
<font color=#447700>!        vhsoak(:) = 0.0<a name='16556'></font>
<a name='16557'>
<font color=#447700>!        vhlshdr(:) = 0.0<a name='16558'></font>
        vhlmlr(:) = qhlmlr(:) <font color=#447700>! not actually volume, but treated as q in rate equation<a name='16559'></font>
<font color=#447700>!        vhlmlr(:) = rho0(:)*qhlmlr(:)/xdn(:,lhl) <a name='16560'></font>
<font color=#447700>!        vhlsoak(:) = 0.0<a name='16561'></font>
      <a name='16562'>
      ENDIF  <font color=#447700>! mixedphase<a name='16563'></font>
<a name='16564'>
<a name='16565'>
<a name='16566'>
<font color=#447700>!<a name='16567'></font>
<font color=#447700>!  Snow volume<a name='16568'></font>
<font color=#447700>!<a name='16569'></font>
      IF ( lvol(ls) .gt. 1 ) THEN<a name='16570'>
      do mgs = 1,ngscnt<a name='16571'>
<font color=#447700>!      pvswi(mgs) = rho0(mgs)*( pqswi(mgs) )/xdn0(ls)<a name='16572'></font>
<a name='16573'>
      pvswi(mgs) = rho0(mgs)*(    &amp;<a name='16574'>
<font color=#447700>!aps     &gt;   il5*qsfzs(mgs)/xdn(mgs,ls)   &amp;<a name='16575'></font>
<font color=#447700>!aps     &gt;  -il5*qsfzs(mgs)/xdn(mgs,lr)   &amp;<a name='16576'></font>
     &amp;  +il5(mgs)*(qscni(mgs)+qsaci(mgs)+qsdpv(mgs)   &amp;<a name='16577'>
     &amp;   + qscnvi(mgs) + (1. - ifrzs)*qiacrs(mgs) &amp;<a name='16578'>
     &amp;   + (1. - ifrzs)*qrfrzs(mgs)  &amp;<a name='16579'>
     &amp;  )/xdn0(ls)   &amp;<a name='16580'>
     &amp;    + (qsacr(mgs))/rimdn(mgs,ls) ) + vsacw(mgs)<a name='16581'>
<font color=#447700>!     &gt;   + (qsacw(mgs) + qsacr(mgs))/rimdn(mgs,ls) )<a name='16582'></font>
      pvswd(mgs) = rho0(mgs)*( pqswd(mgs) )/xdn0(ls)  &amp;<a name='16583'>
<font color=#447700>!     &gt;  -qhacs(mgs)<a name='16584'></font>
<font color=#447700>!     &gt;  -qhcns(mgs)<a name='16585'></font>
<font color=#447700>!     &gt;  +(1-il5(mgs))*qsmlr(mgs) + qsshr(mgs)<a name='16586'></font>
<font color=#447700>!     &gt;  +il5(mgs)*(qssbv(mgs))<a name='16587'></font>
     &amp;   -rho0(mgs)*qsmul(mgs)/xdn0(ls)<a name='16588'>
<font color=#447700>!aps     &gt;   +rho0(mgs)*(1-il5(mgs))*(<a name='16589'></font>
<font color=#447700>!aps     &gt;             qsmlr(mgs)/xdn(mgs,ls)<a name='16590'></font>
<font color=#447700>!aps     &gt;    +(qscev-qsmlr(mgs))/xdn(mgs,lr) )<a name='16591'></font>
      end do<a name='16592'>
<a name='16593'>
<font color=#447700>!aps      IF (mixedphase) THEN<a name='16594'></font>
<font color=#447700>!aps        pvswd(mgs) = pvswd(mgs)<a name='16595'></font>
<font color=#447700>!aps     &gt;   + rho0(mgs)*qsshr(mgs)/xdn(mgs,lr)<a name='16596'></font>
<font color=#447700>!aps      ENDIF<a name='16597'></font>
<a name='16598'>
      ENDIF<a name='16599'>
<font color=#447700>!<a name='16600'></font>
<font color=#447700>!  Graupel volume<a name='16601'></font>
<font color=#447700>!<a name='16602'></font>
      IF ( lvol(lh) .gt. 1 ) THEN<a name='16603'>
      DO mgs = 1,ngscnt<a name='16604'>
<font color=#447700>!      pvhwi(mgs) = rho0(mgs)*( (pqhwi(mgs) )/xdn0(lh) )<a name='16605'></font>
<a name='16606'>
<font color=#447700>!      pvhwi(mgs) = rho0(mgs)*( (pqhwi(mgs) - il5(mgs)*qrfrzf(mgs) )/xdn0(lh) !<a name='16607'></font>
<font color=#447700>!     :  +  il5(mgs)*qrfrzf(mgs)/rhofrz )<a name='16608'></font>
<a name='16609'>
      pvhwi(mgs) = rho0(mgs)*(   &amp;<a name='16610'>
     &amp;  +il5(mgs)*( qracif(mgs))/rhofrz   &amp;<a name='16611'>
<font color=#447700>!erm     &gt;  + il5(mgs)*qhfzh(mgs)/rhofrz !aps: or use xdnmx(lh)?   &amp;<a name='16612'></font>
     &amp;  + (  il5(mgs)*qhdpv(mgs)   &amp;<a name='16613'>
     &amp;     + qhacs(mgs) + qhaci(mgs) )/xdnmn(lh) )   &amp;<a name='16614'>
     &amp;  +   rho0(mgs)*Max(0.0, qhcev(mgs))/1000.   &amp; <font color=#447700>! only used in mixed phase: evaporation of liquid water coating<a name='16615'></font>
<font color=#447700>!     &gt;     + qhacs(mgs) + qhaci(mgs) )/xdn0(ls) )   &amp;<a name='16616'></font>
     &amp;  + vhcns(mgs)   &amp;<a name='16617'>
     &amp;  + vhacr(mgs) + vhacw(mgs)  + vhfzh(mgs)   &amp; <font color=#447700>! qhacw(mgs)/rimdn(mgs,lh)<a name='16618'></font>
<font color=#447700>!     &gt;  + vhfrh(mgs)   &amp;<a name='16619'></font>
     &amp;  + vhcni(mgs) + ifrzg*(viacrf(mgs) + vrfrzf(mgs))<a name='16620'>
<font color=#447700>!     &gt;  +qhacr(mgs)/raindn(mgs,lh) + qhacw(mgs)/rimdn(mgs,lh)<a name='16621'></font>
      <a name='16622'>
<font color=#447700>!      pvhwd(mgs) = rho0(mgs)*(pqhwd(mgs) )/xdn0(lh)<a name='16623'></font>
<a name='16624'>
      pvhwd(mgs) = rho0(mgs)*(   &amp;<a name='16625'>
<font color=#447700>!     &gt;   qhshr(mgs)/xdn0(lr)   &amp;<a name='16626'></font>
<font color=#447700>!     &gt;  - il5(mgs)*qhfzh(mgs)/xdn(mgs,lr)   &amp;<a name='16627'></font>
     &amp;  +( (1-il5(mgs))*vhmlr(mgs)    &amp;<a name='16628'>
<font color=#447700>!     &gt;     +il5(mgs)*qhsbv(mgs)   &amp;<a name='16629'></font>
     &amp;     + qhsbv(mgs)   &amp;<a name='16630'>
     &amp;     + Min(0.0, qhcev(mgs))   &amp;<a name='16631'>
     &amp;     -qhmul1(mgs) )/xdn(mgs,lh) )   &amp;<a name='16632'>
     &amp;  - vhlcnh(mgs) + vhshdr(mgs) - vhsoak(mgs) - vscnh(mgs)<a name='16633'>
<a name='16634'>
<font color=#447700>!      IF (mixedphase) THEN<a name='16635'></font>
<font color=#447700>!       pvhwd(mgs) = pvhwd(mgs) <a name='16636'></font>
<font color=#447700>!     &gt;  + rho0(mgs)*qhshr(mgs)/xdn(mgs,lh) !xdn(mgs,lr)<a name='16637'></font>
<font color=#447700>!      ENDIF<a name='16638'></font>
<a name='16639'>
      IF ( .false. .and. ny .eq. 2 .and. kgs(mgs) .eq. 9 .and. igs(mgs) .eq. 19 ) THEN<a name='16640'>
<a name='16641'>
      write(iunit,*)<a name='16642'>
      write(iunit,*)   'Graupel at ',igs(mgs),kgs(mgs)<a name='16643'>
<font color=#447700>!<a name='16644'></font>
      write(iunit,*)   il5(mgs)*qrfrzf(mgs), qrfrzf(mgs) - qrfrz(mgs)<a name='16645'>
      write(iunit,*)   il5(mgs)*qiacrf(mgs)<a name='16646'>
      write(iunit,*)   il5(mgs)*qracif(mgs)<a name='16647'>
      write(iunit,*)   'qhcns',qhcns(mgs)<a name='16648'>
      write(iunit,*)   'qhcni',qhcni(mgs)<a name='16649'>
      write(iunit,*)   il5(mgs)*(qhdpv(mgs))<a name='16650'>
      write(iunit,*)   'qhacr ',qhacr(mgs)<a name='16651'>
      write(iunit,*)   'qhacw', qhacw(mgs)<a name='16652'>
      write(iunit,*)   'qhacs', qhacs(mgs)<a name='16653'>
      write(iunit,*)   'qhaci', qhaci(mgs)<a name='16654'>
      write(iunit,*)   'pqhwi = ',pqhwi(mgs)<a name='16655'>
      write(iunit,*)<a name='16656'>
      write(iunit,*) 'qhcev',qhcev(mgs)<a name='16657'>
      write(iunit,*)<a name='16658'>
      write(iunit,*)   'qhshr',qhshr(mgs)<a name='16659'>
      write(iunit,*)  'qhmlr', (1-il5(mgs))*qhmlr(mgs)<a name='16660'>
      write(iunit,*)   'qhsbv', qhsbv(mgs)<a name='16661'>
      write(iunit,*)   'qhlcnh',-qhlcnh(mgs)<a name='16662'>
      write(iunit,*)   'qhmul1',-qhmul1(mgs)<a name='16663'>
      write(iunit,*)   'pqhwd = ', pqhwd(mgs)<a name='16664'>
      write(iunit,*)<a name='16665'>
      write(iunit,*)  'Volume'<a name='16666'>
      write(iunit,*)<a name='16667'>
      write(iunit,*)  'pvhwi',pvhwi(mgs)<a name='16668'>
      write(iunit,*)   'vhcns', vhcns(mgs)<a name='16669'>
      write(iunit,*)  'vhacr,vhacw',vhacr(mgs), vhacw(mgs) <font color=#447700>! qhacw(mgs)/rimdn(mgs,lh)<a name='16670'></font>
      write(iunit,*)  'vhcni',vhcni(mgs)<a name='16671'>
      write(iunit,*)<a name='16672'>
      write(iunit,*)  'pvhwd',pvhwd(mgs)<a name='16673'>
      write(iunit,*)  'vhlcnh,vhshdr,vhsoak ', vhlcnh(mgs),  vhshdr(mgs), vhsoak(mgs)<a name='16674'>
      write(iunit,*)  'vhmlr', vhmlr(mgs)<a name='16675'>
      write(iunit,*)<a name='16676'>
<font color=#447700>!      write(iunit,*)<a name='16677'></font>
<font color=#447700>!      write(iunit,*)<a name='16678'></font>
<font color=#447700>!      write(iunit,*)<a name='16679'></font>
      write(iunit,*)  'Concentration'<a name='16680'>
      write(iunit,*)   pchwi(mgs),pchwd(mgs)<a name='16681'>
      write(iunit,*)  crfrzf(mgs)<a name='16682'>
      write(iunit,*)  chcns(mgs)<a name='16683'>
      write(iunit,*)  ciacrf(mgs)<a name='16684'>
<a name='16685'>
<a name='16686'>
      ENDIF<a name='16687'>
<a name='16688'>
<a name='16689'>
      ENDDO<a name='16690'>
<a name='16691'>
      ENDIF<a name='16692'>
<font color=#447700>!<a name='16693'></font>
<font color=#447700>!<a name='16694'></font>
<font color=#447700>!<a name='16695'></font>
<a name='16696'>
<font color=#447700>!<a name='16697'></font>
<font color=#447700>!  Hail volume<a name='16698'></font>
<font color=#447700>!<a name='16699'></font>
      IF ( lhl .gt. 1 ) THEN<a name='16700'>
      IF ( lvol(lhl) .gt. 1 ) THEN<a name='16701'>
      DO mgs = 1,ngscnt<a name='16702'>
<a name='16703'>
      pvhli(mgs) = rho0(mgs)*(   &amp;<a name='16704'>
     &amp;  + (  il5(mgs)*qhldpv(mgs)   &amp;<a name='16705'>
<font color=#447700>!     &amp;  +    Max(0.0, qhlcev(mgs))   &amp;<a name='16706'></font>
<font color=#447700>!     &amp;     + qhlacs(mgs) + qhlaci(mgs) )/xdnmn(lhl) )   &amp; ! xdn0(ls) )   &amp;<a name='16707'></font>
<font color=#447700>!     &amp;     + qhlacs(mgs) + qhlaci(mgs) )/xdnmn(lh) )   &amp;  ! yes, this is 'lh' on purpose<a name='16708'></font>
     &amp;     + qhlacs(mgs) + qhlaci(mgs) )/500. )   &amp;  <font color=#447700>! changed to 500 instead of min graupel density to keep hail density from dropping too much<a name='16709'></font>
     &amp;  +   rho0(mgs)*Max(0.0, qhlcev(mgs))/1000.   &amp;<a name='16710'>
     &amp;  + vhlcnhl(mgs) + (1.0-ifrzg)*(viacrf(mgs) + vrfrzf(mgs))  &amp; <a name='16711'>
     &amp;  + vhlacr(mgs) + vhlacw(mgs) + vhlfzhl(mgs) <font color=#447700>! qhlacw(mgs)/rimdn(mgs,lhl)<a name='16712'></font>
      <a name='16713'>
      pvhld(mgs) = rho0(mgs)*(   &amp;<a name='16714'>
     &amp;  +(  qhlsbv(mgs)   &amp;<a name='16715'>
     &amp;     + Min(0.0, qhlcev(mgs))   &amp;<a name='16716'>
     &amp;     -qhlmul1(mgs) )/xdn(mgs,lhl) ) &amp;<a name='16717'>
<font color=#447700>!     &amp;   + vhlmlr(mgs)                    &amp;<a name='16718'></font>
     &amp;   + rho0(mgs)*(1-il5(mgs))*vhlmlr(mgs)/xdn(mgs,lhl)  &amp;<a name='16719'>
     &amp;   + vhlshdr(mgs) - vhlsoak(mgs)<a name='16720'>
<a name='16721'>
<a name='16722'>
      ENDDO<a name='16723'>
      <a name='16724'>
      ENDIF<a name='16725'>
      ENDIF<a name='16726'>
<a name='16727'>
<a name='16728'>
      if ( ndebug .ge. 1 ) then<a name='16729'>
      do mgs = 1,ngscnt<a name='16730'>
<font color=#447700>!<a name='16731'></font>
      ptotal(mgs) = 0.<a name='16732'>
      ptotal(mgs) = ptotal(mgs)     &amp;<a name='16733'>
     &amp;  + pqwvi(mgs) + pqwvd(mgs)   &amp;<a name='16734'>
     &amp;  + pqcwi(mgs) + pqcwd(mgs)   &amp;<a name='16735'>
     &amp;  + pqcii(mgs) + pqcid(mgs)   &amp;<a name='16736'>
     &amp;  + pqrwi(mgs) + pqrwd(mgs)   &amp;<a name='16737'>
     &amp;  + pqswi(mgs) + pqswd(mgs)   &amp;<a name='16738'>
     &amp;  + pqhwi(mgs) + pqhwd(mgs)   &amp;<a name='16739'>
     &amp;  + pqhli(mgs) + pqhld(mgs)<a name='16740'>
<font color=#447700>!<a name='16741'></font>
      <a name='16742'>
      <a name='16743'>
      ENDDO<a name='16744'>
      <a name='16745'>
      do mgs = 1,ngscnt<a name='16746'>
<a name='16747'>
      if ( ( (ndebug .ge. 0  ) .and. abs(ptotal(mgs)) .gt. eqtot )   &amp;<a name='16748'>
<font color=#447700>!      if ( (  abs(ptotal(mgs)) .gt. eqtot )<a name='16749'></font>
<font color=#447700>!     :    .or. pqswi(mgs)*dtp .gt. 1.e-3<a name='16750'></font>
<font color=#447700>!     :    .or. pqhwi(mgs)*dtp .gt. 1.e-3<a name='16751'></font>
<font color=#447700>!     :     .or. dtp*(pqrwi(mgs)+pqrwd(mgs)) .gt. 10.0e-3<a name='16752'></font>
<font color=#447700>!     :     .or. dtp*(pccii(mgs)+pccid(mgs)) .gt. 1.e7<a name='16753'></font>
<font color=#447700>!     :     .or. dtp*(pcipi(mgs)+pcipd(mgs)) .gt. 1.e7    &amp;<a name='16754'></font>
     &amp;  .or.  .not. (ptotal(mgs) .lt. 1.0 .and.  ptotal(mgs) .gt. -1.0)   &amp; <font color=#447700>! this line is basically checking for NaNs<a name='16755'></font>
     &amp;              ) then<a name='16756'>
      write(iunit,*) 'YIKES<font color=#447700>! ','ptotal1',mgs,igs(mgs),jgs,   &amp;<a name='16757'></font>
     &amp;       kgs(mgs),ptotal(mgs)<a name='16758'>
<a name='16759'>
      write(iunit,*) 't7: ', t7(igs(mgs),jgs,kgs(mgs))<a name='16760'>
      write(iunit,*)  'cci,ccw,crw,rdia: ',cx(mgs,li),cx(mgs,lc),cx(mgs,lr),0.5*xdia(mgs,lr,1)<a name='16761'>
      write(iunit,*)  'qc,qi,qr : ',qx(mgs,lc),qx(mgs,li),qx(mgs,lr)<a name='16762'>
      write(iunit,*)  'rmas, qrcalc : ',xmas(mgs,lr),xmas(mgs,lr)*cx(mgs,lr)/rho0(mgs)<a name='16763'>
      write(iunit,*)  'vti,vtc,eiw,vtr: ',vtxbar(mgs,li,1),vtxbar(mgs,lc,1),eiw(mgs),vtxbar(mgs,lr,1)<a name='16764'>
      write(iunit,*)  'cidia,cwdia,qcmxd: ', xdia(mgs,li,1),xdia(mgs,lc,1),qcmxd(mgs)<a name='16765'>
      write(iunit,*)  'snow: ',qx(mgs,ls),cx(mgs,ls),swvent(mgs),vtxbar(mgs,ls,1),xdia(mgs,ls,1)<a name='16766'>
      write(iunit,*)  'graupel: ',qx(mgs,lh),cx(mgs,lh),hwvent(mgs),vtxbar(mgs,lh,1),xdia(mgs,lh,1)<a name='16767'>
      IF ( lhl .gt. 1 ) write(iunit,*)  'hail: ',qx(mgs,lhl),cx(mgs,lhl),hlvent(mgs),vtxbar(mgs,lhl,1),xdia(mgs,lhl,1)<a name='16768'>
<a name='16769'>
<a name='16770'>
      write(iunit,*)  'li: ',xdia(mgs,li,1),xdia(mgs,li,2),xmas(mgs,li),qx(mgs,li),   &amp;<a name='16771'>
     &amp;         vtxbar(mgs,li,1)<a name='16772'>
<a name='16773'>
<a name='16774'>
      write(iunit,*)  'rain cx,xv : ',cx(mgs,lr),xv(mgs,lr)<a name='16775'>
      write(iunit,*)  'temcg = ', temcg(mgs)<a name='16776'>
<a name='16777'>
      write(iunit,*) 'v ', pqwvi(mgs) ,pqwvd(mgs)<a name='16778'>
      write(iunit,*) 'c ', pqcwi(mgs) ,pqcwd(mgs)<a name='16779'>
      write(iunit,*) 'ci', pqcii(mgs) ,pqcid(mgs)<a name='16780'>
      write(iunit,*) 'r ', pqrwi(mgs) ,pqrwd(mgs)<a name='16781'>
      write(iunit,*) 's ', pqswi(mgs) ,pqswd(mgs)<a name='16782'>
      write(iunit,*) 'h ', pqhwi(mgs) ,pqhwd(mgs)<a name='16783'>
      write(iunit,*) 'hl', pqhli(mgs) ,pqhld(mgs)<a name='16784'>
       tmp =  pqwvi(mgs) + pqwvd(mgs)   &amp;<a name='16785'>
     &amp;  + pqcwi(mgs) + pqcwd(mgs)   &amp;<a name='16786'>
     &amp;  + pqcii(mgs) + pqcid(mgs)   &amp;<a name='16787'>
     &amp;  + pqrwi(mgs) + pqrwd(mgs)   &amp;<a name='16788'>
     &amp;  + pqswi(mgs) + pqswd(mgs)   &amp;<a name='16789'>
     &amp;  + pqhwi(mgs) + pqhwd(mgs)   &amp;<a name='16790'>
     &amp;  + pqhli(mgs) + pqhld(mgs)<a name='16791'>
<a name='16792'>
      write(iunit,*) 'total = ',tmp<a name='16793'>
      write(iunit,*) 'END OF OUTPUT OF SOURCE AND SINK'<a name='16794'>
<a name='16795'>
<font color=#447700>!<a name='16796'></font>
<font color=#447700>!  print production terms<a name='16797'></font>
<font color=#447700>!<a name='16798'></font>
      write(iunit,*)<a name='16799'>
      write(iunit,*)   'Vapor'<a name='16800'>
<font color=#447700>!<a name='16801'></font>
      write(iunit,*)   -Min(0.0,qrcev(mgs))<a name='16802'>
      write(iunit,*)   -il5(mgs)*qhsbv(mgs)<a name='16803'>
      write(iunit,*)   -il5(mgs)*qhlsbv(mgs)<a name='16804'>
      write(iunit,*)   -il5(mgs)*qssbv(mgs)<a name='16805'>
      write(iunit,*)   -il5(mgs)*qisbv(mgs)<a name='16806'>
      write(iunit,*)    'pqwvi= ', pqwvi(mgs)<a name='16807'>
      write(iunit,*)   -Max(0.0,qrcev(mgs))<a name='16808'>
      write(iunit,*)   -Max(0.0,qhcev(mgs))<a name='16809'>
      write(iunit,*)   -Max(0.0,qhlcev(mgs))<a name='16810'>
      write(iunit,*)   -Max(0.0,qscev(mgs))<a name='16811'>
      write(iunit,*)   -il5(mgs)*qiint(mgs)<a name='16812'>
      write(iunit,*)   -il5(mgs)*qhdpv(mgs)<a name='16813'>
      write(iunit,*)   -il5(mgs)*qhldpv(mgs)<a name='16814'>
      write(iunit,*)   -il5(mgs)*qsdpv(mgs)<a name='16815'>
      write(iunit,*)   -il5(mgs)*qidpv(mgs)<a name='16816'>
      write(iunit,*)    'pqwvd = ', pqwvd(mgs)<a name='16817'>
<font color=#447700>!<a name='16818'></font>
      write(iunit,*)<a name='16819'>
      write(iunit,*)   'Cloud ice'<a name='16820'>
<font color=#447700>!<a name='16821'></font>
      write(iunit,*)   il5(mgs)*qicicnt(mgs)<a name='16822'>
      write(iunit,*)   il5(mgs)*qidpv(mgs)<a name='16823'>
      write(iunit,*)   il5(mgs)*qiacw(mgs)<a name='16824'>
      write(iunit,*)   il5(mgs)*qwfrzc(mgs)<a name='16825'>
      write(iunit,*)   il5(mgs)*qwctfzc(mgs)<a name='16826'>
      write(iunit,*)   il5(mgs)*qicichr(mgs)<a name='16827'>
      write(iunit,*)   qhmul1(mgs)<a name='16828'>
      write(iunit,*)   qhlmul1(mgs)<a name='16829'>
      write(iunit,*)   'pqcii = ', pqcii(mgs)<a name='16830'>
      write(iunit,*)   -il5(mgs)*qscni(mgs)<a name='16831'>
      write(iunit,*)   -il5(mgs)*qscnvi(mgs)<a name='16832'>
      write(iunit,*)   -il5(mgs)*qraci(mgs)<a name='16833'>
      write(iunit,*)   -il5(mgs)*qsaci(mgs)<a name='16834'>
      write(iunit,*)   -il5(mgs)*qhaci(mgs)<a name='16835'>
      write(iunit,*)   -il5(mgs)*qhlaci(mgs)<a name='16836'>
      write(iunit,*)   il5(mgs)*qisbv(mgs)<a name='16837'>
      write(iunit,*)   (1.-il5(mgs))*qimlr(mgs)<a name='16838'>
      write(iunit,*)   -il5(mgs)*qhcni(mgs)<a name='16839'>
      write(iunit,*)   'pqcid = ', pqcid(mgs)<a name='16840'>
      write(iunit,*)   ' Conc:'<a name='16841'>
      write(iunit,*)   pccii(mgs),pccid(mgs)<a name='16842'>
      write(iunit,*)   il5(mgs),cicint(mgs)<a name='16843'>
      write(iunit,*)   cwacii(mgs),cwfrzc(mgs),cwctfzc(mgs)<a name='16844'>
      write(iunit,*)   cicichr(mgs)<a name='16845'>
      write(iunit,*)   chmul1(mgs)<a name='16846'>
      write(iunit,*)   chlmul1(mgs)<a name='16847'>
      write(iunit,*)   csmul(mgs)<a name='16848'>
<font color=#447700>!<a name='16849'></font>
<font color=#447700>!<a name='16850'></font>
<font color=#447700>!<a name='16851'></font>
<font color=#447700>!<a name='16852'></font>
      write(iunit,*)<a name='16853'>
      write(iunit,*)   'Cloud water'<a name='16854'>
<font color=#447700>!<a name='16855'></font>
      write(iunit,*)   'pqcwi =', pqcwi(mgs)<a name='16856'>
      write(iunit,*)   -il5(mgs)*qiacw(mgs)<a name='16857'>
      write(iunit,*)   -il5(mgs)*qwfrzc(mgs)<a name='16858'>
      write(iunit,*)   -il5(mgs)*qwctfzc(mgs)<a name='16859'>
      write(iunit,*)   -il5(mgs)*qwctfzis(mgs)<a name='16860'>
<font color=#447700>!      write(iunit,*)   -il5(mgs)*qwfrzp(mgs)<a name='16861'></font>
<font color=#447700>!      write(iunit,*)   -il5(mgs)*qwctfzp(mgs)<a name='16862'></font>
      write(iunit,*)   -il5(mgs)*qiihr(mgs)<a name='16863'>
      write(iunit,*)   -il5(mgs)*qicichr(mgs)<a name='16864'>
      write(iunit,*)   -il5(mgs)*qipiphr(mgs)<a name='16865'>
      write(iunit,*)   -qracw(mgs)<a name='16866'>
      write(iunit,*)   -qsacw(mgs)<a name='16867'>
      write(iunit,*)   -qrcnw(mgs)<a name='16868'>
      write(iunit,*)   -qhacw(mgs)<a name='16869'>
      write(iunit,*)   -qhlacw(mgs)<a name='16870'>
      write(iunit,*)   'pqcwd = ', pqcwd(mgs)<a name='16871'>
<a name='16872'>
<a name='16873'>
      write(iunit,*)<a name='16874'>
      write(iunit,*)  'Concentration:'<a name='16875'>
      write(iunit,*)   -cautn(mgs)<a name='16876'>
      write(iunit,*)   -cracw(mgs)<a name='16877'>
      write(iunit,*)   -csacw(mgs)<a name='16878'>
      write(iunit,*)   -chacw(mgs)<a name='16879'>
      write(iunit,*)  -ciacw(mgs)<a name='16880'>
      write(iunit,*)  -cwfrzp(mgs)<a name='16881'>
      write(iunit,*)  -cwctfzp(mgs)<a name='16882'>
      write(iunit,*)  -cwfrzc(mgs)<a name='16883'>
      write(iunit,*)  -cwctfzc(mgs)<a name='16884'>
      write(iunit,*)   pccwd(mgs)<a name='16885'>
<font color=#447700>!<a name='16886'></font>
      write(iunit,*)<a name='16887'>
      write(iunit,*)      'Rain '<a name='16888'>
<font color=#447700>!<a name='16889'></font>
      write(iunit,*)      qracw(mgs)<a name='16890'>
      write(iunit,*)      qrcnw(mgs)<a name='16891'>
      write(iunit,*)      Max(0.0, qrcev(mgs))<a name='16892'>
      write(iunit,*)       -(1-il5(mgs))*qhmlr(mgs)<a name='16893'>
      write(iunit,*)       -(1-il5(mgs))*qhlmlr(mgs)<a name='16894'>
      write(iunit,*)       -(1-il5(mgs))*qsmlr(mgs)<a name='16895'>
      write(iunit,*)       -(1-il5(mgs))*qimlr(mgs)<a name='16896'>
      write(iunit,*)       -qrshr(mgs)<a name='16897'>
      write(iunit,*)       'pqrwi = ', pqrwi(mgs)    <a name='16898'>
      write(iunit,*)        -qsshr(mgs)     <a name='16899'>
      write(iunit,*)        -qhshr(mgs)     <a name='16900'>
      write(iunit,*)        -qhlshr(mgs)<a name='16901'>
      write(iunit,*)        -il5(mgs)*qiacr(mgs),qiacr(mgs), qiacrf(mgs)<a name='16902'>
      write(iunit,*)        -il5(mgs)*qrfrz(mgs)<a name='16903'>
      write(iunit,*)        -qsacr(mgs)<a name='16904'>
      write(iunit,*)        -qhacr(mgs)<a name='16905'>
      write(iunit,*)        -qhlacr(mgs)<a name='16906'>
      write(iunit,*)        qrcev(mgs)<a name='16907'>
      write(iunit,*)       'pqrwd = ', pqrwd(mgs) <a name='16908'>
      write(iunit,*)       'fhw, fhlw = ',fhw(mgs),fhlw(mgs)<a name='16909'>
      write(iunit,*)        'qrzfac = ', qrzfac(mgs)<a name='16910'>
<font color=#447700>!<a name='16911'></font>
      <a name='16912'>
      write(iunit,*)<a name='16913'>
      write(iunit,*)  'Rain concentration'<a name='16914'>
      write(iunit,*)  pcrwi(mgs) <a name='16915'>
      write(iunit,*)    crcnw(mgs)<a name='16916'>
      write(iunit,*)    1-il5(mgs)<a name='16917'>
      write(iunit,*)   -chmlr(mgs),-csmlr(mgs)<a name='16918'>
      write(iunit,*)     -crshr(mgs)<a name='16919'>
      write(iunit,*)  pcrwd(mgs) <a name='16920'>
      write(iunit,*)    il5(mgs)<a name='16921'>
      write(iunit,*)   -ciacr(mgs),-crfrz(mgs) <a name='16922'>
      write(iunit,*)   -csacr(mgs),-chacr(mgs)<a name='16923'>
      write(iunit,*)   +crcev(mgs)<a name='16924'>
      write(iunit,*)   cracr(mgs)<a name='16925'>
<font color=#447700>!      write(iunit,*)   -il5(mgs)*ciracr(mgs)<a name='16926'></font>
<a name='16927'>
<a name='16928'>
      write(iunit,*)<a name='16929'>
      write(iunit,*)   'Snow'<a name='16930'>
<font color=#447700>!<a name='16931'></font>
      write(iunit,*)        il5(mgs)*qscni(mgs), qscnvi(mgs)<a name='16932'>
      write(iunit,*)        il5(mgs)*qsaci(mgs)<a name='16933'>
      write(iunit,*)        il5(mgs)*qrfrzs(mgs)<a name='16934'>
      write(iunit,*)        il5(mgs)*qiacrs(mgs),il3(mgs)*(qiacrf(mgs)+qracif(mgs)),il3(mgs),qiacrf(mgs),qracif(mgs)<a name='16935'>
      write(iunit,*)        il5(mgs)*qsdpv(mgs), qscev(mgs)<a name='16936'>
      write(iunit,*)        qsacw(mgs)<a name='16937'>
      write(iunit,*)        qsacr(mgs), qscnh(mgs)<a name='16938'>
       write(iunit,*)        'pqswi = ',pqswi(mgs)<a name='16939'>
      write(iunit,*)        -qhcns(mgs)<a name='16940'>
      write(iunit,*)        -qracs(mgs)<a name='16941'>
      write(iunit,*)        -qhacs(mgs)<a name='16942'>
      write(iunit,*)        -qhlacs(mgs)<a name='16943'>
      write(iunit,*)       (1-il5(mgs))*qsmlr(mgs)<a name='16944'>
      write(iunit,*)       qsshr(mgs)<a name='16945'>
<font color=#447700>!      write(iunit,*)       qsshrp(mgs)<a name='16946'></font>
      write(iunit,*)       il5(mgs)*(qssbv(mgs))<a name='16947'>
      write(iunit,*)       'pqswd = ', pqswd(mgs)<a name='16948'>
      write(iunit,*)   -qracs(mgs)*(1-il2(mgs)) , qhacs(mgs) , qhlacs(mgs)   <a name='16949'>
      write(iunit,*)   -qhcns(mgs)   <a name='16950'>
      write(iunit,*)   +(1-il5(mgs))*qsmlr(mgs) , qsshr(mgs)<a name='16951'>
      write(iunit,*)   (qssbv(mgs))   <a name='16952'>
      write(iunit,*)   Min(0.0, qscev(mgs))  <a name='16953'>
      write(iunit,*)   -qsmul(mgs)<a name='16954'>
<font color=#447700>!<a name='16955'></font>
<font color=#447700>!<a name='16956'></font>
      write(iunit,*)<a name='16957'>
      write(iunit,*)   'Graupel'<a name='16958'>
<font color=#447700>!<a name='16959'></font>
      write(iunit,*)   il5(mgs)*qrfrzf(mgs), qrfrzf(mgs) - qrfrz(mgs)<a name='16960'>
      write(iunit,*)   il5(mgs)*qiacrf(mgs)<a name='16961'>
      write(iunit,*)   il5(mgs)*qracif(mgs)<a name='16962'>
      write(iunit,*)   qhcns(mgs)<a name='16963'>
      write(iunit,*)   qhcni(mgs)<a name='16964'>
      write(iunit,*)   il5(mgs)*(qhdpv(mgs))<a name='16965'>
      write(iunit,*)   qhacr(mgs)<a name='16966'>
      write(iunit,*)   qhacw(mgs)<a name='16967'>
      write(iunit,*)   qhacs(mgs)<a name='16968'>
      write(iunit,*)   qhaci(mgs)<a name='16969'>
      write(iunit,*)   'pqhwi = ',pqhwi(mgs)<a name='16970'>
      write(iunit,*)<a name='16971'>
      write(iunit,*)   qhshr(mgs)<a name='16972'>
      write(iunit,*)   (1-il5(mgs))*qhmlr(mgs)<a name='16973'>
      write(iunit,*)   il5(mgs),qhsbv(mgs)<a name='16974'>
      write(iunit,*)   -qhlcnh(mgs)<a name='16975'>
      write(iunit,*)   -qhmul1(mgs)<a name='16976'>
      write(iunit,*)   'pqhwd = ', pqhwd(mgs)<a name='16977'>
      write(iunit,*)  'Concentration'<a name='16978'>
      write(iunit,*)   pchwi(mgs),pchwd(mgs)<a name='16979'>
      write(iunit,*)  crfrzf(mgs)<a name='16980'>
      write(iunit,*)  chcns(mgs)<a name='16981'>
      write(iunit,*)  ciacrf(mgs)<a name='16982'>
<a name='16983'>
<font color=#447700>!<a name='16984'></font>
      write(iunit,*)<a name='16985'>
      write(iunit,*)   'Hail'<a name='16986'>
<font color=#447700>!<a name='16987'></font>
      write(iunit,*)   qhlcnh(mgs)<a name='16988'>
      write(iunit,*)   il5(mgs)*(qhldpv(mgs))<a name='16989'>
      write(iunit,*)   qhlacr(mgs)<a name='16990'>
      write(iunit,*)   qhlacw(mgs)<a name='16991'>
      write(iunit,*)   qhlacs(mgs)<a name='16992'>
      write(iunit,*)   qhlaci(mgs)<a name='16993'>
      write(iunit,*)   pqhli(mgs)<a name='16994'>
      write(iunit,*)<a name='16995'>
      write(iunit,*)   qhlshr(mgs)<a name='16996'>
      write(iunit,*)   (1-il5(mgs))*qhlmlr(mgs)<a name='16997'>
      write(iunit,*)   il5(mgs)*qhlsbv(mgs)<a name='16998'>
      write(iunit,*)   pqhld(mgs)<a name='16999'>
      write(iunit,*)  'Concentration'<a name='17000'>
      write(iunit,*)   pchli(mgs),pchld(mgs)<a name='17001'>
      write(iunit,*)  chlcnh(mgs)<a name='17002'>
<font color=#447700>!<a name='17003'></font>
<font color=#447700>!  Balance and checks for continuity.....within machine precision...<a name='17004'></font>
<font color=#447700>!<a name='17005'></font>
<font color=#447700>!<a name='17006'></font>
      write(iunit,*) 'END OF OUTPUT OF SOURCE AND SINK'<a name='17007'>
      write(iunit,*) 'PTOTAL',ptotal(mgs)<a name='17008'>
<font color=#447700>!<a name='17009'></font>
      end if <font color=#447700>! ptotal out of bounds or NaN<a name='17010'></font>
<font color=#447700>!<a name='17011'></font>
      end do<a name='17012'>
<font color=#447700>!<a name='17013'></font>
<a name='17014'>
      end if <font color=#447700>! ( nstep/12*12 .eq. nstep )<a name='17015'></font>
<a name='17016'>
<font color=#447700>!<a name='17017'></font>
<font color=#447700>!  latent heating from phase changes (except qcw, qci cond, and evap)<a name='17018'></font>
<font color=#447700>!<a name='17019'></font>
      do mgs = 1,ngscnt<a name='17020'>
      IF ( warmonly &lt; 0.5 ) THEN<a name='17021'>
      pfrz(mgs) =    &amp;<a name='17022'>
     &amp;  (1-il5(mgs))*   &amp;<a name='17023'>
     &amp;  (qhmlr(mgs)+qsmlr(mgs)+qhlmlr(mgs))   &amp; <font color=#447700>!+qhmlh(mgs))   &amp;<a name='17024'></font>
     &amp;  +il5(mgs)*(qhfzh(mgs)+qsfzs(mgs)+qhlfzhl(mgs))   &amp;<a name='17025'>
     &amp;  +il5(mgs)*(1-imixedphase)*(   &amp;<a name='17026'>
     &amp;   qsacw(mgs)+qhacw(mgs) + qhlacw(mgs)   &amp;<a name='17027'>
     &amp;  +qsacr(mgs)+qhacr(mgs) + qhlacr(mgs)   &amp;<a name='17028'>
     &amp;  +qsshr(mgs)   &amp;<a name='17029'>
     &amp;  +qhshr(mgs)   &amp;<a name='17030'>
     &amp;  +qhlshr(mgs) +qrfrz(mgs)+qiacr(mgs)  &amp;<a name='17031'>
     &amp;  )  &amp;<a name='17032'>
     &amp;  +il5(mgs)*(qwfrz(mgs)    &amp;<a name='17033'>
     &amp;  +qwctfz(mgs)+qiihr(mgs)   &amp;<a name='17034'>
     &amp;  +qiacw(mgs))<a name='17035'>
      pmlt(mgs) =    &amp;<a name='17036'>
     &amp;  (1-il5(mgs))*   &amp;<a name='17037'>
     &amp;  (qhmlr(mgs)+qsmlr(mgs)+qhlmlr(mgs))    <font color=#447700>!+qhmlh(mgs))   <a name='17038'></font>
      <font color=#447700>! NOTE: psub is sum of sublimation and deposition<a name='17039'></font>
      psub(mgs) =    &amp;<a name='17040'>
     &amp;   il5(mgs)*(   &amp;<a name='17041'>
     &amp;  + qsdpv(mgs) + qhdpv(mgs)   &amp;<a name='17042'>
     &amp;  + qhldpv(mgs)    &amp;<a name='17043'>
     &amp;  + qidpv(mgs) + qisbv(mgs) )   &amp;<a name='17044'>
     &amp;   + qssbv(mgs)  + qhsbv(mgs) + qhlsbv(mgs)   &amp;<a name='17045'>
     &amp;  +il5(mgs)*(qiint(mgs))<a name='17046'>
      pvap(mgs) =    &amp;<a name='17047'>
     &amp;   qrcev(mgs) + qhcev(mgs) + qscev(mgs) + qhlcev(mgs)<a name='17048'>
      pevap(mgs) =    &amp;<a name='17049'>
     &amp;   Min(0.0,qrcev(mgs)) + Min(0.0,qhcev(mgs)) + Min(0.0,qscev(mgs)) + Min(0.0,qhlcev(mgs))<a name='17050'>
      <font color=#447700>! NOTE: pdep is the deposition part only<a name='17051'></font>
      pdep(mgs) =    &amp;<a name='17052'>
     &amp;   il5(mgs)*(   &amp;<a name='17053'>
     &amp;  + qsdpv(mgs) + qhdpv(mgs)   &amp;<a name='17054'>
     &amp;  + qhldpv(mgs)    &amp;<a name='17055'>
     &amp;  + qidpv(mgs)  )  &amp; <a name='17056'>
     &amp;  +il5(mgs)*(qiint(mgs))<a name='17057'>
      ELSEIF ( warmonly &lt; 0.8 ) THEN<a name='17058'>
      pfrz(mgs) =    &amp;<a name='17059'>
     &amp;  (1-il5(mgs))*   &amp;<a name='17060'>
     &amp;  (qhmlr(mgs)+qhlmlr(mgs))   &amp; <font color=#447700>!+qhmlh(mgs))   &amp;<a name='17061'></font>
     &amp;  +il5(mgs)*(qhfzh(mgs)+qhlfzhl(mgs))   &amp;<a name='17062'>
     &amp;  +il5(mgs)*(   &amp;<a name='17063'>
     &amp;  +qhshr(mgs)   &amp;<a name='17064'>
     &amp;  +qhlshr(mgs)   &amp;<a name='17065'>
     &amp;  +qrfrz(mgs)+qwfrz(mgs)   &amp;<a name='17066'>
     &amp;  +qwctfz(mgs)+qiihr(mgs)   &amp;<a name='17067'>
     &amp;  +qiacw(mgs)                &amp;<a name='17068'>
     &amp; +qhacw(mgs) + qhlacw(mgs)   &amp;<a name='17069'>
     &amp; +qhacr(mgs) + qhlacr(mgs)  ) <a name='17070'>
      psub(mgs) =  0.0 +  &amp;<a name='17071'>
     &amp;   il5(mgs)*(   &amp;<a name='17072'>
     &amp;  + qhdpv(mgs)   &amp;<a name='17073'>
     &amp;  + qhldpv(mgs)    &amp;<a name='17074'>
     &amp;  + qidpv(mgs) + qisbv(mgs) )   &amp;<a name='17075'>
     &amp;  +il5(mgs)*(qiint(mgs))<a name='17076'>
      pvap(mgs) =    &amp;<a name='17077'>
     &amp;   qrcev(mgs) + qhcev(mgs) + qhlcev(mgs) <font color=#447700>! + qscev(mgs) <a name='17078'></font>
      ELSE<a name='17079'>
      pfrz(mgs) = 0.0<a name='17080'>
      psub(mgs) = 0.0<a name='17081'>
      pvap(mgs) = qrcev(mgs)<a name='17082'>
      ENDIF <font color=#447700>! warmonly<a name='17083'></font>
      ptem(mgs) =    &amp;<a name='17084'>
     &amp;  (1./pi0(mgs))*   &amp;<a name='17085'>
     &amp;  (felfcp(mgs)*pfrz(mgs)   &amp;<a name='17086'>
     &amp;  +felscp(mgs)*psub(mgs)    &amp;<a name='17087'>
     &amp;  +felvcp(mgs)*pvap(mgs))<a name='17088'>
      thetap(mgs) = thetap(mgs) + dtp*ptem(mgs)<a name='17089'>
      IF ( eqtset &gt; 2 ) THEN<a name='17090'>
        pipert(mgs) = pipert(mgs) + (felfpi(mgs)*pfrz(mgs)   &amp;<a name='17091'>
     &amp;  +felspi(mgs)*psub(mgs)    &amp;<a name='17092'>
     &amp;  +felvpi(mgs)*pvap(mgs))*dtp<a name='17093'>
      ENDIF<a name='17094'>
      end do<a name='17095'>
<a name='17096'>
<a name='17097'>
<a name='17098'>
<a name='17099'>
<font color=#447700>!<a name='17100'></font>
<font color=#447700>!  sum the sources and sinks for qwvp, qcw, qci, qrw, qsw<a name='17101'></font>
<font color=#447700>!<a name='17102'></font>
<font color=#447700>!<a name='17103'></font>
      do mgs = 1,ngscnt<a name='17104'>
      qwvp(mgs) = qwvp(mgs) +        &amp;<a name='17105'>
     &amp;   dtp*(pqwvi(mgs)+pqwvd(mgs))<a name='17106'>
      qx(mgs,lc) = qx(mgs,lc) +   &amp;<a name='17107'>
     &amp;   dtp*(pqcwi(mgs)+pqcwd(mgs))<a name='17108'>
      qx(mgs,lr) = qx(mgs,lr) +   &amp;<a name='17109'>
     &amp;   dtp*(pqrwi(mgs)+pqrwd(mgs))<a name='17110'>
      qx(mgs,li) = qx(mgs,li) +   &amp;<a name='17111'>
     &amp;   dtp*(pqcii(mgs)+pqcid(mgs))<a name='17112'>
      qx(mgs,ls) = qx(mgs,ls) +   &amp;<a name='17113'>
     &amp;   dtp*(pqswi(mgs)+pqswd(mgs))<a name='17114'>
      qx(mgs,lh) = qx(mgs,lh) +    &amp;<a name='17115'>
     &amp;   dtp*(pqhwi(mgs)+pqhwd(mgs))<a name='17116'>
      IF ( lhl .gt. 1 ) THEN<a name='17117'>
      qx(mgs,lhl) = qx(mgs,lhl) +    &amp;<a name='17118'>
     &amp;   dtp*(pqhli(mgs)+pqhld(mgs))<a name='17119'>
      ENDIF<a name='17120'>
<a name='17121'>
<a name='17122'>
      end do<a name='17123'>
<a name='17124'>
<font color=#447700>! sum sources for particle volume<a name='17125'></font>
<a name='17126'>
      IF ( ldovol ) THEN<a name='17127'>
<a name='17128'>
      do mgs = 1,ngscnt<a name='17129'>
<a name='17130'>
      IF ( lvol(ls) .gt. 1 ) THEN<a name='17131'>
      vx(mgs,ls) = vx(mgs,ls) +    &amp;<a name='17132'>
     &amp;   dtp*(pvswi(mgs)+pvswd(mgs))<a name='17133'>
      ENDIF<a name='17134'>
<a name='17135'>
      IF ( lvol(lh) .gt. 1 ) THEN<a name='17136'>
      vx(mgs,lh) = vx(mgs,lh) +    &amp;<a name='17137'>
     &amp;   dtp*(pvhwi(mgs)+pvhwd(mgs))<a name='17138'>
<font color=#447700>!     &gt;   rho0(mgs)*dtp*(pqhwi(mgs)+pqhwd(mgs))/xdn0(lh)<a name='17139'></font>
      ENDIF<a name='17140'>
<a name='17141'>
      IF ( lhl .gt. 1 ) THEN<a name='17142'>
      IF ( lvol(lhl) .gt. 1 ) THEN<a name='17143'>
      vx(mgs,lhl) = vx(mgs,lhl) +    &amp;<a name='17144'>
     &amp;   dtp*(pvhli(mgs)+pvhld(mgs))<a name='17145'>
<font color=#447700>!     &gt;   rho0(mgs)*dtp*(pqhwi(mgs)+pqhwd(mgs))/xdn0(lh)<a name='17146'></font>
      ENDIF<a name='17147'>
      ENDIF<a name='17148'>
<a name='17149'>
      ENDDO<a name='17150'>
<a name='17151'>
      ENDIF  <font color=#447700>! ldovol<a name='17152'></font>
<a name='17153'>
<font color=#447700>!<a name='17154'></font>
<font color=#447700>!<a name='17155'></font>
<font color=#447700>!<a name='17156'></font>
<font color=#447700>! concentrations<a name='17157'></font>
<font color=#447700>!<a name='17158'></font>
      if ( ipconc .ge. 1  ) then<a name='17159'>
      do mgs = 1,ngscnt<a name='17160'>
      cx(mgs,li) = cx(mgs,li) +   &amp;<a name='17161'>
     &amp;   dtp*(pccii(mgs)+pccid(mgs)) <a name='17162'>
      cina(mgs) = cina(mgs) + pccin(mgs)*dtp<a name='17163'>
      IF ( ipconc .ge. 2 ) THEN<a name='17164'>
      cx(mgs,lc) = cx(mgs,lc) +   &amp;<a name='17165'>
     &amp;   dtp*(pccwi(mgs)+pccwd(mgs))<a name='17166'>
      ENDIF<a name='17167'>
      IF ( ipconc .ge. 3 ) THEN<a name='17168'>
      cx(mgs,lr) = cx(mgs,lr) +   &amp;<a name='17169'>
     &amp;   dtp*(pcrwi(mgs)+pcrwd(mgs))<a name='17170'>
      ENDIF<a name='17171'>
      IF ( ipconc .ge. 4 ) THEN<a name='17172'>
      cx(mgs,ls) = cx(mgs,ls) +   &amp;<a name='17173'>
     &amp;   dtp*(pcswi(mgs)+pcswd(mgs))<a name='17174'>
      ENDIF<a name='17175'>
      IF ( ipconc .ge. 5 ) THEN<a name='17176'>
      cx(mgs,lh) = cx(mgs,lh) +    &amp;<a name='17177'>
     &amp;   dtp*(pchwi(mgs)+pchwd(mgs))<a name='17178'>
       IF ( lhl .gt. 1 ) THEN<a name='17179'>
        cx(mgs,lhl) = cx(mgs,lhl) +    &amp;<a name='17180'>
     &amp;     dtp*(pchli(mgs)+pchld(mgs))<a name='17181'>
       ENDIF<a name='17182'>
      ENDIF<a name='17183'>
      end do<a name='17184'>
      end if<a name='17185'>
<a name='17186'>
<a name='17187'>
      IF ( wrfchem_flag &gt; 0 ) THEN<a name='17188'>
<font color=#447700>! 20130917 acd_mb_washout start<a name='17189'></font>
        DO mgs = 1,ngscnt<a name='17190'>
         evapprod2d(igs(mgs),kgs(mgs)) = -(qrcev(mgs) + qssbv(mgs)  + qhsbv(mgs) + qhlsbv(mgs)) <font color=#447700>! - PRE(K) - EVPMS(K) - EVPMG(K)<a name='17191'></font>
         rainprod2d(igs(mgs),kgs(mgs)) = qrcnw(mgs) + qracw(mgs) + qsacw(mgs) + qhacw(mgs) + qhlacw(mgs) + &amp;<a name='17192'>
                                         qraci(mgs) + qsaci(mgs) + qhaci(mgs) + qhlaci(mgs) + qscni(mgs)     <font color=#447700>! PRA(K) + PRC(K) + tqimelt(K)<a name='17193'></font>
<font color=#447700>!         evapprod(k) = - PRE(K) - EPRDS(K) - EPRDG(K) <a name='17194'></font>
<font color=#447700>!         rainprod(k) = PRA(K) + PRC(K) + PSACWS(K) + PSACWG(K) + PGSACW(K) &amp; <a name='17195'></font>
<font color=#447700>!                       + PRAI(K) + PRCI(K) + PRACI(K) + PRACIS(K) + &amp;<a name='17196'></font>
<font color=#447700>!                       + PRDS(K) + PRDG(K)<a name='17197'></font>
        ENDDO<a name='17198'>
<font color=#447700>! 20130917 acd_mb_washout end<a name='17199'></font>
      ENDIF<a name='17200'>
<font color=#447700>!<a name='17201'></font>
<font color=#447700>!<a name='17202'></font>
<font color=#447700>!<a name='17203'></font>
<font color=#447700>! start saturation adjustment<a name='17204'></font>
<font color=#447700>!<a name='17205'></font>
      if (ndebug .gt. 0 ) write(0,*) 'conc 30a'<a name='17206'>
<font color=#447700>!      include 'sam.jms.satadj.sgi'<a name='17207'></font>
<font color=#447700>!<a name='17208'></font>
<font color=#447700>!<a name='17209'></font>
<font color=#447700>!<a name='17210'></font>
<font color=#447700>!  Modified Straka adjustment (nearly identical to Tao et al. 1989 MWR)<a name='17211'></font>
<font color=#447700>!<a name='17212'></font>
<font color=#447700>!<a name='17213'></font>
<font color=#447700>!<a name='17214'></font>
<font color=#447700>!  set up temperature and vapor arrays<a name='17215'></font>
<font color=#447700>!<a name='17216'></font>
      do mgs = 1,ngscnt<a name='17217'>
      pqs(mgs) = (380.0)/(pres(mgs))<a name='17218'>
      theta(mgs) = thetap(mgs) + theta0(mgs)<a name='17219'>
      qvap(mgs) = max( (qwvp(mgs) + qv0(mgs)), 0.0 )<a name='17220'>
      temg(mgs) = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_19">(mgs)*pk(mgs) <font color=#447700>! ( pres(mgs) / poo ) ** cap<a name='17221'></font>
      end do<a name='17222'>
<font color=#447700>!<a name='17223'></font>
<font color=#447700>!  melting of cloud ice<a name='17224'></font>
<font color=#447700>!<a name='17225'></font>
      do mgs = 1,ngscnt<a name='17226'>
      qcwtmp(mgs) = qx(mgs,lc)<a name='17227'>
      ptimlw(mgs) = 0.0<a name='17228'>
      end do<a name='17229'>
<font color=#447700>!<a name='17230'></font>
      do mgs = 1,ngscnt<a name='17231'>
      qitmp(mgs) = qx(mgs,li)<a name='17232'>
      if( temg(mgs) .gt. tfr .and.   &amp;<a name='17233'>
     &amp;    qitmp(mgs) .gt. 0.0 ) then<a name='17234'>
      qx(mgs,lc) = qx(mgs,lc) + qitmp(mgs)<a name='17235'>
<font color=#447700>!      pfrz(mgs) = pfrz(mgs) - qitmp(mgs)/dtp<a name='17236'></font>
      ptem(mgs) =  ptem(mgs) +   &amp;<a name='17237'>
     &amp;  (1./pi0(mgs))*   &amp;<a name='17238'>
     &amp;  felfcp(mgs)*(- qitmp(mgs)/dtp)  <a name='17239'>
      IF ( eqtset &gt; 2 ) THEN<a name='17240'>
        pipert(mgs) = pipert(mgs) - (felfpi(mgs)*qitmp(mgs))<a name='17241'>
      ENDIF<a name='17242'>
      pmlt(mgs) = pmlt(mgs) - qitmp(mgs)/dtp<a name='17243'>
      scx(mgs,lc) = scx(mgs,lc) + scx(mgs,li)<a name='17244'>
      thetap(mgs) = thetap(mgs) -   &amp;<a name='17245'>
     &amp;  fcc3(mgs)*qitmp(mgs)<a name='17246'>
      ptimlw(mgs) = -fcc3(mgs)*qitmp(mgs)/dtp<a name='17247'>
      cx(mgs,lc) = cx(mgs,lc) + cx(mgs,li)<a name='17248'>
      qx(mgs,li) = 0.0<a name='17249'>
      cx(mgs,li) = 0.0<a name='17250'>
      scx(mgs,li) = 0.0<a name='17251'>
      vx(mgs,li) = 0.0<a name='17252'>
      qitmp(mgs) = 0.0<a name='17253'>
      end if<a name='17254'>
      end do<a name='17255'>
<a name='17256'>
<font color=#447700>!<a name='17257'></font>
<font color=#447700>!<a name='17258'></font>
<a name='17259'>
<a name='17260'>
<font color=#447700>!      do mgs = 1,ngscnt<a name='17261'></font>
<font color=#447700>!      qimlw(mgs) = (qcwtmp(mgs)-qx(mgs,lc))/dtp<a name='17262'></font>
<font color=#447700>!      end do<a name='17263'></font>
<font color=#447700>!<a name='17264'></font>
<font color=#447700>!  homogeneous freezing of cloud water<a name='17265'></font>
<font color=#447700>!<a name='17266'></font>
      IF ( warmonly &lt; 0.8 ) THEN<a name='17267'>
<a name='17268'>
      do mgs = 1,ngscnt<a name='17269'>
      qcwtmp(mgs) = qx(mgs,lc)<a name='17270'>
      ptwfzi(mgs) = 0.0<a name='17271'>
      end do<a name='17272'>
<font color=#447700>!<a name='17273'></font>
      do mgs = 1,ngscnt<a name='17274'>
<a name='17275'>
<font color=#447700>!      if( temg(mgs) .lt. tfrh ) THEN<a name='17276'></font>
<font color=#447700>!       write(0,*) 'GS: mgs,temp,qc,qi = ',mgs,temg(mgs),temcg(mgs),qx(mgs,lc),qx(mgs,li)<a name='17277'></font>
<font color=#447700>!      ENDIF<a name='17278'></font>
<a name='17279'>
      ctmp = 0.0<a name='17280'>
      frac = 0.0<a name='17281'>
      qtmp = 0.0<a name='17282'>
      <a name='17283'>
<font color=#447700>!      if( ( temg(mgs) .lt. thnuc + 2. .or. (ibfc == 2 .and. temg(mgs) &lt; thnuc + 10. ) ) .and.    &amp;<a name='17284'></font>
<font color=#447700>!     &amp;  qx(mgs,lc) .gt. qxmin(lc) .and. (ipconc &lt; 2 .or. ibfc == 0 .or. ibfc == 2 )) then<a name='17285'></font>
<font color=#447700>! commented for test (12/01/2015):<a name='17286'></font>
<font color=#447700>!      if( temg(mgs) .lt. thnuc + 0. .and.    &amp;<a name='17287'></font>
<font color=#447700>!     &amp;  qx(mgs,lc) .gt. 0.0 .and. (ipconc &lt; 2 .or. ibfc == 0 )) then<a name='17288'></font>
      if( ( ( temg(mgs) .lt. thnuc + 0.) .or. (temg(mgs) .lt. thnuc + 2. .and. ibfc &gt;= 3) ) .and.    &amp;<a name='17289'>
     &amp;  qx(mgs,lc) .gt. 0.0 .and. (ipconc &lt; 2 .or. ibfc == 0 .or. ibfc == 2)) then<a name='17290'>
<a name='17291'>
      IF ( ibfc &gt;= 3 ) THEN<a name='17292'>
        frac = Max( 0.25, Min( 1., ((thnuc + 2.) - temg(mgs) )/4.0 ) )<a name='17293'>
      ELSEIF ( ibfc /= 2 .or. ipconc &lt; 2 ) THEN<a name='17294'>
        frac = Max( 0.25, Min( 1., ((thnuc + 1.) - temg(mgs) )/4.0 ) )<a name='17295'>
      ELSE<a name='17296'>
          volt = exp( 16.2 + 1.0*temcg(mgs) )* 1.0e-6 <font color=#447700>!  Ts == -temcg ; volt comes from the fit in Fig. 1 in Bigg 1953 <a name='17297'></font>
                                               <font color=#447700>! for mean temperature for freezing: -ln (V) = a*Ts - b<a name='17298'></font>
                                               <font color=#447700>! volt is given in cm**3, so factor of 1.e-6 to convert to m**3<a name='17299'></font>
         <a name='17300'>
         cwfrz(mgs) = cx(mgs,lc)*Exp(-volt/xv(mgs,lc)) <font color=#447700>! number of droplets with volume greater than volt<a name='17301'></font>
<a name='17302'>
         qtmp = cwfrz(mgs)*xdn0(lc)*rhoinv(mgs)*(volt + xv(mgs,lc))<a name='17303'>
         frac = qtmp/qx(mgs,lc) <font color=#447700>! reset number frozen to same fraction as mass. This makes <a name='17304'></font>
                                                       <font color=#447700>! sure that cwfrz and qwfrz are consistent and prevents <a name='17305'></font>
                                                       <font color=#447700>! spurious creation of ice crystals.<a name='17306'></font>
      <a name='17307'>
      ENDIF<a name='17308'>
      qtmp = frac*qx(mgs,lc)<a name='17309'>
<a name='17310'>
      IF ( ibfc == 4 .and. lis &gt;= 1 ) THEN<a name='17311'>
        qx(mgs,lis) = qx(mgs,lis) + qtmp<a name='17312'>
      ELSE<a name='17313'>
        qx(mgs,li) = qx(mgs,li) + qtmp <font color=#447700>! qx(mgs,lc)<a name='17314'></font>
      ENDIF<a name='17315'>
      pfrz(mgs) = pfrz(mgs) + qtmp/dtp<a name='17316'>
      ptem(mgs) =  ptem(mgs) +   &amp;<a name='17317'>
     &amp;  (1./pi0(mgs))*   &amp;<a name='17318'>
     &amp;  felfcp(mgs)*(qtmp/dtp)  <a name='17319'>
<a name='17320'>
      IF ( eqtset &gt; 2 ) THEN<a name='17321'>
        pipert(mgs) = pipert(mgs) + felfpi(mgs)*qtmp<a name='17322'>
      ENDIF<a name='17323'>
<a name='17324'>
<font color=#447700>!      IF ( lvol(li) .gt. 1 ) vx(mgs,li) = vx(mgs,li) + rho0(mgs)*qx(mgs,lc)/xdn0(li)<a name='17325'></font>
      IF ( lvol(li) .gt. 1 ) vx(mgs,li) = vx(mgs,li) + rho0(mgs)*qtmp/xdn0(li)<a name='17326'>
<a name='17327'>
      IF ( ipconc .ge. 2 ) THEN<a name='17328'>
        ctmp = frac*cx(mgs,lc)<a name='17329'>
<font color=#447700>!        cx(mgs,li) = cx(mgs,li) + cx(mgs,lc)<a name='17330'></font>
        IF ( ibfc == 4 .and. lis &gt;= 1 ) THEN<a name='17331'>
          cx(mgs,lis) = cx(mgs,lis) + ctmp<a name='17332'>
        ELSE<a name='17333'>
          cx(mgs,li) = cx(mgs,li) + ctmp<a name='17334'>
        ENDIF<a name='17335'>
      ELSE <font color=#447700>! (ipconc .lt. 2 )<a name='17336'></font>
        ctmp = 0.0<a name='17337'>
        IF ( t9(igs(mgs),jgs,kgs(mgs)-1) .gt. qx(mgs,lc) ) THEN<a name='17338'>
           qtmp = frac*t9(igs(mgs),jgs,kgs(mgs)-1)  <a name='17339'>
<a name='17340'>
<font color=#447700>!           cx(mgs,lc) = cx(mgs,lc)*qx(mgs,lc)*rho0(mgs)/qtmp<a name='17341'></font>
           ctmp = cx(mgs,lc)*qx(mgs,lc)*rho0(mgs)/qtmp<a name='17342'>
        ELSE<a name='17343'>
           cx(mgs,lc) = Max(0.0,wvel(mgs))*dtp*cwccn   &amp;<a name='17344'>
     &amp;      /gz(igs(mgs),jgs,kgs(mgs))<a name='17345'>
          cx(mgs,lc) = cwccn<a name='17346'>
        ENDIF<a name='17347'>
<a name='17348'>
       IF ( ipconc .ge. 1 ) cx(mgs,li) = Min(ccimx, cx(mgs,li) + cx(mgs,lc))<a name='17349'>
      ENDIF<a name='17350'>
<a name='17351'>
      sctmp = frac*scx(mgs,lc)<a name='17352'>
<font color=#447700>!      scx(mgs,li) = scx(mgs,li) + scx(mgs,lc)<a name='17353'></font>
      scx(mgs,li) = scx(mgs,li) + sctmp<a name='17354'>
<font color=#447700>!      thetap(mgs) = thetap(mgs) + fcc3(mgs)*qx(mgs,lc)<a name='17355'></font>
<font color=#447700>!      ptwfzi(mgs) = fcc3(mgs)*qx(mgs,lc)/dtp<a name='17356'></font>
<font color=#447700>!      qx(mgs,lc) = 0.0<a name='17357'></font>
<font color=#447700>!      cx(mgs,lc) = 0.0<a name='17358'></font>
<font color=#447700>!      scx(mgs,lc) = 0.0<a name='17359'></font>
      thetap(mgs) = thetap(mgs) + fcc3(mgs)*qtmp<a name='17360'>
      ptwfzi(mgs) = fcc3(mgs)*qtmp/dtp<a name='17361'>
      qx(mgs,lc) = qx(mgs,lc) - qtmp<a name='17362'>
      cx(mgs,lc) = cx(mgs,lc) - ctmp<a name='17363'>
      scx(mgs,lc) = scx(mgs,lc) - sctmp<a name='17364'>
      end if<a name='17365'>
      end do<a name='17366'>
<a name='17367'>
      ENDIF <font color=#447700>! warmonly<a name='17368'></font>
<font color=#447700>!<a name='17369'></font>
<font color=#447700>!      do mgs = 1,ngscnt<a name='17370'></font>
<font color=#447700>!      qwfzi(mgs) = (qcwtmp(mgs)-qx(mgs,lc))/dtp   ! Not used?? (ERM)<a name='17371'></font>
<font color=#447700>!      end do<a name='17372'></font>
<font color=#447700>!<a name='17373'></font>
<font color=#447700>!  reset temporaries for cloud particles and vapor<a name='17374'></font>
<font color=#447700>!<a name='17375'></font>
      qcond(:) = 0.0<a name='17376'>
      <a name='17377'>
      IF ( ipconc .le. 1 .and.  lwsm6 ) THEN <font color=#447700>! Explicit cloud condensation/evaporation (Rutledge and Hobbs 1983)<a name='17378'></font>
       DO mgs = 1,ngscnt<a name='17379'>
<a name='17380'>
        qcwtmp(mgs) = qx(mgs,lc)<a name='17381'>
        theta(mgs) = thetap(mgs) + theta0(mgs)<a name='17382'>
        temgtmp = temg(mgs)<a name='17383'>
<font color=#447700>!        temg(mgs) = theta(mgs)*(p2(igs(mgs),jgs,kgs(mgs)) ) ! *pk(mgs) ! ( pres(mgs) / poo ) ** cap<a name='17384'></font>
<font color=#447700>!        temsav = temg(mgs)<a name='17385'></font>
<font color=#447700>!        thsave(mgs) = thetap(mgs)<a name='17386'></font>
        temg(mgs) = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_20">(mgs)*pk(mgs) <font color=#447700>! ( pres(mgs) / poo ) ** cap<a name='17387'></font>
        temcg(mgs) = temg(mgs) - tfr<a name='17388'>
        ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='17389'>
        ltemq = Min( nqsat, Max(1,ltemq) )<a name='17390'>
<a name='17391'>
        qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='17392'>
<a name='17393'>
        IF ( ( qvap(mgs) &gt; qvs(mgs) .or. qx(mgs,lc) &gt; qxmin(lc) ) .and. temg(mgs) &gt; tfrh ) THEN<a name='17394'>
          tmp = (qvap(mgs) - qvs(mgs))/(1. + qvs(mgs)*felv(mgs)**2/(cp*rw*temg(mgs)**2) )<a name='17395'>
          qcond(mgs) = Min( Max( 0.0, tmp ), (qvap(mgs)-qvs(mgs)) )<a name='17396'>
          IF ( qx(mgs,lc) &gt; qxmin(lc) .and. tmp &lt; 0.0 ) THEN <font color=#447700>! evaporation<a name='17397'></font>
            qcond(mgs) = Max( tmp, -qx(mgs,lc) )<a name='17398'>
          ENDIF<a name='17399'>
          qwvp(mgs) = qwvp(mgs) - qcond(mgs)<a name='17400'>
          qvap(mgs) = qvap(mgs) - qcond(mgs)<a name='17401'>
          qx(mgs,lc) = Max( 0.0, qx(mgs,lc) + qcond(mgs) )<a name='17402'>
          thetap(mgs) = thetap(mgs) + felvcp(mgs)*qcond(mgs)/(pi0(mgs))<a name='17403'>
          <a name='17404'>
        ENDIF<a name='17405'>
        <a name='17406'>
        ENDDO<a name='17407'>
      <a name='17408'>
      ENDIF<a name='17409'>
      <a name='17410'>
      <a name='17411'>
      IF ( ipconc .le. 1 .and. .not. lwsm6 ) THEN<a name='17412'>
<font color=#447700>!      IF ( ipconc .le. 1  ) THEN<a name='17413'></font>
      <a name='17414'>
      do mgs = 1,ngscnt<a name='17415'>
      qx(mgs,lv) = max( 0.0, qvap(mgs) )<a name='17416'>
      qx(mgs,lc) = max( 0.0, qx(mgs,lc) )<a name='17417'>
      qx(mgs,li) = max( 0.0, qx(mgs,li) )<a name='17418'>
      qitmp(mgs) = qx(mgs,li)<a name='17419'>
      end do<a name='17420'>
<font color=#447700>!<a name='17421'></font>
<font color=#447700>!<a name='17422'></font>
      do mgs = 1,ngscnt<a name='17423'>
      qcwtmp(mgs) = qx(mgs,lc)<a name='17424'>
      qitmp(mgs) = qx(mgs,li)<a name='17425'>
      theta(mgs) = thetap(mgs) + theta0(mgs)<a name='17426'>
      temgtmp = temg(mgs)<a name='17427'>
      temg(mgs) = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_21">(mgs)*(pinit(kgs(mgs)) + p2(igs(mgs),jgs,kgs(mgs)) ) <font color=#447700>! *pk(mgs) ! ( pres(mgs) / poo ) ** cap<a name='17428'></font>
      temsav = temg(mgs)<a name='17429'>
      thsave(mgs) = thetap(mgs)<a name='17430'>
      temcg(mgs) = temg(mgs) - tfr<a name='17431'>
      tqvcon = temg(mgs)-cbw<a name='17432'>
      ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='17433'>
      ltemq = Min( nqsat, Max(1,ltemq) )<a name='17434'>
<font color=#447700>!      IF ( ltemq .lt. 1 .or. ltemq .gt. nqsat ) THEN<a name='17435'></font>
<font color=#447700>! C$PAR CRITICAL SECTION<a name='17436'></font>
<font color=#447700>!        write(iunit,*) 'out of range ltemq!',temgtmp,temg(mgs),<a name='17437'></font>
<font color=#447700>!     :      thetap(mgs),theta0(mgs),pres(mgs),theta(mgs),<a name='17438'></font>
<font color=#447700>!     :      ltemq,igs(mgs),jy,kgs(mgs)<a name='17439'></font>
<font color=#447700>!        write(iunit,*) an(igs(mgs),jy,kgs(mgs),lt),<a name='17440'></font>
<font color=#447700>!     :   ab(igs(mgs),jy,kgs(mgs),lt),<a name='17441'></font>
<font color=#447700>!     :   t0(igs(mgs),jy,kgs(mgs))<a name='17442'></font>
<font color=#447700>!        write(iunit,*) fcc3(mgs),qx(mgs,lc),qitmp(mgs),dtp,ptem(mgs)<a name='17443'></font>
<font color=#447700>!        STOP<a name='17444'></font>
<font color=#447700>! C$PAR END CRITICAL SECTION<a name='17445'></font>
<font color=#447700>!      END IF<a name='17446'></font>
      qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='17447'>
      qis(mgs) = pqs(mgs)*tabqis(ltemq)<a name='17448'>
<font color=#447700>!      qss(kz) = qvs(kz)<a name='17449'></font>
<font color=#447700>!      if ( temg(kz) .lt. tfr ) then<a name='17450'></font>
<font color=#447700>!      if( qcw(kz) .le. qxmin(lc) .and. qci(kz) .gt. qxmin(li))<a name='17451'></font>
<font color=#447700>!     &gt;  qss(kz) = qis(kz)<a name='17452'></font>
<font color=#447700>!      if( qcw(kz) .gt. qxmin(lc) .and. qci(kz) .gt. qxmin(li))<a name='17453'></font>
<font color=#447700>!     &gt;   qss(kz) = (qcw(kz)*qvs(kz) + qci(kz)*qis(kz)) /<a name='17454'></font>
<font color=#447700>!     &gt;   (qcw(kz) + qci(kz))<a name='17455'></font>
<font color=#447700>!      qss(kz) = qis(kz)<a name='17456'></font>
<font color=#447700>!      end if<a name='17457'></font>
<font color=#447700>! dont get enough condensation with qcw .le./.gt. qxmin(lc)<a name='17458'></font>
<font color=#447700>!      if ( temg(mgs) .lt. tfr ) then<a name='17459'></font>
<font color=#447700>!      if( qx(mgs,lc) .ge. 0.0 .and. qitmp(mgs) .le. qxmin(li) )<a name='17460'></font>
<font color=#447700>!     &gt;  qss(mgs) = qvs(mgs)<a name='17461'></font>
<font color=#447700>!      if( qx(mgs,lc) .eq. 0.0 .and. qitmp(mgs) .gt. qxmin(li))<a name='17462'></font>
<font color=#447700>!     &gt;  qss(mgs) = qis(mgs)<a name='17463'></font>
<font color=#447700>!      if( qx(mgs,lc) .gt. 0.0 .and. qitmp(mgs) .gt. qxmin(li))<a name='17464'></font>
<font color=#447700>!     &gt;   qss(mgs) = (qx(mgs,lc)*qvs(mgs) + qitmp(mgs)*qis(mgs)) /<a name='17465'></font>
<font color=#447700>!     &gt;   (qx(mgs,lc) + qitmp(mgs))<a name='17466'></font>
<font color=#447700>!      else<a name='17467'></font>
<font color=#447700>!      qss(mgs) = qvs(mgs)<a name='17468'></font>
<font color=#447700>!      end if<a name='17469'></font>
      qss(mgs) = qvs(mgs)<a name='17470'>
      if ( temg(mgs) .lt. tfr ) then<a name='17471'>
      if( qx(mgs,lc) .ge. 0.0 .and. qitmp(mgs) .le. qxmin(li) )   &amp;<a name='17472'>
     &amp;  qss(mgs) = qvs(mgs)<a name='17473'>
      if( qx(mgs,lc) .le. qxmin(lc) .and. qitmp(mgs) .gt. qxmin(li))   &amp;<a name='17474'>
     &amp;  qss(mgs) = qis(mgs)<a name='17475'>
      if( qx(mgs,lc) .gt. qxmin(lc) .and. qitmp(mgs) .gt. qxmin(li))   &amp;<a name='17476'>
     &amp;   qss(mgs) = (qx(mgs,lc)*qvs(mgs) + qitmp(mgs)*qis(mgs)) /   &amp;<a name='17477'>
     &amp;   (qx(mgs,lc) + qitmp(mgs))<a name='17478'>
      end if<a name='17479'>
      end do<a name='17480'>
<font color=#447700>!<a name='17481'></font>
<font color=#447700>!  iterate  adjustment<a name='17482'></font>
<font color=#447700>!<a name='17483'></font>
      do itertd = 1,2<a name='17484'>
<font color=#447700>!<a name='17485'></font>
      do mgs = 1,ngscnt<a name='17486'>
<font color=#447700>!<a name='17487'></font>
<font color=#447700>!  calculate super-saturation<a name='17488'></font>
<font color=#447700>!<a name='17489'></font>
      qitmp(mgs) = qx(mgs,li)<a name='17490'>
      fcci(mgs) = 0.0<a name='17491'>
      fcip(mgs) = 0.0<a name='17492'>
      dqcw(mgs) = 0.0<a name='17493'>
      dqci(mgs) = 0.0<a name='17494'>
      dqwv(mgs) = ( qx(mgs,lv) - qss(mgs) )<a name='17495'>
<font color=#447700>!<a name='17496'></font>
<font color=#447700>!  evaporation and sublimation adjustment<a name='17497'></font>
<font color=#447700>!<a name='17498'></font>
      if( dqwv(mgs) .lt. 0. ) then           <font color=#447700>!  subsaturated<a name='17499'></font>
        if( qx(mgs,lc) .gt. -dqwv(mgs) ) then  <font color=#447700>! check if qc can make up all of the deficit<a name='17500'></font>
          dqcw(mgs) = dqwv(mgs)<a name='17501'>
          dqwv(mgs) = 0.<a name='17502'>
        else                                 <font color=#447700>!  otherwise make all qc available for evap<a name='17503'></font>
          dqcw(mgs) = -qx(mgs,lc)<a name='17504'>
          dqwv(mgs) = dqwv(mgs) + qx(mgs,lc)<a name='17505'>
        end if<a name='17506'>
<font color=#447700>!<a name='17507'></font>
        if( qitmp(mgs) .gt. -dqwv(mgs) ) then  <font color=#447700>! check if qi can make up all the deficit<a name='17508'></font>
          dqci(mgs) = dqwv(mgs)<a name='17509'>
          dqwv(mgs) = 0.<a name='17510'>
        else                                  <font color=#447700>! otherwise make all ice available for sublimation<a name='17511'></font>
          dqci(mgs) = -qitmp(mgs)<a name='17512'>
          dqwv(mgs) = dqwv(mgs) + qitmp(mgs)<a name='17513'>
        end if<a name='17514'>
<font color=#447700>!<a name='17515'></font>
       qwvp(mgs) = qwvp(mgs) - ( dqcw(mgs) + dqci(mgs) )  <font color=#447700>! add to perturbation vapor<a name='17516'></font>
<font color=#447700>!<a name='17517'></font>
<font color=#447700>! This next line removed 3/19/2003 thanks to Adam Houston,<a name='17518'></font>
<font color=#447700>!  who found the bug in the 3-ICE code<a name='17519'></font>
<font color=#447700>!      qwvp(mgs) = max(qwvp(mgs), 0.0)<a name='17520'></font>
      qitmp(mgs) = qx(mgs,li)<a name='17521'>
      IF ( qitmp(mgs) .gt. qxmin(li) ) THEN<a name='17522'>
        fcci(mgs) = qx(mgs,li)/(qitmp(mgs))<a name='17523'>
      ELSE<a name='17524'>
        fcci(mgs) = 0.0<a name='17525'>
      ENDIF<a name='17526'>
      qx(mgs,lc) = qx(mgs,lc) + dqcw(mgs)<a name='17527'>
      qx(mgs,li) = qx(mgs,li) + dqci(mgs) * fcci(mgs)<a name='17528'>
      thetap(mgs) = thetap(mgs) +   &amp;<a name='17529'>
     &amp;  1./pi0(mgs)*   &amp;<a name='17530'>
     &amp;  (felvcp(mgs)*dqcw(mgs) +felscp(mgs)*dqci(mgs))<a name='17531'>
<a name='17532'>
      IF ( eqtset &gt; 2 ) THEN<a name='17533'>
        pipert(mgs) = pipert(mgs)   &amp;<a name='17534'>
     &amp;  +(felspi(mgs)*dqci(mgs)    &amp;<a name='17535'>
     &amp;  +felvpi(mgs)*dqcw(mgs))*dtp<a name='17536'>
      ENDIF<a name='17537'>
<a name='17538'>
      end if  <font color=#447700>! dqwv(mgs) .lt. 0. (end of evap/sublim)<a name='17539'></font>
<font color=#447700>!<a name='17540'></font>
<font color=#447700>! condensation/deposition<a name='17541'></font>
<font color=#447700>!<a name='17542'></font>
      IF ( dqwv(mgs) .ge. 0. ) THEN<a name='17543'>
      <a name='17544'>
<font color=#447700>!      write(iunit,*) 'satadj: mgs,iter = ',mgs,itertd,dqwv(mgs),qss(mgs),qx(mgs,lv),qx(mgs,lc)<a name='17545'></font>
<font color=#447700>!<a name='17546'></font>
        qitmp(mgs) = qx(mgs,li)<a name='17547'>
        fracl(mgs) = 1.0<a name='17548'>
        fraci(mgs) = 0.0<a name='17549'>
        if ( temg(mgs) .lt. tfr .and. temg(mgs) .gt. thnuc ) then<a name='17550'>
          fracl(mgs) = max(min(1.,(temg(mgs)-233.15)/(20.)),0.0)<a name='17551'>
          fraci(mgs) = 1.0-fracl(mgs)<a name='17552'>
        end if<a name='17553'>
        if ( temg(mgs) .le. thnuc ) then<a name='17554'>
           fraci(mgs) = 1.0<a name='17555'>
           fracl(mgs) = 0.0<a name='17556'>
         end if<a name='17557'>
        fraci(mgs) = 1.0-fracl(mgs)<a name='17558'>
<font color=#447700>!<a name='17559'></font>
       gamss = (felvcp(mgs)*fracl(mgs) + felscp(mgs)*fraci(mgs))   &amp;<a name='17560'>
     &amp;      / (pi0(mgs))<a name='17561'>
<font color=#447700>!<a name='17562'></font>
      IF ( temg(mgs) .lt. tfr ) then<a name='17563'>
        IF (qx(mgs,lc) .ge. 0.0 .and. qitmp(mgs) .le. qxmin(li) ) then<a name='17564'>
         dqvcnd(mgs) = dqwv(mgs)/(1. + fcqv1(mgs)*qss(mgs)/   &amp;<a name='17565'>
     &amp;  ((temg(mgs)-cbw)**2))<a name='17566'>
        END IF<a name='17567'>
        IF ( qx(mgs,lc) .eq. 0.0 .and. qitmp(mgs) .gt. qxmin(li) ) then<a name='17568'>
          dqvcnd(mgs) = dqwv(mgs)/(1. + fcqv2(mgs)*qss(mgs)/   &amp;<a name='17569'>
     &amp;  ((temg(mgs)-cbi)**2))<a name='17570'>
        END IF<a name='17571'>
        IF ( qx(mgs,lc) .gt. 0.0 .and. qitmp(mgs) .gt. qxmin(li) ) then<a name='17572'>
         cdw = caw*pi0(mgs)*tfrcbw/((temg(mgs)-cbw)**2)<a name='17573'>
         cdi = cai*pi0(mgs)*tfrcbi/((temg(mgs)-cbi)**2)<a name='17574'>
         denom1 = qx(mgs,lc) + qitmp(mgs)<a name='17575'>
         denom2 = 1.0 + gamss*   &amp;<a name='17576'>
     &amp;    (qx(mgs,lc)*qvs(mgs)*cdw + qitmp(mgs)*qis(mgs)*cdi) / denom1<a name='17577'>
         dqvcnd(mgs) =  dqwv(mgs) / denom2<a name='17578'>
        END IF <a name='17579'>
<a name='17580'>
      ENDIF  <font color=#447700>!  temg(mgs) .lt. tfr<a name='17581'></font>
<font color=#447700>!<a name='17582'></font>
      if ( temg(mgs) .ge. tfr ) then<a name='17583'>
      dqvcnd(mgs) = dqwv(mgs)/(1. + fcqv1(mgs)*qss(mgs)/   &amp;<a name='17584'>
     &amp;  ((temg(mgs)-cbw)**2))<a name='17585'>
      end if<a name='17586'>
<font color=#447700>!<a name='17587'></font>
      delqci1=qx(mgs,li)<a name='17588'>
<font color=#447700>!<a name='17589'></font>
      IF ( qitmp(mgs) .gt. qxmin(li) ) THEN<a name='17590'>
        fcci(mgs) = qx(mgs,li)/(qitmp(mgs))<a name='17591'>
      ELSE<a name='17592'>
        fcci(mgs) = 0.0<a name='17593'>
      ENDIF<a name='17594'>
<font color=#447700>!<a name='17595'></font>
      dqcw(mgs) = dqvcnd(mgs)*fracl(mgs)<a name='17596'>
      dqci(mgs) = dqvcnd(mgs)*fraci(mgs)<a name='17597'>
<font color=#447700>!<a name='17598'></font>
      thetap(mgs) = thetap(mgs) +   &amp;<a name='17599'>
     &amp;   (felvcp(mgs)*dqcw(mgs) + felscp(mgs)*dqci(mgs))   &amp;<a name='17600'>
     &amp; / (pi0(mgs))<a name='17601'>
<a name='17602'>
      IF ( eqtset &gt; 2 ) THEN<a name='17603'>
        pipert(mgs) = pipert(mgs) + (0   &amp;<a name='17604'>
     &amp;  +felspi(mgs)*dqci(mgs)    &amp;<a name='17605'>
     &amp;  +felvpi(mgs)*dqcw(mgs))*dtp<a name='17606'>
      ENDIF<a name='17607'>
<a name='17608'>
      qwvp(mgs) = qwvp(mgs) - ( dqvcnd(mgs) )<a name='17609'>
      qx(mgs,lc) = qx(mgs,lc) + dqcw(mgs)<a name='17610'>
      IF ( qitmp(mgs) .gt. qxmin(li) ) THEN<a name='17611'>
        qx(mgs,li) = qx(mgs,li) + dqci(mgs)*fcci(mgs)<a name='17612'>
        qitmp(mgs) = qx(mgs,li)<a name='17613'>
      ENDIF<a name='17614'>
<font color=#447700>!<a name='17615'></font>
<font color=#447700>!      delqci(mgs) =  dqci(mgs)*fcci(mgs)<a name='17616'></font>
<font color=#447700>!<a name='17617'></font>
      END IF <font color=#447700>!  dqwv(mgs) .ge. 0.<a name='17618'></font>
      end do<a name='17619'>
<font color=#447700>!<a name='17620'></font>
      do mgs = 1,ngscnt<a name='17621'>
      qitmp(mgs) = qx(mgs,li)<a name='17622'>
      theta(mgs) = thetap(mgs) + theta0(mgs)<a name='17623'>
      temg(mgs) = <A href='../../html_code/phys/module_diag_afwa.F.html#THETA'>theta</A><A href='../../html_code/phys/module_mp_nssl_2mom.F.html#NSSL_2MOM_GS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_22">(mgs)*pk(mgs) <font color=#447700>! ( pres(mgs) / poo ) ** cap<a name='17624'></font>
      qvap(mgs) = Max((qwvp(mgs) + qv0(mgs)), 0.0)<a name='17625'>
      temcg(mgs) = temg(mgs) - tfr<a name='17626'>
      tqvcon = temg(mgs)-cbw<a name='17627'>
      ltemq = (temg(mgs)-163.15)/fqsat+1.5<a name='17628'>
      ltemq = Min( nqsat, Max(1,ltemq) )<a name='17629'>
      qvs(mgs) = pqs(mgs)*tabqvs(ltemq)<a name='17630'>
      qis(mgs) = pqs(mgs)*tabqis(ltemq)<a name='17631'>
      qx(mgs,lc) = max( 0.0, qx(mgs,lc) )<a name='17632'>
      qitmp(mgs) = max( 0.0, qitmp(mgs) )<a name='17633'>
      qx(mgs,lv) = max( 0.0, qvap(mgs))<a name='17634'>
<font color=#447700>!      if ( temg(mgs) .lt. tfr ) then<a name='17635'></font>
<font color=#447700>!      if( qx(mgs,lc) .ge. 0.0 .and. qitmp(mgs) .le. qxmin(li) )<a name='17636'></font>
<font color=#447700>!     &gt;  qss(mgs) = qvs(mgs)<a name='17637'></font>
<font color=#447700>!c      if( qx(mgs,lc) .le. qxmin(lc) .and. qitmp(mgs) .gt. qxmin(li))<a name='17638'></font>
<font color=#447700>!      if( qx(mgs,lc) .eq. 0.0 .and. qitmp(mgs) .gt. qxmin(li))<a name='17639'></font>
<font color=#447700>!     &gt;  qss(mgs) = qis(mgs)<a name='17640'></font>
<font color=#447700>!c      if( qx(mgs,lc) .gt. qxmin(lc) .and. qitmp(mgs) .gt. qxmin(li))<a name='17641'></font>
<font color=#447700>!      if( qx(mgs,lc) .gt. 0.0 .and. qitmp(mgs) .gt. qxmin(li))<a name='17642'></font>
<font color=#447700>!     &gt;  qss(mgs) = (qx(mgs,lc)*qvs(mgs) + qitmp(mgs)*qis(mgs)) /<a name='17643'></font>
<font color=#447700>!     &gt; (qx(mgs,lc) + qitmp(mgs))<a name='17644'></font>
<font color=#447700>!      else<a name='17645'></font>
<font color=#447700>!      qss(mgs) = qvs(mgs)<a name='17646'></font>
<font color=#447700>!      end if<a name='17647'></font>
      qss(mgs) = qvs(mgs)<a name='17648'>
      if ( temg(mgs) .lt. tfr ) then<a name='17649'>
      if( qx(mgs,lc) .ge. 0.0 .and. qitmp(mgs) .le. qxmin(li) )   &amp;<a name='17650'>
     &amp;  qss(mgs) = qvs(mgs)<a name='17651'>
      if( qx(mgs,lc) .le. qxmin(lc) .and. qitmp(mgs) .gt. qxmin(li))   &amp;<a name='17652'>
     &amp;  qss(mgs) = qis(mgs)<a name='17653'>
      if( qx(mgs,lc) .gt. qxmin(lc) .and. qitmp(mgs) .gt. qxmin(li))   &amp;<a name='17654'>
     &amp;   qss(mgs) = (qx(mgs,lc)*qvs(mgs) + qitmp(mgs)*qis(mgs)) /   &amp;<a name='17655'>
     &amp;   (qx(mgs,lc) + qitmp(mgs))<a name='17656'>
      end if<a name='17657'>
<font color=#447700>!      pceds(mgs) = (thetap(mgs) - thsave(mgs))/dtp<a name='17658'></font>
<font color=#447700>!      write(iunit,*) 'satadj2: mgs,iter = ',mgs,itertd,dqwv(mgs),qss(mgs),qx(mgs,lv),qx(mgs,lc)<a name='17659'></font>
      end do<a name='17660'>
<font color=#447700>!<a name='17661'></font>
<font color=#447700>!  end the saturation adjustment iteration loop<a name='17662'></font>
<font color=#447700>!<a name='17663'></font>
      end do<a name='17664'>
<a name='17665'>
     ENDIF <font color=#447700>! ( ipconc .le. 1 )<a name='17666'></font>
<a name='17667'>
<font color=#447700>!<a name='17668'></font>
<font color=#447700>!  spread the growth owing to vapor diffusion onto the<a name='17669'></font>
<font color=#447700>!  ice crystal categories using the<a name='17670'></font>
<font color=#447700>!<a name='17671'></font>
<font color=#447700>!  END OF SATURATION ADJUSTMENT<a name='17672'></font>
<font color=#447700>!<a name='17673'></font>
<a name='17674'>
      if (ndebug .gt. 0 ) write(0,*) 'conc 30b'<a name='17675'>
<font color=#447700>!<a name='17676'></font>
<font color=#447700>!<a name='17677'></font>
<font color=#447700>!  end of saturation adjustment<a name='17678'></font>
<a name='17679'>
<font color=#447700>!<a name='17680'></font>
<font color=#447700>!<a name='17681'></font>
<font color=#447700>! !DIR$ IVDEP<a name='17682'></font>
      do mgs = 1,ngscnt<a name='17683'>
      t0(igs(mgs),jy,kgs(mgs)) =  temg(mgs)<a name='17684'>
      end do<a name='17685'>
<font color=#447700>!<a name='17686'></font>
<font color=#447700>! Load the save arrays<a name='17687'></font>
<font color=#447700>!<a name='17688'></font>
<a name='17689'>
<a name='17690'>
<a name='17691'>
      if (ndebug .gt. 0 ) write(0,*) 'gs 11'<a name='17692'>
<a name='17693'>
      do mgs = 1,ngscnt<a name='17694'>
<font color=#447700>!<a name='17695'></font>
      an(igs(mgs),jy,kgs(mgs),lt) =    &amp;<a name='17696'>
     &amp;  theta0(mgs) + thetap(mgs) <a name='17697'>
      an(igs(mgs),jy,kgs(mgs),lv) = qwvp(mgs) + qv0(mgs) <font color=#447700>!<a name='17698'></font>
<a name='17699'>
      IF ( eqtset &gt; 2 ) THEN<a name='17700'>
        p2(igs(mgs),jy,kgs(mgs)) = pipert(mgs)<a name='17701'>
      ENDIF<a name='17702'>
<font color=#447700>!<a name='17703'></font>
      <a name='17704'>
      DO il = lc,lhab<a name='17705'>
        IF ( ido(il) .eq. 1 ) THEN<a name='17706'>
         an(igs(mgs),jy,kgs(mgs),il) = qx(mgs,il) +   &amp;<a name='17707'>
     &amp;     min( an(igs(mgs),jy,kgs(mgs),il), 0.0 )<a name='17708'>
         qx(mgs,il) = an(igs(mgs),jy,kgs(mgs),il)<a name='17709'>
        ENDIF<a name='17710'>
      ENDDO<a name='17711'>
<a name='17712'>
      IF ( lcina &gt; 1 ) THEN<a name='17713'>
        an(igs(mgs),jy,kgs(mgs),lcina) = cina(mgs)<a name='17714'>
      ENDIF<a name='17715'>
<a name='17716'>
<a name='17717'>
<font color=#447700>!<a name='17718'></font>
      end do<a name='17719'>
<font color=#447700>!<a name='17720'></font>
<a name='17721'>
      if ( ipconc .ge. 1 ) then<a name='17722'>
      DO il = lc,lhab <font color=#447700>!{<a name='17723'></font>
<a name='17724'>
<font color=#447700>!        write(0,*) 'limiter loop: il,ipc,lz: ',il,ipc(il),lz(il),ipconc<a name='17725'></font>
<a name='17726'>
       IF ( ipconc .ge. ipc(il) .and. ido(il) &gt; 0 ) THEN <font color=#447700>! {<a name='17727'></font>
<a name='17728'>
         IF (  ipconc .ge. 4 .and. ipc(il) .ge. 1 ) THEN <font color=#447700>! {<a name='17729'></font>
<a name='17730'>
<font color=#447700>!            write(0,*) 'MY limiter: il,ipc,lz: ',il,ipc(il),lz(il),lr,lzr<a name='17731'></font>
<font color=#447700>!            STOP<a name='17732'></font>
<a name='17733'>
          IF ( lz(il) &lt;= 1 .or. ioldlimiter == 1 ) THEN <font color=#447700>! { { is a two-moment category so dont worry about reflectivity<a name='17734'></font>
          <a name='17735'>
<a name='17736'>
           DO mgs = 1,ngscnt<a name='17737'>
            IF ( qx(mgs,il) .le. 0.0 ) THEN<a name='17738'>
              cx(mgs,il) = 0.0<a name='17739'>
            ELSE <font color=#447700>!{<a name='17740'></font>
              IF ( cx(mgs,il) .gt. cxmin ) THEN <font color=#447700>!{<a name='17741'></font>
<font color=#447700>!              xv(mgs,il) = rho0(mgs)*qx(mgs,il)/(xdn(mgs,il)*Max(1.0e-9,cx(mgs,il)))<a name='17742'></font>
<font color=#447700>!              xv(mgs,il) = rho0(mgs)*qx(mgs,il)/(xdn(mgs,il)*Max(cxmin,cx(mgs,il)))<a name='17743'></font>
                xv(mgs,il) = rho0(mgs)*qx(mgs,il)/(xdn(mgs,il)*cx(mgs,il))<a name='17744'>
              <a name='17745'>
<font color=#447700>!              IF ( lhl .gt. 1 .and. il .eq. lhl ) THEN<a name='17746'></font>
<font color=#447700>!               write(0,*) 'dr: xv,cx,qx,xdn,ln = ',xv(mgs,il),cx(mgs,il),qx(mgs,il),xdn(mgs,il),ln(il)<a name='17747'></font>
<font color=#447700>!              ENDIF<a name='17748'></font>
<a name='17749'>
               <font color=#447700>! 8/26/2015 erm: apply imaxdiaopt for 2-moment also<a name='17750'></font>
               IF ( imaxdiaopt == 1 .or. il == lc .or. il == li .or. (il == lr .and. imurain == 3) .or. (il == ls .and. imusnow == 3 ) ) THEN<a name='17751'>
                 xvbarmax = xvmx(il)<a name='17752'>
               ELSEIF ( imaxdiaopt == 2 ) THEN <font color=#447700>! test against maximum mass diameter<a name='17753'></font>
                 xvbarmax = xvmx(il) /((3. + alpha(mgs,il))**3/((3. + alpha(mgs,il))*(2. + alpha(mgs,il))*(1. + alpha(mgs,il))))<a name='17754'>
               ELSEIF ( imaxdiaopt == 3 ) THEN <font color=#447700>! test against mass-weighted diameter<a name='17755'></font>
                 xvbarmax = xvmx(il) /((4. + alpha(mgs,il))**3/((3. + alpha(mgs,il))*(2. + alpha(mgs,il))*(1. + alpha(mgs,il))))<a name='17756'>
               ENDIF<a name='17757'>
<a name='17758'>
               tmp = 1.0<a name='17759'>
               IF ( il == ls ) THEN<a name='17760'>
                 xvbarmax = xvbarmax*Max(1.,100./Min(100.,xdn(mgs,ls)))<a name='17761'>
               ENDIF<a name='17762'>
               <a name='17763'>
               IF ( xv(mgs,il) .lt. xvmn(il) .or. xv(mgs,il) .gt. xvbarmax ) THEN<a name='17764'>
                xv(mgs,il) = Min( xvbarmax, xv(mgs,il) )<a name='17765'>
                xv(mgs,il) = Max( xvmn(il), xv(mgs,il) )<a name='17766'>
                cx(mgs,il) = rho0(mgs)*qx(mgs,il)/(xv(mgs,il)*xdn(mgs,il))<a name='17767'>
               ENDIF<a name='17768'>
              <a name='17769'>
             ENDIF <font color=#447700>!}<a name='17770'></font>
<a name='17771'>
<font color=#447700>!              IF ( lhl .gt. 1 .and. il .eq. lhl ) THEN<a name='17772'></font>
<font color=#447700>!               write(0,*) 'dr: xv,cx,= ',xv(mgs,il),cx(mgs,il)<a name='17773'></font>
<font color=#447700>!              ENDIF<a name='17774'></font>
<a name='17775'>
            ENDIF <font color=#447700>!}<a name='17776'></font>
           ENDDO <font color=#447700>! mgs<a name='17777'></font>
          <a name='17778'>
          <a name='17779'>
          ENDIF <font color=#447700>! }}<a name='17780'></font>
          ENDIF <font color=#447700>! }<a name='17781'></font>
<a name='17782'>
          DO mgs = 1,ngscnt<a name='17783'>
            an(igs(mgs),jy,kgs(mgs),ln(il)) = Max(cx(mgs,il), 0.0)<a name='17784'>
          ENDDO<a name='17785'>
        ENDIF <font color=#447700>! }<a name='17786'></font>
      ENDDO <font color=#447700>! il }<a name='17787'></font>
<a name='17788'>
      IF ( lcin &gt; 1 ) THEN<a name='17789'>
      do mgs = 1,ngscnt<a name='17790'>
        an(igs(mgs),jy,kgs(mgs),lcin) = Max(0.0, ccin(mgs))<a name='17791'>
      end do<a name='17792'>
      ENDIF<a name='17793'>
<a name='17794'>
      IF ( ipconc .ge. 2 ) THEN<a name='17795'>
      do mgs = 1,ngscnt<a name='17796'>
        IF ( lss &gt; 1 ) THEN<a name='17797'>
          an(igs(mgs),jy,kgs(mgs),lss) = Max(0.0, ssmax(mgs) )<a name='17798'>
        ENDIF<a name='17799'>
<a name='17800'>
        IF ( lccn &gt; 1 ) THEN<a name='17801'>
          an(igs(mgs),jy,kgs(mgs),lccn) = Max(0.0, ccnc(mgs) )<a name='17802'>
        ENDIF<a name='17803'>
      end do<a name='17804'>
      ENDIF<a name='17805'>
      <a name='17806'>
      ELSEIF ( ipconc .eq. 0 .and. lni .gt. 1 ) THEN<a name='17807'>
      <a name='17808'>
          DO mgs = 1,ngscnt<a name='17809'>
            an(igs(mgs),jy,kgs(mgs),lni) = Max(cx(mgs,li), 0.0)<a name='17810'>
          ENDDO<a name='17811'>
<a name='17812'>
<a name='17813'>
      end if<a name='17814'>
<a name='17815'>
      IF ( ldovol ) THEN<a name='17816'>
<a name='17817'>
       DO il = li,lhab<a name='17818'>
<a name='17819'>
        IF ( lvol(il) .ge. 1 ) THEN<a name='17820'>
<a name='17821'>
          DO mgs = 1,ngscnt<a name='17822'>
<a name='17823'>
           an(igs(mgs),jy,kgs(mgs),lvol(il)) = Max( 0.0, vx(mgs,il) )<a name='17824'>
          ENDDO<a name='17825'>
          <a name='17826'>
        ENDIF<a name='17827'>
      <a name='17828'>
       ENDDO<a name='17829'>
      <a name='17830'>
      ENDIF<a name='17831'>
<font color=#447700>!<a name='17832'></font>
<font color=#447700>!<a name='17833'></font>
<font color=#447700>!<a name='17834'></font>
<font color=#447700>!<a name='17835'></font>
<font color=#447700>!<a name='17836'></font>
      if (ndebug .gt. 0 ) write(0,*) 'gs 12'<a name='17837'>
<a name='17838'>
<a name='17839'>
<a name='17840'>
      if (ndebug .gt. 0 ) write(0,*) 'gs 13'<a name='17841'>
<a name='17842'>
 9998 continue<a name='17843'>
<a name='17844'>
      if ( kz .gt. nz-1 .and. ix .ge. itile) then<a name='17845'>
        if ( ix .ge. itile ) then<a name='17846'>
         go to 1200 <font color=#447700>! exit gather scatter<a name='17847'></font>
        else<a name='17848'>
         nzmpb = kz<a name='17849'>
        endif<a name='17850'>
      else<a name='17851'>
        nzmpb = kz<a name='17852'>
      end if<a name='17853'>
<a name='17854'>
      if ( ix .ge. itile ) then<a name='17855'>
        nxmpb = 1<a name='17856'>
        nzmpb = kz+1<a name='17857'>
      else<a name='17858'>
       nxmpb = ix+1<a name='17859'>
      end if<a name='17860'>
<a name='17861'>
 1000 continue<a name='17862'>
 1200 continue<a name='17863'>
<font color=#447700>!<a name='17864'></font>
<font color=#447700>!  end of gather scatter (for this jy slice)<a name='17865'></font>
<font color=#447700>!<a name='17866'></font>
<font color=#447700>!<a name='17867'></font>
<a name='17868'>
      return<a name='17869'>
      end subroutine nssl_2mom_gs<a name='17870'>
<font color=#447700>!<a name='17871'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='17872'></font>
<font color=#447700>!<a name='17873'></font>
<a name='17874'>
<a name='17875'>
<a name='17876'>
<font color=#447700>!<a name='17877'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='17878'></font>
<font color=#447700>!<a name='17879'></font>
<a name='17880'>
<a name='17881'>
END MODULE module_mp_nssl_2mom<a name='17882'>
</pre></body></html>