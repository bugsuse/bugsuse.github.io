<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_CU_G3'><A href='../../html_code/phys/module_cu_g3.F.html#MODULE_CU_G3' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_g3</font> <A href='../../call_to/MODULE_CU_G3.html' TARGET='index'>2</A><a name='6'>
<a name='7'>
CONTAINS<a name='8'>
<a name='9'>
<font color=#447700>!-------------------------------------------------------------<a name='10'></font>
<A NAME='G3DRV'><A href='../../html_code/phys/module_cu_g3.F.html#G3DRV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>G3DRV</font>(                                            &amp; <A href='../../call_to/G3DRV.html' TARGET='index'>1</A>,<A href='../../call_from/G3DRV.html' TARGET='index'>1</A><a name='12'>
               DT,itimestep,DX                                  &amp;<a name='13'>
              ,rho,RAINCV,PRATEC                                &amp;<a name='14'>
              ,U,V,t,W,q,p,pi                                   &amp;<a name='15'>
              ,dz8w,p8w,XLV,CP,G,r_v                            &amp;<a name='16'>
              ,htop,hbot                                        &amp;<a name='17'>
              ,CU_ACT_FLAG,warm_rain                            &amp;<a name='18'>
              ,APR_GR,APR_W,APR_MC,APR_ST,APR_AS                &amp;<a name='19'>
              ,APR_CAPMA,APR_CAPME,APR_CAPMI                    &amp;<a name='20'>
              ,MASS_FLUX,XF_ENS,PR_ENS,HT,XLAND,gsw,edt_out     &amp;<a name='21'>
              ,GDC,GDC2 ,kpbl,k22_shallow,kbcon_shallow         &amp;<a name='22'>
              ,ktop_shallow,xmb_shallow,ktop_deep               &amp;<a name='23'>
              ,cugd_tten,cugd_qvten ,cugd_qcten                 &amp;<a name='24'>
              ,cugd_ttens,cugd_qvtens,cugd_avedx,imomentum      &amp;<a name='25'>
              ,ensdim,maxiens,maxens,maxens2,maxens3,ichoice    &amp;<a name='26'>
              ,ishallow_g3,ids,ide, jds,jde, kds,kde            &amp;<a name='27'>
              ,ims,ime, jms,jme, kms,kme                        &amp;<a name='28'>
              ,ips,ipe, jps,jpe, kps,kpe                        &amp;<a name='29'>
              ,its,ite, jts,jte, kts,kte                        &amp;<a name='30'>
              ,periodic_x,periodic_y                            &amp;<a name='31'>
              ,RQVCUTEN,RQCCUTEN,RQICUTEN                       &amp;<a name='32'>
              ,RQVFTEN,RTHFTEN,RTHCUTEN                         &amp;<a name='33'>
              ,rqvblten,rthblten                                &amp;<a name='34'>
              ,F_QV    ,F_QC    ,F_QR    ,F_QI    ,F_QS         &amp;<a name='35'>
#if ( WRF_DFI_RADAR == 1 )<a name='36'>
                 <font color=#447700>! Optional CAP suppress option<a name='37'></font>
              ,do_capsuppress,cap_suppress_loc                  &amp;<a name='38'>
#endif                                 <a name='39'>
                                                                )<a name='40'>
<font color=#447700>!-------------------------------------------------------------<a name='41'></font>
   IMPLICIT NONE<a name='42'>
<font color=#447700>!-------------------------------------------------------------<a name='43'></font>
   INTEGER,      INTENT(IN   ) ::                               &amp;<a name='44'>
                                  ids,ide, jds,jde, kds,kde,    &amp; <a name='45'>
                                  ims,ime, jms,jme, kms,kme,    &amp; <a name='46'>
                                  ips,ipe, jps,jpe, kps,kpe,    &amp; <a name='47'>
                                  its,ite, jts,jte, kts,kte<a name='48'>
   LOGICAL periodic_x,periodic_y<a name='49'>
               integer, parameter  :: ens4_spread = 3 <font color=#447700>! max(3,cugd_avedx)<a name='50'></font>
               integer, parameter  :: ens4=ens4_spread*ens4_spread<a name='51'>
<a name='52'>
   integer, intent (in   )              ::                      &amp;<a name='53'>
                       ensdim,maxiens,maxens,maxens2,maxens3,ichoice<a name='54'>
  <a name='55'>
   INTEGER,      INTENT(IN   ) :: ITIMESTEP,cugd_avedx, &amp;<a name='56'>
                                  ishallow_g3,imomentum<a name='57'>
   LOGICAL,      INTENT(IN   ) :: warm_rain<a name='58'>
<a name='59'>
   REAL,         INTENT(IN   ) :: XLV, R_v<a name='60'>
   REAL,         INTENT(IN   ) :: CP,G<a name='61'>
<a name='62'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         ,    &amp;<a name='63'>
          INTENT(IN   ) ::                                      &amp;<a name='64'>
                                                          U,    &amp;<a name='65'>
                                                          V,    &amp;<a name='66'>
                                                          W,    &amp;<a name='67'>
                                                         pi,    &amp;<a name='68'>
                                                          t,    &amp;<a name='69'>
                                                          q,    &amp;<a name='70'>
                                                          p,    &amp;<a name='71'>
                                                       dz8w,    &amp;<a name='72'>
                                                       p8w,    &amp;<a name='73'>
                                                        rho<a name='74'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         ,    &amp;<a name='75'>
          OPTIONAL                                         ,    &amp;<a name='76'>
          INTENT(INOUT   ) ::                                   &amp;<a name='77'>
               GDC,GDC2<a name='78'>
<a name='79'>
   REAL, DIMENSION( ims:ime , jms:jme ),INTENT(IN) :: GSW,HT,XLAND<a name='80'>
   INTEGER, DIMENSION( ims:ime , jms:jme ),INTENT(IN) :: KPBL<a name='81'>
   INTEGER, DIMENSION( ims:ime , jms:jme ),INTENT(INOUT) :: k22_shallow, &amp;<a name='82'>
                 kbcon_shallow,ktop_shallow<a name='83'>
   INTEGER, DIMENSION( ims:ime , jms:jme ),INTENT(  OUT) :: ktop_deep<a name='84'>
<font color=#447700>!<a name='85'></font>
   REAL, INTENT(IN   ) :: DT, DX<a name='86'>
<font color=#447700>!<a name='87'></font>
<a name='88'>
   REAL, DIMENSION( ims:ime , jms:jme ),                        &amp;<a name='89'>
         INTENT(INOUT) ::           pratec,RAINCV, MASS_FLUX,   &amp;<a name='90'>
                          APR_GR,APR_W,APR_MC,APR_ST,APR_AS,    &amp;<a name='91'>
                         edt_out,APR_CAPMA,APR_CAPME,APR_CAPMI, &amp;<a name='92'>
                         htop,hbot,xmb_shallow<a name='93'>
<font color=#447700>!+lxz<a name='94'></font>
<font color=#447700>!  REAL, DIMENSION( ims:ime , jms:jme ) :: &amp; !, INTENT(INOUT) ::       &amp;<a name='95'></font>
<font color=#447700>!        HTOP,     &amp;! highest model layer penetrated by cumulus since last reset in radiation_driver<a name='96'></font>
<font color=#447700>!        HBOT       ! lowest  model layer penetrated by cumulus since last reset in radiation_driver<a name='97'></font>
<font color=#447700>!                   ! HBOT&gt;HTOP follow physics leveling convention<a name='98'></font>
<a name='99'>
   LOGICAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='100'>
         INTENT(INOUT) ::                       CU_ACT_FLAG<a name='101'>
<a name='102'>
<font color=#447700>!<a name='103'></font>
<font color=#447700>! Optionals<a name='104'></font>
<font color=#447700>!<a name='105'></font>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='106'>
         OPTIONAL,                                              &amp;<a name='107'>
         INTENT(INOUT) ::                           RTHFTEN,    &amp;<a name='108'>
                            cugd_tten,cugd_qvten,cugd_qcten,    &amp;<a name='109'>
                            cugd_ttens,cugd_qvtens,             &amp;<a name='110'>
                                                    RQVFTEN<a name='111'>
<a name='112'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='113'>
         OPTIONAL,                                              &amp;<a name='114'>
         INTENT(INOUT) ::                                       &amp;<a name='115'>
                                                   RTHCUTEN,    &amp;<a name='116'>
                                                   RQVCUTEN,    &amp;<a name='117'>
                                                   RQVBLTEN,    &amp;<a name='118'>
                                                   RTHBLTEN,    &amp;<a name='119'>
                                                   RQCCUTEN,    &amp;<a name='120'>
                                                   RQICUTEN<a name='121'>
<font color=#447700>!<a name='122'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='123'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='124'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='125'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='126'></font>
<font color=#447700>! use or not.<a name='127'></font>
<font color=#447700>!<a name='128'></font>
   LOGICAL, OPTIONAL ::                                      &amp;<a name='129'>
                                                   F_QV      &amp;<a name='130'>
                                                  ,F_QC      &amp;<a name='131'>
                                                  ,F_QR      &amp;<a name='132'>
                                                  ,F_QI      &amp;<a name='133'>
                                                  ,F_QS<a name='134'>
<a name='135'>
<a name='136'>
#if ( WRF_DFI_RADAR == 1 )<a name='137'>
<font color=#447700>!<a name='138'></font>
<font color=#447700>!  option of cap suppress: <a name='139'></font>
<font color=#447700>!        do_capsuppress = 1   do<a name='140'></font>
<font color=#447700>!        do_capsuppress = other   don't<a name='141'></font>
<font color=#447700>!<a name='142'></font>
<font color=#447700>!<a name='143'></font>
   INTEGER,      INTENT(IN   ) ,OPTIONAL   :: do_capsuppress<a name='144'>
   REAL, DIMENSION( ims:ime, jms:jme ),INTENT(IN   ),OPTIONAL  :: cap_suppress_loc<a name='145'>
   REAL, DIMENSION( its:ite ) :: cap_suppress_j<a name='146'>
#endif<a name='147'>
<a name='148'>
<a name='149'>
<font color=#447700>! LOCAL VARS<a name='150'></font>
     real,    dimension(ims:ime,jms:jme,1:ensdim),intent(inout) ::      &amp;<a name='151'>
        xf_ens,pr_ens<a name='152'>
     real,    dimension ( its:ite , jts:jte , 1:ensdim) ::      &amp;<a name='153'>
        massflni,xfi_ens,pri_ens<a name='154'>
   REAL, DIMENSION( its:ite , jts:jte ) ::            MASSI_FLX,    &amp;<a name='155'>
                          APRi_GR,APRi_W,APRi_MC,APRi_ST,APRi_AS,    &amp;<a name='156'>
                         edti_out,APRi_CAPMA,APRi_CAPME,APRi_CAPMI,gswi<a name='157'>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='158'>
        SUBT,SUBQ,OUTT,OUTQ,OUTQC,phh,subm,cupclw,dhdt,         &amp;<a name='159'>
        outts,outqs<a name='160'>
     real,    dimension (its:ite)         ::                    &amp;<a name='161'>
        pret, ter11, aa0, fp,xlandi<a name='162'>
<font color=#447700>!+lxz<a name='163'></font>
     integer, dimension (its:ite) ::                            &amp;<a name='164'>
        kbcon, ktop,kpbli,k22s,kbcons,ktops<a name='165'>
<font color=#447700>!.lxz<a name='166'></font>
     integer, dimension (its:ite,jts:jte) ::                    &amp;<a name='167'>
        iact_old_gr<a name='168'>
     integer :: iens,ibeg,iend,jbeg,jend,n,nn,ens4n<a name='169'>
     integer :: ibegh,iendh,jbegh,jendh<a name='170'>
     integer :: ibegc,iendc,jbegc,jendc<a name='171'>
<a name='172'>
<font color=#447700>!<a name='173'></font>
<font color=#447700>! basic environmental input includes moisture convergence (mconv)<a name='174'></font>
<font color=#447700>! omega (omeg), windspeed (us,vs), and a flag (aaeq) to turn off<a name='175'></font>
<font color=#447700>! convection for this call only and at that particular gridpoint<a name='176'></font>
<font color=#447700>!<a name='177'></font>
     real,    dimension (its:ite,kts:kte) ::                    &amp;<a name='178'>
        T2d,q2d,PO,P2d,US,VS,tn,qo,tshall,qshall<a name='179'>
     real,    dimension (ips-2:ipe+2,kps:kpe,jps-2:jpe+2) ::    &amp;<a name='180'>
        ave_f_t,ave_f_q<a name='181'>
     real,    dimension (its:ite,kts:kte,1:ens4) ::                    &amp;<a name='182'>
        omeg,tx,qx<a name='183'>
     real, dimension (its:ite)            ::                    &amp;<a name='184'>
        Z1,PSUR,AAEQ,direction,cuten,umean,vmean,pmean,xmbs<a name='185'>
     real, dimension (its:ite,1:ens4)     ::                    &amp;<a name='186'>
        mconv<a name='187'>
<a name='188'>
   INTEGER :: i,j,k,ICLDCK,ipr,jpr<a name='189'>
   REAL    :: tcrit,tscl_KF,dp,dq,sub_spread,subcenter<a name='190'>
   INTEGER :: itf,jtf,ktf,iss,jss,nbegin,nend<a name='191'>
   INTEGER :: high_resolution<a name='192'>
   REAL    :: rkbcon,rktop        <font color=#447700>!-lxz<a name='193'></font>
<font color=#447700>! ruc variable<a name='194'></font>
     real, dimension (its:ite)            ::  tkm<a name='195'>
<a name='196'>
  <font color=#447700>! A. Betts for shallow convection: suggestion for the KF timescale &lt; DELTAX  / 25 m/s<a name='197'></font>
   tscl_kf=dx/25.<a name='198'>
  <font color=#447700>!<a name='199'></font>
<font color=#447700>!   write(0,*)'ishallow = ',ishallow_g3<a name='200'></font>
   high_resolution=0<a name='201'>
   if(cugd_avedx.gt.1) high_resolution=1<a name='202'>
   subcenter=0.<a name='203'>
<font color=#447700>!  subcenter=1./float(cugd_avedx)<a name='204'></font>
   sub_spread=max(1.,float(cugd_avedx*cugd_avedx-1))<a name='205'>
   sub_spread=(1.-subcenter)/sub_spread<a name='206'>
   iens=1<a name='207'>
   ipr=43<a name='208'>
   jpr=1<a name='209'>
   ipr=0<a name='210'>
   jpr=0<a name='211'>
<font color=#447700>!  if(itimestep.eq.8)then<a name='212'></font>
<font color=#447700>!   ipr=37<a name='213'></font>
<font color=#447700>!   jpr=16<a name='214'></font>
<font color=#447700>!  endif<a name='215'></font>
   IF ( periodic_x ) THEN<a name='216'>
      ibeg=max(its,ids)<a name='217'>
      iend=min(ite,ide-1)<a name='218'>
      ibegc=max(its,ids)<a name='219'>
      iendc=min(ite,ide-1)<a name='220'>
   ELSE<a name='221'>
      ibeg=max(its,ids)<a name='222'>
      iend=min(ite,ide-1)<a name='223'>
      ibegc=max(its,ids+4)<a name='224'>
      iendc=min(ite,ide-5)<a name='225'>
   END IF<a name='226'>
   IF ( periodic_y ) THEN<a name='227'>
      jbeg=max(jts,jds)<a name='228'>
      jend=min(jte,jde-1)<a name='229'>
      jbegc=max(jts,jds)<a name='230'>
      jendc=min(jte,jde-1)<a name='231'>
   ELSE<a name='232'>
      jbeg=max(jts,jds)<a name='233'>
      jend=min(jte,jde-1)<a name='234'>
      jbegc=max(jts,jds+4)<a name='235'>
      jendc=min(jte,jde-5)<a name='236'>
   END IF<a name='237'>
   do j=jts,jte<a name='238'>
   do i=its,ite<a name='239'>
     k22_shallow(i,j)=0<a name='240'>
     kbcon_shallow(i,j)=0<a name='241'>
     ktop_shallow(i,j)=0<a name='242'>
     xmb_shallow(i,j)=0<a name='243'>
     ktop_deep(i,j)=0<a name='244'>
   enddo<a name='245'>
   enddo<a name='246'>
   tcrit=258.<a name='247'>
   ave_f_t=0.<a name='248'>
   ave_f_q=0.<a name='249'>
<a name='250'>
   itf=MIN(ite,ide-1)<a name='251'>
   ktf=MIN(kte,kde-1)<a name='252'>
   jtf=MIN(jte,jde-1)<a name='253'>
<font color=#447700>!                                                                      <a name='254'></font>
#if ( EM_CORE == 1 )<a name='255'>
     if(high_resolution.eq.1)then<a name='256'>
<font color=#447700>!<a name='257'></font>
<font color=#447700>! calculate these on the halo...the incominh tendencies have been exchanged on a 24pt halo<a name='258'></font>
<font color=#447700>! only neede for high resolution run<a name='259'></font>
<font color=#447700>!<a name='260'></font>
     ibegh=its<a name='261'>
     jbegh=jts<a name='262'>
     iendh=ite<a name='263'>
     jendh=jte<a name='264'>
     if(its.eq.ips)ibegh=max(its-1,ids)<a name='265'>
     if(jts.eq.jps)jbegh=max(jts-1,jds)<a name='266'>
     if(jte.eq.jpe)jendh=min(jte+1,jde-1)<a name='267'>
     if(ite.eq.ipe)iendh=min(ite+1,ide-1)<a name='268'>
        DO J = jbegh,jendh<a name='269'>
        DO k= kts,ktf<a name='270'>
        DO I= ibegh,iendh<a name='271'>
          ave_f_t(i,k,j)=(rthften(i-1,k,j-1)+rthften(i-1,k,j) + rthften(i-1,k,j+1)+ &amp;<a name='272'>
                         rthften(i,k,j-1)   +rthften(i,k,j)   +rthften(i,k,j+1)+         &amp;<a name='273'>
                         rthften(i+1,k,j-1) +rthften(i+1,k,j) +rthften(i+1,k,j+1))/9.<a name='274'>
          ave_f_q(i,k,j)=(rqvften(i-1,k,j-1)+rqvften(i-1,k,j) + rqvften(i-1,k,j+1)+ &amp;<a name='275'>
                         rqvften(i,k,j-1)   +rqvften(i,k,j)   +rqvften(i,k,j+1)+         &amp;<a name='276'>
                         rqvften(i+1,k,j-1) +rqvften(i+1,k,j) +rqvften(i+1,k,j+1))/9.<a name='277'>
<font color=#447700>!         ave_f_t(i,k,j)=rthften(i,k,j)<a name='278'></font>
<font color=#447700>!         ave_f_q(i,k,j)=rqvften(i,k,j)<a name='279'></font>
        ENDDO<a name='280'>
        ENDDO<a name='281'>
        ENDDO<a name='282'>
     endif<a name='283'>
#endif<a name='284'>
     DO 100 J = jts,jtf  <a name='285'>
     DO n= 1,ensdim<a name='286'>
     DO I= its,itf<a name='287'>
       xfi_ens(i,j,n)=0.<a name='288'>
       pri_ens(i,j,n)=0.<a name='289'>
<font color=#447700>!      xfi_ens(i,j,n)=xf_ens(i,j,n)<a name='290'></font>
<font color=#447700>!      pri_ens(i,j,n)=pr_ens(i,j,n)<a name='291'></font>
     ENDDO<a name='292'>
     ENDDO<a name='293'>
     DO I= its,itf<a name='294'>
        kbcon(i)=0<a name='295'>
        ktop(i)=0<a name='296'>
        tkm(i)=0.<a name='297'>
        HBOT(I,J)  =REAL(KTE)<a name='298'>
        HTOP(I,J)  =REAL(KTS)<a name='299'>
        iact_old_gr(i,j)=0<a name='300'>
        mass_flux(i,j)=0.<a name='301'>
        massi_flx(i,j)=0.<a name='302'>
        raincv(i,j)=0.<a name='303'>
        pratec (i,j)=0.<a name='304'>
        edt_out(i,j)=0.<a name='305'>
        edti_out(i,j)=0.<a name='306'>
        gswi(i,j)=gsw(i,j)<a name='307'>
        xlandi(i)=xland(i,j)<a name='308'>
        APRi_GR(i,j)=apr_gr(i,j)<a name='309'>
        APRi_w(i,j)=apr_w(i,j)<a name='310'>
        APRi_mc(i,j)=apr_mc(i,j)<a name='311'>
        APRi_st(i,j)=apr_st(i,j)<a name='312'>
        APRi_as(i,j)=apr_as(i,j)<a name='313'>
        APRi_capma(i,j)=apr_capma(i,j)<a name='314'>
        APRi_capme(i,j)=apr_capme(i,j)<a name='315'>
        APRi_capmi(i,j)=apr_capmi(i,j)<a name='316'>
        CU_ACT_FLAG(i,j) = .true.<a name='317'>
     ENDDO<a name='318'>
     do k=kts,kte<a name='319'>
     DO I= its,itf<a name='320'>
       cugd_tten(i,k,j)=0.<a name='321'>
       cugd_ttens(i,k,j)=0.<a name='322'>
       cugd_qvten(i,k,j)=0.<a name='323'>
       cugd_qvtens(i,k,j)=0.<a name='324'>
       cugd_qcten(i,k,j)=0.<a name='325'>
     ENDDO<a name='326'>
     ENDDO<a name='327'>
     DO n=1,ens4<a name='328'>
     DO I= its,itf<a name='329'>
        mconv(i,n)=0.<a name='330'>
     ENDDO<a name='331'>
     do k=kts,kte<a name='332'>
     DO I= its,itf<a name='333'>
         omeg(i,k,n)=0.<a name='334'>
         tx(i,k,n)=0.<a name='335'>
         qx(i,k,n)=0.<a name='336'>
     ENDDO<a name='337'>
     ENDDO<a name='338'>
     ENDDO<a name='339'>
     DO k=1,ensdim<a name='340'>
     DO I= its,itf<a name='341'>
        massflni(i,j,k)=0.<a name='342'>
     ENDDO<a name='343'>
     ENDDO<a name='344'>
     <font color=#447700>!  put hydrostatic pressure on half levels<a name='345'></font>
     DO K=kts,ktf<a name='346'>
     DO I=ITS,ITF<a name='347'>
         phh(i,k) = p(i,k,j)<a name='348'>
     ENDDO<a name='349'>
     ENDDO<a name='350'>
<a name='351'>
     DO I=ITS,ITF<a name='352'>
         PSUR(I)=p8w(I,1,J)*.01<a name='353'>
<font color=#447700>!        PSUR(I)=p(I,1,J)*.01<a name='354'></font>
         TER11(I)=HT(i,j)<a name='355'>
         aaeq(i)=0.<a name='356'>
         direction(i)=0.<a name='357'>
         pret(i)=0.<a name='358'>
         umean(i)=0.<a name='359'>
         vmean(i)=0.<a name='360'>
         pmean(i)=0.<a name='361'>
         kpbli(i)=kpbl(i,j)<a name='362'>
     ENDDO<a name='363'>
<font color=#447700>!    if(j.eq.jpr)write(0,*)'psur(ipr),ter11(ipr),kpbli(ipr)'<a name='364'></font>
<font color=#447700>!    if(j.eq.jpr)write(0,*)psur(ipr),ter11(ipr),kpbli(ipr),r_v<a name='365'></font>
     DO K=kts,ktf<a name='366'>
     DO I=ITS,ITF<a name='367'>
         po(i,k)=phh(i,k)*.01<a name='368'>
         subm(i,k)=0.<a name='369'>
         P2d(I,K)=PO(i,k)<a name='370'>
         US(I,K) =u(i,k,j)<a name='371'>
         VS(I,K) =v(i,k,j)<a name='372'>
         T2d(I,K)=t(i,k,j)<a name='373'>
         q2d(I,K)=q(i,k,j)<a name='374'>
         IF(Q2d(I,K).LT.1.E-08)Q2d(I,K)=1.E-08<a name='375'>
         SUBT(I,K)=0.<a name='376'>
         SUBQ(I,K)=0.<a name='377'>
         OUTT(I,K)=0.<a name='378'>
         OUTQ(I,K)=0.<a name='379'>
         OUTQC(I,K)=0.<a name='380'>
         OUTTS(I,K)=0.<a name='381'>
         OUTQS(I,K)=0.<a name='382'>
         TN(I,K)=t2d(i,k)+RTHFTEN(i,k,j)*dt<a name='383'>
         QO(I,K)=q2d(i,k)+RQVFTEN(i,k,j)*dt<a name='384'>
         TSHALL(I,K)=t2d(i,k)+RTHBLTEN(i,k,j)*pi(i,k,j)*dt<a name='385'>
         DHDT(I,K)=cp*RTHBLTEN(i,k,j)*pi(i,k,j)+ XLV*RQVBLTEN(i,k,j)<a name='386'>
         QSHALL(I,K)=q2d(i,k)+RQVBLTEN(i,k,j)*dt<a name='387'>
         if(high_resolution.eq.1)then<a name='388'>
            TN(I,K)=t2d(i,k)+ave_f_t(i,k,j)*dt<a name='389'>
            QO(I,K)=q2d(i,k)+ave_f_q(i,k,j)*dt<a name='390'>
         endif<a name='391'>
         IF(TN(I,K).LT.200.)TN(I,K)=T2d(I,K)<a name='392'>
         IF(QO(I,K).LT.1.E-08)QO(I,K)=1.E-08<a name='393'>
<font color=#447700>!        if(i.eq.ipr.and.j.eq.jpr)then<a name='394'></font>
<font color=#447700>!         write(0,123)k,p2d(i,k),t2d(i,k),tn(i,k),q2d(i,k),QO(i,k),RTHBLTEN(i,k,j),RQVBLTEN(i,k,j)<a name='395'></font>
<font color=#447700>!        endif<a name='396'></font>
     ENDDO<a name='397'>
     ENDDO<a name='398'>
123  format(1x,i2,f8.0,1x,2(1x,f8.3),4(1x,e12.4))<a name='399'>
     ens4n=0<a name='400'>
     nbegin=0<a name='401'>
     nend=0<a name='402'>
     if(ens4_spread.gt.1)then<a name='403'>
     nbegin=-ens4_spread/2<a name='404'>
     nend=ens4_spread/2<a name='405'>
     endif<a name='406'>
     do nn=nbegin,nend,1<a name='407'>
       jss=max(j+nn,jds+0)<a name='408'>
       jss=min(jss,jde-1)<a name='409'>
       do n=nbegin,nend,1<a name='410'>
         ens4n=ens4n+1<a name='411'>
         DO K=kts,ktf<a name='412'>
         DO I=ITS,ITF<a name='413'>
          iss=max(i+n,ids+0)<a name='414'>
          iss=min(iss,ide-1)<a name='415'>
         omeg(I,K,ens4n)= -g*rho(i,k,j)*w(iss,k,jss)<a name='416'>
<font color=#447700>!        omeg(I,K,ens4n)= -g*rho(i,k,j)*w(i,k,j)<a name='417'></font>
         Tx(I,K,ens4n)=t2d(i,k)+RTHFTEN(iss,k,jss)*dt<a name='418'>
<font color=#447700>!        Tx(I,K,ens4n)=t2d(i,k)+RTHFTEN(i,k,j)*dt<a name='419'></font>
         if(high_resolution.eq.1)Tx(I,K,ens4n)=t2d(i,k)+ave_f_t(iss,k,jss)*dt<a name='420'>
         IF(Tx(I,K,ens4n).LT.200.)Tx(I,K,ens4n)=T2d(I,K)<a name='421'>
         Qx(I,K,ens4n)=q2d(i,k)+RQVFTEN(iss,k,jss)*dt<a name='422'>
         Qx(I,K,ens4n)=q2d(i,k)+RQVFTEN(i,k,j)*dt<a name='423'>
         if(high_resolution.eq.1)qx(I,K,ens4n)=q2d(i,k)+ave_f_q(iss,k,jss)*dt<a name='424'>
         IF(Qx(I,K,ens4n).LT.1.E-08)Qx(I,K,ens4n)=1.E-08<a name='425'>
        enddo<a name='426'>
        enddo<a name='427'>
      enddo <font color=#447700>!n<a name='428'></font>
      enddo <font color=#447700>!nn<a name='429'></font>
      do k=  kts+1,ktf-1<a name='430'>
      DO I = its,itf<a name='431'>
         if((p2d(i,1)-p2d(i,k)).gt.150.and.p2d(i,k).gt.300)then<a name='432'>
            dp=-.5*(p2d(i,k+1)-p2d(i,k-1))<a name='433'>
            umean(i)=umean(i)+us(i,k)*dp<a name='434'>
            vmean(i)=vmean(i)+vs(i,k)*dp<a name='435'>
            pmean(i)=pmean(i)+dp<a name='436'>
         endif<a name='437'>
      enddo<a name='438'>
      enddo<a name='439'>
      DO I = its,itf<a name='440'>
         umean(i)=umean(i)/pmean(i)<a name='441'>
         vmean(i)=vmean(i)/pmean(i)<a name='442'>
         direction(i)=(atan2(umean(i),vmean(i))+3.1415926)*57.29578<a name='443'>
         if(direction(i).gt.360.)direction(i)=direction(i)-360.<a name='444'>
      ENDDO<a name='445'>
      do n=1,ens4<a name='446'>
      DO K=kts,ktf-1<a name='447'>
      DO I = its,itf<a name='448'>
        dq=(q2d(i,k+1)-q2d(i,k))<a name='449'>
        mconv(i,n)=mconv(i,n)+omeg(i,k,n)*dq/g<a name='450'>
      enddo<a name='451'>
      ENDDO<a name='452'>
      ENDDO<a name='453'>
      do n=1,ens4<a name='454'>
      DO I = its,itf<a name='455'>
        if(mconv(i,n).lt.0.)mconv(i,n)=0.<a name='456'>
      ENDDO<a name='457'>
      ENDDO<a name='458'>
<font color=#447700>!<a name='459'></font>
<font color=#447700>!---- CALL CUMULUS PARAMETERIZATION<a name='460'></font>
<font color=#447700>!<a name='461'></font>
#if ( WRF_DFI_RADAR == 1 )<a name='462'>
      if(do_capsuppress == 1 ) then<a name='463'>
        DO I= its,itf<a name='464'>
            cap_suppress_j(i)=cap_suppress_loc(i,j)<a name='465'>
        ENDDO<a name='466'>
      endif<a name='467'>
#endif<a name='468'>
      CALL <A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D'>CUP_enss_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#G3DRV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENSS_3D_1">(outqc,j,AAEQ,T2d,Q2d,TER11,subm,TN,QO,PO,PRET,&amp;<a name='469'>
           P2d,OUTT,OUTQ,DT,itimestep,tkm,PSUR,US,VS,tcrit,iens,tx,qx,          &amp;<a name='470'>
           tshall,qshall,kpbli,DHDT,outts,outqs,tscl_kf,           &amp;<a name='471'>
           k22s,kbcons,ktops,xmbs,                                 &amp;<a name='472'>
           mconv,massflni,iact_old_gr,omeg,direction,MASSi_FLX,  &amp;<a name='473'>
           maxiens,maxens,maxens2,maxens3,ensdim,                 &amp;<a name='474'>
           APRi_GR,APRi_W,APRi_MC,APRi_ST,APRi_AS,                &amp;<a name='475'>
           APRi_CAPMA,APRi_CAPME,APRi_CAPMI,kbcon,ktop,cupclw,    &amp;<a name='476'>
           xfi_ens,pri_ens,XLANDi,gswi,edti_out,subt,subq,        &amp;<a name='477'>
<font color=#447700>! ruc          lv_p,rv_p,cpd_p,g0_p,ichoice,ipr,jpr,                  &amp;<a name='478'></font>
           xlv,r_v,cp,g,ichoice,ipr,jpr,ens4,high_resolution,     &amp;<a name='479'>
           ishallow_g3,itf,jtf,ktf,                               &amp;<a name='480'>
           its,ite, jts,jte, kts,kte                              &amp;<a name='481'>
#if ( WRF_DFI_RADAR == 1 )<a name='482'>
           ,do_capsuppress,cap_suppress_j                         &amp;             <a name='483'>
#endif<a name='484'>
                                                             )<a name='485'>
<a name='486'>
<a name='487'>
            if(j.lt.jbegc.or.j.gt.jendc)go to 100<a name='488'>
            DO I=ibegc,iendc<a name='489'>
              xmb_shallow(i,j)=xmbs(i)<a name='490'>
              k22_shallow(i,j)=k22s(i)<a name='491'>
              kbcon_shallow(i,j)=kbcons(i)<a name='492'>
              ktop_shallow(i,j)=ktops(i)<a name='493'>
              ktop_deep(i,j)=ktop(i)<a name='494'>
              cuten(i)=0.<a name='495'>
              if(pret(i).gt.0.)then<a name='496'>
                 cuten(i)=1.<a name='497'>
<font color=#447700>!                raincv(i,j)=pret(i)*dt<a name='498'></font>
              endif<a name='499'>
            ENDDO<a name='500'>
<font color=#447700>!           if(j.eq.jpr)write(0,*)'precip,ktop,kbcon = ',pret(ipr),ktop(ipr),kbcon(ipr)<a name='501'></font>
            DO I=ibegc,iendc<a name='502'>
            DO K=kts,ktf<a name='503'>
               cugd_ttens(I,K,J)=subt(i,k)*cuten(i)*sub_spread<a name='504'>
               cugd_qvtens(I,K,J)=subq(i,k)*cuten(i)*sub_spread<a name='505'>
<font color=#447700>!              cugd_tten(I,K,J)=outt(i,k)*cuten(i) <a name='506'></font>
<font color=#447700>!              cugd_qvten(I,K,J)=outq(i,k)*cuten(i)<a name='507'></font>
               cugd_tten(I,K,J)=outts(i,k)+outt(i,k)*cuten(i)<a name='508'>
               cugd_qvten(I,K,J)=outqs(i,k)+outq(i,k)*cuten(i)<a name='509'>
               cugd_qcten(I,K,J)=outqc(i,k)*cuten(i)<a name='510'>
<font color=#447700>!              if(i.eq.ipr.and.j.eq.jpr)then<a name='511'></font>
<font color=#447700>!                write(0,*)subt(i,k)+outt(i,k),subq(i,k)+outq(i,k),outts(i,k),outqs(i,k)<a name='512'></font>
<font color=#447700>!              endif<a name='513'></font>
            ENDDO<a name='514'>
            ENDDO<a name='515'>
            DO I=ibegc,iendc<a name='516'>
              if(pret(i).gt.0.)then<a name='517'>
                 raincv(i,j)=pret(i)*dt<a name='518'>
                 pratec(i,j)=pret(i)<a name='519'>
                 rkbcon = kte+kts - kbcon(i)<a name='520'>
                 rktop  = kte+kts -  ktop(i)<a name='521'>
                 if (ktop(i)  &gt; HTOP(i,j)) HTOP(i,j) = ktop(i)+.001<a name='522'>
                 if (kbcon(i) &lt; HBOT(i,j)) HBOT(i,j) = kbcon(i)+.001<a name='523'>
              endif<a name='524'>
            ENDDO<a name='525'>
            DO n= 1,ensdim<a name='526'>
            DO I= ibegc,iendc<a name='527'>
              xf_ens(i,j,n)=xfi_ens(i,j,n)<a name='528'>
              pr_ens(i,j,n)=pri_ens(i,j,n)<a name='529'>
            ENDDO<a name='530'>
            ENDDO<a name='531'>
            DO I= ibegc,iendc<a name='532'>
               APR_GR(i,j)=apri_gr(i,j)<a name='533'>
               APR_w(i,j)=apri_w(i,j)<a name='534'>
               APR_mc(i,j)=apri_mc(i,j)<a name='535'>
               APR_st(i,j)=apri_st(i,j)<a name='536'>
               APR_as(i,j)=apri_as(i,j)<a name='537'>
               APR_capma(i,j)=apri_capma(i,j)<a name='538'>
               APR_capme(i,j)=apri_capme(i,j)<a name='539'>
               APR_capmi(i,j)=apri_capmi(i,j)<a name='540'>
               mass_flux(i,j)=massi_flx(i,j)<a name='541'>
               edt_out(i,j)=edti_out(i,j)<a name='542'>
            ENDDO<a name='543'>
            IF(PRESENT(RQCCUTEN)) THEN<a name='544'>
              IF ( F_QC ) THEN<a name='545'>
                DO K=kts,ktf<a name='546'>
                DO I=ibegc,iendc<a name='547'>
                   RQCCUTEN(I,K,J)=outqc(I,K)*cuten(i)<a name='548'>
                   IF ( PRESENT( GDC ) ) GDC(I,K,J)=CUPCLW(I,K)*cuten(i)<a name='549'>
                   IF ( PRESENT( GDC2 ) ) GDC2(I,K,J)=0.<a name='550'>
                ENDDO<a name='551'>
                ENDDO<a name='552'>
              ENDIF<a name='553'>
            ENDIF<a name='554'>
<a name='555'>
<font color=#447700>!......     QSTEN STORES GRAUPEL TENDENCY IF IT EXISTS, OTHERISE SNOW (V2)     <a name='556'></font>
<a name='557'>
            IF(PRESENT(RQICUTEN).AND.PRESENT(RQCCUTEN))THEN<a name='558'>
              IF (F_QI) THEN<a name='559'>
                DO K=kts,ktf<a name='560'>
                  DO I=ibegc,iendc<a name='561'>
                   if(t2d(i,k).lt.258.)then<a name='562'>
                      RQICUTEN(I,K,J)=outqc(I,K)*cuten(i)<a name='563'>
                      cugd_qcten(i,k,j)=0.<a name='564'>
                      RQCCUTEN(I,K,J)=0.<a name='565'>
                      IF ( PRESENT( GDC2 ) ) GDC2(I,K,J)=CUPCLW(I,K)*cuten(i)<a name='566'>
                   else<a name='567'>
                      RQICUTEN(I,K,J)=0.<a name='568'>
                      RQCCUTEN(I,K,J)=outqc(I,K)*cuten(i)<a name='569'>
                      IF ( PRESENT( GDC ) ) GDC(I,K,J)=CUPCLW(I,K)*cuten(i)<a name='570'>
                   endif<a name='571'>
                ENDDO<a name='572'>
                ENDDO<a name='573'>
              ENDIF<a name='574'>
            ENDIF<a name='575'>
<a name='576'>
 100    continue<a name='577'>
<a name='578'>
   END SUBROUTINE G3DRV<a name='579'>
<a name='580'>
<A NAME='CUP_ENSS_3D'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='581'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>CUP_enss_3d</font>(OUTQC,J,AAEQ,T,Q,Z1,sub_mas,                    &amp; <A href='../../call_to/CUP_ENSS_3D.html' TARGET='index'>1</A>,<A href='../../call_from/CUP_ENSS_3D.html' TARGET='index'>62</A><a name='582'>
              TN,QO,PO,PRE,P,OUTT,OUTQ,DTIME,ktau,tkmax,PSUR,US,VS,    &amp;<a name='583'>
              TCRIT,iens,tx,qx,                                        &amp;<a name='584'>
              tshall,qshall,kpbl,dhdt,outts,outqs,tscl_kf,             &amp;<a name='585'>
              k23,kbcon3,ktop3,xmb3,                                   &amp;<a name='586'>
              mconv,massfln,iact,                                      &amp;<a name='587'>
              omeg,direction,massflx,maxiens,                          &amp;<a name='588'>
              maxens,maxens2,maxens3,ensdim,                           &amp;<a name='589'>
              APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                       &amp;<a name='590'>
              APR_CAPMA,APR_CAPME,APR_CAPMI,kbcon,ktop,cupclw,         &amp;   <font color=#447700>!-lxz<a name='591'></font>
              xf_ens,pr_ens,xland,gsw,edt_out,subt,subq,               &amp;<a name='592'>
              xl,rv,cp,g,ichoice,ipr,jpr,ens4,high_resolution,         &amp;<a name='593'>
              ishallow_g3,itf,jtf,ktf,                                 &amp;<a name='594'>
              its,ite, jts,jte, kts,kte                                &amp;<a name='595'>
#if ( WRF_DFI_RADAR == 1 )<a name='596'>
                 <font color=#447700>! Optional CAP suppress option<a name='597'></font>
                     ,do_capsuppress,cap_suppress_j                  &amp;<a name='598'>
#endif                                 <a name='599'>
                                                )<a name='600'>
<a name='601'>
   IMPLICIT NONE<a name='602'>
<a name='603'>
     integer                                                           &amp;<a name='604'>
        ,intent (in   )                   ::                           &amp;<a name='605'>
        itf,jtf,ktf,ktau,                                              &amp;<a name='606'>
        its,ite, jts,jte, kts,kte,ipr,jpr,ens4,high_resolution<a name='607'>
     integer, intent (in   )              ::                           &amp;<a name='608'>
        j,ensdim,maxiens,ishallow_g3,maxens,maxens2,maxens3,ichoice,iens<a name='609'>
  <font color=#447700>!<a name='610'></font>
  <font color=#447700>! <a name='611'></font>
  <font color=#447700>!<a name='612'></font>
     real,    dimension (its:ite,jts:jte,1:ensdim)                     &amp;<a name='613'>
        ,intent (inout)                   ::                           &amp;<a name='614'>
        massfln,xf_ens,pr_ens<a name='615'>
     real,    dimension (its:ite,jts:jte)                              &amp;<a name='616'>
        ,intent (inout )                  ::                           &amp;<a name='617'>
               APR_GR,APR_W,APR_MC,APR_ST,APR_AS,APR_CAPMA,     &amp;<a name='618'>
               APR_CAPME,APR_CAPMI,massflx,edt_out<a name='619'>
     real,    dimension (its:ite,jts:jte)                              &amp;<a name='620'>
        ,intent (in   )                   ::                           &amp;<a name='621'>
               gsw<a name='622'>
     integer, dimension (its:ite,jts:jte)                              &amp;<a name='623'>
        ,intent (in   )                   ::                           &amp;<a name='624'>
        iact<a name='625'>
  <font color=#447700>! outtem = output temp tendency (per s)<a name='626'></font>
  <font color=#447700>! outq   = output q tendency (per s)<a name='627'></font>
  <font color=#447700>! outqc  = output qc tendency (per s)<a name='628'></font>
  <font color=#447700>! pre    = output precip<a name='629'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='630'>
        ,intent (inout  )                   ::                           &amp;<a name='631'>
        DHDT,OUTT,OUTQ,OUTQC,subt,subq,sub_mas,cupclw,outts,outqs<a name='632'>
     real,    dimension (its:ite)                                      &amp;<a name='633'>
        ,intent (out  )                   ::                           &amp;<a name='634'>
        pre,xmb3<a name='635'>
     integer,    dimension (its:ite)                                   &amp;<a name='636'>
        ,intent (out  )                   ::                           &amp;<a name='637'>
        kbcon,ktop,k23,kbcon3,ktop3<a name='638'>
     integer,    dimension (its:ite)                                   &amp;<a name='639'>
        ,intent (in  )                   ::                           &amp;<a name='640'>
        kpbl<a name='641'>
  <font color=#447700>!<a name='642'></font>
  <font color=#447700>! basic environmental input includes moisture convergence (mconv)<a name='643'></font>
  <font color=#447700>! omega (omeg), windspeed (us,vs), and a flag (aaeq) to turn off<a name='644'></font>
  <font color=#447700>! convection for this call only and at that particular gridpoint<a name='645'></font>
  <font color=#447700>!<a name='646'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='647'>
        ,intent (in   )                   ::                           &amp;<a name='648'>
        T,PO,P,US,VS,tn,tshall,qshall<a name='649'>
     real,    dimension (its:ite,kts:kte,1:ens4)                       &amp;<a name='650'>
        ,intent (inout   )                   ::                           &amp;<a name='651'>
        omeg,tx,qx<a name='652'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='653'>
        ,intent (inout)                   ::                           &amp;<a name='654'>
         Q,QO<a name='655'>
     real, dimension (its:ite)                                         &amp;<a name='656'>
        ,intent (in   )                   ::                           &amp;<a name='657'>
        Z1,PSUR,AAEQ,direction,tkmax,xland<a name='658'>
     real, dimension (its:ite,1:ens4)                                         &amp;<a name='659'>
        ,intent (in   )                   ::                           &amp;<a name='660'>
        mconv<a name='661'>
<a name='662'>
       <a name='663'>
       real                                                            &amp;<a name='664'>
        ,intent (in   )                   ::                           &amp;<a name='665'>
        dtime,tcrit,xl,cp,rv,g,tscl_kf<a name='666'>
<a name='667'>
#if ( WRF_DFI_RADAR == 1 )<a name='668'>
<font color=#447700>!<a name='669'></font>
<font color=#447700>!  option of cap suppress: <a name='670'></font>
<font color=#447700>!        do_capsuppress = 1   do<a name='671'></font>
<font color=#447700>!        do_capsuppress = other   don't<a name='672'></font>
<font color=#447700>!<a name='673'></font>
<font color=#447700>!<a name='674'></font>
   INTEGER,      INTENT(IN   ) ,OPTIONAL   :: do_capsuppress<a name='675'>
   REAL, DIMENSION( its:ite ),INTENT(IN   ) ,OPTIONAL   :: cap_suppress_j<a name='676'>
#endif<a name='677'>
<a name='678'>
<font color=#447700>!<a name='679'></font>
<font color=#447700>!  local ensemble dependent variables in this routine<a name='680'></font>
<font color=#447700>!<a name='681'></font>
     real,    dimension (its:ite,1:maxens)  ::                         &amp;<a name='682'>
        xaa0_ens<a name='683'>
     real,    dimension (1:maxens)  ::                                 &amp;<a name='684'>
        mbdt_ens<a name='685'>
     real,    dimension (1:maxens2) ::                                 &amp;<a name='686'>
        edt_ens<a name='687'>
     real,    dimension (its:ite,1:maxens2) ::                         &amp;<a name='688'>
        edtc<a name='689'>
     real,    dimension (its:ite,kts:kte,1:maxens2) ::                 &amp;<a name='690'>
        dellat_ens,dellaqc_ens,dellaq_ens,pwo_ens,subt_ens,subq_ens<a name='691'>
<font color=#447700>!<a name='692'></font>
<font color=#447700>!<a name='693'></font>
<font color=#447700>!<a name='694'></font>
<font color=#447700>!***************** the following are your basic environmental<a name='695'></font>
<font color=#447700>!                  variables. They carry a "_cup" if they are<a name='696'></font>
<font color=#447700>!                  on model cloud levels (staggered). They carry<a name='697'></font>
<font color=#447700>!                  an "o"-ending (z becomes zo), if they are the forced<a name='698'></font>
<font color=#447700>!                  variables. They are preceded by x (z becomes xz)<a name='699'></font>
<font color=#447700>!                  to indicate modification by some typ of cloud<a name='700'></font>
<font color=#447700>!<a name='701'></font>
  <font color=#447700>! z           = heights of model levels<a name='702'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='703'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='704'></font>
  <font color=#447700>! t           = environmental temp<a name='705'></font>
  <font color=#447700>! p           = environmental pressure<a name='706'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='707'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='708'></font>
  <font color=#447700>! z_cup       = heights of model cloud levels<a name='709'></font>
  <font color=#447700>! q_cup       = environmental q on model cloud levels<a name='710'></font>
  <font color=#447700>! qes_cup     = saturation q on model cloud levels<a name='711'></font>
  <font color=#447700>! t_cup       = temperature (Kelvin) on model cloud levels<a name='712'></font>
  <font color=#447700>! p_cup       = environmental pressure<a name='713'></font>
  <font color=#447700>! he_cup = moist static energy on model cloud levels<a name='714'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='715'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='716'></font>
<font color=#447700>!<a name='717'></font>
<font color=#447700>!<a name='718'></font>
  <font color=#447700>! hcd = moist static energy in downdraft<a name='719'></font>
  <font color=#447700>! zd normalized downdraft mass flux<a name='720'></font>
  <font color=#447700>! dby = buoancy term<a name='721'></font>
  <font color=#447700>! entr = entrainment rate<a name='722'></font>
  <font color=#447700>! zd   = downdraft normalized mass flux<a name='723'></font>
  <font color=#447700>! entr= entrainment rate<a name='724'></font>
  <font color=#447700>! hcd = h in model cloud<a name='725'></font>
  <font color=#447700>! bu = buoancy term<a name='726'></font>
  <font color=#447700>! zd = normalized downdraft mass flux<a name='727'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='728'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='729'></font>
  <font color=#447700>! qcd = cloud q (including liquid water) after entrainment<a name='730'></font>
  <font color=#447700>! qrch = saturation q in cloud<a name='731'></font>
  <font color=#447700>! pwd = evaporate at that level<a name='732'></font>
  <font color=#447700>! pwev = total normalized integrated evaoprate (I2)<a name='733'></font>
  <font color=#447700>! entr= entrainment rate<a name='734'></font>
  <font color=#447700>! z1 = terrain elevation<a name='735'></font>
  <font color=#447700>! entr = downdraft entrainment rate<a name='736'></font>
  <font color=#447700>! jmin = downdraft originating level<a name='737'></font>
  <font color=#447700>! kdet = level above ground where downdraft start detraining<a name='738'></font>
  <font color=#447700>! psur        = surface pressure<a name='739'></font>
  <font color=#447700>! z1          = terrain elevation<a name='740'></font>
  <font color=#447700>! pr_ens = precipitation ensemble<a name='741'></font>
  <font color=#447700>! xf_ens = mass flux ensembles<a name='742'></font>
  <font color=#447700>! massfln = downdraft mass flux ensembles used in next timestep<a name='743'></font>
  <font color=#447700>! omeg = omega from large scale model<a name='744'></font>
  <font color=#447700>! mconv = moisture convergence from large scale model<a name='745'></font>
  <font color=#447700>! zd      = downdraft normalized mass flux<a name='746'></font>
  <font color=#447700>! zu      = updraft normalized mass flux<a name='747'></font>
  <font color=#447700>! dir     = "storm motion"<a name='748'></font>
  <font color=#447700>! mbdt    = arbitrary numerical parameter<a name='749'></font>
  <font color=#447700>! dtime   = dt over which forcing is applied<a name='750'></font>
  <font color=#447700>! iact_gr_old = flag to tell where convection was active<a name='751'></font>
  <font color=#447700>! kbcon       = LFC of parcel from k22<a name='752'></font>
  <font color=#447700>! k22         = updraft originating level<a name='753'></font>
  <font color=#447700>! icoic       = flag if only want one closure (usually set to zero!)<a name='754'></font>
  <font color=#447700>! dby = buoancy term<a name='755'></font>
  <font color=#447700>! ktop = cloud top (output)<a name='756'></font>
  <font color=#447700>! xmb    = total base mass flux<a name='757'></font>
  <font color=#447700>! hc = cloud moist static energy<a name='758'></font>
  <font color=#447700>! hkb = moist static energy at originating level<a name='759'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='760'></font>
     real,    dimension (its:ite,kts:kte) ::                           &amp;<a name='761'>
        he3,hes3,qes3,z3,zdo3,zu3_0,hc3_0,dby3_0,                      &amp;<a name='762'>
        qes3_cup,q3_cup,he3_cup,hes3_cup,z3_cup,gamma3_cup,t3_cup,     &amp;<a name='763'>
        xhe3,xhes3,xqes3,xz3,xt3,xq3,                                  &amp;<a name='764'>
        xqes3_cup,xq3_cup,xhe3_cup,xhes3_cup,xz3_cup,xgamma3_cup,      &amp;<a name='765'>
        xt3_cup,                                                       &amp;<a name='766'>
        xdby3,xqc3,xhc3,xqrc3,xzu3,                                    &amp;<a name='767'>
        dby3,qc3,pw3,hc3,qrc3,zu3,cd3,DELLAH3,DELLAQ3,                 &amp;<a name='768'>
        dsubt3,dsubq3,DELLAT3,DELLAQC3<a name='769'>
<a name='770'>
     real,    dimension (its:ite,kts:kte) ::                           &amp;<a name='771'>
        he,hes,qes,z,                                                  &amp;<a name='772'>
        heo,heso,qeso,zo,                                              &amp;<a name='773'>
        xhe,xhes,xqes,xz,xt,xq,                                        &amp;<a name='774'>
<a name='775'>
        qes_cup,q_cup,he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup,      &amp;<a name='776'>
        qeso_cup,qo_cup,heo_cup,heso_cup,zo_cup,po_cup,gammao_cup,     &amp;<a name='777'>
        tn_cup,                                                        &amp;<a name='778'>
        xqes_cup,xq_cup,xhe_cup,xhes_cup,xz_cup,xp_cup,xgamma_cup,     &amp;<a name='779'>
        xt_cup,                                                        &amp;<a name='780'>
<a name='781'>
        dby,qc,qrcd,pwd,pw,hcd,qcd,dbyd,hc,qrc,zu,zd,clw_all,          &amp;<a name='782'>
        dbyo,qco,qrcdo,pwdo,pwo,hcdo,qcdo,dbydo,hco,qrco,zuo,zdo,      &amp;<a name='783'>
        xdby,xqc,xqrcd,xpwd,xpw,xhcd,xqcd,xhc,xqrc,xzu,xzd,            &amp;<a name='784'>
<a name='785'>
  <font color=#447700>! cd  = detrainment function for updraft<a name='786'></font>
  <font color=#447700>! cdd = detrainment function for downdraft<a name='787'></font>
  <font color=#447700>! dellat = change of temperature per unit mass flux of cloud ensemble<a name='788'></font>
  <font color=#447700>! dellaq = change of q per unit mass flux of cloud ensemble<a name='789'></font>
  <font color=#447700>! dellaqc = change of qc per unit mass flux of cloud ensemble<a name='790'></font>
<a name='791'>
        cd,cdd,scr1,DELLAH,DELLAQ,DELLAT,DELLAQC,dsubt,dsubq<a name='792'>
<a name='793'>
  <font color=#447700>! aa0 cloud work function for downdraft<a name='794'></font>
  <font color=#447700>! edt = epsilon<a name='795'></font>
  <font color=#447700>! aa0     = cloud work function without forcing effects<a name='796'></font>
  <font color=#447700>! aa1     = cloud work function with forcing effects<a name='797'></font>
  <font color=#447700>! xaa0    = cloud work function with cloud effects (ensemble dependent)<a name='798'></font>
  <font color=#447700>! edt     = epsilon<a name='799'></font>
<a name='800'>
     real,    dimension (its:ite) ::                                   &amp;<a name='801'>
       aa3_0,aa3,hkb3,qkb3,pwav3,bu3,xaa3,xhkb3,                       &amp;<a name='802'>
       hkb3_0,edt,edto,edtx,AA1,AA0,XAA0,HKB,                          &amp;<a name='803'>
       HKBO,aad,XHKB,QKB,QKBO,edt3,                                    &amp;<a name='804'>
       XMB,XPWAV,XPWEV,PWAV,PWEV,PWAVO,                                &amp;<a name='805'>
       PWEVO,BU,BUO,cap_max,xland1,                                    &amp;<a name='806'>
       cap_max_increment,closure_n,cap_max3<a name='807'>
     real,    dimension (its:ite,1:ens4) ::                                   &amp;<a name='808'>
        axx<a name='809'>
     integer,    dimension (its:ite) ::                                &amp;<a name='810'>
       kzdown,KDET,K22,KB,JMIN,kstabi,kstabm,K22x,jmin3,kdet3,         &amp;   <font color=#447700>!-lxz<a name='811'></font>
       KBCONx,KBx,KTOPx,ierr,ierr2,ierr3,KBMAX,ierr5,ierr5_0 <a name='812'>
<a name='813'>
     integer                              ::                           &amp;<a name='814'>
       nall,iedt,nens,nens3,ki,I,K,KK,iresult<a name='815'>
     real                                 ::                           &amp;<a name='816'>
      day,dz,mbdt,mbdt_s,entr_rate,radius,entrd_rate,mentr_rate,mentrd_rate,  &amp;<a name='817'>
      zcutdown,edtmax,edtmin,depth_min,zkbmax,z_detr,zktop,            &amp;<a name='818'>
      massfld,dh,cap_maxs,trash,entr_rate3,mentr_rate3<a name='819'>
<a name='820'>
     integer :: jmini<a name='821'>
     logical :: keep_going<a name='822'>
     real xff_shal(9),blqe,xkshal<a name='823'>
<a name='824'>
<a name='825'>
<a name='826'>
      day=86400.<a name='827'>
      do i=its,itf<a name='828'>
        xmb3(i)=0.<a name='829'>
        closure_n(i)=16.<a name='830'>
        xland1(i)=1.<a name='831'>
        if(xland(i).gt.1.5)xland1(i)=0.<a name='832'>
<font color=#447700>!       cap_max_increment(i)=50.<a name='833'></font>
        cap_max_increment(i)=25.<a name='834'>
      enddo<a name='835'>
<font color=#447700>!<a name='836'></font>
<font color=#447700>!--- specify entrainmentrate and detrainmentrate<a name='837'></font>
<font color=#447700>!<a name='838'></font>
      if(iens.le.4)then<a name='839'>
      radius=14000.-float(iens)*2000.<a name='840'>
      else<a name='841'>
      radius=12000.<a name='842'>
      endif<a name='843'>
<font color=#447700>!<a name='844'></font>
<font color=#447700>!--- gross entrainment rate (these may be changed later on in the<a name='845'></font>
<font color=#447700>!--- program, depending what your detrainment is!!)<a name='846'></font>
<font color=#447700>!<a name='847'></font>
      entr_rate =.2/radius<a name='848'>
      entr_rate3=.2/200.<a name='849'>
<font color=#447700>!<a name='850'></font>
<font color=#447700>!--- entrainment of mass<a name='851'></font>
<font color=#447700>!<a name='852'></font>
      mentrd_rate=0.<a name='853'>
      mentr_rate=entr_rate<a name='854'>
      mentr_rate3=entr_rate3<a name='855'>
<font color=#447700>!<a name='856'></font>
<font color=#447700>!--- initial detrainmentrates<a name='857'></font>
<font color=#447700>!<a name='858'></font>
      do k=kts,ktf<a name='859'>
      do i=its,itf<a name='860'>
        cupclw(i,k)=0.<a name='861'>
        cd(i,k)=0.01*entr_rate<a name='862'>
        cd3(i,k)=entr_rate3<a name='863'>
        cdd(i,k)=0.<a name='864'>
        zdo3(i,k)=0.<a name='865'>
        hcdo(i,k)=0.<a name='866'>
        qrcdo(i,k)=0.<a name='867'>
        dellaqc(i,k)=0.<a name='868'>
      enddo<a name='869'>
      enddo<a name='870'>
<font color=#447700>!<a name='871'></font>
<font color=#447700>!--- max/min allowed value for epsilon (ratio downdraft base mass flux/updraft<a name='872'></font>
<font color=#447700>!    base mass flux<a name='873'></font>
<font color=#447700>!<a name='874'></font>
      edtmax=1.<a name='875'>
      edtmin=.2<a name='876'>
<font color=#447700>!<a name='877'></font>
<font color=#447700>!--- minimum depth (m), clouds must have<a name='878'></font>
<font color=#447700>!<a name='879'></font>
      depth_min=500.<a name='880'>
<font color=#447700>!<a name='881'></font>
<font color=#447700>!--- maximum depth (mb) of capping <a name='882'></font>
<font color=#447700>!--- inversion (larger cap = no convection)<a name='883'></font>
<font color=#447700>!<a name='884'></font>
<font color=#447700>!     cap_maxs=125.<a name='885'></font>
      cap_maxs=75.<a name='886'>
      DO i=its,itf<a name='887'>
        kbmax(i)=1<a name='888'>
        jmin3(i)=0<a name='889'>
        kdet3(i)=0<a name='890'>
        aa0(i)=0.<a name='891'>
        aa3_0(i)=0.<a name='892'>
        aa1(i)=0.<a name='893'>
        aa3(i)=0.<a name='894'>
        aad(i)=0.<a name='895'>
        edt(i)=0.<a name='896'>
        edt3(i)=0.<a name='897'>
        kstabm(i)=ktf-1<a name='898'>
        IERR(i)=0<a name='899'>
        IERR2(i)=0<a name='900'>
        IERR3(i)=0<a name='901'>
        IERR5(i)=0<a name='902'>
        IERR5_0(i)=0<a name='903'>
 enddo<a name='904'>
<font color=#447700>!<a name='905'></font>
<font color=#447700>!--- first check for upstream convection<a name='906'></font>
<font color=#447700>!<a name='907'></font>
#if ( WRF_DFI_RADAR == 1 )<a name='908'>
  if(do_capsuppress == 1) then<a name='909'>
      do i=its,itf<a name='910'>
          cap_max(i)=cap_maxs<a name='911'>
          cap_max3(i)=25.<a name='912'>
          if(gsw(i,j).lt.1.or.high_resolution.eq.1)cap_max(i)=25.<a name='913'>
          if (abs(cap_suppress_j(i) - 1.0 ) &lt; 0.1 ) then<a name='914'>
             cap_max(i)=cap_maxs+75.<a name='915'>
          elseif (abs(cap_suppress_j(i) - 0.0 ) &lt; 0.1 ) then<a name='916'>
             cap_max(i)=10.0<a name='917'>
          endif<a name='918'>
          iresult=0<a name='919'>
      enddo<a name='920'>
  else<a name='921'>
     do i=its,itf<a name='922'>
         cap_max(i)=cap_maxs<a name='923'>
          cap_max3(i)=25.<a name='924'>
         if(gsw(i,j).lt.1.or.high_resolution.eq.1)cap_max(i)=25.<a name='925'>
       iresult=0<a name='926'>
     enddo<a name='927'>
  endif<a name='928'>
<a name='929'>
      do i=its,itf<a name='930'>
        edt_out(i,j)=cap_max(i)<a name='931'>
      enddo<a name='932'>
#else<a name='933'>
      do i=its,itf<a name='934'>
          cap_max(i)=cap_maxs<a name='935'>
          cap_max3(i)=25.<a name='936'>
          if(gsw(i,j).lt.1.or.high_resolution.eq.1)cap_max(i)=25.<a name='937'>
        iresult=0<a name='938'>
<a name='939'>
      enddo<a name='940'>
#endif<a name='941'>
<font color=#447700>!<a name='942'></font>
<font color=#447700>!--- max height(m) above ground where updraft air can originate<a name='943'></font>
<font color=#447700>!<a name='944'></font>
      zkbmax=4000.<a name='945'>
<font color=#447700>!<a name='946'></font>
<font color=#447700>!--- height(m) above which no downdrafts are allowed to originate<a name='947'></font>
<font color=#447700>!<a name='948'></font>
      zcutdown=3000.<a name='949'>
<font color=#447700>!<a name='950'></font>
<font color=#447700>!--- depth(m) over which downdraft detrains all its mass<a name='951'></font>
<font color=#447700>!<a name='952'></font>
      z_detr=1250.<a name='953'>
<font color=#447700>!<a name='954'></font>
      do nens=1,maxens<a name='955'>
         mbdt_ens(nens)=(float(nens)-3.)*dtime*1.e-3+dtime*5.E-03<a name='956'>
      enddo<a name='957'>
      do nens=1,maxens2<a name='958'>
         edt_ens(nens)=.95-float(nens)*.01<a name='959'>
      enddo<a name='960'>
<font color=#447700>!<a name='961'></font>
<font color=#447700>!--- environmental conditions, FIRST HEIGHTS<a name='962'></font>
<font color=#447700>!<a name='963'></font>
      do i=its,itf<a name='964'>
         if(ierr(i).ne.20)then<a name='965'>
            do k=1,maxens*maxens2*maxens3<a name='966'>
               xf_ens(i,j,(iens-1)*maxens*maxens2*maxens3+k)=0.<a name='967'>
               pr_ens(i,j,(iens-1)*maxens*maxens2*maxens3+k)=0.<a name='968'>
            enddo<a name='969'>
         endif<a name='970'>
      enddo<a name='971'>
<font color=#447700>!<a name='972'></font>
<font color=#447700>!--- calculate moist static energy, heights, qes<a name='973'></font>
<font color=#447700>!<a name='974'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_1">(z,qes,he,hes,t,q,p,z1, &amp;<a name='975'>
           psur,ierr,tcrit,0,xl,cp,   &amp;<a name='976'>
           itf,jtf,ktf, &amp;<a name='977'>
           its,ite, jts,jte, kts,kte)<a name='978'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_2">(zo,qeso,heo,heso,tn,qo,po,z1, &amp;<a name='979'>
           psur,ierr,tcrit,0,xl,cp,   &amp;<a name='980'>
           itf,jtf,ktf, &amp;<a name='981'>
           its,ite, jts,jte, kts,kte)<a name='982'>
<font color=#447700>!<a name='983'></font>
<font color=#447700>!--- environmental values on cloud levels<a name='984'></font>
<font color=#447700>!<a name='985'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_1">(t,qes,q,he,hes,z,p,qes_cup,q_cup,he_cup, &amp;<a name='986'>
           hes_cup,z_cup,p_cup,gamma_cup,t_cup,psur, &amp;<a name='987'>
           ierr,z1,xl,rv,cp,          &amp;<a name='988'>
           itf,jtf,ktf, &amp;<a name='989'>
           its,ite, jts,jte, kts,kte)<a name='990'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_2">(tn,qeso,qo,heo,heso,zo,po,qeso_cup,qo_cup, &amp;<a name='991'>
           heo_cup,heso_cup,zo_cup,po_cup,gammao_cup,tn_cup,psur,  &amp;<a name='992'>
           ierr,z1,xl,rv,cp,          &amp;<a name='993'>
           itf,jtf,ktf, &amp;<a name='994'>
           its,ite, jts,jte, kts,kte)<a name='995'>
      do i=its,itf<a name='996'>
        if(aaeq(i).lt.-0.1)then<a name='997'>
           ierr(i)=20<a name='998'>
        endif<a name='999'>
<font color=#447700>!     if(ierr(i).eq.0)then<a name='1000'></font>
<font color=#447700>!<a name='1001'></font>
      do k=kts,ktf<a name='1002'>
        if(zo_cup(i,k).gt.zkbmax+z1(i))then<a name='1003'>
          kbmax(i)=k<a name='1004'>
          go to 25<a name='1005'>
        endif<a name='1006'>
      enddo<a name='1007'>
 25   continue<a name='1008'>
<font color=#447700>!<a name='1009'></font>
<font color=#447700>!--- level where detrainment for downdraft starts<a name='1010'></font>
<font color=#447700>!<a name='1011'></font>
      do k=kts,ktf<a name='1012'>
        if(zo_cup(i,k).gt.z_detr+z1(i))then<a name='1013'>
          kdet(i)=k<a name='1014'>
          go to 26<a name='1015'>
        endif<a name='1016'>
      enddo<a name='1017'>
 26   continue<a name='1018'>
<font color=#447700>!<a name='1019'></font>
<font color=#447700>!     endif<a name='1020'></font>
      enddo<a name='1021'>
<font color=#447700>!<a name='1022'></font>
<font color=#447700>!<a name='1023'></font>
<font color=#447700>!<a name='1024'></font>
<font color=#447700>!------- DETERMINE LEVEL WITH HIGHEST MOIST STATIC ENERGY CONTENT - K22<a name='1025'></font>
<font color=#447700>!<a name='1026'></font>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MAXIMI'>cup_MAXIMI</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MAXIMI_1">(HEO_CUP,3,KBMAX,K22,ierr, &amp;<a name='1027'>
           itf,jtf,ktf, &amp;<a name='1028'>
           its,ite, jts,jte, kts,kte)<a name='1029'>
       DO 36 i=its,itf<a name='1030'>
         IF(ierr(I).eq.0.)THEN<a name='1031'>
         IF(K22(I).GE.KBMAX(i))ierr(i)=2<a name='1032'>
         endif<a name='1033'>
 36   CONTINUE<a name='1034'>
<font color=#447700>!<a name='1035'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='1036'></font>
<font color=#447700>!<a name='1037'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_1">(cap_max_increment,1,k22,kbcon,heo_cup,heso_cup, &amp;<a name='1038'>
           ierr,kbmax,po_cup,cap_max, &amp;<a name='1039'>
           itf,jtf,ktf, &amp;<a name='1040'>
           its,ite, jts,jte, kts,kte)<a name='1041'>
<font color=#447700>!<a name='1042'></font>
<font color=#447700>!--- increase detrainment in stable layers<a name='1043'></font>
<font color=#447700>!<a name='1044'></font>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MINIMI'>cup_minimi</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MINIMI_1">(HEso_cup,Kbcon,kstabm,kstabi,ierr,  &amp;<a name='1045'>
           itf,jtf,ktf, &amp;<a name='1046'>
           its,ite, jts,jte, kts,kte)<a name='1047'>
      do i=its,itf<a name='1048'>
      IF(ierr(I).eq.0.)THEN<a name='1049'>
        if(kstabm(i)-1.gt.kstabi(i))then<a name='1050'>
           do k=kstabi(i),kstabm(i)-1<a name='1051'>
             cd(i,k)=cd(i,k-1)+.15*entr_rate<a name='1052'>
             if(cd(i,k).gt.1.0*entr_rate)cd(i,k)=1.0*entr_rate<a name='1053'>
           enddo<a name='1054'>
        ENDIF<a name='1055'>
      ENDIF<a name='1056'>
      ENDDO<a name='1057'>
<font color=#447700>!<a name='1058'></font>
<font color=#447700>!--- calculate incloud moist static energy<a name='1059'></font>
<font color=#447700>!<a name='1060'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_1">(k22,hkb,z_cup,cd,mentr_rate,he_cup,hc, &amp;<a name='1061'>
           kbcon,ierr,dby,he,hes_cup,'deep', &amp;<a name='1062'>
           itf,jtf,ktf, &amp;<a name='1063'>
           its,ite, jts,jte, kts,kte)<a name='1064'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_2">(k22,hkbo,zo_cup,cd,mentr_rate,heo_cup,hco, &amp;<a name='1065'>
           kbcon,ierr,dbyo,heo,heso_cup,'deep', &amp;<a name='1066'>
           itf,jtf,ktf, &amp;<a name='1067'>
           its,ite, jts,jte, kts,kte)<a name='1068'>
<a name='1069'>
<font color=#447700>!--- DETERMINE CLOUD TOP - KTOP<a name='1070'></font>
<font color=#447700>!<a name='1071'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_KTOP'>cup_ktop</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KTOP_1">(1,dbyo,kbcon,ktop,ierr, &amp;<a name='1072'>
           itf,jtf,ktf, &amp;<a name='1073'>
           its,ite, jts,jte, kts,kte)<a name='1074'>
      DO 37 i=its,itf<a name='1075'>
         kzdown(i)=0<a name='1076'>
         if(ierr(i).eq.0)then<a name='1077'>
            zktop=(zo_cup(i,ktop(i))-z1(i))*.6<a name='1078'>
            zktop=min(zktop+z1(i),zcutdown+z1(i))<a name='1079'>
            do k=kts,kte<a name='1080'>
              if(zo_cup(i,k).gt.zktop)then<a name='1081'>
                 kzdown(i)=k<a name='1082'>
                 go to 37<a name='1083'>
              endif<a name='1084'>
              enddo<a name='1085'>
         endif<a name='1086'>
 37   CONTINUE<a name='1087'>
<font color=#447700>!<a name='1088'></font>
<font color=#447700>!--- DOWNDRAFT ORIGINATING LEVEL - JMIN<a name='1089'></font>
<font color=#447700>!<a name='1090'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MINIMI'>cup_minimi</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MINIMI_2">(HEso_cup,K22,kzdown,JMIN,ierr, &amp;<a name='1091'>
           itf,jtf,ktf, &amp;<a name='1092'>
           its,ite, jts,jte, kts,kte)<a name='1093'>
      DO 100 i=its,ite<a name='1094'>
      IF(ierr(I).eq.0.)THEN<a name='1095'>
<font color=#447700>!<a name='1096'></font>
<font color=#447700>!--- check whether it would have buoyancy, if there where<a name='1097'></font>
<font color=#447700>!--- no entrainment/detrainment<a name='1098'></font>
<font color=#447700>!<a name='1099'></font>
      jmini = jmin(i)<a name='1100'>
      keep_going = .TRUE.<a name='1101'>
      do while ( keep_going )<a name='1102'>
        keep_going = .FALSE.<a name='1103'>
        if ( jmini - 1 .lt. kdet(i)   ) kdet(i) = jmini-1<a name='1104'>
        if ( jmini     .ge. ktop(i)-1 ) jmini = ktop(i) - 2<a name='1105'>
        ki = jmini<a name='1106'>
        hcdo(i,ki)=heso_cup(i,ki)<a name='1107'>
        DZ=Zo_cup(i,Ki+1)-Zo_cup(i,Ki)<a name='1108'>
        dh=0.<a name='1109'>
        do k=ki-1,1,-1<a name='1110'>
          hcdo(i,k)=heso_cup(i,jmini)<a name='1111'>
          DZ=Zo_cup(i,K+1)-Zo_cup(i,K)<a name='1112'>
          dh=dh+dz*(HCDo(i,K)-heso_cup(i,k))<a name='1113'>
          if(dh.gt.0.)then<a name='1114'>
            jmini=jmini-1<a name='1115'>
            if ( jmini .gt. 3 ) then<a name='1116'>
              keep_going = .TRUE.<a name='1117'>
            else<a name='1118'>
              ierr(i) = 9<a name='1119'>
              exit<a name='1120'>
            endif<a name='1121'>
          endif<a name='1122'>
        enddo<a name='1123'>
      enddo<a name='1124'>
      jmin(i) = jmini <a name='1125'>
      if ( jmini .le. 3 ) then<a name='1126'>
        ierr(i)=4<a name='1127'>
      endif<a name='1128'>
      ENDIF<a name='1129'>
100   continue<a name='1130'>
<font color=#447700>!<a name='1131'></font>
<font color=#447700>! - Must have at least depth_min m between cloud convective base<a name='1132'></font>
<font color=#447700>!     and cloud top.<a name='1133'></font>
<font color=#447700>!<a name='1134'></font>
      do i=its,itf<a name='1135'>
      IF(ierr(I).eq.0.)THEN<a name='1136'>
      IF(-zo_cup(I,KBCON(I))+zo_cup(I,KTOP(I)).LT.depth_min)then<a name='1137'>
            ierr(i)=6<a name='1138'>
      endif<a name='1139'>
      endif<a name='1140'>
      enddo<a name='1141'>
<a name='1142'>
<font color=#447700>!<a name='1143'></font>
<font color=#447700>!c--- normalized updraft mass flux profile<a name='1144'></font>
<font color=#447700>!<a name='1145'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_1">(zu,z_cup,mentr_rate,cd,kbcon,ktop,ierr,k22, &amp;<a name='1146'>
           itf,jtf,ktf, &amp;<a name='1147'>
           its,ite, jts,jte, kts,kte)<a name='1148'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_2">(zuo,zo_cup,mentr_rate,cd,kbcon,ktop,ierr,k22, &amp;<a name='1149'>
           itf,jtf,ktf, &amp;<a name='1150'>
           its,ite, jts,jte, kts,kte)<a name='1151'>
<font color=#447700>!<a name='1152'></font>
<font color=#447700>!c--- normalized downdraft mass flux profile,also work on bottom detrainment<a name='1153'></font>
<font color=#447700>!--- in this routine<a name='1154'></font>
<font color=#447700>!<a name='1155'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_NMS'>cup_dd_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_NMS_1">(zd,z_cup,cdd,mentrd_rate,jmin,ierr, &amp;<a name='1156'>
           0,kdet,z1,                 &amp;<a name='1157'>
           itf,jtf,ktf, &amp;<a name='1158'>
           its,ite, jts,jte, kts,kte)<a name='1159'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_NMS'>cup_dd_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_NMS_2">(zdo,zo_cup,cdd,mentrd_rate,jmin,ierr, &amp;<a name='1160'>
           1,kdet,z1,                 &amp;<a name='1161'>
           itf,jtf,ktf, &amp;<a name='1162'>
           its,ite, jts,jte, kts,kte)<a name='1163'>
<font color=#447700>!<a name='1164'></font>
<font color=#447700>!--- downdraft moist static energy<a name='1165'></font>
<font color=#447700>!<a name='1166'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_HE'>cup_dd_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_HE_1">(hes_cup,zd,hcd,z_cup,cdd,mentrd_rate, &amp;<a name='1167'>
           jmin,ierr,he,dbyd,he_cup,  &amp;<a name='1168'>
           itf,jtf,ktf, &amp;<a name='1169'>
           its,ite, jts,jte, kts,kte)<a name='1170'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_HE'>cup_dd_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_HE_2">(heso_cup,zdo,hcdo,zo_cup,cdd,mentrd_rate, &amp;<a name='1171'>
           jmin,ierr,heo,dbydo,he_cup,&amp;<a name='1172'>
           itf,jtf,ktf, &amp;<a name='1173'>
           its,ite, jts,jte, kts,kte)<a name='1174'>
<font color=#447700>!<a name='1175'></font>
<font color=#447700>!--- calculate moisture properties of downdraft<a name='1176'></font>
<font color=#447700>!<a name='1177'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_MOISTURE_3D'>cup_dd_moisture_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_MOISTURE_3D_1">(zd,hcd,hes_cup,qcd,qes_cup, &amp;<a name='1178'>
           pwd,q_cup,z_cup,cdd,mentrd_rate,jmin,ierr,gamma_cup, &amp;<a name='1179'>
           pwev,bu,qrcd,q,he,t_cup,2,xl,high_resolution, &amp;<a name='1180'>
           itf,jtf,ktf, &amp;<a name='1181'>
           its,ite, jts,jte, kts,kte)<a name='1182'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_MOISTURE_3D'>cup_dd_moisture_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_MOISTURE_3D_2">(zdo,hcdo,heso_cup,qcdo,qeso_cup, &amp;<a name='1183'>
           pwdo,qo_cup,zo_cup,cdd,mentrd_rate,jmin,ierr,gammao_cup, &amp;<a name='1184'>
           pwevo,bu,qrcdo,qo,heo,tn_cup,1,xl,high_resolution, &amp;<a name='1185'>
           itf,jtf,ktf, &amp;<a name='1186'>
           its,ite, jts,jte, kts,kte)<a name='1187'>
<font color=#447700>!<a name='1188'></font>
<font color=#447700>!--- calculate moisture properties of updraft<a name='1189'></font>
<font color=#447700>!<a name='1190'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_1">('deep',ierr,z_cup,qc,qrc,pw,pwav, &amp;<a name='1191'>
           kbcon,ktop,cd,dby,mentr_rate,clw_all,      &amp;<a name='1192'>
           q,GAMMA_cup,zu,qes_cup,k22,q_cup,xl, &amp;<a name='1193'>
           itf,jtf,ktf, &amp;<a name='1194'>
           its,ite, jts,jte, kts,kte)<a name='1195'>
      do k=kts,ktf<a name='1196'>
      do i=its,itf<a name='1197'>
         cupclw(i,k)=qrc(i,k)<a name='1198'>
      enddo<a name='1199'>
      enddo<a name='1200'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_2">('deep',ierr,zo_cup,qco,qrco,pwo,pwavo, &amp;<a name='1201'>
           kbcon,ktop,cd,dbyo,mentr_rate,clw_all, &amp;<a name='1202'>
           qo,GAMMAo_cup,zuo,qeso_cup,k22,qo_cup,xl,&amp;<a name='1203'>
           itf,jtf,ktf, &amp;<a name='1204'>
           its,ite, jts,jte, kts,kte)<a name='1205'>
<font color=#447700>!<a name='1206'></font>
<font color=#447700>!--- calculate workfunctions for updrafts<a name='1207'></font>
<font color=#447700>!<a name='1208'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_1">(aa0,z,zu,dby,GAMMA_CUP,t_cup, &amp;<a name='1209'>
           kbcon,ktop,ierr,           &amp;<a name='1210'>
           itf,jtf,ktf, &amp;<a name='1211'>
           its,ite, jts,jte, kts,kte)<a name='1212'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_2">(aa1,zo,zuo,dbyo,GAMMAo_CUP,tn_cup, &amp;<a name='1213'>
           kbcon,ktop,ierr,           &amp;<a name='1214'>
           itf,jtf,ktf, &amp;<a name='1215'>
           its,ite, jts,jte, kts,kte)<a name='1216'>
      do i=its,itf<a name='1217'>
         if(ierr(i).eq.0)then<a name='1218'>
           if(aa1(i).eq.0.)then<a name='1219'>
               ierr(i)=17<a name='1220'>
           endif<a name='1221'>
         endif<a name='1222'>
      enddo<a name='1223'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1224'></font>
<font color=#447700>!    NEXT section for shallow convection<a name='1225'></font>
<font color=#447700>!<a name='1226'></font>
      if(ishallow_g3.eq.1)then<a name='1227'>
<font color=#447700>!     write(0,*)'now do shallow for j = ',j<a name='1228'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_3">(z3,qes3,he3,hes3,tshall,qshall,po,z1, &amp;<a name='1229'>
           psur,ierr5,tcrit,0,xl,cp,   &amp;<a name='1230'>
           itf,jtf,ktf, &amp;<a name='1231'>
           its,ite, jts,jte, kts,kte)<a name='1232'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_3">(tshall,qes3,qshall,he3,hes3,z3,po,qes3_cup,q3_cup, &amp;<a name='1233'>
           he3_cup,hes3_cup,z3_cup,po_cup,gamma3_cup,t3_cup,psur,  &amp;<a name='1234'>
           ierr5,z1,xl,rv,cp,          &amp;<a name='1235'>
           itf,jtf,ktf, &amp;<a name='1236'>
           its,ite, jts,jte, kts,kte)<a name='1237'>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MAXIMI'>cup_MAXIMI</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MAXIMI_2">(HE3_CUP,1,kbmax,K23,ierr5, &amp;<a name='1238'>
           itf,jtf,ktf, &amp;<a name='1239'>
           its,ite, jts,jte, kts,kte)<a name='1240'>
       DO i=its,itf<a name='1241'>
         if(kpbl(i).gt.5)cap_max3(i)=po_cup(i,kpbl(i))<a name='1242'>
         IF(ierr5(I).eq.0.)THEN<a name='1243'>
         IF(K23(I).Gt.Kbmax(i))ierr5(i)=2<a name='1244'>
         if(kpbl(i).gt.5)k23(i)=kpbl(i)<a name='1245'>
         endif<a name='1246'>
         ierr5_0(i)=ierr5(i)<a name='1247'>
       ENDDO<a name='1248'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_2">(cap_max_increment,5,k23,kbcon3,he3_cup,hes3_cup, &amp;<a name='1249'>
           ierr5,kbmax,po_cup,cap_max3, &amp;<a name='1250'>
<font color=#447700>!          ierr5,kpbl,po_cup,cap_max3, &amp;<a name='1251'></font>
           itf,jtf,ktf, &amp;<a name='1252'>
           its,ite, jts,jte, kts,kte)<a name='1253'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_3">(k23,hkb3,z3_cup,cd3,mentr_rate3,he3_cup,hc3, &amp;<a name='1254'>
           kbcon3,ierr5,dby3,he3,hes3_cup,'shallow', &amp;<a name='1255'>
           itf,jtf,ktf, &amp;<a name='1256'>
           its,ite, jts,jte, kts,kte)<a name='1257'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_4">(k23,hkb3_0,z_cup,cd3,mentr_rate3,he_cup,hc3_0, &amp;<a name='1258'>
           kbcon3,ierr5,dby3_0,he,hes_cup,'shallow', &amp;<a name='1259'>
           itf,jtf,ktf, &amp;<a name='1260'>
           its,ite, jts,jte, kts,kte)<a name='1261'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_KTOP'>cup_ktop</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KTOP_2">(1,dby3,kbcon3,ktop3,ierr5, &amp;<a name='1262'>
           itf,jtf,ktf, &amp;<a name='1263'>
           its,ite, jts,jte, kts,kte)<a name='1264'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_3">(zu3,z3_cup,mentr_rate3,cd3,kbcon3,ktop3,    &amp;<a name='1265'>
           ierr5,k23, &amp;<a name='1266'>
           itf,jtf,ktf, &amp;<a name='1267'>
           its,ite, jts,jte, kts,kte)<a name='1268'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_4">(zu3_0,z_cup,mentr_rate3,cd3,kbcon3,ktop3,    &amp;<a name='1269'>
           ierr5,k23, &amp;<a name='1270'>
           itf,jtf,ktf, &amp;<a name='1271'>
           its,ite, jts,jte, kts,kte)<a name='1272'>
<font color=#447700>!<a name='1273'></font>
<font color=#447700>! first calculate aa3_0_cup<a name='1274'></font>
<font color=#447700>!<a name='1275'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_3">(aa3_0,z,zu3_0,dby3_0,GAMMA3_CUP,t_cup, &amp;<a name='1276'>
           kbcon3,ktop3,ierr5,           &amp;<a name='1277'>
           itf,jtf,ktf, &amp;<a name='1278'>
          its,ite, jts,jte, kts,kte)<a name='1279'>
<font color=#447700>!<a name='1280'></font>
<font color=#447700>!  now what is necessary for aa3 and feedbacks<a name='1281'></font>
<font color=#447700>!<a name='1282'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_3">('shallow',ierr5,z3_cup,qc3,qrc3,pw3,pwav3, &amp;<a name='1283'>
           kbcon3,ktop3,cd3,dby3,mentr_rate3,clw_all, &amp;<a name='1284'>
           qshall,GAMMA3_cup,zu3,qes3_cup,k23,q3_cup,xl,&amp;<a name='1285'>
           itf,jtf,ktf, &amp;<a name='1286'>
           its,ite, jts,jte, kts,kte)<a name='1287'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_4">(aa3,z3,zu3,dby3,GAMMA3_CUP,t3_cup, &amp;<a name='1288'>
           kbcon3,ktop3,ierr5,           &amp;<a name='1289'>
           itf,jtf,ktf, &amp;<a name='1290'>
          its,ite, jts,jte, kts,kte)<a name='1291'>
<font color=#447700>!     do i=its,itf<a name='1292'></font>
<font color=#447700>!        if(ierr5(i).eq.0)then<a name='1293'></font>
<font color=#447700>!          if(aa3(i).eq.0.)then<a name='1294'></font>
<font color=#447700>!              ierr5(i)=17<a name='1295'></font>
<font color=#447700>!          endif<a name='1296'></font>
<font color=#447700>!        endif<a name='1297'></font>
<font color=#447700>!     enddo<a name='1298'></font>
<font color=#447700>!     call cup_dellabot('shallow',ipr,jpr,q3_cup,ierr5,z3_cup,po,qrcdo,edto, &amp;<a name='1299'></font>
<font color=#447700>!          zdo,cdd,q3,dellaq3,dsubq,j,mentrd_rate,z3,g,&amp;<a name='1300'></font>
<font color=#447700>!          itf,jtf,ktf, &amp;<a name='1301'></font>
<font color=#447700>!          its,ite, jts,jte, kts,kte)<a name='1302'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DELLAS_3D'>cup_dellas_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLAS_3D_1">(ierr5,z3_cup,po_cup,hcdo,edt3,zdo3,cdd,    &amp;<a name='1303'>
           he3,dellah3,dsubt3,j,mentrd_rate,zu3,g,                     &amp;<a name='1304'>
           cd3,hc3,ktop3,k23,kbcon3,mentr_rate3,jmin,he3_cup,kdet, &amp;<a name='1305'>
           k23,ipr,jpr,'shallow',0,                                 &amp;<a name='1306'>
           itf,jtf,ktf, &amp;<a name='1307'>
           its,ite, jts,jte, kts,kte)<a name='1308'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DELLAS_3D'>cup_dellas_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLAS_3D_2">(ierr5,z3_cup,po_cup,qrcdo,edt3,zdo3,cdd, &amp;<a name='1309'>
           qshall,dellaq3,dsubq3,j,mentrd_rate,zu3,g, &amp;<a name='1310'>
           cd3,qc3,ktop3,k23,kbcon3,mentr_rate3,jmin,q3_cup,kdet, &amp;<a name='1311'>
           k23,ipr,jpr,'shallow',0,               &amp;<a name='1312'>
              itf,jtf,ktf,                     &amp;<a name='1313'>
              its,ite, jts,jte, kts,kte    )<a name='1314'>
              mbdt_s=1.e-1*mbdt_ens(1)<a name='1315'>
              do k=kts,ktf<a name='1316'>
              do i=its,itf<a name='1317'>
                 dellat3(i,k)=0.<a name='1318'>
                 if(ierr5(i).eq.0)then<a name='1319'>
                    trash=dsubt3(i,k)<a name='1320'>
                    XHE3(I,K)=(dsubt3(i,k)+DELLAH3(I,K))*MBDT_S+HE3(I,K)<a name='1321'>
                    XQ3(I,K)=(dsubq3(i,k)+DELLAQ3(I,K))*MBDT_S+QSHALL(I,K)<a name='1322'>
                    DELLAT3(I,K)=(1./cp)*(DELLAH3(I,K)-xl*DELLAQ3(I,K))<a name='1323'>
                    dSUBT3(I,K)=(1./cp)*(dsubt3(i,k)-xl*dsubq3(i,k))<a name='1324'>
                    XT3(I,K)= (DELLAT3(I,K)+dsubt3(i,k))*MBDT_S+TSHALL(I,K)<a name='1325'>
                    IF(XQ3(I,K).LE.0.)XQ3(I,K)=1.E-08<a name='1326'>
<font color=#447700>!                    if(i.eq.ipr.and.j.eq.jpr)then<a name='1327'></font>
<font color=#447700>!                      write(0,*)k,trash,DELLAQ3(I,K),dsubq3(I,K),dsubt3(i,k)<a name='1328'></font>
<font color=#447700>!                    endif<a name='1329'></font>
                 ENDIF<a name='1330'>
              enddo<a name='1331'>
              enddo<a name='1332'>
      do i=its,itf<a name='1333'>
      if(ierr5(i).eq.0)then<a name='1334'>
      XHE3(I,ktf)=HE3(I,ktf)<a name='1335'>
      XQ3(I,ktf)=QSHALL(I,ktf)<a name='1336'>
      XT3(I,ktf)=TSHALL(I,ktf)<a name='1337'>
      IF(XQ3(I,ktf).LE.0.)XQ3(I,ktf)=1.E-08<a name='1338'>
      endif<a name='1339'>
      enddo<a name='1340'>
<font color=#447700>!<a name='1341'></font>
<font color=#447700>!--- calculate moist static energy, heights, qes<a name='1342'></font>
<font color=#447700>!<a name='1343'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_4">(xz3,xqes3,xhe3,xhes3,xt3,xq3,po,z1, &amp;<a name='1344'>
           psur,ierr5,tcrit,2,xl,cp,   &amp;<a name='1345'>
           itf,jtf,ktf, &amp;<a name='1346'>
           its,ite, jts,jte, kts,kte)<a name='1347'>
<font color=#447700>!<a name='1348'></font>
<font color=#447700>!--- environmental values on cloud levels<a name='1349'></font>
<font color=#447700>!<a name='1350'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_4">(xt3,xqes3,xq3,xhe3,xhes3,xz3,po,xqes3_cup,xq3_cup, &amp;<a name='1351'>
           xhe3_cup,xhes3_cup,xz3_cup,po_cup,gamma3_cup,xt3_cup,psur,   &amp;<a name='1352'>
           ierr5,z1,xl,rv,cp,          &amp;<a name='1353'>
           itf,jtf,ktf, &amp;<a name='1354'>
           its,ite, jts,jte, kts,kte)<a name='1355'>
<font color=#447700>!     <a name='1356'></font>
<font color=#447700>!     <a name='1357'></font>
<font color=#447700>!**************************** static control<a name='1358'></font>
<font color=#447700>!     <a name='1359'></font>
<font color=#447700>!--- moist static energy inside cloud<a name='1360'></font>
<font color=#447700>!<a name='1361'></font>
      do i=its,itf<a name='1362'>
        if(ierr5(i).eq.0)then<a name='1363'>
          xhkb3(i)=xhe3(i,k23(i))<a name='1364'>
        endif<a name='1365'>
      enddo<a name='1366'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_5">(k23,xhkb3,xz3_cup,cd3,mentr_rate3,xhe3_cup,xhc3, &amp;<a name='1367'>
           kbcon3,ierr5,xdby3,xhe3,xhes3_cup,'shallow', &amp;<a name='1368'>
           itf,jtf,ktf, &amp;<a name='1369'>
           its,ite, jts,jte, kts,kte)<a name='1370'>
<font color=#447700>!          <a name='1371'></font>
<font color=#447700>!c--- normalized mass flux profile and CWF<a name='1372'></font>
<font color=#447700>!          <a name='1373'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_5">(xzu3,xz3_cup,mentr_rate3,cd3,kbcon3,ktop3,ierr5,k23, &amp;<a name='1374'>
           itf,jtf,ktf, &amp;<a name='1375'>
           its,ite, jts,jte, kts,kte)<a name='1376'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_5">(xaa3,xz3,xzu3,xdby3,GAMMA3_CUP,xt3_cup, &amp;<a name='1377'>
           kbcon3,ktop3,ierr5,           &amp;<a name='1378'>
           itf,jtf,ktf, &amp;<a name='1379'>
           its,ite, jts,jte, kts,kte)<a name='1380'>
<font color=#447700>!<a name='1381'></font>
<font color=#447700>! now for shallow forcing<a name='1382'></font>
<font color=#447700>!<a name='1383'></font>
       do i=its,itf<a name='1384'>
        xmb3(i)=0.<a name='1385'>
        xff_shal(1:9)=0.<a name='1386'>
        if(ierr5(i).eq.0)then<a name='1387'>
          xkshal=(xaa3(i)-aa3(i))/mbdt_s<a name='1388'>
          if(xkshal.ge.0.)xkshal=+1.e6<a name='1389'>
          if(xkshal.gt.-1.e-4 .and. xkshal.lt.0.)xkshal=-1.e-4<a name='1390'>
          xff_shal(1)=max(0.,-(aa3(i)-aa3_0(i))/(xkshal*dtime))<a name='1391'>
          xff_shal(2)=max(0.,-(aa3(i)-aa3_0(i))/(xkshal*dtime))<a name='1392'>
          xff_shal(3)=max(0.,-(aa3(i)-aa3_0(i))/(xkshal*dtime))<a name='1393'>
          if(aa3_0(i).le.0)then<a name='1394'>
           xff_shal(1)=0.<a name='1395'>
           xff_shal(2)=0.<a name='1396'>
           xff_shal(3)=0.<a name='1397'>
          endif<a name='1398'>
          if(aa3(i)-aa3_0(i).le.0.)then<a name='1399'>
           xff_shal(1)=0.<a name='1400'>
           xff_shal(2)=0.<a name='1401'>
           xff_shal(3)=0.<a name='1402'>
          endif<a name='1403'>
<font color=#447700>! boundary layer QE (from Saulo Freitas)<a name='1404'></font>
          blqe=0.<a name='1405'>
          trash=0.<a name='1406'>
          if(k23(i).lt.kpbl(i)+1)then<a name='1407'>
             do k=1,kbcon3(i)-1<a name='1408'>
                blqe=blqe+100.*dhdt(i,k)*(p_cup(i,k)-p_cup(i,k+1))/g<a name='1409'>
             enddo<a name='1410'>
             trash=max((hc3(i,kbcon3(i))-he_cup(i,kbcon3(i))),1.e1)<a name='1411'>
             xff_shal(7)=max(0.,blqe/trash)<a name='1412'>
             xff_shal(7)=min(0.1,xff_shal(7))<a name='1413'>
          else<a name='1414'>
             xff_shal(7)=0.<a name='1415'>
          endif<a name='1416'>
          if((xkshal.lt.-1.1e-04) .and.  &amp;<a name='1417'>
             ((aa3(i)-aa3_0(i).gt.0.) .or. (xff_shal(7).gt.0)))then<a name='1418'>
          xff_shal(4)=max(0.,-aa3(i)/(xkshal*tscl_KF))<a name='1419'>
          xff_shal(4)=min(0.1,xff_shal(4))<a name='1420'>
          xff_shal(5)=xff_shal(4)<a name='1421'>
          xff_shal(6)=xff_shal(4)<a name='1422'>
          else<a name='1423'>
           xff_shal(4)=0.<a name='1424'>
           xff_shal(5)=0.<a name='1425'>
           xff_shal(6)=0.<a name='1426'>
          endif<a name='1427'>
<font color=#447700>!         write(0,888)'i0=',i,j,kpbl(i),blqe,xff_shal(7)<a name='1428'></font>
888       format(a3,3(1x,i3),2e12.4)<a name='1429'>
          xff_shal(8)= xff_shal(7)<a name='1430'>
          xff_shal(9)= xff_shal(7)<a name='1431'>
          do k=1,9<a name='1432'>
           xmb3(i)=xmb3(i)+xff_shal(k)<a name='1433'>
          enddo<a name='1434'>
          xmb3(i)=min(.1,xmb3(i)/9.)<a name='1435'>
<font color=#447700>!         if(xmb3(i).eq.10.1 )then<a name='1436'></font>
<font color=#447700>!           write(0,*)'i0,xmb3,blqe,xkshal = ',i,j,xmb3(i),blqe,xkshal<a name='1437'></font>
<font color=#447700>!           if(xff_shal(7).ge.0.1)then<a name='1438'></font>
<font color=#447700>!             write(0,*)'i1,blqe,trash = ',blqe,trash<a name='1439'></font>
<font color=#447700>!           endif<a name='1440'></font>
<font color=#447700>!           if(xff_shal(7).eq.0 .and. xff_shal(1).ge.0.1)then<a name='1441'></font>
<font color=#447700>!              write(0,*)'i2,aa3_0(i),aa3(i),xaa3(i) = ',aa3_0(i),aa3(i),xaa3(i)<a name='1442'></font>
<font color=#447700>!           endif<a name='1443'></font>
<font color=#447700>!           if(xff_shal(5).ge.0.1)then<a name='1444'></font>
<font color=#447700>!              write(0,*)'i3,aa3(i),a0,xkshal= ',aa3(i),aa3_0(i),xkshal<a name='1445'></font>
<font color=#447700>!           endif<a name='1446'></font>
<font color=#447700>!           write(0,*)'i0, xff_shallow = ',xff_shal<a name='1447'></font>
<font color=#447700>!         endif<a name='1448'></font>
<font color=#447700>!!         if(xff_shal(7).eq.0 .and. xff_shal(4).gt.0 .and. xmb3(i).eq.0.5)then<a name='1449'></font>
<font color=#447700>!!           write(0,*)'i4,xmb3 = ',i,j,xmb3(i),xkshal<a name='1450'></font>
<font color=#447700>!!           write(0,*)'xff_shallow = ',xff_shal<a name='1451'></font>
<font color=#447700>!!           write(0,*)aa3(i),xaa3(i),blqe<a name='1452'></font>
<font color=#447700>!!         endif<a name='1453'></font>
          if(xmb3(i).eq.0.)ierr5(i)=22<a name='1454'>
          if(xmb3(i).lt.0.)then<a name='1455'>
             ierr5(i)=21<a name='1456'>
<font color=#447700>!            write(0,*)'neg xmb,i,j,xmb3 for shallow = ',i,j,k23(i),ktop3(i),kbcon3(i),kpbl(i)<a name='1457'></font>
          endif<a name='1458'>
        endif<a name='1459'>
<font color=#447700>!         if(ierr5(i).eq.0)write(0,*)'i,j,xmb3 for shallow = ',i,j,xmb3(i),k23(i),ktop3(i)<a name='1460'></font>
<font color=#447700>!         if(ierr5(i).eq.0.and.i.eq.12.and.j.eq.25)write(0,*)'i,j,xmb3 for shallow = ',k23(i),ktop3(i),kbcon3(i),kpbl(i)<a name='1461'></font>
<font color=#447700>!         if(ierr5(i).eq.0)write(0,*)'i,j,xmb3 for shallow = ',i,j,k23(i),ktop3(i),kbcon3(i),kpbl(i)<a name='1462'></font>
        if(ierr5(i).ne.0)then<a name='1463'>
           k23(i)=0<a name='1464'>
           kbcon3(i)=0<a name='1465'>
           ktop3(i)=0<a name='1466'>
           xmb3(i)=0<a name='1467'>
           do k=kts,ktf<a name='1468'>
              outts(i,k)=0.<a name='1469'>
              outqs(i,k)=0.<a name='1470'>
           enddo<a name='1471'>
        else if(ierr5(i).eq.0)then<a name='1472'>
<font color=#447700>!<a name='1473'></font>
<font color=#447700>! got the mass flux, sanity check, first for heating rates<a name='1474'></font>
<font color=#447700>!<a name='1475'></font>
          trash=0.<a name='1476'>
          do k=2,ktop3(i)<a name='1477'>
           trash=max(trash,86400.*(dsubt3(i,k)+dellat3(i,k))*xmb3(i))<a name='1478'>
          enddo<a name='1479'>
          if(trash.gt.150.)xmb3(i)=xmb3(i)*150./trash<a name='1480'>
<font color=#447700>!<a name='1481'></font>
<font color=#447700>! sanity check on moisture tendencies: do not allow anything that may allow neg tendencies<a name='1482'></font>
<font color=#447700>!<a name='1483'></font>
          do k=2,ktop3(i)<a name='1484'>
           trash=q(i,k)+(dsubq3(i,k)+dellaq3(i,k))*xmb3(i)*dtime<a name='1485'>
          if(trash.lt.1.e-12)then<a name='1486'>
<font color=#447700>! max allowable tendency over tendency that would lead to too small mix ratios<a name='1487'></font>
<font color=#447700>!<a name='1488'></font>
            trash=((1.e-12-q(i,k))/dtime)                   &amp;<a name='1489'>
                  /((dsubq3(i,k)+dellaq3(i,k))*xmb3(i))<a name='1490'>
            trash=max(0.,trash)<a name='1491'>
            trash=min(1.,trash)<a name='1492'>
            xmb3(i)=trash*xmb3(i)<a name='1493'>
          endif<a name='1494'>
          enddo<a name='1495'>
<font color=#447700>! <a name='1496'></font>
<font color=#447700>! final tendencies<a name='1497'></font>
<font color=#447700>!<a name='1498'></font>
          do k=2,ktop3(i)<a name='1499'>
           outts(i,k)=(dsubt3(i,k)+dellat3(i,k))*xmb3(i)<a name='1500'>
           outqs(i,k)=(dsubq3(i,k)+dellaq3(i,k))*xmb3(i)<a name='1501'>
          enddo<a name='1502'>
        endif<a name='1503'>
       enddo<a name='1504'>
<font color=#447700>!       if(j.eq.-25)then<a name='1505'></font>
<font color=#447700>!!        write(0,*)'!!!!!!!! j = ',j,' !!!!!!!!!!!!!!!!!!!!'<a name='1506'></font>
        i=12<a name='1507'>
<font color=#447700>!        write(0,*)k23(i),kbcon3(i),ktop3(i)<a name='1508'></font>
<font color=#447700>!        write(0,*)kpbl(i),ierr5(i),ierr(i)<a name='1509'></font>
<font color=#447700>!        write(0,*)xmb3(i),xff_shal(1:9)<a name='1510'></font>
<font color=#447700>!        write(0,*)xaa3(i),aa1(i),aa0(i),aa3(i)<a name='1511'></font>
<font color=#447700>!        do k=1,ktf<a name='1512'></font>
<font color=#447700>!          write(0,*)po(i,k),he3(i,k),hes3(i,k),dellah3(i,k)<a name='1513'></font>
<font color=#447700>!        enddo<a name='1514'></font>
<font color=#447700>!        do k=1,ktf<a name='1515'></font>
<font color=#447700>!          write(0,*)zu3(i,k),hc3(i,k),dsubt3(i,k),dellat3(i,k)<a name='1516'></font>
<font color=#447700>!        enddo<a name='1517'></font>
<font color=#447700>!        do k=1,ktop3(i)+1<a name='1518'></font>
<font color=#447700>!          blqe=cp*outts(i,k)+xl*outqs(i,k)<a name='1519'></font>
<font color=#447700>!          write(0,*)outts(i,k),outqs(i,k),blqe<a name='1520'></font>
<font color=#447700>!        enddo<a name='1521'></font>
<font color=#447700>!       endif<a name='1522'></font>
<font color=#447700>!      <a name='1523'></font>
<font color=#447700>! done shallow<a name='1524'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1525'></font>
       ENDIF<a name='1526'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1527'></font>
<a name='1528'>
<a name='1529'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX'>cup_axx</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_AXX_1">(tcrit,kbmax,z1,p,psur,xl,rv,cp,tx,qx,axx,ierr,    &amp;<a name='1530'>
           cap_max,cap_max_increment,entr_rate,mentr_rate,&amp;<a name='1531'>
           j,itf,jtf,ktf, &amp;<a name='1532'>
           its,ite, jts,jte, kts,kte,ens4)<a name='1533'>
<a name='1534'>
<font color=#447700>!<a name='1535'></font>
<font color=#447700>!--- DETERMINE DOWNDRAFT STRENGTH IN TERMS OF WINDSHEAR<a name='1536'></font>
<font color=#447700>!<a name='1537'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_DD_EDT'>cup_dd_edt</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_EDT_1">(ierr,us,vs,zo,ktop,kbcon,edt,po,pwavo, &amp;<a name='1538'>
           pwevo,edtmax,edtmin,maxens2,edtc, &amp;<a name='1539'>
           itf,jtf,ktf, &amp;<a name='1540'>
           its,ite, jts,jte, kts,kte)<a name='1541'>
      do 250 iedt=1,maxens2<a name='1542'>
        do i=its,itf<a name='1543'>
         if(ierr(i).eq.0)then<a name='1544'>
         edt(i)=edtc(i,iedt)<a name='1545'>
         edto(i)=edtc(i,iedt)<a name='1546'>
         edtx(i)=edtc(i,iedt)<a name='1547'>
         edt_out(i,j)=edtc(i,2)<a name='1548'>
         if(high_resolution.eq.1)then<a name='1549'>
            edt(i)=edtc(i,3)<a name='1550'>
            edto(i)=edtc(i,3)<a name='1551'>
            edtx(i)=edtc(i,3)<a name='1552'>
            edt_out(i,j)=edtc(i,3)<a name='1553'>
         endif<a name='1554'>
         endif<a name='1555'>
        enddo<a name='1556'>
        do k=kts,ktf<a name='1557'>
        do i=its,itf<a name='1558'>
           subt_ens(i,k,iedt)=0.<a name='1559'>
           subq_ens(i,k,iedt)=0.<a name='1560'>
           dellat_ens(i,k,iedt)=0.<a name='1561'>
           dellaq_ens(i,k,iedt)=0.<a name='1562'>
           dellaqc_ens(i,k,iedt)=0.<a name='1563'>
           pwo_ens(i,k,iedt)=0.<a name='1564'>
        enddo<a name='1565'>
        enddo<a name='1566'>
<font color=#447700>!<a name='1567'></font>
<font color=#447700>!      if(j.eq.jpr.and.iedt.eq.1.and.ipr.gt.its.and.ipr.lt.ite)then<a name='1568'></font>
<font color=#447700>!!      if(j.eq.jpr)then<a name='1569'></font>
<font color=#447700>!         i=ipr<a name='1570'></font>
<font color=#447700>!!        write(0,*)'in 250 loop ',iedt,edt(ipr),ierr(ipr)<a name='1571'></font>
<font color=#447700>!!       if(ierr(i).eq.0.or.ierr(i).eq.3)then<a name='1572'></font>
<font color=#447700>!         write(0,*)'250',k22(I),kbcon(i),ktop(i),jmin(i)<a name='1573'></font>
<font color=#447700>!         write(0,*)edt(i),aa0(i),aa1(i)<a name='1574'></font>
<font color=#447700>!         do k=kts,ktf<a name='1575'></font>
<font color=#447700>!           write(0,*)k,z(i,k),he(i,k),hes(i,k)<a name='1576'></font>
<font color=#447700>!         enddo<a name='1577'></font>
<font color=#447700>!         write(0,*)'end 250 loop ',iedt,edt(ipr),ierr(ipr)<a name='1578'></font>
<font color=#447700>!         do k=1,ktop(i)+1<a name='1579'></font>
<font color=#447700>!           write(0,*)zu(i,k),zd(i,k),pw(i,k),pwd(i,k)<a name='1580'></font>
<font color=#447700>!         enddo<a name='1581'></font>
<font color=#447700>!!        endif<a name='1582'></font>
<font color=#447700>!      endif<a name='1583'></font>
      do i=its,itf<a name='1584'>
        aad(i)=0.<a name='1585'>
      enddo<a name='1586'>
<font color=#447700>!<a name='1587'></font>
<font color=#447700>!--- change per unit mass that a model cloud would modify the environment<a name='1588'></font>
<font color=#447700>!<a name='1589'></font>
<font color=#447700>!--- 1. in bottom layer<a name='1590'></font>
<font color=#447700>!<a name='1591'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DELLABOT'>cup_dellabot</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLABOT_1">('deep',ipr,jpr,heo_cup,ierr,zo_cup,po,hcdo,edto, &amp;<a name='1592'>
           zdo,cdd,heo,dellah,dsubt,j,mentrd_rate,zo,g, &amp;<a name='1593'>
           itf,jtf,ktf, &amp;<a name='1594'>
           its,ite, jts,jte, kts,kte)<a name='1595'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DELLABOT'>cup_dellabot</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLABOT_2">('deep',ipr,jpr,qo_cup,ierr,zo_cup,po,qrcdo,edto, &amp;<a name='1596'>
           zdo,cdd,qo,dellaq,dsubq,j,mentrd_rate,zo,g,&amp;<a name='1597'>
           itf,jtf,ktf, &amp;<a name='1598'>
           its,ite, jts,jte, kts,kte)<a name='1599'>
<font color=#447700>!<a name='1600'></font>
<font color=#447700>!--- 2. everywhere else<a name='1601'></font>
<font color=#447700>!<a name='1602'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DELLAS_3D'>cup_dellas_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLAS_3D_3">(ierr,zo_cup,po_cup,hcdo,edto,zdo,cdd,    &amp;<a name='1603'>
           heo,dellah,dsubt,j,mentrd_rate,zuo,g,                     &amp;<a name='1604'>
           cd,hco,ktop,k22,kbcon,mentr_rate,jmin,heo_cup,kdet, &amp;<a name='1605'>
           k22,ipr,jpr,'deep',high_resolution,                                 &amp;<a name='1606'>
           itf,jtf,ktf, &amp;<a name='1607'>
           its,ite, jts,jte, kts,kte)<a name='1608'>
<font color=#447700>!<a name='1609'></font>
<font color=#447700>!-- take out cloud liquid water for detrainment<a name='1610'></font>
<font color=#447700>!<a name='1611'></font>
<font color=#447700>!??   do k=kts,ktf<a name='1612'></font>
      do k=kts,ktf-1<a name='1613'>
      do i=its,itf<a name='1614'>
       scr1(i,k)=0.<a name='1615'>
       dellaqc(i,k)=0.<a name='1616'>
       if(ierr(i).eq.0)then<a name='1617'>
         scr1(i,k)=qco(i,k)-qrco(i,k)<a name='1618'>
         if(k.eq.ktop(i)-0)dellaqc(i,k)= &amp;<a name='1619'>
                      .01*zuo(i,ktop(i))*qrco(i,ktop(i))* &amp;<a name='1620'>
                      9.81/(po_cup(i,k)-po_cup(i,k+1))<a name='1621'>
         if(k.lt.ktop(i).and.k.gt.kbcon(i))then<a name='1622'>
           dz=zo_cup(i,k+1)-zo_cup(i,k)<a name='1623'>
           dellaqc(i,k)=.01*9.81*cd(i,k)*dz*zuo(i,k) &amp;<a name='1624'>
                        *.5*(qrco(i,k)+qrco(i,k+1))/ &amp;<a name='1625'>
                        (po_cup(i,k)-po_cup(i,k+1))<a name='1626'>
         endif<a name='1627'>
       endif<a name='1628'>
      enddo<a name='1629'>
      enddo<a name='1630'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DELLAS_3D'>cup_dellas_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DELLAS_3D_4">(ierr,zo_cup,po_cup,qrcdo,edto,zdo,cdd, &amp;<a name='1631'>
           qo,dellaq,dsubq,j,mentrd_rate,zuo,g, &amp;<a name='1632'>
           cd,qco,ktop,k22,kbcon,mentr_rate,jmin,qo_cup,kdet, &amp;<a name='1633'>
           k22,ipr,jpr,'deep',high_resolution,               &amp;<a name='1634'>
              itf,jtf,ktf,                     &amp;<a name='1635'>
              its,ite, jts,jte, kts,kte    )<a name='1636'>
<font color=#447700>!<a name='1637'></font>
<font color=#447700>!--- using dellas, calculate changed environmental profiles<a name='1638'></font>
<font color=#447700>!<a name='1639'></font>
<font color=#447700>!     do 200 nens=1,maxens<a name='1640'></font>
      mbdt=mbdt_ens(2)<a name='1641'>
      do i=its,itf<a name='1642'>
      xaa0_ens(i,1)=0.<a name='1643'>
      xaa0_ens(i,2)=0.<a name='1644'>
      xaa0_ens(i,3)=0.<a name='1645'>
      enddo<a name='1646'>
<a name='1647'>
<font color=#447700>!      if(j.eq.jpr)then<a name='1648'></font>
<font color=#447700>!               write(0,*)'xt',xl,'DELLAH(I,K),DELLAQ(I,K),dsubq(I,K),dsubt(i,k)'<a name='1649'></font>
<font color=#447700>!      endif<a name='1650'></font>
      do k=kts,ktf<a name='1651'>
      do i=its,itf<a name='1652'>
         dellat(i,k)=0.<a name='1653'>
         if(ierr(i).eq.0)then<a name='1654'>
            trash=dsubt(i,k)<a name='1655'>
            XHE(I,K)=(dsubt(i,k)+DELLAH(I,K))*MBDT+HEO(I,K)<a name='1656'>
            XQ(I,K)=(dsubq(i,k)+DELLAQ(I,K))*MBDT+QO(I,K)<a name='1657'>
            DELLAT(I,K)=(1./cp)*(DELLAH(I,K)-xl*DELLAQ(I,K))<a name='1658'>
            dSUBT(I,K)=(1./cp)*(dsubt(i,k)-xl*dsubq(i,k))<a name='1659'>
            XT(I,K)= (DELLAT(I,K)+dsubt(i,k))*MBDT+TN(I,K)<a name='1660'>
            IF(XQ(I,K).LE.0.)XQ(I,K)=1.E-08<a name='1661'>
<font color=#447700>!             if(i.eq.ipr.and.j.eq.jpr)then<a name='1662'></font>
<font color=#447700>!               write(0,*)k,trash,DELLAQ(I,K),dsubq(I,K),dsubt(i,k)<a name='1663'></font>
<font color=#447700>!             endif<a name='1664'></font>
         ENDIF<a name='1665'>
      enddo<a name='1666'>
      enddo<a name='1667'>
      do i=its,itf<a name='1668'>
      if(ierr(i).eq.0)then<a name='1669'>
      XHE(I,ktf)=HEO(I,ktf)<a name='1670'>
      XQ(I,ktf)=QO(I,ktf)<a name='1671'>
      XT(I,ktf)=TN(I,ktf)<a name='1672'>
      IF(XQ(I,ktf).LE.0.)XQ(I,ktf)=1.E-08<a name='1673'>
      endif<a name='1674'>
      enddo<a name='1675'>
<font color=#447700>!<a name='1676'></font>
<font color=#447700>!--- calculate moist static energy, heights, qes<a name='1677'></font>
<font color=#447700>!<a name='1678'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV'>cup_env</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_5">(xz,xqes,xhe,xhes,xt,xq,po,z1, &amp;<a name='1679'>
           psur,ierr,tcrit,2,xl,cp,   &amp;<a name='1680'>
           itf,jtf,ktf, &amp;<a name='1681'>
           its,ite, jts,jte, kts,kte)<a name='1682'>
<font color=#447700>!<a name='1683'></font>
<font color=#447700>!--- environmental values on cloud levels<a name='1684'></font>
<font color=#447700>!<a name='1685'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_ENV_CLEV'>cup_env_clev</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_ENV_CLEV_5">(xt,xqes,xq,xhe,xhes,xz,po,xqes_cup,xq_cup, &amp;<a name='1686'>
           xhe_cup,xhes_cup,xz_cup,po_cup,gamma_cup,xt_cup,psur,   &amp;<a name='1687'>
           ierr,z1,xl,rv,cp,          &amp;<a name='1688'>
           itf,jtf,ktf, &amp;<a name='1689'>
           its,ite, jts,jte, kts,kte)<a name='1690'>
<font color=#447700>!<a name='1691'></font>
<font color=#447700>!<a name='1692'></font>
<font color=#447700>!**************************** static control<a name='1693'></font>
<font color=#447700>!<a name='1694'></font>
<font color=#447700>!--- moist static energy inside cloud<a name='1695'></font>
<font color=#447700>!<a name='1696'></font>
      do i=its,itf<a name='1697'>
        if(ierr(i).eq.0)then<a name='1698'>
          xhkb(i)=xhe(i,k22(i))<a name='1699'>
        endif<a name='1700'>
      enddo<a name='1701'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_6">(k22,xhkb,xz_cup,cd,mentr_rate,xhe_cup,xhc, &amp;<a name='1702'>
           kbcon,ierr,xdby,xhe,xhes_cup,'deep', &amp;<a name='1703'>
           itf,jtf,ktf, &amp;<a name='1704'>
           its,ite, jts,jte, kts,kte)<a name='1705'>
<font color=#447700>!<a name='1706'></font>
<font color=#447700>!c--- normalized mass flux profile<a name='1707'></font>
<font color=#447700>!<a name='1708'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_6">(xzu,xz_cup,mentr_rate,cd,kbcon,ktop,ierr,k22, &amp;<a name='1709'>
           itf,jtf,ktf, &amp;<a name='1710'>
           its,ite, jts,jte, kts,kte)<a name='1711'>
<font color=#447700>!<a name='1712'></font>
<font color=#447700>!--- moisture downdraft<a name='1713'></font>
<font color=#447700>!<a name='1714'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_NMS'>cup_dd_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_NMS_3">(xzd,xz_cup,cdd,mentrd_rate,jmin,ierr, &amp;<a name='1715'>
           1,kdet,z1,                 &amp;<a name='1716'>
           itf,jtf,ktf, &amp;<a name='1717'>
           its,ite, jts,jte, kts,kte)<a name='1718'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_HE'>cup_dd_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_HE_3">(xhes_cup,xzd,xhcd,xz_cup,cdd,mentrd_rate, &amp;<a name='1719'>
           jmin,ierr,xhe,dbyd,xhe_cup,&amp;<a name='1720'>
           itf,jtf,ktf, &amp;<a name='1721'>
           its,ite, jts,jte, kts,kte)<a name='1722'>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_MOISTURE_3D'>cup_dd_moisture_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_DD_MOISTURE_3D_3">(xzd,xhcd,xhes_cup,xqcd,xqes_cup, &amp;<a name='1723'>
           xpwd,xq_cup,xz_cup,cdd,mentrd_rate,jmin,ierr,gamma_cup, &amp;<a name='1724'>
           xpwev,bu,xqrcd,xq,xhe,xt_cup,3,xl,high_resolution, &amp;<a name='1725'>
           itf,jtf,ktf, &amp;<a name='1726'>
           its,ite, jts,jte, kts,kte)<a name='1727'>
<a name='1728'>
<font color=#447700>!<a name='1729'></font>
<font color=#447700>!------- MOISTURE updraft<a name='1730'></font>
<font color=#447700>!<a name='1731'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_MOISTURE'>cup_up_moisture</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_MOISTURE_4">('deep',ierr,xz_cup,xqc,xqrc,xpw,xpwav, &amp;<a name='1732'>
           kbcon,ktop,cd,xdby,mentr_rate,clw_all, &amp;<a name='1733'>
           xq,GAMMA_cup,xzu,xqes_cup,k22,xq_cup,xl, &amp;<a name='1734'>
           itf,jtf,ktf, &amp;<a name='1735'>
           its,ite, jts,jte, kts,kte)<a name='1736'>
<font color=#447700>!<a name='1737'></font>
<font color=#447700>!--- workfunctions for updraft<a name='1738'></font>
<font color=#447700>!<a name='1739'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_6">(xaa0,xz,xzu,xdby,GAMMA_CUP,xt_cup, &amp;<a name='1740'>
           kbcon,ktop,ierr,           &amp;<a name='1741'>
           itf,jtf,ktf, &amp;<a name='1742'>
           its,ite, jts,jte, kts,kte)<a name='1743'>
      do 200 nens=1,maxens<a name='1744'>
      do i=its,itf <a name='1745'>
         if(ierr(i).eq.0)then<a name='1746'>
           xaa0_ens(i,nens)=xaa0(i)<a name='1747'>
           nall=(iens-1)*maxens3*maxens*maxens2 &amp;<a name='1748'>
                +(iedt-1)*maxens*maxens3 &amp;<a name='1749'>
                +(nens-1)*maxens3<a name='1750'>
           do k=kts,ktf<a name='1751'>
              if(k.le.ktop(i))then<a name='1752'>
                 do nens3=1,maxens3<a name='1753'>
                 if(nens3.eq.7)then<a name='1754'>
<font color=#447700>!--- b=0<a name='1755'></font>
                 pr_ens(i,j,nall+nens3)=pr_ens(i,j,nall+nens3)  &amp;<a name='1756'>
                                 +edto(i)*pwdo(i,k)             &amp;<a name='1757'>
                                    +pwo(i,k) <a name='1758'>
<font color=#447700>!--- b=beta<a name='1759'></font>
                 else if(nens3.eq.8)then<a name='1760'>
                 pr_ens(i,j,nall+nens3)=pr_ens(i,j,nall+nens3)+ &amp;<a name='1761'>
                                    pwo(i,k)<a name='1762'>
<font color=#447700>!--- b=beta/2<a name='1763'></font>
                 else if(nens3.eq.9)then<a name='1764'>
                 pr_ens(i,j,nall+nens3)=pr_ens(i,j,nall+nens3)  &amp;<a name='1765'>
                                 +.5*edto(i)*pwdo(i,k)          &amp;<a name='1766'>
                                 +  pwo(i,k)<a name='1767'>
                 else<a name='1768'>
                 pr_ens(i,j,nall+nens3)=pr_ens(i,j,nall+nens3)+ &amp;<a name='1769'>
                                    pwo(i,k)+edto(i)*pwdo(i,k)<a name='1770'>
                 endif<a name='1771'>
                 enddo<a name='1772'>
              endif<a name='1773'>
           enddo<a name='1774'>
         if(pr_ens(i,j,nall+7).lt.1.e-6)then<a name='1775'>
            ierr(i)=18<a name='1776'>
            do nens3=1,maxens3<a name='1777'>
               pr_ens(i,j,nall+nens3)=0.<a name='1778'>
            enddo<a name='1779'>
         endif<a name='1780'>
         do nens3=1,maxens3<a name='1781'>
           if(pr_ens(i,j,nall+nens3).lt.1.e-4)then<a name='1782'>
            pr_ens(i,j,nall+nens3)=0.<a name='1783'>
           endif<a name='1784'>
         enddo<a name='1785'>
         endif<a name='1786'>
      enddo<a name='1787'>
 200  continue<a name='1788'>
<font color=#447700>!<a name='1789'></font>
<font color=#447700>!--- LARGE SCALE FORCING<a name='1790'></font>
<font color=#447700>!<a name='1791'></font>
<font color=#447700>!<a name='1792'></font>
<font color=#447700>!------- CHECK wether aa0 should have been zero<a name='1793'></font>
<font color=#447700>!<a name='1794'></font>
<font color=#447700>!<a name='1795'></font>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MAXIMI'>cup_MAXIMI</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MAXIMI_3">(HEO_CUP,3,KBMAX,K22x,ierr, &amp;<a name='1796'>
           itf,jtf,ktf, &amp;<a name='1797'>
           its,ite, jts,jte, kts,kte)<a name='1798'>
      do i=its,itf<a name='1799'>
         ierr2(i)=ierr(i)<a name='1800'>
         ierr3(i)=ierr(i)<a name='1801'>
      enddo<a name='1802'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_3">(cap_max_increment,2,k22x,kbconx,heo_cup, &amp;<a name='1803'>
           heso_cup,ierr2,kbmax,po_cup,cap_max, &amp;<a name='1804'>
           itf,jtf,ktf, &amp;<a name='1805'>
           its,ite, jts,jte, kts,kte)<a name='1806'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_4">(cap_max_increment,3,k22x,kbconx,heo_cup, &amp;<a name='1807'>
           heso_cup,ierr3,kbmax,po_cup,cap_max, &amp;<a name='1808'>
           itf,jtf,ktf, &amp;<a name='1809'>
           its,ite, jts,jte, kts,kte)<a name='1810'>
<font color=#447700>!<a name='1811'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='1812'></font>
<font color=#447700>!<a name='1813'></font>
<a name='1814'>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_FORCING_ENS_3D'>cup_forcing_ens_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_FORCING_ENS_3D_1">(closure_n,xland1,aa0,aa1,xaa0_ens,mbdt_ens,dtime,   &amp;<a name='1815'>
           ierr,ierr2,ierr3,xf_ens,j,'deeps',axx,                 &amp;<a name='1816'>
           maxens,iens,iedt,maxens2,maxens3,mconv,            &amp;<a name='1817'>
           po_cup,ktop,omeg,zdo,k22,zuo,pr_ens,edto,kbcon,    &amp;<a name='1818'>
           massflx,iact,direction,ensdim,massfln,ichoice,edt_out,     &amp;<a name='1819'>
           high_resolution,itf,jtf,ktf, &amp;<a name='1820'>
           its,ite, jts,jte, kts,kte,ens4,ktau)<a name='1821'>
<font color=#447700>!<a name='1822'></font>
      do k=kts,ktf<a name='1823'>
      do i=its,itf<a name='1824'>
        if(ierr(i).eq.0)then<a name='1825'>
           subt_ens(i,k,iedt)=dsubt(i,k)<a name='1826'>
           subq_ens(i,k,iedt)=dsubq(i,k)<a name='1827'>
           dellat_ens(i,k,iedt)=dellat(i,k)<a name='1828'>
           dellaq_ens(i,k,iedt)=dellaq(i,k)<a name='1829'>
           dellaqc_ens(i,k,iedt)=dellaqc(i,k)<a name='1830'>
           pwo_ens(i,k,iedt)=pwo(i,k)+edt(i)*pwdo(i,k)<a name='1831'>
        else <a name='1832'>
           subt_ens(i,k,iedt)=0.<a name='1833'>
           subq_ens(i,k,iedt)=0.<a name='1834'>
           dellat_ens(i,k,iedt)=0.<a name='1835'>
           dellaq_ens(i,k,iedt)=0.<a name='1836'>
           dellaqc_ens(i,k,iedt)=0.<a name='1837'>
           pwo_ens(i,k,iedt)=0.<a name='1838'>
        endif<a name='1839'>
<font color=#447700>!       if(i.eq.ipr.and.j.eq.jpr)then<a name='1840'></font>
<font color=#447700>!         write(0,*)'1',iens,iedt,dellat(i,k),dellat_ens(i,k,iedt), &amp;<a name='1841'></font>
<font color=#447700>!           dellaq(i,k), dellaqc(i,k)<a name='1842'></font>
<font color=#447700>!         write(0,*)'2',k,subt_ens(i,k,iedt),subq_ens(i,k,iedt)<a name='1843'></font>
<font color=#447700>!       endif<a name='1844'></font>
      enddo<a name='1845'>
      enddo<a name='1846'>
 250  continue<a name='1847'>
<font color=#447700>!<a name='1848'></font>
<font color=#447700>!--- FEEDBACK<a name='1849'></font>
<font color=#447700>!<a name='1850'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_OUTPUT_ENS_3D'>cup_output_ens_3d</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENSS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_OUTPUT_ENS_3D_1">(xf_ens,ierr,dellat_ens,dellaq_ens, &amp;<a name='1851'>
           dellaqc_ens,subt_ens,subq_ens,subt,subq,outt,     &amp;<a name='1852'>
           outq,outqc,zuo,sub_mas,pre,pwo_ens,xmb,ktop,      &amp;<a name='1853'>
           j,'deep',maxens2,maxens,iens,ierr2,ierr3,         &amp;<a name='1854'>
           pr_ens,maxens3,ensdim,massfln,                    &amp;<a name='1855'>
           APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                &amp;<a name='1856'>
           APR_CAPMA,APR_CAPME,APR_CAPMI,closure_n,xland1,   &amp;<a name='1857'>
           itf,jtf,ktf,                        &amp;<a name='1858'>
           its,ite, jts,jte, kts,kte)<a name='1859'>
      k=1<a name='1860'>
      do i=its,itf<a name='1861'>
          if(ierr(i).eq.0.and.ierr5(i).eq.0.and.kbcon(i).lt.ktop3(i)+1)then<a name='1862'>
<font color=#447700>!            write(0,*)'both ier and ier5=0 at i,j=',i,j,kbcon(i),ktop3(i)<a name='1863'></font>
             if(high_resolution.eq.1)then<a name='1864'>
                outts(i,kts:kte)=0.<a name='1865'>
                outqs(i,kts:kte)=0.<a name='1866'>
             endif<a name='1867'>
          elseif (ierr5(i).eq.0)then<a name='1868'>
<font color=#447700>!            write(0,*)'ier5=0 at i,j=',i,j,k23(i),ktop3(i)<a name='1869'></font>
          endif<a name='1870'>
<a name='1871'>
           PRE(I)=MAX(PRE(I),0.)<a name='1872'>
<font color=#447700>!           if(i.eq.ipr.and.j.eq.jpr)then<a name='1873'></font>
<font color=#447700>!             write(0,*)'i,j,pre(i),aa0(i),aa1(i)'<a name='1874'></font>
<font color=#447700>!             write(0,*)i,j,pre(i),aa0(i)<a name='1875'></font>
<font color=#447700>!           endif<a name='1876'></font>
      enddo<a name='1877'>
<font color=#447700>!<a name='1878'></font>
<font color=#447700>!---------------------------done------------------------------<a name='1879'></font>
<font color=#447700>!<a name='1880'></font>
<font color=#447700>!      do i=its,itf<a name='1881'></font>
<font color=#447700>!        if(ierr(i).eq.0)then<a name='1882'></font>
<font color=#447700>!       if(i.eq.ipr.and.j.eq.jpr)then<a name='1883'></font>
<font color=#447700>!         write(0,*)'on output, pre =',pre(i),its,itf,kts,ktf<a name='1884'></font>
<font color=#447700>!         do k=kts,ktf<a name='1885'></font>
<font color=#447700>!           write(0,*)z(i,k),outt(i,k)*86400.,subt(i,k)*86400.<a name='1886'></font>
<font color=#447700>!         enddo<a name='1887'></font>
<font color=#447700>!         write(0,*)i,j,(axx(i,k),k=1,ens4)<a name='1888'></font>
<font color=#447700>!       endif<a name='1889'></font>
<font color=#447700>!       endif<a name='1890'></font>
<font color=#447700>!      enddo<a name='1891'></font>
<font color=#447700>!     print *,'ierr(i) = ',ierr(i),pre(i)<a name='1892'></font>
<a name='1893'>
   END SUBROUTINE CUP_enss_3d<a name='1894'>
<a name='1895'>
<a name='1896'>
<A NAME='CUP_DD_AA0'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_AA0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1897'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_aa0</font>(edt,ierr,aa0,jmin,gamma_cup,t_cup, &amp;<a name='1898'>
              hcd,hes_cup,z,zd,                             &amp;<a name='1899'>
              itf,jtf,ktf,                    &amp;<a name='1900'>
              its,ite, jts,jte, kts,kte                    )<a name='1901'>
<a name='1902'>
   IMPLICIT NONE<a name='1903'>
<font color=#447700>!<a name='1904'></font>
<font color=#447700>!  on input<a name='1905'></font>
<font color=#447700>!<a name='1906'></font>
<a name='1907'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='1908'></font>
<a name='1909'>
     integer                                                           &amp;<a name='1910'>
        ,intent (in   )                   ::                           &amp;<a name='1911'>
        itf,jtf,ktf,                                     &amp;<a name='1912'>
        its,ite, jts,jte, kts,kte<a name='1913'>
  <font color=#447700>! aa0 cloud work function for downdraft<a name='1914'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='1915'></font>
  <font color=#447700>! t_cup = temperature (Kelvin) on model cloud levels<a name='1916'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='1917'></font>
  <font color=#447700>! hcd = moist static energy in downdraft<a name='1918'></font>
  <font color=#447700>! edt = epsilon<a name='1919'></font>
  <font color=#447700>! zd normalized downdraft mass flux<a name='1920'></font>
  <font color=#447700>! z = heights of model levels <a name='1921'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='1922'></font>
  <font color=#447700>!<a name='1923'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1924'>
        ,intent (in   )                   ::                           &amp;<a name='1925'>
        z,zd,gamma_cup,t_cup,hes_cup,hcd<a name='1926'>
     real,    dimension (its:ite)                                      &amp;<a name='1927'>
        ,intent (in   )                   ::                           &amp;<a name='1928'>
        edt<a name='1929'>
     integer, dimension (its:ite)                                      &amp;<a name='1930'>
        ,intent (in   )                   ::                           &amp;<a name='1931'>
        jmin<a name='1932'>
<font color=#447700>!<a name='1933'></font>
<font color=#447700>! input and output<a name='1934'></font>
<font color=#447700>!<a name='1935'></font>
<a name='1936'>
<a name='1937'>
     integer, dimension (its:ite)                                      &amp;<a name='1938'>
        ,intent (inout)                   ::                           &amp;<a name='1939'>
        ierr<a name='1940'>
     real,    dimension (its:ite)                                      &amp;<a name='1941'>
        ,intent (out  )                   ::                           &amp;<a name='1942'>
        aa0<a name='1943'>
<font color=#447700>!<a name='1944'></font>
<font color=#447700>!  local variables in this routine<a name='1945'></font>
<font color=#447700>!<a name='1946'></font>
<a name='1947'>
     integer                              ::                           &amp;<a name='1948'>
        i,k,kk<a name='1949'>
     real                                 ::                           &amp;<a name='1950'>
        dz<a name='1951'>
<font color=#447700>!<a name='1952'></font>
       do i=its,itf<a name='1953'>
        aa0(i)=0.<a name='1954'>
       enddo<a name='1955'>
<font color=#447700>!<a name='1956'></font>
<font color=#447700>!??    DO k=kts,kte-1<a name='1957'></font>
       DO k=kts,ktf-1<a name='1958'>
       do i=its,itf<a name='1959'>
         IF(ierr(I).eq.0.and.k.lt.jmin(i))then<a name='1960'>
         KK=JMIN(I)-K<a name='1961'>
<font color=#447700>!<a name='1962'></font>
<font color=#447700>!--- ORIGINAL<a name='1963'></font>
<font color=#447700>!<a name='1964'></font>
         DZ=(Z(I,KK)-Z(I,KK+1))<a name='1965'>
         AA0(I)=AA0(I)+zd(i,kk)*EDT(I)*DZ*(9.81/(1004.*T_cup(I,KK))) &amp;<a name='1966'>
            *((hcd(i,kk)-hes_cup(i,kk))/(1.+GAMMA_cup(i,kk)))<a name='1967'>
         endif<a name='1968'>
      enddo<a name='1969'>
      enddo<a name='1970'>
<a name='1971'>
   END SUBROUTINE CUP_dd_aa0<a name='1972'>
<a name='1973'>
<a name='1974'>
<A NAME='CUP_DD_EDT'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_EDT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1975'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_edt</font>(ierr,us,vs,z,ktop,kbcon,edt,p,pwav, &amp; <A href='../../call_to/CUP_DD_EDT.html' TARGET='index'>2</A><a name='1976'>
              pwev,edtmax,edtmin,maxens2,edtc,               &amp;<a name='1977'>
              itf,jtf,ktf,                     &amp;<a name='1978'>
              its,ite, jts,jte, kts,kte                     )<a name='1979'>
<a name='1980'>
   IMPLICIT NONE<a name='1981'>
<a name='1982'>
     integer                                                           &amp;<a name='1983'>
        ,intent (in   )                   ::                           &amp;<a name='1984'>
        itf,jtf,ktf,           &amp;<a name='1985'>
        its,ite, jts,jte, kts,kte<a name='1986'>
     integer, intent (in   )              ::                           &amp;<a name='1987'>
        maxens2<a name='1988'>
  <font color=#447700>!<a name='1989'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='1990'></font>
  <font color=#447700>!<a name='1991'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='1992'>
        ,intent (in   )                   ::                           &amp;<a name='1993'>
        us,vs,z,p<a name='1994'>
     real,    dimension (its:ite,1:maxens2)                            &amp;<a name='1995'>
        ,intent (out  )                   ::                           &amp;<a name='1996'>
        edtc<a name='1997'>
     real,    dimension (its:ite)                                      &amp;<a name='1998'>
        ,intent (out  )                   ::                           &amp;<a name='1999'>
        edt<a name='2000'>
     real,    dimension (its:ite)                                      &amp;<a name='2001'>
        ,intent (in   )                   ::                           &amp;<a name='2002'>
        pwav,pwev<a name='2003'>
     real                                                              &amp;<a name='2004'>
        ,intent (in   )                   ::                           &amp;<a name='2005'>
        edtmax,edtmin<a name='2006'>
     integer, dimension (its:ite)                                      &amp;<a name='2007'>
        ,intent (in   )                   ::                           &amp;<a name='2008'>
        ktop,kbcon<a name='2009'>
     integer, dimension (its:ite)                                      &amp;<a name='2010'>
        ,intent (inout)                   ::                           &amp;<a name='2011'>
        ierr<a name='2012'>
<font color=#447700>!<a name='2013'></font>
<font color=#447700>!  local variables in this routine<a name='2014'></font>
<font color=#447700>!<a name='2015'></font>
<a name='2016'>
     integer i,k,kk<a name='2017'>
     real    einc,pef,pefb,prezk,zkbc<a name='2018'>
     real,    dimension (its:ite)         ::                           &amp;<a name='2019'>
      vshear,sdp,vws<a name='2020'>
<a name='2021'>
<font color=#447700>!<a name='2022'></font>
<font color=#447700>!--- DETERMINE DOWNDRAFT STRENGTH IN TERMS OF WINDSHEAR<a name='2023'></font>
<font color=#447700>!<a name='2024'></font>
<font color=#447700>! */ calculate an average wind shear over the depth of the cloud<a name='2025'></font>
<font color=#447700>!<a name='2026'></font>
       do i=its,itf<a name='2027'>
        edt(i)=0.<a name='2028'>
        vws(i)=0.<a name='2029'>
        sdp(i)=0.<a name='2030'>
        vshear(i)=0.<a name='2031'>
       enddo<a name='2032'>
       do k=1,maxens2<a name='2033'>
       do i=its,itf<a name='2034'>
        edtc(i,k)=0.<a name='2035'>
       enddo<a name='2036'>
       enddo<a name='2037'>
       do kk = kts,ktf-1<a name='2038'>
         do 62 i=its,itf<a name='2039'>
          IF(ierr(i).ne.0)GO TO 62<a name='2040'>
          if (kk .le. min0(ktop(i),ktf) .and. kk .ge. kbcon(i)) then<a name='2041'>
             vws(i) = vws(i)+ &amp;<a name='2042'>
              (abs((us(i,kk+1)-us(i,kk))/(z(i,kk+1)-z(i,kk))) &amp;<a name='2043'>
          +   abs((vs(i,kk+1)-vs(i,kk))/(z(i,kk+1)-z(i,kk)))) * &amp;<a name='2044'>
              (p(i,kk) - p(i,kk+1))<a name='2045'>
            sdp(i) = sdp(i) + p(i,kk) - p(i,kk+1)<a name='2046'>
          endif<a name='2047'>
          if (kk .eq. ktf-1)vshear(i) = 1.e3 * vws(i) / sdp(i)<a name='2048'>
   62   continue<a name='2049'>
       end do<a name='2050'>
      do i=its,itf<a name='2051'>
         IF(ierr(i).eq.0)then<a name='2052'>
            pef=(1.591-.639*VSHEAR(I)+.0953*(VSHEAR(I)**2) &amp;<a name='2053'>
               -.00496*(VSHEAR(I)**3))<a name='2054'>
            if(pef.gt.1.)pef=1.<a name='2055'>
            if(pef.lt.0.)pef=0.<a name='2056'>
<font color=#447700>!<a name='2057'></font>
<font color=#447700>!--- cloud base precip efficiency<a name='2058'></font>
<font color=#447700>!<a name='2059'></font>
            zkbc=z(i,kbcon(i))*3.281e-3<a name='2060'>
            prezk=.02<a name='2061'>
            if(zkbc.gt.3.)then<a name='2062'>
               prezk=.96729352+zkbc*(-.70034167+zkbc*(.162179896+zkbc &amp;<a name='2063'>
               *(- 1.2569798E-2+zkbc*(4.2772E-4-zkbc*5.44E-6))))<a name='2064'>
            endif<a name='2065'>
            if(zkbc.gt.25)then<a name='2066'>
               prezk=2.4<a name='2067'>
            endif<a name='2068'>
            pefb=1./(1.+prezk)<a name='2069'>
            if(pefb.gt.1.)pefb=1.<a name='2070'>
            if(pefb.lt.0.)pefb=0.<a name='2071'>
            EDT(I)=1.-.5*(pefb+pef)<a name='2072'>
<font color=#447700>!--- edt here is 1-precipeff!<a name='2073'></font>
            einc=.2*edt(i)<a name='2074'>
            do k=1,maxens2<a name='2075'>
                edtc(i,k)=edt(i)+float(k-2)*einc<a name='2076'>
            enddo<a name='2077'>
         endif<a name='2078'>
      enddo<a name='2079'>
      do i=its,itf<a name='2080'>
         IF(ierr(i).eq.0)then<a name='2081'>
            do k=1,maxens2<a name='2082'>
               EDTC(I,K)=-EDTC(I,K)*PWAV(I)/PWEV(I)<a name='2083'>
               IF(EDTC(I,K).GT.edtmax)EDTC(I,K)=edtmax<a name='2084'>
               IF(EDTC(I,K).LT.edtmin)EDTC(I,K)=edtmin<a name='2085'>
            enddo<a name='2086'>
         endif<a name='2087'>
      enddo<a name='2088'>
<a name='2089'>
   END SUBROUTINE cup_dd_edt<a name='2090'>
<a name='2091'>
<a name='2092'>
<A NAME='CUP_DD_HE'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_HE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2093'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_he</font>(hes_cup,zd,hcd,z_cup,cdd,entr,       &amp; <A href='../../call_to/CUP_DD_HE.html' TARGET='index'>3</A><a name='2094'>
              jmin,ierr,he,dby,he_cup,                       &amp;<a name='2095'>
              itf,jtf,ktf,                     &amp;<a name='2096'>
              its,ite, jts,jte, kts,kte                     )<a name='2097'>
<a name='2098'>
   IMPLICIT NONE<a name='2099'>
<font color=#447700>!<a name='2100'></font>
<font color=#447700>!  on input<a name='2101'></font>
<font color=#447700>!<a name='2102'></font>
<a name='2103'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='2104'></font>
<a name='2105'>
     integer                                                           &amp;<a name='2106'>
        ,intent (in   )                   ::                           &amp;<a name='2107'>
                                  itf,jtf,ktf,           &amp;<a name='2108'>
                                  its,ite, jts,jte, kts,kte<a name='2109'>
  <font color=#447700>! hcd = downdraft moist static energy<a name='2110'></font>
  <font color=#447700>! he = moist static energy on model levels<a name='2111'></font>
  <font color=#447700>! he_cup = moist static energy on model cloud levels<a name='2112'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='2113'></font>
  <font color=#447700>! dby = buoancy term<a name='2114'></font>
  <font color=#447700>! cdd= detrainment function <a name='2115'></font>
  <font color=#447700>! z_cup = heights of model cloud levels <a name='2116'></font>
  <font color=#447700>! entr = entrainment rate<a name='2117'></font>
  <font color=#447700>! zd   = downdraft normalized mass flux<a name='2118'></font>
  <font color=#447700>!<a name='2119'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2120'>
        ,intent (in   )                   ::                           &amp;<a name='2121'>
        he,he_cup,hes_cup,z_cup,cdd,zd<a name='2122'>
  <font color=#447700>! entr= entrainment rate <a name='2123'></font>
     real                                                              &amp;<a name='2124'>
        ,intent (in   )                   ::                           &amp;<a name='2125'>
        entr<a name='2126'>
     integer, dimension (its:ite)                                      &amp;<a name='2127'>
        ,intent (in   )                   ::                           &amp;<a name='2128'>
        jmin<a name='2129'>
<font color=#447700>!<a name='2130'></font>
<font color=#447700>! input and output<a name='2131'></font>
<font color=#447700>!<a name='2132'></font>
<a name='2133'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='2134'></font>
<a name='2135'>
     integer, dimension (its:ite)                                      &amp;<a name='2136'>
        ,intent (inout)                   ::                           &amp;<a name='2137'>
        ierr<a name='2138'>
<a name='2139'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2140'>
        ,intent (out  )                   ::                           &amp;<a name='2141'>
        hcd,dby<a name='2142'>
<font color=#447700>!<a name='2143'></font>
<font color=#447700>!  local variables in this routine<a name='2144'></font>
<font color=#447700>!<a name='2145'></font>
<a name='2146'>
     integer                              ::                           &amp;<a name='2147'>
        i,k,ki<a name='2148'>
     real                                 ::                           &amp;<a name='2149'>
        dz<a name='2150'>
<a name='2151'>
<a name='2152'>
      do k=kts+1,ktf<a name='2153'>
      do i=its,itf<a name='2154'>
      dby(i,k)=0.<a name='2155'>
      IF(ierr(I).eq.0)then<a name='2156'>
         hcd(i,k)=hes_cup(i,k)<a name='2157'>
      endif<a name='2158'>
      enddo<a name='2159'>
      enddo<a name='2160'>
<font color=#447700>!<a name='2161'></font>
      do 100 i=its,itf<a name='2162'>
      IF(ierr(I).eq.0)then<a name='2163'>
      k=jmin(i)<a name='2164'>
      hcd(i,k)=hes_cup(i,k)<a name='2165'>
      dby(i,k)=hcd(i,jmin(i))-hes_cup(i,k)<a name='2166'>
<font color=#447700>!<a name='2167'></font>
      do ki=jmin(i)-1,1,-1<a name='2168'>
         DZ=Z_cup(i,Ki+1)-Z_cup(i,Ki)<a name='2169'>
         HCD(i,Ki)=(HCD(i,Ki+1)*(1.-.5*CDD(i,Ki)*DZ) &amp;<a name='2170'>
                  +entr*DZ*HE(i,Ki) &amp;<a name='2171'>
                  )/(1.+entr*DZ-.5*CDD(i,Ki)*DZ)<a name='2172'>
         dby(i,ki)=HCD(i,Ki)-hes_cup(i,ki)<a name='2173'>
      enddo<a name='2174'>
<font color=#447700>!<a name='2175'></font>
      endif<a name='2176'>
<font color=#447700>!--- end loop over i<a name='2177'></font>
100    continue<a name='2178'>
<a name='2179'>
<a name='2180'>
   END SUBROUTINE cup_dd_he<a name='2181'>
<a name='2182'>
<a name='2183'>
<A NAME='CUP_DD_MOISTURE_3D'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_MOISTURE_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2184'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_moisture_3d</font>(zd,hcd,hes_cup,qcd,qes_cup,    &amp; <A href='../../call_to/CUP_DD_MOISTURE_3D.html' TARGET='index'>3</A><a name='2185'>
              pwd,q_cup,z_cup,cdd,entr,jmin,ierr,            &amp;<a name='2186'>
              gamma_cup,pwev,bu,qrcd,                        &amp;<a name='2187'>
              q,he,t_cup,iloop,xl,high_resolution,           &amp;<a name='2188'>
              itf,jtf,ktf,                     &amp;<a name='2189'>
              its,ite, jts,jte, kts,kte                     )<a name='2190'>
<a name='2191'>
   IMPLICIT NONE<a name='2192'>
<a name='2193'>
     integer                                                           &amp;<a name='2194'>
        ,intent (in   )                   ::                           &amp;<a name='2195'>
                                  itf,jtf,ktf,           &amp;<a name='2196'>
                                  its,ite, jts,jte, kts,kte,high_resolution<a name='2197'>
  <font color=#447700>! cdd= detrainment function <a name='2198'></font>
  <font color=#447700>! q = environmental q on model levels<a name='2199'></font>
  <font color=#447700>! q_cup = environmental q on model cloud levels<a name='2200'></font>
  <font color=#447700>! qes_cup = saturation q on model cloud levels<a name='2201'></font>
  <font color=#447700>! hes_cup = saturation h on model cloud levels<a name='2202'></font>
  <font color=#447700>! hcd = h in model cloud<a name='2203'></font>
  <font color=#447700>! bu = buoancy term<a name='2204'></font>
  <font color=#447700>! zd = normalized downdraft mass flux<a name='2205'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='2206'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='2207'></font>
  <font color=#447700>! qcd = cloud q (including liquid water) after entrainment<a name='2208'></font>
  <font color=#447700>! qrch = saturation q in cloud<a name='2209'></font>
  <font color=#447700>! pwd = evaporate at that level<a name='2210'></font>
  <font color=#447700>! pwev = total normalized integrated evaoprate (I2)<a name='2211'></font>
  <font color=#447700>! entr= entrainment rate <a name='2212'></font>
  <font color=#447700>!<a name='2213'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2214'>
        ,intent (in   )                   ::                           &amp;<a name='2215'>
        zd,t_cup,hes_cup,hcd,qes_cup,q_cup,z_cup,cdd,gamma_cup,q,he <a name='2216'>
     real                                                              &amp;<a name='2217'>
        ,intent (in   )                   ::                           &amp;<a name='2218'>
        entr,xl<a name='2219'>
     integer                                                           &amp;<a name='2220'>
        ,intent (in   )                   ::                           &amp;<a name='2221'>
        iloop<a name='2222'>
     integer, dimension (its:ite)                                      &amp;<a name='2223'>
        ,intent (in   )                   ::                           &amp;<a name='2224'>
        jmin<a name='2225'>
     integer, dimension (its:ite)                                      &amp;<a name='2226'>
        ,intent (inout)                   ::                           &amp;<a name='2227'>
        ierr<a name='2228'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2229'>
        ,intent (out  )                   ::                           &amp;<a name='2230'>
        qcd,qrcd,pwd<a name='2231'>
     real,    dimension (its:ite)                                      &amp;<a name='2232'>
        ,intent (out  )                   ::                           &amp;<a name='2233'>
        pwev,bu<a name='2234'>
<font color=#447700>!<a name='2235'></font>
<font color=#447700>!  local variables in this routine<a name='2236'></font>
<font color=#447700>!<a name='2237'></font>
<a name='2238'>
     integer                              ::                           &amp;<a name='2239'>
        i,k,ki<a name='2240'>
     real                                 ::                           &amp;<a name='2241'>
        dh,dz,dqeva<a name='2242'>
<a name='2243'>
      do i=its,itf<a name='2244'>
         bu(i)=0.<a name='2245'>
         pwev(i)=0.<a name='2246'>
      enddo<a name='2247'>
      do k=kts,ktf<a name='2248'>
      do i=its,itf<a name='2249'>
         qcd(i,k)=0.<a name='2250'>
         qrcd(i,k)=0.<a name='2251'>
         pwd(i,k)=0.<a name='2252'>
      enddo<a name='2253'>
      enddo<a name='2254'>
<font color=#447700>!<a name='2255'></font>
<font color=#447700>!<a name='2256'></font>
<font color=#447700>!<a name='2257'></font>
      do 100 i=its,itf<a name='2258'>
      IF(ierr(I).eq.0)then<a name='2259'>
      k=jmin(i)<a name='2260'>
      DZ=Z_cup(i,K+1)-Z_cup(i,K)<a name='2261'>
      qcd(i,k)=q_cup(i,k)<a name='2262'>
      if(high_resolution.eq.1)qcd(i,k)=.5*(qes_cup(i,k)+q_cup(i,k))<a name='2263'>
      qrcd(i,k)=qes_cup(i,k)<a name='2264'>
      pwd(i,jmin(i))=min(0.,qcd(i,k)-qrcd(i,k))<a name='2265'>
      pwev(i)=pwev(i)+pwd(i,jmin(i))<a name='2266'>
      qcd(i,k)=qes_cup(i,k)<a name='2267'>
<font color=#447700>!<a name='2268'></font>
      DH=HCD(I,k)-HES_cup(I,K)<a name='2269'>
      bu(i)=dz*dh<a name='2270'>
      do ki=jmin(i)-1,1,-1<a name='2271'>
         DZ=Z_cup(i,Ki+1)-Z_cup(i,Ki)<a name='2272'>
         QCD(i,Ki)=(qCD(i,Ki+1)*(1.-.5*CDD(i,Ki)*DZ) &amp;<a name='2273'>
                  +entr*DZ*q(i,Ki) &amp;<a name='2274'>
                  )/(1.+entr*DZ-.5*CDD(i,Ki)*DZ)<a name='2275'>
<font color=#447700>!<a name='2276'></font>
<font color=#447700>!--- to be negatively buoyant, hcd should be smaller than hes!<a name='2277'></font>
<font color=#447700>!<a name='2278'></font>
         DH=HCD(I,ki)-HES_cup(I,Ki)<a name='2279'>
         bu(i)=bu(i)+dz*dh<a name='2280'>
         QRCD(I,Ki)=qes_cup(i,ki)+(1./XL)*(GAMMA_cup(i,ki) &amp;<a name='2281'>
                  /(1.+GAMMA_cup(i,ki)))*DH<a name='2282'>
         dqeva=qcd(i,ki)-qrcd(i,ki)<a name='2283'>
         if(dqeva.gt.0.)dqeva=0.<a name='2284'>
         pwd(i,ki)=zd(i,ki)*dqeva<a name='2285'>
         qcd(i,ki)=qrcd(i,ki)<a name='2286'>
         pwev(i)=pwev(i)+pwd(i,ki)<a name='2287'>
<font color=#447700>!        if(iloop.eq.1.and.i.eq.102.and.j.eq.62)then<a name='2288'></font>
<font color=#447700>!         print *,'in cup_dd_moi ', hcd(i,ki),HES_cup(I,Ki),dh,dqeva<a name='2289'></font>
<font color=#447700>!        endif<a name='2290'></font>
      enddo<a name='2291'>
<font color=#447700>!<a name='2292'></font>
<font color=#447700>!--- end loop over i<a name='2293'></font>
       if(pwev(I).eq.0.and.iloop.eq.1)then<a name='2294'>
<font color=#447700>!        print *,'problem with buoy in cup_dd_moisture',i<a name='2295'></font>
         ierr(i)=7<a name='2296'>
       endif<a name='2297'>
       if(BU(I).GE.0.and.iloop.eq.1)then<a name='2298'>
<font color=#447700>!        print *,'problem with buoy in cup_dd_moisture',i<a name='2299'></font>
         ierr(i)=7<a name='2300'>
       endif<a name='2301'>
      endif<a name='2302'>
100    continue<a name='2303'>
<a name='2304'>
   END SUBROUTINE cup_dd_moisture_3d<a name='2305'>
<a name='2306'>
<a name='2307'>
<A NAME='CUP_DD_NMS'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_DD_NMS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2308'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dd_nms</font>(zd,z_cup,cdd,entr,jmin,ierr,        &amp; <A href='../../call_to/CUP_DD_NMS.html' TARGET='index'>3</A><a name='2309'>
              itest,kdet,z1,                                 &amp;<a name='2310'>
              itf,jtf,ktf,                     &amp;<a name='2311'>
              its,ite, jts,jte, kts,kte                     )<a name='2312'>
<a name='2313'>
   IMPLICIT NONE<a name='2314'>
<font color=#447700>!<a name='2315'></font>
<font color=#447700>!  on input<a name='2316'></font>
<font color=#447700>!<a name='2317'></font>
<a name='2318'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='2319'></font>
<a name='2320'>
     integer                                                           &amp;<a name='2321'>
        ,intent (in   )                   ::                           &amp;<a name='2322'>
                                  itf,jtf,ktf,           &amp;<a name='2323'>
                                  its,ite, jts,jte, kts,kte<a name='2324'>
  <font color=#447700>! z_cup = height of cloud model level<a name='2325'></font>
  <font color=#447700>! z1 = terrain elevation<a name='2326'></font>
  <font color=#447700>! entr = downdraft entrainment rate<a name='2327'></font>
  <font color=#447700>! jmin = downdraft originating level<a name='2328'></font>
  <font color=#447700>! kdet = level above ground where downdraft start detraining<a name='2329'></font>
  <font color=#447700>! itest = flag to whether to calculate cdd<a name='2330'></font>
  <a name='2331'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2332'>
        ,intent (in   )                   ::                           &amp;<a name='2333'>
        z_cup<a name='2334'>
     real,    dimension (its:ite)                                      &amp;<a name='2335'>
        ,intent (in   )                   ::                           &amp;<a name='2336'>
        z1 <a name='2337'>
     real                                                              &amp;<a name='2338'>
        ,intent (in   )                   ::                           &amp;<a name='2339'>
        entr <a name='2340'>
     integer, dimension (its:ite)                                      &amp;<a name='2341'>
        ,intent (in   )                   ::                           &amp;<a name='2342'>
        jmin,kdet<a name='2343'>
     integer                                                           &amp;<a name='2344'>
        ,intent (in   )                   ::                           &amp;<a name='2345'>
        itest<a name='2346'>
<font color=#447700>!<a name='2347'></font>
<font color=#447700>! input and output<a name='2348'></font>
<font color=#447700>!<a name='2349'></font>
<a name='2350'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='2351'></font>
<a name='2352'>
     integer, dimension (its:ite)                                      &amp;<a name='2353'>
        ,intent (inout)                   ::                           &amp;<a name='2354'>
                                                                 ierr<a name='2355'>
   <font color=#447700>! zd is the normalized downdraft mass flux<a name='2356'></font>
   <font color=#447700>! cdd is the downdraft detrainmen function<a name='2357'></font>
<a name='2358'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2359'>
        ,intent (out  )                   ::                           &amp;<a name='2360'>
                                                             zd<a name='2361'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2362'>
        ,intent (inout)                   ::                           &amp;<a name='2363'>
                                                             cdd<a name='2364'>
<font color=#447700>!<a name='2365'></font>
<font color=#447700>!  local variables in this routine<a name='2366'></font>
<font color=#447700>!<a name='2367'></font>
<a name='2368'>
     integer                              ::                           &amp;<a name='2369'>
                                                  i,k,ki<a name='2370'>
     real                                 ::                           &amp;<a name='2371'>
                                            a,perc,dz<a name='2372'>
<a name='2373'>
<font color=#447700>!<a name='2374'></font>
<font color=#447700>!--- perc is the percentage of mass left when hitting the ground<a name='2375'></font>
<font color=#447700>!<a name='2376'></font>
      perc=.03<a name='2377'>
<a name='2378'>
      do k=kts,ktf<a name='2379'>
      do i=its,itf<a name='2380'>
         zd(i,k)=0.<a name='2381'>
         if(itest.eq.0)cdd(i,k)=0.<a name='2382'>
      enddo<a name='2383'>
      enddo<a name='2384'>
      a=1.-perc<a name='2385'>
<font color=#447700>!<a name='2386'></font>
<font color=#447700>!<a name='2387'></font>
<font color=#447700>!<a name='2388'></font>
      do 100 i=its,itf<a name='2389'>
      IF(ierr(I).eq.0)then<a name='2390'>
      zd(i,jmin(i))=1.<a name='2391'>
<font color=#447700>!<a name='2392'></font>
<font color=#447700>!--- integrate downward, specify detrainment(cdd)!<a name='2393'></font>
<font color=#447700>!<a name='2394'></font>
      do ki=jmin(i)-1,1,-1<a name='2395'>
         DZ=Z_cup(i,Ki+1)-Z_cup(i,Ki)<a name='2396'>
         if(ki.le.kdet(i).and.itest.eq.0)then<a name='2397'>
           cdd(i,ki)=entr+(1.- (a*(z_cup(i,ki)-z1(i)) &amp;<a name='2398'>
                     +perc*(z_cup(i,kdet(i))-z1(i)) ) &amp;<a name='2399'>
                         /(a*(z_cup(i,ki+1)-z1(i)) &amp;<a name='2400'>
                      +perc*(z_cup(i,kdet(i))-z1(i))))/dz<a name='2401'>
         endif<a name='2402'>
         zd(i,ki)=zd(i,ki+1)*(1.+(entr-cdd(i,ki))*dz)<a name='2403'>
      enddo<a name='2404'>
<font color=#447700>!<a name='2405'></font>
      endif<a name='2406'>
<font color=#447700>!--- end loop over i<a name='2407'></font>
100    continue<a name='2408'>
<a name='2409'>
   END SUBROUTINE cup_dd_nms<a name='2410'>
<a name='2411'>
<a name='2412'>
<A NAME='CUP_DELLABOT'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_DELLABOT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2413'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dellabot</font>(name,ipr,jpr,he_cup,ierr,z_cup,p_cup,  &amp; <A href='../../call_to/CUP_DELLABOT.html' TARGET='index'>2</A><a name='2414'>
              hcd,edt,zd,cdd,he,della,subs,j,mentrd_rate,z,g,     &amp;<a name='2415'>
              itf,jtf,ktf,                     &amp;<a name='2416'>
              its,ite, jts,jte, kts,kte                     )<a name='2417'>
<a name='2418'>
   IMPLICIT NONE<a name='2419'>
<a name='2420'>
     integer                                                           &amp;<a name='2421'>
        ,intent (in   )                   ::                           &amp;<a name='2422'>
        itf,jtf,ktf,           &amp;<a name='2423'>
        its,ite, jts,jte, kts,kte<a name='2424'>
     integer, intent (in   )              ::                           &amp;<a name='2425'>
        j,ipr,jpr<a name='2426'>
      character *(*), intent (in)        ::                           &amp;<a name='2427'>
       name<a name='2428'>
  <font color=#447700>!<a name='2429'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2430'></font>
  <font color=#447700>!<a name='2431'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2432'>
        ,intent (out  )                   ::                           &amp;<a name='2433'>
        della,subs<a name='2434'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2435'>
        ,intent (in  )                   ::                           &amp;<a name='2436'>
        z_cup,p_cup,hcd,zd,cdd,he,z,he_cup<a name='2437'>
     real,    dimension (its:ite)                                      &amp;<a name='2438'>
        ,intent (in   )                   ::                           &amp;<a name='2439'>
        edt<a name='2440'>
     real                                                              &amp;<a name='2441'>
        ,intent (in   )                   ::                           &amp;<a name='2442'>
        g,mentrd_rate<a name='2443'>
     integer, dimension (its:ite)                                      &amp;<a name='2444'>
        ,intent (inout)                   ::                           &amp;<a name='2445'>
        ierr<a name='2446'>
<font color=#447700>!<a name='2447'></font>
<font color=#447700>!  local variables in this routine<a name='2448'></font>
<font color=#447700>!<a name='2449'></font>
<a name='2450'>
      integer i<a name='2451'>
      real detdo,detdo1,detdo2,entdo,dp,dz,subin,                      &amp;<a name='2452'>
      totmas<a name='2453'>
<font color=#447700>!<a name='2454'></font>
<font color=#447700>!<a name='2455'></font>
<font color=#447700>!     if(name.eq.'shallow')then<a name='2456'></font>
<font color=#447700>!        edt(:)=0.<a name='2457'></font>
<font color=#447700>!        cdd(:,:)=0.<a name='2458'></font>
<font color=#447700>!     endif<a name='2459'></font>
      do 100 i=its,itf<a name='2460'>
      della(i,1)=0.<a name='2461'>
      subs(i,1)=0.<a name='2462'>
      if(ierr(i).ne.0)go to 100<a name='2463'>
      dz=z_cup(i,2)-z_cup(i,1)<a name='2464'>
      DP=100.*(p_cup(i,1)-P_cup(i,2))<a name='2465'>
      detdo1=edt(i)*zd(i,2)*CDD(i,1)*DZ<a name='2466'>
      detdo2=edt(i)*zd(i,1)<a name='2467'>
      entdo=edt(i)*zd(i,2)*mentrd_rate*dz<a name='2468'>
      subin=-EDT(I)*zd(i,2)<a name='2469'>
      detdo=detdo1+detdo2-entdo+subin<a name='2470'>
      DELLA(I,1)=(detdo1*.5*(HCD(i,1)+HCD(i,2)) &amp;<a name='2471'>
                 +detdo2*hcd(i,1) &amp;<a name='2472'>
                 +subin*he_cup(i,2) &amp;<a name='2473'>
                 -entdo*he(i,1))*g/dp<a name='2474'>
      SUBS(I,1)=0.<a name='2475'>
<font color=#447700>!      if(i.eq.ipr.and.j.eq.jpr)then<a name='2476'></font>
<font color=#447700>!       write(0,*)'db1',della(i,1),subs(i,1),subin,entdo<a name='2477'></font>
<font color=#447700>!       write(0,*)'db2',detdo1,detdo2,detdo1+detdo2-entdo+subin<a name='2478'></font>
<font color=#447700>!      endif<a name='2479'></font>
 100  CONTINUE<a name='2480'>
<a name='2481'>
   END SUBROUTINE cup_dellabot<a name='2482'>
<a name='2483'>
<a name='2484'>
<A NAME='CUP_DELLAS_3D'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_DELLAS_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2485'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_dellas_3d</font>(ierr,z_cup,p_cup,hcd,edt,zd,cdd,              &amp; <A href='../../call_to/CUP_DELLAS_3D.html' TARGET='index'>4</A><a name='2486'>
              he,della,subs,j,mentrd_rate,zu,g,                             &amp;<a name='2487'>
              cd,hc,ktop,k22,kbcon,mentr_rate,jmin,he_cup,kdet,kpbl,   &amp;<a name='2488'>
              ipr,jpr,name,high_res,                                            &amp;<a name='2489'>
              itf,jtf,ktf,                               &amp;<a name='2490'>
              its,ite, jts,jte, kts,kte                               )<a name='2491'>
<a name='2492'>
   IMPLICIT NONE<a name='2493'>
<a name='2494'>
     integer                                                           &amp;<a name='2495'>
        ,intent (in   )                   ::                           &amp;<a name='2496'>
        itf,jtf,ktf,           &amp;<a name='2497'>
        its,ite, jts,jte, kts,kte<a name='2498'>
     integer, intent (in   )              ::                           &amp;<a name='2499'>
        j,ipr,jpr,high_res<a name='2500'>
  <font color=#447700>!<a name='2501'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2502'></font>
  <font color=#447700>!<a name='2503'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2504'>
        ,intent (out  )                   ::                           &amp;<a name='2505'>
        della,subs<a name='2506'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2507'>
        ,intent (in  )                   ::                           &amp;<a name='2508'>
        z_cup,p_cup,hcd,zd,cdd,he,hc,cd,zu,he_cup<a name='2509'>
     real,    dimension (its:ite)                                      &amp;<a name='2510'>
        ,intent (in   )                   ::                           &amp;<a name='2511'>
        edt<a name='2512'>
     real                                                              &amp;<a name='2513'>
        ,intent (in   )                   ::                           &amp;<a name='2514'>
        g,mentrd_rate,mentr_rate<a name='2515'>
     integer, dimension (its:ite)                                      &amp;<a name='2516'>
        ,intent (in   )                   ::                           &amp;<a name='2517'>
        kbcon,ktop,k22,jmin,kdet,kpbl<a name='2518'>
     integer, dimension (its:ite)                                      &amp;<a name='2519'>
        ,intent (inout)                   ::                           &amp;<a name='2520'>
        ierr<a name='2521'>
      character *(*), intent (in)        ::                           &amp;<a name='2522'>
       name<a name='2523'>
<font color=#447700>!<a name='2524'></font>
<font color=#447700>!  local variables in this routine<a name='2525'></font>
<font color=#447700>!<a name='2526'></font>
<a name='2527'>
      integer i,k,kstart<a name='2528'>
      real detdo1,detdo2,entdo,dp,dz,subin,detdo,entup,                &amp;<a name='2529'>
      detup,subdown,entdoj,entupk,detupk,totmas<a name='2530'>
<font color=#447700>!<a name='2531'></font>
      i=ipr<a name='2532'>
      kstart=kts+1<a name='2533'>
      if(name.eq.'shallow')kstart=kts<a name='2534'>
       DO K=kstart,ktf<a name='2535'>
       do i=its,itf<a name='2536'>
          della(i,k)=0.<a name='2537'>
          subs(i,k)=0.<a name='2538'>
       enddo<a name='2539'>
       enddo<a name='2540'>
<font color=#447700>!<a name='2541'></font>
<font color=#447700>! no downdrafts for shallow convection<a name='2542'></font>
<font color=#447700>!<a name='2543'></font>
       DO 100 k=kts+1,ktf-1<a name='2544'>
       DO 100 i=its,ite<a name='2545'>
         IF(ierr(i).ne.0)GO TO 100<a name='2546'>
         IF(K.Gt.KTOP(I))GO TO 100<a name='2547'>
         if(k.lt.k22(i)-1.and.name.eq.'shallow')GO TO 100<a name='2548'>
<font color=#447700>!<a name='2549'></font>
<font color=#447700>!--- SPECIFY DETRAINMENT OF DOWNDRAFT, HAS TO BE CONSISTENT<a name='2550'></font>
<font color=#447700>!--- WITH ZD CALCULATIONS IN SOUNDD.<a name='2551'></font>
<font color=#447700>!<a name='2552'></font>
         DZ=Z_cup(I,K+1)-Z_cup(I,K)<a name='2553'>
         detdo=edt(i)*CDD(i,K)*DZ*ZD(i,k+1)<a name='2554'>
         entdo=edt(i)*mentrd_rate*dz*zd(i,k+1)<a name='2555'>
<font color=#447700>!3d        subin=zu(i,k+1)-zd(i,k+1)*edt(i)<a name='2556'></font>
         subin=-zd(i,k+1)*edt(i)<a name='2557'>
         entup=0.<a name='2558'>
         detup=0.<a name='2559'>
         if(k.ge.kbcon(i).and.k.lt.ktop(i))then<a name='2560'>
            entup=mentr_rate*dz*zu(i,k)<a name='2561'>
            detup=CD(i,K+1)*DZ*ZU(i,k)<a name='2562'>
         endif<a name='2563'>
<font color=#447700>!3d        subdown=(zu(i,k)-zd(i,k)*edt(i))<a name='2564'></font>
         subdown=-zd(i,k)*edt(i)<a name='2565'>
         entdoj=0.<a name='2566'>
         entupk=0.<a name='2567'>
         detupk=0.<a name='2568'>
<font color=#447700>!<a name='2569'></font>
         if(k.eq.jmin(i))then<a name='2570'>
         entdoj=edt(i)*zd(i,k)<a name='2571'>
         endif<a name='2572'>
<a name='2573'>
         if(k.eq.k22(i)-1)then<a name='2574'>
         entupk=zu(i,kpbl(i))<a name='2575'>
         subin=zu(i,k+1)-zd(i,k+1)*edt(i)<a name='2576'>
         if(high_res.eq.1)subin=-zd(i,k+1)*edt(i)<a name='2577'>
<font color=#447700>!        subin=-zd(i,k+1)*edt(i)<a name='2578'></font>
         endif<a name='2579'>
<a name='2580'>
         if(k.gt.kdet(i))then<a name='2581'>
            detdo=0.<a name='2582'>
         endif<a name='2583'>
<a name='2584'>
         if(k.eq.ktop(i)-0)then<a name='2585'>
         detupk=zu(i,ktop(i))<a name='2586'>
         subin=0.<a name='2587'>
<font color=#447700>!<a name='2588'></font>
<font color=#447700>! this subsidene for ktop now in subs term!<a name='2589'></font>
<font color=#447700>!        subdown=zu(i,k)<a name='2590'></font>
         subdown=0.<a name='2591'>
         endif<a name='2592'>
         if(k.lt.kbcon(i))then<a name='2593'>
            detup=0.<a name='2594'>
         endif<a name='2595'>
<font color=#447700>!C<a name='2596'></font>
<font color=#447700>!C--- CHANGED DUE TO SUBSIDENCE AND ENTRAINMENT<a name='2597'></font>
<font color=#447700>!C<a name='2598'></font>
         totmas=subin-subdown+detup-entup-entdo+ &amp;<a name='2599'>
                 detdo-entupk-entdoj+detupk<a name='2600'>
<font color=#447700>!         if(j.eq.jpr.and.i.eq.ipr)print *,'k,totmas,sui,sud = ',k,<a name='2601'></font>
<font color=#447700>!     1   totmas,subin,subdown<a name='2602'></font>
<font color=#447700>!         if(j.eq.jpr.and.i.eq.ipr)print *,'updr stuff = ',detup,<a name='2603'></font>
<font color=#447700>!     1      entup,entupk,detupk<a name='2604'></font>
<font color=#447700>!         if(j.eq.jpr.and.i.eq.ipr)print *,'dddr stuff = ',entdo,<a name='2605'></font>
<font color=#447700>!     1      detdo,entdoj<a name='2606'></font>
         if(abs(totmas).gt.1.e-6)then<a name='2607'>
<font color=#447700>!           print *,'*********************',i,j,k,totmas,name<a name='2608'></font>
<font color=#447700>!           print *,kpbl(i),k22(i),kbcon(i),ktop(i)<a name='2609'></font>
<font color=#447700>!c          print *,'updr stuff = ',subin,<a name='2610'></font>
<font color=#447700>!c    1      subdown,detup,entup,entupk,detupk<a name='2611'></font>
<font color=#447700>!c          print *,'dddr stuff = ',entdo,<a name='2612'></font>
<font color=#447700>!c    1      detdo,entdoj<a name='2613'></font>
<font color=#447700>!        call wrf_error_fatal ( 'totmas .gt.1.e-6' )<a name='2614'></font>
         endif<a name='2615'>
         dp=100.*(p_cup(i,k-1)-p_cup(i,k))<a name='2616'>
         della(i,k)=(detup*.5*(HC(i,K+1)+HC(i,K)) &amp;<a name='2617'>
                    +detdo*.5*(HCD(i,K+1)+HCD(i,K)) &amp;<a name='2618'>
                    -entup*he(i,k) &amp;<a name='2619'>
                    -entdo*he(i,k) &amp;<a name='2620'>
                    +subin*he_cup(i,k+1) &amp;<a name='2621'>
                    -subdown*he_cup(i,k) &amp;<a name='2622'>
                    +detupk*(hc(i,ktop(i))-he_cup(i,ktop(i)))    &amp;<a name='2623'>
                    -entupk*he_cup(i,k22(i)) &amp;<a name='2624'>
                    -entdoj*he_cup(i,jmin(i)) &amp;<a name='2625'>
                     )*g/dp<a name='2626'>
           if(high_res.eq.1)then<a name='2627'>
<font color=#447700>! the first term includes entr and detr into/from updraft as well as (entup-detup)*he(i,k) from<a name='2628'></font>
<font color=#447700>!  neighbouring point, to make things mass consistent....<a name='2629'></font>
<font color=#447700>!            if(k.ge.k22(i))then<a name='2630'></font>
                della(i,k)=(                          &amp;<a name='2631'>
                    detup*.5*(HC(i,K+1)+HC(i,K))-entup*he(i,k)+(entup-detup)*he(i,k) &amp;<a name='2632'>
                    +detdo*.5*(HCD(i,K+1)+HCD(i,K)) &amp;<a name='2633'>
                    -entdo*he(i,k) &amp;<a name='2634'>
                    +subin*he_cup(i,k+1) &amp;<a name='2635'>
                    -subdown*he_cup(i,k) &amp;<a name='2636'>
                    +detupk*(hc(i,ktop(i))-he(i,ktop(i)))    &amp;<a name='2637'>
                    -entdoj*he_cup(i,jmin(i)) &amp;<a name='2638'>
                    -entupk*he_cup(i,k22(i))+entupk*he(i,k) &amp;<a name='2639'>
                     )*g/dp<a name='2640'>
<font color=#447700>!             else if(k.eq.k22(i)-1)then<a name='2641'></font>
<font color=#447700>!                  della(i,k)=(-entupk*he_cup(i,k22(i))+entupk*he(i,k))*g/dp<a name='2642'></font>
           endif<a name='2643'>
<font color=#447700>!3d        subin=zu(i,k+1)-zd(i,k+1)*edt(i)<a name='2644'></font>
<font color=#447700>!<a name='2645'></font>
<font color=#447700>! updraft subsidence only<a name='2646'></font>
<font color=#447700>!<a name='2647'></font>
         if(k.ge.k22(i).and.k.lt.ktop(i))then<a name='2648'>
         subs(i,k)=(zu(i,k+1)*he_cup(i,k+1) &amp;<a name='2649'>
                    -zu(i,k)*he_cup(i,k))*g/dp<a name='2650'>
<font color=#447700>!        else if(k.eq.ktop(i))then<a name='2651'></font>
<font color=#447700>!        subs(i,k)=-detupk*he_cup(i,k)*g/dp<a name='2652'></font>
         endif<a name='2653'>
<font color=#447700>!<a name='2654'></font>
<font color=#447700>! in igh res case, subsidence terms are for meighbouring points only. This has to be <a name='2655'></font>
<font color=#447700>! done mass consistent with the della term<a name='2656'></font>
         if(high_res.eq.1)then<a name='2657'>
            if(k.ge.k22(i).and.k.lt.ktop(i))then<a name='2658'>
               subs(i,k)=(zu(i,k+1)*he_cup(i,k+1)-zu(i,k)*he_cup(i,k)-(entup-detup)*he(i,k))*g/dp<a name='2659'>
            else if(k.eq.ktop(i))then<a name='2660'>
               subs(i,k)=detupk*(he(i,ktop(i))-he_cup(i,ktop(i)))*g/dp<a name='2661'>
            else if(k.eq.k22(i)-1)then<a name='2662'>
               subs(i,k)=(entupk*he(i,k)-entupk*he_cup(i,k))*g/dp<a name='2663'>
         endif<a name='2664'>
         endif<a name='2665'>
<font color=#447700>!       if(i.eq.ipr.and.j.eq.jpr)then<a name='2666'></font>
<font color=#447700>!         write(0,*)'d',k,della(i,k),subs(i,k),subin,subdown<a name='2667'></font>
<font color=#447700>!!        write(0,*)'d',detup,entup,entdo,entupk,entdoj<a name='2668'></font>
<font color=#447700>!!        print *,k,della(i,k),subin*he_cup(i,k+1),subdown*he_cup(i,k),<a name='2669'></font>
<font color=#447700>!!     1            detdo*.5*(HCD(i,K+1)+HCD(i,K))<a name='2670'></font>
<font color=#447700>!!        print *,k,detup*.5*(HC(i,K+1)+HC(i,K)),detupk*hc(i,ktop(i)),<a name='2671'></font>
<font color=#447700>!!     1         entup*he(i,k),entdo*he(i,k)<a name='2672'></font>
<font color=#447700>!!        print *,k,he_cup(i,k+1),he_cup(i,k),entupk*he_cup(i,k)<a name='2673'></font>
<font color=#447700>!       endif<a name='2674'></font>
<a name='2675'>
 100  CONTINUE<a name='2676'>
<a name='2677'>
   END SUBROUTINE cup_dellas_3d<a name='2678'>
<a name='2679'>
<a name='2680'>
<A NAME='CUP_DIRECTION2'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_DIRECTION2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2681'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_direction2</font>(i,j,dir,id,massflx,             &amp;<a name='2682'>
              iresult,imass,massfld,                         &amp;<a name='2683'>
              itf,jtf,ktf,                     &amp;<a name='2684'>
              its,ite, jts,jte, kts,kte                     )<a name='2685'>
<a name='2686'>
   IMPLICIT NONE<a name='2687'>
<a name='2688'>
     integer                                                           &amp;<a name='2689'>
        ,intent (in   )                   ::                           &amp;<a name='2690'>
        itf,jtf,ktf,           &amp;<a name='2691'>
        its,ite, jts,jte, kts,kte<a name='2692'>
     integer, intent (in   )              ::                           &amp;<a name='2693'>
        i,j,imass<a name='2694'>
     integer, intent (out  )              ::                           &amp;<a name='2695'>
        iresult<a name='2696'>
  <font color=#447700>!<a name='2697'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2698'></font>
  <font color=#447700>!<a name='2699'></font>
     integer,    dimension (its:ite,jts:jte)                           &amp;<a name='2700'>
        ,intent (in   )                   ::                           &amp;<a name='2701'>
        id<a name='2702'>
     real,    dimension (its:ite,jts:jte)                              &amp;<a name='2703'>
        ,intent (in   )                   ::                           &amp;<a name='2704'>
        massflx<a name='2705'>
     real,    dimension (its:ite)                                      &amp;<a name='2706'>
        ,intent (inout)                   ::                           &amp;<a name='2707'>
        dir<a name='2708'>
     real                                                              &amp;<a name='2709'>
        ,intent (out  )                   ::                           &amp;<a name='2710'>
        massfld<a name='2711'>
<font color=#447700>!<a name='2712'></font>
<font color=#447700>!  local variables in this routine<a name='2713'></font>
<font color=#447700>!<a name='2714'></font>
<a name='2715'>
       integer k,ia,ja,ib,jb<a name='2716'>
       real diff<a name='2717'>
<font color=#447700>!<a name='2718'></font>
<font color=#447700>!<a name='2719'></font>
<font color=#447700>!<a name='2720'></font>
       if(imass.eq.1)then<a name='2721'>
           massfld=massflx(i,j)<a name='2722'>
       endif<a name='2723'>
       iresult=0<a name='2724'>
<font color=#447700>!      return<a name='2725'></font>
       diff=22.5<a name='2726'>
       if(dir(i).lt.22.5)dir(i)=360.+dir(i)<a name='2727'>
       if(id(i,j).eq.1)iresult=1<a name='2728'>
<font color=#447700>!      ja=max(2,j-1)<a name='2729'></font>
<font color=#447700>!      ia=max(2,i-1)<a name='2730'></font>
<font color=#447700>!      jb=min(mjx-1,j+1)<a name='2731'></font>
<font color=#447700>!      ib=min(mix-1,i+1)<a name='2732'></font>
       ja=j-1<a name='2733'>
       ia=i-1<a name='2734'>
       jb=j+1<a name='2735'>
       ib=i+1<a name='2736'>
        if(dir(i).gt.90.-diff.and.dir(i).le.90.+diff)then<a name='2737'>
<font color=#447700>!--- steering flow from the east<a name='2738'></font>
          if(id(ib,j).eq.1)then<a name='2739'>
            iresult=1<a name='2740'>
            if(imass.eq.1)then<a name='2741'>
               massfld=max(massflx(ib,j),massflx(i,j))<a name='2742'>
            endif<a name='2743'>
            return<a name='2744'>
          endif<a name='2745'>
        else if(dir(i).gt.135.-diff.and.dir(i).le.135.+diff)then<a name='2746'>
<font color=#447700>!--- steering flow from the south-east<a name='2747'></font>
          if(id(ib,ja).eq.1)then<a name='2748'>
            iresult=1<a name='2749'>
            if(imass.eq.1)then<a name='2750'>
               massfld=max(massflx(ib,ja),massflx(i,j))<a name='2751'>
            endif<a name='2752'>
            return<a name='2753'>
          endif<a name='2754'>
<font color=#447700>!--- steering flow from the south<a name='2755'></font>
        else if(dir(i).gt.180.-diff.and.dir(i).le.180.+diff)then<a name='2756'>
          if(id(i,ja).eq.1)then<a name='2757'>
            iresult=1<a name='2758'>
            if(imass.eq.1)then<a name='2759'>
               massfld=max(massflx(i,ja),massflx(i,j))<a name='2760'>
            endif<a name='2761'>
            return<a name='2762'>
          endif<a name='2763'>
<font color=#447700>!--- steering flow from the south west<a name='2764'></font>
        else if(dir(i).gt.225.-diff.and.dir(i).le.225.+diff)then<a name='2765'>
          if(id(ia,ja).eq.1)then<a name='2766'>
            iresult=1<a name='2767'>
            if(imass.eq.1)then<a name='2768'>
               massfld=max(massflx(ia,ja),massflx(i,j))<a name='2769'>
            endif<a name='2770'>
            return<a name='2771'>
          endif<a name='2772'>
<font color=#447700>!--- steering flow from the west<a name='2773'></font>
        else if(dir(i).gt.270.-diff.and.dir(i).le.270.+diff)then<a name='2774'>
          if(id(ia,j).eq.1)then<a name='2775'>
            iresult=1<a name='2776'>
            if(imass.eq.1)then<a name='2777'>
               massfld=max(massflx(ia,j),massflx(i,j))<a name='2778'>
            endif<a name='2779'>
            return<a name='2780'>
          endif<a name='2781'>
<font color=#447700>!--- steering flow from the north-west<a name='2782'></font>
        else if(dir(i).gt.305.-diff.and.dir(i).le.305.+diff)then<a name='2783'>
          if(id(ia,jb).eq.1)then<a name='2784'>
            iresult=1<a name='2785'>
            if(imass.eq.1)then<a name='2786'>
               massfld=max(massflx(ia,jb),massflx(i,j))<a name='2787'>
            endif<a name='2788'>
            return<a name='2789'>
          endif<a name='2790'>
<font color=#447700>!--- steering flow from the north<a name='2791'></font>
        else if(dir(i).gt.360.-diff.and.dir(i).le.360.+diff)then<a name='2792'>
          if(id(i,jb).eq.1)then<a name='2793'>
            iresult=1<a name='2794'>
            if(imass.eq.1)then<a name='2795'>
               massfld=max(massflx(i,jb),massflx(i,j))<a name='2796'>
            endif<a name='2797'>
            return<a name='2798'>
          endif<a name='2799'>
<font color=#447700>!--- steering flow from the north-east<a name='2800'></font>
        else if(dir(i).gt.45.-diff.and.dir(i).le.45.+diff)then<a name='2801'>
          if(id(ib,jb).eq.1)then<a name='2802'>
            iresult=1<a name='2803'>
            if(imass.eq.1)then<a name='2804'>
               massfld=max(massflx(ib,jb),massflx(i,j))<a name='2805'>
            endif<a name='2806'>
            return<a name='2807'>
          endif<a name='2808'>
        endif<a name='2809'>
<a name='2810'>
   END SUBROUTINE cup_direction2<a name='2811'>
<a name='2812'>
<a name='2813'>
<A NAME='CUP_ENV'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2814'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_env</font>(z,qes,he,hes,t,q,p,z1,                 &amp; <A href='../../call_to/CUP_ENV.html' TARGET='index'>12</A>,<A href='../../call_from/CUP_ENV.html' TARGET='index'>1</A><a name='2815'>
              psur,ierr,tcrit,itest,xl,cp,                   &amp;<a name='2816'>
              itf,jtf,ktf,                     &amp;<a name='2817'>
              its,ite, jts,jte, kts,kte                     )<a name='2818'>
<a name='2819'>
   IMPLICIT NONE<a name='2820'>
<a name='2821'>
     integer                                                           &amp;<a name='2822'>
        ,intent (in   )                   ::                           &amp;<a name='2823'>
        itf,jtf,ktf,           &amp;<a name='2824'>
        its,ite, jts,jte, kts,kte<a name='2825'>
  <font color=#447700>!<a name='2826'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2827'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='2828'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='2829'></font>
  <font color=#447700>! t           = environmental temp<a name='2830'></font>
  <font color=#447700>! tv          = environmental virtual temp<a name='2831'></font>
  <font color=#447700>! p           = environmental pressure<a name='2832'></font>
  <font color=#447700>! z           = environmental heights<a name='2833'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='2834'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='2835'></font>
  <font color=#447700>! psur        = surface pressure<a name='2836'></font>
  <font color=#447700>! z1          = terrain elevation<a name='2837'></font>
  <font color=#447700>! <a name='2838'></font>
  <font color=#447700>!<a name='2839'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2840'>
        ,intent (in   )                   ::                           &amp;<a name='2841'>
        p,t,q<a name='2842'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2843'>
        ,intent (out  )                   ::                           &amp;<a name='2844'>
        he,hes,qes<a name='2845'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2846'>
        ,intent (inout)                   ::                           &amp;<a name='2847'>
        z<a name='2848'>
     real,    dimension (its:ite)                                      &amp;<a name='2849'>
        ,intent (in   )                   ::                           &amp;<a name='2850'>
        psur,z1<a name='2851'>
     real                                                              &amp;<a name='2852'>
        ,intent (in   )                   ::                           &amp;<a name='2853'>
        xl,cp<a name='2854'>
     integer, dimension (its:ite)                                      &amp;<a name='2855'>
        ,intent (inout)                   ::                           &amp;<a name='2856'>
        ierr<a name='2857'>
     integer                                                           &amp;<a name='2858'>
        ,intent (in   )                   ::                           &amp;<a name='2859'>
        itest<a name='2860'>
<font color=#447700>!<a name='2861'></font>
<font color=#447700>!  local variables in this routine<a name='2862'></font>
<font color=#447700>!<a name='2863'></font>
<a name='2864'>
     integer                              ::                           &amp;<a name='2865'>
       i,k,iph<a name='2866'>
      real, dimension (1:2) :: AE,BE,HT<a name='2867'>
      real, dimension (its:ite,kts:kte) :: tv<a name='2868'>
      real :: tcrit,e,tvbar<a name='2869'>
<a name='2870'>
<a name='2871'>
      HT(1)=XL/CP<a name='2872'>
      HT(2)=2.834E6/CP<a name='2873'>
      BE(1)=.622*HT(1)/.286<a name='2874'>
      AE(1)=BE(1)/273.+ALOG(610.71)<a name='2875'>
      BE(2)=.622*HT(2)/.286<a name='2876'>
      AE(2)=BE(2)/273.+ALOG(610.71)<a name='2877'>
<font color=#447700>!      print *, 'TCRIT = ', tcrit,its,ite<a name='2878'></font>
      DO k=kts,ktf<a name='2879'>
      do i=its,itf<a name='2880'>
        if(ierr(i).eq.0)then<a name='2881'>
<font color=#447700>!Csgb - IPH is for phase, dependent on TCRIT (water or ice)<a name='2882'></font>
        IPH=1<a name='2883'>
        IF(T(I,K).LE.TCRIT)IPH=2<a name='2884'>
<font color=#447700>!       print *, 'AE(IPH),BE(IPH) = ',AE(IPH),BE(IPH),AE(IPH)-BE(IPH),T(i,k),i,k<a name='2885'></font>
        E=EXP(AE(IPH)-BE(IPH)/T(I,K))<a name='2886'>
<font color=#447700>!       print *, 'P, E = ', P(I,K), E<a name='2887'></font>
        QES(I,K)=.622*E/(100.*P(I,K)-E)<a name='2888'>
        IF(QES(I,K).LE.1.E-08)QES(I,K)=1.E-08<a name='2889'>
        IF(QES(I,K).LT.Q(I,K))QES(I,K)=Q(I,K)<a name='2890'>
<font color=#447700>!       IF(Q(I,K).GT.QES(I,K))Q(I,K)=QES(I,K)<a name='2891'></font>
        TV(I,K)=T(I,K)+.608*Q(I,K)*T(I,K)<a name='2892'>
        endif<a name='2893'>
      enddo<a name='2894'>
      enddo<a name='2895'>
<font color=#447700>!<a name='2896'></font>
<font color=#447700>!--- z's are calculated with changed h's and q's and t's<a name='2897'></font>
<font color=#447700>!--- if itest=2<a name='2898'></font>
<font color=#447700>!<a name='2899'></font>
      if(itest.ne.2)then<a name='2900'>
         do i=its,itf<a name='2901'>
           if(ierr(i).eq.0)then<a name='2902'>
             Z(I,1)=max(0.,Z1(I))-(ALOG(P(I,1))- &amp;<a name='2903'>
                 ALOG(PSUR(I)))*287.*TV(I,1)/9.81<a name='2904'>
           endif<a name='2905'>
         enddo<a name='2906'>
<a name='2907'>
<font color=#447700>! --- calculate heights<a name='2908'></font>
         DO K=kts+1,ktf<a name='2909'>
         do i=its,itf<a name='2910'>
           if(ierr(i).eq.0)then<a name='2911'>
              TVBAR=.5*TV(I,K)+.5*TV(I,K-1)<a name='2912'>
              Z(I,K)=Z(I,K-1)-(ALOG(P(I,K))- &amp;<a name='2913'>
               ALOG(P(I,K-1)))*287.*TVBAR/9.81<a name='2914'>
           endif<a name='2915'>
         enddo<a name='2916'>
         enddo<a name='2917'>
      else<a name='2918'>
         do k=kts,ktf<a name='2919'>
         do i=its,itf<a name='2920'>
           if(ierr(i).eq.0)then<a name='2921'>
             z(i,k)=(he(i,k)-1004.*t(i,k)-2.5e6*q(i,k))/9.81<a name='2922'>
             z(i,k)=max(1.e-3,z(i,k))<a name='2923'>
           endif<a name='2924'>
         enddo<a name='2925'>
         enddo<a name='2926'>
      endif<a name='2927'>
<font color=#447700>!<a name='2928'></font>
<font color=#447700>!--- calculate moist static energy - HE<a name='2929'></font>
<font color=#447700>!    saturated moist static energy - HES<a name='2930'></font>
<font color=#447700>!<a name='2931'></font>
       DO k=kts,ktf<a name='2932'>
       do i=its,itf<a name='2933'>
         if(ierr(i).eq.0)then<a name='2934'>
         if(itest.eq.0)HE(I,K)=9.81*Z(I,K)+1004.*T(I,K)+2.5E06*Q(I,K)<a name='2935'>
         HES(I,K)=9.81*Z(I,K)+1004.*T(I,K)+2.5E06*QES(I,K)<a name='2936'>
         IF(HE(I,K).GE.HES(I,K))HE(I,K)=HES(I,K)<a name='2937'>
         endif<a name='2938'>
      enddo<a name='2939'>
      enddo<a name='2940'>
<a name='2941'>
   END SUBROUTINE cup_env<a name='2942'>
<a name='2943'>
<a name='2944'>
<A NAME='CUP_ENV_CLEV'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_ENV_CLEV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2945'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_env_clev</font>(t,qes,q,he,hes,z,p,qes_cup,q_cup,   &amp; <A href='../../call_to/CUP_ENV_CLEV.html' TARGET='index'>12</A><a name='2946'>
              he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup,psur, &amp;<a name='2947'>
              ierr,z1,xl,rv,cp,                                &amp;<a name='2948'>
              itf,jtf,ktf,                       &amp;<a name='2949'>
              its,ite, jts,jte, kts,kte                       )<a name='2950'>
<a name='2951'>
   IMPLICIT NONE<a name='2952'>
<a name='2953'>
     integer                                                           &amp;<a name='2954'>
        ,intent (in   )                   ::                           &amp;<a name='2955'>
        itf,jtf,ktf,           &amp;<a name='2956'>
        its,ite, jts,jte, kts,kte<a name='2957'>
  <font color=#447700>!<a name='2958'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='2959'></font>
  <font color=#447700>! q           = environmental mixing ratio<a name='2960'></font>
  <font color=#447700>! q_cup       = environmental mixing ratio on cloud levels<a name='2961'></font>
  <font color=#447700>! qes         = environmental saturation mixing ratio<a name='2962'></font>
  <font color=#447700>! qes_cup     = environmental saturation mixing ratio on cloud levels<a name='2963'></font>
  <font color=#447700>! t           = environmental temp<a name='2964'></font>
  <font color=#447700>! t_cup       = environmental temp on cloud levels<a name='2965'></font>
  <font color=#447700>! p           = environmental pressure<a name='2966'></font>
  <font color=#447700>! p_cup       = environmental pressure on cloud levels<a name='2967'></font>
  <font color=#447700>! z           = environmental heights<a name='2968'></font>
  <font color=#447700>! z_cup       = environmental heights on cloud levels<a name='2969'></font>
  <font color=#447700>! he          = environmental moist static energy<a name='2970'></font>
  <font color=#447700>! he_cup      = environmental moist static energy on cloud levels<a name='2971'></font>
  <font color=#447700>! hes         = environmental saturation moist static energy<a name='2972'></font>
  <font color=#447700>! hes_cup     = environmental saturation moist static energy on cloud levels<a name='2973'></font>
  <font color=#447700>! gamma_cup   = gamma on cloud levels<a name='2974'></font>
  <font color=#447700>! psur        = surface pressure<a name='2975'></font>
  <font color=#447700>! z1          = terrain elevation<a name='2976'></font>
  <font color=#447700>! <a name='2977'></font>
  <font color=#447700>!<a name='2978'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2979'>
        ,intent (in   )                   ::                           &amp;<a name='2980'>
        qes,q,he,hes,z,p,t<a name='2981'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='2982'>
        ,intent (out  )                   ::                           &amp;<a name='2983'>
        qes_cup,q_cup,he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup<a name='2984'>
     real,    dimension (its:ite)                                      &amp;<a name='2985'>
        ,intent (in   )                   ::                           &amp;<a name='2986'>
        psur,z1<a name='2987'>
     real                                                              &amp;<a name='2988'>
        ,intent (in   )                   ::                           &amp;<a name='2989'>
        xl,rv,cp<a name='2990'>
     integer, dimension (its:ite)                                      &amp;<a name='2991'>
        ,intent (inout)                   ::                           &amp;<a name='2992'>
        ierr<a name='2993'>
<font color=#447700>!<a name='2994'></font>
<font color=#447700>!  local variables in this routine<a name='2995'></font>
<font color=#447700>!<a name='2996'></font>
<a name='2997'>
     integer                              ::                           &amp;<a name='2998'>
       i,k<a name='2999'>
<a name='3000'>
<a name='3001'>
      do k=kts+1,ktf<a name='3002'>
      do i=its,itf<a name='3003'>
        if(ierr(i).eq.0)then<a name='3004'>
        qes_cup(i,k)=.5*(qes(i,k-1)+qes(i,k))<a name='3005'>
        q_cup(i,k)=.5*(q(i,k-1)+q(i,k))<a name='3006'>
        hes_cup(i,k)=.5*(hes(i,k-1)+hes(i,k))<a name='3007'>
        he_cup(i,k)=.5*(he(i,k-1)+he(i,k))<a name='3008'>
        if(he_cup(i,k).gt.hes_cup(i,k))he_cup(i,k)=hes_cup(i,k)<a name='3009'>
        z_cup(i,k)=.5*(z(i,k-1)+z(i,k))<a name='3010'>
        p_cup(i,k)=.5*(p(i,k-1)+p(i,k))<a name='3011'>
        t_cup(i,k)=.5*(t(i,k-1)+t(i,k))<a name='3012'>
        gamma_cup(i,k)=(xl/cp)*(xl/(rv*t_cup(i,k) &amp;<a name='3013'>
                       *t_cup(i,k)))*qes_cup(i,k)<a name='3014'>
        endif<a name='3015'>
      enddo<a name='3016'>
      enddo<a name='3017'>
      do i=its,itf<a name='3018'>
        if(ierr(i).eq.0)then<a name='3019'>
        qes_cup(i,1)=qes(i,1)<a name='3020'>
        q_cup(i,1)=q(i,1)<a name='3021'>
        hes_cup(i,1)=hes(i,1)<a name='3022'>
        he_cup(i,1)=he(i,1)<a name='3023'>
        z_cup(i,1)=.5*(z(i,1)+z1(i))<a name='3024'>
        p_cup(i,1)=.5*(p(i,1)+psur(i))<a name='3025'>
        t_cup(i,1)=t(i,1)<a name='3026'>
        gamma_cup(i,1)=xl/cp*(xl/(rv*t_cup(i,1) &amp;<a name='3027'>
                       *t_cup(i,1)))*qes_cup(i,1)<a name='3028'>
        endif<a name='3029'>
      enddo<a name='3030'>
<a name='3031'>
   END SUBROUTINE cup_env_clev<a name='3032'>
<a name='3033'>
<a name='3034'>
<A NAME='CUP_FORCING_ENS_3D'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_FORCING_ENS_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3035'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_forcing_ens_3d</font>(closure_n,xland,aa0,aa1,xaa0,mbdt,dtime,ierr,ierr2,ierr3,&amp; <A href='../../call_to/CUP_FORCING_ENS_3D.html' TARGET='index'>2</A><a name='3036'>
              xf_ens,j,name,axx,maxens,iens,iedt,maxens2,maxens3,mconv,    &amp;<a name='3037'>
              p_cup,ktop,omeg,zd,k22,zu,pr_ens,edt,kbcon,massflx,      &amp;<a name='3038'>
              iact_old_gr,dir,ensdim,massfln,icoic,edt_out,            &amp;<a name='3039'>
              high_resolution,itf,jtf,ktf,               &amp;<a name='3040'>
              its,ite, jts,jte, kts,kte,ens4,ktau                )<a name='3041'>
<a name='3042'>
   IMPLICIT NONE<a name='3043'>
<a name='3044'>
     integer                                                           &amp;<a name='3045'>
        ,intent (in   )                   ::                           &amp;<a name='3046'>
        itf,jtf,ktf,           &amp;<a name='3047'>
        its,ite, jts,jte, kts,kte,ens4,high_resolution,ktau<a name='3048'>
     integer, intent (in   )              ::                           &amp;<a name='3049'>
        j,ensdim,maxens,iens,iedt,maxens2,maxens3<a name='3050'>
  <font color=#447700>!<a name='3051'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3052'></font>
  <font color=#447700>! pr_ens = precipitation ensemble<a name='3053'></font>
  <font color=#447700>! xf_ens = mass flux ensembles<a name='3054'></font>
  <font color=#447700>! massfln = downdraft mass flux ensembles used in next timestep<a name='3055'></font>
  <font color=#447700>! omeg = omega from large scale model<a name='3056'></font>
  <font color=#447700>! mconv = moisture convergence from large scale model<a name='3057'></font>
  <font color=#447700>! zd      = downdraft normalized mass flux<a name='3058'></font>
  <font color=#447700>! zu      = updraft normalized mass flux<a name='3059'></font>
  <font color=#447700>! aa0     = cloud work function without forcing effects<a name='3060'></font>
  <font color=#447700>! aa1     = cloud work function with forcing effects<a name='3061'></font>
  <font color=#447700>! xaa0    = cloud work function with cloud effects (ensemble dependent)<a name='3062'></font>
  <font color=#447700>! edt     = epsilon<a name='3063'></font>
  <font color=#447700>! dir     = "storm motion"<a name='3064'></font>
  <font color=#447700>! mbdt    = arbitrary numerical parameter<a name='3065'></font>
  <font color=#447700>! dtime   = dt over which forcing is applied<a name='3066'></font>
  <font color=#447700>! iact_gr_old = flag to tell where convection was active<a name='3067'></font>
  <font color=#447700>! kbcon       = LFC of parcel from k22<a name='3068'></font>
  <font color=#447700>! k22         = updraft originating level<a name='3069'></font>
  <font color=#447700>! icoic       = flag if only want one closure (usually set to zero!)<a name='3070'></font>
  <font color=#447700>! name        = deep or shallow convection flag<a name='3071'></font>
  <font color=#447700>!<a name='3072'></font>
     real,    dimension (its:ite,jts:jte,1:ensdim)                     &amp;<a name='3073'>
        ,intent (inout)                   ::                           &amp;<a name='3074'>
        pr_ens<a name='3075'>
     real,    dimension (its:ite,jts:jte,1:ensdim)                     &amp;<a name='3076'>
        ,intent (out  )                   ::                           &amp;<a name='3077'>
        xf_ens,massfln<a name='3078'>
     real,    dimension (its:ite,jts:jte)                              &amp;<a name='3079'>
        ,intent (inout   )                   ::                           &amp;<a name='3080'>
        edt_out<a name='3081'>
     real,    dimension (its:ite,jts:jte)                              &amp;<a name='3082'>
        ,intent (in   )                   ::                           &amp;<a name='3083'>
        massflx<a name='3084'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3085'>
        ,intent (in   )                   ::                           &amp;<a name='3086'>
        zd,zu,p_cup<a name='3087'>
     real,    dimension (its:ite,kts:kte,1:ens4)                              &amp;<a name='3088'>
        ,intent (in   )                   ::                           &amp;<a name='3089'>
        omeg<a name='3090'>
     real,    dimension (its:ite,1:maxens)                             &amp;<a name='3091'>
        ,intent (in   )                   ::                           &amp;<a name='3092'>
        xaa0<a name='3093'>
     real,    dimension (its:ite)                                      &amp;<a name='3094'>
        ,intent (in   )                   ::                           &amp;<a name='3095'>
        aa1,edt,dir,xland<a name='3096'>
     real,    dimension (its:ite,1:ens4)                                      &amp;<a name='3097'>
        ,intent (in   )                   ::                           &amp;<a name='3098'>
        mconv,axx<a name='3099'>
     real,    dimension (its:ite)                                      &amp;<a name='3100'>
        ,intent (inout)                   ::                           &amp;<a name='3101'>
        aa0,closure_n<a name='3102'>
     real,    dimension (1:maxens)                                     &amp;<a name='3103'>
        ,intent (in   )                   ::                           &amp;<a name='3104'>
        mbdt<a name='3105'>
     real                                                              &amp;<a name='3106'>
        ,intent (in   )                   ::                           &amp;<a name='3107'>
        dtime<a name='3108'>
     integer, dimension (its:ite,jts:jte)                              &amp;<a name='3109'>
        ,intent (in   )                   ::                           &amp;<a name='3110'>
        iact_old_gr<a name='3111'>
     integer, dimension (its:ite)                                      &amp;<a name='3112'>
        ,intent (in   )                   ::                           &amp;<a name='3113'>
        k22,kbcon,ktop<a name='3114'>
     integer, dimension (its:ite)                                      &amp;<a name='3115'>
        ,intent (inout)                   ::                           &amp;<a name='3116'>
        ierr,ierr2,ierr3<a name='3117'>
     integer                                                           &amp;<a name='3118'>
        ,intent (in   )                   ::                           &amp;<a name='3119'>
        icoic<a name='3120'>
      character *(*), intent (in)         ::                           &amp;<a name='3121'>
       name<a name='3122'>
<font color=#447700>!<a name='3123'></font>
<font color=#447700>!  local variables in this routine<a name='3124'></font>
<font color=#447700>!<a name='3125'></font>
<a name='3126'>
     real,    dimension (1:maxens3)       ::                           &amp;<a name='3127'>
       xff_ens3<a name='3128'>
     real,    dimension (1:maxens)        ::                           &amp;<a name='3129'>
       xk<a name='3130'>
     integer                              ::                           &amp;<a name='3131'>
       i,k,nall,n,ne,nens,nens3,iresult,iresultd,iresulte,mkxcrt,kclim<a name='3132'>
     parameter (mkxcrt=15)<a name='3133'>
     real                                 ::                           &amp;<a name='3134'>
       fens4,a1,massfld,a_ave,xff0,xff00,xxx,xomg,aclim1,aclim2,aclim3,aclim4<a name='3135'>
     real,    dimension(1:mkxcrt)         ::                           &amp;<a name='3136'>
       pcrit,acrit,acritt<a name='3137'>
<a name='3138'>
     integer :: nall2,ixxx,irandom<a name='3139'>
     integer, allocatable :: seed(:)<a name='3140'>
     integer              :: seed_size<a name='3141'>
<a name='3142'>
<a name='3143'>
      DATA PCRIT/850.,800.,750.,700.,650.,600.,550.,500.,450.,400.,    &amp;<a name='3144'>
                 350.,300.,250.,200.,150./<a name='3145'>
      DATA ACRIT/.0633,.0445,.0553,.0664,.075,.1082,.1521,.2216,       &amp;<a name='3146'>
                 .3151,.3677,.41,.5255,.7663,1.1686,1.6851/<a name='3147'>
<font color=#447700>!  GDAS DERIVED ACRIT<a name='3148'></font>
      DATA ACRITT/.203,.515,.521,.566,.625,.665,.659,.688,             &amp;<a name='3149'>
                  .743,.813,.886,.947,1.138,1.377,1.896/<a name='3150'>
<font color=#447700>!<a name='3151'></font>
       call random_seed(size=seed_size)      <font color=#447700>! Get size of seed array.<a name='3152'></font>
       allocate(seed(1:seed_size))           <font color=#447700>! Allocate according to returned size<a name='3153'></font>
<a name='3154'>
       seed=0<a name='3155'>
       seed(2)=j<a name='3156'>
       seed(3)=ktau<a name='3157'>
       nens=0<a name='3158'>
       irandom=1<a name='3159'>
       if(high_resolution.eq.1)irandom=0<a name='3160'>
       irandom=0<a name='3161'>
       fens4=float(ens4)<a name='3162'>
<a name='3163'>
<font color=#447700>!--- LARGE SCALE FORCING<a name='3164'></font>
<font color=#447700>!<a name='3165'></font>
       DO 100 i=its,itf<a name='3166'>
          if(name.eq.'deeps'.and.ierr(i).gt.995)then<a name='3167'>
           aa0(i)=0.<a name='3168'>
           ierr(i)=0<a name='3169'>
          endif<a name='3170'>
          IF(ierr(i).eq.0)then<a name='3171'>
<font color=#447700>!<a name='3172'></font>
<font color=#447700>!---<a name='3173'></font>
<font color=#447700>!<a name='3174'></font>
             if(name.eq.'deeps')then<a name='3175'>
<font color=#447700>!<a name='3176'></font>
                a_ave=0.<a name='3177'>
                do ne=1,ens4<a name='3178'>
                  a_ave=a_ave+axx(i,ne)<a name='3179'>
                enddo<a name='3180'>
                a_ave=max(0.,a_ave/fens4)<a name='3181'>
                a_ave=min(a_ave,aa1(i))<a name='3182'>
                a_ave=max(0.,a_ave)<a name='3183'>
                do ne=1,16<a name='3184'>
                  xff_ens3(ne)=0.<a name='3185'>
                enddo<a name='3186'>
                xff0= (AA1(I)-AA0(I))/DTIME<a name='3187'>
                if(high_resolution.eq.1)xff0= (a_ave-AA0(I))/DTIME<a name='3188'>
                xff_ens3(1)=(AA1(I)-AA0(I))/dtime<a name='3189'>
                xff_ens3(2)=(a_ave-AA0(I))/dtime<a name='3190'>
                if(irandom.eq.1)then<a name='3191'>
                   seed(1)=i<a name='3192'>
                   call random_seed (PUT=seed)<a name='3193'>
                   call random_number (xxx)<a name='3194'>
                   ixxx=min(ens4,max(1,int(fens4*xxx+1.e-8)))<a name='3195'>
                   xff_ens3(3)=(axx(i,ixxx)-AA0(I))/dtime<a name='3196'>
                   call random_number (xxx)<a name='3197'>
                   ixxx=min(ens4,max(1,int(fens4*xxx+1.e-8)))<a name='3198'>
                   xff_ens3(13)=(axx(i,ixxx)-AA0(I))/dtime<a name='3199'>
                else<a name='3200'>
                   xff_ens3(3)=(AA1(I)-AA0(I))/dtime<a name='3201'>
                   xff_ens3(13)=(AA1(I)-AA0(I))/dtime<a name='3202'>
                endif<a name='3203'>
                if(high_resolution.eq.1)then<a name='3204'>
                   xff_ens3(1)=(a_ave-AA0(I))/dtime<a name='3205'>
                   xff_ens3(2)=(a_ave-AA0(I))/dtime<a name='3206'>
                   xff_ens3(3)=(a_ave-AA0(I))/dtime<a name='3207'>
                   xff_ens3(13)=(a_ave-AA0(I))/dtime<a name='3208'>
                endif<a name='3209'>
<font color=#447700>!   <a name='3210'></font>
<font color=#447700>!--- more original Arakawa-Schubert (climatologic value of aa0)<a name='3211'></font>
<font color=#447700>!<a name='3212'></font>
<font color=#447700>!<a name='3213'></font>
<font color=#447700>!--- omeg is in bar/s, mconv done with omeg in Pa/s<a name='3214'></font>
<font color=#447700>!     more like Brown (1979), or Frank-Cohen (199?)<a name='3215'></font>
<font color=#447700>!<a name='3216'></font>
                xff_ens3(14)=0.<a name='3217'>
                do ne=1,ens4<a name='3218'>
                  xff_ens3(14)=xff_ens3(14)-omeg(i,k22(i),ne)/(fens4*9.81)<a name='3219'>
                enddo<a name='3220'>
                if(xff_ens3(14).lt.0.)xff_ens3(14)=0.<a name='3221'>
                xff_ens3(5)=0.<a name='3222'>
                do ne=1,ens4<a name='3223'>
                  xff_ens3(5)=xff_ens3(5)-omeg(i,kbcon(i),ne)/(fens4*9.81)<a name='3224'>
                enddo<a name='3225'>
                if(xff_ens3(5).lt.0.)xff_ens3(5)=0.<a name='3226'>
<font color=#447700>!  <a name='3227'></font>
<font color=#447700>! minimum below kbcon<a name='3228'></font>
<font color=#447700>!<a name='3229'></font>
                if(high_resolution.eq.0)then<a name='3230'>
                   xff_ens3(4)=-omeg(i,2,1)/9.81<a name='3231'>
                   do k=2,kbcon(i)-1<a name='3232'>
                   do ne=1,ens4<a name='3233'>
                     xomg=-omeg(i,k,ne)/9.81<a name='3234'>
                     if(xomg.lt.xff_ens3(4))xff_ens3(4)=xomg<a name='3235'>
                   enddo<a name='3236'>
                   enddo<a name='3237'>
                   if(xff_ens3(4).lt.0.)xff_ens3(4)=0.<a name='3238'>
<font color=#447700>!<a name='3239'></font>
<font color=#447700>! max below kbcon<a name='3240'></font>
                   xff_ens3(6)=-omeg(i,2,1)/9.81<a name='3241'>
                   do k=2,kbcon(i)-1<a name='3242'>
                   do ne=1,ens4<a name='3243'>
                     xomg=-omeg(i,k,ne)/9.81<a name='3244'>
                     if(xomg.gt.xff_ens3(6))xff_ens3(6)=xomg<a name='3245'>
                   enddo<a name='3246'>
                   enddo<a name='3247'>
                   if(xff_ens3(6).lt.0.)xff_ens3(6)=0.<a name='3248'>
                endif<a name='3249'>
                if(high_resolution.eq.1)then<a name='3250'>
                   xff_ens3(5)=min(xff_ens3(5),xff_ens3(14))<a name='3251'>
                   xff_ens3(4)=xff_ens3(5)<a name='3252'>
                   xff_ens3(6)=xff_ens3(5)<a name='3253'>
                endif<a name='3254'>
<font color=#447700>!<a name='3255'></font>
<font color=#447700>!--- more like Krishnamurti et al.; pick max and average values<a name='3256'></font>
<font color=#447700>!<a name='3257'></font>
                xff_ens3(7)=mconv(i,1)<a name='3258'>
                xff_ens3(8)=mconv(i,1)<a name='3259'>
                xff_ens3(9)=mconv(i,1)<a name='3260'>
                if(ens4.gt.1)then<a name='3261'>
                   do ne=2,ens4<a name='3262'>
                      if (mconv(i,ne).gt.xff_ens3(7))xff_ens3(7)=mconv(i,ne)<a name='3263'>
                   enddo<a name='3264'>
                   do ne=2,ens4<a name='3265'>
                      if (mconv(i,ne).lt.xff_ens3(8))xff_ens3(8)=mconv(i,ne)<a name='3266'>
                   enddo<a name='3267'>
                   do ne=2,ens4<a name='3268'>
                      xff_ens3(9)=xff_ens3(9)+mconv(i,ne)<a name='3269'>
                   enddo<a name='3270'>
                   xff_ens3(9)=xff_ens3(9)/fens4<a name='3271'>
                endif<a name='3272'>
                if(high_resolution.eq.1)then<a name='3273'>
                   xff_ens3(7)=xff_ens3(9)<a name='3274'>
                   xff_ens3(8)=xff_ens3(9)<a name='3275'>
                   xff_ens3(15)=xff_ens3(9)<a name='3276'>
                endif<a name='3277'>
<font color=#447700>!<a name='3278'></font>
                if(high_resolution.eq.0)then<a name='3279'>
                if(irandom.eq.1)then<a name='3280'>
                   seed(1)=i<a name='3281'>
                   call random_seed (PUT=seed)<a name='3282'>
                   call random_number (xxx)<a name='3283'>
                   ixxx=min(ens4,max(1,int(fens4*xxx+1.e-8)))<a name='3284'>
                   xff_ens3(15)=mconv(i,ixxx)<a name='3285'>
                else<a name='3286'>
                   xff_ens3(15)=mconv(i,1)<a name='3287'>
                endif<a name='3288'>
                endif<a name='3289'>
<font color=#447700>!<a name='3290'></font>
<font color=#447700>!--- more like Fritsch Chappel or Kain Fritsch (plus triggers)<a name='3291'></font>
<font color=#447700>!<a name='3292'></font>
                xff_ens3(10)=A_AVE/(60.*40.)<a name='3293'>
                xff_ens3(11)=AA1(I)/(60.*40.)<a name='3294'>
                if(irandom.eq.1)then<a name='3295'>
                   seed(1)=i<a name='3296'>
                   call random_seed (PUT=seed)<a name='3297'>
                   call random_number (xxx)<a name='3298'>
                   ixxx=min(ens4,max(1,int(fens4*xxx+1.e-8)))<a name='3299'>
                   xff_ens3(12)=AXX(I,ixxx)/(60.*40.)<a name='3300'>
                else<a name='3301'>
                   xff_ens3(12)=AA1(I)/(60.*40.)<a name='3302'>
                endif<a name='3303'>
                if(high_resolution.eq.1)then<a name='3304'>
                   xff_ens3(11)=xff_ens3(10)<a name='3305'>
                   xff_ens3(12)=xff_ens3(10)<a name='3306'>
                endif<a name='3307'>
<font color=#447700>!  <a name='3308'></font>
<font color=#447700>!--- more original Arakawa-Schubert (climatologic value of aa0)<a name='3309'></font>
<font color=#447700>!<a name='3310'></font>
<font color=#447700>!               edt_out(i,j)=xff0<a name='3311'></font>
                if(icoic.eq.0)then<a name='3312'>
                if(xff0.lt.0.)then<a name='3313'>
                     xff_ens3(1)=0.<a name='3314'>
                     xff_ens3(2)=0.<a name='3315'>
                     xff_ens3(3)=0.<a name='3316'>
                     xff_ens3(13)=0.<a name='3317'>
                     xff_ens3(10)=0.<a name='3318'>
                     xff_ens3(11)=0.<a name='3319'>
                     xff_ens3(12)=0.<a name='3320'>
                endif<a name='3321'>
                endif<a name='3322'>
<a name='3323'>
<a name='3324'>
<a name='3325'>
                do nens=1,maxens<a name='3326'>
                   XK(nens)=(XAA0(I,nens)-AA1(I))/MBDT(2)<a name='3327'>
                   if(xk(nens).le.0.and.xk(nens).gt.-1.e-6) &amp;<a name='3328'>
                           xk(nens)=-1.e-6<a name='3329'>
                   if(xk(nens).gt.0.and.xk(nens).lt.1.e-6) &amp;<a name='3330'>
                           xk(nens)=1.e-6<a name='3331'>
                enddo<a name='3332'>
<font color=#447700>!<a name='3333'></font>
<font color=#447700>!--- add up all ensembles<a name='3334'></font>
<font color=#447700>!<a name='3335'></font>
                do 350 ne=1,maxens<a name='3336'>
<font color=#447700>!<a name='3337'></font>
<font color=#447700>!--- for every xk, we have maxens3 xffs<a name='3338'></font>
<font color=#447700>!--- iens is from outermost ensemble (most expensive!<a name='3339'></font>
<font color=#447700>!<a name='3340'></font>
<font color=#447700>!--- iedt (maxens2 belongs to it)<a name='3341'></font>
<font color=#447700>!--- is from second, next outermost, not so expensive<a name='3342'></font>
<font color=#447700>!<a name='3343'></font>
<font color=#447700>!--- so, for every outermost loop, we have maxens*maxens2*3<a name='3344'></font>
<font color=#447700>!--- ensembles!!! nall would be 0, if everything is on first<a name='3345'></font>
<font color=#447700>!--- loop index, then ne would start counting, then iedt, then iens....<a name='3346'></font>
<font color=#447700>!<a name='3347'></font>
                   iresult=0<a name='3348'>
                   iresultd=0<a name='3349'>
                   iresulte=0<a name='3350'>
                   nall=(iens-1)*maxens3*maxens*maxens2 &amp;<a name='3351'>
                        +(iedt-1)*maxens*maxens3 &amp;<a name='3352'>
                        +(ne-1)*maxens3<a name='3353'>
<font color=#447700>!<a name='3354'></font>
<font color=#447700>! over water, enfor!e small cap for some of the closures<a name='3355'></font>
<font color=#447700>!<a name='3356'></font>
                if(xland(i).lt.0.1)then<a name='3357'>
                 if(ierr2(i).gt.0.or.ierr3(i).gt.0)then<a name='3358'>
                      xff_ens3(1) =0.<a name='3359'>
                      massfln(i,j,nall+1)=0.<a name='3360'>
                      xff_ens3(2) =0.<a name='3361'>
                      massfln(i,j,nall+2)=0.<a name='3362'>
                      xff_ens3(3) =0.<a name='3363'>
                      massfln(i,j,nall+3)=0.<a name='3364'>
                      xff_ens3(10) =0.<a name='3365'>
                      massfln(i,j,nall+10)=0.<a name='3366'>
                      xff_ens3(11) =0.<a name='3367'>
                      massfln(i,j,nall+11)=0.<a name='3368'>
                      xff_ens3(12) =0.<a name='3369'>
                      massfln(i,j,nall+12)=0.<a name='3370'>
                      xff_ens3(7) =0.<a name='3371'>
                      massfln(i,j,nall+7)=0.<a name='3372'>
                      xff_ens3(8) =0.<a name='3373'>
                      massfln(i,j,nall+8)=0.<a name='3374'>
                      xff_ens3(9) =0.<a name='3375'>
                      massfln(i,j,nall+9)=0.<a name='3376'>
                      xff_ens3(13) =0.<a name='3377'>
                      massfln(i,j,nall+13)=0.<a name='3378'>
                      xff_ens3(15) =0.<a name='3379'>
                      massfln(i,j,nall+15)=0.<a name='3380'>
                endif<a name='3381'>
                endif<a name='3382'>
<font color=#447700>!<a name='3383'></font>
<font color=#447700>! end water treatment<a name='3384'></font>
<font color=#447700>!<a name='3385'></font>
<font color=#447700>!<a name='3386'></font>
<font color=#447700>!--- check for upwind convection<a name='3387'></font>
<font color=#447700>!                  iresult=0<a name='3388'></font>
                   massfld=0.<a name='3389'>
<a name='3390'>
<font color=#447700>!                  call cup_direction2(i,j,dir,iact_old_gr, &amp;<a name='3391'></font>
<font color=#447700>!                       massflx,iresult,1,                  &amp;<a name='3392'></font>
<font color=#447700>!                       massfld,                            &amp;<a name='3393'></font>
<font color=#447700>!                       itf,jtf,ktf,          &amp;<a name='3394'></font>
<font color=#447700>!                       ims,ime, jms,jme, kms,kme,          &amp;<a name='3395'></font>
<font color=#447700>!                       its,ite, jts,jte, kts,kte          )<a name='3396'></font>
<font color=#447700>!                  if(i.eq.ipr.and.j.eq.jpr.and.iedt.eq.1.and.ne.eq.1)then<a name='3397'></font>
<font color=#447700>!                  if(iedt.eq.1.and.ne.eq.1)then<a name='3398'></font>
<font color=#447700>!                   print *,massfld,ne,iedt,iens<a name='3399'></font>
<font color=#447700>!                   print *,xk(ne),xff_ens3(1),xff_ens3(2),xff_ens3(3)<a name='3400'></font>
<font color=#447700>!                  endif<a name='3401'></font>
<font color=#447700>!                  print *,i,j,massfld,aa0(i),aa1(i)<a name='3402'></font>
                   IF(XK(ne).lt.0.and.xff0.gt.0.)iresultd=1<a name='3403'>
                   iresulte=max(iresult,iresultd)<a name='3404'>
                   iresulte=1<a name='3405'>
                   if(iresulte.eq.1)then<a name='3406'>
<font color=#447700>!<a name='3407'></font>
<font color=#447700>!--- special treatment for stability closures<a name='3408'></font>
<font color=#447700>!<a name='3409'></font>
<a name='3410'>
                      if(xff0.ge.0.)then<a name='3411'>
                         xf_ens(i,j,nall+1)=massfld<a name='3412'>
                         xf_ens(i,j,nall+2)=massfld<a name='3413'>
                         xf_ens(i,j,nall+3)=massfld<a name='3414'>
                         xf_ens(i,j,nall+13)=massfld<a name='3415'>
                         if(xff_ens3(1).gt.0)xf_ens(i,j,nall+1)=max(0.,-xff_ens3(1)/xk(ne)) &amp;<a name='3416'>
                                        +massfld<a name='3417'>
                         if(xff_ens3(2).gt.0)xf_ens(i,j,nall+2)=max(0.,-xff_ens3(2)/xk(ne)) &amp;<a name='3418'>
                                        +massfld<a name='3419'>
                         if(xff_ens3(3).gt.0)xf_ens(i,j,nall+3)=max(0.,-xff_ens3(3)/xk(ne)) &amp;<a name='3420'>
                                        +massfld<a name='3421'>
                         if(xff_ens3(13).gt.0)xf_ens(i,j,nall+13)=max(0.,-xff_ens3(13)/xk(ne)) &amp;<a name='3422'>
                                        +massfld<a name='3423'>
<font color=#447700>!                       endif<a name='3424'></font>
                      else<a name='3425'>
                         xf_ens(i,j,nall+1)=massfld<a name='3426'>
                         xf_ens(i,j,nall+2)=massfld<a name='3427'>
                         xf_ens(i,j,nall+3)=massfld<a name='3428'>
                         xf_ens(i,j,nall+13)=massfld<a name='3429'>
                      endif<a name='3430'>
<font color=#447700>!<a name='3431'></font>
<font color=#447700>!--- if iresult.eq.1, following independent of xff0<a name='3432'></font>
<font color=#447700>!<a name='3433'></font>
                         xf_ens(i,j,nall+4)=max(0.,xff_ens3(4) &amp;<a name='3434'>
                            +massfld)<a name='3435'>
                         xf_ens(i,j,nall+5)=max(0.,xff_ens3(5) &amp;<a name='3436'>
                                        +massfld)<a name='3437'>
                         xf_ens(i,j,nall+6)=max(0.,xff_ens3(6) &amp;<a name='3438'>
                                        +massfld)<a name='3439'>
                         xf_ens(i,j,nall+14)=max(0.,xff_ens3(14) &amp;<a name='3440'>
                                        +massfld)<a name='3441'>
                         a1=max(1.e-3,pr_ens(i,j,nall+7))<a name='3442'>
                         xf_ens(i,j,nall+7)=max(0.,xff_ens3(7) &amp;<a name='3443'>
                                     /a1)<a name='3444'>
                         a1=max(1.e-3,pr_ens(i,j,nall+8))<a name='3445'>
                         xf_ens(i,j,nall+8)=max(0.,xff_ens3(8) &amp;<a name='3446'>
                                     /a1)<a name='3447'>
                         a1=max(1.e-3,pr_ens(i,j,nall+9))<a name='3448'>
                         xf_ens(i,j,nall+9)=max(0.,xff_ens3(9) &amp;<a name='3449'>
                                     /a1)<a name='3450'>
                         a1=max(1.e-3,pr_ens(i,j,nall+15))<a name='3451'>
                         xf_ens(i,j,nall+15)=max(0.,xff_ens3(15) &amp;<a name='3452'>
                                     /a1)<a name='3453'>
                         if(XK(ne).lt.0.)then<a name='3454'>
                            xf_ens(i,j,nall+10)=max(0., &amp;<a name='3455'>
                                        -xff_ens3(10)/xk(ne)) &amp;<a name='3456'>
                                        +massfld<a name='3457'>
                            xf_ens(i,j,nall+11)=max(0., &amp;<a name='3458'>
                                        -xff_ens3(11)/xk(ne)) &amp;<a name='3459'>
                                        +massfld<a name='3460'>
                            xf_ens(i,j,nall+12)=max(0., &amp;<a name='3461'>
                                        -xff_ens3(12)/xk(ne)) &amp;<a name='3462'>
                                        +massfld<a name='3463'>
                         else<a name='3464'>
                            xf_ens(i,j,nall+10)=massfld<a name='3465'>
                            xf_ens(i,j,nall+11)=massfld<a name='3466'>
                            xf_ens(i,j,nall+12)=massfld<a name='3467'>
                         endif<a name='3468'>
                      if(icoic.ge.1)then<a name='3469'>
                      closure_n(i)=0.<a name='3470'>
                      xf_ens(i,j,nall+1)=xf_ens(i,j,nall+icoic)<a name='3471'>
                      xf_ens(i,j,nall+2)=xf_ens(i,j,nall+icoic)<a name='3472'>
                      xf_ens(i,j,nall+3)=xf_ens(i,j,nall+icoic)<a name='3473'>
                      xf_ens(i,j,nall+4)=xf_ens(i,j,nall+icoic)<a name='3474'>
                      xf_ens(i,j,nall+5)=xf_ens(i,j,nall+icoic)<a name='3475'>
                      xf_ens(i,j,nall+6)=xf_ens(i,j,nall+icoic)<a name='3476'>
                      xf_ens(i,j,nall+7)=xf_ens(i,j,nall+icoic)<a name='3477'>
                      xf_ens(i,j,nall+8)=xf_ens(i,j,nall+icoic)<a name='3478'>
                      xf_ens(i,j,nall+9)=xf_ens(i,j,nall+icoic)<a name='3479'>
                      xf_ens(i,j,nall+10)=xf_ens(i,j,nall+icoic)<a name='3480'>
                      xf_ens(i,j,nall+11)=xf_ens(i,j,nall+icoic)<a name='3481'>
                      xf_ens(i,j,nall+12)=xf_ens(i,j,nall+icoic)<a name='3482'>
                      xf_ens(i,j,nall+13)=xf_ens(i,j,nall+icoic)<a name='3483'>
                      xf_ens(i,j,nall+14)=xf_ens(i,j,nall+icoic)<a name='3484'>
                      xf_ens(i,j,nall+15)=xf_ens(i,j,nall+icoic)<a name='3485'>
                      xf_ens(i,j,nall+16)=xf_ens(i,j,nall+icoic)<a name='3486'>
                      endif<a name='3487'>
<font color=#447700>!<a name='3488'></font>
<font color=#447700>! 16 is a randon pick from the oher 15<a name='3489'></font>
<font color=#447700>!<a name='3490'></font>
                if(irandom.eq.1)then<a name='3491'>
                   call random_number (xxx)<a name='3492'>
                   ixxx=min(15,max(1,int(15.*xxx+1.e-8)))<a name='3493'>
                   xf_ens(i,j,nall+16)=xf_ens(i,j,nall+ixxx)<a name='3494'>
                else<a name='3495'>
                   xf_ens(i,j,nall+16)=xf_ens(i,j,nall+1)<a name='3496'>
                endif<a name='3497'>
<font color=#447700>!<a name='3498'></font>
<font color=#447700>!<a name='3499'></font>
<font color=#447700>!--- store new for next time step<a name='3500'></font>
<font color=#447700>!<a name='3501'></font>
                      do nens3=1,maxens3<a name='3502'>
                        massfln(i,j,nall+nens3)=edt(i) &amp;<a name='3503'>
                                                *xf_ens(i,j,nall+nens3)<a name='3504'>
                        massfln(i,j,nall+nens3)=max(0., &amp;<a name='3505'>
                                              massfln(i,j,nall+nens3))<a name='3506'>
                      enddo<a name='3507'>
<font color=#447700>!<a name='3508'></font>
<font color=#447700>!<a name='3509'></font>
<font color=#447700>!--- do some more on the caps!!! ne=1 for 175, ne=2 for 100,....<a name='3510'></font>
<font color=#447700>!<a name='3511'></font>
<font color=#447700>!     do not care for caps here for closure groups 1 and 5,<a name='3512'></font>
<font color=#447700>!     they are fine, do not turn them off here<a name='3513'></font>
<font color=#447700>!<a name='3514'></font>
<font color=#447700>!<a name='3515'></font>
                if(ne.eq.2.and.ierr2(i).gt.0)then<a name='3516'>
                      xf_ens(i,j,nall+1) =0.<a name='3517'>
                      xf_ens(i,j,nall+2) =0.<a name='3518'>
                      xf_ens(i,j,nall+3) =0.<a name='3519'>
                      xf_ens(i,j,nall+4) =0.<a name='3520'>
                      xf_ens(i,j,nall+5) =0.<a name='3521'>
                      xf_ens(i,j,nall+6) =0.<a name='3522'>
                      xf_ens(i,j,nall+7) =0.<a name='3523'>
                      xf_ens(i,j,nall+8) =0.<a name='3524'>
                      xf_ens(i,j,nall+9) =0.<a name='3525'>
                      xf_ens(i,j,nall+10)=0.<a name='3526'>
                      xf_ens(i,j,nall+11)=0.<a name='3527'>
                      xf_ens(i,j,nall+12)=0.<a name='3528'>
                      xf_ens(i,j,nall+13)=0.<a name='3529'>
                      xf_ens(i,j,nall+14)=0.<a name='3530'>
                      xf_ens(i,j,nall+15)=0.<a name='3531'>
                      xf_ens(i,j,nall+16)=0.<a name='3532'>
                      massfln(i,j,nall+1)=0.<a name='3533'>
                      massfln(i,j,nall+2)=0.<a name='3534'>
                      massfln(i,j,nall+3)=0.<a name='3535'>
                      massfln(i,j,nall+4)=0.<a name='3536'>
                      massfln(i,j,nall+5)=0.<a name='3537'>
                      massfln(i,j,nall+6)=0.<a name='3538'>
                      massfln(i,j,nall+7)=0.<a name='3539'>
                      massfln(i,j,nall+8)=0.<a name='3540'>
                      massfln(i,j,nall+9)=0.<a name='3541'>
                      massfln(i,j,nall+10)=0.<a name='3542'>
                      massfln(i,j,nall+11)=0.<a name='3543'>
                      massfln(i,j,nall+12)=0.<a name='3544'>
                      massfln(i,j,nall+13)=0.<a name='3545'>
                      massfln(i,j,nall+14)=0.<a name='3546'>
                      massfln(i,j,nall+15)=0.<a name='3547'>
                      massfln(i,j,nall+16)=0.<a name='3548'>
                endif<a name='3549'>
                if(ne.eq.3.and.ierr3(i).gt.0)then<a name='3550'>
                      xf_ens(i,j,nall+1) =0.<a name='3551'>
                      xf_ens(i,j,nall+2) =0.<a name='3552'>
                      xf_ens(i,j,nall+3) =0.<a name='3553'>
                      xf_ens(i,j,nall+4) =0.<a name='3554'>
                      xf_ens(i,j,nall+5) =0.<a name='3555'>
                      xf_ens(i,j,nall+6) =0.<a name='3556'>
                      xf_ens(i,j,nall+7) =0.<a name='3557'>
                      xf_ens(i,j,nall+8) =0.<a name='3558'>
                      xf_ens(i,j,nall+9) =0.<a name='3559'>
                      xf_ens(i,j,nall+10)=0.<a name='3560'>
                      xf_ens(i,j,nall+11)=0.<a name='3561'>
                      xf_ens(i,j,nall+12)=0.<a name='3562'>
                      xf_ens(i,j,nall+13)=0.<a name='3563'>
                      xf_ens(i,j,nall+14)=0.<a name='3564'>
                      xf_ens(i,j,nall+15)=0.<a name='3565'>
                      xf_ens(i,j,nall+16)=0.<a name='3566'>
                      massfln(i,j,nall+1)=0.<a name='3567'>
                      massfln(i,j,nall+2)=0.<a name='3568'>
                      massfln(i,j,nall+3)=0.<a name='3569'>
                      massfln(i,j,nall+4)=0.<a name='3570'>
                      massfln(i,j,nall+5)=0.<a name='3571'>
                      massfln(i,j,nall+6)=0.<a name='3572'>
                      massfln(i,j,nall+7)=0.<a name='3573'>
                      massfln(i,j,nall+8)=0.<a name='3574'>
                      massfln(i,j,nall+9)=0.<a name='3575'>
                      massfln(i,j,nall+10)=0.<a name='3576'>
                      massfln(i,j,nall+11)=0.<a name='3577'>
                      massfln(i,j,nall+12)=0.<a name='3578'>
                      massfln(i,j,nall+13)=0.<a name='3579'>
                      massfln(i,j,nall+14)=0.<a name='3580'>
                      massfln(i,j,nall+15)=0.<a name='3581'>
                      massfln(i,j,nall+16)=0.<a name='3582'>
                endif<a name='3583'>
<a name='3584'>
                   endif<a name='3585'>
 350            continue<a name='3586'>
<font color=#447700>! ne=1, cap=175<a name='3587'></font>
<font color=#447700>!<a name='3588'></font>
                   nall=(iens-1)*maxens3*maxens*maxens2 &amp;<a name='3589'>
                        +(iedt-1)*maxens*maxens3<a name='3590'>
<font color=#447700>! ne=2, cap=100<a name='3591'></font>
<font color=#447700>!<a name='3592'></font>
                   nall2=(iens-1)*maxens3*maxens*maxens2 &amp;<a name='3593'>
                        +(iedt-1)*maxens*maxens3 &amp;<a name='3594'>
                        +(2-1)*maxens3<a name='3595'>
                      xf_ens(i,j,nall+4) = xf_ens(i,j,nall2+4)<a name='3596'>
                      xf_ens(i,j,nall+5) =xf_ens(i,j,nall2+5)<a name='3597'>
                      xf_ens(i,j,nall+6) =xf_ens(i,j,nall2+6)<a name='3598'>
                      xf_ens(i,j,nall+14) =xf_ens(i,j,nall2+14)<a name='3599'>
                      xf_ens(i,j,nall+7) =xf_ens(i,j,nall2+7)<a name='3600'>
                      xf_ens(i,j,nall+8) =xf_ens(i,j,nall2+8)<a name='3601'>
                      xf_ens(i,j,nall+9) =xf_ens(i,j,nall2+9)<a name='3602'>
                      xf_ens(i,j,nall+15) =xf_ens(i,j,nall2+15)<a name='3603'>
                      xf_ens(i,j,nall+10)=xf_ens(i,j,nall2+10)<a name='3604'>
                      xf_ens(i,j,nall+11)=xf_ens(i,j,nall2+11)<a name='3605'>
                      xf_ens(i,j,nall+12)=xf_ens(i,j,nall2+12)<a name='3606'>
                go to 100<a name='3607'>
             endif<a name='3608'>
          elseif(ierr(i).ne.20.and.ierr(i).ne.0)then<a name='3609'>
             do n=1,ensdim<a name='3610'>
               xf_ens(i,j,n)=0.<a name='3611'>
               massfln(i,j,n)=0.<a name='3612'>
             enddo<a name='3613'>
          endif<a name='3614'>
 100   continue<a name='3615'>
<a name='3616'>
   END SUBROUTINE cup_forcing_ens_3d<a name='3617'>
<a name='3618'>
<a name='3619'>
<A NAME='CUP_KBCON'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_KBCON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3620'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_kbcon</font>(cap_inc,iloop,k22,kbcon,he_cup,hes_cup, &amp; <A href='../../call_to/CUP_KBCON.html' TARGET='index'>9</A>,<A href='../../call_from/CUP_KBCON.html' TARGET='index'>1</A><a name='3621'>
              ierr,kbmax,p_cup,cap_max,                         &amp;<a name='3622'>
              itf,jtf,ktf,                        &amp;<a name='3623'>
              its,ite, jts,jte, kts,kte                        )<a name='3624'>
<a name='3625'>
   IMPLICIT NONE<a name='3626'>
<font color=#447700>!<a name='3627'></font>
<a name='3628'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3629'></font>
<a name='3630'>
     integer                                                           &amp;<a name='3631'>
        ,intent (in   )                   ::                           &amp;<a name='3632'>
        itf,jtf,ktf,           &amp;<a name='3633'>
        its,ite, jts,jte, kts,kte<a name='3634'>
  <font color=#447700>! <a name='3635'></font>
  <font color=#447700>! <a name='3636'></font>
  <font color=#447700>! <a name='3637'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3638'></font>
  <font color=#447700>!<a name='3639'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3640'>
        ,intent (in   )                   ::                           &amp;<a name='3641'>
        he_cup,hes_cup,p_cup<a name='3642'>
     real,    dimension (its:ite)                                      &amp;<a name='3643'>
        ,intent (in   )                   ::                           &amp;<a name='3644'>
        cap_max,cap_inc<a name='3645'>
     integer, dimension (its:ite)                                      &amp;<a name='3646'>
        ,intent (in   )                   ::                           &amp;<a name='3647'>
        kbmax<a name='3648'>
     integer, dimension (its:ite)                                      &amp;<a name='3649'>
        ,intent (inout)                   ::                           &amp;<a name='3650'>
        kbcon,k22,ierr<a name='3651'>
     integer                                                           &amp;<a name='3652'>
        ,intent (in   )                   ::                           &amp;<a name='3653'>
        iloop<a name='3654'>
<font color=#447700>!<a name='3655'></font>
<font color=#447700>!  local variables in this routine<a name='3656'></font>
<font color=#447700>!<a name='3657'></font>
<a name='3658'>
     integer                              ::                           &amp;<a name='3659'>
        i,k<a name='3660'>
     real                                 ::                           &amp;<a name='3661'>
        pbcdif,plus,hetest<a name='3662'>
<font color=#447700>!<a name='3663'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='3664'></font>
<font color=#447700>!<a name='3665'></font>
       DO 27 i=its,itf<a name='3666'>
      kbcon(i)=1<a name='3667'>
      IF(ierr(I).ne.0)GO TO 27<a name='3668'>
      KBCON(I)=K22(I)<a name='3669'>
      GO TO 32<a name='3670'>
 31   CONTINUE<a name='3671'>
      KBCON(I)=KBCON(I)+1<a name='3672'>
      IF(KBCON(I).GT.KBMAX(i)+2)THEN<a name='3673'>
         if(iloop.ne.4)ierr(i)=3<a name='3674'>
<font color=#447700>!        if(iloop.lt.4)ierr(i)=997<a name='3675'></font>
        GO TO 27<a name='3676'>
      ENDIF<a name='3677'>
 32   CONTINUE<a name='3678'>
      hetest=HE_cup(I,K22(I))<a name='3679'>
      if(iloop.eq.5)then<a name='3680'>
       do k=1,k22(i)<a name='3681'>
         hetest=max(hetest,he_cup(i,k))<a name='3682'>
       enddo<a name='3683'>
      endif<a name='3684'>
      IF(HETEST.LT.HES_cup(I,KBCON(I)))GO TO 31<a name='3685'>
<a name='3686'>
<font color=#447700>!     cloud base pressure and max moist static energy pressure<a name='3687'></font>
<font color=#447700>!     i.e., the depth (in mb) of the layer of negative buoyancy<a name='3688'></font>
      if(KBCON(I)-K22(I).eq.1)go to 27<a name='3689'>
      if(iloop.eq.5 .and. (KBCON(I)-K22(I)).eq.0)go to 27<a name='3690'>
      PBCDIF=-P_cup(I,KBCON(I))+P_cup(I,K22(I))<a name='3691'>
      plus=max(25.,cap_max(i)-float(iloop-1)*cap_inc(i))<a name='3692'>
      if(iloop.eq.4)plus=cap_max(i)<a name='3693'>
<font color=#447700>!<a name='3694'></font>
<font color=#447700>! for shallow convection, if cap_max is greater than 25, it is the pressure at pbltop<a name='3695'></font>
      if(iloop.eq.5)plus=25.<a name='3696'>
      if(iloop.eq.5.and.cap_max(i).gt.25)pbcdif=-P_cup(I,KBCON(I))+cap_max(i)<a name='3697'>
      IF(PBCDIF.GT.plus)THEN<a name='3698'>
        K22(I)=K22(I)+1<a name='3699'>
        KBCON(I)=K22(I)<a name='3700'>
        GO TO 32<a name='3701'>
      ENDIF<a name='3702'>
 27   CONTINUE<a name='3703'>
<a name='3704'>
   END SUBROUTINE cup_kbcon<a name='3705'>
<a name='3706'>
<a name='3707'>
<A NAME='CUP_KTOP'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_KTOP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3708'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_ktop</font>(ilo,dby,kbcon,ktop,ierr,              &amp; <A href='../../call_to/CUP_KTOP.html' TARGET='index'>3</A><a name='3709'>
              itf,jtf,ktf,                     &amp;<a name='3710'>
              its,ite, jts,jte, kts,kte                     )<a name='3711'>
<a name='3712'>
   IMPLICIT NONE<a name='3713'>
<font color=#447700>!<a name='3714'></font>
<font color=#447700>!  on input<a name='3715'></font>
<font color=#447700>!<a name='3716'></font>
<a name='3717'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3718'></font>
<a name='3719'>
     integer                                                           &amp;<a name='3720'>
        ,intent (in   )                   ::                           &amp;<a name='3721'>
        itf,jtf,ktf,           &amp;<a name='3722'>
        its,ite, jts,jte, kts,kte<a name='3723'>
  <font color=#447700>! dby = buoancy term<a name='3724'></font>
  <font color=#447700>! ktop = cloud top (output)<a name='3725'></font>
  <font color=#447700>! ilo  = flag<a name='3726'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3727'></font>
  <font color=#447700>!<a name='3728'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3729'>
        ,intent (inout)                   ::                           &amp;<a name='3730'>
        dby<a name='3731'>
     integer, dimension (its:ite)                                      &amp;<a name='3732'>
        ,intent (in   )                   ::                           &amp;<a name='3733'>
        kbcon<a name='3734'>
     integer                                                           &amp;<a name='3735'>
        ,intent (in   )                   ::                           &amp;<a name='3736'>
        ilo<a name='3737'>
     integer, dimension (its:ite)                                      &amp;<a name='3738'>
        ,intent (out  )                   ::                           &amp;<a name='3739'>
        ktop<a name='3740'>
     integer, dimension (its:ite)                                      &amp;<a name='3741'>
        ,intent (inout)                   ::                           &amp;<a name='3742'>
        ierr<a name='3743'>
<font color=#447700>!<a name='3744'></font>
<font color=#447700>!  local variables in this routine<a name='3745'></font>
<font color=#447700>!<a name='3746'></font>
<a name='3747'>
     integer                              ::                           &amp;<a name='3748'>
        i,k<a name='3749'>
<font color=#447700>!<a name='3750'></font>
        DO 42 i=its,itf<a name='3751'>
        ktop(i)=1<a name='3752'>
         IF(ierr(I).EQ.0)then<a name='3753'>
          DO 40 K=KBCON(I)+1,ktf-1<a name='3754'>
            IF(DBY(I,K).LE.0.)THEN<a name='3755'>
                KTOP(I)=K-1<a name='3756'>
                GO TO 41<a name='3757'>
             ENDIF<a name='3758'>
  40      CONTINUE<a name='3759'>
          if(ilo.eq.1)ierr(i)=5<a name='3760'>
<font color=#447700>!         if(ilo.eq.2)ierr(i)=998<a name='3761'></font>
          GO TO 42<a name='3762'>
  41     CONTINUE<a name='3763'>
         do k=ktop(i)+1,ktf<a name='3764'>
           dby(i,k)=0.<a name='3765'>
         enddo<a name='3766'>
         if(kbcon(i).eq.ktop(i))then<a name='3767'>
            ierr(i)=55<a name='3768'>
         endif<a name='3769'>
         endif<a name='3770'>
  42     CONTINUE<a name='3771'>
<a name='3772'>
   END SUBROUTINE cup_ktop<a name='3773'>
<a name='3774'>
<a name='3775'>
<A NAME='CUP_MAXIMI'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_MAXIMI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3776'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_MAXIMI</font>(ARRAY,KS,KE,MAXX,ierr,              &amp; <A href='../../call_to/CUP_MAXIMI.html' TARGET='index'>5</A><a name='3777'>
              itf,jtf,ktf,                     &amp;<a name='3778'>
              its,ite, jts,jte, kts,kte                     )<a name='3779'>
<a name='3780'>
   IMPLICIT NONE<a name='3781'>
<font color=#447700>!<a name='3782'></font>
<font color=#447700>!  on input<a name='3783'></font>
<font color=#447700>!<a name='3784'></font>
<a name='3785'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3786'></font>
<a name='3787'>
     integer                                                           &amp;<a name='3788'>
        ,intent (in   )                   ::                           &amp;<a name='3789'>
         itf,jtf,ktf,                                    &amp;<a name='3790'>
         its,ite, jts,jte, kts,kte<a name='3791'>
  <font color=#447700>! array input array<a name='3792'></font>
  <font color=#447700>! x output array with return values<a name='3793'></font>
  <font color=#447700>! kt output array of levels<a name='3794'></font>
  <font color=#447700>! ks,kend  check-range<a name='3795'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3796'>
        ,intent (in   )                   ::                           &amp;<a name='3797'>
         array<a name='3798'>
     integer, dimension (its:ite)                                      &amp;<a name='3799'>
        ,intent (in   )                   ::                           &amp;<a name='3800'>
         ierr,ke<a name='3801'>
     integer                                                           &amp;<a name='3802'>
        ,intent (in   )                   ::                           &amp;<a name='3803'>
         ks<a name='3804'>
     integer, dimension (its:ite)                                      &amp;<a name='3805'>
        ,intent (out  )                   ::                           &amp;<a name='3806'>
         maxx<a name='3807'>
     real,    dimension (its:ite)         ::                           &amp;<a name='3808'>
         x<a name='3809'>
     real                                 ::                           &amp;<a name='3810'>
         xar<a name='3811'>
     integer                              ::                           &amp;<a name='3812'>
         i,k<a name='3813'>
<a name='3814'>
       DO 200 i=its,itf<a name='3815'>
       MAXX(I)=KS<a name='3816'>
       if(ierr(i).eq.0)then<a name='3817'>
      X(I)=ARRAY(I,KS)<a name='3818'>
<font color=#447700>!<a name='3819'></font>
       DO 100 K=KS,KE(i)<a name='3820'>
         XAR=ARRAY(I,K)<a name='3821'>
         IF(XAR.GE.X(I)) THEN<a name='3822'>
            X(I)=XAR<a name='3823'>
            MAXX(I)=K<a name='3824'>
         ENDIF<a name='3825'>
 100  CONTINUE<a name='3826'>
      endif<a name='3827'>
 200  CONTINUE<a name='3828'>
<a name='3829'>
   END SUBROUTINE cup_MAXIMI<a name='3830'>
<a name='3831'>
<a name='3832'>
<A NAME='CUP_MINIMI'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_MINIMI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3833'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_minimi</font>(ARRAY,KS,KEND,KT,ierr,              &amp; <A href='../../call_to/CUP_MINIMI.html' TARGET='index'>6</A><a name='3834'>
              itf,jtf,ktf,                     &amp;<a name='3835'>
              its,ite, jts,jte, kts,kte                     )<a name='3836'>
<a name='3837'>
   IMPLICIT NONE<a name='3838'>
<font color=#447700>!<a name='3839'></font>
<font color=#447700>!  on input<a name='3840'></font>
<font color=#447700>!<a name='3841'></font>
<a name='3842'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3843'></font>
<a name='3844'>
     integer                                                           &amp;<a name='3845'>
        ,intent (in   )                   ::                           &amp;<a name='3846'>
         itf,jtf,ktf,                                    &amp;<a name='3847'>
         its,ite, jts,jte, kts,kte<a name='3848'>
  <font color=#447700>! array input array<a name='3849'></font>
  <font color=#447700>! x output array with return values<a name='3850'></font>
  <font color=#447700>! kt output array of levels<a name='3851'></font>
  <font color=#447700>! ks,kend  check-range<a name='3852'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3853'>
        ,intent (in   )                   ::                           &amp;<a name='3854'>
         array<a name='3855'>
     integer, dimension (its:ite)                                      &amp;<a name='3856'>
        ,intent (in   )                   ::                           &amp;<a name='3857'>
         ierr,ks,kend<a name='3858'>
     integer, dimension (its:ite)                                      &amp;<a name='3859'>
        ,intent (out  )                   ::                           &amp;<a name='3860'>
         kt<a name='3861'>
     real,    dimension (its:ite)         ::                           &amp;<a name='3862'>
         x<a name='3863'>
     integer                              ::                           &amp;<a name='3864'>
         i,k,kstop<a name='3865'>
<a name='3866'>
       DO 200 i=its,itf<a name='3867'>
      KT(I)=KS(I)<a name='3868'>
      if(ierr(i).eq.0)then<a name='3869'>
      X(I)=ARRAY(I,KS(I))<a name='3870'>
       KSTOP=MAX(KS(I)+1,KEND(I))<a name='3871'>
<font color=#447700>!<a name='3872'></font>
       DO 100 K=KS(I)+1,KSTOP<a name='3873'>
         IF(ARRAY(I,K).LT.X(I)) THEN<a name='3874'>
              X(I)=ARRAY(I,K)<a name='3875'>
              KT(I)=K<a name='3876'>
         ENDIF<a name='3877'>
 100  CONTINUE<a name='3878'>
      endif<a name='3879'>
 200  CONTINUE<a name='3880'>
<a name='3881'>
   END SUBROUTINE cup_MINIMI<a name='3882'>
<a name='3883'>
<a name='3884'>
<A NAME='CUP_OUTPUT_ENS_3D'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_OUTPUT_ENS_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3885'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_output_ens_3d</font>(xf_ens,ierr,dellat,dellaq,dellaqc,  &amp; <A href='../../call_to/CUP_OUTPUT_ENS_3D.html' TARGET='index'>2</A>,<A href='../../call_from/CUP_OUTPUT_ENS_3D.html' TARGET='index'>2</A><a name='3886'>
              subt_ens,subq_ens,subt,subq,outtem,outq,outqc,     &amp;<a name='3887'>
              zu,sub_mas,pre,pw,xmb,ktop,                 &amp;<a name='3888'>
              j,name,nx,nx2,iens,ierr2,ierr3,pr_ens,             &amp;<a name='3889'>
              maxens3,ensdim,massfln,                            &amp;<a name='3890'>
              APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                 &amp;<a name='3891'>
              APR_CAPMA,APR_CAPME,APR_CAPMI,closure_n,xland1,    &amp;<a name='3892'>
              itf,jtf,ktf, &amp;<a name='3893'>
              its,ite, jts,jte, kts,kte)<a name='3894'>
<a name='3895'>
   IMPLICIT NONE<a name='3896'>
<font color=#447700>!<a name='3897'></font>
<font color=#447700>!  on input<a name='3898'></font>
<font color=#447700>!<a name='3899'></font>
<a name='3900'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='3901'></font>
<a name='3902'>
     integer                                                           &amp;<a name='3903'>
        ,intent (in   )                   ::                           &amp;<a name='3904'>
        itf,jtf,ktf,           &amp;<a name='3905'>
        its,ite, jts,jte, kts,kte<a name='3906'>
     integer, intent (in   )              ::                           &amp;<a name='3907'>
        j,ensdim,nx,nx2,iens,maxens3<a name='3908'>
  <font color=#447700>! xf_ens = ensemble mass fluxes<a name='3909'></font>
  <font color=#447700>! pr_ens = precipitation ensembles<a name='3910'></font>
  <font color=#447700>! dellat = change of temperature per unit mass flux of cloud ensemble<a name='3911'></font>
  <font color=#447700>! dellaq = change of q per unit mass flux of cloud ensemble<a name='3912'></font>
  <font color=#447700>! dellaqc = change of qc per unit mass flux of cloud ensemble<a name='3913'></font>
  <font color=#447700>! outtem = output temp tendency (per s)<a name='3914'></font>
  <font color=#447700>! outq   = output q tendency (per s)<a name='3915'></font>
  <font color=#447700>! outqc  = output qc tendency (per s)<a name='3916'></font>
  <font color=#447700>! pre    = output precip<a name='3917'></font>
  <font color=#447700>! xmb    = total base mass flux<a name='3918'></font>
  <font color=#447700>! xfac1  = correction factor<a name='3919'></font>
  <font color=#447700>! pw = pw -epsilon*pd (ensemble dependent)<a name='3920'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='3921'></font>
  <font color=#447700>!<a name='3922'></font>
     real,    dimension (its:ite,jts:jte,1:ensdim)                     &amp;<a name='3923'>
        ,intent (inout)                   ::                           &amp;<a name='3924'>
       xf_ens,pr_ens,massfln<a name='3925'>
     real,    dimension (its:ite,jts:jte)                              &amp;<a name='3926'>
        ,intent (inout)                   ::                           &amp;<a name='3927'>
               APR_GR,APR_W,APR_MC,APR_ST,APR_AS,APR_CAPMA,            &amp;<a name='3928'>
               APR_CAPME,APR_CAPMI <a name='3929'>
<a name='3930'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3931'>
        ,intent (out  )                   ::                           &amp;<a name='3932'>
        outtem,outq,outqc,subt,subq,sub_mas<a name='3933'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='3934'>
        ,intent (in  )                   ::                           &amp;<a name='3935'>
        zu<a name='3936'>
     real,    dimension (its:ite)                                      &amp;<a name='3937'>
        ,intent (out  )                   ::                           &amp;<a name='3938'>
        pre,xmb<a name='3939'>
     real,    dimension (its:ite)                                      &amp;<a name='3940'>
        ,intent (inout  )                   ::                           &amp;<a name='3941'>
        closure_n,xland1<a name='3942'>
     real,    dimension (its:ite,kts:kte,1:nx)                     &amp;<a name='3943'>
        ,intent (in   )                   ::                           &amp;<a name='3944'>
       subt_ens,subq_ens,dellat,dellaqc,dellaq,pw<a name='3945'>
     integer, dimension (its:ite)                                      &amp;<a name='3946'>
        ,intent (in   )                   ::                           &amp;<a name='3947'>
        ktop<a name='3948'>
     integer, dimension (its:ite)                                      &amp;<a name='3949'>
        ,intent (inout)                   ::                           &amp;<a name='3950'>
        ierr,ierr2,ierr3<a name='3951'>
<font color=#447700>!<a name='3952'></font>
<font color=#447700>!  local variables in this routine<a name='3953'></font>
<font color=#447700>!<a name='3954'></font>
<a name='3955'>
     integer                              ::                           &amp;<a name='3956'>
        i,k,n,ncount<a name='3957'>
     real                                 ::                           &amp;<a name='3958'>
        outtes,ddtes,dtt,dtq,dtqc,dtpw,tuning,prerate,clos_wei,xmbhelp<a name='3959'>
     real                                 ::                           &amp;<a name='3960'>
        dtts,dtqs<a name='3961'>
     real,    dimension (its:ite)         ::                           &amp;<a name='3962'>
       xfac1,xfac2<a name='3963'>
     real,    dimension (its:ite)::                           &amp;<a name='3964'>
       xmb_ske,xmb_ave,xmb_std,xmb_cur,xmbweight<a name='3965'>
     real,    dimension (its:ite)::                           &amp;<a name='3966'>
       pr_ske,pr_ave,pr_std,pr_cur<a name='3967'>
     real,    dimension (its:ite,jts:jte)::                           &amp;<a name='3968'>
               pr_gr,pr_w,pr_mc,pr_st,pr_as,pr_capma,     &amp;<a name='3969'>
               pr_capme,pr_capmi<a name='3970'>
     real, dimension (5) :: weight,wm,wm1,wm2,wm3<a name='3971'>
     real, dimension (its:ite,5) :: xmb_w<a name='3972'>
<a name='3973'>
<font color=#447700>!<a name='3974'></font>
      character *(*), intent (in)        ::                           &amp;<a name='3975'>
       name<a name='3976'>
<font color=#447700>!<a name='3977'></font>
     weight(1) = -999.  <font color=#447700>!this will turn off weights<a name='3978'></font>
     wm(1)=-999.<a name='3979'>
<a name='3980'>
     tuning=0.<a name='3981'>
<font color=#447700>!<a name='3982'></font>
<font color=#447700>!<a name='3983'></font>
      DO k=kts,ktf<a name='3984'>
      do i=its,itf<a name='3985'>
        outtem(i,k)=0.<a name='3986'>
        outq(i,k)=0.<a name='3987'>
        outqc(i,k)=0.<a name='3988'>
        subt(i,k)=0.<a name='3989'>
        subq(i,k)=0.<a name='3990'>
        sub_mas(i,k)=0.<a name='3991'>
      enddo<a name='3992'>
      enddo<a name='3993'>
      do i=its,itf<a name='3994'>
        pre(i)=0.<a name='3995'>
        xmb(i)=0.<a name='3996'>
         xfac1(i)=0.<a name='3997'>
         xfac2(i)=0.<a name='3998'>
        xmbweight(i)=1.<a name='3999'>
      enddo<a name='4000'>
      do i=its,itf<a name='4001'>
        IF(ierr(i).eq.0)then<a name='4002'>
        do n=(iens-1)*nx*nx2*maxens3+1,iens*nx*nx2*maxens3<a name='4003'>
           if(pr_ens(i,j,n).le.0.)then<a name='4004'>
             xf_ens(i,j,n)=0.<a name='4005'>
           endif<a name='4006'>
        enddo<a name='4007'>
        endif<a name='4008'>
      enddo<a name='4009'>
<font color=#447700>!<a name='4010'></font>
<font color=#447700>!--- calculate ensemble average mass fluxes<a name='4011'></font>
<font color=#447700>!<a name='4012'></font>
       call <A href='../../html_code/phys/module_cu_g3.F.html#MASSFLX_STATS'>massflx_stats</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_OUTPUT_ENS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MASSFLX_STATS_1">(xf_ens,ensdim,nx2,nx,maxens3,      &amp;<a name='4013'>
            xmb_ave,xmb_std,xmb_cur,xmb_ske,j,ierr,1,    &amp;<a name='4014'>
            APR_GR,APR_W,APR_MC,APR_ST,APR_AS,           &amp;<a name='4015'>
            APR_CAPMA,APR_CAPME,APR_CAPMI,               &amp;<a name='4016'>
            pr_gr,pr_w,pr_mc,pr_st,pr_as,                &amp;<a name='4017'>
            pr_capma,pr_capme,pr_capmi,                  &amp;<a name='4018'>
            itf,jtf,ktf,                   &amp;<a name='4019'>
            its,ite, jts,jte, kts,kte                   )<a name='4020'>
       xmb_w=0.<a name='4021'>
       call <A href='../../html_code/phys/module_cu_g3.F.html#MASSFLX_STATS'>massflx_stats</A><A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_OUTPUT_ENS_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MASSFLX_STATS_2">(pr_ens,ensdim,nx2,nx,maxens3,  &amp;<a name='4022'>
            pr_ave,pr_std,pr_cur,pr_ske,j,ierr,2,        &amp;<a name='4023'>
            APR_GR,APR_W,APR_MC,APR_ST,APR_AS,           &amp;<a name='4024'>
            APR_CAPMA,APR_CAPME,APR_CAPMI,               &amp;<a name='4025'>
            pr_gr,pr_w,pr_mc,pr_st,pr_as,                &amp;<a name='4026'>
            pr_capma,pr_capme,pr_capmi,                  &amp;<a name='4027'>
            itf,jtf,ktf,                   &amp;<a name='4028'>
            its,ite, jts,jte, kts,kte                   )<a name='4029'>
<font color=#447700>!<a name='4030'></font>
<font color=#447700>!-- now do feedback<a name='4031'></font>
<font color=#447700>!<a name='4032'></font>
      ddtes=100.<a name='4033'>
      do i=its,itf<a name='4034'>
        if(ierr(i).eq.0)then<a name='4035'>
         if(xmb_ave(i).le.0.)then<a name='4036'>
              ierr(i)=13<a name='4037'>
              xmb_ave(i)=0.<a name='4038'>
         endif<a name='4039'>
         xmb(i)=max(.1*xmb_ave(i),xmb_ave(i)-tuning*xmb_std(i))<a name='4040'>
<font color=#447700>! --- Now use proper count of how many closures were actually<a name='4041'></font>
<font color=#447700>!       used in cup_forcing_ens (including screening of some<a name='4042'></font>
<font color=#447700>!       closures over water) to properly normalize xmb<a name='4043'></font>
           clos_wei=16./max(1.,closure_n(i))<a name='4044'>
           if (xland1(i).lt.0.5)xmb(i)=xmb(i)*clos_wei<a name='4045'>
           if(xmb(i).eq.0.)then<a name='4046'>
              ierr(i)=19<a name='4047'>
           endif<a name='4048'>
           if(xmb(i).gt.100.)then<a name='4049'>
              ierr(i)=19<a name='4050'>
           endif<a name='4051'>
           xfac1(i)=xmb(i)<a name='4052'>
           xfac2(i)=xmb(i)<a name='4053'>
<a name='4054'>
        endif<a name='4055'>
<font color=#447700>!       if(weight(1).lt.-100.)xfac1(i)=xmb_ave(i)<a name='4056'></font>
<font color=#447700>!       if(weight(1).lt.-100.)xfac2(i)=xmb_ave(i)<a name='4057'></font>
      ENDDO<a name='4058'>
      DO k=kts,ktf<a name='4059'>
      do i=its,itf<a name='4060'>
            dtt=0.<a name='4061'>
            dtts=0.<a name='4062'>
            dtq=0.<a name='4063'>
            dtqs=0.<a name='4064'>
            dtqc=0.<a name='4065'>
            dtpw=0.<a name='4066'>
        IF(ierr(i).eq.0.and.k.le.ktop(i))then<a name='4067'>
           do n=1,nx<a name='4068'>
              dtt=dtt+dellat(i,k,n)<a name='4069'>
              dtts=dtts+subt_ens(i,k,n)<a name='4070'>
              dtq=dtq+dellaq(i,k,n)<a name='4071'>
              dtqs=dtqs+subq_ens(i,k,n)<a name='4072'>
              dtqc=dtqc+dellaqc(i,k,n)<a name='4073'>
              dtpw=dtpw+pw(i,k,n)<a name='4074'>
           enddo<a name='4075'>
           OUTTEM(I,K)=XMB(I)*dtt/float(nx)<a name='4076'>
           SUBT(I,K)=XMB(I)*dtts/float(nx)<a name='4077'>
           OUTQ(I,K)=XMB(I)*dtq/float(nx)<a name='4078'>
           SUBQ(I,K)=XMB(I)*dtqs/float(nx)<a name='4079'>
           OUTQC(I,K)=XMB(I)*dtqc/float(nx)<a name='4080'>
           PRE(I)=PRE(I)+XMB(I)*dtpw/float(nx)<a name='4081'>
           sub_mas(i,k)=zu(i,k)*xmb(i)<a name='4082'>
        endif<a name='4083'>
      enddo<a name='4084'>
      enddo<a name='4085'>
<a name='4086'>
      do i=its,itf<a name='4087'>
        if(ierr(i).eq.0)then<a name='4088'>
        do k=(iens-1)*nx*nx2*maxens3+1,iens*nx*nx2*maxens3<a name='4089'>
          massfln(i,j,k)=massfln(i,j,k)*xfac1(i)<a name='4090'>
          xf_ens(i,j,k)=xf_ens(i,j,k)*xfac1(i)<a name='4091'>
        enddo<a name='4092'>
        endif<a name='4093'>
      ENDDO<a name='4094'>
<a name='4095'>
   END SUBROUTINE cup_output_ens_3d<a name='4096'>
<a name='4097'>
<a name='4098'>
<A NAME='CUP_UP_AA0'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_AA0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4099'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_aa0</font>(aa0,z,zu,dby,GAMMA_CUP,t_cup,       &amp; <A href='../../call_to/CUP_UP_AA0.html' TARGET='index'>14</A><a name='4100'>
              kbcon,ktop,ierr,                               &amp;<a name='4101'>
              itf,jtf,ktf,                     &amp;<a name='4102'>
              its,ite, jts,jte, kts,kte                     )<a name='4103'>
<a name='4104'>
   IMPLICIT NONE<a name='4105'>
<font color=#447700>!<a name='4106'></font>
<font color=#447700>!  on input<a name='4107'></font>
<font color=#447700>!<a name='4108'></font>
<a name='4109'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='4110'></font>
<a name='4111'>
     integer                                                           &amp;<a name='4112'>
        ,intent (in   )                   ::                           &amp;<a name='4113'>
        itf,jtf,ktf,                                     &amp;<a name='4114'>
        its,ite, jts,jte, kts,kte<a name='4115'>
  <font color=#447700>! aa0 cloud work function<a name='4116'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='4117'></font>
  <font color=#447700>! t_cup = temperature (Kelvin) on model cloud levels<a name='4118'></font>
  <font color=#447700>! dby = buoancy term<a name='4119'></font>
  <font color=#447700>! zu= normalized updraft mass flux<a name='4120'></font>
  <font color=#447700>! z = heights of model levels <a name='4121'></font>
  <font color=#447700>! ierr error value, maybe modified in this routine<a name='4122'></font>
  <font color=#447700>!<a name='4123'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='4124'>
        ,intent (in   )                   ::                           &amp;<a name='4125'>
        z,zu,gamma_cup,t_cup,dby<a name='4126'>
     integer, dimension (its:ite)                                      &amp;<a name='4127'>
        ,intent (in   )                   ::                           &amp;<a name='4128'>
        kbcon,ktop<a name='4129'>
<font color=#447700>!<a name='4130'></font>
<font color=#447700>! input and output<a name='4131'></font>
<font color=#447700>!<a name='4132'></font>
<a name='4133'>
<a name='4134'>
     integer, dimension (its:ite)                                      &amp;<a name='4135'>
        ,intent (inout)                   ::                           &amp;<a name='4136'>
        ierr<a name='4137'>
     real,    dimension (its:ite)                                      &amp;<a name='4138'>
        ,intent (out  )                   ::                           &amp;<a name='4139'>
        aa0<a name='4140'>
<font color=#447700>!<a name='4141'></font>
<font color=#447700>!  local variables in this routine<a name='4142'></font>
<font color=#447700>!<a name='4143'></font>
<a name='4144'>
     integer                              ::                           &amp;<a name='4145'>
        i,k<a name='4146'>
     real                                 ::                           &amp;<a name='4147'>
        dz,da<a name='4148'>
<font color=#447700>!<a name='4149'></font>
        do i=its,itf<a name='4150'>
         aa0(i)=0.<a name='4151'>
        enddo<a name='4152'>
        DO 100 k=kts+1,ktf<a name='4153'>
        DO 100 i=its,itf<a name='4154'>
         IF(ierr(i).ne.0)GO TO 100<a name='4155'>
         IF(K.LE.KBCON(I))GO TO 100<a name='4156'>
         IF(K.Gt.KTOP(I))GO TO 100<a name='4157'>
         DZ=Z(I,K)-Z(I,K-1)<a name='4158'>
         da=zu(i,k)*DZ*(9.81/(1004.*( &amp;<a name='4159'>
                (T_cup(I,K)))))*DBY(I,K-1)/ &amp;<a name='4160'>
             (1.+GAMMA_CUP(I,K))<a name='4161'>
         IF(K.eq.KTOP(I).and.da.le.0.)go to 100<a name='4162'>
         AA0(I)=AA0(I)+da<a name='4163'>
         if(aa0(i).lt.0.)aa0(i)=0.<a name='4164'>
100     continue<a name='4165'>
<a name='4166'>
   END SUBROUTINE cup_up_aa0<a name='4167'>
<a name='4168'>
<a name='4169'>
<A NAME='CUP_UP_HE'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_HE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4170'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_he</font>(k22,hkb,z_cup,cd,entr,he_cup,hc,     &amp; <A href='../../call_to/CUP_UP_HE.html' TARGET='index'>7</A><a name='4171'>
              kbcon,ierr,dby,he,hes_cup,name,                &amp;<a name='4172'>
              itf,jtf,ktf,                     &amp;<a name='4173'>
              its,ite, jts,jte, kts,kte                     )<a name='4174'>
<a name='4175'>
   IMPLICIT NONE<a name='4176'>
<font color=#447700>!<a name='4177'></font>
<font color=#447700>!  on input<a name='4178'></font>
<font color=#447700>!<a name='4179'></font>
<a name='4180'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='4181'></font>
<a name='4182'>
     integer                                                           &amp;<a name='4183'>
        ,intent (in   )                   ::                           &amp;<a name='4184'>
                                  itf,jtf,ktf,           &amp;<a name='4185'>
                                  its,ite, jts,jte, kts,kte<a name='4186'>
      character *(*), intent (in)        ::                           &amp;<a name='4187'>
       name<a name='4188'>
  <font color=#447700>! hc = cloud moist static energy<a name='4189'></font>
  <font color=#447700>! hkb = moist static energy at originating level<a name='4190'></font>
  <font color=#447700>! he = moist static energy on model levels<a name='4191'></font>
  <font color=#447700>! he_cup = moist static energy on model cloud levels<a name='4192'></font>
  <font color=#447700>! hes_cup = saturation moist static energy on model cloud levels<a name='4193'></font>
  <font color=#447700>! dby = buoancy term<a name='4194'></font>
  <font color=#447700>! cd= detrainment function <a name='4195'></font>
  <font color=#447700>! z_cup = heights of model cloud levels <a name='4196'></font>
  <font color=#447700>! entr = entrainment rate<a name='4197'></font>
  <font color=#447700>!<a name='4198'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='4199'>
        ,intent (in   )                   ::                           &amp;<a name='4200'>
        he,he_cup,hes_cup,z_cup,cd<a name='4201'>
  <font color=#447700>! entr= entrainment rate <a name='4202'></font>
     real                                                              &amp;<a name='4203'>
        ,intent (in   )                   ::                           &amp;<a name='4204'>
        entr<a name='4205'>
     integer, dimension (its:ite)                                      &amp;<a name='4206'>
        ,intent (in   )                   ::                           &amp;<a name='4207'>
        kbcon,k22<a name='4208'>
<font color=#447700>!<a name='4209'></font>
<font color=#447700>! input and output<a name='4210'></font>
<font color=#447700>!<a name='4211'></font>
<a name='4212'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='4213'></font>
<a name='4214'>
     integer, dimension (its:ite)                                      &amp;<a name='4215'>
        ,intent (inout)                   ::                           &amp;<a name='4216'>
        ierr<a name='4217'>
<a name='4218'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='4219'>
        ,intent (out  )                   ::                           &amp;<a name='4220'>
        hc,dby<a name='4221'>
     real,    dimension (its:ite)                                      &amp;<a name='4222'>
        ,intent (out  )                   ::                           &amp;<a name='4223'>
        hkb<a name='4224'>
<font color=#447700>!<a name='4225'></font>
<font color=#447700>!  local variables in this routine<a name='4226'></font>
<font color=#447700>!<a name='4227'></font>
<a name='4228'>
     integer                              ::                           &amp;<a name='4229'>
        i,k<a name='4230'>
     real                                 ::                           &amp;<a name='4231'>
        dz<a name='4232'>
<font color=#447700>!<a name='4233'></font>
<font color=#447700>!--- moist static energy inside cloud<a name='4234'></font>
<font color=#447700>!<a name='4235'></font>
      do k=kts,ktf<a name='4236'>
      do i=its,itf<a name='4237'>
         hc(i,k)=0.<a name='4238'>
         DBY(I,K)=0.<a name='4239'>
      enddo<a name='4240'>
      enddo<a name='4241'>
      do i=its,itf<a name='4242'>
         hkb(i)=0.<a name='4243'>
      enddo<a name='4244'>
      do i=its,itf<a name='4245'>
        if(ierr(i).eq.0.)then<a name='4246'>
          hkb(i)=he_cup(i,k22(i))<a name='4247'>
          if(name.eq.'shallow')then<a name='4248'>
             do k=1,k22(i)<a name='4249'>
               hkb(i)=max(hkb(i),he_cup(i,k))<a name='4250'>
             enddo<a name='4251'>
          endif<a name='4252'>
          do k=1,k22(i)<a name='4253'>
              hc(i,k)=he_cup(i,k)<a name='4254'>
          enddo<a name='4255'>
          do k=k22(i),kbcon(i)-1<a name='4256'>
              hc(i,k)=hkb(i)<a name='4257'>
          enddo<a name='4258'>
          k=kbcon(i)<a name='4259'>
          hc(i,k)=hkb(i)<a name='4260'>
          DBY(I,Kbcon(i))=Hkb(I)-HES_cup(I,K)<a name='4261'>
        endif<a name='4262'>
      enddo<a name='4263'>
      do k=kts+1,ktf<a name='4264'>
      do i=its,itf<a name='4265'>
        if(k.gt.kbcon(i).and.ierr(i).eq.0.)then<a name='4266'>
           DZ=Z_cup(i,K)-Z_cup(i,K-1)<a name='4267'>
           HC(i,K)=(HC(i,K-1)*(1.-.5*CD(i,K)*DZ)+entr* &amp;<a name='4268'>
                DZ*HE(i,K-1))/(1.+entr*DZ-.5*cd(i,k)*dz)<a name='4269'>
           DBY(I,K)=HC(I,K)-HES_cup(I,K)<a name='4270'>
        endif<a name='4271'>
      enddo<a name='4272'>
<a name='4273'>
      enddo<a name='4274'>
<a name='4275'>
   END SUBROUTINE cup_up_he<a name='4276'>
<a name='4277'>
<a name='4278'>
<A NAME='CUP_UP_MOISTURE'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_MOISTURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4279'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_moisture</font>(name,ierr,z_cup,qc,qrc,pw,pwav,     &amp; <A href='../../call_to/CUP_UP_MOISTURE.html' TARGET='index'>6</A>,<A href='../../call_from/CUP_UP_MOISTURE.html' TARGET='index'>1</A><a name='4280'>
              kbcon,ktop,cd,dby,mentr_rate,clw_all,                  &amp;<a name='4281'>
              q,GAMMA_cup,zu,qes_cup,k22,qe_cup,xl,          &amp;<a name='4282'>
              itf,jtf,ktf,                     &amp;<a name='4283'>
              its,ite, jts,jte, kts,kte                     )<a name='4284'>
<a name='4285'>
   IMPLICIT NONE<a name='4286'>
<font color=#447700>!<a name='4287'></font>
<font color=#447700>!  on input<a name='4288'></font>
<font color=#447700>!<a name='4289'></font>
<a name='4290'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='4291'></font>
<a name='4292'>
     integer                                                           &amp;<a name='4293'>
        ,intent (in   )                   ::                           &amp;<a name='4294'>
                                  itf,jtf,ktf,           &amp;<a name='4295'>
                                  its,ite, jts,jte, kts,kte<a name='4296'>
  <font color=#447700>! cd= detrainment function <a name='4297'></font>
  <font color=#447700>! q = environmental q on model levels<a name='4298'></font>
  <font color=#447700>! qe_cup = environmental q on model cloud levels<a name='4299'></font>
  <font color=#447700>! qes_cup = saturation q on model cloud levels<a name='4300'></font>
  <font color=#447700>! dby = buoancy term<a name='4301'></font>
  <font color=#447700>! cd= detrainment function <a name='4302'></font>
  <font color=#447700>! zu = normalized updraft mass flux<a name='4303'></font>
  <font color=#447700>! gamma_cup = gamma on model cloud levels<a name='4304'></font>
  <font color=#447700>! mentr_rate = entrainment rate<a name='4305'></font>
  <font color=#447700>!<a name='4306'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='4307'>
        ,intent (in   )                   ::                           &amp;<a name='4308'>
        q,zu,gamma_cup,qe_cup,dby,qes_cup,z_cup,cd<a name='4309'>
  <font color=#447700>! entr= entrainment rate <a name='4310'></font>
     real                                                              &amp;<a name='4311'>
        ,intent (in   )                   ::                           &amp;<a name='4312'>
        mentr_rate,xl<a name='4313'>
     integer, dimension (its:ite)                                      &amp;<a name='4314'>
        ,intent (in   )                   ::                           &amp;<a name='4315'>
        kbcon,ktop,k22<a name='4316'>
<font color=#447700>!<a name='4317'></font>
<font color=#447700>! input and output<a name='4318'></font>
<font color=#447700>!<a name='4319'></font>
<a name='4320'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='4321'></font>
<a name='4322'>
     integer, dimension (its:ite)                                      &amp;<a name='4323'>
        ,intent (inout)                   ::                           &amp;<a name='4324'>
        ierr<a name='4325'>
      character *(*), intent (in)        ::                           &amp;<a name='4326'>
       name<a name='4327'>
   <font color=#447700>! qc = cloud q (including liquid water) after entrainment<a name='4328'></font>
   <font color=#447700>! qrch = saturation q in cloud<a name='4329'></font>
   <font color=#447700>! qrc = liquid water content in cloud after rainout<a name='4330'></font>
   <font color=#447700>! pw = condensate that will fall out at that level<a name='4331'></font>
   <font color=#447700>! pwav = totan normalized integrated condensate (I1)<a name='4332'></font>
   <font color=#447700>! c0 = conversion rate (cloud to rain)<a name='4333'></font>
<a name='4334'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='4335'>
        ,intent (out  )                   ::                           &amp;<a name='4336'>
        qc,qrc,pw,clw_all<a name='4337'>
     real,    dimension (its:ite)                                      &amp;<a name='4338'>
        ,intent (out  )                   ::                           &amp;<a name='4339'>
        pwav<a name='4340'>
<font color=#447700>!<a name='4341'></font>
<font color=#447700>!  local variables in this routine<a name='4342'></font>
<font color=#447700>!<a name='4343'></font>
<a name='4344'>
     integer                              ::                           &amp;<a name='4345'>
        iall,i,k<a name='4346'>
     real                                 ::                           &amp;<a name='4347'>
        dh,qrch,c0,dz,radius<a name='4348'>
<font color=#447700>!<a name='4349'></font>
        iall=0<a name='4350'>
        c0=.002<a name='4351'>
<font color=#447700>!<a name='4352'></font>
<font color=#447700>!--- no precip for small clouds<a name='4353'></font>
<font color=#447700>!<a name='4354'></font>
        if(name.eq.'shallow')c0=0.<a name='4355'>
        do i=its,itf<a name='4356'>
          pwav(i)=0.<a name='4357'>
        enddo<a name='4358'>
        do k=kts,ktf<a name='4359'>
        do i=its,itf<a name='4360'>
          pw(i,k)=0.<a name='4361'>
          qc(i,k)=0.<a name='4362'>
          if(ierr(i).eq.0)qc(i,k)=qes_cup(i,k)<a name='4363'>
          clw_all(i,k)=0.<a name='4364'>
          qrc(i,k)=0.<a name='4365'>
        enddo<a name='4366'>
        enddo<a name='4367'>
      do i=its,itf<a name='4368'>
      if(ierr(i).eq.0.)then<a name='4369'>
      do k=k22(i),kbcon(i)-1<a name='4370'>
        qc(i,k)=qe_cup(i,k22(i))<a name='4371'>
      enddo<a name='4372'>
      endif<a name='4373'>
      enddo<a name='4374'>
<a name='4375'>
        DO 100 k=kts+1,ktf<a name='4376'>
        DO 100 i=its,itf<a name='4377'>
         IF(ierr(i).ne.0)GO TO 100<a name='4378'>
         IF(K.Lt.KBCON(I))GO TO 100<a name='4379'>
         IF(K.Gt.KTOP(I))GO TO 100<a name='4380'>
         DZ=Z_cup(i,K)-Z_cup(i,K-1)<a name='4381'>
<font color=#447700>!<a name='4382'></font>
<font color=#447700>!------    1. steady state plume equation, for what could<a name='4383'></font>
<font color=#447700>!------       be in cloud without condensation<a name='4384'></font>
<font color=#447700>!<a name='4385'></font>
<font color=#447700>!<a name='4386'></font>
        QC(i,K)=(QC(i,K-1)*(1.-.5*CD(i,K)*DZ)+mentr_rate* &amp;<a name='4387'>
                DZ*Q(i,K-1))/(1.+mentr_rate*DZ-.5*cd(i,k)*dz)<a name='4388'>
<font color=#447700>!<a name='4389'></font>
<font color=#447700>!--- saturation  in cloud, this is what is allowed to be in it<a name='4390'></font>
<font color=#447700>!<a name='4391'></font>
         QRCH=QES_cup(I,K)+(1./XL)*(GAMMA_cup(i,k) &amp;<a name='4392'>
              /(1.+GAMMA_cup(i,k)))*DBY(I,K)<a name='4393'>
<font color=#447700>!<a name='4394'></font>
<font color=#447700>!------- LIQUID WATER CONTENT IN cloud after rainout<a name='4395'></font>
<font color=#447700>!<a name='4396'></font>
        clw_all(i,k)=QC(I,K)-QRCH<a name='4397'>
        QRC(I,K)=(QC(I,K)-QRCH)/(1.+C0*DZ*zu(i,k))<a name='4398'>
        if(qrc(i,k).lt.0.)then<a name='4399'>
          qrc(i,k)=0.<a name='4400'>
        endif<a name='4401'>
<font color=#447700>!<a name='4402'></font>
<font color=#447700>!-------   3.Condensation<a name='4403'></font>
<font color=#447700>!<a name='4404'></font>
         PW(i,k)=c0*dz*QRC(I,K)*zu(i,k)<a name='4405'>
        if(iall.eq.1)then<a name='4406'>
          qrc(i,k)=0.<a name='4407'>
          pw(i,k)=(QC(I,K)-QRCH)*zu(i,k)<a name='4408'>
          if(pw(i,k).lt.0.)pw(i,k)=0.<a name='4409'>
        endif<a name='4410'>
<font color=#447700>!<a name='4411'></font>
<font color=#447700>!----- set next level<a name='4412'></font>
<font color=#447700>!<a name='4413'></font>
         QC(I,K)=QRC(I,K)+qrch<a name='4414'>
<font color=#447700>!<a name='4415'></font>
<font color=#447700>!--- integrated normalized ondensate<a name='4416'></font>
<font color=#447700>!<a name='4417'></font>
         PWAV(I)=PWAV(I)+PW(I,K)<a name='4418'>
 100     CONTINUE<a name='4419'>
<a name='4420'>
   END SUBROUTINE cup_up_moisture<a name='4421'>
<a name='4422'>
<a name='4423'>
<A NAME='CUP_UP_NMS'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_NMS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4424'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_up_nms</font>(zu,z_cup,entr,cd,kbcon,ktop,ierr,k22,  &amp; <A href='../../call_to/CUP_UP_NMS.html' TARGET='index'>7</A><a name='4425'>
              itf,jtf,ktf,                        &amp;<a name='4426'>
              its,ite, jts,jte, kts,kte                        )<a name='4427'>
<a name='4428'>
   IMPLICIT NONE<a name='4429'>
<a name='4430'>
<font color=#447700>!<a name='4431'></font>
<font color=#447700>!  on input<a name='4432'></font>
<font color=#447700>!<a name='4433'></font>
<a name='4434'>
   <font color=#447700>! only local wrf dimensions are need as of now in this routine<a name='4435'></font>
<a name='4436'>
     integer                                                           &amp;<a name='4437'>
        ,intent (in   )                   ::                           &amp;<a name='4438'>
         itf,jtf,ktf,                                    &amp;<a name='4439'>
         its,ite, jts,jte, kts,kte<a name='4440'>
  <font color=#447700>! cd= detrainment function <a name='4441'></font>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='4442'>
        ,intent (in   )                   ::                           &amp;<a name='4443'>
         z_cup,cd<a name='4444'>
  <font color=#447700>! entr= entrainment rate <a name='4445'></font>
     real                                                              &amp;<a name='4446'>
        ,intent (in   )                   ::                           &amp;<a name='4447'>
         entr<a name='4448'>
     integer, dimension (its:ite)                                      &amp;<a name='4449'>
        ,intent (in   )                   ::                           &amp;<a name='4450'>
         kbcon,ktop,k22<a name='4451'>
<font color=#447700>!<a name='4452'></font>
<font color=#447700>! input and output<a name='4453'></font>
<font color=#447700>!<a name='4454'></font>
<a name='4455'>
   <font color=#447700>! ierr error value, maybe modified in this routine<a name='4456'></font>
<a name='4457'>
     integer, dimension (its:ite)                                      &amp;<a name='4458'>
        ,intent (inout)                   ::                           &amp;<a name='4459'>
         ierr<a name='4460'>
   <font color=#447700>! zu is the normalized mass flux<a name='4461'></font>
<a name='4462'>
     real,    dimension (its:ite,kts:kte)                              &amp;<a name='4463'>
        ,intent (out  )                   ::                           &amp;<a name='4464'>
         zu<a name='4465'>
<font color=#447700>!<a name='4466'></font>
<font color=#447700>!  local variables in this routine<a name='4467'></font>
<font color=#447700>!<a name='4468'></font>
<a name='4469'>
     integer                              ::                           &amp;<a name='4470'>
         i,k<a name='4471'>
     real                                 ::                           &amp;<a name='4472'>
         dz<a name='4473'>
<font color=#447700>!<a name='4474'></font>
<font color=#447700>!   initialize for this go around<a name='4475'></font>
<font color=#447700>!<a name='4476'></font>
       do k=kts,ktf<a name='4477'>
       do i=its,itf<a name='4478'>
         zu(i,k)=0.<a name='4479'>
       enddo<a name='4480'>
       enddo<a name='4481'>
<font color=#447700>!<a name='4482'></font>
<font color=#447700>! do normalized mass budget<a name='4483'></font>
<font color=#447700>!<a name='4484'></font>
       do i=its,itf<a name='4485'>
          IF(ierr(I).eq.0)then<a name='4486'>
             do k=k22(i),kbcon(i)<a name='4487'>
               zu(i,k)=1.<a name='4488'>
             enddo<a name='4489'>
             DO K=KBcon(i)+1,KTOP(i)<a name='4490'>
               DZ=Z_cup(i,K)-Z_cup(i,K-1)<a name='4491'>
               ZU(i,K)=ZU(i,K-1)*(1.+(entr-cd(i,k))*DZ)<a name='4492'>
             enddo<a name='4493'>
          endif<a name='4494'>
       enddo<a name='4495'>
<a name='4496'>
   END SUBROUTINE cup_up_nms<a name='4497'>
<a name='4498'>
<font color=#447700>!====================================================================<a name='4499'></font>
<A NAME='G3INIT'><A href='../../html_code/phys/module_cu_g3.F.html#G3INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4500'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>g3init</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQICUTEN,           &amp; <A href='../../call_to/G3INIT.html' TARGET='index'>1</A><a name='4501'>
                        MASS_FLUX,cp,restart,                       &amp;<a name='4502'>
                        P_QC,P_QI,P_FIRST_SCALAR,                   &amp;<a name='4503'>
                        RTHFTEN, RQVFTEN,                           &amp;<a name='4504'>
                        APR_GR,APR_W,APR_MC,APR_ST,APR_AS,          &amp;<a name='4505'>
                        APR_CAPMA,APR_CAPME,APR_CAPMI,              &amp;<a name='4506'>
                        cugd_tten,cugd_ttens,cugd_qvten,            &amp;<a name='4507'>
                        cugd_qvtens,cugd_qcten,                     &amp;<a name='4508'>
                        allowed_to_read,                            &amp;<a name='4509'>
                        ids, ide, jds, jde, kds, kde,               &amp;<a name='4510'>
                        ims, ime, jms, jme, kms, kme,               &amp;<a name='4511'>
                        its, ite, jts, jte, kts, kte               )<a name='4512'>
<font color=#447700>!--------------------------------------------------------------------   <a name='4513'></font>
   IMPLICIT NONE<a name='4514'>
<font color=#447700>!--------------------------------------------------------------------<a name='4515'></font>
   LOGICAL , INTENT(IN)           ::  restart,allowed_to_read<a name='4516'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='4517'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='4518'>
                                      its, ite, jts, jte, kts, kte<a name='4519'>
   INTEGER , INTENT(IN)           ::  P_FIRST_SCALAR, P_QI, P_QC<a name='4520'>
   REAL,     INTENT(IN)           ::  cp<a name='4521'>
<a name='4522'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='4523'>
                                                          CUGD_TTEN,         &amp;<a name='4524'>
                                                          CUGD_TTENS,        &amp;<a name='4525'>
                                                          CUGD_QVTEN,        &amp;<a name='4526'>
                                                          CUGD_QVTENS,       &amp;<a name='4527'>
                                                          CUGD_QCTEN<a name='4528'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='4529'>
                                                          RTHCUTEN, &amp;<a name='4530'>
                                                          RQVCUTEN, &amp;<a name='4531'>
                                                          RQCCUTEN, &amp;<a name='4532'>
                                                          RQICUTEN   <a name='4533'>
<a name='4534'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='4535'>
                                                          RTHFTEN,  &amp;<a name='4536'>
                                                          RQVFTEN<a name='4537'>
<a name='4538'>
   REAL,     DIMENSION( ims:ime , jms:jme ) , INTENT(OUT) ::        &amp;<a name='4539'>
                                APR_GR,APR_W,APR_MC,APR_ST,APR_AS,  &amp;<a name='4540'>
                                APR_CAPMA,APR_CAPME,APR_CAPMI,      &amp;<a name='4541'>
                                MASS_FLUX<a name='4542'>
<a name='4543'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4544'>
 <a name='4545'>
   jtf=min0(jte,jde-1)<a name='4546'>
   ktf=min0(kte,kde-1)<a name='4547'>
   itf=min0(ite,ide-1)<a name='4548'>
 <a name='4549'>
   IF(.not.restart)THEN<a name='4550'>
     DO j=jts,jte<a name='4551'>
     DO k=kts,kte<a name='4552'>
     DO i=its,ite<a name='4553'>
        RTHCUTEN(i,k,j)=0.<a name='4554'>
        RQVCUTEN(i,k,j)=0.<a name='4555'>
     ENDDO<a name='4556'>
     ENDDO<a name='4557'>
     ENDDO<a name='4558'>
     DO j=jts,jte<a name='4559'>
     DO k=kts,kte<a name='4560'>
     DO i=its,ite<a name='4561'>
       cugd_tten(i,k,j)=0.<a name='4562'>
       cugd_ttens(i,k,j)=0.<a name='4563'>
       cugd_qvten(i,k,j)=0.<a name='4564'>
       cugd_qvtens(i,k,j)=0.<a name='4565'>
     ENDDO<a name='4566'>
     ENDDO<a name='4567'>
     ENDDO<a name='4568'>
<a name='4569'>
     DO j=jts,jtf<a name='4570'>
     DO k=kts,ktf<a name='4571'>
     DO i=its,itf<a name='4572'>
        RTHFTEN(i,k,j)=0.<a name='4573'>
        RQVFTEN(i,k,j)=0.<a name='4574'>
     ENDDO<a name='4575'>
     ENDDO<a name='4576'>
     ENDDO<a name='4577'>
<a name='4578'>
     IF (P_QC .ge. P_FIRST_SCALAR) THEN<a name='4579'>
        DO j=jts,jtf<a name='4580'>
        DO k=kts,ktf<a name='4581'>
        DO i=its,itf<a name='4582'>
           RQCCUTEN(i,k,j)=0.<a name='4583'>
           cugd_qcten(i,k,j)=0.<a name='4584'>
        ENDDO<a name='4585'>
        ENDDO<a name='4586'>
        ENDDO<a name='4587'>
     ENDIF<a name='4588'>
<a name='4589'>
     IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='4590'>
        DO j=jts,jtf<a name='4591'>
        DO k=kts,ktf<a name='4592'>
        DO i=its,itf<a name='4593'>
           RQICUTEN(i,k,j)=0.<a name='4594'>
        ENDDO<a name='4595'>
        ENDDO<a name='4596'>
        ENDDO<a name='4597'>
     ENDIF<a name='4598'>
<a name='4599'>
     DO j=jts,jtf<a name='4600'>
     DO i=its,itf<a name='4601'>
        mass_flux(i,j)=0.<a name='4602'>
     ENDDO<a name='4603'>
     ENDDO<a name='4604'>
<a name='4605'>
     DO j=jts,jtf<a name='4606'>
     DO i=its,itf<a name='4607'>
        APR_GR(i,j)=0.<a name='4608'>
        APR_ST(i,j)=0.<a name='4609'>
        APR_W(i,j)=0.<a name='4610'>
        APR_MC(i,j)=0.<a name='4611'>
        APR_AS(i,j)=0.<a name='4612'>
        APR_CAPMA(i,j)=0.<a name='4613'>
        APR_CAPME(i,j)=0.<a name='4614'>
        APR_CAPMI(i,j)=0.<a name='4615'>
     ENDDO<a name='4616'>
     ENDDO<a name='4617'>
<a name='4618'>
   ENDIF<a name='4619'>
<a name='4620'>
   END SUBROUTINE g3init<a name='4621'>
<a name='4622'>
<a name='4623'>
<A NAME='MASSFLX_STATS'><A href='../../html_code/phys/module_cu_g3.F.html#MASSFLX_STATS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4624'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>massflx_stats</font>(xf_ens,ensdim,maxens,maxens2,maxens3, &amp; <A href='../../call_to/MASSFLX_STATS.html' TARGET='index'>2</A><a name='4625'>
              xt_ave,xt_std,xt_cur,xt_ske,j,ierr,itest,           &amp;<a name='4626'>
              APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                  &amp;<a name='4627'>
              APR_CAPMA,APR_CAPME,APR_CAPMI,                      &amp;<a name='4628'>
              pr_gr,pr_w,pr_mc,pr_st,pr_as,                       &amp;<a name='4629'>
              pr_capma,pr_capme,pr_capmi,                         &amp;<a name='4630'>
              itf,jtf,ktf,  &amp;<a name='4631'>
              its,ite, jts,jte, kts,kte)<a name='4632'>
<a name='4633'>
   IMPLICIT NONE<a name='4634'>
<a name='4635'>
   integer, intent (in   )              ::                                    &amp;<a name='4636'>
                     j,ensdim,maxens3,maxens,maxens2,itest<a name='4637'>
   INTEGER,      INTENT(IN   ) ::                                             &amp;<a name='4638'>
                                  itf,jtf,ktf,                  &amp;<a name='4639'>
                                  its,ite, jts,jte, kts,kte<a name='4640'>
<a name='4641'>
<a name='4642'>
     real, dimension (its:ite)                                                &amp;<a name='4643'>
         , intent(inout) ::                                                   &amp;<a name='4644'>
           xt_ave,xt_cur,xt_std,xt_ske<a name='4645'>
     integer, dimension (its:ite), intent (in) ::                             &amp;<a name='4646'>
           ierr<a name='4647'>
     real, dimension (its:ite,jts:jte,1:ensdim)                               &amp;<a name='4648'>
         , intent(in   ) ::                                                   &amp;<a name='4649'>
           xf_ens<a name='4650'>
     real, dimension (its:ite,jts:jte)                                        &amp;<a name='4651'>
         , intent(inout) ::                                                   &amp;<a name='4652'>
           APR_GR,APR_W,APR_MC,APR_ST,APR_AS,                                 &amp;<a name='4653'>
           APR_CAPMA,APR_CAPME,APR_CAPMI<a name='4654'>
     real, dimension (its:ite,jts:jte)                                        &amp;<a name='4655'>
         , intent(inout) ::                                                   &amp;<a name='4656'>
           pr_gr,pr_w,pr_mc,pr_st,pr_as,                                      &amp;<a name='4657'>
           pr_capma,pr_capme,pr_capmi<a name='4658'>
<a name='4659'>
<font color=#447700>!<a name='4660'></font>
<font color=#447700>! local stuff<a name='4661'></font>
<font color=#447700>!<a name='4662'></font>
     real, dimension (its:ite , 1:maxens3 )       ::                          &amp;<a name='4663'>
           x_ave,x_cur,x_std,x_ske<a name='4664'>
     real, dimension (its:ite , 1:maxens  )       ::                          &amp;<a name='4665'>
           x_ave_cap<a name='4666'>
<a name='4667'>
<a name='4668'>
      integer, dimension (1:maxens3) :: nc1<a name='4669'>
      integer :: i,k<a name='4670'>
      integer :: num,kk,num2,iedt<a name='4671'>
      real :: a3,a4<a name='4672'>
<a name='4673'>
      num=ensdim/maxens3<a name='4674'>
      num2=ensdim/maxens<a name='4675'>
      if(itest.eq.1)then<a name='4676'>
      do i=its,ite<a name='4677'>
       pr_gr(i,j) =  0.<a name='4678'>
       pr_w(i,j) =  0.<a name='4679'>
       pr_mc(i,j) = 0.<a name='4680'>
       pr_st(i,j) = 0.<a name='4681'>
       pr_as(i,j) = 0.<a name='4682'>
       pr_capma(i,j) =  0.<a name='4683'>
       pr_capme(i,j) = 0.<a name='4684'>
       pr_capmi(i,j) = 0.<a name='4685'>
      enddo<a name='4686'>
      endif<a name='4687'>
<a name='4688'>
      do k=1,maxens<a name='4689'>
      do i=its,ite<a name='4690'>
        x_ave_cap(i,k)=0.<a name='4691'>
      enddo<a name='4692'>
      enddo<a name='4693'>
      do k=1,maxens3<a name='4694'>
      do i=its,ite<a name='4695'>
        x_ave(i,k)=0.<a name='4696'>
        x_std(i,k)=0.<a name='4697'>
        x_ske(i,k)=0.<a name='4698'>
        x_cur(i,k)=0.<a name='4699'>
      enddo<a name='4700'>
      enddo<a name='4701'>
      do i=its,ite<a name='4702'>
        xt_ave(i)=0.<a name='4703'>
        xt_std(i)=0.<a name='4704'>
        xt_ske(i)=0.<a name='4705'>
        xt_cur(i)=0.<a name='4706'>
      enddo<a name='4707'>
      do kk=1,num<a name='4708'>
      do k=1,maxens3<a name='4709'>
      do i=its,ite<a name='4710'>
        if(ierr(i).eq.0)then<a name='4711'>
        x_ave(i,k)=x_ave(i,k)+xf_ens(i,j,maxens3*(kk-1)+k)<a name='4712'>
        endif<a name='4713'>
      enddo<a name='4714'>
      enddo<a name='4715'>
      enddo<a name='4716'>
      do iedt=1,maxens2<a name='4717'>
      do k=1,maxens<a name='4718'>
      do kk=1,maxens3<a name='4719'>
      do i=its,ite<a name='4720'>
        if(ierr(i).eq.0)then<a name='4721'>
        x_ave_cap(i,k)=x_ave_cap(i,k)                               &amp;<a name='4722'>
            +xf_ens(i,j,maxens3*(k-1)+(iedt-1)*maxens*maxens3+kk)<a name='4723'>
        endif<a name='4724'>
      enddo<a name='4725'>
      enddo<a name='4726'>
      enddo<a name='4727'>
      enddo<a name='4728'>
      do k=1,maxens<a name='4729'>
      do i=its,ite<a name='4730'>
        if(ierr(i).eq.0)then<a name='4731'>
        x_ave_cap(i,k)=x_ave_cap(i,k)/float(num2)<a name='4732'>
        endif<a name='4733'>
      enddo<a name='4734'>
      enddo<a name='4735'>
<a name='4736'>
      do k=1,maxens3<a name='4737'>
      do i=its,ite<a name='4738'>
        if(ierr(i).eq.0)then<a name='4739'>
        x_ave(i,k)=x_ave(i,k)/float(num)<a name='4740'>
        endif<a name='4741'>
      enddo<a name='4742'>
      enddo<a name='4743'>
      do k=1,maxens3<a name='4744'>
      do i=its,ite<a name='4745'>
        if(ierr(i).eq.0)then<a name='4746'>
        xt_ave(i)=xt_ave(i)+x_ave(i,k)<a name='4747'>
        endif<a name='4748'>
      enddo<a name='4749'>
      enddo<a name='4750'>
      do i=its,ite<a name='4751'>
        if(ierr(i).eq.0)then<a name='4752'>
        xt_ave(i)=xt_ave(i)/float(maxens3)<a name='4753'>
        endif<a name='4754'>
      enddo<a name='4755'>
<font color=#447700>!<a name='4756'></font>
<font color=#447700>!--- now do std, skewness,curtosis<a name='4757'></font>
<font color=#447700>!<a name='4758'></font>
      do kk=1,num<a name='4759'>
      do k=1,maxens3<a name='4760'>
      do i=its,ite<a name='4761'>
        if(ierr(i).eq.0.and.x_ave(i,k).gt.0.)then<a name='4762'>
<font color=#447700>!       print *,i,j,k,kk,x_std(i,k),xf_ens(i,j,maxens3*(kk-1)+k),x_ave(i,k)<a name='4763'></font>
        x_std(i,k)=x_std(i,k)+(xf_ens(i,j,maxens3*(kk-1)+k)-x_ave(i,k))**2<a name='4764'>
        x_ske(i,k)=x_ske(i,k)+(xf_ens(i,j,maxens3*(kk-1)+k)-x_ave(i,k))**3<a name='4765'>
        x_cur(i,k)=x_cur(i,k)+(xf_ens(i,j,maxens3*(kk-1)+k)-x_ave(i,k))**4<a name='4766'>
        endif<a name='4767'>
      enddo<a name='4768'>
      enddo<a name='4769'>
      enddo<a name='4770'>
      do k=1,maxens3<a name='4771'>
      do i=its,ite<a name='4772'>
        if(ierr(i).eq.0.and.xt_ave(i).gt.0.)then<a name='4773'>
        xt_std(i)=xt_std(i)+(x_ave(i,k)-xt_ave(i))**2<a name='4774'>
        xt_ske(i)=xt_ske(i)+(x_ave(i,k)-xt_ave(i))**3<a name='4775'>
        xt_cur(i)=xt_cur(i)+(x_ave(i,k)-xt_ave(i))**4<a name='4776'>
        endif<a name='4777'>
      enddo<a name='4778'>
      enddo<a name='4779'>
      do k=1,maxens3<a name='4780'>
      do i=its,ite<a name='4781'>
        if(ierr(i).eq.0.and.x_std(i,k).gt.0.)then<a name='4782'>
           x_std(i,k)=x_std(i,k)/float(num)<a name='4783'>
           a3=max(1.e-6,x_std(i,k))<a name='4784'>
           x_std(i,k)=sqrt(a3)<a name='4785'>
           a3=max(1.e-6,x_std(i,k)**3)<a name='4786'>
           a4=max(1.e-6,x_std(i,k)**4)<a name='4787'>
           x_ske(i,k)=x_ske(i,k)/float(num)/a3<a name='4788'>
           x_cur(i,k)=x_cur(i,k)/float(num)/a4<a name='4789'>
        endif<a name='4790'>
<font color=#447700>!       print*,'                               '<a name='4791'></font>
<font color=#447700>!       print*,'Some statistics at gridpoint i,j, ierr',i,j,ierr(i)<a name='4792'></font>
<font color=#447700>!       print*,'statistics for closure number ',k<a name='4793'></font>
<font color=#447700>!       print*,'Average= ',x_ave(i,k),'  Std= ',x_std(i,k)<a name='4794'></font>
<font color=#447700>!       print*,'Skewness= ',x_ske(i,k),' Curtosis= ',x_cur(i,k)<a name='4795'></font>
<font color=#447700>!       print*,'                               '<a name='4796'></font>
<a name='4797'>
      enddo<a name='4798'>
      enddo<a name='4799'>
      do i=its,ite<a name='4800'>
        if(ierr(i).eq.0.and.xt_std(i).gt.0.)then<a name='4801'>
           xt_std(i)=xt_std(i)/float(maxens3)<a name='4802'>
           a3=max(1.e-6,xt_std(i))<a name='4803'>
           xt_std(i)=sqrt(a3)<a name='4804'>
           a3=max(1.e-6,xt_std(i)**3)<a name='4805'>
           a4=max(1.e-6,xt_std(i)**4)<a name='4806'>
           xt_ske(i)=xt_ske(i)/float(maxens3)/a3<a name='4807'>
           xt_cur(i)=xt_cur(i)/float(maxens3)/a4<a name='4808'>
<font color=#447700>!       print*,'                               '<a name='4809'></font>
<font color=#447700>!       print*,'Total ensemble independent statistics at i =',i<a name='4810'></font>
<font color=#447700>!       print*,'Average= ',xt_ave(i),'  Std= ',xt_std(i)<a name='4811'></font>
<font color=#447700>!       print*,'Skewness= ',xt_ske(i),' Curtosis= ',xt_cur(i)<a name='4812'></font>
<font color=#447700>!       print*,'                               '<a name='4813'></font>
<font color=#447700>!<a name='4814'></font>
<font color=#447700>!  first go around: store massflx for different closures/caps<a name='4815'></font>
<font color=#447700>!<a name='4816'></font>
      if(itest.eq.1)then<a name='4817'>
       pr_gr(i,j) = .25*(x_ave(i,1)+x_ave(i,2)+x_ave(i,3)+x_ave(i,13))<a name='4818'>
       pr_w(i,j) = .25*(x_ave(i,4)+x_ave(i,5)+x_ave(i,6)+x_ave(i,14))<a name='4819'>
       pr_mc(i,j) = .25*(x_ave(i,7)+x_ave(i,8)+x_ave(i,9)+x_ave(i,15))<a name='4820'>
       pr_st(i,j) = .333*(x_ave(i,10)+x_ave(i,11)+x_ave(i,12))<a name='4821'>
       pr_as(i,j) = x_ave(i,16)<a name='4822'>
       pr_capma(i,j) = x_ave_cap(i,1)<a name='4823'>
       pr_capme(i,j) = x_ave_cap(i,2)<a name='4824'>
       pr_capmi(i,j) = x_ave_cap(i,3)<a name='4825'>
<font color=#447700>!<a name='4826'></font>
<font color=#447700>!  second go around: store preciprates (mm/hour) for different closures/caps<a name='4827'></font>
<font color=#447700>!<a name='4828'></font>
        else if (itest.eq.2)then<a name='4829'>
       APR_GR(i,j)=.25*(x_ave(i,1)+x_ave(i,2)+x_ave(i,3)+x_ave(i,13))*      &amp;<a name='4830'>
                  3600.*pr_gr(i,j) +APR_GR(i,j)<a name='4831'>
       APR_W(i,j)=.25*(x_ave(i,4)+x_ave(i,5)+x_ave(i,6)+x_ave(i,14))*       &amp;<a name='4832'>
                  3600.*pr_w(i,j) +APR_W(i,j)<a name='4833'>
       APR_MC(i,j)=.25*(x_ave(i,7)+x_ave(i,8)+x_ave(i,9)+x_ave(i,15))*      &amp;<a name='4834'>
                  3600.*pr_mc(i,j) +APR_MC(i,j)<a name='4835'>
       APR_ST(i,j)=.333*(x_ave(i,10)+x_ave(i,11)+x_ave(i,12))*   &amp;<a name='4836'>
                  3600.*pr_st(i,j) +APR_ST(i,j)<a name='4837'>
       APR_AS(i,j)=x_ave(i,16)*                       &amp;<a name='4838'>
                  3600.*pr_as(i,j) +APR_AS(i,j)<a name='4839'>
       APR_CAPMA(i,j) = x_ave_cap(i,1)*                          &amp;<a name='4840'>
                  3600.*pr_capma(i,j) +APR_CAPMA(i,j)<a name='4841'>
       APR_CAPME(i,j) = x_ave_cap(i,2)*                          &amp;<a name='4842'>
                  3600.*pr_capme(i,j) +APR_CAPME(i,j)<a name='4843'>
       APR_CAPMI(i,j) = x_ave_cap(i,3)*                          &amp;<a name='4844'>
                  3600.*pr_capmi(i,j) +APR_CAPMI(i,j)<a name='4845'>
        endif<a name='4846'>
        endif<a name='4847'>
      enddo<a name='4848'>
<a name='4849'>
   END SUBROUTINE massflx_stats<a name='4850'>
<a name='4851'>
<A NAME='CUP_AXX'><A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4852'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>cup_axx</font>(tcrit,kbmax,z1,p,psur,xl,rv,cp,tx,qx,axx,ierr,    &amp; <A href='../../call_to/CUP_AXX.html' TARGET='index'>1</A>,<A href='../../call_from/CUP_AXX.html' TARGET='index'>7</A><a name='4853'>
           cap_max,cap_max_increment,entr_rate,mentr_rate,&amp;<a name='4854'>
           j,itf,jtf,ktf, &amp;<a name='4855'>
           its,ite, jts,jte, kts,kte,ens4)<a name='4856'>
   IMPLICIT NONE<a name='4857'>
   INTEGER,      INTENT(IN   ) ::                                             &amp;<a name='4858'>
                                  j,itf,jtf,ktf,                &amp;<a name='4859'>
                                  its,ite, jts,jte, kts,kte,ens4<a name='4860'>
     real, dimension (its:ite,kts:kte,1:ens4)                                 &amp;<a name='4861'>
         , intent(inout) ::                                                   &amp;<a name='4862'>
           tx,qx<a name='4863'>
     real, dimension (its:ite,kts:kte)                                 &amp;<a name='4864'>
         , intent(in) ::                                                   &amp;<a name='4865'>
           p<a name='4866'>
     real, dimension (its:ite)                                 &amp;<a name='4867'>
         , intent(in) ::                                                   &amp;<a name='4868'>
           z1,psur,cap_max,cap_max_increment<a name='4869'>
     real, intent(in) ::                                                   &amp;<a name='4870'>
           tcrit,xl,rv,cp,mentr_rate,entr_rate<a name='4871'>
     real, dimension (its:ite,1:ens4)                                 &amp;<a name='4872'>
         , intent(out) ::                                                   &amp;<a name='4873'>
           axx<a name='4874'>
     integer, dimension (its:ite), intent (in) ::                             &amp;<a name='4875'>
           ierr,kbmax<a name='4876'>
     integer, dimension (its:ite) ::                             &amp;<a name='4877'>
           ierrxx,k22xx,kbconxx,ktopxx,kstabm,kstabi<a name='4878'>
      real, dimension (1:2) :: AE,BE,HT<a name='4879'>
      real, dimension (its:ite,kts:kte) :: tv<a name='4880'>
      real :: e,tvbar<a name='4881'>
     integer n,i,k,iph<a name='4882'>
     real,    dimension (its:ite,kts:kte) ::                           &amp;<a name='4883'>
        he,hes,qes,z,                                                  &amp;<a name='4884'>
        qes_cup,q_cup,he_cup,hes_cup,z_cup,p_cup,gamma_cup,t_cup,      &amp;<a name='4885'>
        tn_cup,                                                        &amp;<a name='4886'>
        dby,qc,qrcd,pwd,pw,hcd,qcd,dbyd,hc,qrc,zu,zd,cd<a name='4887'>
<a name='4888'>
     real,    dimension (its:ite) ::                                   &amp;<a name='4889'>
       AA0,HKB,QKB,          &amp;<a name='4890'>
       PWAV,BU<a name='4891'>
      do n=1,ens4<a name='4892'>
      do i=its,ite<a name='4893'>
       axx(i,n)=0.<a name='4894'>
      enddo<a name='4895'>
      enddo<a name='4896'>
     HT(1)=XL/CP<a name='4897'>
     HT(2)=2.834E6/CP<a name='4898'>
     BE(1)=.622*HT(1)/.286<a name='4899'>
     AE(1)=BE(1)/273.+ALOG(610.71)<a name='4900'>
     BE(2)=.622*HT(2)/.286<a name='4901'>
     AE(2)=BE(2)/273.+ALOG(610.71)<a name='4902'>
<font color=#447700>!<a name='4903'></font>
<font color=#447700>!<a name='4904'></font>
     do 100 n=1,ens4<a name='4905'>
<a name='4906'>
      do k=kts,ktf<a name='4907'>
      do i=its,itf<a name='4908'>
        cd(i,k)=0.1*entr_rate<a name='4909'>
      enddo<a name='4910'>
      enddo<a name='4911'>
<a name='4912'>
<a name='4913'>
      do i=its,itf<a name='4914'>
        ierrxx(i)=ierr(i)<a name='4915'>
        k22xx(i)=1<a name='4916'>
        kbconxx(i)=1<a name='4917'>
        ktopxx(i)=1<a name='4918'>
        kstabm(i)=ktf-1<a name='4919'>
      enddo<a name='4920'>
      DO k=kts,ktf<a name='4921'>
      do i=its,itf<a name='4922'>
        if(ierrxx(i).eq.0)then<a name='4923'>
        IPH=1<a name='4924'>
        IF(Tx(I,K,n).LE.TCRIT)IPH=2<a name='4925'>
        E=EXP(AE(IPH)-BE(IPH)/TX(I,K,N))<a name='4926'>
        QES(I,K)=.622*E/(100.*P(I,K)-E)<a name='4927'>
        IF(QES(I,K).LE.1.E-08)QES(I,K)=1.E-08<a name='4928'>
        IF(Qx(I,K,N).GT.QES(I,K))Qx(I,K,N)=QES(I,K)<a name='4929'>
        TV(I,K)=Tx(I,K,N)+.608*Qx(I,K,N)*Tx(I,K,N)<a name='4930'>
        endif<a name='4931'>
      enddo<a name='4932'>
      enddo<a name='4933'>
<font color=#447700>!<a name='4934'></font>
         do i=its,itf<a name='4935'>
           if(ierrxx(i).eq.0)then<a name='4936'>
             Z(I,KTS)=max(0.,Z1(I))-(ALOG(P(I,KTS))- &amp;<a name='4937'>
                 ALOG(PSUR(I)))*287.*TV(I,KTS)/9.81<a name='4938'>
           endif<a name='4939'>
         enddo<a name='4940'>
<a name='4941'>
<font color=#447700>! --- calculate heights<a name='4942'></font>
         DO K=kts+1,ktf<a name='4943'>
         do i=its,itf<a name='4944'>
           if(ierrxx(i).eq.0)then<a name='4945'>
              TVBAR=.5*TV(I,K)+.5*TV(I,K-1)<a name='4946'>
              Z(I,K)=Z(I,K-1)-(ALOG(P(I,K))- &amp;<a name='4947'>
               ALOG(P(I,K-1)))*287.*TVBAR/9.81<a name='4948'>
           endif<a name='4949'>
         enddo<a name='4950'>
         enddo<a name='4951'>
<font color=#447700>!<a name='4952'></font>
<font color=#447700>!--- calculate moist static energy - HE<a name='4953'></font>
<font color=#447700>!    saturated moist static energy - HES<a name='4954'></font>
<font color=#447700>!<a name='4955'></font>
       DO k=kts,ktf<a name='4956'>
       do i=its,itf<a name='4957'>
         if(ierrxx(i).eq.0)then<a name='4958'>
         HE(I,K)=9.81*Z(I,K)+1004.*Tx(I,K,n)+2.5E06*Qx(I,K,n)<a name='4959'>
         HES(I,K)=9.81*Z(I,K)+1004.*Tx(I,K,n)+2.5E06*QES(I,K)<a name='4960'>
         IF(HE(I,K).GE.HES(I,K))HE(I,K)=HES(I,K)<a name='4961'>
         endif<a name='4962'>
      enddo<a name='4963'>
      enddo<a name='4964'>
<a name='4965'>
<font color=#447700>! cup levels<a name='4966'></font>
<font color=#447700>!<a name='4967'></font>
      do k=kts+1,ktf<a name='4968'>
      do i=its,itf<a name='4969'>
        if(ierrxx(i).eq.0)then<a name='4970'>
        qes_cup(i,k)=.5*(qes(i,k-1)+qes(i,k))<a name='4971'>
        q_cup(i,k)=.5*(qx(i,k-1,n)+qx(i,k,n))<a name='4972'>
        hes_cup(i,k)=.5*(hes(i,k-1)+hes(i,k))<a name='4973'>
        he_cup(i,k)=.5*(he(i,k-1)+he(i,k))<a name='4974'>
        if(he_cup(i,k).gt.hes_cup(i,k))he_cup(i,k)=hes_cup(i,k)<a name='4975'>
        z_cup(i,k)=.5*(z(i,k-1)+z(i,k))<a name='4976'>
        p_cup(i,k)=.5*(p(i,k-1)+p(i,k))<a name='4977'>
        t_cup(i,k)=.5*(tx(i,k-1,n)+tx(i,k,n))<a name='4978'>
        gamma_cup(i,k)=(xl/cp)*(xl/(rv*t_cup(i,k) &amp;<a name='4979'>
                       *t_cup(i,k)))*qes_cup(i,k)<a name='4980'>
        endif<a name='4981'>
      enddo<a name='4982'>
      enddo<a name='4983'>
      do i=its,itf<a name='4984'>
        if(ierrxx(i).eq.0)then<a name='4985'>
        qes_cup(i,1)=qes(i,1)<a name='4986'>
        q_cup(i,1)=qx(i,1,n)<a name='4987'>
        hes_cup(i,1)=hes(i,1)<a name='4988'>
        he_cup(i,1)=he(i,1)<a name='4989'>
        z_cup(i,1)=.5*(z(i,1)+z1(i))<a name='4990'>
        p_cup(i,1)=.5*(p(i,1)+psur(i))<a name='4991'>
        t_cup(i,1)=tx(i,1,n)<a name='4992'>
        gamma_cup(i,1)=xl/cp*(xl/(rv*t_cup(i,1) &amp;<a name='4993'>
                       *t_cup(i,1)))*qes_cup(i,1)<a name='4994'>
        endif<a name='4995'>
      enddo<a name='4996'>
<font color=#447700>!<a name='4997'></font>
<font color=#447700>!<a name='4998'></font>
<font color=#447700>!------- DETERMINE LEVEL WITH HIGHEST MOIST STATIC ENERGY CONTENT - K22<a name='4999'></font>
<font color=#447700>!<a name='5000'></font>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MAXIMI'>cup_MAXIMI</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MAXIMI_4">(HE_CUP,3,KBMAX,K22XX,ierrxx, &amp;<a name='5001'>
           itf,jtf,ktf, &amp;<a name='5002'>
           its,ite, jts,jte, kts,kte)<a name='5003'>
       DO 36 i=its,itf<a name='5004'>
         IF(ierrxx(I).eq.0.)THEN<a name='5005'>
         IF(K22xx(I).GE.KBMAX(i))ierrxx(i)=2<a name='5006'>
         endif<a name='5007'>
 36   CONTINUE<a name='5008'>
<font color=#447700>!<a name='5009'></font>
<font color=#447700>!--- DETERMINE THE LEVEL OF CONVECTIVE CLOUD BASE  - KBCON<a name='5010'></font>
<font color=#447700>!<a name='5011'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_KBCON'>cup_kbcon</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KBCON_5">(cap_max_increment,1,k22xx,kbconxx,he_cup,hes_cup, &amp;<a name='5012'>
           ierrxx,kbmax,p_cup,cap_max, &amp;<a name='5013'>
           itf,jtf,ktf, &amp;<a name='5014'>
           its,ite, jts,jte, kts,kte)<a name='5015'>
<font color=#447700>!<a name='5016'></font>
<font color=#447700>!--- increase detrainment in stable layers<a name='5017'></font>
<font color=#447700>!<a name='5018'></font>
      CALL <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_MINIMI'>cup_minimi</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_MINIMI_3">(HEs_cup,Kbconxx,kstabm,kstabi,ierrxx,  &amp;<a name='5019'>
           itf,jtf,ktf, &amp;<a name='5020'>
           its,ite, jts,jte, kts,kte)<a name='5021'>
      do i=its,itf<a name='5022'>
      IF(ierrxx(I).eq.0.)THEN<a name='5023'>
        if(kstabm(i)-1.gt.kstabi(i))then<a name='5024'>
           do k=kstabi(i),kstabm(i)-1<a name='5025'>
             cd(i,k)=cd(i,k-1)+1.5*entr_rate<a name='5026'>
             if(cd(i,k).gt.10.0*entr_rate)cd(i,k)=10.0*entr_rate<a name='5027'>
           enddo<a name='5028'>
        ENDIF<a name='5029'>
      ENDIF<a name='5030'>
      ENDDO<a name='5031'>
<font color=#447700>!<a name='5032'></font>
<font color=#447700>!--- calculate incloud moist static energy<a name='5033'></font>
<font color=#447700>!<a name='5034'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_HE'>cup_up_he</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_HE_7">(k22xx,hkb,z_cup,cd,mentr_rate,he_cup,hc, &amp;<a name='5035'>
           kbconxx,ierrxx,dby,he,hes_cup,'deep', &amp;<a name='5036'>
           itf,jtf,ktf, &amp;<a name='5037'>
           its,ite, jts,jte, kts,kte)<a name='5038'>
<a name='5039'>
<font color=#447700>!--- DETERMINE CLOUD TOP - KTOP<a name='5040'></font>
<font color=#447700>!<a name='5041'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_KTOP'>cup_ktop</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_KTOP_3">(1,dby,kbconxx,ktopxx,ierrxx, &amp;<a name='5042'>
           itf,jtf,ktf, &amp;<a name='5043'>
           its,ite, jts,jte, kts,kte)<a name='5044'>
<font color=#447700>!<a name='5045'></font>
<font color=#447700>!c--- normalized updraft mass flux profile<a name='5046'></font>
<font color=#447700>!<a name='5047'></font>
      call <A href='../../html_code/phys/module_cu_g3.F.html#CUP_UP_NMS'>cup_up_nms</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_NMS_7">(zu,z_cup,mentr_rate,cd,kbconxx,ktopxx,ierrxx,k22xx, &amp;<a name='5048'>
           itf,jtf,ktf, &amp;<a name='5049'>
           its,ite, jts,jte, kts,kte)<a name='5050'>
<font color=#447700>!<a name='5051'></font>
<font color=#447700>!--- calculate workfunctions for updrafts<a name='5052'></font>
<font color=#447700>!<a name='5053'></font>
      call <A href='../../html_code/phys/module_cu_gf_deep.F.html#CUP_UP_AA0'>cup_up_aa0</A><A href='../../html_code/phys/module_cu_g3.F.html#CUP_AXX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CUP_UP_AA0_7">(aa0,z,zu,dby,GAMMA_CUP,t_cup, &amp;<a name='5054'>
           kbconxx,ktopxx,ierrxx,           &amp;<a name='5055'>
           itf,jtf,ktf, &amp;<a name='5056'>
           its,ite, jts,jte, kts,kte)<a name='5057'>
      do i=its,itf<a name='5058'>
       if(ierrxx(i).eq.0)axx(i,n)=aa0(i)<a name='5059'>
      enddo<a name='5060'>
100   continue<a name='5061'>
     END SUBROUTINE cup_axx<a name='5062'>
<a name='5063'>
<A NAME='CONV_GRELL_SPREAD3D'><A href='../../html_code/phys/module_cu_g3.F.html#CONV_GRELL_SPREAD3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5064'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>conv_grell_spread3d</font>(rthcuten,rqvcuten,rqccuten,raincv,   &amp; <A href='../../call_to/CONV_GRELL_SPREAD3D.html' TARGET='index'>1</A><a name='5065'>
     &amp;         cugd_avedx,cugd_tten,cugd_qvten,rqicuten,cugd_ttens,       &amp;<a name='5066'>
     &amp;         cugd_qvtens,cugd_qcten,pi_phy,moist_qv,pratec,dt,num_tiles,&amp;<a name='5067'>
     &amp;         imomentum,F_QV    ,F_QC    ,F_QR    ,F_QI    ,F_QS,        &amp;<a name='5068'>
     &amp;         ids, ide, jds, jde, kds, kde,                              &amp;<a name='5069'>
     &amp;         ips, ipe, jps, jpe, kps, kpe,                              &amp;<a name='5070'>
     &amp;         ims, ime, jms, jme, kms, kme,                              &amp;<a name='5071'>
     &amp;         its, ite, jts, jte, kts, kte   )<a name='5072'>
<a name='5073'>
<font color=#447700>!<a name='5074'></font>
<a name='5075'>
   INTEGER,      INTENT(IN   )    ::   num_tiles,imomentum<a name='5076'>
   INTEGER,      INTENT(IN   )    ::   ids, ide, jds, jde, kds, kde,&amp;<a name='5077'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='5078'>
                                       ips,ipe, jps,jpe, kps,kpe, &amp;<a name='5079'>
                                       its,ite, jts,jte, kts,kte, &amp;<a name='5080'>
                                       cugd_avedx<a name='5081'>
   REAL, DIMENSION (ims:ime,kms:kme,jms:jme), optional,INTENT (INOUT) ::     &amp;<a name='5082'>
     &amp;  rthcuten,rqvcuten,rqccuten,rqicuten<a name='5083'>
   REAL, DIMENSION (ims:ime,kms:kme,jms:jme), optional,INTENT (IN   ) ::     &amp;<a name='5084'>
     &amp;  cugd_tten,cugd_qvten,cugd_ttens,cugd_qvtens,cugd_qcten<a name='5085'>
   REAL, DIMENSION (ims:ime,kms:kme,jms:jme),INTENT (IN) ::        &amp;<a name='5086'>
          moist_qv<a name='5087'>
   REAL, DIMENSION (ims:ime,kms:kme,jms:jme), INTENT (IN) ::        &amp;<a name='5088'>
          PI_PHY<a name='5089'>
   REAL, DIMENSION (ims:ime,jms:jme), INTENT (INOUT) ::             &amp;<a name='5090'>
          raincv,pratec<a name='5091'>
   REAL,                              INTENT(IN) ::   dt<a name='5092'>
   INTEGER                        :: ikk1,ikk2,ikk11,i,j,k,kk,nn,smoothh,smoothv<a name='5093'>
   INTEGER                        :: ifs,ife,jfs,jfe,ido,jdo,cugd_spread<a name='5094'>
   LOGICAL                        :: new<a name='5095'>
<font color=#447700>!<a name='5096'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='5097'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='5098'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='5099'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='5100'></font>
<font color=#447700>! use or not.<a name='5101'></font>
<font color=#447700>!<a name='5102'></font>
   LOGICAL, OPTIONAL ::                                      &amp;<a name='5103'>
                                                   F_QV      &amp;<a name='5104'>
                                                  ,F_QC      &amp;<a name='5105'>
                                                  ,F_QR      &amp;<a name='5106'>
                                                  ,F_QI      &amp;<a name='5107'>
                                                  ,F_QS<a name='5108'>
   REAL, DIMENSION (its-2:ite+2,kts:kte,jts-2:jte+2) ::     &amp;<a name='5109'>
          RTHcutent,RQVcutent<a name='5110'>
   real, dimension (its-2:ite+2,jts-2:jte+2) :: Qmem<a name='5111'>
   real, dimension (its-1:ite+1,jts-1:jte+1) :: smTT,smTQ<a name='5112'>
   real, dimension (kts:kte) :: conv_TRASHT,conv_TRASHQ<a name='5113'>
   REAL                           :: Qmem1,Qmem2,Qmemf,Thresh<a name='5114'>
<a name='5115'>
   smoothh=1<a name='5116'>
   smoothv=1<a name='5117'>
   cugd_spread=cugd_avedx/2<a name='5118'>
<a name='5119'>
   ifs=max(its,ids)<a name='5120'>
   jfs=max(jts,jds)<a name='5121'>
   ife=min(ite,ide-1)<a name='5122'>
   jfe=min(jte,jde-1)<a name='5123'>
<a name='5124'>
   do j=jfs-2,jfe+2<a name='5125'>
   do i=ifs-2,ife+2<a name='5126'>
     Qmem(i,j)=1.<a name='5127'>
   enddo<a name='5128'>
   enddo<a name='5129'>
   do j=jfs-1,jfe+1<a name='5130'>
   do i=ifs-1,ife+1<a name='5131'>
     smTT(i,j)=0.<a name='5132'>
     smTQ(i,j)=0.<a name='5133'>
   enddo<a name='5134'>
   enddo<a name='5135'>
   do j=jfs,jfe              <a name='5136'>
   do k=kts,kte              <a name='5137'>
   do i=ifs,ife<a name='5138'>
     rthcuten(i,k,j)=0. <a name='5139'>
     rqvcuten(i,k,j)=0.      <a name='5140'>
   enddo<a name='5141'>
   enddo<a name='5142'>
   enddo<a name='5143'>
   do j=jfs-2,jfe+2              <a name='5144'>
   do k=kts,kte              <a name='5145'>
   do i=ifs-2,ife+2<a name='5146'>
     RTHcutent(i,k,j)=0. <a name='5147'>
     RQVcutent(i,k,j)=0.      <a name='5148'>
   enddo<a name='5149'>
   enddo<a name='5150'>
   enddo<a name='5151'>
<font color=#447700>!     <a name='5152'></font>
<font color=#447700>!<a name='5153'></font>
<font color=#447700>!       <a name='5154'></font>
<font color=#447700>!  <a name='5155'></font>
<font color=#447700>! prelims finished, now go real for every grid point<a name='5156'></font>
<font color=#447700>!  <a name='5157'></font>
   if(cugd_spread.gt.0.or.smoothh.eq.1)then<a name='5158'>
      <font color=#447700>!if(its.eq.ips)ifs=max(its-1,ids)<a name='5159'></font>
      <font color=#447700>!if(ite.eq.ipe)ife=min(ite+1,ide-1)<a name='5160'></font>
      <font color=#447700>!if(jts.eq.jps)jfs=max(jts-1,jds)<a name='5161'></font>
      <font color=#447700>!if(jte.eq.jpe)jfe=min(jte+1,jde-1)<a name='5162'></font>
      ifs=max(its-1,ids)<a name='5163'>
      ife=min(ite+1,ide-1)<a name='5164'>
      jfs=max(jts-1,jds)<a name='5165'>
      jfe=min(jte+1,jde-1)<a name='5166'>
   endif<a name='5167'>
<a name='5168'>
<font color=#447700>! *** jm note -- for smoothing this goes out one row/column beyond tile in i and j<a name='5169'></font>
   do j=jfs,jfe<a name='5170'>
     do i=ifs,ife<a name='5171'>
<font color=#447700>!<a name='5172'></font>
       do k=kts,kte<a name='5173'>
         RTHcutent(i,k,j)=cugd_tten(i,k,j)<a name='5174'>
         RQVcutent(i,k,j)=cugd_qvten(i,k,j)<a name='5175'>
       enddo<a name='5176'>
<font color=#447700>!<a name='5177'></font>
<font color=#447700>! for high res run, spread the subsidence<a name='5178'></font>
<font color=#447700>! this is tricky......only consider grid points where there was no rain,<a name='5179'></font>
<font color=#447700>! so cugd_tten and such are zero!<a name='5180'></font>
<font color=#447700>!<a name='5181'></font>
       if(cugd_spread.gt.0)then<a name='5182'>
         do k=kts,kte<a name='5183'>
           do nn=-1,1,1<a name='5184'>
             jdo=max(j+nn,jds)<a name='5185'>
             jdo=min(jdo,jde-1)<a name='5186'>
             do kk=-1,1,1<a name='5187'>
               ido=max(i+kk,ids)<a name='5188'>
               ido=min(ido,ide-1)<a name='5189'>
               RTHcutent(i,k,j)=RTHcutent(i,k,j)     &amp;<a name='5190'>
                                    +Qmem(ido,jdo)*cugd_ttens(ido,k,jdo)<a name='5191'>
               RQVcutent(i,k,j)=RQVcutent(i,k,j)     &amp;<a name='5192'>
                                    +Qmem(ido,jdo)*cugd_qvtens(ido,k,jdo)<a name='5193'>
             enddo<a name='5194'>
           enddo<a name='5195'>
         enddo<a name='5196'>
       endif<a name='5197'>
<font color=#447700>!       <a name='5198'></font>
<font color=#447700>! end spreading<a name='5199'></font>
    <a name='5200'>
       if(cugd_spread.eq.0)then<a name='5201'>
         do k=kts,kte<a name='5202'>
           RTHcutent(i,k,j)=RTHcutent(i,k,j)+cugd_ttens(i,k,j)<a name='5203'>
           RQVcutent(i,k,j)=RQVcutent(i,k,j)+cugd_qvtens(i,k,j)<a name='5204'>
         enddo<a name='5205'>
       endif<a name='5206'>
     enddo  <font color=#447700>! end j<a name='5207'></font>
   enddo  <font color=#447700>! end i<a name='5208'></font>
<a name='5209'>
<font color=#447700>! smooth<a name='5210'></font>
   do k=kts,kte<a name='5211'>
     if(smoothh.eq.0)then<a name='5212'>
          ifs=max(its,ids+4)<a name='5213'>
          ife=min(ite,ide-5)<a name='5214'>
          jfs=max(jts,jds+4)<a name='5215'>
          jfe=min(jte,jde-5)<a name='5216'>
          do i=ifs,ife<a name='5217'>
            do j=jfs,jfe<a name='5218'>
              rthcuten(i,k,j)=RTHcutent(i,k,j)<a name='5219'>
              rqvcuten(i,k,j)=RQVcutent(i,k,j)<a name='5220'>
            enddo  <font color=#447700>! end j<a name='5221'></font>
          enddo  <font color=#447700>! end j<a name='5222'></font>
     else if(smoothh.eq.1)then   <font color=#447700>! smooth<a name='5223'></font>
          ifs=max(its,ids)<a name='5224'>
          ife=min(ite,ide-1)<a name='5225'>
          jfs=max(jts,jds)<a name='5226'>
          jfe=min(jte,jde-1)<a name='5227'>
<font color=#447700>! we need an extra row for j (halo comp)<a name='5228'></font>
          <font color=#447700>!if(jts.eq.jps)jfs=max(jts-1,jds)<a name='5229'></font>
          <font color=#447700>!if(jte.eq.jpe)jfe=min(jte+1,jde-1)<a name='5230'></font>
          jfs=max(jts-1,jds)<a name='5231'>
          jfe=min(jte+1,jde-1)<a name='5232'>
          do i=ifs,ife<a name='5233'>
            do j=jfs,jfe<a name='5234'>
               smTT(i,j)=.25*(RTHcutent(i-1,k,j)+2.*RTHcutent(i,k,j)+RTHcutent(i+1,k,j))<a name='5235'>
               smTQ(i,j)=.25*(RQVcutent(i-1,k,j)+2.*RQVcutent(i,k,j)+RQVcutent(i+1,k,j))<a name='5236'>
            enddo  <font color=#447700>! end j<a name='5237'></font>
          enddo  <font color=#447700>! end j<a name='5238'></font>
          ifs=max(its,ids+4)<a name='5239'>
          ife=min(ite,ide-5)<a name='5240'>
          jfs=max(jts,jds+4)<a name='5241'>
          jfe=min(jte,jde-5)<a name='5242'>
          do i=ifs,ife<a name='5243'>
            do j=jfs,jfe<a name='5244'>
              rthcuten(i,k,j)=.25*(smTT(i,j-1)+2.*smTT(i,j)+smTT(i,j+1))<a name='5245'>
              rqvcuten(i,k,j)=.25*(smTQ(i,j-1)+2.*smTQ(i,j)+smTQ(i,j+1))<a name='5246'>
            enddo  <font color=#447700>! end j<a name='5247'></font>
          enddo  <font color=#447700>! end i<a name='5248'></font>
      endif  <font color=#447700>! smoothh<a name='5249'></font>
    enddo  <font color=#447700>! end k<a name='5250'></font>
<font color=#447700>!       <a name='5251'></font>
<font color=#447700>! check moistening rates<a name='5252'></font>
<font color=#447700>!         <a name='5253'></font>
    ifs=max(its,ids+4)<a name='5254'>
    ife=min(ite,ide-5)<a name='5255'>
    jfs=max(jts,jds+4)<a name='5256'>
    jfe=min(jte,jde-5)<a name='5257'>
    do j=jfs,jfe<a name='5258'>
      do i=ifs,ife<a name='5259'>
        Qmemf=1.<a name='5260'>
        Thresh=1.e-20<a name='5261'>
        do k=kts,kte              <a name='5262'>
          if(rqvcuten(i,k,j).lt.0.)then<a name='5263'>
            Qmem1=moist_qv(i,k,j)+rqvcuten(i,k,j)*dt<a name='5264'>
            if(Qmem1.lt.Thresh)then<a name='5265'>
              Qmem1=rqvcuten(i,k,j)<a name='5266'>
              Qmem2=(Thresh-moist_qv(i,k,j))/dt<a name='5267'>
              Qmemf=min(Qmemf,Qmem2/Qmem1)<a name='5268'>
              Qmemf=max(0.,Qmemf)<a name='5269'>
              Qmemf=min(1.,Qmemf)<a name='5270'>
            endif<a name='5271'>
          endif<a name='5272'>
        enddo<a name='5273'>
        do k=kts,kte<a name='5274'>
          rqvcuten(i,k,j)=rqvcuten(i,k,j)*Qmemf<a name='5275'>
          rthcuten(i,k,j)=rthcuten(i,k,j)*Qmemf<a name='5276'>
        enddo<a name='5277'>
        if(present(rqccuten))then<a name='5278'>
          if(f_qc) then<a name='5279'>
            do k=kts,kte<a name='5280'>
              rqccuten(i,k,j)=rqccuten(i,k,j)*Qmemf<a name='5281'>
            enddo<a name='5282'>
          endif<a name='5283'>
        endif<a name='5284'>
        if(present(rqicuten))then<a name='5285'>
          if(f_qi) then<a name='5286'>
            do k=kts,kte<a name='5287'>
              rqicuten(i,k,j)=rqicuten(i,k,j)*Qmemf<a name='5288'>
            enddo<a name='5289'>
          endif<a name='5290'>
        endif<a name='5291'>
        raincv(I,J)=raincv(I,J)*Qmemf<a name='5292'>
        pratec(I,J)=pratec(I,J)*Qmemf<a name='5293'>
<font color=#447700>!<a name='5294'></font>
<font color=#447700>! check heating rates<a name='5295'></font>
<a name='5296'>
<font color=#447700>!<a name='5297'></font>
        Thresh=200.<a name='5298'>
        Qmemf=1.<a name='5299'>
        Qmem1=0.<a name='5300'>
        do k=kts,kte<a name='5301'>
          Qmem1=abs(rthcuten(i,k,j))*86400. <a name='5302'>
<a name='5303'>
          if(Qmem1.gt.Thresh)then<a name='5304'>
            Qmem2=Thresh/Qmem1<a name='5305'>
            Qmemf=min(Qmemf,Qmem2)<a name='5306'>
            Qmemf=max(0.,Qmemf) <a name='5307'>
          endif<a name='5308'>
<a name='5309'>
        enddo<a name='5310'>
        raincv(i,j)=raincv(i,j)*Qmemf<a name='5311'>
        pratec(i,j)=pratec(i,j)*Qmemf<a name='5312'>
        do k=kts,kte<a name='5313'>
          rqvcuten(i,k,j)=rqvcuten(i,k,j)*Qmemf<a name='5314'>
          rthcuten(i,k,j)=rthcuten(i,k,j)*Qmemf<a name='5315'>
        enddo<a name='5316'>
        if(present(rqccuten))then<a name='5317'>
          if(f_qc) then<a name='5318'>
            do k=kts,kte<a name='5319'>
              rqccuten(i,k,j)=rqccuten(i,k,j)*Qmemf<a name='5320'>
            enddo<a name='5321'>
          endif<a name='5322'>
        endif<a name='5323'>
        if(present(rqicuten))then<a name='5324'>
          if(f_qi) then<a name='5325'>
            do k=kts,kte<a name='5326'>
              rqicuten(i,k,j)=rqicuten(i,k,j)*Qmemf<a name='5327'>
            enddo<a name='5328'>
          endif<a name='5329'>
        endif<a name='5330'>
        if(smoothv.eq.1)then<a name='5331'>
<font color=#447700>! <a name='5332'></font>
<font color=#447700>! smooth for now<a name='5333'></font>
<font color=#447700>!<a name='5334'></font>
          do k=kts+2,kte-2<a name='5335'>
            conv_TRASHT(k)= .25*(rthcuten(i,k-1,j)+2.*rthcuten(i,k,j)+rthcuten(i,k+1,j))<a name='5336'>
            conv_TRASHQ(k)= .25*(rqvcuten(i,k-1,j)+2.*rqvcuten(i,k,j)+rqvcuten(i,k+1,j))<a name='5337'>
          enddo<a name='5338'>
          do k=kts+2,kte-2<a name='5339'>
            rthcuten(i,k,j)=conv_TRASHT(k)<a name='5340'>
            rqvcuten(i,k,j)=conv_TRASHQ(k)<a name='5341'>
          enddo<a name='5342'>
        endif<a name='5343'>
        do k=kts,kte<a name='5344'>
          rthcuten(i,k,j)=rthcuten(i,k,j)/pi_phy(i,k,j)<a name='5345'>
        enddo<a name='5346'>
      enddo  <font color=#447700>! end j<a name='5347'></font>
    enddo  <font color=#447700>! end i<a name='5348'></font>
<a name='5349'>
  END SUBROUTINE CONV_GRELL_SPREAD3D<a name='5350'>
<font color=#447700>!-------------------------------------------------------<a name='5351'></font>
END MODULE module_cu_g3<a name='5352'>
</pre></body></html>