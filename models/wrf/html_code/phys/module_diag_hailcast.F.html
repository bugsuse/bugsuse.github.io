<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if (NMM_CORE == 1)<a name='2'>
<A NAME='MODULE_DIAG_HAILCAST'><A href='../../html_code/phys/module_diag_hailcast.F.html#MODULE_DIAG_HAILCAST' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>MODULE </font><font color=#cc0000>module_diag_hailcast</font> <A href='../../call_to/MODULE_DIAG_HAILCAST.html' TARGET='index'>1</A><a name='4'>
CONTAINS<a name='5'>
<A NAME='DIAG_HAILCAST_STUB'><A href='../../html_code/phys/module_diag_hailcast.F.html#DIAG_HAILCAST_STUB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>diag_hailcast_stub</font><a name='7'>
   END SUBROUTINE diag_hailcast_stub<a name='8'>
END MODULE module_diag_hailcast<a name='9'>
#else<a name='10'>
<a name='11'>
<A NAME='MODULE_DIAG_HAILCAST'><A href='../../html_code/phys/module_diag_hailcast.F.html#MODULE_DIAG_HAILCAST' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='12'>
<font color=#993300>MODULE </font><font color=#cc0000>module_diag_hailcast</font> <A href='../../call_to/MODULE_DIAG_HAILCAST.html' TARGET='index'>1</A><a name='13'>
<a name='14'>
CONTAINS<a name='15'>
<a name='16'>
<A NAME='HAILCAST_DIAGNOSTIC_DRIVER'><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='17'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>hailcast_diagnostic_driver</font> (   grid , config_flags     &amp; <A href='../../call_to/HAILCAST_DIAGNOSTIC_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/HAILCAST_DIAGNOSTIC_DRIVER.html' TARGET='index'>10</A><a name='18'>
                             , moist                             &amp;<a name='19'>
                             , rho  &amp;<a name='20'>
                             , ids, ide, jds, jde, kds, kde      &amp;<a name='21'>
                             , ims, ime, jms, jme, kms, kme      &amp;<a name='22'>
                             , ips, ipe, jps, jpe, kps, kpe      &amp;<a name='23'>
                             , its, ite, jts, jte                &amp;<a name='24'>
                             , k_start, k_end               )<a name='25'>
<a name='26'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_223">, ONLY : domain , domain_clock_get<a name='27'>
    USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_146">, ONLY : grid_config_rec_type, model_config_rec<a name='28'>
    USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_117"><a name='29'>
    USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_55"><a name='30'>
    USE module_utility<a name='31'>
    USE <A href='../../html_code/frame/module_streams.F.html#MODULE_STREAMS'>module_streams</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STREAMS_6">, ONLY: history_alarm, auxhist2_alarm<a name='32'>
#ifdef DM_PARALLEL<a name='33'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_145">, ONLY: wrf_dm_sum_real, wrf_dm_maxval<a name='34'>
#endif<a name='35'>
<a name='36'>
    IMPLICIT NONE<a name='37'>
<a name='38'>
    TYPE ( domain ), INTENT(INOUT) :: grid<a name='39'>
    TYPE ( grid_config_rec_type ), INTENT(IN) :: config_flags<a name='40'>
<a name='41'>
    INTEGER, INTENT(IN) :: ids, ide, jds, jde, kds, kde,        &amp;<a name='42'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='43'>
                           ips, ipe, jps, jpe, kps, kpe<a name='44'>
    INTEGER             :: k_start , k_end, its, ite, jts, jte<a name='45'>
<a name='46'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme , num_moist),    &amp;<a name='47'>
         INTENT(IN   ) ::                                moist<a name='48'>
<a name='49'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='50'>
         INTENT(IN   ) ::                                 rho<a name='51'>
<a name='52'>
    <font color=#447700>! Local<a name='53'></font>
    <a name='54'>
    CHARACTER*512 :: message<a name='55'>
    CHARACTER*256 :: timestr <a name='56'>
    INTEGER :: i,j,k,nz<a name='57'>
    INTEGER :: i_start, i_end, j_start, j_end<a name='58'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ) ::      qr  &amp;<a name='59'>
                                              ,          qs  &amp;<a name='60'>
                                              ,          qg  &amp;<a name='61'>
                                              ,          qv  &amp;<a name='62'>
                                              ,          qc  &amp;<a name='63'>
                                              ,          qi  &amp;<a name='64'>
                                              ,        ptot <a name='65'>
    REAL, DIMENSION( ims:ime, jms:jme ) ::       wup_mask_prev  &amp;<a name='66'>
                                              ,      wdur_prev  <a name='67'>
    REAL :: dhail1,dhail2,dhail3,dhail4,dhail5<a name='68'>
    <a name='69'>
    <font color=#447700>! Timing<a name='70'></font>
    <a name='71'>
    TYPE(WRFU_Time) :: hist_time, aux2_time, CurrTime, StartTime<a name='72'>
    TYPE(WRFU_TimeInterval) :: dtint, histint, aux2int<a name='73'>
    LOGICAL :: is_after_history_dump, is_output_timestep, is_first_timestep<a name='74'>
<a name='75'>
    <font color=#447700>! Chirp the routine name for debugging purposes<a name='76'></font>
    write ( message, * ) 'inside hailcast_diagnostics_driver'<a name='77'>
    CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_572">( 100 , message )<a name='78'>
<a name='79'>
    <font color=#447700>! Get timing info <a name='80'></font>
    <font color=#447700>! Want to know if when the last history output was<a name='81'></font>
    <font color=#447700>! Check history and auxhist2 alarms to check last ring time and how often<a name='82'></font>
    <font color=#447700>! they are set to ring<a name='83'></font>
    <a name='84'>
    CALL WRFU_ALARMGET( grid%alarms( HISTORY_ALARM ), prevringtime=hist_time, &amp;<a name='85'>
         ringinterval=histint)<a name='86'>
    CALL WRFU_ALARMGET( grid%alarms( AUXHIST2_ALARM ), prevringtime=aux2_time, &amp;<a name='87'>
         ringinterval=aux2int)<a name='88'>
<a name='89'>
    <font color=#447700>! Get domain clock<a name='90'></font>
   <a name='91'>
    CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_37"> ( grid, current_time=CurrTime, &amp;<a name='92'>
         simulationStartTime=StartTime, &amp;            <a name='93'>
         current_timestr=timestr, time_step=dtint )<a name='94'>
<a name='95'>
    <font color=#447700>! Set some booleans for use later<a name='96'></font>
    <font color=#447700>! Following uses an overloaded .lt.<a name='97'></font>
  <a name='98'>
    is_after_history_dump = ( Currtime .lt. hist_time + dtint )<a name='99'>
<a name='100'>
    <font color=#447700>! Following uses an overloaded .ge.<a name='101'></font>
 <a name='102'>
    is_output_timestep = (Currtime .ge. hist_time + histint - dtint .or. &amp;<a name='103'>
                         Currtime .ge. aux2_time + aux2int - dtint )<a name='104'>
    write ( message, * ) 'is output timestep? ', is_output_timestep<a name='105'>
    CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_573">( 100 , message )<a name='106'>
<a name='107'>
    <font color=#447700>! Following uses an overloaded .eq.<a name='108'></font>
<a name='109'>
    is_first_timestep = ( Currtime .eq. StartTime + dtint )<a name='110'>
        <a name='111'>
    <font color=#447700>! 3-D arrays for moisture variables<a name='112'></font>
<a name='113'>
    DO i=ims, ime<a name='114'>
      DO k=kms, kme<a name='115'>
        DO j=jms, jme<a name='116'>
          qv(i,k,j) = moist(i,k,j,P_QV)<a name='117'>
          qr(i,k,j) = moist(i,k,j,P_QR)<a name='118'>
          qs(i,k,j) = moist(i,k,j,P_QS)<a name='119'>
          qg(i,k,j) = moist(i,k,j,P_QG)<a name='120'>
          qc(i,k,j) = moist(i,k,j,P_QC)<a name='121'>
          qi(i,k,j) = moist(i,k,j,P_QI)<a name='122'>
        ENDDO<a name='123'>
      ENDDO<a name='124'>
    ENDDO<a name='125'>
<a name='126'>
    <font color=#447700>! Total pressure<a name='127'></font>
<a name='128'>
    DO i=ims, ime<a name='129'>
      DO k=kms, kme<a name='130'>
        DO j=jms, jme<a name='131'>
          ptot(i,k,j)=grid%pb(i,k,j)+grid%p(i,k,j)<a name='132'>
        ENDDO<a name='133'>
      ENDDO<a name='134'>
    ENDDO<a name='135'>
<a name='136'>
    <font color=#447700>! After each history dump, reset max/min value arrays<a name='137'></font>
<a name='138'>
    IF ( is_after_history_dump ) THEN<a name='139'>
      DO j = jms, jme<a name='140'>
        DO i = ims, ime<a name='141'>
           grid%hailcast_dhail1(i,j) = 0.<a name='142'>
           grid%hailcast_dhail2(i,j) = 0.<a name='143'>
           grid%hailcast_dhail3(i,j) = 0.<a name='144'>
           grid%hailcast_dhail4(i,j) = 0.<a name='145'>
           grid%hailcast_dhail5(i,j) = 0.<a name='146'>
        ENDDO<a name='147'>
      ENDDO<a name='148'>
    ENDIF  <font color=#447700>! is_after_history_dump<a name='149'></font>
<a name='150'>
<a name='151'>
    <font color=#447700>! We need to do some neighboring gridpoint comparisons for the updraft<a name='152'></font>
    <font color=#447700>! duration calculations; set i,j start and end values so we don't go off <a name='153'></font>
    <font color=#447700>! the edges of the domain.  Updraft duration on domain edges will always be 0.<a name='154'></font>
<a name='155'>
    i_start = its<a name='156'>
    i_end   = ite<a name='157'>
    j_start = jts<a name='158'>
    j_end   = jte<a name='159'>
<a name='160'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='161'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='162'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='163'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='164'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='165'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='166'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='167'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='168'>
    IF ( config_flags%periodic_x ) i_start = its<a name='169'>
    IF ( config_flags%periodic_x ) i_end = ite<a name='170'>
    <a name='171'>
<a name='172'>
    <font color=#447700>! Make a copy of the updraft duration, mask variables<a name='173'></font>
<a name='174'>
    wdur_prev(:,:) = grid%hailcast_wdur(:,:)<a name='175'>
    wup_mask_prev(:,:) = grid%hailcast_wup_mask(:,:)<a name='176'>
<a name='177'>
    <font color=#447700>! Determine updraft mask (where updraft greater than some threshold)<a name='178'></font>
<a name='179'>
    DO j = jts, jte<a name='180'>
      DO i = its, ite<a name='181'>
        grid%hailcast_wup_mask(i,j) = 0<a name='182'>
        grid%hailcast_wdur(i,j) = 0<a name='183'>
<a name='184'>
        DO k = k_start, k_end<a name='185'>
          IF ( grid%w_2(i,k,j) .ge. 10. ) THEN<a name='186'>
              grid%hailcast_wup_mask(i,j) = 1<a name='187'>
          ENDIF<a name='188'>
        ENDDO<a name='189'>
      ENDDO<a name='190'>
    ENDDO<a name='191'>
<a name='192'>
    <font color=#447700>! Determine updraft duration; make sure not to call point outside the domain<a name='193'></font>
<a name='194'>
    DO j = j_start, j_end<a name='195'>
      DO i = i_start, i_end<a name='196'>
<a name='197'>
        <font color=#447700>! Determine updraft duration using updraft masks<a name='198'></font>
<a name='199'>
        IF ( (grid%hailcast_wup_mask(i,j).eq.1) .OR.                 &amp;<a name='200'>
           (MAXVAL(wup_mask_prev(i-1:i+1,j-1:j+1)).eq.1) ) THEN<a name='201'>
             grid%hailcast_wdur(i,j) =                                 &amp;<a name='202'>
                  MAXVAL(wdur_prev(i-1:i+1,j-1:j+1)) + grid%dt<a name='203'>
        ENDIF<a name='204'>
      ENDDO<a name='205'>
    ENDDO<a name='206'>
<a name='207'>
<a name='208'>
    <font color=#447700>! Hail diameter in millimeters (HAILCAST)<a name='209'></font>
<a name='210'>
    nz = k_end - k_start<a name='211'>
    DO j = jts, jte<a name='212'>
      DO i = its, ite<a name='213'>
<a name='214'>
        <font color=#447700>! Only call hailstone driver if updraft has been<a name='215'></font>
        <font color=#447700>! around longer than 15 min<a name='216'></font>
<a name='217'>
        IF (grid%hailcast_wdur(i,j) .gt. 900) THEN<a name='218'>
          CALL <A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER'>hailstone_driver</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILCAST_DIAGNOSTIC_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HAILSTONE_DRIVER_1"> ( grid%t_phy(i,kms:kme,j), &amp;<a name='219'>
                                  grid%z(i,kms:kme,j),     &amp;<a name='220'>
                                  grid%ht(i,       j),     &amp;<a name='221'>
                                  ptot(i,kms:kme,j),     &amp;<a name='222'>
                                  rho(i,kms:kme,j),   &amp;<a name='223'>
                                  qv(i,kms:kme,j),    &amp;<a name='224'>
                                  qi(i,kms:kme,j),    &amp;<a name='225'>
                                  qc(i,kms:kme,j),    &amp;<a name='226'>
                                  qr(i,kms:kme,j),    &amp;<a name='227'>
                                  qs(i,kms:kme,j),    &amp;<a name='228'>
                                  qg(i,kms:kme,j),    &amp;<a name='229'>
                                  grid%w_2(i,kms:kme,j),   &amp;<a name='230'>
                                  grid%hailcast_wdur(i,j),          &amp;<a name='231'>
                                  nz,                 &amp;<a name='232'>
                                  dhail1, dhail2,     &amp;<a name='233'>
                                  dhail3, dhail4,     &amp;<a name='234'>
                                  dhail5              )<a name='235'>
          IF (dhail1 .gt. grid%hailcast_dhail1(i,j)) THEN<a name='236'>
              grid%hailcast_dhail1(i,j) = dhail1<a name='237'>
          ENDIF<a name='238'>
          IF (dhail2 .gt. grid%hailcast_dhail2(i,j)) THEN<a name='239'>
              grid%hailcast_dhail2(i,j) = dhail2<a name='240'>
          ENDIF<a name='241'>
          IF (dhail3 .gt. grid%hailcast_dhail3(i,j)) THEN<a name='242'>
              grid%hailcast_dhail3(i,j) = dhail3<a name='243'>
          ENDIF<a name='244'>
          IF (dhail4 .gt. grid%hailcast_dhail4(i,j)) THEN<a name='245'>
              grid%hailcast_dhail4(i,j) = dhail4<a name='246'>
          ENDIF<a name='247'>
          IF (dhail5 .gt. grid%hailcast_dhail5(i,j)) THEN<a name='248'>
              grid%hailcast_dhail5(i,j) = dhail5<a name='249'>
          ENDIF<a name='250'>
        ENDIF<a name='251'>
      ENDDO<a name='252'>
    ENDDO<a name='253'>
<a name='254'>
    <font color=#447700>! Calculate the mean and standard deviation of the hail diameter<a name='255'></font>
    <font color=#447700>! distribution over different embryo sizes<a name='256'></font>
<a name='257'>
    DO j = jms, jme<a name='258'>
      DO i = ims, ime<a name='259'>
        <font color=#447700>!mean<a name='260'></font>
        grid%hailcast_diam_mean(i,j)=(grid%hailcast_dhail1(i,j)+&amp;<a name='261'>
             grid%hailcast_dhail2(i,j) +grid%hailcast_dhail3(i,j)+&amp;<a name='262'>
             grid%hailcast_dhail4(i,j) +grid%hailcast_dhail5(i,j))/5.<a name='263'>
        <font color=#447700>!sample standard deviation<a name='264'></font>
        grid%hailcast_diam_std(i,j) = SQRT( ( &amp;<a name='265'>
          (grid%hailcast_dhail1(i,j)-grid%hailcast_diam_mean(i,j))**2.+&amp;<a name='266'>
          (grid%hailcast_dhail2(i,j)-grid%hailcast_diam_mean(i,j))**2.+&amp;<a name='267'>
          (grid%hailcast_dhail3(i,j)-grid%hailcast_diam_mean(i,j))**2.+&amp;<a name='268'>
          (grid%hailcast_dhail4(i,j)-grid%hailcast_diam_mean(i,j))**2.+&amp;<a name='269'>
          (grid%hailcast_dhail5(i,j)-grid%hailcast_diam_mean(i,j))**2.)&amp;<a name='270'>
          / 4.0)<a name='271'>
      ENDDO<a name='272'>
    ENDDO<a name='273'>
<a name='274'>
  END SUBROUTINE hailcast_diagnostic_driver<a name='275'>
<a name='276'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='277'></font>
<font color=#447700>!<a name='278'></font>
<font color=#447700>! Hailstone driver, adapted from hailstone subroutine in HAILCAST<a name='279'></font>
<font color=#447700>!  Inputs:<a name='280'></font>
<font color=#447700>!    1-d (nz)<a name='281'></font>
<font color=#447700>!     TCA          temperature (K) <a name='282'></font>
<font color=#447700>!     h1d          height above sea level (m) <a name='283'></font>
<font color=#447700>!     PA           total pressure (Pa)<a name='284'></font>
<font color=#447700>!     rho1d        density (kg/m3)<a name='285'></font>
<font color=#447700>!     RA           vapor mixing ratio (kg/kg)<a name='286'></font>
<font color=#447700>!     qi1d         cloud ice mixing ratio (kg/kg)<a name='287'></font>
<font color=#447700>!     qc1d         cloud water mixing ratio (kg/kg)<a name='288'></font>
<font color=#447700>!     qr1d         rain water mixing ratio (kg/kg)<a name='289'></font>
<font color=#447700>!     qg1d         graupel mixing ratio (kg/kg)<a name='290'></font>
<font color=#447700>!     qs1d         snow mixing ratio (kg/kg)<a name='291'></font>
<font color=#447700>!     VUU          updraft speed at each level (m/s)<a name='292'></font>
<font color=#447700>!    Float<a name='293'></font>
<font color=#447700>!     ht         terrain height (m)<a name='294'></font>
<font color=#447700>!     wdur       duration of any updraft &gt; 10 m/s within 1 surrounding <a name='295'></font>
<font color=#447700>!                 gridpoint <a name='296'></font>
<font color=#447700>!    Integer<a name='297'></font>
<font color=#447700>!     nz         number of vertical levels<a name='298'></font>
<font color=#447700>!<a name='299'></font>
<font color=#447700>!  Output:<a name='300'></font>
<font color=#447700>!     dhail      hail diameter in mm <a name='301'></font>
<font color=#447700>!                1st-5th rank-ordered hail diameters returned<a name='302'></font>
<font color=#447700>!<a name='303'></font>
<font color=#447700>!  13 Aug 2013 .................................Becky Adams-Selin AER<a name='304'></font>
<font color=#447700>!     adapted from hailstone subroutine in SPC's HAILCAST<a name='305'></font>
<font color=#447700>!  18 Mar 2014 .................................Becky Adams-Selin AER<a name='306'></font>
<font color=#447700>!     added variable rime layer density, per Ziegler et al. (1983)<a name='307'></font>
<font color=#447700>!  4 Jun 2014 ..................................Becky Adams-Selin AER<a name='308'></font>
<font color=#447700>!     removed initial embryo size dependency on microphysic scheme<a name='309'></font>
<font color=#447700>!  5 Jun 2014 ..................................Becky Adams-Selin AER<a name='310'></font>
<font color=#447700>!     used smaller initial embryo sizes<a name='311'></font>
<font color=#447700>!  25 Jun 2015..................................Becky Adams-Selin AER<a name='312'></font>
<font color=#447700>!     Significant revamping.  Fixed units bug in HEATBUD that caused<a name='313'></font>
<font color=#447700>!     hailstone temperature instabilities.  Similar issue fixed in BREAKUP<a name='314'></font>
<font color=#447700>!     subroutine.  Removed graupel from ice content.  Changed initial<a name='315'></font>
<font color=#447700>!     embryo size and location to better match literature.  Added<a name='316'></font>
<font color=#447700>!     enhanced melting when hailstone collides with liquid water<a name='317'></font>
<font color=#447700>!     in regions above freezing.  Final diameter returned is ice diameter<a name='318'></font>
<font color=#447700>!     only. Added hailstone temperature averaging over previous timesteps <a name='319'></font>
<font color=#447700>!     to decrease initial temperature instability at small embyro diameters.  <a name='320'></font>
<font color=#447700>!  3 Sep 2015...................................Becky Adams-Selin AER<a name='321'></font>
<font color=#447700>!    Insert embryos at -13C; interpret pressure and other variables to<a name='322'></font>
<font color=#447700>!    that exact temperature level.<a name='323'></font>
<font color=#447700>! 16 Nov 2015...................................Becky Adams-Selin AER<a name='324'></font>
<font color=#447700>!     Hailstone travels horizontally through updraft instead of being<a name='325'></font>
<font color=#447700>!     locked in the center.<a name='326'></font>
<font color=#447700>!    <a name='327'></font>
<font color=#447700>! See Adams-Selin and Ziegler 2016, MWR for further documentation.<a name='328'></font>
<font color=#447700>!<a name='329'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='330'></font>
<A NAME='HAILSTONE_DRIVER'><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='331'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>hailstone_driver</font> ( TCA, h1d, ht, PA, rho1d,&amp; <A href='../../call_to/HAILSTONE_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/HAILSTONE_DRIVER.html' TARGET='index'>16</A><a name='332'>
                                RA, qi1d,qc1d,qr1d,qs1d,qg1d,   &amp;<a name='333'>
                                VUU, wdur,                          &amp;<a name='334'>
                                nz,dhail1,dhail2,dhail3,dhail4,     &amp;<a name='335'>
                                dhail5                             )<a name='336'>
    IMPLICIT NONE<a name='337'>
    INTEGER, INTENT(IN ) :: nz<a name='338'>
<a name='339'>
    REAL, DIMENSION( nz ),             &amp;<a name='340'>
         INTENT(IN   ) ::                                  TCA  &amp; <font color=#447700>! temperature (K)<a name='341'></font>
                                              ,          rho1d  &amp;<a name='342'>
                                              ,            h1d  &amp;<a name='343'>
                                              ,             PA  &amp; <font color=#447700>! pressure (Pa)<a name='344'></font>
                                              ,             RA  &amp; <font color=#447700>! vapor mixing ratio (kg/kg)<a name='345'></font>
                                              ,            VUU  &amp; <font color=#447700>! updraft speed (m/s)<a name='346'></font>
                                              , qi1d,qc1d,qr1d  &amp;<a name='347'>
                                              , qs1d,qg1d<a name='348'>
<a name='349'>
    REAL, INTENT(IN   ) ::                                  ht  &amp;<a name='350'>
                                              ,           wdur<a name='351'>
    <a name='352'>
    <font color=#447700>!Output: 1st-5th rank-ordered hail diameters returned<a name='353'></font>
    REAL, INTENT(INOUT) ::                              dhail1 &amp; <font color=#447700>! hail diameter (mm);<a name='354'></font>
                                              ,         dhail2 &amp;<a name='355'>
                                              ,         dhail3 &amp;<a name='356'>
                                              ,         dhail4 &amp;<a name='357'>
                                              ,         dhail5<a name='358'>
    <font color=#447700>!Local variables<a name='359'></font>
    REAL ZBAS, TBAS, WBASP     <font color=#447700>! height, temp, pressure of cloud base<a name='360'></font>
    REAL RBAS                  <font color=#447700>! mix ratio of cloud base<a name='361'></font>
    REAL cwitot                <font color=#447700>! total cloud water, ice mix ratio<a name='362'></font>
    INTEGER KBAS               <font color=#447700>! k of cloud base<a name='363'></font>
    REAL tk_embryo             <font color=#447700>! temperature at which initial embryo is inserted<a name='364'></font>
    REAL ZFZL, TFZL, WFZLP     <font color=#447700>! height, temp, pressure of embryo start point<a name='365'></font>
    REAL RFZL                  <font color=#447700>! mix ratio of embryo start point<a name='366'></font>
    REAL VUFZL, DENSAFZL       <font color=#447700>! updraft speed, density of embryo start point<a name='367'></font>
    INTEGER KFZL               <font color=#447700>! k of embryo start point<a name='368'></font>
    INTEGER nofroze            <font color=#447700>! keeps track if hailstone has ever been frozen<a name='369'></font>
    INTEGER CLOUDON            <font color=#447700>! use to zero out cloud water, ice once past updraft duration<a name='370'></font>
    REAL RTIME                 <font color=#447700>! real updraft duration (sec)<a name='371'></font>
    REAL TAU, TAU_1, TAU_2     <font color=#447700>! upper time limit of simulation (sec)<a name='372'></font>
    REAL delTAU                <font color=#447700>! difference between TAU_2 and TAU_1 (sec)<a name='373'></font>
    REAL g                     <font color=#447700>! gravity (m/s)<a name='374'></font>
    REAL r_d                   <font color=#447700>! constant<a name='375'></font>
    <font color=#447700>!hailstone parameters<a name='376'></font>
    REAL*8 DD, D, D_ICE        <font color=#447700>! hail diameter (m)<a name='377'></font>
    REAL VT                    <font color=#447700>! terminal velocity (m/s)<a name='378'></font>
    REAL V                     <font color=#447700>! actual stone velocity (m/s)<a name='379'></font>
    REAL TS                    <font color=#447700>! hailstone temperature (K)<a name='380'></font>
    <font color=#447700>!HAILSTONE temperature differencing<a name='381'></font>
    REAL TSm1, TSm2            <font color=#447700>! hailstone temperature at previous 3 timesteps<a name='382'></font>
    REAL FW                    <font color=#447700>! fraction of stone that is liquid<a name='383'></font>
    REAL WATER                 <font color=#447700>! mass of stone that is liquid<a name='384'></font>
    REAL CRIT                  <font color=#447700>! critical water mass allowed on stone surface<a name='385'></font>
    REAL DENSE                 <font color=#447700>! hailstone density (kg/m3)<a name='386'></font>
    INTEGER ITYPE              <font color=#447700>! wet (2) or dry (1) growth regime<a name='387'></font>
    <font color=#447700>!1-d column arrays of updraft parameters<a name='388'></font>
    REAL, DIMENSION( nz ) ::  &amp;<a name='389'>
      RIA, &amp;                   <font color=#447700>! frozen content mix ratio (kg/kg)<a name='390'></font>
      RWA, &amp;                   <font color=#447700>! liquid content mix ratio (kg/kg)<a name='391'></font>
      VUU_pert                 <font color=#447700>! perturbed updraft profile (m/s)<a name='392'></font>
    <font color=#447700>!in-cloud updraft parameters at location of hailstone<a name='393'></font>
    REAL P                     <font color=#447700>! in-cloud pressure (Pa)<a name='394'></font>
    REAL RS                    <font color=#447700>! in-cloud saturation mixing ratio <a name='395'></font>
    REAL RI, RW                <font color=#447700>! ice, liquid water mix. ratio (kg/kg)<a name='396'></font>
    REAL XI, XW                <font color=#447700>! ice, liquid water content (kg/m3 air)<a name='397'></font>
    REAL PC                    <font color=#447700>! in-cloud fraction of frozen water<a name='398'></font>
    REAL TC                    <font color=#447700>! in-cloud temperature (K)<a name='399'></font>
    REAL VU                    <font color=#447700>! in-cloud updraft speed (m/s)<a name='400'></font>
    REAL VUMAX                 <font color=#447700>! in-cloud updraft speed read from WRF (max allowed)<a name='401'></font>
    REAL VUCORE                <font color=#447700>! perturbed in-cloud updraft speed<a name='402'></font>
    REAL DENSA                 <font color=#447700>! in-cloud updraft density (kg/m3)<a name='403'></font>
    REAL Z                     <font color=#447700>! height of hailstone (m)<a name='404'></font>
    REAL DELRW                 <font color=#447700>! diff in sat vap. dens. between hail and air (kg/m3)<a name='405'></font>
    <font color=#447700>!variables to determine graupel size distribution<a name='406'></font>
    REAL, DIMENSION(600) :: gd       <font color=#447700>!graupel diameter<a name='407'></font>
    REAL, DIMENSION(600) :: ng_d     <font color=#447700>!number of graupel particles of that diameter<a name='408'></font>
    REAL, DIMENSION(600) :: sum_ng_d <font color=#447700>!cumulative summation of # graupel particles of diam. D or less<a name='409'></font>
    REAL lambdag                     <font color=#447700>!slope of the graupel size distribution<a name='410'></font>
    REAL n0g                         <font color=#447700>!graupel distribution intercept<a name='411'></font>
    REAL deng                        <font color=#447700>!graupel density<a name='412'></font>
    REAL xslw1,ygra1,zans1           <font color=#447700>!Thompson graupel size dist parameters<a name='413'></font>
    REAL pile                        <font color=#447700>!desired percentile<a name='414'></font>
    REAL d02,d05,d10,d15,d20 <font color=#447700>!2,5,10,15,20th %ile graupel dsd diameters<a name='415'></font>
    REAL n02,n05,n10,n15,n20 <font color=#447700>!#rank of each of the %iles<a name='416'></font>
    REAL, DIMENSION(5) :: dhails     <font color=#447700>!hail diameters with the 1st-15th %ile of graupel dsd <a name='417'></font>
                                     <font color=#447700>!used as initial hail embryo size<a name='418'></font>
    <font color=#447700>!mean sub-cloud layer variables<a name='419'></font>
    REAL TLAYER,RLAYER,PLAYER  <font color=#447700>! mean sub-cloud temp, mix ratio, pres<a name='420'></font>
    REAL TSUM,RSUM,PSUM        <font color=#447700>! sub-cloud layer T, R, P sums<a name='421'></font>
    REAL LDEPTH                <font color=#447700>! layer depth<a name='422'></font>
    <font color=#447700>!internal function variables<a name='423'></font>
    REAL GM,GM1,GMW,GMI,DGM,DGMW,DGMI,DGMV,DI,ANU,RE,AE<a name='424'>
    REAL dum<a name='425'>
      <a name='426'>
    REAL sec, secdel           <font color=#447700>! time step, increment in seconds<a name='427'></font>
    INTEGER i, j, k, IFOUT, ind(1)<a name='428'>
    CHARACTER*256 :: message<a name='429'>
<a name='430'>
<a name='431'>
    <font color=#447700>!secdel = 0.05<a name='432'></font>
    secdel = 5.0<a name='433'>
    g=9.81<a name='434'>
    r_d = 287.<a name='435'>
            <a name='436'>
<font color=#447700>!   Upper limit of simulation in seconds<a name='437'></font>
    TAU = 7200.    <font color=#447700>!simulation ends<a name='438'></font>
<a name='439'>
    <font color=#447700>!Set initial updraft strength - reduce to simulate the embryo hovering<a name='440'></font>
    <font color=#447700>! around the edges of the updraft, as in Heymsfield and Musil (1982)<a name='441'></font>
    DO i=1,nz<a name='442'>
       VUU_pert(i) = VUU(i) * 1.<a name='443'>
    ENDDO<a name='444'>
<a name='445'>
      <a name='446'>
<font color=#447700>!   Initialize diameters to 0.<a name='447'></font>
    DO i=1,5<a name='448'>
       dhails(i) = 0.<a name='449'>
    ENDDO<a name='450'>
<a name='451'>
<font color=#447700>!   Cap updraft lifetime at 2000 sec.<a name='452'></font>
    IF (wdur .GT. 2000) THEN<a name='453'>
        RTIME  = 2000.<a name='454'>
    ELSE<a name='455'>
        RTIME = wdur<a name='456'>
    ENDIF<a name='457'>
<a name='458'>
 <a name='459'>
    <font color=#447700>!Sum frozen and liquid condensate.<a name='460'></font>
    <font color=#447700>!Also find the cloud base for end-of-algorithm purposes.<a name='461'></font>
    KBAS=nz<a name='462'>
    <font color=#447700>!KFZL=nz<a name='463'></font>
    DO k=1,nz<a name='464'>
         cwitot = qi1d(k) + qc1d(k)<a name='465'>
         <font color=#447700>!No longer include graupel in in-cloud ice amounts<a name='466'></font>
         <font color=#447700>!RIA(k) = qi1d(k) + qs1d(k) + qg1d(k)<a name='467'></font>
         RIA(k) = qi1d(k) + qs1d(k)<a name='468'>
         <font color=#447700>!RWA(k) = qc1d(k) + qr1d(k)<a name='469'></font>
         RWA(k) = qc1d(k)<a name='470'>
         <font color=#447700>!IF ((RIA(k) .ge. 0.0001) .and. (TCA(k).lt.260.155) .and. &amp;<a name='471'></font>
         <font color=#447700>!    (k .lt. KFZL)) THEN<a name='472'></font>
         <font color=#447700>!   KFZL = k<a name='473'></font>
         <font color=#447700>!ENDIF<a name='474'></font>
         IF ((cwitot .ge. 1.E-12) .and. (k .lt. KBAS)) THEN<a name='475'>
            KBAS = k<a name='476'>
         ENDIF<a name='477'>
    ENDDO<a name='478'>
    <font color=#447700>!QC - our embryo can't start below the cloud base.<a name='479'></font>
    <font color=#447700>!IF (KFZL .lt. KBAS) THEN<a name='480'></font>
    <font color=#447700>!   KFZL = KBAS<a name='481'></font>
    <font color=#447700>!ENDIF<a name='482'></font>
<a name='483'>
    <font color=#447700>!Pull heights, etc. of these levels out of 1-d arrays.<a name='484'></font>
    <font color=#447700>!ZFZL = h1d(KFZL)<a name='485'></font>
    <font color=#447700>!TFZL = TCA(KFZL)<a name='486'></font>
    <font color=#447700>!WFZLP = PA(KFZL)<a name='487'></font>
    <font color=#447700>!RFZL = RA(KFZL)<a name='488'></font>
    ZBAS = h1d(KBAS)<a name='489'>
    TBAS = TCA(KBAS)<a name='490'>
    WBASP = PA(KBAS)<a name='491'>
    RBAS = RA(KBAS)<a name='492'>
    <a name='493'>
    <font color=#447700>!Insert initial embryo at -13C<a name='494'></font>
    tk_embryo = 260.155<a name='495'>
    TFZL = tk_embryo<a name='496'>
    CALL <A href='../../html_code/phys/module_diag_hailcast.F.html#INTERPP'>INTERPP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERPP_1">(PA, WFZLP, TCA, tk_embryo, IFOUT, nz)<a name='497'>
    CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_1">(h1d, ZFZL, WFZLP, IFOUT, PA, nz)<a name='498'>
    CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_2">(RA,  RFZL, WFZLP, IFOUT, PA, nz)<a name='499'>
    CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_3">(VUU_pert, VUFZL, WFZLP, IFOUT, PA, nz)<a name='500'>
    CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_4">(rho1d, DENSAFZL, WFZLP, IFOUT, PA, nz)<a name='501'>
<a name='502'>
    <font color=#447700>!!!!!!!!!!!!!!!! 0. INITIAL EMBRYO SIZE  !!!!!!!!!!!!!!!!!!!!!<a name='503'></font>
    <font color=#447700>!      SET CONSTANT RANGE OF INITIAL EMBRYO SIZES            !<a name='504'></font>
    <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='505'></font>
    <font color=#447700>! See Adams-Selin and Ziegler 2016 MWR for explanation of why<a name='506'></font>
    <font color=#447700>! these sizes were picked.<a name='507'></font>
    d02 = 9.E-4<a name='508'>
    d05 = 2.E-3<a name='509'>
    d10 = 5.E-3<a name='510'>
    d15 = 7.5E-3<a name='511'>
    d20 = 1.E-2    <a name='512'>
<a name='513'>
    <font color=#447700>!Run each initial embryo size perturbation<a name='514'></font>
    DO i=1,5<a name='515'>
      SELECT CASE (i)   <a name='516'>
        CASE (1)<a name='517'>
        <font color=#447700>!Initial hail embryo diameter in m, at cloud base<a name='518'></font>
        DD = d02<a name='519'>
        CASE (2)<a name='520'>
        DD = d05<a name='521'>
        CASE (3)  <a name='522'>
        DD = d10<a name='523'>
        CASE (4)<a name='524'>
        DD = d15<a name='525'>
        CASE (5)<a name='526'>
        DD = d20<a name='527'>
      END SELECT<a name='528'>
<a name='529'>
      <font color=#447700>!Begin hail simulation time (seconds)<a name='530'></font>
      sec = 0.<a name='531'>
 <a name='532'>
      <font color=#447700>!Set initial values for parameters at freezing level<a name='533'></font>
      P = WFZLP<a name='534'>
      RS = RFZL<a name='535'>
      TC = TFZL<a name='536'>
      VU = VUFZL  <a name='537'>
      Z = ZFZL - ht<a name='538'>
      LDEPTH = Z<a name='539'>
      DENSA = DENSAFZL<a name='540'>
<a name='541'>
      <font color=#447700>!Set initial hailstone parameters<a name='542'></font>
      nofroze=1 <font color=#447700>!Set test for embryo: 0 for never been frozen; 1 frozen<a name='543'></font>
      TS = TC<a name='544'>
      TSm1 = TS<a name='545'>
      TSm2 = TS      <a name='546'>
      D = DD   <font color=#447700>!hailstone diameter in m<a name='547'></font>
      FW = 0.0<a name='548'>
      DENSE = 500.  <font color=#447700>!kg/m3  <a name='549'></font>
      ITYPE=1.  <font color=#447700>!Assume starts in dry growth.<a name='550'></font>
      CLOUDON=1  <font color=#447700>!we'll eventually turn cloud "off" once updraft past time limit<a name='551'></font>
<a name='552'>
      <font color=#447700>!Start time loop.<a name='553'></font>
      DO WHILE (sec .lt. TAU)<a name='554'>
         sec = sec + secdel<a name='555'>
         <a name='556'>
         <font color=#447700>!!!!!!!!!!!!!!!!!!  1. CALCULATE PARAMETERS  !!!!!!!!!!!!!!!!!<a name='557'></font>
         <font color=#447700>!              CALCULATE UPDRAFT PROPERTIES                  !<a name='558'></font>
         <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='559'></font>
         <font color=#447700>!Intepolate vertical velocity to our new pressure level<a name='560'></font>
         CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_5">(VUU_pert,VUMAX,P,IFOUT,PA,nz)<a name='561'>
         <font color=#447700>!print *, 'INTERP VU: ', VU, P<a name='562'></font>
         <a name='563'>
         <font color=#447700>!Outside pressure levels?  If so, exit loop<a name='564'></font>
         IF (IFOUT.EQ.1) GOTO 100<a name='565'>
                  <a name='566'>
         <font color=#447700>!Sine wave multiplier on updraft strength<a name='567'></font>
         IF (SEC .GT. 0.0 .AND. SEC .LT. RTIME) THEN<a name='568'>
            VUCORE = VUMAX * SIN( (3.14159 * SEC)/(RTIME) )<a name='569'>
            VU = VUCORE<a name='570'>
      <a name='571'>
         ELSEIF (SEC .GE. RTIME) THEN<a name='572'>
            VU = 0.0<a name='573'>
            CLOUDON = 0<a name='574'>
         ENDIF<a name='575'>
         <a name='576'>
         <font color=#447700>!Calculate terminal velocity of the hailstone <a name='577'></font>
         <font color=#447700>! (use previous values)<a name='578'></font>
         CALL <A href='../../html_code/phys/module_diag_hailcast.F.html#TERMINL'>TERMINL</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TERMINL_1">(DENSA,DENSE,D,VT,TC)<a name='579'>
         <a name='580'>
         <font color=#447700>!Actual velocity of hailstone (upwards positive)<a name='581'></font>
         V = VU - VT<a name='582'>
         <a name='583'>
         <font color=#447700>!Use hydrostatic eq'n to calc height of next level<a name='584'></font>
         P = P - DENSA*g*V*secdel<a name='585'>
         Z = Z + V*secdel<a name='586'>
<a name='587'>
         <font color=#447700>!Interpolate cloud temp, qvapor at new p-level<a name='588'></font>
         CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_6">(TCA,TC,P,IFOUT,PA,nz)<a name='589'>
         CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_7">(RA,RS,P,IFOUT,PA,nz)<a name='590'>
         <a name='591'>
         <font color=#447700>!New density of in-cloud air<a name='592'></font>
         DENSA=P/(r_d*(1.+0.609*RS/(1.+RS))*TC)<a name='593'>
         <a name='594'>
         <font color=#447700>!Interpolate liquid, frozen water mix ratio at new level<a name='595'></font>
         CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_8">(RIA,RI,P,IFOUT,PA,nz)<a name='596'>
         CALL <A href='../../html_code/phys/module_fr_fire_util.F.html#INTERP'>INTERP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_9">(RWA,RW,P,IFOUT,PA,nz)<a name='597'>
         XI = RI * DENSA * CLOUDON<a name='598'>
         XW = RW * DENSA * CLOUDON<a name='599'>
         IF( (XW+XI).GT.0) THEN<a name='600'>
           PC = XI / (XW+XI)<a name='601'>
         ELSE<a name='602'>
           PC = 1.<a name='603'>
         ENDIF<a name='604'>
         <a name='605'>
         <a name='606'>
        <font color=#447700>!!!!!!!!!!!!!!!!!!  2. TEST FOR WET/DRY GROWTH !!!!!!!!!!!!!!!<a name='607'></font>
        <font color=#447700>!  WET GROWTH - STONE'S SFC &gt;0; DRY GROWTH SFC &lt; 0           ! <a name='608'></font>
        <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='609'></font>
        <font color=#447700>!MOVED TEST INSIDE HEATBUD - JUST ASSIGN AFTER TS/FW CALC<a name='610'></font>
<a name='611'>
        <font color=#447700>! DENSITY OF HAILSTONE - DEPENDS ON FW<a name='612'></font>
        <font color=#447700>! ONLY WATER=1 GM/L=1000KG/M3; ONLY ICE  =0.9 GM/L <a name='613'></font>
        <font color=#447700>!DENSE=(FW*0.1+0.9) * 1000.  !KG/M3 !RAS-density calc inside MASSAGR<a name='614'></font>
 <a name='615'>
        <font color=#447700>! SATURATION VAPOUR DENSITY DIFFERENCE BETWTEEN STONE AND CLOUD<a name='616'></font>
        CALL <A href='../../html_code/phys/module_diag_hailcast.F.html#VAPORCLOSE'>VAPORCLOSE</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VAPORCLOSE_1">(DELRW,PC,TS,TC,ITYPE)<a name='617'>
      <a name='618'>
        <a name='619'>
        <font color=#447700>!!!!!!!!!!!!!!!!!!  3. STONE'S MASS GROWTH !!!!!!!!!!!!!!!!!!!!<a name='620'></font>
        CALL <A href='../../html_code/phys/module_diag_hailcast.F.html#MASSAGR'>MASSAGR</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MASSAGR_1">(D,GM,GM1,GMW,GMI,DGM,DGMW,DGMI,DGMV,DI,ANU,RE,AE,&amp;<a name='621'>
                 TC,TS,P,DENSE,DENSA,FW,VT,XW,XI,secdel,ITYPE,DELRW) <a name='622'>
<a name='623'>
<a name='624'>
        <font color=#447700>!!!!!!!!!!!!!!!!!!  4. HEAT BUDGET OF HAILSTONE !!!!!!!!!!!!!!!<a name='625'></font>
        CALL <A href='../../html_code/phys/module_diag_hailcast.F.html#HEATBUD'>HEATBUD</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HEATBUD_1">(TS,TSm1,TSm2,FW,TC,VT,DELRW,D,DENSA,GM1,GM,DGM,DGMW,  &amp; <a name='626'>
                     DGMV,DGMI,GMW,GMI,DI,ANU,RE,AE,secdel,ITYPE,P)<a name='627'>
<a name='628'>
 <a name='629'>
        <font color=#447700>!!!!! 5. TEST DIAMETER OF STONE AND HEIGHT ABOVE GROUND !!!!!!!<a name='630'></font>
        <font color=#447700>!  TEST IF DIAMETER OF STONE IS GREATER THAN 9 MM LIMIT, IF SO  <a name='631'></font>
        <font color=#447700>!  BREAK UP <a name='632'></font>
        <font color=#447700>!IF(D.GT.0.009) THEN   <a name='633'></font>
        <font color=#447700>!   CALL BREAKUP(DENSE,D,GM,FW)<a name='634'></font>
        <font color=#447700>!ENDIF<a name='635'></font>
        WATER=FW*GM  <font color=#447700>!KG<a name='636'></font>
        <font color=#447700>! CRTICAL MASS CAPABLE OF BEING "SUPPORTED" ON THE STONE'S SURFACE <a name='637'></font>
        CRIT = 1.0E-10<a name='638'>
        IF (WATER.GT.CRIT)THEN<a name='639'>
           CALL <A href='../../html_code/phys/module_mp_full_sbm.F.html#BREAKUP'>BREAKUP</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BREAKUP_1">(DENSE,D,GM,FW)<a name='640'>
        ENDIF<a name='641'>
        <a name='642'>
        <font color=#447700>! Has stone reached below cloud base?<a name='643'></font>
        <font color=#447700>!IF (Z .LE. 0) GOTO 200<a name='644'></font>
        IF (Z .LE. ZBAS) GOTO 200<a name='645'>
<a name='646'>
        <font color=#447700>!calculate ice-only diameter size<a name='647'></font>
        D_ICE = ( (6*GM*(1.-FW)) / (3.141592654*DENSE) )**0.33333333 <a name='648'>
<a name='649'>
        <font color=#447700>!Has the stone entirely melted and it's below the freezing level?  <a name='650'></font>
        IF ((D_ICE .LT. 1.E-8) .AND. (TC.GT.273.155)) GOTO 300<a name='651'>
<a name='652'>
        <font color=#447700>!move values to previous timestep value<a name='653'></font>
        TSm1 = TS<a name='654'>
        TSm2 = TSm1<a name='655'>
        <a name='656'>
      ENDDO  <font color=#447700>!end cloud lifetime loop<a name='657'></font>
<a name='658'>
100   CONTINUE <font color=#447700>!outside pressure levels in model<a name='659'></font>
200   CONTINUE <font color=#447700>!stone reached surface<a name='660'></font>
300   CONTINUE <font color=#447700>!stone has entirely melted and is below freezing level<a name='661'></font>
<a name='662'>
      <font color=#447700>!!!!!!!!!!!!!!!!!! 6. MELT STONE BELOW CLOUD !!!!!!!!!!!!!!!!!!!!<a name='663'></font>
      <font color=#447700>!Did the stone shoot out the top of the storm? <a name='664'></font>
      <font color=#447700>!Then let's assume it's lost in the murky "outside storm" world.<a name='665'></font>
      IF (P.lt.PA(nz)) THEN<a name='666'>
         D=0.0<a name='667'>
      <font color=#447700>!Is the stone entirely water? Then set D=0 and exit.<a name='668'></font>
      ELSE IF(ABS(FW - 1.0).LT.0.001) THEN<a name='669'>
         D=0.0<a name='670'>
      ELSE IF (Z.GT.0) THEN<a name='671'>
         <font color=#447700>!If still frozen, then use melt routine to melt below cloud<a name='672'></font>
         <font color=#447700>! based on mean below-cloud conditions.<a name='673'></font>
        <a name='674'>
         <font color=#447700>!Calculate mean sub-cloud layer conditions<a name='675'></font>
         TSUM = 0.<a name='676'>
         RSUM = 0.<a name='677'>
         PSUM = 0.<a name='678'>
         DO k=1,KBAS<a name='679'>
            TSUM = TSUM + TCA(k)<a name='680'>
            PSUM = PSUM + PA(k)<a name='681'>
            RSUM = RSUM + RA(k)<a name='682'>
         ENDDO<a name='683'>
         TLAYER = TSUM / KBAS<a name='684'>
         PLAYER = PSUM / KBAS<a name='685'>
         RLAYER = RSUM / KBAS<a name='686'>
         <a name='687'>
         <font color=#447700>!MELT is expecting a hailstone of only ice.  At the surface<a name='688'></font>
         <font color=#447700>!we're only interested in the actual ice diameter of the hailstone,<a name='689'></font>
         <font color=#447700>!so let's shed any excess water now.<a name='690'></font>
         D_ICE = ( (6*GM*(1.-FW)) / (3.141592654*DENSE) )**0.33333333 <a name='691'>
         D = D_ICE  <a name='692'>
         CALL <A href='../../html_code/phys/module_diag_hailcast.F.html#MELT'>MELT</A><A href='../../html_code/phys/module_diag_hailcast.F.html#HAILSTONE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MELT_1">(D,TLAYER,PLAYER,RLAYER,LDEPTH,VT)<a name='693'>
<a name='694'>
      ENDIF <font color=#447700>!end check for melting call<a name='695'></font>
      <a name='696'>
      <font color=#447700>!assign hail size in mm for output<a name='697'></font>
      dhails(i) = D * 1000<a name='698'>
<a name='699'>
    ENDDO  <font color=#447700>!end embryo size loop<a name='700'></font>
  <a name='701'>
    <font color=#447700>!! Size-sort hail diameters for function output !!<a name='702'></font>
    DO j=1,4<a name='703'>
     DO k=j+1,5<a name='704'>
         IF (dhails(j).lt.dhails(k)) THEN<a name='705'>
            dum = dhails(j)<a name='706'>
            dhails(j) = dhails(k)<a name='707'>
            dhails(k) = dum<a name='708'>
         ENDIF<a name='709'>
      ENDDO<a name='710'>
    ENDDO<a name='711'>
    <a name='712'>
    dhail1 = dhails(1)<a name='713'>
    dhail2 = dhails(2)<a name='714'>
    dhail3 = dhails(3)<a name='715'>
    dhail4 = dhails(4)<a name='716'>
    dhail5 = dhails(5)<a name='717'>
 <a name='718'>
  END SUBROUTINE hailstone_driver<a name='719'>
<a name='720'>
<a name='721'>
<A NAME='INTERPP'><A href='../../html_code/phys/module_diag_hailcast.F.html#INTERPP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='722'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>INTERPP</font>(PA,PVAL,TA,TVAL,IFOUT,ITEL) <A href='../../call_to/INTERPP.html' TARGET='index'>1</A><a name='723'>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='724'></font>
  <font color=#447700>!<a name='725'></font>
  <font color=#447700>! INTERP: to linearly interpolate value of pval at temperature tval<a name='726'></font>
  <font color=#447700>!   between two levels of pressure array pa and temperatures ta<a name='727'></font>
  <font color=#447700>!<a name='728'></font>
  <font color=#447700>! INPUT: PA    1D array of pressure, to be interpolated<a name='729'></font>
  <font color=#447700>!        TA    1D array of temperature<a name='730'></font>
  <font color=#447700>!        TVAL  temperature value at which we want to calculate pressure<a name='731'></font>
  <font color=#447700>!        IFOUT set to 0 if TVAL outside range of TA<a name='732'></font>
  <font color=#447700>!        ITEL  number of vertical levels<a name='733'></font>
  <font color=#447700>! OUTPUT: PVAL interpolated pressure variable at temperature tval<a name='734'></font>
  <font color=#447700>!<a name='735'></font>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='736'></font>
      IMPLICIT NONE<a name='737'>
      <a name='738'>
      REAL PVAL, TVAL<a name='739'>
      REAL, DIMENSION( ITEL) :: TA, PA<a name='740'>
      INTEGER ITEL, IFOUT<a name='741'>
      <font color=#447700>!local variables<a name='742'></font>
      INTEGER I<a name='743'>
      REAL FRACT<a name='744'>
      <a name='745'>
      IFOUT=1<a name='746'>
      <a name='747'>
      DO I=1,ITEL-1<a name='748'>
         IF ( (TVAL .LT. TA(I) .AND. TVAL .GE. TA(I+1)) .or.  &amp;   <font color=#447700>! dT/dz &lt; 0<a name='749'></font>
              (TVAL .GT. TA(I) .AND. TVAL .LE. TA(I+1)) ) THEN    <font color=#447700>! dT/dz &gt; 0<a name='750'></font>
<a name='751'>
            FRACT = (TA(I) - TVAL) / (TA(I) - TA(I+1))<a name='752'>
            <font color=#447700>!.... compute the pressure value pval at temperature tval<a name='753'></font>
            PVAL = ((1.0 - FRACT) * PA(I)) + (FRACT * PA(I+1))<a name='754'>
          <a name='755'>
            <font color=#447700>!End loop<a name='756'></font>
            IFOUT=0<a name='757'>
            EXIT<a name='758'>
         ENDIF<a name='759'>
      ENDDO<a name='760'>
      <a name='761'>
  END SUBROUTINE INTERPP<a name='762'>
<a name='763'>
<a name='764'>
<a name='765'>
<A NAME='INTERP'><A href='../../html_code/phys/module_diag_hailcast.F.html#INTERP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='766'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>INTERP</font>(AA,A,P,IFOUT,PA,ITEL) <A href='../../call_to/INTERP.html' TARGET='index'>9</A><a name='767'>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='768'></font>
  <font color=#447700>!<a name='769'></font>
  <font color=#447700>! INTERP: to linearly interpolate values of A at level P<a name='770'></font>
  <font color=#447700>!   between two levels of AA (at levels PA)<a name='771'></font>
  <font color=#447700>!<a name='772'></font>
  <font color=#447700>! INPUT: AA    1D array of variable<a name='773'></font>
  <font color=#447700>!        PA    1D array of pressure<a name='774'></font>
  <font color=#447700>!        P     new pressure level we want to calculate A at<a name='775'></font>
  <font color=#447700>!        IFOUT set to 0 if P outside range of PA<a name='776'></font>
  <font color=#447700>!        ITEL  number of vertical levels<a name='777'></font>
  <font color=#447700>! OUTPUT: A    variable at pressure level P<a name='778'></font>
  <font color=#447700>!<a name='779'></font>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='780'></font>
      IMPLICIT NONE<a name='781'>
      <a name='782'>
      REAL A, P<a name='783'>
      REAL, DIMENSION( ITEL) :: AA, PA<a name='784'>
      INTEGER ITEL, IFOUT<a name='785'>
      <font color=#447700>!local variables<a name='786'></font>
      INTEGER I<a name='787'>
      REAL PDIFF, VDIFF, RDIFF, VERH, ADIFF<a name='788'>
      <a name='789'>
      IFOUT=1<a name='790'>
      <a name='791'>
      DO I=1,ITEL-1<a name='792'>
        IF (P.LE.PA(I) .AND. P.GT.PA(I+1)) THEN<a name='793'>
          <font color=#447700>!Calculate ratio between vdiff and pdiff<a name='794'></font>
          PDIFF = PA(I)-PA(I+1)<a name='795'>
          VDIFF = PA(I)-P<a name='796'>
          VERH = VDIFF/PDIFF     <a name='797'>
          <a name='798'>
          <font color=#447700>!Calculate the difference between the 2 A values<a name='799'></font>
          RDIFF = AA(I+1) - AA(I)<a name='800'>
          <a name='801'>
          <font color=#447700>!Calculate new value<a name='802'></font>
          A = AA(I) + RDIFF*VERH<a name='803'>
          <a name='804'>
          <font color=#447700>!End loop<a name='805'></font>
          IFOUT=0<a name='806'>
          EXIT<a name='807'>
        ENDIF<a name='808'>
      ENDDO<a name='809'>
      <a name='810'>
  END SUBROUTINE INTERP<a name='811'>
      <a name='812'>
<a name='813'>
<A NAME='TERMINL'><A href='../../html_code/phys/module_diag_hailcast.F.html#TERMINL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='814'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>TERMINL</font>(DENSA,DENSE,D,VT,TC) <A href='../../call_to/TERMINL.html' TARGET='index'>1</A><a name='815'>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='816'></font>
  <font color=#447700>!<a name='817'></font>
  <font color=#447700>! INTERP: Calculate terminal velocity of the hailstone<a name='818'></font>
  <font color=#447700>!<a name='819'></font>
  <font color=#447700>! INPUT: DENSA  density of updraft air (kg/m3)<a name='820'></font>
  <font color=#447700>!        DENSE  density of hailstone<a name='821'></font>
  <font color=#447700>!        D      diameter of hailstone (m)<a name='822'></font>
  <font color=#447700>!        TC     updraft temperature (K)<a name='823'></font>
  <font color=#447700>! OUTPUT:VT     hailstone terminal velocity (m/s)<a name='824'></font>
  <font color=#447700>!<a name='825'></font>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='826'></font>
      IMPLICIT NONE<a name='827'>
      <a name='828'>
      REAL*8 D<a name='829'>
      REAL DENSA, DENSE, TC, VT<a name='830'>
      REAL GMASS, GX, RE, W, Y<a name='831'>
      REAL, PARAMETER :: PI = 3.141592654, G = 9.78956<a name='832'>
      REAL ANU<a name='833'>
      <a name='834'>
      <font color=#447700>!Mass of stone in kg<a name='835'></font>
      GMASS = (DENSE * PI * (D**3.)) / 6.<a name='836'>
      <a name='837'>
      <font color=#447700>!Dynamic viscosity<a name='838'></font>
      ANU = (0.00001718)*(273.155+120.)/(TC+120.)*(TC/273.155)**(1.5)<a name='839'>
      <a name='840'>
      <font color=#447700>!CALC THE BEST NUMBER, X AND REYNOLDS NUMBER, RE <a name='841'></font>
      GX=(8.0*GMASS*G*DENSA)/(PI*(ANU*ANU))<a name='842'>
      RE=(GX/0.6)**0.5<a name='843'>
<a name='844'>
      <font color=#447700>!SELECT APPROPRIATE EQUATIONS FOR TERMINAL VELOCITY DEPENDING ON <a name='845'></font>
      <font color=#447700>!THE BEST NUMBER<a name='846'></font>
      IF (GX.LT.550) THEN<a name='847'>
        W=LOG10(GX)<a name='848'>
        Y= -1.7095 + 1.33438*W - 0.11591*(W**2.0)      <a name='849'>
        RE=10**Y<a name='850'>
        VT=ANU*RE/(D*DENSA)<a name='851'>
      ELSE IF (GX.GE.550.AND.GX.LT.1800) THEN<a name='852'>
        W=LOG10(GX)<a name='853'>
        Y= -1.81391 + 1.34671*W - 0.12427*(W**2.0) + 0.0063*(W**3.0)<a name='854'>
        RE=10**Y<a name='855'>
        VT=ANU*RE/(D*DENSA)<a name='856'>
      ELSE IF (GX.GE.1800.AND.GX.LT.3.45E08) THEN<a name='857'>
        RE=0.4487*(GX**0.5536)<a name='858'>
        VT=ANU*RE/(D*DENSA)<a name='859'>
      ELSE <a name='860'>
        RE=(GX/0.6)**0.5<a name='861'>
        VT=ANU*RE/(D*DENSA)<a name='862'>
      ENDIF<a name='863'>
      <a name='864'>
  END SUBROUTINE TERMINL   <a name='865'>
<a name='866'>
   <a name='867'>
   <a name='868'>
<A NAME='VAPORCLOSE'><A href='../../html_code/phys/module_diag_hailcast.F.html#VAPORCLOSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='869'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>VAPORCLOSE</font>(DELRW,PC,TS,TC,ITYPE) <A href='../../call_to/VAPORCLOSE.html' TARGET='index'>1</A><a name='870'>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='871'></font>
  <font color=#447700>!  VAPORCLOSE: CALC THE DIFFERENCE IN SATURATION VAPOUR DENSITY <a name='872'></font>
  <font color=#447700>!  BETWEEN THAT OVER THE HAILSTONE'S SURFACE AND THE IN-CLOUD <a name='873'></font>
  <font color=#447700>!  AIR, DEPENDS ON THE WATER/ICE RATIO OF THE UPDRAFT, <a name='874'></font>
  <font color=#447700>!  AND IF THE STONE IS IN WET OR DRY GROWTH REGIME<a name='875'></font>
  <font color=#447700>!<a name='876'></font>
  <font color=#447700>!  INPUT:  PC    fraction of updraft water that is frozen<a name='877'></font>
  <font color=#447700>!          TS    temperature of hailstone (K)<a name='878'></font>
  <font color=#447700>!          TC    temperature of updraft air (K)<a name='879'></font>
  <font color=#447700>!          ITYPE wet (2) or dry (1) growth regime<a name='880'></font>
  <font color=#447700>!  OUTPUT: DELRW difference in sat vap. dens. between hail and air<a name='881'></font>
  <font color=#447700>!          (kg/m3)<a name='882'></font>
  <font color=#447700>!<a name='883'></font>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='884'></font>
<a name='885'>
      IMPLICIT NONE<a name='886'>
      REAL DELRW, PC, TS, TC<a name='887'>
      INTEGER ITYPE<a name='888'>
      <font color=#447700>!local variables<a name='889'></font>
      REAL RV, ALV, ALS, RATIO<a name='890'>
      DATA RV/461.48/,ALV/2500000./,ALS/2836050./ <a name='891'>
      REAL ESAT, RHOKOR, ESATW, RHOOMGW, ESATI, RHOOMGI, RHOOMG<a name='892'>
<a name='893'>
      <font color=#447700>!  FOR HAILSTONE:  FIRST TEST IF STONE IS IN WET OR DRY GROWTH<a name='894'></font>
      RATIO = 1./273.155<a name='895'>
      IF(ITYPE.EQ.2) THEN <font color=#447700>!!WET GROWTH<a name='896'></font>
        ESAT=611.*EXP(ALV/RV*(RATIO-1./TS))<a name='897'>
      ELSE  <font color=#447700>!!DRY GROWTH<a name='898'></font>
        ESAT=611.*EXP(ALS/RV*(RATIO-1./TS))<a name='899'>
      ENDIF<a name='900'>
      RHOKOR=ESAT/(RV*TS)<a name='901'>
      <a name='902'>
      <font color=#447700>!  NOW FOR THE AMBIENT/IN-CLOUD CONDITIONS <a name='903'></font>
      ESATW=611.*EXP(ALV/RV*(RATIO-1./TC))<a name='904'>
      RHOOMGW=ESATW/(RV*TC)<a name='905'>
      ESATI=611.*EXP(ALS/RV*(RATIO-1./TC))<a name='906'>
      RHOOMGI=ESATI/(RV*TC)<a name='907'>
      <font color=#447700>!RHOOMG=PC*(RHOOMGI-RHOOMGW)+RHOOMGW<a name='908'></font>
      RHOOMG = RHOOMGI  <font color=#447700>!done as in hailtraj.f<a name='909'></font>
<a name='910'>
      <font color=#447700>!  CALC THE DIFFERENCE(KG/M3): &lt;0 FOR CONDENSATION, <a name='911'></font>
      <font color=#447700>!  &gt;0 FOR EVAPORATION<a name='912'></font>
      DELRW=(RHOKOR-RHOOMG) <a name='913'>
<a name='914'>
  END SUBROUTINE VAPORCLOSE<a name='915'>
     <a name='916'>
      <a name='917'>
<a name='918'>
<A NAME='MASSAGR'><A href='../../html_code/phys/module_diag_hailcast.F.html#MASSAGR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='919'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>MASSAGR</font>(D,GM,GM1,GMW,GMI,DGM,DGMW,DGMI,DGMV,DI,ANU,RE,AE,&amp;  <A href='../../call_to/MASSAGR.html' TARGET='index'>1</A><a name='920'>
                 TC,TS,P,DENSE,DENSA,FW,VT,XW,XI,SEKDEL,ITYPE,DELRW) <a name='921'>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='922'></font>
  <font color=#447700>! CALC THE STONE'S INCREASE IN MASS <a name='923'></font>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='924'></font>
            <a name='925'>
      IMPLICIT NONE<a name='926'>
      REAL*8 D<a name='927'>
      REAL GM,GM1,GMW,GMI,DGM,DGMW,DGMI,DI,ANU,RE,AE,  &amp;<a name='928'>
                 TC,TS,P,DENSE,DENSA,FW,VT,XW,XI,SEKDEL,DELRW<a name='929'>
      INTEGER ITYPE <a name='930'>
      <font color=#447700>!local variables<a name='931'></font>
      REAL PI, D0, GMW2, GMI2, EW, EI,DGMV<a name='932'>
      REAL DENSEL, DENSELI, DENSELW <a name='933'>
      REAL DC <font color=#447700>!MEAN CLOUD DROPLET DIAMETER (MICRONS, 1E-6M)<a name='934'></font>
      REAL VOLL, VOLT <font color=#447700>!VOLUME OF NEW LAYER, TOTAL (M3)<a name='935'></font>
      REAL VOL1, DGMW_NOSOAK, SOAK, SOAKM<a name='936'>
      REAL DENSAC, E<a name='937'>
      PI=3.141592654<a name='938'>
<a name='939'>
      <font color=#447700>!  CALCULATE THE DIFFUSIVITY DI (m2/s)<a name='940'></font>
      D0=0.226*1.E-4  <font color=#447700>! change to m2/s, not cm2/s<a name='941'></font>
      DI=D0*(TC/273.155)**1.81*(100000./P)<a name='942'>
  <a name='943'>
      <font color=#447700>!  COLLECTION EFFICIENCY FOR WATER AND ICE <a name='944'></font>
      <font color=#447700>!EW=1.0      <a name='945'></font>
      <font color=#447700>!   IF TS WARMER THAN -5C THEN ACCRETE ALL THE ICE (EI=1.0) <a name='946'></font>
      <font color=#447700>!   OTHERWISE EI=0.21      <a name='947'></font>
      <font color=#447700>!IF(TS.GE.268.15)THEN<a name='948'></font>
      <font color=#447700>!  EI=1.00<a name='949'></font>
      <font color=#447700>!ELSE<a name='950'></font>
      <font color=#447700>!  EI=0.21<a name='951'></font>
      <font color=#447700>!ENDIF<a name='952'></font>
<a name='953'>
      <font color=#447700>!  COLLECTION EFFICIENCY FOR WATER AND ICE <a name='954'></font>
      EW=1.0      <a name='955'>
      <font color=#447700>!  Linear function for ice accretion efficiency<a name='956'></font>
      IF (TC .GE. 273.155) THEN<a name='957'>
         EI=1.00<a name='958'>
      ELSE IF (TC.GE.233.155) THEN<a name='959'>
         EI= 1.0 - ( (273.155 - TS) / 40. )<a name='960'>
      ELSE  <font color=#447700>!cooler than -40C<a name='961'></font>
         EI = 0.0<a name='962'>
      ENDIF<a name='963'>
<a name='964'>
      <font color=#447700>!  CALCULATE THE VENTILATION COEFFICIENT - NEEDED FOR GROWTH FROM VAPOR<a name='965'></font>
      <font color=#447700>!The coefficients in the ventilation coefficient equations have been <a name='966'></font>
      <font color=#447700>!experimentally derived, and are expecting cal-C-g units.  Do some conversions.<a name='967'></font>
      DENSAC = DENSA * (1.E3) * (1.E-6)<a name='968'>
      <font color=#447700>!dynamic viscosity <a name='969'></font>
      ANU=1.717E-4*(393.0/(TC+120.0))*(TC/273.155)**1.5<a name='970'>
      <font color=#447700>!  CALCULATE THE REYNOLDS NUMBER - unitless<a name='971'></font>
      RE=D*VT*DENSAC/ANU   <a name='972'>
      E=(0.60)**(0.333333333)*(RE**0.50) <font color=#447700>!ventilation coefficient vapor (fv)<a name='973'></font>
      <font color=#447700>!   SELECT APPROPRIATE VALUES OF AE ACCORDING TO RE<a name='974'></font>
      IF(RE.LT.6000.0)THEN<a name='975'>
         AE=0.78+0.308*E<a name='976'>
      ELSEIF(RE.GE.6000.0.AND.RE.LT.20000.0)THEN<a name='977'>
         AE=0.76*E<a name='978'>
      ELSEIF(RE.GE.20000.0) THEN<a name='979'>
         AE=(0.57+9.0E-6*RE)*E<a name='980'>
      ENDIF<a name='981'>
<a name='982'>
<a name='983'>
      <font color=#447700>!  CALC HAILSTONE'S MASS (GM), MASS OF WATER (GMW) AND THE  <a name='984'></font>
      <font color=#447700>!  MASS OF ICE IN THE STONE (GMI)<a name='985'></font>
      GM=PI/6.*(D**3.)*DENSE<a name='986'>
      GMW=FW*GM<a name='987'>
      GMI=GM-GMW<a name='988'>
  <a name='989'>
      <font color=#447700>!  STORE THE MASS<a name='990'></font>
      GM1=GM<a name='991'>
      <a name='992'>
      <font color=#447700>! NEW MASS GROWTH CALCULATIONS WITH VARIABLE RIME <a name='993'></font>
      <font color=#447700>! LAYER DENSITY BASED ON ZIEGLER ET AL. (1983)<a name='994'></font>
      <a name='995'>
      <font color=#447700>! CALCULATE INCREASE IN MASS DUE INTERCEPTED CLD WATER, USE<a name='996'></font>
      <font color=#447700>! ORIGINAL DIAMETER<a name='997'></font>
      GMW2=GMW+SEKDEL*(PI/4.*D**2.*VT*XW*EW)<a name='998'>
      DGMW=GMW2-GMW <a name='999'>
      GMW=GMW2<a name='1000'>
<a name='1001'>
      <font color=#447700>!  CALCULATE THE INCREASE IN MASS DUE INTERCEPTED CLOUD ICE<a name='1002'></font>
      GMI2=GMI+SEKDEL*(PI/4.*D**2.*VT*XI*EI)<a name='1003'>
      DGMI=GMI2-GMI <a name='1004'>
      GMI=GMI2<a name='1005'>
  <a name='1006'>
      <font color=#447700>! CALCULATE INCREASE IN MASS DUE TO SUBLIMATION/CONDENSATION OF <a name='1007'></font>
      <font color=#447700>! WATER VAPOR<a name='1008'></font>
      DGMV = SEKDEL*2*PI*D*AE*DI*DELRW<a name='1009'>
      IF (DGMV .LT. 0) DGMV=0<a name='1010'>
<a name='1011'>
      <font color=#447700>!  CALCULATE THE TOTAL MASS CHANGE <a name='1012'></font>
      DGM=DGMW+DGMI+DGMV<a name='1013'>
      <font color=#447700>! CALCULATE DENSITY OF NEW LAYER, DEPENDS ON FW AND ITYPE<a name='1014'></font>
      IF (ITYPE.EQ.1) THEN <font color=#447700>!DRY GROWTH<a name='1015'></font>
          <font color=#447700>!If hailstone encountered supercooled water, calculate new layer density <a name='1016'></font>
          <font color=#447700>! using Macklin form<a name='1017'></font>
          IF ((DGMW.GT.0).OR.(DGMV.GT.0)) THEN<a name='1018'>
             <font color=#447700>!MEAN CLOUD DROPLET RADIUS, ASSUME CLOUD DROPLET CONC OF 3E8 M-3 (300 CM-3)<a name='1019'></font>
             DC = (0.74*XW / (3.14159*1000.*3.E8))**0.33333333 * 1.E6 <font color=#447700>!MICRONS<a name='1020'></font>
             <font color=#447700>!RIME LAYER DENSITY, MACKLIN FORM<a name='1021'></font>
             DENSELW = 0.11*(DC*VT / (273.16-TS))**0.76 <font color=#447700>!G CM-3<a name='1022'></font>
             DENSELW = DENSELW * 1000. <font color=#447700>!KG M-3<a name='1023'></font>
             <font color=#447700>!BOUND POSSIBLE DENSITIES<a name='1024'></font>
             IF (DENSELW.LT.100) DENSELW=100<a name='1025'>
             IF (DENSELW.GT.900) DENSELW=900<a name='1026'>
          ENDIF<a name='1027'>
          IF (DGMI.GT.0) THEN<a name='1028'>
             <font color=#447700>!Ice collection main source of growth, so set new density layer<a name='1029'></font>
             <font color=#447700>! to value calculated from Thompson et al. 2008 snow-diameter relation<a name='1030'></font>
             <font color=#447700>!Mean cloud ice/snow radius, assume concentration of 1E3 M-3<a name='1031'></font>
             <font color=#447700>! Chose 1E3 because median cloud ice concentration in <a name='1032'></font>
             <font color=#447700>! look up table in Thompson mp code in WRF<a name='1033'></font>
             DI = (0.74*XI / (3.14159*1000.*1.E3))**0.33333333 <font color=#447700>!M<a name='1034'></font>
             DENSELI = 0.13 / DI  <font color=#447700>!kg m-3<a name='1035'></font>
             IF (DENSELI .LT. 100) THEN<a name='1036'>
                 DENSELI = 100.<a name='1037'>
             ENDIF<a name='1038'>
             IF (DENSELI .GT. 900) THEN<a name='1039'>
                 DENSELI = 900.<a name='1040'>
             ENDIF<a name='1041'>
          ENDIF<a name='1042'>
          <a name='1043'>
          <font color=#447700>!All liquid water contributes to growth, none is soaked into center.<a name='1044'></font>
          DGMW_NOSOAK = DGMW  <font color=#447700>!All liquid water contributes to growth,<a name='1045'></font>
                              <font color=#447700>! none of it is soaked into center.<a name='1046'></font>
<a name='1047'>
      ELSE <font color=#447700>!WET GROWTH<a name='1048'></font>
          <font color=#447700>!Collected liquid water can soak into the stone before freezing,<a name='1049'></font>
          <font color=#447700>! increasing mass and density but leaving volume constant.<a name='1050'></font>
          <font color=#447700>!Volume of current drop, before growth <a name='1051'></font>
          VOL1 = GM/DENSE<a name='1052'>
          <font color=#447700>!Difference b/w mass of stone if density is 900 kg/m3, and<a name='1053'></font>
          <font color=#447700>! current mass<a name='1054'></font>
          SOAK = 900*VOL1 - GM<a name='1055'>
          <font color=#447700>!Liquid mass available<a name='1056'></font>
          SOAKM = DGMW<a name='1057'>
          <font color=#447700>!Soak up as much liquid as we can, up to a density of 900 kg/m3<a name='1058'></font>
          IF (SOAKM.GT.SOAK) SOAKM=SOAK<a name='1059'>
          GM = GM+SOAKM  <font color=#447700>!Mass of current drop, plus soaking<a name='1060'></font>
          <font color=#447700>!New density of current drop, including soaking but before growth<a name='1061'></font>
          DENSE = GM/VOL1 <a name='1062'>
          <font color=#447700>!Mass increment of liquid water growth that doesn't<a name='1063'></font>
          <font color=#447700>! include the liquid water we just soaked into the stone.<a name='1064'></font>
          DGMW_NOSOAK = DGMW - SOAKM<a name='1065'>
          <a name='1066'>
          <font color=#447700>!Whatever growth does occur has high density<a name='1067'></font>
          DENSELW = 900.  <font color=#447700>!KG M-3<a name='1068'></font>
          DENSELI = 900.<a name='1069'>
         <a name='1070'>
      ENDIF<a name='1071'>
<a name='1072'>
      <font color=#447700>!VOLUME OF NEW LAYER<a name='1073'></font>
      <font color=#447700>!VOLL = (DGM) / DENSEL<a name='1074'></font>
      <font color=#447700>!VOLL = (DGMI+DGMV+DGMW_NOSOAK) / DENSEL<a name='1075'></font>
      <font color=#447700>!VOLL = (DGMI) / DENSELI + (DGMW_NOSOAK+DGMV) / DENSELW<a name='1076'></font>
      IF (DGMI.LE.0) THEN<a name='1077'>
         VOLL = (DGMW_NOSOAK+DGMV) / DENSELW<a name='1078'>
      ELSE IF (DGMW.LE.0) THEN<a name='1079'>
         VOLL = (DGMI) / DENSELI<a name='1080'>
      ELSE<a name='1081'>
         VOLL = (DGMI) / DENSELI + (DGMW_NOSOAK+DGMV) / DENSELW<a name='1082'>
      ENDIF<a name='1083'>
<a name='1084'>
      <font color=#447700>!NEW TOTAL VOLUME, DENSITY, DIAMETER<a name='1085'></font>
      VOLT = VOLL + GM/DENSE<a name='1086'>
      <font color=#447700>!DENSE = (GM+DGM) / VOLT<a name='1087'></font>
      DENSE = (GM+DGMI+DGMV+DGMW_NOSOAK) / VOLT<a name='1088'>
      <font color=#447700>!D=D+SEKDEL*0.5*VT/DENSE*(XW*EW+XI*EI)      <a name='1089'></font>
      GM = GM+DGMI+DGMW_NOSOAK+DGMV<a name='1090'>
      D = ( (6*GM) / (PI*DENSE) )**0.33333333 <a name='1091'>
<a name='1092'>
  END SUBROUTINE MASSAGR<a name='1093'>
<a name='1094'>
<a name='1095'>
<a name='1096'>
<A NAME='HEATBUD'><A href='../../html_code/phys/module_diag_hailcast.F.html#HEATBUD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1097'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>HEATBUD</font>(TS,TSm1,TSm2,FW,TC,VT,DELRW,D,DENSA,GM1,GM,DGM,DGMW,     &amp; <A href='../../call_to/HEATBUD.html' TARGET='index'>1</A><a name='1098'>
                     DGMV,DGMI,GMW,GMI,DI,ANU,RE,AE,SEKDEL,ITYPE,P)<a name='1099'>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1100'></font>
  <font color=#447700>! CALCULATE HAILSTONE'S HEAT BUDGET <a name='1101'></font>
  <font color=#447700>! See Rasmussen and Heymsfield 1987; JAS<a name='1102'></font>
  <font color=#447700>! Original Hailcast's variable units<a name='1103'></font>
  <font color=#447700>! TS - Celsius<a name='1104'></font>
  <font color=#447700>! FW - unitless, between 0 and 1<a name='1105'></font>
  <font color=#447700>! TC - Celsius<a name='1106'></font>
  <font color=#447700>! VT - m/s<a name='1107'></font>
  <font color=#447700>! D  - m<a name='1108'></font>
  <font color=#447700>! DELRW - g/cm3 (per comment)<a name='1109'></font>
  <font color=#447700>! DENSA - g/cm3 (per comment)<a name='1110'></font>
  <font color=#447700>! GM1, DMG, DGMW, DGMV, DGMI, GMW, GMI - should all be kg<a name='1111'></font>
  <font color=#447700>! DI - cm2 / sec<a name='1112'></font>
  <font color=#447700>! P  - hPa<a name='1113'></font>
  <font color=#447700>! Original HAILCAST HEATBUD subroutine uses c-g-s units, so do some conversions<a name='1114'></font>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1115'></font>
      IMPLICIT NONE<a name='1116'>
      REAL*8 D<a name='1117'>
      REAL TS,TSm1,TSm2,FW,TC,VT,DELRW,DENSA,GM1,GM,DGM,DGMW,DGMV,  &amp;<a name='1118'>
                    DGMI,GMW,GMI,DI,ANU,RE,AE,SEKDEL,P<a name='1119'>
      INTEGER ITYPE<a name='1120'>
      <a name='1121'>
      REAL RV, RD, G, PI, ALF, ALV, ALS, CI, CW, AK<a name='1122'>
      REAL H, AH, TCC, TSC, DELRWC, DENSAC, TDIFF<a name='1123'>
      REAL DMLT<a name='1124'>
      REAL TSCm1, TSCm2<a name='1125'>
      DATA RV/461.48/,RD/287.04/,G/9.78956/<a name='1126'>
      DATA PI/3.141592654/,ALF/79.7/,ALV/597.3/<a name='1127'>
      DATA ALS/677.0/,CI/0.5/,CW/1./<a name='1128'>
      <a name='1129'>
      <font color=#447700>!Convert values to non-SI units here<a name='1130'></font>
      TSC = TS - 273.155<a name='1131'>
      TSCm1 = TSm1 - 273.155<a name='1132'>
      TSCm2 = TSm2 - 273.155<a name='1133'>
      TCC = TC - 273.155<a name='1134'>
      DELRWC = DELRW * (1.E3) * (1.E-6)<a name='1135'>
      DENSAC = DENSA * (1.E3) * (1.E-6)<a name='1136'>
      <font color=#447700>!DI still in cm2/sec<a name='1137'></font>
<a name='1138'>
<a name='1139'>
      <font color=#447700>!  CALCULATE THE CONSTANTS <a name='1140'></font>
      AK=(5.8+0.0184*TCC)*1.E-5  <font color=#447700>!thermal conductivity - cal/(cm*sec*K)<a name='1141'></font>
      <font color=#447700>!dynamic viscosity - calculated in MASSAGR<a name='1142'></font>
      <font color=#447700>!ANU=1.717E-4*(393.0/(TC+120.0))*(TC/273.155)**1.5<a name='1143'></font>
<a name='1144'>
      <font color=#447700>!  CALCULATE THE REYNOLDS NUMBER - unitless<a name='1145'></font>
      <font color=#447700>!RE=D*VT*DENSAC/ANU  - calculated in MASSAGR  <a name='1146'></font>
      <a name='1147'>
      H=(0.71)**(0.333333333)*(RE**0.50) <font color=#447700>!ventilation coefficient heat (fh)<a name='1148'></font>
      <font color=#447700>!E=(0.60)**(0.333333333)*(RE**0.50) !ventilation coefficient vapor (fv)<a name='1149'></font>
<a name='1150'>
      <font color=#447700>!   SELECT APPROPRIATE VALUES OF AH AND AE ACCORDING TO RE<a name='1151'></font>
      IF(RE.LT.6000.0)THEN<a name='1152'>
         AH=0.78+0.308*H<a name='1153'>
         <font color=#447700>!AE=0.78+0.308*E<a name='1154'></font>
      ELSEIF(RE.GE.6000.0.AND.RE.LT.20000.0)THEN<a name='1155'>
         AH=0.76*H<a name='1156'>
         <font color=#447700>!AE=0.76*E<a name='1157'></font>
      ELSEIF(RE.GE.20000.0) THEN<a name='1158'>
         AH=(0.57+9.0E-6*RE)*H<a name='1159'>
         <font color=#447700>!AE=(0.57+9.0E-6*RE)*E  calculated in MASSAGR<a name='1160'></font>
      ENDIF<a name='1161'>
<a name='1162'>
      <font color=#447700>!  FOR DRY GROWTH FW=0, CALCULATE NEW TS, ITIPE=1 <a name='1163'></font>
      <font color=#447700>!  FOR WET GROWTH TS=0, CALCULATE NEW FW, ITIPE=2<a name='1164'></font>
<a name='1165'>
<a name='1166'>
      IF(ITYPE.EQ.1) THEN<a name='1167'>
      <font color=#447700>!  DRY GROWTH; CALC NEW TEMP OF THE STONE <a name='1168'></font>
         <font color=#447700>!Original Hailcast algorithm (no time differencing)<a name='1169'></font>
         <font color=#447700>!TSC=TSC-TSC*DGM/GM1+SEKDEL/(GM1*CI)*                &amp;<a name='1170'></font>
         <font color=#447700>!   (2.*PI*D*(AH*AK*(TCC-TSC)-AE*ALS*DI*DELRWC)+     &amp;<a name='1171'></font>
         <font color=#447700>!   DGMW/SEKDEL*(ALF+CW*TCC)+DGMI/SEKDEL*CI*TCC)<a name='1172'></font>
         TSC=0.6*(TSC-TSC*DGM/GM1+SEKDEL/(GM1*CI)*                &amp;<a name='1173'>
            (2.*PI*D*(AH*AK*(TCC-TSC)-AE*ALS*DI*DELRWC)+     &amp;<a name='1174'>
            DGMW/SEKDEL*(ALF+CW*TCC)+DGMI/SEKDEL*CI*TCC)) + &amp;<a name='1175'>
            0.2*TSCm1 + 0.2*TSCm2<a name='1176'>
         <a name='1177'>
         TS = TSC+273.155<a name='1178'>
         IF (TS.GE.273.155) THEN <a name='1179'>
            TS=273.155<a name='1180'>
            TDIFF = ABS(TS-273.155)<a name='1181'>
         ENDIF<a name='1182'>
         TDIFF = ABS(TS-273.155)         <a name='1183'>
         IF (TDIFF.LE.1.E-6) ITYPE=2  <font color=#447700>!NOW IN WET GROWTH<a name='1184'></font>
     <a name='1185'>
      ELSE IF (ITYPE.EQ.2) THEN<a name='1186'>
      <font color=#447700>!  WET GROWTH; CALC NEW FW          <a name='1187'></font>
         <a name='1188'>
         IF (TCC.LT.0.) THEN<a name='1189'>
            <font color=#447700>!Original Hailcast algorithm<a name='1190'></font>
            FW=FW-FW*DGM/GM1+SEKDEL/(GM1*ALF)*               &amp;<a name='1191'>
                (2.*PI*D*(AH*AK*TCC-AE*ALV*DI*DELRWC)+          &amp;<a name='1192'>
                DGMW/SEKDEL*(ALF+CW*TCC)+DGMI/SEKDEL*CI*TCC)<a name='1193'>
         ELSE<a name='1194'>
            <font color=#447700>!Calculate decrease in ice mass due to melting<a name='1195'></font>
            DMLT = (2.*PI*D*AH*AK*TCC + 2.*PI*D*AE*ALV*DI*DELRWC + &amp;<a name='1196'>
                    DGMW/SEKDEL*CW*TCC) / ALF<a name='1197'>
            FW = (FW*GM + DMLT) / GM<a name='1198'>
         ENDIF<a name='1199'>
         <a name='1200'>
         IF(FW.GT.1.)FW=1.<a name='1201'>
         IF(FW.LT.0.)FW=0.<a name='1202'>
<a name='1203'>
         <font color=#447700>!IF ALL OUR ACCRETED WATER WAS FROZEN, WE ARE BACK IN DRY GROWTH<a name='1204'></font>
         IF(FW.LE.1.E-6) THEN<a name='1205'>
            ITYPE=1  <a name='1206'>
         ENDIF<a name='1207'>
         <a name='1208'>
      ENDIF<a name='1209'>
<a name='1210'>
  END SUBROUTINE HEATBUD<a name='1211'>
<a name='1212'>
<a name='1213'>
  <a name='1214'>
<A NAME='BREAKUP'><A href='../../html_code/phys/module_diag_hailcast.F.html#BREAKUP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1215'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>BREAKUP</font>(DENSE,D,GM,FW) <A href='../../call_to/BREAKUP.html' TARGET='index'>3</A><a name='1216'>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1217'></font>
  <font color=#447700>!  INVOKE SHEDDING SCHEME <a name='1218'></font>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1219'></font>
<a name='1220'>
      IMPLICIT NONE<a name='1221'>
      REAL*8 D<a name='1222'>
      REAL DENSE, GM, FW<a name='1223'>
      <font color=#447700>!local variables<a name='1224'></font>
      REAL WATER, GMI, CRIT, WAT, PI<a name='1225'>
      DATA PI/3.141592654/<a name='1226'>
<a name='1227'>
      WATER=FW*GM  <font color=#447700>!KG<a name='1228'></font>
      <font color=#447700>!GMI=(GM-WATER) !KG<a name='1229'></font>
<a name='1230'>
      <font color=#447700>! CALC CRTICAL MASS CAPABLE OF BEING "SUPPORTED" ON THE STONE'S <a name='1231'></font>
      <font color=#447700>! SURFACE <a name='1232'></font>
      <font color=#447700>!CRIT=0.268+0.1389*GMI <a name='1233'></font>
      <font color=#447700>!CRIT=0.268*1.E-3 + 0.1389*1.E-3*GMI  !mass now in kg instead of g<a name='1234'></font>
      CRIT = 1.0E-10<a name='1235'>
<a name='1236'>
      <font color=#447700>!IF (WATER.GT.CRIT)THEN - test now occurs outside function<a name='1237'></font>
         WAT=WATER-CRIT<a name='1238'>
         GM=GM-WAT<a name='1239'>
         FW=(CRIT)/GM<a name='1240'>
       <a name='1241'>
         IF(FW.GT.1.0) FW=1.0<a name='1242'>
         IF(FW.LT.0.0) FW=0.0<a name='1243'>
<a name='1244'>
         <font color=#447700>! RECALCULATE DIAMETER AFTER SHEDDING <a name='1245'></font>
         <font color=#447700>! Assume density remains the same<a name='1246'></font>
         <font color=#447700>!DENSE=(FW*(0.1)+0.9) * 1000.  <a name='1247'></font>
         D=(6.*GM/(PI*DENSE))**(0.333333333)<a name='1248'>
      <font color=#447700>!ENDIF<a name='1249'></font>
  END SUBROUTINE BREAKUP<a name='1250'>
  <a name='1251'>
  <a name='1252'>
<A NAME='MELT'><A href='../../html_code/phys/module_diag_hailcast.F.html#MELT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1253'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>MELT</font>(D,TLAYER,PLAYER,RLAYER,LDEPTH,VT) <A href='../../call_to/MELT.html' TARGET='index'>1</A><a name='1254'>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1255'></font>
  <font color=#447700>!  This is a spherical hail melting estimate based on the Goyer <a name='1256'></font>
  <font color=#447700>!  et al. (1969) eqn (3).  The depth of the warm layer, estimated <a name='1257'></font>
  <font color=#447700>!  terminal velocity, and mean temperature of the warm layer are <a name='1258'></font>
  <font color=#447700>!  used.  DRB.  11/17/2003.<a name='1259'></font>
  <font color=#447700>!<a name='1260'></font>
  <font color=#447700>!  INPUT:  TLAYER   mean sub-cloud layer temperature (K)<a name='1261'></font>
  <font color=#447700>!          PLAYER   mean sub-cloud layer pressure (Pa)<a name='1262'></font>
  <font color=#447700>!          RLAYER   mean sub-cloud layer mixing ratio (kg/kg)<a name='1263'></font>
  <font color=#447700>!          VT       terminal velocity of stone (m/s)<a name='1264'></font>
  <font color=#447700>!  OUTPUT: D        diameter (m)<a name='1265'></font>
  <font color=#447700>!          <a name='1266'></font>
  <font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1267'></font>
      IMPLICIT NONE<a name='1268'>
<a name='1269'>
      REAL*8 D<a name='1270'>
      REAL TLAYER, PLAYER, RLAYER, LDEPTH, VT<a name='1271'>
      REAL eenv, delta, ewet, de, der, wetold, wetbulb, wetbulbk<a name='1272'>
      REAL tdclayer, tclayer, eps, b, hplayer<a name='1273'>
      REAL*8 a<a name='1274'>
      REAL sd, lt, ka, lf, lv, t0, dv, pi, rv, rhoice, &amp;<a name='1275'>
           tres, re, delt, esenv, rhosenv, essfc, rhosfc, dsig, &amp;<a name='1276'>
           dmdt, mass, massorg, newmass, gamma, r, rho<a name='1277'>
      INTEGER wcnt<a name='1278'>
      <a name='1279'>
      <font color=#447700>!Convert temp to Celsius, calculate dewpoint in celsius<a name='1280'></font>
      tclayer = TLAYER - 273.155<a name='1281'>
      a = 2.53E11<a name='1282'>
      b = 5.42E3<a name='1283'>
      tdclayer = b / LOG(a*eps / (rlayer*player))<a name='1284'>
      hplayer = player / 100.<a name='1285'>
      <a name='1286'>
      <font color=#447700>!Calculate partial vapor pressure<a name='1287'></font>
      eps = 0.622<a name='1288'>
      eenv = (player*rlayer) / (rlayer+eps)<a name='1289'>
      eenv = eenv / 100.  <font color=#447700>!convert to mb<a name='1290'></font>
      <a name='1291'>
      <font color=#447700>!Estimate wet bulb temperature (C)<a name='1292'></font>
      gamma = 6.6E-4*player<a name='1293'>
      delta = (4098.0*eenv)/((tdclayer+237.7)*(tdclayer+237.7))<a name='1294'>
      wetbulb = ((gamma*tclayer)+(delta*tdclayer))/(gamma+delta)<a name='1295'>
      <a name='1296'>
      <font color=#447700>!Iterate to get exact wet bulb<a name='1297'></font>
      wcnt = 0<a name='1298'>
      DO WHILE (wcnt .lt. 11)<a name='1299'>
        ewet = 6.108*(exp((17.27*wetbulb)/(237.3 + wetbulb))) <a name='1300'>
        de = (0.0006355*hplayer*(tclayer-wetbulb))-(ewet-eenv)<a name='1301'>
        der= (ewet*(.0091379024 - (6106.396/(273.155+wetbulb)**2))) &amp;<a name='1302'>
             - (0.0006355*hplayer)<a name='1303'>
        wetold = wetbulb<a name='1304'>
        wetbulb = wetbulb - de/der<a name='1305'>
        wcnt = wcnt + 1<a name='1306'>
        IF ((abs(wetbulb-wetold)/wetbulb.gt.0.0001)) THEN<a name='1307'>
           EXIT<a name='1308'>
        ENDIF<a name='1309'>
      ENDDO<a name='1310'>
      <a name='1311'>
      wetbulbk = wetbulb + 273.155  <font color=#447700>!convert to K<a name='1312'></font>
      ka = .02 <font color=#447700>! thermal conductivity of air<a name='1313'></font>
      lf = 3.34e5 <font color=#447700>! latent heat of melting/fusion<a name='1314'></font>
      lv = 2.5e6  <font color=#447700>! latent heat of vaporization<a name='1315'></font>
      t0 = 273.155 <font color=#447700>! temp of ice/water melting interface<a name='1316'></font>
      dv = 0.25e-4 <font color=#447700>! diffusivity of water vapor (m2/s)<a name='1317'></font>
      pi = 3.1415927<a name='1318'>
      rv = 1004. - 287. <font color=#447700>! gas constant for water vapor<a name='1319'></font>
      rhoice = 917.0 <font color=#447700>! density of ice (kg/m**3)<a name='1320'></font>
      r = D/2. <font color=#447700>! radius of stone (m)<a name='1321'></font>
      <a name='1322'>
      <font color=#447700>!Compute residence time in warm layer<a name='1323'></font>
      tres = LDEPTH / VT<a name='1324'>
        <a name='1325'>
      <font color=#447700>!Calculate dmdt based on eqn (3) of Goyer et al. (1969)<a name='1326'></font>
      <font color=#447700>!Reynolds number...from pg 317 of Atmo Physics (Salby 1996)<a name='1327'></font>
      <font color=#447700>!Just use the density of air at 850 mb...close enough.<a name='1328'></font>
      rho = 85000./(287.*TLAYER)<a name='1329'>
      re = rho*r*VT*.01/1.7e-5<a name='1330'>
      <a name='1331'>
      <font color=#447700>!Temperature difference between environment and hailstone surface<a name='1332'></font>
      delt = wetbulb <font color=#447700>!- 0.0 !assume stone surface is at 0C<a name='1333'></font>
                            <font color=#447700>!wetbulb is in Celsius<a name='1334'></font>
<a name='1335'>
      <font color=#447700>!Difference in vapor density of air stream and equil vapor<a name='1336'></font>
      <font color=#447700>!density at the sfc of the hailstone<a name='1337'></font>
      esenv = 610.8*(exp((17.27*wetbulb)/  &amp;<a name='1338'>
               (237.3 + wetbulb))) <font color=#447700>! es environment in Pa<a name='1339'></font>
      rhosenv = esenv/(rv*wetbulbk)<a name='1340'>
      essfc = 610.8*(exp((17.27*(t0-273.155))/  &amp;<a name='1341'>
               (237.3 + (t0-273.155)))) <font color=#447700>! es environment in Pa<a name='1342'></font>
      rhosfc = essfc/(rv*t0)<a name='1343'>
      dsig = rhosenv - rhosfc<a name='1344'>
<a name='1345'>
      <font color=#447700>!Calculate new mass growth<a name='1346'></font>
      dmdt = (-1.7*pi*r*(re**0.5)/lf)*((ka*delt)+((lv-lf)*dv*dsig))<a name='1347'>
      IF (dmdt.gt.0.) dmdt = 0<a name='1348'>
      mass = dmdt*tres<a name='1349'>
      <a name='1350'>
      <font color=#447700>!Find the new hailstone diameter<a name='1351'></font>
      massorg = 1.33333333*pi*r*r*r*rhoice<a name='1352'>
      newmass = massorg + mass<a name='1353'>
      if (newmass.lt.0.0) newmass = 0.0<a name='1354'>
      D = 2.*(0.75*newmass/(pi*rhoice))**0.333333333<a name='1355'>
  END SUBROUTINE MELT<a name='1356'>
<a name='1357'>
  <a name='1358'>
END MODULE module_diag_hailcast<a name='1359'>
<a name='1360'>
#endif<a name='1361'>
</pre></body></html>