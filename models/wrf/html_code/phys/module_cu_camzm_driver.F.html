<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_CU_CAMZM_DRIVER'><A href='../../html_code/phys/module_cu_camzm_driver.F.html#MODULE_CU_CAMZM_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_camzm_driver</font> <A href='../../call_to/MODULE_CU_CAMZM_DRIVER.html' TARGET='index'>2</A><a name='3'>
<a name='4'>
  <font color=#447700>!Roughly based on zm_conv_intr.F90 from CAM<a name='5'></font>
  <a name='6'>
  <font color=#447700>!-------------------------------------------<a name='7'></font>
  <font color=#447700>!Future Modifications and important warning (BSINGH:02/01/2013: Notes from WIG):<a name='8'></font>
  <font color=#447700>!===========================================<a name='9'></font>
  <font color=#447700>!1. Fracis is hardwired to 1 for first 3 constituents (vapor,liq mass,ice mass) <a name='10'></font>
  <font color=#447700>!   for WRF_CHEM simulations and first 5 constituents(liq # and ice #) for WRF<a name='11'></font>
  <font color=#447700>!   physcis ONLY runs. Should be generalized for other constituents (like snow,graupel etc.)<a name='12'></font>
  <font color=#447700>!<a name='13'></font>
  <font color=#447700>!2. In CAM model, ZM scheme only acts up to 40 mb. In WRF, it will function all the way <a name='14'></font>
  <font color=#447700>!   to the model top no matter how high it is. We could do a better job at capping this <a name='15'></font>
  <font color=#447700>!   by checking to see where 40 mb roughly occurs during initialization. It won't change <a name='16'></font>
  <font color=#447700>!   too dramatically over time. Also, WRF often uses a top of 50 mb, so we rarely hit 40 mb.<a name='17'></font>
  <font color=#447700>!   This is a minor issue.<a name='18'></font>
  <font color=#447700>!3. ZM is set to never do convection w/in the PBL. In CAM model, this is dependent on the <a name='19'></font>
  <font color=#447700>!   use of UW shallow. Should this be a conditional setting in WRF or hard-wired as it <a name='20'></font>
  <font color=#447700>!   currently is?<a name='21'></font>
  <font color=#447700>!-----------------------------------------<a name='22'></font>
<a name='23'>
<a name='24'>
  USE <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#module_cu_camzm_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_42">, only: pcnst =&gt;pcnst_runtime, pcols, pver, pverp<a name='25'>
#if ( WRF_CHEM == 1 )<a name='26'>
  USE <A href='../../html_code/phys/module_cam_support.F.html#MODULE_CAM_SUPPORT'>module_cam_support</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#module_cu_camzm_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CAM_SUPPORT_43">, only: cam_mam_aerosols<a name='27'>
#endif<a name='28'>
  USE <A href='../../html_code/phys/module_cam_shr_kind_mod.F.html#SHR_KIND_MOD'>shr_kind_mod</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#module_cu_camzm_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHR_KIND_MOD_25">,    only: r8 =&gt; shr_kind_r8<a name='29'>
  USE <A href='../../html_code/phys/module_cu_camzm.F.html#MODULE_CU_CAMZM'>module_cu_camzm</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#module_cu_camzm_driver.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CU_CAMZM_1">, only: convtran, momtran, zm_conv_evap, zm_convr<a name='30'>
<a name='31'>
  IMPLICIT NONE<a name='32'>
<a name='33'>
  PRIVATE                  <font color=#447700>!Default to private<a name='34'></font>
  PUBLIC :: &amp;              <font color=#447700>!Public entities<a name='35'></font>
       camzm_driver  , &amp;<a name='36'>
#if ( WRF_CHEM == 1 )<a name='37'>
       zm_conv_tend_2, &amp;<a name='38'>
#endif<a name='39'>
       zm_conv_init<a name='40'>
<a name='41'>
  <font color=#447700>!Module level variables which are required for zm_conv_tend_2 subrouine<a name='42'></font>
  integer :: ixcldliq, ixcldice, ixnumliq, ixnumice<a name='43'>
  <a name='44'>
CONTAINS<a name='45'>
<a name='46'>
<font color=#447700>!------------------------------------------------------------------------<a name='47'></font>
<A NAME='CAMZM_DRIVER'><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='48'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>camzm_driver</font>(                                      &amp; <A href='../../call_to/CAMZM_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/CAMZM_DRIVER.html' TARGET='index'>9</A><a name='49'>
              ids,ide, jds,jde, kds,kde                       &amp;<a name='50'>
             ,ims,ime, jms,jme, kms,kme                       &amp;<a name='51'>
             ,its,ite, jts,jte, kts,kte                       &amp;<a name='52'>
             ,itimestep, bl_pbl_physics, sf_sfclay_physics    &amp;<a name='53'>
             ,th, t_phy, tsk, tke_pbl, ust, qv, qc, qi        &amp;<a name='54'>
             ,mavail, kpbl, pblh, xland, z                    &amp;<a name='55'>
             ,z_at_w, dz8w, ht, p, p8w, pi_phy, psfc          &amp;<a name='56'>
             ,u_phy, v_phy, hfx, qfx, cldfra, cldfra_mp_all   &amp;<a name='57'>
             ,is_CAMMGMP_used, tpert_camuwpbl                 &amp;<a name='58'>
             ,dx, dt, stepcu, cudt, curr_secs, adapt_step_flag&amp;<a name='59'>
             ,cudtacttime                                     &amp; <a name='60'>
             ,cape_out, mu_out, md_out, zmdt, zmdq            &amp;<a name='61'>
             ,rliq_out, dlf_out                               &amp;<a name='62'>
             ,pconvb, pconvt, cubot, cutop, raincv, pratec    &amp;<a name='63'>
             ,rucuten, rvcuten                                &amp;<a name='64'>
             ,rthcuten, rqvcuten, rqccuten, rqicuten          &amp;<a name='65'>
             ,rqcncuten, rqincuten                            &amp;<a name='66'>
             ,evaptzm, fzsntzm, evsntzm, evapqzm, zmflxprc    &amp;<a name='67'>
             ,zmflxsnw, zmntprpd, zmntsnpd, zmeiheat          &amp;<a name='68'>
             ,cmfmc, cmfmcdzm, preccdzm, precz                &amp;<a name='69'>
             ,zmmtu, zmmtv, zmupgu, zmupgd, zmvpgu, zmvpgd    &amp;<a name='70'>
             ,zmicuu, zmicud, zmicvu, zmicvd                  &amp;<a name='71'>
             ,zmdice, zmdliq                                  &amp;<a name='72'>
             <font color=#447700>!Following intent-OUT variables are required by wet scavenging code of WRF_CHEM package- Balwinder.Singh@pnnl.gov<a name='73'></font>
             ,evapcdp3d, icwmrdp3d, rprddp3d                  &amp;<a name='74'>
             <font color=#447700>!Following intent-OUT variables are required by zm_conv_tend_2 call <a name='75'></font>
             ,dp3d, du3d, ed3d, eu3d, md3d, mu3d, dsubcld2d   &amp;<a name='76'>
             ,ideep2d, jt2d, maxg2d, lengath2d                )<a name='77'>
<a name='78'>
<font color=#447700>! This routine is based on zm_conv_tend in CAM. It handles the mapping of<a name='79'></font>
<font color=#447700>! variables from the WRF to the CAM framework for the Zhang-McFarlane<a name='80'></font>
<font color=#447700>! convective parameterization.<a name='81'></font>
<font color=#447700>!<a name='82'></font>
<font color=#447700>! Author: William.Gustafson@pnl.gov, Nov. 2009<a name='83'></font>
<font color=#447700>! Last modified: William.Gustafson@pnl.gov, Nov. 2010<a name='84'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='85'></font>
  USE <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_17">,     only: latice,cpair, gravit<a name='86'>
  USE <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_12">, only: fqsatd,epsqs, polysvp<a name='87'>
  USE <A href='../../html_code/phys/module_cam_wv_saturation.F.html#WV_SATURATION'>wv_saturation</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WV_SATURATION_13">,            only: fqsatd,epsqs, polysvp<a name='88'>
<a name='89'>
<font color=#447700>! Subroutine arguments...<a name='90'></font>
  logical, intent(in)    ::    is_CAMMGMP_used<a name='91'>
  INTEGER, INTENT(IN   ) ::    ids,ide, jds,jde, kds,kde,  &amp;<a name='92'>
                               ims,ime, jms,jme, kms,kme,  &amp;<a name='93'>
                               its,ite, jts,jte, kts,kte,  &amp;<a name='94'>
                     bl_pbl_physics, &amp; <font color=#447700>!pbl scheme<a name='95'></font>
                          itimestep, &amp; <font color=#447700>!time step index<a name='96'></font>
                  sf_sfclay_physics, &amp; <font color=#447700>!surface layer scheme<a name='97'></font>
                             stepcu    <font color=#447700>!number of time steps between Cu calls<a name='98'></font>
<a name='99'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) :: &amp;<a name='100'>
                             cldfra, &amp; <font color=#447700>!cloud fraction<a name='101'></font>
                      cldfra_mp_all, &amp; <font color=#447700>!cloud fraction from CAMMGMP microphysics<a name='102'></font>
                               dz8w, &amp; <font color=#447700>!height between interfaces (m)<a name='103'></font>
                                  p, &amp; <font color=#447700>!pressure at mid-level (Pa)<a name='104'></font>
                                p8w, &amp; <font color=#447700>!pressure at level interface (Pa)<a name='105'></font>
                             pi_phy, &amp; <font color=#447700>!exner function, (p/p0)^(R/cpair) (none)<a name='106'></font>
                                 qv, &amp; <font color=#447700>!water vapor mixing ratio (kg/kg-dry air)<a name='107'></font>
                                 th, &amp; <font color=#447700>!potential temperature (K)<a name='108'></font>
                            tke_pbl, &amp; <font color=#447700>!turbulent kinetic energy from PBL (m2/s2)<a name='109'></font>
                              t_phy, &amp; <font color=#447700>!temperature (K)<a name='110'></font>
                              u_phy, &amp; <font color=#447700>!zonal wind component on T points (m/s)<a name='111'></font>
                              v_phy, &amp; <font color=#447700>!meridional wind component on T points (m/s)<a name='112'></font>
                                  z, &amp; <font color=#447700>!height above sea level at mid-level (m)<a name='113'></font>
                             z_at_w    <font color=#447700>!height above sea level at interface (m)<a name='114'></font>
<a name='115'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN), OPTIONAL :: &amp;<a name='116'>
                                 qc, &amp; <font color=#447700>!cloud droplet mixing ratio (kg/kg-dry air)<a name='117'></font>
                                 qi    <font color=#447700>!cloud ice crystal mixing ratio (kg/kg-dry air)<a name='118'></font>
<a name='119'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) :: &amp;<a name='120'>
                            dlf_out, &amp; <font color=#447700>!detraining cloud water tendendcy<a name='121'></font>
                            evaptzm, &amp; <font color=#447700>!temp. tendency - evap/snow prod from ZM (K/s)<a name='122'></font>
                            fzsntzm, &amp; <font color=#447700>!temp. tendency - rain to snow conversion from ZM (K/s)<a name='123'></font>
                            evsntzm, &amp; <font color=#447700>!temp. tendency - snow to rain conversion from ZM (K/s)<a name='124'></font>
                            evapqzm, &amp; <font color=#447700>!spec. humidity tend. - evaporation from ZM (kg/kg/s)<a name='125'></font>
                           zmflxprc, &amp; <font color=#447700>!flux of precipitation from ZM (kg/m2/s)<a name='126'></font>
                           zmflxsnw, &amp; <font color=#447700>!flux of snow from ZM (kg/m2/s)<a name='127'></font>
                           zmntprpd, &amp; <font color=#447700>!net precipitation production from ZM (kg/kg/s)<a name='128'></font>
                           zmntsnpd, &amp; <font color=#447700>!net snow production from ZM (kg/kg/s)<a name='129'></font>
                           zmeiheat, &amp; <font color=#447700>!heating by ice and evaporation from ZM (W/kg)<a name='130'></font>
                              cmfmc, &amp; <font color=#447700>!convective mass flux--m sub c, deep here but ultimately deep+shallow (kg/m2/s)<a name='131'></font>
                           cmfmcdzm, &amp; <font color=#447700>!convection mass flux from ZM deep (kg/m2/s)<a name='132'></font>
                             md_out, &amp; <font color=#447700>!output convective downdraft mass flux (kg/m2/s)<a name='133'></font>
                             mu_out, &amp; <font color=#447700>!output convective updraft mass flux (kg/m2/s)<a name='134'></font>
                            rucuten, &amp; <font color=#447700>!UNcoupled zonal wind tendency due to Cu scheme (m/s2)<a name='135'></font>
                            rvcuten, &amp; <font color=#447700>!UNcoupled meridional wind tendency due to Cu scheme (m/s2)<a name='136'></font>
                           rthcuten, &amp; <font color=#447700>!UNcoupled potential temperature tendendcy due to cu scheme (K/s)<a name='137'></font>
                           rqvcuten, &amp; <font color=#447700>!UNcoupled water vapor mixing ratio tendency due to Cu scheme (kg/kg/s)<a name='138'></font>
                               zmdt, &amp; <font color=#447700>!temp. tendency from moist convection (K/s)<a name='139'></font>
                               zmdq, &amp; <font color=#447700>!spec. humidity tendency from moist convection (kg/kg/s)<a name='140'></font>
                              zmmtu, &amp; <font color=#447700>!U tendency from ZM convective momentum transport (m/s2)<a name='141'></font>
                              zmmtv, &amp; <font color=#447700>!V tendency from ZM convective momentum transport (m/s2)<a name='142'></font>
                             zmupgu, &amp; <font color=#447700>!zonal force from ZM updraft pressure gradient term (m/s2)<a name='143'></font>
                             zmupgd, &amp; <font color=#447700>!zonal force from ZM downdraft pressure gradient term (m/s2)<a name='144'></font>
                             zmvpgu, &amp; <font color=#447700>!meridional force from ZM updraft pressure gradient term (m/s2)<a name='145'></font>
                             zmvpgd, &amp; <font color=#447700>!meridional force from ZM downdraft pressure gradient term (m/s2)<a name='146'></font>
                             zmicuu, &amp; <font color=#447700>!ZM in-cloud U updrafts (m/s)<a name='147'></font>
                             zmicud, &amp; <font color=#447700>!ZM in-cloud U downdrafts (m/s)<a name='148'></font>
                             zmicvu, &amp; <font color=#447700>!ZM in-cloud V updrafts (m/s)<a name='149'></font>
                             zmicvd, &amp; <font color=#447700>!ZM in-cloud V downdrafts (m/s)<a name='150'></font>
                             zmdice, &amp; <font color=#447700>!ZM cloud ice tendency (kg/kg/s)<a name='151'></font>
                             zmdliq    <font color=#447700>!ZM cloud liquid tendency (kg/kg/s)<a name='152'></font>
<a name='153'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT), OPTIONAL :: &amp;<a name='154'>
                           rqccuten, &amp; <font color=#447700>!UNcoupled cloud droplet mixing ratio tendency due to Cu scheme (kg/kg/s)<a name='155'></font>
                           rqicuten, &amp; <font color=#447700>!UNcoupled ice crystal mixing ratio tendency due to Cu scheme (kg/kg/s)<a name='156'></font>
                          rqcncuten, &amp; <font color=#447700>!PMA<a name='157'></font>
                          rqincuten    <font color=#447700>!PMA<a name='158'></font>
<a name='159'>
<a name='160'>
  <font color=#447700>!variables required by wet scavenging in WRF_CHEM -Balwinder.Singh@pnnl.gov<a name='161'></font>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(OUT) :: &amp; <a name='162'>
                          evapcdp3d, &amp; <font color=#447700>!Evaporation of deep convective precipitation (kg/kg/s)<a name='163'></font>
                          icwmrdp3d, &amp; <font color=#447700>!Deep Convection in-cloud water mixing ratio (kg/m2)<a name='164'></font>
                           rprddp3d    <font color=#447700>!dq/dt due to deep convective rainout (kg/kg/s)<a name='165'></font>
<a name='166'>
  <font color=#447700>!variables required by zm_conv_tend_2 call<a name='167'></font>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(OUT) :: &amp;<a name='168'>
                               dp3d, &amp;<a name='169'>
                               du3d, &amp;<a name='170'>
                               ed3d, &amp;<a name='171'>
                               eu3d, &amp;<a name='172'>
                               md3d, &amp;<a name='173'>
                               mu3d<a name='174'>
<a name='175'>
<a name='176'>
  REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: &amp;<a name='177'>
                                hfx, &amp; <font color=#447700>!upward heat flux at sfc (W/m2)<a name='178'></font>
                                 ht, &amp; <font color=#447700>!terrain height (m)<a name='179'></font>
                              xland, &amp; <font color=#447700>!land/water mask, 1=land, 2=water<a name='180'></font>
                             mavail, &amp; <font color=#447700>!soil moisture availability<a name='181'></font>
                               pblh, &amp; <font color=#447700>!planetary boundary layer height (m)<a name='182'></font>
                               psfc, &amp; <font color=#447700>!surface pressure (Pa)<a name='183'></font>
                                qfx, &amp; <font color=#447700>!upward moisture flux at sfc (kg/m2/s)<a name='184'></font>
                     tpert_camuwpbl, &amp; <font color=#447700>!temperature perturbation from UW CAM PBL<a name='185'></font>
                                tsk, &amp; <font color=#447700>!skin temperature (K)<a name='186'></font>
                                ust    <font color=#447700>!u* in similarity theory (m/s)<a name='187'></font>
<a name='188'>
  REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: &amp;<a name='189'>
                           cape_out, &amp; <font color=#447700>!convective available potential energy (J/kg)<a name='190'></font>
                              cubot, &amp; <font color=#447700>!level number of base of convection<a name='191'></font>
                              cutop, &amp; <font color=#447700>!level number of top of convection<a name='192'></font>
                             pconvb, &amp; <font color=#447700>!pressure of base of convection (Pa)<a name='193'></font>
                             pconvt, &amp; <font color=#447700>!pressure of top of convection (Pa)<a name='194'></font>
                             pratec, &amp; <font color=#447700>!rain rate returned to WRF for accumulation (mm/s)<a name='195'></font>
                           preccdzm, &amp; <font color=#447700>!convection precipitation rate from ZM deep (m/s)<a name='196'></font>
                              precz, &amp; <font color=#447700>!total precipitation rate from ZM (m/s)<a name='197'></font>
                             raincv, &amp; <font color=#447700>!time-step convective rain amount (mm)<a name='198'></font>
                           rliq_out    <font color=#447700>!vertical integral of reserved cloud water<a name='199'></font>
  REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: &amp;<a name='200'>
                           dsubcld2d<a name='201'>
<a name='202'>
  REAL, INTENT(IN) :: &amp;<a name='203'>
                               cudt, &amp; <font color=#447700>!cumulus time step (min)<a name='204'></font>
                          curr_secs, &amp; <font color=#447700>!current forecast time (s)<a name='205'></font>
                                 dt, &amp; <font color=#447700>!domain time step (s)<a name='206'></font>
                                 dx    <font color=#447700>!grid spacing (m)<a name='207'></font>
<a name='208'>
  REAL, INTENT (INOUT) :: &amp;<a name='209'>
                        cudtacttime    <font color=#447700>!for adaptive time stepping, next to to run scheme (s)   <a name='210'></font>
<a name='211'>
  INTEGER, DIMENSION( ims:ime, jms:jme), INTENT(IN) :: &amp;<a name='212'>
                               kpbl    <font color=#447700>!index of PBL level<a name='213'></font>
<a name='214'>
  INTEGER, DIMENSION( ims:ime, jms:jme), INTENT(OUT) :: &amp;<a name='215'>
                           ideep2d, &amp;<a name='216'>
                           jt2d,    &amp;<a name='217'>
                           maxg2d,  &amp;<a name='218'>
                        lengath2d <a name='219'>
<a name='220'>
  LOGICAL, INTENT(IN), OPTIONAL :: &amp;<a name='221'>
                    adapt_step_flag    <font color=#447700>!using adaptive time steps?<a name='222'></font>
<a name='223'>
<font color=#447700>! Local variables...<a name='224'></font>
  <font color=#447700>!Variables dimensioned for input to ZM routines<a name='225'></font>
  REAL(r8), DIMENSION(pcols, kte+1) ::  &amp;<a name='226'>
                               mcon, &amp; <font color=#447700>!convective mass flux--m sub c (sub arg out in CAM)<a name='227'></font>
                               pflx, &amp; <font color=#447700>!scattered precip flux at each level (sub arg out in CAM)<a name='228'></font>
                              pint8, &amp; <font color=#447700>!pressure at layer interface (Pa)<a name='229'></font>
                                zi8, &amp; <font color=#447700>!height above sea level at mid-level (m)<a name='230'></font>
                            flxprec, &amp; <font color=#447700>!evap outfld: convective-scale flux of precip at interfaces (kg/m2/s)<a name='231'></font>
                            flxsnow    <font color=#447700>!evap outfld: convective-scale flux of snow at interfaces (kg/m2/s)<a name='232'></font>
<a name='233'>
<a name='234'>
  REAL(r8), DIMENSION(pcols, kte, pcnst) ::  &amp;<a name='235'>
                                qh8    <font color=#447700>!specific humidity (kg/kg-moist air)<a name='236'></font>
<a name='237'>
  REAL(r8), DIMENSION(pcols, kte, 3) ::  &amp;<a name='238'>
                              cloud, &amp; <font color=#447700>!holder for cloud water and ice (q in CAM)<a name='239'></font>
                           cloudtnd    <font color=#447700>!holder for cloud tendencies (ptend_loc%q in CAM)<a name='240'></font>
<a name='241'>
<font color=#447700>!BSINGH - 02/18/2013: FRACIS is used for qv,qc and qi for WRF_CHEM simulation but for<a name='242'></font>
<font color=#447700>! WRF simulations it is used for qnc and qni also<a name='243'></font>
#if ( WRF_CHEM == 1 )<a name='244'>
 REAL(r8), DIMENSION(pcols, kte, 3) ::  &amp;<a name='245'>
#else<a name='246'>
 REAL(r8), DIMENSION(pcols, kte, 5) ::  &amp;<a name='247'>
#endif<a name='248'>
                             fracis    <font color=#447700>!fraction of cloud species that are insoluble<a name='249'></font>
<a name='250'>
<a name='251'>
  REAL(r8), DIMENSION(pcols, kte, 2) ::  &amp;<a name='252'>
                               icwu, &amp; <font color=#447700>!in-cloud winds in upraft (m/s)<a name='253'></font>
                               icwd, &amp; <font color=#447700>!in-cloud winds in downdraft (m/s)<a name='254'></font>
                             pguall, &amp; <font color=#447700>!apparent force from updraft pres. gradient (~units?)<a name='255'></font>
                             pgdall, &amp; <font color=#447700>!apparent force from downdraft pres. gradient (~units?)<a name='256'></font>
                              winds, &amp; <font color=#447700>!wind components (m/s)<a name='257'></font>
                         wind_tends    <font color=#447700>!wind component tendencies (m/s2)<a name='258'></font>
<a name='259'>
  REAL(r8), DIMENSION(pcols, kte) ::  &amp;<a name='260'>
                               cld8, &amp; <font color=#447700>!cloud fraction<a name='261'></font>
                                cme, &amp; <font color=#447700>!cmf condensation - evaporation (~units?, sub arg out in CAM)<a name='262'></font>
                                dlf, &amp; <font color=#447700>!scattered version of the detraining cld h2o tendency (~units?)<a name='263'></font>
                         fake_dpdry, &amp; <font color=#447700>!place holder for dpdry, delta pres. of dry atmos.<a name='264'></font>
                            ntprprd, &amp; <font color=#447700>!evap outfld: net precip production in layer (kg/kg/s)<a name='265'></font>
                            ntsnprd, &amp; <font color=#447700>!evap outfld: net snow production in layer (kg/kg/s)<a name='266'></font>
                              pdel8, &amp; <font color=#447700>!pressure thickness of layer (between interfaces, Pa)<a name='267'></font>
                              pmid8, &amp; <font color=#447700>!pressure at layer middle (Pa)<a name='268'></font>
                                ql8, &amp; <font color=#447700>!in cloud liquid water (~units?)<a name='269'></font>
                             ql8prm, &amp; <font color=#447700>!cloud liquid water (~units?)<a name='270'></font>
                                qi8, &amp; <font color=#447700>!cloud ice (~units?)<a name='271'></font>
                                 t8, &amp; <font color=#447700>!temperature (K)<a name='272'></font>
                                zm8, &amp; <font color=#447700>!height above ground at mid-level (m)<a name='273'></font>
                               qtnd, &amp; <font color=#447700>!specific humidity tendency (kg/kg/s)<a name='274'></font>
                               rprd, &amp; <font color=#447700>!rain production rate (kg/kg/s, comes from pbuf array in CAM, add to restart?~)<a name='275'></font>
                               stnd, &amp; <font color=#447700>!heating rate (dry static energy tendency, W/kg)<a name='276'></font>
                      tend_s_snwprd, &amp; <font color=#447700>!heating rate of snow production (~units?)<a name='277'></font>
                    tend_s_snwevmlt, &amp; <font color=#447700>!heating rate of evap/melting of snow (~units?)<a name='278'></font>
                                zdu, &amp; <font color=#447700>!detraining mass flux (~units? sub arg out in CAM)<a name='279'></font>
                            evapcdp    <font color=#447700>!Evaporation of deep convective precipitation (kg/kg/s)<a name='280'></font>
<a name='281'>
  REAL(r8), DIMENSION(pcols, kte) ::  &amp;<a name='282'>
                                esl, &amp; <font color=#447700>!saturation vapor pressure<a name='283'></font>
                                qvs, &amp; <font color=#447700>!saturation specific humidity<a name='284'></font>
                          qcten_det, &amp;<a name='285'>
                          qiten_det, &amp;<a name='286'>
                         qcnten_det, &amp;<a name='287'>
                         qinten_det, &amp;<a name='288'>
                          qsten_det<a name='289'>
  REAL(r8), DIMENSION(pcols) ::  &amp;<a name='290'>
                               cape, &amp; <font color=#447700>!convective available potential energy (J/kg)<a name='291'></font>
                              jctop, &amp; <font color=#447700>!row of top-of-deep-convection indices passed out (sub arg out in CAM)<a name='292'></font>
                              jcbot, &amp; <font color=#447700>!row of base of cloud indices passed out (sub arg out in CAM)<a name='293'></font>
                           landfrac, &amp; <font color=#447700>!land fraction<a name='294'></font>
                              pblh8, &amp; <font color=#447700>!planetary boundary layer height (m)<a name='295'></font>
                               phis, &amp; <font color=#447700>!geopotential at terrain height (m2/s2)<a name='296'></font>
                               prec, &amp; <font color=#447700>!convective-scale precipitation rate from ZM (m/s)<a name='297'></font>
                               rliq, &amp; <font color=#447700>!reserved liquid (not yet in cldliq) for energy integrals (units? sub arg out in CAM)<a name='298'></font>
                               snow, &amp; <font color=#447700>!convective-scale snowfall rate from ZM (m/s)<a name='299'></font>
                              tpert    <font color=#447700>!thermal (convective) temperature excess (K)<a name='300'></font>
<a name='301'>
  REAL(r8), DIMENSION(pcols, kte, (ime-ims+1)*(jme-jms+1)) :: &amp;<a name='302'>
                                 dp, &amp; <font color=#447700>!layer pres. thickness between interfaces (mb)<a name='303'></font>
                                 du, &amp;<a name='304'>
                                 ed, &amp;<a name='305'>
                                 eu, &amp;<a name='306'>
                                 md, &amp;<a name='307'>
                                 mu<a name='308'>
<a name='309'>
  REAL(r8), DIMENSION(pcols, (ime-ims+1)*(jme-jms+1)) :: &amp;<a name='310'>
                            dsubcld    <font color=#447700>! layer pres. thickness between LCL and maxi (mb)<a name='311'></font>
<a name='312'>
  INTEGER, DIMENSION(pcols, (ime-ims+1)*(jme-jms+1)) :: &amp;<a name='313'>
                              ideep, &amp; <font color=#447700>! holds position of gathered points<a name='314'></font>
                                 jt, &amp; <font color=#447700>! top-level index of deep cumulus convection<a name='315'></font>
                               maxg    <font color=#447700>! gathered values of maxi<a name='316'></font>
                               <a name='317'>
  INTEGER, DIMENSION((ime-ims+1)*(jme-jms+1)) :: &amp;<a name='318'>
                            lengath    <font color=#447700>! number of gathered points<a name='319'></font>
<a name='320'>
  <font color=#447700>!Other local vars<a name='321'></font>
  REAL(r8):: dum1,cudts,hcudts<a name='322'>
  INTEGER :: i, j, k, kflip, n, ncnst<a name='323'>
  INTEGER :: lchnk         <font color=#447700>!chunk identifier, used to map 2-D to 1-D arrays in WRF<a name='324'></font>
  INTEGER :: ncol          <font color=#447700>!number of atmospheric columns in chunk<a name='325'></font>
  LOGICAL, DIMENSION(3) :: l_qt    <font color=#447700>!logical switches for constituent tendency presence<a name='326'></font>
  LOGICAL, DIMENSION(2) :: l_windt <font color=#447700>!logical switches for wind tendency presence<a name='327'></font>
  LOGICAL :: run_param , &amp; <font color=#447700>!flag for handling alternate cumulus call freq.<a name='328'></font>
             doing_adapt_dt , decided<a name='329'>
<font color=#447700>!<a name='330'></font>
<font color=#447700>! Check to see if this is a convection timestep...<a name='331'></font>
<font color=#447700>!<a name='332'></font>
<a name='333'>
<font color=#447700>!  Initialization for adaptive time step.<a name='334'></font>
<a name='335'>
   if (cudt .eq. 0.) then<a name='336'>
    cudts = dt<a name='337'>
    hcudts=cudts*0.5_r8<a name='338'>
   else <a name='339'>
    cudts=cudt*60._r8<a name='340'>
    hcudts=cudts*0.5_r8<a name='341'>
   end if<a name='342'>
<a name='343'>
   doing_adapt_dt = .FALSE.<a name='344'>
   IF ( PRESENT(adapt_step_flag) ) THEN<a name='345'>
      IF ( adapt_step_flag ) THEN<a name='346'>
         doing_adapt_dt = .TRUE.<a name='347'>
         IF ( cudtacttime .EQ. 0. ) THEN<a name='348'>
            cudtacttime = curr_secs + cudt*60.<a name='349'>
         END IF<a name='350'>
      END IF<a name='351'>
   END IF<a name='352'>
<a name='353'>
<font color=#447700>!  Do we run through this scheme or not?<a name='354'></font>
<a name='355'>
<font color=#447700>!    Test 1:  If this is the initial model time, then yes.<a name='356'></font>
<font color=#447700>!                ITIMESTEP=1<a name='357'></font>
<font color=#447700>!    Test 2:  If the user asked for the cumulus to be run every time step, then yes.<a name='358'></font>
<font color=#447700>!                CUDT=0 or STEPCU=1<a name='359'></font>
<font color=#447700>!    Test 3:  If not adaptive dt, and this is on the requested cumulus frequency, then yes.<a name='360'></font>
<font color=#447700>!                MOD(ITIMESTEP,STEPCU)=0<a name='361'></font>
<font color=#447700>!    Test 4:  If using adaptive dt and the current time is past the last requested activate cumulus time, then yes.<a name='362'></font>
<font color=#447700>!                CURR_SECS &gt;= CUDTACTTIME<a name='363'></font>
<a name='364'>
<font color=#447700>!  If we do run through the scheme, we set the flag run_param to TRUE and we set the decided flag<a name='365'></font>
<font color=#447700>!  to TRUE.  The decided flag says that one of these tests was able to say "yes", run the scheme.<a name='366'></font>
<font color=#447700>!  We only proceed to other tests if the previous tests all have left decided as FALSE.<a name='367'></font>
<a name='368'>
<font color=#447700>!  If we set run_param to TRUE and this is adaptive time stepping, we set the time to the next<a name='369'></font>
<font color=#447700>!  cumulus run.<a name='370'></font>
<a name='371'>
   decided = .FALSE.<a name='372'>
   run_param = .FALSE.<a name='373'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='374'>
        ( itimestep .EQ. 1 ) ) THEN<a name='375'>
      run_param   = .TRUE.<a name='376'>
      decided     = .TRUE.<a name='377'>
   END IF<a name='378'>
<a name='379'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='380'>
        ( ( cudt .EQ. 0. ) .OR. ( stepcu .EQ. 1 ) ) ) THEN<a name='381'>
      run_param   = .TRUE.<a name='382'>
      decided     = .TRUE.<a name='383'>
   END IF<a name='384'>
<a name='385'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='386'>
        ( .NOT. doing_adapt_dt ) .AND. &amp;<a name='387'>
        ( MOD(itimestep,stepcu) .EQ. 0 ) ) THEN<a name='388'>
      run_param   = .TRUE.<a name='389'>
      decided     = .TRUE.<a name='390'>
   END IF<a name='391'>
<a name='392'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='393'>
        ( doing_adapt_dt ) .AND. &amp;<a name='394'>
        ( curr_secs .GE. cudtacttime ) ) THEN<a name='395'>
      run_param   = .TRUE.<a name='396'>
      decided     = .TRUE.<a name='397'>
      cudtacttime = curr_secs + cudt*60<a name='398'>
   END IF<a name='399'>
<a name='400'>
  <font color=#447700>!Leave the subroutine if it is not yet time to call the cumulus param<a name='401'></font>
  if( .not. run_param ) return<a name='402'>
<font color=#447700>!<a name='403'></font>
<font color=#447700>! Initialize...<a name='404'></font>
<font color=#447700>!<a name='405'></font>
  ncol  = 1          <font color=#447700>!chunk size in WRF is 1 since we loop over all columns in a tile<a name='406'></font>
<a name='407'>
  cape_out(its:ite, jts:jte)        = 0.<a name='408'>
  mu_out(its:ite, kts:kte, jts:jte) = 0.<a name='409'>
  md_out(its:ite, kts:kte, jts:jte) = 0.<a name='410'>
  zmdt(its:ite, kts:kte, jts:jte)   = 0.<a name='411'>
<font color=#447700>!<a name='412'></font>
<font color=#447700>! Map variables to inputs for zm_convr and call it...<a name='413'></font>
<font color=#447700>! Loop over the points in the tile and treat them each as a CAM chunk.<a name='414'></font>
<font color=#447700>!<a name='415'></font>
  do j = jts,jte<a name='416'>
     do i = its,ite<a name='417'>
        lchnk = (j-jts)*(ite-its+1) + (i-its+1) <font color=#447700>!1-D index location from the 2-D tile<a name='418'></font>
<a name='419'>
        <font color=#447700>!Flip variables on the layer middles<a name='420'></font>
        do k = kts,kte<a name='421'>
           kflip = kte-k+1<a name='422'>
           if(is_CAMMGMP_used) then<a name='423'>
              cld8(1,kflip)  = cldfra_mp_all(i,k,j)<a name='424'>
           else<a name='425'>
              cld8(1,kflip)  = cldfra(i,k,j)<a name='426'>
           endif<a name='427'>
		   if (itimestep .eq. 1) cld8(1,kflip) =0.<a name='428'>
           pdel8(1,kflip) = p8w(i,k,j) - p8w(i,k+1,j)<a name='429'>
           pmid8(1,kflip) = p(i,k,j)<a name='430'>
           qh8(1,kflip,1) = max( qv(i,k,j)/(1.+qv(i,k,j)), 1e-30 ) <font color=#447700>!values of 0 cause a crash in entropy<a name='431'></font>
           if( present(qc) ) then<a name='432'>
              ql8prm(1,kflip) = qc(i,k,j)/(1.+qv(i,k,j)) <font color=#447700>!Convert to moist mix ratio<a name='433'></font>
           else<a name='434'>
              ql8prm(1,kflip) = 0.<a name='435'>
           end if<a name='436'>
           if( present(qi) ) then<a name='437'>
              qi8(1,kflip) = qi(i,k,j)/(1.+qv(i,k,j)) <font color=#447700>!Used in convtran, ditto for conversion<a name='438'></font>
           else<a name='439'>
              qi8(1,kflip) = 0.<a name='440'>
           end if<a name='441'>
           t8(1,kflip)    = t_phy(i,k,j)<a name='442'>
           zm8(1,kflip)   = z(i,k,j) - ht(i,j) <font color=#447700>!Height above the ground at midlevels<a name='443'></font>
           <a name='444'>
           dp(1,kflip,lchnk) = 0.0_r8<a name='445'>
           du(1,kflip,lchnk) = 0.0_r8<a name='446'>
           ed(1,kflip,lchnk) = 0.0_r8<a name='447'>
           eu(1,kflip,lchnk) = 0.0_r8<a name='448'>
           md(1,kflip,lchnk) = 0.0_r8<a name='449'>
           mu(1,kflip,lchnk) = 0.0_r8<a name='450'>
        end do<a name='451'>
<a name='452'>
        <font color=#447700>!Flip variables on the layer interfaces<a name='453'></font>
        do k = kts,kte+1<a name='454'>
           kflip = kte-k+2<a name='455'>
<a name='456'>
           pint8(1,kflip) = p8w(i,k,j)<a name='457'>
           zi8(1,kflip)   = z_at_w(i,k,j) -ht(i,j) <font color=#447700>!Height above the ground at interfaces<a name='458'></font>
        end do<a name='459'>
<a name='460'>
        <font color=#447700>!Other necessary conversions for input to ZM<a name='461'></font>
        if( xland(i,j)==2 ) then<a name='462'>
           landfrac(1) = 1. <font color=#447700>!land, WRF is all or nothing<a name='463'></font>
        else<a name='464'>
           landfrac(1) = 0. <font color=#447700>!water<a name='465'></font>
        end if<a name='466'>
        pblh8(1) = pblh(i,j)<a name='467'>
        phis(1)  = ht(i,j)*gravit<a name='468'>
<a name='469'>
        call <A href='../../html_code/phys/module_cu_camzm_driver.F.html#GET_TPERT'>get_tpert</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_TPERT_1">(bl_pbl_physics, sf_sfclay_physics, dx, &amp;<a name='470'>
             mavail(i,j), kpbl(i,j), pblh(i,j), &amp;<a name='471'>
             dz8w(i,1,j), psfc(i,j), qv(i,1,j), t_phy(i,1,j), &amp;<a name='472'>
             th(i,1,j), tsk(i,j), tke_pbl(i,:,j), ust(i,j),   &amp;<a name='473'>
             u_phy(i,1,j), v_phy(i,1,j), hfx(i,j), qfx(i,j), &amp;<a name='474'>
             tpert_camuwpbl(i,j), kte, &amp;<a name='475'>
             tpert(1))<a name='476'>
<a name='477'>
        <font color=#447700>!Call the Zhang-McFarlane (1996) convection parameterization<a name='478'></font>
        <font color=#447700>!PMA: pass in 0.5 x cudt (sec)<a name='479'></font>
        <font color=#447700>!Modified by Balwinder.Singh@pnnl.gov: We are no longer using 0.5*dt<a name='480'></font>
<a name='481'>
        <font color=#447700>!PMA: pass in 0.5 x cudt (sec)<a name='482'></font>
        call <A href='../../html_code/phys/module_cu_camzm.F.html#ZM_CONVR'>zm_convr</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZM_CONVR_1">( lchnk, ncol, &amp;<a name='483'>
             t8, qh8, prec, jctop, jcbot, &amp;<a name='484'>
             pblh8, zm8, phis, zi8, qtnd, &amp;<a name='485'>
             stnd, pmid8, pint8, pdel8, &amp;<a name='486'>
             hcudts, mcon, cme, cape, &amp;<a name='487'>
             tpert, dlf, pflx, zdu, rprd, &amp;<a name='488'>
             mu(:,:,lchnk), md(:,:,lchnk),du(:,:,lchnk),eu(:,:,lchnk),ed(:,:,lchnk), &amp;<a name='489'>
             dp(:,:,lchnk), dsubcld(:,lchnk), jt(:,lchnk), maxg(:,lchnk), ideep(:,lchnk), &amp;<a name='490'>
             lengath(lchnk), ql8, rliq, landfrac )<a name='491'>
<a name='492'>
        <font color=#447700>!Start mapping CAM output to WRF output variables. We follow the<a name='493'></font>
        <font color=#447700>!same order as in CAM's zm_conv_tend to ease maintenance...<a name='494'></font>
        do k=kts,kte<a name='495'>
           kflip = kte-k+1<a name='496'>
           dlf(1,kflip)    = max(min(1.e-6_r8,dlf(1,kflip)),0._r8)<a name='497'>
           dlf_out(i,k,j)  = dlf(1,kflip)<a name='498'>
        end do<a name='499'>
        cape_out(i,j) = cape(1)<a name='500'>
        rliq_out(i,j) = rliq(1)<a name='501'>
<a name='502'>
        <font color=#447700>!Convert mass flux from reported mb/s to kg/m2/s<a name='503'></font>
        mcon(:ncol,:pverp) = mcon(:ncol,:pverp) * 100._r8/gravit<a name='504'>
<a name='505'>
        <font color=#447700>! Store upward and downward mass fluxes in un-gathered arrays<a name='506'></font>
        <font color=#447700>! + convert from mb/s to kg/m2/s<a name='507'></font>
        do n=1,lengath(lchnk)<a name='508'>
           do k=kts,kte<a name='509'>
              kflip = kte-k+1<a name='510'>
<font color=#447700>!              ii = ideep(n,lchnk) &lt;--in WRF this is always 1 because chunk size=1<a name='511'></font>
              mu_out(i,k,j) = mu(n,kflip,lchnk) * 100._r8/gravit<a name='512'>
              md_out(i,k,j) = md(n,kflip,lchnk) * 100._r8/gravit<a name='513'>
           end do<a name='514'>
        end do<a name='515'>
<a name='516'>
        do k=kts,kte<a name='517'>
           kflip = kte-k+1<a name='518'>
           zmdt(i,k,j) = stnd(1,kflip)/cpair<a name='519'>
           zmdq(i,k,j) = qtnd(1,kflip)<a name='520'>
        end do<a name='521'>
<a name='522'>
        <font color=#447700>!Top and bottom pressure of convection<a name='523'></font>
        pconvt(i,j) = p8w(i,1,j)<a name='524'>
        pconvb(i,j) = p8w(i,1,j)<a name='525'>
        do n = 1,lengath(lchnk)<a name='526'>
           if (maxg(n,lchnk).gt.jt(n,lchnk)) then<a name='527'>
              pconvt(i,j) = pmid8(ideep(n,lchnk),jt(n,lchnk))  <font color=#447700>! gathered array (or jctop ungathered)<a name='528'></font>
              pconvb(i,j) = pmid8(ideep(n,lchnk),maxg(n,lchnk))<font color=#447700>! gathered array<a name='529'></font>
           endif<a name='530'>
        end do<a name='531'>
        cutop(i,j) = jctop(1)<a name='532'>
        cubot(i,j) = jcbot(1)<a name='533'>
<a name='534'>
        <font color=#447700>!Add tendency from this process to tendencies arrays. Also,<a name='535'></font>
        <font color=#447700>!increment the local state arrays to reflect additional tendency<a name='536'></font>
        <font color=#447700>!from zm_convr, i.e. the physics update call in CAM. Note that<a name='537'></font>
        <font color=#447700>!we are not readjusting the pressure levels to hydrostatic<a name='538'></font>
        <font color=#447700>!balance for the new virtual temperature like is done in CAM. We<a name='539'></font>
        <font color=#447700>!will let WRF take care of such things later for the total<a name='540'></font>
        <font color=#447700>!tendency.<a name='541'></font>
        do k=kts,kte<a name='542'>
           kflip = kte-k+1<a name='543'>
<a name='544'>
           <font color=#447700>!Convert temperature to potential temperature and<a name='545'></font>
           <font color=#447700>!specific humidity to water vapor mixing ratio<a name='546'></font>
           rthcuten(i,k,j) = zmdt(i,k,j)/pi_phy(i,k,j)<a name='547'>
           rqvcuten(i,k,j) = zmdq(i,k,j)*(1._r8 + qv(i,k,j))**2<a name='548'>
<a name='549'>
           t8(1,kflip)    = t8(1,kflip) + zmdt(i,k,j)*cudts   <font color=#447700>!PMA<a name='550'></font>
           qh8(1,kflip,1) = qh8(1,kflip,1) + zmdq(i,k,j)*cudts   <font color=#447700>!PMA<a name='551'></font>
        end do<a name='552'>
<a name='553'>
        <font color=#447700>! Determine the phase of the precipitation produced and add latent heat of fusion<a name='554'></font>
        <font color=#447700>! Evaporate some of the precip directly into the environment (Sundqvist)<a name='555'></font>
        <font color=#447700>! Allow this to use the updated state1 (t8 and qh8 in WRF) and the fresh ptend_loc type<a name='556'></font>
        <font color=#447700>! heating and specific humidity tendencies produced<a name='557'></font>
        qtnd = 0._r8 <font color=#447700>!re-initialize tendencies (i.e. physics_ptend_init(ptend_loc))<a name='558'></font>
        stnd = 0._r8<a name='559'>
        call <A href='../../html_code/phys/module_cu_camzm.F.html#ZM_CONV_EVAP'>zm_conv_evap</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZM_CONV_EVAP_1">(ncol, lchnk, &amp;<a name='560'>
             t8, pmid8, pdel8, qh8(:,:,1), &amp;<a name='561'>
             stnd, tend_s_snwprd, tend_s_snwevmlt, qtnd, &amp;<a name='562'>
             rprd, cld8, cudts, &amp;                            <font color=#447700>!PMA: This subroutine uses delt not 2xdelt, so pass in cudts<a name='563'></font>
             prec, snow, ntprprd, ntsnprd , flxprec, flxsnow)<a name='564'>
        evapcdp(:ncol,:pver) = qtnd(:ncol,:pver) <font color=#447700>!Added by Balwinder.Singh@pnnl.gov for assisting wetscavenging in WRF_CHEM package<a name='565'></font>
<a name='566'>
        <font color=#447700>! Parse output variables from zm_conv_evap<a name='567'></font>
        do k=kts,kte<a name='568'>
           kflip = kte-k+1<a name='569'>
<a name='570'>
           evaptzm(i,k,j)  = stnd(1,kflip)/cpair<a name='571'>
           fzsntzm(i,k,j)  = tend_s_snwprd(1,kflip)/cpair<a name='572'>
           evsntzm(i,k,j)  = tend_s_snwevmlt(1,kflip)/cpair<a name='573'>
           evapqzm(i,k,j)  = qtnd(1,kflip)<a name='574'>
           zmflxprc(i,k,j) = flxprec(1,kflip)<a name='575'>
           zmflxsnw(i,k,j) = flxsnow(1,kflip)<a name='576'>
           zmntprpd(i,k,j) = ntprprd(1,kflip)<a name='577'>
           zmntsnpd(i,k,j) = ntsnprd(1,kflip)<a name='578'>
           zmeiheat(i,k,j) = stnd(1,kflip) <font color=#447700>!Do we really need this and evaptzm?<a name='579'></font>
           <font color=#447700>!BSINGH - Following quantities are to be stored at interfaces<a name='580'></font>
           <font color=#447700>!cmfmc(i,k,j)    = mcon(1,kflip) !Set to deep value here, shallow added in UW scheme<a name='581'></font>
           <font color=#447700>!cmfmcdzm(i,k,j) = mcon(1,kflip)<a name='582'></font>
           preccdzm(i,j)   = prec(1)       <font color=#447700>!Rain rate from just deep<a name='583'></font>
           precz(i,j)      = prec(1)       <font color=#447700>!Rain rate for total convection (just deep right now)<a name='584'></font>
           pratec(i,j)     = prec(1)*1e3   <font color=#447700>!Rain rate used in WRF for accumulation (mm/s)<a name='585'></font>
           raincv(i,j)     = pratec(i,j)*dt <font color=#447700>!Rain amount for dynamic time step returned back to WRF   !wig: fixed wrong timestep usage 3-Jun-2016<a name='586'></font>
        end do<a name='587'>
<a name='588'>
        <font color=#447700>!BSINGH - storing quantities at interfaces<a name='589'></font>
        do k = kts,kte+1<a name='590'>
           kflip             = kte - k + 2<a name='591'>
           cmfmc(i,k,j)    = mcon(1,kflip) <font color=#447700>!Set to deep value here, shallow added in UW scheme<a name='592'></font>
           cmfmcdzm(i,k,j) = mcon(1,kflip)<a name='593'>
        end do<a name='594'>
        <font color=#447700>!Add tendency from zm_conv_evap to tendencies arrays. Also,<a name='595'></font>
        <font color=#447700>!increment the local state arrays to reflect additional tendency<a name='596'></font>
        <font color=#447700>!Note that we are not readjusting the pressure levels to hydrostatic<a name='597'></font>
        <font color=#447700>!balance for the new virtual temperature like is done in CAM. We<a name='598'></font>
        <font color=#447700>!will let WRF take care of such things later for the total<a name='599'></font>
        <font color=#447700>!tendency.<a name='600'></font>
        do k=kts,kte<a name='601'>
           kflip = kte-k+1<a name='602'>
<a name='603'>
           <font color=#447700>!Convert temperature to potential temperature and<a name='604'></font>
           <font color=#447700>!specific humidity to water vapor mixing ratio<a name='605'></font>
           rthcuten(i,k,j) = rthcuten(i,k,j) + &amp;<a name='606'>
                             evaptzm(i,k,j)/pi_phy(i,k,j)<a name='607'>
           rqvcuten(i,k,j) = rqvcuten(i,k,j) + &amp;<a name='608'>
                             evapqzm(i,k,j)*(1. + qv(i,k,j))**2<a name='609'>
<a name='610'>
           t8(1,kflip)    = t8(1,kflip) + evaptzm(i,k,j)*cudts    <font color=#447700>!PMA<a name='611'></font>
           qh8(1,kflip,1) = qh8(1,kflip,1) + evapqzm(i,k,j)*cudts <font color=#447700>!PMA<a name='612'></font>
        end do<a name='613'>
<a name='614'>
        <font color=#447700>! Momentum transport<a name='615'></font>
        stnd       = 0._r8     <font color=#447700>!Zero relevant tendencies in preparation<a name='616'></font>
        wind_tends = 0._r8<a name='617'>
        do k=kts,kte<a name='618'>
           kflip = kte-k+1<a name='619'>
           winds(1,k,1) = u_phy(i,kflip,j)<a name='620'>
           winds(1,k,2) = v_phy(i,kflip,j)<a name='621'>
        end do<a name='622'>
        l_windt(1:2) = .true.<a name='623'>
<a name='624'>
        call <A href='../../html_code/phys/module_cu_camzm.F.html#MOMTRAN'>momtran</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOMTRAN_1"> (lchnk, ncol, &amp;<a name='625'>
             l_windt, winds, 2, mu(:,:,lchnk), md(:,:,lchnk), &amp;<a name='626'>
             du(:,:,lchnk), eu(:,:,lchnk), ed(:,:,lchnk), dp(:,:,lchnk), dsubcld(:,lchnk), &amp;<a name='627'>
             jt(:,lchnk),maxg(:,lchnk), ideep(:,lchnk), 1, lengath(lchnk), &amp;<a name='628'>
             itimestep, wind_tends, pguall, pgdall, icwu, icwd, hcudts, stnd )  <font color=#447700>!PMA<a name='629'></font>
        <a name='630'>
        <font color=#447700>!Add tendency from momtran to tendencies arrays. Also,<a name='631'></font>
        <font color=#447700>!increment the local state arrays to reflect additional tendency<a name='632'></font>
        <font color=#447700>!Note that we are not readjusting the pressure levels to hydrostatic<a name='633'></font>
        <font color=#447700>!balance for the new virtual temperature like is done in CAM. We<a name='634'></font>
        <font color=#447700>!will let WRF take care of such things later for the total<a name='635'></font>
        <font color=#447700>!tendency.<a name='636'></font>
        do k=kts,kte<a name='637'>
           kflip = kte-k+1<a name='638'>
<a name='639'>
           <font color=#447700>!Convert temperature to potential temperature and<a name='640'></font>
           <font color=#447700>!specific humidity to water vapor mixing ratio<a name='641'></font>
           rucuten(i,k,j)  = wind_tends(1,kflip,1)<a name='642'>
           rvcuten(i,k,j)  = wind_tends(1,kflip,2)<a name='643'>
           rthcuten(i,k,j) = rthcuten(i,k,j) + &amp;<a name='644'>
                                stnd(1,kflip)/cpair/pi_phy(i,k,j)<a name='645'>
<a name='646'>
           t8(1,kflip) = t8(1,kflip) + stnd(1,kflip)/cpair*cudts   <font color=#447700>!PMA<a name='647'></font>
           <font color=#447700>!winds is not used again so do not bother updating them<a name='648'></font>
        end do<a name='649'>
<a name='650'>
        <font color=#447700>!Parse output arrays for momtran<a name='651'></font>
        do k=kts,kte<a name='652'>
           kflip = kte-k+1<a name='653'>
<a name='654'>
           zmmtu(i,k,j) = wind_tends(1,kflip,1) <font color=#447700>!wind tendencies...<a name='655'></font>
           zmmtv(i,k,j) = wind_tends(1,kflip,2)<a name='656'>
<a name='657'>
           zmupgu(i,k,j) = pguall(1,kflip,1)   <font color=#447700>!apparent force pres. grads...<a name='658'></font>
           zmupgd(i,k,j) = pgdall(1,kflip,1)<a name='659'>
           zmvpgu(i,k,j) = pguall(1,kflip,2)<a name='660'>
           zmvpgd(i,k,j) = pgdall(1,kflip,2)<a name='661'>
<a name='662'>
           zmicuu(i,k,j) = icwu(1,kflip,1)     <font color=#447700>!in-cloud winds...<a name='663'></font>
           zmicud(i,k,j) = icwd(1,kflip,1)<a name='664'>
           zmicvu(i,k,j) = icwu(1,kflip,2)<a name='665'>
           zmicvd(i,k,j) = icwd(1,kflip,2)<a name='666'>
        end do<a name='667'>
<a name='668'>
        <font color=#447700>!Setup for convective transport of cloud water and ice<a name='669'></font>
        <font color=#447700>!~We should set this up to use an integer pointer instead of<a name='670'></font>
        <font color=#447700>! hard-coded numbers for each species so that we can easily<a name='671'></font>
        <font color=#447700>! handle other species. Something to come back to later...<a name='672'></font>
        l_qt(1)   = .false.     <font color=#447700>!do not mix water vapor<a name='673'></font>
        l_qt(2:3) = .true.      <font color=#447700>!do mix cloud water and ice<a name='674'></font>
        cloudtnd = 0._r8<a name='675'>
        fracis(1,:,1:3) = 1._r8 <font color=#447700>!all cloud liquid &amp; ice <a name='676'></font>
#if ( WRF_CHEM <font color=#447700>!= 1 )<a name='677'></font>
        <font color=#447700>!BSINGH:02/01/2013: For WRF Physics ONLY runs, the liq # and ice # should<a name='678'></font>
        <font color=#447700>!also be transpoted. Please note that liq # and ice # are transported in the <a name='679'></font>
        <font color=#447700>!zm_conv_tend_2 call for WRF_CHEM simulations (ONLY works for MAM aerosols)<a name='680'></font>
        <font color=#447700>!currently.<a name='681'></font>
        fracis(1,:,4:5) = 1._r8<a name='682'>
#endif<a name='683'>
        ncnst = 3               <font color=#447700>!number of constituents in cloud array (including vapor)<a name='684'></font>
        fake_dpdry = 0._r8      <font color=#447700>!delta pres. for dry atmos. (0 since assuming moist mix ratios)<a name='685'></font>
        do k=kts,kte<a name='686'>
           kflip = kte-k+1<a name='687'>
<a name='688'>
           cloud(1,kflip,1) = qh8(1,kflip,1)  <font color=#447700>!We can either use moist mix ratios, as is<a name='689'></font>
           cloud(1,kflip,2) = ql8prm(1,kflip)    <font color=#447700>!done here, or else use dry mix ratios, send<a name='690'></font>
           cloud(1,kflip,3) = qi8(1,kflip)    <font color=#447700>!in appropriate dpdry values, and return the<a name='691'></font>
                                              <font color=#447700>!approp. response from cnst_get_type_byind<a name='692'></font>
        end do<a name='693'>
<a name='694'>
        call <A href='../../html_code/phys/module_cu_camzm.F.html#CONVTRAN'>convtran</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONVTRAN_1"> (lchnk, &amp;<a name='695'>
             l_qt, cloud, ncnst,  mu(:,:,lchnk), md(:,:,lchnk), &amp;<a name='696'>
             du(:,:,lchnk), eu(:,:,lchnk), ed(:,:,lchnk), dp(:,:,lchnk), dsubcld(:,lchnk), &amp;<a name='697'>
             jt(:,lchnk), maxg(:,lchnk), ideep(:,lchnk), 1, lengath(lchnk), &amp;<a name='698'>
             itimestep, fracis, cloudtnd, fake_dpdry)<a name='699'>
<a name='700'>
        <font color=#447700>!Parse output for convtran and increment tendencies<a name='701'></font>
<font color=#447700>!PMA&gt;<a name='702'></font>
        do k=kts,kte<a name='703'>
           kflip = kte-k+1<a name='704'>
           esl(1,kflip)     = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#CAMZM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_17">(t8(1,kflip),0)<a name='705'>
           qvs(1,kflip)     = epsqs*esl(1,kflip)/(pmid8(1,kflip)-(1._r8-epsqs)*esl(1,kflip))<a name='706'>
            if( t8(1,kflip) &gt; 268.15_r8 ) then<a name='707'>
              dum1 = 0.0_r8<a name='708'>
            elseif( t8(1,kflip) &lt; 238.15_r8 ) then<a name='709'>
              dum1 = 1.0_r8<a name='710'>
            else<a name='711'>
              dum1 = ( 268.15_r8 - t8(1,kflip) ) / 30._r8<a name='712'>
            endif<a name='713'>
           qcten_det(1,kflip) = dlf(1,kflip) * ( 1._r8 - dum1 )<a name='714'>
           qiten_det(1,kflip) = dlf(1,kflip) * dum1<a name='715'>
           qcnten_det(1,kflip) = 3._r8 * (dlf(1,kflip)    * ( 1._r8 - dum1 ) ) / (4._r8*3.14159_r8*(8.e-6_r8**3)*997._r8)<a name='716'>
           qinten_det(1,kflip) = 3._r8 * (dlf(1,kflip)    *  dum1 ) / (4._r8*3.14159_r8*(25.e-6_r8**3)*500._r8)<a name='717'>
           qsten_det(1,kflip)  =  dlf(1,kflip) * dum1 * latice                    <font color=#447700>! liquid to ice heating<a name='718'></font>
        end do<a name='719'>
        do k=kts,kte<a name='720'>
           kflip = kte-k+1<a name='721'>
<a name='722'>
           <font color=#447700>!For assisting wetscavenging in WRF_CHEM package -Balwinder.Singh@pnnl.gov<a name='723'></font>
           evapcdp3d(i,k,j) = evapcdp(1,kflip) <a name='724'>
           icwmrdp3d(i,k,j) = ql8(1,kflip)     <a name='725'>
           rprddp3d(i,k,j)  = rprd(1,kflip)    <a name='726'>
<a name='727'>
           zmdice(i,k,j) = cloudtnd(1,kflip,3)+qiten_det(1,kflip)<a name='728'>
           zmdliq(i,k,j) = cloudtnd(1,kflip,2)+qcten_det(1,kflip)<a name='729'>
           rthcuten(i,k,j) = rthcuten(i,k,j) + &amp;<a name='730'>
                            qsten_det(1,kflip)/cpair/pi_phy(i,k,j)<a name='731'>
<a name='732'>
           <font color=#447700>!Convert cloud tendencies from wet to dry mix ratios<a name='733'></font>
           if( present(rqccuten) ) then<a name='734'>
              rqccuten(i,k,j) = (cloudtnd(1,kflip,2)+qcten_det(1,kflip))*(1. + qv(i,k,j))<a name='735'>
           end if<a name='736'>
           if( present(rqicuten) ) then<a name='737'>
              rqicuten(i,k,j) = (cloudtnd(1,kflip,3)+qiten_det(1,kflip))*(1. + qv(i,k,j))<a name='738'>
           end if<a name='739'>
           if( present(rqcncuten) ) then<a name='740'>
              rqcncuten(i,k,j) = qcnten_det(1,kflip)*(1. + qv(i,k,j)) <font color=#447700>!BSINGH - Added the denominator following qiten_det<a name='741'></font>
           end if<a name='742'>
           if( present(rqincuten) ) then<a name='743'>
              rqincuten(i,k,j) = qinten_det(1,kflip)*(1. + qv(i,k,j)) <font color=#447700>!BSINGH - Added the denominator following qiten_det<a name='744'></font>
           end if<a name='745'>
           <font color=#447700>!Variables required by zm_conv_tend_2 call<a name='746'></font>
           dp3d(i,k,j) = dp(1,kflip,lchnk)<a name='747'>
           du3d(i,k,j) = du(1,kflip,lchnk)<a name='748'>
           ed3d(i,k,j) = ed(1,kflip,lchnk)<a name='749'>
           eu3d(i,k,j) = eu(1,kflip,lchnk)<a name='750'>
           md3d(i,k,j) = md(1,kflip,lchnk)<a name='751'>
           mu3d(i,k,j) = mu(1,kflip,lchnk)<a name='752'>
<a name='753'>
           dsubcld2d(i,j) = dsubcld(1,lchnk)<a name='754'>
           ideep2d(i,j)   = ideep(1,lchnk)<a name='755'>
           jt2d(i,j)      = jt(1,lchnk)<a name='756'>
           maxg2d(i,j)    = maxg(1,lchnk)<a name='757'>
           lengath2d(i,j) = lengath(lchnk)<a name='758'>
        end do<a name='759'>
        <a name='760'>
     end do <font color=#447700>!i-loop<a name='761'></font>
  end do    <font color=#447700>!j-loop<a name='762'></font>
END SUBROUTINE camzm_driver<a name='763'>
<a name='764'>
<a name='765'>
<font color=#447700>!------------------------------------------------------------------------<a name='766'></font>
<A NAME='ZM_CONV_INIT'><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='767'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>zm_conv_init</font>(DT, DX, rucuten, rvcuten, rthcuten, rqvcuten,   &amp; <A href='../../call_to/ZM_CONV_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/ZM_CONV_INIT.html' TARGET='index'>9</A><a name='768'>
                     rqccuten, rqicuten, rqcncuten, rqincuten,          &amp;<a name='769'>
                     p_qc, p_qi, p_qnc, p_qni, param_first_scalar,      &amp;<a name='770'>
                     restart,                                           &amp;<a name='771'>
                     ids, ide, jds, jde, kds, kde,                      &amp;<a name='772'>
                     ims, ime, jms, jme, kms, kme,                      &amp;<a name='773'>
                     its, ite, jts, jte, kts, kte                    )<a name='774'>
<font color=#447700>! Initialization routine for Zhang-McFarlane cumulus parameterization<a name='775'></font>
<font color=#447700>! from CAM. The routine with this name in CAM is revamped here to give<a name='776'></font>
<font color=#447700>! the needed functionality within WRF.<a name='777'></font>
<font color=#447700>!<a name='778'></font>
<font color=#447700>! Author: William.Gustafson@pnl.gov, Nov. 2009<a name='779'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='780'></font>
  USE <A href='../../html_code/phys/module_cam_physconst.F.html#PHYSCONST'>physconst</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSCONST_18">, only: epsilo, latvap, latice, rh2o, cpair, tmelt<a name='781'>
  USE <A href='../../html_code/phys/module_cu_camzm.F.html#MODULE_CU_CAMZM'>module_cu_camzm</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CU_CAMZM_2">, only: zm_convi, zmconv_readnl<a name='782'>
  USE <A href='../../html_code/phys/module_cam_constituents.F.html#CONSTITUENTS'>constituents</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTITUENTS_17">, only: cnst_get_ind<a name='783'>
<a name='784'>
  LOGICAL , INTENT(IN)           ::   restart<a name='785'>
  INTEGER , INTENT(IN)           ::   ids, ide, jds, jde, kds, kde, &amp;<a name='786'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='787'>
                                      its, ite, jts, jte, kts, kte, &amp;<a name='788'>
                                      p_qc, p_qi, p_qnc, p_qni,     &amp;<a name='789'>
                                      param_first_scalar<a name='790'>
<a name='791'>
   REAL ,    INTENT(IN)        :: DT, DX<a name='792'>
<a name='793'>
<a name='794'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(INOUT) :: &amp;<a name='795'>
                                                           rucuten, &amp;<a name='796'>
                                                           rvcuten, &amp;<a name='797'>
                                                          rthcuten, &amp;<a name='798'>
                                                          rqvcuten, &amp;<a name='799'>
                                                          rqccuten, &amp;<a name='800'>
                                                          rqicuten, &amp;<a name='801'>
                                                          rqcncuten,&amp;<a name='802'>
                                                          rqincuten<a name='803'>
<a name='804'>
  integer :: i, itf, j, jtf, k, ktf<a name='805'>
  integer :: limcnv<a name='806'>
<a name='807'>
  jtf = min(jte,jde-1)<a name='808'>
  ktf = min(kte,kde-1)<a name='809'>
  itf = min(ite,ide-1)<a name='810'>
<a name='811'>
  call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_7">('CLDLIQ', ixcldliq)<a name='812'>
  call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_8">('CLDICE', ixcldice)       <a name='813'>
  call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_9">('NUMLIQ', ixnumliq)<a name='814'>
  call <A href='../../html_code/phys/module_cam_constituents.F.html#CNST_GET_IND'>cnst_get_ind</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CNST_GET_IND_10">('NUMICE', ixnumice)<a name='815'>
  <a name='816'>
<font color=#447700>!<a name='817'></font>
<font color=#447700>! Initialize module_cam_support variables...<a name='818'></font>
<font color=#447700>! This could be moved to a master "cam-init" subroutine once multiple CAM<a name='819'></font>
<font color=#447700>! parameterizations are implemented in WRF. For now, it doesn't hurt to<a name='820'></font>
<font color=#447700>! have these possibly initialized more than once since they are<a name='821'></font>
<font color=#447700>! essentially constant.<a name='822'></font>
<font color=#447700>!<a name='823'></font>
  pver  = ktf-kts+1<a name='824'>
  pverp = pver+1<a name='825'>
<font color=#447700>!~Need code here to set limcnv to max convective level of 40 mb... To <a name='826'></font>
<font color=#447700>! properly set an average value for the whole domain would involve doing<a name='827'></font>
<font color=#447700>! a collective operation across the whole domain to get pressure averages<a name='828'></font>
<font color=#447700>! by level, which is difficult within the WRF framework. So, we will just<a name='829'></font>
<font color=#447700>! use the model top for now.<a name='830'></font>
<font color=#447700>!<a name='831'></font>
<font color=#447700>! Technically, limcnv should be calculated for each grid point at each<a name='832'></font>
<font color=#447700>! time because the levels in WRF do not have a constant pressure, as<a name='833'></font>
<font color=#447700>! opposed to CAM. But, that would involve making this variable local<a name='834'></font>
<font color=#447700>! instead of at the module level as is currently done in CAM. For now,<a name='835'></font>
<font color=#447700>! we will not worry about this because WRF rarely has domains higher than<a name='836'></font>
<font color=#447700>! 40 mb. There is also little variability between grid points near the<a name='837'></font>
<font color=#447700>! model top due to the underlying topography so a constant value would<a name='838'></font>
<font color=#447700>! be OK across the domain. Also, remember that CAM levels are reversed in<a name='839'></font>
<font color=#447700>! the vertical from WRF. So, setting limcnv to 1 means the top of the<a name='840'></font>
<font color=#447700>! domain. Note that because of a bug in the parcel_dilute routine, limcnv<a name='841'></font>
<font color=#447700>! must be &gt;=2 instead of 1. Otherwise, an array out-of-bounds occurs.<a name='842'></font>
  limcnv = 2<a name='843'>
<font color=#447700>!<a name='844'></font>
<font color=#447700>! Get the ZM namelist variables (hard-wired for now)...<a name='845'></font>
<font color=#447700>!<a name='846'></font>
  call <A href='../../html_code/phys/module_cu_camzm.F.html#ZMCONV_READNL'>zmconv_readnl</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZMCONV_READNL_1">("hard-wired")<a name='847'>
<font color=#447700>! <a name='848'></font>
<font color=#447700>!~need to determine if convection should happen in PBL and set<a name='849'></font>
<font color=#447700>! no_deep_pbl_in accordingly<a name='850'></font>
  call <A href='../../html_code/phys/module_cu_camzm.F.html#ZM_CONVI'>zm_convi</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZM_CONVI_1">(DT, DX, limcnv, NO_DEEP_PBL_IN=.true.)<a name='851'>
<a name='852'>
<font color=#447700>!<a name='853'></font>
<font color=#447700>! Set initial values for arrays dependent on restart conditions<a name='854'></font>
<font color=#447700>!<a name='855'></font>
  if(.not.restart)then<a name='856'>
     do j=jts,jtf<a name='857'>
        do k=kts,ktf<a name='858'>
           do i=its,itf<a name='859'>
              rucuten(i,k,j)  = 0.<a name='860'>
              rvcuten(i,k,j)  = 0.<a name='861'>
              rthcuten(i,k,j) = 0.<a name='862'>
              rqvcuten(i,k,j) = 0.<a name='863'>
              if( p_qc  &gt; param_first_scalar ) rqccuten(i,k,j)  = 0.<a name='864'>
              if( p_qi  &gt; param_first_scalar ) rqicuten(i,k,j)  = 0.<a name='865'>
              if( p_qnc &gt; param_first_scalar ) rqcncuten(i,k,j) = 0.<a name='866'>
              if( p_qni &gt; param_first_scalar ) rqincuten(i,k,j) = 0.<a name='867'>
           enddo<a name='868'>
        enddo<a name='869'>
     enddo<a name='870'>
  end if<a name='871'>
<a name='872'>
END SUBROUTINE zm_conv_init<a name='873'>
<a name='874'>
<a name='875'>
<font color=#447700>!------------------------------------------------------------------------<a name='876'></font>
<A NAME='GET_TPERT'><A href='../../html_code/phys/module_cu_camzm_driver.F.html#GET_TPERT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='877'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>get_tpert</font>(bl_pbl_physics, sf_sfclay_physics, dx, &amp; <A href='../../call_to/GET_TPERT.html' TARGET='index'>1</A>,<A href='../../call_from/GET_TPERT.html' TARGET='index'>6</A><a name='878'>
     mavail, kpbl, pblh, dzlowest, &amp;<a name='879'>
     psfc, qvlowest, t_phylowest, thlowest, tsk, tke_pbl, ust,   &amp;<a name='880'>
     u_phylowest, v_phylowest, hfx, qfx, tpert_camuwpbl, kte, tpert)<a name='881'>
<font color=#447700>! Calculates the temperature perturbation used to trigger convection.<a name='882'></font>
<font color=#447700>! This should only be used if tpert is not already provided by CAM's PBL<a name='883'></font>
<font color=#447700>! scheme. Right now, this only works with the Mellor-Yamada boundary<a name='884'></font>
<font color=#447700>! layer scheme in combination with the MYJ surface scheme. This is due to<a name='885'></font>
<font color=#447700>! the need of TKE for the vertical velocity perturbation. This scheme has<a name='886'></font>
<font color=#447700>! not been generalized to handle all schemes that produce TKE at this<a name='887'></font>
<font color=#447700>! time, and the non-TKE schemes, e.g. YSU, could probably have an<a name='888'></font>
<font color=#447700>! appropriate tpert deduced but we have not taken the time yet to do it.<a name='889'></font>
<font color=#447700>!<a name='890'></font>
<font color=#447700>! Author: William.Gustafson@pnl.gov, Nov. 2009<a name='891'></font>
<font color=#447700>! Last updated: William.Gustafson@pnl.gov, Nov. 2010<a name='892'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='893'></font>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#GET_TPERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_47">, only: cp, ep_1, ep_2, g, r_d, rcp, &amp;<a name='894'>
                                    svp1, svp2, svp3, svpt0, xlv<a name='895'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#GET_TPERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_110">, ONLY : SFCLAYSCHEME              &amp;<a name='896'>
                                      ,MYJSFCSCHEME              &amp;<a name='897'>
                                      ,GFSSFCSCHEME              &amp;<a name='898'>
                                      ,SLABSCHEME                &amp;<a name='899'>
                                      ,LSMSCHEME                 &amp;<a name='900'>
                                      ,RUCLSMSCHEME              &amp;<a name='901'>
                                      ,MYJPBLSCHEME              &amp;<a name='902'>
                                      ,CAMUWPBLSCHEME<a name='903'>
<font color=#447700>!<a name='904'></font>
<font color=#447700>! Subroutine arguments...<a name='905'></font>
<font color=#447700>!<a name='906'></font>
  real, dimension(:), intent(in) :: tke_pbl<a name='907'>
  real, intent(in) :: dx, dzlowest, hfx, mavail, pblh, psfc, qvlowest, &amp;<a name='908'>
       tpert_camuwpbl, tsk, t_phylowest, thlowest, ust, u_phylowest, &amp;<a name='909'>
       v_phylowest<a name='910'>
  integer, intent(in) :: bl_pbl_physics, kpbl, kte, sf_sfclay_physics<a name='911'>
  real(r8),intent(inout) :: tpert<a name='912'>
<font color=#447700>!<a name='913'></font>
<font color=#447700>! Local vars...<a name='914'></font>
<font color=#447700>!<a name='915'></font>
  real, parameter :: fak      = 8.5   <font color=#447700>!Constant in surface temperature excess         <a name='916'></font>
  real, parameter :: tfac     = 1.    <font color=#447700>!Ratio of 'tpert' to (w't')/wpert<a name='917'></font>
  real, parameter :: wfac     = 1.    <font color=#447700>!Ratio of 'wpert' to sqrt(tke)<a name='918'></font>
  real, parameter :: wpertmin = 1.e-6 <font color=#447700>!Min PBL eddy vertical velocity perturbation<a name='919'></font>
  real :: ebrk                        <font color=#447700>!In CAM, net mean TKE of CL including<a name='920'></font>
                                      <font color=#447700>!entrainment effect (m2/s2). In WRF,<a name='921'></font>
                                      <font color=#447700>!average TKE within the PBL<a name='922'></font>
  real :: br2, dthvdz, e1, flux, govrth, psfccmb, qfx, qsfc, rhox, thgb, &amp;<a name='923'>
       thv, tskv, tvcon, vconv, vsgd, wpert, wspd, za<a name='924'>
  integer :: k<a name='925'>
  character(len=250) :: msg<a name='926'>
  logical :: UnstableOrNeutral<a name='927'>
<font color=#447700>!<a name='928'></font>
<font color=#447700>! We can get the perturbation values directly from CAMUWPBLSCHEME if<a name='929'></font>
<font color=#447700>! available. Otherwise, we have to calculate them.<a name='930'></font>
<font color=#447700>!<a name='931'></font>
  if( bl_pbl_physics==CAMUWPBLSCHEME ) then<a name='932'>
     tpert = tpert_camuwpbl<a name='933'>
<font color=#447700>!<a name='934'></font>
<font color=#447700>!...non-CAMUWPBL. Need MYJ SFC &amp; PBL for now until other schemes<a name='935'></font>
<font color=#447700>!   get coded to give perturbations too.<a name='936'></font>
<font color=#447700>! First, we need to determine if the conditions are stable or unstable.<a name='937'></font>
<font color=#447700>! We will do this by mimicing the bulk Richardson calculation from<a name='938'></font>
<font color=#447700>! module_sf_sfclay.F because the MYJ scheme does not provide this info.<a name='939'></font>
<font color=#447700>! The logic borrowed from the CuP shallow cumulus scheme. Non-MYJ sfc<a name='940'></font>
<font color=#447700>! scheme code is commented out for now since we also require MYJ PBL<a name='941'></font>
<font color=#447700>! scheme.<a name='942'></font>
<font color=#447700>!<a name='943'></font>
  elseif( bl_pbl_physics==MYJPBLSCHEME ) then<a name='944'>
<a name='945'>
     UnstableOrNeutral = .false.<a name='946'>
     sfclay_case: SELECT CASE (sf_sfclay_physics)<a name='947'>
     CASE (MYJSFCSCHEME)<a name='948'>
        <font color=#447700>! The MYJ sfc scheme does not already provide a stability criteria.<a name='949'></font>
        <font color=#447700>! So, we will mimic the bulk Richardson calculation from<a name='950'></font>
        <font color=#447700>! module_sf_sfclay.F.<a name='951'></font>
<a name='952'>
        if( pblh &lt;= 0. ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#GET_TPERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_596">( &amp;<a name='953'>
             "CAMZMSCHEME needs a PBL height from a PBL scheme.")<a name='954'>
<a name='955'>
        za     = 0.5*dzlowest<a name='956'>
<a name='957'>
        e1     = svp1*exp(svp2*(tsk-svpt0)/(tsk-svp3))<a name='958'>
        psfccmb=psfc/1000.  <font color=#447700>!converts from Pa to cmb<a name='959'></font>
        qsfc   = ep_2*e1/(psfccmb-e1)<a name='960'>
        thgb   = tsk*(100./psfccmb)**rcp<a name='961'>
        tskv   = thgb*(1.+ep_1*qsfc*mavail)<a name='962'>
        tvcon  = 1.+ep_1*qvlowest<a name='963'>
        thv    = thlowest*tvcon<a name='964'>
        dthvdz = (thv-tskv)<a name='965'>
<a name='966'>
        govrth = g/thlowest<a name='967'>
<a name='968'>
        rhox   = psfc/(r_d*t_phylowest*tvcon)<a name='969'>
        flux   = max(hfx/rhox/cp + ep_1*tskv*qfx/rhox,0.)<a name='970'>
        vconv  = (g/tsk*pblh*flux)**.33<a name='971'>
        vsgd   = 0.32 * (max(dx/5000.-1.,0.))**.33<a name='972'>
        wspd   = sqrt(u_phylowest*u_phylowest+v_phylowest*v_phylowest)<a name='973'>
        wspd   = sqrt(wspd*wspd+vconv*vconv+vsgd*vsgd)<a name='974'>
        wspd   = max(wspd,0.1)<a name='975'>
<a name='976'>
        <font color=#447700>!And finally, the bulk Richardson number...<a name='977'></font>
        br2   = govrth*za*dthvdz/(wspd*wspd)<a name='978'>
<a name='979'>
        if( br2 &lt;= 0. ) UnstableOrNeutral = .true.<a name='980'>
<a name='981'>
     CASE DEFAULT<a name='982'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#GET_TPERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_597">("CAMZMSCHEME requires MYJSFCSCHEME or else CAMUWPBLSCHEME.")<a name='983'>
<a name='984'>
     END SELECT sfclay_case<a name='985'>
<font color=#447700>!<a name='986'></font>
<font color=#447700>! The perturbation temperature for unstable conditions...<a name='987'></font>
<font color=#447700>! The calculation follows the one in caleddy inside eddy_diff.F90 from<a name='988'></font>
<font color=#447700>! CAM.<a name='989'></font>
<font color=#447700>!<a name='990'></font>
     <font color=#447700>!Check that we are using the MJY BL scheme since we are hard-wired to<a name='991'></font>
     <font color=#447700>!use TKE and u* from this scheme. At some point this dependency should<a name='992'></font>
     <font color=#447700>!be broken and a way needs to be found for other schemes to provide<a name='993'></font>
     <font color=#447700>!reasonable tpert values too.<a name='994'></font>
     if( bl_pbl_physics /= MYJPBLSCHEME ) &amp;<a name='995'>
          call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#GET_TPERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_598">("CAMZMSCHEME requires MYJPBLSCHEME or CAMUWPBLSCHEME")<a name='996'>
   <a name='997'>
<a name='998'>
     <font color=#447700>!Recalculate rhox in case a non-MYJ scheme is used to get<a name='999'></font>
     <font color=#447700>!stability and rhox is not calculated above. Right now, this is<a name='1000'></font>
     <font color=#447700>!technically reduncant, but cheap.<a name='1001'></font>
     tvcon = 1.+ep_1*qvlowest<a name='1002'>
     rhox  = psfc/(r_d*t_phylowest*tvcon)<a name='1003'>
<a name='1004'>
     if( UnstableOrNeutral ) then<a name='1005'>
        <font color=#447700>!1st, get avg TKE w/n the PBL as a proxy for ebrk variable in CAM<a name='1006'></font>
        ebrk = 0.<a name='1007'>
        do k=1,min(kpbl,kte+1) <font color=#447700>!BSINGH - Changed KTE to KTE+1 as tke_pbl is @ interfaces<a name='1008'></font>
           ebrk = ebrk + tke_pbl(k)<a name='1009'>
        end do<a name='1010'>
        ebrk = ebrk/real(kpbl)<a name='1011'>
<a name='1012'>
        wpert = max( wfac*sqrt(ebrk), wpertmin )<a name='1013'>
        tpert = max( abs(hfx/rhox/cp)*tfac/wpert, 0. )<a name='1014'>
<font color=#447700>!<a name='1015'></font>
<font color=#447700>! Or, the perturbation temperature for stable conditions...<a name='1016'></font>
<font color=#447700>!<a name='1017'></font>
     else <font color=#447700>!Stable conditions<a name='1018'></font>
        tpert = max( hfx/rhox/cp*fak/ust, 0. )<a name='1019'>
     end if<a name='1020'>
<a name='1021'>
  else<a name='1022'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#GET_TPERT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_599">("CAMZMSCHEME requires MYJPBLSCHEME or CAMUWPBLSCHEME")<a name='1023'>
<a name='1024'>
  end if <font color=#447700>!PBL choice<a name='1025'></font>
<a name='1026'>
END SUBROUTINE get_tpert<a name='1027'>
<a name='1028'>
<a name='1029'>
<font color=#447700>!=========================================================================================<a name='1030'></font>
<a name='1031'>
#if ( WRF_CHEM == 1 )<a name='1032'>
<A NAME='ZM_CONV_TEND_2'><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_TEND_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1033'>
<font color=#993300>subroutine </font><font color=#cc0000>zm_conv_tend_2</font>(itimestep, dt, p8w, fracis3d, dp3d, du3d, ed3d, eu3d, md3d, mu3d, &amp;,<A href='../../call_from/ZM_CONV_TEND_2.html' TARGET='index'>7</A><a name='1034'>
     dsubcld2d, ideep2d, jt2d, maxg2d, lengath2d, moist, scalar, chem,                      &amp;<a name='1035'>
     ids,ide, jds,jde, kds,kde, &amp;<a name='1036'>
     ims,ime, jms,jme, kms,kme, &amp;<a name='1037'>
     its,ite, jts,jte, kts,kte)<a name='1038'>
<a name='1039'>
  use <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_TEND_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_111">,  only: num_moist, num_scalar, num_chem, param_first_scalar, &amp;<a name='1040'>
       P_QV, P_QC, P_QI, P_QNC, P_QNI, CBMZ_CAM_MAM3_NOAQ, CBMZ_CAM_MAM3_AQ,                &amp;<a name='1041'>
       CBMZ_CAM_MAM7_NOAQ,CBMZ_CAM_MAM7_AQ<a name='1042'>
  use <A href='../../html_code/phys/module_data_cam_mam_asect.F.html#MODULE_DATA_CAM_MAM_ASECT'>module_data_cam_mam_asect</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_TEND_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATA_CAM_MAM_ASECT_1">, only: lptr_chem_to_q, factconv_chem_to_q<a name='1043'>
  use <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#MODULE_MP_CAMMGMP_DRIVER'>module_mp_cammgmp_driver</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_TEND_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MP_CAMMGMP_DRIVER_1">,  only: physics_update, physics_ptend_init<a name='1044'>
<a name='1045'>
  implicit none<a name='1046'>
  <a name='1047'>
  <font color=#447700>! Arguments<a name='1048'></font>
<a name='1049'>
  <font color=#447700>!intent-ins<a name='1050'></font>
  integer, intent(in) :: itimestep<a name='1051'>
  integer, intent(in) :: ids,ide, jds,jde, kds,kde<a name='1052'>
  integer, intent(in) :: ims,ime, jms,jme, kms,kme<a name='1053'>
  integer, intent(in) :: its,ite, jts,jte, kts,kte<a name='1054'>
<a name='1055'>
  integer, dimension(ims:ime,jms:jme), intent(in) :: ideep2d, jt2d, maxg2d, lengath2d<a name='1056'>
  <a name='1057'>
  real, intent(in) :: dt<a name='1058'>
<a name='1059'>
  real, dimension(ims:ime,jms:jme), intent(in) :: dsubcld2d<a name='1060'>
<a name='1061'>
  real, dimension(ims:ime,kms:kme,jms:jme), intent(in) :: p8w, dp3d, du3d, ed3d, eu3d, md3d<a name='1062'>
  real, dimension(ims:ime,kms:kme,jms:jme), intent(in) :: mu3d <a name='1063'>
<a name='1064'>
  real, dimension(ims:ime,kms:kme,jms:jme,pcnst), intent(in) :: fracis3d<a name='1065'>
  <a name='1066'>
  <font color=#447700>!intent-inouts<a name='1067'></font>
  real, dimension(ims:ime,kms:kme,jms:jme,num_moist),  intent(inout) :: moist<a name='1068'>
  real, dimension(ims:ime,kms:kme,jms:jme,num_scalar), intent(inout) :: scalar<a name='1069'>
  real, dimension(ims:ime,kms:kme,jms:jme,num_chem),   intent(inout) :: chem<a name='1070'>
  <a name='1071'>
  <a name='1072'>
  <font color=#447700>! Local variables<a name='1073'></font>
  character(len=1000) :: msg<a name='1074'>
  character*24 :: ptend_name            <font color=#447700>!ptend%name in CAM5 - used in parameterization<a name='1075'></font>
  logical      :: ptend_ls              <font color=#447700>!ptend%ls   in CAM5 - used for calling physics_update subroutine<a name='1076'></font>
  logical      :: ptend_lq(pcnst)       <font color=#447700>!ptend%lq   in CAM5<a name='1077'></font>
<a name='1078'>
  integer :: iw, jw, kw, kflip, l, l2<a name='1079'>
  integer :: i, lchnk, istat<a name='1080'>
  integer :: nstep<a name='1081'>
<a name='1082'>
  real(r8) :: delta_p, multFrc, dtime <a name='1083'>
  real(r8) :: dpdry(pcols,kte)<a name='1084'>
  real(r8) :: state_pdel(pcols,kte)                <font color=#447700>! Pressure difference (Pa) <a name='1085'></font>
  real(r8) :: state_pdeldry(pcols,kte)             <font color=#447700>! dry pressure difference (1/Pa)<a name='1086'></font>
  real(r8) :: state_q(pcols,kte,pcnst)<a name='1087'>
  real(r8) :: state_s(pcols,kte)<a name='1088'>
  real(r8) :: ptend_s(pcols,kte)                   <font color=#447700>!Dummy arguments for physics_update call<a name='1089'></font>
  real(r8) :: ptend_q(pcols,kte,pcnst)<a name='1090'>
  <a name='1091'>
  real(r8) :: dp(pcols, kte, (ime-ims+1)*(jme-jms+1)) <font color=#447700>!layer pres. thickness between interfaces (mb)<a name='1092'></font>
  real(r8) :: du(pcols, kte, (ime-ims+1)*(jme-jms+1)) <a name='1093'>
  real(r8) :: ed(pcols, kte, (ime-ims+1)*(jme-jms+1))<a name='1094'>
  real(r8) :: eu(pcols, kte, (ime-ims+1)*(jme-jms+1)) <a name='1095'>
  real(r8) :: md(pcols, kte, (ime-ims+1)*(jme-jms+1))<a name='1096'>
  real(r8) :: mu(pcols, kte, (ime-ims+1)*(jme-jms+1))<a name='1097'>
<a name='1098'>
  real(r8) :: dsubcld(pcols, (ime-ims+1)*(jme-jms+1)) <font color=#447700>! layer pres. thickness between LCL and maxi (mb)<a name='1099'></font>
<a name='1100'>
  integer :: ideep(pcols, (ime-ims+1)*(jme-jms+1)) <font color=#447700>! holds position of gathered points<a name='1101'></font>
  integer :: jt(pcols, (ime-ims+1)*(jme-jms+1))    <font color=#447700>! top-level index of deep cumulus convection<a name='1102'></font>
  integer :: maxg(pcols, (ime-ims+1)*(jme-jms+1))  <font color=#447700>! gathered values of maxi<a name='1103'></font>
                               <a name='1104'>
  integer :: lengath((ime-ims+1)*(jme-jms+1))    <font color=#447700>! number of gathered points<a name='1105'></font>
<a name='1106'>
  <a name='1107'>
  <font color=#447700>! physics buffer fields <a name='1108'></font>
  integer itim, ifld<a name='1109'>
  real(r8), dimension(pcols,kte,pcnst) :: fracis  <font color=#447700>! fraction of transported species that are insoluble<a name='1110'></font>
<a name='1111'>
  <font color=#447700>!Time step is stored in the (r8) format in dtime<a name='1112'></font>
  dtime = dt<a name='1113'>
<a name='1114'>
  <font color=#447700>! Map variables for CAM subrouine call<a name='1115'></font>
  <font color=#447700>! Loop over the points in the tile and treat them each as a CAM chunk.<a name='1116'></font>
  <font color=#447700>!<a name='1117'></font>
<a name='1118'>
  <font color=#447700>!BSINGH:02/01/2013: Sanity check for Non-MAM simulations<a name='1119'></font>
  <font color=#447700>!This subroutine will not be called for chem_opt=0, so we dont need to worry about chem_opt = 0<a name='1120'></font>
  if(.NOT.cam_mam_aerosols) then<a name='1121'>
     write(msg,*)'CAMZM DRIVER - zm_conv_tend_2 is valid for only MAM aerosols ', &amp;<a name='1122'>
          '(chem_opts:',CBMZ_CAM_MAM3_NOAQ,CBMZ_CAM_MAM3_AQ,CBMZ_CAM_MAM7_NOAQ,CBMZ_CAM_MAM7_AQ ,')'<a name='1123'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_TEND_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_600">( msg )<a name='1124'>
  endif<a name='1125'>
  <a name='1126'>
  do jw = jts,jte<a name='1127'>
     do iw = its,ite<a name='1128'>
        lchnk = (jw-jts)*(ite-its+1) + (iw-its+1) <font color=#447700>!1-D index location from the 2-D tile<a name='1129'></font>
        <a name='1130'>
        <font color=#447700>!Flip variables on the layer middles<a name='1131'></font>
        do kw = kts,kte<a name='1132'>
           kflip = kte-kw+1<a name='1133'>
<a name='1134'>
           <font color=#447700>!Following three formulas are obtained from ported CAM's ZM cumulus scheme<a name='1135'></font>
           <font color=#447700>!Values of 0 cause a crash in entropy<a name='1136'></font>
           multFrc              = 1._r8/(1._r8 + moist(iw,kw,jw,P_QV))<a name='1137'>
           state_q(1,kflip,1)   = moist(iw,kw,jw,P_QV)*multFrc      <font color=#447700>!Specific humidity<a name='1138'></font>
           state_q(1,kflip,ixcldliq) = moist(iw,kw,jw,P_QC)*multFrc <font color=#447700>!Convert to moist mix ratio-cloud liquid<a name='1139'></font>
           state_q(1,kflip,ixcldice) = moist(iw,kw,jw,P_QI)*multFrc <font color=#447700>!cloud ice                              <a name='1140'></font>
           state_q(1,kflip,ixnumliq) = scalar(iw,kw,jw,P_QNC)*multFrc<a name='1141'>
           state_q(1,kflip,ixnumice) = scalar(iw,kw,jw,P_QNI)*multFrc<a name='1142'>
           do l = 1, 5<a name='1143'>
              fracis(1,kflip,l)      = fracis3d(iw,kw,jw,l)<a name='1144'>
           enddo<a name='1145'>
           <font color=#447700>!populate state_q and qqcw arrays<a name='1146'></font>
           <font color=#447700>!Following Do-Loop is obtained from chem/module_cam_mam_aerchem_driver.F <a name='1147'></font>
           do l = param_first_scalar, num_chem<a name='1148'>
              l2 = lptr_chem_to_q(l)<a name='1149'>
              if ((l2 &gt;= 1) .and. (l2 &lt;= pcnst)) then<a name='1150'>
                 fracis(1,kflip,l2)  = fracis3d(iw,kw,jw,l2)<a name='1151'>
                 state_q(1,kflip,l2) = chem(iw,kw,jw,l)*factconv_chem_to_q(l)<a name='1152'>
              end if<a name='1153'>
           end do <font color=#447700>! l<a name='1154'></font>
           <a name='1155'>
           delta_p                 = p8w(iw,kw,jw) - p8w(iw,kw+1,jw) <font color=#447700>!Change in pressure (Pa) <a name='1156'></font>
           state_pdel(  1,kflip)   = delta_p<a name='1157'>
           state_pdeldry(1,kflip)  = state_pdel(1,kflip)*(1._r8-state_q(1,kflip,1)) <a name='1158'>
           <font color=#447700>!Variables required by zm_conv_tend_2 call<a name='1159'></font>
           dp(1,kflip,lchnk) = dp3d(iw,kw,jw) <a name='1160'>
           du(1,kflip,lchnk) = du3d(iw,kw,jw)  <a name='1161'>
           ed(1,kflip,lchnk) = ed3d(iw,kw,jw)  <a name='1162'>
           eu(1,kflip,lchnk) = eu3d(iw,kw,jw)  <a name='1163'>
           md(1,kflip,lchnk) = md3d(iw,kw,jw)  <a name='1164'>
           mu(1,kflip,lchnk) = mu3d(iw,kw,jw)  <a name='1165'>
           <a name='1166'>
           dsubcld(1,lchnk)  = dsubcld2d(iw,jw)  <a name='1167'>
           ideep(1,lchnk)    = ideep2d(iw,jw)    <a name='1168'>
           jt(1,lchnk)       = jt2d(iw,jw)       <a name='1169'>
           maxg(1,lchnk)     = maxg2d(iw,jw)     <a name='1170'>
           lengath(lchnk)    = lengath2d(iw,jw) <a name='1171'>
        enddo<a name='1172'>
        <a name='1173'>
        <font color=#447700>!<a name='1174'></font>
        <font color=#447700>! Initialize<a name='1175'></font>
        <font color=#447700>!<a name='1176'></font>
        call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_PTEND_INIT'>physics_ptend_init</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_TEND_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_PTEND_INIT_1">(ptend_name,ptend_q,ptend_s,ptend_lq,ptend_ls,pcnst)  <font color=#447700>!! Initialize local ptend type <a name='1177'></font>
                <a name='1178'>
        <font color=#447700>!<a name='1179'></font>
        <font color=#447700>! Transport all constituents except cloud water and ice<a name='1180'></font>
        <font color=#447700>!<a name='1181'></font>
        <a name='1182'>
        nstep = itimestep<a name='1183'>
        <a name='1184'>
        <font color=#447700>!<a name='1185'></font>
        <font color=#447700>!     Convective transport of all trace species except cloud liquid <a name='1186'></font>
        <font color=#447700>!     and cloud ice done here because we need to do the scavenging first<a name='1187'></font>
        <font color=#447700>!     to determine the interstitial fraction.<a name='1188'></font>
        <font color=#447700>!<a name='1189'></font>
        ptend_name  = 'convtran2'<a name='1190'>
        ptend_lq(:) = .true.<a name='1191'>
        ptend_lq(1)        = .false.<a name='1192'>
        ptend_lq(ixcldice) = .false.<a name='1193'>
        ptend_lq(ixcldliq) = .false.<a name='1194'>
        <a name='1195'>
        <font color=#447700>! initialize dpdry for call to convtran<a name='1196'></font>
        <font color=#447700>! it is used for tracers of dry mixing ratio type<a name='1197'></font>
        dpdry = 0._r8<a name='1198'>
        do i = 1,lengath(lchnk)<a name='1199'>
           dpdry(i,:) = state_pdeldry(ideep(i,lchnk),:)/100._r8<a name='1200'>
        end do<a name='1201'>
        <a name='1202'>
        call <A href='../../html_code/phys/module_cu_camzm.F.html#CONVTRAN'>convtran</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_TEND_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONVTRAN_2"> (lchnk,                                        &amp;<a name='1203'>
             ptend_lq,state_q, pcnst,  mu(:,:,lchnk), md(:,:,lchnk),   &amp;<a name='1204'>
             du(:,:,lchnk), eu(:,:,lchnk), ed(:,:,lchnk), dp(:,:,lchnk), dsubcld(:,lchnk),  &amp;<a name='1205'>
             jt(:,lchnk),maxg(:,lchnk),ideep(:,lchnk), 1, lengath(lchnk),  &amp;<a name='1206'>
             nstep,   fracis,  ptend_q, dpdry)<a name='1207'>
<a name='1208'>
        <font color=#447700>!Update chem array and state constiuents<a name='1209'></font>
        <font color=#447700>!populate state_s, ptend_s, ptend_ls with dummy values (zeros) for physics update call<a name='1210'></font>
        state_s(:,:) = 0.0_r8<a name='1211'>
        ptend_s(:,:) = 0.0_r8<a name='1212'>
        ptend_ls     = .FALSE.<a name='1213'>
        <a name='1214'>
        call <A href='../../html_code/phys/module_mp_cammgmp_driver.F.html#PHYSICS_UPDATE'>physics_update</A><A href='../../html_code/phys/module_cu_camzm_driver.F.html#ZM_CONV_TEND_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICS_UPDATE_1">(lchnk,dtime,state_q,ptend_q,state_s,ptend_s,ptend_name,ptend_lq,ptend_ls,pcnst)<a name='1215'>
<a name='1216'>
        <font color=#447700>!Post processing of the output to update WRF arrays<a name='1217'></font>
          do kw=kts,kte<a name='1218'>
             <a name='1219'>
             kflip = kte-kw+1<a name='1220'>
<a name='1221'>
             <font color=#447700>!Following equation are derived following UWPBL and CAMZM schemes<a name='1222'></font>
             moist(iw,kw,jw,P_QV)   = state_q(1,kflip,1) / (1.0_r8 - state_q(1,kflip,1)) <a name='1223'>
             multFrc                = 1._r8 + moist(iw,kw,jw,P_QV)<a name='1224'>
             <a name='1225'>
             moist(iw,kw,jw,P_QC)   = state_q(1,kflip,2) * multFrc<a name='1226'>
             moist(iw,kw,jw,P_QI)   = state_q(1,kflip,3) * multFrc <a name='1227'>
             <a name='1228'>
             scalar(iw,kw,jw,P_QNC) = state_q(1,kflip,4) * multFrc <a name='1229'>
             scalar(iw,kw,jw,P_QNI) = state_q(1,kflip,5) * multFrc<a name='1230'>
             <a name='1231'>
             do l = param_first_scalar, num_chem<a name='1232'>
                l2 = lptr_chem_to_q(l)<a name='1233'>
                if ((l2 &gt;= 1) .and. (l2 &lt;= pcnst)) then<a name='1234'>
                   chem(iw,kw,jw,l) = state_q(1,kflip,l2)/factconv_chem_to_q(l)<a name='1235'>
                end if<a name='1236'>
             end do <font color=#447700>! l<a name='1237'></font>
          end do<a name='1238'>
<a name='1239'>
<a name='1240'>
<a name='1241'>
     enddo<a name='1242'>
  enddo<a name='1243'>
end subroutine zm_conv_tend_2<a name='1244'>
#endif<a name='1245'>
END MODULE module_cu_camzm_driver<a name='1246'>
</pre></body></html>