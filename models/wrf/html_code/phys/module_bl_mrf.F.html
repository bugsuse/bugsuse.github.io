<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_BL_MRF'><A href='../../html_code/phys/module_bl_mrf.F.html#MODULE_BL_MRF' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_bl_mrf</font> <A href='../../call_to/MODULE_BL_MRF.html' TARGET='index'>2</A><a name='5'>
<a name='6'>
CONTAINS<a name='7'>
<a name='8'>
<font color=#447700>!-------------------------------------------------------------------          <a name='9'></font>
<A NAME='MRF'><A href='../../html_code/phys/module_bl_mrf.F.html#MRF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>MRF</font>(U3D,V3D,TH3D,T3D,QV3D,QC3D,P3D,PI3D,             &amp; <A href='../../call_to/MRF.html' TARGET='index'>1</A>,<A href='../../call_from/MRF.html' TARGET='index'>1</A><a name='11'>
                  RUBLTEN,RVBLTEN,RTHBLTEN,                        &amp;<a name='12'>
                  RQVBLTEN,RQCBLTEN,                               &amp;<a name='13'>
                  CP,G,ROVCP,R,ROVG,                               &amp;<a name='14'>
                  dz8w,z,XLV,RV,PSFC,                              &amp;<a name='15'>
                  p1000mb,                                         &amp;<a name='16'>
                  ZNT,UST,ZOL,HOL,PBL,PSIM,PSIH,                   &amp;<a name='17'>
                  XLAND,HFX,QFX,TSK,GZ1OZ0,WSPD,BR,                &amp;<a name='18'>
                  DT,DTMIN,KPBL2D,                                 &amp;<a name='19'>
                  SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,EOMEG,STBOLT,&amp;<a name='20'>
                  flag_qi,                                         &amp;<a name='21'>
                  ids,ide, jds,jde, kds,kde,                       &amp;<a name='22'>
                  ims,ime, jms,jme, kms,kme,                       &amp;<a name='23'>
                  its,ite, jts,jte, kts,kte,                       &amp;<a name='24'>
               <font color=#447700>! Optional<a name='25'></font>
                  QI3D,RQIBLTEN,                                   &amp; <a name='26'>
                  regime                                           )<a name='27'>
<font color=#447700>!-------------------------------------------------------------------<a name='28'></font>
      IMPLICIT NONE<a name='29'>
<font color=#447700>!-------------------------------------------------------------------<a name='30'></font>
<font color=#447700>!-- U3D         3D u-velocity interpolated to theta points (m/s)<a name='31'></font>
<font color=#447700>!-- V3D         3D v-velocity interpolated to theta points (m/s)<a name='32'></font>
<font color=#447700>!-- TH3D        3D potential temperature (K)<a name='33'></font>
<font color=#447700>!-- T3D         temperature (K)<a name='34'></font>
<font color=#447700>!-- QV3D        3D water vapor mixing ratio (Kg/Kg)<a name='35'></font>
<font color=#447700>!-- QC3D        3D cloud mixing ratio (Kg/Kg)<a name='36'></font>
<font color=#447700>!-- QI3D        3D ice mixing ratio (Kg/Kg)<a name='37'></font>
<font color=#447700>!-- P3D         3D pressure (Pa)<a name='38'></font>
<font color=#447700>!-- PI3D        3D exner function (dimensionless)<a name='39'></font>
<font color=#447700>!-- rr3D        3D dry air density (kg/m^3)<a name='40'></font>
<font color=#447700>!-- RUBLTEN     U tendency due to<a name='41'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='42'></font>
<font color=#447700>!-- RVBLTEN     V tendency due to<a name='43'></font>
<font color=#447700>!               PBL parameterization (m/s^2)<a name='44'></font>
<font color=#447700>!-- RTHBLTEN    Theta tendency due to<a name='45'></font>
<font color=#447700>!               PBL parameterization (K/s)<a name='46'></font>
<font color=#447700>!-- RQVBLTEN    Qv tendency due to<a name='47'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='48'></font>
<font color=#447700>!-- RQCBLTEN    Qc tendency due to<a name='49'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='50'></font>
<font color=#447700>!-- RQIBLTEN    Qi tendency due to<a name='51'></font>
<font color=#447700>!               PBL parameterization (kg/kg/s)<a name='52'></font>
<font color=#447700>!-- CP          heat capacity at constant pressure for dry air (J/kg/K)<a name='53'></font>
<font color=#447700>!-- G           acceleration due to gravity (m/s^2)<a name='54'></font>
<font color=#447700>!-- ROVCP       R/CP<a name='55'></font>
<font color=#447700>!-- R           gas constant for dry air (J/kg/K)<a name='56'></font>
<font color=#447700>!-- ROVG        R/G<a name='57'></font>
<font color=#447700>!-- dz8w        dz between full levels (m)<a name='58'></font>
<font color=#447700>!-- z           height above sea level (m)<a name='59'></font>
<font color=#447700>!-- XLV         latent heat of vaporization (J/kg)<a name='60'></font>
<font color=#447700>!-- RV          gas constant for water vapor (J/kg/K)<a name='61'></font>
<font color=#447700>!-- PSFC        pressure at the surface (Pa)<a name='62'></font>
<font color=#447700>!-- ZNT         roughness length (m)<a name='63'></font>
<font color=#447700>!-- UST         u* in similarity theory (m/s)<a name='64'></font>
<font color=#447700>!-- ZOL         z/L height over Monin-Obukhov length<a name='65'></font>
<font color=#447700>!-- HOL         PBL height over Monin-Obukhov length<a name='66'></font>
<font color=#447700>!-- PBL         PBL height (m)<a name='67'></font>
<font color=#447700>!-- REGIME      flag indicating PBL regime (stable, unstable, etc.)<a name='68'></font>
<font color=#447700>!-- PSIM        similarity stability function for momentum<a name='69'></font>
<font color=#447700>!-- PSIH        similarity stability function for heat<a name='70'></font>
<font color=#447700>!-- XLAND       land mask (1 for land, 2 for water)<a name='71'></font>
<font color=#447700>!-- HFX         upward heat flux at the surface (W/m^2)<a name='72'></font>
<font color=#447700>!-- QFX         upward moisture flux at the surface (kg/m^2/s)<a name='73'></font>
<font color=#447700>!-- TSK         surface temperature (K)<a name='74'></font>
<font color=#447700>!-- GZ1OZ0      log(z/z0) where z0 is roughness length<a name='75'></font>
<font color=#447700>!-- WSPD        wind speed at lowest model level (m/s)<a name='76'></font>
<font color=#447700>!-- BR          bulk Richardson number in surface layer<a name='77'></font>
<font color=#447700>!-- DT          time step (s)<a name='78'></font>
<font color=#447700>!-- DTMIN       time step (minute)<a name='79'></font>
<font color=#447700>!-- rvovrd      R_v divided by R_d (dimensionless)<a name='80'></font>
<font color=#447700>!-- SVP1        constant for saturation vapor pressure (kPa)<a name='81'></font>
<font color=#447700>!-- SVP2        constant for saturation vapor pressure (dimensionless)<a name='82'></font>
<font color=#447700>!-- SVP3        constant for saturation vapor pressure (K)<a name='83'></font>
<font color=#447700>!-- SVPT0       constant for saturation vapor pressure (K)<a name='84'></font>
<font color=#447700>!-- EP1         constant for virtual temperature (R_v/R_d - 1) (dimensionless)<a name='85'></font>
<font color=#447700>!-- EP2         constant for specific humidity calculation<a name='86'></font>
<font color=#447700>!-- KARMAN      Von Karman constant<a name='87'></font>
<font color=#447700>!-- EOMEG       angular velocity of earth's rotation (rad/s)<a name='88'></font>
<font color=#447700>!-- STBOLT      Stefan-Boltzmann constant (W/m^2/K^4)<a name='89'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='90'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='91'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='92'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='93'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='94'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='95'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='96'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='97'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='98'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='99'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='100'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='101'></font>
<font color=#447700>!-- its         start index for i in tile<a name='102'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='103'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='104'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='105'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='106'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='107'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='108'></font>
<a name='109'>
      INTEGER,  INTENT(IN   )   ::      ids,ide, jds,jde, kds,kde, &amp;<a name='110'>
                                        ims,ime, jms,jme, kms,kme, &amp;<a name='111'>
                                        its,ite, jts,jte, kts,kte<a name='112'>
<a name='113'>
<font color=#447700>!<a name='114'></font>
      REAL,     INTENT(IN   )   ::      P1000mb<a name='115'>
      REAL,     INTENT(IN   )   ::      DT,DTMIN,CP,G,ROVCP,       &amp;<a name='116'>
                                        ROVG,R,XLV,RV             <a name='117'>
<a name='118'>
      REAL,     INTENT(IN )     ::     SVP1,SVP2,SVP3,SVPT0 <a name='119'>
      REAL,     INTENT(IN )     ::     EP1,EP2,KARMAN,EOMEG,STBOLT<a name='120'>
<a name='121'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='122'>
                INTENT(IN   )   ::                           QV3D, &amp;<a name='123'>
                                                             QC3D, &amp;<a name='124'>
                                                              P3D, &amp;<a name='125'>
                                                             PI3D, &amp;<a name='126'>
                                                             TH3D, &amp;<a name='127'>
                                                              T3D, &amp;<a name='128'>
                                                             dz8w, &amp;<a name='129'>
                                                                z   <a name='130'>
<font color=#447700>!<a name='131'></font>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='132'>
                INTENT(INOUT)   ::                        RUBLTEN, &amp;<a name='133'>
                                                          RVBLTEN, &amp;<a name='134'>
                                                         RTHBLTEN, &amp;<a name='135'>
                                                         RQVBLTEN, &amp;<a name='136'>
                                                         RQCBLTEN<a name='137'>
<a name='138'>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='139'>
                INTENT(IN   )   ::                          XLAND, &amp;<a name='140'>
                                                              HFX, &amp;<a name='141'>
                                                              QFX<a name='142'>
 <a name='143'>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='144'>
                INTENT(INOUT)   ::                            HOL, &amp;<a name='145'>
                                                              UST, &amp;<a name='146'>
                                                              PBL, &amp;<a name='147'>
                                                              ZNT<a name='148'>
<a name='149'>
      LOGICAL,  INTENT(IN)      ::                        FLAG_QI<a name='150'>
<font color=#447700>!<a name='151'></font>
<font color=#447700>!m The following 5 variables are changed to memory size from tile size--<a name='152'></font>
<font color=#447700>!<a name='153'></font>
     REAL,     DIMENSION( ims:ime, jms:jme ), INTENT(IN   )  ::    &amp;<a name='154'>
                                                             PSIM, &amp;<a name='155'>
                                                             PSIH<a name='156'>
<a name='157'>
     REAL,     DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)   ::   &amp;<a name='158'>
                                                             WSPD<a name='159'>
<a name='160'>
     REAL,     DIMENSION( ims:ime, jms:jme ), INTENT(IN   )   ::   &amp;<a name='161'>
                                                           GZ1OZ0, &amp;<a name='162'>
                                                               BR<a name='163'>
<a name='164'>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='165'>
                INTENT(IN   )               ::               PSFC<a name='166'>
<a name='167'>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='168'>
                INTENT(IN   )   ::                            TSK<a name='169'>
<a name='170'>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='171'>
                INTENT(INOUT)   ::                            ZOL<a name='172'>
                                                                      <a name='173'>
      INTEGER,  DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='174'>
                INTENT(OUT  )   ::                         KPBL2D <a name='175'>
<a name='176'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='177'>
                INTENT(IN   )   ::                            U3D, &amp;<a name='178'>
                                                              V3D<a name='179'>
<font color=#447700>!<a name='180'></font>
<font color=#447700>! Optional<a name='181'></font>
<font color=#447700>!<a name='182'></font>
      REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='183'>
                OPTIONAL                                         , &amp;<a name='184'>
                INTENT(INOUT)   ::                         REGIME<a name='185'>
<a name='186'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='187'>
                INTENT(INOUT)   ::                       RQIBLTEN<a name='188'>
<a name='189'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='190'>
                OPTIONAL                                         , &amp;<a name='191'>
                INTENT(IN   )   ::                           QI3D<a name='192'>
<a name='193'>
<font color=#447700>! LOCAL VARS<a name='194'></font>
   REAL,       DIMENSION( its:ite, kts:kte )          ::   dz8w2d, &amp; <a name='195'>
                                                              z2d<a name='196'>
                                                           <a name='197'>
<a name='198'>
   INTEGER ::  I,J,K,NK<a name='199'>
<a name='200'>
<font color=#447700>!<a name='201'></font>
   DO J=jts,jte<a name='202'>
      DO k=kts,kte<a name='203'>
      NK=kme-k<a name='204'>
      DO i=its,ite<a name='205'>
         dz8w2d(I,K) = dz8w(i,NK,j)<a name='206'>
         z2d(I,K) = z(i,NK,j)<a name='207'>
      ENDDO<a name='208'>
      ENDDO<a name='209'>
<a name='210'>
<a name='211'>
      CALL <A href='../../html_code/phys/module_bl_mrf.F.html#MRF2D'>MRF2D</A><A href='../../html_code/phys/module_bl_mrf.F.html#MRF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MRF2D_1">(J,U3D(ims,kms,j),V3D(ims,kms,j),T3D(ims,kms,j),    &amp;<a name='212'>
               QV3D(ims,kms,j),QC3D(ims,kms,j),                     &amp;<a name='213'>
               P3D(ims,kms,j),RUBLTEN(ims,kms,j),RVBLTEN(ims,kms,j),&amp;<a name='214'>
               RTHBLTEN(ims,kms,j),RQVBLTEN(ims,kms,j),             &amp;<a name='215'>
               RQCBLTEN(ims,kms,j),                                 &amp;<a name='216'>
               p1000mb,                                             &amp;<a name='217'>
               CP,G,ROVCP,R,ROVG,                                   &amp;<a name='218'>
               dz8w2d,z2d,XLV,Rv,                                   &amp;<a name='219'>
               PSFC(ims,j),ZNT(ims,j),                              &amp;<a name='220'>
               UST(ims,j),ZOL(ims,j),                               &amp;<a name='221'>
               HOL(ims,j),PBL(ims,j),PSIM(ims,j),                   &amp;<a name='222'>
               PSIH(ims,j),XLAND(ims,j),HFX(ims,j),QFX(ims,j),      &amp;<a name='223'>
               TSK(ims,j),GZ1OZ0(ims,j),WSPD(ims,j),BR(ims,j),      &amp;<a name='224'>
               DT,DTMIN,KPBL2D(ims,j),                              &amp;<a name='225'>
               SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,EOMEG,STBOLT,    &amp;<a name='226'>
               flag_qi,                                             &amp;<a name='227'>
               ids,ide, jds,jde, kds,kde,                           &amp;<a name='228'>
               ims,ime, jms,jme, kms,kme,                           &amp;<a name='229'>
               its,ite, jts,jte, kts,kte,                           &amp;<a name='230'>
            <font color=#447700>!optional<a name='231'></font>
               QI2DTEN=RQIBLTEN(ims,kms,j),                         &amp;<a name='232'>
               REGIME=REGIME(ims,j),QI2D=QI3D(ims,kms,j)            )<a name='233'>
<a name='234'>
<a name='235'>
      DO k=kts,kte<a name='236'>
      DO i=its,ite<a name='237'>
         RTHBLTEN(I,K,J)=RTHBLTEN(I,K,J)/PI3D(I,K,J)<a name='238'>
      ENDDO<a name='239'>
      ENDDO<a name='240'>
<a name='241'>
    ENDDO<a name='242'>
<a name='243'>
   END SUBROUTINE MRF<a name='244'>
<a name='245'>
<font color=#447700>!-------------------------------------------------------------------          <a name='246'></font>
<A NAME='MRF2D'><A href='../../html_code/phys/module_bl_mrf.F.html#MRF2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='247'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>MRF2D</font>(J,U2D,V2D,T2D,QV2D,QC2D,     P2D,              &amp; <A href='../../call_to/MRF2D.html' TARGET='index'>1</A>,<A href='../../call_from/MRF2D.html' TARGET='index'>3</A><a name='248'>
                  U2DTEN,V2DTEN,T2DTEN,                            &amp;<a name='249'>
                  QV2DTEN,QC2DTEN,                                 &amp; <a name='250'>
                  p1000mb,                                         &amp;<a name='251'>
                  CP,G,ROVCP,R,ROVG,                               &amp;<a name='252'>
                  dz8w2d,z2d,XLV,RV,PSFCPA,                        &amp;<a name='253'>
                  ZNT,UST,ZOL,HOL,PBL,PSIM,PSIH,                   &amp;<a name='254'>
                  XLAND,HFX,QFX,TSK,GZ1OZ0,WSPD,BR,                &amp;<a name='255'>
                  DT,DTMIN,KPBL1D,                                 &amp;<a name='256'>
                  SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,EOMEG,STBOLT,&amp;<a name='257'>
                  flag_qi,                                         &amp;<a name='258'>
                  ids,ide, jds,jde, kds,kde,                       &amp;<a name='259'>
                  ims,ime, jms,jme, kms,kme,                       &amp;<a name='260'>
                  its,ite, jts,jte, kts,kte,                       &amp;<a name='261'>
               <font color=#447700>! optional<a name='262'></font>
                  regime, qi2d, QI2DTEN                            )<a name='263'>
<font color=#447700>!-------------------------------------------------------------------<a name='264'></font>
      IMPLICIT NONE<a name='265'>
<font color=#447700>!-------------------------------------------------------------------<a name='266'></font>
<font color=#447700>!     BASED ON THE "COUNTERGRADIENT" TRANSPORT TERM OF TROEN                     <a name='267'></font>
<font color=#447700>!     AND MAHRT (1986) FOR THE UNSTABLE PBL.                                     <a name='268'></font>
<font color=#447700>!     THIS ROUTINE USES AN IMPLICIT APPROACH FOR VERTICAL FLUX                   <a name='269'></font>
<font color=#447700>!     DIVERGENCE AND DOES NOT REQUIRE "MITER" TIMESTEPS.                         <a name='270'></font>
<font color=#447700>!     IT INCLUDES VERTICAL DIFFUSION IN THE STABLE ATMOSPHERE                    <a name='271'></font>
<font color=#447700>!     AND MOIST VERTICAL DIFFUSION IN CLOUDS.                                    <a name='272'></font>
<font color=#447700>!     SURFACE FLUXES CALCULATED AS IN HIRPBL.                                    <a name='273'></font>
<font color=#447700>!     5-LAYER SOIL MODEL OPTION REQUIRED IN SLAB DUE TO LONG TIMESTEP            <a name='274'></font>
<font color=#447700>!                                                                                <a name='275'></font>
<font color=#447700>!     CODED BY SONG-YOU HONG (NCEP), IMPLEMENTED BY JIMY DUDHIA (NCAR)           <a name='276'></font>
<font color=#447700>!     FALL 1996                                                                  <a name='277'></font>
<font color=#447700>!                                                                                <a name='278'></font>
<font color=#447700>!     REFERENCES:                                                                <a name='279'></font>
<font color=#447700>!                                                                                <a name='280'></font>
<font color=#447700>!        HONG AND PAN (1996), MON. WEA. REV.                                     <a name='281'></font>
<font color=#447700>!        TROEN AND MAHRT (1986), BOUNDARY LAYER MET.                             <a name='282'></font>
<font color=#447700>!                                                                                <a name='283'></font>
<font color=#447700>!     CHANGES:                                                                   <a name='284'></font>
<font color=#447700>!        INCREASE RLAM FROM 30 TO 150, AND CHANGE FREE ATMOSPHERE                <a name='285'></font>
<font color=#447700>!        STABILITY FUNCTION TO INCREASE VERTICAL DIFFUSION                       <a name='286'></font>
<font color=#447700>!        (HONG, JUNE 1997)                                                       <a name='287'></font>
<font color=#447700>!                                                                                <a name='288'></font>
<font color=#447700>!        PUT LOWER LIMIT ON PSI FOR STABLE CONDITIONS. THIS WILL                 <a name='289'></font>
<font color=#447700>!        PREVENT FLUXES FROM BECOMING TOO SMALL (DUDHIA, OCTOBER 1997)           <a name='290'></font>
<font color=#447700>!                                                                                <a name='291'></font>
<font color=#447700>!        CORRECTION TO REGIME CALCULATION. THIS WILL ALLOW POINTS IN             <a name='292'></font>
<font color=#447700>!        REGIME 4 MUCH MORE FREQUENTLY GIVING LARGER SURFACE FLUXES              <a name='293'></font>
<font color=#447700>!        REGIME 3 NO LONGER USES HOL &lt; 1.5 OR THVX LAPSE-RATE CHECK              <a name='294'></font>
<font color=#447700>!        IN MRF SCHEME. THIS WILL MAKE REGIME 3 MUCH LESS FREQUENT.              <a name='295'></font>
<font color=#447700>!                                                                                <a name='296'></font>
<font color=#447700>!        ADD SURFACE PRESSURE, PS(I), ARRAY FOR EFFICIENCY                       <a name='297'></font>
<font color=#447700>!                                                                                <a name='298'></font>
<font color=#447700>!        FIX FOR PROBLEM WITH THIN LAYERS AND HIGH ROUGHNESS                     <a name='299'></font>
<font color=#447700>!                                                                                <a name='300'></font>
<font color=#447700>!        CHARNOCK CONSTANT NOW COMES FROM NAMELIST (DEFAULT SAME)                <a name='301'></font>
<font color=#447700>!                                                                                <a name='302'></font>
<font color=#447700>!-------------------------------------------------------------------          <a name='303'></font>
<a name='304'>
      REAL      RLAM,PRMIN,PRMAX,XKZMIN,XKZMAX,RIMIN,BRCR,         &amp;<a name='305'>
                CFAC,PFAC,SFCFRAC,CKZ,ZFMIN,APHI5,APHI16,GAMCRT,   &amp;<a name='306'>
                GAMCRQ,XKA,PRT<a name='307'>
<a name='308'>
      PARAMETER (RLAM=150.,PRMIN=0.5,PRMAX=4.)                       <a name='309'>
      PARAMETER (XKZMIN=0.01,XKZMAX=1000.,RIMIN=-100.)                           <a name='310'>
      PARAMETER (BRCR=0.5,CFAC=7.8,PFAC=2.0,SFCFRAC=0.1)                         <a name='311'>
      PARAMETER (CKZ=0.001,ZFMIN=1.E-8,APHI5=5.,APHI16=16.)                      <a name='312'>
      PARAMETER (GAMCRT=3.,GAMCRQ=2.E-3)                                         <a name='313'>
      PARAMETER (XKA=2.4E-5)                                                     <a name='314'>
      PARAMETER (PRT=1.)                                                         <a name='315'>
<font color=#447700>!<a name='316'></font>
      INTEGER,  INTENT(IN   )   ::      ids,ide, jds,jde, kds,kde, &amp;<a name='317'>
                                        ims,ime, jms,jme, kms,kme, &amp;<a name='318'>
                                        its,ite, jts,jte, kts,kte, &amp;<a name='319'>
                                        J<a name='320'>
<font color=#447700>!<a name='321'></font>
      LOGICAL,  INTENT(IN)      ::                        FLAG_QI<a name='322'>
<font color=#447700>!<a name='323'></font>
      REAL,     INTENT(IN   )   ::      P1000mb<a name='324'>
      REAL,     INTENT(IN   )   ::      DT,DTMIN,CP,G,ROVCP,       &amp;<a name='325'>
                                        ROVG,R,XLV,RV<a name='326'>
<a name='327'>
      REAL,     INTENT(IN )     ::     SVP1,SVP2,SVP3,SVPT0 <a name='328'>
      REAL,     INTENT(IN )     ::     EP1,EP2,KARMAN,EOMEG,STBOLT<a name='329'>
<a name='330'>
      REAL,     DIMENSION( ims:ime, kms:kme )                    , &amp;<a name='331'>
                INTENT(IN   )   ::                           QV2D, &amp;<a name='332'>
                                                             QC2D, &amp;<a name='333'>
                                                              P2D, &amp;<a name='334'>
                                                              T2D<a name='335'>
<font color=#447700>!<a name='336'></font>
      REAL,     DIMENSION( ims:ime, kms:kme )                    , &amp;<a name='337'>
                INTENT(INOUT)   ::                         U2DTEN, &amp;<a name='338'>
                                                           V2DTEN, &amp;<a name='339'>
                                                           T2DTEN, &amp;<a name='340'>
                                                          QV2DTEN, &amp;<a name='341'>
                                                          QC2DTEN<a name='342'>
                                                                  <a name='343'>
      REAL,     DIMENSION( ims:ime )                             , &amp;<a name='344'>
                INTENT(INOUT)   ::                            HOL, &amp;<a name='345'>
                                                              UST, &amp;<a name='346'>
                                                              PBL, &amp;<a name='347'>
                                                              ZNT<a name='348'>
<a name='349'>
      REAL,     DIMENSION( ims:ime )                             , &amp;<a name='350'>
                INTENT(IN   )   ::                          XLAND, &amp;<a name='351'>
                                                              HFX, &amp;<a name='352'>
                                                              QFX<a name='353'>
<font color=#447700>!<a name='354'></font>
<font color=#447700>!m The following 5 are changed to memory size---<a name='355'></font>
<font color=#447700>!<a name='356'></font>
     REAL,     DIMENSION( ims:ime ), INTENT(IN   )   ::      PSIM, &amp;<a name='357'>
                                                             PSIH<a name='358'>
<a name='359'>
     REAL,     DIMENSION( ims:ime ), INTENT(INOUT)   ::      WSPD<a name='360'>
<a name='361'>
     REAL,     DIMENSION( ims:ime ), INTENT(IN   )   ::    GZ1OZ0, &amp;<a name='362'>
                                                               BR<a name='363'>
<a name='364'>
      REAL,     DIMENSION( ims:ime )                             , &amp;<a name='365'>
                INTENT(IN   )               ::             PSFCPA<a name='366'>
<a name='367'>
      REAL,     DIMENSION( ims:ime )                             , &amp;<a name='368'>
                INTENT(IN   )   ::                            TSK<a name='369'>
<a name='370'>
      REAL,     DIMENSION( ims:ime )                             , &amp;<a name='371'>
                INTENT(INOUT)   ::                            ZOL<a name='372'>
<a name='373'>
      INTEGER,  DIMENSION( ims:ime )                             , &amp;<a name='374'>
                INTENT(OUT  )   ::                         KPBL1D<a name='375'>
<a name='376'>
      REAL,     DIMENSION( ims:ime, kms:kme )                    , &amp;<a name='377'>
                INTENT(IN   )   ::                            U2D, &amp;<a name='378'>
                                                              V2D<a name='379'>
                                                                      <a name='380'>
<font color=#447700>! MODULE-LOCAL VARIABLES (DEFINED IN SUBROUTINE MRF)<a name='381'></font>
<font color=#447700>!<a name='382'></font>
      REAL,     DIMENSION( its:ite, kts:kte ) ,                    &amp;<a name='383'>
                INTENT(IN)      ::                         dz8w2d, &amp;<a name='384'>
                                                              z2d<a name='385'>
<font color=#447700>!                                                                                <a name='386'></font>
<font color=#447700>! <a name='387'></font>
<font color=#447700>! Optional<a name='388'></font>
<font color=#447700>!<a name='389'></font>
      REAL,     DIMENSION( ims:ime )                             , &amp;<a name='390'>
                OPTIONAL                                         , &amp;<a name='391'>
                INTENT(INOUT)   ::                         REGIME<a name='392'>
<a name='393'>
      REAL,     DIMENSION( ims:ime, kms:kme )                    , &amp;<a name='394'>
                OPTIONAL                                         , &amp;<a name='395'>
                INTENT(IN   )   ::                           QI2D<a name='396'>
<a name='397'>
      REAL,     DIMENSION( ims:ime, kms:kme )                    , &amp;<a name='398'>
                OPTIONAL                                         , &amp;<a name='399'>
                INTENT(INOUT)   ::                        QI2DTEN<a name='400'>
    <a name='401'>
<font color=#447700>! LOCAL VARS<a name='402'></font>
<a name='403'>
      REAL,     DIMENSION( its:ite, kts:kte+1 ) ::             ZQ<a name='404'>
<a name='405'>
      REAL,     DIMENSION( its:ite, kts:kte )   ::                 &amp;<a name='406'>
                                                         UX,VX,QX, &amp;<a name='407'>
                                                     QCX,THX,THVX, &amp; <a name='408'>
                                                          DZQ,DZA, &amp; <a name='409'>
                                                        TTNP,QTNP, &amp;<a name='410'>
                                                         QCTNP,ZA, &amp;<a name='411'>
                                                          UXS,VXS, &amp;<a name='412'>
                                                         THXS,QXS, &amp;<a name='413'>
                                                         QCXS,QIX, &amp;<a name='414'>
                                                       QITNP,QIXS, &amp;<a name='415'>
                                                        UTNP,VTNP<a name='416'>
<font color=#447700>!<a name='417'></font>
      REAL,    DIMENSION( its:ite )             ::     QIXSV,RHOX, &amp;<a name='418'>
                                                     WSPD1,GOVRTH, &amp; <a name='419'>
                                                       PBL0,THXSV, &amp;<a name='420'>
                                                        UXSV,VXSV, &amp;             <a name='421'>
                                                       QXSV,QCXSV, &amp; <a name='422'>
                                                     QGH,TGDSA,PS<a name='423'>
<a name='424'>
      INTEGER                                   ::   ILXM,JLXM,KL, &amp;<a name='425'>
                                                   KLM,KLP1,KLPBL<a name='426'>
<font color=#447700>!<a name='427'></font>
      INTEGER, DIMENSION( its:ite )             ::     KPBL,KPBL0<a name='428'>
<font color=#447700>!<a name='429'></font>
      REAL,    DIMENSION( its:ite, kts:kte )    ::      SCR3,SCR4<a name='430'>
<font color=#447700>!<a name='431'></font>
      REAL,    DIMENSION( its:ite )             ::           DUM1, &amp;<a name='432'>
                                                           XKZMKL<a name='433'>
<font color=#447700>!<a name='434'></font>
      REAL,    DIMENSION( its:ite )             ::    ZL1,THERMAL, &amp;<a name='435'>
                                                     WSCALE,HGAMT, &amp;<a name='436'>
                                                       HGAMQ,BRDN, &amp;<a name='437'>
                                                        BRUP,PHIM, &amp;<a name='438'>
                                                         PHIH,CPM, &amp;<a name='439'>
                                                      DUSFC,DVSFC, &amp;<a name='440'>
                                                      DTSFC,DQSFC<a name='441'>
                <a name='442'>
<font color=#447700>!<a name='443'></font>
      REAL,    DIMENSION( its:ite, kts:kte )    ::      XKZM,XKZH, &amp;<a name='444'>
                                                            A1,A2, &amp;  <a name='445'>
                                                            AD,AU, &amp;<a name='446'>
                                                               TX<a name='447'>
<font color=#447700>!<a name='448'></font>
      REAL,    DIMENSION( its:ite, kts:kte )  ::               AL<a name='449'>
<font color=#447700>!<a name='450'></font>
      LOGICAL, DIMENSION( its:ite )             ::         PBLFLG, &amp;<a name='451'>
                                                           SFCFLG, &amp;<a name='452'>
                                                           STABLE<a name='453'>
<font color=#447700>!                                                         <a name='454'></font>
      REAL, DIMENSION( its:ite )                ::           THGB<a name='455'>
<a name='456'>
      INTEGER ::  N,I,K,KK,L,NZOL,IMVDIF<a name='457'>
<a name='458'>
      INTEGER ::  JBGN,JEND,IBGN,IEND,NK<a name='459'>
<a name='460'>
      REAL    ::  ZOLN,X,Y,CONT,CONQ,CONW,PL,THCON,TVCON,E1,DTSTEP<a name='461'>
      REAL    ::  ZL,TSKV,DTHVDZ,DTHVM,VCONV,RZOL<a name='462'>
      REAL    ::  DTTHX,PSIX,DTG,PSIQ,USTM<a name='463'>
      REAL    ::  DT4,RDT,SPDK2,FM,FH,HOL1,GAMFAC,VPERT,PRNUM<a name='464'>
      REAL    ::  ZFAC,XKZO,SS,RI,QMEAN,TMEAN,ALPH,CHI,ZK,RL2,DK,SRI<a name='465'>
      REAL    ::  BRINT,DTODSD,DSIG,RDZ,DSDZT,DSDZQ,DSDZ2,TTEND,QTEND<a name='466'>
      REAL    ::  UTEND,VTEND,QCTEND,QITEND,TGC,DTODSU<a name='467'>
<a name='468'>
<font color=#447700>!----------------------------------------------------------------------<a name='469'></font>
<a name='470'>
      KLPBL=1<a name='471'>
      KL=kte<a name='472'>
      ILXM=ite-1<a name='473'>
      JLXM=jte-1<a name='474'>
      KLM=kte-1<a name='475'>
      KLP1=kte+1<a name='476'>
<font color=#447700>!                                                                                <a name='477'></font>
      CONT=1000.*CP/G                                                            <a name='478'>
      CONQ=1000.*XLV/G                                                           <a name='479'>
      CONW=1000./G                                                               <a name='480'>
<a name='481'>
<font color=#447700>!-- IMVDIF      imvdif=1 for moist adiabat vertical diffusion<a name='482'></font>
<a name='483'>
      IMVDIF=1<a name='484'>
<a name='485'>
<font color=#447700>!     DO i=its,ite<a name='486'></font>
<font color=#447700>!!PS PSFC cmb<a name='487'></font>
<font color=#447700>!        PSFC(I)=PSFCPA(I)/1000.<a name='488'></font>
<font color=#447700>!     ENDDO<a name='489'></font>
<a name='490'>
<a name='491'>
<font color=#447700>!                                                                                <a name='492'></font>
<font color=#447700>!----CONVERT GROUND TEMPERATURE TO POTENTIAL TEMPERATURE:                        <a name='493'></font>
<font color=#447700>!                                                                                <a name='494'></font>
      DO 5 I=its,ite                                                       <a name='495'>
        TGDSA(I)=TSK(I)                                                        <a name='496'>
<font color=#447700>! PS PSFC cmb<a name='497'></font>
        PS(I)=PSFCPA(I)/1000.<a name='498'>
<font color=#447700>!        THGB(I)=TSK(I)*(100./PS(I))**ROVCP   <a name='499'></font>
        THGB(I)=TSK(I)*(P1000mb/PSFCPA(I))**ROVCP   <a name='500'>
    5 CONTINUE                                                                   <a name='501'>
<font color=#447700>!                                                                                <a name='502'></font>
<font color=#447700>!-----DECOUPLE FLUX-FORM VARIABLES TO GIVE U,V,T,THETA,THETA-VIR.,               <a name='503'></font>
<font color=#447700>!     T-VIR., QV, AND QC AT CROSS POINTS AND AT KTAU-1.                          <a name='504'></font>
<font color=#447700>!                                                                                <a name='505'></font>
<font color=#447700>!     *** NOTE ***                                                               <a name='506'></font>
<font color=#447700>!         THE BOUNDARY WINDS MAY NOT BE ADEQUATELY AFFECTED BY FRICTION,         <a name='507'></font>
<font color=#447700>!         SO USE ONLY INTERIOR VALUES OF UX AND VX TO CALCULATE                  <a name='508'></font>
<font color=#447700>!         TENDENCIES.                                                            <a name='509'></font>
<font color=#447700>!                                                                                <a name='510'></font>
      DO 24 K=kts,kte                                                      <a name='511'>
        NK=kme-K<a name='512'>
        DO 24 I=its,ite<a name='513'>
          UX(I,K)=U2D(I,NK)<a name='514'>
          VX(I,K)=V2D(I,NK)<a name='515'>
   24 CONTINUE                                                                 <a name='516'>
<font color=#447700>!                                                                                <a name='517'></font>
<font color=#447700>!.....SCR3(I,K) STORE TEMPERATURE,                                               <a name='518'></font>
<font color=#447700>!     SCR4(I,K) STORE VIRTUAL TEMPERATURE.                                       <a name='519'></font>
<font color=#447700>!                                                                                <a name='520'></font>
      DO 30 K=kts,kte<a name='521'>
        NK=kme-K<a name='522'>
        DO 30 I=its,ite<a name='523'>
<font color=#447700>! PL cmb<a name='524'></font>
          PL=P2D(I,NK)/1000.<a name='525'>
          SCR3(I,K)=T2D(I,NK)<a name='526'>
<font color=#447700>!          THCON=(100./PL)**ROVCP                                                 <a name='527'></font>
          THCON=(P1000mb/(PL*1000.))**ROVCP                                                 <a name='528'>
          THX(I,K)=SCR3(I,K)*THCON                                               <a name='529'>
          TX(I,K)=SCR3(I,K)                                                      <a name='530'>
          SCR4(I,K)=SCR3(I,K)                                                    <a name='531'>
          THVX(I,K)=THX(I,K)                                                     <a name='532'>
          QX(I,K)=0.                                                             <a name='533'>
   30 CONTINUE                                                                 <a name='534'>
<font color=#447700>!                                                                                <a name='535'></font>
      DO I=its,ite<a name='536'>
         QGH(i)=0.                                                                <a name='537'>
         CPM(i)=CP                                                                <a name='538'>
      ENDDO<a name='539'>
<font color=#447700>!                                                                                <a name='540'></font>
<font color=#447700>!     IF(IDRY.EQ.1)GOTO 80                                                   <a name='541'></font>
      DO 50 K=kts,kte<a name='542'>
        NK=kme-K<a name='543'>
        DO 50 I=its,ite<a name='544'>
          QX(I,K)=QV2D(I,NK)<a name='545'>
          TVCON=(1.+EP1*QX(I,K))                                      <a name='546'>
          THVX(I,K)=THX(I,K)*TVCON                                               <a name='547'>
          SCR4(I,K)=SCR3(I,K)*TVCON                                              <a name='548'>
   50 CONTINUE                                                                 <a name='549'>
<font color=#447700>!                                                                                <a name='550'></font>
      DO 60 I=its,ite<a name='551'>
        E1=SVP1*EXP(SVP2*(TGDSA(I)-SVPT0)/(TGDSA(I)-SVP3))                       <a name='552'>
        QGH(I)=EP2*E1/(PS(I)-E1)                                                 <a name='553'>
        CPM(I)=CP*(1.+0.8*QX(I,KL))                                   <a name='554'>
   60 CONTINUE                                                                   <a name='555'>
<font color=#447700>!                                                                                <a name='556'></font>
<font color=#447700>!     IF(IMOIST.EQ.1)GOTO 80<a name='557'></font>
      DO 70 K=kts,kte<a name='558'>
        NK=kme-K<a name='559'>
        DO 70 I=its,ite<a name='560'>
          QCX(I,K)=QC2D(I,NK)<a name='561'>
   70 CONTINUE<a name='562'>
<a name='563'>
      IF (flag_QI .AND. PRESENT( QI2D ) ) THEN<a name='564'>
         DO K=kts,kte<a name='565'>
            NK=kme-K<a name='566'>
            DO I=its,ite<a name='567'>
               QIX(I,K)=QI2D(I,NK)<a name='568'>
            ENDDO<a name='569'>
         ENDDO<a name='570'>
      ELSE<a name='571'>
         DO K=kts,kte<a name='572'>
            NK=kme-K<a name='573'>
            DO I=its,ite<a name='574'>
               QIX(I,K)=0.<a name='575'>
            ENDDO<a name='576'>
         ENDDO<a name='577'>
      ENDIF<a name='578'>
<a name='579'>
   80 CONTINUE<a name='580'>
<a name='581'>
<font color=#447700>!                                                                                <a name='582'></font>
<font color=#447700>!-----COMPUTE THE HEIGHT OF FULL- AND HALF-SIGMA LEVELS ABOVE GROUND             <a name='583'></font>
<font color=#447700>!     LEVEL, AND THE LAYER THICKNESSES.                                          <a name='584'></font>
<font color=#447700>!                                                                                <a name='585'></font>
      DO 90 I=its,ite<a name='586'>
        ZQ(I,KLP1)=0.                                                            <a name='587'>
        RHOX(I)=PS(I)*1000./(R*SCR4(I,KL))                                       <a name='588'>
   90 CONTINUE                                                                   <a name='589'>
<font color=#447700>!                                                                                <a name='590'></font>
      DO 110 KK=kts,kte<a name='591'>
        K=kme-KK<a name='592'>
        DO 100 I=its,ite                                                   <a name='593'>
          DUM1(I)=ZQ(I,K+1)                                                      <a name='594'>
  100   CONTINUE                                                                 <a name='595'>
<font color=#447700>!                                                                                <a name='596'></font>
        DO 110 I=its,ite                                                   <a name='597'>
           ZQ(I,K)=dz8w2d(I,K)+DUM1(I)<a name='598'>
  110   CONTINUE                                                                 <a name='599'>
<font color=#447700>!                                                                                <a name='600'></font>
      DO 120 K=kts,kte<a name='601'>
        DO 120 I=its,ite<a name='602'>
          ZA(I,K)=0.5*(ZQ(I,K)+ZQ(I,K+1))                                        <a name='603'>
          DZQ(I,K)=ZQ(I,K)-ZQ(I,K+1)                                             <a name='604'>
  120 CONTINUE                                                                 <a name='605'>
<font color=#447700>!                                                                                <a name='606'></font>
      DO 130 K=kts,kte-1<a name='607'>
        DO 130 I=its,ite<a name='608'>
          DZA(I,K)=ZA(I,K)-ZA(I,K+1)                                             <a name='609'>
  130 CONTINUE                                                                 <a name='610'>
               <a name='611'>
      DTSTEP=DT                                                                  <a name='612'>
<font color=#447700>!                                                                                <a name='613'></font>
      DO 160 I=its,ite<a name='614'>
        GOVRTH(I)=G/THX(I,KL)                                                    <a name='615'>
  160 CONTINUE                                                                   <a name='616'>
<font color=#447700>!                                                                                <a name='617'></font>
<font color=#447700>!-----INITIALIZE VERTICAL TENDENCIES AND                                         <a name='618'></font>
<font color=#447700>!                                                                                <a name='619'></font>
      DO I=its,ite<a name='620'>
      DO K=kts,kte<a name='621'>
         UTNP(i,k)=0.                                                           <a name='622'>
         VTNP(i,k)=0.                                                           <a name='623'>
         TTNP(i,k)=0.                                                           <a name='624'>
      ENDDO<a name='625'>
      ENDDO<a name='626'>
<font color=#447700>!                                                                                <a name='627'></font>
<font color=#447700>!     IF(IDRY.EQ.1)GOTO 250                                                  <a name='628'></font>
      DO 230 K=kts,kte<a name='629'>
        DO 230 I=its,ite<a name='630'>
          QTNP(I,K)=0.                                                           <a name='631'>
  230 CONTINUE                                                                 <a name='632'>
<font color=#447700>!                                                                                <a name='633'></font>
<font color=#447700>!     IF(IMOIST.EQ.1)GOTO 250                                                <a name='634'></font>
      DO 240 K=kts,kte<a name='635'>
        DO 240 I=its,ite<a name='636'>
          QCTNP(I,K)=0.                                                          <a name='637'>
          QITNP(I,K)=0.                                                          <a name='638'>
  240 CONTINUE                                                                 <a name='639'>
                                                                                 <a name='640'>
  250 CONTINUE                                                                   <a name='641'>
<font color=#447700>!                                                                                <a name='642'></font>
<font color=#447700>!-----CALCULATE BULK RICHARDSON NO. OF SURFACE LAYER, ACCORDING TO               <a name='643'></font>
<font color=#447700>!     AKB(1976), EQ(12).                                                         <a name='644'></font>
                                                                                 <a name='645'>
<font color=#447700>!     DO 260 I=its,ite<a name='646'></font>
<font color=#447700>!       GZ1OZ0(I)=ALOG(ZA(I,KL)/ZNT(I))                                        <a name='647'></font>
<font color=#447700>!       IF((XLAND(I)-1.5).GE.0)THEN                                            <a name='648'></font>
<font color=#447700>!         ZL=ZNT(I)                                                            <a name='649'></font>
<font color=#447700>!       ELSE                                                                     <a name='650'></font>
<font color=#447700>!         ZL=0.01                                                                <a name='651'></font>
<font color=#447700>!       ENDIF                                                                    <a name='652'></font>
<font color=#447700>!       WSPD(I)=SQRT(UX(I,KL)*UX(I,KL)+VX(I,KL)*VX(I,KL))                        <a name='653'></font>
<font color=#447700>!       TSKV=THGB(I)*(1.+EP1*QGH(I)*MAVAIL(I))                     <a name='654'></font>
<font color=#447700>!       DTHVDZ=(THVX(I,KL)-TSKV)                                                 <a name='655'></font>
<font color=#447700>!       IF(-DTHVDZ.GE.0)THEN                                                     <a name='656'></font>
<font color=#447700>!         DTHVM=-DTHVDZ                                                          <a name='657'></font>
<font color=#447700>!       ELSE                                                                     <a name='658'></font>
<font color=#447700>!         DTHVM=0.                                                               <a name='659'></font>
<font color=#447700>!       ENDIF                                                                    <a name='660'></font>
<font color=#447700>!       VCONV=VCONVC*SQRT(DTHVM)                                                 <a name='661'></font>
<font color=#447700>!       WSPD(I)=SQRT(WSPD(I)*WSPD(I)+VCONV*VCONV)                                <a name='662'></font>
<font color=#447700>!       WSPD(I)=AMAX1(WSPD(I),1.)                                                <a name='663'></font>
<font color=#447700>!       BR(I)=GOVRTH(I)*ZA(I,KL)*DTHVDZ/(WSPD(I)*WSPD(I))                        <a name='664'></font>
<font color=#447700>! 260 CONTINUE                                                                   <a name='665'></font>
                                                                                 <a name='666'>
<font color=#447700>!!-----DIAGNOSE BASIC PARAMETERS FOR THE APPROPRIATED STABILITY CLASS:            <a name='667'></font>
<font color=#447700>!!                                                                                <a name='668'></font>
<font color=#447700>!!     THE STABILITY CLASSES ARE DETERMINED BY BR (BULK RICHARDSON NO.)           <a name='669'></font>
<font color=#447700>!!     AND HOL (HEIGHT OF PBL/MONIN-OBUKHOV LENGTH).                              <a name='670'></font>
<font color=#447700>!!                                                                                <a name='671'></font>
<font color=#447700>!!     CRITERIA FOR THE CLASSES ARE AS FOLLOWS:                                   <a name='672'></font>
<font color=#447700>!!                                                                                <a name='673'></font>
<font color=#447700>!!        1. BR .GE. 0.2;                                                         <a name='674'></font>
<font color=#447700>!!               REPRESENTS NIGHTTIME STABLE CONDITIONS (REGIME=1),               <a name='675'></font>
<font color=#447700>!!                                                                                <a name='676'></font>
<font color=#447700>!!        2. BR .LT. 0.2 .AND. BR .GT. 0.0;                                       <a name='677'></font>
<font color=#447700>!!               REPRESENTS DAMPED MECHANICAL TURBULENT CONDITIONS                <a name='678'></font>
<font color=#447700>!!               (REGIME=2),                                                      <a name='679'></font>
<font color=#447700>!!                                                                                <a name='680'></font>
<font color=#447700>!!        3. BR .EQ. 0.0                                                          <a name='681'></font>
<font color=#447700>!!               REPRESENTS FORCED CONVECTION CONDITIONS (REGIME=3),              <a name='682'></font>
<font color=#447700>!!                                                                                <a name='683'></font>
<font color=#447700>!!        4. BR .LT. 0.0                                                          <a name='684'></font>
<font color=#447700>!!               REPRESENTS FREE CONVECTION CONDITIONS (REGIME=4).                <a name='685'></font>
<font color=#447700>!!                                                                                <a name='686'></font>
<font color=#447700>!!-----                                                                           <a name='687'></font>
<font color=#447700>!<a name='688'></font>
<font color=#447700>!      DO 320 I=its,ite<a name='689'></font>
<font color=#447700>!!----                                                                            <a name='690'></font>
<font color=#447700>!!--     REMOVE REGIME 3 DEPENDENCE ON PBL HEIGHT                                 <a name='691'></font>
<font color=#447700>!!--          IF(BR(I).LT.0..AND.HOL(I).GT.1.5)GOTO 310                         <a name='692'></font>
<font color=#447700>!<a name='693'></font>
<font color=#447700>!        IF(BR(I).LT.0.)GOTO 310                                                  <a name='694'></font>
<font color=#447700>!!                                                                                <a name='695'></font>
<font color=#447700>!!-----CLASS 1; STABLE (NIGHTTIME) CONDITIONS:                                    <a name='696'></font>
<font color=#447700>!!                                                                                <a name='697'></font>
<font color=#447700>!        IF(BR(I).LT.0.2)GOTO 270                                                 <a name='698'></font>
<font color=#447700>!        REGIME(I)=1.                                                           <a name='699'></font>
<font color=#447700>!        PSIM(I)=-10.*GZ1OZ0(I)                                                   <a name='700'></font>
<font color=#447700>!!    LOWER LIMIT ON PSI IN STABLE CONDITIONS                                     <a name='701'></font>
<font color=#447700>!        PSIM(I)=AMAX1(PSIM(I),-10.)                                              <a name='702'></font>
<font color=#447700>!        PSIH(I)=PSIM(I)                                                          <a name='703'></font>
<font color=#447700>!        HOL(I)=0.0<a name='704'></font>
<font color=#447700>!        PBL(I)=0.0                                                             <a name='705'></font>
<font color=#447700>!        GOTO 320                                                                 <a name='706'></font>
<font color=#447700>!!                                                                                <a name='707'></font>
<font color=#447700>!!-----CLASS 2; DAMPED MECHANICAL TURBULENCE:                                     <a name='708'></font>
<font color=#447700>!!                                                                                <a name='709'></font>
<font color=#447700>!  270   IF(BR(I).EQ.0.0)GOTO 280                                                 <a name='710'></font>
<font color=#447700>!        REGIME(I)=2.                                                           <a name='711'></font>
<font color=#447700>!        PSIM(I)=-5.0*BR(I)*GZ1OZ0(I)/(1.1-5.0*BR(I))                             <a name='712'></font>
<font color=#447700>!!    LOWER LIMIT ON PSI IN STABLE CONDITIONS                                     <a name='713'></font>
<font color=#447700>!        PSIM(I)=AMAX1(PSIM(I),-10.)                                              <a name='714'></font>
<font color=#447700>!!.....AKB(1976), EQ(16).                                                         <a name='715'></font>
<font color=#447700>!        PSIH(I)=PSIM(I)                                                          <a name='716'></font>
<font color=#447700>!        HOL(I)=0.0<a name='717'></font>
<font color=#447700>!        PBL(I)=0.0                                                             <a name='718'></font>
<font color=#447700>!        GOTO 320                                                                 <a name='719'></font>
<font color=#447700>!!                                                                                <a name='720'></font>
<font color=#447700>!!-----CLASS 3; FORCED CONVECTION:                                                <a name='721'></font>
<font color=#447700>!!                                                                                <a name='722'></font>
<font color=#447700>!  280   REGIME(I)=3.                                                           <a name='723'></font>
<font color=#447700>!        PSIM(I)=0.0                                                              <a name='724'></font>
<font color=#447700>!        PSIH(I)=PSIM(I)                                                          <a name='725'></font>
<font color=#447700>!                                                                                 <a name='726'></font>
<font color=#447700>!! special use kte instead of kme<a name='727'></font>
<font color=#447700>!<a name='728'></font>
<font color=#447700>!        DO 290 KK=kts,kte-1<a name='729'></font>
<font color=#447700>!          K=kte-KK<a name='730'></font>
<font color=#447700>!          IF(THVX(I,K).GT.THVX(I,KL))GOTO 300                                    <a name='731'></font>
<font color=#447700>!  290   CONTINUE                                                                 <a name='732'></font>
<font color=#447700>!        STOP 290                                                                 <a name='733'></font>
<font color=#447700>!  300   PBL(I)=ZQ(I,K+1)                                                       <a name='734'></font>
<font color=#447700>!        IF(UST(I).LT.0.01)THEN                                                 <a name='735'></font>
<font color=#447700>!          ZOL(I)=BR(I)*GZ1OZ0(I)                                               <a name='736'></font>
<font color=#447700>!        ELSE                                                                     <a name='737'></font>
<font color=#447700>!          ZOL(I)=KARMAN*GOVRTH(I)*ZA(I,KL)*MOL(I,J)/(UST(I)*UST(I)) <a name='738'></font>
<font color=#447700>!        ENDIF                                                                    <a name='739'></font>
<font color=#447700>!        HOL(I)=-ZOL(I)*PBL(I)/ZA(I,KL)<a name='740'></font>
<font color=#447700>!        GOTO 320                                                                 <a name='741'></font>
<font color=#447700>!                                                                                 <a name='742'></font>
<font color=#447700>!!-----CLASS 4; FREE CONVECTION:                                                  <a name='743'></font>
<font color=#447700>!                                                                                 <a name='744'></font>
<font color=#447700>!! 310     IF(THVX(I,KLM).GT.THVX(I,KL))GOTO 280                                  <a name='745'></font>
<font color=#447700>!<a name='746'></font>
<font color=#447700>!  310   CONTINUE                                                                 <a name='747'></font>
<font color=#447700>!        REGIME(I)=4.                                                           <a name='748'></font>
<font color=#447700>!        IF(UST(I).LT.0.01)THEN                                                 <a name='749'></font>
<font color=#447700>!          ZOL(I)=BR(I)*GZ1OZ0(I)                                               <a name='750'></font>
<font color=#447700>!        ELSE                                                                     <a name='751'></font>
<font color=#447700>!          ZOL(I)=KARMAN*GOVRTH(I)*ZA(I,KL)*MOL(I,J)/(UST(I)*UST(I))<a name='752'></font>
<font color=#447700>!        ENDIF                                                                    <a name='753'></font>
<font color=#447700>!        ZOL(I)=AMIN1(ZOL(I),0.)                                              <a name='754'></font>
<font color=#447700>!        ZOL(I)=AMAX1(ZOL(I),-9.9999)                                         <a name='755'></font>
<font color=#447700>!        NZOL=INT(-ZOL(I)*100.)                                                 <a name='756'></font>
<font color=#447700>!        RZOL=-ZOL(I)*100.-NZOL                                                 <a name='757'></font>
<font color=#447700>!        PSIM(I)=PSIMTB(NZOL)+RZOL*(PSIMTB(NZOL+1)-PSIMTB(NZOL))                  <a name='758'></font>
<font color=#447700>!        PSIH(I)=PSIHTB(NZOL)+RZOL*(PSIHTB(NZOL+1)-PSIHTB(NZOL))                  <a name='759'></font>
<font color=#447700>!!---LIMIT PSIH AND PSIM IN THE CASE OF THIN LAYERS AND HIGH ROUGHNESS            <a name='760'></font>
<font color=#447700>!!---  THIS PREVENTS DENOMINATOR IN FLUXES FROM GETTING TOO SMALL                 <a name='761'></font>
<font color=#447700>!        PSIH(I)=AMIN1(PSIH(I),0.9*GZ1OZ0(I))                                     <a name='762'></font>
<font color=#447700>!        PSIM(I)=AMIN1(PSIM(I),0.9*GZ1OZ0(I))                                     <a name='763'></font>
<font color=#447700>!  320 CONTINUE                                                                   <a name='764'></font>
<a name='765'>
<font color=#447700>!-----COMPUTE THE FRICTIONAL VELOCITY:        <a name='766'></font>
<font color=#447700>!     ZA(1982) EQS(2.60),(2.61).     <a name='767'></font>
<a name='768'>
      DO 330 I=its,ite<a name='769'>
        DTG=THX(I,KL)-THGB(I)        <a name='770'>
        PSIX=GZ1OZ0(I)-PSIM(I)        <a name='771'>
        IF((XLAND(I)-1.5).GE.0)THEN        <a name='772'>
          ZL=ZNT(I)        <a name='773'>
        ELSE        <a name='774'>
          ZL=0.01        <a name='775'>
        ENDIF        <a name='776'>
        PSIQ=ALOG(KARMAN*UST(I)*ZA(I,KL)/XKA+ZA(I,KL)/ZL)-PSIH(I)        <a name='777'>
        UST(I)=KARMAN*WSPD(I)/PSIX        <a name='778'>
<font color=#447700>!        <a name='779'></font>
        USTM=AMAX1(UST(I),0.1)        <a name='780'>
        IF((XLAND(I)-1.5).GE.0)THEN        <a name='781'>
          UST(I)=UST(I)        <a name='782'>
        ELSE                     <a name='783'>
          UST(I)=USTM          <a name='784'>
        ENDIF                    <a name='785'>
<font color=#447700>!       MOL(I,J)=KARMAN*DTG/(GZ1OZ0(I)-PSIH(I))/PRT<a name='786'></font>
  330 CONTINUE                   <a name='787'>
<font color=#447700>!                                                                                <a name='788'></font>
      DO 420 I=its,ite<a name='789'>
        WSPD1(I)=SQRT(UX(I,KL)*UX(I,KL)+VX(I,KL)*VX(I,KL))+1.E-9                  <a name='790'>
  420 CONTINUE                                                                   <a name='791'>
<font color=#447700>!                                                                                <a name='792'></font>
<font color=#447700>!---- COMPUTE VERTICAL DIFFUSION                                                 <a name='793'></font>
<font color=#447700>!                                                                                <a name='794'></font>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -          <a name='795'></font>
<font color=#447700>!     COMPUTE PRELIMINARY VARIABLES                                              <a name='796'></font>
<font color=#447700>!                                                                                <a name='797'></font>
<font color=#447700>!                                                                                <a name='798'></font>
      DT4=2.*DTSTEP                                                              <a name='799'>
      RDT=1./DT4                                                                 <a name='800'>
<font color=#447700>!                                                                                <a name='801'></font>
      DO I=its,ite<a name='802'>
        HGAMT(I)=0.                                                              <a name='803'>
        HGAMQ(I)=0.                                                              <a name='804'>
        WSCALE(I)=0.                                                             <a name='805'>
        KPBL(I)=KL                                                               <a name='806'>
        PBL(I)=ZQ(I,KL)                                                        <a name='807'>
        KPBL0(I)=KL                                                    <a name='808'>
        PBL0(I)=ZQ(I,KL)                                              <a name='809'>
        PBLFLG(I)=.TRUE.                                                         <a name='810'>
        SFCFLG(I)=.TRUE.                                                         <a name='811'>
        IF(BR(I).GT.0.0)SFCFLG(I)=.FALSE.                                        <a name='812'>
        ZL1(I)=ZA(I,KL)                                                          <a name='813'>
        THERMAL(I)=THVX(I,KL)                                                    <a name='814'>
      ENDDO                                                                      <a name='815'>
                                                                                 <a name='816'>
<font color=#447700>!     COMPUTE THE FIRST GUESS OF PBL HEIGHT                                      <a name='817'></font>
                                                                                 <a name='818'>
      DO I=its,ite<a name='819'>
        STABLE(I)=.FALSE.                                                        <a name='820'>
        BRUP(I)=BR(I)                                                            <a name='821'>
      ENDDO                                                                      <a name='822'>
      DO K=KLM,KLPBL,-1                                                          <a name='823'>
        DO I=its,ite<a name='824'>
          IF(.NOT.STABLE(I))THEN                                                 <a name='825'>
            BRDN(I)=BRUP(I)                                                      <a name='826'>
            SPDK2=MAX(UX(I,K)**2+VX(I,K)**2,1.)                                  <a name='827'>
            BRUP(I)=(THVX(I,K)-THERMAL(I))*(G*ZA(I,K)/THVX(I,KL))/SPDK2          <a name='828'>
            KPBL(I)=K                                                            <a name='829'>
            STABLE(I)=BRUP(I).GT.BRCR                                            <a name='830'>
          ENDIF                                                                  <a name='831'>
        ENDDO                                                                    <a name='832'>
      ENDDO                                                                      <a name='833'>
<font color=#447700>!                                                                                <a name='834'></font>
      DO I=its,ite<a name='835'>
        K=KPBL(I)                                                                <a name='836'>
        IF(BRDN(I).GE.BRCR)THEN                                                  <a name='837'>
          BRINT=0.                                                               <a name='838'>
        ELSEIF(BRUP(I).LE.BRCR)THEN                                              <a name='839'>
          BRINT=1.                                                               <a name='840'>
        ELSE                                                                     <a name='841'>
          BRINT=(BRCR-BRDN(I))/(BRUP(I)-BRDN(I))                                 <a name='842'>
        ENDIF                                                                    <a name='843'>
        PBL(I)=ZA(I,K+1)+BRINT*(ZA(I,K)-ZA(I,K+1))                             <a name='844'>
        IF(PBL(I).LT.ZQ(I,KPBL(I)+1))KPBL(I)=KPBL(I)+1                         <a name='845'>
      ENDDO                                                                      <a name='846'>
<font color=#447700>!                                                                                <a name='847'></font>
      DO I=its,ite<a name='848'>
        FM=GZ1OZ0(I)-PSIM(I)                                                     <a name='849'>
        FH=GZ1OZ0(I)-PSIH(I)                                                     <a name='850'>
        HOL(I)=MAX(BR(I)*FM*FM/FH,RIMIN)                                       <a name='851'>
        IF(SFCFLG(I))THEN                                                        <a name='852'>
          HOL(I)=MIN(HOL(I),-ZFMIN)                                          <a name='853'>
        ELSE                                                                     <a name='854'>
          HOL(I)=MAX(HOL(I),ZFMIN)                                           <a name='855'>
        ENDIF                                                                    <a name='856'>
<font color=#447700>!                                                                                <a name='857'></font>
        HOL1=HOL(I)*PBL(I)/ZL1(I)*SFCFRAC                                    <a name='858'>
        HOL(I)=-HOL(I)*PBL(I)/ZL1(I)                                       <a name='859'>
        IF(SFCFLG(I))THEN                                                        <a name='860'>
          PHIM(I)=(1.-APHI16*HOL1)**(-1./4.)                                     <a name='861'>
          PHIH(I)=(1.-APHI16*HOL1)**(-1./2.)                                     <a name='862'>
        ELSE                                                                     <a name='863'>
          PHIM(I)=(1.+APHI5*HOL1)                                                <a name='864'>
          PHIH(I)=PHIM(I)                                                        <a name='865'>
        ENDIF                                                                    <a name='866'>
        WSCALE(I)=UST(I)/PHIM(I)                                               <a name='867'>
        WSCALE(I)=MIN(WSCALE(I),UST(I)*APHI16)                                 <a name='868'>
        WSCALE(I)=MAX(WSCALE(I),UST(I)/APHI5)                                  <a name='869'>
      ENDDO                                                                      <a name='870'>
                                                                                 <a name='871'>
<font color=#447700>!     COMPUTE THE SURFACE VARIABLES FOR PBL HEIGHT ESTIMATION                    <a name='872'></font>
<font color=#447700>!     UNDER UNSTABLE CONDITIONS                                                  <a name='873'></font>
                                                                                 <a name='874'>
      DO I=its,ite<a name='875'>
        IF(SFCFLG(I))THEN                                                        <a name='876'>
          GAMFAC=CFAC/RHOX(I)/WSCALE(I)                                          <a name='877'>
          HGAMT(I)=MIN(GAMFAC*HFX(I)/CPM(I),GAMCRT)                            <a name='878'>
          HGAMQ(I)=MIN(GAMFAC*QFX(I),GAMCRQ)                                   <a name='879'>
          IF((XLAND(I)-1.5).GE.0)HGAMQ(I)=0.                                   <a name='880'>
          VPERT=HGAMT(I)+EP1*THX(I,KL)*HGAMQ(I)                                  <a name='881'>
          VPERT=MIN(VPERT,GAMCRT)                                                <a name='882'>
          THERMAL(I)=THERMAL(I)+MAX(VPERT,0.)                                    <a name='883'>
          HGAMT(I)=MAX(HGAMT(I),0.0)                                             <a name='884'>
          HGAMQ(I)=MAX(HGAMQ(I),0.0)                                             <a name='885'>
        ELSE                                                                     <a name='886'>
          PBLFLG(I)=.FALSE.                                                      <a name='887'>
        ENDIF                                                                    <a name='888'>
      ENDDO                                                                      <a name='889'>
<font color=#447700>!                                                                                <a name='890'></font>
      DO I=its,ite<a name='891'>
        IF(PBLFLG(I))THEN                                                        <a name='892'>
          KPBL(I)=KL                                                             <a name='893'>
          PBL(I)=ZQ(I,KL)                                                      <a name='894'>
        ENDIF                                                                    <a name='895'>
      ENDDO                                                                      <a name='896'>
<font color=#447700>!                                                                                <a name='897'></font>
<font color=#447700>!     ENHANCE THE PBL HEIGHT BY CONSIDERING THE THERMAL                          <a name='898'></font>
<font color=#447700>!                                                                                <a name='899'></font>
      DO I=its,ite<a name='900'>
        IF(PBLFLG(I))THEN                                                        <a name='901'>
          STABLE(I)=.FALSE.                                                      <a name='902'>
          BRUP(I)=BR(I)                                                          <a name='903'>
        ENDIF                                                                    <a name='904'>
      ENDDO                                                                      <a name='905'>
      DO K=KLM,KLPBL,-1                                                          <a name='906'>
        DO I=its,ite<a name='907'>
          IF(.NOT.STABLE(I).AND.PBLFLG(I))THEN                                   <a name='908'>
            BRDN(I)=BRUP(I)                                                      <a name='909'>
            SPDK2=MAX((UX(I,K)**2+VX(I,K)**2),1.)                                <a name='910'>
            BRUP(I)=(THVX(I,K)-THERMAL(I))*(G*ZA(I,K)/THVX(I,KL))/SPDK2          <a name='911'>
            KPBL(I)=K                                                            <a name='912'>
            STABLE(I)=BRUP(I).GT.BRCR                                            <a name='913'>
          ENDIF                                                                  <a name='914'>
        ENDDO                                                                    <a name='915'>
      ENDDO                                                                      <a name='916'>
<font color=#447700>!                                                                                <a name='917'></font>
      DO I=its,ite<a name='918'>
        IF(PBLFLG(I))THEN                                                        <a name='919'>
          K=KPBL(I)                                                              <a name='920'>
          IF(BRDN(I).GE.BRCR)THEN                                                <a name='921'>
            BRINT=0.                                                             <a name='922'>
          ELSEIF(BRUP(I).LE.BRCR)THEN                                            <a name='923'>
            BRINT=1.                                                             <a name='924'>
          ELSE                                                                   <a name='925'>
            BRINT=(BRCR-BRDN(I))/(BRUP(I)-BRDN(I))                               <a name='926'>
          ENDIF                                                                  <a name='927'>
          PBL(I)=ZA(I,K+1)+BRINT*(ZA(I,K)-ZA(I,K+1))                           <a name='928'>
          IF(PBL(I).LT.ZQ(I,KPBL(I)+1))KPBL(I)=KPBL(I)+1                       <a name='929'>
          IF(KPBL(I).LE.1)PBLFLG(I)=.FALSE.                                      <a name='930'>
        ENDIF                                                                    <a name='931'>
      ENDDO                                                                      <a name='932'>
<font color=#447700>!                                                                                <a name='933'></font>
<font color=#447700>!     DIAGNOSTIC PBL HEIGHT WITH BRCR EFFECTIVELY ZERO (PBL0)                    <a name='934'></font>
<font color=#447700>!                                                                                <a name='935'></font>
      DO I=its,ite<a name='936'>
        IF(PBLFLG(I))THEN                                                        <a name='937'>
          STABLE(I)=.FALSE.                                                      <a name='938'>
          BRUP(I)=BR(I)                                                          <a name='939'>
        ENDIF                                                                    <a name='940'>
      ENDDO                                                                      <a name='941'>
      DO K=KLM,KLPBL,-1                                                          <a name='942'>
        DO I=its,ite<a name='943'>
          IF(.NOT.STABLE(I).AND.PBLFLG(I))THEN                                   <a name='944'>
            BRDN(I)=BRUP(I)                                                      <a name='945'>
            SPDK2=MAX((UX(I,K)**2+VX(I,K)**2),1.)                                <a name='946'>
            BRUP(I)=(THVX(I,K)-THERMAL(I))*(G*ZA(I,K)/THVX(I,KL))/SPDK2          <a name='947'>
            KPBL0(I)=K                                                           <a name='948'>
            STABLE(I)=BRUP(I).GT.0.0                                             <a name='949'>
          ENDIF                                                                  <a name='950'>
                                                                                 <a name='951'>
        ENDDO                                                                    <a name='952'>
      ENDDO                                                                      <a name='953'>
<font color=#447700>!                                                                                <a name='954'></font>
      DO I=its,ite<a name='955'>
        IF(PBLFLG(I))THEN                                                        <a name='956'>
          K=KPBL0(I)                                                             <a name='957'>
          IF(BRDN(I).GE.0.0)THEN                                                 <a name='958'>
            BRINT=0.                                                             <a name='959'>
          ELSEIF(BRUP(I).LE.0.0)THEN                                             <a name='960'>
            BRINT=1.                                                             <a name='961'>
          ELSE                                                                   <a name='962'>
            BRINT=(0.0-BRDN(I))/(BRUP(I)-BRDN(I))                                <a name='963'>
          ENDIF                                                                  <a name='964'>
          PBL0(I)=ZA(I,K+1)+BRINT*(ZA(I,K)-ZA(I,K+1))                            <a name='965'>
          IF(PBL0(I).LT.ZQ(I,KPBL0(I)+1))KPBL0(I)=KPBL0(I)+1                     <a name='966'>
          IF(KPBL0(I).LE.1)PBLFLG(I)=.FALSE.                                     <a name='967'>
        ENDIF                                                                    <a name='968'>
      ENDDO                                                                      <a name='969'>
<a name='970'>
<font color=#447700>!                                                                                <a name='971'></font>
<font color=#447700>!     COMPUTE DIFFUSION COEFFICIENTS BELOW PBL                                   <a name='972'></font>
<font color=#447700>!                                                                                <a name='973'></font>
      DO K=kte,KLPBL,-1 <a name='974'>
        DO I=its,ite<a name='975'>
          IF(KPBL(I).LT.K)THEN                                                   <a name='976'>
            PRNUM=(PHIH(I)/PHIM(I)+CFAC*KARMAN*SFCFRAC)                          <a name='977'>
            PRNUM=MIN(PRNUM,PRMAX)                                               <a name='978'>
            PRNUM=MAX(PRNUM,PRMIN)                                               <a name='979'>
            ZFAC=MAX((1.-(ZQ(I,K)-ZL1(I))/(PBL(I)-ZL1(I))),ZFMIN)              <a name='980'>
            XKZO=CKZ*DZA(I,K-1)                                                    <a name='981'>
            XKZM(I,K)=XKZO+WSCALE(I)*KARMAN*ZQ(I,K)*ZFAC**PFAC                   <a name='982'>
            XKZH(I,K)=XKZM(I,K)/PRNUM                                            <a name='983'>
            XKZM(I,K)=MIN(XKZM(I,K),XKZMAX)                                      <a name='984'>
            XKZM(I,K)=MAX(XKZM(I,K),XKZMIN)                                      <a name='985'>
            XKZH(I,K)=MIN(XKZH(I,K),XKZMAX)                                      <a name='986'>
            XKZH(I,K)=MAX(XKZH(I,K),XKZMIN)                                      <a name='987'>
          ENDIF                                                                  <a name='988'>
        ENDDO                                                                    <a name='989'>
      ENDDO                                                                      <a name='990'>
<font color=#447700>!                                                                                <a name='991'></font>
<font color=#447700>!     COMPUTE DIFFUSION COEFFICIENTS OVER PBL (FREE ATMOSPHERE)                  <a name='992'></font>
<font color=#447700>!                                                                                <a name='993'></font>
      DO K=kts+1,kte<a name='994'>
        DO I=its,ite<a name='995'>
          XKZO=CKZ*DZA(I,K-1)                                                      <a name='996'>
          IF(K.LE.KPBL(I))THEN                                                   <a name='997'>
            SS=((UX(I,K-1)-UX(I,K))*(UX(I,K-1)-UX(I,K))+(VX(I,K-1)-   &amp; <a name='998'>
               VX(I,K))*(VX(I,K-1)-VX(I,K)))/(DZA(I,K-1)*DZA(I,K-1))+ &amp;          <a name='999'>
               1.E-9                                                             <a name='1000'>
            RI=GOVRTH(I)*(THVX(I,K-1)-THVX(I,K))/(SS*DZA(I,K-1))                 <a name='1001'>
            IF(IMVDIF.EQ.1)THEN                              <a name='1002'>
              IF((QCX(I,K)+QIX(I,K)).GT.0.01E-3.AND.(QCX(I,K-1)+      &amp; <a name='1003'>
                QIX(I,K-1)).GT.0.01E-3)THEN                                      <a name='1004'>
<font color=#447700>!      IN CLOUD                                                                  <a name='1005'></font>
                QMEAN=0.5*(QX(I,K)+QX(I,K-1))                                    <a name='1006'>
                TMEAN=0.5*(SCR3(I,K)+SCR3(I,K-1))                                <a name='1007'>
                ALPH=XLV*QMEAN/R/TMEAN                                           <a name='1008'>
                CHI=XLV*XLV*QMEAN/CP/RV/TMEAN/TMEAN                              <a name='1009'>
                RI=(1.+ALPH)*(RI-G*G/SS/TMEAN/CP*((CHI-ALPH)/(1.+CHI)))          <a name='1010'>
              ENDIF                                                              <a name='1011'>
            ENDIF                                                                <a name='1012'>
            ZK=KARMAN*ZQ(I,K)                                                    <a name='1013'>
            RL2=(ZK*RLAM/(RLAM+ZK))**2                                           <a name='1014'>
            DK=RL2*SQRT(SS)                                                      <a name='1015'>
            IF(RI.LT.0.)THEN                                                     <a name='1016'>
<font color=#447700>! UNSTABLE REGIME                                                                <a name='1017'></font>
              SRI=SQRT(-RI)                                                      <a name='1018'>
              XKZM(I,K)=XKZO+DK*(1+8.*(-RI)/(1+1.746*SRI))                       <a name='1019'>
              XKZH(I,K)=XKZO+DK*(1+8.*(-RI)/(1+1.286*SRI))                       <a name='1020'>
            ELSE                                                                 <a name='1021'>
<font color=#447700>! STABLE REGIME                                                                  <a name='1022'></font>
              XKZH(I,K)=XKZO+DK/(1+5.*RI)**2                                     <a name='1023'>
              PRNUM=1.0+2.1*RI                                                   <a name='1024'>
              PRNUM=MIN(PRNUM,PRMAX)                                             <a name='1025'>
              XKZM(I,K)=(XKZH(I,K)-XKZO)*PRNUM+XKZO                              <a name='1026'>
            ENDIF                                                                <a name='1027'>
<font color=#447700>!                                                                                <a name='1028'></font>
            XKZM(I,K)=MIN(XKZM(I,K),XKZMAX)                                      <a name='1029'>
            XKZM(I,K)=MAX(XKZM(I,K),XKZMIN)                                      <a name='1030'>
            XKZH(I,K)=MIN(XKZH(I,K),XKZMAX)                                      <a name='1031'>
            XKZH(I,K)=MAX(XKZH(I,K),XKZMIN)                                      <a name='1032'>
          ENDIF                                                                  <a name='1033'>
<font color=#447700>!                                                                                <a name='1034'></font>
        ENDDO                                                                    <a name='1035'>
      ENDDO                                                                      <a name='1036'>
                                                                                 <a name='1037'>
<font color=#447700>!     COMPUTE TRIDIAGONAL MATRIX ELEMENTS FOR HEAT AND MOISTURE                  <a name='1038'></font>
                                                                                 <a name='1039'>
      DO I=its,ite<a name='1040'>
      DO K=kts,kte<a name='1041'>
         AU(i,k)=0.<a name='1042'>
         AL(i,k)=0.<a name='1043'>
         AD(i,k)=0.<a name='1044'>
         A1(i,k)=0.<a name='1045'>
         A2(i,k)=0.<a name='1046'>
      ENDDO<a name='1047'>
      ENDDO<a name='1048'>
 <a name='1049'>
      DO I=its,ite<a name='1050'>
        AD(I,1)=1.                                                               <a name='1051'>
        A1(I,1)=SCR3(I,KL)+HFX(I)/(RHOX(I)*CPM(I))/ZQ(I,KL)*DT4                <a name='1052'>
        A2(I,1)=QX(I,KL)+QFX(I)/(RHOX(I))/ZQ(I,KL)*DT4                         <a name='1053'>
      ENDDO                                                                      <a name='1054'>
<font color=#447700>!                                                                                <a name='1055'></font>
      DO K=kte,kts+1,-1<a name='1056'>
        KK=kme-K                                                                <a name='1057'>
        DO I=its,ite<a name='1058'>
          DTODSD=DT4/dz8w2d(I,K)                                                   <a name='1059'>
          DTODSU=DT4/dz8w2d(I,K-1)                                                 <a name='1060'>
          DSIG=z2d(I,K)-z2d(I,K-1)                                                 <a name='1061'>
          DSIG=-DSIG<a name='1062'>
          RDZ=1./DZA(I,K-1)                                                      <a name='1063'>
          IF(PBLFLG(I).AND.KPBL(I).LT.K)THEN                                     <a name='1064'>
            DSDZT=DSIG*XKZH(I,K)*RDZ*(G/CP-HGAMT(I)/PBL(I))                    <a name='1065'>
            DSDZQ=DSIG*XKZH(I,K)*RDZ*(-HGAMQ(I)/PBL(I))                        <a name='1066'>
            A2(I,KK)=A2(I,KK)+DTODSD*DSDZQ                                       <a name='1067'>
            A2(I,KK+1)=QX(I,K-1)-DTODSU*DSDZQ                                    <a name='1068'>
          ELSE                                                                   <a name='1069'>
            DSDZT=DSIG*XKZH(I,K)*RDZ*(G/CP)                                      <a name='1070'>
            A2(I,KK+1)=QX(I,K-1)                                                 <a name='1071'>
          ENDIF                                                                  <a name='1072'>
          DSDZ2=DSIG*XKZH(I,K)*RDZ*RDZ                                           <a name='1073'>
          AU(I,KK)=-DTODSD*DSDZ2                                                 <a name='1074'>
          AL(I,KK)=-DTODSU*DSDZ2                                                 <a name='1075'>
          AD(I,KK)=AD(I,KK)-AU(I,KK)                                             <a name='1076'>
          AD(I,KK+1)=1.-AL(I,KK)                                                 <a name='1077'>
          A1(I,KK)=A1(I,KK)+DTODSD*DSDZT                                         <a name='1078'>
          A1(I,KK+1)=SCR3(I,K-1)-DTODSU*DSDZT                                    <a name='1079'>
        ENDDO                                                                    <a name='1080'>
      ENDDO                                                                      <a name='1081'>
                                                                                 <a name='1082'>
<font color=#447700>!     SOLVE TRIDIAGONAL PROBLEM FOR HEAT AND MOISTURE                            <a name='1083'></font>
      <a name='1084'>
      CALL <A href='../../html_code/phys/module_bl_mrf.F.html#TRIDI2'>TRIDI2</A><A href='../../html_code/phys/module_bl_mrf.F.html#MRF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDI2_3">(AL,AD,AU,A1,A2,AU,A1,A2,                 &amp;<a name='1085'>
                  its,ite,kts,kte                          )<a name='1086'>
<a name='1087'>
<font color=#447700>!     RECOVER TENDENCIES OF HEAT AND MOISTURE                                    <a name='1088'></font>
                                                                                 <a name='1089'>
      DO K=kte,kts,-1<a name='1090'>
        KK=kme-K<a name='1091'>
        DO I=its,ite<a name='1092'>
          TTEND=(A1(I,KK)-SCR3(I,K))*RDT                                         <a name='1093'>
          QTEND=(A2(I,KK)-QX(I,K))*RDT                                           <a name='1094'>
          TTNP(I,K)=TTNP(I,K)+TTEND                                              <a name='1095'>
          QTNP(I,K)=QTNP(I,K)+QTEND                                              <a name='1096'>
        ENDDO                                                                    <a name='1097'>
      ENDDO                                                                      <a name='1098'>
                                                                                 <a name='1099'>
<font color=#447700>!     COMPUTE TRIDIAGONAL MATRIX ELEMENTS FOR MOMENTUM                           <a name='1100'></font>
                                                                                 <a name='1101'>
      DO I=its,ite<a name='1102'>
      DO K=kts,kte<a name='1103'>
         AU(i,k)=0.<a name='1104'>
         AL(i,k)=0.<a name='1105'>
         AD(i,k)=0.<a name='1106'>
         A1(i,k)=0.<a name='1107'>
         A2(i,k)=0.<a name='1108'>
      ENDDO<a name='1109'>
      ENDDO<a name='1110'>
 <a name='1111'>
      DO I=its,ite<a name='1112'>
        AD(I,1)=1.                                                               <a name='1113'>
        A1(I,1)=UX(I,KL)-UX(I,KL)/WSPD1(I)*UST(I)*UST(I)/ZQ(I,KL)  &amp;<a name='1114'>
                *DT4*(WSPD1(I)/WSPD(I))**2                            <a name='1115'>
        A2(I,1)=VX(I,KL)-VX(I,KL)/WSPD1(I)*UST(I)*UST(I)/ZQ(I,KL)  &amp;<a name='1116'>
                *DT4*(WSPD1(I)/WSPD(I))**2                          <a name='1117'>
      ENDDO                                                                      <a name='1118'>
<font color=#447700>!                                                                                <a name='1119'></font>
      DO K=kte,kts+1,-1<a name='1120'>
        KK=kme-K<a name='1121'>
        DO I=its,ite<a name='1122'>
          DTODSD=DT4/dz8w2d(I,K)                                                   <a name='1123'>
          DTODSU=DT4/dz8w2d(I,K-1)                                                 <a name='1124'>
          DSIG=z2d(I,K)-z2d(I,K-1)                                                 <a name='1125'>
          DSIG=-DSIG<a name='1126'>
          RDZ=1./DZA(I,K-1)                                                      <a name='1127'>
          DSDZ2=DSIG*XKZM(I,K)*RDZ*RDZ                                           <a name='1128'>
          AU(I,KK)=-DTODSD*DSDZ2                                                 <a name='1129'>
          AL(I,KK)=-DTODSU*DSDZ2                                                 <a name='1130'>
          AD(I,KK)=AD(I,KK)-AU(I,KK)                                             <a name='1131'>
          AD(I,KK+1)=1.-AL(I,KK)                                                 <a name='1132'>
          A1(I,KK+1)=UX(I,K-1)                                                   <a name='1133'>
          A2(I,KK+1)=VX(I,K-1)                                                   <a name='1134'>
        ENDDO                                                                    <a name='1135'>
      ENDDO                                                                      <a name='1136'>
                                                                                 <a name='1137'>
<font color=#447700>!     SOLVE TRIDIAGONAL PROBLEM FOR MOMENTUM                                     <a name='1138'></font>
                                                                                 <a name='1139'>
      CALL <A href='../../html_code/phys/module_bl_mrf.F.html#TRIDI2'>TRIDI2</A><A href='../../html_code/phys/module_bl_mrf.F.html#MRF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDI2_4">(AL,AD,AU,A1,A2,AU,A1,A2,                 &amp;<a name='1140'>
                  its,ite,kts,kte                          )<a name='1141'>
                                                                                 <a name='1142'>
<font color=#447700>!     RECOVER TENDENCIES OF MOMENTUM                                             <a name='1143'></font>
                                                                                 <a name='1144'>
      DO K=kte,kts,-1 <a name='1145'>
        KK=kme-K<a name='1146'>
        DO I=its,ite<a name='1147'>
          UTEND=(A1(I,KK)-UX(I,K))*RDT                                           <a name='1148'>
          VTEND=(A2(I,KK)-VX(I,K))*RDT                                           <a name='1149'>
          UTNP(I,K)=UTNP(I,K)+UTEND                                              <a name='1150'>
          VTNP(I,K)=VTNP(I,K)+VTEND                                              <a name='1151'>
        ENDDO                                                                    <a name='1152'>
      ENDDO                                                                      <a name='1153'>
                                                                                 <a name='1154'>
<font color=#447700>!     COMPUTE TRIDIAGONAL MATRIX ELEMENTS FOR CLOUD                              <a name='1155'></font>
                                                                                 <a name='1156'>
      DO I=its,ite<a name='1157'>
      DO K=kts,kte<a name='1158'>
         AU(i,k)=0.<a name='1159'>
         AL(i,k)=0.<a name='1160'>
         AD(i,k)=0.<a name='1161'>
         A1(i,k)=0.<a name='1162'>
         A2(i,k)=0.<a name='1163'>
      ENDDO<a name='1164'>
      ENDDO<a name='1165'>
 <a name='1166'>
<font color=#447700>!     IF(IMOIST.EQ.1)GOTO 690                                                <a name='1167'></font>
      DO I=its,ite<a name='1168'>
        AD(I,1)=1.                                                               <a name='1169'>
        A1(I,1)=QCX(I,KL)                                                        <a name='1170'>
        A2(I,1)=QIX(I,KL)                                                        <a name='1171'>
      ENDDO                                                                      <a name='1172'>
<font color=#447700>!                                                                                <a name='1173'></font>
      DO K=kte,kts+1,-1<a name='1174'>
        KK=kme-K<a name='1175'>
        DO I=its,ite<a name='1176'>
          DTODSD=DT4/dz8w2d(I,K)                                                   <a name='1177'>
          DTODSU=DT4/dz8w2d(I,K-1)                                                 <a name='1178'>
          DSIG=z2d(I,K)-z2d(I,K-1)                                                 <a name='1179'>
          DSIG=-DSIG<a name='1180'>
          RDZ=1./DZA(I,K-1)                                                      <a name='1181'>
          A1(I,KK+1)=QCX(I,K-1)                                                  <a name='1182'>
          A2(I,KK+1)=QIX(I,K-1)                                                  <a name='1183'>
          DSDZ2=DSIG*XKZH(I,K)*RDZ*RDZ                                           <a name='1184'>
          AU(I,KK)=-DTODSD*DSDZ2                                                 <a name='1185'>
          AL(I,KK)=-DTODSU*DSDZ2                                                 <a name='1186'>
          AD(I,KK)=AD(I,KK)-AU(I,KK)                                             <a name='1187'>
          AD(I,KK+1)=1.-AL(I,KK)                                                 <a name='1188'>
        ENDDO                                                                    <a name='1189'>
      ENDDO                                                                      <a name='1190'>
                                                                                 <a name='1191'>
<font color=#447700>!     SOLVE TRIDIAGONAL PROBLEM FOR CLOUD                                        <a name='1192'></font>
                                                                                 <a name='1193'>
      CALL <A href='../../html_code/phys/module_bl_mrf.F.html#TRIDI2'>TRIDI2</A><A href='../../html_code/phys/module_bl_mrf.F.html#MRF2D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIDI2_5">(AL,AD,AU,A1,A2,AU,A1,A2,                 &amp;<a name='1194'>
                  its,ite,kts,kte                          )<a name='1195'>
<font color=#447700>!<a name='1196'></font>
      DO K=kte,kts,-1<a name='1197'>
        KK=kme-K                                                                <a name='1198'>
        DO I=its,ite<a name='1199'>
          QCTEND=(A1(I,KK)-QCX(I,K))*RDT                                         <a name='1200'>
          QITEND=(A2(I,KK)-QIX(I,K))*RDT                                         <a name='1201'>
          QCTNP(I,K)=QCTNP(I,K)+QCTEND                                           <a name='1202'>
          QITNP(I,K)=QITNP(I,K)+QITEND                                           <a name='1203'>
        ENDDO                                                                    <a name='1204'>
      ENDDO                                                                      <a name='1205'>
<font color=#447700>!                                                                                <a name='1206'></font>
<font color=#447700>!---- END OF VERTICAL DIFFUSION                                                  <a name='1207'></font>
<font color=#447700>!                                                                                <a name='1208'></font>
  690 CONTINUE                                                                   <a name='1209'>
<font color=#447700>!                                                                                <a name='1210'></font>
<font color=#447700>!-----CALCULATION OF NEW VALUES DUE TO VERTICAL EXCHANGE PROCESSES IS            <a name='1211'></font>
<font color=#447700>!     COMPLETED. THE FINAL STEP IS TO ADD THE TENDENCIES CALCULATED              <a name='1212'></font>
<font color=#447700>!     IN HIRPBL TO THOSE OF MM4.                                                 <a name='1213'></font>
                                                                                 <a name='1214'>
      DO 820 K=kts,kte<a name='1215'>
        NK=kme-K<a name='1216'>
        DO 820 I=its,ite<a name='1217'>
          U2DTEN(I,NK)=UTNP(I,K)<a name='1218'>
          V2DTEN(I,NK)=VTNP(I,K)<a name='1219'>
  820   CONTINUE                                                                 <a name='1220'>
<font color=#447700>!                                                                                <a name='1221'></font>
<font color=#447700>!     IF(J.EQ.1.AND.IN.GT.1)GOTO 860                                             <a name='1222'></font>
<font color=#447700>!SUE  JBGN=3                                                                     <a name='1223'></font>
<font color=#447700>!SUE  JEND=JLXM-1                                                                <a name='1224'></font>
<a name='1225'>
<font color=#447700>! change when nest<a name='1226'></font>
<font color=#447700>!SUE  JBGN=2                                                                   <a name='1227'></font>
<font color=#447700>!SUE  JEND=JLXM                                                                <a name='1228'></font>
<a name='1229'>
      JBGN=jts<a name='1230'>
      JEND=jte<a name='1231'>
      IBGN=its                                                                   <a name='1232'>
      IEND=ite<a name='1233'>
<a name='1234'>
<font color=#447700>!     IF(J.LT.JBGN.OR.J.GT.JEND)GOTO 860                                         <a name='1235'></font>
<font color=#447700>!SUE  IBGN=3                                                                     <a name='1236'></font>
<font color=#447700>!SUE  IEND=ILXM-1                                                                <a name='1237'></font>
<a name='1238'>
<font color=#447700>! change when nest<a name='1239'></font>
<font color=#447700>!SUE  IBGN=2                                                                   <a name='1240'></font>
<font color=#447700>!SUE  IEND=ILXM                                                                <a name='1241'></font>
<a name='1242'>
      DO 830 K=kts,kte<a name='1243'>
        NK=kme-K<a name='1244'>
        DO 830 I=IBGN,IEND                                                       <a name='1245'>
          T2DTEN(I,NK)=TTNP(I,K)<a name='1246'>
  830   CONTINUE                                                                 <a name='1247'>
<font color=#447700>!                                                                                <a name='1248'></font>
<font color=#447700>!     IF(IDRY.EQ.1)GOTO 860                                                  <a name='1249'></font>
      DO 840 K=kts,kte<a name='1250'>
        NK=kme-K<a name='1251'>
        DO 840 I=IBGN,IEND                                                       <a name='1252'>
          QV2DTEN(I,NK)=QTNP(I,K) <a name='1253'>
  840   CONTINUE                                                                 <a name='1254'>
                                                                                 <a name='1255'>
<font color=#447700>!     IF(IMOIST.EQ.1)GOTO 860<a name='1256'></font>
      DO 850 K=kts,kte<a name='1257'>
        NK=kme-K<a name='1258'>
        DO 850 I=IBGN,IEND<a name='1259'>
           QC2DTEN(I,NK)=QCTNP(I,K)<a name='1260'>
  850   CONTINUE<a name='1261'>
<a name='1262'>
      IF(flag_QI .AND. PRESENT( QI2DTEN ) ) THEN<a name='1263'>
        DO K=kts,kte<a name='1264'>
        NK=kme-K<a name='1265'>
          DO I=IBGN,IEND<a name='1266'>
             QI2DTEN(I,NK)=QITNP(I,K)<a name='1267'>
          ENDDO<a name='1268'>
        ENDDO<a name='1269'>
      ENDIF<a name='1270'>
<a name='1271'>
  860 CONTINUE                                                                   <a name='1272'>
<font color=#447700>!                                                                                <a name='1273'></font>
<font color=#447700>!-----APPLY ASSELIN FILTER TO TGD FOR LARGE TIME STEP:                           <a name='1274'></font>
<font color=#447700>!                                                                                <a name='1275'></font>
<font color=#447700>!     DO 885 I=its,ite<a name='1276'></font>
<font color=#447700>!       TSK(I)=TSK(I)*(PS(I)/100.)**ROVCP                                    <a name='1277'></font>
<font color=#447700>! 885 CONTINUE                                                                   <a name='1278'></font>
<font color=#447700>!                                                                                <a name='1279'></font>
  940 CONTINUE                                                                   <a name='1280'>
<font color=#447700>!                                                                                <a name='1281'></font>
<font color=#447700>! KPBL IS NEEDED FOR THE FDDA, AND SINCE THERE IS NO LONGER JUST ONE             <a name='1282'></font>
<font color=#447700>! LARGE "J LOOP" IT MUST BE STORED AS (I,J)...                                   <a name='1283'></font>
<font color=#447700>!                                                                                <a name='1284'></font>
<font color=#447700>! USE NEW DIAGNOSED PBL DEPTH (CALCULATED WITH brcr=0.0)<a name='1285'></font>
<font color=#447700>! PBL IS USED FOR OUTPUT AND NEXT-TIME-STEP BELJAARS CALC IN SFCLAY<a name='1286'></font>
      DO 950 I=its,ite<a name='1287'>
        KPBL1D(I)=KPBL0(I)                                                      <a name='1288'>
        PBL(I)=PBL0(I)<a name='1289'>
  950 CONTINUE                                                                   <a name='1290'>
<a name='1291'>
   END SUBROUTINE MRF2D<a name='1292'>
<a name='1293'>
<font color=#447700>!================================================================          <a name='1294'></font>
<A NAME='TRIDI2'><A href='../../html_code/phys/module_bl_mrf.F.html#TRIDI2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1295'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TRIDI2</font>(CL,CM,CU,R1,R2,AU,A1,A2,                   &amp; <A href='../../call_to/TRIDI2.html' TARGET='index'>5</A>,<A href='../../call_from/TRIDI2.html' TARGET='index'>2</A><a name='1296'>
                     its,ite,kts,kte                            )<a name='1297'>
<font color=#447700>!----------------------------------------------------------------<a name='1298'></font>
   IMPLICIT NONE<a name='1299'>
<font color=#447700>!----------------------------------------------------------------<a name='1300'></font>
<a name='1301'>
   INTEGER, INTENT(IN )      ::     its,ite, kts,kte<a name='1302'>
                                   <a name='1303'>
   REAL, DIMENSION( its:ite, kts+1:kte+1 )                    , &amp;<a name='1304'>
         INTENT(IN   )  ::                                  CL<a name='1305'>
<a name='1306'>
   REAL, DIMENSION( its:ite, kts:kte )                        , &amp;<a name='1307'>
         INTENT(IN   )  ::                                  CM, &amp;<a name='1308'>
                                                            R1, &amp;<a name='1309'>
                                                            R2<a name='1310'>
   REAL, DIMENSION( its:ite, kts:kte )                        , &amp;<a name='1311'>
         INTENT(INOUT)  ::                                  AU, &amp;<a name='1312'>
                                                            CU, &amp;<a name='1313'>
                                                            A1, &amp;<a name='1314'>
                                                            A2<a name='1315'>
<a name='1316'>
   REAL    :: FK<a name='1317'>
   INTEGER :: I,K,L,N<a name='1318'>
<a name='1319'>
<font color=#447700>!----------------------------------------------------------------         <a name='1320'></font>
<a name='1321'>
   L=ite <a name='1322'>
   N=kte<a name='1323'>
<a name='1324'>
   DO I=its,L<a name='1325'>
     FK=1./CM(I,1)                                                            <a name='1326'>
     AU(I,1)=FK*CU(I,1)                                                       <a name='1327'>
     A1(I,1)=FK*R1(I,1)                                                       <a name='1328'>
     A2(I,1)=FK*R2(I,1)                                                       <a name='1329'>
   ENDDO                                                                      <a name='1330'>
   DO K=2,N-1<a name='1331'>
     DO I=its,L<a name='1332'>
       FK=1./(CM(I,K)-CL(I,K)*AU(I,K-1))                                      <a name='1333'>
       AU(I,K)=FK*CU(I,K)                                                     <a name='1334'>
       A1(I,K)=FK*(R1(I,K)-CL(I,K)*A1(I,K-1))                                 <a name='1335'>
       A2(I,K)=FK*(R2(I,K)-CL(I,K)*A2(I,K-1))                                 <a name='1336'>
     ENDDO                                                                    <a name='1337'>
   ENDDO                                                                      <a name='1338'>
   DO I=its,L<a name='1339'>
     FK=1./(CM(I,N)-CL(I,N)*AU(I,N-1))                                        <a name='1340'>
     A1(I,N)=FK*(R1(I,N)-CL(I,N)*A1(I,N-1))                                   <a name='1341'>
     A2(I,N)=FK*(R2(I,N)-CL(I,N)*A2(I,N-1))                                   <a name='1342'>
<a name='1343'>
   ENDDO                                                                      <a name='1344'>
   DO K=N-1,kts,-1                                                              <a name='1345'>
     DO I=its,L<a name='1346'>
       A1(I,K)=A1(I,K)-AU(I,K)*A1(I,K+1)                                      <a name='1347'>
       A2(I,K)=A2(I,K)-AU(I,K)*A2(I,K+1)                                      <a name='1348'>
     ENDDO                                                                    <a name='1349'>
   ENDDO                                                                      <a name='1350'>
<a name='1351'>
   END SUBROUTINE TRIDI2<a name='1352'>
      <a name='1353'>
<font color=#447700>!===================================================================<a name='1354'></font>
<A NAME='MRFINIT'><A href='../../html_code/phys/module_bl_mrf.F.html#MRFINIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1355'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>mrfinit</font>(RUBLTEN,RVBLTEN,RTHBLTEN,RQVBLTEN,           &amp; <A href='../../call_to/MRFINIT.html' TARGET='index'>1</A><a name='1356'>
                      RQCBLTEN,RQIBLTEN,P_QI,P_FIRST_SCALAR,       &amp;<a name='1357'>
                      restart, allowed_to_read ,                   &amp;<a name='1358'>
                      ids, ide, jds, jde, kds, kde,                &amp;<a name='1359'>
                      ims, ime, jms, jme, kms, kme,                &amp;<a name='1360'>
                      its, ite, jts, jte, kts, kte                 )<a name='1361'>
<font color=#447700>!-------------------------------------------------------------------          <a name='1362'></font>
   IMPLICIT NONE<a name='1363'>
<font color=#447700>!-------------------------------------------------------------------          <a name='1364'></font>
   LOGICAL , INTENT(IN)          :: restart , allowed_to_read<a name='1365'>
   INTEGER , INTENT(IN)          ::  ids, ide, jds, jde, kds, kde, &amp;<a name='1366'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='1367'>
                                     its, ite, jts, jte, kts, kte<a name='1368'>
   INTEGER , INTENT(IN)          ::  P_QI,P_FIRST_SCALAR<a name='1369'>
<a name='1370'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::         &amp;<a name='1371'>
                                                         RUBLTEN, &amp;<a name='1372'>
                                                         RVBLTEN, &amp;<a name='1373'>
                                                         RTHBLTEN, &amp;<a name='1374'>
                                                         RQVBLTEN, &amp;<a name='1375'>
                                                         RQCBLTEN, &amp; <a name='1376'>
                                                         RQIBLTEN<a name='1377'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='1378'>
<a name='1379'>
   jtf=min0(jte,jde-1)<a name='1380'>
   ktf=min0(kte,kde-1)<a name='1381'>
   itf=min0(ite,ide-1)<a name='1382'>
<a name='1383'>
   IF(.not.restart)THEN<a name='1384'>
     DO j=jts,jtf<a name='1385'>
     DO k=kts,ktf<a name='1386'>
     DO i=its,itf<a name='1387'>
        RUBLTEN(i,k,j)=0.<a name='1388'>
        RVBLTEN(i,k,j)=0.<a name='1389'>
        RTHBLTEN(i,k,j)=0.<a name='1390'>
        RQVBLTEN(i,k,j)=0.<a name='1391'>
        RQCBLTEN(i,k,j)=0.<a name='1392'>
     ENDDO<a name='1393'>
     ENDDO<a name='1394'>
     ENDDO<a name='1395'>
   ENDIF<a name='1396'>
<a name='1397'>
   IF (P_QI .ge. P_FIRST_SCALAR .and. .not.restart) THEN<a name='1398'>
      DO j=jts,jtf<a name='1399'>
      DO k=kts,ktf<a name='1400'>
      DO i=its,itf<a name='1401'>
         RQIBLTEN(i,k,j)=0.<a name='1402'>
      ENDDO<a name='1403'>
      ENDDO<a name='1404'>
      ENDDO<a name='1405'>
   ENDIF<a name='1406'>
<a name='1407'>
   END SUBROUTINE mrfinit<a name='1408'>
<a name='1409'>
<font color=#447700>!-------------------------------------------------------------------          <a name='1410'></font>
<a name='1411'>
END MODULE module_bl_mrf<a name='1412'>
<a name='1413'>
</pre></body></html>