<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_NOAHLSM_GLACIAL_ONLY'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#MODULE_SF_NOAHLSM_GLACIAL_ONLY' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_noahlsm_glacial_only</font> <A href='../../call_to/MODULE_SF_NOAHLSM_GLACIAL_ONLY.html' TARGET='index'>1</A><a name='3'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#module_sf_noahlsm_glacial_only.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_97"><a name='4'>
  USE <A href='../../html_code/phys/module_sf_noahlsm.F.html#MODULE_SF_NOAHLSM'>module_sf_noahlsm</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#module_sf_noahlsm_glacial_only.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHLSM_5">, ONLY : RD, SIGMA, CPH2O, CPICE, LSUBF, EMISSI_S, ROSR12<a name='5'>
  USE <A href='../../html_code/phys/module_sf_noahlsm.F.html#MODULE_SF_NOAHLSM'>module_sf_noahlsm</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#module_sf_noahlsm_glacial_only.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHLSM_6">, ONLY : LVCOEF_DATA<a name='6'>
<a name='7'>
  PRIVATE :: ALCALC<a name='8'>
  PRIVATE :: CSNOW<a name='9'>
  PRIVATE :: HRTICE<a name='10'>
  PRIVATE :: HSTEP<a name='11'>
  PRIVATE :: PENMAN<a name='12'>
  PRIVATE :: SHFLX<a name='13'>
  PRIVATE :: SNOPAC<a name='14'>
  PRIVATE :: SNOWPACK<a name='15'>
  PRIVATE :: SNOWZ0<a name='16'>
  PRIVATE :: SNOW_NEW<a name='17'>
<a name='18'>
  integer, private :: iloc, jloc<a name='19'>
<font color=#447700>!$omp threadprivate(iloc, jloc)<a name='20'></font>
<a name='21'>
CONTAINS<a name='22'>
<a name='23'>
<A NAME='SFLX_GLACIAL'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='24'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SFLX_GLACIAL</font> (IILOC,JJLOC,ISICE,FFROZP,DT,ZLVL,NSOIL,SLDPTH,     &amp;    <font color=#447700>!C <A href='../../call_to/SFLX_GLACIAL.html' TARGET='index'>3</A>,<A href='../../call_from/SFLX_GLACIAL.html' TARGET='index'>8</A><a name='25'></font>
       &amp;                   LWDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2,           &amp;    <font color=#447700>!F<a name='26'></font>
       &amp;                   TH2,Q2SAT,DQSDT2,                            &amp;    <font color=#447700>!I<a name='27'></font>
       &amp;                   ALB, SNOALB,TBOT, Z0BRD, Z0, EMISSI, EMBRD,  &amp;    <font color=#447700>!S<a name='28'></font>
       &amp;                   T1,STC,SNOWH,SNEQV,ALBEDO,CH,                &amp;    <font color=#447700>!H<a name='29'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='30'></font>
<font color=#447700>! OUTPUTS, DIAGNOSTICS, PARAMETERS BELOW GENERALLY NOT NECESSARY WHEN<a name='31'></font>
<font color=#447700>! COUPLED WITH E.G. A NWP MODEL (SUCH AS THE NOAA/NWS/NCEP MESOSCALE ETA<a name='32'></font>
<font color=#447700>! MODEL).  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.<a name='33'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='34'></font>
       &amp;                   ETA,SHEAT, ETA_KINEMATIC,FDOWN,              &amp;    <font color=#447700>!O<a name='35'></font>
       &amp;                   ESNOW,DEW,                                   &amp;    <font color=#447700>!O<a name='36'></font>
       &amp;                   ETP,SSOIL,                                   &amp;    <font color=#447700>!O<a name='37'></font>
       &amp;                   FLX1,FLX2,FLX3,                              &amp;    <font color=#447700>!O<a name='38'></font>
       &amp;                   SNOMLT,SNCOVR,                               &amp;    <font color=#447700>!O<a name='39'></font>
       &amp;                   RUNOFF1,                                     &amp;    <font color=#447700>!O<a name='40'></font>
       &amp;                   Q1,                                          &amp;    <font color=#447700>!D<a name='41'></font>
       &amp;                   SNOTIME1,                                    &amp;<a name='42'>
       &amp;                   RIBB)<a name='43'>
<font color=#447700>! ----------------------------------------------------------------------<a name='44'></font>
<font color=#447700>! SUB-DRIVER FOR "Noah LSM" FAMILY OF PHYSICS SUBROUTINES FOR A<a name='45'></font>
<font color=#447700>! SOIL/VEG/SNOWPACK LAND-SURFACE MODEL TO UPDATE ICE TEMPERATURE, SKIN <a name='46'></font>
<font color=#447700>! TEMPERATURE, SNOWPACK WATER CONTENT, SNOWDEPTH, AND ALL TERMS OF THE <a name='47'></font>
<font color=#447700>! SURFACE ENERGY BALANCE (EXCLUDING INPUT ATMOSPHERIC FORCINGS OF <a name='48'></font>
<font color=#447700>! DOWNWARD RADIATION AND PRECIP)<a name='49'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='50'></font>
<font color=#447700>! SFLX ARGUMENT LIST KEY:<a name='51'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='52'></font>
<font color=#447700>!  C  CONFIGURATION INFORMATION<a name='53'></font>
<font color=#447700>!  F  FORCING DATA<a name='54'></font>
<font color=#447700>!  I  OTHER (INPUT) FORCING DATA<a name='55'></font>
<font color=#447700>!  S  SURFACE CHARACTERISTICS<a name='56'></font>
<font color=#447700>!  H  HISTORY (STATE) VARIABLES<a name='57'></font>
<font color=#447700>!  O  OUTPUT VARIABLES<a name='58'></font>
<font color=#447700>!  D  DIAGNOSTIC OUTPUT<a name='59'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='60'></font>
<font color=#447700>! 1. CONFIGURATION INFORMATION (C):<a name='61'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='62'></font>
<font color=#447700>!   DT         TIMESTEP (SEC) (DT SHOULD NOT EXCEED 3600 SECS, RECOMMEND<a name='63'></font>
<font color=#447700>!                1800 SECS OR LESS)<a name='64'></font>
<font color=#447700>!   ZLVL       HEIGHT (M) ABOVE GROUND OF ATMOSPHERIC FORCING VARIABLES<a name='65'></font>
<font color=#447700>!   NSOIL      NUMBER OF SOIL LAYERS (AT LEAST 2, AND NOT GREATER THAN<a name='66'></font>
<font color=#447700>!                PARAMETER NSOLD SET BELOW)<a name='67'></font>
<font color=#447700>!   SLDPTH     THE THICKNESS OF EACH SOIL LAYER (M)<a name='68'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='69'></font>
<font color=#447700>! 3. FORCING DATA (F):<a name='70'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='71'></font>
<font color=#447700>!   LWDN       LW DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET LONGWAVE)<a name='72'></font>
<font color=#447700>!   SOLNET     NET DOWNWARD SOLAR RADIATION ((W M-2; POSITIVE)<a name='73'></font>
<font color=#447700>!   SFCPRS     PRESSURE AT HEIGHT ZLVL ABOVE GROUND (PASCALS)<a name='74'></font>
<font color=#447700>!   PRCP       PRECIP RATE (KG M-2 S-1) (NOTE, THIS IS A RATE)<a name='75'></font>
<font color=#447700>!   SFCTMP     AIR TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND<a name='76'></font>
<font color=#447700>!   TH2        AIR POTENTIAL TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND<a name='77'></font>
<font color=#447700>!   Q2         MIXING RATIO AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)<a name='78'></font>
<font color=#447700>!   FFROZP     FRACTION OF FROZEN PRECIPITATION<a name='79'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='80'></font>
<font color=#447700>! 4. OTHER FORCING (INPUT) DATA (I):<a name='81'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='82'></font>
<font color=#447700>!   Q2SAT      SAT SPECIFIC HUMIDITY AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)<a name='83'></font>
<font color=#447700>!   DQSDT2     SLOPE OF SAT SPECIFIC HUMIDITY CURVE AT T=SFCTMP<a name='84'></font>
<font color=#447700>!                (KG KG-1 K-1)<a name='85'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='86'></font>
<font color=#447700>! 5. CANOPY/SOIL CHARACTERISTICS (S):<a name='87'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='88'></font>
<font color=#447700>!   ALB        BACKROUND SNOW-FREE SURFACE ALBEDO (FRACTION), FOR JULIAN<a name='89'></font>
<font color=#447700>!                DAY OF YEAR (USUALLY FROM TEMPORAL INTERPOLATION OF<a name='90'></font>
<font color=#447700>!                MONTHLY MEAN VALUES' CALLING PROG MAY OR MAY NOT<a name='91'></font>
<font color=#447700>!                INCLUDE DIURNAL SUN ANGLE EFFECT)<a name='92'></font>
<font color=#447700>!   SNOALB     UPPER BOUND ON MAXIMUM ALBEDO OVER DEEP SNOW (E.G. FROM<a name='93'></font>
<font color=#447700>!                ROBINSON AND KUKLA, 1985, J. CLIM. &amp; APPL. METEOR.)<a name='94'></font>
<font color=#447700>!   TBOT       BOTTOM SOIL TEMPERATURE (LOCAL YEARLY-MEAN SFC AIR<a name='95'></font>
<font color=#447700>!                TEMPERATURE)<a name='96'></font>
<font color=#447700>!   Z0BRD      Background fixed roughness length (M)<a name='97'></font>
<font color=#447700>!   Z0         Time varying roughness length (M) as function of snow depth<a name='98'></font>
<font color=#447700>!   EMBRD      Background surface emissivity (between 0 and 1)<a name='99'></font>
<font color=#447700>!   EMISSI     Surface emissivity (between 0 and 1)<a name='100'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='101'></font>
<font color=#447700>! 6. HISTORY (STATE) VARIABLES (H):<a name='102'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='103'></font>
<font color=#447700>!  T1          GROUND/CANOPY/SNOWPACK) EFFECTIVE SKIN TEMPERATURE (K)<a name='104'></font>
<font color=#447700>!  STC(NSOIL)  SOIL TEMP (K)<a name='105'></font>
<font color=#447700>!  SNOWH       ACTUAL SNOW DEPTH (M)<a name='106'></font>
<font color=#447700>!  SNEQV       LIQUID WATER-EQUIVALENT SNOW DEPTH (M)<a name='107'></font>
<font color=#447700>!                NOTE: SNOW DENSITY = SNEQV/SNOWH<a name='108'></font>
<font color=#447700>!  ALBEDO      SURFACE ALBEDO INCLUDING SNOW EFFECT (UNITLESS FRACTION)<a name='109'></font>
<font color=#447700>!                =SNOW-FREE ALBEDO (ALB) WHEN SNEQV=0, OR<a name='110'></font>
<font color=#447700>!                =FCT(MSNOALB,ALB,SHDFAC,SHDMIN) WHEN SNEQV&gt;0<a name='111'></font>
<font color=#447700>!  CH          SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE<a name='112'></font>
<font color=#447700>!                (M S-1); NOTE: CH IS TECHNICALLY A CONDUCTANCE SINCE<a name='113'></font>
<font color=#447700>!                IT HAS BEEN MULTIPLIED BY WIND SPEED.<a name='114'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='115'></font>
<font color=#447700>! 7. OUTPUT (O):<a name='116'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='117'></font>
<font color=#447700>! OUTPUT VARIABLES NECESSARY FOR A COUPLED NUMERICAL WEATHER PREDICTION<a name='118'></font>
<font color=#447700>! MODEL, E.G. NOAA/NWS/NCEP MESOSCALE ETA MODEL.  FOR THIS APPLICATION,<a name='119'></font>
<font color=#447700>! THE REMAINING OUTPUT/DIAGNOSTIC/PARAMETER BLOCKS BELOW ARE NOT<a name='120'></font>
<font color=#447700>! NECESSARY.  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.<a name='121'></font>
<font color=#447700>!   ETA        ACTUAL LATENT HEAT FLUX (W m-2: NEGATIVE, IF UP FROM<a name='122'></font>
<font color=#447700>!              SURFACE)<a name='123'></font>
<font color=#447700>!  ETA_KINEMATIC atctual latent heat flux in Kg m-2 s-1<a name='124'></font>
<font color=#447700>!   SHEAT      SENSIBLE HEAT FLUX (W M-2: NEGATIVE, IF UPWARD FROM<a name='125'></font>
<font color=#447700>!              SURFACE)<a name='126'></font>
<font color=#447700>!   FDOWN      Radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN<a name='127'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='128'></font>
<font color=#447700>!   ESNOW      SUBLIMATION FROM (OR DEPOSITION TO IF &lt;0) SNOWPACK<a name='129'></font>
<font color=#447700>!                (W m-2)<a name='130'></font>
<font color=#447700>!   DEW        DEWFALL (OR FROSTFALL FOR T&lt;273.15) (M)<a name='131'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='132'></font>
<font color=#447700>!   ETP        POTENTIAL EVAPORATION (W m-2)<a name='133'></font>
<font color=#447700>!   SSOIL      SOIL HEAT FLUX (W M-2: NEGATIVE IF DOWNWARD FROM SURFACE)<a name='134'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='135'></font>
<font color=#447700>!   FLX1       PRECIP-SNOW SFC (W M-2)<a name='136'></font>
<font color=#447700>!   FLX2       FREEZING RAIN LATENT HEAT FLUX (W M-2)<a name='137'></font>
<font color=#447700>!   FLX3       PHASE-CHANGE HEAT FLUX FROM SNOWMELT (W M-2)<a name='138'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='139'></font>
<font color=#447700>!   SNOMLT     SNOW MELT (M) (WATER EQUIVALENT)<a name='140'></font>
<font color=#447700>!   SNCOVR     FRACTIONAL SNOW COVER (UNITLESS FRACTION, 0-1)<a name='141'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='142'></font>
<font color=#447700>!   RUNOFF1    SURFACE RUNOFF (M S-1), NOT INFILTRATING THE SURFACE<a name='143'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='144'></font>
<font color=#447700>! 8. DIAGNOSTIC OUTPUT (D):<a name='145'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='146'></font>
<font color=#447700>!   Q1         Effective mixing ratio at surface (kg kg-1), used for<a name='147'></font>
<font color=#447700>!              diagnosing the mixing ratio at 2 meter for coupled model<a name='148'></font>
<font color=#447700>!  Documentation for SNOTIME1 and SNOABL2 ?????<a name='149'></font>
<font color=#447700>!  What categories of arguments do these variables fall into ????<a name='150'></font>
<font color=#447700>!  Documentation for RIBB ?????<a name='151'></font>
<font color=#447700>!  What category of argument does RIBB fall into ?????<a name='152'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='153'></font>
<a name='154'>
    IMPLICIT NONE<a name='155'>
<font color=#447700>! ----------------------------------------------------------------------<a name='156'></font>
    integer, intent(in) ::  iiloc, jjloc<a name='157'>
    INTEGER, INTENT(IN) ::  ISICE<a name='158'>
<font color=#447700>! ----------------------------------------------------------------------<a name='159'></font>
    LOGICAL             ::  FRZGRA, SNOWNG<a name='160'>
<a name='161'>
<font color=#447700>! ----------------------------------------------------------------------<a name='162'></font>
<font color=#447700>! 1. CONFIGURATION INFORMATION (C):<a name='163'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='164'></font>
    INTEGER, INTENT(IN) ::  NSOIL<a name='165'>
    INTEGER             ::  KZ<a name='166'>
<a name='167'>
<font color=#447700>! ----------------------------------------------------------------------<a name='168'></font>
<font color=#447700>! 2. LOGICAL:<a name='169'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='170'></font>
<a name='171'>
    REAL, INTENT(IN)   :: DT,DQSDT2,LWDN,PRCP,     &amp;<a name='172'>
         &amp;                Q2,Q2SAT,SFCPRS,SFCTMP, SNOALB,          &amp;<a name='173'>
         &amp;                SOLNET,TBOT,TH2,ZLVL,FFROZP<a name='174'>
    REAL, INTENT(OUT)  :: EMBRD, ALBEDO<a name='175'>
    REAL, INTENT(INOUT):: CH,SNEQV,SNCOVR,SNOWH,T1,Z0BRD,EMISSI,ALB<a name='176'>
    REAL, INTENT(INOUT):: SNOTIME1<a name='177'>
    REAL, INTENT(INOUT):: RIBB<a name='178'>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)    :: SLDPTH<a name='179'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) ::  STC<a name='180'>
    REAL, DIMENSION(1:NSOIL) ::   ZSOIL<a name='181'>
<a name='182'>
    REAL,INTENT(OUT)   :: ETA_KINEMATIC,DEW,ESNOW,ETA,  &amp;<a name='183'>
         &amp;                ETP,FLX1,FLX2,FLX3,SHEAT,RUNOFF1,    &amp;<a name='184'>
         &amp;                SSOIL,SNOMLT,FDOWN,Q1<a name='185'>
    REAL               :: DF1,DSOIL,DTOT,FRCSNO,FRCSOI,          &amp;<a name='186'>
         &amp;                PRCP1,RCH,RR,RSNOW,SNDENS,SNCOND,SN_NEW,     &amp;<a name='187'>
         &amp;                T1V,T24,T2V,TH2V,TSNOW,Z0,PRCPF,RHO<a name='188'>
<a name='189'>
<font color=#447700>! ----------------------------------------------------------------------<a name='190'></font>
<font color=#447700>! DECLARATIONS - PARAMETERS<a name='191'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='192'></font>
    REAL, PARAMETER :: TFREEZ = 273.15<a name='193'>
    REAL, PARAMETER :: LVH2O = 2.501E+6<a name='194'>
    REAL, PARAMETER :: LSUBS = 2.83E+6<a name='195'>
    REAL, PARAMETER :: R = 287.04<a name='196'>
<a name='197'>
<font color=#447700>! ----------------------------------------------------------------------<a name='198'></font>
    iloc = iiloc<a name='199'>
    jloc = jjloc<a name='200'>
<font color=#447700>! ----------------------------------------------------------------------<a name='201'></font>
    ZSOIL (1) = - SLDPTH (1)<a name='202'>
    DO KZ = 2,NSOIL<a name='203'>
       ZSOIL (KZ) = - SLDPTH (KZ) + ZSOIL (KZ -1)<a name='204'>
    END DO<a name='205'>
<a name='206'>
<font color=#447700>! ----------------------------------------------------------------------<a name='207'></font>
<font color=#447700>! IF S.W.E. (SNEQV) BELOW THRESHOLD LOWER BOUND (0.10 M FOR GLACIAL <a name='208'></font>
<font color=#447700>! ICE), THEN SET AT LOWER BOUND<a name='209'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='210'></font>
    IF ( SNEQV &lt; 0.10 ) THEN<a name='211'>
       SNEQV = 0.10<a name='212'>
       SNOWH = 0.50<a name='213'>
    ENDIF<a name='214'>
<font color=#447700>! ----------------------------------------------------------------------<a name='215'></font>
<font color=#447700>! IF INPUT SNOWPACK IS NONZERO, THEN COMPUTE SNOW DENSITY "SNDENS" AND<a name='216'></font>
<font color=#447700>! SNOW THERMAL CONDUCTIVITY "SNCOND"<a name='217'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='218'></font>
    SNDENS = SNEQV / SNOWH<a name='219'>
    IF(SNDENS &gt; 1.0) THEN<a name='220'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1176"> ( 'Physical snow depth is less than snow water equiv.' )<a name='221'>
    ENDIF<a name='222'>
<a name='223'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_5"> (SNCOND,SNDENS)<a name='224'>
<font color=#447700>! ----------------------------------------------------------------------<a name='225'></font>
<font color=#447700>! DETERMINE IF IT'S PRECIPITATING AND WHAT KIND OF PRECIP IT IS.<a name='226'></font>
<font color=#447700>! IF IT'S PRCPING AND THE AIR TEMP IS COLDER THAN 0 C, IT'S SNOWING!<a name='227'></font>
<font color=#447700>! IF IT'S PRCPING AND THE AIR TEMP IS WARMER THAN 0 C, BUT THE GRND<a name='228'></font>
<font color=#447700>! TEMP IS COLDER THAN 0 C, FREEZING RAIN IS PRESUMED TO BE FALLING.<a name='229'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='230'></font>
<a name='231'>
    SNOWNG = .FALSE.<a name='232'>
    FRZGRA = .FALSE.<a name='233'>
    IF (PRCP &gt; 0.0) THEN<a name='234'>
<font color=#447700>! ----------------------------------------------------------------------<a name='235'></font>
<font color=#447700>! Snow defined when fraction of frozen precip (FFROZP) &gt; 0.5,<a name='236'></font>
<font color=#447700>! passed in from model microphysics.<a name='237'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='238'></font>
       IF (FFROZP .GT. 0.5) THEN<a name='239'>
          SNOWNG = .TRUE.<a name='240'>
       ELSE<a name='241'>
          IF (T1 &lt;= TFREEZ) FRZGRA = .TRUE.<a name='242'>
       END IF<a name='243'>
    END IF<a name='244'>
<font color=#447700>! ----------------------------------------------------------------------<a name='245'></font>
<font color=#447700>! IF EITHER PRCP FLAG IS SET, DETERMINE NEW SNOWFALL (CONVERTING PRCP<a name='246'></font>
<font color=#447700>! RATE FROM KG M-2 S-1 TO A LIQUID EQUIV SNOW DEPTH IN METERS) AND ADD<a name='247'></font>
<font color=#447700>! IT TO THE EXISTING SNOWPACK.<a name='248'></font>
<font color=#447700>! NOTE THAT SINCE ALL PRECIP IS ADDED TO SNOWPACK, NO PRECIP INFILTRATES<a name='249'></font>
<font color=#447700>! INTO THE SOIL SO THAT PRCP1 IS SET TO ZERO.<a name='250'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='251'></font>
    IF ( (SNOWNG) .OR. (FRZGRA) ) THEN<a name='252'>
       SN_NEW = PRCP * DT * 0.001<a name='253'>
       SNEQV = SNEQV + SN_NEW<a name='254'>
       PRCPF = 0.0<a name='255'>
<a name='256'>
<font color=#447700>! ----------------------------------------------------------------------<a name='257'></font>
<font color=#447700>! UPDATE SNOW DENSITY BASED ON NEW SNOWFALL, USING OLD AND NEW SNOW.<a name='258'></font>
<font color=#447700>! UPDATE SNOW THERMAL CONDUCTIVITY<a name='259'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='260'></font>
       CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOW_NEW'>SNOW_NEW</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_NEW_3"> (SFCTMP,SN_NEW,SNOWH,SNDENS)<a name='261'>
<a name='262'>
<font color=#447700>! ----------------------------------------------------------------------<a name='263'></font>
<font color=#447700>! kmh 09/04/2006 set Snow Density at 0.2 g/cm**3<a name='264'></font>
<font color=#447700>! for "cold permanent ice" or new "dry" snow<a name='265'></font>
<font color=#447700>! if soil temperature less than 268.15 K, treat as typical <a name='266'></font>
<font color=#447700>! Antarctic/Greenland snow firn<a name='267'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='268'></font>
       IF ( SNCOVR .GT. 0.99 ) THEN<a name='269'>
          IF ( STC(1) .LT. (TFREEZ - 5.) ) SNDENS = 0.2<a name='270'>
          IF ( SNOWNG .AND. (T1.LT.273.) .AND. (SFCTMP.LT.273.) ) SNDENS=0.2<a name='271'>
       ENDIF<a name='272'>
<a name='273'>
       CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#CSNOW'>CSNOW</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CSNOW_6"> (SNCOND,SNDENS)<a name='274'>
<a name='275'>
<font color=#447700>! ----------------------------------------------------------------------<a name='276'></font>
<font color=#447700>! PRECIP IS LIQUID (RAIN), HENCE SAVE IN THE PRECIP VARIABLE THAT<a name='277'></font>
<font color=#447700>! LATER CAN WHOLELY OR PARTIALLY INFILTRATE THE SOIL<a name='278'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='279'></font>
    ELSE<a name='280'>
       PRCPF = PRCP<a name='281'>
    ENDIF<a name='282'>
<a name='283'>
<font color=#447700>! ----------------------------------------------------------------------<a name='284'></font>
<font color=#447700>! DETERMINE SNOW FRACTIONAL COVERAGE.<a name='285'></font>
<font color=#447700>!      KWM:  Set SNCOVR to 1.0 because SNUP is set small in VEGPARM.TBL,<a name='286'></font>
<font color=#447700>!      and SNEQV is at least 0.1 (as set above)<a name='287'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='288'></font>
    SNCOVR = 1.0 <a name='289'>
<a name='290'>
<font color=#447700>! ----------------------------------------------------------------------<a name='291'></font>
<font color=#447700>! DETERMINE SURFACE ALBEDO MODIFICATION DUE TO SNOWDEPTH STATE.<a name='292'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='293'></font>
<a name='294'>
    CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#ALCALC'>ALCALC</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALCALC_2"> (ALB,SNOALB,EMBRD,T1,ALBEDO,EMISSI,   &amp;<a name='295'>
         &amp;       DT,SNOWNG,SNOTIME1) <a name='296'>
<a name='297'>
<font color=#447700>! ----------------------------------------------------------------------<a name='298'></font>
<font color=#447700>! THERMAL CONDUCTIVITY <a name='299'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='300'></font>
    DF1 = SNCOND<a name='301'>
<a name='302'>
    DSOIL = - (0.5 * ZSOIL (1))<a name='303'>
    DTOT = SNOWH + DSOIL<a name='304'>
    FRCSNO = SNOWH / DTOT<a name='305'>
<a name='306'>
<font color=#447700>! 1. HARMONIC MEAN (SERIES FLOW)<a name='307'></font>
<font color=#447700>!        DF1 = (SNCOND*DF1)/(FRCSOI*SNCOND+FRCSNO*DF1)<a name='308'></font>
    FRCSOI = DSOIL / DTOT<a name='309'>
<a name='310'>
<font color=#447700>! 3. GEOMETRIC MEAN (INTERMEDIATE BETWEEN HARMONIC AND ARITHMETIC MEAN)<a name='311'></font>
<font color=#447700>!        DF1 = (SNCOND**FRCSNO)*(DF1**FRCSOI)<a name='312'></font>
    DF1 = FRCSNO * SNCOND + FRCSOI * DF1<a name='313'>
<a name='314'>
<font color=#447700>! ----------------------------------------------------------------------<a name='315'></font>
<font color=#447700>! CALCULATE SUBSURFACE HEAT FLUX, SSOIL, FROM FINAL THERMAL DIFFUSIVITY<a name='316'></font>
<font color=#447700>! OF SURFACE MEDIUMS, DF1 ABOVE, AND SKIN TEMPERATURE AND TOP<a name='317'></font>
<font color=#447700>! MID-LAYER SOIL TEMPERATURE<a name='318'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='319'></font>
    IF ( DTOT .GT. 2.*DSOIL ) then<a name='320'>
       DTOT = 2.*DSOIL<a name='321'>
    ENDIF<a name='322'>
    SSOIL = DF1 * ( T1 - STC(1) ) / DTOT<a name='323'>
<a name='324'>
<font color=#447700>! ----------------------------------------------------------------------<a name='325'></font>
<font color=#447700>! DETERMINE SURFACE ROUGHNESS OVER SNOWPACK USING SNOW CONDITION FROM<a name='326'></font>
<font color=#447700>! THE PREVIOUS TIMESTEP.<a name='327'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='328'></font>
<a name='329'>
    CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWZ0'>SNOWZ0</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWZ0_4"> (Z0,Z0BRD,SNOWH)<a name='330'>
<a name='331'>
<font color=#447700>! ----------------------------------------------------------------------<a name='332'></font>
<font color=#447700>! CALCULATE TOTAL DOWNWARD RADIATION (SOLAR PLUS LONGWAVE) NEEDED IN<a name='333'></font>
<font color=#447700>! PENMAN EP SUBROUTINE THAT FOLLOWS<a name='334'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='335'></font>
<a name='336'>
    FDOWN = SOLNET + LWDN<a name='337'>
<a name='338'>
<font color=#447700>! ----------------------------------------------------------------------<a name='339'></font>
<font color=#447700>! CALC VIRTUAL TEMPS AND VIRTUAL POTENTIAL TEMPS NEEDED BY SUBROUTINES<a name='340'></font>
<font color=#447700>! PENMAN.<a name='341'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='342'></font>
<a name='343'>
    T2V = SFCTMP * (1.0+ 0.61 * Q2 )<a name='344'>
    RHO = SFCPRS / (RD * T2V)<a name='345'>
    RCH = RHO * 1004.6 * CH<a name='346'>
    T24 = SFCTMP * SFCTMP * SFCTMP * SFCTMP<a name='347'>
<a name='348'>
<font color=#447700>! ----------------------------------------------------------------------<a name='349'></font>
<font color=#447700>! CALL PENMAN SUBROUTINE TO CALCULATE POTENTIAL EVAPORATION (ETP), AND<a name='350'></font>
<font color=#447700>! OTHER PARTIAL PRODUCTS AND SUMS SAVE IN COMMON/RITE FOR LATER<a name='351'></font>
<font color=#447700>! CALCULATIONS.<a name='352'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='353'></font>
<a name='354'>
    <font color=#447700>! PENMAN returns ETP, FLX2, and RR<a name='355'></font>
    CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#PENMAN'>PENMAN</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PENMAN_3"> (SFCTMP,SFCPRS,CH,TH2,PRCP,FDOWN,T24,SSOIL,     &amp;<a name='356'>
         &amp;       Q2,Q2SAT,ETP,RCH,RR,SNOWNG,FRZGRA,             &amp;<a name='357'>
         &amp;       DQSDT2,FLX2,EMISSI,T1)<a name='358'>
<a name='359'>
    CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC'>SNOPAC</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SFLX_GLACIAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOPAC_3"> (ETP,ETA,PRCP,PRCPF,SNOWNG,NSOIL,DT,DF1,        &amp;<a name='360'>
         &amp;       Q2,T1,SFCTMP,T24,TH2,FDOWN,SSOIL,STC,          &amp;<a name='361'>
         &amp;       SFCPRS,RCH,RR,SNEQV,SNDENS,SNOWH,ZSOIL,TBOT,   &amp;<a name='362'>
         &amp;       SNOMLT,DEW,FLX1,FLX2,FLX3,ESNOW,EMISSI,RIBB)<a name='363'>
<a name='364'>
<font color=#447700>!   ETA_KINEMATIC =  ESNOW<a name='365'></font>
    ETA_KINEMATIC =  ETP<a name='366'>
<a name='367'>
<font color=#447700>! ----------------------------------------------------------------------<a name='368'></font>
<font color=#447700>! Effective mixing ratio at grnd level (skin)<a name='369'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='370'></font>
    Q1=Q2+ETA_KINEMATIC*CP/RCH<a name='371'>
<a name='372'>
<font color=#447700>! ----------------------------------------------------------------------<a name='373'></font>
<font color=#447700>! DETERMINE SENSIBLE HEAT (H) IN ENERGY UNITS (W M-2)<a name='374'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='375'></font>
    SHEAT = - (CH * CP * SFCPRS)/ (R * T2V) * ( TH2- T1 )<a name='376'>
<a name='377'>
<font color=#447700>! ----------------------------------------------------------------------<a name='378'></font>
<font color=#447700>! CONVERT EVAP TERMS FROM KINEMATIC (KG M-2 S-1) TO ENERGY UNITS (W M-2)<a name='379'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='380'></font>
    ESNOW = ESNOW * LSUBS<a name='381'>
    ETP   = ETP   * LSUBS<a name='382'>
    IF (ETP .GT. 0.) THEN<a name='383'>
       ETA = ESNOW<a name='384'>
    ELSE<a name='385'>
       ETA = ETP<a name='386'>
    ENDIF<a name='387'>
<a name='388'>
<font color=#447700>! ----------------------------------------------------------------------<a name='389'></font>
<font color=#447700>! CONVERT THE SIGN OF SOIL HEAT FLUX SO THAT:<a name='390'></font>
<font color=#447700>!   SSOIL&gt;0: WARM THE SURFACE  (NIGHT TIME)<a name='391'></font>
<font color=#447700>!   SSOIL&lt;0: COOL THE SURFACE  (DAY TIME)<a name='392'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='393'></font>
    SSOIL = -1.0* SSOIL<a name='394'>
<a name='395'>
<font color=#447700>! ----------------------------------------------------------------------<a name='396'></font>
<font color=#447700>! FOR THE CASE OF GLACIAL-ICE, ADD ANY SNOWMELT DIRECTLY TO SURFACE <a name='397'></font>
<font color=#447700>! RUNOFF (RUNOFF1) SINCE THERE IS NO SOIL MEDIUM<a name='398'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='399'></font>
    RUNOFF1 = SNOMLT / DT<a name='400'>
<a name='401'>
<font color=#447700>! ----------------------------------------------------------------------<a name='402'></font>
  END SUBROUTINE SFLX_GLACIAL<a name='403'>
<font color=#447700>! ----------------------------------------------------------------------<a name='404'></font>
<a name='405'>
<A NAME='ALCALC'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#ALCALC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='406'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ALCALC</font> (ALB,SNOALB,EMBRD,TSNOW,ALBEDO,EMISSI,   &amp; <A href='../../call_to/ALCALC.html' TARGET='index'>2</A><a name='407'>
       &amp;             DT,SNOWNG,SNOTIME1)<a name='408'>
<a name='409'>
<font color=#447700>! ----------------------------------------------------------------------<a name='410'></font>
<font color=#447700>! CALCULATE ALBEDO INCLUDING SNOW EFFECT (0 -&gt; 1)<a name='411'></font>
<font color=#447700>!   ALB     SNOWFREE ALBEDO<a name='412'></font>
<font color=#447700>!   SNOALB  MAXIMUM (DEEP) SNOW ALBEDO<a name='413'></font>
<font color=#447700>!   ALBEDO  SURFACE ALBEDO INCLUDING SNOW EFFECT<a name='414'></font>
<font color=#447700>!   TSNOW   SNOW SURFACE TEMPERATURE (K)<a name='415'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='416'></font>
    IMPLICIT NONE<a name='417'>
<a name='418'>
<font color=#447700>! ----------------------------------------------------------------------<a name='419'></font>
<font color=#447700>! SNOALB IS ARGUMENT REPRESENTING MAXIMUM ALBEDO OVER DEEP SNOW,<a name='420'></font>
<font color=#447700>! AS PASSED INTO SFLX, AND ADAPTED FROM THE SATELLITE-BASED MAXIMUM<a name='421'></font>
<font color=#447700>! SNOW ALBEDO FIELDS PROVIDED BY D. ROBINSON AND G. KUKLA<a name='422'></font>
<font color=#447700>! (1985, JCAM, VOL 24, 402-411)<a name='423'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='424'></font>
    REAL,    INTENT(IN)    :: ALB, SNOALB, EMBRD, TSNOW<a name='425'>
    REAL,    INTENT(IN)    :: DT<a name='426'>
    LOGICAL, INTENT(IN)    :: SNOWNG<a name='427'>
    REAL,    INTENT(INOUT) :: SNOTIME1<a name='428'>
    REAL,    INTENT(OUT)   :: ALBEDO, EMISSI<a name='429'>
    REAL                   :: SNOALB2<a name='430'>
    REAL                   :: TM,SNOALB1<a name='431'>
    REAL,    PARAMETER     :: SNACCA=0.94,SNACCB=0.58,SNTHWA=0.82,SNTHWB=0.46<a name='432'>
<font color=#447700>! turn off vegetation effect<a name='433'></font>
<font color=#447700>!      ALBEDO = ALB + (1.0- (SHDFAC - SHDMIN))* SNCOVR * (SNOALB - ALB)<a name='434'></font>
<font color=#447700>!      ALBEDO = (1.0-SNCOVR)*ALB + SNCOVR*SNOALB !this is equivalent to below<a name='435'></font>
    ALBEDO = ALB + (SNOALB-ALB)<a name='436'>
    EMISSI = EMBRD + (EMISSI_S - EMBRD)<a name='437'>
<a name='438'>
<font color=#447700>!     BASE FORMULATION (DICKINSON ET AL., 1986, COGLEY ET AL., 1990)<a name='439'></font>
<font color=#447700>!          IF (TSNOW.LE.263.16) THEN<a name='440'></font>
<font color=#447700>!            ALBEDO=SNOALB<a name='441'></font>
<font color=#447700>!          ELSE<a name='442'></font>
<font color=#447700>!            IF (TSNOW.LT.273.16) THEN<a name='443'></font>
<font color=#447700>!              TM=0.1*(TSNOW-263.16)<a name='444'></font>
<font color=#447700>!              SNOALB1=0.5*((0.9-0.2*(TM**3))+(0.8-0.16*(TM**3)))<a name='445'></font>
<font color=#447700>!            ELSE<a name='446'></font>
<font color=#447700>!              SNOALB1=0.67<a name='447'></font>
<font color=#447700>!             IF(SNCOVR.GT.0.95) SNOALB1= 0.6<a name='448'></font>
<font color=#447700>!             SNOALB1 = ALB + SNCOVR*(SNOALB-ALB)<a name='449'></font>
<font color=#447700>!            ENDIF<a name='450'></font>
<font color=#447700>!          ENDIF<a name='451'></font>
<font color=#447700>!            ALBEDO = ALB + SNCOVR*(SNOALB1-ALB)<a name='452'></font>
<a name='453'>
<font color=#447700>!     ISBA FORMULATION (VERSEGHY, 1991; BAKER ET AL., 1990)<a name='454'></font>
<font color=#447700>!          SNOALB1 = SNOALB+COEF*(0.85-SNOALB)<a name='455'></font>
<font color=#447700>!          SNOALB2=SNOALB1<a name='456'></font>
<font color=#447700>!!m          LSTSNW=LSTSNW+1<a name='457'></font>
<font color=#447700>!          SNOTIME1 = SNOTIME1 + DT<a name='458'></font>
<font color=#447700>!          IF (SNOWNG) THEN<a name='459'></font>
<font color=#447700>!             SNOALB2=SNOALB<a name='460'></font>
<font color=#447700>!!m             LSTSNW=0<a name='461'></font>
<font color=#447700>!             SNOTIME1 = 0.0<a name='462'></font>
<font color=#447700>!          ELSE<a name='463'></font>
<font color=#447700>!            IF (TSNOW.LT.273.16) THEN<a name='464'></font>
<font color=#447700>!!              SNOALB2=SNOALB-0.008*LSTSNW*DT/86400<a name='465'></font>
<font color=#447700>!!m              SNOALB2=SNOALB-0.008*SNOTIME1/86400<a name='466'></font>
<font color=#447700>!              SNOALB2=(SNOALB2-0.65)*EXP(-0.05*DT/3600)+0.65<a name='467'></font>
<font color=#447700>!!              SNOALB2=(ALBEDO-0.65)*EXP(-0.01*DT/3600)+0.65<a name='468'></font>
<font color=#447700>!            ELSE<a name='469'></font>
<font color=#447700>!              SNOALB2=(SNOALB2-0.5)*EXP(-0.0005*DT/3600)+0.5<a name='470'></font>
<font color=#447700>!!              SNOALB2=(SNOALB-0.5)*EXP(-0.24*LSTSNW*DT/86400)+0.5<a name='471'></font>
<font color=#447700>!!m              SNOALB2=(SNOALB-0.5)*EXP(-0.24*SNOTIME1/86400)+0.5<a name='472'></font>
<font color=#447700>!            ENDIF<a name='473'></font>
<font color=#447700>!          ENDIF<a name='474'></font>
<font color=#447700>!<a name='475'></font>
<font color=#447700>!!               print*,'SNOALB2',SNOALB2,'ALBEDO',ALBEDO,'DT',DT<a name='476'></font>
<font color=#447700>!          ALBEDO = ALB + SNCOVR*(SNOALB2-ALB)<a name='477'></font>
<font color=#447700>!          IF (ALBEDO .GT. SNOALB2) ALBEDO=SNOALB2<a name='478'></font>
<font color=#447700>!!m          LSTSNW1=LSTSNW<a name='479'></font>
<font color=#447700>!!          SNOTIME = SNOTIME1<a name='480'></font>
<a name='481'>
<font color=#447700>! formulation by Livneh<a name='482'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='483'></font>
<font color=#447700>! SNOALB IS CONSIDERED AS THE MAXIMUM SNOW ALBEDO FOR NEW SNOW, AT<a name='484'></font>
<font color=#447700>! A VALUE OF 85%. SNOW ALBEDO CURVE DEFAULTS ARE FROM BRAS P.263. SHOULD<a name='485'></font>
<font color=#447700>! NOT BE CHANGED EXCEPT FOR SERIOUS PROBLEMS WITH SNOW MELT.<a name='486'></font>
<font color=#447700>! TO IMPLEMENT ACCUMULATIN PARAMETERS, SNACCA AND SNACCB, ASSERT THAT IT<a name='487'></font>
<font color=#447700>! IS INDEED ACCUMULATION SEASON. I.E. THAT SNOW SURFACE TEMP IS BELOW<a name='488'></font>
<font color=#447700>! ZERO AND THE DATE FALLS BETWEEN OCTOBER AND FEBRUARY<a name='489'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='490'></font>
    SNOALB1 = SNOALB+LVCOEF_DATA*(0.85-SNOALB)<a name='491'>
    SNOALB2=SNOALB1<a name='492'>
<font color=#447700>! ---------------- Initial LSTSNW --------------------------------------<a name='493'></font>
    IF (SNOWNG) THEN<a name='494'>
       SNOTIME1 = 0.<a name='495'>
    ELSE<a name='496'>
       SNOTIME1=SNOTIME1+DT<a name='497'>
<font color=#447700>!               IF (TSNOW.LT.273.16) THEN<a name='498'></font>
       SNOALB2=SNOALB1*(SNACCA**((SNOTIME1/86400.0)**SNACCB))<a name='499'>
<font color=#447700>!               ELSE<a name='500'></font>
<font color=#447700>!                  SNOALB2 =SNOALB1*(SNTHWA**((SNOTIME1/86400.0)**SNTHWB))<a name='501'></font>
<font color=#447700>!               ENDIF<a name='502'></font>
    ENDIF<a name='503'>
<a name='504'>
    SNOALB2 = MAX ( SNOALB2, ALB )<a name='505'>
    ALBEDO = ALB + (SNOALB2-ALB)<a name='506'>
    IF (ALBEDO .GT. SNOALB2) ALBEDO=SNOALB2<a name='507'>
<a name='508'>
<font color=#447700>!          IF (TSNOW.LT.273.16) THEN<a name='509'></font>
<font color=#447700>!            ALBEDO=SNOALB-0.008*DT/86400<a name='510'></font>
<font color=#447700>!          ELSE<a name='511'></font>
<font color=#447700>!            ALBEDO=(SNOALB-0.5)*EXP(-0.24*DT/86400)+0.5<a name='512'></font>
<font color=#447700>!          ENDIF<a name='513'></font>
<a name='514'>
<font color=#447700>!      IF (ALBEDO &gt; SNOALB) ALBEDO = SNOALB<a name='515'></font>
<a name='516'>
<font color=#447700>! ----------------------------------------------------------------------<a name='517'></font>
  END SUBROUTINE ALCALC<a name='518'>
<font color=#447700>! ----------------------------------------------------------------------<a name='519'></font>
<a name='520'>
<A NAME='CSNOW'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#CSNOW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='521'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>CSNOW</font> (SNCOND,DSNOW) <A href='../../call_to/CSNOW.html' TARGET='index'>7</A><a name='522'>
<a name='523'>
<font color=#447700>! ----------------------------------------------------------------------<a name='524'></font>
<font color=#447700>! CALCULATE SNOW TERMAL CONDUCTIVITY<a name='525'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='526'></font>
    IMPLICIT NONE<a name='527'>
    REAL, INTENT(IN)  :: DSNOW<a name='528'>
    REAL, INTENT(OUT) :: SNCOND<a name='529'>
    REAL              :: C<a name='530'>
    REAL, PARAMETER   :: UNIT = 0.11631<a name='531'>
<a name='532'>
<font color=#447700>! ----------------------------------------------------------------------<a name='533'></font>
<font color=#447700>! SNCOND IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)<a name='534'></font>
<font color=#447700>! CSNOW IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)<a name='535'></font>
<font color=#447700>! BASIC VERSION IS DYACHKOVA EQUATION (1960), FOR RANGE 0.1-0.4<a name='536'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='537'></font>
    C = 0.328*10** (2.25* DSNOW)<a name='538'>
<font color=#447700>!      CSNOW=UNIT*C<a name='539'></font>
<a name='540'>
<font color=#447700>! ----------------------------------------------------------------------<a name='541'></font>
<font color=#447700>! DE VAUX EQUATION (1933), IN RANGE 0.1-0.6<a name='542'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='543'></font>
<font color=#447700>!      SNCOND=0.0293*(1.+100.*DSNOW**2)<a name='544'></font>
<font color=#447700>!      CSNOW=0.0293*(1.+100.*DSNOW**2)<a name='545'></font>
<a name='546'>
<font color=#447700>! ----------------------------------------------------------------------<a name='547'></font>
<font color=#447700>! E. ANDERSEN FROM FLERCHINGER<a name='548'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='549'></font>
<font color=#447700>!      SNCOND=0.021+2.51*DSNOW**2<a name='550'></font>
<font color=#447700>!      CSNOW=0.021+2.51*DSNOW**2<a name='551'></font>
<a name='552'>
<font color=#447700>!      SNCOND = UNIT * C<a name='553'></font>
<font color=#447700>! double snow thermal conductivity<a name='554'></font>
    SNCOND = 2.0 * UNIT * C<a name='555'>
<a name='556'>
<font color=#447700>! ----------------------------------------------------------------------<a name='557'></font>
  END SUBROUTINE CSNOW<a name='558'>
<font color=#447700>! ----------------------------------------------------------------------<a name='559'></font>
<a name='560'>
<A NAME='HRTICE'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#HRTICE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='561'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>HRTICE</font> (RHSTS,STC,TBOT,NSOIL,ZSOIL,YY,ZZ1,DF1,AI,BI,CI) <A href='../../call_to/HRTICE.html' TARGET='index'>2</A><a name='562'>
<a name='563'>
<font color=#447700>! ----------------------------------------------------------------------<a name='564'></font>
<font color=#447700>! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL<a name='565'></font>
<font color=#447700>! THERMAL DIFFUSION EQUATION IN THE CASE OF SEA-ICE (ICE=1) OR GLACIAL<a name='566'></font>
<font color=#447700>! ICE (ICE=-1). COMPUTE (PREPARE) THE MATRIX COEFFICIENTS FOR THE<a name='567'></font>
<font color=#447700>! TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.<a name='568'></font>
<font color=#447700>!<a name='569'></font>
<font color=#447700>! (NOTE:  THIS SUBROUTINE ONLY CALLED FOR SEA-ICE OR GLACIAL ICE, BUT<a name='570'></font>
<font color=#447700>! NOT FOR NON-GLACIAL LAND (ICE = 0).<a name='571'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='572'></font>
    IMPLICIT NONE<a name='573'>
<a name='574'>
<a name='575'>
    INTEGER,                  INTENT(IN)  :: NSOIL<a name='576'>
    REAL,                     INTENT(IN)  :: DF1,YY,ZZ1<a name='577'>
    REAL, DIMENSION(1:NSOIL), INTENT(OUT) :: AI, BI,CI<a name='578'>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)  :: STC, ZSOIL<a name='579'>
    REAL, DIMENSION(1:NSOIL), INTENT(OUT) :: RHSTS<a name='580'>
    REAL,                     INTENT(IN)  :: TBOT<a name='581'>
    INTEGER                :: K<a name='582'>
    REAL                   :: DDZ,DDZ2,DENOM,DTSDZ,DTSDZ2,SSOIL,HCPCT<a name='583'>
    REAL                   :: DF1K,DF1N<a name='584'>
    REAL                   :: ZMD<a name='585'>
    REAL, PARAMETER        :: ZBOT = -25.0<a name='586'>
<a name='587'>
<font color=#447700>! ----------------------------------------------------------------------<a name='588'></font>
<font color=#447700>! SET A NOMINAL UNIVERSAL VALUE OF GLACIAL-ICE SPECIFIC HEAT CAPACITY,<a name='589'></font>
<font color=#447700>!   HCPCT = 2100.0*900.0 = 1.89000E+6 (SOURCE:  BOB GRUMBINE, 2005)<a name='590'></font>
<font color=#447700>!   TBOT PASSED IN AS ARGUMENT, VALUE FROM GLOBAL DATA SET<a name='591'></font>
    <font color=#447700>!<a name='592'></font>
    <font color=#447700>! A least-squares fit for the four points provided by<a name='593'></font>
    <font color=#447700>! Keith Hines for the Yen (1981) values for Antarctic<a name='594'></font>
    <font color=#447700>! snow firn.<a name='595'></font>
    <font color=#447700>!<a name='596'></font>
    HCPCT = 1.E6 * (0.8194 - 0.1309*0.5*ZSOIL(1))<a name='597'>
    DF1K = DF1<a name='598'>
<a name='599'>
<font color=#447700>! ----------------------------------------------------------------------<a name='600'></font>
<font color=#447700>! THE INPUT ARGUMENT DF1 IS A UNIVERSALLY CONSTANT VALUE OF SEA-ICE<a name='601'></font>
<font color=#447700>! THERMAL DIFFUSIVITY, SET IN ROUTINE SNOPAC AS DF1 = 2.2.<a name='602'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='603'></font>
<font color=#447700>! SET ICE PACK DEPTH.  USE TBOT AS ICE PACK LOWER BOUNDARY TEMPERATURE<a name='604'></font>
<font color=#447700>! (THAT OF UNFROZEN SEA WATER AT BOTTOM OF SEA ICE PACK).  ASSUME ICE<a name='605'></font>
<font color=#447700>! PACK IS OF N=NSOIL LAYERS SPANNING A UNIFORM CONSTANT ICE PACK<a name='606'></font>
<font color=#447700>! THICKNESS AS DEFINED BY ZSOIL(NSOIL) IN ROUTINE SFLX.<a name='607'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='608'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='609'></font>
<font color=#447700>! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER<a name='610'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='611'></font>
    DDZ = 1.0 / ( -0.5 * ZSOIL (2) )<a name='612'>
    AI (1) = 0.0<a name='613'>
    CI (1) = (DF1 * DDZ) / (ZSOIL (1) * HCPCT)<a name='614'>
<a name='615'>
<font color=#447700>! ----------------------------------------------------------------------<a name='616'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT BTWN THE TOP AND 2ND SOIL LAYERS.<a name='617'></font>
<font color=#447700>! RECALC/ADJUST THE SOIL HEAT FLUX.  USE THE GRADIENT AND FLUX TO CALC<a name='618'></font>
<font color=#447700>! RHSTS FOR THE TOP SOIL LAYER.<a name='619'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='620'></font>
    BI (1) = - CI (1) + DF1/ (0.5 * ZSOIL (1) * ZSOIL (1) * HCPCT *    &amp;<a name='621'>
         &amp;   ZZ1)<a name='622'>
    DTSDZ = ( STC (1) - STC (2) ) / ( -0.5 * ZSOIL (2) )<a name='623'>
    SSOIL = DF1 * ( STC (1) - YY ) / ( 0.5 * ZSOIL (1) * ZZ1 )<a name='624'>
<a name='625'>
<font color=#447700>! ----------------------------------------------------------------------<a name='626'></font>
<font color=#447700>! INITIALIZE DDZ2<a name='627'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='628'></font>
    RHSTS (1) = ( DF1 * DTSDZ - SSOIL ) / ( ZSOIL (1) * HCPCT )<a name='629'>
<a name='630'>
<font color=#447700>! ----------------------------------------------------------------------<a name='631'></font>
<font color=#447700>! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS<a name='632'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='633'></font>
    DDZ2 = 0.0<a name='634'>
    DF1K = DF1<a name='635'>
    DF1N = DF1<a name='636'>
    DO K = 2,NSOIL<a name='637'>
<a name='638'>
       ZMD = 0.5 * (ZSOIL(K)+ZSOIL(K-1))<a name='639'>
       <font color=#447700>! For the land-ice case<a name='640'></font>
<font color=#447700>! kmh 09/03/2006 use Yen (1981)'s values for Antarctic snow firn<a name='641'></font>
<font color=#447700>!         IF ( K .eq. 2 ) HCPCT = 0.855108E6<a name='642'></font>
<font color=#447700>!         IF ( K .eq. 3 ) HCPCT = 0.922906E6<a name='643'></font>
<font color=#447700>!         IF ( K .eq. 4 ) HCPCT = 1.009986E6<a name='644'></font>
<a name='645'>
       <font color=#447700>! Least squares fit to the four points supplied by Keith Hines<a name='646'></font>
       <font color=#447700>! from Yen (1981) for Antarctic snow firn.  Not optimal, but<a name='647'></font>
       <font color=#447700>! probably better than just a constant.<a name='648'></font>
       HCPCT = 1.E6 * ( 0.8194 - 0.1309*ZMD )<a name='649'>
<a name='650'>
<font color=#447700>!         IF ( K .eq. 2 ) DF1N = 0.345356<a name='651'></font>
<font color=#447700>!         IF ( K .eq. 3 ) DF1N = 0.398777<a name='652'></font>
<font color=#447700>!         IF ( K .eq. 4 ) DF1N = 0.472653<a name='653'></font>
<a name='654'>
       <font color=#447700>! Least squares fit to the three points supplied by Keith Hines<a name='655'></font>
       <font color=#447700>! from Yen (1981) for Antarctic snow firn.  Not optimal, but<a name='656'></font>
       <font color=#447700>! probably better than just a constant.<a name='657'></font>
       DF1N = 0.32333 - ( 0.10073 * ZMD )<a name='658'>
<font color=#447700>! ----------------------------------------------------------------------<a name='659'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER.<a name='660'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='661'></font>
       IF (K /= NSOIL) THEN<a name='662'>
          DENOM = 0.5 * ( ZSOIL (K -1) - ZSOIL (K +1) )<a name='663'>
<a name='664'>
<font color=#447700>! ----------------------------------------------------------------------<a name='665'></font>
<font color=#447700>! CALC THE MATRIX COEF, CI, AFTER CALC'NG ITS PARTIAL PRODUCT.<a name='666'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='667'></font>
          DTSDZ2 = ( STC (K) - STC (K +1) ) / DENOM<a name='668'>
          DDZ2 = 2. / (ZSOIL (K -1) - ZSOIL (K +1))<a name='669'>
          CI (K) = - DF1N * DDZ2 / ( (ZSOIL (K -1) - ZSOIL (K))*HCPCT)<a name='670'>
<a name='671'>
<font color=#447700>! ----------------------------------------------------------------------<a name='672'></font>
<font color=#447700>! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THE LOWEST LAYER.<a name='673'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='674'></font>
       ELSE<a name='675'>
<a name='676'>
<font color=#447700>! ----------------------------------------------------------------------<a name='677'></font>
<font color=#447700>! SET MATRIX COEF, CI TO ZERO.<a name='678'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='679'></font>
          DTSDZ2 = (STC (K) - TBOT)/ (.5 * (ZSOIL (K -1) + ZSOIL (K)) &amp;<a name='680'>
               &amp;   - ZBOT)<a name='681'>
          CI (K) = 0.<a name='682'>
<font color=#447700>! ----------------------------------------------------------------------<a name='683'></font>
<font color=#447700>! CALC RHSTS FOR THIS LAYER AFTER CALC'NG A PARTIAL PRODUCT.<a name='684'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='685'></font>
       END IF<a name='686'>
       DENOM = ( ZSOIL (K) - ZSOIL (K -1) ) * HCPCT<a name='687'>
<a name='688'>
<font color=#447700>! ----------------------------------------------------------------------<a name='689'></font>
<font color=#447700>! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.<a name='690'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='691'></font>
       RHSTS (K) = ( DF1N * DTSDZ2- DF1K * DTSDZ ) / DENOM<a name='692'>
       AI (K) = - DF1K * DDZ / ( (ZSOIL (K -1) - ZSOIL (K)) * HCPCT)<a name='693'>
<a name='694'>
<font color=#447700>! ----------------------------------------------------------------------<a name='695'></font>
<font color=#447700>! RESET VALUES OF DTSDZ AND DDZ FOR LOOP TO NEXT SOIL LYR.<a name='696'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='697'></font>
       BI (K) = - (AI (K) + CI (K))<a name='698'>
       DF1K = DF1N<a name='699'>
       DTSDZ = DTSDZ2<a name='700'>
       DDZ = DDZ2<a name='701'>
    END DO<a name='702'>
<font color=#447700>! ----------------------------------------------------------------------<a name='703'></font>
  END SUBROUTINE HRTICE<a name='704'>
<font color=#447700>! ----------------------------------------------------------------------<a name='705'></font>
<a name='706'>
<A NAME='HSTEP'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#HSTEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='707'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>HSTEP</font> (STCOUT,STCIN,RHSTS,DT,NSOIL,AI,BI,CI) <A href='../../call_to/HSTEP.html' TARGET='index'>5</A>,<A href='../../call_from/HSTEP.html' TARGET='index'>4</A><a name='708'>
<a name='709'>
<font color=#447700>! ----------------------------------------------------------------------<a name='710'></font>
<font color=#447700>! CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.<a name='711'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='712'></font>
    IMPLICIT NONE<a name='713'>
    INTEGER,                  INTENT(IN)    :: NSOIL<a name='714'>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)    :: STCIN<a name='715'>
    REAL, DIMENSION(1:NSOIL), INTENT(OUT)   :: STCOUT<a name='716'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: RHSTS<a name='717'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: AI,BI,CI<a name='718'>
    REAL, DIMENSION(1:NSOIL) :: RHSTSin<a name='719'>
    REAL, DIMENSION(1:NSOIL) :: CIin<a name='720'>
    REAL                     :: DT<a name='721'>
    INTEGER                  :: K<a name='722'>
<a name='723'>
<font color=#447700>! ----------------------------------------------------------------------<a name='724'></font>
<font color=#447700>! CREATE FINITE DIFFERENCE VALUES FOR USE IN ROSR12 ROUTINE<a name='725'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='726'></font>
    DO K = 1,NSOIL<a name='727'>
       RHSTS (K) = RHSTS (K) * DT<a name='728'>
       AI (K) = AI (K) * DT<a name='729'>
       BI (K) = 1. + BI (K) * DT<a name='730'>
       CI (K) = CI (K) * DT<a name='731'>
    END DO<a name='732'>
<font color=#447700>! ----------------------------------------------------------------------<a name='733'></font>
<font color=#447700>! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12<a name='734'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='735'></font>
    DO K = 1,NSOIL<a name='736'>
       RHSTSin (K) = RHSTS (K)<a name='737'>
    END DO<a name='738'>
    DO K = 1,NSOIL<a name='739'>
       CIin (K) = CI (K)<a name='740'>
    END DO<a name='741'>
<font color=#447700>! ----------------------------------------------------------------------<a name='742'></font>
<font color=#447700>! SOLVE THE TRI-DIAGONAL MATRIX EQUATION<a name='743'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='744'></font>
    CALL <A href='../../html_code/phys/module_sf_urban.F.html#ROSR12'>ROSR12</A><A href='../../html_code/phys/module_sf_urban.F.html#HSTEP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROSR12_3"> (CI,AI,BI,CIin,RHSTSin,RHSTS,NSOIL)<a name='745'>
<font color=#447700>! ----------------------------------------------------------------------<a name='746'></font>
<font color=#447700>! CALC/UPDATE THE SOIL TEMPS USING MATRIX SOLUTION<a name='747'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='748'></font>
    DO K = 1,NSOIL<a name='749'>
       STCOUT (K) = STCIN (K) + CI (K)<a name='750'>
    END DO<a name='751'>
<font color=#447700>! ----------------------------------------------------------------------<a name='752'></font>
  END SUBROUTINE HSTEP<a name='753'>
<font color=#447700>! ----------------------------------------------------------------------<a name='754'></font>
<a name='755'>
<A NAME='PENMAN'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#PENMAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='756'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>PENMAN</font> (SFCTMP,SFCPRS,CH,TH2,PRCP,FDOWN,T24,SSOIL, &amp; <A href='../../call_to/PENMAN.html' TARGET='index'>3</A><a name='757'>
       &amp;             Q2,Q2SAT,ETP,RCH,RR,SNOWNG,FRZGRA,       &amp;<a name='758'>
       &amp;             DQSDT2,FLX2,EMISSI,T1)<a name='759'>
<a name='760'>
<font color=#447700>! ----------------------------------------------------------------------<a name='761'></font>
<font color=#447700>! CALCULATE POTENTIAL EVAPORATION FOR THE CURRENT POINT.  VARIOUS<a name='762'></font>
<font color=#447700>! PARTIAL SUMS/PRODUCTS ARE ALSO CALCULATED AND PASSED BACK TO THE<a name='763'></font>
<font color=#447700>! CALLING ROUTINE FOR LATER USE.<a name='764'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='765'></font>
    IMPLICIT NONE<a name='766'>
    LOGICAL, INTENT(IN)  :: SNOWNG, FRZGRA<a name='767'>
    REAL,    INTENT(IN)  :: CH, DQSDT2,FDOWN,PRCP,Q2,Q2SAT,SSOIL,SFCPRS, &amp;<a name='768'>
         &amp;                  SFCTMP,TH2,EMISSI,T1,RCH,T24<a name='769'>
    REAL,    INTENT(OUT) :: ETP,FLX2,RR<a name='770'>
<a name='771'>
    REAL                 :: A, DELTA, FNET,RAD,ELCP1,LVS,EPSCA<a name='772'>
<a name='773'>
    REAL, PARAMETER      :: ELCP = 2.4888E+3, LSUBC = 2.501000E+6<a name='774'>
    REAL, PARAMETER      :: LSUBS = 2.83E+6<a name='775'>
<a name='776'>
<font color=#447700>! ----------------------------------------------------------------------<a name='777'></font>
<font color=#447700>! PREPARE PARTIAL QUANTITIES FOR PENMAN EQUATION.<a name='778'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='779'></font>
    IF ( T1 &gt; 273.15 ) THEN<a name='780'>
       ELCP1 = ELCP<a name='781'>
       LVS   = LSUBC<a name='782'>
    ELSE<a name='783'>
       ELCP1 = ELCP*LSUBS/LSUBC<a name='784'>
       LVS   = LSUBS<a name='785'>
    ENDIF<a name='786'>
    DELTA = ELCP1 * DQSDT2<a name='787'>
    A = ELCP1 * (Q2SAT - Q2)<a name='788'>
    RR = EMISSI*T24 * 6.48E-8 / (SFCPRS * CH) + 1.0<a name='789'>
<a name='790'>
<font color=#447700>! ----------------------------------------------------------------------<a name='791'></font>
<font color=#447700>! ADJUST THE PARTIAL SUMS / PRODUCTS WITH THE LATENT HEAT<a name='792'></font>
<font color=#447700>! EFFECTS CAUSED BY FALLING PRECIPITATION.<a name='793'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='794'></font>
    IF (.NOT. SNOWNG) THEN<a name='795'>
       IF (PRCP &gt;  0.0) RR = RR + CPH2O * PRCP / RCH<a name='796'>
    ELSE<a name='797'>
       RR = RR + CPICE * PRCP / RCH<a name='798'>
    END IF<a name='799'>
<a name='800'>
<font color=#447700>! ----------------------------------------------------------------------<a name='801'></font>
<font color=#447700>! INCLUDE THE LATENT HEAT EFFECTS OF FREEZING RAIN CONVERTING TO ICE ON<a name='802'></font>
<font color=#447700>! IMPACT IN THE CALCULATION OF FLX2 AND FNET.<a name='803'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='804'></font>
    IF (FRZGRA) THEN<a name='805'>
       FLX2 = - LSUBF * PRCP<a name='806'>
    ELSE<a name='807'>
       FLX2 = 0.0<a name='808'>
    ENDIF<a name='809'>
    FNET = FDOWN -  ( EMISSI * SIGMA * T24 ) - SSOIL - FLX2<a name='810'>
<a name='811'>
<font color=#447700>! ----------------------------------------------------------------------<a name='812'></font>
<font color=#447700>! FINISH PENMAN EQUATION CALCULATIONS.<a name='813'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='814'></font>
    RAD = FNET / RCH + TH2 - SFCTMP<a name='815'>
    EPSCA = (A * RR + RAD * DELTA) / (DELTA + RR)<a name='816'>
    ETP = EPSCA * RCH / LVS<a name='817'>
<a name='818'>
<font color=#447700>! ----------------------------------------------------------------------<a name='819'></font>
  END SUBROUTINE PENMAN<a name='820'>
<font color=#447700>! ----------------------------------------------------------------------<a name='821'></font>
<a name='822'>
<A NAME='SHFLX'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SHFLX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='823'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SHFLX</font> (STC,NSOIL,DT,YY,ZZ1,ZSOIL,TBOT,DF1) <A href='../../call_to/SHFLX.html' TARGET='index'>5</A>,<A href='../../call_from/SHFLX.html' TARGET='index'>8</A><a name='824'>
<font color=#447700>! ----------------------------------------------------------------------<a name='825'></font>
<font color=#447700>! UPDATE THE TEMPERATURE STATE OF THE SOIL COLUMN BASED ON THE THERMAL<a name='826'></font>
<font color=#447700>! DIFFUSION EQUATION AND UPDATE THE FROZEN SOIL MOISTURE CONTENT BASED<a name='827'></font>
<font color=#447700>! ON THE TEMPERATURE.<a name='828'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='829'></font>
    IMPLICIT NONE<a name='830'>
<a name='831'>
    INTEGER,                  INTENT(IN)    :: NSOIL<a name='832'>
    REAL,                     INTENT(IN)    :: DF1,DT,TBOT,YY, ZZ1<a name='833'>
    REAL, DIMENSION(1:NSOIL), INTENT(IN)    :: ZSOIL<a name='834'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: STC<a name='835'>
<a name='836'>
    REAL, DIMENSION(1:NSOIL) :: AI, BI, CI, STCF,RHSTS<a name='837'>
    INTEGER                  :: I<a name='838'>
    REAL, PARAMETER          :: T0 = 273.15<a name='839'>
<a name='840'>
<font color=#447700>! ----------------------------------------------------------------------<a name='841'></font>
<font color=#447700>! HRT ROUTINE CALCS THE RIGHT HAND SIDE OF THE SOIL TEMP DIF EQN<a name='842'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='843'></font>
<a name='844'>
    CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#HRTICE'>HRTICE</A><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HRTICE_2"> (RHSTS,STC,TBOT, NSOIL,ZSOIL,YY,ZZ1,DF1,AI,BI,CI)<a name='845'>
<a name='846'>
    CALL <A href='../../html_code/phys/module_sf_urban.F.html#HSTEP'>HSTEP</A><A href='../../html_code/phys/module_sf_urban.F.html#SHFLX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HSTEP_3"> (STCF,STC,RHSTS,DT,NSOIL,AI,BI,CI)<a name='847'>
<a name='848'>
    DO I = 1,NSOIL<a name='849'>
       STC (I) = STCF (I)<a name='850'>
    END DO<a name='851'>
<font color=#447700>! ----------------------------------------------------------------------<a name='852'></font>
  END SUBROUTINE SHFLX<a name='853'>
<font color=#447700>! ----------------------------------------------------------------------<a name='854'></font>
<a name='855'>
<A NAME='SNOPAC'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='856'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOPAC</font> (ETP,ETA,PRCP,PRCPF,SNOWNG,NSOIL,DT,DF1,           &amp; <A href='../../call_to/SNOPAC.html' TARGET='index'>3</A>,<A href='../../call_from/SNOPAC.html' TARGET='index'>9</A><a name='857'>
       &amp;             Q2,T1,SFCTMP,T24,TH2,FDOWN,SSOIL,STC,             &amp;<a name='858'>
       &amp;             SFCPRS,RCH,RR,SNEQV,SNDENS,SNOWH,ZSOIL,TBOT,      &amp;<a name='859'>
       &amp;             SNOMLT,DEW,FLX1,FLX2,FLX3,ESNOW,EMISSI,RIBB)<a name='860'>
<a name='861'>
<font color=#447700>! ----------------------------------------------------------------------<a name='862'></font>
<font color=#447700>! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES &amp; UPDATE SOIL MOISTURE<a name='863'></font>
<font color=#447700>! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN A SNOW PACK IS<a name='864'></font>
<font color=#447700>! PRESENT.<a name='865'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='866'></font>
    IMPLICIT NONE<a name='867'>
<a name='868'>
    INTEGER, INTENT(IN)   :: NSOIL<a name='869'>
    LOGICAL, INTENT(IN)   :: SNOWNG<a name='870'>
    REAL,    INTENT(IN)   :: DF1,DT,FDOWN,PRCP,Q2,RCH,RR,SFCPRS,SFCTMP, &amp;<a name='871'>
         &amp;                   T24,TBOT,TH2,EMISSI<a name='872'>
    REAL, INTENT(INOUT)   :: SNEQV,FLX2,PRCPF,SNOWH,SNDENS,T1,RIBB,ETP<a name='873'>
    REAL, INTENT(OUT)     :: DEW,ESNOW,FLX1,FLX3,SSOIL,SNOMLT<a name='874'>
    REAL, DIMENSION(1:NSOIL),INTENT(IN)     :: ZSOIL<a name='875'>
    REAL, DIMENSION(1:NSOIL), INTENT(INOUT) :: STC<a name='876'>
    REAL, DIMENSION(1:NSOIL) :: ET1<a name='877'>
    INTEGER               :: K<a name='878'>
    REAL                  :: DENOM,DSOIL,DTOT,ESDFLX,ETA,        &amp;<a name='879'>
         &amp;                   ESNOW1,ESNOW2,ETA1,ETP1,ETP2,       &amp;<a name='880'>
         &amp;                   ETP3,ETANRG,EX,                     &amp;<a name='881'>
         &amp;                   FRCSNO,FRCSOI,PRCP1,QSAT,RSNOW,SEH, &amp;<a name='882'>
         &amp;                   SNCOND,T12,T12A,T12B,T14,YY,ZZ1<a name='883'>
<a name='884'>
    REAL, PARAMETER       :: ESDMIN = 1.E-6, LSUBC = 2.501000E+6,     &amp;<a name='885'>
         &amp;                   LSUBS = 2.83E+6, TFREEZ = 273.15,        &amp;<a name='886'>
         &amp;                   SNOEXP = 2.0<a name='887'>
<a name='888'>
<font color=#447700>! ----------------------------------------------------------------------<a name='889'></font>
<font color=#447700>! FOR GLACIAL-ICE, SNOWCOVER FRACTION = 1.0, AND SUBLIMATION IS AT THE <a name='890'></font>
<font color=#447700>! POTENTIAL RATE.<a name='891'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='892'></font>
<font color=#447700>! INITIALIZE EVAP TERMS.<a name='893'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='894'></font>
<font color=#447700>! conversions:<a name='895'></font>
<font color=#447700>! ESNOW [KG M-2 S-1]<a name='896'></font>
<font color=#447700>! ESDFLX [KG M-2 S-1] .le. ESNOW<a name='897'></font>
<font color=#447700>! ESNOW1 [M S-1]<a name='898'></font>
<font color=#447700>! ESNOW2 [M]<a name='899'></font>
<font color=#447700>! ETP [KG M-2 S-1]<a name='900'></font>
<font color=#447700>! ETP1 [M S-1]<a name='901'></font>
<font color=#447700>! ETP2 [M]<a name='902'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='903'></font>
    SNOMLT = 0.0<a name='904'>
    DEW = 0.<a name='905'>
    ESNOW = 0.<a name='906'>
    ESNOW1 = 0.<a name='907'>
    ESNOW2 = 0.<a name='908'>
<a name='909'>
<font color=#447700>! ----------------------------------------------------------------------<a name='910'></font>
<font color=#447700>! CONVERT POTENTIAL EVAP (ETP) FROM KG M-2 S-1 TO ETP1 IN M S-1<a name='911'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='912'></font>
    PRCP1 = PRCPF *0.001<a name='913'>
<font color=#447700>! ----------------------------------------------------------------------<a name='914'></font>
<font color=#447700>! IF ETP&lt;0 (DOWNWARD) THEN DEWFALL (=FROSTFALL IN THIS CASE).<a name='915'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='916'></font>
    IF (ETP &lt;= 0.0) THEN<a name='917'>
       IF ( ( RIBB &gt;= 0.1 ) .AND. ( FDOWN &gt; 150.0 ) ) THEN<a name='918'>
          ETP=(MIN(ETP*(1.0-RIBB),0.)/0.980 + ETP*(0.980-1.0))/0.980<a name='919'>
       ENDIF<a name='920'>
       ETP1 = ETP * 0.001<a name='921'>
       DEW = -ETP1<a name='922'>
       ESNOW2 = ETP1*DT<a name='923'>
       ETANRG = ETP*LSUBS<a name='924'>
    ELSE<a name='925'>
       ETP1 = ETP * 0.001<a name='926'>
       ESNOW = ETP<a name='927'>
       ESNOW1 = ESNOW*0.001<a name='928'>
       ESNOW2 = ESNOW1*DT<a name='929'>
       ETANRG = ESNOW*LSUBS<a name='930'>
    END IF<a name='931'>
<a name='932'>
<font color=#447700>! ----------------------------------------------------------------------<a name='933'></font>
<font color=#447700>! IF PRECIP IS FALLING, CALCULATE HEAT FLUX FROM SNOW SFC TO NEWLY<a name='934'></font>
<font color=#447700>! ACCUMULATING PRECIP.  NOTE THAT THIS REFLECTS THE FLUX APPROPRIATE FOR<a name='935'></font>
<font color=#447700>! THE NOT-YET-UPDATED SKIN TEMPERATURE (T1).  ASSUMES TEMPERATURE OF THE<a name='936'></font>
<font color=#447700>! SNOWFALL STRIKING THE GROUND IS =SFCTMP (LOWEST MODEL LEVEL AIR TEMP).<a name='937'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='938'></font>
    FLX1 = 0.0<a name='939'>
    IF (SNOWNG) THEN<a name='940'>
       FLX1 = CPICE * PRCP * (T1- SFCTMP)<a name='941'>
    ELSE<a name='942'>
       IF (PRCP &gt;  0.0) FLX1 = CPH2O * PRCP * (T1- SFCTMP)<a name='943'>
    END IF<a name='944'>
<font color=#447700>! ----------------------------------------------------------------------<a name='945'></font>
<font color=#447700>! CALCULATE AN 'EFFECTIVE SNOW-GRND SFC TEMP' (T12) BASED ON HEAT FLUXES<a name='946'></font>
<font color=#447700>! BETWEEN THE SNOW PACK AND THE SOIL AND ON NET RADIATION.<a name='947'></font>
<font color=#447700>! INCLUDE FLX1 (PRECIP-SNOW SFC) AND FLX2 (FREEZING RAIN LATENT HEAT)<a name='948'></font>
<font color=#447700>! FLUXES.  FLX1 FROM ABOVE, FLX2 BROUGHT IN VIA COMMOM BLOCK RITE.<a name='949'></font>
<font color=#447700>! FLX2 REFLECTS FREEZING RAIN LATENT HEAT FLUX USING T1 CALCULATED IN<a name='950'></font>
<font color=#447700>! PENMAN.<a name='951'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='952'></font>
    DSOIL = - (0.5 * ZSOIL (1))<a name='953'>
    DTOT = SNOWH + DSOIL<a name='954'>
    DENOM = 1.0+ DF1 / (DTOT * RR * RCH)<a name='955'>
    T12A = ( (FDOWN - FLX1- FLX2- EMISSI * SIGMA * T24)/ RCH                    &amp;<a name='956'>
         + TH2- SFCTMP - ETANRG / RCH ) / RR<a name='957'>
    T12B = DF1 * STC (1) / (DTOT * RR * RCH)<a name='958'>
<a name='959'>
    T12 = (SFCTMP + T12A + T12B) / DENOM<a name='960'>
    IF (T12 &lt;=  TFREEZ) THEN<a name='961'>
<font color=#447700>! ----------------------------------------------------------------------<a name='962'></font>
<font color=#447700>! SUB-FREEZING BLOCK<a name='963'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='964'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='965'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS AT OR BELOW FREEZING, NO SNOW<a name='966'></font>
<font color=#447700>! MELT WILL OCCUR.  SET THE SKIN TEMP TO THIS EFFECTIVE TEMP.  REDUCE<a name='967'></font>
<font color=#447700>! (BY SUBLIMINATION ) OR INCREASE (BY FROST) THE DEPTH OF THE SNOWPACK,<a name='968'></font>
<font color=#447700>! DEPENDING ON SIGN OF ETP.<a name='969'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX (SSOIL) USING NEW SKIN TEMPERATURE (T1)<a name='970'></font>
<font color=#447700>! SINCE NO SNOWMELT, SET ACCUMULATED SNOWMELT TO ZERO, SET 'EFFECTIVE'<a name='971'></font>
<font color=#447700>! PRECIP FROM SNOWMELT TO ZERO, SET PHASE-CHANGE HEAT FLUX FROM SNOWMELT<a name='972'></font>
<font color=#447700>! TO ZERO.<a name='973'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='974'></font>
       T1 = T12<a name='975'>
       SSOIL = DF1 * (T1- STC (1)) / DTOT<a name='976'>
       SNEQV = MAX(0.0, SNEQV-ESNOW2)<a name='977'>
       FLX3 = 0.0<a name='978'>
       EX = 0.0<a name='979'>
       SNOMLT = 0.0<a name='980'>
    ELSE<a name='981'>
<font color=#447700>! ----------------------------------------------------------------------<a name='982'></font>
<font color=#447700>! ABOVE FREEZING BLOCK<a name='983'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='984'></font>
<font color=#447700>! IF THE 'EFFECTIVE SNOW-GRND SFC TEMP' IS ABOVE FREEZING, SNOW MELT<a name='985'></font>
<font color=#447700>! WILL OCCUR.  CALL THE SNOW MELT RATE,EX AND AMT, SNOMLT.  REVISE THE<a name='986'></font>
<font color=#447700>! EFFECTIVE SNOW DEPTH.  REVISE THE SKIN TEMP BECAUSE IT WOULD HAVE CHGD<a name='987'></font>
<font color=#447700>! DUE TO THE LATENT HEAT RELEASED BY THE MELTING. CALC THE LATENT HEAT<a name='988'></font>
<font color=#447700>! RELEASED, FLX3. SET THE EFFECTIVE PRECIP, PRCP1 TO THE SNOW MELT RATE,<a name='989'></font>
<font color=#447700>! EX FOR USE IN SMFLX.  ADJUSTMENT TO T1 TO ACCOUNT FOR SNOW PATCHES.<a name='990'></font>
<font color=#447700>! CALCULATE QSAT VALID AT FREEZING POINT.  NOTE THAT ESAT (SATURATION<a name='991'></font>
<font color=#447700>! VAPOR PRESSURE) VALUE OF 6.11E+2 USED HERE IS THAT VALID AT FRZZING<a name='992'></font>
<font color=#447700>! POINT.  NOTE THAT ETP FROM CALL PENMAN IN SFLX IS IGNORED HERE IN<a name='993'></font>
<font color=#447700>! FAVOR OF BULK ETP OVER 'OPEN WATER' AT FREEZING TEMP.<a name='994'></font>
<font color=#447700>! UPDATE SOIL HEAT FLUX (S) USING NEW SKIN TEMPERATURE (T1)<a name='995'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='996'></font>
       T1 = TFREEZ<a name='997'>
       IF ( DTOT .GT. 2.0*DSOIL ) THEN<a name='998'>
          DTOT = 2.0*DSOIL<a name='999'>
       ENDIF<a name='1000'>
       SSOIL = DF1 * (T1- STC (1)) / DTOT<a name='1001'>
       IF (SNEQV-ESNOW2 &lt;= ESDMIN) THEN<a name='1002'>
          SNEQV = 0.0<a name='1003'>
          EX = 0.0<a name='1004'>
          SNOMLT = 0.0<a name='1005'>
          FLX3 = 0.0<a name='1006'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1007'></font>
<font color=#447700>! SUBLIMATION LESS THAN DEPTH OF SNOWPACK<a name='1008'></font>
<font color=#447700>! SNOWPACK (SNEQV) REDUCED BY ESNOW2 (DEPTH OF SUBLIMATED SNOW)<a name='1009'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1010'></font>
       ELSE<a name='1011'>
          SNEQV = SNEQV-ESNOW2<a name='1012'>
          ETP3 = ETP * LSUBC<a name='1013'>
          SEH = RCH * (T1- TH2)<a name='1014'>
          T14 = ( T1 * T1 ) * ( T1 * T1 )<a name='1015'>
          FLX3 = FDOWN - FLX1- FLX2- EMISSI*SIGMA * T14- SSOIL - SEH - ETANRG<a name='1016'>
          IF (FLX3 &lt;= 0.0) FLX3 = 0.0<a name='1017'>
          EX = FLX3*0.001/ LSUBF<a name='1018'>
          SNOMLT = EX * DT<a name='1019'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1020'></font>
<font color=#447700>! ESDMIN REPRESENTS A SNOWPACK DEPTH THRESHOLD VALUE BELOW WHICH WE<a name='1021'></font>
<font color=#447700>! CHOOSE NOT TO RETAIN ANY SNOWPACK, AND INSTEAD INCLUDE IT IN SNOWMELT.<a name='1022'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1023'></font>
          IF (SNEQV- SNOMLT &gt;=  ESDMIN) THEN<a name='1024'>
             SNEQV = SNEQV- SNOMLT<a name='1025'>
          ELSE<a name='1026'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1027'></font>
<font color=#447700>! SNOWMELT EXCEEDS SNOW DEPTH<a name='1028'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1029'></font>
             EX = SNEQV / DT<a name='1030'>
             FLX3 = EX *1000.0* LSUBF<a name='1031'>
             SNOMLT = SNEQV<a name='1032'>
<a name='1033'>
             SNEQV = 0.0<a name='1034'>
          ENDIF<a name='1035'>
       ENDIF<a name='1036'>
<a name='1037'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1038'></font>
<font color=#447700>! FOR GLACIAL ICE, THE SNOWMELT WILL BE ADDED TO SUBSURFACE<a name='1039'></font>
<font color=#447700>! RUNOFF/BASEFLOW LATER NEAR THE END OF SFLX (AFTER RETURN FROM CALL TO<a name='1040'></font>
<font color=#447700>! SUBROUTINE SNOPAC)<a name='1041'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1042'></font>
<a name='1043'>
    ENDIF<a name='1044'>
<a name='1045'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1046'></font>
<font color=#447700>! BEFORE CALL SHFLX IN THIS SNOWPACK CASE, SET ZZ1 AND YY ARGUMENTS TO<a name='1047'></font>
<font color=#447700>! SPECIAL VALUES THAT ENSURE THAT GROUND HEAT FLUX CALCULATED IN SHFLX<a name='1048'></font>
<font color=#447700>! MATCHES THAT ALREADY COMPUTED FOR BELOW THE SNOWPACK, THUS THE SFC<a name='1049'></font>
<font color=#447700>! HEAT FLUX TO BE COMPUTED IN SHFLX WILL EFFECTIVELY BE THE FLUX AT THE<a name='1050'></font>
<font color=#447700>! SNOW TOP SURFACE.  <a name='1051'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1052'></font>
    ZZ1 = 1.0<a name='1053'>
    YY = STC (1) -0.5* SSOIL * ZSOIL (1)* ZZ1/ DF1<a name='1054'>
<a name='1055'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1056'></font>
<font color=#447700>! SHFLX WILL CALC/UPDATE THE SOIL TEMPS.<a name='1057'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1058'></font>
    CALL <A href='../../html_code/phys/module_sf_urban.F.html#SHFLX'>SHFLX</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SHFLX_4"> (STC,NSOIL,DT,YY,ZZ1,ZSOIL,TBOT,DF1)<a name='1059'>
<a name='1060'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1061'></font>
<font color=#447700>! SNOW DEPTH AND DENSITY ADJUSTMENT BASED ON SNOW COMPACTION.  YY IS<a name='1062'></font>
<font color=#447700>! ASSUMED TO BE THE SOIL TEMPERTURE AT THE TOP OF THE SOIL COLUMN.<a name='1063'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1064'></font>
    IF (SNEQV .GE. 0.10) THEN<a name='1065'>
       CALL <A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWPACK'>SNOWPACK</A><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOPAC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWPACK_4"> (SNEQV,DT,SNOWH,SNDENS,T1,YY)<a name='1066'>
    ELSE<a name='1067'>
       SNEQV = 0.10<a name='1068'>
       SNOWH = 0.50<a name='1069'>
<font color=#447700>!KWM???? SNDENS =<a name='1070'></font>
<font color=#447700>!KWM???? SNCOND =<a name='1071'></font>
    ENDIF<a name='1072'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1073'></font>
  END SUBROUTINE SNOPAC<a name='1074'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1075'></font>
<a name='1076'>
<A NAME='SNOWPACK'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWPACK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1077'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWPACK</font> (SNEQV,DTSEC,SNOWH,SNDENS,TSNOW,TSOIL) <A href='../../call_to/SNOWPACK.html' TARGET='index'>4</A><a name='1078'>
<a name='1079'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1080'></font>
<font color=#447700>! CALCULATE COMPACTION OF SNOWPACK UNDER CONDITIONS OF INCREASING SNOW<a name='1081'></font>
<font color=#447700>! DENSITY, AS OBTAINED FROM AN APPROXIMATE SOLUTION OF E. ANDERSON'S<a name='1082'></font>
<font color=#447700>! DIFFERENTIAL EQUATION (3.29), NOAA TECHNICAL REPORT NWS 19, BY VICTOR<a name='1083'></font>
<font color=#447700>! KOREN, 03/25/95.<a name='1084'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1085'></font>
<font color=#447700>! SNEQV     WATER EQUIVALENT OF SNOW (M)<a name='1086'></font>
<font color=#447700>! DTSEC   TIME STEP (SEC)<a name='1087'></font>
<font color=#447700>! SNOWH   SNOW DEPTH (M)<a name='1088'></font>
<font color=#447700>! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)<a name='1089'></font>
<font color=#447700>! TSNOW   SNOW SURFACE TEMPERATURE (K)<a name='1090'></font>
<font color=#447700>! TSOIL   SOIL SURFACE TEMPERATURE (K)<a name='1091'></font>
<a name='1092'>
<font color=#447700>! SUBROUTINE WILL RETURN NEW VALUES OF SNOWH AND SNDENS<a name='1093'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1094'></font>
      IMPLICIT NONE<a name='1095'>
<a name='1096'>
      INTEGER                :: IPOL, J<a name='1097'>
      REAL, INTENT(IN)       :: SNEQV, DTSEC,TSNOW,TSOIL<a name='1098'>
      REAL, INTENT(INOUT)    :: SNOWH, SNDENS<a name='1099'>
      REAL                   :: BFAC,DSX,DTHR,DW,SNOWHC,PEXP,           &amp;<a name='1100'>
                                TAVGC,TSNOWC,TSOILC,ESDC,ESDCX<a name='1101'>
      REAL, PARAMETER        :: C1 = 0.01, C2 = 21.0, G = 9.81,         &amp;<a name='1102'>
                                KN = 4000.0<a name='1103'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1104'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS<a name='1105'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1106'></font>
      SNOWHC = SNOWH *100.<a name='1107'>
      ESDC   = SNEQV *100.<a name='1108'>
      DTHR   = DTSEC /3600.<a name='1109'>
      TSNOWC = TSNOW -273.15<a name='1110'>
      TSOILC = TSOIL -273.15<a name='1111'>
<a name='1112'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1113'></font>
<font color=#447700>! CALCULATING OF AVERAGE TEMPERATURE OF SNOW PACK<a name='1114'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1115'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1116'></font>
<font color=#447700>! CALCULATING OF SNOW DEPTH AND DENSITY AS A RESULT OF COMPACTION<a name='1117'></font>
<font color=#447700>!  SNDENS=DS0*(EXP(BFAC*SNEQV)-1.)/(BFAC*SNEQV)<a name='1118'></font>
<font color=#447700>!  BFAC=DTHR*C1*EXP(0.08*TAVGC-C2*DS0)<a name='1119'></font>
<font color=#447700>! NOTE: BFAC*SNEQV IN SNDENS EQN ABOVE HAS TO BE CAREFULLY TREATED<a name='1120'></font>
<font color=#447700>! NUMERICALLY BELOW:<a name='1121'></font>
<font color=#447700>!   C1 IS THE FRACTIONAL INCREASE IN DENSITY (1/(CM*HR))<a name='1122'></font>
<font color=#447700>!   C2 IS A CONSTANT (CM3/G) KOJIMA ESTIMATED AS 21 CMS/G<a name='1123'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1124'></font>
      TAVGC = 0.5* (TSNOWC + TSOILC)<a name='1125'>
      IF (ESDC &gt;  1.E-2) THEN<a name='1126'>
         ESDCX = ESDC<a name='1127'>
      ELSE<a name='1128'>
         ESDCX = 1.E-2<a name='1129'>
      END IF<a name='1130'>
<a name='1131'>
<font color=#447700>!      DSX = SNDENS*((DEXP(BFAC*ESDC)-1.)/(BFAC*ESDC))<a name='1132'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1133'></font>
<font color=#447700>! THE FUNCTION OF THE FORM (e**x-1)/x IMBEDDED IN ABOVE EXPRESSION<a name='1134'></font>
<font color=#447700>! FOR DSX WAS CAUSING NUMERICAL DIFFICULTIES WHEN THE DENOMINATOR "x"<a name='1135'></font>
<font color=#447700>! (I.E. BFAC*ESDC) BECAME ZERO OR APPROACHED ZERO (DESPITE THE FACT THAT<a name='1136'></font>
<font color=#447700>! THE ANALYTICAL FUNCTION (e**x-1)/x HAS A WELL DEFINED LIMIT AS<a name='1137'></font>
<font color=#447700>! "x" APPROACHES ZERO), HENCE BELOW WE REPLACE THE (e**x-1)/x<a name='1138'></font>
<font color=#447700>! EXPRESSION WITH AN EQUIVALENT, NUMERICALLY WELL-BEHAVED<a name='1139'></font>
<font color=#447700>! POLYNOMIAL EXPANSION.<a name='1140'></font>
<a name='1141'>
<font color=#447700>! NUMBER OF TERMS OF POLYNOMIAL EXPANSION, AND HENCE ITS ACCURACY,<a name='1142'></font>
<font color=#447700>! IS GOVERNED BY ITERATION LIMIT "IPOL".<a name='1143'></font>
<font color=#447700>!      IPOL GREATER THAN 9 ONLY MAKES A DIFFERENCE ON DOUBLE<a name='1144'></font>
<font color=#447700>!            PRECISION (RELATIVE ERRORS GIVEN IN PERCENT %).<a name='1145'></font>
<font color=#447700>!       IPOL=9, FOR REL.ERROR &lt;~ 1.6 E-6 % (8 SIGNIFICANT DIGITS)<a name='1146'></font>
<font color=#447700>!       IPOL=8, FOR REL.ERROR &lt;~ 1.8 E-5 % (7 SIGNIFICANT DIGITS)<a name='1147'></font>
<font color=#447700>!       IPOL=7, FOR REL.ERROR &lt;~ 1.8 E-4 % ...<a name='1148'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1149'></font>
      BFAC = DTHR * C1* EXP (0.08* TAVGC - C2* SNDENS)<a name='1150'>
      IPOL = 4<a name='1151'>
      PEXP = 0.<a name='1152'>
<font color=#447700>!        PEXP = (1. + PEXP)*BFAC*ESDC/REAL(J+1)<a name='1153'></font>
      DO J = IPOL,1, -1<a name='1154'>
         PEXP = (1. + PEXP)* BFAC * ESDCX / REAL (J +1)<a name='1155'>
      END DO<a name='1156'>
<a name='1157'>
      PEXP = PEXP + 1.<a name='1158'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1159'></font>
<font color=#447700>! ABOVE LINE ENDS POLYNOMIAL SUBSTITUTION<a name='1160'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1161'></font>
<font color=#447700>!     END OF KOREAN FORMULATION<a name='1162'></font>
<a name='1163'>
<font color=#447700>!     BASE FORMULATION (COGLEY ET AL., 1990)<a name='1164'></font>
<font color=#447700>!     CONVERT DENSITY FROM G/CM3 TO KG/M3<a name='1165'></font>
<font color=#447700>!       DSM=SNDENS*1000.0<a name='1166'></font>
<a name='1167'>
<font color=#447700>!       DSX=DSM+DTSEC*0.5*DSM*G*SNEQV/<a name='1168'></font>
<font color=#447700>!    &amp;      (1E7*EXP(-0.02*DSM+KN/(TAVGC+273.16)-14.643))<a name='1169'></font>
<a name='1170'>
<font color=#447700>!  &amp;   CONVERT DENSITY FROM KG/M3 TO G/CM3<a name='1171'></font>
<font color=#447700>!       DSX=DSX/1000.0<a name='1172'></font>
<a name='1173'>
<font color=#447700>!     END OF COGLEY ET AL. FORMULATION<a name='1174'></font>
<a name='1175'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1176'></font>
<font color=#447700>! SET UPPER/LOWER LIMIT ON SNOW DENSITY<a name='1177'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1178'></font>
      DSX = SNDENS * (PEXP)<a name='1179'>
      IF (DSX &gt; 0.40) DSX = 0.40<a name='1180'>
      IF (DSX &lt; 0.05) DSX = 0.05<a name='1181'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1182'></font>
<font color=#447700>! UPDATE OF SNOW DEPTH AND DENSITY DEPENDING ON LIQUID WATER DURING<a name='1183'></font>
<font color=#447700>! SNOWMELT.  ASSUMED THAT 13% OF LIQUID WATER CAN BE STORED IN SNOW PER<a name='1184'></font>
<font color=#447700>! DAY DURING SNOWMELT TILL SNOW DENSITY 0.40.<a name='1185'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1186'></font>
      SNDENS = DSX<a name='1187'>
      IF (TSNOWC &gt;=  0.) THEN<a name='1188'>
         DW = 0.13* DTHR /24.<a name='1189'>
         SNDENS = SNDENS * (1. - DW) + DW<a name='1190'>
         IF (SNDENS &gt;=  0.40) SNDENS = 0.40<a name='1191'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1192'></font>
<font color=#447700>! CALCULATE SNOW DEPTH (CM) FROM SNOW WATER EQUIVALENT AND SNOW DENSITY.<a name='1193'></font>
<font color=#447700>! CHANGE SNOW DEPTH UNITS TO METERS<a name='1194'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1195'></font>
      END IF<a name='1196'>
      SNOWHC = ESDC / SNDENS<a name='1197'>
      SNOWH = SNOWHC * 0.01<a name='1198'>
<a name='1199'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1200'></font>
  END SUBROUTINE SNOWPACK<a name='1201'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1202'></font>
<a name='1203'>
<A NAME='SNOWZ0'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOWZ0' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1204'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOWZ0</font> (Z0, Z0BRD, SNOWH) <A href='../../call_to/SNOWZ0.html' TARGET='index'>4</A><a name='1205'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1206'></font>
<font color=#447700>! CALCULATE TOTAL ROUGHNESS LENGTH OVER SNOW<a name='1207'></font>
<font color=#447700>! Z0      ROUGHNESS LENGTH (m)<a name='1208'></font>
<font color=#447700>! Z0S     SNOW ROUGHNESS LENGTH:=0.001 (m)<a name='1209'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1210'></font>
    IMPLICIT NONE<a name='1211'>
    REAL, INTENT(IN)        :: Z0BRD<a name='1212'>
    REAL, INTENT(OUT)       :: Z0<a name='1213'>
    REAL, PARAMETER         :: Z0S=0.001<a name='1214'>
    REAL, INTENT(IN)        :: SNOWH<a name='1215'>
    REAL                    :: BURIAL<a name='1216'>
    REAL                    :: Z0EFF<a name='1217'>
<a name='1218'>
    BURIAL = 7.0*Z0BRD - SNOWH<a name='1219'>
    IF(BURIAL.LE.0.0007) THEN<a name='1220'>
       Z0EFF = Z0S<a name='1221'>
    ELSE      <a name='1222'>
       Z0EFF = BURIAL/7.0<a name='1223'>
    ENDIF<a name='1224'>
<a name='1225'>
    Z0 = Z0EFF<a name='1226'>
<a name='1227'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1228'></font>
  END SUBROUTINE SNOWZ0<a name='1229'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1230'></font>
<a name='1231'>
<A NAME='SNOW_NEW'><A href='../../html_code/phys/module_sf_noahlsm_glacial_only.F.html#SNOW_NEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1232'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOW_NEW</font> (TEMP,NEWSN,SNOWH,SNDENS) <A href='../../call_to/SNOW_NEW.html' TARGET='index'>3</A><a name='1233'>
<a name='1234'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1235'></font>
<font color=#447700>! CALCULATE SNOW DEPTH AND DENSITY TO ACCOUNT FOR THE NEW SNOWFALL.<a name='1236'></font>
<font color=#447700>! UPDATED VALUES OF SNOW DEPTH AND DENSITY ARE RETURNED.<a name='1237'></font>
<a name='1238'>
<font color=#447700>! TEMP    AIR TEMPERATURE (K)<a name='1239'></font>
<font color=#447700>! NEWSN   NEW SNOWFALL (M)<a name='1240'></font>
<font color=#447700>! SNOWH   SNOW DEPTH (M)<a name='1241'></font>
<font color=#447700>! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)<a name='1242'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1243'></font>
    IMPLICIT NONE<a name='1244'>
    REAL, INTENT(IN)        :: NEWSN, TEMP<a name='1245'>
    REAL, INTENT(INOUT)     :: SNDENS, SNOWH<a name='1246'>
    REAL                    :: DSNEW, HNEWC, SNOWHC,NEWSNC,TEMPC<a name='1247'>
<a name='1248'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1249'></font>
<font color=#447700>! CALCULATING NEW SNOWFALL DENSITY DEPENDING ON TEMPERATURE<a name='1250'></font>
<font color=#447700>! EQUATION FROM GOTTLIB L. 'A GENERAL RUNOFF MODEL FOR SNOWCOVERED<a name='1251'></font>
<font color=#447700>! AND GLACIERIZED BASIN', 6TH NORDIC HYDROLOGICAL CONFERENCE,<a name='1252'></font>
<font color=#447700>! VEMADOLEN, SWEDEN, 1980, 172-177PP.<a name='1253'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1254'></font>
    TEMPC = TEMP - 273.15<a name='1255'>
    IF ( TEMPC &lt;=  -15. ) THEN<a name='1256'>
       DSNEW = 0.05<a name='1257'>
    ELSE<a name='1258'>
       DSNEW = 0.05 + 0.0017 * ( TEMPC + 15. ) ** 1.5<a name='1259'>
    ENDIF<a name='1260'>
<a name='1261'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1262'></font>
<font color=#447700>! CONVERSION INTO SIMULATION UNITS<a name='1263'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1264'></font>
    SNOWHC = SNOWH * 100.<a name='1265'>
    NEWSNC = NEWSN * 100.<a name='1266'>
<a name='1267'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1268'></font>
<font color=#447700>! ADJUSTMENT OF SNOW DENSITY DEPENDING ON NEW SNOWFALL<a name='1269'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1270'></font>
    HNEWC = NEWSNC / DSNEW<a name='1271'>
    IF ( SNOWHC + HNEWC &lt; 1.0E-3 ) THEN<a name='1272'>
       SNDENS = MAX ( DSNEW , SNDENS )<a name='1273'>
    ELSE<a name='1274'>
       SNDENS = ( SNOWHC * SNDENS + HNEWC * DSNEW ) / ( SNOWHC + HNEWC )<a name='1275'>
    ENDIF<a name='1276'>
    SNOWHC = SNOWHC + HNEWC<a name='1277'>
    SNOWH = SNOWHC * 0.01<a name='1278'>
<a name='1279'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1280'></font>
  END SUBROUTINE SNOW_NEW<a name='1281'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1282'></font>
<a name='1283'>
END MODULE module_sf_noahlsm_glacial_only<a name='1284'>
</pre></body></html>