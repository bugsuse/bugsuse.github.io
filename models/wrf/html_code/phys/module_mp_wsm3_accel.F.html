<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( RWORDSIZE == 4 )<a name='2'>
#  define VREC vsrec<a name='3'>
#  define VSQRT vssqrt<a name='4'>
#else<a name='5'>
#  define VREC vrec<a name='6'>
#  define VSQRT vsqrt<a name='7'>
#endif<a name='8'>
<a name='9'>
<A NAME='MODULE_MP_WSM3'><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#MODULE_MP_WSM3' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='10'>
<font color=#993300>MODULE </font><font color=#cc0000>module_mp_wsm3</font> <A href='../../call_to/MODULE_MP_WSM3.html' TARGET='index'>2</A><a name='11'>
<font color=#447700>!<a name='12'></font>
<font color=#447700>!<a name='13'></font>
   REAL, PARAMETER, PRIVATE :: dtcldcr     = 120. <font color=#447700>! maximum time step for minor loops<a name='14'></font>
   REAL, PARAMETER, PRIVATE :: n0r = 8.e6         <font color=#447700>! intercept parameter rain<a name='15'></font>
   REAL, PARAMETER, PRIVATE :: avtr = 841.9       <font color=#447700>! a constant for terminal velocity of rain<a name='16'></font>
   REAL, PARAMETER, PRIVATE :: bvtr = 0.8         <font color=#447700>! a constant for terminal velocity of rain<a name='17'></font>
   REAL, PARAMETER, PRIVATE :: r0 = .8e-5         <font color=#447700>! 8 microm  in contrast to 10 micro m<a name='18'></font>
   REAL, PARAMETER, PRIVATE :: peaut = .55        <font color=#447700>! collection efficiency<a name='19'></font>
   REAL, PARAMETER, PRIVATE :: xncr = 3.e8        <font color=#447700>! maritime cloud in contrast to 3.e8 in tc80<a name='20'></font>
   REAL, PARAMETER, PRIVATE :: xmyu = 1.718e-5    <font color=#447700>! the dynamic viscosity kgm-1s-1<a name='21'></font>
   REAL, PARAMETER, PRIVATE :: avts = 11.72       <font color=#447700>! a constant for terminal velocity of snow<a name='22'></font>
   REAL, PARAMETER, PRIVATE :: bvts = .41         <font color=#447700>! a constant for terminal velocity of snow<a name='23'></font>
   REAL, PARAMETER, PRIVATE :: n0smax =  1.e11    <font color=#447700>! maximum n0s (t=-90C unlimited)<a name='24'></font>
   REAL, PARAMETER, PRIVATE :: lamdarmax = 8.e4   <font color=#447700>! limited maximum value for slope parameter of rain<a name='25'></font>
   REAL, PARAMETER, PRIVATE :: lamdasmax = 1.e5   <font color=#447700>! limited maximum value for slope parameter of snow<a name='26'></font>
   REAL, PARAMETER, PRIVATE :: lamdagmax = 6.e4   <font color=#447700>! limited maximum value for slope parameter of graupel<a name='27'></font>
   REAL, PARAMETER, PRIVATE :: dicon = 11.9       <font color=#447700>! constant for the cloud-ice diamter<a name='28'></font>
   REAL, PARAMETER, PRIVATE :: dimax = 500.e-6    <font color=#447700>! limited maximum value for the cloud-ice diamter<a name='29'></font>
   REAL, PARAMETER, PRIVATE :: n0s = 2.e6         <font color=#447700>! temperature dependent intercept parameter snow <a name='30'></font>
   REAL, PARAMETER, PRIVATE :: alpha = .12        <font color=#447700>! .122 exponen factor for n0s<a name='31'></font>
   REAL, PARAMETER, PRIVATE :: qcrmin = 1.e-9     <font color=#447700>! minimun values for qr, qs, and qg<a name='32'></font>
   REAL, SAVE ::                                      &amp;<a name='33'>
             qc0, qck1,bvtr1,bvtr2,bvtr3,bvtr4,g1pbr, &amp;<a name='34'>
             g3pbr,g4pbr,g5pbro2,pvtr,eacrr,pacrr,    &amp;<a name='35'>
             precr1,precr2,xmmax,roqimax,bvts1,       &amp;<a name='36'>
             bvts2,bvts3,bvts4,g1pbs,g3pbs,g4pbs,     &amp;<a name='37'>
             g5pbso2,pvts,pacrs,precs1,precs2,pidn0r, &amp;<a name='38'>
             pidn0s,xlv1,                             &amp;<a name='39'>
             rslopermax,rslopesmax,rslopegmax,        &amp;<a name='40'>
             rsloperbmax,rslopesbmax,rslopegbmax,     &amp;<a name='41'>
             rsloper2max,rslopes2max,rslopeg2max,     &amp;<a name='42'>
             rsloper3max,rslopes3max,rslopeg3max<a name='43'>
<font color=#447700>!<a name='44'></font>
<font color=#447700>! Specifies code-inlining of fpvs function in WSM32D below. JM 20040507<a name='45'></font>
<font color=#447700>!<a name='46'></font>
CONTAINS<a name='47'>
<font color=#447700>!===================================================================<a name='48'></font>
<font color=#447700>!<a name='49'></font>
<A NAME='WSM3'><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='50'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wsm3</font>(th, q, qci, qrs                     &amp; <A href='../../call_to/WSM3.html' TARGET='index'>1</A>,<A href='../../call_from/WSM3.html' TARGET='index'>4</A><a name='51'>
                   , w, den, pii, p, delz             &amp;<a name='52'>
                   , delt,g, cpd, cpv, rd, rv, t0c    &amp;<a name='53'>
                   , ep1, ep2, qmin                   &amp;<a name='54'>
                   , XLS, XLV0, XLF0, den0, denr      &amp;<a name='55'>
                   , cliq,cice,psat                   &amp;<a name='56'>
                   , rain, rainncv                    &amp;<a name='57'>
                   , snow, snowncv                    &amp;<a name='58'>
                   , sr                               &amp;<a name='59'>
                   , ids,ide, jds,jde, kds,kde        &amp;<a name='60'>
                   , ims,ime, jms,jme, kms,kme        &amp;<a name='61'>
                   , its,ite, jts,jte, kts,kte        &amp;<a name='62'>
                                                      )<a name='63'>
<font color=#447700>!-------------------------------------------------------------------<a name='64'></font>
#ifdef _OPENMP<a name='65'>
  use omp_lib<a name='66'>
#endif<a name='67'>
  IMPLICIT NONE<a name='68'>
<font color=#447700>!-------------------------------------------------------------------<a name='69'></font>
<font color=#447700>!<a name='70'></font>
<font color=#447700>!<a name='71'></font>
<font color=#447700>!  This code is a 3-class simple ice microphyiscs scheme (WSM3) of the WRF<a name='72'></font>
<font color=#447700>!  Single-Moment MicroPhyiscs (WSMMP). The WSMMP assumes that ice nuclei<a name='73'></font>
<font color=#447700>!  number concentration is a function of temperature, and seperate assumption<a name='74'></font>
<font color=#447700>!  is developed, in which ice crystal number concentration is a function<a name='75'></font>
<font color=#447700>!  of ice amount. A theoretical background of the ice-microphysics and related<a name='76'></font>
<font color=#447700>!  processes in the WSMMPs are described in Hong et al. (2004).<a name='77'></font>
<font color=#447700>!  Production terms in the WSM6 scheme are described in Hong and Lim (2006).<a name='78'></font>
<font color=#447700>!  All units are in m.k.s. and source/sink terms in kgkg-1s-1.<a name='79'></font>
<font color=#447700>!<a name='80'></font>
<font color=#447700>!  WSM3 cloud scheme<a name='81'></font>
<font color=#447700>!<a name='82'></font>
<font color=#447700>!  Coded by Song-You Hong (Yonsei Univ.)<a name='83'></font>
<font color=#447700>!             Jimy Dudhia (NCAR) and Shu-Hua Chen (UC Davis)<a name='84'></font>
<font color=#447700>!             Summer 2002<a name='85'></font>
<font color=#447700>!<a name='86'></font>
<font color=#447700>!  Implemented by Song-You Hong (Yonsei Univ.) and Jimy Dudhia (NCAR)<a name='87'></font>
<font color=#447700>!             Summer 2003<a name='88'></font>
<font color=#447700>!<a name='89'></font>
<font color=#447700>!  Reference) Hong, Dudhia, Chen (HDC, 2004) Mon. Wea. Rev.<a name='90'></font>
<font color=#447700>!             Dudhia (D89, 1989) J. Atmos. Sci.<a name='91'></font>
<font color=#447700>!             Hong and Lim (HL, 2006) J. Korean Meteor. Soc.<a name='92'></font>
<font color=#447700>!<a name='93'></font>
  INTEGER,      INTENT(IN   )    ::                ids,ide, jds,jde, kds,kde , &amp;<a name='94'>
                                                   ims,ime, jms,jme, kms,kme , &amp;<a name='95'>
                                                   its,ite, jts,jte, kts,kte<a name='96'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                              &amp;<a name='97'>
        INTENT(INOUT) ::                                                       &amp;<a name='98'>
                                                                          th,  &amp;<a name='99'>
                                                                           q,  &amp;<a name='100'>
                                                                          qci, &amp;<a name='101'>
                                                                          qrs<a name='102'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),                              &amp;<a name='103'>
        INTENT(IN   ) ::                                                    w, &amp;<a name='104'>
                                                                          den, &amp;<a name='105'>
                                                                          pii, &amp;<a name='106'>
                                                                            p, &amp;<a name='107'>
                                                                         delz<a name='108'>
<a name='109'>
  REAL, INTENT(IN   ) ::                                                 delt, &amp;<a name='110'>
                                                                            g, &amp;<a name='111'>
                                                                           rd, &amp;<a name='112'>
                                                                           rv, &amp;<a name='113'>
                                                                          t0c, &amp;<a name='114'>
                                                                         den0, &amp;<a name='115'>
                                                                          cpd, &amp;<a name='116'>
                                                                          cpv, &amp;<a name='117'>
                                                                          ep1, &amp;<a name='118'>
                                                                          ep2, &amp;<a name='119'>
                                                                         qmin, &amp;<a name='120'>
                                                                          XLS, &amp;<a name='121'>
                                                                         XLV0, &amp;<a name='122'>
                                                                         XLF0, &amp;<a name='123'>
                                                                         cliq, &amp;<a name='124'>
                                                                         cice, &amp;<a name='125'>
                                                                         psat, &amp;<a name='126'>
                                                                         denr<a name='127'>
  REAL, DIMENSION( ims:ime , jms:jme ),                                        &amp;<a name='128'>
        INTENT(INOUT) ::                                                 rain, &amp;<a name='129'>
                                                                      rainncv<a name='130'>
<a name='131'>
  REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL,                              &amp;<a name='132'>
        INTENT(INOUT) ::                                                 snow, &amp;<a name='133'>
                                                                      snowncv, &amp;<a name='134'>
                                                                           sr<a name='135'>
<a name='136'>
<font color=#447700>! LOCAL VAR<a name='137'></font>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                   t<a name='138'>
  INTEGER ::                                                            i,j,k<a name='139'>
#ifdef _ACCEL_PROF<a name='140'>
  integer :: l<a name='141'>
  real*8 wsm3_t(8,256), wsm5_t(8,256), t1, t2<a name='142'>
  common /wsm_times/ wsm3_t(8,256), wsm5_t(8,256)<a name='143'>
#endif<a name='144'>
<font color=#447700>!-------------------------------------------------------------------<a name='145'></font>
#ifdef _ACCEL_PROF<a name='146'>
  call cpu_time(t1)<a name='147'>
#endif<a name='148'>
<a name='149'>
#ifdef _ACCEL<a name='150'>
<a name='151'>
        CALL <A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D'>wsm32D</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WSM32D_2">(th, q, qci, qrs,                               &amp;<a name='152'>
                     w, den, pii, p, delz, rain, rainncv,          &amp;<a name='153'>
                     delt,g, cpd, cpv, rd, rv, t0c,                &amp;<a name='154'>
                     ep1, ep2, qmin,                               &amp;<a name='155'>
                     XLS, XLV0, XLF0, den0, denr,                  &amp;<a name='156'>
                     cliq,cice,psat,                               &amp;<a name='157'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='158'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='159'>
                     its,ite, jts,jte, kts,kte                     )<a name='160'>
<a name='161'>
#else<a name='162'>
<a name='163'>
      DO j=jts,jte<a name='164'>
         DO k=kts,kte<a name='165'>
         DO i=its,ite<a name='166'>
            t(i,k)=th(i,k,j)*pii(i,k,j)<a name='167'>
         ENDDO<a name='168'>
         ENDDO<a name='169'>
         CALL <A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D'>wsm32D</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WSM32D_3">(t, q(ims,kms,j), qci(ims,kms,j)                           &amp;<a name='170'>
                    ,qrs(ims,kms,j),w(ims,kms,j), den(ims,kms,j)               &amp;<a name='171'>
                    ,p(ims,kms,j), delz(ims,kms,j)                             &amp;<a name='172'>
                    ,delt,g, cpd, cpv, rd, rv, t0c                             &amp;<a name='173'>
                    ,ep1, ep2, qmin                                            &amp;<a name='174'>
                    ,XLS, XLV0, XLF0, den0, denr                               &amp;<a name='175'>
                    ,cliq,cice,psat                                            &amp;<a name='176'>
                    ,j                                                         &amp;<a name='177'>
                    ,rain(ims,j), rainncv(ims,j)                               &amp;<a name='178'>
                    ,snow(ims,j),snowncv(ims,j)                                &amp;<a name='179'>
                    ,sr(ims,j)                                                 &amp;<a name='180'>
                    ,ids,ide, jds,jde, kds,kde                                 &amp;<a name='181'>
                    ,ims,ime, jms,jme, kms,kme                                 &amp;<a name='182'>
                    ,its,ite, jts,jte, kts,kte                                 &amp;<a name='183'>
                                                                               )<a name='184'>
         DO K=kts,kte<a name='185'>
         DO I=its,ite<a name='186'>
            th(i,k,j)=t(i,k)/pii(i,k,j)<a name='187'>
         ENDDO<a name='188'>
         ENDDO<a name='189'>
      ENDDO<a name='190'>
#endif<a name='191'>
<a name='192'>
<a name='193'>
#ifdef _ACCEL_PROF<a name='194'>
  call cpu_time(t2)<a name='195'>
#ifdef _OPENMP<a name='196'>
  l = omp_get_thread_num() + 1<a name='197'>
#else<a name='198'>
  l = 1<a name='199'>
#endif<a name='200'>
  wsm3_t(1,l) = wsm3_t(1,l) + (t2 - t1)<a name='201'>
#endif<a name='202'>
<a name='203'>
  END SUBROUTINE wsm3<a name='204'>
<a name='205'>
<a name='206'>
#ifdef _ACCEL<a name='207'>
<a name='208'>
<font color=#447700>!===================================================================<a name='209'></font>
<font color=#447700>!{<a name='210'></font>
<A NAME='WSM32D'><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='211'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wsm32D</font>(th, q, qci, qrs,                               &amp; <A href='../../call_to/WSM32D.html' TARGET='index'>3</A>,<A href='../../call_from/WSM32D.html' TARGET='index'>11</A><a name='212'>
                     w, den, pii, p, delz, rain, rainncv,          &amp;<a name='213'>
                     delt,g, cpd, cpv, rd, rv, t0c,                &amp;<a name='214'>
                     ep1, ep2, qmin,                               &amp;<a name='215'>
                     XLS, XLV0, XLF0, den0, denr,                  &amp;<a name='216'>
                     cliq,cice,psat,                               &amp;<a name='217'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='218'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='219'>
                     its,ite, jts,jte, kts,kte                     )<a name='220'>
<font color=#447700>!-------------------------------------------------------------------<a name='221'></font>
  IMPLICIT NONE<a name='222'>
<font color=#447700>!-------------------------------------------------------------------<a name='223'></font>
  INTEGER,      INTENT(IN   )    ::   ids,ide, jds,jde, kds,kde , &amp;<a name='224'>
                                      ims,ime, jms,jme, kms,kme , &amp;<a name='225'>
                                      its,ite, jts,jte, kts,kte<a name='226'>
  REAL, DIMENSION( ims:ime , kms:kme, ims:ims ),                  &amp;<a name='227'>
        INTENT(INOUT) ::                                          &amp;<a name='228'>
                                                               th<a name='229'>
  REAL, DIMENSION( ims:ime , kms:kme, ims:ims ),                  &amp;<a name='230'>
        INTENT(IN) ::                                             &amp;<a name='231'>
                                                               pii<a name='232'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),                  &amp;<a name='233'>
        INTENT(INOUT) ::                                          &amp;<a name='234'>
                                                               q, &amp;<a name='235'>
                                                             qci, &amp;<a name='236'>
                                                             qrs<a name='237'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),                  &amp;<a name='238'>
        INTENT(IN   ) ::                                       w, &amp;<a name='239'>
                                                             den, &amp;<a name='240'>
                                                               p, &amp;<a name='241'>
                                                            delz<a name='242'>
  REAL, DIMENSION( ims:ime , jms:jme ),                           &amp;<a name='243'>
        INTENT(INOUT) ::                                    rain, &amp;<a name='244'>
                                                         rainncv<a name='245'>
  REAL, INTENT(IN   ) ::                                    delt, &amp;<a name='246'>
                                                               g, &amp;<a name='247'>
                                                             cpd, &amp;<a name='248'>
                                                             cpv, &amp;<a name='249'>
                                                             t0c, &amp;<a name='250'>
                                                            den0, &amp;<a name='251'>
                                                              rd, &amp;<a name='252'>
                                                              rv, &amp;<a name='253'>
                                                             ep1, &amp;<a name='254'>
                                                             ep2, &amp;<a name='255'>
                                                            qmin, &amp;<a name='256'>
                                                             XLS, &amp;<a name='257'>
                                                            XLV0, &amp;<a name='258'>
                                                            XLF0, &amp;<a name='259'>
                                                            cliq, &amp;<a name='260'>
                                                            cice, &amp;<a name='261'>
                                                            psat, &amp;<a name='262'>
                                                            denr<a name='263'>
<font color=#447700>! LOCAL VAR<a name='264'></font>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='265'>
        rh, qs, denfac, rslope, rslope2, rslope3, rslopeb,        &amp;<a name='266'>
        pgen, paut, pacr, pisd, pres, pcon, fall, falk,           &amp;<a name='267'>
        xl, cpm, work1, work2, xni, qs0, n0sfac<a name='268'>
<font color=#447700>! LOCAL VAR<a name='269'></font>
  REAL, DIMENSION( its:ite , kts:kte, jts:jte ) ::   t<a name='270'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                         &amp;<a name='271'>
              falkc, work1c, work2c, fallc<a name='272'>
  INTEGER :: mstep, numdt<a name='273'>
  LOGICAL, DIMENSION( its:ite ) :: flgcld<a name='274'>
  REAL  ::  pi,                                                   &amp;<a name='275'>
            cpmcal, xlcal, lamdar, lamdas, diffus,                &amp;<a name='276'>
            viscos, xka, venfac, conden, diffac,                  &amp;<a name='277'>
            x, y, z, a, b, c, d, e,                               &amp;<a name='278'>
            qdt, pvt, qik, delq, facq, qrsci, frzmlt,             &amp;<a name='279'>
            snomlt, hold, holdrs, facqci, supcol, coeres,         &amp;<a name='280'>
            supsat, dtcld, xmi, qciik, delqci, eacrs, satdt,      &amp;<a name='281'>
            qimax, diameter, xni0, roqi0<a name='282'>
  REAL  :: holdc, holdci<a name='283'>
  INTEGER :: i, k, j,                                 &amp;<a name='284'>
            iprt, latd, lond, loop, loops, ifsat, kk, n<a name='285'>
<font color=#447700>!<a name='286'></font>
<a name='287'>
#define INL<a name='288'>
#ifdef INL<a name='289'>
<font color=#447700>! Temporaries used for inlining fpvs function<a name='290'></font>
  REAL  :: dldti, xb, xai, tr, xbi, xa, hvap, cvap, hsub, dldt, ttp<a name='291'>
#endif<a name='292'>
<a name='293'>
<a name='294'>
<a name='295'>
<font color=#447700>!=================================================================<a name='296'></font>
<font color=#447700>!   compute internal functions<a name='297'></font>
<font color=#447700>!<a name='298'></font>
      cpmcal(x) = cpd*(1.-max(x,qmin))+max(x,qmin)*cpv<a name='299'>
      xlcal(x) = xlv0-xlv1*(x-t0c)<a name='300'>
<font color=#447700>!     tvcal(x,y) = x+x*ep1*max(y,qmin)<a name='301'></font>
<font color=#447700>!----------------------------------------------------------------<a name='302'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='303'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='304'></font>
<font color=#447700>!<a name='305'></font>
      lamdar(x,y)=(pidn0r/(x*y))**.25<a name='306'>
      lamdas(x,y,z)=(pidn0s*z/(x*y))**.25<a name='307'>
<font color=#447700>!<a name='308'></font>
<font color=#447700>!----------------------------------------------------------------<a name='309'></font>
<font color=#447700>!     diffus: diffusion coefficient of the water vapor<a name='310'></font>
<font color=#447700>!     viscos: kinematic viscosity(m2s-1)<a name='311'></font>
<font color=#447700>!<a name='312'></font>
      diffus(x,y) = 8.794e-5*x**1.81/y<a name='313'>
      viscos(x,y) = 1.496e-6*x**1.5/(x+120.)/y<a name='314'>
      xka(x,y) = 1.414e3*viscos(x,y)*y<a name='315'>
      diffac(a,b,c,d,e) = d*a*a/(xka(c,d)*rv*c*c)+1./(e*diffus(c,b))<a name='316'>
      venfac(a,b,c) = (viscos(b,c)/diffus(b,a))**(.3333333)       &amp;<a name='317'>
             /viscos(b,c)**(.5)*(den0/c)**0.25<a name='318'>
      conden(a,b,c,d,e) = (max(b,qmin)-c)/(1.+d*d/(rv*e)*c/(a*a))<a name='319'>
<font color=#447700>!<a name='320'></font>
      pi = 4. * atan(1.)<a name='321'>
<font color=#447700>!<a name='322'></font>
<font color=#447700>!----------------------------------------------------------------<a name='323'></font>
<font color=#447700>!     compute the minor time steps.<a name='324'></font>
<font color=#447700>!<a name='325'></font>
      loops = max(int(delt/dtcldcr+0.5),1)<a name='326'>
      dtcld = delt/loops<a name='327'>
      if(delt.le.dtcldcr) dtcld = delt<a name='328'>
#ifdef INL<a name='329'>
      cvap = cpv<a name='330'>
      hvap=xlv0<a name='331'>
      hsub=xls<a name='332'>
      ttp=t0c+0.1<a name='333'>
      dldt=cvap-cliq<a name='334'>
      xa=-dldt/rv<a name='335'>
      xb=xa+hvap/(rv*ttp)<a name='336'>
      dldti=cvap-cice<a name='337'>
      xai=-dldti/rv<a name='338'>
      xbi=xai+hsub/(rv*ttp)<a name='339'>
#endif<a name='340'>
<font color=#447700>!<a name='341'></font>
<font color=#447700>!----------------------------------------------------------------<a name='342'></font>
<font color=#447700>!     paddint 0 for negative values generated by dynamics<a name='343'></font>
<font color=#447700>!<a name='344'></font>
<font color=#447700>!$acc region &amp;<a name='345'></font>
<font color=#447700>!$acc        local(t) &amp;<a name='346'></font>
<font color=#447700>!$acc        copyin(delz(:,:,:),p(:,:,:)) &amp;<a name='347'></font>
<font color=#447700>!$acc        copyin(den(:,:,:),w(:,:,:)) &amp;<a name='348'></font>
<font color=#447700>!$acc        copy(q(:,:,:),qci(:,:,:),qrs(:,:,:))<a name='349'></font>
<font color=#447700>!$acc do &amp;<a name='350'></font>
<font color=#447700>!$acc        private(rh,qs,denfac,rslope,rslope2,rslope3,rslopeb) &amp;<a name='351'></font>
<font color=#447700>!$acc        private(pgen,paut,pacr,pisd,pres,pcon,fall,falk) &amp;<a name='352'></font>
<font color=#447700>!$acc        private(xl,cpm,work1,work2,xni,qs0,n0sfac) &amp;<a name='353'></font>
<font color=#447700>!$acc        private(falkc,work1c,work2c,fallc) &amp;<a name='354'></font>
<font color=#447700>!$acc        parallel<a name='355'></font>
      do j = jts, jte<a name='356'>
<font color=#447700>!$acc do &amp;<a name='357'></font>
<font color=#447700>!$acc        private(numdt,mstep) &amp;<a name='358'></font>
<font color=#447700>!$acc        kernel vector(96)<a name='359'></font>
      do i = its, ite<a name='360'>
      do k = kts, kte<a name='361'>
            t(i,k,j)=th(i,k,j)*pii(i,k,j)<a name='362'>
          qci(i,k,j) = max(qci(i,k,j),0.0)<a name='363'>
          qrs(i,k,j) = max(qrs(i,k,j),0.0)<a name='364'>
        enddo<a name='365'>
<font color=#447700>!<a name='366'></font>
<font color=#447700>!----------------------------------------------------------------<a name='367'></font>
<font color=#447700>!     latent heat for phase changes and heat capacity. neglect the<a name='368'></font>
<font color=#447700>!     changes during microphysical process calculation<a name='369'></font>
<font color=#447700>!     emanuel(1994)<a name='370'></font>
<font color=#447700>!<a name='371'></font>
      do k = kts, kte<a name='372'>
          cpm(i,k) = cpmcal(q(i,k,j))<a name='373'>
          xl(i,k) = xlcal(t(i,k,j))<a name='374'>
      enddo<a name='375'>
<font color=#447700>!<a name='376'></font>
      do loop = 1,loops<a name='377'>
<font color=#447700>!<a name='378'></font>
<font color=#447700>!----------------------------------------------------------------<a name='379'></font>
<font color=#447700>!     initialize the large scale variables<a name='380'></font>
<font color=#447700>!<a name='381'></font>
        mstep = 1<a name='382'>
        flgcld(i) = .true.<a name='383'>
<font color=#447700>!<a name='384'></font>
      do k = kts, kte<a name='385'>
          denfac(i,k) = sqrt(den0/den(i,k,j))<a name='386'>
      enddo<a name='387'>
<font color=#447700>!<a name='388'></font>
      do k = kts, kte<a name='389'>
#ifndef INL<a name='390'>
          qs(i,k) = <A href='../../html_code/phys/module_mp_wsm6.F.html#FPVS'>fpvs</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVS_1">(t(i,k,j),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='391'>
          qs0(i,k) = <A href='../../html_code/phys/module_mp_wsm6.F.html#FPVS'>fpvs</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVS_2">(t(i,k,j),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='392'>
#else<a name='393'>
          tr=ttp/t(i,k,j)<a name='394'>
          if(t(i,k,j).lt.ttp) then<a name='395'>
            qs(i,k) =psat*(tr**xai)*exp(xbi*(1.-tr))<a name='396'>
          else<a name='397'>
            qs(i,k) =psat*(tr**xa)*exp(xb*(1.-tr))<a name='398'>
          endif<a name='399'>
          qs0(i,k)  =psat*(tr**xa)*exp(xb*(1.-tr))<a name='400'>
#endif<a name='401'>
          qs0(i,k) = (qs0(i,k)-qs(i,k))/qs(i,k)<a name='402'>
          qs(i,k) = ep2 * qs(i,k) / (p(i,k,j) - qs(i,k))<a name='403'>
          qs(i,k) = max(qs(i,k),qmin)<a name='404'>
          rh(i,k) = max(q(i,k,j) / qs(i,k),qmin)<a name='405'>
      enddo<a name='406'>
<font color=#447700>!<a name='407'></font>
<font color=#447700>!----------------------------------------------------------------<a name='408'></font>
<font color=#447700>!     initialize the variables for microphysical physics<a name='409'></font>
<font color=#447700>!<a name='410'></font>
<font color=#447700>!<a name='411'></font>
      do k = kts, kte<a name='412'>
          pres(i,k) = 0.<a name='413'>
          paut(i,k) = 0.<a name='414'>
          pacr(i,k) = 0.<a name='415'>
          pgen(i,k) = 0.<a name='416'>
          pisd(i,k) = 0.<a name='417'>
          pcon(i,k) = 0.<a name='418'>
          fall(i,k) = 0.<a name='419'>
          falk(i,k) = 0.<a name='420'>
          fallc(i,k) = 0.<a name='421'>
          falkc(i,k) = 0.<a name='422'>
          xni(i,k) = 1.e3<a name='423'>
      enddo<a name='424'>
<font color=#447700>!<a name='425'></font>
<font color=#447700>!----------------------------------------------------------------<a name='426'></font>
<font color=#447700>!     compute the fallout term:<a name='427'></font>
<font color=#447700>!     first, vertical terminal velosity for minor loops<a name='428'></font>
<font color=#447700>!---------------------------------------------------------------<a name='429'></font>
<font color=#447700>! n0s: Intercept parameter for snow [m-4] [HDC 6]<a name='430'></font>
<font color=#447700>!---------------------------------------------------------------<a name='431'></font>
      do k = kts, kte<a name='432'>
          supcol = t0c-t(i,k,j)<a name='433'>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='434'>
          if(t(i,k,j).ge.t0c) then<a name='435'>
            if(qrs(i,k,j).le.qcrmin)then<a name='436'>
              rslope(i,k) = rslopermax<a name='437'>
              rslopeb(i,k) = rsloperbmax<a name='438'>
              rslope2(i,k) = rsloper2max<a name='439'>
              rslope3(i,k) = rsloper3max<a name='440'>
            else<a name='441'>
              rslope(i,k) = 1./lamdar(qrs(i,k,j),den(i,k,j))<a name='442'>
              rslopeb(i,k) = rslope(i,k)**bvtr<a name='443'>
              rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='444'>
              rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='445'>
            endif<a name='446'>
          else<a name='447'>
            if(qrs(i,k,j).le.qcrmin)then<a name='448'>
              rslope(i,k) = rslopesmax<a name='449'>
              rslopeb(i,k) = rslopesbmax<a name='450'>
              rslope2(i,k) = rslopes2max<a name='451'>
              rslope3(i,k) = rslopes3max<a name='452'>
            else<a name='453'>
              rslope(i,k) = 1./lamdas(qrs(i,k,j),den(i,k,j),n0sfac(i,k))<a name='454'>
              rslopeb(i,k) = rslope(i,k)**bvts<a name='455'>
              rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='456'>
              rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='457'>
            endif<a name='458'>
          endif<a name='459'>
<font color=#447700>!-------------------------------------------------------------<a name='460'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='461'></font>
<font color=#447700>!-------------------------------------------------------------<a name='462'></font>
          xni(i,k) = min(max(5.38e7*(den(i,k,j)                           &amp;<a name='463'>
                    *max(qci(i,k,j),qmin))**0.75,1.e3),1.e6)<a name='464'>
      enddo<a name='465'>
<font color=#447700>!<a name='466'></font>
      numdt = 1<a name='467'>
      do k = kte, kts, -1<a name='468'>
          if(t(i,k,j).lt.t0c) then<a name='469'>
            pvt = pvts<a name='470'>
          else<a name='471'>
            pvt = pvtr<a name='472'>
          endif<a name='473'>
          work1(i,k) = pvt*rslopeb(i,k)*denfac(i,k)<a name='474'>
          work2(i,k) = work1(i,k)/delz(i,k,j)<a name='475'>
          numdt = max(int(work2(i,k)*dtcld+1.),1)<a name='476'>
          if(numdt.ge.mstep) mstep = numdt<a name='477'>
      enddo<a name='478'>
<font color=#447700>!<a name='479'></font>
      do n = 1, mstep<a name='480'>
        k = kte<a name='481'>
            falk(i,k) = den(i,k,j)*qrs(i,k,j)*work2(i,k)/mstep<a name='482'>
            hold = falk(i,k)<a name='483'>
            fall(i,k) = fall(i,k)+falk(i,k)<a name='484'>
            holdrs = qrs(i,k,j)<a name='485'>
            qrs(i,k,j) = max(qrs(i,k,j)-falk(i,k)*dtcld/den(i,k,j),0.)<a name='486'>
        do k = kte-1, kts, -1<a name='487'>
              falk(i,k) = den(i,k,j)*qrs(i,k,j)*work2(i,k)/mstep<a name='488'>
              hold = falk(i,k)<a name='489'>
              fall(i,k) = fall(i,k)+falk(i,k)<a name='490'>
              holdrs = qrs(i,k,j)<a name='491'>
              qrs(i,k,j) = max(qrs(i,k,j)-(falk(i,k)                        &amp;<a name='492'>
                        -falk(i,k+1)*delz(i,k+1,j)/delz(i,k,j))*dtcld/den(i,k,j),0.)<a name='493'>
        enddo<a name='494'>
      enddo<a name='495'>
<font color=#447700>!---------------------------------------------------------------<a name='496'></font>
<font color=#447700>! Vice [ms-1] : fallout of ice crystal [HDC 5a]<a name='497'></font>
<font color=#447700>!---------------------------------------------------------------<a name='498'></font>
      mstep = 1<a name='499'>
      numdt = 1<a name='500'>
      do k = kte, kts, -1<a name='501'>
          if(t(i,k,j).lt.t0c.and.qci(i,k,j).gt.0.) then<a name='502'>
            xmi = den(i,k,j)*qci(i,k,j)/xni(i,k)<a name='503'>
            diameter  = dicon * sqrt(xmi)<a name='504'>
            work1c(i,k) = 1.49e4*diameter**1.31<a name='505'>
          else<a name='506'>
            work1c(i,k) = 0.<a name='507'>
          endif<a name='508'>
          if(qci(i,k,j).le.0.) then<a name='509'>
            work2c(i,k) = 0.<a name='510'>
          else<a name='511'>
            work2c(i,k) = work1c(i,k)/delz(i,k,j)<a name='512'>
          endif<a name='513'>
          numdt = max(int(work2c(i,k)*dtcld+1.),1)<a name='514'>
          if(numdt.ge.mstep) mstep = numdt<a name='515'>
      enddo<a name='516'>
<font color=#447700>!<a name='517'></font>
      do n = 1, mstep<a name='518'>
        k = kte<a name='519'>
            falkc(i,k) = den(i,k,j)*qci(i,k,j)*work2c(i,k)/mstep<a name='520'>
            holdc = falkc(i,k)<a name='521'>
            fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='522'>
            holdci = qci(i,k,j)<a name='523'>
            qci(i,k,j) = max(qci(i,k,j)-falkc(i,k)*dtcld/den(i,k,j),0.)<a name='524'>
        do k = kte-1, kts, -1<a name='525'>
              falkc(i,k) = den(i,k,j)*qci(i,k,j)*work2c(i,k)/mstep<a name='526'>
              holdc = falkc(i,k)<a name='527'>
              fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='528'>
              holdci = qci(i,k,j)<a name='529'>
              qci(i,k,j) = max(qci(i,k,j)-(falkc(i,k)                       &amp;<a name='530'>
                        -falkc(i,k+1)*delz(i,k+1,j)/delz(i,k,j))*dtcld/den(i,k,j),0.)<a name='531'>
        enddo<a name='532'>
      enddo<a name='533'>
<font color=#447700>!<a name='534'></font>
<font color=#447700>!----------------------------------------------------------------<a name='535'></font>
<font color=#447700>!     compute the freezing/melting term. [D89 B16-B17]<a name='536'></font>
<font color=#447700>!     freezing occurs one layer above the melting level<a name='537'></font>
<font color=#447700>!<a name='538'></font>
        mstep = 0<a name='539'>
<font color=#447700>!<a name='540'></font>
      do k = kts, kte<a name='541'>
          if(t(i,k,j).ge.t0c) then<a name='542'>
            mstep = k<a name='543'>
          endif<a name='544'>
      enddo<a name='545'>
<font color=#447700>!<a name='546'></font>
        if(mstep.ne.0.and.w(i,mstep,j).gt.0.) then<a name='547'>
          work1(i,1) = float(mstep + 1)<a name='548'>
          work1(i,2) = float(mstep)<a name='549'>
        else<a name='550'>
          work1(i,1) = float(mstep)<a name='551'>
          work1(i,2) = float(mstep)<a name='552'>
        endif<a name='553'>
<font color=#447700>!<a name='554'></font>
        k  = int(work1(i,1)+0.5)<a name='555'>
        kk = int(work1(i,2)+0.5)<a name='556'>
        if(k*kk.ge.1) then<a name='557'>
          qrsci = qrs(i,k,j) + qci(i,k,j)<a name='558'>
          if(qrsci.gt.0..or.fall(i,kk).gt.0.) then<a name='559'>
            frzmlt = min(max(-w(i,k,j)*qrsci/delz(i,k,j),-qrsci/dtcld),    &amp;<a name='560'>
                     qrsci/dtcld)<a name='561'>
            snomlt = min(max(fall(i,kk)/den(i,kk,j),-qrs(i,k,j)/dtcld),    &amp;<a name='562'>
                     qrs(i,k,j)/dtcld)<a name='563'>
            if(k.eq.kk) then<a name='564'>
              t(i,k,j) = t(i,k,j) - xlf0/cpm(i,k)*(frzmlt+snomlt)*dtcld<a name='565'>
            else<a name='566'>
              t(i,k,j) = t(i,k,j) - xlf0/cpm(i,k)*frzmlt*dtcld<a name='567'>
              t(i,kk,j) = t(i,kk,j) - xlf0/cpm(i,kk)*snomlt*dtcld<a name='568'>
            endif<a name='569'>
          endif<a name='570'>
        endif<a name='571'>
<font color=#447700>!<a name='572'></font>
<font color=#447700>!----------------------------------------------------------------<a name='573'></font>
<font color=#447700>!      rain (unit is mm/sec;kgm-2s-1: /1000*delt ===&gt; m)==&gt; mm for wrf<a name='574'></font>
<font color=#447700>!<a name='575'></font>
        if(fall(i,1).gt.0.) then<a name='576'>
          rainncv(i,j) = fall(i,1)*delz(i,1,j)/denr*dtcld*1000.<a name='577'>
          rain(i,j) = fall(i,1)*delz(i,1,j)/denr*dtcld*1000.                &amp;<a name='578'>
                  + rain(i,j)<a name='579'>
        endif<a name='580'>
<font color=#447700>!<a name='581'></font>
<font color=#447700>!----------------------------------------------------------------<a name='582'></font>
<font color=#447700>!     rsloper: reverse of the slope parameter of the rain(m,j)<a name='583'></font>
<font color=#447700>!     xka:    thermal conductivity of air(jm-1s-1k-1)<a name='584'></font>
<font color=#447700>!     work1:  the thermodynamic term in the denominator associated with<a name='585'></font>
<font color=#447700>!             heat conduction and vapor diffusion<a name='586'></font>
<font color=#447700>!             (ry88, y93, h85)<a name='587'></font>
<font color=#447700>!     work2: parameter associated with the ventilation effects(y93)<a name='588'></font>
<font color=#447700>!<a name='589'></font>
      do k = kts, kte<a name='590'>
          if(t(i,k,j).ge.t0c) then<a name='591'>
            if(qrs(i,k,j).le.qcrmin)then<a name='592'>
              rslope(i,k) = rslopermax<a name='593'>
              rslopeb(i,k) = rsloperbmax<a name='594'>
              rslope2(i,k) = rsloper2max<a name='595'>
              rslope3(i,k) = rsloper3max<a name='596'>
            else<a name='597'>
              rslope(i,k) = 1./lamdar(qrs(i,k,j),den(i,k,j))<a name='598'>
              rslopeb(i,k) = rslope(i,k)**bvtr<a name='599'>
              rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='600'>
              rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='601'>
            endif<a name='602'>
          else<a name='603'>
            if(qrs(i,k,j).le.qcrmin)then<a name='604'>
              rslope(i,k) = rslopesmax<a name='605'>
              rslopeb(i,k) = rslopesbmax<a name='606'>
              rslope2(i,k) = rslopes2max<a name='607'>
              rslope3(i,k) = rslopes3max<a name='608'>
            else<a name='609'>
              rslope(i,k) = 1./lamdas(qrs(i,k,j),den(i,k,j),n0sfac(i,k))<a name='610'>
              rslopeb(i,k) = rslope(i,k)**bvts<a name='611'>
              rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='612'>
              rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='613'>
            endif<a name='614'>
          endif<a name='615'>
      enddo<a name='616'>
<font color=#447700>!<a name='617'></font>
      do k = kts, kte<a name='618'>
          if(t(i,k,j).ge.t0c) then<a name='619'>
            work1(i,k) = diffac(xl(i,k),p(i,k,j),t(i,k,j),den(i,k,j),qs(i,k))<a name='620'>
          else<a name='621'>
            work1(i,k) = diffac(xls,p(i,k,j),t(i,k,j),den(i,k,j),qs(i,k))<a name='622'>
          endif<a name='623'>
          work2(i,k) = venfac(p(i,k,j),t(i,k,j),den(i,k,j))<a name='624'>
      enddo<a name='625'>
<font color=#447700>!<a name='626'></font>
      do k = kts, kte<a name='627'>
          supsat = max(q(i,k,j),qmin)-qs(i,k)<a name='628'>
          satdt = supsat/dtcld<a name='629'>
          if(t(i,k,j).ge.t0c) then<a name='630'>
<font color=#447700>!<a name='631'></font>
<font color=#447700>!===============================================================<a name='632'></font>
<font color=#447700>!<a name='633'></font>
<font color=#447700>! warm rain processes<a name='634'></font>
<font color=#447700>!<a name='635'></font>
<font color=#447700>! - follows the processes in RH83 and LFO except for autoconcersion<a name='636'></font>
<font color=#447700>!<a name='637'></font>
<font color=#447700>!===============================================================<a name='638'></font>
<font color=#447700>!---------------------------------------------------------------<a name='639'></font>
<font color=#447700>! paut1: auto conversion rate from cloud to rain [HDC 16]<a name='640'></font>
<font color=#447700>!        (C-&gt;R)<a name='641'></font>
<font color=#447700>!---------------------------------------------------------------<a name='642'></font>
            if(qci(i,k,j).gt.qc0) then<a name='643'>
              paut(i,k) = qck1*qci(i,k,j)**(7./3.)<a name='644'>
              paut(i,k) = min(paut(i,k),qci(i,k,j)/dtcld)<a name='645'>
            endif<a name='646'>
<font color=#447700>!---------------------------------------------------------------<a name='647'></font>
<font color=#447700>! pracw: accretion of cloud water by rain [D89 B15]<a name='648'></font>
<font color=#447700>!        (C-&gt;R)<a name='649'></font>
<font color=#447700>!---------------------------------------------------------------<a name='650'></font>
            if(qrs(i,k,j).gt.qcrmin.and.qci(i,k,j).gt.qmin) then<a name='651'>
                pacr(i,k) = min(pacrr*rslope3(i,k)*rslopeb(i,k)          &amp;<a name='652'>
                     *qci(i,k,j)*denfac(i,k),qci(i,k,j)/dtcld)<a name='653'>
            endif<a name='654'>
<font color=#447700>!---------------------------------------------------------------<a name='655'></font>
<font color=#447700>! pres1: evaporation/condensation rate of rain [HDC 14]<a name='656'></font>
<font color=#447700>!        (V-&gt;R or R-&gt;V)<a name='657'></font>
<font color=#447700>!---------------------------------------------------------------<a name='658'></font>
            if(qrs(i,k,j).gt.0.) then<a name='659'>
                coeres = rslope2(i,k)*sqrt(rslope(i,k)*rslopeb(i,k))<a name='660'>
                pres(i,k) = (rh(i,k)-1.)*(precr1*rslope2(i,k)            &amp;<a name='661'>
                         +precr2*work2(i,k)*coeres)/work1(i,k)<a name='662'>
              if(pres(i,k).lt.0.) then<a name='663'>
                pres(i,k) = max(pres(i,k),-qrs(i,k,j)/dtcld)<a name='664'>
                pres(i,k) = max(pres(i,k),satdt/2)<a name='665'>
              else<a name='666'>
                pres(i,k) = min(pres(i,k),satdt/2)<a name='667'>
              endif<a name='668'>
            endif<a name='669'>
          else<a name='670'>
<font color=#447700>!<a name='671'></font>
<font color=#447700>!===============================================================<a name='672'></font>
<font color=#447700>!<a name='673'></font>
<font color=#447700>! cold rain processes<a name='674'></font>
<font color=#447700>!<a name='675'></font>
<font color=#447700>! - follows the revised ice microphysics processes in HDC<a name='676'></font>
<font color=#447700>! - the processes same as in RH83 and LFO behave<a name='677'></font>
<font color=#447700>!   following ice crystal hapits defined in HDC, inclduing<a name='678'></font>
<font color=#447700>!   intercept parameter for snow (n0s), ice crystal number<a name='679'></font>
<font color=#447700>!   concentration (ni), ice nuclei number concentration<a name='680'></font>
<font color=#447700>!   (n0i), ice diameter (d)<a name='681'></font>
<font color=#447700>!<a name='682'></font>
<font color=#447700>!===============================================================<a name='683'></font>
<font color=#447700>!<a name='684'></font>
            supcol = t0c-t(i,k,j)<a name='685'>
            ifsat = 0<a name='686'>
<font color=#447700>!-------------------------------------------------------------<a name='687'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='688'></font>
<font color=#447700>!-------------------------------------------------------------<a name='689'></font>
            xni(i,k) = min(max(5.38e7*(den(i,k,j)                         &amp;<a name='690'>
                      *max(qci(i,k,j),qmin))**0.75,1.e3),1.e6)<a name='691'>
            eacrs = exp(0.05*(-supcol))<a name='692'>
<font color=#447700>!<a name='693'></font>
            if(qrs(i,k,j).gt.qcrmin.and.qci(i,k,j).gt.qmin) then<a name='694'>
              pacr(i,k) = min(pacrs*n0sfac(i,k)*eacrs*rslope3(i,k)       &amp;<a name='695'>
                       *rslopeb(i,k)*qci(i,k,j)*denfac(i,k),qci(i,k,j)/dtcld)<a name='696'>
            endif<a name='697'>
<font color=#447700>!-------------------------------------------------------------<a name='698'></font>
<font color=#447700>! pisd: Deposition/Sublimation rate of ice [HDC 9]<a name='699'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I or I-&gt;V)<a name='700'></font>
<font color=#447700>!-------------------------------------------------------------<a name='701'></font>
            if(qci(i,k,j).gt.0.) then<a name='702'>
              xmi = den(i,k,j)*qci(i,k,j)/xni(i,k)<a name='703'>
              diameter = dicon * sqrt(xmi)<a name='704'>
              pisd(i,k) = 4.*diameter*xni(i,k)*(rh(i,k)-1.)              &amp;<a name='705'>
                        /work1(i,k)<a name='706'>
              if(pisd(i,k).lt.0.) then<a name='707'>
                pisd(i,k) = max(pisd(i,k),satdt/2)<a name='708'>
                pisd(i,k) = max(pisd(i,k),-qci(i,k,j)/dtcld)<a name='709'>
              else<a name='710'>
                pisd(i,k) = min(pisd(i,k),satdt/2)<a name='711'>
              endif<a name='712'>
              if(abs(pisd(i,k)).ge.abs(satdt)) ifsat = 1<a name='713'>
            endif<a name='714'>
<font color=#447700>!-------------------------------------------------------------<a name='715'></font>
<font color=#447700>! pres2: deposition/sublimation rate of snow [HDC 14]<a name='716'></font>
<font color=#447700>!        (V-&gt;S or S-&gt;V)<a name='717'></font>
<font color=#447700>!-------------------------------------------------------------<a name='718'></font>
            if(qrs(i,k,j).gt.0..and.ifsat.ne.1) then<a name='719'>
              coeres = rslope2(i,k)*sqrt(rslope(i,k)*rslopeb(i,k))<a name='720'>
              pres(i,k) = (rh(i,k)-1.)*n0sfac(i,k)*(precs1*rslope2(i,k)   &amp;<a name='721'>
                        +precs2*work2(i,k)*coeres)/work1(i,k)<a name='722'>
              if(pres(i,k).lt.0.) then<a name='723'>
                pres(i,k) = max(pres(i,k),-qrs(i,k,j)/dtcld)<a name='724'>
                pres(i,k) = max(pres(i,k),satdt/2)<a name='725'>
              else<a name='726'>
                pres(i,k) = min(pres(i,k),satdt/2)<a name='727'>
              endif<a name='728'>
              if(abs(pisd(i,k)+pres(i,k)).ge.abs(satdt)) ifsat = 1<a name='729'>
            endif<a name='730'>
<font color=#447700>!-------------------------------------------------------------<a name='731'></font>
<font color=#447700>! pgen: generation(nucleation) of ice from vapor [HDC 7-8]<a name='732'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I)<a name='733'></font>
<font color=#447700>!-------------------------------------------------------------<a name='734'></font>
            if(supsat.gt.0.and.ifsat.ne.1) then<a name='735'>
              xni0 = 1.e3*exp(0.1*supcol)<a name='736'>
              roqi0 = 4.92e-11*xni0**1.33<a name='737'>
              pgen(i,k) = max(0.,(roqi0/den(i,k,j)-max(qci(i,k,j),0.))/dtcld)<a name='738'>
              pgen(i,k) = min(pgen(i,k),satdt)<a name='739'>
            endif<a name='740'>
<font color=#447700>!-------------------------------------------------------------<a name='741'></font>
<font color=#447700>! paut2: conversion(aggregation) of ice to snow [HDC 12]<a name='742'></font>
<font color=#447700>!       (T&lt;T0: I-&gt;S)<a name='743'></font>
<font color=#447700>!-------------------------------------------------------------<a name='744'></font>
            if(qci(i,k,j).gt.0.) then<a name='745'>
              qimax = roqimax/den(i,k,j)<a name='746'>
              paut(i,k) = max(0.,(qci(i,k,j)-qimax)/dtcld)<a name='747'>
            endif<a name='748'>
          endif<a name='749'>
      enddo<a name='750'>
<font color=#447700>!<a name='751'></font>
<font color=#447700>!----------------------------------------------------------------<a name='752'></font>
<font color=#447700>!     check mass conservation of generation terms and feedback to the<a name='753'></font>
<font color=#447700>!     large scale<a name='754'></font>
<font color=#447700>!<a name='755'></font>
      do k = kts, kte<a name='756'>
          qciik = max(qmin,qci(i,k,j))<a name='757'>
          delqci = (paut(i,k)+pacr(i,k)-pgen(i,k)-pisd(i,k))*dtcld<a name='758'>
          if(delqci.ge.qciik) then<a name='759'>
            facqci = qciik/delqci<a name='760'>
            paut(i,k) = paut(i,k)*facqci<a name='761'>
            pacr(i,k) = pacr(i,k)*facqci<a name='762'>
            pgen(i,k) = pgen(i,k)*facqci<a name='763'>
            pisd(i,k) = pisd(i,k)*facqci<a name='764'>
          endif<a name='765'>
          qik = max(qmin,q(i,k,j))<a name='766'>
          delq = (pres(i,k)+pgen(i,k)+pisd(i,k))*dtcld<a name='767'>
          if(delq.ge.qik) then<a name='768'>
            facq = qik/delq<a name='769'>
            pres(i,k) = pres(i,k)*facq<a name='770'>
            pgen(i,k) = pgen(i,k)*facq<a name='771'>
            pisd(i,k) = pisd(i,k)*facq<a name='772'>
          endif<a name='773'>
          work2(i,k) = -pres(i,k)-pgen(i,k)-pisd(i,k)<a name='774'>
          q(i,k,j) = q(i,k,j)+work2(i,k)*dtcld<a name='775'>
          qci(i,k,j) = max(qci(i,k,j)-(paut(i,k)+pacr(i,k)-pgen(i,k)     &amp;<a name='776'>
                   -pisd(i,k))*dtcld,0.)<a name='777'>
          qrs(i,k,j) = max(qrs(i,k,j)+(paut(i,k)+pacr(i,k)               &amp;<a name='778'>
                   +pres(i,k))*dtcld,0.)<a name='779'>
          if(t(i,k,j).lt.t0c) then<a name='780'>
            t(i,k,j) = t(i,k,j)-xls*work2(i,k)/cpm(i,k)*dtcld<a name='781'>
          else<a name='782'>
            t(i,k,j) = t(i,k,j)-xl(i,k)*work2(i,k)/cpm(i,k)*dtcld<a name='783'>
          endif<a name='784'>
      enddo<a name='785'>
<font color=#447700>!<a name='786'></font>
      do k = kts, kte<a name='787'>
#ifndef INL<a name='788'>
          qs(i,k) = <A href='../../html_code/phys/module_mp_wsm6.F.html#FPVS'>fpvs</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FPVS_3">(t(i,k,j),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='789'>
#else<a name='790'>
          tr=ttp/t(i,k,j)<a name='791'>
          qs(i,k)=psat*(tr**xa)*exp(xb*(1.-tr))<a name='792'>
#endif<a name='793'>
          qs(i,k) = ep2 * qs(i,k) / (p(i,k,j) - qs(i,k))<a name='794'>
          qs(i,k) = max(qs(i,k),qmin)<a name='795'>
          denfac(i,k) = sqrt(den0/den(i,k,j))<a name='796'>
      enddo<a name='797'>
<font color=#447700>!<a name='798'></font>
<font color=#447700>!----------------------------------------------------------------<a name='799'></font>
<font color=#447700>!  pcon: condensational/evaporational rate of cloud water [RH83 A6]<a name='800'></font>
<font color=#447700>!     if there exists additional water vapor condensated/if<a name='801'></font>
<font color=#447700>!     evaporation of cloud water is not enough to remove subsaturation<a name='802'></font>
<font color=#447700>!<a name='803'></font>
      do k = kts, kte<a name='804'>
          work1(i,k) = conden(t(i,k,j),q(i,k,j),qs(i,k),xl(i,k),cpm(i,k))<a name='805'>
          work2(i,k) = qci(i,k,j)+work1(i,k)<a name='806'>
          pcon(i,k) = min(max(work1(i,k),0.),max(q(i,k,j),0.))/dtcld<a name='807'>
          if(qci(i,k,j).gt.0..and.work1(i,k).lt.0.and.t(i,k,j).gt.t0c)      &amp;<a name='808'>
            pcon(i,k) = max(work1(i,k),-qci(i,k,j))/dtcld<a name='809'>
          q(i,k,j) = q(i,k,j)-pcon(i,k)*dtcld<a name='810'>
          qci(i,k,j) = max(qci(i,k,j)+pcon(i,k)*dtcld,0.)<a name='811'>
          t(i,k,j) = t(i,k,j)+pcon(i,k)*xl(i,k)/cpm(i,k)*dtcld<a name='812'>
      enddo<a name='813'>
<font color=#447700>!<a name='814'></font>
<font color=#447700>!----------------------------------------------------------------<a name='815'></font>
<font color=#447700>!     padding for small values<a name='816'></font>
<font color=#447700>!<a name='817'></font>
      do k = kts, kte<a name='818'>
          if(qci(i,k,j).le.qmin) qci(i,k,j) = 0.0<a name='819'>
      enddo<a name='820'>
<font color=#447700>!<a name='821'></font>
      enddo                  <font color=#447700>! big loops<a name='822'></font>
         DO K=kts,kte<a name='823'>
            th(i,k,j)=t(i,k,j)/pii(i,k,j)<a name='824'>
         ENDDO<a name='825'>
      enddo<a name='826'>
      enddo<a name='827'>
<font color=#447700>!$acc end region<a name='828'></font>
  END SUBROUTINE wsm32D <font color=#447700>!}<a name='829'></font>
<a name='830'>
#else<a name='831'>
<a name='832'>
<a name='833'>
<font color=#447700>!===================================================================<a name='834'></font>
<font color=#447700>!<a name='835'></font>
<A NAME='WSM32D'><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='836'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wsm32D</font>(t, q, qci, qrs,w, den, p, delz                             &amp; <A href='../../call_to/WSM32D.html' TARGET='index'>3</A>,<A href='../../call_from/WSM32D.html' TARGET='index'>11</A><a name='837'>
                   ,delt,g, cpd, cpv, rd, rv, t0c                              &amp;<a name='838'>
                   ,ep1, ep2, qmin                                             &amp;<a name='839'>
                   ,XLS, XLV0, XLF0, den0, denr                                &amp;<a name='840'>
                   ,cliq,cice,psat                                             &amp;<a name='841'>
                   ,lat                                                        &amp;<a name='842'>
                   ,rain, rainncv                                              &amp;<a name='843'>
                   ,snow,snowncv                                               &amp;<a name='844'>
                   ,sr                                                         &amp;<a name='845'>
                   ,ids,ide, jds,jde, kds,kde                                  &amp;<a name='846'>
                   ,ims,ime, jms,jme, kms,kme                                  &amp;<a name='847'>
                   ,its,ite, jts,jte, kts,kte                                  &amp;<a name='848'>
                                                                               )<a name='849'>
<font color=#447700>!-------------------------------------------------------------------<a name='850'></font>
  IMPLICIT NONE<a name='851'>
<font color=#447700>!-------------------------------------------------------------------<a name='852'></font>
  INTEGER,      INTENT(IN   )    ::                 ids,ide, jds,jde, kds,kde, &amp;<a name='853'>
                                                    ims,ime, jms,jme, kms,kme, &amp;<a name='854'>
                                                    its,ite, jts,jte, kts,kte, &amp;<a name='855'>
                                                    lat<a name='856'>
  REAL, DIMENSION( its:ite , kts:kte ),                                        &amp;<a name='857'>
        INTENT(INOUT) ::                                                       &amp;<a name='858'>
                                                                            t<a name='859'>
  REAL, DIMENSION( ims:ime , kms:kme ),                                        &amp;<a name='860'>
        INTENT(INOUT) ::                                                       &amp;<a name='861'>
                                                                            q, &amp;<a name='862'>
                                                                          qci, &amp;<a name='863'>
                                                                          qrs<a name='864'>
  REAL, DIMENSION( ims:ime , kms:kme ),                                        &amp;<a name='865'>
        INTENT(IN   ) ::                                                    w, &amp;<a name='866'>
                                                                          den, &amp;<a name='867'>
                                                                            p, &amp;<a name='868'>
                                                                         delz<a name='869'>
  REAL, INTENT(IN   ) ::                                                 delt, &amp;<a name='870'>
                                                                            g, &amp;<a name='871'>
                                                                          cpd, &amp;<a name='872'>
                                                                          cpv, &amp;<a name='873'>
                                                                          t0c, &amp;<a name='874'>
                                                                         den0, &amp;<a name='875'>
                                                                           rd, &amp;<a name='876'>
                                                                           rv, &amp;<a name='877'>
                                                                          ep1, &amp;<a name='878'>
                                                                          ep2, &amp;<a name='879'>
                                                                         qmin, &amp;<a name='880'>
                                                                          XLS, &amp;<a name='881'>
                                                                         XLV0, &amp;<a name='882'>
                                                                         XLF0, &amp;<a name='883'>
                                                                         cliq, &amp;<a name='884'>
                                                                         cice, &amp;<a name='885'>
                                                                         psat, &amp;<a name='886'>
                                                                         denr<a name='887'>
  REAL, DIMENSION( ims:ime ),                                                  &amp;<a name='888'>
        INTENT(INOUT) ::                                                 rain, &amp;<a name='889'>
                                                                      rainncv<a name='890'>
<a name='891'>
  REAL, DIMENSION( ims:ime ),     OPTIONAL,                                    &amp;<a name='892'>
        INTENT(INOUT) ::                                                 snow, &amp;<a name='893'>
                                                                      snowncv, &amp;<a name='894'>
                                                                           sr<a name='895'>
<font color=#447700>! LOCAL VAR<a name='896'></font>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                      &amp;<a name='897'>
                                                                           rh, &amp;<a name='898'>
                                                                           qs, &amp;<a name='899'>
                                                                       denfac, &amp;<a name='900'>
                                                                       rslope, &amp;<a name='901'>
                                                                      rslope2, &amp;<a name='902'>
                                                                      rslope3, &amp;<a name='903'>
                                                                      rslopeb<a name='904'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                      &amp;<a name='905'>
                                                                         pgen, &amp;<a name='906'>
                                                                         pisd, &amp;<a name='907'>
                                                                         paut, &amp;<a name='908'>
                                                                         pacr, &amp;<a name='909'>
                                                                         pres, &amp;<a name='910'>
                                                                         pcon<a name='911'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                      &amp;<a name='912'>
                                                                         fall, &amp;<a name='913'>
                                                                         falk, &amp;<a name='914'>
                                                                           xl, &amp;<a name='915'>
                                                                          cpm, &amp;<a name='916'>
                                                                        work1, &amp;<a name='917'>
                                                                        work2, &amp;<a name='918'>
                                                                          xni, &amp;<a name='919'>
                                                                          qs0, &amp;<a name='920'>
                                                                       n0sfac<a name='921'>
  REAL, DIMENSION( its:ite , kts:kte ) ::                                      &amp;<a name='922'>
                                                                        falkc, &amp;<a name='923'>
                                                                       work1c, &amp;<a name='924'>
                                                                       work2c, &amp;<a name='925'>
                                                                        fallc<a name='926'>
<a name='927'>
  INTEGER, DIMENSION( its:ite ) ::                                      kwork1,&amp;<a name='928'>
                                                                        kwork2<a name='929'>
<a name='930'>
  INTEGER, DIMENSION( its:ite ) ::                                      mstep, &amp;<a name='931'>
                                                                        numdt<a name='932'>
  LOGICAL, DIMENSION( its:ite ) :: flgcld<a name='933'>
  REAL  ::  pi,                                                                &amp;<a name='934'>
            cpmcal, xlcal, lamdar, lamdas, diffus,                             &amp;<a name='935'>
            viscos, xka, venfac, conden, diffac,                               &amp;<a name='936'>
            x, y, z, a, b, c, d, e,                                            &amp;<a name='937'>
            fallsum, fallsum_qsi, vt2i,vt2s,acrfac,                            &amp;      <a name='938'>
            qdt, pvt, qik, delq, facq, qrsci, frzmlt,                          &amp;<a name='939'>
            snomlt, hold, holdrs, facqci, supcol, coeres,                      &amp;<a name='940'>
            supsat, dtcld, xmi, qciik, delqci, eacrs, satdt,                   &amp;<a name='941'>
            qimax, diameter, xni0, roqi0, supice,holdc, holdci<a name='942'>
  INTEGER :: i, j, k, mstepmax,                                                &amp;<a name='943'>
            iprt, latd, lond, loop, loops, ifsat, kk, n<a name='944'>
<font color=#447700>! Temporaries used for inlining fpvs function<a name='945'></font>
  REAL  :: dldti, xb, xai, tr, xbi, xa, hvap, cvap, hsub, dldt, ttp<a name='946'>
<font color=#447700>! variables for optimization<a name='947'></font>
  REAL, DIMENSION( its:ite )    :: tvec1<a name='948'>
<font color=#447700>!<a name='949'></font>
<font color=#447700>!=================================================================<a name='950'></font>
<font color=#447700>!   compute internal functions<a name='951'></font>
<font color=#447700>!<a name='952'></font>
      cpmcal(x) = cpd*(1.-max(x,qmin))+max(x,qmin)*cpv<a name='953'>
      xlcal(x) = xlv0-xlv1*(x-t0c)<a name='954'>
<font color=#447700>!----------------------------------------------------------------<a name='955'></font>
<font color=#447700>!     size distributions: (x=mixing ratio, y=air density):<a name='956'></font>
<font color=#447700>!     valid for mixing ratio &gt; 1.e-9 kg/kg.<a name='957'></font>
<font color=#447700>!<a name='958'></font>
<font color=#447700>! Optimizatin : A**B =&gt; exp(log(A)*(B))<a name='959'></font>
      lamdar(x,y)=   sqrt(sqrt(pidn0r/(x*y)))      <font color=#447700>! (pidn0r/(x*y))**.25<a name='960'></font>
      lamdas(x,y,z)= sqrt(sqrt(pidn0s*z/(x*y)))    <font color=#447700>! (pidn0s*z/(x*y))**.25<a name='961'></font>
<font color=#447700>!<a name='962'></font>
<font color=#447700>!----------------------------------------------------------------<a name='963'></font>
<font color=#447700>!     diffus: diffusion coefficient of the water vapor<a name='964'></font>
<font color=#447700>!     viscos: kinematic viscosity(m2s-1)<a name='965'></font>
<font color=#447700>!<a name='966'></font>
      diffus(x,y) = 8.794e-5 * exp(log(x)*(1.81)) / y        <font color=#447700>! 8.794e-5*x**1.81/y<a name='967'></font>
      viscos(x,y) = 1.496e-6 * (x*sqrt(x)) /(x+120.)/y  <font color=#447700>! 1.496e-6*x**1.5/(x+120.)/y<a name='968'></font>
      xka(x,y) = 1.414e3*viscos(x,y)*y<a name='969'>
      diffac(a,b,c,d,e) = d*a*a/(xka(c,d)*rv*c*c)+1./(e*diffus(c,b))<a name='970'>
<font color=#447700>!      venfac(a,b,c) = (viscos(b,c)/diffus(b,a))**(.3333333)                   &amp;<a name='971'></font>
<font color=#447700>!                      /viscos(b,c)**(.5)*(den0/c)**0.25<a name='972'></font>
      venfac(a,b,c) = exp(log((viscos(b,c)/diffus(b,a)))*((.3333333)))         &amp;<a name='973'>
                     /sqrt(viscos(b,c))*sqrt(sqrt(den0/c))<a name='974'>
      conden(a,b,c,d,e) = (max(b,qmin)-c)/(1.+d*d/(rv*e)*c/(a*a))<a name='975'>
<font color=#447700>!<a name='976'></font>
      pi = 4. * atan(1.)<a name='977'>
<font color=#447700>!<a name='978'></font>
<font color=#447700>!----------------------------------------------------------------<a name='979'></font>
<font color=#447700>!     paddint 0 for negative values generated by dynamics<a name='980'></font>
<font color=#447700>!<a name='981'></font>
      do k = kts, kte<a name='982'>
        do i = its, ite<a name='983'>
          qci(i,k) = max(qci(i,k),0.0)<a name='984'>
          qrs(i,k) = max(qrs(i,k),0.0)<a name='985'>
        enddo<a name='986'>
      enddo<a name='987'>
<font color=#447700>!<a name='988'></font>
<font color=#447700>!----------------------------------------------------------------<a name='989'></font>
<font color=#447700>!     latent heat for phase changes and heat capacity. neglect the<a name='990'></font>
<font color=#447700>!     changes during microphysical process calculation<a name='991'></font>
<font color=#447700>!     emanuel(1994)<a name='992'></font>
<font color=#447700>!<a name='993'></font>
      do k = kts, kte<a name='994'>
        do i = its, ite<a name='995'>
          cpm(i,k) = cpmcal(q(i,k))<a name='996'>
          xl(i,k) = xlcal(t(i,k))<a name='997'>
        enddo<a name='998'>
      enddo<a name='999'>
<font color=#447700>!<a name='1000'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1001'></font>
<font color=#447700>!     compute the minor time steps.<a name='1002'></font>
<font color=#447700>!<a name='1003'></font>
      loops = max(nint(delt/dtcldcr),1)<a name='1004'>
      dtcld = delt/loops<a name='1005'>
      if(delt.le.dtcldcr) dtcld = delt<a name='1006'>
<font color=#447700>!<a name='1007'></font>
      do loop = 1,loops<a name='1008'>
<font color=#447700>!<a name='1009'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1010'></font>
<font color=#447700>!     initialize the large scale variables<a name='1011'></font>
<font color=#447700>!<a name='1012'></font>
      do i = its, ite<a name='1013'>
        mstep(i) = 1<a name='1014'>
        flgcld(i) = .true.<a name='1015'>
      enddo<a name='1016'>
<font color=#447700>!<a name='1017'></font>
<font color=#447700>!     do k = kts, kte<a name='1018'></font>
<font color=#447700>!       do i = its, ite<a name='1019'></font>
<font color=#447700>!         denfac(i,k) = sqrt(den0/den(i,k))<a name='1020'></font>
<font color=#447700>!       enddo<a name='1021'></font>
<font color=#447700>!     enddo<a name='1022'></font>
      do k = kts, kte<a name='1023'>
        CALL <A href='../../html_code/frame/libmassv.F.html#VREC'>VREC</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VREC_4">( tvec1(its), den(its,k), ite-its+1)<a name='1024'>
        do i = its, ite<a name='1025'>
          tvec1(i) = tvec1(i)*den0<a name='1026'>
        enddo<a name='1027'>
        CALL <A href='../../html_code/frame/libmassv.F.html#VSQRT'>VSQRT</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM32D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VSQRT_4">( denfac(its,k), tvec1(its), ite-its+1)<a name='1028'>
      enddo<a name='1029'>
<font color=#447700>!<a name='1030'></font>
<font color=#447700>! Inline expansion for fpvs<a name='1031'></font>
<font color=#447700>!         qs(i,k) = fpvs(t(i,k),1,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1032'></font>
<font color=#447700>!         qs0(i,k) = fpvs(t(i,k),0,rd,rv,cpv,cliq,cice,xlv0,xls,psat,t0c)<a name='1033'></font>
      cvap = cpv<a name='1034'>
      hvap=xlv0<a name='1035'>
      hsub=xls<a name='1036'>
      ttp=t0c+0.01<a name='1037'>
      dldt=cvap-cliq<a name='1038'>
      xa=-dldt/rv<a name='1039'>
      xb=xa+hvap/(rv*ttp)<a name='1040'>
      dldti=cvap-cice<a name='1041'>
      xai=-dldti/rv<a name='1042'>
      xbi=xai+hsub/(rv*ttp)<a name='1043'>
      do k = kts, kte<a name='1044'>
        do i = its, ite<a name='1045'>
<font color=#447700>!         tr=ttp/t(i,k)<a name='1046'></font>
<font color=#447700>!         if(t(i,k).lt.ttp) then<a name='1047'></font>
<font color=#447700>!           qs(i,k) =psat*(tr**xai)*exp(xbi*(1.-tr))<a name='1048'></font>
<font color=#447700>!         else<a name='1049'></font>
<font color=#447700>!           qs(i,k) =psat*(tr**xa)*exp(xb*(1.-tr))<a name='1050'></font>
<font color=#447700>!         endif<a name='1051'></font>
<font color=#447700>!         qs0(i,k)  =psat*(tr**xa)*exp(xb*(1.-tr))<a name='1052'></font>
          tr=ttp/t(i,k)<a name='1053'>
          if(t(i,k).lt.ttp) then<a name='1054'>
            qs(i,k) =psat*(exp(log(tr)*(xai)))*exp(xbi*(1.-tr))<a name='1055'>
          else<a name='1056'>
            qs(i,k) =psat*(exp(log(tr)*(xa)))*exp(xb*(1.-tr))<a name='1057'>
          endif<a name='1058'>
          qs0(i,k)  =psat*(exp(log(tr)*(xa)))*exp(xb*(1.-tr))<a name='1059'>
          qs0(i,k) = (qs0(i,k)-qs(i,k))/qs(i,k)<a name='1060'>
          qs(i,k) = ep2 * qs(i,k) / (p(i,k) - qs(i,k))<a name='1061'>
          qs(i,k) = max(qs(i,k),qmin)<a name='1062'>
          rh(i,k) = max(q(i,k) / qs(i,k),qmin)<a name='1063'>
        enddo<a name='1064'>
      enddo<a name='1065'>
<font color=#447700>!<a name='1066'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1067'></font>
<font color=#447700>!     initialize the variables for microphysical physics<a name='1068'></font>
<font color=#447700>!<a name='1069'></font>
<font color=#447700>!<a name='1070'></font>
      do k = kts, kte<a name='1071'>
        do i = its, ite<a name='1072'>
          pres(i,k) = 0.<a name='1073'>
          paut(i,k) = 0.<a name='1074'>
          pacr(i,k) = 0.<a name='1075'>
          pgen(i,k) = 0.<a name='1076'>
          pisd(i,k) = 0.<a name='1077'>
          pcon(i,k) = 0.<a name='1078'>
          fall(i,k) = 0.<a name='1079'>
          falk(i,k) = 0.<a name='1080'>
          fallc(i,k) = 0.<a name='1081'>
          falkc(i,k) = 0.<a name='1082'>
          xni(i,k) = 1.e3<a name='1083'>
        enddo<a name='1084'>
      enddo<a name='1085'>
<font color=#447700>!<a name='1086'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1087'></font>
<font color=#447700>!     compute the fallout term:<a name='1088'></font>
<font color=#447700>!     first, vertical terminal velosity for minor loops<a name='1089'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1090'></font>
<font color=#447700>! n0s: Intercept parameter for snow [m-4] [HDC 6]<a name='1091'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1092'></font>
      do k = kts, kte<a name='1093'>
        do i = its, ite<a name='1094'>
          supcol = t0c-t(i,k)<a name='1095'>
          n0sfac(i,k) = max(min(exp(alpha*supcol),n0smax/n0s),1.)<a name='1096'>
          if(t(i,k).ge.t0c) then<a name='1097'>
            if(qrs(i,k).le.qcrmin)then<a name='1098'>
              rslope(i,k) = rslopermax<a name='1099'>
              rslopeb(i,k) = rsloperbmax<a name='1100'>
              rslope2(i,k) = rsloper2max<a name='1101'>
              rslope3(i,k) = rsloper3max<a name='1102'>
            else<a name='1103'>
              rslope(i,k) = 1./lamdar(qrs(i,k),den(i,k))<a name='1104'>
<font color=#447700>!             rslopeb(i,k) = rslope(i,k)**bvtr<a name='1105'></font>
              rslopeb(i,k) = exp(log(rslope(i,k))*(bvtr))<a name='1106'>
              rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='1107'>
              rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='1108'>
            endif<a name='1109'>
          else<a name='1110'>
            if(qrs(i,k).le.qcrmin)then<a name='1111'>
              rslope(i,k) = rslopesmax<a name='1112'>
              rslopeb(i,k) = rslopesbmax<a name='1113'>
              rslope2(i,k) = rslopes2max<a name='1114'>
              rslope3(i,k) = rslopes3max<a name='1115'>
            else<a name='1116'>
              rslope(i,k) = 1./lamdas(qrs(i,k),den(i,k),n0sfac(i,k))<a name='1117'>
<font color=#447700>!             rslopeb(i,k) = rslope(i,k)**bvts<a name='1118'></font>
              rslopeb(i,k) = exp(log(rslope(i,k))*(bvts))<a name='1119'>
              rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='1120'>
              rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='1121'>
            endif<a name='1122'>
          endif<a name='1123'>
<font color=#447700>!-------------------------------------------------------------<a name='1124'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='1125'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1126'></font>
<font color=#447700>!         xni(i,k) = min(max(5.38e7                                            &amp;<a name='1127'></font>
<font color=#447700>!                   *(den(i,k)*max(qci(i,k),qmin))**0.75,1.e3),1.e6)<a name='1128'></font>
          xni(i,k) = min(max(5.38e7                                            &amp;<a name='1129'>
                    *exp(log((den(i,k)*max(qci(i,k),qmin)))*(0.75)),1.e3),1.e6)<a name='1130'>
        enddo<a name='1131'>
      enddo<a name='1132'>
<font color=#447700>!<a name='1133'></font>
      mstepmax = 1<a name='1134'>
      numdt = 1<a name='1135'>
      do k = kte, kts, -1<a name='1136'>
        do i = its, ite<a name='1137'>
          if(t(i,k).lt.t0c) then<a name='1138'>
            pvt = pvts<a name='1139'>
          else<a name='1140'>
            pvt = pvtr<a name='1141'>
          endif<a name='1142'>
          work1(i,k) = pvt*rslopeb(i,k)*denfac(i,k)<a name='1143'>
          work2(i,k) = work1(i,k)/delz(i,k)<a name='1144'>
          numdt(i) = max(nint(work2(i,k)*dtcld+.5),1)<a name='1145'>
          if(numdt(i).ge.mstep(i)) mstep(i) = numdt(i)<a name='1146'>
        enddo<a name='1147'>
      enddo<a name='1148'>
      do i = its, ite<a name='1149'>
        if(mstepmax.le.mstep(i)) mstepmax = mstep(i)<a name='1150'>
      enddo<a name='1151'>
<font color=#447700>!<a name='1152'></font>
      do n = 1, mstepmax<a name='1153'>
        k = kte<a name='1154'>
        do i = its, ite<a name='1155'>
          if(n.le.mstep(i)) then<a name='1156'>
            falk(i,k) = den(i,k)*qrs(i,k)*work2(i,k)/mstep(i)<a name='1157'>
            hold = falk(i,k)<a name='1158'>
            fall(i,k) = fall(i,k)+falk(i,k)<a name='1159'>
            holdrs = qrs(i,k)<a name='1160'>
            qrs(i,k) = max(qrs(i,k)-falk(i,k)*dtcld/den(i,k),0.)<a name='1161'>
          endif<a name='1162'>
        enddo<a name='1163'>
        do k = kte-1, kts, -1<a name='1164'>
          do i = its, ite<a name='1165'>
            if(n.le.mstep(i)) then<a name='1166'>
              falk(i,k) = den(i,k)*qrs(i,k)*work2(i,k)/mstep(i)<a name='1167'>
              hold = falk(i,k)<a name='1168'>
              fall(i,k) = fall(i,k)+falk(i,k)<a name='1169'>
              holdrs = qrs(i,k)<a name='1170'>
              qrs(i,k) = max(qrs(i,k)-(falk(i,k)                               &amp;<a name='1171'>
                        -falk(i,k+1)*delz(i,k+1)/delz(i,k))*dtcld/den(i,k),0.)<a name='1172'>
            endif<a name='1173'>
          enddo<a name='1174'>
        enddo<a name='1175'>
      enddo<a name='1176'>
<font color=#447700>!---------------------------------------------------------------<a name='1177'></font>
<font color=#447700>! Vice [ms-1] : fallout of ice crystal [HDC 5a]<a name='1178'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1179'></font>
      mstepmax = 1<a name='1180'>
      mstep = 1<a name='1181'>
      numdt = 1<a name='1182'>
      do k = kte, kts, -1<a name='1183'>
        do i = its, ite<a name='1184'>
          if(t(i,k).lt.t0c.and.qci(i,k).gt.0.) then<a name='1185'>
            xmi = den(i,k)*qci(i,k)/xni(i,k)<a name='1186'>
<font color=#447700>!           diameter  = dicon * sqrt(xmi)<a name='1187'></font>
<font color=#447700>!           work1c(i,k) = 1.49e4*diameter**1.31<a name='1188'></font>
            diameter  = max(dicon * sqrt(xmi), 1.e-25)<a name='1189'>
            work1c(i,k) = 1.49e4*exp(log(diameter)*(1.31))<a name='1190'>
          else<a name='1191'>
            work1c(i,k) = 0.<a name='1192'>
          endif<a name='1193'>
          if(qci(i,k).le.0.) then<a name='1194'>
            work2c(i,k) = 0.<a name='1195'>
          else<a name='1196'>
            work2c(i,k) = work1c(i,k)/delz(i,k)<a name='1197'>
          endif<a name='1198'>
          numdt(i) = max(nint(work2c(i,k)*dtcld+.5),1)<a name='1199'>
          if(numdt(i).ge.mstep(i)) mstep(i) = numdt(i)<a name='1200'>
        enddo<a name='1201'>
      enddo<a name='1202'>
      do i = its, ite<a name='1203'>
        if(mstepmax.le.mstep(i)) mstepmax = mstep(i)<a name='1204'>
      enddo<a name='1205'>
<font color=#447700>!<a name='1206'></font>
      do n = 1, mstepmax<a name='1207'>
        k = kte<a name='1208'>
        do i = its, ite<a name='1209'>
          if (n.le.mstep(i)) then<a name='1210'>
            falkc(i,k) = den(i,k)*qci(i,k)*work2c(i,k)/mstep(i)<a name='1211'>
            holdc = falkc(i,k)<a name='1212'>
            fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='1213'>
            holdci = qci(i,k)<a name='1214'>
            qci(i,k) = max(qci(i,k)-falkc(i,k)*dtcld/den(i,k),0.)<a name='1215'>
          endif<a name='1216'>
        enddo<a name='1217'>
        do k = kte-1, kts, -1<a name='1218'>
          do i = its, ite<a name='1219'>
            if (n.le.mstep(i)) then<a name='1220'>
              falkc(i,k) = den(i,k)*qci(i,k)*work2c(i,k)/mstep(i)<a name='1221'>
              holdc = falkc(i,k)<a name='1222'>
              fallc(i,k) = fallc(i,k)+falkc(i,k)<a name='1223'>
              holdci = qci(i,k)<a name='1224'>
              qci(i,k) = max(qci(i,k)-(falkc(i,k)                              &amp;<a name='1225'>
                        -falkc(i,k+1)*delz(i,k+1)/delz(i,k))*dtcld/den(i,k),0.)<a name='1226'>
            endif<a name='1227'>
          enddo<a name='1228'>
        enddo<a name='1229'>
      enddo<a name='1230'>
<font color=#447700>!<a name='1231'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1232'></font>
<font color=#447700>!     compute the freezing/melting term. [D89 B16-B17]<a name='1233'></font>
<font color=#447700>!     freezing occurs one layer above the melting level<a name='1234'></font>
<font color=#447700>!<a name='1235'></font>
      do i = its, ite<a name='1236'>
        mstep(i) = 0<a name='1237'>
      enddo<a name='1238'>
      do k = kts, kte<a name='1239'>
<font color=#447700>!<a name='1240'></font>
        do i = its, ite<a name='1241'>
          if(t(i,k).ge.t0c) then<a name='1242'>
            mstep(i) = k<a name='1243'>
          endif<a name='1244'>
        enddo<a name='1245'>
      enddo<a name='1246'>
<font color=#447700>!<a name='1247'></font>
      do i = its, ite<a name='1248'>
        kwork2(i) = mstep(i)<a name='1249'>
        kwork1(i) = mstep(i)<a name='1250'>
        if(mstep(i).ne.0) then<a name='1251'>
          if (w(i,mstep(i)).gt.0.) then<a name='1252'>
            kwork1(i) = mstep(i) + 1<a name='1253'>
          endif<a name='1254'>
        endif<a name='1255'>
      enddo<a name='1256'>
<font color=#447700>!<a name='1257'></font>
      do i = its, ite<a name='1258'>
        k  = kwork1(i)<a name='1259'>
        kk = kwork2(i)<a name='1260'>
        if(k*kk.ge.1) then<a name='1261'>
          qrsci = qrs(i,k) + qci(i,k)<a name='1262'>
          if(qrsci.gt.0..or.fall(i,kk).gt.0.) then<a name='1263'>
            frzmlt = min(max(-w(i,k)*qrsci/delz(i,k),-qrsci/dtcld),            &amp;<a name='1264'>
                    qrsci/dtcld)<a name='1265'>
            snomlt = min(max(fall(i,kk)/den(i,kk),-qrs(i,k)/dtcld),            &amp;<a name='1266'>
                    qrs(i,k)/dtcld)<a name='1267'>
            if(k.eq.kk) then<a name='1268'>
              t(i,k) = t(i,k) - xlf0/cpm(i,k)*(frzmlt+snomlt)*dtcld<a name='1269'>
            else<a name='1270'>
              t(i,k) = t(i,k) - xlf0/cpm(i,k)*frzmlt*dtcld<a name='1271'>
              t(i,kk) = t(i,kk) - xlf0/cpm(i,kk)*snomlt*dtcld<a name='1272'>
            endif<a name='1273'>
          endif<a name='1274'>
        endif<a name='1275'>
      enddo<a name='1276'>
<font color=#447700>!<a name='1277'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1278'></font>
<font color=#447700>!      rain (unit is mm/sec;kgm-2s-1: /1000*delt ===&gt; m)==&gt; mm for wrf<a name='1279'></font>
<font color=#447700>!<a name='1280'></font>
      do i = its, ite<a name='1281'>
        fallsum = fall(i,1)<a name='1282'>
        fallsum_qsi = 0.<a name='1283'>
        if((t0c-t(i,1)).gt.0) then<a name='1284'>
        fallsum = fallsum+fallc(i,1)<a name='1285'>
        fallsum_qsi = fall(i,1)+fallc(i,1)<a name='1286'>
        endif<a name='1287'>
        rainncv(i) = 0.<a name='1288'>
        if(fallsum.gt.0.) then<a name='1289'>
          rainncv(i) = fallsum*delz(i,1)/denr*dtcld*1000.<a name='1290'>
          rain(i) = fallsum*delz(i,1)/denr*dtcld*1000. + rain(i)<a name='1291'>
        endif<a name='1292'>
        IF ( PRESENT (snowncv) .AND. PRESENT (snow)) THEN<a name='1293'>
        snowncv(i) = 0.<a name='1294'>
        if(fallsum_qsi.gt.0.) then<a name='1295'>
          snowncv(i) = fallsum_qsi*delz(i,kts)/denr*dtcld*1000.<a name='1296'>
          snow(i) = fallsum_qsi*delz(i,kts)/denr*dtcld*1000. + snow(i)<a name='1297'>
        endif<a name='1298'>
        ENDIF<a name='1299'>
        sr(i) = 0.<a name='1300'>
        if(fallsum.gt.0.) sr(i) = fallsum_qsi*delz(i,kts)/denr*dtcld*1000.     &amp;<a name='1301'>
                                 /(rainncv(i)+1.e-12)<a name='1302'>
      enddo<a name='1303'>
<font color=#447700>!<a name='1304'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1305'></font>
<font color=#447700>!     rsloper: reverse of the slope parameter of the rain(m)<a name='1306'></font>
<font color=#447700>!     xka:    thermal conductivity of air(jm-1s-1k-1)<a name='1307'></font>
<font color=#447700>!     work1:  the thermodynamic term in the denominator associated with<a name='1308'></font>
<font color=#447700>!             heat conduction and vapor diffusion<a name='1309'></font>
<font color=#447700>!             (ry88, y93, h85)<a name='1310'></font>
<font color=#447700>!     work2: parameter associated with the ventilation effects(y93)<a name='1311'></font>
<font color=#447700>!<a name='1312'></font>
      do k = kts, kte<a name='1313'>
        do i = its, ite<a name='1314'>
          if(t(i,k).ge.t0c) then<a name='1315'>
            if(qrs(i,k).le.qcrmin)then<a name='1316'>
              rslope(i,k) = rslopermax<a name='1317'>
              rslopeb(i,k) = rsloperbmax<a name='1318'>
              rslope2(i,k) = rsloper2max<a name='1319'>
              rslope3(i,k) = rsloper3max<a name='1320'>
            else<a name='1321'>
              rslope(i,k) = 1./lamdar(qrs(i,k),den(i,k))<a name='1322'>
              rslopeb(i,k) = exp(log(rslope(i,k))*(bvtr))<a name='1323'>
              rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='1324'>
              rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='1325'>
            endif<a name='1326'>
          else<a name='1327'>
            if(qrs(i,k).le.qcrmin)then<a name='1328'>
              rslope(i,k) = rslopesmax<a name='1329'>
              rslopeb(i,k) = rslopesbmax<a name='1330'>
              rslope2(i,k) = rslopes2max<a name='1331'>
              rslope3(i,k) = rslopes3max<a name='1332'>
            else<a name='1333'>
              rslope(i,k) = 1./lamdas(qrs(i,k),den(i,k),n0sfac(i,k))<a name='1334'>
              rslopeb(i,k) = exp(log(rslope(i,k))*(bvts))<a name='1335'>
              rslope2(i,k) = rslope(i,k)*rslope(i,k)<a name='1336'>
              rslope3(i,k) = rslope2(i,k)*rslope(i,k)<a name='1337'>
            endif<a name='1338'>
          endif<a name='1339'>
        enddo<a name='1340'>
      enddo<a name='1341'>
<font color=#447700>!<a name='1342'></font>
      do k = kts, kte<a name='1343'>
        do i = its, ite<a name='1344'>
          if(t(i,k).ge.t0c) then<a name='1345'>
            work1(i,k) = diffac(xl(i,k),p(i,k),t(i,k),den(i,k),qs(i,k))<a name='1346'>
          else<a name='1347'>
            work1(i,k) = diffac(xls,p(i,k),t(i,k),den(i,k),qs(i,k))<a name='1348'>
          endif<a name='1349'>
          work2(i,k) = venfac(p(i,k),t(i,k),den(i,k))<a name='1350'>
        enddo<a name='1351'>
      enddo<a name='1352'>
<font color=#447700>!<a name='1353'></font>
      do k = kts, kte<a name='1354'>
        do i = its, ite<a name='1355'>
          supsat = max(q(i,k),qmin)-qs(i,k)<a name='1356'>
          satdt = supsat/dtcld<a name='1357'>
          if(t(i,k).ge.t0c) then<a name='1358'>
<font color=#447700>!<a name='1359'></font>
<font color=#447700>!===============================================================<a name='1360'></font>
<font color=#447700>!<a name='1361'></font>
<font color=#447700>! warm rain processes<a name='1362'></font>
<font color=#447700>!<a name='1363'></font>
<font color=#447700>! - follows the processes in RH83 and LFO except for autoconcersion<a name='1364'></font>
<font color=#447700>!<a name='1365'></font>
<font color=#447700>!===============================================================<a name='1366'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1367'></font>
<font color=#447700>! praut: auto conversion rate from cloud to rain [HDC 16]<a name='1368'></font>
<font color=#447700>!        (C-&gt;R)<a name='1369'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1370'></font>
            if(qci(i,k).gt.qc0) then<a name='1371'>
<font color=#447700>!             paut(i,k) = qck1*qci(i,k)**(7./3.)<a name='1372'></font>
              paut(i,k) = qck1*exp(log(qci(i,k))*((7./3.)))<a name='1373'>
              paut(i,k) = min(paut(i,k),qci(i,k)/dtcld)<a name='1374'>
            endif<a name='1375'>
<font color=#447700>!---------------------------------------------------------------<a name='1376'></font>
<font color=#447700>! pracw: accretion of cloud water by rain [HL A40] [D89 B15]<a name='1377'></font>
<font color=#447700>!        (C-&gt;R)<a name='1378'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1379'></font>
            if(qrs(i,k).gt.qcrmin.and.qci(i,k).gt.qmin) then<a name='1380'>
                pacr(i,k) = min(pacrr*rslope3(i,k)*rslopeb(i,k)                &amp;<a name='1381'>
                     *qci(i,k)*denfac(i,k),qci(i,k)/dtcld)<a name='1382'>
            endif<a name='1383'>
<font color=#447700>!---------------------------------------------------------------<a name='1384'></font>
<font color=#447700>! prevp: evaporation/condensation rate of rain [HDC 14]<a name='1385'></font>
<font color=#447700>!        (V-&gt;R or R-&gt;V)<a name='1386'></font>
<font color=#447700>!---------------------------------------------------------------<a name='1387'></font>
            if(qrs(i,k).gt.0.) then<a name='1388'>
                coeres = rslope2(i,k)*sqrt(rslope(i,k)*rslopeb(i,k))<a name='1389'>
                pres(i,k) = (rh(i,k)-1.)*(precr1*rslope2(i,k)                  &amp;<a name='1390'>
                         +precr2*work2(i,k)*coeres)/work1(i,k)<a name='1391'>
              if(pres(i,k).lt.0.) then<a name='1392'>
                pres(i,k) = max(pres(i,k),-qrs(i,k)/dtcld)<a name='1393'>
                pres(i,k) = max(pres(i,k),satdt/2)<a name='1394'>
              else<a name='1395'>
                pres(i,k) = min(pres(i,k),satdt/2)<a name='1396'>
              endif<a name='1397'>
            endif<a name='1398'>
          else<a name='1399'>
<font color=#447700>!<a name='1400'></font>
<font color=#447700>!===============================================================<a name='1401'></font>
<font color=#447700>!<a name='1402'></font>
<font color=#447700>! cold rain processes<a name='1403'></font>
<font color=#447700>!<a name='1404'></font>
<font color=#447700>! - follows the revised ice microphysics processes in HDC<a name='1405'></font>
<font color=#447700>! - the processes same as in RH83 and LFO behave<a name='1406'></font>
<font color=#447700>!   following ice crystal hapits defined in HDC, inclduing<a name='1407'></font>
<font color=#447700>!   intercept parameter for snow (n0s), ice crystal number<a name='1408'></font>
<font color=#447700>!   concentration (ni), ice nuclei number concentration<a name='1409'></font>
<font color=#447700>!   (n0i), ice diameter (d)<a name='1410'></font>
<font color=#447700>!<a name='1411'></font>
<font color=#447700>!===============================================================<a name='1412'></font>
<font color=#447700>!<a name='1413'></font>
            supcol = t0c-t(i,k)<a name='1414'>
            ifsat = 0<a name='1415'>
<font color=#447700>!-------------------------------------------------------------<a name='1416'></font>
<font color=#447700>! Ni: ice crystal number concentraiton   [HDC 5c]<a name='1417'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1418'></font>
<font color=#447700>!           xni(i,k) = min(max(5.38e7                                          &amp;<a name='1419'></font>
<font color=#447700>!                     *(den(i,k)*max(qci(i,k),qmin))**0.75,1.e3),1.e6)<a name='1420'></font>
            xni(i,k) = min(max(5.38e7                                          &amp;<a name='1421'>
                      *exp(log((den(i,k)*max(qci(i,k),qmin)))*(0.75)),1.e3),1.e6)<a name='1422'>
            eacrs = exp(0.07*(-supcol))<a name='1423'>
<font color=#447700>!<a name='1424'></font>
            if(qrs(i,k).gt.qcrmin.and.qci(i,k).gt.qmin) then<a name='1425'>
              xmi = den(i,k)*qci(i,k)/xni(i,k)<a name='1426'>
              diameter  = min(dicon * sqrt(xmi),dimax)<a name='1427'>
              vt2i = 1.49e4*diameter**1.31<a name='1428'>
<font color=#447700>!             vt2i = 1.49e4*exp((log(diameter))*(1.31))<a name='1429'></font>
              vt2s = pvts*rslopeb(i,k)*denfac(i,k)<a name='1430'>
<font color=#447700>!-------------------------------------------------------------<a name='1431'></font>
<font color=#447700>! praci: Accretion of cloud ice by rain [HL A15] [LFO 25]<a name='1432'></font>
<font color=#447700>!        (T&lt;T0: I-&gt;R)<a name='1433'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1434'></font>
              acrfac = 2.*rslope3(i,k)+2.*diameter*rslope2(i,k)                &amp;<a name='1435'>
                      +diameter**2*rslope(i,k)<a name='1436'>
              pacr(i,k) = min(pi*qci(i,k)*eacrs*n0s*n0sfac(i,k)                &amp;<a name='1437'>
                       *abs(vt2s-vt2i)*acrfac/4.,qci(i,k)/dtcld)<a name='1438'>
            endif<a name='1439'>
<font color=#447700>!-------------------------------------------------------------<a name='1440'></font>
<font color=#447700>! pidep: Deposition/Sublimation rate of ice [HDC 9]<a name='1441'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I or I-&gt;V)<a name='1442'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1443'></font>
            if(qci(i,k).gt.0.) then<a name='1444'>
              xmi = den(i,k)*qci(i,k)/xni(i,k)<a name='1445'>
              diameter = dicon * sqrt(xmi)<a name='1446'>
              pisd(i,k) = 4.*diameter*xni(i,k)*(rh(i,k)-1.)/work1(i,k)<a name='1447'>
              if(pisd(i,k).lt.0.) then<a name='1448'>
                pisd(i,k) = max(pisd(i,k),satdt/2)<a name='1449'>
                pisd(i,k) = max(pisd(i,k),-qci(i,k)/dtcld)<a name='1450'>
              else<a name='1451'>
                pisd(i,k) = min(pisd(i,k),satdt/2)<a name='1452'>
              endif<a name='1453'>
              if(abs(pisd(i,k)).ge.abs(satdt)) ifsat = 1<a name='1454'>
            endif<a name='1455'>
<font color=#447700>!-------------------------------------------------------------<a name='1456'></font>
<font color=#447700>! psdep: deposition/sublimation rate of snow [HDC 14]<a name='1457'></font>
<font color=#447700>!        (V-&gt;S or S-&gt;V)<a name='1458'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1459'></font>
            if(qrs(i,k).gt.0..and.ifsat.ne.1) then<a name='1460'>
              coeres = rslope2(i,k)*sqrt(rslope(i,k)*rslopeb(i,k))<a name='1461'>
              pres(i,k) = (rh(i,k)-1.)*n0sfac(i,k)*(precs1*rslope2(i,k)        &amp;<a name='1462'>
                        +precs2*work2(i,k)*coeres)/work1(i,k)<a name='1463'>
              supice = satdt-pisd(i,k)<a name='1464'>
              if(pres(i,k).lt.0.) then<a name='1465'>
                pres(i,k) = max(pres(i,k),-qrs(i,k)/dtcld)<a name='1466'>
                pres(i,k) = max(max(pres(i,k),satdt/2),supice)<a name='1467'>
              else<a name='1468'>
                pres(i,k) = min(min(pres(i,k),satdt/2),supice)<a name='1469'>
              endif<a name='1470'>
              if(abs(pisd(i,k)+pres(i,k)).ge.abs(satdt)) ifsat = 1<a name='1471'>
            endif<a name='1472'>
<font color=#447700>!-------------------------------------------------------------<a name='1473'></font>
<font color=#447700>! pigen: generation(nucleation) of ice from vapor [HDC 7-8]<a name='1474'></font>
<font color=#447700>!       (T&lt;T0: V-&gt;I)<a name='1475'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1476'></font>
            if(supsat.gt.0.and.ifsat.ne.1) then<a name='1477'>
              supice = satdt-pisd(i,k)-pres(i,k)<a name='1478'>
              xni0 = 1.e3*exp(0.1*supcol)<a name='1479'>
<font color=#447700>!             roqi0 = 4.92e-11*xni0**1.33<a name='1480'></font>
              roqi0 = 4.92e-11*exp(log(xni0)*(1.33))<a name='1481'>
              pgen(i,k) = max(0.,(roqi0/den(i,k)-max(qci(i,k),0.))/dtcld)<a name='1482'>
              pgen(i,k) = min(min(pgen(i,k),satdt),supice)<a name='1483'>
            endif<a name='1484'>
<font color=#447700>!-------------------------------------------------------------<a name='1485'></font>
<font color=#447700>! psaut: conversion(aggregation) of ice to snow [HDC 12]<a name='1486'></font>
<font color=#447700>!       (T&lt;T0: I-&gt;S)<a name='1487'></font>
<font color=#447700>!-------------------------------------------------------------<a name='1488'></font>
            if(qci(i,k).gt.0.) then<a name='1489'>
              qimax = roqimax/den(i,k)<a name='1490'>
              paut(i,k) = max(0.,(qci(i,k)-qimax)/dtcld)<a name='1491'>
            endif<a name='1492'>
          endif<a name='1493'>
        enddo<a name='1494'>
      enddo<a name='1495'>
<font color=#447700>!<a name='1496'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1497'></font>
<font color=#447700>!     check mass conservation of generation terms and feedback to the<a name='1498'></font>
<font color=#447700>!     large scale<a name='1499'></font>
<font color=#447700>!<a name='1500'></font>
      do k = kts, kte<a name='1501'>
        do i = its, ite<a name='1502'>
          qciik = max(qmin,qci(i,k))<a name='1503'>
          delqci = (paut(i,k)+pacr(i,k)-pgen(i,k)-pisd(i,k))*dtcld<a name='1504'>
          if(delqci.ge.qciik) then<a name='1505'>
            facqci = qciik/delqci<a name='1506'>
            paut(i,k) = paut(i,k)*facqci<a name='1507'>
            pacr(i,k) = pacr(i,k)*facqci<a name='1508'>
            pgen(i,k) = pgen(i,k)*facqci<a name='1509'>
            pisd(i,k) = pisd(i,k)*facqci<a name='1510'>
          endif<a name='1511'>
          qik = max(qmin,q(i,k))<a name='1512'>
          delq = (pres(i,k)+pgen(i,k)+pisd(i,k))*dtcld<a name='1513'>
          if(delq.ge.qik) then<a name='1514'>
            facq = qik/delq<a name='1515'>
            pres(i,k) = pres(i,k)*facq<a name='1516'>
            pgen(i,k) = pgen(i,k)*facq<a name='1517'>
            pisd(i,k) = pisd(i,k)*facq<a name='1518'>
          endif<a name='1519'>
          work2(i,k) = -pres(i,k)-pgen(i,k)-pisd(i,k)<a name='1520'>
          q(i,k) = q(i,k)+work2(i,k)*dtcld<a name='1521'>
          qci(i,k) = max(qci(i,k)-(paut(i,k)+pacr(i,k)-pgen(i,k)-pisd(i,k))    &amp;<a name='1522'>
                    *dtcld,0.)<a name='1523'>
          qrs(i,k) = max(qrs(i,k)+(paut(i,k)+pacr(i,k)+pres(i,k))*dtcld,0.)<a name='1524'>
          if(t(i,k).lt.t0c) then<a name='1525'>
            t(i,k) = t(i,k)-xls*work2(i,k)/cpm(i,k)*dtcld<a name='1526'>
          else<a name='1527'>
            t(i,k) = t(i,k)-xl(i,k)*work2(i,k)/cpm(i,k)*dtcld<a name='1528'>
          endif<a name='1529'>
        enddo<a name='1530'>
      enddo<a name='1531'>
<font color=#447700>!<a name='1532'></font>
      cvap = cpv<a name='1533'>
      hvap = xlv0<a name='1534'>
      hsub = xls<a name='1535'>
      ttp=t0c+0.01<a name='1536'>
      dldt=cvap-cliq<a name='1537'>
      xa=-dldt/rv<a name='1538'>
      xb=xa+hvap/(rv*ttp)<a name='1539'>
      dldti=cvap-cice<a name='1540'>
      xai=-dldti/rv<a name='1541'>
      xbi=xai+hsub/(rv*ttp)<a name='1542'>
      do k = kts, kte<a name='1543'>
        do i = its, ite<a name='1544'>
          tr=ttp/t(i,k)<a name='1545'>
<font color=#447700>!         qs(i,k)=psat*(tr**xa)*exp(xb*(1.-tr))<a name='1546'></font>
          qs(i,k)=psat*(exp(log(tr)*(xa)))*exp(xb*(1.-tr))<a name='1547'>
          qs(i,k) = ep2 * qs(i,k) / (p(i,k) - qs(i,k))<a name='1548'>
          qs(i,k) = max(qs(i,k),qmin)<a name='1549'>
          denfac(i,k) = sqrt(den0/den(i,k))<a name='1550'>
        enddo<a name='1551'>
      enddo<a name='1552'>
<font color=#447700>!<a name='1553'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1554'></font>
<font color=#447700>!  pcond: condensational/evaporational rate of cloud water [HL A46] [RH83 A6]<a name='1555'></font>
<font color=#447700>!     if there exists additional water vapor condensated/if<a name='1556'></font>
<font color=#447700>!     evaporation of cloud water is not enough to remove subsaturation<a name='1557'></font>
<font color=#447700>!<a name='1558'></font>
      do k = kts, kte<a name='1559'>
        do i = its, ite<a name='1560'>
          work1(i,k) = conden(t(i,k),q(i,k),qs(i,k),xl(i,k),cpm(i,k))<a name='1561'>
          work2(i,k) = qci(i,k)+work1(i,k)<a name='1562'>
          pcon(i,k) = min(max(work1(i,k),0.),max(q(i,k),0.))/dtcld<a name='1563'>
          if(qci(i,k).gt.0..and.work1(i,k).lt.0.and.t(i,k).gt.t0c)             &amp;<a name='1564'>
            pcon(i,k) = max(work1(i,k),-qci(i,k))/dtcld<a name='1565'>
          q(i,k) = q(i,k)-pcon(i,k)*dtcld<a name='1566'>
          qci(i,k) = max(qci(i,k)+pcon(i,k)*dtcld,0.)<a name='1567'>
          t(i,k) = t(i,k)+pcon(i,k)*xl(i,k)/cpm(i,k)*dtcld<a name='1568'>
        enddo<a name='1569'>
      enddo<a name='1570'>
<font color=#447700>!<a name='1571'></font>
<font color=#447700>!----------------------------------------------------------------<a name='1572'></font>
<font color=#447700>!     padding for small values<a name='1573'></font>
<font color=#447700>!<a name='1574'></font>
      do k = kts, kte<a name='1575'>
        do i = its, ite<a name='1576'>
          if(qci(i,k).le.qmin) qci(i,k) = 0.0<a name='1577'>
        enddo<a name='1578'>
      enddo<a name='1579'>
<font color=#447700>!<a name='1580'></font>
      enddo                  <font color=#447700>! big loops<a name='1581'></font>
  END SUBROUTINE wsm32D<a name='1582'>
#endif<a name='1583'>
<a name='1584'>
<font color=#447700>! ...................................................................<a name='1585'></font>
<A NAME='RGMMA'><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#RGMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1586'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>rgmma</font>(x) <A href='../../call_to/RGMMA.html' TARGET='index'>76</A><a name='1587'>
<font color=#447700>!-------------------------------------------------------------------<a name='1588'></font>
  IMPLICIT NONE<a name='1589'>
<font color=#447700>!-------------------------------------------------------------------<a name='1590'></font>
<font color=#447700>!     rgmma function:  use infinite product form<a name='1591'></font>
      REAL :: euler<a name='1592'>
      PARAMETER (euler=0.577215664901532)<a name='1593'>
      REAL :: x, y<a name='1594'>
      INTEGER :: i<a name='1595'>
      if(x.eq.1.)then<a name='1596'>
        rgmma=0.<a name='1597'>
          else<a name='1598'>
        rgmma=x*exp(euler*x)<a name='1599'>
        do i=1,10000<a name='1600'>
          y=float(i)<a name='1601'>
          rgmma=rgmma*(1.000+x/y)*exp(-x/y)<a name='1602'>
        enddo<a name='1603'>
        rgmma=1./rgmma<a name='1604'>
      endif<a name='1605'>
      END FUNCTION rgmma<a name='1606'>
<font color=#447700>!<a name='1607'></font>
<font color=#447700>!--------------------------------------------------------------------------<a name='1608'></font>
<A NAME='FPVS'><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#FPVS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1609'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>fpvs</font>(t,ice,rd,rv,cvap,cliq,cice,hvap,hsub,psat,t0c) <A href='../../call_to/FPVS.html' TARGET='index'>9</A>,<A href='../../call_from/FPVS.html' TARGET='index'>1</A><a name='1610'>
<font color=#447700>!--------------------------------------------------------------------------<a name='1611'></font>
      IMPLICIT NONE<a name='1612'>
<font color=#447700>!--------------------------------------------------------------------------<a name='1613'></font>
      REAL t,rd,rv,cvap,cliq,cice,hvap,hsub,psat,t0c,dldt,xa,xb,dldti,         &amp;<a name='1614'>
           xai,xbi,ttp,tr<a name='1615'>
      INTEGER ice<a name='1616'>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='1617'></font>
      ttp=t0c+0.01<a name='1618'>
      dldt=cvap-cliq<a name='1619'>
      xa=-dldt/rv<a name='1620'>
      xb=xa+hvap/(rv*ttp)<a name='1621'>
      dldti=cvap-cice<a name='1622'>
      xai=-dldti/rv<a name='1623'>
      xbi=xai+hsub/(rv*ttp)<a name='1624'>
      tr=ttp/t<a name='1625'>
      if(t.lt.ttp.and.ice.eq.1) then<a name='1626'>
        fpvs=psat*(tr**xai)*exp(xbi*(1.-tr))<a name='1627'>
      else<a name='1628'>
        fpvs=psat*(tr**xa)*exp(xb*(1.-tr))<a name='1629'>
      endif<a name='1630'>
<font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<a name='1631'></font>
      END FUNCTION fpvs<a name='1632'>
<font color=#447700>!-------------------------------------------------------------------<a name='1633'></font>
<A NAME='WSM3INIT'><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1634'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wsm3init</font>(den0,denr,dens,cl,cpv,allowed_to_read) <A href='../../call_to/WSM3INIT.html' TARGET='index'>1</A>,<A href='../../call_from/WSM3INIT.html' TARGET='index'>16</A><a name='1635'>
<font color=#447700>!-------------------------------------------------------------------<a name='1636'></font>
  IMPLICIT NONE<a name='1637'>
<font color=#447700>!-------------------------------------------------------------------<a name='1638'></font>
<font color=#447700>!.... constants which may not be tunable<a name='1639'></font>
   REAL, INTENT(IN) :: den0,denr,dens,cl,cpv<a name='1640'>
   LOGICAL, INTENT(IN) :: allowed_to_read<a name='1641'>
   REAL :: pi<a name='1642'>
<font color=#447700>!<a name='1643'></font>
   pi = 4.*atan(1.)<a name='1644'>
   xlv1 = cl-cpv<a name='1645'>
<font color=#447700>!<a name='1646'></font>
   qc0  = 4./3.*pi*denr*r0**3*xncr/den0  <font color=#447700>! 0.419e-3 -- .61e-3<a name='1647'></font>
   qck1 = .104*9.8*peaut/(xncr*denr)**(1./3.)/xmyu*den0**(4./3.) <font color=#447700>! 7.03<a name='1648'></font>
<font color=#447700>!<a name='1649'></font>
   bvtr1 = 1.+bvtr<a name='1650'>
   bvtr2 = 2.5+.5*bvtr<a name='1651'>
   bvtr3 = 3.+bvtr<a name='1652'>
   bvtr4 = 4.+bvtr<a name='1653'>
   g1pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_40">(bvtr1)<a name='1654'>
   g3pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_41">(bvtr3)<a name='1655'>
   g4pbr = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_42">(bvtr4)            <font color=#447700>! 17.837825<a name='1656'></font>
   g5pbro2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_43">(bvtr2)          <font color=#447700>! 1.8273<a name='1657'></font>
   pvtr = avtr*g4pbr/6.<a name='1658'>
   eacrr = 1.0<a name='1659'>
   pacrr = pi*n0r*avtr*g3pbr*.25*eacrr<a name='1660'>
   precr1 = 2.*pi*n0r*.78<a name='1661'>
   precr2 = 2.*pi*n0r*.31*avtr**.5*g5pbro2<a name='1662'>
   xmmax = (dimax/dicon)**2<a name='1663'>
   roqimax = 2.08e22*dimax**8<a name='1664'>
<font color=#447700>!<a name='1665'></font>
   bvts1 = 1.+bvts<a name='1666'>
   bvts2 = 2.5+.5*bvts<a name='1667'>
   bvts3 = 3.+bvts<a name='1668'>
   bvts4 = 4.+bvts<a name='1669'>
   g1pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_44">(bvts1)    <font color=#447700>!.8875<a name='1670'></font>
   g3pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_45">(bvts3)<a name='1671'>
   g4pbs = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_46">(bvts4)    <font color=#447700>! 12.0786<a name='1672'></font>
   g5pbso2 = <A href='../../html_code/phys/module_mp_wsm6.F.html#RGMMA'>rgmma</A><A href='../../html_code/phys/module_mp_wsm3_accel.F.html#WSM3INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RGMMA_47">(bvts2)<a name='1673'>
   pvts = avts*g4pbs/6.<a name='1674'>
   pacrs = pi*n0s*avts*g3pbs*.25<a name='1675'>
   precs1 = 4.*n0s*.65<a name='1676'>
   precs2 = 4.*n0s*.44*avts**.5*g5pbso2<a name='1677'>
   pidn0r =  pi*denr*n0r<a name='1678'>
   pidn0s =  pi*dens*n0s<a name='1679'>
<font color=#447700>!<a name='1680'></font>
   rslopermax = 1./lamdarmax<a name='1681'>
   rslopesmax = 1./lamdasmax<a name='1682'>
   rsloperbmax = rslopermax ** bvtr<a name='1683'>
   rslopesbmax = rslopesmax ** bvts<a name='1684'>
   rsloper2max = rslopermax * rslopermax<a name='1685'>
   rslopes2max = rslopesmax * rslopesmax<a name='1686'>
   rsloper3max = rsloper2max * rslopermax<a name='1687'>
   rslopes3max = rslopes2max * rslopesmax<a name='1688'>
<font color=#447700>!<a name='1689'></font>
  END SUBROUTINE wsm3init<a name='1690'>
END MODULE module_mp_wsm3<a name='1691'>
</pre></body></html>