<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_SF_NOAHMPDRV'><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#MODULE_SF_NOAHMPDRV' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sf_noahmpdrv</font> <A href='../../call_to/MODULE_SF_NOAHMPDRV.html' TARGET='index'>2</A><a name='3'>
<a name='4'>
<font color=#447700>!-------------------------------<a name='5'></font>
#if ( WRF_CHEM == 1 )<a name='6'>
  USE <A href='../../html_code/phys/module_data_gocart_dust.F.html#MODULE_DATA_GOCART_DUST'>module_data_gocart_dust</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#module_sf_noahmpdrv.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATA_GOCART_DUST_2"><a name='7'>
#endif<a name='8'>
<font color=#447700>!-------------------------------<a name='9'></font>
<a name='10'>
<font color=#447700>!<a name='11'></font>
CONTAINS<a name='12'>
<font color=#447700>!<a name='13'></font>
<A NAME='NOAHMPLSM'><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='14'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>noahmplsm</font>(ITIMESTEP,        YR,   JULIAN,   COSZIN,XLAT,XLONG, &amp; <font color=#447700>! IN : Time/Space-related <A href='../../call_to/NOAHMPLSM.html' TARGET='index'>1</A>,<A href='../../call_from/NOAHMPLSM.html' TARGET='index'>11</A><a name='15'></font>
                  DZ8W,       DT,       DZS,    NSOIL,       DX,            &amp; <font color=#447700>! IN : Model configuration <a name='16'></font>
	        IVGTYP,   ISLTYP,    VEGFRA,   VEGMAX,      TMN,            &amp; <font color=#447700>! IN : Vegetation/Soil characteristics<a name='17'></font>
		 XLAND,     XICE,XICE_THRES,  CROPCAT,                      &amp; <font color=#447700>! IN : Vegetation/Soil characteristics<a name='18'></font>
	       PLANTING,  HARVEST,SEASON_GDD,                               &amp;<a name='19'>
                 IDVEG, IOPT_CRS,  IOPT_BTR, IOPT_RUN, IOPT_SFC, IOPT_FRZ,  &amp; <font color=#447700>! IN : User options<a name='20'></font>
              IOPT_INF, IOPT_RAD,  IOPT_ALB, IOPT_SNF,IOPT_TBOT, IOPT_STC,  &amp; <font color=#447700>! IN : User options<a name='21'></font>
              IOPT_GLA, IOPT_RSF,   IZ0TLND, SF_URBAN_PHYSICS,              &amp; <font color=#447700>! IN : User options<a name='22'></font>
                   T3D,     QV3D,     U_PHY,    V_PHY,   SWDOWN,      GLW,  &amp; <font color=#447700>! IN : Forcing<a name='23'></font>
		 P8W3D,PRECIP_IN,        SR,                                &amp; <font color=#447700>! IN : Forcing<a name='24'></font>
                   TSK,      HFX,      QFX,        LH,   GRDFLX,    SMSTAV, &amp; <font color=#447700>! IN/OUT LSM eqv<a name='25'></font>
                SMSTOT,SFCRUNOFF, UDRUNOFF,    ALBEDO,    SNOWC,     SMOIS, &amp; <font color=#447700>! IN/OUT LSM eqv<a name='26'></font>
		  SH2O,     TSLB,     SNOW,     SNOWH,   CANWAT,    ACSNOM, &amp; <font color=#447700>! IN/OUT LSM eqv<a name='27'></font>
		ACSNOW,    EMISS,     QSFC,                                 &amp; <font color=#447700>! IN/OUT LSM eqv<a name='28'></font>
 		    Z0,      ZNT,                                           &amp; <font color=#447700>! IN/OUT LSM eqv<a name='29'></font>
               ISNOWXY,     TVXY,     TGXY,  CANICEXY, CANLIQXY,     EAHXY, &amp; <font color=#447700>! IN/OUT Noah MP only<a name='30'></font>
	         TAHXY,     CMXY,     CHXY,    FWETXY, SNEQVOXY,  ALBOLDXY, &amp; <font color=#447700>! IN/OUT Noah MP only<a name='31'></font>
               QSNOWXY, WSLAKEXY,    ZWTXY,      WAXY,     WTXY,    TSNOXY, &amp; <font color=#447700>! IN/OUT Noah MP only<a name='32'></font>
	       ZSNSOXY,  SNICEXY,  SNLIQXY,  LFMASSXY, RTMASSXY,  STMASSXY, &amp; <font color=#447700>! IN/OUT Noah MP only<a name='33'></font>
	        WOODXY, STBLCPXY, FASTCPXY,    XLAIXY,   XSAIXY,   TAUSSXY, &amp; <font color=#447700>! IN/OUT Noah MP only<a name='34'></font>
	       SMOISEQ, SMCWTDXY,DEEPRECHXY,   RECHXY,  GRAINXY,    GDDXY,PGSXY,  &amp; <font color=#447700>! IN/OUT Noah MP only<a name='35'></font>
	        T2MVXY,   T2MBXY,    Q2MVXY,   Q2MBXY,                      &amp; <font color=#447700>! OUT Noah MP only<a name='36'></font>
	        TRADXY,    NEEXY,    GPPXY,     NPPXY,   FVEGXY,   RUNSFXY, &amp; <font color=#447700>! OUT Noah MP only<a name='37'></font>
	       RUNSBXY,   ECANXY,   EDIRXY,   ETRANXY,    FSAXY,    FIRAXY, &amp; <font color=#447700>! OUT Noah MP only<a name='38'></font>
	        APARXY,    PSNXY,    SAVXY,     SAGXY,  RSSUNXY,   RSSHAXY, &amp; <font color=#447700>! OUT Noah MP only<a name='39'></font>
		BGAPXY,   WGAPXY,    TGVXY,     TGBXY,    CHVXY,     CHBXY, &amp; <font color=#447700>! OUT Noah MP only<a name='40'></font>
		 SHGXY,    SHCXY,    SHBXY,     EVGXY,    EVBXY,     GHVXY, &amp; <font color=#447700>! OUT Noah MP only<a name='41'></font>
		 GHBXY,    IRGXY,    IRCXY,     IRBXY,     TRXY,     EVCXY, &amp; <font color=#447700>! OUT Noah MP only<a name='42'></font>
              CHLEAFXY,   CHUCXY,   CHV2XY,    CHB2XY,                      &amp; <font color=#447700>! OUT Noah MP only<a name='43'></font>
<font color=#447700>!                 BEXP_3D,SMCDRY_3D,SMCWLT_3D,SMCREF_3D,SMCMAX_3D,          &amp; ! placeholders to activate 3D soil<a name='44'></font>
<font color=#447700>!		 DKSAT_3D,DWSAT_3D,PSISAT_3D,QUARTZ_3D,                     &amp;<a name='45'></font>
<font color=#447700>!		 REFDK_2D,REFKDT_2D,                                        &amp;<a name='46'></font>
#ifdef WRF_HYDRO<a name='47'>
               sfcheadrt,INFXSRT,soldrain,                                  &amp;<a name='48'>
#endif<a name='49'>
               ids,ide,  jds,jde,  kds,kde,                    &amp;<a name='50'>
               ims,ime,  jms,jme,  kms,kme,                    &amp;<a name='51'>
               its,ite,  jts,jte,  kts,kte,                    &amp;<a name='52'>
               MP_RAINC, MP_RAINNC, MP_SHCV, MP_SNOW, MP_GRAUP, MP_HAIL     )<a name='53'>
<font color=#447700>!----------------------------------------------------------------<a name='54'></font>
    USE <A href='../../html_code/phys/module_sf_noahmplsm.F.html#MODULE_SF_NOAHMPLSM'>MODULE_SF_NOAHMPLSM</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHMPLSM_1"><a name='55'>
<font color=#447700>!    USE MODULE_SF_NOAHMPLSM, only: noahmp_options, NOAHMP_SFLX, noahmp_parameters<a name='56'></font>
    USE <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#MODULE_SF_NOAHMP_GLACIER'>module_sf_noahmp_glacier</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHMP_GLACIER_1"><a name='57'>
    USE <A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_TABLES'>NOAHMP_TABLES</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_TABLES_4">, ONLY: ISICE_TABLE, CO2_TABLE, O2_TABLE, DEFAULT_CROP_TABLE, ISCROP_TABLE, ISURBAN_TABLE, NATURAL_TABLE, &amp;<a name='58'>
                             LOW_DENSITY_RESIDENTIAL_TABLE, HIGH_DENSITY_RESIDENTIAL_TABLE, HIGH_INTENSITY_INDUSTRIAL_TABLE<a name='59'>
    USE <A href='../../html_code/phys/module_sf_urban.F.html#MODULE_SF_URBAN'>module_sf_urban</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_URBAN_6">,    only: IRI_SCHEME<a name='60'>
    USE <A href='../../html_code/phys/module_ra_gfdleta.F.html#MODULE_RA_GFDLETA'>module_ra_gfdleta</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_GFDLETA_7">,  only: cal_mon_day<a name='61'>
<font color=#447700>!----------------------------------------------------------------<a name='62'></font>
    IMPLICIT NONE<a name='63'>
<font color=#447700>!----------------------------------------------------------------<a name='64'></font>
<a name='65'>
<font color=#447700>! IN only<a name='66'></font>
<a name='67'>
    INTEGER,                                         INTENT(IN   ) ::  ITIMESTEP <font color=#447700>! timestep number<a name='68'></font>
    INTEGER,                                         INTENT(IN   ) ::  YR        <font color=#447700>! 4-digit year<a name='69'></font>
    REAL,                                            INTENT(IN   ) ::  JULIAN    <font color=#447700>! Julian day<a name='70'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  COSZIN    <font color=#447700>! cosine zenith angle<a name='71'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  XLAT      <font color=#447700>! latitude [rad]<a name='72'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  XLONG     <font color=#447700>! latitude [rad]<a name='73'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  DZ8W      <font color=#447700>! thickness of atmo layers [m]<a name='74'></font>
    REAL,                                            INTENT(IN   ) ::  DT        <font color=#447700>! timestep [s]<a name='75'></font>
    REAL,    DIMENSION(1:nsoil),                     INTENT(IN   ) ::  DZS       <font color=#447700>! thickness of soil layers [m]<a name='76'></font>
    INTEGER,                                         INTENT(IN   ) ::  NSOIL     <font color=#447700>! number of soil layers<a name='77'></font>
    REAL,                                            INTENT(IN   ) ::  DX        <font color=#447700>! horizontal grid spacing [m]<a name='78'></font>
    INTEGER, DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  IVGTYP    <font color=#447700>! vegetation type<a name='79'></font>
    INTEGER, DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  ISLTYP    <font color=#447700>! soil type<a name='80'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  VEGFRA    <font color=#447700>! vegetation fraction []<a name='81'></font>
    REAL,    DIMENSION( ims:ime ,         jms:jme ), INTENT(IN   ) ::  VEGMAX    <font color=#447700>! annual max vegetation fraction []<a name='82'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  TMN       <font color=#447700>! deep soil temperature [K]<a name='83'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  XLAND     <font color=#447700>! =2 ocean; =1 land/seaice<a name='84'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  XICE      <font color=#447700>! fraction of grid that is seaice<a name='85'></font>
    REAL,                                            INTENT(IN   ) ::  XICE_THRES<font color=#447700>! fraction of grid determining seaice<a name='86'></font>
    INTEGER,                                         INTENT(IN   ) ::  IDVEG     <font color=#447700>! dynamic vegetation (1 -&gt; off ; 2 -&gt; on) with opt_crs = 1      <a name='87'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_CRS  <font color=#447700>! canopy stomatal resistance (1-&gt; Ball-Berry; 2-&gt;Jarvis)<a name='88'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_BTR  <font color=#447700>! soil moisture factor for stomatal resistance (1-&gt; Noah; 2-&gt; CLM; 3-&gt; SSiB)<a name='89'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_RUN  <font color=#447700>! runoff and groundwater (1-&gt;SIMGM; 2-&gt;SIMTOP; 3-&gt;Schaake96; 4-&gt;BATS)<a name='90'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_SFC  <font color=#447700>! surface layer drag coeff (CH &amp; CM) (1-&gt;M-O; 2-&gt;Chen97)<a name='91'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_FRZ  <font color=#447700>! supercooled liquid water (1-&gt; NY06; 2-&gt;Koren99)<a name='92'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_INF  <font color=#447700>! frozen soil permeability (1-&gt; NY06; 2-&gt;Koren99)<a name='93'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_RAD  <font color=#447700>! radiation transfer (1-&gt;gap=F(3D,cosz); 2-&gt;gap=0; 3-&gt;gap=1-Fveg)<a name='94'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_ALB  <font color=#447700>! snow surface albedo (1-&gt;BATS; 2-&gt;CLASS)<a name='95'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_SNF  <font color=#447700>! rainfall &amp; snowfall (1-Jordan91; 2-&gt;BATS; 3-&gt;Noah)<a name='96'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_TBOT <font color=#447700>! lower boundary of soil temperature (1-&gt;zero-flux; 2-&gt;Noah)<a name='97'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_STC  <font color=#447700>! snow/soil temperature time scheme<a name='98'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_GLA  <font color=#447700>! glacier option (1-&gt;phase change; 2-&gt;simple)<a name='99'></font>
    INTEGER,                                         INTENT(IN   ) ::  IOPT_RSF  <font color=#447700>! surface resistance (1-&gt;Sakaguchi/Zeng; 2-&gt;Seller; 3-&gt;mod Sellers; 4-&gt;1+snow)<a name='100'></font>
    INTEGER,                                         INTENT(IN   ) ::  IZ0TLND   <font color=#447700>! option of Chen adjustment of Czil (not used)<a name='101'></font>
    INTEGER,                                         INTENT(IN   ) ::  sf_urban_physics   <font color=#447700>! urban physics option<a name='102'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  T3D       <font color=#447700>! 3D atmospheric temperature valid at mid-levels [K]<a name='103'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  QV3D      <font color=#447700>! 3D water vapor mixing ratio [kg/kg_dry]<a name='104'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  U_PHY     <font color=#447700>! 3D U wind component [m/s]<a name='105'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  V_PHY     <font color=#447700>! 3D V wind component [m/s]<a name='106'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  SWDOWN    <font color=#447700>! solar down at surface [W m-2]<a name='107'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  GLW       <font color=#447700>! longwave down at surface [W m-2]<a name='108'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  P8W3D     <font color=#447700>! 3D pressure, valid at interface [Pa]<a name='109'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  PRECIP_IN <font color=#447700>! total input precipitation [mm]<a name='110'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  SR        <font color=#447700>! frozen precipitation ratio [-]<a name='111'></font>
<a name='112'>
<font color=#447700>!Optional Detailed Precipitation Partitioning Inputs<a name='113'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ), OPTIONAL ::  MP_RAINC  <font color=#447700>! convective precipitation entering land model [mm] ! MB/AN : v3.7<a name='114'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ), OPTIONAL ::  MP_RAINNC <font color=#447700>! large-scale precipitation entering land model [mm]! MB/AN : v3.7<a name='115'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ), OPTIONAL ::  MP_SHCV   <font color=#447700>! shallow conv precip entering land model [mm]      ! MB/AN : v3.7<a name='116'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ), OPTIONAL ::  MP_SNOW   <font color=#447700>! snow precipitation entering land model [mm]       ! MB/AN : v3.7<a name='117'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ), OPTIONAL ::  MP_GRAUP  <font color=#447700>! graupel precipitation entering land model [mm]    ! MB/AN : v3.7<a name='118'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ), OPTIONAL ::  MP_HAIL   <font color=#447700>! hail precipitation entering land model [mm]       ! MB/AN : v3.7<a name='119'></font>
<a name='120'>
<font color=#447700>! Crop Model<a name='121'></font>
    INTEGER, DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  CROPCAT   <font color=#447700>! crop catagory<a name='122'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  PLANTING  <font color=#447700>! planting date<a name='123'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  HARVEST   <font color=#447700>! harvest date<a name='124'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  SEASON_GDD<font color=#447700>! growing season GDD<a name='125'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  GRAINXY   <font color=#447700>! mass of grain XING [g/m2]<a name='126'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  GDDXY     <font color=#447700>! growing degree days XING (based on 10C) <a name='127'></font>
 INTEGER,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  PGSXY<a name='128'>
<a name='129'>
#ifdef WRF_HYDRO<a name='130'>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  sfcheadrt,INFXSRT,soldrain   <font color=#447700>! for WRF-Hydro<a name='131'></font>
#endif<a name='132'>
<font color=#447700>! placeholders for 3D soil<a name='133'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  BEXP_3D   ! C-H B exponent<a name='134'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  SMCDRY_3D ! Soil Moisture Limit: Dry<a name='135'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  SMCWLT_3D ! Soil Moisture Limit: Wilt<a name='136'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  SMCREF_3D ! Soil Moisture Limit: Reference<a name='137'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  SMCMAX_3D ! Soil Moisture Limit: Max<a name='138'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  DKSAT_3D  ! Saturated Soil Conductivity<a name='139'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  DWSAT_3D  ! Saturated Soil Diffusivity<a name='140'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  PSISAT_3D ! Saturated Matric Potential<a name='141'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(IN) ::  QUARTZ_3D ! Soil quartz content<a name='142'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, jms:jme ), INTENT(IN)          ::  REFDK_2D  ! Reference Soil Conductivity<a name='143'></font>
<font color=#447700>!    REAL,    DIMENSION( ims:ime, jms:jme ), INTENT(IN)          ::  REFKDT_2D ! Soil Infiltration Parameter<a name='144'></font>
<a name='145'>
<font color=#447700>! INOUT (with generic LSM equivalent)<a name='146'></font>
<a name='147'>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  TSK       <font color=#447700>! surface radiative temperature [K]<a name='148'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  HFX       <font color=#447700>! sensible heat flux [W m-2]<a name='149'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  QFX       <font color=#447700>! latent heat flux [kg s-1 m-2]<a name='150'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  LH        <font color=#447700>! latent heat flux [W m-2]<a name='151'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  GRDFLX    <font color=#447700>! ground/snow heat flux [W m-2]<a name='152'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  SMSTAV    <font color=#447700>! soil moisture avail. [not used]<a name='153'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  SMSTOT    <font color=#447700>! total soil water [mm][not used]<a name='154'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  SFCRUNOFF <font color=#447700>! accumulated surface runoff [m]<a name='155'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  UDRUNOFF  <font color=#447700>! accumulated sub-surface runoff [m]<a name='156'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ALBEDO    <font color=#447700>! total grid albedo []<a name='157'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  SNOWC     <font color=#447700>! snow cover fraction []<a name='158'></font>
    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(INOUT) ::  SMOIS     <font color=#447700>! volumetric soil moisture [m3/m3]<a name='159'></font>
    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(INOUT) ::  SH2O      <font color=#447700>! volumetric liquid soil moisture [m3/m3]<a name='160'></font>
    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(INOUT) ::  TSLB      <font color=#447700>! soil temperature [K]<a name='161'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  SNOW      <font color=#447700>! snow water equivalent [mm]<a name='162'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  SNOWH     <font color=#447700>! physical snow depth [m]<a name='163'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  CANWAT    <font color=#447700>! total canopy water + ice [mm]<a name='164'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ACSNOM    <font color=#447700>! accumulated snow melt leaving pack<a name='165'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ACSNOW    <font color=#447700>! accumulated snow on grid<a name='166'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  EMISS     <font color=#447700>! surface bulk emissivity<a name='167'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  QSFC      <font color=#447700>! bulk surface specific humidity<a name='168'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  Z0        <font color=#447700>! combined z0 sent to coupled model<a name='169'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ZNT       <font color=#447700>! combined z0 sent to coupled model<a name='170'></font>
<a name='171'>
<font color=#447700>! INOUT (with no Noah LSM equivalent)<a name='172'></font>
<a name='173'>
    INTEGER, DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ISNOWXY   <font color=#447700>! actual no. of snow layers<a name='174'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  TVXY      <font color=#447700>! vegetation leaf temperature<a name='175'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  TGXY      <font color=#447700>! bulk ground surface temperature<a name='176'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  CANICEXY  <font color=#447700>! canopy-intercepted ice (mm)<a name='177'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  CANLIQXY  <font color=#447700>! canopy-intercepted liquid water (mm)<a name='178'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  EAHXY     <font color=#447700>! canopy air vapor pressure (pa)<a name='179'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  TAHXY     <font color=#447700>! canopy air temperature (k)<a name='180'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  CMXY      <font color=#447700>! bulk momentum drag coefficient<a name='181'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  CHXY      <font color=#447700>! bulk sensible heat exchange coefficient<a name='182'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  FWETXY    <font color=#447700>! wetted or snowed fraction of the canopy (-)<a name='183'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  SNEQVOXY  <font color=#447700>! snow mass at last time step(mm h2o)<a name='184'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ALBOLDXY  <font color=#447700>! snow albedo at last time step (-)<a name='185'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  QSNOWXY   <font color=#447700>! snowfall on the ground [mm/s]<a name='186'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  WSLAKEXY  <font color=#447700>! lake water storage [mm]<a name='187'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ZWTXY     <font color=#447700>! water table depth [m]<a name='188'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  WAXY      <font color=#447700>! water in the "aquifer" [mm]<a name='189'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  WTXY      <font color=#447700>! groundwater storage [mm]<a name='190'></font>
    REAL,    DIMENSION( ims:ime,-2:0,     jms:jme ), INTENT(INOUT) ::  TSNOXY    <font color=#447700>! snow temperature [K]<a name='191'></font>
    REAL,    DIMENSION( ims:ime,-2:NSOIL, jms:jme ), INTENT(INOUT) ::  ZSNSOXY   <font color=#447700>! snow layer depth [m]<a name='192'></font>
    REAL,    DIMENSION( ims:ime,-2:0,     jms:jme ), INTENT(INOUT) ::  SNICEXY   <font color=#447700>! snow layer ice [mm]<a name='193'></font>
    REAL,    DIMENSION( ims:ime,-2:0,     jms:jme ), INTENT(INOUT) ::  SNLIQXY   <font color=#447700>! snow layer liquid water [mm]<a name='194'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  LFMASSXY  <font color=#447700>! leaf mass [g/m2]<a name='195'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  RTMASSXY  <font color=#447700>! mass of fine roots [g/m2]<a name='196'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  STMASSXY  <font color=#447700>! stem mass [g/m2]<a name='197'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  WOODXY    <font color=#447700>! mass of wood (incl. woody roots) [g/m2]<a name='198'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  STBLCPXY  <font color=#447700>! stable carbon in deep soil [g/m2]<a name='199'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  FASTCPXY  <font color=#447700>! short-lived carbon, shallow soil [g/m2]<a name='200'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  XLAIXY    <font color=#447700>! leaf area index<a name='201'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  XSAIXY    <font color=#447700>! stem area index<a name='202'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  TAUSSXY   <font color=#447700>! snow age factor<a name='203'></font>
    REAL,    DIMENSION( ims:ime, 1:nsoil, jms:jme ), INTENT(INOUT) ::  SMOISEQ   <font color=#447700>! eq volumetric soil moisture [m3/m3]<a name='204'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  SMCWTDXY  <font color=#447700>! soil moisture content in the layer to the water table when deep<a name='205'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  DEEPRECHXY <font color=#447700>! recharge to the water table when deep<a name='206'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  RECHXY    <font color=#447700>! recharge to the water table (diagnostic) <a name='207'></font>
<a name='208'>
<font color=#447700>! OUT (with no Noah LSM equivalent)<a name='209'></font>
<a name='210'>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  T2MVXY    <font color=#447700>! 2m temperature of vegetation part<a name='211'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  T2MBXY    <font color=#447700>! 2m temperature of bare ground part<a name='212'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  Q2MVXY    <font color=#447700>! 2m mixing ratio of vegetation part<a name='213'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  Q2MBXY    <font color=#447700>! 2m mixing ratio of bare ground part<a name='214'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  TRADXY    <font color=#447700>! surface radiative temperature (k)<a name='215'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  NEEXY     <font color=#447700>! net ecosys exchange (g/m2/s CO2)<a name='216'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  GPPXY     <font color=#447700>! gross primary assimilation [g/m2/s C]<a name='217'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  NPPXY     <font color=#447700>! net primary productivity [g/m2/s C]<a name='218'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  FVEGXY    <font color=#447700>! Noah-MP vegetation fraction [-]<a name='219'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  RUNSFXY   <font color=#447700>! surface runoff [mm/s]<a name='220'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  RUNSBXY   <font color=#447700>! subsurface runoff [mm/s]<a name='221'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  ECANXY    <font color=#447700>! evaporation of intercepted water (mm/s)<a name='222'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  EDIRXY    <font color=#447700>! soil surface evaporation rate (mm/s]<a name='223'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  ETRANXY   <font color=#447700>! transpiration rate (mm/s)<a name='224'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  FSAXY     <font color=#447700>! total absorbed solar radiation (w/m2)<a name='225'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  FIRAXY    <font color=#447700>! total net longwave rad (w/m2) [+ to atm]<a name='226'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  APARXY    <font color=#447700>! photosyn active energy by canopy (w/m2)<a name='227'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  PSNXY     <font color=#447700>! total photosynthesis (umol co2/m2/s) [+]<a name='228'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  SAVXY     <font color=#447700>! solar rad absorbed by veg. (w/m2)<a name='229'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  SAGXY     <font color=#447700>! solar rad absorbed by ground (w/m2)<a name='230'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  RSSUNXY   <font color=#447700>! sunlit leaf stomatal resistance (s/m)<a name='231'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  RSSHAXY   <font color=#447700>! shaded leaf stomatal resistance (s/m)<a name='232'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  BGAPXY    <font color=#447700>! between gap fraction<a name='233'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  WGAPXY    <font color=#447700>! within gap fraction<a name='234'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  TGVXY     <font color=#447700>! under canopy ground temperature[K]<a name='235'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  TGBXY     <font color=#447700>! bare ground temperature [K]<a name='236'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  CHVXY     <font color=#447700>! sensible heat exchange coefficient vegetated<a name='237'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  CHBXY     <font color=#447700>! sensible heat exchange coefficient bare-ground<a name='238'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  SHGXY     <font color=#447700>! veg ground sen. heat [w/m2]   [+ to atm]<a name='239'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  SHCXY     <font color=#447700>! canopy sen. heat [w/m2]   [+ to atm]<a name='240'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  SHBXY     <font color=#447700>! bare sensible heat [w/m2]     [+ to atm]<a name='241'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  EVGXY     <font color=#447700>! veg ground evap. heat [w/m2]  [+ to atm]<a name='242'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  EVBXY     <font color=#447700>! bare soil evaporation [w/m2]  [+ to atm]<a name='243'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  GHVXY     <font color=#447700>! veg ground heat flux [w/m2]  [+ to soil]<a name='244'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  GHBXY     <font color=#447700>! bare ground heat flux [w/m2] [+ to soil]<a name='245'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  IRGXY     <font color=#447700>! veg ground net LW rad. [w/m2] [+ to atm]<a name='246'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  IRCXY     <font color=#447700>! canopy net LW rad. [w/m2] [+ to atm]<a name='247'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  IRBXY     <font color=#447700>! bare net longwave rad. [w/m2] [+ to atm]<a name='248'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  TRXY      <font color=#447700>! transpiration [w/m2]  [+ to atm]<a name='249'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  EVCXY     <font color=#447700>! canopy evaporation heat [w/m2]  [+ to atm]<a name='250'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  CHLEAFXY  <font color=#447700>! leaf exchange coefficient <a name='251'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  CHUCXY    <font color=#447700>! under canopy exchange coefficient <a name='252'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  CHV2XY    <font color=#447700>! veg 2m exchange coefficient <a name='253'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(OUT  ) ::  CHB2XY    <font color=#447700>! bare 2m exchange coefficient <a name='254'></font>
    INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;  <font color=#447700>! d -&gt; domain<a name='255'></font>
         &amp;                           ims,ime, jms,jme, kms,kme,  &amp;  <font color=#447700>! m -&gt; memory<a name='256'></font>
         &amp;                           its,ite, jts,jte, kts,kte      <font color=#447700>! t -&gt; tile<a name='257'></font>
<a name='258'>
<a name='259'>
<font color=#447700>! 1D equivalent of 2D/3D fields<a name='260'></font>
<a name='261'>
<font color=#447700>! IN only<a name='262'></font>
<a name='263'>
    REAL                                :: COSZ         <font color=#447700>! cosine zenith angle<a name='264'></font>
    REAL                                :: LAT          <font color=#447700>! latitude [rad]<a name='265'></font>
    REAL                                :: Z_ML         <font color=#447700>! model height [m]<a name='266'></font>
    INTEGER                             :: VEGTYP       <font color=#447700>! vegetation type<a name='267'></font>
    INTEGER                             :: SOILTYP      <font color=#447700>! soil type<a name='268'></font>
    INTEGER                             :: CROPTYPE     <font color=#447700>! crop type<a name='269'></font>
    REAL                                :: FVEG         <font color=#447700>! vegetation fraction [-]<a name='270'></font>
    REAL                                :: FVGMAX       <font color=#447700>! annual max vegetation fraction []<a name='271'></font>
    REAL                                :: TBOT         <font color=#447700>! deep soil temperature [K]<a name='272'></font>
    REAL                                :: T_ML         <font color=#447700>! temperature valid at mid-levels [K]<a name='273'></font>
    REAL                                :: Q_ML         <font color=#447700>! water vapor mixing ratio [kg/kg_dry]<a name='274'></font>
    REAL                                :: U_ML         <font color=#447700>! U wind component [m/s]<a name='275'></font>
    REAL                                :: V_ML         <font color=#447700>! V wind component [m/s]<a name='276'></font>
    REAL                                :: SWDN         <font color=#447700>! solar down at surface [W m-2]<a name='277'></font>
    REAL                                :: LWDN         <font color=#447700>! longwave down at surface [W m-2]<a name='278'></font>
    REAL                                :: P_ML         <font color=#447700>! pressure, valid at interface [Pa]<a name='279'></font>
    REAL                                :: PSFC         <font color=#447700>! surface pressure [Pa]<a name='280'></font>
    REAL                                :: PRCP         <font color=#447700>! total precipitation entering  [mm]         ! MB/AN : v3.7<a name='281'></font>
    REAL                                :: PRCPCONV     <font color=#447700>! convective precipitation entering  [mm]    ! MB/AN : v3.7<a name='282'></font>
    REAL                                :: PRCPNONC     <font color=#447700>! non-convective precipitation entering [mm] ! MB/AN : v3.7<a name='283'></font>
    REAL                                :: PRCPSHCV     <font color=#447700>! shallow convective precip entering  [mm]   ! MB/AN : v3.7<a name='284'></font>
    REAL                                :: PRCPSNOW     <font color=#447700>! snow entering land model [mm]              ! MB/AN : v3.7<a name='285'></font>
    REAL                                :: PRCPGRPL     <font color=#447700>! graupel entering land model [mm]           ! MB/AN : v3.7<a name='286'></font>
    REAL                                :: PRCPHAIL     <font color=#447700>! hail entering land model [mm]              ! MB/AN : v3.7<a name='287'></font>
    REAL                                :: PRCPOTHR     <font color=#447700>! other precip, e.g. fog [mm]                ! MB/AN : v3.7<a name='288'></font>
<a name='289'>
<font color=#447700>! INOUT (with generic LSM equivalent)<a name='290'></font>
<a name='291'>
    REAL                                :: FSH          <font color=#447700>! total sensible heat (w/m2) [+ to atm]<a name='292'></font>
    REAL                                :: SSOIL        <font color=#447700>! soil heat heat (w/m2) <a name='293'></font>
    REAL                                :: SALB         <font color=#447700>! surface albedo (-)<a name='294'></font>
    REAL                                :: FSNO         <font color=#447700>! snow cover fraction (-)<a name='295'></font>
    REAL,   DIMENSION( 1:NSOIL)         :: SMCEQ        <font color=#447700>! eq vol. soil moisture (m3/m3)<a name='296'></font>
    REAL,   DIMENSION( 1:NSOIL)         :: SMC          <font color=#447700>! vol. soil moisture (m3/m3)<a name='297'></font>
    REAL,   DIMENSION( 1:NSOIL)         :: SMH2O        <font color=#447700>! vol. soil liquid water (m3/m3)<a name='298'></font>
    REAL,   DIMENSION(-2:NSOIL)         :: STC          <font color=#447700>! snow/soil tmperatures<a name='299'></font>
    REAL                                :: SWE          <font color=#447700>! snow water equivalent (mm)<a name='300'></font>
    REAL                                :: SNDPTH       <font color=#447700>! snow depth (m)<a name='301'></font>
    REAL                                :: EMISSI       <font color=#447700>! net surface emissivity<a name='302'></font>
    REAL                                :: QSFC1D       <font color=#447700>! bulk surface specific humidity<a name='303'></font>
<a name='304'>
<font color=#447700>! INOUT (with no Noah LSM equivalent)<a name='305'></font>
<a name='306'>
    INTEGER                             :: ISNOW        <font color=#447700>! actual no. of snow layers<a name='307'></font>
    REAL                                :: TV           <font color=#447700>! vegetation canopy temperature<a name='308'></font>
    REAL                                :: TG           <font color=#447700>! ground surface temperature<a name='309'></font>
    REAL                                :: CANICE       <font color=#447700>! canopy-intercepted ice (mm)<a name='310'></font>
    REAL                                :: CANLIQ       <font color=#447700>! canopy-intercepted liquid water (mm)<a name='311'></font>
    REAL                                :: EAH          <font color=#447700>! canopy air vapor pressure (pa)<a name='312'></font>
    REAL                                :: TAH          <font color=#447700>! canopy air temperature (k)<a name='313'></font>
    REAL                                :: CM           <font color=#447700>! momentum drag coefficient<a name='314'></font>
    REAL                                :: CH           <font color=#447700>! sensible heat exchange coefficient<a name='315'></font>
    REAL                                :: FWET         <font color=#447700>! wetted or snowed fraction of the canopy (-)<a name='316'></font>
    REAL                                :: SNEQVO       <font color=#447700>! snow mass at last time step(mm h2o)<a name='317'></font>
    REAL                                :: ALBOLD       <font color=#447700>! snow albedo at last time step (-)<a name='318'></font>
    REAL                                :: QSNOW        <font color=#447700>! snowfall on the ground [mm/s]<a name='319'></font>
    REAL                                :: WSLAKE       <font color=#447700>! lake water storage [mm]<a name='320'></font>
    REAL                                :: ZWT          <font color=#447700>! water table depth [m]<a name='321'></font>
    REAL                                :: WA           <font color=#447700>! water in the "aquifer" [mm]<a name='322'></font>
    REAL                                :: WT           <font color=#447700>! groundwater storage [mm]<a name='323'></font>
    REAL                                :: SMCWTD       <font color=#447700>! soil moisture content in the layer to the water table when deep<a name='324'></font>
    REAL                                :: DEEPRECH     <font color=#447700>! recharge to the water table when deep<a name='325'></font>
    REAL                                :: RECH         <font color=#447700>! recharge to the water table (diagnostic)  <a name='326'></font>
    REAL, DIMENSION(-2:NSOIL)           :: ZSNSO        <font color=#447700>! snow layer depth [m]<a name='327'></font>
    REAL, DIMENSION(-2:              0) :: SNICE        <font color=#447700>! snow layer ice [mm]<a name='328'></font>
    REAL, DIMENSION(-2:              0) :: SNLIQ        <font color=#447700>! snow layer liquid water [mm]<a name='329'></font>
    REAL                                :: LFMASS       <font color=#447700>! leaf mass [g/m2]<a name='330'></font>
    REAL                                :: RTMASS       <font color=#447700>! mass of fine roots [g/m2]<a name='331'></font>
    REAL                                :: STMASS       <font color=#447700>! stem mass [g/m2]<a name='332'></font>
    REAL                                :: WOOD         <font color=#447700>! mass of wood (incl. woody roots) [g/m2]<a name='333'></font>
    REAL                                :: GRAIN        <font color=#447700>! mass of grain XING [g/m2]<a name='334'></font>
    REAL                                :: GDD          <font color=#447700>! mass of grain XING[g/m2]<a name='335'></font>
    INTEGER                             :: PGS          <font color=#447700>!stem respiration [g/m2/s]<a name='336'></font>
    REAL                                :: STBLCP       <font color=#447700>! stable carbon in deep soil [g/m2]<a name='337'></font>
    REAL                                :: FASTCP       <font color=#447700>! short-lived carbon, shallow soil [g/m2]<a name='338'></font>
    REAL                                :: PLAI         <font color=#447700>! leaf area index<a name='339'></font>
    REAL                                :: PSAI         <font color=#447700>! stem area index<a name='340'></font>
    REAL                                :: TAUSS        <font color=#447700>! non-dimensional snow age<a name='341'></font>
<a name='342'>
<font color=#447700>! OUT (with no Noah LSM equivalent)<a name='343'></font>
<a name='344'>
    REAL                                :: Z0WRF        <font color=#447700>! combined z0 sent to coupled model<a name='345'></font>
    REAL                                :: T2MV         <font color=#447700>! 2m temperature of vegetation part<a name='346'></font>
    REAL                                :: T2MB         <font color=#447700>! 2m temperature of bare ground part<a name='347'></font>
    REAL                                :: Q2MV         <font color=#447700>! 2m mixing ratio of vegetation part<a name='348'></font>
    REAL                                :: Q2MB         <font color=#447700>! 2m mixing ratio of bare ground part<a name='349'></font>
    REAL                                :: TRAD         <font color=#447700>! surface radiative temperature (k)<a name='350'></font>
    REAL                                :: NEE          <font color=#447700>! net ecosys exchange (g/m2/s CO2)<a name='351'></font>
    REAL                                :: GPP          <font color=#447700>! gross primary assimilation [g/m2/s C]<a name='352'></font>
    REAL                                :: NPP          <font color=#447700>! net primary productivity [g/m2/s C]<a name='353'></font>
    REAL                                :: FVEGMP       <font color=#447700>! greenness vegetation fraction [-]<a name='354'></font>
    REAL                                :: RUNSF        <font color=#447700>! surface runoff [mm/s]<a name='355'></font>
    REAL                                :: RUNSB        <font color=#447700>! subsurface runoff [mm/s]<a name='356'></font>
    REAL                                :: ECAN         <font color=#447700>! evaporation of intercepted water (mm/s)<a name='357'></font>
    REAL                                :: ETRAN        <font color=#447700>! transpiration rate (mm/s)<a name='358'></font>
    REAL                                :: ESOIL        <font color=#447700>! soil surface evaporation rate (mm/s]<a name='359'></font>
    REAL                                :: FSA          <font color=#447700>! total absorbed solar radiation (w/m2)<a name='360'></font>
    REAL                                :: FIRA         <font color=#447700>! total net longwave rad (w/m2) [+ to atm]<a name='361'></font>
    REAL                                :: APAR         <font color=#447700>! photosyn active energy by canopy (w/m2)<a name='362'></font>
    REAL                                :: PSN          <font color=#447700>! total photosynthesis (umol co2/m2/s) [+]<a name='363'></font>
    REAL                                :: SAV          <font color=#447700>! solar rad absorbed by veg. (w/m2)<a name='364'></font>
    REAL                                :: SAG          <font color=#447700>! solar rad absorbed by ground (w/m2)<a name='365'></font>
    REAL                                :: RSSUN        <font color=#447700>! sunlit leaf stomatal resistance (s/m)<a name='366'></font>
    REAL                                :: RSSHA        <font color=#447700>! shaded leaf stomatal resistance (s/m)<a name='367'></font>
    REAL                                :: BGAP         <font color=#447700>! between gap fraction<a name='368'></font>
    REAL                                :: WGAP         <font color=#447700>! within gap fraction<a name='369'></font>
    REAL                                :: TGV          <font color=#447700>! under canopy ground temperature[K]<a name='370'></font>
    REAL                                :: TGB          <font color=#447700>! bare ground temperature [K]<a name='371'></font>
    REAL                                :: CHV          <font color=#447700>! sensible heat exchange coefficient vegetated<a name='372'></font>
    REAL                                :: CHB          <font color=#447700>! sensible heat exchange coefficient bare-ground<a name='373'></font>
    REAL                                :: IRC          <font color=#447700>! canopy net LW rad. [w/m2] [+ to atm]<a name='374'></font>
    REAL                                :: IRG          <font color=#447700>! veg ground net LW rad. [w/m2] [+ to atm]<a name='375'></font>
    REAL                                :: SHC          <font color=#447700>! canopy sen. heat [w/m2]   [+ to atm]<a name='376'></font>
    REAL                                :: SHG          <font color=#447700>! veg ground sen. heat [w/m2]   [+ to atm]<a name='377'></font>
    REAL                                :: EVG          <font color=#447700>! veg ground evap. heat [w/m2]  [+ to atm]<a name='378'></font>
    REAL                                :: GHV          <font color=#447700>! veg ground heat flux [w/m2]  [+ to soil]<a name='379'></font>
    REAL                                :: IRB          <font color=#447700>! bare net longwave rad. [w/m2] [+ to atm]<a name='380'></font>
    REAL                                :: SHB          <font color=#447700>! bare sensible heat [w/m2]     [+ to atm]<a name='381'></font>
    REAL                                :: EVB          <font color=#447700>! bare evaporation heat [w/m2]  [+ to atm]<a name='382'></font>
    REAL                                :: GHB          <font color=#447700>! bare ground heat flux [w/m2] [+ to soil]<a name='383'></font>
    REAL                                :: TR           <font color=#447700>! transpiration [w/m2]  [+ to atm]<a name='384'></font>
    REAL                                :: EVC          <font color=#447700>! canopy evaporation heat [w/m2]  [+ to atm]<a name='385'></font>
    REAL                                :: CHLEAF       <font color=#447700>! leaf exchange coefficient <a name='386'></font>
    REAL                                :: CHUC         <font color=#447700>! under canopy exchange coefficient <a name='387'></font>
    REAL                                :: CHV2         <font color=#447700>! veg 2m exchange coefficient <a name='388'></font>
    REAL                                :: CHB2         <font color=#447700>! bare 2m exchange coefficient <a name='389'></font>
  REAL   :: PAHV    <font color=#447700>!precipitation advected heat - vegetation net (W/m2)<a name='390'></font>
  REAL   :: PAHG    <font color=#447700>!precipitation advected heat - under canopy net (W/m2)<a name='391'></font>
  REAL   :: PAHB    <font color=#447700>!precipitation advected heat - bare ground net (W/m2)<a name='392'></font>
  REAL   :: PAH     <font color=#447700>!precipitation advected heat - total (W/m2)<a name='393'></font>
<a name='394'>
<font color=#447700>! Intermediate terms<a name='395'></font>
<a name='396'>
    REAL                                :: FPICE        <font color=#447700>! snow fraction of precip<a name='397'></font>
    REAL                                :: FCEV         <font color=#447700>! canopy evaporation heat (w/m2) [+ to atm]<a name='398'></font>
    REAL                                :: FGEV         <font color=#447700>! ground evaporation heat (w/m2) [+ to atm]<a name='399'></font>
    REAL                                :: FCTR         <font color=#447700>! transpiration heat flux (w/m2) [+ to atm]<a name='400'></font>
    REAL                                :: QSNBOT       <font color=#447700>! snowmelt out bottom of pack [mm/s]<a name='401'></font>
    REAL                                :: PONDING      <font color=#447700>! snowmelt with no pack [mm]<a name='402'></font>
    REAL                                :: PONDING1     <font color=#447700>! snowmelt with no pack [mm]<a name='403'></font>
    REAL                                :: PONDING2     <font color=#447700>! snowmelt with no pack [mm]<a name='404'></font>
<a name='405'>
<font color=#447700>! Local terms<a name='406'></font>
<a name='407'>
    REAL                                :: FSR          <font color=#447700>! total reflected solar radiation (w/m2)<a name='408'></font>
    REAL, DIMENSION(-2:0)               :: FICEOLD      <font color=#447700>! snow layer ice fraction []<a name='409'></font>
    REAL                                :: CO2PP        <font color=#447700>! CO2 partial pressure [Pa]<a name='410'></font>
    REAL                                :: O2PP         <font color=#447700>! O2 partial pressure [Pa]<a name='411'></font>
    REAL, DIMENSION(1:NSOIL)            :: ZSOIL        <font color=#447700>! depth to soil interfaces [m]<a name='412'></font>
    REAL                                :: FOLN         <font color=#447700>! nitrogen saturation [%]<a name='413'></font>
<a name='414'>
    REAL                                :: QC           <font color=#447700>! cloud specific humidity for MYJ [not used]<a name='415'></font>
    REAL                                :: PBLH         <font color=#447700>! PBL height for MYJ [not used]<a name='416'></font>
    REAL                                :: DZ8W1D       <font color=#447700>! model level heights for MYJ [not used]<a name='417'></font>
<a name='418'>
    INTEGER                             :: I<a name='419'>
    INTEGER                             :: J<a name='420'>
    INTEGER                             :: K<a name='421'>
    INTEGER                             :: ICE<a name='422'>
    INTEGER                             :: SLOPETYP<a name='423'>
    LOGICAL                             :: IPRINT<a name='424'>
<a name='425'>
    INTEGER                             :: SOILCOLOR          <font color=#447700>! soil color index<a name='426'></font>
    INTEGER                             :: IST          <font color=#447700>! surface type 1-soil; 2-lake<a name='427'></font>
    INTEGER                             :: YEARLEN<a name='428'>
    REAL                                :: SOLAR_TIME<a name='429'>
    INTEGER                             :: JMONTH, JDAY<a name='430'>
<a name='431'>
    INTEGER, PARAMETER                  :: NSNOW = 3    <font color=#447700>! number of snow layers fixed to 3<a name='432'></font>
    REAL, PARAMETER                     :: undefined_value = -1.E36<a name='433'>
    <a name='434'>
    type(noahmp_parameters) :: parameters<a name='435'>
<a name='436'>
<a name='437'>
<font color=#447700>! ----------------------------------------------------------------------<a name='438'></font>
<a name='439'>
    CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_OPTIONS'>NOAHMP_OPTIONS</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_OPTIONS_1">(IDVEG  ,IOPT_CRS  ,IOPT_BTR  ,IOPT_RUN  ,IOPT_SFC  ,IOPT_FRZ , &amp;<a name='440'>
                     IOPT_INF  ,IOPT_RAD  ,IOPT_ALB  ,IOPT_SNF  ,IOPT_TBOT, IOPT_STC , &amp;<a name='441'>
		     IOPT_RSF )<a name='442'>
<a name='443'>
    IPRINT    =  .false.                     <font color=#447700>! debug printout<a name='444'></font>
<a name='445'>
    YEARLEN = 365                            <font color=#447700>! find length of year for phenology (also S Hemisphere)<a name='446'></font>
    if (mod(YR,4) == 0) then<a name='447'>
       YEARLEN = 366<a name='448'>
       if (mod(YR,100) == 0) then<a name='449'>
          YEARLEN = 365<a name='450'>
          if (mod(YR,400) == 0) then<a name='451'>
             YEARLEN = 366<a name='452'>
          endif<a name='453'>
       endif<a name='454'>
    endif<a name='455'>
<a name='456'>
    ZSOIL(1) = -DZS(1)                    <font color=#447700>! depth to soil interfaces (&lt;0) [m]<a name='457'></font>
    DO K = 2, NSOIL<a name='458'>
       ZSOIL(K) = -DZS(K) + ZSOIL(K-1)<a name='459'>
    END DO<a name='460'>
<a name='461'>
    JLOOP : DO J=jts,jte<a name='462'>
<a name='463'>
       IF(ITIMESTEP == 1)THEN<a name='464'>
          DO I=its,ite<a name='465'>
             IF((XLAND(I,J)-1.5) &gt;= 0.) THEN    <font color=#447700>! Open water case<a name='466'></font>
                IF(XICE(I,J) == 1. .AND. IPRINT) PRINT *,' sea-ice at water point, I=',I,'J=',J<a name='467'>
                SMSTAV(I,J) = 1.0<a name='468'>
                SMSTOT(I,J) = 1.0<a name='469'>
                DO K = 1, NSOIL<a name='470'>
                   SMOIS(I,K,J) = 1.0<a name='471'>
                    TSLB(I,K,J) = 273.16<a name='472'>
                ENDDO<a name='473'>
             ELSE<a name='474'>
                IF(XICE(I,J) == 1.) THEN        <font color=#447700>! Sea-ice case<a name='475'></font>
                   SMSTAV(I,J) = 1.0<a name='476'>
                   SMSTOT(I,J) = 1.0<a name='477'>
                   DO K = 1, NSOIL<a name='478'>
                      SMOIS(I,K,J) = 1.0<a name='479'>
                   ENDDO<a name='480'>
                ENDIF<a name='481'>
             ENDIF<a name='482'>
          ENDDO<a name='483'>
       ENDIF                                                               <font color=#447700>! end of initialization over ocean<a name='484'></font>
<a name='485'>
<a name='486'>
<font color=#447700>!-----------------------------------------------------------------------<a name='487'></font>
   ILOOP : DO I = its, ite<a name='488'>
<a name='489'>
    IF (XICE(I,J) &gt;= XICE_THRES) THEN<a name='490'>
       ICE = 1                            <font color=#447700>! Sea-ice point<a name='491'></font>
<a name='492'>
       SH2O  (i,1:NSOIL,j) = 1.0<a name='493'>
       XLAIXY(i,j)         = 0.01<a name='494'>
<a name='495'>
       CYCLE ILOOP <font color=#447700>! Skip any processing at sea-ice points<a name='496'></font>
<a name='497'>
    ELSE<a name='498'>
<a name='499'>
       IF((XLAND(I,J)-1.5) &gt;= 0.) CYCLE ILOOP   <font color=#447700>! Open water case<a name='500'></font>
<a name='501'>
<font color=#447700>!     2D to 1D       <a name='502'></font>
<a name='503'>
<font color=#447700>! IN only<a name='504'></font>
<a name='505'>
       COSZ   = COSZIN  (I,J)                         <font color=#447700>! cos zenith angle []<a name='506'></font>
       LAT    = XLAT  (I,J)                           <font color=#447700>! latitude [rad]<a name='507'></font>
       Z_ML   = 0.5*DZ8W(I,1,J)                       <font color=#447700>! DZ8W: thickness of full levels; ZLVL forcing height [m]<a name='508'></font>
       VEGTYP = IVGTYP(I,J)                           <font color=#447700>! vegetation type<a name='509'></font>
       SOILTYP= ISLTYP(I,J)                           <font color=#447700>! soil type<a name='510'></font>
       FVEG   = VEGFRA(I,J)/100.                      <font color=#447700>! vegetation fraction [0-1]<a name='511'></font>
       FVGMAX = VEGMAX (I,J)/100.                     <font color=#447700>! Vegetation fraction annual max [0-1]<a name='512'></font>
       TBOT = TMN(I,J)                                <font color=#447700>! Fixed deep soil temperature for land<a name='513'></font>
       T_ML   = T3D(I,1,J)                            <font color=#447700>! temperature defined at intermediate level [K]<a name='514'></font>
       Q_ML   = QV3D(I,1,J)/(1.0+QV3D(I,1,J))         <font color=#447700>! convert from mixing ratio to specific humidity [kg/kg]<a name='515'></font>
       U_ML   = U_PHY(I,1,J)                          <font color=#447700>! u-wind at interface [m/s]<a name='516'></font>
       V_ML   = V_PHY(I,1,J)                          <font color=#447700>! v-wind at interface [m/s]<a name='517'></font>
       SWDN   = SWDOWN(I,J)                           <font color=#447700>! shortwave down from SW scheme [W/m2]<a name='518'></font>
       LWDN   = GLW(I,J)                              <font color=#447700>! total longwave down from LW scheme [W/m2]<a name='519'></font>
       P_ML   =(P8W3D(I,KTS+1,J)+P8W3D(I,KTS,J))*0.5  <font color=#447700>! surface pressure defined at intermediate level [Pa]<a name='520'></font>
	                                              <font color=#447700>!    consistent with temperature, mixing ratio<a name='521'></font>
       PSFC   = P8W3D(I,1,J)                          <font color=#447700>! surface pressure defined a full levels [Pa]<a name='522'></font>
       PRCP   = PRECIP_IN (I,J) / DT                  <font color=#447700>! timestep total precip rate (glacier) [mm/s]! MB: v3.7<a name='523'></font>
<a name='524'>
       CROPTYPE = 0<a name='525'>
       IF (IDVEG == 10 .AND. VEGTYP == ISCROP_TABLE) CROPTYPE = DEFAULT_CROP_TABLE <font color=#447700>! default croptype is generic dynamic vegetation crop<a name='526'></font>
       IF (IDVEG == 10 .AND. CROPCAT(I,J) &gt; 0) THEN<a name='527'>
         CROPTYPE = CROPCAT(I,J)                      <font color=#447700>! crop type<a name='528'></font>
	 VEGTYP = ISCROP_TABLE<a name='529'>
         FVGMAX = 0.95<a name='530'>
	 FVEG   = 0.95<a name='531'>
       END IF<a name='532'>
<a name='533'>
       IF (PRESENT(MP_RAINC) .AND. PRESENT(MP_RAINNC) .AND. PRESENT(MP_SHCV) .AND. &amp;<a name='534'>
           PRESENT(MP_SNOW)  .AND. PRESENT(MP_GRAUP)  .AND. PRESENT(MP_HAIL)   ) THEN<a name='535'>
<a name='536'>
         PRCPCONV  = MP_RAINC (I,J)/DT                <font color=#447700>! timestep convective precip rate [mm/s]     ! MB: v3.7<a name='537'></font>
         PRCPNONC  = MP_RAINNC(I,J)/DT                <font color=#447700>! timestep non-convective precip rate [mm/s] ! MB: v3.7<a name='538'></font>
         PRCPSHCV  = MP_SHCV(I,J)  /DT                <font color=#447700>! timestep shallow conv precip rate [mm/s]   ! MB: v3.7<a name='539'></font>
         PRCPSNOW  = MP_SNOW(I,J)  /DT                <font color=#447700>! timestep snow precip rate [mm/s]           ! MB: v3.7<a name='540'></font>
         PRCPGRPL  = MP_GRAUP(I,J) /DT                <font color=#447700>! timestep graupel precip rate [mm/s]        ! MB: v3.7<a name='541'></font>
         PRCPHAIL  = MP_HAIL(I,J)  /DT                <font color=#447700>! timestep hail precip rate [mm/s]           ! MB: v3.7<a name='542'></font>
<a name='543'>
         PRCPOTHR  = PRCP - PRCPCONV - PRCPNONC - PRCPSHCV <font color=#447700>! take care of other (fog) contained in rainbl<a name='544'></font>
	 PRCPOTHR  = MAX(0.0,PRCPOTHR)<a name='545'>
	 PRCPNONC  = PRCPNONC + PRCPOTHR<a name='546'>
         PRCPSNOW  = PRCPSNOW + SR(I,J)  * PRCPOTHR <a name='547'>
       ELSE<a name='548'>
         PRCPCONV  = 0.<a name='549'>
         PRCPNONC  = PRCP<a name='550'>
         PRCPSHCV  = 0.<a name='551'>
         PRCPSNOW  = SR(I,J) * PRCP<a name='552'>
         PRCPGRPL  = 0.<a name='553'>
         PRCPHAIL  = 0.<a name='554'>
       ENDIF<a name='555'>
<a name='556'>
<font color=#447700>! IN/OUT fields<a name='557'></font>
<a name='558'>
       ISNOW                 = ISNOWXY (I,J)                <font color=#447700>! snow layers []<a name='559'></font>
       SMC  (      1:NSOIL)  = SMOIS   (I,      1:NSOIL,J)  <font color=#447700>! soil total moisture [m3/m3]<a name='560'></font>
       SMH2O(      1:NSOIL)  = SH2O    (I,      1:NSOIL,J)  <font color=#447700>! soil liquid moisture [m3/m3]<a name='561'></font>
       STC  (-NSNOW+1:    0) = TSNOXY  (I,-NSNOW+1:    0,J) <font color=#447700>! snow temperatures [K]<a name='562'></font>
       STC  (      1:NSOIL)  = TSLB    (I,      1:NSOIL,J)  <font color=#447700>! soil temperatures [K]<a name='563'></font>
       SWE                   = SNOW    (I,J)                <font color=#447700>! snow water equivalent [mm]<a name='564'></font>
       SNDPTH                = SNOWH   (I,J)                <font color=#447700>! snow depth [m]<a name='565'></font>
       QSFC1D                = QSFC    (I,J)<a name='566'>
<a name='567'>
<font color=#447700>! INOUT (with no Noah LSM equivalent)<a name='568'></font>
<a name='569'>
       TV                    = TVXY    (I,J)                <font color=#447700>! leaf temperature [K]<a name='570'></font>
       TG                    = TGXY    (I,J)                <font color=#447700>! ground temperature [K]<a name='571'></font>
       CANLIQ                = CANLIQXY(I,J)                <font color=#447700>! canopy liquid water [mm]<a name='572'></font>
       CANICE                = CANICEXY(I,J)                <font color=#447700>! canopy frozen water [mm]<a name='573'></font>
       EAH                   = EAHXY   (I,J)                <font color=#447700>! canopy vapor pressure [Pa]<a name='574'></font>
       TAH                   = TAHXY   (I,J)                <font color=#447700>! canopy temperature [K]<a name='575'></font>
       CM                    = CMXY    (I,J)                <font color=#447700>! avg. momentum exchange (MP only) [m/s]<a name='576'></font>
       CH                    = CHXY    (I,J)                <font color=#447700>! avg. heat exchange (MP only) [m/s]<a name='577'></font>
       FWET                  = FWETXY  (I,J)                <font color=#447700>! canopy fraction wet or snow<a name='578'></font>
       SNEQVO                = SNEQVOXY(I,J)                <font color=#447700>! SWE previous timestep<a name='579'></font>
       ALBOLD                = ALBOLDXY(I,J)                <font color=#447700>! albedo previous timestep, for snow aging<a name='580'></font>
       QSNOW                 = QSNOWXY (I,J)                <font color=#447700>! snow falling on ground<a name='581'></font>
       WSLAKE                = WSLAKEXY(I,J)                <font color=#447700>! lake water storage (can be neg.) (mm)<a name='582'></font>
       ZWT                   = ZWTXY   (I,J)                <font color=#447700>! depth to water table [m]<a name='583'></font>
       WA                    = WAXY    (I,J)                <font color=#447700>! water storage in aquifer [mm]<a name='584'></font>
       WT                    = WTXY    (I,J)                <font color=#447700>! water in aquifer&amp;saturated soil [mm]<a name='585'></font>
       ZSNSO(-NSNOW+1:NSOIL) = ZSNSOXY (I,-NSNOW+1:NSOIL,J) <font color=#447700>! depth to layer interface<a name='586'></font>
       SNICE(-NSNOW+1:    0) = SNICEXY (I,-NSNOW+1:    0,J) <font color=#447700>! snow layer ice content<a name='587'></font>
       SNLIQ(-NSNOW+1:    0) = SNLIQXY (I,-NSNOW+1:    0,J) <font color=#447700>! snow layer water content<a name='588'></font>
       LFMASS                = LFMASSXY(I,J)                <font color=#447700>! leaf mass<a name='589'></font>
       RTMASS                = RTMASSXY(I,J)                <font color=#447700>! root mass<a name='590'></font>
       STMASS                = STMASSXY(I,J)                <font color=#447700>! stem mass<a name='591'></font>
       WOOD                  = WOODXY  (I,J)                <font color=#447700>! mass of wood (incl. woody roots) [g/m2]<a name='592'></font>
       STBLCP                = STBLCPXY(I,J)                <font color=#447700>! stable carbon pool<a name='593'></font>
       FASTCP                = FASTCPXY(I,J)                <font color=#447700>! fast carbon pool<a name='594'></font>
       PLAI                  = XLAIXY  (I,J)                <font color=#447700>! leaf area index [-] (no snow effects)<a name='595'></font>
       PSAI                  = XSAIXY  (I,J)                <font color=#447700>! stem area index [-] (no snow effects)<a name='596'></font>
       TAUSS                 = TAUSSXY (I,J)                <font color=#447700>! non-dimensional snow age<a name='597'></font>
       SMCEQ(       1:NSOIL) = SMOISEQ (I,       1:NSOIL,J)<a name='598'>
       SMCWTD                = SMCWTDXY(I,J)<a name='599'>
       RECH                  = 0.<a name='600'>
       DEEPRECH              = 0.<a name='601'>
<a name='602'>
       SLOPETYP     = 1                               <font color=#447700>! set underground runoff slope term<a name='603'></font>
       IST          = 1                               <font color=#447700>! MP surface type: 1 = land; 2 = lake<a name='604'></font>
       SOILCOLOR    = 4                               <font color=#447700>! soil color: assuming a middle color category ?????????<a name='605'></font>
<a name='606'>
       IF(SOILTYP == 14 .AND. XICE(I,J) == 0.) THEN<a name='607'>
          IF(IPRINT) PRINT *, ' SOIL TYPE FOUND TO BE WATER AT A LAND-POINT'<a name='608'>
          IF(IPRINT) PRINT *, i,j,'RESET SOIL in surfce.F'<a name='609'>
          SOILTYP = 7<a name='610'>
       ENDIF<a name='611'>
<a name='612'>
       IF( IVGTYP(I,J) == ISURBAN_TABLE                  .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL_TABLE .or. &amp;<a name='613'>
           IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL_TABLE .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL_TABLE ) THEN<a name='614'>
<a name='615'>
         IF(SF_URBAN_PHYSICS == 0 ) THEN<a name='616'>
           VEGTYP = ISURBAN_TABLE<a name='617'>
         ELSE<a name='618'>
           VEGTYP = NATURAL_TABLE  <font color=#447700>! set urban vegetation type based on table natural<a name='619'></font>
           FVGMAX = 0.96 <a name='620'>
         ENDIF<a name='621'>
<a name='622'>
       ENDIF<a name='623'>
<a name='624'>
<font color=#447700>! placeholders for 3D soil<a name='625'></font>
<font color=#447700>!       parameters%bexp   = BEXP_3D  (I,1:NSOIL,J) ! C-H B exponent<a name='626'></font>
<font color=#447700>!       parameters%smcdry = SMCDRY_3D(I,1:NSOIL,J) ! Soil Moisture Limit: Dry<a name='627'></font>
<font color=#447700>!       parameters%smcwlt = SMCWLT_3D(I,1:NSOIL,J) ! Soil Moisture Limit: Wilt<a name='628'></font>
<font color=#447700>!       parameters%smcref = SMCREF_3D(I,1:NSOIL,J) ! Soil Moisture Limit: Reference<a name='629'></font>
<font color=#447700>!       parameters%smcmax = SMCMAX_3D(I,1:NSOIL,J) ! Soil Moisture Limit: Max<a name='630'></font>
<font color=#447700>!       parameters%dksat  = DKSAT_3D (I,1:NSOIL,J) ! Saturated Soil Conductivity<a name='631'></font>
<font color=#447700>!       parameters%dwsat  = DWSAT_3D (I,1:NSOIL,J) ! Saturated Soil Diffusivity<a name='632'></font>
<font color=#447700>!       parameters%psisat = PSISAT_3D(I,1:NSOIL,J) ! Saturated Matric Potential<a name='633'></font>
<font color=#447700>!       parameters%quartz = QUARTZ_3D(I,1:NSOIL,J) ! Soil quartz content<a name='634'></font>
<font color=#447700>!       parameters%refdk  = REFDK_2D (I,J)         ! Reference Soil Conductivity<a name='635'></font>
<font color=#447700>!       parameters%refkdt = REFKDT_2D(I,J)         ! Soil Infiltration Parameter<a name='636'></font>
<a name='637'>
       CALL <A href='../../html_code/phys/module_sf_noahmpdrv.F.html#TRANSFER_MP_PARAMETERS'>TRANSFER_MP_PARAMETERS</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRANSFER_MP_PARAMETERS_1">(VEGTYP,SOILTYP,SLOPETYP,SOILCOLOR,CROPTYPE,parameters)<a name='638'>
       <a name='639'>
       GRAIN = GRAINXY (I,J)                <font color=#447700>! mass of grain XING [g/m2]<a name='640'></font>
       GDD   = GDDXY (I,J)                  <font color=#447700>! growing degree days XING<a name='641'></font>
       PGS   = PGSXY (I,J)                  <font color=#447700>! growing degree days XING<a name='642'></font>
<a name='643'>
       if(idveg == 10 .and. croptype &gt; 0) then<a name='644'>
         parameters%PLTDAY = PLANTING(I,J)<a name='645'>
	 parameters%HSDAY  = HARVEST (I,J)<a name='646'>
	 parameters%GDDS1  = SEASON_GDD(I,J) / 1770.0 * parameters%GDDS1<a name='647'>
	 parameters%GDDS2  = SEASON_GDD(I,J) / 1770.0 * parameters%GDDS2<a name='648'>
	 parameters%GDDS3  = SEASON_GDD(I,J) / 1770.0 * parameters%GDDS3<a name='649'>
	 parameters%GDDS4  = SEASON_GDD(I,J) / 1770.0 * parameters%GDDS4<a name='650'>
	 parameters%GDDS5  = SEASON_GDD(I,J) / 1770.0 * parameters%GDDS5<a name='651'>
       end if<a name='652'>
<a name='653'>
<font color=#447700>!=== hydrological processes for vegetation in urban model ===<a name='654'></font>
<font color=#447700>!=== irrigate vegetaion only in urban area, MAY-SEP, 9-11pm<a name='655'></font>
<a name='656'>
       IF( IVGTYP(I,J) == ISURBAN_TABLE                  .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL_TABLE .or. &amp;<a name='657'>
           IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL_TABLE .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL_TABLE ) THEN<a name='658'>
<a name='659'>
         IF(SF_URBAN_PHYSICS &gt; 0 .AND. IRI_SCHEME == 1 ) THEN<a name='660'>
	     SOLAR_TIME = (JULIAN - INT(JULIAN))*24 + XLONG(I,J)/15.0<a name='661'>
	     IF(SOLAR_TIME &lt; 0.) SOLAR_TIME = SOLAR_TIME + 24.<a name='662'>
             CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>CAL_MON_DAY</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_12">(INT(JULIAN),YR,JMONTH,JDAY)<a name='663'>
             IF (SOLAR_TIME &gt;= 21. .AND. SOLAR_TIME &lt;= 23. .AND. JMONTH &gt;= 5 .AND. JMONTH &lt;= 9) THEN<a name='664'>
                SMC(1) = max(SMC(1),parameters%SMCREF(1))<a name='665'>
                SMC(2) = max(SMC(2),parameters%SMCREF(2))<a name='666'>
             ENDIF<a name='667'>
         ENDIF<a name='668'>
<a name='669'>
       ENDIF<a name='670'>
<a name='671'>
<font color=#447700>! Initialized local<a name='672'></font>
<a name='673'>
       FICEOLD = 0.0<a name='674'>
       FICEOLD(ISNOW+1:0) = SNICEXY(I,ISNOW+1:0,J) &amp;  <font color=#447700>! snow ice fraction  <a name='675'></font>
           /(SNICEXY(I,ISNOW+1:0,J)+SNLIQXY(I,ISNOW+1:0,J))<a name='676'>
       CO2PP  = CO2_TABLE * P_ML                      <font color=#447700>! partial pressure co2 [Pa]<a name='677'></font>
       O2PP   = O2_TABLE  * P_ML                      <font color=#447700>! partial pressure  o2 [Pa]<a name='678'></font>
       FOLN   = 1.0                                   <font color=#447700>! for now, set to nitrogen saturation<a name='679'></font>
       QC     = undefined_value                       <font color=#447700>! test dummy value<a name='680'></font>
       PBLH   = undefined_value                       <font color=#447700>! test dummy value ! PBL height<a name='681'></font>
       DZ8W1D = DZ8W (I,1,J)                          <font color=#447700>! thickness of atmospheric layers<a name='682'></font>
<a name='683'>
       IF(VEGTYP == 25) FVEG = 0.0                  <font color=#447700>! Set playa, lava, sand to bare<a name='684'></font>
       IF(VEGTYP == 25) PLAI = 0.0 <a name='685'>
       IF(VEGTYP == 26) FVEG = 0.0                  <font color=#447700>! hard coded for USGS<a name='686'></font>
       IF(VEGTYP == 26) PLAI = 0.0<a name='687'>
       IF(VEGTYP == 27) FVEG = 0.0<a name='688'>
       IF(VEGTYP == 27) PLAI = 0.0<a name='689'>
<a name='690'>
       IF ( VEGTYP == ISICE_TABLE ) THEN<a name='691'>
         ICE = -1                           <font color=#447700>! Land-ice point<a name='692'></font>
         CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_OPTIONS_GLACIER'>NOAHMP_OPTIONS_GLACIER</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_OPTIONS_GLACIER_1">(IOPT_ALB  ,IOPT_SNF  ,IOPT_TBOT, IOPT_STC, IOPT_GLA )<a name='693'>
      <a name='694'>
         TBOT = MIN(TBOT,263.15)                      <font color=#447700>! set deep temp to at most -10C<a name='695'></font>
         CALL <A href='../../html_code/phys/module_sf_noahmp_glacier.F.html#NOAHMP_GLACIER'>NOAHMP_GLACIER</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_GLACIER_1">(     I,       J,    COSZ,   NSNOW,   NSOIL,      DT, &amp; <font color=#447700>! IN : Time/Space/Model-related<a name='696'></font>
                               T_ML,    P_ML,    U_ML,    V_ML,    Q_ML,    SWDN, &amp; <font color=#447700>! IN : Forcing<a name='697'></font>
                               PRCP,    LWDN,    TBOT,    Z_ML, FICEOLD,   ZSOIL, &amp; <font color=#447700>! IN : Forcing<a name='698'></font>
                              QSNOW,  SNEQVO,  ALBOLD,      CM,      CH,   ISNOW, &amp; <font color=#447700>! IN/OUT :<a name='699'></font>
                                SWE,     SMC,   ZSNSO,  SNDPTH,   SNICE,   SNLIQ, &amp; <font color=#447700>! IN/OUT :<a name='700'></font>
                                 TG,     STC,   SMH2O,   TAUSS,  QSFC1D,          &amp; <font color=#447700>! IN/OUT :<a name='701'></font>
                                FSA,     FSR,    FIRA,     FSH,    FGEV,   SSOIL, &amp; <font color=#447700>! OUT : <a name='702'></font>
                               TRAD,   ESOIL,   RUNSF,   RUNSB,     SAG,    SALB, &amp; <font color=#447700>! OUT :<a name='703'></font>
                              QSNBOT,PONDING,PONDING1,PONDING2,    T2MB,    Q2MB, &amp; <font color=#447700>! OUT :<a name='704'></font>
			      EMISSI,  FPICE,    CHB2 &amp;                             <font color=#447700>! OUT :<a name='705'></font>
#ifdef WRF_HYDRO<a name='706'>
                              , sfcheadrt(i,j)                                      &amp;<a name='707'>
#endif<a name='708'>
                              )<a name='709'>
<a name='710'>
         FSNO   = 1.0       <a name='711'>
         TV     = undefined_value     <font color=#447700>! Output from standard Noah-MP undefined for glacier points<a name='712'></font>
         TGB    = TG <a name='713'>
         CANICE = undefined_value <a name='714'>
         CANLIQ = undefined_value <a name='715'>
         EAH    = undefined_value <a name='716'>
         TAH    = undefined_value<a name='717'>
         FWET   = undefined_value <a name='718'>
         WSLAKE = undefined_value <a name='719'>
<font color=#447700>!         ZWT    = undefined_value <a name='720'></font>
         WA     = undefined_value <a name='721'>
         WT     = undefined_value <a name='722'>
         LFMASS = undefined_value <a name='723'>
         RTMASS = undefined_value <a name='724'>
         STMASS = undefined_value <a name='725'>
         WOOD   = undefined_value <a name='726'>
         GRAIN  = undefined_value<a name='727'>
         GDD    = undefined_value<a name='728'>
         STBLCP = undefined_value <a name='729'>
         FASTCP = undefined_value <a name='730'>
         PLAI   = undefined_value <a name='731'>
         PSAI   = undefined_value <a name='732'>
         T2MV   = undefined_value <a name='733'>
         Q2MV   = undefined_value <a name='734'>
         NEE    = undefined_value <a name='735'>
         GPP    = undefined_value <a name='736'>
         NPP    = undefined_value <a name='737'>
         FVEGMP = 0.0 <a name='738'>
         ECAN   = undefined_value <a name='739'>
         ETRAN  = undefined_value <a name='740'>
         APAR   = undefined_value <a name='741'>
         PSN    = undefined_value <a name='742'>
         SAV    = undefined_value <a name='743'>
         RSSUN  = undefined_value <a name='744'>
         RSSHA  = undefined_value <a name='745'>
         BGAP   = undefined_value <a name='746'>
         WGAP   = undefined_value <a name='747'>
         TGV    = undefined_value<a name='748'>
         CHV    = undefined_value <a name='749'>
         CHB    = CH <a name='750'>
         IRC    = undefined_value <a name='751'>
         IRG    = undefined_value <a name='752'>
         SHC    = undefined_value <a name='753'>
         SHG    = undefined_value <a name='754'>
         EVG    = undefined_value <a name='755'>
         GHV    = undefined_value <a name='756'>
         IRB    = FIRA<a name='757'>
         SHB    = FSH<a name='758'>
         EVB    = FGEV<a name='759'>
         GHB    = SSOIL<a name='760'>
         TR     = undefined_value <a name='761'>
         EVC    = undefined_value <a name='762'>
         CHLEAF = undefined_value <a name='763'>
         CHUC   = undefined_value <a name='764'>
         CHV2   = undefined_value <a name='765'>
         FCEV   = undefined_value <a name='766'>
         FCTR   = undefined_value        <a name='767'>
         Z0WRF  = 0.002<a name='768'>
         QFX(I,J) = ESOIL<a name='769'>
         LH (I,J) = FGEV<a name='770'>
<a name='771'>
<a name='772'>
    ELSE<a name='773'>
         ICE=0                              <font color=#447700>! Neither sea ice or land ice.<a name='774'></font>
         CALL <A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_SFLX'>NOAHMP_SFLX</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_SFLX_1"> (parameters, &amp;<a name='775'>
            I       , J       , LAT     , YEARLEN , JULIAN  , COSZ    , &amp; <font color=#447700>! IN : Time/Space-related<a name='776'></font>
            DT      , DX      , DZ8W1D  , NSOIL   , ZSOIL   , NSNOW   , &amp; <font color=#447700>! IN : Model configuration <a name='777'></font>
            FVEG    , FVGMAX  , VEGTYP  , ICE     , IST     , CROPTYPE, &amp; <font color=#447700>! IN : Vegetation/Soil characteristics<a name='778'></font>
            SMCEQ   ,                                                   &amp; <font color=#447700>! IN : Vegetation/Soil characteristics<a name='779'></font>
            T_ML    , P_ML    , PSFC    , U_ML    , V_ML    , Q_ML    , &amp; <font color=#447700>! IN : Forcing<a name='780'></font>
            QC      , SWDN    , LWDN    ,                               &amp; <font color=#447700>! IN : Forcing<a name='781'></font>
	    PRCPCONV, PRCPNONC, PRCPSHCV, PRCPSNOW, PRCPGRPL, PRCPHAIL, &amp; <font color=#447700>! IN : Forcing<a name='782'></font>
            TBOT    , CO2PP   , O2PP    , FOLN    , FICEOLD , Z_ML    , &amp; <font color=#447700>! IN : Forcing<a name='783'></font>
            ALBOLD  , SNEQVO  ,                                         &amp; <font color=#447700>! IN/OUT : <a name='784'></font>
            STC     , SMH2O   , SMC     , TAH     , EAH     , FWET    , &amp; <font color=#447700>! IN/OUT : <a name='785'></font>
            CANLIQ  , CANICE  , TV      , TG      , QSFC1D  , QSNOW   , &amp; <font color=#447700>! IN/OUT : <a name='786'></font>
            ISNOW   , ZSNSO   , SNDPTH  , SWE     , SNICE   , SNLIQ   , &amp; <font color=#447700>! IN/OUT : <a name='787'></font>
            ZWT     , WA      , WT      , WSLAKE  , LFMASS  , RTMASS  , &amp; <font color=#447700>! IN/OUT : <a name='788'></font>
            STMASS  , WOOD    , STBLCP  , FASTCP  , PLAI    , PSAI    , &amp; <font color=#447700>! IN/OUT : <a name='789'></font>
            CM      , CH      , TAUSS   ,                               &amp; <font color=#447700>! IN/OUT : <a name='790'></font>
            GRAIN   , GDD     , PGS     ,                               &amp; <font color=#447700>! IN/OUT <a name='791'></font>
            SMCWTD  ,DEEPRECH , RECH    ,                               &amp; <font color=#447700>! IN/OUT :<a name='792'></font>
            Z0WRF   ,                                                   &amp;<a name='793'>
            FSA     , FSR     , FIRA    , FSH     , SSOIL   , FCEV    , &amp; <font color=#447700>! OUT : <a name='794'></font>
            FGEV    , FCTR    , ECAN    , ETRAN   , ESOIL   , TRAD    , &amp; <font color=#447700>! OUT : <a name='795'></font>
            TGB     , TGV     , T2MV    , T2MB    , Q2MV    , Q2MB    , &amp; <font color=#447700>! OUT : <a name='796'></font>
            RUNSF   , RUNSB   , APAR    , PSN     , SAV     , SAG     , &amp; <font color=#447700>! OUT : <a name='797'></font>
            FSNO    , NEE     , GPP     , NPP     , FVEGMP  , SALB    , &amp; <font color=#447700>! OUT : <a name='798'></font>
            QSNBOT  , PONDING , PONDING1, PONDING2, RSSUN   , RSSHA   , &amp; <font color=#447700>! OUT : <a name='799'></font>
            BGAP    , WGAP    , CHV     , CHB     , EMISSI  ,           &amp; <font color=#447700>! OUT : <a name='800'></font>
            SHG     , SHC     , SHB     , EVG     , EVB     , GHV     , &amp; <font color=#447700>! OUT :<a name='801'></font>
	    GHB     , IRG     , IRC     , IRB     , TR      , EVC     , &amp; <font color=#447700>! OUT :<a name='802'></font>
	    CHLEAF  , CHUC    , CHV2    , CHB2    , FPICE   , PAHV    , &amp; <a name='803'>
            PAHG    , PAHB    , PAH                                     &amp;<a name='804'>
#ifdef WRF_HYDRO<a name='805'>
            , sfcheadrt(i,j)                               &amp;<a name='806'>
#endif<a name='807'>
            )            <font color=#447700>! OUT :<a name='808'></font>
                  <a name='809'>
            QFX(I,J) = ECAN + ESOIL + ETRAN<a name='810'>
            LH       (I,J)                = FCEV + FGEV + FCTR<a name='811'>
<a name='812'>
   ENDIF <font color=#447700>! glacial split ends <a name='813'></font>
<a name='814'>
#ifdef WRF_HYDRO<a name='815'>
<font color=#447700>!AD_CHANGE: Glacier cells can produce small negative subsurface runoff for mass balance.<a name='816'></font>
<font color=#447700>!           This will crash channel routing, so only pass along positive runoff.<a name='817'></font>
            soldrain(i,j) = max(RUNSB*dt, 0.)        <font color=#447700>!mm , underground runoff<a name='818'></font>
            INFXSRT(i,j) = RUNSF*dt        <font color=#447700>!mm , surface runoff<a name='819'></font>
#endif<a name='820'>
<a name='821'>
<a name='822'>
<font color=#447700>! INPUT/OUTPUT<a name='823'></font>
<a name='824'>
             TSK      (I,J)                = TRAD<a name='825'>
             HFX      (I,J)                = FSH<a name='826'>
             GRDFLX   (I,J)                = SSOIL<a name='827'>
	     SMSTAV   (I,J)                = 0.0  <font color=#447700>! [maintained as Noah consistency]<a name='828'></font>
             SMSTOT   (I,J)                = 0.0  <font color=#447700>! [maintained as Noah consistency]<a name='829'></font>
             SFCRUNOFF(I,J)                = SFCRUNOFF(I,J) + RUNSF * DT<a name='830'>
             UDRUNOFF (I,J)                = UDRUNOFF(I,J)  + RUNSB * DT<a name='831'>
             IF ( SALB &gt; -999 ) THEN<a name='832'>
                ALBEDO(I,J)                = SALB<a name='833'>
             ENDIF<a name='834'>
             SNOWC    (I,J)                = FSNO<a name='835'>
             SMOIS    (I,      1:NSOIL,J)  = SMC   (      1:NSOIL)<a name='836'>
             SH2O     (I,      1:NSOIL,J)  = SMH2O (      1:NSOIL)<a name='837'>
             TSLB     (I,      1:NSOIL,J)  = STC   (      1:NSOIL)<a name='838'>
             SNOW     (I,J)                = SWE<a name='839'>
             SNOWH    (I,J)                = SNDPTH<a name='840'>
             CANWAT   (I,J)                = CANLIQ + CANICE<a name='841'>
             ACSNOW   (I,J)                = ACSNOW(I,J) +  PRECIP_IN(I,J) * FPICE<a name='842'>
             ACSNOM   (I,J)                = ACSNOM(I,J) + QSNBOT*DT + PONDING + PONDING1 + PONDING2<a name='843'>
             EMISS    (I,J)                = EMISSI<a name='844'>
             QSFC     (I,J)                = QSFC1D<a name='845'>
<a name='846'>
             ISNOWXY  (I,J)                = ISNOW<a name='847'>
             TVXY     (I,J)                = TV<a name='848'>
             TGXY     (I,J)                = TG<a name='849'>
             CANLIQXY (I,J)                = CANLIQ<a name='850'>
             CANICEXY (I,J)                = CANICE<a name='851'>
             EAHXY    (I,J)                = EAH<a name='852'>
             TAHXY    (I,J)                = TAH<a name='853'>
             CMXY     (I,J)                = CM<a name='854'>
             CHXY     (I,J)                = CH<a name='855'>
             FWETXY   (I,J)                = FWET<a name='856'>
             SNEQVOXY (I,J)                = SNEQVO<a name='857'>
             ALBOLDXY (I,J)                = ALBOLD<a name='858'>
             QSNOWXY  (I,J)                = QSNOW<a name='859'>
             WSLAKEXY (I,J)                = WSLAKE<a name='860'>
             ZWTXY    (I,J)                = ZWT<a name='861'>
             WAXY     (I,J)                = WA<a name='862'>
             WTXY     (I,J)                = WT<a name='863'>
             TSNOXY   (I,-NSNOW+1:    0,J) = STC   (-NSNOW+1:    0)<a name='864'>
             ZSNSOXY  (I,-NSNOW+1:NSOIL,J) = ZSNSO (-NSNOW+1:NSOIL)<a name='865'>
             SNICEXY  (I,-NSNOW+1:    0,J) = SNICE (-NSNOW+1:    0)<a name='866'>
             SNLIQXY  (I,-NSNOW+1:    0,J) = SNLIQ (-NSNOW+1:    0)<a name='867'>
             LFMASSXY (I,J)                = LFMASS<a name='868'>
             RTMASSXY (I,J)                = RTMASS<a name='869'>
             STMASSXY (I,J)                = STMASS<a name='870'>
             WOODXY   (I,J)                = WOOD<a name='871'>
             STBLCPXY (I,J)                = STBLCP<a name='872'>
             FASTCPXY (I,J)                = FASTCP<a name='873'>
             XLAIXY   (I,J)                = PLAI<a name='874'>
             XSAIXY   (I,J)                = PSAI<a name='875'>
             TAUSSXY  (I,J)                = TAUSS<a name='876'>
<a name='877'>
<font color=#447700>! OUTPUT<a name='878'></font>
<a name='879'>
             Z0       (I,J)                = Z0WRF<a name='880'>
             ZNT      (I,J)                = Z0WRF<a name='881'>
             T2MVXY   (I,J)                = T2MV<a name='882'>
             T2MBXY   (I,J)                = T2MB<a name='883'>
             Q2MVXY   (I,J)                = Q2MV/(1.0 - Q2MV)  <font color=#447700>! specific humidity to mixing ratio<a name='884'></font>
             Q2MBXY   (I,J)                = Q2MB/(1.0 - Q2MB)  <font color=#447700>! consistent with registry def of Q2<a name='885'></font>
             TRADXY   (I,J)                = TRAD<a name='886'>
             NEEXY    (I,J)                = NEE<a name='887'>
             GPPXY    (I,J)                = GPP<a name='888'>
             NPPXY    (I,J)                = NPP<a name='889'>
             FVEGXY   (I,J)                = FVEGMP<a name='890'>
             RUNSFXY  (I,J)                = RUNSF<a name='891'>
             RUNSBXY  (I,J)                = RUNSB<a name='892'>
             ECANXY   (I,J)                = ECAN<a name='893'>
             EDIRXY   (I,J)                = ESOIL<a name='894'>
             ETRANXY  (I,J)                = ETRAN<a name='895'>
             FSAXY    (I,J)                = FSA<a name='896'>
             FIRAXY   (I,J)                = FIRA<a name='897'>
             APARXY   (I,J)                = APAR<a name='898'>
             PSNXY    (I,J)                = PSN<a name='899'>
             SAVXY    (I,J)                = SAV<a name='900'>
             SAGXY    (I,J)                = SAG<a name='901'>
             RSSUNXY  (I,J)                = RSSUN<a name='902'>
             RSSHAXY  (I,J)                = RSSHA<a name='903'>
             BGAPXY   (I,J)                = BGAP<a name='904'>
             WGAPXY   (I,J)                = WGAP<a name='905'>
             TGVXY    (I,J)                = TGV<a name='906'>
             TGBXY    (I,J)                = TGB<a name='907'>
             CHVXY    (I,J)                = CHV<a name='908'>
             CHBXY    (I,J)                = CHB<a name='909'>
             IRCXY    (I,J)                = IRC<a name='910'>
             IRGXY    (I,J)                = IRG<a name='911'>
             SHCXY    (I,J)                = SHC<a name='912'>
             SHGXY    (I,J)                = SHG<a name='913'>
             EVGXY    (I,J)                = EVG<a name='914'>
             GHVXY    (I,J)                = GHV<a name='915'>
             IRBXY    (I,J)                = IRB<a name='916'>
             SHBXY    (I,J)                = SHB<a name='917'>
             EVBXY    (I,J)                = EVB<a name='918'>
             GHBXY    (I,J)                = GHB<a name='919'>
             TRXY     (I,J)                = TR<a name='920'>
             EVCXY    (I,J)                = EVC<a name='921'>
             CHLEAFXY (I,J)                = CHLEAF<a name='922'>
             CHUCXY   (I,J)                = CHUC<a name='923'>
             CHV2XY   (I,J)                = CHV2<a name='924'>
             CHB2XY   (I,J)                = CHB2<a name='925'>
             RECHXY   (I,J)                = RECHXY(I,J) + RECH*1.E3 <font color=#447700>!RECHARGE TO THE WATER TABLE<a name='926'></font>
             DEEPRECHXY(I,J)               = DEEPRECHXY(I,J) + DEEPRECH<a name='927'>
             SMCWTDXY(I,J)                 = SMCWTD<a name='928'>
<a name='929'>
             GRAINXY  (I,J) = GRAIN <font color=#447700>!GRAIN XING<a name='930'></font>
             GDDXY    (I,J) = GDD   <font color=#447700>!XING <a name='931'></font>
	     PGSXY    (I,J) = PGS<a name='932'>
<a name='933'>
          ENDIF                                                         <font color=#447700>! endif of land-sea test<a name='934'></font>
<a name='935'>
      ENDDO ILOOP                                                       <font color=#447700>! of I loop<a name='936'></font>
   ENDDO JLOOP                                                          <font color=#447700>! of J loop<a name='937'></font>
<a name='938'>
<font color=#447700>!------------------------------------------------------<a name='939'></font>
  END SUBROUTINE noahmplsm<a name='940'>
<font color=#447700>!------------------------------------------------------<a name='941'></font>
<a name='942'>
<A NAME='TRANSFER_MP_PARAMETERS'><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#TRANSFER_MP_PARAMETERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='943'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>TRANSFER_MP_PARAMETERS</font>(VEGTYPE,SOILTYPE,SLOPETYPE,SOILCOLOR,CROPTYPE,parameters) <A href='../../call_to/TRANSFER_MP_PARAMETERS.html' TARGET='index'>1</A>,<A href='../../call_from/TRANSFER_MP_PARAMETERS.html' TARGET='index'>2</A><a name='944'>
<a name='945'>
  USE <A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_TABLES'>NOAHMP_TABLES</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#TRANSFER_MP_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_TABLES_5"><a name='946'>
  USE <A href='../../html_code/phys/module_sf_noahmplsm.F.html#MODULE_SF_NOAHMPLSM'>MODULE_SF_NOAHMPLSM</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#TRANSFER_MP_PARAMETERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHMPLSM_2"><a name='947'>
<a name='948'>
  implicit none<a name='949'>
<a name='950'>
  INTEGER, INTENT(IN)    :: VEGTYPE<a name='951'>
  INTEGER, INTENT(IN)    :: SOILTYPE<a name='952'>
  INTEGER, INTENT(IN)    :: SLOPETYPE<a name='953'>
  INTEGER, INTENT(IN)    :: SOILCOLOR<a name='954'>
  INTEGER, INTENT(IN)    :: CROPTYPE<a name='955'>
    <a name='956'>
  type (noahmp_parameters), intent(inout) :: parameters<a name='957'>
    <a name='958'>
  REAL    :: REFDK<a name='959'>
  REAL    :: REFKDT<a name='960'>
  REAL    :: FRZK<a name='961'>
  REAL    :: FRZFACT<a name='962'>
<a name='963'>
  parameters%ISWATER   =   ISWATER_TABLE<a name='964'>
  parameters%ISBARREN  =  ISBARREN_TABLE<a name='965'>
  parameters%ISICE     =     ISICE_TABLE<a name='966'>
  parameters%ISCROP    =    ISCROP_TABLE<a name='967'>
  parameters%EBLFOREST = EBLFOREST_TABLE<a name='968'>
<a name='969'>
  parameters%URBAN_FLAG = .FALSE.<a name='970'>
  IF( VEGTYPE == ISURBAN_TABLE                  .or. VEGTYPE == LOW_DENSITY_RESIDENTIAL_TABLE  .or. &amp;<a name='971'>
      VEGTYPE == HIGH_DENSITY_RESIDENTIAL_TABLE .or. VEGTYPE == HIGH_INTENSITY_INDUSTRIAL_TABLE ) THEN<a name='972'>
     parameters%URBAN_FLAG = .TRUE.<a name='973'>
  ENDIF<a name='974'>
<a name='975'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='976'></font>
<font color=#447700>! Transfer veg parameters<a name='977'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='978'></font>
<a name='979'>
  parameters%CH2OP  =  CH2OP_TABLE(VEGTYPE)       <font color=#447700>!maximum intercepted h2o per unit lai+sai (mm)<a name='980'></font>
  parameters%DLEAF  =  DLEAF_TABLE(VEGTYPE)       <font color=#447700>!characteristic leaf dimension (m)<a name='981'></font>
  parameters%Z0MVT  =  Z0MVT_TABLE(VEGTYPE)       <font color=#447700>!momentum roughness length (m)<a name='982'></font>
  parameters%HVT    =    HVT_TABLE(VEGTYPE)       <font color=#447700>!top of canopy (m)<a name='983'></font>
  parameters%HVB    =    HVB_TABLE(VEGTYPE)       <font color=#447700>!bottom of canopy (m)<a name='984'></font>
  parameters%DEN    =    DEN_TABLE(VEGTYPE)       <font color=#447700>!tree density (no. of trunks per m2)<a name='985'></font>
  parameters%RC     =     RC_TABLE(VEGTYPE)       <font color=#447700>!tree crown radius (m)<a name='986'></font>
  parameters%MFSNO  =  MFSNO_TABLE(VEGTYPE)       <font color=#447700>!snowmelt m parameter ()<a name='987'></font>
  parameters%SAIM   =   SAIM_TABLE(VEGTYPE,:)     <font color=#447700>!monthly stem area index, one-sided<a name='988'></font>
  parameters%LAIM   =   LAIM_TABLE(VEGTYPE,:)     <font color=#447700>!monthly leaf area index, one-sided<a name='989'></font>
  parameters%SLA    =    SLA_TABLE(VEGTYPE)       <font color=#447700>!single-side leaf area per Kg [m2/kg]<a name='990'></font>
  parameters%DILEFC = DILEFC_TABLE(VEGTYPE)       <font color=#447700>!coeficient for leaf stress death [1/s]<a name='991'></font>
  parameters%DILEFW = DILEFW_TABLE(VEGTYPE)       <font color=#447700>!coeficient for leaf stress death [1/s]<a name='992'></font>
  parameters%FRAGR  =  FRAGR_TABLE(VEGTYPE)       <font color=#447700>!fraction of growth respiration  !original was 0.3 <a name='993'></font>
  parameters%LTOVRC = LTOVRC_TABLE(VEGTYPE)       <font color=#447700>!leaf turnover [1/s]<a name='994'></font>
<a name='995'>
  parameters%C3PSN  =  C3PSN_TABLE(VEGTYPE)       <font color=#447700>!photosynthetic pathway: 0. = c4, 1. = c3<a name='996'></font>
  parameters%KC25   =   KC25_TABLE(VEGTYPE)       <font color=#447700>!co2 michaelis-menten constant at 25c (pa)<a name='997'></font>
  parameters%AKC    =    AKC_TABLE(VEGTYPE)       <font color=#447700>!q10 for kc25<a name='998'></font>
  parameters%KO25   =   KO25_TABLE(VEGTYPE)       <font color=#447700>!o2 michaelis-menten constant at 25c (pa)<a name='999'></font>
  parameters%AKO    =    AKO_TABLE(VEGTYPE)       <font color=#447700>!q10 for ko25<a name='1000'></font>
  parameters%VCMX25 = VCMX25_TABLE(VEGTYPE)       <font color=#447700>!maximum rate of carboxylation at 25c (umol co2/m**2/s)<a name='1001'></font>
  parameters%AVCMX  =  AVCMX_TABLE(VEGTYPE)       <font color=#447700>!q10 for vcmx25<a name='1002'></font>
  parameters%BP     =     BP_TABLE(VEGTYPE)       <font color=#447700>!minimum leaf conductance (umol/m**2/s)<a name='1003'></font>
  parameters%MP     =     MP_TABLE(VEGTYPE)       <font color=#447700>!slope of conductance-to-photosynthesis relationship<a name='1004'></font>
  parameters%QE25   =   QE25_TABLE(VEGTYPE)       <font color=#447700>!quantum efficiency at 25c (umol co2 / umol photon)<a name='1005'></font>
  parameters%AQE    =    AQE_TABLE(VEGTYPE)       <font color=#447700>!q10 for qe25<a name='1006'></font>
  parameters%RMF25  =  RMF25_TABLE(VEGTYPE)       <font color=#447700>!leaf maintenance respiration at 25c (umol co2/m**2/s)<a name='1007'></font>
  parameters%RMS25  =  RMS25_TABLE(VEGTYPE)       <font color=#447700>!stem maintenance respiration at 25c (umol co2/kg bio/s)<a name='1008'></font>
  parameters%RMR25  =  RMR25_TABLE(VEGTYPE)       <font color=#447700>!root maintenance respiration at 25c (umol co2/kg bio/s)<a name='1009'></font>
  parameters%ARM    =    ARM_TABLE(VEGTYPE)       <font color=#447700>!q10 for maintenance respiration<a name='1010'></font>
  parameters%FOLNMX = FOLNMX_TABLE(VEGTYPE)       <font color=#447700>!foliage nitrogen concentration when f(n)=1 (%)<a name='1011'></font>
  parameters%TMIN   =   TMIN_TABLE(VEGTYPE)       <font color=#447700>!minimum temperature for photosynthesis (k)<a name='1012'></font>
<a name='1013'>
  parameters%XL     =     XL_TABLE(VEGTYPE)       <font color=#447700>!leaf/stem orientation index<a name='1014'></font>
  parameters%RHOL   =   RHOL_TABLE(VEGTYPE,:)     <font color=#447700>!leaf reflectance: 1=vis, 2=nir<a name='1015'></font>
  parameters%RHOS   =   RHOS_TABLE(VEGTYPE,:)     <font color=#447700>!stem reflectance: 1=vis, 2=nir<a name='1016'></font>
  parameters%TAUL   =   TAUL_TABLE(VEGTYPE,:)     <font color=#447700>!leaf transmittance: 1=vis, 2=nir<a name='1017'></font>
  parameters%TAUS   =   TAUS_TABLE(VEGTYPE,:)     <font color=#447700>!stem transmittance: 1=vis, 2=nir<a name='1018'></font>
<a name='1019'>
  parameters%MRP    =    MRP_TABLE(VEGTYPE)       <font color=#447700>!microbial respiration parameter (umol co2 /kg c/ s)<a name='1020'></font>
  parameters%CWPVT  =  CWPVT_TABLE(VEGTYPE)       <font color=#447700>!empirical canopy wind parameter<a name='1021'></font>
<a name='1022'>
  parameters%WRRAT  =  WRRAT_TABLE(VEGTYPE)       <font color=#447700>!wood to non-wood ratio<a name='1023'></font>
  parameters%WDPOOL = WDPOOL_TABLE(VEGTYPE)       <font color=#447700>!wood pool (switch 1 or 0) depending on woody or not [-]<a name='1024'></font>
  parameters%TDLEF  =  TDLEF_TABLE(VEGTYPE)       <font color=#447700>!characteristic T for leaf freezing [K]<a name='1025'></font>
<a name='1026'>
  parameters%NROOT  =  NROOT_TABLE(VEGTYPE)       <font color=#447700>!number of soil layers with root present<a name='1027'></font>
  parameters%RGL    =    RGL_TABLE(VEGTYPE)       <font color=#447700>!Parameter used in radiation stress function<a name='1028'></font>
  parameters%RSMIN  =     RS_TABLE(VEGTYPE)       <font color=#447700>!Minimum stomatal resistance [s m-1]<a name='1029'></font>
  parameters%HS     =     HS_TABLE(VEGTYPE)       <font color=#447700>!Parameter used in vapor pressure deficit function<a name='1030'></font>
  parameters%TOPT   =   TOPT_TABLE(VEGTYPE)       <font color=#447700>!Optimum transpiration air temperature [K]<a name='1031'></font>
  parameters%RSMAX  =  RSMAX_TABLE(VEGTYPE)       <font color=#447700>!Maximal stomatal resistance [s m-1]<a name='1032'></font>
<a name='1033'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='1034'></font>
<font color=#447700>! Transfer rad parameters<a name='1035'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='1036'></font>
<a name='1037'>
   parameters%ALBSAT    = ALBSAT_TABLE(SOILCOLOR,:)<a name='1038'>
   parameters%ALBDRY    = ALBDRY_TABLE(SOILCOLOR,:)<a name='1039'>
   parameters%ALBICE    = ALBICE_TABLE<a name='1040'>
   parameters%ALBLAK    = ALBLAK_TABLE               <a name='1041'>
   parameters%OMEGAS    = OMEGAS_TABLE<a name='1042'>
   parameters%BETADS    = BETADS_TABLE<a name='1043'>
   parameters%BETAIS    = BETAIS_TABLE<a name='1044'>
   parameters%EG        = EG_TABLE<a name='1045'>
<a name='1046'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='1047'></font>
<font color=#447700>! Transfer crop parameters<a name='1048'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='1049'></font>
<a name='1050'>
  IF(CROPTYPE &gt; 0) THEN<a name='1051'>
   parameters%PLTDAY    =    PLTDAY_TABLE(CROPTYPE)    <font color=#447700>! Planting date<a name='1052'></font>
   parameters%HSDAY     =     HSDAY_TABLE(CROPTYPE)    <font color=#447700>! Harvest date<a name='1053'></font>
   parameters%PLANTPOP  =  PLANTPOP_TABLE(CROPTYPE)    <font color=#447700>! Plant density [per ha] - used?<a name='1054'></font>
   parameters%IRRI      =      IRRI_TABLE(CROPTYPE)    <font color=#447700>! Irrigation strategy 0= non-irrigation 1=irrigation (no water-stress)<a name='1055'></font>
   parameters%GDDTBASE  =  GDDTBASE_TABLE(CROPTYPE)    <font color=#447700>! Base temperature for GDD accumulation [C]<a name='1056'></font>
   parameters%GDDTCUT   =   GDDTCUT_TABLE(CROPTYPE)    <font color=#447700>! Upper temperature for GDD accumulation [C]<a name='1057'></font>
   parameters%GDDS1     =     GDDS1_TABLE(CROPTYPE)    <font color=#447700>! GDD from seeding to emergence<a name='1058'></font>
   parameters%GDDS2     =     GDDS2_TABLE(CROPTYPE)    <font color=#447700>! GDD from seeding to initial vegetative <a name='1059'></font>
   parameters%GDDS3     =     GDDS3_TABLE(CROPTYPE)    <font color=#447700>! GDD from seeding to post vegetative <a name='1060'></font>
   parameters%GDDS4     =     GDDS4_TABLE(CROPTYPE)    <font color=#447700>! GDD from seeding to intial reproductive<a name='1061'></font>
   parameters%GDDS5     =     GDDS5_TABLE(CROPTYPE)    <font color=#447700>! GDD from seeding to pysical maturity <a name='1062'></font>
   parameters%C3C4      =      C3C4_TABLE(CROPTYPE)    <font color=#447700>! photosynthetic pathway:  1. = c3 2. = c4<a name='1063'></font>
   parameters%AREF      =      AREF_TABLE(CROPTYPE)    <font color=#447700>! reference maximum CO2 assimulation rate <a name='1064'></font>
   parameters%PSNRF     =     PSNRF_TABLE(CROPTYPE)    <font color=#447700>! CO2 assimulation reduction factor(0-1) (caused by non-modeling part,e.g.pest,weeds)<a name='1065'></font>
   parameters%I2PAR     =     I2PAR_TABLE(CROPTYPE)    <font color=#447700>! Fraction of incoming solar radiation to photosynthetically active radiation<a name='1066'></font>
   parameters%TASSIM0   =   TASSIM0_TABLE(CROPTYPE)    <font color=#447700>! Minimum temperature for CO2 assimulation [C]<a name='1067'></font>
   parameters%TASSIM1   =   TASSIM1_TABLE(CROPTYPE)    <font color=#447700>! CO2 assimulation linearly increasing until temperature reaches T1 [C]<a name='1068'></font>
   parameters%TASSIM2   =   TASSIM2_TABLE(CROPTYPE)    <font color=#447700>! CO2 assmilation rate remain at Aref until temperature reaches T2 [C]<a name='1069'></font>
   parameters%K         =         K_TABLE(CROPTYPE)    <font color=#447700>! light extinction coefficient<a name='1070'></font>
   parameters%EPSI      =      EPSI_TABLE(CROPTYPE)    <font color=#447700>! initial light use efficiency<a name='1071'></font>
   parameters%Q10MR     =     Q10MR_TABLE(CROPTYPE)    <font color=#447700>! q10 for maintainance respiration<a name='1072'></font>
   parameters%FOLN_MX   =   FOLN_MX_TABLE(CROPTYPE)    <font color=#447700>! foliage nitrogen concentration when f(n)=1 (%)<a name='1073'></font>
   parameters%LEFREEZ   =   LEFREEZ_TABLE(CROPTYPE)    <font color=#447700>! characteristic T for leaf freezing [K]<a name='1074'></font>
   parameters%DILE_FC   =   DILE_FC_TABLE(CROPTYPE,:)  <font color=#447700>! coeficient for temperature leaf stress death [1/s]<a name='1075'></font>
   parameters%DILE_FW   =   DILE_FW_TABLE(CROPTYPE,:)  <font color=#447700>! coeficient for water leaf stress death [1/s]<a name='1076'></font>
   parameters%FRA_GR    =    FRA_GR_TABLE(CROPTYPE)    <font color=#447700>! fraction of growth respiration<a name='1077'></font>
   parameters%LF_OVRC   =   LF_OVRC_TABLE(CROPTYPE,:)  <font color=#447700>! fraction of leaf turnover  [1/s]<a name='1078'></font>
   parameters%ST_OVRC   =   ST_OVRC_TABLE(CROPTYPE,:)  <font color=#447700>! fraction of stem turnover  [1/s]<a name='1079'></font>
   parameters%RT_OVRC   =   RT_OVRC_TABLE(CROPTYPE,:)  <font color=#447700>! fraction of root tunrover  [1/s]<a name='1080'></font>
   parameters%LFMR25    =    LFMR25_TABLE(CROPTYPE)    <font color=#447700>! leaf maintenance respiration at 25C [umol CO2/m**2  /s]<a name='1081'></font>
   parameters%STMR25    =    STMR25_TABLE(CROPTYPE)    <font color=#447700>! stem maintenance respiration at 25C [umol CO2/kg bio/s]<a name='1082'></font>
   parameters%RTMR25    =    RTMR25_TABLE(CROPTYPE)    <font color=#447700>! root maintenance respiration at 25C [umol CO2/kg bio/s]<a name='1083'></font>
   parameters%GRAINMR25 = GRAINMR25_TABLE(CROPTYPE)    <font color=#447700>! grain maintenance respiration at 25C [umol CO2/kg bio/s]<a name='1084'></font>
   parameters%LFPT      =      LFPT_TABLE(CROPTYPE,:)  <font color=#447700>! fraction of carbohydrate flux to leaf<a name='1085'></font>
   parameters%STPT      =      STPT_TABLE(CROPTYPE,:)  <font color=#447700>! fraction of carbohydrate flux to stem<a name='1086'></font>
   parameters%RTPT      =      RTPT_TABLE(CROPTYPE,:)  <font color=#447700>! fraction of carbohydrate flux to root<a name='1087'></font>
   parameters%GRAINPT   =   GRAINPT_TABLE(CROPTYPE,:)  <font color=#447700>! fraction of carbohydrate flux to grain<a name='1088'></font>
   parameters%BIO2LAI   =   BIO2LAI_TABLE(CROPTYPE)    <font color=#447700>! leaf are per living leaf biomass [m^2/kg]<a name='1089'></font>
  END IF<a name='1090'>
<a name='1091'>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='1092'></font>
<font color=#447700>! Transfer global parameters<a name='1093'></font>
<font color=#447700>!------------------------------------------------------------------------------------------!<a name='1094'></font>
<a name='1095'>
   parameters%CO2        =         CO2_TABLE<a name='1096'>
   parameters%O2         =          O2_TABLE<a name='1097'>
   parameters%TIMEAN     =      TIMEAN_TABLE<a name='1098'>
   parameters%FSATMX     =      FSATMX_TABLE<a name='1099'>
   parameters%Z0SNO      =       Z0SNO_TABLE<a name='1100'>
   parameters%SSI        =         SSI_TABLE<a name='1101'>
   parameters%SWEMX      =       SWEMX_TABLE<a name='1102'>
   parameters%RSURF_SNOW =  RSURF_SNOW_TABLE<a name='1103'>
<a name='1104'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1105'></font>
<font color=#447700>!  Transfer soil parameters<a name='1106'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1107'></font>
<a name='1108'>
    parameters%BEXP   = BEXP_TABLE   (SOILTYPE)<a name='1109'>
    parameters%DKSAT  = DKSAT_TABLE  (SOILTYPE)<a name='1110'>
    parameters%DWSAT  = DWSAT_TABLE  (SOILTYPE)<a name='1111'>
    parameters%F1     = F1_TABLE     (SOILTYPE)<a name='1112'>
    parameters%PSISAT = PSISAT_TABLE (SOILTYPE)<a name='1113'>
    parameters%QUARTZ = QUARTZ_TABLE (SOILTYPE)<a name='1114'>
    parameters%SMCDRY = SMCDRY_TABLE (SOILTYPE)<a name='1115'>
    parameters%SMCMAX = SMCMAX_TABLE (SOILTYPE)<a name='1116'>
    parameters%SMCREF = SMCREF_TABLE (SOILTYPE)<a name='1117'>
    parameters%SMCWLT = SMCWLT_TABLE (SOILTYPE)<a name='1118'>
    parameters%REFDK  = REFDK_TABLE<a name='1119'>
    parameters%REFKDT = REFKDT_TABLE<a name='1120'>
<a name='1121'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1122'></font>
<font color=#447700>! Transfer GENPARM parameters<a name='1123'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1124'></font>
    parameters%CSOIL  = CSOIL_TABLE<a name='1125'>
    parameters%ZBOT   = ZBOT_TABLE<a name='1126'>
    parameters%CZIL   = CZIL_TABLE<a name='1127'>
<a name='1128'>
    FRZK   = FRZK_TABLE<a name='1129'>
    parameters%KDT    = parameters%REFKDT * parameters%DKSAT(1) / parameters%REFDK<a name='1130'>
    parameters%SLOPE  = SLOPE_TABLE(SLOPETYPE)<a name='1131'>
<a name='1132'>
    IF(parameters%URBAN_FLAG)THEN  <font color=#447700>! Hardcoding some urban parameters for soil<a name='1133'></font>
       parameters%SMCMAX = 0.45 <a name='1134'>
       parameters%SMCREF = 0.42 <a name='1135'>
       parameters%SMCWLT = 0.40 <a name='1136'>
       parameters%SMCDRY = 0.40 <a name='1137'>
       parameters%CSOIL  = 3.E6<a name='1138'>
    ENDIF<a name='1139'>
<a name='1140'>
<font color=#447700>! adjust FRZK parameter to actual soil type: FRZK * FRZFACT<a name='1141'></font>
<a name='1142'>
    IF(SOILTYPE /= 14) then<a name='1143'>
      FRZFACT = (parameters%SMCMAX(1) / parameters%SMCREF(1)) * (0.412 / 0.468)<a name='1144'>
      parameters%FRZX = FRZK * FRZFACT<a name='1145'>
    END IF<a name='1146'>
<a name='1147'>
 END SUBROUTINE TRANSFER_MP_PARAMETERS<a name='1148'>
<a name='1149'>
<A NAME='NOAHMP_INIT'><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1150'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>NOAHMP_INIT</font> ( MMINLU, SNOW , SNOWH , CANWAT , ISLTYP ,   IVGTYP, &amp; <A href='../../call_to/NOAHMP_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/NOAHMP_INIT.html' TARGET='index'>13</A><a name='1151'>
       TSLB , SMOIS , SH2O , DZS , FNDSOILW , FNDSNOWH ,             &amp;<a name='1152'>
       TSK, isnowxy , tvxy     ,tgxy     ,canicexy ,         TMN,     XICE,   &amp;<a name='1153'>
       canliqxy ,eahxy    ,tahxy    ,cmxy     ,chxy     ,                     &amp;<a name='1154'>
       fwetxy   ,sneqvoxy ,alboldxy ,qsnowxy  ,wslakexy ,zwtxy    ,waxy     , &amp;<a name='1155'>
       wtxy     ,tsnoxy   ,zsnsoxy  ,snicexy  ,snliqxy  ,lfmassxy ,rtmassxy , &amp;<a name='1156'>
       stmassxy ,woodxy   ,stblcpxy ,fastcpxy ,xsaixy   ,lai      ,           &amp;<a name='1157'>
       grainxy  ,gddxy    ,                                                   &amp;<a name='1158'>
       croptype ,cropcat  ,                      &amp;<a name='1159'>
<font color=#447700>!jref:start<a name='1160'></font>
       t2mvxy   ,t2mbxy   ,chstarxy,            &amp;<a name='1161'>
<font color=#447700>!jref:end       <a name='1162'></font>
       NSOIL, restart,                 &amp;<a name='1163'>
       allowed_to_read , iopt_run,                         &amp;<a name='1164'>
       sf_urban_physics,                         &amp;  <font color=#447700>! urban scheme<a name='1165'></font>
       ids,ide, jds,jde, kds,kde,                &amp;<a name='1166'>
       ims,ime, jms,jme, kms,kme,                &amp;<a name='1167'>
       its,ite, jts,jte, kts,kte,                &amp;<a name='1168'>
       smoiseq  ,smcwtdxy ,rechxy   ,deeprechxy, areaxy, dx, dy, msftx, msfty,&amp;     <font color=#447700>! Optional groundwater<a name='1169'></font>
       wtddt    ,stepwtd  ,dt       ,qrfsxy     ,qspringsxy  , qslatxy    ,  &amp;      <font color=#447700>! Optional groundwater<a name='1170'></font>
       fdepthxy ,ht     ,riverbedxy ,eqzwt     ,rivercondxy ,pexpxy       ,  &amp;      <font color=#447700>! Optional groundwater<a name='1171'></font>
       rechclim                                                             )    <font color=#447700>! Optional groundwater<a name='1172'></font>
<a name='1173'>
  USE <A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_TABLES'>NOAHMP_TABLES</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_TABLES_6"><a name='1174'>
<a name='1175'>
  IMPLICIT NONE<a name='1176'>
<a name='1177'>
<font color=#447700>! Initializing Canopy air temperature to 287 K seems dangerous to me [KWM].<a name='1178'></font>
<a name='1179'>
    INTEGER, INTENT(IN   )    ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='1180'>
         &amp;                           ims,ime, jms,jme, kms,kme,  &amp;<a name='1181'>
         &amp;                           its,ite, jts,jte, kts,kte<a name='1182'>
<a name='1183'>
    INTEGER, INTENT(IN)       ::     NSOIL, iopt_run<a name='1184'>
<a name='1185'>
    LOGICAL, INTENT(IN)       ::     restart,                    &amp;<a name='1186'>
         &amp;                           allowed_to_read<a name='1187'>
    INTEGER, INTENT(IN)       ::     sf_urban_physics                              <font color=#447700>! urban, by yizhou<a name='1188'></font>
<a name='1189'>
    REAL,    DIMENSION( NSOIL), INTENT(IN)    ::     DZS  <font color=#447700>! Thickness of the soil layers [m]<a name='1190'></font>
    REAL,    INTENT(IN) , OPTIONAL ::     DX, DY<a name='1191'>
    REAL,    DIMENSION( ims:ime, jms:jme ) ,  INTENT(IN) , OPTIONAL :: MSFTX,MSFTY<a name='1192'>
<a name='1193'>
    REAL,    DIMENSION( ims:ime, NSOIL, jms:jme ) ,    &amp;<a name='1194'>
         &amp;   INTENT(INOUT)    ::     SMOIS,                      &amp;<a name='1195'>
         &amp;                           SH2O,                       &amp;<a name='1196'>
         &amp;                           TSLB<a name='1197'>
<a name='1198'>
    REAL,    DIMENSION( ims:ime, jms:jme ) ,                     &amp;<a name='1199'>
         &amp;   INTENT(INOUT)    ::     SNOW,                       &amp;<a name='1200'>
         &amp;                           SNOWH,                      &amp;<a name='1201'>
         &amp;                           CANWAT<a name='1202'>
<a name='1203'>
    INTEGER, DIMENSION( ims:ime, jms:jme ),                      &amp;<a name='1204'>
         &amp;   INTENT(IN)       ::     ISLTYP,  &amp;<a name='1205'>
                                     IVGTYP<a name='1206'>
<a name='1207'>
    LOGICAL, INTENT(IN)       ::     FNDSOILW,                   &amp;<a name='1208'>
         &amp;                           FNDSNOWH<a name='1209'>
<a name='1210'>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(IN) :: TSK         <font color=#447700>!skin temperature (k)<a name='1211'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: TMN         <font color=#447700>!deep soil temperature (k)<a name='1212'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(IN) :: XICE         <font color=#447700>!sea ice fraction<a name='1213'></font>
    INTEGER, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: isnowxy     <font color=#447700>!actual no. of snow layers<a name='1214'></font>
    REAL, DIMENSION(ims:ime,-2:NSOIL,jms:jme), INTENT(INOUT) :: zsnsoxy  <font color=#447700>!snow layer depth [m]<a name='1215'></font>
    REAL, DIMENSION(ims:ime,-2:              0,jms:jme), INTENT(INOUT) :: tsnoxy   <font color=#447700>!snow temperature [K]<a name='1216'></font>
    REAL, DIMENSION(ims:ime,-2:              0,jms:jme), INTENT(INOUT) :: snicexy  <font color=#447700>!snow layer ice [mm]<a name='1217'></font>
    REAL, DIMENSION(ims:ime,-2:              0,jms:jme), INTENT(INOUT) :: snliqxy  <font color=#447700>!snow layer liquid water [mm]<a name='1218'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: tvxy        <font color=#447700>!vegetation canopy temperature<a name='1219'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: tgxy        <font color=#447700>!ground surface temperature<a name='1220'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: canicexy    <font color=#447700>!canopy-intercepted ice (mm)<a name='1221'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: canliqxy    <font color=#447700>!canopy-intercepted liquid water (mm)<a name='1222'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: eahxy       <font color=#447700>!canopy air vapor pressure (pa)<a name='1223'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: tahxy       <font color=#447700>!canopy air temperature (k)<a name='1224'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: cmxy        <font color=#447700>!momentum drag coefficient<a name='1225'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: chxy        <font color=#447700>!sensible heat exchange coefficient<a name='1226'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: fwetxy      <font color=#447700>!wetted or snowed fraction of the canopy (-)<a name='1227'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: sneqvoxy    <font color=#447700>!snow mass at last time step(mm h2o)<a name='1228'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: alboldxy    <font color=#447700>!snow albedo at last time step (-)<a name='1229'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: qsnowxy     <font color=#447700>!snowfall on the ground [mm/s]<a name='1230'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: wslakexy    <font color=#447700>!lake water storage [mm]<a name='1231'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: zwtxy       <font color=#447700>!water table depth [m]<a name='1232'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: waxy        <font color=#447700>!water in the "aquifer" [mm]<a name='1233'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: wtxy        <font color=#447700>!groundwater storage [mm]<a name='1234'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: lfmassxy    <font color=#447700>!leaf mass [g/m2]<a name='1235'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: rtmassxy    <font color=#447700>!mass of fine roots [g/m2]<a name='1236'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: stmassxy    <font color=#447700>!stem mass [g/m2]<a name='1237'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: woodxy      <font color=#447700>!mass of wood (incl. woody roots) [g/m2]<a name='1238'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: grainxy     <font color=#447700>!mass of grain [g/m2] !XING<a name='1239'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: gddxy       <font color=#447700>!growing degree days !XING<a name='1240'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: stblcpxy    <font color=#447700>!stable carbon in deep soil [g/m2]<a name='1241'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: fastcpxy    <font color=#447700>!short-lived carbon, shallow soil [g/m2]<a name='1242'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: xsaixy      <font color=#447700>!stem area index<a name='1243'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: lai         <font color=#447700>!leaf area index<a name='1244'></font>
<a name='1245'>
    INTEGER, DIMENSION(ims:ime,  jms:jme), INTENT(OUT) :: cropcat<a name='1246'>
    REAL   , DIMENSION(ims:ime,5,jms:jme), INTENT(IN ) :: croptype<a name='1247'>
<a name='1248'>
<font color=#447700>! IOPT_RUN = 5 option<a name='1249'></font>
<a name='1250'>
    REAL, DIMENSION(ims:ime,1:nsoil,jms:jme), INTENT(INOUT) , OPTIONAL :: smoiseq <font color=#447700>!equilibrium soil moisture content [m3m-3]<a name='1251'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: smcwtdxy    <font color=#447700>!deep soil moisture content [m3m-3]<a name='1252'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: deeprechxy  <font color=#447700>!deep recharge [m]<a name='1253'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: rechxy      <font color=#447700>!accumulated recharge [mm]<a name='1254'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: qrfsxy      <font color=#447700>!accumulated flux from groundwater to rivers [mm]<a name='1255'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: qspringsxy  <font color=#447700>!accumulated seeping water [mm]<a name='1256'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: qslatxy     <font color=#447700>!accumulated lateral flow [mm]<a name='1257'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: areaxy      <font color=#447700>!grid cell area [m2]<a name='1258'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(IN) , OPTIONAL :: FDEPTHXY    <font color=#447700>!efolding depth for transmissivity (m)<a name='1259'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(IN) , OPTIONAL :: HT          <font color=#447700>!terrain height (m)<a name='1260'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: RIVERBEDXY  <font color=#447700>!riverbed depth (m)<a name='1261'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) , OPTIONAL :: EQZWT       <font color=#447700>!equilibrium water table depth (m)<a name='1262'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT), OPTIONAL :: RIVERCONDXY <font color=#447700>!river conductance<a name='1263'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT), OPTIONAL :: PEXPXY      <font color=#447700>!factor for river conductance<a name='1264'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(IN) , OPTIONAL :: rechclim<a name='1265'>
<a name='1266'>
    INTEGER,  INTENT(OUT) , OPTIONAL :: STEPWTD<a name='1267'>
    REAL, INTENT(IN) , OPTIONAL :: DT, WTDDT<a name='1268'>
<a name='1269'>
<font color=#447700>!jref:start<a name='1270'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: t2mvxy        <font color=#447700>!2m temperature vegetation part (k)<a name='1271'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: t2mbxy        <font color=#447700>!2m temperature bare ground part (k)<a name='1272'></font>
    REAL, DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: chstarxy        <font color=#447700>!dummy<a name='1273'></font>
<font color=#447700>!jref:end<a name='1274'></font>
<a name='1275'>
<a name='1276'>
    REAL, DIMENSION(1:NSOIL)  :: ZSOIL      <font color=#447700>! Depth of the soil layer bottom (m) from <a name='1277'></font>
    <font color=#447700>!                                                   the surface (negative)<a name='1278'></font>
<a name='1279'>
    REAL                      :: BEXP, SMCMAX, PSISAT<a name='1280'>
    REAL                      :: FK, masslai,masssai<a name='1281'>
<a name='1282'>
    REAL, PARAMETER           :: BLIM  = 5.5<a name='1283'>
    REAL, PARAMETER           :: HLICE = 3.335E5<a name='1284'>
    REAL, PARAMETER           :: GRAV = 9.81<a name='1285'>
    REAL, PARAMETER           :: T0 = 273.15<a name='1286'>
<a name='1287'>
    INTEGER                   :: errflag, i,j,itf,jtf,ns<a name='1288'>
<a name='1289'>
    character(len=240) :: err_message<a name='1290'>
    character(len=4)  :: MMINSL<a name='1291'>
    character(len=*), intent(in) :: MMINLU<a name='1292'>
    MMINSL='STAS'<a name='1293'>
<a name='1294'>
    call <A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_VEG_PARAMETERS'>read_mp_veg_parameters</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_MP_VEG_PARAMETERS_1">(trim(MMINLU))<a name='1295'>
    call <A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_SOIL_PARAMETERS'>read_mp_soil_parameters</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_MP_SOIL_PARAMETERS_1">()<a name='1296'>
    call <A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_RAD_PARAMETERS'>read_mp_rad_parameters</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_MP_RAD_PARAMETERS_1">()<a name='1297'>
    call <A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_GLOBAL_PARAMETERS'>read_mp_global_parameters</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_MP_GLOBAL_PARAMETERS_1">()<a name='1298'>
    call <A href='../../html_code/phys/module_sf_noahmplsm.F.html#READ_MP_CROP_PARAMETERS'>read_mp_crop_parameters</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_MP_CROP_PARAMETERS_1">()<a name='1299'>
<a name='1300'>
    IF( .NOT. restart ) THEN<a name='1301'>
<a name='1302'>
       itf=min0(ite,ide-1)<a name='1303'>
       jtf=min0(jte,jde-1)<a name='1304'>
<a name='1305'>
       <font color=#447700>!<a name='1306'></font>
       <font color=#447700>! initialize physical snow height SNOWH<a name='1307'></font>
       <font color=#447700>!<a name='1308'></font>
       IF(.NOT.FNDSNOWH)THEN<a name='1309'>
          <font color=#447700>! If no SNOWH do the following<a name='1310'></font>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_954">( 'SNOW HEIGHT NOT FOUND - VALUE DEFINED IN LSMINIT' )<a name='1311'>
          DO J = jts,jtf<a name='1312'>
             DO I = its,itf<a name='1313'>
                SNOWH(I,J)=SNOW(I,J)*0.005               <font color=#447700>! SNOW in mm and SNOWH in m<a name='1314'></font>
             ENDDO<a name='1315'>
          ENDDO<a name='1316'>
       ENDIF<a name='1317'>
<a name='1318'>
<a name='1319'>
       <font color=#447700>! Check if snow/snowh are consistent and cap SWE at 2000mm;<a name='1320'></font>
       <font color=#447700>!  the Noah-MP code does it internally but if we don't do it here, problems ensue<a name='1321'></font>
       DO J = jts,jtf<a name='1322'>
          DO I = its,itf<a name='1323'>
             IF ( SNOW(i,j) &gt; 0. .AND. SNOWH(i,j) == 0. .OR. SNOWH(i,j) &gt; 0. .AND. SNOW(i,j) == 0.) THEN<a name='1324'>
               WRITE(err_message,*)"problem with initial snow fields: snow/snowh&gt;0 while snowh/snow=0 at i,j" &amp;<a name='1325'>
                                     ,i,j,snow(i,j),snowh(i,j)<a name='1326'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_955">(err_message)<a name='1327'>
             ENDIF<a name='1328'>
             IF ( SNOW( i,j ) &gt; 2000. ) THEN<a name='1329'>
               SNOWH(I,J) = SNOWH(I,J) * 2000. / SNOW(I,J)      <font color=#447700>! SNOW in mm and SNOWH in m<a name='1330'></font>
               SNOW (I,J) = 2000.                               <font color=#447700>! cap SNOW at 2000, maintain density<a name='1331'></font>
             ENDIF<a name='1332'>
          ENDDO<a name='1333'>
       ENDDO<a name='1334'>
<a name='1335'>
       errflag = 0<a name='1336'>
       DO j = jts,jtf<a name='1337'>
          DO i = its,itf<a name='1338'>
             IF ( ISLTYP( i,j ) .LT. 1 ) THEN<a name='1339'>
                errflag = 1<a name='1340'>
                WRITE(err_message,*)"module_sf_noahlsm.F: lsminit: out of range ISLTYP ",i,j,ISLTYP( i,j )<a name='1341'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_956">(err_message)<a name='1342'>
             ENDIF<a name='1343'>
          ENDDO<a name='1344'>
       ENDDO<a name='1345'>
       IF ( errflag .EQ. 1 ) THEN<a name='1346'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1182">( "module_sf_noahlsm.F: lsminit: out of range value "// &amp;<a name='1347'>
               "of ISLTYP. Is this field in the input?" )<a name='1348'>
       ENDIF<a name='1349'>
<font color=#447700>! GAC--&gt;LATERALFLOW<a name='1350'></font>
<font color=#447700>! 20130219 - No longer need this - see module_data_gocart_dust<a name='1351'></font>
<font color=#447700>!#if ( WRF_CHEM == 1 )<a name='1352'></font>
<font color=#447700>!       !<a name='1353'></font>
<font color=#447700>!       ! need this parameter for dust parameterization in wrf/chem<a name='1354'></font>
<font color=#447700>!       !<a name='1355'></font>
<font color=#447700>!       do I=1,NSLTYPE<a name='1356'></font>
<font color=#447700>!          porosity(i)=maxsmc(i)<a name='1357'></font>
<font color=#447700>!       enddo<a name='1358'></font>
<font color=#447700>!#endif<a name='1359'></font>
<font color=#447700>! &lt;--GAC<a name='1360'></font>
<a name='1361'>
<font color=#447700>! initialize soil liquid water content SH2O<a name='1362'></font>
<a name='1363'>
       DO J = jts , jtf<a name='1364'>
          DO I = its , itf<a name='1365'>
	    IF(IVGTYP(I,J)==ISICE_TABLE .AND. XICE(I,J) &lt;= 0.0) THEN<a name='1366'>
              DO NS=1, NSOIL<a name='1367'>
	        SMOIS(I,NS,J) = 1.0                     <font color=#447700>! glacier starts all frozen<a name='1368'></font>
	        SH2O(I,NS,J) = 0.0<a name='1369'>
	        TSLB(I,NS,J) = MIN(TSLB(I,NS,J),263.15) <font color=#447700>! set glacier temp to at most -10C<a name='1370'></font>
              END DO<a name='1371'>
	        <font color=#447700>!TMN(I,J) = MIN(TMN(I,J),263.15)         ! set deep temp to at most -10C<a name='1372'></font>
		SNOW(I,J) = MAX(SNOW(I,J), 10.0)        <font color=#447700>! set SWE to at least 10mm<a name='1373'></font>
                SNOWH(I,J)=SNOW(I,J)*0.01               <font color=#447700>! SNOW in mm and SNOWH in m<a name='1374'></font>
	    ELSE<a name='1375'>
	      <a name='1376'>
              BEXP   =   BEXP_TABLE(ISLTYP(I,J))<a name='1377'>
              SMCMAX = SMCMAX_TABLE(ISLTYP(I,J))<a name='1378'>
              PSISAT = -1.0*PSISAT_TABLE(ISLTYP(I,J))<a name='1379'>
<a name='1380'>
              DO NS=1, NSOIL<a name='1381'>
	        IF ( SMOIS(I,NS,J) &gt; SMCMAX )  SMOIS(I,NS,J) = SMCMAX<a name='1382'>
              END DO<a name='1383'>
              IF ( ( BEXP &gt; 0.0 ) .AND. ( SMCMAX &gt; 0.0 ) .AND. ( PSISAT &gt; 0.0 ) ) THEN<a name='1384'>
                DO NS=1, NSOIL<a name='1385'>
                   IF ( TSLB(I,NS,J) &lt; 273.149 ) THEN    <font color=#447700>! Use explicit as initial soil ice<a name='1386'></font>
                      FK=(( (HLICE/(GRAV*(-PSISAT))) *                              &amp;<a name='1387'>
                           ((TSLB(I,NS,J)-T0)/TSLB(I,NS,J)) )**(-1/BEXP) )*SMCMAX<a name='1388'>
                      FK = MAX(FK, 0.02)<a name='1389'>
                      SH2O(I,NS,J) = MIN( FK, SMOIS(I,NS,J) )<a name='1390'>
                   ELSE<a name='1391'>
                      SH2O(I,NS,J)=SMOIS(I,NS,J)<a name='1392'>
                   ENDIF<a name='1393'>
                END DO<a name='1394'>
              ELSE<a name='1395'>
                DO NS=1, NSOIL<a name='1396'>
                   SH2O(I,NS,J)=SMOIS(I,NS,J)<a name='1397'>
                END DO<a name='1398'>
              ENDIF<a name='1399'>
            ENDIF<a name='1400'>
          ENDDO<a name='1401'>
       ENDDO<a name='1402'>
<font color=#447700>!  ENDIF<a name='1403'></font>
<a name='1404'>
<a name='1405'>
       DO J = jts,jtf<a name='1406'>
          DO I = its,itf<a name='1407'>
             tvxy       (I,J) = TSK(I,J)<a name='1408'>
	       if(snow(i,j) &gt; 0.0 .and. tsk(i,j) &gt; 273.15) tvxy(I,J) = 273.15<a name='1409'>
             tgxy       (I,J) = TSK(I,J)<a name='1410'>
	       if(snow(i,j) &gt; 0.0 .and. tsk(i,j) &gt; 273.15) tgxy(I,J) = 273.15<a name='1411'>
             CANWAT     (I,J) = 0.0<a name='1412'>
             canliqxy   (I,J) = CANWAT(I,J)<a name='1413'>
             canicexy   (I,J) = 0.<a name='1414'>
             eahxy      (I,J) = 2000. <a name='1415'>
             tahxy      (I,J) = TSK(I,J)<a name='1416'>
	       if(snow(i,j) &gt; 0.0 .and. tsk(i,j) &gt; 273.15) tahxy(I,J) = 273.15<a name='1417'>
<font color=#447700>!             tahxy      (I,J) = 287.<a name='1418'></font>
<font color=#447700>!jref:start<a name='1419'></font>
             t2mvxy     (I,J) = TSK(I,J)<a name='1420'>
	       if(snow(i,j) &gt; 0.0 .and. tsk(i,j) &gt; 273.15) t2mvxy(I,J) = 273.15<a name='1421'>
             t2mbxy     (I,J) = TSK(I,J)<a name='1422'>
	       if(snow(i,j) &gt; 0.0 .and. tsk(i,j) &gt; 273.15) t2mbxy(I,J) = 273.15<a name='1423'>
             chstarxy     (I,J) = 0.1<a name='1424'>
<font color=#447700>!jref:end<a name='1425'></font>
<a name='1426'>
             cmxy       (I,J) = 0.0<a name='1427'>
             chxy       (I,J) = 0.0<a name='1428'>
             fwetxy     (I,J) = 0.0<a name='1429'>
             sneqvoxy   (I,J) = 0.0<a name='1430'>
             alboldxy   (I,J) = 0.65<a name='1431'>
             qsnowxy    (I,J) = 0.0<a name='1432'>
             wslakexy   (I,J) = 0.0<a name='1433'>
<a name='1434'>
             if(iopt_run.ne.5) then <a name='1435'>
                   waxy       (I,J) = 4900.                                       <font color=#447700>!???<a name='1436'></font>
                   wtxy       (I,J) = waxy(i,j)                                   <font color=#447700>!???<a name='1437'></font>
                   zwtxy      (I,J) = (25. + 2.0) - waxy(i,j)/1000/0.2            <font color=#447700>!???<a name='1438'></font>
             else<a name='1439'>
                   waxy       (I,J) = 0.<a name='1440'>
                   wtxy       (I,J) = 0.<a name='1441'>
                   areaxy     (I,J) = (DX * DY) / ( MSFTX(I,J) * MSFTY(I,J) )<a name='1442'>
             endif<a name='1443'>
<a name='1444'>
           IF(IVGTYP(I,J) == ISBARREN_TABLE .OR. IVGTYP(I,J) == ISICE_TABLE .OR. &amp;<a name='1445'>
	      ( SF_URBAN_PHYSICS == 0 .AND. IVGTYP(I,J) == ISURBAN_TABLE )  .OR. &amp;<a name='1446'>
	      IVGTYP(I,J) == ISWATER_TABLE ) THEN<a name='1447'>
	     <a name='1448'>
	     lai        (I,J) = 0.0<a name='1449'>
             xsaixy     (I,J) = 0.0<a name='1450'>
             lfmassxy   (I,J) = 0.0<a name='1451'>
             stmassxy   (I,J) = 0.0<a name='1452'>
             rtmassxy   (I,J) = 0.0<a name='1453'>
             woodxy     (I,J) = 0.0<a name='1454'>
             stblcpxy   (I,J) = 0.0<a name='1455'>
             fastcpxy   (I,J) = 0.0<a name='1456'>
             grainxy    (I,J) = 1E-10<a name='1457'>
             gddxy      (I,J) = 0<a name='1458'>
	     cropcat    (I,J) = 0<a name='1459'>
<a name='1460'>
	   ELSE<a name='1461'>
	     <a name='1462'>
	     lai        (I,J) = max(lai(i,j),0.05)             <font color=#447700>! at least start with 0.05 for arbitrary initialization (v3.7)<a name='1463'></font>
             xsaixy     (I,J) = max(0.1*lai(I,J),0.05)         <font color=#447700>! MB: arbitrarily initialize SAI using input LAI (v3.7)<a name='1464'></font>
             masslai = 1000. / max(SLA_TABLE(IVGTYP(I,J)),1.0) <font color=#447700>! conversion from lai to mass  (v3.7)<a name='1465'></font>
             lfmassxy   (I,J) = lai(i,j)*masslai               <font color=#447700>! use LAI to initialize (v3.7)<a name='1466'></font>
             masssai = 1000. / 3.0                             <font color=#447700>! conversion from lai to mass (v3.7)<a name='1467'></font>
             stmassxy   (I,J) = xsaixy(i,j)*masssai            <font color=#447700>! use SAI to initialize (v3.7)<a name='1468'></font>
             rtmassxy   (I,J) = 500.0                          <font color=#447700>! these are all arbitrary and probably should be<a name='1469'></font>
             woodxy     (I,J) = 500.0                          <font color=#447700>! in the table or read from initialization<a name='1470'></font>
             stblcpxy   (I,J) = 1000.0                         <font color=#447700>!<a name='1471'></font>
             fastcpxy   (I,J) = 1000.0                         <font color=#447700>!<a name='1472'></font>
             grainxy    (I,J) = 1E-10<a name='1473'>
             gddxy      (I,J) = 0    <a name='1474'>
	     cropcat    (i,j) = default_crop_table<a name='1475'>
<a name='1476'>
	     if(croptype(i,5,j) &gt;= 0.5) then<a name='1477'>
               rtmassxy(i,j) = 0.0<a name='1478'>
               woodxy  (i,j) = 0.0                    <a name='1479'>
<a name='1480'>
	       if(    croptype(i,1,j) &gt; croptype(i,2,j) .and. &amp;<a name='1481'>
		      croptype(i,1,j) &gt; croptype(i,3,j) .and. &amp;<a name='1482'>
		      croptype(i,1,j) &gt; croptype(i,4,j) ) then   <font color=#447700>! choose corn<a name='1483'></font>
<a name='1484'>
		   cropcat (i,j) = 1<a name='1485'>
                   lfmassxy(i,j) =    lai(i,j)/0.035<a name='1486'>
                   stmassxy(i,j) = xsaixy(i,j)/0.003<a name='1487'>
<a name='1488'>
	       elseif(croptype(i,2,j) &gt; croptype(i,1,j) .and. &amp;<a name='1489'>
		      croptype(i,2,j) &gt; croptype(i,3,j) .and. &amp;<a name='1490'>
		      croptype(i,2,j) &gt; croptype(i,4,j) ) then   <font color=#447700>! choose soybean<a name='1491'></font>
<a name='1492'>
		   cropcat (i,j) = 2<a name='1493'>
                   lfmassxy(i,j) =    lai(i,j)/0.015<a name='1494'>
                   stmassxy(i,j) = xsaixy(i,j)/0.003<a name='1495'>
<a name='1496'>
	       else<a name='1497'>
<a name='1498'>
		   cropcat (i,j) = default_crop_table<a name='1499'>
                   lfmassxy(i,j) =    lai(i,j)/0.035<a name='1500'>
                   stmassxy(i,j) = xsaixy(i,j)/0.003<a name='1501'>
<a name='1502'>
	       end if<a name='1503'>
<a name='1504'>
	     end if<a name='1505'>
<a name='1506'>
	   END IF<a name='1507'>
<a name='1508'>
          enddo<a name='1509'>
       enddo<a name='1510'>
<a name='1511'>
       <font color=#447700>! Given the soil layer thicknesses (in DZS), initialize the soil layer<a name='1512'></font>
       <font color=#447700>! depths from the surface.<a name='1513'></font>
       ZSOIL(1)         = -DZS(1)          <font color=#447700>! negative<a name='1514'></font>
       DO NS=2, NSOIL<a name='1515'>
          ZSOIL(NS)       = ZSOIL(NS-1) - DZS(NS)<a name='1516'>
       END DO<a name='1517'>
<a name='1518'>
       <font color=#447700>! Initialize snow/soil layer arrays ZSNSOXY, TSNOXY, SNICEXY, SNLIQXY, <a name='1519'></font>
       <font color=#447700>! and ISNOWXY<a name='1520'></font>
       CALL <A href='../../html_code/phys/module_sf_noahmpdrv.F.html#SNOW_INIT'>snow_init</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_INIT_1"> ( ims , ime , jms , jme , its , itf , jts , jtf , 3 , &amp;<a name='1521'>
            &amp;           NSOIL , zsoil , snow , tgxy , snowh ,     &amp;<a name='1522'>
            &amp;           zsnsoxy , tsnoxy , snicexy , snliqxy , isnowxy )<a name='1523'>
<a name='1524'>
       <font color=#447700>!initialize arrays for groundwater dynamics iopt_run=5<a name='1525'></font>
<a name='1526'>
       if(iopt_run.eq.5) then<a name='1527'>
          IF ( PRESENT(smoiseq)     .AND. &amp;<a name='1528'>
            PRESENT(smcwtdxy)    .AND. &amp;<a name='1529'>
            PRESENT(rechxy)      .AND. &amp;<a name='1530'>
            PRESENT(deeprechxy)  .AND. &amp;<a name='1531'>
            PRESENT(areaxy)      .AND. &amp;<a name='1532'>
            PRESENT(dx)          .AND. &amp;<a name='1533'>
            PRESENT(dy)          .AND. &amp;<a name='1534'>
            PRESENT(msftx)       .AND. &amp;<a name='1535'>
            PRESENT(msfty)       .AND. &amp;<a name='1536'>
            PRESENT(wtddt)       .AND. &amp;<a name='1537'>
            PRESENT(stepwtd)     .AND. &amp;<a name='1538'>
            PRESENT(dt)          .AND. &amp;<a name='1539'>
            PRESENT(qrfsxy)      .AND. &amp;<a name='1540'>
            PRESENT(qspringsxy)  .AND. &amp;<a name='1541'>
            PRESENT(qslatxy)     .AND. &amp;<a name='1542'>
            PRESENT(fdepthxy)    .AND. &amp;<a name='1543'>
            PRESENT(ht)          .AND. &amp;<a name='1544'>
            PRESENT(riverbedxy)  .AND. &amp;<a name='1545'>
            PRESENT(eqzwt)       .AND. &amp;<a name='1546'>
            PRESENT(rivercondxy) .AND. &amp;<a name='1547'>
            PRESENT(pexpxy)      .AND. &amp;<a name='1548'>
            PRESENT(rechclim)    ) THEN<a name='1549'>
<a name='1550'>
             STEPWTD = nint(WTDDT*60./DT)<a name='1551'>
             STEPWTD = max(STEPWTD,1)<a name='1552'>
<a name='1553'>
              CALL <A href='../../html_code/phys/module_sf_noahmpdrv.F.html#GROUNDWATER_INIT'>groundwater_init</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GROUNDWATER_INIT_1"> ( &amp; <a name='1554'>
      &amp;       nsoil, zsoil , dzs  ,isltyp, ivgtyp,wtddt , &amp;<a name='1555'>
      &amp;       fdepthxy, ht, riverbedxy, eqzwt, rivercondxy, pexpxy , areaxy, zwtxy,   &amp;<a name='1556'>
      &amp;       smois,sh2o, smoiseq, smcwtdxy, deeprechxy, rechxy, qslatxy, qrfsxy, qspringsxy, &amp;<a name='1557'>
      &amp;       rechclim  ,                                   &amp;<a name='1558'>
      &amp;       ids,ide, jds,jde, kds,kde,                    &amp;<a name='1559'>
      &amp;       ims,ime, jms,jme, kms,kme,                    &amp;<a name='1560'>
      &amp;       its,ite, jts,jte, kts,kte                     )<a name='1561'>
<a name='1562'>
          ELSE<a name='1563'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1183"> ('Not enough fields to use groundwater option in Noah-MP')<a name='1564'>
          END IF<a name='1565'>
       endif<a name='1566'>
<a name='1567'>
    ENDIF<a name='1568'>
  END SUBROUTINE NOAHMP_INIT<a name='1569'>
<a name='1570'>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='1571'></font>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='1572'></font>
<a name='1573'>
<A NAME='SNOW_INIT'><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#SNOW_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1574'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>SNOW_INIT</font> ( ims , ime , jms , jme , its , itf , jts , jtf ,                  &amp; <A href='../../call_to/SNOW_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/SNOW_INIT.html' TARGET='index'>1</A><a name='1575'>
       &amp;                 NSNOW , NSOIL , ZSOIL , SWE , TGXY , SNODEP ,                    &amp;<a name='1576'>
       &amp;                 ZSNSOXY , TSNOXY , SNICEXY ,SNLIQXY , ISNOWXY )<a name='1577'>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='1578'></font>
<font color=#447700>!   Initialize snow arrays for Noah-MP LSM, based in input SNOWDEP, NSNOW<a name='1579'></font>
<font color=#447700>!   ISNOWXY is an index array, indicating the index of the top snow layer.  Valid indices<a name='1580'></font>
<font color=#447700>!           for snow layers range from 0 (no snow) and -1 (shallow snow) to (-NSNOW)+1 (deep snow).<a name='1581'></font>
<font color=#447700>!   TSNOXY holds the temperature of the snow layer.  Snow layers are initialized with <a name='1582'></font>
<font color=#447700>!          temperature = ground temperature [?].  Snow-free levels in the array have value 0.0<a name='1583'></font>
<font color=#447700>!   SNICEXY is the frozen content of a snow layer.  Initial estimate based on SNODEP and SWE<a name='1584'></font>
<font color=#447700>!   SNLIQXY is the liquid content of a snow layer.  Initialized to 0.0<a name='1585'></font>
<font color=#447700>!   ZNSNOXY is the layer depth from the surface.  <a name='1586'></font>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='1587'></font>
    IMPLICIT NONE<a name='1588'>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='1589'></font>
    INTEGER, INTENT(IN)                              :: ims, ime, jms, jme<a name='1590'>
    INTEGER, INTENT(IN)                              :: its, itf, jts, jtf<a name='1591'>
    INTEGER, INTENT(IN)                              :: NSNOW<a name='1592'>
    INTEGER, INTENT(IN)                              :: NSOIL<a name='1593'>
    REAL,    INTENT(IN), DIMENSION(ims:ime, jms:jme) :: SWE <a name='1594'>
    REAL,    INTENT(IN), DIMENSION(ims:ime, jms:jme) :: SNODEP<a name='1595'>
    REAL,    INTENT(IN), DIMENSION(ims:ime, jms:jme) :: TGXY<a name='1596'>
    REAL,    INTENT(IN), DIMENSION(1:NSOIL)          :: ZSOIL<a name='1597'>
<a name='1598'>
    INTEGER, INTENT(OUT), DIMENSION(ims:ime, jms:jme)                :: ISNOWXY <font color=#447700>! Top snow layer index<a name='1599'></font>
    REAL,    INTENT(OUT), DIMENSION(ims:ime, -NSNOW+1:NSOIL,jms:jme) :: ZSNSOXY <font color=#447700>! Snow/soil layer depth from surface [m]<a name='1600'></font>
    REAL,    INTENT(OUT), DIMENSION(ims:ime, -NSNOW+1:    0,jms:jme) :: TSNOXY  <font color=#447700>! Snow layer temperature [K]<a name='1601'></font>
    REAL,    INTENT(OUT), DIMENSION(ims:ime, -NSNOW+1:    0,jms:jme) :: SNICEXY <font color=#447700>! Snow layer ice content [mm]<a name='1602'></font>
    REAL,    INTENT(OUT), DIMENSION(ims:ime, -NSNOW+1:    0,jms:jme) :: SNLIQXY <font color=#447700>! snow layer liquid content [mm]<a name='1603'></font>
<a name='1604'>
<font color=#447700>! Local variables:<a name='1605'></font>
<font color=#447700>!   DZSNO   holds the thicknesses of the various snow layers.<a name='1606'></font>
<font color=#447700>!   DZSNOSO holds the thicknesses of the various soil/snow layers.<a name='1607'></font>
    INTEGER                           :: I,J,IZ<a name='1608'>
    REAL,   DIMENSION(-NSNOW+1:    0) :: DZSNO<a name='1609'>
    REAL,   DIMENSION(-NSNOW+1:NSOIL) :: DZSNSO<a name='1610'>
<a name='1611'>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='1612'></font>
<a name='1613'>
    DO J = jts , jtf<a name='1614'>
       DO I = its , itf<a name='1615'>
          IF ( SNODEP(I,J) &lt; 0.025 ) THEN<a name='1616'>
             ISNOWXY(I,J) = 0<a name='1617'>
             DZSNO(-NSNOW+1:0) = 0.<a name='1618'>
          ELSE<a name='1619'>
             IF ( ( SNODEP(I,J) &gt;= 0.025 ) .AND. ( SNODEP(I,J) &lt;= 0.05 ) ) THEN<a name='1620'>
                ISNOWXY(I,J)    = -1<a name='1621'>
                DZSNO(0)  = SNODEP(I,J)<a name='1622'>
             ELSE IF ( ( SNODEP(I,J) &gt; 0.05 ) .AND. ( SNODEP(I,J) &lt;= 0.10 ) ) THEN<a name='1623'>
                ISNOWXY(I,J)    = -2<a name='1624'>
                DZSNO(-1) = SNODEP(I,J)/2.<a name='1625'>
                DZSNO( 0) = SNODEP(I,J)/2.<a name='1626'>
             ELSE IF ( (SNODEP(I,J) &gt; 0.10 ) .AND. ( SNODEP(I,J) &lt;= 0.25 ) ) THEN<a name='1627'>
                ISNOWXY(I,J)    = -2<a name='1628'>
                DZSNO(-1) = 0.05<a name='1629'>
                DZSNO( 0) = SNODEP(I,J) - DZSNO(-1)<a name='1630'>
             ELSE IF ( ( SNODEP(I,J) &gt; 0.25 ) .AND. ( SNODEP(I,J) &lt;= 0.45 ) ) THEN<a name='1631'>
                ISNOWXY(I,J)    = -3<a name='1632'>
                DZSNO(-2) = 0.05<a name='1633'>
                DZSNO(-1) = 0.5*(SNODEP(I,J)-DZSNO(-2))<a name='1634'>
                DZSNO( 0) = 0.5*(SNODEP(I,J)-DZSNO(-2))<a name='1635'>
             ELSE IF ( SNODEP(I,J) &gt; 0.45 ) THEN<a name='1636'>
                ISNOWXY(I,J)     = -3<a name='1637'>
                DZSNO(-2) = 0.05<a name='1638'>
                DZSNO(-1) = 0.20<a name='1639'>
                DZSNO( 0) = SNODEP(I,J) - DZSNO(-1) - DZSNO(-2)<a name='1640'>
             ELSE<a name='1641'>
                CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#SNOW_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1184">("Problem with the logic assigning snow layers.")<a name='1642'>
             END IF<a name='1643'>
          END IF<a name='1644'>
<a name='1645'>
          TSNOXY (I,-NSNOW+1:0,J) = 0.<a name='1646'>
          SNICEXY(I,-NSNOW+1:0,J) = 0.<a name='1647'>
          SNLIQXY(I,-NSNOW+1:0,J) = 0.<a name='1648'>
          DO IZ = ISNOWXY(I,J)+1 , 0<a name='1649'>
             TSNOXY(I,IZ,J)  = TGXY(I,J)  <font color=#447700>! [k]<a name='1650'></font>
             SNLIQXY(I,IZ,J) = 0.00<a name='1651'>
             SNICEXY(I,IZ,J) = 1.00 * DZSNO(IZ) * (SWE(I,J)/SNODEP(I,J))  <font color=#447700>! [kg/m3]<a name='1652'></font>
          END DO<a name='1653'>
<a name='1654'>
          <font color=#447700>! Assign local variable DZSNSO, the soil/snow layer thicknesses, for snow layers<a name='1655'></font>
          DO IZ = ISNOWXY(I,J)+1 , 0<a name='1656'>
             DZSNSO(IZ) = -DZSNO(IZ)<a name='1657'>
          END DO<a name='1658'>
<a name='1659'>
          <font color=#447700>! Assign local variable DZSNSO, the soil/snow layer thicknesses, for soil layers<a name='1660'></font>
          DZSNSO(1) = ZSOIL(1)<a name='1661'>
          DO IZ = 2 , NSOIL<a name='1662'>
             DZSNSO(IZ) = (ZSOIL(IZ) - ZSOIL(IZ-1))<a name='1663'>
          END DO<a name='1664'>
<a name='1665'>
          <font color=#447700>! Assign ZSNSOXY, the layer depths, for soil and snow layers<a name='1666'></font>
          ZSNSOXY(I,ISNOWXY(I,J)+1,J) = DZSNSO(ISNOWXY(I,J)+1)<a name='1667'>
          DO IZ = ISNOWXY(I,J)+2 , NSOIL<a name='1668'>
             ZSNSOXY(I,IZ,J) = ZSNSOXY(I,IZ-1,J) + DZSNSO(IZ)<a name='1669'>
          ENDDO<a name='1670'>
<a name='1671'>
       END DO<a name='1672'>
    END DO<a name='1673'>
<a name='1674'>
  END SUBROUTINE SNOW_INIT<a name='1675'>
<font color=#447700>! ==================================================================================================<a name='1676'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1677'></font>
<A NAME='GROUNDWATER_INIT'><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#GROUNDWATER_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1678'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>GROUNDWATER_INIT</font> (   &amp; <A href='../../call_to/GROUNDWATER_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/GROUNDWATER_INIT.html' TARGET='index'>5</A><a name='1679'>
            &amp;            NSOIL , ZSOIL , DZS, ISLTYP, IVGTYP, WTDDT , &amp;<a name='1680'>
            &amp;            FDEPTH, TOPO, RIVERBED, EQWTD, RIVERCOND, PEXP , AREA ,WTD ,  &amp;<a name='1681'>
            &amp;            SMOIS,SH2O, SMOISEQ, SMCWTDXY, DEEPRECHXY, RECHXY ,  &amp;<a name='1682'>
            &amp;            QSLATXY, QRFSXY, QSPRINGSXY,                  &amp;<a name='1683'>
            &amp;            rechclim  ,                                   &amp;<a name='1684'>
            &amp;            ids,ide, jds,jde, kds,kde,                    &amp;<a name='1685'>
            &amp;            ims,ime, jms,jme, kms,kme,                    &amp;<a name='1686'>
            &amp;            its,ite, jts,jte, kts,kte                     )<a name='1687'>
<a name='1688'>
<a name='1689'>
  USE <A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_TABLES'>NOAHMP_TABLES</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#GROUNDWATER_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_TABLES_7">, ONLY : BEXP_TABLE,SMCMAX_TABLE,PSISAT_TABLE,SMCWLT_TABLE,DWSAT_TABLE,DKSAT_TABLE, &amp;<a name='1690'>
                                ISURBAN_TABLE, ISICE_TABLE ,ISWATER_TABLE<a name='1691'>
  USE <A href='../../html_code/phys/module_sf_noahmp_groundwater.F.html#MODULE_SF_NOAHMP_GROUNDWATER'>module_sf_noahmp_groundwater</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#GROUNDWATER_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHMP_GROUNDWATER_1">, ONLY : LATERALFLOW<a name='1692'>
<a name='1693'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1694'></font>
  IMPLICIT NONE<a name='1695'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1696'></font>
<a name='1697'>
    INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;<a name='1698'>
         &amp;                           ims,ime, jms,jme, kms,kme,  &amp;<a name='1699'>
         &amp;                           its,ite, jts,jte, kts,kte<a name='1700'>
    INTEGER, INTENT(IN)                              :: NSOIL<a name='1701'>
    REAL,   INTENT(IN)                               ::     WTDDT<a name='1702'>
    REAL,    INTENT(IN), DIMENSION(1:NSOIL)          :: ZSOIL,DZS<a name='1703'>
    INTEGER, INTENT(IN), DIMENSION(ims:ime, jms:jme) :: ISLTYP, IVGTYP<a name='1704'>
    REAL,    INTENT(IN), DIMENSION(ims:ime, jms:jme) :: FDEPTH, TOPO , AREA<a name='1705'>
    REAL,    INTENT(IN), DIMENSION(ims:ime, jms:jme) :: rechclim <a name='1706'>
    REAL,    INTENT(OUT), DIMENSION(ims:ime, jms:jme) :: RIVERCOND<a name='1707'>
    REAL,    INTENT(INOUT), DIMENSION(ims:ime, jms:jme) :: WTD, RIVERBED, EQWTD, PEXP<a name='1708'>
    REAL,     DIMENSION( ims:ime , 1:nsoil, jms:jme ), &amp;<a name='1709'>
         &amp;    INTENT(INOUT)   ::                          SMOIS, &amp;<a name='1710'>
         &amp;                                                 SH2O, &amp;<a name='1711'>
         &amp;                                                 SMOISEQ<a name='1712'>
    REAL,    INTENT(INOUT), DIMENSION(ims:ime, jms:jme) ::  &amp;<a name='1713'>
                                                           SMCWTDXY, &amp;<a name='1714'>
                                                           DEEPRECHXY, &amp;<a name='1715'>
                                                           RECHXY, &amp;<a name='1716'>
                                                           QSLATXY, &amp;<a name='1717'>
                                                           QRFSXY, &amp;<a name='1718'>
                                                           QSPRINGSXY  <a name='1719'>
<font color=#447700>! local<a name='1720'></font>
    INTEGER  :: I,J,K,ITER,itf,jtf, NITER, NCOUNT<a name='1721'>
    REAL :: BEXP,SMCMAX,PSISAT,SMCWLT,DWSAT,DKSAT<a name='1722'>
    REAL :: FRLIQ,SMCEQDEEP<a name='1723'>
    REAL :: DELTAT,RCOND,TOTWATER<a name='1724'>
    REAL :: AA,BBB,CC,DD,DX,FUNC,DFUNC,DDZ,EXPON,SMC,FLUX<a name='1725'>
    REAL, DIMENSION(1:NSOIL) :: SMCEQ<a name='1726'>
    REAL,      DIMENSION( ims:ime, jms:jme )    :: QLAT, QRF<a name='1727'>
    INTEGER,   DIMENSION( ims:ime, jms:jme )    :: LANDMASK <font color=#447700>!-1 for water (ice or no ice) and glacial areas, 1 for land where the LSM does its soil moisture calculations<a name='1728'></font>
<a name='1729'>
<a name='1730'>
       itf=min0(ite,ide-1)<a name='1731'>
       jtf=min0(jte,jde-1)<a name='1732'>
<a name='1733'>
<a name='1734'>
    WHERE(IVGTYP.NE.ISWATER_TABLE.AND.IVGTYP.NE.ISICE_TABLE)<a name='1735'>
         LANDMASK=1<a name='1736'>
    ELSEWHERE<a name='1737'>
         LANDMASK=-1<a name='1738'>
    ENDWHERE<a name='1739'>
    <a name='1740'>
    PEXP = 1.0<a name='1741'>
<a name='1742'>
    DELTAT=365.*24*3600. <font color=#447700>!1 year<a name='1743'></font>
<a name='1744'>
<font color=#447700>!readjust the raw aggregated water table from hires, so that it is better compatible with topography<a name='1745'></font>
<a name='1746'>
 DO NITER=1,500<a name='1747'>
<a name='1748'>
    NCOUNT=0<a name='1749'>
<a name='1750'>
<font color=#447700>!Calculate lateral flow<a name='1751'></font>
<a name='1752'>
    QLAT = 0.<a name='1753'>
    CALL <A href='../../html_code/phys/module_sf_noahmp_groundwater.F.html#LATERALFLOW'>LATERALFLOW</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#GROUNDWATER_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LATERALFLOW_2">(ISLTYP,EQWTD,QLAT,FDEPTH,TOPO,LANDMASK,DELTAT,AREA       &amp;<a name='1754'>
                        ,ids,ide,jds,jde,kds,kde                      &amp; <a name='1755'>
                        ,ims,ime,jms,jme,kms,kme                      &amp;<a name='1756'>
                        ,its,ite,jts,jte,kts,kte                      )<a name='1757'>
<a name='1758'>
    DO J=jts,jtf<a name='1759'>
       DO I=its,itf<a name='1760'>
          IF(LANDMASK(I,J).GT.0)THEN<a name='1761'>
            IF(QLAT(i,j).GT.1.e-2)THEN<a name='1762'>
                 NCOUNT=NCOUNT+1<a name='1763'>
                 EQWTD(i,j)=min(EQWTD(i,j)+0.25,0.)<a name='1764'>
            ENDIF<a name='1765'>
          ENDIF<a name='1766'>
        ENDDO<a name='1767'>
     ENDDO<a name='1768'>
<a name='1769'>
   IF(NCOUNT.EQ.0)EXIT<a name='1770'>
<a name='1771'>
 ENDDO<a name='1772'>
<a name='1773'>
<font color=#447700>!after adjusting, where qlat &gt; 1cm/year now wtd is at the surface.<a name='1774'></font>
<font color=#447700>!it may still happen that qlat + rech &gt; 0 and eqwtd-rbed &lt;0. There the wtd can<a name='1775'></font>
<font color=#447700>!rise to the surface (poor drainage) but the et will then increase.<a name='1776'></font>
<a name='1777'>
<a name='1778'>
<font color=#447700>!now, calculate rcond:<a name='1779'></font>
<a name='1780'>
    DO J=jts,jtf<a name='1781'>
       DO I=its,itf<a name='1782'>
<a name='1783'>
        DDZ = EQWTD(I,J)- ( RIVERBED(I,J)-TOPO(I,J) )<a name='1784'>
<font color=#447700>!dont allow riverbed above water table<a name='1785'></font>
        IF(DDZ.LT.0.)then<a name='1786'>
               RIVERBED(I,J)=TOPO(I,J)+EQWTD(I,J)<a name='1787'>
               DDZ=0.<a name='1788'>
        ENDIF<a name='1789'>
<a name='1790'>
<a name='1791'>
        TOTWATER = AREA(I,J)*(QLAT(I,J)+RECHCLIM(I,J)*0.001)/DELTAT<a name='1792'>
<a name='1793'>
        IF (TOTWATER.GT.0) THEN<a name='1794'>
              RIVERCOND(I,J) = TOTWATER / MAX(DDZ,0.05)<a name='1795'>
        ELSE<a name='1796'>
              RIVERCOND(I,J)=0.01<a name='1797'>
<font color=#447700>!and make riverbed  equal to eqwtd, otherwise qrf might be too big...<a name='1798'></font>
              RIVERBED(I,J)=TOPO(I,J)+EQWTD(I,J)<a name='1799'>
        ENDIF<a name='1800'>
<a name='1801'>
<a name='1802'>
       ENDDO<a name='1803'>
    ENDDO<a name='1804'>
<a name='1805'>
<font color=#447700>!make riverbed to be height down from the surface instead of above sea level<a name='1806'></font>
<a name='1807'>
    RIVERBED = min( RIVERBED-TOPO, 0.)<a name='1808'>
<a name='1809'>
<font color=#447700>!now inititalize wtd<a name='1810'></font>
<a name='1811'>
    WTD = EQWTD<a name='1812'>
<a name='1813'>
<a name='1814'>
<font color=#447700>!now recompute lateral flow and flow to rivers to initialize deep soil moisture<a name='1815'></font>
<a name='1816'>
    DELTAT = WTDDT * 60. <font color=#447700>!timestep in seconds for this calculation<a name='1817'></font>
<a name='1818'>
<a name='1819'>
<font color=#447700>!recalculate lateral flow<a name='1820'></font>
<a name='1821'>
    QLAT = 0.<a name='1822'>
    CALL <A href='../../html_code/phys/module_sf_noahmp_groundwater.F.html#LATERALFLOW'>LATERALFLOW</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#GROUNDWATER_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LATERALFLOW_3">(ISLTYP,WTD,QLAT,FDEPTH,TOPO,LANDMASK,DELTAT,AREA       &amp;<a name='1823'>
                        ,ids,ide,jds,jde,kds,kde                      &amp; <a name='1824'>
                        ,ims,ime,jms,jme,kms,kme                      &amp;<a name='1825'>
                        ,its,ite,jts,jte,kts,kte                      )<a name='1826'>
                        <a name='1827'>
<font color=#447700>!compute flux from grounwater to rivers in the cell<a name='1828'></font>
<a name='1829'>
    DO J=jts,jtf<a name='1830'>
       DO I=its,itf<a name='1831'>
          IF(LANDMASK(I,J).GT.0)THEN<a name='1832'>
             IF(WTD(I,J) .GT. RIVERBED(I,J) .AND.  EQWTD(I,J) .GT. RIVERBED(I,J)) THEN<a name='1833'>
               RCOND = RIVERCOND(I,J) * EXP(PEXP(I,J)*(WTD(I,J)-EQWTD(I,J)))<a name='1834'>
             ELSE    <a name='1835'>
               RCOND = RIVERCOND(I,J)<a name='1836'>
             ENDIF<a name='1837'>
             QRF(I,J) = RCOND * (WTD(I,J)-RIVERBED(I,J)) * DELTAT/AREA(I,J)<a name='1838'>
<font color=#447700>!for now, dont allow it to go from river to groundwater<a name='1839'></font>
             QRF(I,J) = MAX(QRF(I,J),0.) <a name='1840'>
          ELSE<a name='1841'>
             QRF(I,J) = 0.<a name='1842'>
          ENDIF<a name='1843'>
       ENDDO<a name='1844'>
    ENDDO<a name='1845'>
<a name='1846'>
<font color=#447700>!now compute eq. soil moisture, change soil moisture to be compatible with the water table and compute deep soil moisture<a name='1847'></font>
<a name='1848'>
       DO J = jts,jtf<a name='1849'>
          DO I = its,itf<a name='1850'>
             BEXP   =   BEXP_TABLE(ISLTYP(I,J))<a name='1851'>
             SMCMAX = SMCMAX_TABLE(ISLTYP(I,J))<a name='1852'>
             SMCWLT = SMCWLT_TABLE(ISLTYP(I,J))<a name='1853'>
             IF(IVGTYP(I,J)==ISURBAN_TABLE)THEN<a name='1854'>
                 SMCMAX = 0.45         <a name='1855'>
                 SMCWLT = 0.40         <a name='1856'>
             ENDIF <a name='1857'>
             DWSAT  =   DWSAT_TABLE(ISLTYP(I,J))<a name='1858'>
             DKSAT  =   DKSAT_TABLE(ISLTYP(I,J))<a name='1859'>
             PSISAT = -PSISAT_TABLE(ISLTYP(I,J))<a name='1860'>
           IF ( ( BEXP &gt; 0.0 ) .AND. ( smcmax &gt; 0.0 ) .AND. ( -psisat &gt; 0.0 ) ) THEN<a name='1861'>
             <font color=#447700>!initialize equilibrium soil moisture for water table diagnostic<a name='1862'></font>
                    CALL <A href='../../html_code/phys/module_sf_noahmpdrv.F.html#EQSMOISTURE'>EQSMOISTURE</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#GROUNDWATER_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EQSMOISTURE_1">(NSOIL ,  ZSOIL , SMCMAX , SMCWLT ,DWSAT, DKSAT  ,BEXP  , &amp; <font color=#447700>!in<a name='1863'></font>
                                     SMCEQ                          )  <font color=#447700>!out<a name='1864'></font>
<a name='1865'>
             SMOISEQ (I,1:NSOIL,J) = SMCEQ (1:NSOIL)<a name='1866'>
<a name='1867'>
<a name='1868'>
              <font color=#447700>!make sure that below the water table the layers are saturated and initialize the deep soil moisture<a name='1869'></font>
             IF(WTD(I,J) &lt; ZSOIL(NSOIL)-DZS(NSOIL)) THEN<a name='1870'>
<a name='1871'>
<font color=#447700>!initialize deep soil moisture so that the flux compensates qlat+qrf<a name='1872'></font>
<font color=#447700>!use Newton-Raphson method to find soil moisture<a name='1873'></font>
<a name='1874'>
                         EXPON = 2. * BEXP + 3.<a name='1875'>
                         DDZ = ZSOIL(NSOIL) - WTD(I,J)<a name='1876'>
                         CC = PSISAT/DDZ<a name='1877'>
                         FLUX = (QLAT(I,J)-QRF(I,J))/DELTAT<a name='1878'>
<a name='1879'>
                         SMC = 0.5 * SMCMAX<a name='1880'>
<a name='1881'>
                         DO ITER = 1, 100<a name='1882'>
                           DD = (SMC+SMCMAX)/(2.*SMCMAX)<a name='1883'>
                           AA = -DKSAT * DD  ** EXPON<a name='1884'>
                           BBB = CC * ( (SMCMAX/SMC)**BEXP - 1. ) + 1. <a name='1885'>
                           FUNC =  AA * BBB - FLUX<a name='1886'>
                           DFUNC = -DKSAT * (EXPON/(2.*SMCMAX)) * DD ** (EXPON - 1.) * BBB &amp;<a name='1887'>
                                   + AA * CC * (-BEXP) * SMCMAX ** BEXP * SMC ** (-BEXP-1.)<a name='1888'>
<a name='1889'>
                           DX = FUNC/DFUNC<a name='1890'>
                           SMC = SMC - DX<a name='1891'>
                           IF ( ABS (DX) &lt; 1.E-6)EXIT<a name='1892'>
                         ENDDO<a name='1893'>
<a name='1894'>
                  SMCWTDXY(I,J) = MAX(SMC,1.E-4)<a name='1895'>
<a name='1896'>
             ELSEIF(WTD(I,J) &lt; ZSOIL(NSOIL))THEN<a name='1897'>
                  SMCEQDEEP = SMCMAX * ( PSISAT / ( PSISAT - DZS(NSOIL) ) ) ** (1./BEXP)<a name='1898'>
<font color=#447700>!                  SMCEQDEEP = MAX(SMCEQDEEP,SMCWLT)<a name='1899'></font>
                  SMCEQDEEP = MAX(SMCEQDEEP,1.E-4)<a name='1900'>
                  SMCWTDXY(I,J) = SMCMAX * ( WTD(I,J) -  (ZSOIL(NSOIL)-DZS(NSOIL))) + &amp;<a name='1901'>
                                  SMCEQDEEP * (ZSOIL(NSOIL) - WTD(I,J))<a name='1902'>
<a name='1903'>
             ELSE <font color=#447700>!water table within the resolved layers<a name='1904'></font>
                  SMCWTDXY(I,J) = SMCMAX<a name='1905'>
                  DO K=NSOIL,2,-1<a name='1906'>
                     IF(WTD(I,J) .GE. ZSOIL(K-1))THEN<a name='1907'>
                          FRLIQ = SH2O(I,K,J) / SMOIS(I,K,J)<a name='1908'>
                          SMOIS(I,K,J) = SMCMAX<a name='1909'>
                          SH2O(I,K,J) = SMCMAX * FRLIQ<a name='1910'>
                     ELSE<a name='1911'>
                          IF(SMOIS(I,K,J).LT.SMCEQ(K))THEN<a name='1912'>
                              WTD(I,J) = ZSOIL(K)<a name='1913'>
                          ELSE<a name='1914'>
                              WTD(I,J) = ( SMOIS(I,K,J)*DZS(K) - SMCEQ(K)*ZSOIL(K-1) + SMCMAX*ZSOIL(K) ) / &amp;<a name='1915'>
                                         (SMCMAX - SMCEQ(K))   <a name='1916'>
                          ENDIF<a name='1917'>
                          EXIT<a name='1918'>
                     ENDIF<a name='1919'>
                  ENDDO<a name='1920'>
             ENDIF<a name='1921'>
            ELSE<a name='1922'>
              SMOISEQ (I,1:NSOIL,J) = SMCMAX<a name='1923'>
              SMCWTDXY(I,J) = SMCMAX<a name='1924'>
              WTD(I,J) = 0.<a name='1925'>
            ENDIF<a name='1926'>
<a name='1927'>
<font color=#447700>!zero out some arrays<a name='1928'></font>
<a name='1929'>
             DEEPRECHXY(I,J) = 0.<a name='1930'>
             RECHXY(I,J) = 0.<a name='1931'>
             QSLATXY(I,J) = 0.<a name='1932'>
             QRFSXY(I,J) = 0.<a name='1933'>
             QSPRINGSXY(I,J) = 0.<a name='1934'>
<a name='1935'>
          ENDDO<a name='1936'>
       ENDDO<a name='1937'>
<a name='1938'>
<a name='1939'>
<a name='1940'>
<a name='1941'>
    END  SUBROUTINE GROUNDWATER_INIT<a name='1942'>
<font color=#447700>! ==================================================================================================<a name='1943'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1944'></font>
<A NAME='EQSMOISTURE'><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#EQSMOISTURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1945'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>EQSMOISTURE</font>(NSOIL  ,  ZSOIL , SMCMAX , SMCWLT, DWSAT , DKSAT ,BEXP , &amp; <font color=#447700>!in <A href='../../call_to/EQSMOISTURE.html' TARGET='index'>1</A><a name='1946'></font>
                         SMCEQ                          )  <font color=#447700>!out<a name='1947'></font>
<font color=#447700>! ----------------------------------------------------------------------<a name='1948'></font>
  IMPLICIT NONE<a name='1949'>
<font color=#447700>! ----------------------------------------------------------------------<a name='1950'></font>
<font color=#447700>! input<a name='1951'></font>
  INTEGER,                         INTENT(IN) :: NSOIL <font color=#447700>!no. of soil layers<a name='1952'></font>
  REAL, DIMENSION(       1:NSOIL), INTENT(IN) :: ZSOIL <font color=#447700>!depth of soil layer-bottom [m]<a name='1953'></font>
  REAL,                            INTENT(IN) :: SMCMAX , SMCWLT, BEXP , DWSAT, DKSAT<a name='1954'>
<font color=#447700>!output<a name='1955'></font>
  REAL,  DIMENSION(      1:NSOIL), INTENT(OUT) :: SMCEQ  <font color=#447700>!equilibrium soil water  content [m3/m3]<a name='1956'></font>
<font color=#447700>!local<a name='1957'></font>
  INTEGER                                     :: K , ITER<a name='1958'>
  REAL                                        :: DDZ , SMC, FUNC, DFUNC , AA, BB , EXPON, DX<a name='1959'>
<a name='1960'>
<font color=#447700>!gmmcompute equilibrium soil moisture content for the layer when wtd=zsoil(k)<a name='1961'></font>
<a name='1962'>
<a name='1963'>
   DO K=1,NSOIL<a name='1964'>
<a name='1965'>
            IF ( K == 1 )THEN<a name='1966'>
                DDZ = -ZSOIL(K+1) * 0.5<a name='1967'>
            ELSEIF ( K &lt; NSOIL ) THEN<a name='1968'>
                DDZ = ( ZSOIL(K-1) - ZSOIL(K+1) ) * 0.5<a name='1969'>
            ELSE<a name='1970'>
                DDZ = ZSOIL(K-1) - ZSOIL(K)<a name='1971'>
            ENDIF<a name='1972'>
<a name='1973'>
<font color=#447700>!use Newton-Raphson method to find eq soil moisture<a name='1974'></font>
<a name='1975'>
            EXPON = BEXP +1.<a name='1976'>
            AA = DWSAT/DDZ<a name='1977'>
            BB = DKSAT / SMCMAX ** EXPON<a name='1978'>
<a name='1979'>
            SMC = 0.5 * SMCMAX<a name='1980'>
<a name='1981'>
         DO ITER = 1, 100<a name='1982'>
            FUNC = (SMC - SMCMAX) * AA +  BB * SMC ** EXPON<a name='1983'>
            DFUNC = AA + BB * EXPON * SMC ** BEXP <a name='1984'>
<a name='1985'>
            DX = FUNC/DFUNC<a name='1986'>
            SMC = SMC - DX<a name='1987'>
            IF ( ABS (DX) &lt; 1.E-6)EXIT<a name='1988'>
         ENDDO<a name='1989'>
<a name='1990'>
<font color=#447700>!             SMCEQ(K) = MIN(MAX(SMC,SMCWLT),SMCMAX*0.99)<a name='1991'></font>
             SMCEQ(K) = MIN(MAX(SMC,1.E-4),SMCMAX*0.99)<a name='1992'>
   ENDDO<a name='1993'>
<a name='1994'>
END  SUBROUTINE EQSMOISTURE<a name='1995'>
<font color=#447700>!<a name='1996'></font>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='1997'></font>
<A NAME='NOAHMP_URBAN'><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1998'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>noahmp_urban</font>(sf_urban_physics,   NSOIL,         IVGTYP,  ITIMESTEP,            &amp; <font color=#447700>! IN : Model configuration  <A href='../../call_to/NOAHMP_URBAN.html' TARGET='index'>1</A>,<A href='../../call_from/NOAHMP_URBAN.html' TARGET='index'>10</A><a name='1999'></font>
                                 DT,     COSZ_URB2D,     XLAT_URB2D,                        &amp; <font color=#447700>! IN : Time/Space-related<a name='2000'></font>
                                T3D,           QV3D,          U_PHY,      V_PHY,   SWDOWN,  &amp; <font color=#447700>! IN : Forcing<a name='2001'></font>
		                GLW,          P8W3D,         RAINBL,       DZ8W,      ZNT,  &amp; <font color=#447700>! IN : Forcing<a name='2002'></font>
                                TSK,            HFX,            QFX,         LH,   GRDFLX,  &amp; <font color=#447700>! IN/OUT : LSM <a name='2003'></font>
		             ALBEDO,          EMISS,           QSFC,                        &amp; <font color=#447700>! IN/OUT : LSM <a name='2004'></font>
                            ids,ide,        jds,jde,        kds,kde,                        &amp;<a name='2005'>
                            ims,ime,        jms,jme,        kms,kme,                        &amp;<a name='2006'>
                            its,ite,        jts,jte,        kts,kte,                        &amp;<a name='2007'>
                         cmr_sfcdif,     chr_sfcdif,     cmc_sfcdif,                        &amp;<a name='2008'>
	                 chc_sfcdif,    cmgr_sfcdif,    chgr_sfcdif,                        &amp;<a name='2009'>
                           tr_urb2d,       tb_urb2d,       tg_urb2d,                        &amp; <font color=#447700>!H urban<a name='2010'></font>
	                   tc_urb2d,       qc_urb2d,       uc_urb2d,                        &amp; <font color=#447700>!H urban<a name='2011'></font>
                         xxxr_urb2d,     xxxb_urb2d,     xxxg_urb2d, xxxc_urb2d,            &amp; <font color=#447700>!H urban<a name='2012'></font>
                          trl_urb3d,      tbl_urb3d,      tgl_urb3d,                        &amp; <font color=#447700>!H urban<a name='2013'></font>
                           sh_urb2d,       lh_urb2d,        g_urb2d,   rn_urb2d,  ts_urb2d, &amp; <font color=#447700>!H urban<a name='2014'></font>
                         psim_urb2d,     psih_urb2d,      u10_urb2d,  v10_urb2d,            &amp; <font color=#447700>!O urban<a name='2015'></font>
                       GZ1OZ0_urb2d,     AKMS_URB2D,                                        &amp; <font color=#447700>!O urban<a name='2016'></font>
                          th2_urb2d,       q2_urb2d,      ust_urb2d,                        &amp; <font color=#447700>!O urban<a name='2017'></font>
                         declin_urb,      omg_urb2d,                                        &amp; <font color=#447700>!I urban<a name='2018'></font>
                    num_roof_layers,num_wall_layers,num_road_layers,                        &amp; <font color=#447700>!I urban<a name='2019'></font>
                                dzr,            dzb,            dzg,                        &amp; <font color=#447700>!I urban<a name='2020'></font>
                         cmcr_urb2d,      tgr_urb2d,     tgrl_urb3d,  smr_urb3d,            &amp; <font color=#447700>!H urban<a name='2021'></font>
                        drelr_urb2d,    drelb_urb2d,    drelg_urb2d,                        &amp; <font color=#447700>!H urban<a name='2022'></font>
                      flxhumr_urb2d,  flxhumb_urb2d,  flxhumg_urb2d,                        &amp; <font color=#447700>!H urban<a name='2023'></font>
                             julian,          julyr,                                        &amp; <font color=#447700>!H urban<a name='2024'></font>
                          frc_urb2d,    utype_urb2d,                                        &amp; <font color=#447700>!I urban<a name='2025'></font>
                                chs,           chs2,           cqs2,                        &amp; <font color=#447700>!H<a name='2026'></font>
                   num_urban_layers,                                                        &amp; <font color=#447700>!I multi-layer urban<a name='2027'></font>
                       num_urban_hi,                                                        &amp; <font color=#447700>!I multi-layer urban<a name='2028'></font>
                          trb_urb4d,      tw1_urb4d,      tw2_urb4d,  tgb_urb4d,            &amp; <font color=#447700>!H multi-layer urban<a name='2029'></font>
                         tlev_urb3d,     qlev_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='2030'></font>
                       tw1lev_urb3d,   tw2lev_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='2031'></font>
                        tglev_urb3d,    tflev_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='2032'></font>
                        sf_ac_urb3d,    lf_ac_urb3d,    cm_ac_urb3d,                        &amp; <font color=#447700>!H multi-layer urban<a name='2033'></font>
                       sfvent_urb3d,   lfvent_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='2034'></font>
                       sfwin1_urb3d,   sfwin2_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='2035'></font>
                         sfw1_urb3d,     sfw2_urb3d,      sfr_urb3d,  sfg_urb3d,            &amp; <font color=#447700>!H multi-layer urban<a name='2036'></font>
                           lp_urb2d,       hi_urb2d,       lb_urb2d,  hgt_urb2d,            &amp; <font color=#447700>!H multi-layer urban<a name='2037'></font>
                           mh_urb2d,     stdh_urb2d,       lf_urb2d,                        &amp; <font color=#447700>!SLUCM<a name='2038'></font>
                             th_phy,            rho,          p_phy,        ust,            &amp; <font color=#447700>!I multi-layer urban<a name='2039'></font>
                                gmt,         julday,          xlong,       xlat,            &amp; <font color=#447700>!I multi-layer urban<a name='2040'></font>
                            a_u_bep,        a_v_bep,        a_t_bep,    a_q_bep,            &amp; <font color=#447700>!O multi-layer urban<a name='2041'></font>
                            a_e_bep,        b_u_bep,        b_v_bep,                        &amp; <font color=#447700>!O multi-layer urban<a name='2042'></font>
                            b_t_bep,        b_q_bep,        b_e_bep,    dlg_bep,            &amp; <font color=#447700>!O multi-layer urban<a name='2043'></font>
                           dl_u_bep,         sf_bep,         vl_bep                         &amp; <font color=#447700>!O multi-layer urban<a name='2044'></font>
                 )<a name='2045'>
<a name='2046'>
  USE <A href='../../html_code/phys/module_sf_urban.F.html#MODULE_SF_URBAN'>module_sf_urban</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_URBAN_7">,    only: urban<a name='2047'>
  USE <A href='../../html_code/phys/module_sf_bep.F.html#MODULE_SF_BEP'>module_sf_bep</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_BEP_3">,      only: bep<a name='2048'>
  USE <A href='../../html_code/phys/module_sf_bep_bem.F.html#MODULE_SF_BEP_BEM'>module_sf_bep_bem</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_BEP_BEM_3">,  only: bep_bem<a name='2049'>
  USE <A href='../../html_code/phys/module_ra_gfdleta.F.html#MODULE_RA_GFDLETA'>module_ra_gfdleta</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_RA_GFDLETA_8">,  only: cal_mon_day<a name='2050'>
  USE <A href='../../html_code/phys/module_sf_noahmplsm.F.html#NOAHMP_TABLES'>NOAHMP_TABLES</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_TABLES_8">, ONLY: ISURBAN_TABLE<a name='2051'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_98">, only: KARMAN, CP, XLV<a name='2052'>
<font color=#447700>!----------------------------------------------------------------<a name='2053'></font>
    IMPLICIT NONE<a name='2054'>
<font color=#447700>!----------------------------------------------------------------<a name='2055'></font>
<a name='2056'>
    INTEGER,                                         INTENT(IN   ) ::  sf_urban_physics   <font color=#447700>! urban physics option<a name='2057'></font>
    INTEGER,                                         INTENT(IN   ) ::  NSOIL     <font color=#447700>! number of soil layers<a name='2058'></font>
    INTEGER, DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  IVGTYP    <font color=#447700>! vegetation type<a name='2059'></font>
    INTEGER,                                         INTENT(IN   ) ::  ITIMESTEP <font color=#447700>! timestep number<a name='2060'></font>
    REAL,                                            INTENT(IN   ) ::  DT        <font color=#447700>! timestep [s]<a name='2061'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  COSZ_URB2D<a name='2062'>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  XLAT_URB2D<a name='2063'>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  T3D       <font color=#447700>! 3D atmospheric temperature valid at mid-levels [K]<a name='2064'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  QV3D      <font color=#447700>! 3D water vapor mixing ratio [kg/kg_dry]<a name='2065'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  U_PHY     <font color=#447700>! 3D U wind component [m/s]<a name='2066'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  V_PHY     <font color=#447700>! 3D V wind component [m/s]<a name='2067'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  SWDOWN    <font color=#447700>! solar down at surface [W m-2]<a name='2068'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  GLW       <font color=#447700>! longwave down at surface [W m-2]<a name='2069'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  P8W3D     <font color=#447700>! 3D pressure, valid at interface [Pa]<a name='2070'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(IN   ) ::  RAINBL    <font color=#447700>! total input precipitation [mm]<a name='2071'></font>
    REAL,    DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) ::  DZ8W      <font color=#447700>! thickness of atmo layers [m]<a name='2072'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ZNT       <font color=#447700>! combined z0 sent to coupled model<a name='2073'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  TSK       <font color=#447700>! surface radiative temperature [K]<a name='2074'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  HFX       <font color=#447700>! sensible heat flux [W m-2]<a name='2075'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  QFX       <font color=#447700>! latent heat flux [kg s-1 m-2]<a name='2076'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  LH        <font color=#447700>! latent heat flux [W m-2]<a name='2077'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  GRDFLX    <font color=#447700>! ground/snow heat flux [W m-2]<a name='2078'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  ALBEDO    <font color=#447700>! total grid albedo []<a name='2079'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  EMISS     <font color=#447700>! surface bulk emissivity<a name='2080'></font>
    REAL,    DIMENSION( ims:ime,          jms:jme ), INTENT(INOUT) ::  QSFC      <font color=#447700>! bulk surface mixing ratio<a name='2081'></font>
<a name='2082'>
    INTEGER,  INTENT(IN   )   ::     ids,ide, jds,jde, kds,kde,  &amp;  <font color=#447700>! d -&gt; domain<a name='2083'></font>
         &amp;                           ims,ime, jms,jme, kms,kme,  &amp;  <font color=#447700>! m -&gt; memory<a name='2084'></font>
         &amp;                           its,ite, jts,jte, kts,kte      <font color=#447700>! t -&gt; tile<a name='2085'></font>
<a name='2086'>
<font color=#447700>! input variables surface_driver --&gt; lsm<a name='2087'></font>
<a name='2088'>
     INTEGER,                                                INTENT(IN   ) :: num_roof_layers<a name='2089'>
     INTEGER,                                                INTENT(IN   ) :: num_wall_layers<a name='2090'>
     INTEGER,                                                INTENT(IN   ) :: num_road_layers<a name='2091'>
<a name='2092'>
     INTEGER,        DIMENSION( ims:ime, jms:jme ),          INTENT(IN   ) :: UTYPE_URB2D<a name='2093'>
     REAL,           DIMENSION( ims:ime, jms:jme ),          INTENT(IN   ) :: FRC_URB2D<a name='2094'>
<a name='2095'>
     REAL, OPTIONAL, DIMENSION(1:num_roof_layers),           INTENT(IN   ) :: DZR<a name='2096'>
     REAL, OPTIONAL, DIMENSION(1:num_wall_layers),           INTENT(IN   ) :: DZB<a name='2097'>
     REAL, OPTIONAL, DIMENSION(1:num_road_layers),           INTENT(IN   ) :: DZG<a name='2098'>
     REAL, OPTIONAL,                                         INTENT(IN   ) :: DECLIN_URB<a name='2099'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),          INTENT(IN   ) :: OMG_URB2D<a name='2100'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) :: TH_PHY<a name='2101'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) :: P_PHY<a name='2102'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN   ) :: RHO<a name='2103'>
<a name='2104'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),          INTENT(INOUT) :: UST<a name='2105'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),          INTENT(INOUT) :: CHS, CHS2, CQS2<a name='2106'>
<a name='2107'>
     INTEGER,  INTENT(IN   )   ::  julian, julyr                  <font color=#447700>!urban<a name='2108'></font>
<a name='2109'>
<font color=#447700>! local variables lsm --&gt; urban<a name='2110'></font>
<a name='2111'>
     INTEGER :: UTYPE_URB <font color=#447700>! urban type [urban=1, suburban=2, rural=3]<a name='2112'></font>
     REAL    :: TA_URB       <font color=#447700>! potential temp at 1st atmospheric level [K]<a name='2113'></font>
     REAL    :: QA_URB       <font color=#447700>! mixing ratio at 1st atmospheric level  [kg/kg]<a name='2114'></font>
     REAL    :: UA_URB       <font color=#447700>! wind speed at 1st atmospheric level    [m/s]<a name='2115'></font>
     REAL    :: U1_URB       <font color=#447700>! u at 1st atmospheric level             [m/s]<a name='2116'></font>
     REAL    :: V1_URB       <font color=#447700>! v at 1st atmospheric level             [m/s]<a name='2117'></font>
     REAL    :: SSG_URB      <font color=#447700>! downward total short wave radiation    [W/m/m]<a name='2118'></font>
     REAL    :: LLG_URB      <font color=#447700>! downward long wave radiation           [W/m/m]<a name='2119'></font>
     REAL    :: RAIN_URB     <font color=#447700>! precipitation                          [mm/h]<a name='2120'></font>
     REAL    :: RHOO_URB     <font color=#447700>! air density                            [kg/m^3]<a name='2121'></font>
     REAL    :: ZA_URB       <font color=#447700>! first atmospheric level                [m]<a name='2122'></font>
     REAL    :: DELT_URB     <font color=#447700>! time step                              [s]<a name='2123'></font>
     REAL    :: SSGD_URB     <font color=#447700>! downward direct short wave radiation   [W/m/m]<a name='2124'></font>
     REAL    :: SSGQ_URB     <font color=#447700>! downward diffuse short wave radiation  [W/m/m]<a name='2125'></font>
     REAL    :: XLAT_URB     <font color=#447700>! latitude                               [deg]<a name='2126'></font>
     REAL    :: COSZ_URB     <font color=#447700>! cosz<a name='2127'></font>
     REAL    :: OMG_URB      <font color=#447700>! hour angle<a name='2128'></font>
     REAL    :: ZNT_URB      <font color=#447700>! roughness length                       [m]<a name='2129'></font>
     REAL    :: TR_URB<a name='2130'>
     REAL    :: TB_URB<a name='2131'>
     REAL    :: TG_URB<a name='2132'>
     REAL    :: TC_URB<a name='2133'>
     REAL    :: QC_URB<a name='2134'>
     REAL    :: UC_URB<a name='2135'>
     REAL    :: XXXR_URB<a name='2136'>
     REAL    :: XXXB_URB<a name='2137'>
     REAL    :: XXXG_URB<a name='2138'>
     REAL    :: XXXC_URB<a name='2139'>
     REAL, DIMENSION(1:num_roof_layers) :: TRL_URB  <font color=#447700>! roof layer temp [K]<a name='2140'></font>
     REAL, DIMENSION(1:num_wall_layers) :: TBL_URB  <font color=#447700>! wall layer temp [K]<a name='2141'></font>
     REAL, DIMENSION(1:num_road_layers) :: TGL_URB  <font color=#447700>! road layer temp [K]<a name='2142'></font>
     LOGICAL  :: LSOLAR_URB<a name='2143'>
<a name='2144'>
<font color=#447700>!===hydrological variable for single layer UCM===<a name='2145'></font>
<a name='2146'>
     INTEGER :: jmonth, jday<a name='2147'>
     REAL    :: DRELR_URB<a name='2148'>
     REAL    :: DRELB_URB<a name='2149'>
     REAL    :: DRELG_URB<a name='2150'>
     REAL    :: FLXHUMR_URB<a name='2151'>
     REAL    :: FLXHUMB_URB<a name='2152'>
     REAL    :: FLXHUMG_URB<a name='2153'>
     REAL    :: CMCR_URB<a name='2154'>
     REAL    :: TGR_URB<a name='2155'>
<a name='2156'>
     REAL, DIMENSION(1:num_roof_layers) :: SMR_URB  <font color=#447700>! green roof layer moisture<a name='2157'></font>
     REAL, DIMENSION(1:num_roof_layers) :: TGRL_URB <font color=#447700>! green roof layer temp [K]<a name='2158'></font>
<a name='2159'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                    INTENT(INOUT) :: DRELR_URB2D<a name='2160'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                    INTENT(INOUT) :: DRELB_URB2D<a name='2161'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                    INTENT(INOUT) :: DRELG_URB2D<a name='2162'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                    INTENT(INOUT) :: FLXHUMR_URB2D<a name='2163'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                    INTENT(INOUT) :: FLXHUMB_URB2D<a name='2164'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                    INTENT(INOUT) :: FLXHUMG_URB2D<a name='2165'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                    INTENT(INOUT) :: CMCR_URB2D<a name='2166'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                    INTENT(INOUT) :: TGR_URB2D<a name='2167'>
<a name='2168'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: TGRL_URB3D<a name='2169'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: SMR_URB3D<a name='2170'>
<a name='2171'>
<a name='2172'>
<font color=#447700>! state variable surface_driver &lt;--&gt; lsm &lt;--&gt; urban<a name='2173'></font>
<a name='2174'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TR_URB2D<a name='2175'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TB_URB2D<a name='2176'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TG_URB2D<a name='2177'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TC_URB2D<a name='2178'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: QC_URB2D<a name='2179'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: UC_URB2D<a name='2180'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXR_URB2D<a name='2181'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXB_URB2D<a name='2182'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXG_URB2D<a name='2183'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: XXXC_URB2D<a name='2184'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: SH_URB2D<a name='2185'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: LH_URB2D<a name='2186'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: G_URB2D<a name='2187'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: RN_URB2D<a name='2188'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TS_URB2D<a name='2189'>
<a name='2190'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_roof_layers, jms:jme ), INTENT(INOUT) :: TRL_URB3D<a name='2191'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_wall_layers, jms:jme ), INTENT(INOUT) :: TBL_URB3D<a name='2192'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_road_layers, jms:jme ), INTENT(INOUT) :: TGL_URB3D<a name='2193'>
<a name='2194'>
<font color=#447700>! output variable lsm --&gt; surface_driver<a name='2195'></font>
<a name='2196'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: PSIM_URB2D<a name='2197'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: PSIH_URB2D<a name='2198'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: GZ1OZ0_URB2D<a name='2199'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: U10_URB2D<a name='2200'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: V10_URB2D<a name='2201'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: TH2_URB2D<a name='2202'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: Q2_URB2D<a name='2203'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: AKMS_URB2D<a name='2204'>
     REAL,           DIMENSION( ims:ime, jms:jme ), INTENT(OUT) :: UST_URB2D<a name='2205'>
<a name='2206'>
<a name='2207'>
<font color=#447700>! output variables urban --&gt; lsm<a name='2208'></font>
<a name='2209'>
     REAL :: TS_URB           <font color=#447700>! surface radiative temperature    [K]<a name='2210'></font>
     REAL :: QS_URB           <font color=#447700>! surface humidity                 [-]<a name='2211'></font>
     REAL :: SH_URB           <font color=#447700>! sensible heat flux               [W/m/m]<a name='2212'></font>
     REAL :: LH_URB           <font color=#447700>! latent heat flux                 [W/m/m]<a name='2213'></font>
     REAL :: LH_KINEMATIC_URB <font color=#447700>! latent heat flux, kinetic  [kg/m/m/s]<a name='2214'></font>
     REAL :: SW_URB           <font color=#447700>! upward short wave radiation flux [W/m/m]<a name='2215'></font>
     REAL :: ALB_URB          <font color=#447700>! time-varying albedo            [fraction]<a name='2216'></font>
     REAL :: LW_URB           <font color=#447700>! upward long wave radiation flux  [W/m/m]<a name='2217'></font>
     REAL :: G_URB            <font color=#447700>! heat flux into the ground        [W/m/m]<a name='2218'></font>
     REAL :: RN_URB           <font color=#447700>! net radiation                    [W/m/m]<a name='2219'></font>
     REAL :: PSIM_URB         <font color=#447700>! shear f for momentum             [-]<a name='2220'></font>
     REAL :: PSIH_URB         <font color=#447700>! shear f for heat                 [-]<a name='2221'></font>
     REAL :: GZ1OZ0_URB       <font color=#447700>! shear f for heat                 [-]<a name='2222'></font>
     REAL :: U10_URB          <font color=#447700>! wind u component at 10 m         [m/s]<a name='2223'></font>
     REAL :: V10_URB          <font color=#447700>! wind v component at 10 m         [m/s]<a name='2224'></font>
     REAL :: TH2_URB          <font color=#447700>! potential temperature at 2 m     [K]<a name='2225'></font>
     REAL :: Q2_URB           <font color=#447700>! humidity at 2 m                  [-]<a name='2226'></font>
     REAL :: CHS_URB<a name='2227'>
     REAL :: CHS2_URB<a name='2228'>
     REAL :: UST_URB<a name='2229'>
<a name='2230'>
<font color=#447700>! NUDAPT Parameters urban --&gt; lam<a name='2231'></font>
<a name='2232'>
     REAL :: mh_urb<a name='2233'>
     REAL :: stdh_urb<a name='2234'>
     REAL :: lp_urb<a name='2235'>
     REAL :: hgt_urb<a name='2236'>
     REAL, DIMENSION(4) :: lf_urb<a name='2237'>
<a name='2238'>
<font color=#447700>! Local variables<a name='2239'></font>
<a name='2240'>
     INTEGER :: I,J,K<a name='2241'>
     REAL :: Q1<a name='2242'>
<a name='2243'>
<font color=#447700>! Noah UA changes<a name='2244'></font>
<a name='2245'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: CMR_SFCDIF<a name='2246'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: CHR_SFCDIF<a name='2247'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: CMGR_SFCDIF<a name='2248'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: CHGR_SFCDIF<a name='2249'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: CMC_SFCDIF<a name='2250'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: CHC_SFCDIF<a name='2251'>
<a name='2252'>
<font color=#447700>! Variables for multi-layer UCM<a name='2253'></font>
<a name='2254'>
     REAL, OPTIONAL,                                                    INTENT(IN   ) :: GMT<a name='2255'>
     INTEGER, OPTIONAL,                                                 INTENT(IN   ) :: JULDAY<a name='2256'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(IN   ) :: XLAT, XLONG<a name='2257'>
     INTEGER,                                                           INTENT(IN   ) :: NUM_URBAN_LAYERS<a name='2258'>
     INTEGER,                                                           INTENT(IN   ) :: NUM_URBAN_HI<a name='2259'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_hi, jms:jme ),     INTENT(IN   ) :: hi_urb2d<a name='2260'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(IN   ) :: lp_urb2d<a name='2261'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(IN   ) :: lb_urb2d<a name='2262'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(IN   ) :: hgt_urb2d<a name='2263'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(IN   ) :: mh_urb2d<a name='2264'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(IN   ) :: stdh_urb2d<a name='2265'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 4, jms:jme ),                  INTENT(IN   ) :: lf_urb2d<a name='2266'>
<a name='2267'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: trb_urb4d<a name='2268'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1_urb4d<a name='2269'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2_urb4d<a name='2270'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tgb_urb4d<a name='2271'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tlev_urb3d<a name='2272'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: qlev_urb3d<a name='2273'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1lev_urb3d<a name='2274'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2lev_urb3d<a name='2275'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tglev_urb3d<a name='2276'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tflev_urb3d<a name='2277'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: lf_ac_urb3d<a name='2278'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: sf_ac_urb3d<a name='2279'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: cm_ac_urb3d<a name='2280'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: sfvent_urb3d<a name='2281'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ),                     INTENT(INOUT) :: lfvent_urb3d<a name='2282'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin1_urb3d<a name='2283'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin2_urb3d<a name='2284'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw1_urb3d<a name='2285'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw2_urb3d<a name='2286'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfr_urb3d<a name='2287'>
     REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfg_urb3d<a name='2288'>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: a_u_bep   <font color=#447700>!Implicit momemtum component X-direction<a name='2289'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: a_v_bep   <font color=#447700>!Implicit momemtum component Y-direction<a name='2290'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: a_t_bep   <font color=#447700>!Implicit component pot. temperature<a name='2291'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: a_q_bep   <font color=#447700>!Implicit momemtum component X-direction<a name='2292'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: a_e_bep   <font color=#447700>!Implicit component TKE<a name='2293'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: b_u_bep   <font color=#447700>!Explicit momentum component X-direction<a name='2294'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: b_v_bep   <font color=#447700>!Explicit momentum component Y-direction<a name='2295'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: b_t_bep   <font color=#447700>!Explicit component pot. temperature<a name='2296'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: b_q_bep   <font color=#447700>!Implicit momemtum component Y-direction<a name='2297'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: b_e_bep   <font color=#447700>!Explicit component TKE<a name='2298'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: vl_bep    <font color=#447700>!Fraction air volume in grid cell<a name='2299'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: dlg_bep   <font color=#447700>!Height above ground<a name='2300'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: sf_bep    <font color=#447700>!Fraction air at the face of grid cell<a name='2301'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ),            INTENT(INOUT) :: dl_u_bep  <font color=#447700>!Length scale<a name='2302'></font>
<a name='2303'>
<font color=#447700>! Local variables for multi-layer UCM<a name='2304'></font>
<a name='2305'>
     REAL,    DIMENSION( its:ite, jts:jte) :: HFX_RURAL,GRDFLX_RURAL          <font color=#447700>! ,LH_RURAL,RN_RURAL<a name='2306'></font>
     REAL,    DIMENSION( its:ite, jts:jte) :: QFX_RURAL                       <font color=#447700>! ,QSFC_RURAL,UMOM_RURAL,VMOM_RURAL<a name='2307'></font>
     REAL,    DIMENSION( its:ite, jts:jte) :: ALB_RURAL,EMISS_RURAL,TSK_RURAL <font color=#447700>! ,UST_RURAL<a name='2308'></font>
     REAL,    DIMENSION( its:ite, jts:jte) :: HFX_URB,UMOM_URB,VMOM_URB<a name='2309'>
     REAL,    DIMENSION( its:ite, jts:jte) :: QFX_URB<a name='2310'>
     REAL,    DIMENSION( its:ite, jts:jte) :: EMISS_URB<a name='2311'>
     REAL,    DIMENSION( its:ite, jts:jte) :: RL_UP_URB<a name='2312'>
     REAL,    DIMENSION( its:ite, jts:jte) :: RS_ABS_URB<a name='2313'>
     REAL,    DIMENSION( its:ite, jts:jte) :: GRDFLX_URB<a name='2314'>
<a name='2315'>
     REAL :: SIGMA_SB,RL_UP_RURAL,RL_UP_TOT,RS_ABS_TOT,UMOM,VMOM<a name='2316'>
     REAL :: r1,r2,r3<a name='2317'>
     REAL :: CMR_URB, CHR_URB, CMC_URB, CHC_URB, CMGR_URB, CHGR_URB<a name='2318'>
     REAL :: frc_urb,lb_urb<a name='2319'>
     REAL :: check<a name='2320'>
<a name='2321'>
    character(len=80) :: message<a name='2322'>
<a name='2323'>
    DO J=JTS,JTE<a name='2324'>
    DO I=ITS,ITE<a name='2325'>
      HFX_RURAL(I,J)                = HFX(I,J)<a name='2326'>
      QFX_RURAL(I,J)                = QFX(I,J)<a name='2327'>
      GRDFLX_RURAL(I,J)             = GRDFLX(I,J)<a name='2328'>
      EMISS_RURAL(I,J)              = EMISS(I,J)<a name='2329'>
      TSK_RURAL(I,J)                = TSK(I,J)<a name='2330'>
      ALB_RURAL(I,J)                = ALBEDO(I,J)<a name='2331'>
    END DO<a name='2332'>
    END DO<a name='2333'>
<a name='2334'>
IF (SF_URBAN_PHYSICS == 1 ) THEN         <font color=#447700>! Beginning of UCM CALL if block<a name='2335'></font>
<a name='2336'>
<font color=#447700>!--------------------------------------<a name='2337'></font>
<font color=#447700>! URBAN CANOPY MODEL START<a name='2338'></font>
<font color=#447700>!--------------------------------------<a name='2339'></font>
<a name='2340'>
JLOOP : DO J = jts, jte<a name='2341'>
<a name='2342'>
ILOOP : DO I = its, ite<a name='2343'>
<a name='2344'>
<a name='2345'>
  IF( IVGTYP(I,J) == ISURBAN_TABLE .or. IVGTYP(I,J) == 31 .or. &amp;<a name='2346'>
      IVGTYP(I,J) == 32 .or. IVGTYP(I,J) == 33 ) THEN<a name='2347'>
<a name='2348'>
    UTYPE_URB = UTYPE_URB2D(I,J) <font color=#447700>!urban type (low, high or industrial)<a name='2349'></font>
<a name='2350'>
    TA_URB    = T3D(I,1,J)                                <font color=#447700>! [K]            <a name='2351'></font>
    QA_URB    = QV3D(I,1,J)/(1.0+QV3D(I,1,J))             <font color=#447700>! [kg/kg]       <a name='2352'></font>
    UA_URB    = SQRT(U_PHY(I,1,J)**2.+V_PHY(I,1,J)**2.)<a name='2353'>
    U1_URB    = U_PHY(I,1,J)<a name='2354'>
    V1_URB    = V_PHY(I,1,J)<a name='2355'>
    IF(UA_URB &lt; 1.) UA_URB=1.                             <font color=#447700>! [m/s]<a name='2356'></font>
    SSG_URB   = SWDOWN(I,J)                               <font color=#447700>! [W/m/m]      <a name='2357'></font>
    SSGD_URB  = 0.8*SWDOWN(I,J)                           <font color=#447700>! [W/m/m]     <a name='2358'></font>
    SSGQ_URB  = SSG_URB-SSGD_URB                          <font color=#447700>! [W/m/m]<a name='2359'></font>
    LLG_URB   = GLW(I,J)                                  <font color=#447700>! [W/m/m]<a name='2360'></font>
    RAIN_URB  = RAINBL(I,J)                               <font color=#447700>! [mm]       <a name='2361'></font>
    RHOO_URB  = (P8W3D(I,KTS+1,J)+P8W3D(I,KTS,J))*0.5 / (287.04 * TA_URB * (1.0+ 0.61 * QA_URB)) <font color=#447700>![kg/m/m/m] <a name='2362'></font>
    ZA_URB    = 0.5*DZ8W(I,1,J)                           <font color=#447700>! [m]         <a name='2363'></font>
    DELT_URB  = DT                                        <font color=#447700>! [sec]<a name='2364'></font>
    XLAT_URB  = XLAT_URB2D(I,J)                           <font color=#447700>! [deg]<a name='2365'></font>
    COSZ_URB  = COSZ_URB2D(I,J) <a name='2366'>
    OMG_URB   = OMG_URB2D(I,J)<a name='2367'>
    ZNT_URB   = ZNT(I,J)<a name='2368'>
<a name='2369'>
    LSOLAR_URB = .FALSE.<a name='2370'>
<a name='2371'>
    TR_URB = TR_URB2D(I,J)<a name='2372'>
    TB_URB = TB_URB2D(I,J)<a name='2373'>
    TG_URB = TG_URB2D(I,J)<a name='2374'>
    TC_URB = TC_URB2D(I,J)<a name='2375'>
    QC_URB = QC_URB2D(I,J)<a name='2376'>
    UC_URB = UC_URB2D(I,J)<a name='2377'>
<a name='2378'>
    TGR_URB     = TGR_URB2D(I,J)<a name='2379'>
    CMCR_URB    = CMCR_URB2D(I,J)<a name='2380'>
    FLXHUMR_URB = FLXHUMR_URB2D(I,J)<a name='2381'>
    FLXHUMB_URB = FLXHUMB_URB2D(I,J)<a name='2382'>
    FLXHUMG_URB = FLXHUMG_URB2D(I,J)<a name='2383'>
    DRELR_URB   = DRELR_URB2D(I,J)<a name='2384'>
    DRELB_URB   = DRELB_URB2D(I,J)<a name='2385'>
    DRELG_URB   = DRELG_URB2D(I,J)<a name='2386'>
<a name='2387'>
    DO K = 1,num_roof_layers<a name='2388'>
      TRL_URB(K) = TRL_URB3D(I,K,J)<a name='2389'>
      SMR_URB(K) = SMR_URB3D(I,K,J)<a name='2390'>
      TGRL_URB(K)= TGRL_URB3D(I,K,J)<a name='2391'>
    END DO<a name='2392'>
<a name='2393'>
    DO K = 1,num_wall_layers<a name='2394'>
      TBL_URB(K) = TBL_URB3D(I,K,J)<a name='2395'>
    END DO<a name='2396'>
<a name='2397'>
    DO K = 1,num_road_layers<a name='2398'>
      TGL_URB(K) = TGL_URB3D(I,K,J)<a name='2399'>
    END DO<a name='2400'>
<a name='2401'>
    XXXR_URB = XXXR_URB2D(I,J)<a name='2402'>
    XXXB_URB = XXXB_URB2D(I,J)<a name='2403'>
    XXXG_URB = XXXG_URB2D(I,J)<a name='2404'>
    XXXC_URB = XXXC_URB2D(I,J)<a name='2405'>
<a name='2406'>
<font color=#447700>! Limits to avoid dividing by small number<a name='2407'></font>
    IF (CHS(I,J) &lt; 1.0E-02) THEN<a name='2408'>
      CHS(I,J)  = 1.0E-02<a name='2409'>
    ENDIF<a name='2410'>
    IF (CHS2(I,J) &lt; 1.0E-02) THEN<a name='2411'>
      CHS2(I,J)  = 1.0E-02<a name='2412'>
    ENDIF<a name='2413'>
    IF (CQS2(I,J) &lt; 1.0E-02) THEN<a name='2414'>
      CQS2(I,J)  = 1.0E-02<a name='2415'>
    ENDIF<a name='2416'>
<a name='2417'>
    CHS_URB  = CHS(I,J)<a name='2418'>
    CHS2(I,J)= CQS2(I,J)      <a name='2419'>
    CHS2_URB = CHS2(I,J)<a name='2420'>
    IF (PRESENT(CMR_SFCDIF)) THEN<a name='2421'>
      CMR_URB = CMR_SFCDIF(I,J)<a name='2422'>
      CHR_URB = CHR_SFCDIF(I,J)<a name='2423'>
      CMGR_URB = CMGR_SFCDIF(I,J)<a name='2424'>
      CHGR_URB = CHGR_SFCDIF(I,J)<a name='2425'>
      CMC_URB = CMC_SFCDIF(I,J)<a name='2426'>
      CHC_URB = CHC_SFCDIF(I,J)<a name='2427'>
    ENDIF<a name='2428'>
<a name='2429'>
<font color=#447700>! NUDAPT for SLUCM<a name='2430'></font>
<a name='2431'>
    MH_URB   = MH_URB2D(I,J)<a name='2432'>
    STDH_URB = STDH_URB2D(I,J)<a name='2433'>
    LP_URB   = LP_URB2D(I,J)<a name='2434'>
    HGT_URB  = HGT_URB2D(I,J)<a name='2435'>
    LF_URB   = 0.0<a name='2436'>
    DO K = 1,4<a name='2437'>
      LF_URB(K) = LF_URB2D(I,K,J)<a name='2438'>
    ENDDO<a name='2439'>
    FRC_URB  = FRC_URB2D(I,J)<a name='2440'>
    LB_URB   = LB_URB2D(I,J)<a name='2441'>
    CHECK    = 0<a name='2442'>
    IF (I.EQ.73.AND.J.EQ.125)THEN<a name='2443'>
      CHECK = 1<a name='2444'>
    END IF<a name='2445'>
<a name='2446'>
<font color=#447700>! Call urban<a name='2447'></font>
<a name='2448'>
    CALL <A href='../../html_code/phys/module_ra_HWRF.F.html#CAL_MON_DAY'>cal_mon_day</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CAL_MON_DAY_13">(julian,julyr,jmonth,jday)<a name='2449'>
    CALL <A href='../../html_code/phys/module_sf_urban.F.html#URBAN'>urban</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="URBAN_5">(LSOLAR_URB,                                                             &amp; <font color=#447700>! I<a name='2450'></font>
          num_roof_layers, num_wall_layers, num_road_layers,                           &amp; <font color=#447700>! C<a name='2451'></font>
                DZR,        DZB,        DZG, &amp; <font color=#447700>! C<a name='2452'></font>
          UTYPE_URB,     TA_URB,     QA_URB,     UA_URB,   U1_URB,  V1_URB, SSG_URB,   &amp; <font color=#447700>! I<a name='2453'></font>
           SSGD_URB,   SSGQ_URB,    LLG_URB,   RAIN_URB, RHOO_URB,                     &amp; <font color=#447700>! I<a name='2454'></font>
             ZA_URB, DECLIN_URB,   COSZ_URB,    OMG_URB,                               &amp; <font color=#447700>! I<a name='2455'></font>
           XLAT_URB,   DELT_URB,    ZNT_URB,                                           &amp; <font color=#447700>! I<a name='2456'></font>
            CHS_URB,   CHS2_URB,                                                       &amp; <font color=#447700>! I<a name='2457'></font>
             TR_URB,     TB_URB,     TG_URB,     TC_URB,   QC_URB,   UC_URB,           &amp; <font color=#447700>! H<a name='2458'></font>
            TRL_URB,    TBL_URB,    TGL_URB,                                           &amp; <font color=#447700>! H<a name='2459'></font>
           XXXR_URB,   XXXB_URB,   XXXG_URB,   XXXC_URB,                               &amp; <font color=#447700>! H<a name='2460'></font>
             TS_URB,     QS_URB,     SH_URB,     LH_URB, LH_KINEMATIC_URB,             &amp; <font color=#447700>! O<a name='2461'></font>
             SW_URB,    ALB_URB,     LW_URB,      G_URB,   RN_URB, PSIM_URB, PSIH_URB, &amp; <font color=#447700>! O<a name='2462'></font>
         GZ1OZ0_URB,                                                                   &amp; <font color=#447700>!O<a name='2463'></font>
            CMR_URB,    CHR_URB,    CMC_URB,    CHC_URB,                               &amp;<a name='2464'>
            U10_URB,    V10_URB,    TH2_URB,     Q2_URB,                               &amp; <font color=#447700>! O<a name='2465'></font>
            UST_URB,     mh_urb,   stdh_urb,     lf_urb,   lp_urb,                     &amp; <font color=#447700>! 0<a name='2466'></font>
            hgt_urb,    frc_urb,     lb_urb,      check, CMCR_URB,TGR_URB,             &amp; <font color=#447700>! H<a name='2467'></font>
           TGRL_URB,    SMR_URB,   CMGR_URB,   CHGR_URB,   jmonth,                     &amp; <font color=#447700>! H<a name='2468'></font>
          DRELR_URB,  DRELB_URB,                                                       &amp; <font color=#447700>! H<a name='2469'></font>
          DRELG_URB,FLXHUMR_URB,FLXHUMB_URB,FLXHUMG_URB )<a name='2470'>
<a name='2471'>
    TS_URB2D(I,J) = TS_URB<a name='2472'>
<a name='2473'>
    ALBEDO(I,J)   = FRC_URB2D(I,J) * ALB_URB + (1-FRC_URB2D(I,J)) * ALBEDO(I,J)        <font color=#447700>![-]      <a name='2474'></font>
    HFX(I,J)      = FRC_URB2D(I,J) * SH_URB  + (1-FRC_URB2D(I,J)) * HFX(I,J)           <font color=#447700>![W/m/m] <a name='2475'></font>
    QFX(I,J)      = FRC_URB2D(I,J) * LH_KINEMATIC_URB &amp;<a name='2476'>
                       + (1-FRC_URB2D(I,J))* QFX(I,J)                                  <font color=#447700>![kg/m/m/s] <a name='2477'></font>
    LH(I,J)       = FRC_URB2D(I,J) * LH_URB  + (1-FRC_URB2D(I,J)) * LH(I,J)            <font color=#447700>![W/m/m]   <a name='2478'></font>
    GRDFLX(I,J)   = FRC_URB2D(I,J) * (G_URB) + (1-FRC_URB2D(I,J)) * GRDFLX(I,J)        <font color=#447700>![W/m/m]  <a name='2479'></font>
    TSK(I,J)      = FRC_URB2D(I,J) * TS_URB  + (1-FRC_URB2D(I,J)) * TSK(I,J)           <font color=#447700>![K]    <a name='2480'></font>
<font color=#447700>!    Q1            = QSFC(I,J)/(1.0+QSFC(I,J))                                         <a name='2481'></font>
<font color=#447700>!    Q1            = FRC_URB2D(I,J) * QS_URB  + (1-FRC_URB2D(I,J)) * Q1                 ![-]<a name='2482'></font>
<a name='2483'>
<font color=#447700>! Convert QSFC back to mixing ratio<a name='2484'></font>
<a name='2485'>
<font color=#447700>!    QSFC(I,J)     = Q1/(1.0-Q1)<a name='2486'></font>
                   QSFC(I,J)= FRC_URB2D(I,J)*QS_URB+(1-FRC_URB2D(I,J))*QSFC(I,J)               <font color=#447700>!!   QSFC(I,J)=QSFC1D<a name='2487'></font>
    UST(I,J)      = FRC_URB2D(I,J) * UST_URB + (1-FRC_URB2D(I,J)) * UST(I,J)     <font color=#447700>![m/s]<a name='2488'></font>
<a name='2489'>
<font color=#447700>! Renew Urban State Variables<a name='2490'></font>
<a name='2491'>
    TR_URB2D(I,J) = TR_URB<a name='2492'>
    TB_URB2D(I,J) = TB_URB<a name='2493'>
    TG_URB2D(I,J) = TG_URB<a name='2494'>
    TC_URB2D(I,J) = TC_URB<a name='2495'>
    QC_URB2D(I,J) = QC_URB<a name='2496'>
    UC_URB2D(I,J) = UC_URB<a name='2497'>
<a name='2498'>
    TGR_URB2D(I,J)     = TGR_URB<a name='2499'>
    CMCR_URB2D(I,J)    = CMCR_URB<a name='2500'>
    FLXHUMR_URB2D(I,J) = FLXHUMR_URB<a name='2501'>
    FLXHUMB_URB2D(I,J) = FLXHUMB_URB<a name='2502'>
    FLXHUMG_URB2D(I,J) = FLXHUMG_URB<a name='2503'>
    DRELR_URB2D(I,J)   = DRELR_URB<a name='2504'>
    DRELB_URB2D(I,J)   = DRELB_URB<a name='2505'>
    DRELG_URB2D(I,J)   = DRELG_URB<a name='2506'>
<a name='2507'>
    DO K = 1,num_roof_layers<a name='2508'>
      TRL_URB3D(I,K,J) = TRL_URB(K)<a name='2509'>
      SMR_URB3D(I,K,J) = SMR_URB(K)<a name='2510'>
      TGRL_URB3D(I,K,J)= TGRL_URB(K)<a name='2511'>
    END DO<a name='2512'>
    DO K = 1,num_wall_layers<a name='2513'>
      TBL_URB3D(I,K,J) = TBL_URB(K)<a name='2514'>
    END DO<a name='2515'>
    DO K = 1,num_road_layers<a name='2516'>
      TGL_URB3D(I,K,J) = TGL_URB(K)<a name='2517'>
    END DO<a name='2518'>
<a name='2519'>
    XXXR_URB2D(I,J)    = XXXR_URB<a name='2520'>
    XXXB_URB2D(I,J)    = XXXB_URB<a name='2521'>
    XXXG_URB2D(I,J)    = XXXG_URB<a name='2522'>
    XXXC_URB2D(I,J)    = XXXC_URB<a name='2523'>
<a name='2524'>
    SH_URB2D(I,J)      = SH_URB<a name='2525'>
    LH_URB2D(I,J)      = LH_URB<a name='2526'>
    G_URB2D(I,J)       = G_URB         <a name='2527'>
    RN_URB2D(I,J)      = RN_URB<a name='2528'>
    PSIM_URB2D(I,J)    = PSIM_URB<a name='2529'>
    PSIH_URB2D(I,J)    = PSIH_URB<a name='2530'>
    GZ1OZ0_URB2D(I,J)  = GZ1OZ0_URB<a name='2531'>
    U10_URB2D(I,J)     = U10_URB<a name='2532'>
    V10_URB2D(I,J)     = V10_URB<a name='2533'>
    TH2_URB2D(I,J)     = TH2_URB<a name='2534'>
    Q2_URB2D(I,J)      = Q2_URB<a name='2535'>
    UST_URB2D(I,J)     = UST_URB<a name='2536'>
    AKMS_URB2D(I,J)    = KARMAN * UST_URB2D(I,J)/(GZ1OZ0_URB2D(I,J)-PSIM_URB2D(I,J))<a name='2537'>
    IF (PRESENT(CMR_SFCDIF)) THEN<a name='2538'>
      CMR_SFCDIF(I,J)  = CMR_URB<a name='2539'>
      CHR_SFCDIF(I,J)  = CHR_URB<a name='2540'>
      CMGR_SFCDIF(I,J) = CMGR_URB<a name='2541'>
      CHGR_SFCDIF(I,J) = CHGR_URB<a name='2542'>
      CMC_SFCDIF(I,J)  = CMC_URB<a name='2543'>
      CHC_SFCDIF(I,J)  = CHC_URB<a name='2544'>
    ENDIF<a name='2545'>
<a name='2546'>
  ENDIF                                 <font color=#447700>! urban land used type block<a name='2547'></font>
<a name='2548'>
ENDDO ILOOP                             <font color=#447700>! of I loop<a name='2549'></font>
ENDDO JLOOP                             <font color=#447700>! of J loop<a name='2550'></font>
<a name='2551'>
ENDIF                                   <font color=#447700>! sf_urban_physics = 1 block<a name='2552'></font>
<a name='2553'>
<font color=#447700>!--------------------------------------<a name='2554'></font>
<font color=#447700>! URBAN CANOPY MODEL END<a name='2555'></font>
<font color=#447700>!--------------------------------------<a name='2556'></font>
<a name='2557'>
<font color=#447700>!--------------------------------------<a name='2558'></font>
<font color=#447700>! URBAN BEP and BEM MODEL BEGIN<a name='2559'></font>
<font color=#447700>!--------------------------------------<a name='2560'></font>
<a name='2561'>
IF (SF_URBAN_PHYSICS == 2) THEN<a name='2562'>
<a name='2563'>
DO J=JTS,JTE<a name='2564'>
DO I=ITS,ITE<a name='2565'>
<a name='2566'>
  EMISS_URB(I,J)       = 0.<a name='2567'>
  RL_UP_URB(I,J)       = 0.<a name='2568'>
  RS_ABS_URB(I,J)      = 0.<a name='2569'>
  GRDFLX_URB(I,J)      = 0.<a name='2570'>
  B_Q_BEP(I,KTS:KTE,J) = 0.<a name='2571'>
<a name='2572'>
END DO<a name='2573'>
END DO<a name='2574'>
<a name='2575'>
  CALL <A href='../../html_code/phys/module_sf_bep.F.html#BEP'>BEP</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BEP_2">(frc_urb2d,  utype_urb2d, itimestep,       dz8w,         &amp;<a name='2576'>
                  dt,        u_phy,     v_phy,                     &amp;<a name='2577'>
              th_phy,          rho,     p_phy,     swdown,    glw, &amp;<a name='2578'>
                 gmt,       julday,     xlong,       xlat,         &amp;<a name='2579'>
          declin_urb,   cosz_urb2d, omg_urb2d,                     &amp;<a name='2580'>
    num_urban_layers, num_urban_hi,                                &amp;<a name='2581'>
           trb_urb4d,    tw1_urb4d, tw2_urb4d,  tgb_urb4d,         &amp;<a name='2582'>
          sfw1_urb3d,   sfw2_urb3d, sfr_urb3d,  sfg_urb3d,         &amp;<a name='2583'>
            lp_urb2d,     hi_urb2d,  lb_urb2d,  hgt_urb2d,         &amp;<a name='2584'>
             a_u_bep,      a_v_bep,   a_t_bep,                     &amp;<a name='2585'>
             a_e_bep,      b_u_bep,   b_v_bep,                     &amp;<a name='2586'>
             b_t_bep,      b_e_bep,   b_q_bep,    dlg_bep,         &amp;<a name='2587'>
            dl_u_bep,       sf_bep,    vl_bep,                     &amp;<a name='2588'>
           rl_up_urb,   rs_abs_urb, emiss_urb, grdflx_urb,         &amp;<a name='2589'>
         ids,ide, jds,jde, kds,kde,                                &amp;<a name='2590'>
         ims,ime, jms,jme, kms,kme,                                &amp;<a name='2591'>
         its,ite, jts,jte, kts,kte )<a name='2592'>
<a name='2593'>
ENDIF <font color=#447700>! SF_URBAN_PHYSICS == 2<a name='2594'></font>
<a name='2595'>
IF (SF_URBAN_PHYSICS == 3) THEN<a name='2596'>
<a name='2597'>
DO J=JTS,JTE<a name='2598'>
DO I=ITS,ITE<a name='2599'>
<a name='2600'>
  EMISS_URB(I,J)       = 0.<a name='2601'>
  RL_UP_URB(I,J)       = 0.<a name='2602'>
  RS_ABS_URB(I,J)      = 0.<a name='2603'>
  GRDFLX_URB(I,J)      = 0.<a name='2604'>
  B_Q_BEP(I,KTS:KTE,J) = 0.<a name='2605'>
<a name='2606'>
END DO<a name='2607'>
END DO<a name='2608'>
<a name='2609'>
  CALL <A href='../../html_code/phys/module_sf_bep_bem.F.html#BEP_BEM'>BEP_BEM</A><A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BEP_BEM_2">( frc_urb2d,  utype_urb2d,    itimestep,         dz8w,       &amp;<a name='2610'>
                       dt,        u_phy,        v_phy,                     &amp;<a name='2611'>
                   th_phy,          rho,        p_phy,       swdown,  glw, &amp;<a name='2612'>
                      gmt,       julday,        xlong,         xlat,       &amp;<a name='2613'>
               declin_urb,   cosz_urb2d,    omg_urb2d,                     &amp;<a name='2614'>
         num_urban_layers, num_urban_hi,                                   &amp;<a name='2615'>
                trb_urb4d,    tw1_urb4d,    tw2_urb4d,    tgb_urb4d,       &amp;<a name='2616'>
               tlev_urb3d,   qlev_urb3d, tw1lev_urb3d, tw2lev_urb3d,       &amp;<a name='2617'>
              tglev_urb3d,  tflev_urb3d,  sf_ac_urb3d,  lf_ac_urb3d,       &amp;<a name='2618'>
              cm_ac_urb3d, sfvent_urb3d, lfvent_urb3d,                     &amp;<a name='2619'>
             sfwin1_urb3d, sfwin2_urb3d,                                   &amp;<a name='2620'>
               sfw1_urb3d,   sfw2_urb3d,    sfr_urb3d,    sfg_urb3d,       &amp;<a name='2621'>
                 lp_urb2d,     hi_urb2d,     lb_urb2d,    hgt_urb2d,       &amp;<a name='2622'>
                  a_u_bep,      a_v_bep,      a_t_bep,                     &amp;<a name='2623'>
                  a_e_bep,      b_u_bep,      b_v_bep,                     &amp;<a name='2624'>
                  b_t_bep,      b_e_bep,      b_q_bep,      dlg_bep,       &amp;<a name='2625'>
                 dl_u_bep,       sf_bep,       vl_bep,                     &amp;<a name='2626'>
                rl_up_urb,   rs_abs_urb,    emiss_urb,   grdflx_urb, qv3d, &amp;<a name='2627'>
             ids,ide, jds,jde, kds,kde,                                    &amp;<a name='2628'>
             ims,ime, jms,jme, kms,kme,                                    &amp;<a name='2629'>
             its,ite, jts,jte, kts,kte )<a name='2630'>
<a name='2631'>
ENDIF <font color=#447700>! SF_URBAN_PHYSICS == 3<a name='2632'></font>
<a name='2633'>
IF((SF_URBAN_PHYSICS == 2).OR.(SF_URBAN_PHYSICS == 3))THEN <a name='2634'>
<a name='2635'>
  sigma_sb=5.67e-08<a name='2636'>
  do j = jts, jte<a name='2637'>
  do i = its, ite<a name='2638'>
    UMOM_URB(I,J)     = 0.<a name='2639'>
    VMOM_URB(I,J)     = 0.<a name='2640'>
    HFX_URB(I,J)      = 0.<a name='2641'>
    QFX_URB(I,J)      = 0.<a name='2642'>
<a name='2643'>
    do k=kts,kte<a name='2644'>
      a_u_bep(i,k,j) = a_u_bep(i,k,j)*frc_urb2d(i,j)<a name='2645'>
      a_v_bep(i,k,j) = a_v_bep(i,k,j)*frc_urb2d(i,j)<a name='2646'>
      a_t_bep(i,k,j) = a_t_bep(i,k,j)*frc_urb2d(i,j)<a name='2647'>
      a_q_bep(i,k,j) = 0.<a name='2648'>
      a_e_bep(i,k,j) = 0.<a name='2649'>
      b_u_bep(i,k,j) = b_u_bep(i,k,j)*frc_urb2d(i,j)<a name='2650'>
      b_v_bep(i,k,j) = b_v_bep(i,k,j)*frc_urb2d(i,j)<a name='2651'>
      b_t_bep(i,k,j) = b_t_bep(i,k,j)*frc_urb2d(i,j)<a name='2652'>
      b_q_bep(i,k,j) = b_q_bep(i,k,j)*frc_urb2d(i,j)<a name='2653'>
      b_e_bep(i,k,j) = b_e_bep(i,k,j)*frc_urb2d(i,j)<a name='2654'>
      HFX_URB(I,J)   = HFX_URB(I,J) + B_T_BEP(I,K,J)*RHO(I,K,J)*CP*DZ8W(I,K,J)*VL_BEP(I,K,J)<a name='2655'>
      QFX_URB(I,J)   = QFX_URB(I,J) + B_Q_BEP(I,K,J)*DZ8W(I,K,J)*VL_BEP(I,K,J)<a name='2656'>
      UMOM_URB(I,J)  = UMOM_URB(I,J)+ (A_U_BEP(I,K,J)*U_PHY(I,K,J)+B_U_BEP(I,K,J))*DZ8W(I,K,J)*VL_BEP(I,K,J)<a name='2657'>
      VMOM_URB(I,J)  = VMOM_URB(I,J)+ (A_V_BEP(I,K,J)*V_PHY(I,K,J)+B_V_BEP(I,K,J))*DZ8W(I,K,J)*VL_BEP(I,K,J)<a name='2658'>
      vl_bep(i,k,j)  = (1.-frc_urb2d(i,j)) + vl_bep(i,k,j)*frc_urb2d(i,j)<a name='2659'>
      sf_bep(i,k,j)  = (1.-frc_urb2d(i,j)) + sf_bep(i,k,j)*frc_urb2d(i,j)<a name='2660'>
    end do<a name='2661'>
<a name='2662'>
    a_u_bep(i,1,j)   = (1.-frc_urb2d(i,j))*(-ust(I,J)*ust(I,J))/dz8w(i,1,j)/   &amp;<a name='2663'>
                          ((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)+a_u_bep(i,1,j)<a name='2664'>
<a name='2665'>
    a_v_bep(i,1,j)   = (1.-frc_urb2d(i,j))*(-ust(I,J)*ust(I,J))/dz8w(i,1,j)/   &amp;<a name='2666'>
                          ((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)+a_v_bep(i,1,j)<a name='2667'>
<a name='2668'>
    b_t_bep(i,1,j)   = (1.-frc_urb2d(i,j))*hfx_rural(i,j)/dz8w(i,1,j)/rho(i,1,j)/CP+ &amp; <a name='2669'>
                           b_t_bep(i,1,j)<a name='2670'>
<a name='2671'>
    b_q_bep(i,1,j)   = (1.-frc_urb2d(i,j))*qfx_rural(i,j)/dz8w(i,1,j)/rho(i,1,j)+b_q_bep(i,1,j)<a name='2672'>
<a name='2673'>
    umom             = (1.-frc_urb2d(i,j))*ust(i,j)*ust(i,j)*u_phy(i,1,j)/               &amp;<a name='2674'>
                         ((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)+umom_urb(i,j)<a name='2675'>
<a name='2676'>
    vmom             = (1.-frc_urb2d(i,j))*ust(i,j)*ust(i,j)*v_phy(i,1,j)/               &amp;<a name='2677'>
                         ((u_phy(i,1,j)**2+v_phy(i,1,j)**2.)**.5)+vmom_urb(i,j)<a name='2678'>
    sf_bep(i,1,j)    = 1.<a name='2679'>
<a name='2680'>
<font color=#447700>! using the emissivity and the total longwave upward radiation estimate the averaged skin temperature<a name='2681'></font>
<a name='2682'>
  IF (FRC_URB2D(I,J).GT.0.) THEN<a name='2683'>
    rl_up_rural   = -emiss_rural(i,j)*sigma_sb*(tsk_rural(i,j)**4.)-(1.-emiss_rural(i,j))*glw(i,j)<a name='2684'>
    rl_up_tot     = (1.-frc_urb2d(i,j))*rl_up_rural     + frc_urb2d(i,j)*rl_up_urb(i,j)<a name='2685'>
    emiss(i,j)    = (1.-frc_urb2d(i,j))*emiss_rural(i,j)+ frc_urb2d(i,j)*emiss_urb(i,j)<a name='2686'>
    ts_urb2d(i,j) = (max(0.,(-rl_up_urb(i,j)-(1.-emiss_urb(i,j))*glw(i,j))/emiss_urb(i,j)/sigma_sb))**0.25<a name='2687'>
    tsk(i,j)      = (max(0., (-1.*rl_up_tot-(1.-emiss(i,j))*glw(i,j) )/emiss(i,j)/sigma_sb))**.25<a name='2688'>
    rs_abs_tot    = (1.-frc_urb2d(i,j))*swdown(i,j)*(1.-albedo(i,j))+frc_urb2d(i,j)*rs_abs_urb(i,j)<a name='2689'>
<a name='2690'>
    if(swdown(i,j) &gt; 0.)then<a name='2691'>
      albedo(i,j) = 1.-rs_abs_tot/swdown(i,j)<a name='2692'>
    else<a name='2693'>
      albedo(i,j) = alb_rural(i,j)<a name='2694'>
    endif<a name='2695'>
<a name='2696'>
<font color=#447700>! rename *_urb to sh_urb2d,lh_urb2d,g_urb2d,rn_urb2d<a name='2697'></font>
<a name='2698'>
    grdflx(i,j)   = (1.-frc_urb2d(i,j))*grdflx_rural(i,j)+ frc_urb2d(i,j)*grdflx_urb(i,j)<a name='2699'>
    qfx(i,j)      = (1.-frc_urb2d(i,j))*qfx_rural(i,j)   + qfx_urb(i,j)<a name='2700'>
    lh(i,j)       = qfx(i,j)*xlv<a name='2701'>
    hfx(i,j)      = hfx_urb(i,j)                         + (1-frc_urb2d(i,j))*hfx_rural(i,j)      <font color=#447700>![W/m/m]<a name='2702'></font>
    sh_urb2d(i,j) = hfx_urb(i,j)/frc_urb2d(i,j)<a name='2703'>
    lh_urb2d(i,j) = qfx_urb(i,j)*xlv<a name='2704'>
    g_urb2d(i,j)  = grdflx_urb(i,j)<a name='2705'>
    rn_urb2d(i,j) = rs_abs_urb(i,j)+emiss_urb(i,j)*glw(i,j)-rl_up_urb(i,j)<a name='2706'>
    ust(i,j)      = (umom**2.+vmom**2.)**.25<a name='2707'>
<a name='2708'>
  ELSE<a name='2709'>
<a name='2710'>
    sh_urb2d(i,j)    = 0.<a name='2711'>
    lh_urb2d(i,j)    = 0.<a name='2712'>
    g_urb2d(i,j)     = 0.<a name='2713'>
    rn_urb2d(i,j)    = 0.<a name='2714'>
<a name='2715'>
  ENDIF<a name='2716'>
<a name='2717'>
  enddo <font color=#447700>! jloop<a name='2718'></font>
  enddo <font color=#447700>! iloop<a name='2719'></font>
<a name='2720'>
ENDIF <font color=#447700>! SF_URBAN_PHYSICS == 2 or 3<a name='2721'></font>
<a name='2722'>
<font color=#447700>!--------------------------------------<a name='2723'></font>
<font color=#447700>! URBAN BEP and BEM MODEL END<a name='2724'></font>
<font color=#447700>!--------------------------------------<a name='2725'></font>
<a name='2726'>
<a name='2727'>
END SUBROUTINE noahmp_urban<a name='2728'>
<a name='2729'>
<font color=#447700>!------------------------------------------------------------------------------------------<a name='2730'></font>
<font color=#447700>!<a name='2731'></font>
END MODULE module_sf_noahmpdrv<a name='2732'>
</pre></body></html>