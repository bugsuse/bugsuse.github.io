<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!_______________________________________________________________________________!<a name='2'></font>
<font color=#447700>!                                                                               !<a name='3'></font>
<font color=#447700>!  This module contains the microphysics sub-driver for the 2-moment version of !<a name='4'></font>
<font color=#447700>!  the Milbrandt-Yau (2005, JAS) microphysics scheme, along with all associated !<a name='5'></font>
<font color=#447700>!  subprograms.  The main subroutine, 'mp_milbrandt2mom_main', is essentially   !<a name='6'></font>
<font color=#447700>!  directly from the RPN-CMC physics library of the Canadian GEM model.  It is  !<a name='7'></font>
<font color=#447700>!  called by the wrapper 'mp_milbrandt2mom_driver' which makes the necessary    !<a name='8'></font>
<font color=#447700>!  adjustments to the calling parameters for the interface to WRF.              !<a name='9'></font>
<font color=#447700>!                                                                               !<a name='10'></font>
<font color=#447700>!  For questions, bug reports, etc. pertaining to the scheme, or to request     !<a name='11'></font>
<font color=#447700>!  updates to the code (before the next offical WRF release) please contact     !<a name='12'></font>
<font color=#447700>!  Jason Milbrandt (Environment Canada) at jason.milbrandt@ec.gc.ca             !<a name='13'></font>
<font color=#447700>!                                                                               !<a name='14'></font>
<font color=#447700>!_______________________________________________________________________________!<a name='15'></font>
<font color=#447700>!                                                                               !<a name='16'></font>
<font color=#447700>!  Package version:   2.25.2_beta_04   (internal bookkeeping)                   !<a name='17'></font>
<font color=#447700>!  Last modified:     2015-02-11                                                !<a name='18'></font>
<font color=#447700>!_______________________________________________________________________________!<a name='19'></font>
<a name='20'>
<A NAME='MY2_MOD'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MY2_MOD' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='21'>
<font color=#993300>MODULE </font><font color=#cc0000>my2_mod</font> <A href='../../call_to/MY2_MOD.html' TARGET='index'>1</A><a name='22'>
<a name='23'>
 private<a name='24'>
 public  :: mp_milbrandt2mom_main<a name='25'>
 private :: NccnFNC,SxFNC,gamma,gser,gammln,gammp,cfg,gamminc,polysvp,qsat,check_values<a name='26'>
 private :: sedi_wrapper_2,sedi_1D,count_columns,des_OF_Ds,Dm_x,iLAMDA_x,N_Cooper,Nos_Thompson<a name='27'>
<a name='28'>
 CONTAINS<a name='29'>
<a name='30'>
<font color=#447700>!==============================================================================!<a name='31'></font>
<a name='32'>
<A NAME='NCCNFNC'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#NCCNFNC' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='33'>
 REAL <font color=#993300>FUNCTION </font><font color=#cc0000>NccnFNC</font>(Win,Tin,Pin,CCNtype)<a name='34'>
<a name='35'>
<font color=#447700>!---------------------------------------------------------------------------!<a name='36'></font>
<font color=#447700>! This function returns number concentration (activated aerosols) as a<a name='37'></font>
<font color=#447700>! function of w,T,p, based on polynomial approximations of detailed<a name='38'></font>
<font color=#447700>! approach using a hypergeometric function, following Cohard and Pinty (2000a).<a name='39'></font>
<font color=#447700>!---------------------------------------------------------------------------!<a name='40'></font>
<a name='41'>
  IMPLICIT NONE<a name='42'>
<a name='43'>
<font color=#447700>! PASSING PARAMETERS:<a name='44'></font>
  real,    intent(in) :: Win, Tin, Pin<a name='45'>
  integer, intent(in) :: CCNtype<a name='46'>
<a name='47'>
<font color=#447700>! LOCAL PARAMETERS:<a name='48'></font>
  real :: T,p,x,y,a,b,c,d,e,f,g,h,T2,T3,T4,x2,x3,x4,p2<a name='49'>
<a name='50'>
  x= log10(Win*100.);   x2= x*x;  x3= x2*x;  x4= x2*x2<a name='51'>
  T= Tin - 273.15;      T2= T*T;  T3= T2*T;  T4= T2*T2<a name='52'>
  p= Pin*0.01;          p2= p*p<a name='53'>
<a name='54'>
  if (CCNtype==1) then  <font color=#447700>!Maritime<a name='55'></font>
<a name='56'>
     a= 1.47e-9*T4 -6.944e-8*T3 -9.933e-7*T2 +2.7278e-4*T -6.6853e-4<a name='57'>
     b=-1.41e-8*T4 +6.662e-7*T3 +4.483e-6*T2 -2.0479e-3*T +4.0823e-2<a name='58'>
     c= 5.12e-8*T4 -2.375e-6*T3 +4.268e-6*T2 +3.9681e-3*T -3.2356e-1<a name='59'>
     d=-8.25e-8*T4 +3.629e-6*T3 -4.044e-5*T2 +2.1846e-3*T +9.1227e-1<a name='60'>
     e= 5.02e-8*T4 -1.973e-6*T3 +3.944e-5*T2 -9.0734e-3*T +1.1256e0<a name='61'>
     f= -1.424e-6*p2 +3.631e-3*p -1.986<a name='62'>
     g= -0.0212*x4 +0.1765*x3 -0.3770*x2 -0.2200*x +1.0081<a name='63'>
     h= 2.47e-6*T3 -3.654e-5*T2 +2.3327e-3*T +0.1938<a name='64'>
     y= a*x4 + b*x3 + c*x2 + d*x + e + f*g*h<a name='65'>
     NccnFNC= 10.**min(2.,max(0.,y)) *1.e6                <font color=#447700>![m-3]<a name='66'></font>
<a name='67'>
  else if (CCNtype==2) then  <font color=#447700>!Continental<a name='68'></font>
<a name='69'>
     a= 0.<a name='70'>
     b= 0.<a name='71'>
     c=-2.112e-9*T4 +3.9836e-8*T3 +2.3703e-6*T2 -1.4542e-4*T -0.0698<a name='72'>
     d=-4.210e-8*T4 +5.5745e-7*T3 +1.8460e-5*T2 +9.6078e-4*T +0.7120<a name='73'>
     e= 1.434e-7*T4 -1.6455e-6*T3 -4.3334e-5*T2 -7.6720e-3*T +1.0056<a name='74'>
     f= 1.340e-6*p2 -3.5114e-3*p  +1.9453<a name='75'>
     g= 4.226e-3*x4 -5.6012e-3*x3 -8.7846e-2*x2 +2.7435e-2*x +0.9932<a name='76'>
     h= 5.811e-9*T4 +1.5589e-7*T3 -3.8623e-5*T2 +1.4471e-3*T +0.1496<a name='77'>
     y= a*x4 +b*x3 +c*x2 + d*x + e + (f*g*h)<a name='78'>
     NccnFNC= 10.**max(0.,y) *1.e6<a name='79'>
<a name='80'>
  else<a name='81'>
<a name='82'>
    print*, '*** STOPPED in MODULE ### NccnFNC  *** '<a name='83'>
    print*, '    Parameter CCNtype incorrectly specified'<a name='84'>
    stop<a name='85'>
<a name='86'>
  endif<a name='87'>
<a name='88'>
 END FUNCTION NccnFNC<a name='89'>
<font color=#447700>!======================================================================!<a name='90'></font>
<a name='91'>
<A NAME='SXFNC'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SXFNC' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='92'>
   real <font color=#993300>FUNCTION </font><font color=#cc0000>SxFNC</font>(Win,Tin,Pin,Qsw,Qsi,CCNtype,WRT) <A href='../../call_to/SXFNC.html' TARGET='index'>1</A><a name='93'>
<a name='94'>
<font color=#447700>!---------------------------------------------------------------------------!<a name='95'></font>
<font color=#447700>! This function returns the peak supersaturation achieved during ascent with<a name='96'></font>
<font color=#447700>! activation of CCN aerosols as a function of w,T,p, based on polynomial<a name='97'></font>
<font color=#447700>! approximations of detailed approach using a hypergeometric function,<a name='98'></font>
<font color=#447700>! following Cohard and Pinty (2000a).<a name='99'></font>
<font color=#447700>!---------------------------------------------------------------------------!<a name='100'></font>
<a name='101'>
 IMPLICIT NONE<a name='102'>
<a name='103'>
<font color=#447700>! PASSING PARAMETERS:<a name='104'></font>
  integer, intent(IN) :: WRT<a name='105'>
  integer, intent(IN) :: CCNtype<a name='106'>
  real,    intent(IN) :: Win, Tin, Pin, Qsw, Qsi<a name='107'>
<a name='108'>
<font color=#447700>! LOCAL PARAMETERS:<a name='109'></font>
  real   ::  Si,Sw,Qv,T,p,x,a,b,c,d,f,g,h,Pcorr,T2corr,T2,T3,T4,x2,x3,x4,p2<a name='110'>
  real, parameter :: TRPL= 273.15<a name='111'>
<a name='112'>
  x= log10(max(Win,1.e-20)*100.);   x2= x*x;  x3= x2*x;  x4= x2*x2<a name='113'>
  T= Tin;                           T2= T*T;  T3= T2*T;  T4= T2*T2<a name='114'>
  p= Pin*0.01;                      p2= p*p<a name='115'>
<a name='116'>
  if (CCNtype==1) then  <font color=#447700>!Maritime<a name='117'></font>
<a name='118'>
     a= -5.109e-7*T4 -3.996e-5*T3 -1.066e-3*T2 -1.273e-2*T +0.0659<a name='119'>
     b=  2.014e-6*T4 +1.583e-4*T3 +4.356e-3*T2 +4.943e-2*T -0.1538<a name='120'>
     c= -2.037e-6*T4 -1.625e-4*T3 -4.541e-3*T2 -5.118e-2*T +0.1428<a name='121'>
     d=  3.812e-7*T4 +3.065e-5*T3 +8.795e-4*T2 +9.440e-3*T +6.14e-3<a name='122'>
     f= -2.012e-6*p2 + 4.1913e-3*p    - 1.785e0<a name='123'>
     g=  2.832e-1*x3 -5.6990e-1*x2 +5.1105e-1*x -4.1747e-4<a name='124'>
     h=  1.173e-6*T3 +3.2174e-5*T2 -6.8832e-4*T +6.7888e-2<a name='125'>
     Pcorr= f*g*h<a name='126'>
     T2corr= 0.9581-4.449e-3*T-2.016e-4*T2-3.307e-6*T3-1.725e-8*T4<a name='127'>
<a name='128'>
  else if (CCNtype==2) then  <font color=#447700>!Continental [computed for -35&lt;T&lt;-5C]<a name='129'></font>
<a name='130'>
     a=  3.80e-5*T2 +1.65e-4*T +9.88e-2<a name='131'>
     b= -7.38e-5*T2 -2.53e-3*T -3.23e-1<a name='132'>
     c=  8.39e-5*T2 +3.96e-3*T +3.50e-1<a name='133'>
     d= -1.88e-6*T2 -1.33e-3*T -3.73e-2<a name='134'>
     f= -1.9761e-6*p2 + 4.1473e-3*p - 1.771e0<a name='135'>
     g=  0.1539*x4 -0.5575*x3 +0.9262*x2 -0.3498*x -0.1293<a name='136'>
     h=-8.035e-9*T4+3.162e-7*T3+1.029e-5*T2-5.931e-4*T+5.62e-2<a name='137'>
     Pcorr= f*g*h<a name='138'>
     T2corr= 0.98888-5.0525e-4*T-1.7598e-5*T2-8.3308e-8*T3<a name='139'>
<a name='140'>
  else<a name='141'>
<a name='142'>
    print*, '*** STOPPED in MODULE ### SxFNC  *** '<a name='143'>
    print*, '    Parameter CCNtype incorrectly specified'<a name='144'>
    stop<a name='145'>
<a name='146'>
  endif<a name='147'>
<a name='148'>
  Sw= (a*x3 + b*x2 +c*x + d) + Pcorr<a name='149'>
  Sw= 1. + 0.01*Sw<a name='150'>
  Qv= Qsw*Sw<a name='151'>
  Si= Qv/Qsi<a name='152'>
  Si= Si*T2corr<a name='153'>
  if (WRT.eq.1) then<a name='154'>
     SxFNC= Sw<a name='155'>
  else<a name='156'>
     SxFNC= Si<a name='157'>
  endif<a name='158'>
  if (Win.le.0.) SxFNC= 1.<a name='159'>
<a name='160'>
 END function SxFNC<a name='161'>
<font color=#447700>!======================================================================!<a name='162'></font>
<a name='163'>
<A NAME='GAMMA'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#GAMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='164'>
 real <font color=#993300>FUNCTION </font><font color=#cc0000>gamma</font>(xx) <A href='../../call_to/GAMMA.html' TARGET='index'>117</A><a name='165'>
<a name='166'>
<font color=#447700>!  Modified from "Numerical Recipes"<a name='167'></font>
<a name='168'>
  IMPLICIT NONE<a name='169'>
<a name='170'>
<font color=#447700>! PASSING PARAMETERS:<a name='171'></font>
  real, intent(IN) :: xx<a name='172'>
<a name='173'>
<font color=#447700>! LOCAL PARAMETERS:<a name='174'></font>
  integer  :: j<a name='175'>
  real*8   :: ser,stp,tmp,x,y,cof(6),gammadp<a name='176'>
<a name='177'>
<a name='178'>
  SAVE cof,stp<a name='179'>
  DATA cof,stp/76.18009172947146d0,-86.50532032941677d0,               &amp;<a name='180'>
       24.01409824083091d0,-1.231739572450155d0,.1208650973866179d-2,  &amp;<a name='181'>
       -.5395239384953d-5,2.5066282746310005d0/<a name='182'>
  x=dble(xx)<a name='183'>
  y=x<a name='184'>
  tmp=x+5.5d0<a name='185'>
  tmp=(x+0.5d0)*log(tmp)-tmp<a name='186'>
  ser=1.000000000190015d0<a name='187'>
<font color=#447700>! do j=1,6   !original<a name='188'></font>
  do j=1,4<a name='189'>
<font color=#447700>!!do j=1,3   !gives result to within ~ 3 %<a name='190'></font>
     y=y+1.d0<a name='191'>
     ser=ser+cof(j)/y<a name='192'>
  enddo<a name='193'>
  gammadp=tmp+log(stp*ser/x)<a name='194'>
  gammadp= exp(gammadp)<a name='195'>
<a name='196'>
<font color=#447700>!!GEM:<a name='197'></font>
  gamma  = sngl(gammadp)<a name='198'>
<a name='199'>
 END FUNCTION gamma<a name='200'>
<font color=#447700>!======================================================================!<a name='201'></font>
<a name='202'>
<A NAME='GSER'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#GSER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='203'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>gser</font>(gamser,a,x,gln) <A href='../../call_to/GSER.html' TARGET='index'>2</A>,<A href='../../call_from/GSER.html' TARGET='index'>2</A><a name='204'>
<a name='205'>
<font color=#447700>! USES gammln<a name='206'></font>
<a name='207'>
<font color=#447700>!   Returns the incomplete gamma function P(a,x) evaluated by its series<a name='208'></font>
<font color=#447700>!   representation as gamser.  Also returns GAMMA(a) as gln.<a name='209'></font>
<a name='210'>
 implicit none<a name='211'>
<a name='212'>
 integer :: itmax<a name='213'>
 real    :: a,gamser,gln,x,eps<a name='214'>
 parameter (itmax=100, eps=3.e-7)<a name='215'>
 integer :: n<a name='216'>
 real :: ap,de1,summ<a name='217'>
<a name='218'>
 gln=<A href='../../html_code/phys/module_mp_thompson.F.html#GAMMLN'>gammln</A><A href='../../html_code/phys/module_mp_thompson.F.html#GSER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMLN_1">(a)<a name='219'>
 if(x.le.0.)then<a name='220'>
    gamser=0.<a name='221'>
    return<a name='222'>
 endif<a name='223'>
 ap=a<a name='224'>
 summ=1./a<a name='225'>
 de1=summ<a name='226'>
 do n=1,itmax<a name='227'>
    ap=ap+1.<a name='228'>
    de1=de1*x/ap<a name='229'>
    summ=summ+de1<a name='230'>
    if(abs(de1).lt.abs(summ)*eps) goto 1<a name='231'>
 enddo<a name='232'>
1 gamser=summ*exp(-x+a*log(x)-gln)<a name='233'>
 return<a name='234'>
<a name='235'>
END SUBROUTINE gser<a name='236'>
<font color=#447700>!======================================================================!<a name='237'></font>
<a name='238'>
<A NAME='GAMMLN'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#GAMMLN' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='239'>
 real <font color=#993300>FUNCTION </font><font color=#cc0000>gammln</font>(xx) <A href='../../call_to/GAMMLN.html' TARGET='index'>4</A><a name='240'>
<a name='241'>
<font color=#447700>!  Returns value of ln(GAMMA(xx)) for xx&gt;0<a name='242'></font>
<font color=#447700>!   (modified from "Numerical Recipes")<a name='243'></font>
<a name='244'>
  IMPLICIT NONE<a name='245'>
<a name='246'>
<font color=#447700>! PASSING PARAMETERS:<a name='247'></font>
  real, intent(IN) :: xx<a name='248'>
<a name='249'>
<font color=#447700>! LOCAL PARAMETERS:<a name='250'></font>
  integer  :: j<a name='251'>
  real*8   :: ser,stp,tmp,x,y,cof(6)<a name='252'>
<a name='253'>
  SAVE cof,stp<a name='254'>
  DATA cof,stp/76.18009172947146d0,-86.50532032941677d0,               &amp;<a name='255'>
       24.01409824083091d0,-1.231739572450155d0,.1208650973866179d-2,  &amp;<a name='256'>
       -.5395239384953d-5,2.5066282746310005d0/<a name='257'>
  x=dble(xx)<a name='258'>
  y=x<a name='259'>
  tmp=x+5.5d0<a name='260'>
  tmp=(x+0.5d0)*log(tmp)-tmp<a name='261'>
  ser=1.000000000190015d0<a name='262'>
  do j=1,6   <font color=#447700>!original<a name='263'></font>
<font color=#447700>!  do j=1,4<a name='264'></font>
     y=y+1.d0<a name='265'>
     ser=ser+cof(j)/y<a name='266'>
  enddo<a name='267'>
<a name='268'>
<font color=#447700>!! GEM:<a name='269'></font>
  gammln= sngl( tmp+log(stp*ser/x)  )<a name='270'>
<a name='271'>
 END FUNCTION gammln<a name='272'>
<font color=#447700>!======================================================================!<a name='273'></font>
<a name='274'>
<A NAME='GAMMP'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#GAMMP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='275'>
 real <font color=#993300>FUNCTION </font><font color=#cc0000>gammp</font>(a,x) <A href='../../call_to/GAMMP.html' TARGET='index'>2</A>,<A href='../../call_from/GAMMP.html' TARGET='index'>4</A><a name='276'>
<a name='277'>
<font color=#447700>! USES gcf,gser<a name='278'></font>
<a name='279'>
<font color=#447700>! Returns the incomplete gamma function P(a,x)<a name='280'></font>
<a name='281'>
 implicit none<a name='282'>
<a name='283'>
 real :: a,x,gammcf,gamser,gln<a name='284'>
<a name='285'>
 if(x.lt.a+1.)then<a name='286'>
    call <A href='../../html_code/phys/module_mp_thompson.F.html#GSER'>gser</A><A href='../../html_code/phys/module_mp_thompson.F.html#GAMMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GSER_1">(gamser,a,x,gln)<a name='287'>
    gammp=gamser<a name='288'>
 else<a name='289'>
    call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#CFG'>cfg</A><A href='../../html_code/phys/module_mp_thompson.F.html#GAMMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CFG_1">(gammcf,a,x,gln)<a name='290'>
    gammp=1.-gammcf<a name='291'>
 endif<a name='292'>
 return<a name='293'>
<a name='294'>
 END FUNCTION gammp<a name='295'>
<font color=#447700>!======================================================================!<a name='296'></font>
<a name='297'>
<A NAME='CFG'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#CFG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='298'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>cfg</font>(gammcf,a,x,gln) <A href='../../call_to/CFG.html' TARGET='index'>1</A>,<A href='../../call_from/CFG.html' TARGET='index'>1</A><a name='299'>
<a name='300'>
<font color=#447700>! USES gammln<a name='301'></font>
<a name='302'>
<font color=#447700>! Returns the incomplete gamma function (Q(a,x) evaluated by tis continued fraction<a name='303'></font>
<font color=#447700>! representation as gammcf.  Also returns ln(GAMMA(a)) as gln.  ITMAX is the maximum<a name='304'></font>
<font color=#447700>! allowed number of iterations; EPS is the relative accuracy; FPMIN is a number near<a name='305'></font>
<font color=#447700>! the smallest representable floating-point number.<a name='306'></font>
<a name='307'>
 implicit none<a name='308'>
<a name='309'>
 integer :: i,itmax<a name='310'>
 real    :: a,gammcf,gln,x,eps,fpmin<a name='311'>
 real    :: an,b,c,d,de1,h<a name='312'>
 parameter (itmax=100,eps=3.e-7)<a name='313'>
<a name='314'>
 gln=<A href='../../html_code/phys/module_mp_thompson.F.html#GAMMLN'>gammln</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#CFG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMLN_2">(a)<a name='315'>
 b=x+1.-a<a name='316'>
 c=1./fpmin<a name='317'>
 d=1./b<a name='318'>
 h=d<a name='319'>
 do i= 1,itmax<a name='320'>
   an=-i*(i-a)<a name='321'>
   b=b+2.<a name='322'>
   d=an*d+b<a name='323'>
   if(abs(d).lt.fpmin)d=fpmin<a name='324'>
   c=b+an/c<a name='325'>
 if(abs(c).lt.fpmin) c=fpmin<a name='326'>
   d=1./d<a name='327'>
   de1=d*c<a name='328'>
   h=h*de1<a name='329'>
   if(abs(de1-1.).lt.eps) goto 1<a name='330'>
 enddo<a name='331'>
1 gammcf=exp(-x+a*log(x)-gln)*h<a name='332'>
 return<a name='333'>
<a name='334'>
END SUBROUTINE cfg<a name='335'>
<font color=#447700>!======================================================================!<a name='336'></font>
<a name='337'>
<A NAME='GAMMINC'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#GAMMINC' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='338'>
 real <font color=#993300>FUNCTION </font><font color=#cc0000>gamminc</font>(p,xmax),<A href='../../call_from/GAMMINC.html' TARGET='index'>1</A><a name='339'>
<a name='340'>
<font color=#447700>! USES gammp, gammln<a name='341'></font>
<font color=#447700>! Returns incomplete gamma function, gamma(p,xmax)= P(p,xmax)*GAMMA(p)<a name='342'></font>
 real :: p,xmax<a name='343'>
 gamminc= <A href='../../html_code/phys/module_mp_thompson.F.html#GAMMP'>gammp</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#GAMMINC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMP_1">(p,xmax)*exp(gammln(p))<a name='344'>
<a name='345'>
 end FUNCTION gamminc<a name='346'>
<font color=#447700>!======================================================================!<a name='347'></font>
<a name='348'>
<A NAME='POLYSVP'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#POLYSVP' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='349'>
 real <font color=#993300>function </font><font color=#cc0000>polysvp</font>(T,TYPE) <A href='../../call_to/POLYSVP.html' TARGET='index'>27</A><a name='350'>
<a name='351'>
<font color=#447700>!--------------------------------------------------------------<a name='352'></font>
<font color=#447700>! Taken from 'module_mp_morr_two_moment.F' (WRFV3.4)<a name='353'></font>
<a name='354'>
<font color=#447700>!  COMPUTE SATURATION VAPOR PRESSURE<a name='355'></font>
<a name='356'>
<font color=#447700>!  POLYSVP RETURNED IN UNITS OF PA.<a name='357'></font>
<font color=#447700>!  T IS INPUT IN UNITS OF K.<a name='358'></font>
<font color=#447700>!  TYPE REFERS TO SATURATION WITH RESPECT TO LIQUID (0) OR ICE (1)<a name='359'></font>
<a name='360'>
<font color=#447700>! REPLACE GOFF-GRATCH WITH FASTER FORMULATION FROM FLATAU ET AL. 1992,<a name='361'></font>
<font color=#447700>! TABLE 4 (RIGHT-HAND COLUMN)<a name='362'></font>
<font color=#447700>!--------------------------------------------------------------<a name='363'></font>
<a name='364'>
      IMPLICIT NONE<a name='365'>
<a name='366'>
      REAL DUM<a name='367'>
      REAL T<a name='368'>
      INTEGER TYPE<a name='369'>
<font color=#447700>! ice<a name='370'></font>
      real a0i,a1i,a2i,a3i,a4i,a5i,a6i,a7i,a8i<a name='371'>
      data a0i,a1i,a2i,a3i,a4i,a5i,a6i,a7i,a8i /&amp;<a name='372'>
	6.11147274, 0.503160820, 0.188439774e-1, &amp;<a name='373'>
        0.420895665e-3, 0.615021634e-5,0.602588177e-7, &amp;<a name='374'>
        0.385852041e-9, 0.146898966e-11, 0.252751365e-14/<a name='375'>
<a name='376'>
<font color=#447700>! liquid<a name='377'></font>
      real a0,a1,a2,a3,a4,a5,a6,a7,a8<a name='378'>
<a name='379'>
<font color=#447700>! V1.7<a name='380'></font>
      data a0,a1,a2,a3,a4,a5,a6,a7,a8 /&amp;<a name='381'>
	6.11239921, 0.443987641, 0.142986287e-1, &amp;<a name='382'>
        0.264847430e-3, 0.302950461e-5, 0.206739458e-7, &amp;<a name='383'>
        0.640689451e-10,-0.952447341e-13,-0.976195544e-15/<a name='384'>
      real dt<a name='385'>
<a name='386'>
<font color=#447700>! ICE<a name='387'></font>
<a name='388'>
      IF (TYPE.EQ.1) THEN<a name='389'>
<a name='390'>
<font color=#447700>!         POLYSVP = 10.**(-9.09718*(273.16/T-1.)-3.56654*                &amp;<a name='391'></font>
<font color=#447700>!          LOG10(273.16/T)+0.876793*(1.-T/273.16)+						&amp;<a name='392'></font>
<font color=#447700>!          LOG10(6.1071))*100.<a name='393'></font>
<a name='394'>
<a name='395'>
      dt = max(-80.,t-273.16)<a name='396'>
      polysvp = a0i + dt*(a1i+dt*(a2i+dt*(a3i+dt*(a4i+dt*(a5i+dt*(a6i+dt*(a7i+a8i*dt)))))))<a name='397'>
      polysvp = polysvp*100.<a name='398'>
<a name='399'>
      END IF<a name='400'>
<a name='401'>
<font color=#447700>! LIQUID<a name='402'></font>
<a name='403'>
      IF (TYPE.EQ.0) THEN<a name='404'>
<a name='405'>
       dt = max(-80.,t-273.16)<a name='406'>
       polysvp = a0 + dt*(a1+dt*(a2+dt*(a3+dt*(a4+dt*(a5+dt*(a6+dt*(a7+a8*dt)))))))<a name='407'>
       polysvp = polysvp*100.<a name='408'>
<a name='409'>
<font color=#447700>!         POLYSVP = 10.**(-7.90298*(373.16/T-1.)+                        &amp;<a name='410'></font>
<font color=#447700>!             5.02808*LOG10(373.16/T)-									&amp;<a name='411'></font>
<font color=#447700>!             1.3816E-7*(10**(11.344*(1.-T/373.16))-1.)+				&amp;<a name='412'></font>
<font color=#447700>!             8.1328E-3*(10**(-3.49149*(373.16/T-1.))-1.)+				&amp;<a name='413'></font>
<font color=#447700>!             LOG10(1013.246))*100.<a name='414'></font>
<a name='415'>
         END IF<a name='416'>
<a name='417'>
 end function polysvp<a name='418'>
<a name='419'>
<font color=#447700>!==============================================================================!<a name='420'></font>
<A NAME='QSAT'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='421'>
 real <font color=#993300>function </font><font color=#cc0000>qsat</font>(temp,pres,wtype) <A href='../../call_to/QSAT.html' TARGET='index'>29</A>,<A href='../../call_from/QSAT.html' TARGET='index'>3</A><a name='422'>
<a name='423'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='424'></font>
<font color=#447700>! Returns the saturation mixing ratio [kg kg-1], as a function of temperature<a name='425'></font>
<font color=#447700>! pressure, with respect to liquid water [wtype=0] or ice [wtype=1], by calling<a name='426'></font>
<font color=#447700>! function POLYSVP to obtain the saturation vapor pressure.<a name='427'></font>
<a name='428'>
<font color=#447700>! 2013-08-06<a name='429'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='430'></font>
<a name='431'>
  implicit none<a name='432'>
<a name='433'>
 <font color=#447700>!Calling parameters:<a name='434'></font>
  real, intent(in)    :: temp     <font color=#447700>!temperature [K]<a name='435'></font>
  real, intent(in)    :: pres     <font color=#447700>!pressure    [Pa]<a name='436'></font>
  integer, intent(in) :: wtype    <font color=#447700>!0=liquid water; 1=ice<a name='437'></font>
<a name='438'>
 <font color=#447700>!Local variables:<a name='439'></font>
  real :: tmp1<a name='440'>
<a name='441'>
  tmp1 = <A href='../../html_code/phys/module_mp_morr_two_moment.F.html#POLYSVP'>polysvp</A><A href='../../html_code/phys/module_sf_lake.F.html#QSAT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLYSVP_27">(temp,wtype)       <font color=#447700>!esat [Pa], wrt liquid (Flatau formulation)<a name='442'></font>
  qsat = 0.622*tmp1/(pres-tmp1)<a name='443'>
<a name='444'>
  end function qsat<a name='445'>
<a name='446'>
<font color=#447700>!==============================================================================!<a name='447'></font>
<A NAME='CHECK_VALUES'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#CHECK_VALUES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='448'>
 <font color=#993300>subroutine </font><font color=#cc0000>check_values</font>(Qv,T,Qc,Qr,Qi,Qn,Qg,Qh,Nc,Nr,Ny,Nn,Ng,Nh,epsQ,epsN,     &amp; <A href='../../call_to/CHECK_VALUES.html' TARGET='index'>17</A><a name='449'>
                         check_consistency,force_abort,source_ind)<a name='450'>
<a name='451'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='452'></font>
<font color=#447700>! Checks current values of prognotic variables for reasonable values and<a name='453'></font>
<font color=#447700>! stops and prints values if they are out of specified allowable ranges.<a name='454'></font>
<font color=#447700>!<a name='455'></font>
<font color=#447700>! 'trapAll = 1' means include trap for inconsistency in hydrometeor moments;<a name='456'></font>
<font color=#447700>! otherwise, only trap for Q, T, and negative Qx, Nx.  This option is here<a name='457'></font>
<font color=#447700>! to allow for Q&lt;epsQ.and.N&gt;epsN or Q&gt;epsQ.and.N&lt;epsN which can be produced<a name='458'></font>
<font color=#447700>! at the leading edges due to sedimentation and whose values are accpetable<a name='459'></font>
<font color=#447700>! since Dmax is imposed in SEDI (so one does not necessarily want to trap<a name='460'></font>
<font color=#447700>! for inconsistency after sedimentation has been called).<a name='461'></font>
<font color=#447700>!<a name='462'></font>
<font color=#447700>! The value 'source_ind' indicates the approximate line number in 'my2_main'<a name='463'></font>
<font color=#447700>! from where 'check_values' was called before it resulted in a trap.<a name='464'></font>
<font color=#447700>!<a name='465'></font>
<font color=#447700>! 2013-06-21<a name='466'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='467'></font>
<a name='468'>
  implicit none<a name='469'>
<a name='470'>
 <font color=#447700>!Calling parameters:<a name='471'></font>
  real, dimension(:,:), intent(in) :: Qv,T,Qc,Qr,Qi,Qn,Qg,Qh,Nc,Nr,Ny,Nn,Ng,Nh<a name='472'>
  real, intent(in)                 :: epsQ,epsN<a name='473'>
  integer,              intent(in) :: source_ind<a name='474'>
  logical,              intent(in) :: force_abort         <font color=#447700>!.TRUE. = forces abort if value violation is detected<a name='475'></font>
  logical,              intent(in) :: check_consistency   <font color=#447700>!.TRUE. = check for sign consistency between Qx and Nx<a name='476'></font>
<a name='477'>
 <font color=#447700>!Local variables:<a name='478'></font>
  real, parameter :: T_low  = 173.<a name='479'>
  real, parameter :: T_high = 323.<a name='480'>
  real, parameter :: Q_high = 1.e-1<a name='481'>
  real, parameter :: N_high = 1.e+20<a name='482'>
  real            :: x_low<a name='483'>
  integer         :: i,k,ni,nk<a name='484'>
  logical         :: trap<a name='485'>
<a name='486'>
  if (source_ind == 100) then<a name='487'>
     x_low = -1.e+30          <font color=#447700>!for call at beginning of main<a name='488'></font>
  else<a name='489'>
     x_low = 0.<a name='490'>
  endif<a name='491'>
<a name='492'>
  ni = size(Qv,dim=1)<a name='493'>
  nk = size(Qv,dim=2)<a name='494'>
<a name='495'>
  trap = .false.<a name='496'>
  do k = 1,nk<a name='497'>
     do i = 1,ni<a name='498'>
<a name='499'>
        if (.not.(T(i,k)&gt;T_low .and. T(i,k)&lt;T_high)) then<a name='500'>
           print*,'** WARNING IN MICRO **'<a name='501'>
           print*,'** src,i,k,T: ',source_ind,i,k,T(i,k)<a name='502'>
           trap = .true.<a name='503'>
        endif<a name='504'>
        if (.not.(Qv(i,k)&gt;=0. .and. Qv(i,k)&lt;Q_high)) then<a name='505'>
           print*,'** WARNING IN MICRO **'<a name='506'>
           print*,'** src,i,k,Qv (HU): ',source_ind,i,k,Qv(i,k)<a name='507'>
        endif<a name='508'>
        <font color=#447700>!-- NAN check:<a name='509'></font>
        if (.not.(Qc(i,k)&gt;=x_low .and. Qc(i,k)&lt;Q_high .and.                               &amp;<a name='510'>
                  Qr(i,k)&gt;=x_low .and. Qr(i,k)&lt;Q_high .and.                               &amp;<a name='511'>
                  Qi(i,k)&gt;=x_low .and. Qi(i,k)&lt;Q_high .and.                               &amp;<a name='512'>
                  Qn(i,k)&gt;=x_low .and. Qn(i,k)&lt;Q_high .and.                               &amp;<a name='513'>
                  Qg(i,k)&gt;=x_low .and. Qg(i,k)&lt;Q_high .and.                               &amp;<a name='514'>
                  Qh(i,k)&gt;=x_low .and. Qh(i,k)&lt;Q_high  )) then<a name='515'>
           print*,'** WARNING IN MICRO **'<a name='516'>
           print*, '** src,i,k,Qc,Qr,Qi,Qn,Qg,Qh: ',source_ind,i,k,Qc(i,k),Qr(i,k),       &amp;<a name='517'>
                   Qi(i,k),Qn(i,k),Qg(i,k),Qh(i,k)  <a name='518'>
           trap = .true.<a name='519'>
        endif<a name='520'>
        if (.not.(Nc(i,k)&gt;=x_low .and. Nc(i,k)&lt;N_high .and.                               &amp;<a name='521'>
                  Nr(i,k)&gt;=x_low .and. Nr(i,k)&lt;N_high .and.                               &amp;<a name='522'>
                  Ny(i,k)&gt;=x_low .and. Ny(i,k)&lt;N_high .and.                               &amp;<a name='523'>
                  Nn(i,k)&gt;=x_low .and. Nn(i,k)&lt;N_high .and.                               &amp;<a name='524'>
                  Ng(i,k)&gt;=x_low .and. Ng(i,k)&lt;N_high .and.                               &amp;<a name='525'>
                  Nh(i,k)&gt;=x_low .and. Nh(i,k)&lt;N_high  )) then<a name='526'>
           print*,'** WARNING IN MICRO **'<a name='527'>
           print*, '** src,i,k,Nc,Nr,Ny,Nn,Ng,Nh: ',source_ind,i,k,Nc(i,k),Nr(i,k),       &amp;<a name='528'>
                  Ny(i,k),Nn(i,k),Ng(i,k),Nh(i,k)<a name='529'>
           trap = .true.<a name='530'>
        endif<a name='531'>
        <font color=#447700>!==<a name='532'></font>
        if (check_consistency) then<a name='533'>
           if ((Qc(i,k)&gt;epsQ.and.Nc(i,k)&lt;epsN) .or. (Qc(i,k)&lt;epsQ.and.Nc(i,k)&gt;epsN)) then<a name='534'>
              print*,'** WARNING IN MICRO **'<a name='535'>
              print*, '** src,i,k,Qc,Nc: ',source_ind,i,k,Qc(i,k),Nc(i,k)<a name='536'>
              trap = .true.<a name='537'>
           endif<a name='538'>
           if ((Qr(i,k)&gt;epsQ.and.Nr(i,k)&lt;epsN) .or. (Qr(i,k)&lt;epsQ.and.Nr(i,k)&gt;epsN)) then<a name='539'>
              print*,'** WARNING IN MICRO **'<a name='540'>
              print*, '** src,i,k,Qr,Nr: ',source_ind,i,k,Qr(i,k),Nr(i,k)<a name='541'>
              trap = .true.<a name='542'>
           endif<a name='543'>
           if ((Qi(i,k)&gt;epsQ.and.Ny(i,k)&lt;epsN) .or. (Qi(i,k)&lt;epsQ.and.Ny(i,k)&gt;epsN)) then<a name='544'>
              print*,'** WARNING IN MICRO **'<a name='545'>
              print*, '** src,i,k,Qi,Ny: ',source_ind,i,k,Qi(i,k),Ny(i,k)<a name='546'>
              trap = .true.<a name='547'>
           endif<a name='548'>
           if ((Qn(i,k)&gt;epsQ.and.Nn(i,k)&lt;epsN) .or. (Qn(i,k)&lt;epsQ.and.Nn(i,k)&gt;epsN)) then<a name='549'>
              print*,'** WARNING IN MICRO **'<a name='550'>
              print*, '** src,i,k,Qn,Nn: ',source_ind,i,k,Qn(i,k),Nn(i,k)<a name='551'>
              trap = .true.<a name='552'>
           endif<a name='553'>
           if ((Qg(i,k)&gt;epsQ.and.Ng(i,k)&lt;epsN) .or. (Qg(i,k)&lt;epsQ.and.Ng(i,k)&gt;epsN)) then<a name='554'>
              print*,'** WARNING IN MICRO **'<a name='555'>
              print*, '** src,i,k,Qg,Ng: ',source_ind,i,k,Qg(i,k),Ng(i,k)<a name='556'>
              trap = .true.<a name='557'>
           endif<a name='558'>
           if ((Qh(i,k)&gt;epsQ.and.Nh(i,k)&lt;epsN) .or. (Qh(i,k)&lt;epsQ.and.Nh(i,k)&gt;epsN)) then<a name='559'>
              print*,'** WARNING IN MICRO **'<a name='560'>
              print*, '** src,i,k,Qh,Nh: ',source_ind,i,k,Qh(i,k),Nh(i,k)<a name='561'>
              trap = .true.<a name='562'>
           endif<a name='563'>
        endif <font color=#447700>!if (check_consistency)<a name='564'></font>
     enddo<a name='565'>
  enddo<a name='566'>
<a name='567'>
  if (trap .and. force_abort) then<a name='568'>
     print*,'** DEBUG TRAP IN MICRO, s/r CHECK_VALUES -- source: ',source_ind<a name='569'>
     if (source_ind/=100) stop<a name='570'>
  endif<a name='571'>
<a name='572'>
 end subroutine check_values<a name='573'>
<a name='574'>
<a name='575'>
<font color=#447700>!=====================================================================================!<a name='576'></font>
<A NAME='SEDI_WRAPPER_2'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_WRAPPER_2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='577'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>sedi_wrapper_2</font>(QX,NX,cat,epsQ,epsQ_sedi,epsN,dmx,ni,VxMax,DxMax,dt,     &amp; <A href='../../call_to/SEDI_WRAPPER_2.html' TARGET='index'>5</A>,<A href='../../call_from/SEDI_WRAPPER_2.html' TARGET='index'>2</A><a name='578'>
                massFlux_bot,kdir,kbot,ktop_sedi,GRAV,zheight,nk,DE,iDE,iDP,         &amp;<a name='579'>
                DZ,iDZ,gamfact,kount,afx_in,bfx_in,cmx_in,ckQx1_in,ckQx2_in,ckQx4_in)<a name='580'>
<a name='581'>
<font color=#447700>!-------------------------------------------------------------------------------------!<a name='582'></font>
<font color=#447700>!  Wrapper for s/r SEDI, for computation on all vertical levels.  Called from MY2_MAIN.<a name='583'></font>
<font color=#447700>!-------------------------------------------------------------------------------------!<a name='584'></font>
<a name='585'>
  implicit none<a name='586'>
<a name='587'>
<font color=#447700>! PASSING PARAMETERS:<a name='588'></font>
  real, dimension(:,:), intent(inout) :: QX,NX<a name='589'>
  real, dimension(:),   intent(out)   :: massFlux_bot<a name='590'>
  real, dimension(:,:), intent(in)    :: zheight, DE,iDE,iDP,DZ,iDZ,gamfact<a name='591'>
  real, intent(in)                    :: epsQ,epsQ_sedi,epsN,VxMax,dmx,DxMax,dt,GRAV<a name='592'>
  real, intent(in), optional          :: afx_in,bfx_in,cmx_in,ckQx1_in,ckQx2_in,ckQx4_in<a name='593'>
  integer, dimension(:), intent(in)   :: ktop_sedi<a name='594'>
  integer, intent(in)                 :: ni,cat,kbot,kdir,nk,kount<a name='595'>
<a name='596'>
<font color=#447700>! LOCAL VARIABLES:<a name='597'></font>
  integer, dimension(size(QX,dim=1))  :: activeColumn,ktop<a name='598'>
  integer                             :: counter<a name='599'>
  integer                             :: a,i,k<a name='600'>
<a name='601'>
<a name='602'>
   massFlux_bot = 0.<a name='603'>
<a name='604'>
   ktop = ktop_sedi  <font color=#447700>!(i-array)  - for complete column, ktop(:)=1 (GEM) or =nk (WRF)<a name='605'></font>
   call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#COUNT_COLUMNS'>count_columns</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_WRAPPER_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUNT_COLUMNS_1">(QX,ni,epsQ_sedi,counter,activeColumn,kdir,kbot,ktop)<a name='606'>
<a name='607'>
   DO a = 1,counter<a name='608'>
      i= activeColumn(a)<a name='609'>
     <font color=#447700>!From here, all sedi calcs are done for each column i<a name='610'></font>
<a name='611'>
      call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_1D'>sedi_1D</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_WRAPPER_2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEDI_1D_1">(QX(i,:),NX(i,:),cat,DE(i,:),iDE(i,:),iDP(i,:),gamfact(i,:),epsQ,epsN,  &amp;<a name='612'>
                   dmx,VxMax,DxMax,dt,DZ(i,:),iDZ(i,:),massFlux_bot(i),kdir,kbot,ktop(i), &amp;<a name='613'>
                   GRAV,afx_in=afx_in,bfx_in=bfx_in,cmx_in=cmx_in,ckQx1_in=ckQx1_in,      &amp;<a name='614'>
                   ckQx2_in=ckQx2_in,ckQx4_in=ckQx4_in)<a name='615'>
<a name='616'>
   ENDDO  <font color=#447700>!a-loop<a name='617'></font>
<a name='618'>
 END SUBROUTINE sedi_wrapper_2<a name='619'>
<a name='620'>
<font color=#447700>!=====================================================================================!<a name='621'></font>
<A NAME='SEDI_1D'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='622'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>sedi_1D</font>(QX1d,NX1d,cat,DE1d,iDE1d,iDP1d,gamfact1d,epsQ,epsN,dmx,VxMax,DxMax,    &amp; <A href='../../call_to/SEDI_1D.html' TARGET='index'>1</A>,<A href='../../call_from/SEDI_1D.html' TARGET='index'>1</A><a name='623'>
                    dt,DZ1d,iDZ1d,massFlux_bot,kdir,kbot,ktop,GRAV,afx_in,bfx_in,cmx_in,  &amp;<a name='624'>
                    ckQx1_in,ckQx2_in,ckQx4_in,BX1d,epsB)<a name='625'>
<a name='626'>
  implicit none<a name='627'>
<a name='628'>
<font color=#447700>! PASSING PARAMETERS:<a name='629'></font>
  real, dimension(:),  intent(inout), optional :: BX1d<a name='630'>
  real, dimension(:),  intent(inout) :: QX1d,NX1d<a name='631'>
  real, dimension(:),  intent(in)    :: gamfact1d<a name='632'>
  real,                intent(out)   :: massFlux_bot<a name='633'>
  real, dimension(:),  intent(in)    :: DE1d,iDE1d,iDP1d,DZ1d,iDZ1d<a name='634'>
  real,                intent(in)    :: epsQ,epsN,VxMax,dmx,DxMax,dt,GRAV<a name='635'>
  real, optional,      intent(in)    :: afx_in,bfx_in,cmx_in,ckQx1_in,ckQx2_in,          &amp;<a name='636'>
                                        ckQx4_in,epsB<a name='637'>
  integer,             intent(in)    :: cat,kbot,kdir<a name='638'>
  integer,             intent(in)    :: ktop<a name='639'>
<a name='640'>
<font color=#447700>! LOCAL PARAMETERS:<a name='641'></font>
  integer                            :: npassx<a name='642'>
  real, dimension(size(QX1d,dim=1))  :: VVQ,VVN<a name='643'>
  real                               :: dzMIN,dtx,VxMaxx<a name='644'>
  logical                            :: firstPass,QxPresent,BX_present<a name='645'>
  integer                            :: nnn,i,k,l,km1,kp1,idzmin,kk<a name='646'>
  real                               :: VqMax,VnMax,iLAMx,iLAMxB0,tmp1,tmp2,tmp3,Dx,     &amp;<a name='647'>
                                        iDxMax,icmx,VincFact,ratio_Vn2Vq,zmax_Q,zmax_N,  &amp;<a name='648'>
                                        idmx<a name='649'>
  real                               :: alpha_x,afx,bfx,cmx,ckQx1,ckQx2,ckQx4<a name='650'>
<a name='651'>
  real, parameter :: thrd    = 1./3.<a name='652'>
  real, parameter :: sxth    = 1./6.<a name='653'>
<font color=#447700>! real, parameter :: CoMAX   = 0.5  !0.8<a name='654'></font>
  real, parameter :: CoMAX   = 0.8<a name='655'>
  real, parameter :: PIov6   = 3.14159265*sxth<a name='656'>
<font color=#447700>!-------------------------------------------------------------------------------------!<a name='657'></font>
<a name='658'>
   BX_present = present(BX1d)<a name='659'>
<a name='660'>
  <font color=#447700>!for rain, ice, snow, hail:<a name='661'></font>
<font color=#447700>! !    if (.not. (cat==4 .and. BX_present)) then<a name='662'></font>
      afx   = afx_in<a name='663'>
      bfx   = bfx_in<a name='664'>
      cmx   = cmx_in<a name='665'>
      icmx  = 1./cmx<a name='666'>
      ckQx1 = ckQx1_in<a name='667'>
      ckQx2 = ckQx2_in<a name='668'>
      ckQx4 = ckQx4_in<a name='669'>
      ratio_Vn2Vq  = ckQx2/ckQx1<a name='670'>
<font color=#447700>! !    endif<a name='671'></font>
<a name='672'>
   massFlux_bot = 0.<a name='673'>
   iDxMax = 1./DxMax<a name='674'>
   idmx   = 1./dmx<a name='675'>
   VVQ    = 0.<a name='676'>
   VVN    = 0.<a name='677'>
   VqMax  = 0.<a name='678'>
   VnMax  = 0.<a name='679'>
   VVQ(:) = 0.<a name='680'>
<a name='681'>
      do k= kbot,ktop,kdir<a name='682'>
         QxPresent =  (QX1d(k)&gt;epsQ .and. NX1d(k)&gt;epsN)<a name='683'>
         if (QxPresent) VVQ(k)= <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#VV_Q'>VV_Q</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VV_Q_1">()<a name='684'>
      enddo<a name='685'>
<a name='686'>
   Vxmaxx= min( VxMax, maxval(VVQ(:)))<a name='687'>
   if (kdir==1) then<a name='688'>
      dzMIN = minval(DZ1d)  <font color=#447700>!WRF (to be tested)<a name='689'></font>
   else<a name='690'>
      dzMIN = minval(DZ1d(ktop:kbot+kdir))  <font color=#447700>!GEM<a name='691'></font>
   endif<a name='692'>
   npassx= max(1, nint( dt*Vxmaxx/(CoMAX*dzMIN) ))<a name='693'>
<a name='694'>
<a name='695'>
   dtx   = dt/float(npassx)<a name='696'>
<a name='697'>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -!<a name='698'></font>
   DO nnn= 1,npassx<a name='699'>
<a name='700'>
      firstPass = (nnn==1)<a name='701'>
      do k= kbot,ktop,kdir<a name='702'>
         QxPresent  = (QX1d(k)&gt;epsQ .and. NX1d(k)&gt;epsN)<a name='703'>
         if (QxPresent) then<a name='704'>
            if (firstPass) then     <font color=#447700>!to avoid re-computing VVQ on first pass<a name='705'></font>
               VVQ(k)= -VVQ(k)<a name='706'>
            else<a name='707'>
               VVQ(k)= -VV_Q()<a name='708'>
            endif<a name='709'>
           <font color=#447700>!--<a name='710'></font>
           <font color=#447700>!control excessive size-sorting for hail:<a name='711'></font>
            if (cat==5) then<a name='712'>
               tmp1 = (icmx*QX1d(k)/NX1d(k))**thrd   <font color=#447700>!Dmh<a name='713'></font>
               tmp2 = min(50., 0.1*(1000.*tmp1))     <font color=#447700>!mu = const*Dmh [mm]<a name='714'></font>
               ratio_Vn2Vq = ((3.+tmp2)*(2.+tmp2)*(1.+tmp2))/((3.+bfx+tmp2)*             &amp;<a name='715'>
                              (2.+bfx+tmp2)*(1.+bfx+tmp2))<a name='716'>
            endif<a name='717'>
           <font color=#447700>!==<a name='718'></font>
            VVN(k) = VVQ(k)*ratio_Vn2Vq<a name='719'>
            VqMax  = max(VxMAX,-VVQ(k))<a name='720'>
            VnMax  = max(VxMAX,-VVN(k))<a name='721'>
         else<a name='722'>
            VVQ(k) = 0.<a name='723'>
            VVN(k) = 0.<a name='724'>
            VqMax  = 0.<a name='725'>
            VnMax  = 0.<a name='726'>
         endif<a name='727'>
      enddo  <font color=#447700>!k-loop<a name='728'></font>
<a name='729'>
      massFlux_bot= massFlux_bot - VVQ(kbot)*DE1d(kbot)*QX1d(kbot)<a name='730'>
      do k= kbot,ktop,kdir<a name='731'>
         QX1d(k)= QX1d(k) + dtx*iDE1d(k)*(-DE1d(k+kdir)*QX1d(k+kdir)*VVQ(k+kdir) +       &amp;<a name='732'>
                            DE1d(k)*QX1d(k)*VVQ(k))*iDZ1d(k+kdir)<a name='733'>
         NX1d(k)= NX1d(k) + dtx*(-NX1d(k+kdir)*VVN(k+kdir) + NX1d(k)*VVN(k))*iDZ1d(k+kdir)<a name='734'>
         QX1d(k) = max( QX1d(k), 0.)<a name='735'>
         NX1d(k) = max( NX1d(k), 0.)<a name='736'>
      enddo<a name='737'>
     <font color=#447700>!<a name='738'></font>
      if (BX_present) then<a name='739'>
       do k= kbot,ktop,kdir<a name='740'>
         BX1d(k)= BX1d(k) + dtx*iDE1d(k)*(-DE1d(k+kdir)*BX1d(k+kdir)*VVQ(k+kdir) +       &amp;<a name='741'>
                            DE1d(k)*BX1d(k)*VVQ(k))*iDZ1d(k+kdir)<a name='742'>
         BX1d(k) = max( BX1d(k), 0.)<a name='743'>
       enddo<a name='744'>
      endif<a name='745'>
     <font color=#447700>!--<a name='746'></font>
<a name='747'>
      do k= kbot,ktop,kdir<a name='748'>
<a name='749'>
        <font color=#447700>!Prescribe NX if QX&gt;0.and.NX=0:<a name='750'></font>
        if (QX1d(k)&gt;epsQ .and. NX1d(k)&lt;epsN) then<a name='751'>
           <font color=#447700>!determine first level above with NX&gt;epsN<a name='752'></font>
           do kk = k+kdir,ktop,kdir<a name='753'>
              <font color=#447700>!note: the following condition should normally be satisfied immediately;<a name='754'></font>
              <font color=#447700>!      that is, the next level up should contain NX&gt;epsN<a name='755'></font>
              if (NX1d(kk)&gt;=epsN) exit<a name='756'>
           enddo<a name='757'>
          <font color=#447700>!prescribe new NX:<a name='758'></font>
          <font color=#447700>!  note: if no kk with NX&gt;epsN found [i.e. if kk=ktop at this point] then<a name='759'></font>
          <font color=#447700>!        epsN is prescribed; this will then be modified via size-limiter below<a name='760'></font>
           NX1d(k) = max(epsN,NX1d(kk))<a name='761'>
        endif<a name='762'>
<a name='763'>
        <font color=#447700>!Impose size-limiter / drop-breakup:<a name='764'></font>
        if (QX1d(k)&gt;epsQ .and. NX1d(k)&gt;epsN) then<a name='765'>
           Dx= (DE1d(k)*QX1d(k)/(NX1d(k)*cmx))**idmx<a name='766'>
           if (cat==1 .and. Dx&gt;3.e-3) then<a name='767'>
              NX1d(k)= NX1d(k)*max((1.+2.e4*(Dx-3.e-3)**2),(Dx*iDxMAX)**3)<a name='768'>
           else<a name='769'>
              NX1d(k)= NX1d(k)*(max(Dx,DxMAX)*iDxMAX)**dmx   <font color=#447700>!impose Dx_max<a name='770'></font>
           endif<a name='771'>
        endif<a name='772'>
<a name='773'>
      enddo<a name='774'>
<a name='775'>
   ENDDO  <font color=#447700>!nnn-loop<a name='776'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -!<a name='777'></font>
  <font color=#447700>!Compute average mass flux during the full time step: (used to compute the<a name='778'></font>
  <font color=#447700>!instantaneous sedimentation rate [liq. equiv. volume flux] in the main s/r)<a name='779'></font>
   massFlux_bot= massFlux_bot/float(npassx)<a name='780'>
<a name='781'>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -!<a name='782'></font>
<a name='783'>
   CONTAINS<a name='784'>
<a name='785'>
<A NAME='VV_Q'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#VV_Q' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='786'>
   real <font color=#993300>function </font><font color=#cc0000>VV_Q</font>() <A href='../../call_to/VV_Q.html' TARGET='index'>1</A><a name='787'>
   <font color=#447700>!Calculates Q-weighted fall velocity<a name='788'></font>
      iLAMx   = ((QX1d(k)*DE1d(k)/NX1d(k))*ckQx4)**idmx<a name='789'>
      iLAMxB0 = iLAMx**bfx<a name='790'>
      VV_Q    = gamfact1d(k)*iLAMxB0*ckQx1<a name='791'>
   end function VV_Q<a name='792'>
<a name='793'>
<A NAME='VV_QG'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#VV_QG' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='794'>
   real <font color=#993300>function </font><font color=#cc0000>VV_Qg</font>()<a name='795'>
   <font color=#447700>!Calculates Q-weighted fall velocity<a name='796'></font>
<font color=#447700>!     iLAMx is already computed in 'calc_grpl_params' (for graupel only)<a name='797'></font>
      iLAMxB0 = iLAMx**bfx<a name='798'>
      VV_Qg   = gamfact1d(k)*iLAMxB0*ckQx1<a name='799'>
   end function VV_Qg<a name='800'>
<a name='801'>
 END SUBROUTINE sedi_1D<a name='802'>
<a name='803'>
<font color=#447700>!=====================================================================================!<a name='804'></font>
<A NAME='COUNT_COLUMNS'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#COUNT_COLUMNS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='805'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>count_columns</font>(QX,ni,minQX,counter,activeColumn,kdir,kbot,ktop) <A href='../../call_to/COUNT_COLUMNS.html' TARGET='index'>1</A><a name='806'>
<a name='807'>
 <font color=#447700>!--------------------------------------------------------------------------<a name='808'></font>
 <font color=#447700>! Searches the hydrometeor array QX(ni,nk) for non-zero (&gt;minQX) values.<a name='809'></font>
 <font color=#447700>! Returns the array if i-indices (activeColumn) for the column indices (i) which<a name='810'></font>
 <font color=#447700>! contain at least one non-zero value, the number of such columns (counter),<a name='811'></font>
 <font color=#447700>! and the k-indices of the maximum level to compute sedimentation.<a name='812'></font>
 <font color=#447700>!--------------------------------------------------------------------------<a name='813'></font>
<a name='814'>
  implicit none<a name='815'>
<a name='816'>
<font color=#447700>!PASSING PARAMETERS:<a name='817'></font>
  real,    dimension(:,:),intent(in)   :: QX            <font color=#447700>! mixing ratio<a name='818'></font>
  real,    intent(in)                  :: minQX         <font color=#447700>! mixing ratio threshold<a name='819'></font>
  integer, intent(in)                  :: ni            <font color=#447700>! total number of columns (input)<a name='820'></font>
  integer, intent(in)                  :: kbot          <font color=#447700>! k index of lowest level<a name='821'></font>
  integer, intent(in)                  :: kdir          <font color=#447700>! -1 of k=1 is top (GEM); 1 if k=1 is bottom (WRF)<a name='822'></font>
  integer, dimension(:),  intent(inout):: ktop          <font color=#447700>! IN: array of highest level to look at; OUT: array of highest level with QX&gt;epsQ<a name='823'></font>
  integer,                intent(out)  :: counter       <font color=#447700>! number of columns containing at least one QX&gt;epsQ<a name='824'></font>
  integer, dimension(:),  intent(out)  :: activeColumn  <font color=#447700>! array of i-indices with columns containing at least one QX&gt;epsQ<a name='825'></font>
<a name='826'>
<font color=#447700>!LOCAL PARAMETERS:<a name='827'></font>
  integer                              :: i<a name='828'>
  integer, dimension(size(QX,dim=1))   :: k<a name='829'>
<a name='830'>
   counter       = 0<a name='831'>
   activeColumn  = 0<a name='832'>
<a name='833'>
 <font color=#447700>!Note:  k_top(i) must be at least one level higher than the level with non-zero Qx<a name='834'></font>
<a name='835'>
   do i=1,ni<a name='836'>
      k(i)= ktop(i)<a name='837'>
      do<a name='838'>
         k(i)=k(i)-kdir               <font color=#447700>!step 1 level downward (towards lowest-level k)<a name='839'></font>
         if (QX(i,k(i))&gt;minQX) then<a name='840'>
            counter=counter+1<a name='841'>
            activeColumn(counter)=i<a name='842'>
            ktop(i)= k(i)             <font color=#447700>!set ktop(k) to highest level with QX&gt;minQX<a name='843'></font>
            exit<a name='844'>
         else<a name='845'>
            if (k(i)==kbot) then<a name='846'>
               ktop(i) = kbot<a name='847'>
               exit<a name='848'>
            endif<a name='849'>
         endif<a name='850'>
      enddo<a name='851'>
   enddo<a name='852'>
<a name='853'>
 END SUBROUTINE count_columns<a name='854'>
<font color=#447700>!=======================================================================================!<a name='855'></font>
<a name='856'>
<font color=#447700>!_______________________________________________________________________________________!<a name='857'></font>
<a name='858'>
<A NAME='MP_MILBRANDT2MOM_MAIN'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='859'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>mp_milbrandt2mom_main</font>(WZ,T,Q,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,PS,          &amp; <A href='../../call_to/MP_MILBRANDT2MOM_MAIN.html' TARGET='index'>1</A>,<A href='../../call_from/MP_MILBRANDT2MOM_MAIN.html' TARGET='index'>117</A><a name='860'>
     sigma,RT_rn1,RT_rn2,RT_fr1,RT_fr2,RT_sn1,RT_sn2,RT_sn3,RT_pe1,RT_pe2,RT_peL,RT_snd,  &amp;<a name='861'>
     dt,NI,NK,J,KOUNT,CCNtype,precipDiag_ON,sedi_ON,warmphase_ON,autoconv_ON,icephase_ON, &amp;<a name='862'>
     snow_ON,Dm_c,Dm_r,Dm_i,Dm_s,Dm_g,Dm_h,ZET,ZEC,SS,nk_bottom)<a name='863'>
<a name='864'>
  implicit none<a name='865'>
<a name='866'>
<font color=#447700>!CALLING PARAMETERS:<a name='867'></font>
  integer,               intent(in)    :: NI,NK,J,KOUNT,CCNtype<a name='868'>
  real,                  intent(in)    :: dt<a name='869'>
  real, dimension(:),    intent(in)    :: PS<a name='870'>
  real, dimension(:),    intent(out)   :: RT_rn1,RT_rn2,RT_fr1,RT_fr2,RT_sn1,RT_sn2,     &amp;<a name='871'>
                                          RT_sn3,RT_pe1,RT_pe2,RT_peL,ZEC,RT_snd<a name='872'>
  real, dimension(:,:),  intent(in)    :: WZ,sigma<a name='873'>
  real, dimension(:,:),  intent(inout) :: T,Q,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH<a name='874'>
  real, dimension(:,:),  intent(out)   :: ZET,Dm_c,Dm_r,Dm_i,Dm_s,Dm_g,Dm_h<a name='875'>
  real, dimension(:,:,:),intent(out)   :: SS<a name='876'>
  logical,               intent(in)    :: precipDiag_ON,sedi_ON,icephase_ON,snow_ON,     &amp;<a name='877'>
                                          warmphase_ON,autoconv_ON,nk_BOTTOM<a name='878'>
<a name='879'>
<font color=#447700>!_______________________________________________________________________________________<a name='880'></font>
<font color=#447700>!                                                                                       !<a name='881'></font>
<font color=#447700>!                    Milbrandt-Yau Multimoment Bulk Microphysics Scheme                 !<a name='882'></font>
<font color=#447700>!                              - double-moment version   -                              !<a name='883'></font>
<font color=#447700>!_______________________________________________________________________________________!<a name='884'></font>
<font color=#447700>!<a name='885'></font>
<font color=#447700>!  Author:<a name='886'></font>
<font color=#447700>!       J. Milbrandt, McGill University (August 2004)<a name='887'></font>
<font color=#447700>!<a name='888'></font>
<font color=#447700>!  Major revisions:<a name='889'></font>
<font color=#447700>!<a name='890'></font>
<font color=#447700>!  001  J. Milbrandt  (Dec 2006) - Converted the full Milbrandt-Yau (2005) multimoment<a name='891'></font>
<font color=#447700>!        (RPN)                     scheme to an efficient fixed-dispersion double-moment<a name='892'></font>
<font color=#447700>!                                  version<a name='893'></font>
<font color=#447700>!  002  J. Milbrandt  (Mar 2007) - Added options for single-moment/double-moment for<a name='894'></font>
<font color=#447700>!                                  each hydrometeor category<a name='895'></font>
<font color=#447700>!  003  J. Milbrandt  (Feb 2008) - Modified single-moment version for use in GEM-LAM-2.5<a name='896'></font>
<font color=#447700>!  004  J. Milbrandt  (Nov 2008) - Modified double-moment version for use in 2010 Vancouver<a name='897'></font>
<font color=#447700>!                                  Olympics GEM-LAM configuration<a name='898'></font>
<font color=#447700>!  005  J. Milbrandt  (Aug 2009) - Modified (dmom) for PHY_v5.0.4, for use in V2010 system:<a name='899'></font>
<font color=#447700>!                                  + reduced ice/snow capacitance to C=0.25D (from C=0.5D)<a name='900'></font>
<font color=#447700>!                                  + added diagnostic fields (VIS, levels, etc.)<a name='901'></font>
<font color=#447700>!                                  + added constraints to snow size distribution (No_s and<a name='902'></font>
<font color=#447700>!                                    LAMDA_s limits, plus changed m-D parameters<a name='903'></font>
<font color=#447700>!                                  + modified solid-to-liquid ratio calculation, based on<a name='904'></font>
<font color=#447700>!                                    volume flux (and other changes)<a name='905'></font>
<font color=#447700>!                                  + added back sedimentation of ice category<a name='906'></font>
<font color=#447700>!                                  + modified condition for conversion of graupel to hail<a name='907'></font>
<font color=#447700>!                                  + corrected bug it diagnostic "ice pellets" vs. "hail"<a name='908'></font>
<font color=#447700>!                                  + minor bug corrections (uninitialized values, etc.)<a name='909'></font>
<font color=#447700>!  006  J. Milbrandt  (Jan 2011) - Bug fixes and minor code clean-up from PHY_v5.1.3 version<a name='910'></font>
<font color=#447700>!                                  + corrected latent heat constants in thermodynamic functions<a name='911'></font>
<font color=#447700>!                                    (ABi and ABw) for sublimation and evaporation<a name='912'></font>
<font color=#447700>!                                  + properly initialized variables No_g and No_h<a name='913'></font>
<font color=#447700>!                                  + changed max ice crystal size (fallspeed) to 5 mm (2 m s-1)<a name='914'></font>
<font color=#447700>!                                  + imposed maximum ice number concentration of 1.e+7 m-3<a name='915'></font>
<font color=#447700>!                                  + removed unused supersaturation reduction<a name='916'></font>
<font color=#447700>!<a name='917'></font>
<font color=#447700>!  Object:<a name='918'></font>
<font color=#447700>!          Computes changes to the temperature, water vapor mixing ratio, and the<a name='919'></font>
<font color=#447700>!          mixing ratios and total number concentrations of six hydrometeor species<a name='920'></font>
<font color=#447700>!          resulting from cloud microphysical interactions at saturated grid points.<a name='921'></font>
<font color=#447700>!          Liquid and solid surface precipitation rates from sedimenting hydrometeor<a name='922'></font>
<font color=#447700>!          categories are also computed.<a name='923'></font>
<font color=#447700>!<a name='924'></font>
<font color=#447700>!          This subroutine and the associated modules form the single/double-moment<a name='925'></font>
<font color=#447700>!          switchable verion of the multimoment bulk microphysics package, the full<a name='926'></font>
<font color=#447700>!          version of which is described in the references below.<a name='927'></font>
<font color=#447700>!<a name='928'></font>
<font color=#447700>!  References:  Milbrandt and Yau, (2005a), J. Atmos. Sci., vol.62, 3051-3064<a name='929'></font>
<font color=#447700>!               --------- and ---, (2005b), J. Atmos. Sci., vol.62, 3065-3081<a name='930'></font>
<font color=#447700>!               (and references therein)<a name='931'></font>
<font color=#447700>!<a name='932'></font>
<font color=#447700>!  Please report bugs to:  jason.milbrandt@ec.gc.ca<a name='933'></font>
<font color=#447700>!_______________________________________________________________________________________!<a name='934'></font>
<font color=#447700>!<a name='935'></font>
<font color=#447700>! Arguments:         Description:                                         Units:<a name='936'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -!<a name='937'></font>
<font color=#447700>!            - Input -<a name='938'></font>
<font color=#447700>!<a name='939'></font>
<font color=#447700>! NI                 number of x-dir points (in local subdomain)<a name='940'></font>
<font color=#447700>! NK                 number of vertical levels<a name='941'></font>
<font color=#447700>! N                  not used (to be removed)<a name='942'></font>
<font color=#447700>! J                  y-dir index (local subdomain)<a name='943'></font>
<font color=#447700>! KOUNT              current model time step number<a name='944'></font>
<font color=#447700>! dt                 model time step                                      [s]<a name='945'></font>
<font color=#447700>! CCNtype            switch for airmass type<a name='946'></font>
<font color=#447700>!                      1 = maritime                   --&gt; N_c =  80 cm-3  (1-moment cloud)<a name='947'></font>
<font color=#447700>!                      2 = continental 1              --&gt; N_c = 200 cm-3     "       "<a name='948'></font>
<font color=#447700>!                      3 = continental 2  (polluted)  --&gt; N_c = 500 cm-3     "       "<a name='949'></font>
<font color=#447700>!                      4 = land-sea-mask-dependent (TBA)<a name='950'></font>
<font color=#447700>! WZ                 vertical velocity                                    [m s-1]<a name='951'></font>
<font color=#447700>! sigma              sigma = p/p_sfc<a name='952'></font>
<font color=#447700>! precipDiag_ON      logical switch, .F. to suppress calc. of sfc precip types<a name='953'></font>
<font color=#447700>! sedi_ON            logical switch, .F. to suppress sedimentation<a name='954'></font>
<font color=#447700>! warmphase_ON       logical switch, .F. to suppress warm-phase (Part II)<a name='955'></font>
<font color=#447700>! autoconv_ON        logical switch, .F. to supppress autoconversion (cld-&gt;rn)<a name='956'></font>
<font color=#447700>! icephase_ON        logical switch, .F. to suppress ice-phase (Part I)<a name='957'></font>
<font color=#447700>! snow_ON            logical switch, .F. to suppress snow initiation<a name='958'></font>
<font color=#447700>! nk_BOTTOM          logical switch, .T. for  nk at bottom (GEM, 1dkin); .F. for nk at top (WRF, 2dkin)<a name='959'></font>
<font color=#447700>!<a name='960'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -!<a name='961'></font>
<font color=#447700>!            - Input/Output -<a name='962'></font>
<font color=#447700>!<a name='963'></font>
<font color=#447700>! T                  air temperature at time (t*)                         [K]<a name='964'></font>
<font color=#447700>! Q                  water vapor mixing ratio at (t*)                     [kg kg-1]<a name='965'></font>
<font color=#447700>! PS                 surface pressure at time (t*)                        [Pa]<a name='966'></font>
<font color=#447700>!<a name='967'></font>
<font color=#447700>!  For x = (C,R,I,N,G,H):  C = cloud<a name='968'></font>
<font color=#447700>!                          R = rain<a name='969'></font>
<font color=#447700>!                          I = ice (pristine) [except 'NY', not 'NI']<a name='970'></font>
<font color=#447700>!                          N = snow<a name='971'></font>
<font color=#447700>!                          G = graupel<a name='972'></font>
<font color=#447700>!                          H = hail<a name='973'></font>
<font color=#447700>!<a name='974'></font>
<font color=#447700>! Q(x)               mixing ratio for hydrometeor x at (t*)               [kg kg-1]<a name='975'></font>
<font color=#447700>! N(x)               total number concentration for hydrometeor x  (t*)   [m-3]<a name='976'></font>
<font color=#447700>!<a name='977'></font>
<font color=#447700>!- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -!<a name='978'></font>
<font color=#447700>!            - Output -<a name='979'></font>
<font color=#447700>!<a name='980'></font>
<font color=#447700>! Dm_(x)             mean-mass diameter for hydrometeor x                 [m]<a name='981'></font>
<font color=#447700>! RT_rn1             precipitation rate (at sfc) of liquid rain           [m+3 m-2 s-1]<a name='982'></font>
<font color=#447700>! RT_rn2             precipitation rate (at sfc) of liquid drizzle        [m+3 m-2 s-1]<a name='983'></font>
<font color=#447700>! RT_fr1             precipitation rate (at sfc) of freezing rain         [m+3 m-2 s-1]<a name='984'></font>
<font color=#447700>! RT_fr2             precipitation rate (at sfc) of freezing drizzle      [m+3 m-2 s-1]<a name='985'></font>
<font color=#447700>! RT_sn1             precipitation rate (at sfc) of ice crystals (liq-eq) [m+3 m-2 s-1]<a name='986'></font>
<font color=#447700>! RT_sn2             precipitation rate (at sfc) of snow    (liq-equiv)   [m+3 m-2 s-1]<a name='987'></font>
<font color=#447700>! RT_sn3             precipitation rate (at sfc) of graupel (liq-equiv)   [m+3 m-2 s-1]<a name='988'></font>
<font color=#447700>! RT_snd             precipitation rate (at sfc) of snow    (frozen)      [m+3 m-2 s-1]<a name='989'></font>
<font color=#447700>! RT_pe1             precipitation rate (at sfc) of ice pellets (liq-eq)  [m+3 m-2 s-1]<a name='990'></font>
<font color=#447700>! RT_pe2             precipitation rate (at sfc) of hail (total; liq-eq)  [m+3 m-2 s-1]<a name='991'></font>
<font color=#447700>! RT_peL             precipitation rate (at sfc) of hail (large only)     [m+3 m-2 s-1]<a name='992'></font>
<font color=#447700>! SS(i,k,n)          array (n) for 3D diagnostic output (e.g. S/S term)<a name='993'></font>
<font color=#447700>! ZET                total equivalent radar reflectivity                  [dBZ]<a name='994'></font>
<font color=#447700>! ZEC                composite (column-max) of ZET                        [dBZ]<a name='995'></font>
<font color=#447700>!_______________________________________________________________________________________!<a name='996'></font>
<a name='997'>
<a name='998'>
<font color=#447700>!LOCAL VARIABLES:<a name='999'></font>
<a name='1000'>
 <font color=#447700>!Variables to count active grid points:<a name='1001'></font>
  logical :: log1,log2,log3,log4,doneK,rainPresent,calcDiag<a name='1002'>
  logical, dimension(size(QC,dim=1),size(QC,dim=2)) :: activePoint<a name='1003'>
  integer, dimension(size(QC,dim=1)) :: ktop_sedi<a name='1004'>
  integer :: i,k,niter,ll,start,kskip_1,ktop,kbot,kdir<a name='1005'>
<a name='1006'>
  real    :: tmp1,tmp2,tmp3,tmp4,tmp5,tmp6,tmp7,tmp8,tmp9,tmp10,                    &amp;<a name='1007'>
       VDmax,NNUmax,X,D,DEL,QREVP,NuDEPSOR,NuCONTA,NuCONTB,NuCONTC,iMUkin,Ecg,Erg,  &amp;<a name='1008'>
       NuCONT,GG,Na,Tcc,F1,F2,Kdiff,PSIa,Kn,source,sink,sour,ratio,qvs0,Kstoke,     &amp;<a name='1009'>
       DELqvs,ft,esi,Si,Simax,Vq,Vn,Vz,LAMr,No_r_DM,No_i,No_s,No_g,No_h,D_sll,      &amp;<a name='1010'>
       iABi,ABw,VENTr,VENTs,VENTg,VENTi,VENTh,Cdiff,Ka,MUdyn,MUkin,Ng_tail,         &amp;<a name='1011'>
       gam,ScTHRD,Tc,mi,ff,Ec,Ntr,Dho,DMrain,Ech,DMice,DMsnow,DMgrpl,DMhail,        &amp;<a name='1012'>
       ssat,Swmax,dey,Esh,Eii,Eis,Ess,Eig,Eih,FRAC,JJ,Dirg,Dirh,Dsrs,Dsrg,Dsrh,     &amp;<a name='1013'>
       Dgrg,Dgrh,SIGc,L,TAU,DrAUT,DrINIT,Di,Ds,Dg,Dh,qFact,nFact,Ki,Rz,NgCNgh,      &amp;<a name='1014'>
       vr0,vi0,vs0,vg0,vh0,Dc,Dr,QCLcs,QCLrs,QCLis,QCLcg,QCLrg,QCLig,NhCNgh,        &amp;<a name='1015'>
       QCLch,QCLrh,QCLsh,QMLir,QMLsr,QMLgr,QMLhr,QCLih,QVDvg,QVDvh,QSHhr,           &amp;<a name='1016'>
       QFZci,QNUvi,QVDvi,QCNis,QCNis1,QCNis2,QCLir,QCLri,QCNsg,QCLsr,QCNgh,         &amp;<a name='1017'>
       QCLgr,QHwet,QVDvs,QFZrh,QIMsi,QIMgi,NMLhr,NVDvh,NCLir,NCLri,NCLrh,           &amp;<a name='1018'>
       NCLch,NCLsr,NCLirg,NCLirh,NrFZrh,NhFZrh,NCLsrs,NCLsrg,NCLsrh,NCLgrg,         &amp;<a name='1019'>
       NCLgrh,NVDvg,NMLgr,NiCNis,NsCNis,NVDvs,NMLsr,NCLsh,NCLss,NNUvi,NFZci,NVDvi,  &amp;<a name='1020'>
       NCLis,NCLig,NCLih,NMLir,NCLrs,NCNsg,NCLcs,NCLcg,NIMsi,NIMgi,NCLgr,NCLrg,     &amp;<a name='1021'>
       NSHhr,RCAUTR,RCACCR,CCACCR,CCSCOC,CCAUTR,CRSCOR,ALFx,des_pmlt,Ecs,des,ides,  &amp;<a name='1022'>
       LAMx,iLAMx,iLAMxB0,Dx,ffx,iLAMc,iNC,iNR,iNY,iNN,iNG,iLAMs_D3,                &amp;<a name='1023'>
       iLAMg,iLAMg2,iLAMgB0,iLAMgB1,iLAMgB2,iLAMh,iLAMhB0,iLAMhB1,iLAMhB2,iNH,      &amp;<a name='1024'>
       iLAMi,iLAMi2,iLAMi3,iLAMi4,iLAMi5,iLAMiB0,iLAMiB1,iLAMiB2,iLAMr6,iLAMh2,     &amp;<a name='1025'>
       iLAMs,iLAMs2,iLAMsB0,iLAMsB1,iLAMsB2,iLAMr,iLAMr2,iLAMr3,iLAMr4,iLAMr5,      &amp;<a name='1026'>
       iLAMc2,iLAMc3,iLAMc4,iLAMc5,iLAMc6,iQC,iQR,iQI,iQN,iQG,iQH,iEih,iEsh,        &amp;<a name='1027'>
       N_c,N_r,N_i,N_s,N_g,N_h,fluxV_i,fluxV_g,fluxV_s,rhos_mlt,fracLiq<a name='1028'>
<a name='1029'>
 <font color=#447700>!Variables that only need to be calulated on the first step (and saved):<a name='1030'></font>
  real, save :: idt,iMUc,cmr,cmi,cms,cmg,cmh,icmr,icmi,icmg,icms,icmh,idew,idei,    &amp;<a name='1031'>
       ideh,ideg,GC1,imso,icexc9,cexr1,cexr2,cexr3,No_s_SM,No_r,idms,imgo,icexs2,   &amp;<a name='1032'>
       cexr4,cexr5,cexr6,cexr9,icexr9,ckQr1,ckQr2,ckQr3,ckQi1,ckQi2,ckQi3,ckQi4,    &amp;<a name='1033'>
       icexi9,ckQs1,ckQs2,cexs1,cexs2,ckQg1,ckQg2,ckQg4,ckQh1,ckQh2,ckQh4,GR37,dms, &amp;<a name='1034'>
       LCP,LFP,LSP,ck5,ck6,PI2,PIov4,PIov6,CHLS,iCHLF,cxr,cxi,Gzr,Gzi,Gzs,Gzg,Gzh,  &amp;<a name='1035'>
       N_c_SM,iGC1,GC2,GC3,GC4,GC5,iGC5,GC6,GC7,GC8,GC11,GC12,GC13,GC14,iGR34,mso,  &amp;<a name='1036'>
       GC15,GR1,GR3,GR13,GR14,GR15,GR17,GR31,iGR31,GR32,GR33,GR34,GR35,GR36,GI4,    &amp;<a name='1037'>
       GI6,GI20,GI21,GI22,GI31,GI32,GI33,GI34,GI35,iGI31,GI11,GI36,GI37,GI40,iGG34, &amp;<a name='1038'>
       GS09,GS11,GS12,GS13,iGS20,GS31,iGS31,GS32,GS33,GS34,GS35,GS36,GS40,iGS40,    &amp;<a name='1039'>
       GS50,GG09,GG11,GG12,GG13,GG31,iGG31,GG32,GG33,GG34,GG35,GG36,GG40,iGG99,GH09,&amp;<a name='1040'>
       GH11,GH12,GH13,GH31,GH32,GH33,GH40,GR50,GG50,iGH34,GH50,iGH99,iGH31,iGS34,   &amp;<a name='1041'>
       iGS20_D3,GS40_D3,cms_D3,eds,fds,rfact_FvFm<a name='1042'>
<a name='1043'>
<font color=#447700>!Size distribution parameters:<a name='1044'></font>
  real, parameter :: MUc      =  3.    <font color=#447700>!shape parameter for cloud<a name='1045'></font>
  real, parameter :: alpha_c  =  1.    <font color=#447700>!shape parameter for cloud<a name='1046'></font>
  real, parameter :: alpha_r  =  0.    <font color=#447700>!shape parameter for rain<a name='1047'></font>
  real, parameter :: alpha_i  =  0.    <font color=#447700>!shape parameter for ice<a name='1048'></font>
  real, parameter :: alpha_s  =  0.    <font color=#447700>!shape parameter for snow<a name='1049'></font>
  real, parameter :: alpha_g  =  0.    <font color=#447700>!shape parameter for graupel<a name='1050'></font>
  real, parameter :: alpha_h  =  0.    <font color=#447700>!shape parameter for hail<a name='1051'></font>
  real, parameter :: No_s_max =  1.e+8 <font color=#447700>!max. allowable intercept for snow [m-4]<a name='1052'></font>
  real, parameter :: lamdas_min= 500.  <font color=#447700>!min. allowable LAMDA_s [m-1]<a name='1053'></font>
<a name='1054'>
 <font color=#447700>!For single-moment:<a name='1055'></font>
  real, parameter :: No_r_SM  =  1.e+7  <font color=#447700>!intercept parameter for rain    [m-4]<a name='1056'></font>
  real, parameter :: No_g_SM  =  4.e+6  <font color=#447700>!intercept parameter for graupel [m-4]<a name='1057'></font>
  real, parameter :: No_h_SM  =  1.e+5  <font color=#447700>!intercept parameter for hail    [m-4]<a name='1058'></font>
  <font color=#447700>!note: No_s = f(T), rather than a fixed value<a name='1059'></font>
  <font color=#447700>!------------------------------------!<a name='1060'></font>
  <font color=#447700>! Symbol convention: (dist. params.) ! MY05: Milbrandt &amp; Yau, 2005a,b (JAS)<a name='1061'></font>
  <font color=#447700>!       MY05    F94       CP00       ! F94:  Ferrier, 1994            (JAS)<a name='1062'></font>
  <font color=#447700>!       ------  --------  ------     ! CP00: Cohard &amp; Pinty, 2000a,b  (QJGR)<a name='1063'></font>
  <font color=#447700>!       ALFx    ALPHAx    MUx-1      !<a name='1064'></font>
  <font color=#447700>!       MUx     (1)       ALPHAx     !<a name='1065'></font>
  <font color=#447700>!       ALFx+1  ALPHAx+1  MUx        !<a name='1066'></font>
  <font color=#447700>!------------------------------------!<a name='1067'></font>
  <font color=#447700>!  Note: The symbols for MU and ALPHA are REVERSED from that of CP2000a,b<a name='1068'></font>
  <font color=#447700>!        Explicit appearance of MUr = 1. has been removed.<a name='1069'></font>
<a name='1070'>
  <font color=#447700>! Fallspeed parameters:<a name='1071'></font>
  real, parameter :: afr=  149.100,  bfr= 0.5000   <font color=#447700>!Tripoloi and Cotton (1980)<a name='1072'></font>
  real, parameter :: afi=   71.340,  bfi= 0.6635   <font color=#447700>!Ferrier (1994)<a name='1073'></font>
  real, parameter :: afs=   11.720,  bfs= 0.4100   <font color=#447700>!Locatelli and Hobbs (1974)<a name='1074'></font>
  real, parameter :: afg=   19.300,  bfg= 0.3700   <font color=#447700>!Ferrier (1994)<a name='1075'></font>
  real, parameter :: afh=  206.890,  bfh= 0.6384   <font color=#447700>!Ferrier (1994)<a name='1076'></font>
 <font color=#447700>!options:<a name='1077'></font>
 <font color=#447700>!real, parameter :: afs=    8.996,  bfs= 0.4200   !Ferrier (1994)<a name='1078'></font>
 <font color=#447700>!real, parameter :: afg=   6.4800,  bfg= 0.2400   !LH74 (grpl-like snow of lump type)<a name='1079'></font>
<a name='1080'>
  real, parameter :: epsQ  = 1.e-14   <font color=#447700>!kg kg-1, min. allowable mixing ratio<a name='1081'></font>
  real, parameter :: epsN  = 1.e-3    <font color=#447700>!m-3,     min. allowable number concentration<a name='1082'></font>
  real, parameter :: epsQ2 = 1.e-6    <font color=#447700>!kg kg-1, mixing ratio threshold for diagnostics<a name='1083'></font>
  real, parameter :: epsVIS= 1.       <font color=#447700>!m,       min. allowable visibility<a name='1084'></font>
<a name='1085'>
  real, parameter :: iLAMmin1= 1.e-6  <font color=#447700>!min. iLAMx (prevents underflow in Nox and VENTx calcs)<a name='1086'></font>
  real, parameter :: iLAMmin2= 1.e-10 <font color=#447700>!min. iLAMx (prevents underflow in Nox and VENTx calcs)<a name='1087'></font>
  real, parameter :: eps   = 1.e-32<a name='1088'>
<a name='1089'>
  real, parameter :: deg   =  400., mgo= 1.6e-10<a name='1090'>
  real, parameter :: deh   =  900.<a name='1091'>
  real, parameter :: dei   =  500., mio=1.e-12, Nti0=1.e3<a name='1092'>
  real, parameter :: dew   = 1000.<a name='1093'>
  real, parameter :: desFix=  100.  <font color=#447700>!used for snowSpherical = .true.<a name='1094'></font>
  real, parameter :: desMax=  500.<a name='1095'>
  real, parameter :: Dso   =  125.e-6  <font color=#447700>![m]; embryo snow diameter (mean-volume particle)<a name='1096'></font>
  real, parameter :: dmr   = 3., dmi= 3., dmg= 3., dmh= 3.<a name='1097'>
<a name='1098'>
  <font color=#447700>! NOTE: VxMAX below are the max.allowable mass-weighted fallspeeds for sedimentation.<a name='1099'></font>
  <font color=#447700>!       Thus, Vx corresponds to DxMAX (at sea-level) times the max. density factor, GAM.<a name='1100'></font>
  <font color=#447700>!       [GAMmax=sqrt(DEo/DEmin)=sqrt(1.25/0.4)~2.]  e.g. VrMAX = 2.*8.m/s = 16.m/s<a name='1101'></font>
  real, parameter :: DrMax=  5.e-3,   VrMax= 16.,   epsQr_sedi= 1.e-8<a name='1102'>
  real, parameter :: DiMax=  5.e-3,   ViMax=  2.,   epsQi_sedi= 1.e-10<a name='1103'>
  real, parameter :: DsMax=  5.e-3,   VsMax=  4.,   epsQs_sedi= 1.e-8<a name='1104'>
  real, parameter :: DgMax=  2.e-3,   VgMax=  6.,   epsQg_sedi= 1.e-8<a name='1105'>
  real, parameter :: DhMax= 80.e-3,   VhMax= 25.,   epsQh_sedi= 1.e-10<a name='1106'>
<a name='1107'>
  real, parameter :: CPW     = 4218.              <font color=#447700>![J kg-1 K-1] specific heat capacity of water<a name='1108'></font>
  real, parameter :: DEo     = 1.225              <font color=#447700>![kg m-3] reference air density<a name='1109'></font>
  real, parameter :: thrd    = 1./3.<a name='1110'>
  real, parameter :: sixth   = 0.5*thrd<a name='1111'>
  real, parameter :: Ers     = 1., Eci= 1.        <font color=#447700>!collection efficiencies, Exy, between categories x and y<a name='1112'></font>
  real, parameter :: Eri     = 1., Erh= 1.<a name='1113'>
  real, parameter :: Xdisp   = 0.25               <font color=#447700>!dispersion of the fall velocity of ice<a name='1114'></font>
  real, parameter :: aa11    = 9.44e15, aa22= 5.78e3, Rh= 41.e-6<a name='1115'>
  real, parameter :: Avx     = 0.78, Bvx= 0.30    <font color=#447700>!ventilation coefficients [F94 (B.36)]<a name='1116'></font>
  real, parameter :: Abigg   = 0.66, Bbigg= 100.  <font color=#447700>!parameters in probabilistic freezing<a name='1117'></font>
  real, parameter :: fdielec     = 4.464          <font color=#447700>!ratio of dielectric factor, |K|w**2/|K|i**2<a name='1118'></font>
  real, parameter :: zfact       = 1.e+18         <font color=#447700>!conversion factor for m-3 to mm2 m-6 for Ze<a name='1119'></font>
  real, parameter :: minZET      = -99.           <font color=#447700>![dBZ] min threshold for ZET<a name='1120'></font>
  real, parameter :: maxVIS      = 99.e+3         <font color=#447700>![m] max. allowable VIS (visibility)<a name='1121'></font>
  real, parameter :: Drshed      = 0.001          <font color=#447700>![m] mean diam. of drop shed during wet growth<a name='1122'></font>
  real, parameter :: SIGcTHRS    = 15.e-6         <font color=#447700>!threshold cld std.dev. before autoconversion<a name='1123'></font>
  real, parameter :: KK1         = 3.03e3         <font color=#447700>!parameter in Long (1974) kernel<a name='1124'></font>
  real, parameter :: KK2         = 2.59e15        <font color=#447700>!parameter in Long (1974) kernel<a name='1125'></font>
  real, parameter :: Dhh         = 82.e-6         <font color=#447700>![m] diameter that rain hump first appears<a name='1126'></font>
  real, parameter :: zMax_sedi   = 20000.         <font color=#447700>![m] maximum height to compute sedimentation<a name='1127'></font>
  real, parameter :: Dr_large    = 200.e-6        <font color=#447700>![m] size threshold to distinguish rain/drizzle for precip rates<a name='1128'></font>
  real, parameter :: Ds_large    = 200.e-6        <font color=#447700>![m] size threshold to distinguish snow/snow-grains for precip rates<a name='1129'></font>
  real, parameter :: Dh_large    = 1.0e-2         <font color=#447700>![m] size threshold for "large" hail precipitation rate<a name='1130'></font>
  real, parameter :: Dh_min      = 1.0e-3         <font color=#447700>![m] size threhsold for below which hail converts to graupel<a name='1131'></font>
  real, parameter :: Dr_3cmpThrs = 2.5e-3         <font color=#447700>![m] size threshold for hail production from 3-comp freezing<a name='1132'></font>
  real, parameter :: w_CNgh      = 3.             <font color=#447700>![m s-1] vertical motion  threshold for CNgh<a name='1133'></font>
  real, parameter :: Ngh_crit    = 1.e+0          <font color=#447700>![m-3] critical graupel concentration for CNgh<a name='1134'></font>
  real, parameter :: Tc_FZrh     = -10.           <font color=#447700>!temp-threshold (C) for FZrh<a name='1135'></font>
  real, parameter :: CNsgThres   = 1.0            <font color=#447700>!threshold for CLcs/VDvs ratio for CNsg<a name='1136'></font>
  real, parameter :: capFact_i   = 0.5            <font color=#447700>!capacitace factor for ice  (C= 0.5*D*capFact_i)<a name='1137'></font>
  real, parameter :: capFact_s   = 0.5            <font color=#447700>!capacitace factor for snow (C= 0.5*D*capFact_s)<a name='1138'></font>
  real, parameter :: Fv_Dsmin    = 125.e-6        <font color=#447700>![m] min snow size to compute volume flux<a name='1139'></font>
  real, parameter :: Fv_Dsmax    = 0.008          <font color=#447700>![m] max snow size to compute volume flux<a name='1140'></font>
  real, parameter :: Ni_max      = 1.e+7          <font color=#447700>![m-3] max ice crystal concentration<a name='1141'></font>
  real, parameter :: satw_peak   = 1.01           <font color=#447700>!assumed max. peak saturation w.r.t. water (for calc of Simax)<a name='1142'></font>
<a name='1143'>
<font color=#447700>!------------------------------------------------------------------------------!<a name='1144'></font>
<font color=#447700>!-- For GEM:<a name='1145'></font>
<font color=#447700>!#include "consphy.cdk"<a name='1146'></font>
<a name='1147'>
<font color=#447700>!-- For WRF + kin_1d + kin_2d:<a name='1148'></font>
  real, parameter :: CPI      =.21153e+4          <font color=#447700>!J kg-1 K-1; specific heat capacity of ice<a name='1149'></font>
  real, parameter :: TRPL     =.27316e+3          <font color=#447700>!K; triple point of water<a name='1150'></font>
  real, parameter :: TCDK     =.27315e+3          <font color=#447700>!conversion from kelvin to celsius<a name='1151'></font>
  real, parameter :: RAUW     =.1e+4              <font color=#447700>!density of liquid H2O<a name='1152'></font>
  real, parameter :: EPS2     =.3780199778986     <font color=#447700>!1 - EPS1<a name='1153'></font>
  real, parameter :: TGL      =.27316e+3          <font color=#447700>!K; ice temperature in the atmosphere<a name='1154'></font>
  real, parameter :: CONSOL   =.1367e+4           <font color=#447700>!W m-2; solar constant<a name='1155'></font>
  real, parameter :: RAYT     =.637122e+7         <font color=#447700>!M; mean radius of the earth<a name='1156'></font>
  real, parameter :: STEFAN   =.566948e-7         <font color=#447700>!J m-2 s-1 K-4; Stefan-Boltzmann constant<a name='1157'></font>
  real, parameter :: PI       =.314159265359e+1   <font color=#447700>!PI constant = ACOS(-1)<a name='1158'></font>
  real, parameter :: OMEGA    =.7292e-4           <font color=#447700>!s-1; angular speed of rotation of the earth<a name='1159'></font>
  real, parameter :: KNAMS    =.514791            <font color=#447700>!conversion from knots to m/s<a name='1160'></font>
  real, parameter :: STLO     =.6628486583943e-3  <font color=#447700>!K s2 m-2; Schuman-Newell Lapse Rate<a name='1161'></font>
  real, parameter :: KARMAN   =.35                <font color=#447700>!Von Karman constant<a name='1162'></font>
  real, parameter :: RIC      =.2                 <font color=#447700>!Critical Richardson number<a name='1163'></font>
<font color=#447700>!-- For kin_1d + kin_2d (exclude from WRF):<a name='1164'></font>
  real, parameter :: CHLC     =.2501e+7           <font color=#447700>!J kg-1; latent heat of condensation<a name='1165'></font>
  real, parameter :: CHLF     =.334e+6            <font color=#447700>!J kg-1; latent heat of fusion<a name='1166'></font>
  real, parameter :: CPD      =.100546e+4         <font color=#447700>!J K-1 kg-1; specific heat of dry air<a name='1167'></font>
  real, parameter :: CPV      =.186946e+4         <font color=#447700>!J K-1 kg-1; specific heat of water vapour<a name='1168'></font>
  real, parameter :: RGASD    =.28705e+3          <font color=#447700>!J K-1 kg-1; gas constant for dry air<a name='1169'></font>
  real, parameter :: RGASV    =.46151e+3          <font color=#447700>!J K-1 kg-1; gas constant for water vapour<a name='1170'></font>
  real, parameter :: EPS1     =.62194800221014    <font color=#447700>!RGASD/RGASV<a name='1171'></font>
  real, parameter :: DELTA    =.6077686814144     <font color=#447700>!1/EPS1 - 1<a name='1172'></font>
  real, parameter :: CAPPA    =.28549121795       <font color=#447700>!RGASD/CPD<a name='1173'></font>
  real, parameter :: GRAV     =.980616e+1         <font color=#447700>!M s-2; gravitational acceleration<a name='1174'></font>
<font color=#447700>!==<a name='1175'></font>
<font color=#447700>!------------------------------------------------------------------------------!<a name='1176'></font>
<a name='1177'>
  <font color=#447700>! Constants used for contact ice nucleation:<a name='1178'></font>
  real, parameter :: LAMa0  = 6.6e-8     <font color=#447700>![m] mean free path at T0 and p0 [W95_eqn58]<a name='1179'></font>
  real, parameter :: T0     = 293.15     <font color=#447700>![K] ref. temp.<a name='1180'></font>
  real, parameter :: p0     = 101325.    <font color=#447700>![Pa] ref. pres.<a name='1181'></font>
  real, parameter :: Ra     = 1.e-6      <font color=#447700>![m] aerosol (IN) radius         [M92 p.713; W95_eqn60]<a name='1182'></font>
  real, parameter :: kBoltz = 1.381e-23  <font color=#447700>!Boltzmann's constant<a name='1183'></font>
  real, parameter :: KAPa   = 5.39e5     <font color=#447700>!aerosol thermal conductivity<a name='1184'></font>
<a name='1185'>
 <font color=#447700>!Test switches:<a name='1186'></font>
  logical, parameter :: DEBUG_ON      = .false.  <font color=#447700>!.true. to switch on debugging checks/traps throughout code<a name='1187'></font>
  logical, parameter :: DEBUG_abort   = .true.  <font color=#447700>!.true. will result in forced abort in s/r 'check_values'<a name='1188'></font>
  logical, parameter :: iceDep_ON     = .true.  <font color=#447700>!.false. to suppress depositional growth of ice<a name='1189'></font>
  logical, parameter :: grpl_ON       = .true.  <font color=#447700>!.false. to suppress graupel initiation<a name='1190'></font>
  logical, parameter :: hail_ON       = .true.  <font color=#447700>!.false. to suppress hail initiation<a name='1191'></font>
  logical, parameter :: rainAccr_ON   = .true.  <font color=#447700>! rain accretion and self-collection ON/OFF<a name='1192'></font>
  logical, parameter :: snowSpherical = .false. <font color=#447700>!.true.: m(D)=(pi/6)*const_des*D^3 | .false.: m(D)= 0.069*D^2<a name='1193'></font>
  integer, parameter :: primIceNucl   = 1       <font color=#447700>!1= Meyers+contact ;  2= Cooper<a name='1194'></font>
  real,    parameter :: outfreq       =  60.    <font color=#447700>!frequency to compute output diagnostics [s]<a name='1195'></font>
<a name='1196'>
  real, dimension(size(QC,dim=1),size(QC,dim=2)) :: DE,iDE,iDP,QSW,QSI,DZ,iDZ,zz,VQQ,    &amp;<a name='1197'>
        gamfact,pres,zheight,QC_in,QR_in,NC_in,NR_in<a name='1198'>
  real, dimension(size(QC,dim=1))                :: fluxM_r,fluxM_i,fluxM_s,fluxM_g,     &amp;<a name='1199'>
        fluxM_h,dum<a name='1200'>
  integer, dimension(size(QC,dim=1))             :: activeColumn<a name='1201'>
<a name='1202'>
 <font color=#447700>!-- for use with sedimentation on subset of levels:<a name='1203'></font>
 <font color=#447700>!integer                                        :: k_sub,nk_sub,nk_skip<a name='1204'></font>
 <font color=#447700>!integer                                        :: status  !for allocate/deallocate statements (0 for success)<a name='1205'></font>
 <font color=#447700>!integer, allocatable, dimension(:)             :: kfull,kskip<a name='1206'></font>
 <font color=#447700>!integer, allocatable, dimension(:,:)           :: iint<a name='1207'></font>
 <font color=#447700>!real, dimension(:,:), allocatable              :: DE_sub,iDE_sub,iDP_sub,pres_sub,     &amp;<a name='1208'></font>
 <font color=#447700>!==                                                DZ_sub,zheight_sub,iDZ_sub,gamfact_sub<a name='1209'></font>
<a name='1210'>
<a name='1211'>
  <font color=#447700>!==================================================================================!<a name='1212'></font>
<a name='1213'>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='1214'></font>
  <font color=#447700>!                      PART 1:   Prelimiary Calculations                           !<a name='1215'></font>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='1216'></font>
<a name='1217'>
  <font color=#447700>!Switch on here later, once it is certain that calling routine is not supposed to<a name='1218'></font>
  <font color=#447700>!pass negative values of tracers.<a name='1219'></font>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_1">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,100)<a name='1220'>
<a name='1221'>
  if (nk_BOTTOM) then<a name='1222'>
<font color=#447700>!    !GEM / kin_1d:<a name='1223'></font>
     ktop  = 1          <font color=#447700>!k of top level<a name='1224'></font>
     kbot  = nk         <font color=#447700>!k of bottom level<a name='1225'></font>
     kdir  = -1         <font color=#447700>!direction of vertical leveling (k: 1=top, nk=bottom)<a name='1226'></font>
  else<a name='1227'>
   <font color=#447700>!WRF / kin_2d: (assuming no array flipping in wrapper)<a name='1228'></font>
     ktop  = nk         <font color=#447700>!k of top level<a name='1229'></font>
     kbot  = 1          <font color=#447700>!k of bottom level<a name='1230'></font>
     kdir  = 1          <font color=#447700>!direction of vertical leveling (k: 1=bottom, nk=top)<a name='1231'></font>
  endif<a name='1232'>
<a name='1233'>
  do k= kbot,ktop,kdir<a name='1234'>
     pres(:,k)= PS(:)*sigma(:,k)               <font color=#447700>!air pressure [Pa]<a name='1235'></font>
     do i=1,ni<a name='1236'>
        QSW(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_8">(T(i,k),pres(i,k),0)    <font color=#447700>!wrt. liquid water<a name='1237'></font>
        QSI(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_9">(T(i,k),pres(i,k),1)    <font color=#447700>!wrt. ice<a name='1238'></font>
     enddo<a name='1239'>
  enddo<a name='1240'>
<a name='1241'>
 <font color=#447700>!Air density:<a name='1242'></font>
  DE  = pres/(RGASD*T)<a name='1243'>
  iDE = 1./DE<a name='1244'>
<a name='1245'>
 <font color=#447700>!Convert N from #/kg to #/m3:<a name='1246'></font>
  NC = NC*DE<a name='1247'>
  NR = NR*DE<a name='1248'>
  NY = NY*DE<a name='1249'>
  NN = NN*DE<a name='1250'>
  NG = NG*DE<a name='1251'>
  NH = NH*DE<a name='1252'>
<a name='1253'>
  <font color=#447700>! The SS(i,k,n) array is passed to 'vkuocon6' where it is converted into individual<a name='1254'></font>
  <font color=#447700>! arrays [a_ss01(i,k)] and then passed to the volatile bus for output as 3-D diagnostic<a name='1255'></font>
  <font color=#447700>! output variables, for testing purposes.  For example, to output the<a name='1256'></font>
  <font color=#447700>! instantanous value of the deposition rate, add 'SS(i,k,1) = QVDvi'  in the<a name='1257'></font>
  <font color=#447700>! appropriate place.  It can then be output as a 3-D physics variable by adding<a name='1258'></font>
  <font color=#447700>! SS01 to the sortie_p list in 'outcfgs.out'<a name='1259'></font>
  SS= 0.<a name='1260'>
<a name='1261'>
 <font color=#447700>!Compute diagnostic values only every 'outfreq' minutes:<a name='1262'></font>
 <font color=#447700>!calcDiag= (mod(DT*float(KOUNT),outfreq)==0.)<a name='1263'></font>
  calcDiag = .true.  <font color=#447700>!compute diagnostics every step (for time-series output)<a name='1264'></font>
<a name='1265'>
<font color=#447700>!####  These need only to be computed once per model integration:<a name='1266'></font>
<font color=#447700>!      (note:  These variables must be declared with the SAVE attribute)<a name='1267'></font>
<a name='1268'>
<font color=#447700>! if (KOUNT==0) then<a name='1269'></font>
<font color=#447700>!*** For restarts, these values are not saved.  Therefore, the condition statement<a name='1270'></font>
<font color=#447700>!    must be modified to something like: IF (MOD(Step_rsti,KOUNT).eq.0) THEN<a name='1271'></font>
<font color=#447700>!    in order that these be computed only on the first step of a given restart.<a name='1272'></font>
<font color=#447700>!    (...to be done.  For now, changing condition to IF(TRUE) to compute at each step.)<a name='1273'></font>
<a name='1274'>
<a name='1275'>
  if (.TRUE.) then<a name='1276'>
<a name='1277'>
   PI2    = PI*2.<a name='1278'>
   PIov4  = 0.25*PI<a name='1279'>
   PIov6  = PI*sixth<a name='1280'>
   CHLS   = CHLC+CHLF  <font color=#447700>!J k-1; latent heat of sublimation<a name='1281'></font>
   LCP    = CHLC/CPD<a name='1282'>
   LFP    = CHLF/CPD<a name='1283'>
   iCHLF  = 1./CHLF<a name='1284'>
   LSP    = LCP+LFP<a name='1285'>
   ck5    = 4098.170*LCP<a name='1286'>
   ck6    = 5806.485*LSP<a name='1287'>
   idt    = 1./dt<a name='1288'>
   imgo   = 1./mgo<a name='1289'>
   idew   = 1./dew<a name='1290'>
   idei   = 1./dei<a name='1291'>
   ideg   = 1./deg<a name='1292'>
   ideh   = 1./deh<a name='1293'>
<a name='1294'>
   <font color=#447700>!Constants based on size distribution parameters:<a name='1295'></font>
<a name='1296'>
   <font color=#447700>! Mass parameters [ m(D) = cD^d ]<a name='1297'></font>
   cmr    = PIov6*dew;  icmr= 1./cmr<a name='1298'>
   cmi    = 440.;       icmi= 1./cmi<a name='1299'>
   cmg    = PIov6*deg;  icmg= 1./cmg<a name='1300'>
   cmh    = PIov6*deh;  icmh= 1./cmh<a name='1301'>
<a name='1302'>
   cms_D3 = PIov6*desFix <font color=#447700>!used for snowSpherical = .T. or .F.<a name='1303'></font>
   if (snowSpherical) then<a name='1304'>
      cms = cms_D3<a name='1305'>
      dms = 3.<a name='1306'>
   else<a name='1307'>
<font color=#447700>!     cms = 0.0690;  dms = 2.000   !Cox, 1988 (QJRMS)<a name='1308'></font>
      cms = 0.1597;  dms = 2.078   <font color=#447700>!Brandes et al., 2007 (JAMC)<a name='1309'></font>
   endif<a name='1310'>
   icms   = 1./cms<a name='1311'>
   idms   = 1./dms<a name='1312'>
   mso    = cms*Dso**dms<a name='1313'>
   imso   = 1./mso<a name='1314'>
  <font color=#447700>!bulk density parameters: [rho(D) = eds*D^fds]<a name='1315'></font>
  <font color=#447700>!  These are implied by the mass-diameter parameters, by computing the bulk<a name='1316'></font>
  <font color=#447700>!  density of a sphere with the equaivalent mass.<a name='1317'></font>
  <font color=#447700>!  e.g. m(D) = cD^d = (pi/6)rhoD^3 and solve for rho(D)<a name='1318'></font>
   eds    = cms/PIov6<a name='1319'>
   fds    = dms-3.<a name='1320'>
   if (fds/=-1. .and..not.snowSpherical) GS50= <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_28">(1.+fds+alpha_s)<a name='1321'>
<a name='1322'>
   <font color=#447700>! Cloud:<a name='1323'></font>
   iMUc   =  1./MUc<a name='1324'>
   GC1    =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_29">(alpha_c+1.0)<a name='1325'>
   iGC1   = 1./GC1<a name='1326'>
   GC2    =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_30">(alpha_c+1.+3.0*iMUc)  <font color=#447700>!i.e. gamma(alf + 4)<a name='1327'></font>
   GC3    =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_31">(alpha_c+1.+6.0*iMUc)  <font color=#447700>!i.e. gamma(alf + 7)<a name='1328'></font>
   GC4    =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_32">(alpha_c+1.+9.0*iMUc)  <font color=#447700>!i.e. gamma(alf + 10)<a name='1329'></font>
   GC11   =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_33">(1.0*iMUc+1.0+alpha_c)<a name='1330'>
   GC12   =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_34">(2.0*iMUc+1.0+alpha_c)<a name='1331'>
   GC5    =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_35">(1.0+alpha_c)<a name='1332'>
   iGC5   = 1./GC5<a name='1333'>
   GC6    =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_36">(1.0+alpha_c+1.0*iMUc)<a name='1334'>
   GC7    =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_37">(1.0+alpha_c+2.0*iMUc)<a name='1335'>
   GC8    =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_38">(1.0+alpha_c+3.0*iMUc)<a name='1336'>
   GC13   =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_39">(3.0*iMUc+1.0+alpha_c)<a name='1337'>
   GC14   =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_40">(4.0*iMUc+1.0+alpha_c)<a name='1338'>
   GC15   =  <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_41">(5.0*iMUc+1.0+alpha_c)<a name='1339'>
   icexc9 =  1./(GC2*iGC1*PIov6*dew)<a name='1340'>
  <font color=#447700>!specify cloud droplet number concentration [m-3] based on 'CCNtype' (1-moment):<a name='1341'></font>
   if     (CCNtype==1) then<a name='1342'>
      N_c_SM =  0.8e+8          <font color=#447700>!maritime<a name='1343'></font>
   elseif (CCNtype==2) then<a name='1344'>
      N_c_SM =  2.0e+8          <font color=#447700>!continental 1<a name='1345'></font>
   elseif (CCNtype==3) then<a name='1346'>
      N_c_SM =  5.0e+8          <font color=#447700>!continental 2 (polluted)<a name='1347'></font>
   else<a name='1348'>
      N_c_SM =  2.0e+8          <font color=#447700>!default (cont1), if 'CCNtype' specified incorrectly<a name='1349'></font>
   endif<a name='1350'>
<a name='1351'>
   <font color=#447700>! Rain:<a name='1352'></font>
   cexr1  = 1.+alpha_r+dmr+bfr<a name='1353'>
   cexr2  = 1.+alpha_r+dmr<a name='1354'>
   GR17   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_42">(2.5+alpha_r+0.5*bfr)<a name='1355'>
   GR31   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_43">(1.+alpha_r)<a name='1356'>
   iGR31  = 1./GR31<a name='1357'>
   GR32   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_44">(2.+alpha_r)<a name='1358'>
   GR33   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_45">(3.+alpha_r)<a name='1359'>
   GR34   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_46">(4.+alpha_r)<a name='1360'>
   iGR34  = 1./GR34<a name='1361'>
   GR35   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_47">(5.+alpha_r)<a name='1362'>
   GR36   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_48">(6.+alpha_r)<a name='1363'>
   GR37   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_49">(7.+alpha_r)<a name='1364'>
   GR50   = (No_r_SM*GR31)**0.75  <font color=#447700>!for 1-moment or Nr-initialization<a name='1365'></font>
   cexr5  = 2.+alpha_r<a name='1366'>
   cexr6  = 2.5+alpha_r+0.5*bfr<a name='1367'>
   cexr9  = cmr*GR34*iGR31;    icexr9= 1./cexr9<a name='1368'>
   cexr3  = 1.+bfr+alpha_r<a name='1369'>
   cexr4  = 1.+alpha_r<a name='1370'>
   ckQr1  = afr*gamma(1.+alpha_r+dmr+bfr)/gamma(1.+alpha_r+dmr)<a name='1371'>
   ckQr2  = afr*gamma(1.+alpha_r+bfr)*GR31<a name='1372'>
   ckQr3  = afr*gamma(7.+alpha_r+bfr)/GR37<a name='1373'>
<a name='1374'>
   <font color=#447700>! Ice:<a name='1375'></font>
   GI4    = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_50">(alpha_i+dmi+bfi)<a name='1376'>
   GI6    = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_51">(2.5+bfi*0.5+alpha_i)<a name='1377'>
   GI11   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_52">(1.+bfi+alpha_i)<a name='1378'>
   GI20   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_53">(0.+bfi+1.+alpha_i)<a name='1379'>
   GI21   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_54">(1.+bfi+1.+alpha_i)<a name='1380'>
   GI22   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_55">(2.+bfi+1.+alpha_i)<a name='1381'>
   GI31   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_56">(1.+alpha_i)<a name='1382'>
   iGI31  = 1./GI31<a name='1383'>
   GI32   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_57">(2.+alpha_i)<a name='1384'>
   GI33   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_58">(3.+alpha_i)<a name='1385'>
   GI34   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_59">(4.+alpha_i)<a name='1386'>
   GI35   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_60">(5.+alpha_i)<a name='1387'>
   GI36   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_61">(6.+alpha_i)<a name='1388'>
   GI40   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_62">(1.+alpha_i+dmi)<a name='1389'>
   icexi9 = 1./(cmi*gamma(1.+alpha_i+dmi)*iGI31)<a name='1390'>
   ckQi1  = afi*gamma(1.+alpha_i+dmi+bfi)/GI40<a name='1391'>
   ckQi2  = afi*GI11*iGI31<a name='1392'>
   ckQi4  = 1./(cmi*GI40*iGI31)<a name='1393'>
<a name='1394'>
   <font color=#447700>! Snow:<a name='1395'></font>
   cexs1  = 2.5+0.5*bfs+alpha_s<a name='1396'>
   cexs2  = 1.+alpha_s+dms<a name='1397'>
   icexs2 = 1./cexs2<a name='1398'>
   GS09   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_63">(2.5+bfs*0.5+alpha_s)<a name='1399'>
   GS11   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_64">(1.+bfs+alpha_s)<a name='1400'>
   GS12   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_65">(2.+bfs+alpha_s)<a name='1401'>
   GS13   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_66">(3.+bfs+alpha_s)<a name='1402'>
   GS31   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_67">(1.+alpha_s)<a name='1403'>
   iGS31  = 1./GS31<a name='1404'>
   GS32   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_68">(2.+alpha_s)<a name='1405'>
   GS33   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_69">(3.+alpha_s)<a name='1406'>
   GS34   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_70">(4.+alpha_s)<a name='1407'>
   iGS34  = 1./GS34<a name='1408'>
   GS35   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_71">(5.+alpha_s)<a name='1409'>
   GS36   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_72">(6.+alpha_s)<a name='1410'>
   GS40   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_73">(1.+alpha_s+dms)<a name='1411'>
   iGS40  = 1./GS40<a name='1412'>
   iGS20  = 1./(GS40*iGS31*cms)<a name='1413'>
   ckQs1  = afs*gamma(1.+alpha_s+dms+bfs)*iGS40<a name='1414'>
   ckQs2  = afs*GS11*iGS31<a name='1415'>
   GS40_D3 = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_74">(1.+alpha_s+3.)<a name='1416'>
   iGS20_D3= 1./(GS40_D3*iGS31*cms_D3)<a name='1417'>
   rfact_FvFm= PIov6*icms*gamma(4.+bfs+alpha_s)/gamma(1.+dms+bfs+alpha_s)<a name='1418'>
<a name='1419'>
   <font color=#447700>! Graupel:<a name='1420'></font>
   GG09   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_75">(2.5+0.5*bfg+alpha_g)<a name='1421'>
   GG11   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_76">(1.+bfg+alpha_g)<a name='1422'>
   GG12   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_77">(2.+bfg+alpha_g)<a name='1423'>
   GG13   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_78">(3.+bfg+alpha_g)<a name='1424'>
   GG31   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_79">(1.+alpha_g)<a name='1425'>
   iGG31  = 1./GG31<a name='1426'>
   GG32   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_80">(2.+alpha_g)<a name='1427'>
   GG33   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_81">(3.+alpha_g)<a name='1428'>
   GG34   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_82">(4.+alpha_g)<a name='1429'>
   iGG34  = 1./GG34<a name='1430'>
   GG35   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_83">(5.+alpha_g)<a name='1431'>
   GG36   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_84">(6.+alpha_g)<a name='1432'>
   GG40   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_85">(1.+alpha_g+dmg)<a name='1433'>
   iGG99  = 1./(GG40*iGG31*cmg)<a name='1434'>
   GG50   = (No_g_SM*GG31)**0.75     <font color=#447700>!for 1-moment only<a name='1435'></font>
   ckQg1  = afg*gamma(1.+alpha_g+dmg+bfg)/GG40<a name='1436'>
   ckQg2  = afg*GG11*iGG31<a name='1437'>
   ckQg4  = 1./(cmg*GG40*iGG31)<a name='1438'>
<a name='1439'>
   <font color=#447700>! Hail:<a name='1440'></font>
   GH09   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_86">(2.5+bfh*0.5+alpha_h)<a name='1441'>
   GH11   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_87">(1.+bfh+alpha_h)<a name='1442'>
   GH12   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_88">(2.+bfh+alpha_h)<a name='1443'>
   GH13   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_89">(3.+bfh+alpha_h)<a name='1444'>
   GH31   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_90">(1.+alpha_h)<a name='1445'>
   iGH31  = 1./GH31<a name='1446'>
   GH32   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_91">(2.+alpha_h)<a name='1447'>
   GH33   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_92">(3.+alpha_h)<a name='1448'>
   iGH34  = 1./gamma(4.+alpha_h)<a name='1449'>
   GH40   = <A href='../../html_code/phys/module_mp_p3.F.html#GAMMA'>gamma</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GAMMA_93">(1.+alpha_h+dmh)<a name='1450'>
   iGH99  = 1./(GH40*iGH31*cmh)<a name='1451'>
   GH50   = (No_h_SM*GH31)**0.75     <font color=#447700>!for 1-moment only<a name='1452'></font>
   ckQh1  = afh*gamma(1.+alpha_h+dmh+bfh)/GH40<a name='1453'>
   ckQh2  = afh*GH11*iGH31<a name='1454'>
   ckQh4  = 1./(cmh*GH40*iGH31)<a name='1455'>
<a name='1456'>
  endif  <font color=#447700>!if (KOUNT=0)<a name='1457'></font>
<font color=#447700>!####<a name='1458'></font>
<a name='1459'>
<font color=#447700>!=======================================================================================!<a name='1460'></font>
<font color=#447700>!  if (DEBUG_ON) call check_values(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,200)<a name='1461'></font>
<a name='1462'>
<font color=#447700>!--- Ensure consistency between moments:<a name='1463'></font>
  do k= kbot,ktop,kdir<a name='1464'>
     do i= 1,ni<a name='1465'>
<a name='1466'>
        tmp1 = QSW(i,k)/max(Q(i,k),1.e-20)   <font color=#447700>!saturation w.r.t. water<a name='1467'></font>
        tmp2 = QSI(i,k)/max(Q(i,k),1.e-20)   <font color=#447700>!saturation w.r.t. ice<a name='1468'></font>
       <font color=#447700>!NOTE: Hydrometeor (Qx,Nx) is clipped if Qx is tiny or if Qx is small<a name='1469'></font>
       <font color=#447700>!      and is expected to completely evaporate/sublimate in one time step<a name='1470'></font>
       <font color=#447700>!      anyway.  (To avoid creating mass from a parallel universe, only<a name='1471'></font>
       <font color=#447700>!      positive Qx values are added to water vapor upon clipping.)<a name='1472'></font>
       <font color=#447700>!   ** RH thresholds for clipping need to be tuned (especially for graupel<a name='1473'></font>
       <font color=#447700>!      and hail, for which it may be preferable to reduce threshold)<a name='1474'></font>
<a name='1475'>
<a name='1476'>
       <font color=#447700>!cloud:<a name='1477'></font>
        if (QC(i,k)&gt;epsQ .and. NC(i,k)&lt;epsN) then<a name='1478'>
           NC(i,k) = N_c_SM<a name='1479'>
        elseif (QC(i,k)&lt;=epsQ .or. (QC(i,k)&lt;epsQ2 .and. tmp1&lt;0.90)) then<a name='1480'>
           tmp3    = max(0., QC(i,k))<a name='1481'>
           Q(i,k)  = Q(i,k) + tmp3<a name='1482'>
           T(i,k)  = T(i,k) - LCP*tmp3<a name='1483'>
           QC(i,k) = 0.<a name='1484'>
           NC(i,k) = 0.<a name='1485'>
        endif<a name='1486'>
<a name='1487'>
       <font color=#447700>!rain<a name='1488'></font>
        if (QR(i,k)&gt;epsQ .and. NR(i,k)&lt;epsN) then<a name='1489'>
           NR(i,k) = (No_r_SM*GR31)**(3./(4.+alpha_r))*(GR31*iGR34*DE(i,k)*QR(i,k)*      &amp;<a name='1490'>
                     icmr)**((1.+alpha_r)/(4.+alpha_r))<a name='1491'>
        elseif (QR(i,k)&lt;=epsQ .or. (QR(i,k)&lt;epsQ2 .and. tmp1&lt;0.90)) then<a name='1492'>
           tmp3    = max(0., QR(i,k))<a name='1493'>
           Q(i,k)  = Q(i,k) + tmp3<a name='1494'>
           T(i,k)  = T(i,k) - LCP*tmp3<a name='1495'>
           QR(i,k) = 0.<a name='1496'>
           NR(i,k) = 0.<a name='1497'>
        endif<a name='1498'>
<a name='1499'>
        <font color=#447700>!ice:<a name='1500'></font>
        if (QI(i,k)&gt;epsQ .and. NY(i,k)&lt;epsN) then<a name='1501'>
    <font color=#447700>!       NY(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#N_COOPER'>N_Cooper</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N_COOPER_1">(TRPL,T(i,k))<a name='1502'></font>
           NY(i,k) = max(2.*epsN, N_Cooper(TRPL,T(i,k)) )<a name='1503'>
        elseif (QI(i,k)&lt;=epsQ .or. (QI(i,k)&lt;epsQ2 .and. tmp2&lt;0.80)) then<a name='1504'>
           tmp3    = max(0., QI(i,k))<a name='1505'>
           Q(i,k)  = Q(i,k) + tmp3<a name='1506'>
           T(i,k)  = T(i,k) - LSP*tmp3<a name='1507'>
           QI(i,k) = 0.<a name='1508'>
           NY(i,k) = 0.<a name='1509'>
        endif<a name='1510'>
<a name='1511'>
       <font color=#447700>!snow:<a name='1512'></font>
        if (QN(i,k)&gt;epsQ .and. NN(i,k)&lt;epsN) then<a name='1513'>
           No_s    = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#NOS_THOMPSON'>Nos_Thompson</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOS_THOMPSON_1">(TRPL,T(i,k))<a name='1514'>
           NN(i,k) = (No_s*GS31)**(dms*icexs2)*(GS31*iGS40*icms*DE(i,k)*QN(i,k))**       &amp;<a name='1515'>
                     ((1.+alpha_s)*icexs2)<a name='1516'>
        elseif (QN(i,k)&lt;=epsQ .or. (QN(i,k)&lt;epsQ2 .and. tmp2&lt;0.80)) then<a name='1517'>
           tmp3    = max(0., QN(i,k))<a name='1518'>
           Q(i,k)  = Q(i,k) + tmp3<a name='1519'>
           T(i,k)  = T(i,k) - LSP*tmp3<a name='1520'>
           QN(i,k) = 0.<a name='1521'>
           NN(i,k) = 0.<a name='1522'>
        endif<a name='1523'>
<a name='1524'>
       <font color=#447700>!grpl:<a name='1525'></font>
      if (QG(i,k)&gt;epsQ .and. NG(i,k)&lt;epsN) then<a name='1526'>
           NG(i,k) = (No_g_SM*GG31)**(3./(4.+alpha_g))*(GG31*iGG34*DE(i,k)*QG(i,k)*      &amp;<a name='1527'>
                     icmg)**((1.+alpha_g)/(4.+alpha_g))<a name='1528'>
        elseif (QG(i,k)&lt;=epsQ .or. (QG(i,k)&lt;epsQ2 .and. tmp2&lt;0.80)) then<a name='1529'>
           tmp3    = max(0., QG(i,k))<a name='1530'>
           Q(i,k)  = Q(i,k) + tmp3<a name='1531'>
           T(i,k)  = T(i,k) - LSP*tmp3<a name='1532'>
           QG(i,k) = 0.<a name='1533'>
           NG(i,k) = 0.<a name='1534'>
        endif<a name='1535'>
<a name='1536'>
       <font color=#447700>!hail:<a name='1537'></font>
        if (QH(i,k)&gt;epsQ .and. NH(i,k)&lt;epsN) then<a name='1538'>
           NH(i,k) = (No_h_SM*GH31)**(3./(4.+alpha_h))*(GH31*iGH34*DE(i,k)*QH(i,k)*      &amp;<a name='1539'>
                     icmh)**((1.+alpha_h)/(4.+alpha_h))<a name='1540'>
        elseif (QH(i,k)&lt;=epsQ .or. (QH(i,k)&lt;epsQ2 .and. tmp2&lt;0.80)) then<a name='1541'>
           tmp3    = max(0., QH(i,k))<a name='1542'>
           Q(i,k)  = Q(i,k) + tmp3<a name='1543'>
           T(i,k)  = T(i,k) - LSP*tmp3<a name='1544'>
           QH(i,k) = 0.<a name='1545'>
           NH(i,k) = 0.<a name='1546'>
        endif<a name='1547'>
<a name='1548'>
     enddo <font color=#447700>!i-loop<a name='1549'></font>
  enddo    <font color=#447700>!k-loop<a name='1550'></font>
<font color=#447700>!===<a name='1551'></font>
<a name='1552'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_2">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.true.,DEBUG_abort,300)<a name='1553'>
<a name='1554'>
<font color=#447700>!Temporarily store arrays at time (t*) in order to compute warm-rain coalescence<a name='1555'></font>
<font color=#447700>! equations (Part 3a):<a name='1556'></font>
  QC_in = QC<a name='1557'>
  QR_in = QR<a name='1558'>
  NC_in = NC<a name='1559'>
  NR_in = NR<a name='1560'>
<a name='1561'>
<a name='1562'>
 <font color=#447700>!Air-density factor (for fall velocity computations):<a name='1563'></font>
  do i= 1,ni<a name='1564'>
     gamfact(i,:)  = sqrt(DEo/(DE(i,:)))<a name='1565'>
  enddo<a name='1566'>
<a name='1567'>
 <font color=#447700>!Pressure difference between levels (used for sedimentation)<a name='1568'></font>
  iDP(:,kbot) = 1./(PS(:)-pres(:,kbot))<a name='1569'>
  do k = kbot+kdir,ktop,kdir<a name='1570'>
    iDP(:,k) = 1./(pres(:,k-kdir)-pres(:,k))<a name='1571'>
  enddo<a name='1572'>
<a name='1573'>
 <font color=#447700>!Compute thickness of layers for sedimentation calculation: (optional use if height coordiates)<a name='1574'></font>
 <font color=#447700>! note - from 'cldoptx4.ftn':  dz(i,k)= dp(i,k)/aird(i,k)*rec_grav<a name='1575'></font>
  iDZ = DE*GRAV*iDP<a name='1576'>
  DZ  = 1./iDZ  <a name='1577'>
<a name='1578'>
 <font color=#447700>!Compute height above surface (zheight) and height above lowest prog level (zz):<a name='1579'></font>
  zheight(:,kbot)= DZ(:,kbot)<a name='1580'>
  zz(:,kbot)= 0.       <font color=#447700>!&lt;-- define height of lowest prognosic level to be 0. (for diagnostics only)<a name='1581'></font>
  do k = kbot+kdir,ktop,kdir<a name='1582'>
     zheight(:,k) = zheight(:,k-kdir) + DZ(:,k)<a name='1583'>
     zz(:,k)      = zz(:,k-kdir)      + DZ(:,k)<a name='1584'>
  enddo<a name='1585'>
<a name='1586'>
 <font color=#447700>!Determine the upper-most level in each column to which to compute sedimentation:<a name='1587'></font>
 <font color=#447700>!ktop_sedi= ktop+kdir !&lt;Optional (in place of code below) - to compute sedimentation at all levels<a name='1588'></font>
  ktop_sedi= 0<a name='1589'>
  do i=1,ni<a name='1590'>
     do k= ktop,kbot,-kdir<a name='1591'>
       ktop_sedi(i)= k<a name='1592'>
       if (zheight(i,k)&lt;zMax_sedi) exit<a name='1593'>
     enddo<a name='1594'>
  enddo<a name='1595'>
<a name='1596'>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='1597'></font>
<a name='1598'>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='1599'></font>
  <font color=#447700>!                 End of Preliminary Calculation section (Part 1)                  !<a name='1600'></font>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='1601'></font>
<a name='1602'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_3">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.true.,DEBUG_abort,400)<a name='1603'>
<a name='1604'>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='1605'></font>
  <font color=#447700>!                      PART 2: Cold Microphysics Processes                         !<a name='1606'></font>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='1607'></font>
<a name='1608'>
<font color=#447700>! Determine the active grid points (i.e. those which scheme should treat):<a name='1609'></font>
  activePoint = .false.<a name='1610'>
  DO k= ktop-kdir,kbot,-kdir<a name='1611'>
     DO i=1,ni<a name='1612'>
        log1= ((QI(i,k)+QG(i,k)+QN(i,k)+QH(i,k))&lt;epsQ)     <font color=#447700>!no solid  (i,g,s,h)<a name='1613'></font>
        log2= ((QC(i,k)+QR(i,k))                  &lt;epsQ)   <font color=#447700>!no liquid (c,r)<a name='1614'></font>
        log3= ((T(i,k)&gt;TRPL) .and. log1)                   <font color=#447700>!T&gt;0C &amp; no i,g,s,h<a name='1615'></font>
        log4= log1.and.log2.and.(Q(i,k)&lt;QSI(i,k))          <font color=#447700>!no sol. or liq.; subsat(i)<a name='1616'></font>
        if (.not.( log3 .or. log4 ) .and. icephase_ON) then<a name='1617'>
          activePoint(i,k)= .true.<a name='1618'>
        endif<a name='1619'>
     ENDDO<a name='1620'>
  ENDDO<a name='1621'>
<a name='1622'>
    <font color=#447700>! Size distribution parameters:<a name='1623'></font>
    <font color=#447700>!  Note: + 'thrd' should actually be '1/dmx'(but dmx=3 for all categories x)<a name='1624'></font>
    <font color=#447700>!        + If Qx=0, LAMx etc. are never be used in any calculations<a name='1625'></font>
    <font color=#447700>!          (If Qc=0, CLcy etc. will never be calculated. iLAMx is set to 0<a name='1626'></font>
    <font color=#447700>!           to avoid possible problems due to bugs.)<a name='1627'></font>
<a name='1628'>
  DO k= ktop-kdir,kbot,-kdir<a name='1629'>
    DO i= 1,ni<a name='1630'>
      IF (activePoint(i,k)) THEN<a name='1631'>
<a name='1632'>
       Tc= T(i,k)-TRPL<a name='1633'>
       if (Tc&lt;-120. .or. Tc&gt;50.) then<a name='1634'>
          print*, '***WARNING*** -- In MICROPHYSICS --  Ambient Temp.(C),step,i,k:',Tc,kount,i,k<a name='1635'>
         <font color=#447700>!stop<a name='1636'></font>
       endif<a name='1637'>
       Cdiff = (2.2157e-5+0.0155e-5*Tc)*1.e5/pres(i,k)<a name='1638'>
       MUdyn = 1.72e-5*(393./(T(i,k)+120.))*(T(i,k)/TRPL)**1.5 <font color=#447700>!RYp.102<a name='1639'></font>
       MUkin = MUdyn*iDE(i,k)<a name='1640'>
       iMUkin= 1./MUkin<a name='1641'>
       ScTHRD= (MUkin/Cdiff)**thrd       <font color=#447700>! i.e. Sc^(1/3)<a name='1642'></font>
       Ka    = 2.3971e-2 + 0.0078e-2*Tc                                   <font color=#447700>!therm.cond.(air)<a name='1643'></font>
       Kdiff = (9.1018e-11*T(i,k)*T(i,k)+8.8197e-8*T(i,k)-(1.0654e-5)) <font color=#447700>!therm.diff.(air)<a name='1644'></font>
       gam   = gamfact(i,k)<a name='1645'>
<a name='1646'>
      <font color=#447700>!Collection efficiencies:<a name='1647'></font>
       Eis   = min(0.05*exp(0.1*Tc),1.)     <font color=#447700>!Ferrier, 1995 (Table 1)<a name='1648'></font>
       Eig   = min(0.01*exp(0.1*Tc),1.)     <font color=#447700>!dry (Eig=1.0 for wet growth)<a name='1649'></font>
       Eii   = 0.1*Eis<a name='1650'>
       Ess   = Eis;   Eih = Eig;   Esh = Eig<a name='1651'>
       iEih  = 1./Eih<a name='1652'>
       iEsh  = 1./Esh<a name='1653'>
       <font color=#447700>!note:  Eri=Ers=Erh=1. (constant parameters)<a name='1654'></font>
       <font color=#447700>!       - Ecs is computed in CLcs section<a name='1655'></font>
       <font color=#447700>!       - Ech is computed in CLch section<a name='1656'></font>
       <font color=#447700>!       - Ecg is computed in CLcg section<a name='1657'></font>
       <font color=#447700>!       - Erg is computed in CLrg section<a name='1658'></font>
<a name='1659'>
       qvs0   = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_10">(TRPL,pres(i,k),0)      <font color=#447700>!sat.mix.ratio at 0C<a name='1660'></font>
       DELqvs = qvs0-(Q(i,k))<a name='1661'>
<a name='1662'>
    <font color=#447700>! Cloud:<a name='1663'></font>
       if (QC(i,k)&gt;epsQ) then<a name='1664'>
          iQC   = 1./QC(i,k)<a name='1665'>
          iNC   = 1./NC(i,k)<a name='1666'>
          Dc     = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_1">(DE(i,k),QC(i,k),iNC,icmr,thrd)<a name='1667'>
<a name='1668'>
          iLAMc  = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#ILAMDA_X'>iLAMDA_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ILAMDA_X_1">(DE(i,k),QC(i,k),iNC,icexc9,thrd)<a name='1669'>
          iLAMc2 = iLAMc *iLAMc<a name='1670'>
          iLAMc3 = iLAMc2*iLAMc<a name='1671'>
          iLAMc4 = iLAMc2*iLAMc2<a name='1672'>
          iLAMc5 = iLAMc3*iLAMc2<a name='1673'>
       else<a name='1674'>
          Dc     = 0.;   iLAMc3= 0.<a name='1675'>
          iLAMc  = 0.;   iLAMc4= 0.<a name='1676'>
          iLAMc2 = 0.;   iLAMc5= 0.<a name='1677'>
       endif<a name='1678'>
<a name='1679'>
    <font color=#447700>! Rain:<a name='1680'></font>
       if (QR(i,k)&gt;epsQ) then<a name='1681'>
          iQR   = 1./QR(i,k)<a name='1682'>
          iNR   = 1./NR(i,k)<a name='1683'>
          Dr     = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_2">(DE(i,k),QR(i,k),iNR,icmr,thrd)<a name='1684'>
          iLAMr  = max( iLAMmin1, iLAMDA_x(DE(i,k),QR(i,k),iNR,icexr9,thrd) )<a name='1685'>
          tmp1   = 1./iLAMr<a name='1686'>
          iLAMr2 = iLAMr**2<a name='1687'>
          iLAMr3 = iLAMr**3<a name='1688'>
          iLAMr4 = iLAMr**4<a name='1689'>
          iLAMr5 = iLAMr**5<a name='1690'>
          if (Dr&gt;40.e-6) then<a name='1691'>
             vr0 = gamfact(i,k)*ckQr1*iLAMr**bfr<a name='1692'>
          else<a name='1693'>
             vr0 = 0.<a name='1694'>
          endif<a name='1695'>
       else<a name='1696'>
          iLAMr  = 0.;  Dr    = 0.;  vr0   = 0.<a name='1697'>
          iLAMr2 = 0.;  iLAMr3= 0.;  iLAMr4= 0.;  iLAMr5 = 0.<a name='1698'>
       endif<a name='1699'>
<a name='1700'>
    <font color=#447700>! Ice:<a name='1701'></font>
       if (QI(i,k)&gt;epsQ) then<a name='1702'>
          iQI   = 1./QI(i,k)<a name='1703'>
          iNY   = 1./NY(i,k)<a name='1704'>
          iLAMi  = max( iLAMmin2, iLAMDA_x(DE(i,k),QI(i,k),iNY,icexi9,thrd) )<a name='1705'>
          iLAMi2 = iLAMi**2<a name='1706'>
          iLAMi3 = iLAMi**3<a name='1707'>
          iLAMi4 = iLAMi**4<a name='1708'>
          iLAMi5 = iLAMi**5<a name='1709'>
          iLAMiB0= iLAMi**(bfi)<a name='1710'>
          iLAMiB1= iLAMi**(bfi+1.)<a name='1711'>
          iLAMiB2= iLAMi**(bfi+2.)<a name='1712'>
          vi0    = gamfact(i,k)*ckQi1*iLAMiB0<a name='1713'>
          Di     = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_3">(DE(i,k),QI(i,k),iNY,icmi,thrd)<a name='1714'>
       else<a name='1715'>
          iLAMi  = 0.;  vi0    = 0.;  Di     = 0.<a name='1716'>
          iLAMi2 = 0.;  iLAMi3 = 0.;  iLAMi4 = 0.;  iLAMi5= 0.<a name='1717'>
          iLAMiB0= 0.;  iLAMiB1= 0.;  iLAMiB2= 0.<a name='1718'>
       endif<a name='1719'>
<a name='1720'>
    <font color=#447700>! Snow:<a name='1721'></font>
       if (QN(i,k)&gt;epsQ) then<a name='1722'>
          iQN   = 1./QN(i,k)<a name='1723'>
          iNN   = 1./NN(i,k)<a name='1724'>
          iLAMs  = max( iLAMmin2, iLAMDA_x(DE(i,k),QN(i,k),iNN,iGS20,idms) )<a name='1725'>
          iLAMs_D3= max(iLAMmin2, iLAMDA_x(DE(i,k),QN(i,k),iNN,iGS20_D3,thrd) )<a name='1726'>
          iLAMs2 = iLAMs**2<a name='1727'>
          iLAMsB0= iLAMs**(bfs)<a name='1728'>
          iLAMsB1= iLAMs**(bfs+1.)<a name='1729'>
          iLAMsB2= iLAMs**(bfs+2.)<a name='1730'>
          vs0    = gamfact(i,k)*ckQs1*iLAMsB0<a name='1731'>
          Ds     = min(DsMax, Dm_x(DE(i,k),QN(i,k),iNN,icms,idms))<a name='1732'>
          if (snowSpherical) then<a name='1733'>
             des = desFix<a name='1734'>
          else<a name='1735'>
             des = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DES_OF_DS'>des_OF_Ds</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DES_OF_DS_1">(Ds,desMax,eds,fds)<a name='1736'>
          endif<a name='1737'>
         <font color=#447700>!!-- generalized equations (any alpha_s):<a name='1738'></font>
         <font color=#447700>!    No_s  = (NN(i,k))*iGS31/iLAMs**(1.+alpha_s)<a name='1739'></font>
         <font color=#447700>!    VENTs = Avx*GS32*iLAMs**(2.+alpha_s)+Bvx*ScTHRD*sqrt(gam*afs*iMUkin)*      &amp;<a name='1740'></font>
         <font color=#447700>!!--         GS09*iLAMs**(2.5+0.5*bfs+alpha_s)<a name='1741'></font>
         <font color=#447700>!The following equations for No_s and VENTs is based on m(D)=(pi/6)*100.*D**3 for snow.<a name='1742'></font>
         <font color=#447700>!  Strict application of m(D)=c*D**2 would require re-derivation using implied<a name='1743'></font>
         <font color=#447700>!  definition of D as the MAXIMUM DIMENSION of an ellipsoid, rather than a sphere.<a name='1744'></font>
         <font color=#447700>!  For simplicity, the m-D^3 relation is applied -- used for VDvs and MLsr only.<a name='1745'></font>
        <font color=#447700>!No_s= NN(i,k)*iGS31/iLAMs     !optimized for alpha_s=0<a name='1746'></font>
         No_s= NN(i,k)*iGS31/iLAMs_D3  <font color=#447700>!based on m-D^3 (consistent with VENTs, below)<a name='1747'></font>
         VENTs= Avx*GS32*iLAMs_D3**2. + Bvx*ScTHRD*sqrt(gamfact(i,k)*afs*iMUkin)*GS09*   &amp;<a name='1748'>
                iLAMs_D3**cexs1<a name='1749'>
       else<a name='1750'>
          iLAMs  = 0.;  vs0    = 0.;  Ds     = 0.;  iLAMs2= 0.<a name='1751'>
          iLAMsB0= 0.;  iLAMsB1= 0.;  iLAMsB1= 0.<a name='1752'>
          des    = desFix <font color=#447700>!used for 3-component freezing if QN=0 (even for snowSpherical=.F.)<a name='1753'></font>
       endif<a name='1754'>
       ides  = 1./des<a name='1755'>
<a name='1756'>
<a name='1757'>
    <font color=#447700>! Graupel:<a name='1758'></font>
       if (QG(i,k)&gt;epsQ) then<a name='1759'>
          iQG    = 1./QG(i,k)<a name='1760'>
          iNG    = 1./NG(i,k)<a name='1761'>
          iLAMg  = max( iLAMmin1, iLAMDA_x(DE(i,k),QG(i,k),iNG,iGG99,thrd) )<a name='1762'>
          iLAMg2 = iLAMg**2<a name='1763'>
          iLAMgB0= iLAMg**(bfg)<a name='1764'>
          iLAMgB1= iLAMg**(bfg+1.)<a name='1765'>
          iLAMgB2= iLAMg**(bfg+2.)<a name='1766'>
         <font color=#447700>!No_g = (NG(i,k))*iGG31/iLAMg**(1.+alpha_g)<a name='1767'></font>
          No_g= NG(i,k)*iGG31/iLAMg     <font color=#447700>!optimized for alpha_g=0<a name='1768'></font>
          vg0    = gamfact(i,k)*ckQg1*iLAMgB0<a name='1769'>
          Dg     = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_4">(DE(i,k),QG(i,k),iNG,icmg,thrd)<a name='1770'>
       else<a name='1771'>
          iLAMg  = 0.;  vg0    = 0.;  Dg     = 0.;  No_g   = 0.<a name='1772'>
          iLAMg2 = 0.;  iLAMgB0= 0.;  iLAMgB1= 0.;  iLAMgB1= 0.<a name='1773'>
       endif<a name='1774'>
<a name='1775'>
    <font color=#447700>! Hail:<a name='1776'></font>
       if (QH(i,k)&gt;epsQ) then<a name='1777'>
          iQH    = 1./QH(i,k)<a name='1778'>
          iNH    = 1./NH(i,k)<a name='1779'>
          iLAMh  = max( iLAMmin1, iLAMDA_x(DE(i,k),QH(i,k),iNH,iGH99,thrd) )<a name='1780'>
          iLAMh2 = iLAMh**2<a name='1781'>
          iLAMhB0= iLAMh**(bfh)<a name='1782'>
          iLAMhB1= iLAMh**(bfh+1.)<a name='1783'>
          iLAMhB2= iLAMh**(bfh+2.)<a name='1784'>
          No_h= NH(i,k)*iGH31/iLAMh**(1.+alpha_h)<a name='1785'>
          vh0    = gamfact(i,k)*ckQh1*iLAMhB0<a name='1786'>
          Dh     = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_5">(DE(i,k),QH(i,k),iNH,icmh,thrd)<a name='1787'>
       else<a name='1788'>
          iLAMh  = 0.;  vh0    = 0.;  Dh     = 0.;  No_h= 0.<a name='1789'>
          iLAMhB0= 0.;  iLAMhB1= 0.;  iLAMhB1= 0.<a name='1790'>
       endif<a name='1791'>
<font color=#447700>!------<a name='1792'></font>
<a name='1793'>
 <font color=#447700>!Calculating ice-phase source/sink terms:<a name='1794'></font>
<a name='1795'>
 <font color=#447700>! Initialize all source terms to zero:<a name='1796'></font>
       QNUvi=0.;  QVDvi=0.;  QVDvs=0.;  QVDvg=0.;  QVDvh=0.<a name='1797'>
       QCLcs=0.;  QCLcg=0.;  QCLch=0.;  QFZci=0.;  QCLri=0.;   QMLsr=0.<a name='1798'>
       QCLrs=0.;  QCLrg=0.;  QMLgr=0.;  QCLrh=0.;  QMLhr=0.;   QFZrh=0.<a name='1799'>
       QMLir=0.;  QCLsr=0.;  QCLsh=0.;  QCLgr=0.;  QCNgh=0.<a name='1800'>
       QCNis=0.;  QCLir=0.;  QCLis=0.;  QCLih=0.<a name='1801'>
       QIMsi=0.;  QIMgi=0.;  QCNsg=0.;  QHwet=0.<a name='1802'>
<a name='1803'>
       NCLcs= 0.; NCLcg=0.;  NCLch=0.;  NFZci=0.;  NMLhr=0.;   NhCNgh=0.<a name='1804'>
       NCLri= 0.; NCLrs=0.;  NCLrg=0.;  NCLrh=0.;  NMLsr=0.;   NMLgr=0.<a name='1805'>
       NMLir= 0.; NSHhr=0.;  NNUvi=0.;  NVDvi=0.;  NVDvh=0.;   QCLig=0.<a name='1806'>
       NCLir= 0.; NCLis=0.;  NCLig=0.;  NCLih=0.;  NIMsi=0.;   NIMgi=0.<a name='1807'>
       NiCNis=0.; NsCNis=0.; NVDvs=0.;  NCNsg=0.;  NCLgr=0.;   NCLsrh=0.<a name='1808'>
       NCLss= 0.; NCLsr=0.;  NCLsh=0.;  NCLsrs=0.; NCLgrg=0.;  NgCNgh=0.<a name='1809'>
       NVDvg= 0.; NCLirg=0.; NCLsrg=0.; NCLgrh=0.; NrFZrh=0.;  NhFZrh=0.<a name='1810'>
       NCLirh=0.<a name='1811'>
<a name='1812'>
       Dirg=0.; Dirh=0.; Dsrs= 0.; Dsrg= 0.; Dsrh= 0.; Dgrg=0.; Dgrh=0.<a name='1813'>
<a name='1814'>
   <font color=#447700>!-------------------------------------------------------------------------------------------!<a name='1815'></font>
<a name='1816'>
       Si    = Q(i,k)/QSI(i,k)<a name='1817'>
       iABi  = 1./( CHLS*CHLS/(Ka*RGASV*T(i,k)**2) + 1./(DE(i,k)*(QSI(i,k))*Cdiff) )<a name='1818'>
<a name='1819'>
           <font color=#447700>! COLLECTION by snow, graupel, hail:<a name='1820'></font>
           <font color=#447700>!  (i.e. wet or dry ice-categories [=&gt; excludes ice crystals])<a name='1821'></font>
<a name='1822'>
           <font color=#447700>! Collection by SNOW:<a name='1823'></font>
       if (QN(i,k)&gt;epsQ) then<a name='1824'>
          <font color=#447700>! cloud:<a name='1825'></font>
          if (QC(i,k)&gt;epsQ) then<a name='1826'>
<a name='1827'>
            <font color=#447700>!Approximation of Ecs based on Pruppacher &amp; Klett (1997) Fig. 14-11<a name='1828'></font>
             Ecs= min(Dc,30.e-6)*3.333e+4*sqrt(min(Ds,1.e-3)*1.e+3)<a name='1829'>
             QCLcs= dt*gam*afs*cmr*Ecs*PIov4*iDE(i,k)*(NC(i,k)*NN(i,k))*iGC5*iGS31*    &amp;<a name='1830'>
                    (GC13*GS13*iLAMc3*iLAMsB2+2.*GC14*GS12*iLAMc4*iLAMsB1+GC15*GS11*     &amp;<a name='1831'>
                    iLAMc5*iLAMsB0)<a name='1832'>
<a name='1833'>
             NCLcs= dt*gam*afs*PIov4*Ecs*(NC(i,k)*NN(i,k))*iGC5*iGS31*(GC5*GS13*       &amp;<a name='1834'>
                    iLAMsB2+2.*GC11*GS12*iLAMc*iLAMsB1+GC12*GS11*iLAMc2*iLAMsB0)<a name='1835'>
<a name='1836'>
            <font color=#447700>!continuous collection: (alternative; gives values ~0.95 of SCE [above])<a name='1837'></font>
            <font color=#447700>!QCLcs= dt*gam*Ecs*PIov4*afs*QC(i,k)*NN(i,k)*iLAMs**(2.+bfs)*GS13*iGS31<a name='1838'></font>
            <font color=#447700>!NCLcs= QCLcs*NC(i,k)/QC(i,k)<a name='1839'></font>
<a name='1840'>
            <font color=#447700>!Correction factor for non-spherical snow [D = maximum dimension] which<a name='1841'></font>
            <font color=#447700>!changes projected area:   [assumption: A=0.50*D**2 (vs. A=(PI/4)*D**2)]<a name='1842'></font>
            <font color=#447700>! note: Strictly speaking, this correction should only be applied to<a name='1843'></font>
            <font color=#447700>!       continuous growth approximation for cloud.  [factor = 0.50/(pi/4)]<a name='1844'></font>
             if (.not. snowSpherical) then<a name='1845'>
                tmp1 = 0.6366      <font color=#447700>!factor = 0.50/(pi/4)<a name='1846'></font>
                QCLcs= tmp1*QCLcs<a name='1847'>
                NCLcs= tmp1*NCLcs<a name='1848'>
             endif<a name='1849'>
<a name='1850'>
             QCLcs= min(QCLcs, QC(i,k))<a name='1851'>
             NCLcs= min(NCLcs, NC(i,k))<a name='1852'>
          else<a name='1853'>
             QCLcs= 0.;   NCLcs= 0.<a name='1854'>
          endif<a name='1855'>
<a name='1856'>
          <font color=#447700>! ice:<a name='1857'></font>
          if (QI(i,k)&gt;epsQ) then<a name='1858'>
             tmp1= vs0-vi0<a name='1859'>
             tmp3= sqrt(tmp1*tmp1+0.04*vs0*vi0)<a name='1860'>
<a name='1861'>
             QCLis= dt*cmi*iDE(i,k)*PI*6.*Eis*(NY(i,k)*NN(i,k))*tmp3*iGI31*iGS31*(0.5* &amp;<a name='1862'>
                    iLAMs2*iLAMi3+2.*iLAMs*iLAMi4+5.*iLAMi5)<a name='1863'>
<a name='1864'>
             NCLis= dt*PIov4*Eis*(NY(i,k)*NN(i,k))*GI31*GS31*tmp3*(GI33*GS31*iLAMi2+   &amp;<a name='1865'>
                    2.*GI32*GS32*iLAMi*iLAMs+GI31*GS33*iLAMs2)<a name='1866'>
<a name='1867'>
             QCLis= min(QCLis, (QI(i,k)))<a name='1868'>
             NCLis= min(QCLis*(NY(i,k)*iQI), NCLis)<a name='1869'>
          else<a name='1870'>
             QCLis= 0.;   NCLis= 0.<a name='1871'>
          endif<a name='1872'>
<a name='1873'>
          <font color=#447700>!snow: (i.e. self-collection [aggregation])<a name='1874'></font>
          NCLss= dt*0.93952*Ess*(DE(i,k)*(QN(i,k)))**((2.+bfs)*thrd)*(NN(i,k))**         &amp;<a name='1875'>
                   ((4.-bfs)*thrd)<a name='1876'>
            <font color=#447700>!Note: 0.91226 = I(bfs)*afs*PI^((1-bfs)/3)*des^((-2-bfs)/3); I(bfs=0.41)=1138<a name='1877'></font>
            <font color=#447700>!      0.93952 = I(bfs)*afs*PI^((1-bfs)/3)*des^((-2-bfs)/3); I(bfs=0.42)=1172<a name='1878'></font>
            <font color=#447700>!      [interpolated from 3rd-order polynomial approx. of values given in RRB98;<a name='1879'></font>
            <font color=#447700>!       see eqn(A.35)]<a name='1880'></font>
           NCLss= min(NCLss, 0.5*(NN(i,k)))<a name='1881'>
<a name='1882'>
       else<a name='1883'>
          QCLcs= 0.;   NCLcs= 0.;   QCLis= 0.;   NCLis= 0.;  NCLss= 0.<a name='1884'>
       endif<a name='1885'>
<a name='1886'>
       <font color=#447700>! Collection by GRAUPEL:<a name='1887'></font>
       if (QG(i,k)&gt;epsQ) then<a name='1888'>
<a name='1889'>
          <font color=#447700>! cloud:<a name='1890'></font>
          if (QC(i,k)&gt;epsQ) then<a name='1891'>
<a name='1892'>
            <font color=#447700>!(parameterization of Ecg based on Cober and List, 1993 [JAS])<a name='1893'></font>
             Kstoke = dew*vg0*Dc*Dc/(9.*MUdyn*Dg)<a name='1894'>
             Kstoke = max(1.5,min(10.,Kstoke))<a name='1895'>
             Ecg    = 0.55*log10(2.51*Kstoke)<a name='1896'>
<a name='1897'>
             QCLcg= dt*gam*afg*cmr*Ecg*PIov4*iDE(i,k)*(NC(i,k)*NG(i,k))*iGC5*iGG31*      &amp;<a name='1898'>
                    (GC13*GG13*iLAMc3*iLAMgB2+ 2.*GC14*GG12*iLAMc4*iLAMgB1+GC15*GG11*    &amp;<a name='1899'>
                    iLAMc5*iLAMgB0)<a name='1900'>
<a name='1901'>
             NCLcg= dt*gam*afg*PIov4*Ecg*(NC(i,k)*NG(i,k))*iGC5*iGG31*(GC5*GG13*         &amp;<a name='1902'>
                    iLAMgB2+2.*GC11*GG12*iLAMc*iLAMgB1+GC12*GG11*iLAMc2*iLAMgB0)<a name='1903'>
<a name='1904'>
             QCLcg= min(QCLcg, (QC(i,k)))<a name='1905'>
             NCLcg= min(NCLcg, (NC(i,k)))<a name='1906'>
          else<a name='1907'>
             QCLcg= 0.;   NCLcg= 0.<a name='1908'>
          endif<a name='1909'>
<a name='1910'>
          <font color=#447700>! ice:<a name='1911'></font>
          if (QI(i,k)&gt;epsQ) then<a name='1912'>
             tmp1= vg0-vi0<a name='1913'>
             tmp3= sqrt(tmp1*tmp1+0.04*vg0*vi0)<a name='1914'>
<a name='1915'>
             QCLig= dt*cmi*iDE(i,k)*PI*6.*Eig*(NY(i,k)*NG(i,k))*tmp3*iGI31*iGG31*(0.5*   &amp;<a name='1916'>
                    iLAMg2*iLAMi3+2.*iLAMg*iLAMi4+5.*iLAMi5)<a name='1917'>
             NCLig= dt*PIov4*Eig*(NY(i,k)*NG(i,k))*GI31*GG31*tmp3*(GI33*GG31*iLAMi2+     &amp;<a name='1918'>
                    2.*GI32*GG32*iLAMi*iLAMg+GI31*GG33*iLAMg2)<a name='1919'>
<a name='1920'>
             QCLig= min(QCLig, (QI(i,k)))<a name='1921'>
             NCLig= min(QCLig*(NY(i,k)*iQI), NCLig)<a name='1922'>
          else<a name='1923'>
             QCLig= 0.;   NCLig= 0.<a name='1924'>
          endif<a name='1925'>
<a name='1926'>
         <font color=#447700>!Deposition/sublimation:<a name='1927'></font>
          VENTg= Avx*GG32*iLAMg*iLAMg+Bvx*ScTHRD*sqrt(gam*afg*iMUkin)*GG09*iLAMg**       &amp;<a name='1928'>
                 (2.5+0.5*bfg+alpha_g)<a name='1929'>
<font color=#447700>!         QVDvg = dt*iDE(i,k)*iABi*(PI2*(Si-1.)*No_g*VENTg - CHLS*CHLF/(Ka*RGASV*        &amp;<a name='1930'></font>
<font color=#447700>!                   T(i,k)**2)*QCLcg*idt)<a name='1931'></font>
          QVDvg = dt*iDE(i,k)*iABi*(PI2*(Si-1.)*No_g*VENTg)   <font color=#447700>!neglect accretion term<a name='1932'></font>
          <font color=#447700>! Prevent overdepletion of vapor:<a name='1933'></font>
          VDmax = (Q(i,k)-QSI(i,k))/(1.+ck6*QSI(i,k)/(T(i,k)-7.66)**2)  <font color=#447700>!KY97_A.33<a name='1934'></font>
          if(Si&gt;=1.) then<a name='1935'>
             QVDvg= min(max(QVDvg,0.),VDmax)<a name='1936'>
          else<a name='1937'>
             if (VDmax&lt;0.) QVDvg= max(QVDvg,VDmax)<a name='1938'>
             <font color=#447700>!IF prevents subl.(QVDvs&lt;0 at t) changing to dep.(VDmax&gt;0 at t*)<a name='1939'></font>
          endif<a name='1940'>
         <font color=#447700>!NVDvg = -min(0.,NG(i,k)*iQG*QVDvg)  !assume slope  does not change during sublimation (pos. quantity)<a name='1941'></font>
          NVDvg = 0.                            <font color=#447700>!assume number does not change during sublimation<a name='1942'></font>
<a name='1943'>
       else<a name='1944'>
          QCLcg= 0.;   QCLrg= 0.;   QCLig= 0.<a name='1945'>
          NCLcg= 0.;   NCLrg= 0.;   NCLig= 0.<a name='1946'>
       endif<a name='1947'>
<a name='1948'>
       <font color=#447700>! Collection by HAIL:<a name='1949'></font>
       if (QH(i,k)&gt;epsQ) then<a name='1950'>
<a name='1951'>
         <font color=#447700>! cloud:<a name='1952'></font>
          if (QC(i,k)&gt;epsQ) then<a name='1953'>
             Ech  = exp(-8.68e-7*Dc**(-1.6)*Dh)    <font color=#447700>!Ziegler (1985) A24<a name='1954'></font>
<a name='1955'>
             QCLch= dt*gam*afh*cmr*Ech*PIov4*iDE(i,k)*(NC(i,k)*NH(i,k))*iGC5*iGH31*      &amp;<a name='1956'>
                    (GC13*GH13*iLAMc3*iLAMhB2+2.*GC14*GH12*iLAMc4*iLAMhB1+GC15*GH11*     &amp;<a name='1957'>
                    iLAMc5*iLAMhB0)<a name='1958'>
<a name='1959'>
             NCLch= dt*gam*afh*PIov4*Ech*(NC(i,k)*NH(i,k))*iGC5*iGH31*(GC5*GH13*         &amp;<a name='1960'>
                    iLAMhB2+2.*GC11*GH12*iLAMc*iLAMhB1+GC12*GH11*iLAMc2*iLAMhB0)<a name='1961'>
<a name='1962'>
             QCLch= min(QCLch, QC(i,k))<a name='1963'>
             NCLch= min(NCLch, NC(i,k))<a name='1964'>
          else<a name='1965'>
             QCLch= 0.;   NCLch= 0.<a name='1966'>
          endif<a name='1967'>
<a name='1968'>
          <font color=#447700>! rain:<a name='1969'></font>
          if (QR(i,k)&gt;epsQ) then<a name='1970'>
             tmp1= vh0-vr0<a name='1971'>
             tmp3= sqrt(tmp1*tmp1+0.04*vh0*vr0)<a name='1972'>
             QCLrh= dt*cmr*Erh*PIov4*iDE(i,k)*(NH(i,k)*NR(i,k))*iGR31*iGH31*tmp3*        &amp;<a name='1973'>
                    (GR36*GH31*iLAMr5+2.*GR35*GH32*iLAMr4*iLAMh+GR34*GH33*iLAMr3*iLAMh2)<a name='1974'>
<a name='1975'>
             NCLrh= dt*PIov4*Erh*(NH(i,k)*NR(i,k))*iGR31*iGH31*tmp3*(GR33*GH31*          &amp;<a name='1976'>
                    iLAMr2+2.*GR32*GH32*iLAMr*iLAMh+GR31*GH33*iLAMh2)<a name='1977'>
<a name='1978'>
             QCLrh= min(QCLrh, QR(i,k))<a name='1979'>
             NCLrh= min(NCLrh, QCLrh*(NR(i,k)*iQR))<a name='1980'>
          else<a name='1981'>
             QCLrh= 0.;   NCLrh= 0.<a name='1982'>
          endif<a name='1983'>
<a name='1984'>
          <font color=#447700>! ice:<a name='1985'></font>
          if (QI(i,k)&gt;epsQ) then<a name='1986'>
             tmp1 = vh0-vi0<a name='1987'>
             tmp3 = sqrt(tmp1*tmp1+0.04*vh0*vi0)<a name='1988'>
<a name='1989'>
             QCLih= dt*cmi*iDE(i,k)*PI*6.*Eih*(NY(i,k)*NH(i,k))*tmp3*iGI31*iGH31*(0.5*   &amp;<a name='1990'>
                    iLAMh2*iLAMi3+2.*iLAMh*iLAMi4+5.*iLAMi5)<a name='1991'>
<a name='1992'>
             NCLih= dt*PIov4*Eih*(NY(i,k)*NH(i,k))*GI31*GH31*tmp3*(GI33*GH31*iLAMi2+     &amp;<a name='1993'>
                    2.*GI32*GH32*iLAMi*iLAMh+GI31*GH33*iLAMh2)<a name='1994'>
<a name='1995'>
             QCLih= min(QCLih, QI(i,k))<a name='1996'>
             NCLih= min(QCLih*(NY(i,k)*iQI), NCLih)<a name='1997'>
          else<a name='1998'>
             QCLih= 0.;   NCLih= 0.<a name='1999'>
          endif<a name='2000'>
<a name='2001'>
          <font color=#447700>! snow:<a name='2002'></font>
          if (QN(i,k)&gt;epsQ) then<a name='2003'>
             tmp1 = vh0-vs0<a name='2004'>
             tmp3 = sqrt(tmp1*tmp1+0.04*vh0*vs0)<a name='2005'>
             tmp4 = iLAMs2*iLAMs2<a name='2006'>
<a name='2007'>
             if (snowSpherical) then<a name='2008'>
               <font color=#447700>!hardcoded for dms=3:<a name='2009'></font>
                QCLsh= dt*cms*iDE(i,k)*PI*6.*Esh*(NN(i,k)*NH(i,k))*tmp3*iGS31*iGH31*     &amp;<a name='2010'>
                       (0.5*iLAMh2*iLAMs2*iLAMs+2.*iLAMh*tmp4+5.*tmp4*iLAMs)<a name='2011'>
             else<a name='2012'>
               <font color=#447700>!hardcoded for dms=2:<a name='2013'></font>
                QCLsh= dt*cms*iDE(i,k)*PI*0.25*Esh*tmp3*NN(i,k)*NH(i,k)*iGS31*iGH31*     &amp;<a name='2014'>
                       (GH33*GS33*iLAMh**2.*iLAMs**2. + 2.*GH32*GS34*iLAMh*iLAMs**3. +   &amp;<a name='2015'>
                        GH31*GS35*iLAMs**4.)<a name='2016'>
             endif<a name='2017'>
<a name='2018'>
             NCLsh= dt*PIov4*Esh*(NN(i,k)*NH(i,k))*GS31*GH31*tmp3*(GS33*GH31*iLAMs2+     &amp;<a name='2019'>
                    2.*GS32*GH32*iLAMs*iLAMh+GS31*GH33*iLAMh2)<a name='2020'>
<a name='2021'>
             QCLsh= min(QCLsh, (QN(i,k)))<a name='2022'>
             NCLsh= min((NN(i,k)*iQN)*QCLsh, NCLsh, (NN(i,k)))<a name='2023'>
          else<a name='2024'>
             QCLsh= 0.;   NCLsh= 0.<a name='2025'>
          endif<a name='2026'>
<a name='2027'>
         <font color=#447700>!wet growth:<a name='2028'></font>
          VENTh= Avx*GH32*iLAMh**(2.+alpha_h) + Bvx*ScTHRD*sqrt(gam*afh*iMUkin)*GH09*    &amp;<a name='2029'>
                 iLAMh**(2.5+0.5*bfh+alpha_h)<a name='2030'>
          QHwet= max(0., dt*PI2*(DE(i,k)*CHLC*Cdiff*DELqvs-Ka*Tc)*No_h*iDE(i,k)/(CHLF+   &amp;<a name='2031'>
                 CPW*Tc)*VENTh+(QCLih*iEih+QCLsh*iEsh)*(1.-CPI*Tc/(CHLF+CPW*Tc)) )<a name='2032'>
<a name='2033'>
         <font color=#447700>!Deposition/sublimation:<a name='2034'></font>
<font color=#447700>!         QVDvh = dt*iDE(i,k)*iABi*(PI2*(Si-1.)*No_h*VENTh - CHLS*CHLF/(Ka*RGASV*        &amp;<a name='2035'></font>
<font color=#447700>!                   T(i,k)**2)*QCLch*idt)<a name='2036'></font>
          QVDvh = dt*iDE(i,k)*iABi*(PI2*(Si-1.)*No_h*VENTh)   <font color=#447700>!neglect acretion term<a name='2037'></font>
          <font color=#447700>!prevent overdepletion of vapor:<a name='2038'></font>
          VDmax = (Q(i,k)-QSI(i,k))/(1.+ck6*(QSI(i,k))/(T(i,k)-7.66)**2)  <font color=#447700>!KY97_A.33    ** USED BY OTHERS; COULD BE PUT ABOVE<a name='2039'></font>
          if(Si&gt;=1.) then<a name='2040'>
             QVDvh= min(max(QVDvh,0.),VDmax)<a name='2041'>
          else<a name='2042'>
             if (VDmax&lt;0.) QVDvh= max(QVDvh,VDmax)  <font color=#447700>!prevents subl.(QVDvs&lt;0 at t) changing to dep.(VDmax&gt;0 at t*)<a name='2043'></font>
          endif<a name='2044'>
<font color=#447700>!         NVDvh= -min(0.,NH(i,k)*iQH*QVDvh)  !assume SLOPE does not change during sublimation (pos. quantity)<a name='2045'></font>
          NVDvh= 0.                            <font color=#447700>!assume NUMBER does not change during sublimation<a name='2046'></font>
<a name='2047'>
       else<a name='2048'>
          QCLch= 0.;   QCLrh= 0.;   QCLih= 0.;   QCLsh= 0.;   QHwet= 0.<a name='2049'>
          NCLch= 0.;   NCLrh= 0.;   NCLsh= 0.;   NCLih= 0.<a name='2050'>
       endif<a name='2051'>
<a name='2052'>
       IF (T(i,k)&gt;TRPL .and. warmphase_ON) THEN<a name='2053'>
          <font color=#447700>!**********!<a name='2054'></font>
          <font color=#447700>!  T &gt; To  !<a name='2055'></font>
          <font color=#447700>!**********!<a name='2056'></font>
<a name='2057'>
          <font color=#447700>! MELTING of frozen particles:<a name='2058'></font>
          <font color=#447700>!  ICE:<a name='2059'></font>
          QMLir   = QI(i,k)  <font color=#447700>!all pristine ice melts in one time step<a name='2060'></font>
          QI(i,k)= 0.<a name='2061'>
          NMLir   = NY(i,k)<a name='2062'>
<a name='2063'>
          <font color=#447700>!  SNOW:<a name='2064'></font>
          if (QN(i,k)&gt;epsQ) then<a name='2065'>
             QMLsr= dt*(PI2*iDE(i,k)*iCHLF*No_s*VENTs*(Ka*Tc-CHLC*Cdiff*DELqvs) + CPW*   &amp;<a name='2066'>
                    iCHLF*Tc*(QCLcs+QCLrs)*idt)<a name='2067'>
             QMLsr= min(max(QMLsr,0.), QN(i,k))<a name='2068'>
             NMLsr= NN(i,k)*iQN*QMLsr<a name='2069'>
          else<a name='2070'>
             QMLsr= 0.;   NMLsr= 0.<a name='2071'>
          endif<a name='2072'>
<a name='2073'>
          <font color=#447700>!  GRAUPEL:<a name='2074'></font>
          if (QG(i,k)&gt;epsQ) then<a name='2075'>
             QMLgr= dt*(PI2*iDE(i,k)*iCHLF*No_g*VENTg*(Ka*Tc-CHLC*Cdiff*DELqvs) + CPW*   &amp;<a name='2076'>
                    iCHLF*Tc*(QCLcg+QCLrg)*idt)<a name='2077'>
             QMLgr= min(max(QMLgr,0.), QG(i,k))<a name='2078'>
             NMLgr= NG(i,k)*iQG*QMLgr<a name='2079'>
          else<a name='2080'>
             QMLgr= 0.;   NMLgr= 0.<a name='2081'>
          endif<a name='2082'>
<a name='2083'>
          <font color=#447700>!  HAIL:<a name='2084'></font>
          if (QH(i,k)&gt;epsQ.and.Tc&gt;5.) then<a name='2085'>
             VENTh= Avx*GH32*iLAMh**(2.+alpha_h) + Bvx*ScTHRD*sqrt(gam*afh*iMUkin)*GH09* &amp;<a name='2086'>
                    iLAMh**(2.5+0.5*bfh+alpha_h)<a name='2087'>
             QMLhr= dt*(PI2*iDE(i,k)*iCHLF*No_h*VENTh*(Ka*Tc-CHLC*Cdiff*DELqvs) + CPW/   &amp;<a name='2088'>
                    CHLF*Tc*(QCLch+QCLrh)*idt)<a name='2089'>
             QMLhr= min(max(QMLhr,0.), QH(i,k))<a name='2090'>
             NMLhr= NH(i,k)*iQH*QMLhr<a name='2091'>
             if(QCLrh&gt;0.) NMLhr= NMLhr*0.1   <font color=#447700>!Prevents problems when hail is ML &amp; CL<a name='2092'></font>
          else<a name='2093'>
             QMLhr= 0.;   NMLhr= 0.<a name='2094'>
          endif<a name='2095'>
<a name='2096'>
         <font color=#447700>! Cold (sub-zero) source/sink terms:<a name='2097'></font>
          QNUvi= 0.;   QFZci= 0.;   QVDvi= 0.;   QVDvs= 0.<a name='2098'>
          QCLis= 0.;   QCNis1=0.;   QCNis2=0.;   QCLri= 0.<a name='2099'>
          QCNgh= 0.;   QIMsi= 0.;   QIMgi= 0.;   QCLir= 0.<a name='2100'>
          QCLrs= 0.;   QCLgr= 0.;   QCLrg= 0.;   QCNis= 0.<a name='2101'>
          QCNsg= 0.;   QCLsr= 0.<a name='2102'>
<a name='2103'>
          NNUvi= 0.;   NFZci= 0.;   NCLgr= 0.;   NCLrg= 0.;   NgCNgh= 0.<a name='2104'>
          NCLis= 0.;   NVDvi= 0.;   NVDvs= 0.;   NCLri= 0.;   NCLsr= 0.<a name='2105'>
          NCNsg= 0.;   NhCNgh= 0.;  NiCNis=0.;   NsCNis=0.<a name='2106'>
          NIMsi= 0.;   NIMgi= 0.;   NCLir= 0.;   NCLrs= 0.<a name='2107'>
<a name='2108'>
       ELSE  <font color=#447700>!----------!<a name='2109'></font>
             <font color=#447700>!  T &lt; To  !<a name='2110'></font>
             <font color=#447700>!----------!<a name='2111'></font>
<a name='2112'>
          <font color=#447700>! Warm-air-only source/sink terms:<a name='2113'></font>
          QMLir= 0.;   QMLsr= 0.;   QMLgr= 0.;   QMLhr= 0.<a name='2114'>
          NMLir= 0.;   NMLsr= 0.;   NMLgr= 0.;   NMLhr= 0.<a name='2115'>
<a name='2116'>
          <font color=#447700>!Probabilistic freezing (Bigg) of rain:<a name='2117'></font>
          if (Tc&lt;Tc_FZrh .and. QR(i,k)&gt;epsQ .and. hail_ON) then<a name='2118'>
             <font color=#447700>!note: - (Tc&lt;-10.C) condition is based on Pruppacher-Klett (1997) Fig. 9-41<a name='2119'></font>
             <font color=#447700>!      - Small raindrops will freeze to hail. However, if after all S/S terms<a name='2120'></font>
             <font color=#447700>!        are added Dh&lt;Dh_min, then hail will be converted to graupel. Thus,<a name='2121'></font>
             <font color=#447700>!        probabilistic freezing of small rain is effectively a source of graupel.<a name='2122'></font>
             NrFZrh= -dt*Bbigg*(exp(Abigg*Tc)-1.)*DE(i,k)*QR(i,k)*idew<a name='2123'>
             Rz= 1.  <font color=#447700>!N and Z (and Q) are conserved for FZrh with triple-moment<a name='2124'></font>
           <font color=#447700>! The Rz factor serves to conserve reflectivity when a rain distribution<a name='2125'></font>
           <font color=#447700>!  converts to an distribution with a different shape parameter, alpha.<a name='2126'></font>
           <font color=#447700>!  (e.g. when rain freezes to hail)  The factor Rz non-conserves N while<a name='2127'></font>
           <font color=#447700>!  acting to conserve Z for double-moment.  See Ferrier, 1994 App. D)<a name='2128'></font>
           <font color=#447700>! Rz= (gamma(7.d0+alpha_h)*GH31*GR34*GR34)/(GR36(i,k)*GR31*   &amp;<a name='2129'></font>
           <font color=#447700>!      gamma(4.d0+alpha_h)*gamma(4.d0+alpha_h))<a name='2130'></font>
             NhFZrh= Rz*NrFZrh<a name='2131'>
             QFZrh = NrFZrh*(QR(i,k)*iNR)<a name='2132'>
          else<a name='2133'>
             QFZrh= 0.;   NrFZrh= 0.;  NhFZrh= 0.<a name='2134'>
          endif<a name='2135'>
<a name='2136'>
          <font color=#447700>!--------!<a name='2137'></font>
          <font color=#447700>!  ICE:  !<a name='2138'></font>
          <font color=#447700>!--------!<a name='2139'></font>
          <font color=#447700>! Homogeneous freezing of cloud to ice:<a name='2140'></font>
          if (QC(i,k)&gt;epsQ) then<a name='2141'>
             tmp2  = Tc*Tc; tmp3= tmp2*Tc; tmp4= tmp2*tmp2<a name='2142'>
             JJ    = (10.**max(-20.,(-606.3952-52.6611*Tc-1.7439*tmp2-0.0265*tmp3-    &amp;<a name='2143'>
                      1.536e-4*tmp4)))<a name='2144'>
             tmp1  = 1.e6*(DE(i,k)*(QC(i,k)*iNC)*icmr) <font color=#447700>!i.e. Dc[cm]**3<a name='2145'></font>
             FRAC  = 1.-exp(-JJ*PIov6*tmp1*dt)<a name='2146'>
             if (Tc&gt;-30.) FRAC= 0.<a name='2147'>
             if (Tc&lt;-50.) FRAC= 1.<a name='2148'>
             QFZci= FRAC*QC(i,k)<a name='2149'>
             NFZci= FRAC*NC(i,k)<a name='2150'>
          else<a name='2151'>
             QFZci= 0.;   NFZci= 0.<a name='2152'>
          endif<a name='2153'>
<a name='2154'>
          <font color=#447700>!Primary ice nucleation:<a name='2155'></font>
          NNUvi= 0.;   QNUvi= 0.<a name='2156'>
          if (primIceNucl==1) then<a name='2157'>
<a name='2158'>
             NuDEPSOR= 0.;   NuCONT= 0.<a name='2159'>
             if (QSI(i,k)&gt;1.e-20) then<a name='2160'>
                Simax = min(Si, satw_peak*QSW(i,k)/QSI(i,k))<a name='2161'>
             else<a name='2162'>
                Simax = 0.<a name='2163'>
             endif<a name='2164'>
             tmp1    = T(i,k)-7.66<a name='2165'>
             NNUmax  = max(0., DE(i,k)/mio*(Q(i,k)-QSI(i,k))/(1.+ck6*(QSI(i,k)/(tmp1*    &amp;<a name='2166'>
                       tmp1))))<a name='2167'>
             <font color=#447700>!Deposition/sorption nucleation:<a name='2168'></font>
             if (Tc&lt;-5. .and. Si&gt;1.) then<a name='2169'>
                NuDEPSOR= max(0., 1.e3*exp(12.96*(Simax-1.)-0.639)-(NY(i,k))) <font color=#447700>!Meyers(1992)<a name='2170'></font>
             endif<a name='2171'>
             <font color=#447700>!Contact nucleation:<a name='2172'></font>
             if (QC(i,k)&gt;epsQ .and. Tc&lt;-2. .and. WZ(i,k)&gt;0.001) then<a name='2173'>
                GG     =  1.*idew/(RGASV*(T(i,k))/((QSW(i,k)*pres(i,k))/EPS1)/          &amp;<a name='2174'>
                            Cdiff+CHLC/Ka/(T(i,k))*(CHLC/RGASV/(T(i,k))-1.))  <font color=#447700>!CP00a<a name='2175'></font>
                Swmax  =  <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SXFNC'>SxFNC</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SXFNC_1">(WZ(i,k),Tc,pres(i,k),QSW(i,k),QSI(i,k),CCNtype,1)<a name='2176'>
                if (QSW(i,k)&gt;1.e-20) then<a name='2177'>
                   ssat=  min((Q(i,k)/QSW(i,k)), Swmax) -1.<a name='2178'>
                else<a name='2179'>
                   ssat= 0.<a name='2180'>
                endif<a name='2181'>
                Tcc    =  Tc + GG*ssat*CHLC/Kdiff                            <font color=#447700>!C86_eqn64<a name='2182'></font>
                Na     =  exp(4.11-0.262*Tcc)                                <font color=#447700>!W95_eqn60/M92_2.6<a name='2183'></font>
                Kn     =  LAMa0*(T(i,k))*p0/(T0*pres(i,k)*Ra)               <font color=#447700>!W95_eqn59<a name='2184'></font>
                PSIa   =  -kBoltz*Tcc/(6.*pi*Ra*MUdyn)*(1.+Kn)               <font color=#447700>!W95_eqn58<a name='2185'></font>
                ft     =  0.4*(1.+1.45*Kn+0.4*Kn*exp(-1./Kn))*(Ka+2.5*Kn*KAPa)/          &amp;<a name='2186'>
                         (1.+3.*Kn)/(2.*Ka+5.*KAPa*Kn+KAPa)                  <font color=#447700>!W95_eqn57<a name='2187'></font>
                Dc     =  (DE(i,k)*(QC(i,k)*iNC)*icmr)**thrd<a name='2188'>
                F1     =  PI2*Dc*Na*(NC(i,k))                               <font color=#447700>!W95_eqn55<a name='2189'></font>
                F2     =  Ka/pres(i,k)*(Tc-Tcc)                              <font color=#447700>!W95_eqn56<a name='2190'></font>
                NuCONTA= -F1*F2*RGASV*(T(i,k))/CHLC*iDE(i,k)                <font color=#447700>!diffusiophoresis<a name='2191'></font>
                NuCONTB=  F1*F2*ft*iDE(i,k)                                  <font color=#447700>!thermeophoresis<a name='2192'></font>
                NuCONTC=  F1*PSIa                                            <font color=#447700>!Brownian diffusion<a name='2193'></font>
                NuCONT =  max(0.,(NuCONTA+NuCONTB+NuCONTC)*dt)<a name='2194'>
             endif<a name='2195'>
             <font color=#447700>!Total primary ice nucleation:<a name='2196'></font>
             if (icephase_ON) then<a name='2197'>
                NNUvi= min(NNUmax, NuDEPSOR + NuCONT )<a name='2198'>
                QNUvi= mio*iDE(i,k)*NNUvi<a name='2199'>
                QNUvi= min(QNUvi,(Q(i,k)))<a name='2200'>
             endif<a name='2201'>
<a name='2202'>
          elseif (primIceNucl==2) then<a name='2203'>
             if (Tc&lt;-5. .and. Si&gt;1.08) then <font color=#447700>!following Thompson etal (2006)<a name='2204'></font>
                NNUvi= max(N_Cooper(TRPL,T(i,k))-NY(i,k),0.)<a name='2205'>
                QNUvi= min(mio*iDE(i,k)*NNUvi, Q(i,k))<a name='2206'>
             endif<a name='2207'>
         <font color=#447700>!elseif (primIceNucl==3) then<a name='2208'></font>
         <font color=#447700>!! (for alternative [future] ice nucleation parameterizations)<a name='2209'></font>
         <font color=#447700>!   NNUvi=...<a name='2210'></font>
         <font color=#447700>!   QNUvi=...<a name='2211'></font>
          endif <font color=#447700>!if (primIceNucl==1)<a name='2212'></font>
<a name='2213'>
<a name='2214'>
<a name='2215'>
          IF (QI(i,k)&gt;epsQ) THEN<a name='2216'>
<a name='2217'>
             <font color=#447700>!Deposition/sublimation:<a name='2218'></font>
<font color=#447700>!            No_i  = NY(i,k)*iGI31/iLAMi**(1.+alpha_i)<a name='2219'></font>
<font color=#447700>!            VENTi= Avx*GI32*iLAMi**(2.+alpha_i)+Bvx*ScTHRD*sqrt(gam*afi*iMUkin)*GI6*    &amp;<a name='2220'></font>
<font color=#447700>!                     iLAMi**(2.5+0.5*bfi+alpha_i)<a name='2221'></font>
             No_i  = NY(i,k)*iGI31/iLAMi    <font color=#447700>!optimized for alpha_i=0<a name='2222'></font>
             VENTi= Avx*GI32*iLAMi*iLAMi+Bvx*ScTHRD*sqrt(gam*afi*iMUkin)*GI6*iLAMi**     &amp;<a name='2223'>
                    (2.5+0.5*bfi+alpha_i)<a name='2224'>
            <font color=#447700>!Note: ice crystal capacitance is implicitly C = 0.5*D*capFact_i<a name='2225'></font>
<font color=#447700>!            QVDvi= dt*capFact_i*iABi*(PI2*(Si-1.)*No_i*VENTi)<a name='2226'></font>
             QVDvi = dt*iDE(i,k)*capFact_i*iABi*(PI2*(Si-1.)*No_i*VENTi)<a name='2227'>
<a name='2228'>
             <font color=#447700>! Prevent overdepletion of vapor:<a name='2229'></font>
             VDmax = (Q(i,k)-QSI(i,k))/(1.+ck6*(QSI(i,k))/(T(i,k)-7.66)**2)<a name='2230'>
             if(Si&gt;=1.) then<a name='2231'>
                QVDvi= min(max(QVDvi,0.),VDmax)<a name='2232'>
             else<a name='2233'>
                if (VDmax&lt;0.) QVDvi= max(QVDvi,VDmax)<a name='2234'>
               <font color=#447700>!IF prevents subl.(QVDvi&lt;0 at t) changing to dep.(VDmax&gt;0 at t*)  2005-06-28<a name='2235'></font>
             endif<a name='2236'>
             if (.not. iceDep_ON) QVDvi= 0. <font color=#447700>!suppresses depositional growth<a name='2237'></font>
             NVDvi= min(0., (NY(i,k)*iQI)*QVDvi) <font color=#447700>!dNi/dt=0 for deposition<a name='2238'></font>
<a name='2239'>
             <font color=#447700>! Conversion to snow:<a name='2240'></font>
             if (QI(i,k)+QVDvi&gt;epsQ .and. NY(i,k)+NVDvi&gt;epsN) then<a name='2241'>
                tmp5   = iLAMi <font color=#447700>!hold value<a name='2242'></font>
                tmp6   = No_i  <font color=#447700>!hold value<a name='2243'></font>
               <font color=#447700>!estimate ice PSD after VDvi (if there were no CNis):<a name='2244'></font>
                tmp1   = QI(i,k) + QVDvi<a name='2245'>
                tmp2   = NY(i,k) + NVDvi<a name='2246'>
                tmp3   = 1./tmp2<a name='2247'>
                iLAMi  = max( iLAMmin2, iLAMDA_x(DE(i,k),tmp1,tmp3,icexi9,thrd) )<a name='2248'>
                No_i   = tmp2*iGI31/iLAMi    <font color=#447700>!optimized for alpha_i=0<a name='2249'></font>
               <font color=#447700>!compute number and mass of ice converted to snow as the integral from<a name='2250'></font>
               <font color=#447700>! Dso to INF of Ni(D)dD and m(D)Ni(D)dD, respectively:<a name='2251'></font>
                tmp4   = exp(-Dso/iLAMi)<a name='2252'>
                NiCNis = No_i*iLAMi*tmp4<a name='2253'>
                NsCNis = NiCNis<a name='2254'>
                QCNis  = cmi*No_i*tmp4*(Dso**3*iLAMi + 3.*Dso**2*iLAMi**2 + 6.*Dso*      &amp;<a name='2255'>
                         iLAMi**3 + 6.*iLAMi**4)<a name='2256'>
                iLAMi  = tmp5  <font color=#447700>!(restore value)<a name='2257'></font>
                No_i   = tmp6  <font color=#447700>!(restore value)<a name='2258'></font>
             endif<a name='2259'>
<a name='2260'>
             if (.not.(snow_ON)) then  <font color=#447700>!Suppress SNOW initiation (for testing only)<a name='2261'></font>
                QCNis  = 0.<a name='2262'>
                NiCNis = 0.<a name='2263'>
                NsCNis = 0.<a name='2264'>
             endif<a name='2265'>
<a name='2266'>
             <font color=#447700>! 3-component freezing (collisions with rain):<a name='2267'></font>
             if (QR(i,k)&gt;epsQ .and. QI(i,k)&gt;epsQ) then<a name='2268'>
                tmp1 = vr0-vi0<a name='2269'>
                tmp3 = sqrt(tmp1*tmp1+0.04*vr0*vi0)<a name='2270'>
<a name='2271'>
                QCLir= dt*cmi*Eri*PIov4*iDE(i,k)*(NR(i,k)*NY(i,k))*iGI31*iGR31*tmp3*     &amp;<a name='2272'>
                       (GI36*GR31*iLAMi5+2.*GI35*GR32*iLAMi4*iLAMr+GI34*GR33*iLAMi3*     &amp;<a name='2273'>
                       iLAMr2)<a name='2274'>
<a name='2275'>
                NCLri= dt*PIov4*Eri*(NR(i,k)*NY(i,k))*iGI31*iGR31*tmp3*(GI33*GR31*       &amp;<a name='2276'>
                       iLAMi2+2.*GI32*GR32*iLAMi*iLAMr+GI31*GR33*iLAMr2)<a name='2277'>
<a name='2278'>
                QCLri= dt*cmr*Eri*PIov4*iDE(i,k)*(NY(i,k)*NR(i,k))*iGR31*iGI31*tmp3*     &amp;<a name='2279'>
                       (GR36*GI31 *iLAMr5+2.*GR35*GI32*iLAMr4*iLAMi+GR34*GI33*iLAMr3*    &amp;<a name='2280'>
                       iLAMi2)<a name='2281'>
<a name='2282'>
               <font color=#447700>!note: For explicit eqns, both NCLri and NCLir are mathematically identical)<a name='2283'></font>
                NCLir= min(QCLir*(NY(i,k)*iQI), NCLri)<a name='2284'>
                QCLri= min(QCLri, (QR(i,k)));  QCLir= min(QCLir, (QI(i,k)))<a name='2285'>
                NCLri= min(NCLri, (NR(i,k)));  NCLir= min(NCLir, (NY(i,k)))<a name='2286'>
<a name='2287'>
                <font color=#447700>!Determine destination of 3-comp.freezing:<a name='2288'></font>
                tmp1= max(Di,Dr)<a name='2289'>
                dey= (dei*Di*Di*Di+dew*Dr*Dr*Dr)/(tmp1*tmp1*tmp1)<a name='2290'>
                if (dey&gt;0.5*(deg+deh) .and. Dr&gt;Dr_3cmpThrs .and. hail_ON) then<a name='2291'>
                   Dirg= 0.;  Dirh= 1.<a name='2292'>
                else<a name='2293'>
                   Dirg= 1.;  Dirh= 0.<a name='2294'>
                endif<a name='2295'>
                if (.not. grpl_ON) Dirg= 0.<a name='2296'>
<a name='2297'>
             else<a name='2298'>
                QCLir= 0.;  NCLir= 0.;  QCLri= 0.<a name='2299'>
                NCLri= 0.;  Dirh = 0.;  Dirg= 0.<a name='2300'>
             endif<a name='2301'>
<a name='2302'>
             <font color=#447700>!  Rime-splintering (ice multiplication):<a name='2303'></font>
             ff= 0.<a name='2304'>
             if(Tc&gt;=-8..and.Tc&lt;=-5.) ff= 3.5e8*(Tc +8.)*thrd<a name='2305'>
             if(Tc&gt; -5..and.Tc&lt; -3.) ff= 3.5e8*(-3.-Tc)*0.5<a name='2306'>
             NIMsi= DE(i,k)*ff*QCLcs<a name='2307'>
             NIMgi= DE(i,k)*ff*QCLcg<a name='2308'>
             QIMsi= mio*iDE(i,k)*NIMsi<a name='2309'>
             QIMgi= mio*iDE(i,k)*NIMgi<a name='2310'>
<a name='2311'>
          ELSE<a name='2312'>
<a name='2313'>
             QVDvi= 0.;  QCNis= 0.<a name='2314'>
             QIMsi= 0.;  QIMgi= 0.;   QCLri= 0.;   QCLir= 0.<a name='2315'>
             NVDvi= 0.;  NCLir= 0.;   NIMsi= 0.<a name='2316'>
             NiCNis=0.;  NsCNis=0.;   NIMgi= 0.;   NCLri= 0.<a name='2317'>
<a name='2318'>
          ENDIF<a name='2319'>
          <font color=#447700>!---------!<a name='2320'></font>
          <font color=#447700>!  SNOW:  !<a name='2321'></font>
          <font color=#447700>!---------!<a name='2322'></font>
          IF (QN(i,k)&gt;epsQ) THEN<a name='2323'>
<a name='2324'>
            <font color=#447700>!Deposition/sublimation:<a name='2325'></font>
             <font color=#447700>!note: - snow crystal capacitance is implicitly C = 0.5*D*capFact_s<a name='2326'></font>
             <font color=#447700>!      - No_s and VENTs are computed above<a name='2327'></font>
<font color=#447700>!             QVDvs = dt*capFact_s*iABi*(PI2*(Si-1.)*No_s*VENTs - CHLS*CHLF/(Ka*RGASV*    &amp;<a name='2328'></font>
<font color=#447700>!                     T(i,k)*T(i,k))*QCLcs*idt)<a name='2329'></font>
             QVDvs = dt*iDE(i,k)*capFact_s*iABi*(PI2*(Si-1.)*No_s*VENTs - CHLS*CHLF/(Ka* &amp;<a name='2330'>
                     RGASV*T(i,k)**2)*QCLcs*idt)<a name='2331'>
<a name='2332'>
             <font color=#447700>! Prevent overdepletion of vapor:<a name='2333'></font>
             VDmax = (Q(i,k)-QSI(i,k))/(1.+ck6*(QSI(i,k))/(T(i,k)-7.66)**2)<a name='2334'>
             if(Si&gt;=1.) then<a name='2335'>
                QVDvs= min(max(QVDvs,0.),VDmax)<a name='2336'>
             else<a name='2337'>
                if (VDmax&lt;0.) QVDvs= max(QVDvs,VDmax)<a name='2338'>
                <font color=#447700>!IF prevents subl.(QVDvs&lt;0 at t) changing to dep.(VDmax&gt;0 at t*)<a name='2339'></font>
             endif<a name='2340'>
             NVDvs= -min(0.,(NN(i,k)*iQN)*QVDvs)  <font color=#447700>!pos. quantity<a name='2341'></font>
<a name='2342'>
             <font color=#447700>! Conversion to graupel:<a name='2343'></font>
             if (QCLcs&gt;0. .and. QCLcs&gt;CNsgThres*QVDvs .and. grpl_ON) then<a name='2344'>
                tmp1 = 100.  <font color=#447700>!tuning factor: controls amount of mass either added or removed<a name='2345'></font>
                             <font color=#447700>!from snow (QN) during partial conversion to graupel. [If QCLcs/QN &gt; 1/tmp1,<a name='2346'></font>
                             <font color=#447700>!then some snow mass will be converted to graupel (in addition to rime mass).]<a name='2347'></font>
                QCNsg = min( QN(i,k)+QCLcs, QCLcs*(tmp1*QCLcs/QN(i,k)) )<a name='2348'>
               <font color=#447700>!calculate NCNsg: [explicit logic]<a name='2349'></font>
               <font color=#447700>!mgo   = DE(i,k)*(QN(i,k)+QCLsg)/NN(i,k)  !mean-mass of new graupel<a name='2350'></font>
               <font color=#447700>!NCNsg = DE(i,k)*QCNsg/mgo<a name='2351'></font>
               <font color=#447700>!calculate NCNsg: [optimized; substituting mgo and factoring]<a name='2352'></font>
                NCNsg = DE(i,k)*QCNsg/(QN(i,k)+QCLcs)<a name='2353'>
             else<a name='2354'>
                QCNsg = 0.<a name='2355'>
                NCNsg = 0.<a name='2356'>
             endif<a name='2357'>
<a name='2358'>
             <font color=#447700>! 3-component freezing (collisions with rain):<a name='2359'></font>
              if (QR(i,k)&gt;epsQ .and. QN(i,k)&gt;epsQ .and. Tc&lt;-5.) then<a name='2360'>
                tmp1 = vs0-vr0<a name='2361'>
                tmp2 = sqrt(tmp1*tmp1+0.04*vs0*vr0)<a name='2362'>
                tmp6 = iLAMs2*iLAMs2*iLAMs<a name='2363'>
<a name='2364'>
                QCLrs= dt*cmr*Ers*PIov4*iDE(i,k)*NN(i,k)*NR(i,k)*iGR31*iGS31*tmp2*       &amp;<a name='2365'>
                       (GR36*GS31*iLAMr5+2.*GR35*GS32*iLAMr4*iLAMs+GR34*GS33*iLAMr3*     &amp;<a name='2366'>
                       iLAMs2)<a name='2367'>
<a name='2368'>
                NCLrs= dt*0.25e0*PI*Ers*(NN(i,k)*NR(i,k))*iGR31*iGS31*tmp2*(GR33*        &amp;<a name='2369'>
                       GS31*iLAMr2+2.*GR32*GS32*iLAMr*iLAMs+GR31*GS33*iLAMs2)<a name='2370'>
<a name='2371'>
                if (snowSpherical) then<a name='2372'>
                  <font color=#447700>!hardcoded for dms=3:<a name='2373'></font>
                   QCLsr= dt*cms*Ers*PIov4*iDE(i,k)*(NR(i,k)*NN(i,k))*iGS31*iGR31*       &amp;<a name='2374'>
                          tmp2*(GS36*GR31*tmp6+2.*GS35*GR32*iLAMs2*iLAMs2*iLAMr+GS34*    &amp;<a name='2375'>
                          GR33*iLAMs2*iLAMs*iLAMr2)<a name='2376'>
                else<a name='2377'>
                  <font color=#447700>!hardcoded for dms=2:<a name='2378'></font>
                   QCLsr= dt*cms*iDE(i,k)*PI*0.25*ERS*tmp2*NN(i,k)*NR(i,k)*iGS31*        &amp;<a name='2379'>
                          iGR31*(GR33*GS33*iLAMr**2.*iLAMs**2. + 2.*GR32*GS34*iLAMr*     &amp;<a name='2380'>
                          iLAMs**3. +GR31*GS35*iLAMs**4.)<a name='2381'>
                endif<a name='2382'>
<a name='2383'>
               <font color=#447700>!note: For explicit eqns, NCLsr = NCLrs<a name='2384'></font>
                NCLsr= min(QCLsr*(NN(i,k)*iQN), NCLrs)<a name='2385'>
                QCLrs= min(QCLrs, QR(i,k));  QCLsr= min(QCLsr, QN(i,k))<a name='2386'>
                NCLrs= min(NCLrs, NR(i,k));  NCLsr= min(NCLsr, NN(i,k))<a name='2387'>
<a name='2388'>
                <font color=#447700>! Determine destination of 3-comp.freezing:<a name='2389'></font>
                Dsrs= 0.;   Dsrg= 0.;    Dsrh= 0.<a name='2390'>
                tmp1= max(Ds,Dr)<a name='2391'>
                tmp2= tmp1*tmp1*tmp1<a name='2392'>
                dey = (des*Ds*Ds*Ds + dew*Dr*Dr*Dr)/tmp2<a name='2393'>
                if (dey&lt;=0.5*(des+deg)                        ) Dsrs= 1.  <font color=#447700>!snow<a name='2394'></font>
                if (dey &gt;0.5*(des+deg) .and. dey&lt;0.5*(deg+deh)) Dsrg= 1.  <font color=#447700>!graupel<a name='2395'></font>
                if (dey&gt;=0.5*(deg+deh)) then<a name='2396'>
                   Dsrh= 1.                                               <font color=#447700>!hail<a name='2397'></font>
                   if (.not.hail_ON .or. Dr&lt;Dr_3cmpThrs) then<a name='2398'>
                      Dsrg= 1.;   Dsrh= 0.                                <font color=#447700>!graupel<a name='2399'></font>
                   endif<a name='2400'>
                endif<a name='2401'>
                if (.not. grpl_ON) Dsrg=0.<a name='2402'>
<a name='2403'>
             else<a name='2404'>
                QCLrs= 0.;   QCLsr= 0.;   NCLrs= 0.;   NCLsr= 0.<a name='2405'>
             endif<a name='2406'>
<a name='2407'>
          ELSE<a name='2408'>
<a name='2409'>
             QVDvs= 0.;  QCLcs= 0.;  QCNsg= 0.;  QCLsr= 0.;  QCLrs= 0.<a name='2410'>
             NVDvs= 0.;  NCLcs= 0.;  NCLsr= 0.;  NCLrs= 0.;  NCNsg= 0.<a name='2411'>
<a name='2412'>
          ENDIF<a name='2413'>
          <font color=#447700>!------------!<a name='2414'></font>
          <font color=#447700>!  GRAUPEL:  !<a name='2415'></font>
          <font color=#447700>!------------!<a name='2416'></font>
          IF (QG(i,k)&gt;epsQ .and. NG(i,k)&gt;epsN) THEN<a name='2417'>
<a name='2418'>
           <font color=#447700>!Conversion to hail:    (D_sll given by S-L limit)<a name='2419'></font>
             if ( (QCLcg+QCLrg)&gt;0. .and. hail_ON ) then<a name='2420'>
<font color=#447700>!               D_sll = 0.01*(exp(min(20.,-Tc/(1.1e4*DE(i,k)*(QC(i,k)+QR(i,k))-1.3e3*DE(i,k)*QI(i,k)+1.)))-1.)<a name='2421'></font>
<font color=#447700>!               D_sll = 2.0*D_sll !correction factor [error Ziegler (1985), as per Young (1993)]<a name='2422'></font>
<font color=#447700>!               D_sll = 2.*0.01*(exp(min(20.,-Tc/(1.1e4*DE(i,k)*(QC(i,k)+QR(i,k)) + 1.)))-1.)<a name='2423'></font>
                tmp1  = 1.1e4*DE(i,k)*(QC(i,k)+QR(i,k)) + 1.<a name='2424'>
                tmp1  = max(1.,tmp1)  <font color=#447700>!to prevent div-by-zero<a name='2425'></font>
                D_sll = 2.*0.01*(exp(min(20.,-Tc/tmp1))-1.)<a name='2426'>
                D_sll = min(1., max(0.0001,D_sll))    <font color=#447700>!smallest D_sll=0.1mm; largest=1m<a name='2427'></font>
                tmp1  = iLAMg <font color=#447700>!hold value<a name='2428'></font>
                tmp2  = No_g  <font color=#447700>!hold value<a name='2429'></font>
               <font color=#447700>!estimate PSD after accretion (and before conversion to hail): (assume inverse-exponential)<a name='2430'></font>
                tmp3  = QG(i,k) + QCLcg + QCLrg<a name='2431'>
                iLAMg = exp(thrd*log(DE(i,k)*tmp3/(NG(i,k)*6*cmg)))<a name='2432'>
                No_g  = NG(i,k)/iLAMg<a name='2433'>
                tmp4  = exp(-D_sll/iLAMg)<a name='2434'>
                Ng_tail = No_g*iLAMg*tmp4<a name='2435'>
                if (Ng_tail &gt; Ngh_crit) then<a name='2436'>
                   NgCNgh= min(NG(i,k), Ng_tail)<a name='2437'>
                   QCNgh = min(QG(i,k), cmg*No_g*tmp4*(D_sll**3*iLAMg + 3.*D_sll**2*    &amp;<a name='2438'>
                                         iLAMg**2 + 6.*D_sll*iLAMg**3 + 6.*iLAMg**4) )<a name='2439'>
                   Rz= 1.<a name='2440'>
                   <font color=#447700>! The Rz factor (/=1) serves to conserve reflectivity when graupel<a name='2441'></font>
                   <font color=#447700>! converts to hail with a a different shape parameter, alpha.<a name='2442'></font>
                   <font color=#447700>! (See Ferrier, 1994 App. D).<a name='2443'></font>
                   NhCNgh = Rz*NgCNgh<a name='2444'>
                else<a name='2445'>
                   QCNgh  = 0.<a name='2446'>
                   NgCNgh = 0.<a name='2447'>
                   NhCNgh = 0.<a name='2448'>
                endif<a name='2449'>
                iLAMg = tmp1  <font color=#447700>!restore value<a name='2450'></font>
                No_g  = tmp2  <font color=#447700>!restore value<a name='2451'></font>
             endif<a name='2452'>
<a name='2453'>
          <font color=#447700>!3-component freezing (collisions with rain):<a name='2454'></font>
<font color=#447700>!            if (QR(i,k)&gt;epsQ) then<a name='2455'></font>
             if (QR(i,k)&gt;epsQ .and. Tc&lt;-5.) then<a name='2456'>
                tmp1 = vg0-vr0<a name='2457'>
                tmp2 = sqrt(tmp1*tmp1 + 0.04*vg0*vr0)<a name='2458'>
                tmp8 = iLAMg2*iLAMg      <font color=#447700>! iLAMg**3<a name='2459'></font>
                tmp9 = tmp8*iLAMg        <font color=#447700>! iLAMg**4<a name='2460'></font>
                tmp10= tmp9*iLAMg        <font color=#447700>! iLAMg**5<a name='2461'></font>
<a name='2462'>
               <font color=#447700>!(parameterization of Erg based on Cober and List, 1993 [JAS])<a name='2463'></font>
                Kstoke = dew*abs(vg0-vr0)*Dr*Dr/(9.*MUdyn*Dg)<a name='2464'>
                Kstoke = max(1.5,min(10.,Kstoke))<a name='2465'>
                Erg    = 0.55*log10(2.51*Kstoke)<a name='2466'>
<a name='2467'>
                QCLrg= dt*cmr*Erg*PIov4*iDE(i,k)*(NG(i,k)*NR(i,k))*iGR31*iGG31*tmp2*     &amp;<a name='2468'>
                       (GR36*GG31*iLAMr5+2.*GR35*GG32*iLAMr4*iLAMg+GR34*GG33*iLAMr3*     &amp;<a name='2469'>
                       iLAMg2)<a name='2470'>
<a name='2471'>
                NCLrg= dt*PIov4*Erg*(NG(i,k)*NR(i,k))*iGR31*iGG31*tmp2*(GR33*GG31*       &amp;<a name='2472'>
                       iLAMr2+2.*GR32*GG32*iLAMr*iLAMg+GR31*GG33*iLAMg2)<a name='2473'>
<a name='2474'>
                QCLgr= dt*cmg*Erg*PIov4*iDE(i,k)*(NR(i,k)*NG(i,k))*iGG31*iGR31*tmp2*     &amp;<a name='2475'>
                       (GG36*GR31*tmp10+2.*GG35*GR32*tmp9*iLAMr+GG34*GR33*tmp8*iLAMr2)<a name='2476'>
<a name='2477'>
               <font color=#447700>!(note: For explicit eqns, NCLgr= NCLrg)<a name='2478'></font>
                NCLgr= min(NCLrg, QCLgr*(NG(i,k)*iQG))<a name='2479'>
                QCLrg= min(QCLrg, QR(i,k));  QCLgr= min(QCLgr, QG(i,k))<a name='2480'>
                NCLrg= min(NCLrg, NR(i,k));  NCLgr= min(NCLgr, NG(i,k))<a name='2481'>
<a name='2482'>
               <font color=#447700>! Determine destination of 3-comp.freezing:<a name='2483'></font>
                tmp1= max(Dg,Dr)<a name='2484'>
                tmp2= tmp1*tmp1*tmp1<a name='2485'>
                dey = (deg*Dg*Dg*Dg + dew*Dr*Dr*Dr)/tmp2<a name='2486'>
                if (dey&gt;0.5*(deg+deh) .and. Dr&gt;Dr_3cmpThrs .and. hail_ON) then<a name='2487'>
                   Dgrg= 0.;  Dgrh= 1.<a name='2488'>
                else<a name='2489'>
                   Dgrg= 1.;  Dgrh= 0.<a name='2490'>
                endif<a name='2491'>
             else<a name='2492'>
                QCLgr= 0.;  QCLrg= 0.;  NCLgr= 0.;  NCLrg= 0.<a name='2493'>
             endif<a name='2494'>
<a name='2495'>
          ELSE<a name='2496'>
<a name='2497'>
             QCNgh= 0.;  QCLgr= 0.;  QCLrg= 0.;  NgCNgh= 0.<a name='2498'>
             NhCNgh= 0.; NCLgr= 0.;  NCLrg= 0.<a name='2499'>
<a name='2500'>
          ENDIF<a name='2501'>
          <font color=#447700>!---------!<a name='2502'></font>
          <font color=#447700>!  HAIL:  !<a name='2503'></font>
          <font color=#447700>!---------!<a name='2504'></font>
          IF (QH(i,k)&gt;epsQ) THEN<a name='2505'>
<a name='2506'>
            <font color=#447700>!Wet growth:<a name='2507'></font>
             if (QHwet&lt;(QCLch+QCLrh+QCLih+QCLsh) .and. Tc&gt;-40.) then<a name='2508'>
                QCLih= min(QCLih*iEih, QI(i,k))  <font color=#447700>!change Eih to 1. in CLih<a name='2509'></font>
                NCLih= min(NCLih*iEih, NY(i,k))  <font color=#447700>!  "    "<a name='2510'></font>
                QCLsh= min(QCLsh*iEsh, QN(i,k))  <font color=#447700>!change Esh to 1. in CLsh<a name='2511'></font>
                NCLsh= min(NCLsh*iEsh, NN(i,k))  <font color=#447700>!  "    "<a name='2512'></font>
                tmp3 = QCLrh<a name='2513'>
                QCLrh= QHwet-(QCLch+QCLih+QCLsh)  <font color=#447700>!actual QCLrh minus QSHhr<a name='2514'></font>
                QSHhr= tmp3-QCLrh                 <font color=#447700>!QSHhr used here only<a name='2515'></font>
                NSHhr= DE(i,k)*QSHhr/(cmr*Drshed*Drshed*Drshed)<a name='2516'>
             else<a name='2517'>
                NSHhr= 0.<a name='2518'>
             endif<a name='2519'>
          ELSE<a name='2520'>
             NSHhr= 0.<a name='2521'>
          ENDIF<a name='2522'>
<a name='2523'>
       ENDIF  <font color=#447700>! ( if Tc&lt;0C Block )<a name='2524'></font>
<a name='2525'>
     <font color=#447700>!----- Prevent mass transfer from accretion during melting:  ---!<a name='2526'></font>
     <font color=#447700>! (only if exepcted NX (X=s,g,h) &lt; 0 after source/sinks added)<a name='2527'></font>
     <font color=#447700>! The purpose is to prevent mass tranfer from cloud to X and then<a name='2528'></font>
     <font color=#447700>! to vapor (during "prevent overdepletion" code) if all of X<a name='2529'></font>
     <font color=#447700>! would otherwise be completely depleted (e.g. due to melting).<a name='2530'></font>
<a name='2531'>
      <font color=#447700>!estimate NN after S/S:<a name='2532'></font>
       tmp1= NN(i,k) +NsCNis -NVDvs -NCNsg -NMLsr -NCLss -NCLsr -NCLsh +NCLsrs<a name='2533'>
       if (tmp1&lt;epsN) then<a name='2534'>
          QCLcs = 0.<a name='2535'>
          NCLcs = 0.<a name='2536'>
          QCLrs = 0.<a name='2537'>
          NCLrs = 0.<a name='2538'>
          if (Dsrs==1.) then<a name='2539'>
             QCLrs = 0.<a name='2540'>
             QCLsr = 0.<a name='2541'>
           endif<a name='2542'>
        endif<a name='2543'>
      <font color=#447700>!estimate NG after S/S:<a name='2544'></font>
       tmp2= NG(i,k) +NCNsg -NCLgr -NVDvg -NMLgr +NCLirg +NCLsrg +NCLgrg -NgCNgh<a name='2545'>
       if (tmp2&lt;epsN) then<a name='2546'>
          QCLcg = 0.<a name='2547'>
          NCLcg = 0.<a name='2548'>
          QCLrg = 0.<a name='2549'>
          NCLrg = 0.<a name='2550'>
          if (Dirg==1.) then<a name='2551'>
             QCLri = 0.<a name='2552'>
             QCLir = 0.<a name='2553'>
          endif<a name='2554'>
          if (Dsrg==1.) then<a name='2555'>
             QCLrs = 0.<a name='2556'>
             QCLsr = 0.<a name='2557'>
          endif<a name='2558'>
       endif<a name='2559'>
      <font color=#447700>!estimate NH after S/S:<a name='2560'></font>
       tmp3= NH(i,k) +NhFZrh +NhCNgh -NMLhr -NVDvh +NCLirh +NCLsrh +NCLgrh<a name='2561'>
       if (tmp3&lt;epsN) then<a name='2562'>
          QCLch = 0.<a name='2563'>
          NCLch = 0.<a name='2564'>
          QCLrh = 0.<a name='2565'>
          NCLrh = 0.<a name='2566'>
          if (Dirh==1.) then<a name='2567'>
             QCLri = 0.<a name='2568'>
             QCLir = 0.<a name='2569'>
          endif<a name='2570'>
          if (Dsrh==1.) then<a name='2571'>
             QCLrs = 0.<a name='2572'>
             QCLsr = 0.<a name='2573'>
          endif<a name='2574'>
       endif<a name='2575'>
     <font color=#447700>!=====<a name='2576'></font>
<a name='2577'>
     <font color=#447700>!------------  End of source/sink term calculation  -------------!<a name='2578'></font>
<a name='2579'>
     <font color=#447700>!-- Adjustment of source/sink terms to prevent  overdepletion: --!<a name='2580'></font>
       do niter= 1,2<a name='2581'>
<a name='2582'>
          <font color=#447700>! (1) Vapor:<a name='2583'></font>
          source= Q(i,k) +dim(-QVDvi,0.)+dim(-QVDvs,0.)+dim(-QVDvg,0.)+dim(-QVDvh,0.)<a name='2584'>
          sink  = QNUvi+dim(QVDvi,0.)+dim(QVDvs,0.)<a name='2585'>
          sour  = max(source,0.)<a name='2586'>
          if(sink&gt;sour) then<a name='2587'>
             ratio= sour/sink<a name='2588'>
             QNUvi= ratio*QNUvi;   NNUvi= ratio*NNUvi<a name='2589'>
             if(QVDvi&gt;0.) then<a name='2590'>
               QVDvi= ratio*QVDvi; NVDvi= ratio*NVDvi<a name='2591'>
             endif<a name='2592'>
             if(QVDvs&gt;0.) then<a name='2593'>
               QVDvs=ratio*QVDvs;  NVDvs=ratio*NVDvs<a name='2594'>
             endif<a name='2595'>
             QVDvg= ratio*QVDvg;   NVDvg= ratio*NVDvg<a name='2596'>
             QVDvh= ratio*QVDvh;   NVDvh= ratio*NVDvh<a name='2597'>
          endif<a name='2598'>
<a name='2599'>
          <font color=#447700>! (2) Cloud:<a name='2600'></font>
          source= QC(i,k)<a name='2601'>
          sink  = QCLcs+QCLcg+QCLch+QFZci<a name='2602'>
          sour  = max(source,0.)<a name='2603'>
          if(sink&gt;sour) then<a name='2604'>
             ratio= sour/sink<a name='2605'>
             QFZci= ratio*QFZci;   NFZci= ratio*NFZci<a name='2606'>
             QCLcs= ratio*QCLcs;   NCLcs= ratio*NCLcs<a name='2607'>
             QCLcg= ratio*QCLcg;   NCLcg= ratio*NCLcg<a name='2608'>
             QCLch= ratio*QCLch;   NCLch= ratio*NCLch<a name='2609'>
          endif<a name='2610'>
<a name='2611'>
          <font color=#447700>! (3) Rain:<a name='2612'></font>
          source= QR(i,k)+QMLsr+QMLgr+QMLhr+QMLir<a name='2613'>
          sink  = QCLri+QCLrs+QCLrg+QCLrh+QFZrh<a name='2614'>
          sour  = max(source,0.)<a name='2615'>
          if(sink&gt;sour) then<a name='2616'>
             ratio= sour/sink<a name='2617'>
             QCLrg= ratio*QCLrg;   QCLri= ratio*QCLri;   NCLri= ratio*NCLri<a name='2618'>
             QCLrs= ratio*QCLrs;   NCLrs= ratio*NCLrs<a name='2619'>
             NCLrg= ratio*NCLrg;   QCLrh= ratio*QCLrh;   NCLrh= ratio*NCLrh<a name='2620'>
             QFZrh= ratio*QFZrh;   NrFZrh=ratio*NrFZrh;  NhFZrh=ratio*NhFZrh<a name='2621'>
             if (ratio==0.) then<a name='2622'>
                Dirg= 0.; Dirh= 0.; Dgrg= 0.; Dgrh= 0.<a name='2623'>
                Dsrs= 0.; Dsrg= 0.; Dsrh= 0.<a name='2624'>
              endif<a name='2625'>
          endif<a name='2626'>
<a name='2627'>
          <font color=#447700>! (4) Ice:<a name='2628'></font>
          source= QI(i,k)+QNUvi+dim(QVDvi,0.)+QFZci<a name='2629'>
          sink  = QCNis+QCLir+dim(-QVDvi,0.)+QCLis+QCLig+QCLih+QMLir<a name='2630'>
          sour  = max(source,0.)<a name='2631'>
          if(sink&gt;sour) then<a name='2632'>
             ratio= sour/sink<a name='2633'>
             QMLir= ratio*QMLir;    NMLir= ratio*NMLir<a name='2634'>
             if (QVDvi&lt;0.) then<a name='2635'>
                QVDvi= ratio*QVDvi; NVDvi= ratio*NVDvi<a name='2636'>
             endif<a name='2637'>
             QCNis=  ratio*QCNis;   NiCNis= ratio*NiCNis;   NsCNis= ratio*NsCNis<a name='2638'>
             QCLir=  ratio*QCLir;   NCLir=  ratio*NCLir;    QCLig=  ratio*QCLig<a name='2639'>
             QCLis=  ratio*QCLis;   NCLis=  ratio*NCLis<a name='2640'>
             QCLih=  ratio*QCLih;   NCLih=  ratio*NCLih<a name='2641'>
             if (ratio==0.) then<a name='2642'>
                Dirg= 0.; Dirh= 0.<a name='2643'>
             endif<a name='2644'>
          endif<a name='2645'>
<a name='2646'>
          <font color=#447700>! (5) Snow:<a name='2647'></font>
          source= QN(i,k)+QCNis+dim(QVDvs,0.)+QCLis+Dsrs*(QCLrs+QCLsr)+QCLcs<a name='2648'>
          sink  = dim(-QVDvs,0.)+QCNsg+QMLsr+QCLsr+QCLsh<a name='2649'>
          sour  = max(source,0.)<a name='2650'>
          if(sink&gt;sour) then<a name='2651'>
             ratio= sour/sink<a name='2652'>
             if(QVDvs&lt;=0.) then<a name='2653'>
                QVDvs= ratio*QVDvs;   NVDvs= ratio*NVDvs<a name='2654'>
             endif<a name='2655'>
             QCNsg= ratio*QCNsg;   NCNsg= ratio*NCNsg;   QMLsr= ratio*QMLsr<a name='2656'>
             NMLsr= ratio*NMLsr;   QCLsr= ratio*QCLsr;   NCLsr= ratio*NCLsr<a name='2657'>
             QCLsh= ratio*QCLsh;   NCLsh= ratio*NCLsh<a name='2658'>
             if (ratio==0.) then<a name='2659'>
                Dsrs= 0.; Dsrg= 0.; Dsrh= 0.<a name='2660'>
             endif<a name='2661'>
          endif<a name='2662'>
<a name='2663'>
          <font color=#447700>!  (6) Graupel:<a name='2664'></font>
          source= QG(i,k)+QCNsg+dim(QVDvg,0.)+Dirg*(QCLri+QCLir)+Dgrg*(QCLrg+QCLgr)+     &amp;<a name='2665'>
                  QCLcg+Dsrg*(QCLrs+QCLsr)+QCLig<a name='2666'>
          sink  = dim(-QVDvg,0.)+QMLgr+QCNgh+QCLgr<a name='2667'>
          sour  = max(source,0.)<a name='2668'>
          if(sink&gt;sour) then<a name='2669'>
             ratio= sour/sink<a name='2670'>
             QVDvg= ratio*QVDvg;   NVDvg= ratio*NVDvg;   QMLgr = ratio*QMLgr<a name='2671'>
             NMLgr= ratio*NMLgr;   QCNgh= ratio*QCNgh;   NgCNgh= ratio*NgCNgh<a name='2672'>
             QCLgr= ratio*QCLgr;   NCLgr= ratio*NCLgr;   NhCNgh= ratio*NhCNgh<a name='2673'>
             if (ratio==0.) then<a name='2674'>
                Dgrg= 0.; Dgrh= 0.<a name='2675'>
             endif<a name='2676'>
          endif<a name='2677'>
<a name='2678'>
          <font color=#447700>!  (7) Hail:<a name='2679'></font>
          source= QH(i,k)+dim(QVDvh,0.)+QCLch+QCLrh+Dirh*(QCLri+QCLir)+QCLih+QCLsh+      &amp;<a name='2680'>
                  Dsrh*(QCLrs+QCLsr)+QCNgh+Dgrh*(QCLrg+QCLgr)+QFZrh<a name='2681'>
          sink  = dim(-QVDvh,0.)+QMLhr<a name='2682'>
          sour  = max(source,0.)<a name='2683'>
          if(sink&gt;sour) then<a name='2684'>
             ratio= sour/sink<a name='2685'>
             QVDvh= ratio*QVDvh;   NVDvh= ratio*NVDvh<a name='2686'>
             QMLhr= ratio*QMLhr;   NMLhr= ratio*NMLhr<a name='2687'>
          endif<a name='2688'>
<a name='2689'>
       enddo<a name='2690'>
       <font color=#447700>!---------------  End of source/sink term adjustment  ------------------!<a name='2691'></font>
<a name='2692'>
      <font color=#447700>!Compute N-tendencies for destination categories of 3-comp.freezing:<a name='2693'></font>
       NCLirg= 0.;  NCLirh= 0.;  NCLsrs= 0.;  NCLsrg= 0.<a name='2694'>
       NCLsrh= 0.;  NCLgrg= 0.;  NCLgrh= 0.<a name='2695'>
<a name='2696'>
       if (QCLir+QCLri&gt;0.) then<a name='2697'>
          tmp1  = max(Dr,Di)<a name='2698'>
          tmp2  = tmp1*tmp1*tmp1*PIov6<a name='2699'>
          NCLirg= Dirg*DE(i,k)*(QCLir+QCLri)/(deg*tmp2)<a name='2700'>
          NCLirh= Dirh*DE(i,k)*(QCLir+QCLri)/(deh*tmp2)<a name='2701'>
       endif<a name='2702'>
<a name='2703'>
       if (QCLsr+QCLrs&gt;0.) then<a name='2704'>
          tmp1  = max(Dr,Ds)<a name='2705'>
          tmp2  = tmp1*tmp1*tmp1*PIov6<a name='2706'>
          NCLsrs= Dsrs*DE(i,k)*(QCLsr+QCLrs)/(des*tmp2)<a name='2707'>
          NCLsrg= Dsrg*DE(i,k)*(QCLsr+QCLrs)/(deg*tmp2)<a name='2708'>
          NCLsrh= Dsrh*DE(i,k)*(QCLsr+QCLrs)/(deh*tmp2)<a name='2709'>
       endif<a name='2710'>
<a name='2711'>
       if (QCLgr+QCLrg&gt;0.) then<a name='2712'>
          tmp1  = max(Dr,Dg)<a name='2713'>
          tmp2  = tmp1*tmp1*tmp1*PIov6<a name='2714'>
          NCLgrg= Dgrg*DE(i,k)*(QCLgr+QCLrg)/(deg*tmp2)<a name='2715'>
          NCLgrh= Dgrh*DE(i,k)*(QCLgr+QCLrg)/(deh*tmp2)<a name='2716'>
       endif<a name='2717'>
<a name='2718'>
       <font color=#447700>!========================================================================!<a name='2719'></font>
       <font color=#447700>!           Add all source/sink terms to all predicted moments:          !<a name='2720'></font>
       <font color=#447700>!========================================================================!<a name='2721'></font>
<a name='2722'>
      <font color=#447700>!Diagnostic S/S terms:  (to facilitate output of 3D variables for diagnostics)<a name='2723'></font>
      <font color=#447700>!e.g. SS(i,k,1)= QVDvs*idt  (for depositional growth rate of snow, kg kg-1 s-1)<a name='2724'></font>
<a name='2725'>
       <font color=#447700>! Q-Source/Sink Terms:<a name='2726'></font>
       Q(i,k) = Q(i,k)  -QNUvi -QVDvi -QVDvs -QVDvg -QVDvh<a name='2727'>
       QC(i,k)= QC(i,k) -QCLcs -QCLcg -QCLch -QFZci<a name='2728'>
       QR(i,k)= QR(i,k) -QCLri +QMLsr -QCLrs -QCLrg +QMLgr -QCLrh +QMLhr -QFZrh +QMLir<a name='2729'>
       QI(i,k)= QI(i,k) +QNUvi +QVDvi +QFZci -QCNis -QCLir -QCLis -QCLig                 &amp;<a name='2730'>
                        -QMLir -QCLih +QIMsi +QIMgi<a name='2731'>
       QG(i,k)= QG(i,k) +QCNsg +QVDvg +QCLcg -QCLgr-QMLgr -QCNgh -QIMgi +QCLig           &amp;<a name='2732'>
                        +Dirg*(QCLri+QCLir) +Dgrg*(QCLrg+QCLgr) +Dsrg*(QCLrs+QCLsr)<a name='2733'>
       QN(i,k)= QN(i,k) +QCNis +QVDvs +QCLcs -QCNsg -QMLsr -QIMsi -QCLsr +QCLis -QCLsh   &amp;<a name='2734'>
                        +Dsrs*(QCLrs+QCLsr)<a name='2735'>
       QH(i,k)= QH(i,k) +Dirh*(QCLri+QCLir) -QMLhr +QVDvh +QCLch +Dsrh*(QCLrs+QCLsr)     &amp;<a name='2736'>
                        +QCLih +QCLsh +QFZrh +QCLrh +QCNgh +Dgrh*(QCLrg+QCLgr)<a name='2737'>
<a name='2738'>
       <font color=#447700>! N-Source/Sink Terms:<a name='2739'></font>
       NC(i,k)= NC(i,k) -NCLcs -NCLcg -NCLch -NFZci<a name='2740'>
       NR(i,k)= NR(i,k) -NCLri -NCLrs -NCLrg -NCLrh +NMLsr +NMLgr +NMLhr -NrFZrh +NMLir  &amp;<a name='2741'>
                        +NSHhr<a name='2742'>
       NY(i,k)= NY(i,k) +NNUvi +NVDvi +NFZci -NCLir -NCLis -NCLig -NCLih -NMLir +NIMsi   &amp;<a name='2743'>
                        +NIMgi -NiCNis<a name='2744'>
       NN(i,k)= NN(i,k) +NsCNis -NVDvs -NCNsg -NMLsr -NCLss -NCLsr -NCLsh +NCLsrs<a name='2745'>
       NG(i,k)= NG(i,k) +NCNsg -NCLgr -NVDvg -NMLgr +NCLirg +NCLsrg +NCLgrg -NgCNgh<a name='2746'>
       NH(i,k)= NH(i,k) +NhFZrh +NhCNgh -NMLhr -NVDvh +NCLirh +NCLsrh +NCLgrh<a name='2747'>
<a name='2748'>
       T(i,k)= T(i,k)   +LFP*(QCLri+QCLcs+QCLrs+QFZci-QMLsr+QCLcg+QCLrg-QMLir-QMLgr      &amp;<a name='2749'>
                        -QMLhr+QCLch+QCLrh+QFZrh) +LSP*(QNUvi+QVDvi+QVDvs+QVDvg+QVDvh)<a name='2750'>
<a name='2751'>
<font color=#447700>!--- Ensure consistency between moments: (prescribe NX (and BG) in case of inconsistency)<a name='2752'></font>
         tmp1= pres(i,k)/(RGASD*T(i,k))    <font color=#447700>!updated air density<a name='2753'></font>
         <font color=#447700>!note: In Part 2a (warm-rain coalescence), air density at initial time (before<a name='2754'></font>
         <font color=#447700>!      modification of T due to ice-phase) is used; hence, DE is not recomputed here.<a name='2755'></font>
<a name='2756'>
        <font color=#447700>!cloud:<a name='2757'></font>
         if (QC(i,k)&gt;epsQ .and. NC(i,k)&lt;epsN) then<a name='2758'>
             NC(i,k)= N_c_SM<a name='2759'>
         elseif (QC(i,k)&lt;=epsQ) then<a name='2760'>
            Q(i,k)  = Q(i,k) + QC(i,k)<a name='2761'>
            T(i,k)  = T(i,k) - LCP*QC(i,k)<a name='2762'>
            QC(i,k) = 0.<a name='2763'>
            NC(i,k) = 0.<a name='2764'>
         endif<a name='2765'>
<a name='2766'>
        <font color=#447700>!rain<a name='2767'></font>
         if (QR(i,k)&gt;epsQ .and. NR(i,k)&lt;epsN) then<a name='2768'>
            NR(i,k)= (No_r_SM*GR31)**(3./(4.+alpha_r))*(GR31*iGR34*tmp1*QR(i,k)*         &amp;<a name='2769'>
                     icmr)**((1.+alpha_r)/(4.+alpha_r))<a name='2770'>
         elseif (QR(i,k)&lt;=epsQ) then<a name='2771'>
            Q(i,k)  = Q(i,k) + QR(i,k)<a name='2772'>
            T(i,k)  = T(i,k) - LCP*QR(i,k)<a name='2773'>
            QR(i,k) = 0.<a name='2774'>
            NR(i,k) = 0.<a name='2775'>
         endif<a name='2776'>
<a name='2777'>
        <font color=#447700>!ice:<a name='2778'></font>
         if (QI(i,k)&gt;epsQ .and. NY(i,k)&lt;epsN) then<a name='2779'>
         <font color=#447700>!   NY(i,k)= <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#N_COOPER'>N_Cooper</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N_COOPER_2">(TRPL,T(i,k))<a name='2780'></font>
           NY(i,k) = max(2.*epsN, N_Cooper(TRPL,T(i,k)) )<a name='2781'>
         elseif (QI(i,k)&lt;=epsQ) then<a name='2782'>
            Q(i,k)  = Q(i,k) + QI(i,k)<a name='2783'>
            T(i,k)  = T(i,k) - LSP*QI(i,k)<a name='2784'>
            QI(i,k) = 0.<a name='2785'>
            NY(i,k) = 0.<a name='2786'>
         endif<a name='2787'>
<a name='2788'>
        <font color=#447700>!snow:<a name='2789'></font>
         if (QN(i,k)&gt;epsQ .and. NN(i,k)&lt;epsN) then<a name='2790'>
            No_s= <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#NOS_THOMPSON'>Nos_Thompson</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOS_THOMPSON_2">(TRPL,T(i,k))<a name='2791'>
            NN(i,k)= (No_s*GS31)**(dms*icexs2)*(GS31*iGS40*icms*tmp1*QN(i,k))**((1.+     &amp;<a name='2792'>
                     alpha_s)*icexs2)<a name='2793'>
         elseif (QN(i,k)&lt;=epsQ) then<a name='2794'>
            Q(i,k)  = Q(i,k) + QN(i,k)<a name='2795'>
            T(i,k)  = T(i,k) - LSP*QN(i,k)<a name='2796'>
            QN(i,k) = 0.<a name='2797'>
            NN(i,k) = 0.<a name='2798'>
         endif<a name='2799'>
<a name='2800'>
        <font color=#447700>!grpl:<a name='2801'></font>
         if (QG(i,k)&gt;epsQ .and. NG(i,k)&lt;epsN) then<a name='2802'>
            NG(i,k) = (No_g_SM*GG31)**(3./(4.+alpha_g))*(GG31*iGG34*tmp1*QG(i,k)*        &amp;<a name='2803'>
                      icmg)**((1.+alpha_g)/(4.+alpha_g))<a name='2804'>
         elseif (QG(i,k)&lt;=epsQ) then<a name='2805'>
            Q(i,k)  = Q(i,k) + QG(i,k)<a name='2806'>
            T(i,k)  = T(i,k) - LSP*QG(i,k)<a name='2807'>
            QG(i,k) = 0.<a name='2808'>
            NG(i,k) = 0.<a name='2809'>
         endif<a name='2810'>
<a name='2811'>
        <font color=#447700>!hail:<a name='2812'></font>
         if (QH(i,k)&gt;epsQ .and. NH(i,k)&lt;epsN) then<a name='2813'>
            NH(i,k)= (No_h_SM*GH31)**(3./(4.+alpha_h))*(GH31*iGH34*tmp1*QH(i,k)*         &amp;<a name='2814'>
                     icmh)**((1.+alpha_h)/(4.+alpha_h))<a name='2815'>
         elseif (QH(i,k)&lt;=epsQ) then<a name='2816'>
            Q(i,k)  = Q(i,k) + QH(i,k)<a name='2817'>
            T(i,k)  = T(i,k) - LSP*QH(i,k)<a name='2818'>
            QH(i,k) = 0.<a name='2819'>
            NH(i,k) = 0.<a name='2820'>
         endif<a name='2821'>
         if (QH(i,k)&gt;epsQ .and. NH(i,k)&gt;epsN) then<a name='2822'>
          <font color=#447700>!transfer small hail to graupel:<a name='2823'></font>
            tmp1 = 1./NH(i,k)<a name='2824'>
            Dh   = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_6">(DE(i,k),QH(i,k),tmp1,icmh,thrd)<a name='2825'>
            if (Dh &lt; Dh_min) then<a name='2826'>
               QG(i,k) = QG(i,k) + QH(i,k)<a name='2827'>
               NG(i,k) = NG(i,k) + NH(i,k)<a name='2828'>
               QH(i,k) = 0.<a name='2829'>
               NH(i,k) = 0.<a name='2830'>
            endif<a name='2831'>
         endif<a name='2832'>
<font color=#447700>!===<a name='2833'></font>
         Q(i,k)= max(Q(i,k),0.)<a name='2834'>
         NY(i,k)= min(NY(i,k), Ni_max)<a name='2835'>
<a name='2836'>
<font color=#447700>!-----<a name='2837'></font>
  if ( T(i,k)&lt;173. .or. T(i,k)&gt;323.) then                            <font color=#447700>!** DEBUG **<a name='2838'></font>
     print*, '** STOPPING IN MICROPHYSICS: (Part 2, end) **'         <font color=#447700>!** DEBUG **<a name='2839'></font>
     print*, '** i,k,T [K]: ',i,k,T(i,k)                             <font color=#447700>!** DEBUG **<a name='2840'></font>
     stop                                                            <font color=#447700>!** DEBUG **<a name='2841'></font>
  endif                                                              <font color=#447700>!** DEBUG **<a name='2842'></font>
<font color=#447700>!=====<a name='2843'></font>
<a name='2844'>
      ENDIF  <font color=#447700>!if (activePoint)<a name='2845'></font>
    ENDDO<a name='2846'>
  ENDDO<a name='2847'>
<a name='2848'>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='2849'></font>
  <font color=#447700>!                    End of ice phase microphysics (Part 2)                        !<a name='2850'></font>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='2851'></font>
<a name='2852'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_4">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.true.,DEBUG_abort,450)<a name='2853'>
<a name='2854'>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='2855'></font>
  <font color=#447700>!                       PART 3: Warm Microphysics Processes                        !<a name='2856'></font>
  <font color=#447700>!                                                                                  !<a name='2857'></font>
  <font color=#447700>!  Equations for warm-rain coalescence based on Cohard and Pinty (2000a,b; QJRMS)  !<a name='2858'></font>
  <font color=#447700>!  Condensation/evaportaion equations based on Kong and Yau (1997; Atmos-Ocean)    !<a name='2859'></font>
  <font color=#447700>!  Equations for rain reflectivity (ZR) based on Milbrandt and Yau (2005b; JAS)    !<a name='2860'></font>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='2861'></font>
<a name='2862'>
  <font color=#447700>! Part 3a - Warm-rain Coallescence:<a name='2863'></font>
<a name='2864'>
 IF (warmphase_ON) THEN<a name='2865'>
<a name='2866'>
  DO k= ktop-kdir,kbot,-kdir<a name='2867'>
     DO i= 1,ni<a name='2868'>
<a name='2869'>
        RCAUTR= 0.;  CCACCR= 0.;  Dc= 0.;  iLAMc= 0.;  L  = 0.<a name='2870'>
        RCACCR= 0.;  CCSCOC= 0.;  Dr= 0.;  iLAMr= 0.;  TAU= 0.<a name='2871'>
        CCAUTR= 0.;  CRSCOR= 0.;  SIGc= 0.;  DrINIT= 0.<a name='2872'>
        iLAMc3= 0.;  iLAMc6= 0.;  iLAMr3= 0.;  iLAMr6= 0.<a name='2873'>
<a name='2874'>
        rainPresent= (QR_in(i,k)&gt;epsQ .and. NR_in(i,k)&gt;epsN)<a name='2875'>
<a name='2876'>
        if (QC_in(i,k)&gt;epsQ .and. NC_in(i,k)&gt;epsN) then<a name='2877'>
           iNC = 1./NC_in(i,k)<a name='2878'>
           iLAMc = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#ILAMDA_X'>iLAMDA_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ILAMDA_X_2">(DE(i,k),QC_in(i,k),iNC,icexc9,thrd)<a name='2879'>
           iLAMc3= iLAMc*iLAMc*iLAMc<a name='2880'>
           iLAMc6= iLAMc3*iLAMc3<a name='2881'>
           Dc    = iLAMc*(GC2*iGC1)**thrd<a name='2882'>
           SIGc  = iLAMc*( GC3*iGC1- (GC2*iGC1)*(GC2*iGC1) )**sixth<a name='2883'>
           L     = 0.027*DE(i,k)*QC_in(i,k)*(6.25e18*SIGc*SIGc*SIGc*Dc-0.4)<a name='2884'>
           if (SIGc&gt;SIGcTHRS) TAU= 3.7/(DE(i,k)*(QC_in(i,k))*(0.5e6*SIGc-7.5))<a name='2885'>
        endif<a name='2886'>
<a name='2887'>
        if (rainPresent) then<a name='2888'>
           iNR = 1./NR_in(i,k)<a name='2889'>
           Dr = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_7">(DE(i,k),QR_in(i,k),iNR,icmr,thrd)<a name='2890'>
<a name='2891'>
          <font color=#447700>!Drop-size limiter [prevents initially large drops]<a name='2892'></font>
            if (Dr&gt;3.e-3) then<a name='2893'>
              tmp1 = (Dr-3.e-3)<a name='2894'>
              tmp2 = (Dr/DrMAX)<a name='2895'>
              tmp3 = tmp2*tmp2*tmp2<a name='2896'>
              NR_in(i,k)= NR_in(i,k)*max((1.+2.e4*tmp1*tmp1),tmp3)<a name='2897'>
              iNR  = 1./NR_in(i,k)<a name='2898'>
              Dr   = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_8">(DE(i,k),QR_in(i,k),iNR,icmr,thrd)<a name='2899'>
           endif<a name='2900'>
           iLAMr  = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#ILAMDA_X'>iLAMDA_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ILAMDA_X_3">(DE(i,k),QR_in(i,k),iNR,icexr9,thrd)<a name='2901'>
           iLAMr3 = iLAMr*iLAMr*iLAMr<a name='2902'>
           iLAMr6 = iLAMr3*iLAMr3<a name='2903'>
        endif<a name='2904'>
<a name='2905'>
        <font color=#447700>!  Autoconversion:<a name='2906'></font>
        if (QC_in(i,k)&gt;epsQ .and. SIGc&gt;SIGcTHRS .and. autoconv_ON) then<a name='2907'>
           RCAUTR= min( max(L/TAU,0.), QC(i,k)*idt )<a name='2908'>
           DrINIT= max(83.e-6, 12.6e-4/(0.5e6*SIGc-3.5))  <font color=#447700>!initiation regime Dr<a name='2909'></font>
           DrAUT = max(DrINIT, Dr)                     <font color=#447700>!init. or feeding DrAUT<a name='2910'></font>
           CCAUTR= RCAUTR*DE(i,k)/(cmr*DrAUT*DrAUT*DrAUT)<a name='2911'>
<a name='2912'>
           <font color=#447700>! ---------------------------------------------------------------------------- !<a name='2913'></font>
           <font color=#447700>! NOTE: The formulation for CCAUTR here (dNr/dt|initiation) does NOT follow<a name='2914'></font>
           <font color=#447700>!       eqn (18) in CP2000a, but rather it comes from the F90 code provided<a name='2915'></font>
           <font color=#447700>!       by J-P Pinty (subroutine: 'rain_c2r2.f90').<a name='2916'></font>
           <font color=#447700>!       (See notes: 2001-10-17; 2001-10-22)<a name='2917'></font>
           <font color=#447700>!<a name='2918'></font>
           <font color=#447700>!       Similarly, the condition for the activation of accretion and self-<a name='2919'></font>
           <font color=#447700>!       collection depends on whether or not autoconversion is in the feeding<a name='2920'></font>
           <font color=#447700>!       regime (see notes 2002-01-07).  This is apparent in the F90 code, but<a name='2921'></font>
           <font color=#447700>!       NOT in CP2000a.<a name='2922'></font>
           <font color=#447700>! ---------------------------------------------------------------------------- !<a name='2923'></font>
<a name='2924'>
           <font color=#447700>! cloud self-collection: (dNc/dt_autoconversion)   {CP eqn(25)}<a name='2925'></font>
           CCSCOC= min(KK2*NC_in(i,k)*NC_in(i,k)*GC3*iGC1*iLAMc6, NC_in(i,k)*idt)  <font color=#447700>!{CP00a eqn(25)}<a name='2926'></font>
        endif<a name='2927'>
<a name='2928'>
        <font color=#447700>! Accretion, rain self-collection, and collisional breakup:<a name='2929'></font>
        if (((QR_in(i,k))&gt;1.2*max(L,0.)*iDE(i,k).or.Dr&gt;max(5.e-6,DrINIT)).and.rainAccr_ON  &amp;<a name='2930'>
             .and. rainPresent) then<a name='2931'>
<a name='2932'>
           <font color=#447700>!  Accretion:                                                      !{CP00a eqn(22)}<a name='2933'></font>
           if (QC_in(i,k)&gt;epsQ.and.L&gt;0.) then<a name='2934'>
              if (Dr.ge.100.e-6) then<a name='2935'>
                 CCACCR = KK1*(NC_in(i,k)*NR_in(i,k))*(GC2*iGC1*iLAMc3+GR34*iGR31*iLAMr3)<a name='2936'>
                 RCACCR = cmr*iDE(i,k)*KK1*(NC_in(i,k)*NR_in(i,k))*iLAMc3*(GC3*iGC1*iLAMc3+  &amp;<a name='2937'>
                          GC2*iGC1*GR34*iGR31*iLAMr3)<a name='2938'>
              else<a name='2939'>
                 CCACCR = KK2*(NC_in(i,k)*NR_in(i,k))*(GC3*iGC1*iLAMc6+GR37*iGR31*iLAMr6)<a name='2940'>
<a name='2941'>
<font color=#447700>!                  RCACCR= cmr*iDE(i,k)*KK2*(NC(i,k)*NR(i,k))*iLAMc3*                  &amp;<a name='2942'></font>
<font color=#447700>!                          (GC4*iGR31*iLAMc6+GC2*iGC1*GR37*iGR31*iLAMr6)<a name='2943'></font>
<font color=#447700>!++  The following calculation of RCACCR avoids overflow:<a name='2944'></font>
                 tmp1   = cmr*iDE(i,k)<a name='2945'>
                 tmp2   = KK2*(NC_in(i,k)*NR_in(i,k))*iLAMc3<a name='2946'>
                 RCACCR = tmp1 * tmp2<a name='2947'>
                 tmp1   = GC4*iGR31<a name='2948'>
                 tmp1   = (tmp1)*iLAMc6<a name='2949'>
                 tmp2   = GC2*iGC1<a name='2950'>
                 tmp2   = tmp2*GR37*iGR31<a name='2951'>
                 tmp2   = (tmp2)*iLAMr6<a name='2952'>
                 RCACCR = RCACCR * (tmp1 + tmp2)<a name='2953'>
<font color=#447700>!++<a name='2954'></font>
              endif<a name='2955'>
              CCACCR = min(CCACCR,(NC(i,k))*idt)<a name='2956'>
              RCACCR = min(RCACCR,(QC(i,k))*idt)<a name='2957'>
            endif<a name='2958'>
<a name='2959'>
         <font color=#447700>!Rain self-collection:<a name='2960'></font>
           tmp1= NR_in(i,k)*NR_in(i,k)<a name='2961'>
           if (Dr.ge.100.e-6) then<a name='2962'>
              CRSCOR= KK1*tmp1*GR34*iGR31*iLAMr3                        <font color=#447700>!{CP00a eqn(24)}<a name='2963'></font>
           else<a name='2964'>
              CRSCOR= KK2*tmp1*GR37*iGR31*iLAMr6                        <font color=#447700>!{CP00a eqn(25)}<a name='2965'></font>
           endif<a name='2966'>
         <font color=#447700>!Raindrop breakup:                                             !{CP00a eqn(26)}<a name='2967'></font>
           Ec= 1.<a name='2968'>
<font color=#447700>!          if (Dr &gt; 300.e-6) Ec = 2.-exp(2300.*(Dr-300.e-6))<a name='2969'></font>
           if (iLAMr &gt; 300.e-6) Ec = 2.-exp(2300.*(iLAMr-300.e-6))  <font color=#447700>!(assumes alpha_r=0)<a name='2970'></font>
<a name='2971'>
           CRSCOR= min(Ec*CRSCOR,(0.5*NR(i,k))*idt) <font color=#447700>!0.5 prevents depletion of NR<a name='2972'></font>
<a name='2973'>
        endif  <font color=#447700>!accretion/self-collection/breakup<a name='2974'></font>
<a name='2975'>
        <font color=#447700>! Prevent overdepletion of cloud:<a name='2976'></font>
        source= QC(i,k)<a name='2977'>
        sink  = (RCAUTR+RCACCR)*dt<a name='2978'>
        if (sink&gt;source) then<a name='2979'>
           ratio = source/sink<a name='2980'>
           RCAUTR= ratio*RCAUTR<a name='2981'>
           RCACCR= ratio*RCACCR<a name='2982'>
           CCACCR= ratio*CCACCR<a name='2983'>
        endif<a name='2984'>
<a name='2985'>
        <font color=#447700>! Apply tendencies:<a name='2986'></font>
        QC(i,k)= max(0., QC(i,k)+(-RCAUTR-RCACCR)*dt )<a name='2987'>
        QR(i,k)= max(0., QR(i,k)+( RCAUTR+RCACCR)*dt )<a name='2988'>
        NC(i,k)= max(0., NC(i,k)+(-CCACCR-CCSCOC)*dt )<a name='2989'>
        NR(i,k)= max(0., NR(i,k)+( CCAUTR-CRSCOR)*dt )<a name='2990'>
<a name='2991'>
        if (QR(i,k)&gt;epsQ .and. NR(i,k)&gt;epsN) then<a name='2992'>
           iNR = 1./NR(i,k)<a name='2993'>
           Dr  = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_9">(DE(i,k),QR(i,k),iNR,icmr,thrd)<a name='2994'>
           if (Dr&gt;3.e-3) then<a name='2995'>
              tmp1= (Dr-3.e-3);   tmp2= tmp1*tmp1<a name='2996'>
              tmp3= (Dr/DrMAX);   tmp4= tmp3*tmp3*tmp3<a name='2997'>
              NR(i,k)= NR(i,k)*(max((1.+2.e4*tmp2),tmp4))<a name='2998'>
           elseif (Dr&lt;Dhh) then<a name='2999'>
           <font color=#447700>!Convert small raindrops to cloud:<a name='3000'></font>
              QC(i,k)= QC(i,k) + QR(i,k)<a name='3001'>
              NC(i,k)= NC(i,k) + NR(i,k)<a name='3002'>
              QR(i,k)= 0.;   NR(i,k)= 0.<a name='3003'>
           endif<a name='3004'>
        else<a name='3005'>
           QR(i,k)= 0.;   NR(i,k)= 0.<a name='3006'>
        endif  <font color=#447700>!(Qr,Nr&gt;eps)<a name='3007'></font>
<a name='3008'>
  <font color=#447700>! Part 3b - Condensation/Evaporation:<a name='3009'></font>
<a name='3010'>
        QSW(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_11">(T(i,k),pres(i,k),0)              <font color=#447700>!Flatau formulation<a name='3011'></font>
        if (QSW(i,k)&gt;1.e-20) then<a name='3012'>
           ssat = Q(i,k)/QSW(i,k)-1.                     <font color=#447700>!supersaturation ratio<a name='3013'></font>
        else<a name='3014'>
           ssat = 0.<a name='3015'>
        endif<a name='3016'>
        X       = Q(i,k)-QSW(i,k)                        <font color=#447700>!saturation excess (deficit)<a name='3017'></font>
        <font color=#447700>!adjustment for latent heating during cond/evap<a name='3018'></font>
<font color=#447700>!       X       = X/(1.+ck5*QSW(i,k)/(T(i,k)-35.86)**2)                                   !orig (KY97)<a name='3019'></font>
        X       = X / ( 1.+ ((3.1484e6-2370.*T(i,k))**2 * QSW(i,k))/( (1005.*(1.+       &amp; <font color=#447700>!morr2mom<a name='3020'></font>
                        0.887*Q(i,k))) *461.5*T(i,k)**2 ) )<a name='3021'>
        X       = max(X, -QC(i,k))                       <font color=#447700>!ensure no overdepletion of QC<a name='3022'></font>
        QC(i,k) = QC(i,k) + X<a name='3023'>
        Q(i,k)  = Q(i,k)  - X<a name='3024'>
        T(i,k)  = T(i,k)  + LCP*X<a name='3025'>
<a name='3026'>
        if (X&gt;0.) then<a name='3027'>
          <font color=#447700>!nucleation of cloud droplets:<a name='3028'></font>
           if (WZ(i,k)&gt;0.001) then<a name='3029'>
              <font color=#447700>!condensation and non-negligible upward motion:<a name='3030'></font>
               <font color=#447700>!note: WZ threshold of 1 mm/s is to overflow problem in NccnFNC, which<a name='3031'></font>
               <font color=#447700>!      uses a polynomial approximation that is invalid for tiny WZ.<a name='3032'></font>
              NC(i,k) = max(NC(i,k), NccnFNC(WZ(i,k),T(i,k),pres(i,k),CCNtype))<a name='3033'>
           else<a name='3034'>
             <font color=#447700>!condensation and negible or downward vertical motion:<a name='3035'></font>
              NC(i,k) = max(NC(i,k), N_c_SM)<a name='3036'>
           endif<a name='3037'>
        else<a name='3038'>
           if (QC(i,k)&gt;epsQ) then<a name='3039'>
              <font color=#447700>!partial evaporation of cloud droplets:<a name='3040'></font>
              NC(i,k) = max(0., NC(i,k) + X*NC(i,k)/max(QC(i,k),epsQ) ) <font color=#447700>!(dNc/dt)|evap<a name='3041'></font>
           else<a name='3042'>
              NC(i,k) = 0.<a name='3043'>
           endif<a name='3044'>
        endif<a name='3045'>
        if (QC(i,k)&gt;epsQ .and. NC(i,k)&lt;epsN) NC(i,k)= N_c_SM <font color=#447700>!prevents non-zero_Q &amp; zero_N<a name='3046'></font>
<a name='3047'>
       <font color=#447700>!rain evaporation:<a name='3048'></font>
       <font color=#447700>!saturation adjustment:<a name='3049'></font>
        QSW(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#QSAT'>qsat</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSAT_12">(T(i,k),pres(i,k),0)              <font color=#447700>!Flatau formulation<a name='3050'></font>
        if (Q(i,k)&lt;QSW(i,k) .and. QR(i,k)&gt;epsQ .and. NR(i,k)&gt;epsN) then<a name='3051'>
           ssat    = Q(i,k)/QSW(i,k)-1.<a name='3052'>
           Tc      = T(i,k)-TRPL<a name='3053'>
           Cdiff   = max(1.62e-5, (2.2157e-5 + 0.0155e-5*Tc)) *1.e5/pres(i,k)<a name='3054'>
           MUdyn   = max(1.51e-5, (1.7153e-5 + 0.0050e-5*Tc))<a name='3055'>
           Ka      = max(2.07e-2, (2.3971e-2 + 0.0078e-2*Tc))<a name='3056'>
           MUkin   = MUdyn*iDE(i,k)<a name='3057'>
           iMUkin  = 1./MUkin<a name='3058'>
           ScTHRD  = (MUkin/Cdiff)**thrd<a name='3059'>
           X       = QSW(i,k) - Q(i,k)                      <font color=#447700>!saturation exesss(deficit)<a name='3060'></font>
           <font color=#447700>!adjustment for latent cooling during evaporation:<a name='3061'></font>
<font color=#447700>!          X       = X/(1.+ck5*QSW(i,k)/(T(i,k)-35.86)**2)                                  !orig (KY97)<a name='3062'></font>
           X       = X / ( 1.+ ((3.1484e6-2370.*T(i,k))**2 * QSW(i,k))/( (1005.*(1.+     &amp;  <font color=#447700>!morr2mom<a name='3063'></font>
                     0.887*Q(i,k))) *461.5*T(i,k)**2 ) )<a name='3064'>
           DE(i,k)  = pres(i,k)/(RGASD*T(i,k))        <font color=#447700>!recompute air density (with updated T)<a name='3065'></font>
           iDE(i,k) = 1./DE(i,k)<a name='3066'>
           gam      = sqrt(DEo*iDE(i,k))<a name='3067'>
           tmp1     = 1./NR(i,k)<a name='3068'>
           iLAMr    = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#ILAMDA_X'>iLAMDA_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ILAMDA_X_4">(DE(i,k),QR(i,k),tmp1,icexr9,thrd)<a name='3069'>
           LAMr     = 1./iLAMr<a name='3070'>
          <font color=#447700>!note: The following coding of 'No_r=...' prevents overflow:<a name='3071'></font>
          <font color=#447700>!No_r     = NR(i,k)*LAMr**(1.+alpha_r))*iGR31<a name='3072'></font>
           No_r     = sngl(dble(NR(i,k))*dble(LAMr)**dble(1.+alpha_r))*iGR31<a name='3073'>
          <font color=#447700>!note: There is an error in MY05a_eq(8) for VENTx (corrected in code)<a name='3074'></font>
           VENTr    = Avx*GR32*iLAMr**cexr5 + Bvx*ScTHRD*sqrt(gam*afr*iMUkin)*GR17*iLAMr**cexr6<a name='3075'>
           ABw      = CHLC**2/(Ka*RGASV*T(i,k)**2)+1./(DE(i,k)*(QSW(i,k))*Cdiff)<a name='3076'>
           QREVP    = min( QR(i,k), -dt*(iDE(i,k)*PI2*ssat*No_r*VENTr/ABw) )<a name='3077'>
           tmp1     = QR(i,k)   <font color=#447700>!value of QR before update, used in NR update eqn<a name='3078'></font>
           T(i,k)   = T(i,k)  - LCP*QREVP<a name='3079'>
           Q(i,k)   = Q(i,k)  + QREVP<a name='3080'>
           QR(i,k)  = QR(i,k) - QREVP<a name='3081'>
           NR(i,k)  = max(0., NR(i,k) - QREVP*NR(i,k)/tmp1)<a name='3082'>
          <font color=#447700>!Protect against negative values due to overdepletion:<a name='3083'></font>
           if (QR(i,k)&lt;epsQ .or. NR(i,k)&lt;epsN)  then<a name='3084'>
              Q(i,k)  = Q(i,k) + QR(i,k)<a name='3085'>
              T(i,k)  = T(i,k) - QR(i,k)*LCP<a name='3086'>
              QR(i,k) = 0.<a name='3087'>
              NR(i,k) = 0.<a name='3088'>
           endif<a name='3089'>
        endif<a name='3090'>
<a name='3091'>
       <font color=#447700>!homogeneous freezing of cloud:<a name='3092'></font>
        Tc = T(i,k) - TRPL<a name='3093'>
        if (QC(i,k)&gt;epsQ .and. Tc&lt;-30. .and. icephase_ON) then<a name='3094'>
<a name='3095'>
         <font color=#447700>!-detailed:<a name='3096'></font>
<font color=#447700>!            Tc    = T(i,k) - TRPL<a name='3097'></font>
<font color=#447700>!            JJ    = (10.**max(-20.,(-606.3952-52.6611*Tc-1.7439*Tc**2-0.0265*Tc**3-       &amp;<a name='3098'></font>
<font color=#447700>!                     1.536e-4*Tc**4)))<a name='3099'></font>
<font color=#447700>!            tmp1  = 1.e6*(DE(i,k)*(QC(i,k)/NC(i,k))*icmr) !i.e. Dc[cm]**3<a name='3100'></font>
<font color=#447700>!            FRAC  = 1.-exp(-JJ*PIov6*tmp1*dt)<a name='3101'></font>
<font color=#447700>!            if (Tc&gt;-30.) FRAC= 0.<a name='3102'></font>
<font color=#447700>!            if (Tc&lt;-50.) FRAC= 1.<a name='3103'></font>
         <font color=#447700>!-simplified:<a name='3104'></font>
           if (Tc&lt;-35.) then<a name='3105'>
              FRAC = 1.<a name='3106'>
           else<a name='3107'>
              FRAC = 0.<a name='3108'>
           endif<a name='3109'>
          <font color=#447700>!=<a name='3110'></font>
           QFZci   = FRAC*QC(i,k)<a name='3111'>
           NFZci   = FRAC*NC(i,k)<a name='3112'>
           QC(i,k) = QC(i,k) - QFZci<a name='3113'>
           NC(i,k) = NC(i,k) - NFZci<a name='3114'>
           QI(i,k) = QI(i,k) + QFZci<a name='3115'>
           NY(i,k) = NY(i,k) + NFZci<a name='3116'>
           T(i,k)  = T(i,k)  + LFP*QFZci<a name='3117'>
<a name='3118'>
           if (QC(i,k)&gt;epsQ .and. NC(i,k)&lt;epsN) then<a name='3119'>
               NC(i,k)= N_c_SM<a name='3120'>
           elseif (QC(i,k)&lt;=epsQ) then<a name='3121'>
              Q(i,k)  = Q(i,k) + QC(i,k)<a name='3122'>
              T(i,k)  = T(i,k) - LCP*QC(i,k)<a name='3123'>
              QC(i,k) = 0.<a name='3124'>
              NC(i,k) = 0.<a name='3125'>
           endif<a name='3126'>
<a name='3127'>
           if (QI(i,k)&gt;epsQ .and. NY(i,k)&lt;epsN) then<a name='3128'>
           <font color=#447700>!   NY(i,k)= <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#N_COOPER'>N_Cooper</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="N_COOPER_3">(TRPL,T(i,k))<a name='3129'></font>
           NY(i,k) = max(2.*epsN, N_Cooper(TRPL,T(i,k)) )<a name='3130'>
           elseif (QI(i,k)&lt;=epsQ) then<a name='3131'>
              Q(i,k)  = Q(i,k) + QI(i,k)<a name='3132'>
              T(i,k)  = T(i,k) - LSP*QI(i,k)<a name='3133'>
              QI(i,k) = 0.<a name='3134'>
              NY(i,k) = 0.<a name='3135'>
           endif<a name='3136'>
<a name='3137'>
        endif<a name='3138'>
<a name='3139'>
<font color=#447700>!==<a name='3140'></font>
<a name='3141'>
     ENDDO<a name='3142'>
  ENDDO    <font color=#447700>!cond/evap [k-loop]<a name='3143'></font>
<a name='3144'>
 ENDIF  <font color=#447700>!if warmphase_ON<a name='3145'></font>
<a name='3146'>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='3147'></font>
  <font color=#447700>!                    End of warm-phase microphysics (Part 3)                       !<a name='3148'></font>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='3149'></font>
<a name='3150'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_5">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.true.,DEBUG_abort,500)<a name='3151'>
<a name='3152'>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='3153'></font>
  <font color=#447700>!                            PART 4:  Sedimentation                                !<a name='3154'></font>
  <font color=#447700>!----------------------------------------------------------------------------------!<a name='3155'></font>
<a name='3156'>
 IF (sedi_ON) THEN<a name='3157'>
<a name='3158'>
   fluxM_r= 0.;  fluxM_i= 0.;  fluxM_s= 0.;  fluxM_g= 0.;  fluxM_h= 0.<a name='3159'>
   RT_rn1 = 0.;  RT_rn2 = 0.;  RT_fr1 = 0.;  RT_fr2 = 0.;  RT_sn1 = 0.<a name='3160'>
   RT_sn2 = 0.;  RT_sn3 = 0.;  RT_pe1 = 0.;  RT_pe2 = 0.;  RT_peL = 0.<a name='3161'>
<a name='3162'>
<font color=#447700>!---- For sedimentation on all levels:<a name='3163'></font>
    call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_WRAPPER_2'>sedi_wrapper_2</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEDI_WRAPPER_2_1">(QR,NR,1,epsQ,epsQr_sedi,epsN,dmr,ni,VrMax,DrMax,dt,fluxM_r,kdir, &amp;<a name='3164'>
                        kbot,ktop_sedi,GRAV,zheight,nk,DE,iDE,iDP,DZ,iDZ,gamfact,kount,  &amp;<a name='3165'>
                        afr,bfr,cmr,ckQr1,ckQr2,icexr9)<a name='3166'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_6">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,610)<a name='3167'>
<a name='3168'>
    call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_WRAPPER_2'>sedi_wrapper_2</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEDI_WRAPPER_2_2">(QI,NY,2,epsQ,epsQi_sedi,epsN,dmi,ni,ViMax,DiMax,dt,fluxM_i,kdir, &amp;<a name='3169'>
                        kbot,ktop_sedi,GRAV,zheight,nk,DE,iDE,iDP,DZ,iDZ,gamfact,kount,  &amp;<a name='3170'>
                        afi,bfi,cmi,ckQi1,ckQi2,ckQi4)<a name='3171'>
<a name='3172'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_7">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,620)<a name='3173'>
<a name='3174'>
    call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_WRAPPER_2'>sedi_wrapper_2</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEDI_WRAPPER_2_3">(QN,NN,3,epsQ,epsQs_sedi,epsN,dms,ni,VsMax,DsMax,dt,fluxM_s,kdir, &amp;<a name='3175'>
                        kbot,ktop_sedi,GRAV,zheight,nk,DE,iDE,iDP,DZ,iDZ,gamfact,kount,  &amp;<a name='3176'>
                        afs,bfs,cms,ckQs1,ckQs2,iGS20)<a name='3177'>
<a name='3178'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_8">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,630)<a name='3179'>
<a name='3180'>
    call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_WRAPPER_2'>sedi_wrapper_2</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEDI_WRAPPER_2_4">(QG,NG,4,epsQ,epsQg_sedi,epsN,dmg,ni,VgMax,DgMax,dt,fluxM_g,kdir, &amp;<a name='3181'>
                        kbot,ktop_sedi,GRAV,zheight,nk,DE,iDE,iDP,DZ,iDZ,gamfact,kount,  &amp;<a name='3182'>
                        afg,bfg,cmg,ckQg1,ckQg2,ckQg4)<a name='3183'>
<a name='3184'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_9">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,640)<a name='3185'>
<a name='3186'>
    call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#SEDI_WRAPPER_2'>sedi_wrapper_2</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEDI_WRAPPER_2_5">(QH,NH,5,epsQ,epsQh_sedi,epsN,dmh,ni,VhMax,DhMax,dt,fluxM_h,kdir, &amp;<a name='3187'>
                        kbot,ktop_sedi,GRAV,zheight,nk,DE,iDE,iDP,DZ,iDZ,gamfact,kount,  &amp;<a name='3188'>
                        afh,bfh,cmh,ckQh1,ckQh2,ckQh4)<a name='3189'>
<font color=#447700>!====<a name='3190'></font>
<a name='3191'>
<a name='3192'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_10">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,650)<a name='3193'>
<a name='3194'>
<font color=#447700>!---  Impose constraints on size distribution parameters ---!<a name='3195'></font>
    do k= ktop,kbot,-kdir<a name='3196'>
      do i= 1,ni<a name='3197'>
       <font color=#447700>!snow:<a name='3198'></font>
         if (QN(i,k)&gt;epsQ .and. NN(i,k)&gt;epsN) then<a name='3199'>
         <font color=#447700>!Impose No_s max for snow: (assumes alpha_s=0.)<a name='3200'></font>
            tmp1   = 1./NN(i,k)<a name='3201'>
            iLAMs  = max( iLAMmin2, iLAMDA_x(DE(i,k),QN(i,k),tmp1,iGS20,idms) )<a name='3202'>
            tmp1   = min(NN(i,k)/iLAMs,No_s_max)                 <font color=#447700>!min. No_s<a name='3203'></font>
            NN(i,k)= tmp1**(dms/(1.+dms))*(iGS20*DE(i,k)*QN(i,k))**(1./(1.+dms)) <font color=#447700>!impose Nos_max<a name='3204'></font>
         <font color=#447700>!Impose LAMDAs_min (by increasing LAMDAs if it is below LAMDAs_min2 [2xLAMDAs_min])<a name='3205'></font>
            tmp1   = 1./NN(i,k)<a name='3206'>
            iLAMs  = max( iLAMmin2, iLAMDA_x(DE(i,k),QN(i,k),tmp1,iGS20,idms) )<a name='3207'>
            tmp2   = 1./iLAMs                                   <font color=#447700>!LAMs before adjustment<a name='3208'></font>
           <font color=#447700>!adjust value of lamdas_min to be applied:<a name='3209'></font>
           <font color=#447700>!  This adjusts for multiple corrections (each time step).  The factor 0.6 was obtained by<a name='3210'></font>
           <font color=#447700>!  trial-and-error to ultimately give reasonable LAMs profiles, smooth and with min LAMs~lamdas_min<a name='3211'></font>
            tmp4   = 0.6*lamdas_min<a name='3212'>
            tmp5   = 2.*tmp4<a name='3213'>
            tmp3   = tmp2 + tmp4*(max(0.,tmp5-tmp2)/tmp5)**2.   <font color=#447700>!LAMs after adjustment<a name='3214'></font>
            tmp3   = max(tmp3, lamdas_min)                      <font color=#447700>!final correction<a name='3215'></font>
            NN(i,k)= NN(i,k)*(tmp3*iLAMs)**dms                  <font color=#447700>!re-compute NN after LAMs adjustment<a name='3216'></font>
         endif<a name='3217'>
       enddo <font color=#447700>!i-loop<a name='3218'></font>
    enddo <font color=#447700>!k-loop<a name='3219'></font>
<font color=#447700>!===<a name='3220'></font>
<a name='3221'>
  <font color=#447700>!Compute melted (liquid-equivalent) volume fluxes [m3 (liquid) m-2 (sfc area) s-1]:<a name='3222'></font>
  <font color=#447700>!  (note: For other precipitation schemes in RPN-CMC physics, this is computed in 'vkuocon6.ftn')<a name='3223'></font>
  RT_rn1 = fluxM_r *idew<a name='3224'>
  RT_sn1 = fluxM_i *idew<a name='3225'>
  RT_sn2 = fluxM_s *idew<a name='3226'>
  RT_sn3 = fluxM_g *idew<a name='3227'>
  RT_pe1 = fluxM_h *idew<a name='3228'>
<a name='3229'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_11">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,700)<a name='3230'>
<a name='3231'>
<font color=#447700>!----<a name='3232'></font>
  <font color=#447700>!Compute sum of solid (unmelted) volume fluxes [m3 (bulk hydrometeor) m-2 (sfc area) s-1]:<a name='3233'></font>
  <font color=#447700>!(this is the precipitation rate for UNmelted total snow [i+s+g])<a name='3234'></font>
<a name='3235'>
  <font color=#447700>!    Note:  In 'calcdiagn.ftn', the total solid precipitation (excluding hail) SN is computed<a name='3236'></font>
  <font color=#447700>!           from the sum of the liq-eq.vol fluxes, tss_sn1 + tss_sn2 + tss_sn3.  With the<a name='3237'></font>
  <font color=#447700>!           accumulation of SND (in 'calcdiag.ftn'), the solid-to-liquid ratio for the total<a name='3238'></font>
  <font color=#447700>!           accumulated "snow" (i+s+g) can be compute as SND/SN.  Likewise, the instantaneous<a name='3239'></font>
  <font color=#447700>!           solid-to-liquid ratio of solid precipitation is computed (in 'calcdiag.ftn') as<a name='3240'></font>
  <font color=#447700>!           RS2L = RSND/RSN.<a name='3241'></font>
<a name='3242'>
   do i= 1,ni<a name='3243'>
<a name='3244'>
      fluxV_i= fluxM_i(i)*idei<a name='3245'>
      fluxV_g= fluxM_g(i)*ideg<a name='3246'>
     <font color=#447700>!Compute unmelted volume flux for snow:<a name='3247'></font>
         <font color=#447700>! note: This is based on the strict calculation of the volume flux, where vol=(pi/6)D^3,<a name='3248'></font>
         <font color=#447700>!       and remains in the integral calculation Fv = int[V(D)*vol(D)*N(D)*dD].<a name='3249'></font>
         <font color=#447700>!       For a constant density (ice and graupel), vol(D) = m(D)/dex, dex comes out of<a name='3250'></font>
         <font color=#447700>!       integral and Fv_x=Fm_x/dex<a name='3251'></font>
         <font color=#447700>!       Optimized for alpha_s = 0.<a name='3252'></font>
      if (QN(i,nk)&gt;epsQ .and. NN(i,nk)&gt;epsN .and. fluxM_s(i)&gt;0.) then<a name='3253'>
         tmp2    = 1./NN(i,nk)<a name='3254'>
         tmp1    = 1./iLAMDA_x(DE(i,nk),QN(i,nk),tmp2,iGS20,idms) <font color=#447700>!LAMDA_s<a name='3255'></font>
         fluxV_s = fluxM_s(i)*rfact_FvFm*tmp1**(dms-3.)<a name='3256'>
      else<a name='3257'>
         fluxV_s = 0.<a name='3258'>
      endif<a name='3259'>
<a name='3260'>
     <font color=#447700>!total solid unmelted volume flux, before accounting for partial melting:<a name='3261'></font>
      tmp1= fluxV_i + fluxV_g + fluxV_s<a name='3262'>
<a name='3263'>
     <font color=#447700>!liquid-fraction of partially-melted solid precipitation:<a name='3264'></font>
     <font color=#447700>!  The physical premise is that if QR&gt;0, QN+QI+QG&gt;0, and T&gt;0, then QR<a name='3265'></font>
     <font color=#447700>!  originates from melting and can be used to estimate the liquid portion<a name='3266'></font>
     <font color=#447700>!  of the partially-melted solid hydrometeor.<a name='3267'></font>
      tmp2= QR(i,nk) + QI(i,nk) + QN(i,nk) + QG(i,nk)<a name='3268'>
      if (T(i,nk)&gt;TRPL .and. tmp2&gt;epsQ) then<a name='3269'>
         fracLiq= QR(i,nk)/tmp2<a name='3270'>
      else<a name='3271'>
         fracLiq= 0.<a name='3272'>
      endif<a name='3273'>
<a name='3274'>
     <font color=#447700>!Tend total volume flux towards the liquid-equivalent as the liquid-fraction increases to 1:<a name='3275'></font>
      tmp3= RT_sn1(i) + RT_sn2(i) + RT_sn3(i)      <font color=#447700>!total liquid-equivalent volume flux    (RSN,  Fv_sol)<a name='3276'></font>
      RT_snd(i)= (1.-fracLiq)*tmp1 + fracLiq*tmp3  <font color=#447700>!total volume flux with partial melting (RSND, Fvsle_sol)<a name='3277'></font>
      <font color=#447700>!Note:  Calculation of instantaneous solid-to-liquid ratio [RS2L = RSND/RSN]<a name='3278'></font>
      <font color=#447700>!       is based on the above quantities and is done on 'calcdiag.ftn'.<a name='3279'></font>
<a name='3280'>
   enddo  <font color=#447700>!i-loop<a name='3281'></font>
<font color=#447700>!====<a name='3282'></font>
<a name='3283'>
 <font color=#447700>!++++<a name='3284'></font>
 <font color=#447700>! Diagnose surface precipitation types:<a name='3285'></font>
 <font color=#447700>!<a name='3286'></font>
 <font color=#447700>! The following involves diagnostic conditions to determine surface precipitation rates<a name='3287'></font>
 <font color=#447700>! for various precipitation elements defined in Canadian Meteorological Operational Internship<a name='3288'></font>
 <font color=#447700>! Program module 3.1 (plus one for large hail) based on the sedimentation rates of the five<a name='3289'></font>
 <font color=#447700>! sedimenting hydrometeor categories.<a name='3290'></font>
 <font color=#447700>!<a name='3291'></font>
 <font color=#447700>! With the diagnostics shut off (precipDiag_ON=.false.), 5 rates are just the 5 category<a name='3292'></font>
 <font color=#447700>! rates, with the other 6 rates just 0.  The model output variables will have:<a name='3293'></font>
 <font color=#447700>!<a name='3294'></font>
 <font color=#447700>!   total liquid = RT_rn1 [RAIN]<a name='3295'></font>
 <font color=#447700>!   total solid  = RT_sn1 [ICE] + RT_sn2 [SNOW] + RT_sn3 [GRAUPEL] + RT_pe1 [HAIL]<a name='3296'></font>
 <font color=#447700>!<a name='3297'></font>
 <font color=#447700>! With the diagnostics on, the 5 sedimentation rates are partitioned into 9 rates,<a name='3298'></font>
 <font color=#447700>! with the following model output variable:<a name='3299'></font>
 <font color=#447700>!<a name='3300'></font>
 <font color=#447700>!  total liquid = RT_rn1 [liquid rain] + RT_rn2 [liquid drizzle]<a name='3301'></font>
 <font color=#447700>!  total solid  = RT_fr1 [freezing rain] + RT_fr2 [freezing drizzle] + RT_sn1 [ice crystals] +<a name='3302'></font>
 <font color=#447700>!                 RT_sn2 [snow] + RT_sn3 [graupel] + RT_pe1 [ice pellets] + RT_pe2 [hail]<a name='3303'></font>
 <font color=#447700>!<a name='3304'></font>
 <font color=#447700>! NOTE:  - The above total liquid/solid rates are computed in 'calcdiag.ftn' (as R2/R4).<a name='3305'></font>
 <font color=#447700>!        - RT_peL [large hail] is a sub-set of RT_pe2 [hail] and is thus not added to the total<a name='3306'></font>
 <font color=#447700>!          solid precipitation.<a name='3307'></font>
<a name='3308'>
<font color=#447700>!   call tmg_start0(98,'mmCalcDIAG')<a name='3309'></font>
<a name='3310'>
   IF (precipDiag_ON) THEN<a name='3311'>
      DO i= 1,ni<a name='3312'>
<a name='3313'>
         DE(i,kbot)= pres(i,kbot)/(RGASD*T(i,kbot))<a name='3314'>
<a name='3315'>
      <font color=#447700>!rain vs. drizzle:<a name='3316'></font>
         N_r= NR(i,nk)<a name='3317'>
         if (QR(i,kbot)&gt;epsQ .and. N_r&gt;epsN) then<a name='3318'>
            Dm_r(i,kbot)= (DE(i,nk)*icmr*QR(i,kbot)/N_r)**thrd<a name='3319'>
            if (Dm_r(i,kbot)&gt;Dr_large) then  <font color=#447700>!Dr_large is rain/drizzle size threshold<a name='3320'></font>
               RT_rn2(i)= RT_rn1(i);   RT_rn1(i)= 0.<a name='3321'>
            endif<a name='3322'>
         endif<a name='3323'>
<a name='3324'>
      <font color=#447700>!liquid vs. freezing rain or drizzle:<a name='3325'></font>
         if (T(i,nk)&lt;TRPL) then<a name='3326'>
            RT_fr1(i)= RT_rn1(i);   RT_rn1(i)= 0.<a name='3327'>
            RT_fr2(i)= RT_rn2(i);   RT_rn2(i)= 0.<a name='3328'>
         endif<a name='3329'>
<a name='3330'>
      <font color=#447700>!ice pellets vs. hail:<a name='3331'></font>
         if (T(i,nk)&gt;(TRPL+5.0)) then<a name='3332'>
         <font color=#447700>!note: The condition (T_sfc&lt;5C) for ice pellets is a simply proxy for the presence<a name='3333'></font>
         <font color=#447700>!      of a warm layer aloft, though which falling snow or graupel will melt to rain,<a name='3334'></font>
         <font color=#447700>!      over a sub-freezinglayer, where the rain will freeze into the 'hail' category<a name='3335'></font>
            RT_pe2(i)= RT_pe1(i);   RT_pe1(i)= 0.<a name='3336'>
         endif<a name='3337'>
<a name='3338'>
      <font color=#447700>!large hail:<a name='3339'></font>
         if (QH(i,kbot)&gt;epsQ) then<a name='3340'>
            N_h  = NH(i,kbot)<a name='3341'>
            tmp1 = 1./N_h<a name='3342'>
            Dm_h(i,kbot)= <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_10">(DE(i,kbot),QH(i,kbot),tmp1,icmh,thrd)<a name='3343'>
            if (DM_h(i,kbot)&gt;Dh_large) RT_peL(i)= RT_pe2(i)<a name='3344'>
            <font color=#447700>!note: large hail (RT_peL) is a subset of the total hail (RT_pe2)<a name='3345'></font>
         endif<a name='3346'>
<a name='3347'>
      ENDDO<a name='3348'>
   ENDIF  <font color=#447700>!if (precipDiag_ON)<a name='3349'></font>
 <font color=#447700>!<a name='3350'></font>
 <font color=#447700>!++++<a name='3351'></font>
<a name='3352'>
 ENDIF  <font color=#447700>! if (sedi_ON)<a name='3353'></font>
<a name='3354'>
 where (Q&lt;0.) Q= 0.<a name='3355'>
<a name='3356'>
 <font color=#447700>!-----------------------------------------------------------------------------------!<a name='3357'></font>
 <font color=#447700>!                     End of sedimentation calculations (Part 4)                    !<a name='3358'></font>
 <font color=#447700>!-----------------------------------------------------------------------------------!<a name='3359'></font>
<a name='3360'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_12">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,800)<a name='3361'>
<a name='3362'>
 <font color=#447700>!===================================================================================!<a name='3363'></font>
 <font color=#447700>!                             End of microphysics scheme                            !<a name='3364'></font>
 <font color=#447700>!===================================================================================!<a name='3365'></font>
<a name='3366'>
 <font color=#447700>!-----------------------------------------------------------------------------------!<a name='3367'></font>
 <font color=#447700>!                    Calculation of diagnostic variables:                           !<a name='3368'></font>
<a name='3369'>
 <font color=#447700>!Compute effective radii for cloud and ice (to be passed to radiation scheme):<a name='3370'></font>
 <font color=#447700>!  - based of definition, r_eff = M_r(3)/M_r(2) = 0.5*M_D(3)/M_D(2),<a name='3371'></font>
 <font color=#447700>!    where the pth moment w.r.t. diameter, M_D(p), is given by MY2005a, eqn (2)<a name='3372'></font>
  do k = kbot,ktop,kdir<a name='3373'>
     do i = 1,ni<a name='3374'>
<a name='3375'>
      <font color=#447700>!cloud:<a name='3376'></font>
        if (QC(i,k)&gt;epsQ .and. NC(i,k)&gt;epsN) then<a name='3377'>
          <font color=#447700>!hardcoded for alpha_c = 1. and mu_c = 3.<a name='3378'></font>
           iNC   = 1./NC(i,k)<a name='3379'>
           iLAMc = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#ILAMDA_X'>iLAMDA_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ILAMDA_X_5">(DE(i,k),QC(i,k),iNC,icexc9,thrd)<a name='3380'>
        <font color=#447700>!   reff_c(i,k) = 0.664639*iLAMc<a name='3381'></font>
        else<a name='3382'>
        <font color=#447700>!   reff_c(i,k) = 0.<a name='3383'></font>
        endif<a name='3384'>
<a name='3385'>
      <font color=#447700>!ice:<a name='3386'></font>
        if (QI(i,k)&gt;epsQ .and. NY(i,k)&gt;epsN) then<a name='3387'>
          <font color=#447700>!hardcoded for alpha_i = 0. and mu_i = 1.<a name='3388'></font>
           iNY   = 1./NY(i,k)<a name='3389'>
           iLAMi = max( iLAMmin2, iLAMDA_x(DE(i,k),QI(i,k),iNY,icexi9,thrd) )<a name='3390'>
        <font color=#447700>!   reff_i(i,k) = 1.5*iLAMi<a name='3391'></font>
        else<a name='3392'>
        <font color=#447700>!   reff_i(i,k) = 0.<a name='3393'></font>
        endif<a name='3394'>
<a name='3395'>
     enddo<a name='3396'>
  enddo<a name='3397'>
<a name='3398'>
<a name='3399'>
  IF (calcDiag) THEN<a name='3400'>
<a name='3401'>
   <font color=#447700>!For reflectivity calculations:<a name='3402'></font>
     ZEC= minZET<a name='3403'>
     cxr=            icmr*icmr   <font color=#447700>!for rain<a name='3404'></font>
     cxi= 1./fdielec*icmr*icmr   <font color=#447700>!for all frozen categories<a name='3405'></font>
     Gzr= (6.+alpha_r)*(5.+alpha_r)*(4.+alpha_r)/((3.+alpha_r)*(2.+alpha_r)*(1.+alpha_r))<a name='3406'>
     Gzi= (6.+alpha_i)*(5.+alpha_i)*(4.+alpha_i)/((3.+alpha_i)*(2.+alpha_i)*(1.+alpha_i))<a name='3407'>
     if (snowSpherical) then  <font color=#447700>!dms=3<a name='3408'></font>
        Gzs= (6.+alpha_s)*(5.+alpha_s)*(4.+alpha_s)/((3.+alpha_s)*(2.+alpha_s)*          &amp;<a name='3409'>
             (1.+alpha_s))<a name='3410'>
     else                     <font color=#447700>!dms=2<a name='3411'></font>
        Gzs= (4.+alpha_s)*(3.+alpha_s)/((2.+alpha_s)*(1.+alpha_s))<a name='3412'>
     endif<a name='3413'>
     Gzg= (6.+alpha_g)*(5.+alpha_g)*(4.+alpha_g)/((3.+alpha_g)*(2.+alpha_g)*(1.+alpha_g))<a name='3414'>
     Gzh= (6.+alpha_h)*(5.+alpha_h)*(4.+alpha_h)/((3.+alpha_h)*(2.+alpha_h)*(1.+alpha_h))<a name='3415'>
<a name='3416'>
     do k= ktop,kbot,-kdir<a name='3417'>
       do i= 1,ni<a name='3418'>
           DE(i,k)= pres(i,k)/(RGASD*T(i,k))<a name='3419'>
           tmp9= DE(i,k)*DE(i,k)<a name='3420'>
<a name='3421'>
           N_c= NC(i,k)<a name='3422'>
           N_r= NR(i,k)<a name='3423'>
           N_i= NY(i,k)<a name='3424'>
           N_s= NN(i,k)<a name='3425'>
           N_g= NG(i,k)<a name='3426'>
           N_h= NH(i,k)<a name='3427'>
<a name='3428'>
        <font color=#447700>!Total equivalent reflectivity:     (units of [dBZ])<a name='3429'></font>
           tmp1= 0.;  tmp2= 0.;  tmp3= 0.;  tmp4= 0.;  tmp5= 0.<a name='3430'>
           if (QR(i,k)&gt;epsQ .and. N_r&gt;epsN) tmp1 = cxr*Gzr*tmp9*QR(i,k)*QR(i,k)/N_r<a name='3431'>
           if (QI(i,k)&gt;epsQ .and. N_i&gt;epsN) tmp2 = cxi*Gzi*tmp9*QI(i,k)*QI(i,k)/N_i<a name='3432'>
           if (QN(i,k)&gt;epsQ .and. N_s&gt;epsN) tmp3 = cxi*Gzs*tmp9*QN(i,k)*QN(i,k)/N_s<a name='3433'>
           if (QG(i,k)&gt;epsQ .and. N_g&gt;epsN) tmp4 = cxi*Gzg*tmp9*QG(i,k)*QG(i,k)/N_g<a name='3434'>
           if (QH(i,k)&gt;epsQ .and. N_h&gt;epsN) tmp5 = cxi*Gzh*tmp9*QH(i,k)*QH(i,k)/N_h<a name='3435'>
          <font color=#447700>!Modifiy dielectric constant for melting ice-phase categories:<a name='3436'></font>
           if ( T(i,k)&gt;TRPL) then<a name='3437'>
             tmp2= tmp2*fdielec<a name='3438'>
             tmp3= tmp3*fdielec<a name='3439'>
             tmp4= tmp4*fdielec<a name='3440'>
             tmp5= tmp5*fdielec<a name='3441'>
           endif<a name='3442'>
           ZET(i,k) = tmp1 + tmp2 + tmp3 + tmp4 + tmp5   <font color=#447700>!= Zr+Zi+Zs+Zg+Zh<a name='3443'></font>
           if (ZET(i,k)&gt;0.) then<a name='3444'>
              ZET(i,k)= 10.*log10((ZET(i,k)*Zfact))      <font color=#447700>!convert to dBZ<a name='3445'></font>
           else<a name='3446'>
              ZET(i,k)= minZET<a name='3447'>
           endif<a name='3448'>
           ZET(i,k)= max(ZET(i,k),minZET)<a name='3449'>
           ZEC(i)= max(ZEC(i),ZET(i,k))  <font color=#447700>!composite (max in column) of ZET<a name='3450'></font>
<a name='3451'>
         <font color=#447700>!Mean-mass diameters:  (units of [m])<a name='3452'></font>
           Dm_c(i,k)= 0.;   Dm_r(i,k)= 0.;   Dm_i(i,k)= 0.<a name='3453'>
           Dm_s(i,k)= 0.;   Dm_g(i,k)= 0.;   Dm_h(i,k)= 0.<a name='3454'>
           if (QC(i,k)&gt;epsQ.and.N_c&gt;epsN) then<a name='3455'>
              tmp1      = 1./N_c<a name='3456'>
              Dm_c(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_11">(DE(i,k),QC(i,k),tmp1,icmr,thrd)<a name='3457'>
           endif<a name='3458'>
           if (QR(i,k)&gt;epsQ.and.N_r&gt;epsN) then<a name='3459'>
              tmp1      = 1./N_r<a name='3460'>
              Dm_r(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_12">(DE(i,k),QR(i,k),tmp1,icmr,thrd)<a name='3461'>
           endif<a name='3462'>
           if (QI(i,k)&gt;epsQ.and.N_i&gt;epsN) then<a name='3463'>
              tmp1      = 1./N_i<a name='3464'>
              Dm_i(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_13">(DE(i,k),QI(i,k),tmp1,icmi,thrd)<a name='3465'>
           endif<a name='3466'>
           if (QN(i,k)&gt;epsQ.and.N_s&gt;epsN) then<a name='3467'>
              tmp1      = 1./N_s<a name='3468'>
              Dm_s(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_14">(DE(i,k),QN(i,k),tmp1,icms,idms)<a name='3469'>
           endif<a name='3470'>
           if (QG(i,k)&gt;epsQ.and.N_g&gt;epsN) then<a name='3471'>
              tmp1      = 1./N_g<a name='3472'>
              Dm_g(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_15">(DE(i,k),QG(i,k),tmp1,icmg,thrd)<a name='3473'>
           endif<a name='3474'>
           if (QH(i,k)&gt;epsQ.and.N_h&gt;epsN) then<a name='3475'>
              tmp1      = 1./N_h<a name='3476'>
              Dm_h(i,k) = <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X'>Dm_x</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DM_X_16">(DE(i,k),QH(i,k),tmp1,icmh,thrd)<a name='3477'>
           endif<a name='3478'>
<a name='3479'>
        enddo  <font color=#447700>!i-loop<a name='3480'></font>
     enddo     <font color=#447700>!k-loop<a name='3481'></font>
<a name='3482'>
  ENDIF<a name='3483'>
<a name='3484'>
<font color=#447700>!-- Convert N from #/m3 to #/kg:<a name='3485'></font>
  iDE = (RGASD*T)/pres<a name='3486'>
  NC  = NC*iDE<a name='3487'>
  NR  = NR*iDE<a name='3488'>
  NY  = NY*iDE<a name='3489'>
  NN  = NN*iDE<a name='3490'>
  NG  = NG*iDE<a name='3491'>
  NH  = NH*iDE<a name='3492'>
<a name='3493'>
<font color=#447700>!-- Ensure than no negative final values:<a name='3494'></font>
<font color=#447700>!   QC = max(QC, 0.);   NC = max(NC, 0.)<a name='3495'></font>
<font color=#447700>!   QR = max(QR, 0.);   NR = max(NR, 0.)<a name='3496'></font>
<font color=#447700>!   QI = max(QI, 0.);   NY = max(NY, 0.)<a name='3497'></font>
<font color=#447700>!   QN = max(QN, 0.);   NN = max(NN, 0.)<a name='3498'></font>
<font color=#447700>!   QG = max(QG, 0.);   NG = max(NG, 0.)<a name='3499'></font>
<font color=#447700>!   QH = max(QH, 0.);   NH = max(NH, 0.)<a name='3500'></font>
<a name='3501'>
  if (DEBUG_ON) call <A href='../../html_code/phys/module_mp_p3.F.html#CHECK_VALUES'>check_values</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_VALUES_13">(Q,T,QC,QR,QI,QN,QG,QH,NC,NR,NY,NN,NG,NH,epsQ,epsN,.false.,DEBUG_abort,900)<a name='3502'>
<a name='3503'>
 END SUBROUTINE mp_milbrandt2mom_main<a name='3504'>
<a name='3505'>
<font color=#447700>!___________________________________________________________________________________!<a name='3506'></font>
<a name='3507'>
<A NAME='DES_OF_DS'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DES_OF_DS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3508'>
   real <font color=#993300>function </font><font color=#cc0000>des_OF_Ds</font>(Ds_local,desMax_local,eds_local,fds_local) <A href='../../call_to/DES_OF_DS.html' TARGET='index'>1</A><a name='3509'>
   <font color=#447700>!Computes density of equivalent-volume snow particle based on (pi/6*des)*Ds^3 = cms*Ds^dms<a name='3510'></font>
      real :: Ds_local,desMax_local,eds_local,fds_local<a name='3511'>
<font color=#447700>!     des_OF_Ds= min(desMax_local, eds_local*Ds_local**fds_local)<a name='3512'></font>
      des_OF_Ds= min(desMax_local, eds_local*exp(fds_local*log(Ds_local)))   <font color=#447700>!IBM optimization<a name='3513'></font>
   end function des_OF_Ds<a name='3514'>
<a name='3515'>
<a name='3516'>
<A NAME='DM_X'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#DM_X' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3517'>
   real <font color=#993300>function </font><font color=#cc0000>Dm_x</font>(DE_local,QX_local,iNX_local,icmx_local,idmx_local) <A href='../../call_to/DM_X.html' TARGET='index'>16</A><a name='3518'>
   <font color=#447700>!Computes mean-mass diameter<a name='3519'></font>
      real :: DE_local,QX_local,iNX_local,icmx_local,idmx_local<a name='3520'>
     <font color=#447700>!Dm_x = (DE_local*QX_local*iNX_local*icmx_local)**idmx_local<a name='3521'></font>
      Dm_x = exp(idmx_local*log(DE_local*QX_local*iNX_local*icmx_local))     <font color=#447700>!IBM optimization<a name='3522'></font>
   end function Dm_x<a name='3523'>
<a name='3524'>
<a name='3525'>
<A NAME='ILAMDA_X'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#ILAMDA_X' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3526'>
   real <font color=#993300>function </font><font color=#cc0000>iLAMDA_x</font>(DE_local,QX_local,iNX_local,icex_local,idmx_local) <A href='../../call_to/ILAMDA_X.html' TARGET='index'>5</A><a name='3527'>
   <font color=#447700>!Computes 1/LAMDA ("slope" parameter):<a name='3528'></font>
      real :: DE_local,QX_local,iNX_local,icex_local,idmx_local<a name='3529'>
     <font color=#447700>!iLAMDA_x = (DE_local*QX_local*iNX_local*icex_local)**idmx_local<a name='3530'></font>
      iLAMDA_x = exp(idmx_local*log(DE_local*QX_local*iNX_local*icex_local)) <font color=#447700>!IBM optimization<a name='3531'></font>
   end function<a name='3532'>
<a name='3533'>
<a name='3534'>
<A NAME='N_COOPER'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#N_COOPER' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3535'>
   real <font color=#993300>function </font><font color=#cc0000>N_Cooper</font>(TRPL_local,T_local) <A href='../../call_to/N_COOPER.html' TARGET='index'>3</A><a name='3536'>
   <font color=#447700>!Computes total number concentration of ice as a function of temperature<a name='3537'></font>
   <font color=#447700>!according to parameterization of Cooper (1986):<a name='3538'></font>
      real :: TRPL_local,T_local<a name='3539'>
      N_Cooper= 5.*exp(0.304*(TRPL_local-max(233.,T_local)))<a name='3540'>
   end function N_Cooper<a name='3541'>
<a name='3542'>
<A NAME='NOS_THOMPSON'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#NOS_THOMPSON' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3543'>
   real <font color=#993300>function </font><font color=#cc0000>Nos_Thompson</font>(TRPL_local,T_local) <A href='../../call_to/NOS_THOMPSON.html' TARGET='index'>2</A>,<A href='../../call_from/NOS_THOMPSON.html' TARGET='index'>2</A><a name='3544'>
   <font color=#447700>!Computes the snow intercept, No_s, as a function of temperature<a name='3545'></font>
   <font color=#447700>!according to the parameterization of Thompson et al. (2004):<a name='3546'></font>
      real :: TRPL_local,T_local<a name='3547'>
      Nos_Thompson= min(2.e+8, 2.e+6*exp(-0.12*min(-0.001,T_local-TRPL_local)))<a name='3548'>
   end function Nos_Thompson<a name='3549'>
<a name='3550'>
<font color=#447700>!===================================================================================================!<a name='3551'></font>
<a name='3552'>
END MODULE my2_mod<a name='3553'>
<a name='3554'>
<font color=#447700>!________________________________________________________________________________________!<a name='3555'></font>
<a name='3556'>
<A NAME='MODULE_MP_MILBRANDT2MOM'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MODULE_MP_MILBRANDT2MOM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3557'>
 <font color=#993300>MODULE </font><font color=#cc0000>module_mp_milbrandt2mom</font> <A href='../../call_to/MODULE_MP_MILBRANDT2MOM.html' TARGET='index'>2</A><a name='3558'>
<a name='3559'>
      use <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#NOS_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_62"><a name='3560'>
      use <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MY2_MOD'>my2_mod</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#NOS_THOMPSON' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MY2_MOD_1">, ONLY: mp_milbrandt2mom_main<a name='3561'>
<a name='3562'>
      implicit none<a name='3563'>
<a name='3564'>
<font color=#447700>! To be done later.  Currently, parameters are initialized in the main routine<a name='3565'></font>
<font color=#447700>! (at every time step).<a name='3566'></font>
<a name='3567'>
      CONTAINS<a name='3568'>
<a name='3569'>
<font color=#447700>!----------------------------------------------------------------------------------------!<a name='3570'></font>
<A NAME='MILBRANDT2MOM_INIT'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MILBRANDT2MOM_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3571'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>milbrandt2mom_init</font> <A href='../../call_to/MILBRANDT2MOM_INIT.html' TARGET='index'>1</A><a name='3572'>
<a name='3573'>
<font color=#447700>! To be done later.  Currently, parameters are initialized in the main routine (at every time step).<a name='3574'></font>
<a name='3575'>
      END SUBROUTINE milbrandt2mom_init<a name='3576'>
<a name='3577'>
<font color=#447700>!----------------------------------------------------------------------------------------!<a name='3578'></font>
<a name='3579'>
 <font color=#447700>!+---------------------------------------------------------------------+<a name='3580'></font>
 <font color=#447700>! This is a wrapper routine designed to transfer values from 3D to 2D. !<a name='3581'></font>
 <font color=#447700>!+---------------------------------------------------------------------+<a name='3582'></font>
<a name='3583'>
<a name='3584'>
<A NAME='MP_MILBRANDT2MOM_DRIVER'><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3585'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>mp_milbrandt2mom_driver</font>(qv, qc, qr, qi, qs, qg, qh, nc, nr, ni, ns, ng,  &amp; <A href='../../call_to/MP_MILBRANDT2MOM_DRIVER.html' TARGET='index'>1</A>,<A href='../../call_from/MP_MILBRANDT2MOM_DRIVER.html' TARGET='index'>1</A><a name='3586'>
                              nh, th, pii, p, w, dz, dt_in, itimestep, p8w,               &amp; <a name='3587'>
                              RAINNC, RAINNCV, SNOWNC, SNOWNCV, GRPLNC, GRPLNCV,          &amp;<a name='3588'>
                              HAILNC, HAILNCV, SR, Zet,                                   &amp;<a name='3589'>
                              ids,ide, jds,jde, kds,kde,                                  &amp;  <font color=#447700>! domain dims<a name='3590'></font>
                              ims,ime, jms,jme, kms,kme,                                  &amp;  <font color=#447700>! memory dims<a name='3591'></font>
                              its,ite, jts,jte, kts,kte)                                     <font color=#447700>! tile dims<a name='3592'></font>
<a name='3593'>
      implicit none<a name='3594'>
<a name='3595'>
 <font color=#447700>!Subroutine arguments:<a name='3596'></font>
      integer, intent(in):: ids,ide, jds,jde, kds,kde,                                   &amp;<a name='3597'>
                            ims,ime, jms,jme, kms,kme,                                   &amp;<a name='3598'>
                            its,ite, jts,jte, kts,kte<a name='3599'>
      real, dimension(ims:ime, kms:kme, jms:jme), intent(inout)::                        &amp;<a name='3600'>
                            qv,qc,qr,qi,qs,qg,qh,nc,nr,ni,ns,ng,nh,th,Zet<a name='3601'>
      real, dimension(ims:ime, kms:kme, jms:jme), intent(in)::                           &amp;<a name='3602'>
                            pii,p,w,dz<a name='3603'>
      real, dimension(ims:ime, kms:kme, jms:jme), intent(in):: p8w                                  <a name='3604'>
      real, dimension(ims:ime, jms:jme), intent(inout)::                                 &amp;<a name='3605'>
                            RAINNC,RAINNCV,SNOWNC,SNOWNCV,GRPLNC,GRPLNCV,HAILNC,HAILNCV, &amp;<a name='3606'>
                            SR<a name='3607'>
      real, intent(in)::    dt_in<a name='3608'>
      integer, intent(in):: itimestep <font color=#447700>!, ccntype<a name='3609'></font>
<a name='3610'>
 <font color=#447700>!Local variables:<a name='3611'></font>
      real, dimension(1:ite-its+1,1:kte-kts+1) :: t2d,p2d,sigma2d<a name='3612'>
<a name='3613'>
     <font color=#447700>!tentatively local; to be passed out as output variables later<a name='3614'></font>
      real, dimension(1:ite-its+1,1:kte-kts+1)      :: Dm_c,Dm_r,Dm_i,Dm_s,Dm_g,Dm_h<a name='3615'>
      real, dimension(1:ite-its+1,1:kte-kts+1,1:20) :: SS<a name='3616'>
      <font color=#447700>!note: 20 is temporarily hardcoded; eventually should allocate size with parameter<a name='3617'></font>
      <font color=#447700>!integer, parameter :: numSS = 20    ! number of diagnostic arrays [SS(i,k,:)]<a name='3618'></font>
<a name='3619'>
      real, dimension(1:ite-its+1) :: rt_rn1,rt_rn2,rt_fr1,rt_fr2,rt_sn1,rt_sn2,rt_sn3,  &amp;<a name='3620'>
            rt_pe1,rt_pe2,rt_peL,rt_snd,ZEC,p_sfc<a name='3621'>
      real, dimension(ims:ime, kms:kme, jms:jme) :: t3d<a name='3622'>
<a name='3623'>
      real    :: dt,ms2mmstp<a name='3624'>
      integer :: i,j,k,i2d,k2d,i2d_max,k2d_max<a name='3625'>
      integer :: i_start, j_start, i_end, j_end, CCNtype<a name='3626'>
      logical :: precipDiag_ON,sedi_ON,warmphase_ON,autoconv_ON,icephase_ON,snow_ON<a name='3627'>
<a name='3628'>
      real, parameter    :: ms2mmh    = 3.6e+6   <font color=#447700>!conversion factor for precipitation rates<a name='3629'></font>
      logical, parameter :: nk_BOTTOM = .false.  <font color=#447700>!.F. for k=1 at bottom level (WRF)<a name='3630'></font>
<a name='3631'>
      real, parameter    :: statfreq  = 300.     <font color=#447700>!frequency (seconds) to output block stats<a name='3632'></font>
<a name='3633'>
<font color=#447700>!+---+<a name='3634'></font>
      i2d_max  = ite-its+1<a name='3635'>
      k2d_max  = kte-kts+1<a name='3636'>
      dt       = dt_in<a name='3637'>
      ms2mmstp = 1.e+3*dt    <font color=#447700>!conversion factor: m/2 to mm/step<a name='3638'></font>
<a name='3639'>
   <font color=#447700>!--- temporary initialization (until variables are put as namelist options:<a name='3640'></font>
<font color=#447700>!     CCNtype       = 1.  !maritime      --&gt; N_c =  80 cm-3 for dblMom_c = .F.<a name='3641'></font>
      CCNtype       = 2.  <font color=#447700>!continental   --&gt; N_c = 200 cm-3 for dblMom_c = .F.<a name='3642'></font>
<a name='3643'>
      precipDiag_ON = .true.<a name='3644'>
      sedi_ON       = .true.<a name='3645'>
      warmphase_ON  = .true.<a name='3646'>
      autoconv_ON   = .true.<a name='3647'>
      icephase_ON   = .true.<a name='3648'>
      snow_ON       = .true.<a name='3649'>
   <font color=#447700>!---<a name='3650'></font>
<a name='3651'>
      RAINNCV(its:ite,jts:jte) = 0.<a name='3652'>
      SNOWNCV(its:ite,jts:jte) = 0.<a name='3653'>
      GRPLNCV(its:ite,jts:jte) = 0.<a name='3654'>
      HAILNCV(its:ite,jts:jte) = 0.<a name='3655'>
      SR(its:ite,jts:jte)      = 0.<a name='3656'>
<a name='3657'>
      <font color=#447700>!--run-time stats:<a name='3658'></font>
<font color=#447700>!       if (mod(itimestep*dt,statfreq)==0.) then<a name='3659'></font>
<font color=#447700>!           t3d = th*pii<a name='3660'></font>
<font color=#447700>!           print*, 'Bloc Stats -- BEFORE micro call (my-2.25.1_b11)'<a name='3661'></font>
<font color=#447700>!           write(6,'(a8,7e15.5)') 'Max qx: ',maxval(qc(its:ite,kts:kte,jts:jte)),maxval(qr(its:ite,kts:kte,jts:jte)),maxval(qi(its:ite,kts:kte,jts:jte)), &amp;<a name='3662'></font>
<font color=#447700>!                                             maxval(qs(its:ite,kts:kte,jts:jte)),maxval(qg(its:ite,kts:kte,jts:jte)),maxval(qh(its:ite,kts:kte,jts:jte))<a name='3663'></font>
<font color=#447700>!           write(6,'(a8,6e15.5)') 'Max Nx: ',maxval(nc(its:ite,kts:kte,jts:jte)),maxval(nr(its:ite,kts:kte,jts:jte)),maxval(ni(its:ite,kts:kte,jts:jte)), &amp;<a name='3664'></font>
<font color=#447700>!                                             maxval(ns(its:ite,kts:kte,jts:jte)),maxval(ng(its:ite,kts:kte,jts:jte)),maxval(nh(its:ite,kts:kte,jts:jte))<a name='3665'></font>
<font color=#447700>!           write(6,'(a8,7e15.5)') 'Min qx: ',minval(qc(its:ite,kts:kte,jts:jte)),minval(qr(its:ite,kts:kte,jts:jte)),minval(qi(its:ite,kts:kte,jts:jte)), &amp;<a name='3666'></font>
<font color=#447700>!                                             minval(qs(its:ite,kts:kte,jts:jte)),minval(qg(its:ite,kts:kte,jts:jte)),minval(qh(its:ite,kts:kte,jts:jte))<a name='3667'></font>
<font color=#447700>!           write(6,'(a8,6e15.5)') 'Min Nx: ',minval(nc(its:ite,kts:kte,jts:jte)),minval(nr(its:ite,kts:kte,jts:jte)),minval(ni(its:ite,kts:kte,jts:jte)), &amp;<a name='3668'></font>
<font color=#447700>!                                             minval(ns(its:ite,kts:kte,jts:jte)),minval(ng(its:ite,kts:kte,jts:jte)),minval(nh(its:ite,kts:kte,jts:jte))<a name='3669'></font>
<font color=#447700>!           write(6,'(a8,6e15.5)') 'W,T,qv: ',minval( w(its:ite,kts:kte,jts:jte)),maxval( w(its:ite,kts:kte,jts:jte)),minval(t3d(its:ite,kts:kte,jts:jte)),&amp;<a name='3670'></font>
<font color=#447700>!                                             maxval(t3d(its:ite,kts:kte,jts:jte)),minval(qv(its:ite,kts:kte,jts:jte)),maxval(qv(its:ite,kts:kte,jts:jte))<a name='3671'></font>
<font color=#447700>!       endif<a name='3672'></font>
      <a name='3673'>
      do j = jts, jte<a name='3674'>
<a name='3675'>
         t2d(:,:) = th(its:ite,kts:kte,j)*pii(its:ite,kts:kte,j)<a name='3676'>
         p2d(:,:) = p(its:ite,kts:kte,j)<a name='3677'>
      <font color=#447700>!   p_sfc(:) = p2d(:,k2d_max)<a name='3678'></font>
         p_sfc(:) = p8w(its:ite,kms, j)  <a name='3679'>
<a name='3680'>
         do i = its, ite<a name='3681'>
            i2d = i-its+1<a name='3682'>
            sigma2d(i2d,:) = p2d(i2d,:)/p_sfc(i2d)<a name='3683'>
         enddo<a name='3684'>
         call <A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_MAIN'>mp_milbrandt2mom_main</A><A href='../../html_code/phys/module_mp_milbrandt2mom.F.html#MP_MILBRANDT2MOM_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MP_MILBRANDT2MOM_MAIN_1">(w(its:ite,kts:kte,j),t2d,qv(its:ite,kts:kte,j), &amp;<a name='3685'>
               qc(its:ite,kts:kte,j),qr(its:ite,kts:kte,j),qi(its:ite,kts:kte,j),   &amp;<a name='3686'>
               qs(its:ite,kts:kte,j),qg(its:ite,kts:kte,j),qh(its:ite,kts:kte,j),   &amp;<a name='3687'>
               nc(its:ite,kts:kte,j),nr(its:ite,kts:kte,j),ni(its:ite,kts:kte,j),   &amp;<a name='3688'>
               ns(its:ite,kts:kte,j),ng(its:ite,kts:kte,j),nh(its:ite,kts:kte,j),   &amp;<a name='3689'>
               p_sfc,sigma2d,rt_rn1,rt_rn2,rt_fr1,rt_fr2,rt_sn1,rt_sn2,rt_sn3,      &amp;<a name='3690'>
               rt_pe1,rt_pe2,rt_peL,rt_snd,dt,i2d_max,k2d_max,j,itimestep,CCNtype,  &amp;<a name='3691'>
               precipDiag_ON,sedi_ON,warmphase_ON,autoconv_ON,icephase_ON,snow_ON,  &amp;<a name='3692'>
               Dm_c,Dm_r,Dm_i,Dm_s,Dm_g,Dm_h,Zet(its:ite,kts:kte,j),ZEC,SS,nk_BOTTOM)<a name='3693'>
<a name='3694'>
         th(its:ite,kts:kte,j) = t2d(:,:)/pii(its:ite,kts:kte,j)<a name='3695'>
<a name='3696'>
         <font color=#447700>!Convert individual precipitation rates (in m/s) to WRF precipitation fields (mm/step):<a name='3697'></font>
         RAINNCV(its:ite,j) = ( rt_rn1(:)+rt_rn2(:)+rt_fr1(:)+rt_fr2(:)+rt_sn1(:)+rt_sn2(:)+ &amp;<a name='3698'>
                                rt_sn3(:)+rt_pe1(:)+rt_pe2(:) )*ms2mmstp<a name='3699'>
         SNOWNCV(its:ite,j) = (rt_sn1(:) + rt_sn2(:))*ms2mmstp<a name='3700'>
         HAILNCV(its:ite,j) = (rt_pe1(:) + rt_pe2(:))*ms2mmstp<a name='3701'>
         GRPLNCV(its:ite,j) = rt_sn3(:)*ms2mmstp<a name='3702'>
<a name='3703'>
         RAINNC(its:ite,j)  = RAINNC(its:ite,j) + RAINNCV(its:ite,j)<a name='3704'>
         SNOWNC(its:ite,j)  = SNOWNC(its:ite,j) + SNOWNCV(its:ite,j)<a name='3705'>
         HAILNC(its:ite,j)  = HAILNC(its:ite,j) + HAILNCV(its:ite,j)<a name='3706'>
         GRPLNC(its:ite,j)  = GRPLNC(its:ite,j) + GRPLNCV(its:ite,j)<a name='3707'>
         SR(its:ite,j)      = (SNOWNCV(its:ite,j)+HAILNCV(its:ite,j)+GRPLNCV(its:ite,j))/(RAINNCV(its:ite,j)+1.e-12)<a name='3708'>
<a name='3709'>
<a name='3710'>
      enddo <font color=#447700>!j_loop<a name='3711'></font>
<a name='3712'>
      <font color=#447700>!--run-time stats:<a name='3713'></font>
<font color=#447700>!       if (mod(itimestep*dt,statfreq)==0.) then<a name='3714'></font>
<font color=#447700>!          t3d = th*pii<a name='3715'></font>
<font color=#447700>!          print*, 'Bloc Stats -- AFTER micro call; my_2.25.1-b11)'<a name='3716'></font>
<font color=#447700>!          write(6,'(a8,7e15.5)') 'Max qx: ',maxval(qc(its:ite,kts:kte,jts:jte)),maxval(qr(its:ite,kts:kte,jts:jte)),maxval(qi(its:ite,kts:kte,jts:jte)), &amp;<a name='3717'></font>
<font color=#447700>!                                            maxval(qs(its:ite,kts:kte,jts:jte)),maxval(qg(its:ite,kts:kte,jts:jte)),maxval(qh(its:ite,kts:kte,jts:jte))<a name='3718'></font>
<font color=#447700>!          write(6,'(a8,6e15.5)') 'Max Nx: ',maxval(nc(its:ite,kts:kte,jts:jte)),maxval(nr(its:ite,kts:kte,jts:jte)),maxval(ni(its:ite,kts:kte,jts:jte)), &amp;<a name='3719'></font>
<font color=#447700>!                                            maxval(ns(its:ite,kts:kte,jts:jte)),maxval(ng(its:ite,kts:kte,jts:jte)),maxval(nh(its:ite,kts:kte,jts:jte))<a name='3720'></font>
<font color=#447700>!          write(6,'(a8,7e15.5)') 'Min qx: ',minval(qc(its:ite,kts:kte,jts:jte)),minval(qr(its:ite,kts:kte,jts:jte)),minval(qi(its:ite,kts:kte,jts:jte)), &amp;<a name='3721'></font>
<font color=#447700>!                                            minval(qs(its:ite,kts:kte,jts:jte)),minval(qg(its:ite,kts:kte,jts:jte)),minval(qh(its:ite,kts:kte,jts:jte))<a name='3722'></font>
<font color=#447700>!          write(6,'(a8,6e15.5)') 'Min Nx: ',minval(nc(its:ite,kts:kte,jts:jte)),minval(nr(its:ite,kts:kte,jts:jte)),minval(ni(its:ite,kts:kte,jts:jte)), &amp;<a name='3723'></font>
<font color=#447700>!                                            minval(ns(its:ite,kts:kte,jts:jte)),minval(ng(its:ite,kts:kte,jts:jte)),minval(nh(its:ite,kts:kte,jts:jte))<a name='3724'></font>
<font color=#447700>!          write(6,'(a8,6e15.5)') 'W,T,qv: ',minval( w(its:ite,kts:kte,jts:jte)),maxval( w(its:ite,kts:kte,jts:jte)),minval(t3d(its:ite,kts:kte,jts:jte)),&amp;<a name='3725'></font>
<font color=#447700>!                                            maxval(t3d(its:ite,kts:kte,jts:jte)),minval(qv(its:ite,kts:kte,jts:jte)),maxval(qv(its:ite,kts:kte,jts:jte))<a name='3726'></font>
<font color=#447700>!          write(6,'(a8,2e15.5)') 'Zet   : ',maxval(Zet(its:ite,kts:kte,jts:jte))<a name='3727'></font>
<font color=#447700>!       endif<a name='3728'></font>
<a name='3729'>
      END SUBROUTINE mp_milbrandt2mom_driver<a name='3730'>
<a name='3731'>
<font color=#447700>!+---+-----------------------------------------------------------------+<a name='3732'></font>
<font color=#447700>!________________________________________________________________________________________!<a name='3733'></font>
<a name='3734'>
END MODULE module_mp_milbrandt2mom<a name='3735'>
</pre></body></html>