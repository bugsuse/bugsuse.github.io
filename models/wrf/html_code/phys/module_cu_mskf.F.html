<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='MODULE_CU_MSKF'><A href='../../html_code/phys/module_cu_mskf.F.html#MODULE_CU_MSKF' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>module_cu_mskf</font> <A href='../../call_to/MODULE_CU_MSKF.html' TARGET='index'>2</A><a name='3'>
<a name='4'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_cu_mskf.F.html#module_cu_mskf.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_47"><a name='5'>
<a name='6'>
<font color=#447700>!<a name='7'></font>
<font color=#447700>!ckay=Kiran Alapaty, EPA<a name='8'></font>
<font color=#447700>!CGM = Chris Marciano, NCSU<a name='9'></font>
<font color=#447700>!<a name='10'></font>
<font color=#447700>!multi-scale KF scheme<a name='11'></font>
<font color=#447700>!  (1) With diagnosed deep and shallow KF cloud fraction using<a name='12'></font>
<font color=#447700>!       CAM3-CAM5 methodology, along with captured liquid and ice condensates.<a name='13'></font>
<font color=#447700>!       and linking with the RRTMG &amp; Other radiation schemes<a name='14'></font>
<font color=#447700>! (2) Scale-dependent Dynamic adjustment timescale for KF clouds (both shallow and deep)<a name='15'></font>
<font color=#447700>! (3) Scale-dependent LCL-based entrainment Methodology that avoids 2-km cloud radius method<a name='16'></font>
<font color=#447700>! (4) Scale-dependent Fallout Rate<a name='17'></font>
<font color=#447700>! (5) Scale-dependent Stabilization Capacity<a name='18'></font>
<font color=#447700>! (6) Elimination of "double counting" when environment is saturated<a name='19'></font>
<font color=#447700>!<a name='20'></font>
<font color=#447700>! Alapaty et al., 2012: Introducing subgrid-scale cloud feedbacks to radiation<a name='21'></font>
<font color=#447700>!    for regional meteorological and climate modeling. GRL, V39, I24.<a name='22'></font>
<font color=#447700>!<a name='23'></font>
<font color=#447700>! Alapaty et al., 2013:  The Kain-Fritsch Scheme: Science Updates and revisiting<a name='24'></font>
<font color=#447700>!     gray-scale issues from the NWP and regional climate perspectives. 2013 WRF<a name='25'></font>
<font color=#447700>!     workshop: URL: http://www.mmm.ucar.edu/wrf/users/workshops/WS2013/ppts/9.2.pdf<a name='26'></font>
<font color=#447700>!<a name='27'></font>
<font color=#447700>! Herwehe et al., 2014: Increasing the credibility of regional climate simulations <a name='28'></font>
<font color=#447700>!     by introducing subgrid-scale cloud-radiation interactions. JGR, 119,<a name='29'></font>
<font color=#447700>!     5317-5330, doi:10.1002/2014JD021504.<a name='30'></font>
<font color=#447700>!<a name='31'></font>
<font color=#447700>! Zheng et al., 2015: Improving High-Resolution Weather Forecasts using the<a name='32'></font>
<font color=#447700>!     Weather Research and Forecasting (WRF) Model with an Updated Kain-Fritsch<a name='33'></font>
<font color=#447700>!     Scheme. Revision - Mon. Wea. Rev.<a name='34'></font>
<font color=#447700>!ckay<a name='35'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='36'></font>
<font color=#447700>! Lookup table variables:<a name='37'></font>
      INTEGER, PARAMETER :: KFNT=250,KFNP=220<a name='38'>
      REAL, DIMENSION(KFNT,KFNP),PRIVATE, SAVE :: TTAB,QSTAB<a name='39'>
      REAL, DIMENSION(KFNP),PRIVATE, SAVE :: THE0K<a name='40'>
      REAL, DIMENSION(200),PRIVATE, SAVE :: ALU<a name='41'>
      REAL, PRIVATE, SAVE :: RDPR,RDTHK,PLUTOP<a name='42'>
<font color=#447700>! Note:  KF Lookup table is used by subroutines KF_eta_PARA, TPMIX2,<a name='43'></font>
<font color=#447700>!        TPMIX2DD, ENVIRTHT<a name='44'></font>
<font color=#447700>! End of Lookup table variables:<a name='45'></font>
<a name='46'>
CONTAINS<a name='47'>
<a name='48'>
<A NAME='MSKF_CPS'><A href='../../html_code/phys/module_cu_mskf.F.html#MSKF_CPS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='49'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>MSKF_CPS</font>(                                      &amp; <A href='../../call_to/MSKF_CPS.html' TARGET='index'>1</A>,<A href='../../call_from/MSKF_CPS.html' TARGET='index'>1</A><a name='50'>
              ids,ide, jds,jde, kds,kde                      &amp;<a name='51'>
             ,ims,ime, jms,jme, kms,kme                      &amp;<a name='52'>
             ,its,ite, jts,jte, kts,kte                      &amp;<a name='53'>
             ,trigger                                        &amp;<a name='54'>
             ,DT,KTAU,DX,CUDT,ADAPT_STEP_FLAG                &amp;<a name='55'>
             ,rho,RAINCV,PRATEC,NCA                          &amp;<a name='56'>
             ,U,V,TH,T,W,dz8w,Pcps,pi                        &amp;<a name='57'>
             ,W0AVG,XLV0,XLV1,XLS0,XLS1,CP,R,G,EP1           &amp;<a name='58'>
             ,EP2,SVP1,SVP2,SVP3,SVPT0                       &amp;<a name='59'>
             ,STEPCU,CU_ACT_FLAG,warm_rain,CUTOP,CUBOT       &amp;<a name='60'>
             ,QV                                             &amp;<a name='61'>
            <font color=#447700>! optionals<a name='62'></font>
             ,F_QV    ,F_QC    ,F_QR    ,F_QI    ,F_QS       &amp;<a name='63'>
             ,RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN            &amp;<a name='64'>
             ,RQICUTEN,RQSCUTEN, RQVFTEN                     &amp;<a name='65'>
<font color=#447700>!ckay<a name='66'></font>
             ,cldfra_dp_KF,cldfra_sh_KF,w_up                 &amp;<a name='67'>
             ,qc_KF,qi_KF                                    &amp;<a name='68'>
<font color=#447700>!kf_edrates<a name='69'></font>
             ,UDR_KF,DDR_KF                                  &amp;<a name='70'>
             ,UER_KF,DER_KF                                  &amp;<a name='71'>
             ,TIMEC_KF,KF_EDRATES                            &amp; <a name='72'>
             ,ZOL,WSTAR,UST,PBLH                             &amp;   <font color=#447700>!ckay<a name='73'></font>
                                                             )<a name='74'>
<font color=#447700>!<a name='75'></font>
<font color=#447700>!-------------------------------------------------------------<a name='76'></font>
   IMPLICIT NONE<a name='77'>
<font color=#447700>!-------------------------------------------------------------<a name='78'></font>
   INTEGER,      INTENT(IN   ) ::                            &amp;<a name='79'>
                                  ids,ide, jds,jde, kds,kde, &amp;<a name='80'>
                                  ims,ime, jms,jme, kms,kme, &amp;<a name='81'>
                                  its,ite, jts,jte, kts,kte<a name='82'>
<a name='83'>
   INTEGER,      INTENT(IN   ) :: trigger<a name='84'>
   INTEGER,      INTENT(IN   ) :: STEPCU<a name='85'>
   LOGICAL,      INTENT(IN   ) :: warm_rain<a name='86'>
<a name='87'>
   REAL,         INTENT(IN   ) :: XLV0,XLV1,XLS0,XLS1<a name='88'>
   REAL,         INTENT(IN   ) :: CP,R,G,EP1,EP2<a name='89'>
   REAL,         INTENT(IN   ) :: SVP1,SVP2,SVP3,SVPT0<a name='90'>
<a name='91'>
   INTEGER,      INTENT(IN   ) :: KTAU           <a name='92'>
<a name='93'>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='94'>
          INTENT(IN   ) ::                                   &amp;<a name='95'>
                                                          U, &amp;<a name='96'>
                                                          V, &amp;<a name='97'>
<font color=#447700>!ckay                                                     W, &amp;<a name='98'></font>
                                                         TH, &amp;<a name='99'>
                                                          T, &amp;<a name='100'>
                                                         QV, &amp;<a name='101'>
                                                       dz8w, &amp;<a name='102'>
                                                       Pcps, &amp;<a name='103'>
                                                        rho, &amp;<a name='104'>
                                                         pi<a name='105'>
<font color=#447700>!<a name='106'></font>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='107'>
          INTENT(INOUT) ::                                   &amp;<a name='108'>
                                                      W0AVG   <a name='109'>
<a name='110'>
   REAL,  INTENT(IN   ) :: DT, DX<a name='111'>
   REAL,  INTENT(IN   ) :: CUDT<a name='112'>
   LOGICAL,OPTIONAL,INTENT(IN   ) :: ADAPT_STEP_FLAG<a name='113'>
<font color=#447700>!<a name='114'></font>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='115'>
          INTENT(INOUT) ::                           RAINCV<a name='116'>
<a name='117'>
   REAL,    DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='118'>
          INTENT(INOUT) ::                           PRATEC<a name='119'>
<a name='120'>
   REAL,    DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='121'>
            INTENT(INOUT) ::                            NCA<a name='122'>
<a name='123'>
   REAL, DIMENSION( ims:ime , jms:jme ),                     &amp;<a name='124'>
          INTENT(OUT) ::                              CUBOT, &amp;<a name='125'>
                                                      CUTOP    <a name='126'>
<a name='127'>
   LOGICAL, DIMENSION( ims:ime , jms:jme ),                  &amp;<a name='128'>
          INTENT(INOUT) :: CU_ACT_FLAG<a name='129'>
<a name='130'>
<font color=#447700>!<a name='131'></font>
<font color=#447700>! Optional arguments<a name='132'></font>
<font color=#447700>!<a name='133'></font>
<a name='134'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),           &amp;<a name='135'>
         OPTIONAL,                                           &amp;<a name='136'>
         INTENT(INOUT) ::                                    &amp;<a name='137'>
                                                   RTHCUTEN, &amp;<a name='138'>
                                                   RQVCUTEN, &amp;<a name='139'>
                                                   RQCCUTEN, &amp;<a name='140'>
                                                   RQRCUTEN, &amp;<a name='141'>
                                                   RQICUTEN, &amp;<a name='142'>
                                                   RQSCUTEN, &amp;<a name='143'>
                                                   RQVFTEN<a name='144'>
<font color=#447700>!<a name='145'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='146'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='147'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='148'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='149'></font>
<font color=#447700>! use or not.<a name='150'></font>
<font color=#447700>!<a name='151'></font>
   LOGICAL, OPTIONAL ::                                      &amp;<a name='152'>
                                                   F_QV      &amp;<a name='153'>
                                                  ,F_QC      &amp;<a name='154'>
                                                  ,F_QR      &amp;<a name='155'>
                                                  ,F_QI      &amp;<a name='156'>
                                                  ,F_QS<a name='157'>
<a name='158'>
<font color=#447700>!ckay<a name='159'></font>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='160'>
          INTENT(INOUT) ::                                   &amp;<a name='161'>
                                               cldfra_dp_KF, &amp;<a name='162'>
                                               cldfra_sh_KF, &amp;<a name='163'>
                                                      qc_KF, &amp;<a name='164'>
                                                      qi_KF, &amp;<a name='165'>
                                                          W<a name='166'>
<a name='167'>
<font color=#447700>!kf_edrates<a name='168'></font>
   REAL,  DIMENSION( ims:ime , kms:kme , jms:jme )         , &amp;<a name='169'>
          INTENT(INOUT) ::                         &amp;<a name='170'>
                                                     UDR_KF, &amp;<a name='171'>
                                                     DDR_KF, &amp;<a name='172'>
                                                     UER_KF, &amp;<a name='173'>
                                                     DER_KF<a name='174'>
<a name='175'>
   REAL,  DIMENSION( ims:ime , jms:jme )                   , &amp;<a name='176'>
          INTENT(INOUT) ::                         &amp;<a name='177'>
                                                   TIMEC_KF<a name='178'>
<a name='179'>
   INTEGER, INTENT(IN) ::              KF_EDRATES<a name='180'>
<a name='181'>
<font color=#447700>!ckay<a name='182'></font>
   REAL, DIMENSION( ims:ime, jms:jme )                     , &amp;<a name='183'>
         INTENT(   IN) ::                               ZOL, &amp;<a name='184'>
                                                      WSTAR, &amp;<a name='185'>
                                                        UST, &amp;<a name='186'>
                                                       PBLH<a name='187'>
<font color=#447700>!ckaywup<a name='188'></font>
   REAL, DIMENSION( ims:ime,  kms:kme , jms:jme )          , &amp;<a name='189'>
           INTENT(INOUT) ::                             w_up<a name='190'>
<a name='191'>
<a name='192'>
<font color=#447700>! LOCAL VARS<a name='193'></font>
<a name='194'>
   LOGICAL :: flag_qr, flag_qi, flag_qs<a name='195'>
<a name='196'>
   REAL, DIMENSION( kts:kte ) ::                             &amp;<a name='197'>
                                                        U1D, &amp;<a name='198'>
                                                        V1D, &amp;<a name='199'>
                                                        T1D, &amp;<a name='200'>
                                                       DZ1D, &amp;<a name='201'>
                                                       QV1D, &amp;<a name='202'>
                                                        P1D, &amp;<a name='203'>
                                                      RHO1D, &amp;<a name='204'>
                                                  tpart_v1D, &amp;<a name='205'>
                                                  tpart_h1D, &amp;<a name='206'>
                                                    W0AVG1D<a name='207'>
<a name='208'>
   REAL, DIMENSION( kts:kte )::                              &amp;<a name='209'>
                                                       DQDT, &amp;<a name='210'>
                                                      DQIDT, &amp;<a name='211'>
                                                      DQCDT, &amp;<a name='212'>
                                                      DQRDT, &amp;<a name='213'>
                                                      DQSDT, &amp;<a name='214'>
                                                       DTDT<a name='215'>
<a name='216'>
<a name='217'>
  REAL, DIMENSION (its-1:ite+1,kts:kte,jts-1:jte+1) ::  aveh_t, aveh_q<a name='218'>
  REAL, DIMENSION (its:ite,kts:kte,jts:jte) :: aveh_qmax, aveh_qmin<a name='219'>
  REAL, DIMENSION (its:ite,kts:kte,jts:jte) ::  avev_t, avev_q <a name='220'>
  REAL, DIMENSION (its:ite,kts:kte,jts:jte) :: avev_qmax, avev_qmin<a name='221'>
  REAL, DIMENSION (its:ite,kts:kte,jts:jte) ::  coef_v, coef_h, tpart_h, tpart_v<a name='222'>
  INTEGER :: ii,jj,kk<a name='223'>
<a name='224'>
  REAL :: ttop<a name='225'>
  REAL, DIMENSION (kts:kte)  :: z0<a name='226'>
<a name='227'>
   REAL    ::         TST,tv,PRS,RHOE,W0,SCR1,DXSQ,tmp<a name='228'>
   integer :: ibegh,iendh,jbegh,jendh<a name='229'>
   integer :: istart,iend,jstart,jend<a name='230'>
   INTEGER :: i,j,k,NTST<a name='231'>
   REAL    :: lastdt = -1.0<a name='232'>
   REAL    :: W0AVGfctr, W0fctr, W0den<a name='233'>
   <a name='234'>
<font color=#447700>!<a name='235'></font>
   DXSQ=DX*DX<a name='236'>
<a name='237'>
<font color=#447700>!----------------------<a name='238'></font>
   NTST=STEPCU<a name='239'>
   TST=float(NTST*2)<a name='240'>
   flag_qr = .FALSE.<a name='241'>
   flag_qi = .FALSE.<a name='242'>
   flag_qs = .FALSE.<a name='243'>
   IF ( PRESENT(F_QR) ) flag_qr = F_QR<a name='244'>
   IF ( PRESENT(F_QI) ) flag_qi = F_QI<a name='245'>
   IF ( PRESENT(F_QS) ) flag_qs = F_QS<a name='246'>
<font color=#447700>!<a name='247'></font>
   if (lastdt &lt; 0) then<a name='248'>
      lastdt = dt<a name='249'>
   endif<a name='250'>
   <a name='251'>
   if (ADAPT_STEP_FLAG) then<a name='252'>
      W0AVGfctr = 2 * MAX(CUDT*60,dt) - dt<a name='253'>
      W0fctr = dt<a name='254'>
      W0den = 2 * MAX(CUDT*60,dt)<a name='255'>
   else<a name='256'>
      W0AVGfctr = (TST-1.)<a name='257'>
      W0fctr = 1.<a name='258'>
      W0den = TST<a name='259'>
   endif<a name='260'>
<a name='261'>
  DO J = jts,jte<a name='262'>
      DO K=kts,kte<a name='263'>
         DO I= its,ite<a name='264'>
<font color=#447700>!            SCR1=-5.0E-4*G*rho(I,K,J)*(w(I,K,J)+w(I,K+1,J))<a name='265'></font>
<font color=#447700>!            TV=T(I,K,J)*(1.+EP1*QV(I,K,J))<a name='266'></font>
<font color=#447700>!            RHOE=Pcps(I,K,J)/(R*TV)<a name='267'></font>
<font color=#447700>!            W0=-101.9368*SCR1/RHOE<a name='268'></font>
            W0=0.5*(w(I,K,J)+w(I,K+1,J))<a name='269'>
<a name='270'>
<font color=#447700>!           Old:            <a name='271'></font>
<font color=#447700>!<a name='272'></font>
<font color=#447700>!            W0AVG(I,K,J)=(W0AVG(I,K,J)*(TST-1.)+W0)/TST            <a name='273'></font>
<font color=#447700>!<a name='274'></font>
<font color=#447700>!           New, to support adaptive time step:<a name='275'></font>
<font color=#447700>!<a name='276'></font>
            W0AVG(I,K,J) = ( W0AVG(I,K,J) * W0AVGfctr + W0 * W0fctr ) / W0den<a name='277'>
<font color=#447700>!ckaywup<a name='278'></font>
<font color=#447700>!           w(I,K,J)=w(I,K,J)+w_up(i,K,j)  <a name='279'></font>
<a name='280'>
         ENDDO<a name='281'>
      ENDDO<a name='282'>
   ENDDO<a name='283'>
<a name='284'>
<a name='285'>
   lastdt = dt<a name='286'>
<a name='287'>
<font color=#447700>! New trigger function<a name='288'></font>
     IF (trigger.eq.2) THEN         <a name='289'>
<font color=#447700>!<a name='290'></font>
<font color=#447700>! calculate 9-point average of moisture advection and temperature using halo (Horizontal)<a name='291'></font>
<font color=#447700>!<a name='292'></font>
     aveh_t=-999   <font color=#447700>! horizontal 9-point ave<a name='293'></font>
     aveh_q=-999<a name='294'>
     avev_t=0   <font color=#447700>! vertical 3-level ave<a name='295'></font>
     avev_q=0<a name='296'>
     avev_qmax=0<a name='297'>
     avev_qmin=0<a name='298'>
     aveh_qmax=0<a name='299'>
     aveh_qmin=0<a name='300'>
     tpart_h=0<a name='301'>
     tpart_v=0<a name='302'>
     coef_h=0<a name='303'>
     coef_v=0<a name='304'>
     ibegh=max(its-1, ids+1)   <font color=#447700>! start from 2<a name='305'></font>
     jbegh=max(jts-1, jds+1)<a name='306'>
     iendh=min(ite+1, ide-2)   <font color=#447700>! end at ide-2<a name='307'></font>
     jendh=min(jte+1, jde-2)<a name='308'>
        DO J = jbegh,jendh<a name='309'>
        DO K = kts,kte<a name='310'>
        DO I = ibegh,iendh<a name='311'>
          aveh_t(i,k,j)=(T(i-1,k,j-1)+T(i-1,k,j)  +T(i-1,k,j+1)+ &amp;<a name='312'>
                         T(i,k,j-1)   +T(i,k,j)   +T(i,k,j+1)+         &amp;<a name='313'>
                         T(i+1,k,j-1) +T(i+1,k,j) +T(i+1,k,j+1))/9.<a name='314'>
          aveh_q(i,k,j)=(rqvften(i-1,k,j-1)+rqvften(i-1,k,j)  +rqvften(i-1,k,j+1)+ &amp;<a name='315'>
                         rqvften(i,k,j-1)   +rqvften(i,k,j)   +rqvften(i,k,j+1)+         &amp;<a name='316'>
                         rqvften(i+1,k,j-1) +rqvften(i+1,k,j) +rqvften(i+1,k,j+1))/9.<a name='317'>
        ENDDO<a name='318'>
        ENDDO<a name='319'>
        ENDDO<a name='320'>
<font color=#447700>! boundary value ( all processors will do the following? Or just those processsors handling sub-area including boundary)<a name='321'></font>
        DO K = kts,kte<a name='322'>
           DO J = jts-1,jte+1<a name='323'>
            DO I = its-1,ite+1<a name='324'>
<a name='325'>
            if(i.eq.ids) then<a name='326'>
            aveh_t(i,k,j)=aveh_t(i+1,k,j)<a name='327'>
            aveh_q(i,k,j)=aveh_q(i+1,k,j)<a name='328'>
            elseif(i.eq.ide-1) then<a name='329'>
            aveh_t(i,k,j)=aveh_t(i-1,k,j)<a name='330'>
            aveh_q(i,k,j)=aveh_q(i-1,k,j)<a name='331'>
            endif<a name='332'>
<a name='333'>
            if(j.eq.jds) then<a name='334'>
             aveh_t(i,k,j)=aveh_t(i,k,j+1)<a name='335'>
             aveh_q(i,k,j)=aveh_q(i,k,j+1)<a name='336'>
            elseif(j.eq.jde-1) then<a name='337'>
            aveh_t(i,k,j)=aveh_t(i,k,j-1)<a name='338'>
            aveh_q(i,k,j)=aveh_q(i,k,j-1)<a name='339'>
            endif<a name='340'>
<a name='341'>
            if(j.eq.jds.and.i.eq.ids) then<a name='342'>
            aveh_q(i,k,j)=aveh_q(i+1,k,j+1) <a name='343'>
            aveh_t(i,k,j)=aveh_t(i+1,k,j+1) <a name='344'>
            endif<a name='345'>
<a name='346'>
            if(j.eq.jde-1.and.i.eq.ids) then<a name='347'>
            aveh_q(i,k,j)=aveh_q(i+1,k,j-1) <a name='348'>
            aveh_t(i,k,j)=aveh_t(i+1,k,j-1) <a name='349'>
            endif<a name='350'>
<a name='351'>
            if(j.eq.jde-1.and.i.eq.ide-1) then<a name='352'>
            aveh_q(i,k,j)=aveh_q(i-1,k,j-1) <a name='353'>
            aveh_t(i,k,j)=aveh_t(i-1,k,j-1) <a name='354'>
            endif<a name='355'>
<a name='356'>
            if(j.eq.jds.and.i.eq.ide-1) then<a name='357'>
            aveh_q(i,k,j)=aveh_q(i-1,k,j+1) <a name='358'>
            aveh_t(i,k,j)=aveh_t(i-1,k,j+1) <a name='359'>
            endif<a name='360'>
<a name='361'>
            ENDDO<a name='362'>
           ENDDO<a name='363'>
        ENDDO<a name='364'>
<font color=#447700>! search for max/min moisture advection in 9-point range, calculate horizontal T-perturbation (tpart_h)<a name='365'></font>
     istart=max(its, ids+1)   <font color=#447700>! start from 2<a name='366'></font>
     jstart=max(jts, jds+1)<a name='367'>
     iend=min(ite, ide-2)   <font color=#447700>! end at ide-2<a name='368'></font>
     jend=min(jte, jde-2)<a name='369'>
        DO K = kts,kte<a name='370'>
        DO J = jstart,jend<a name='371'>
        DO I = istart,iend<a name='372'>
           aveh_qmax(i,k,j)=aveh_q(i,k,j)<a name='373'>
           aveh_qmin(i,k,j)=aveh_q(i,k,j)<a name='374'>
          DO ii=-1, 1<a name='375'>
           DO jj=-1,1<a name='376'>
             if(aveh_q(i+II,k,j+JJ).gt.aveh_qmax(i,k,j)) aveh_qmax(i,k,j)=aveh_q(i+II,k,j+JJ)<a name='377'>
             if(aveh_q(i+II,k,j+JJ).lt.aveh_qmin(i,k,j)) aveh_qmin(i,k,j)=aveh_q(i+II,k,j+JJ)<a name='378'>
           ENDDO<a name='379'>
          ENDDO <a name='380'>
          if(aveh_qmax(i,k,j).gt.aveh_qmin(i,k,j))then<a name='381'>
          coef_h(i,k,j)=(aveh_q(i,k,j)-aveh_qmin(i,k,j))/(aveh_qmax(i,k,j)-aveh_qmin(i,k,j))<a name='382'>
          else<a name='383'>
          coef_h(i,k,j)=0.<a name='384'>
          endif<a name='385'>
          coef_h(i,k,j)=amin1(coef_h(i,k,j),1.0)<a name='386'>
          coef_h(i,k,j)=amax1(coef_h(i,k,j),0.0)<a name='387'>
          tpart_h(i,k,j)=coef_h(i,k,j)*(T(i,k,j)-aveh_t(i,k,j))<a name='388'>
        ENDDO<a name='389'>
        ENDDO<a name='390'>
        ENDDO<a name='391'>
    89 continue <a name='392'>
<font color=#447700>! vertical 3-layer calculation<a name='393'></font>
        DO J = jts, jte<a name='394'>
        DO I = its, ite<a name='395'>
          z0(1) = 0.5 * dz8w(i,1,j)<a name='396'>
          DO K = 2, kte<a name='397'>
            Z0(K) = Z0(K-1) + .5 * (DZ8W(i,K,j) + DZ8W(i,K-1,j))<a name='398'>
          ENDDO<a name='399'>
        DO K = kts+1,kte-1<a name='400'>
	  ttop = t(i,k,j) + ((t(i,k,j) - t(i,k+1,j)) / (z0(k) - z0(k+1))) * (z0(k)-z0(k-1))<a name='401'>
          avev_t(i,k,j)=(T(i,k-1,j) + T(i,k,j) + ttop)/3.<a name='402'>
<font color=#447700>!         avev_t(i,k,j)=(T(i,k-1,j)+T(i,k,j) + T(i,k+1,j))/3.<a name='403'></font>
          avev_q(i,k,j)=(rqvften(i,k-1,j)+rqvften(i,k,j) + rqvften(i,k+1,j))/3.<a name='404'>
        ENDDO<a name='405'>
          avev_t(i,kts,j)=avev_t(i,kts+1,j)   <font color=#447700>! lowest level value, is it the same as avev_t(i,kds,j)=avev_t(i,kds+1,j)?<a name='406'></font>
          avev_q(i,kts,j)=avev_q(i,kts+1,j)   <a name='407'>
          avev_t(i,kte,j)=avev_t(i,kte-1,j)   <font color=#447700>! highest level value<a name='408'></font>
          avev_q(i,kte,j)=avev_q(i,kte-1,j)   <a name='409'>
        ENDDO<a name='410'>
        ENDDO<a name='411'>
<font color=#447700>! max /min value<a name='412'></font>
        DO J = jts, jte<a name='413'>
        DO I = its, ite<a name='414'>
        DO K = kts+1,kte-1<a name='415'>
          avev_qmax(i,k,j)=avev_q(i,k,j)<a name='416'>
          avev_qmin(i,k,j)=avev_q(i,k,j)<a name='417'>
         DO kk=-1,1<a name='418'>
         if(avev_q(i,k+kk,j).gt.avev_qmax(i,k,j)) avev_qmax(i,k,j)=avev_q(i,k+kk,j) <a name='419'>
         if(avev_q(i,k+kk,j).lt.avev_qmin(i,k,j)) avev_qmin(i,k,j)=avev_q(i,k+kk,j) <a name='420'>
         ENDDO<a name='421'>
         if(avev_qmax(i,k,j).gt.avev_qmin(i,k,j)) then<a name='422'>
         coef_v(i,k,j)=(avev_q(i,k,j)-avev_qmin(i,k,j))/(avev_qmax(i,k,j)-avev_qmin(i,k,j))<a name='423'>
         else<a name='424'>
         coef_v(i,k,j)=0<a name='425'>
         endif<a name='426'>
         tpart_v(i,k,j)=coef_v(i,k,j)*(T(i,k,j)-avev_t(i,k,j))<a name='427'>
        ENDDO<a name='428'>
         tpart_v(i,kts,j)= tpart_v(i,kts+1,j)    <font color=#447700>! lowest level<a name='429'></font>
         tpart_v(i,kte,j)= tpart_v(i,kte-1,j)    <font color=#447700>! highest level<a name='430'></font>
        ENDDO<a name='431'>
        ENDDO<a name='432'>
     ENDIF       <font color=#447700>! endif (trigger.eq.2)          <a name='433'></font>
<font color=#447700>!<a name='434'></font>
     DO J = jts,jte<a name='435'>
     DO I= its,ite<a name='436'>
        CU_ACT_FLAG(i,j) = .true.<a name='437'>
     ENDDO<a name='438'>
     ENDDO<a name='439'>
<a name='440'>
     DO J = jts,jte<a name='441'>
       DO I=its,ite<a name='442'>
          <a name='443'>
<a name='444'>
         IF ( NCA(I,J) .ge. 0.5*DT ) then<a name='445'>
            CU_ACT_FLAG(i,j) = .false.<a name='446'>
         ELSE<a name='447'>
<a name='448'>
            DO k=kts,kte<a name='449'>
               DQDT(k)=0.<a name='450'>
               DQIDT(k)=0.<a name='451'>
               DQCDT(k)=0.<a name='452'>
               DQRDT(k)=0.<a name='453'>
               DQSDT(k)=0.<a name='454'>
               DTDT(k)=0.<a name='455'>
<font color=#447700>!ckay<a name='456'></font>
               cldfra_dp_KF(I,k,J)=0.<a name='457'>
               cldfra_sh_KF(I,k,J)=0.<a name='458'>
               qc_KF(I,k,J)=0.<a name='459'>
               qi_KF(I,k,J)=0.<a name='460'>
               w_up(I,k,J)=0.<a name='461'>
            ENDDO<a name='462'>
            IF (KF_EDRATES == 1) THEN<a name='463'>
               DO k=kts,kte<a name='464'>
                  UDR_KF(I,k,J)=0.<a name='465'>
                  DDR_KF(I,k,J)=0.<a name='466'>
                  UER_KF(I,k,J)=0.<a name='467'>
                  DER_KF(I,k,J)=0.<a name='468'>
               ENDDO<a name='469'>
               TIMEC_KF(I,J)=0.<a name='470'>
            ENDIF<a name='471'>
            RAINCV(I,J)=0.<a name='472'>
            CUTOP(I,J)=KTS<a name='473'>
            CUBOT(I,J)=KTE+1<a name='474'>
            PRATEC(I,J)=0.<a name='475'>
<font color=#447700>!<a name='476'></font>
<font color=#447700>! assign vars from 3D to 1D<a name='477'></font>
<a name='478'>
            DO K=kts,kte<a name='479'>
               U1D(K) =U(I,K,J)<a name='480'>
               V1D(K) =V(I,K,J)<a name='481'>
               T1D(K) =T(I,K,J)<a name='482'>
               RHO1D(K) =rho(I,K,J)<a name='483'>
               QV1D(K)=QV(I,K,J)<a name='484'>
               P1D(K) =Pcps(I,K,J)<a name='485'>
               W0AVG1D(K) =W0AVG(I,K,J)<a name='486'>
               DZ1D(k)=dz8w(I,K,J)<a name='487'>
<a name='488'>
               IF (trigger.eq.2) THEN<a name='489'>
                  tpart_h1D(K) =tpart_h(I,K,J)<a name='490'>
                  tpart_v1D(K) =tpart_v(I,K,J)<a name='491'>
               ELSE<a name='492'>
                  tpart_h1D(K) = 0.<a name='493'>
                  tpart_v1D(K) = 0.<a name='494'>
               ENDIF<a name='495'>
            ENDDO<a name='496'>
            CALL <A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA'>KF_eta_PARA</A><A href='../../html_code/phys/module_cu_mskf.F.html#MSKF_CPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KF_ETA_PARA_1">(I, J,                  &amp;<a name='497'>
                 U1D,V1D,T1D,QV1D,P1D,DZ1D,W0AVG1D, &amp;<a name='498'>
                 tpart_h1D,tpart_v1D,               &amp;<a name='499'>
                 trigger,                           &amp;<a name='500'>
                 DT,DX,DXSQ,RHO1D,                  &amp;<a name='501'>
                 XLV0,XLV1,XLS0,XLS1,CP,R,G,        &amp;<a name='502'>
                 EP2,SVP1,SVP2,SVP3,SVPT0,          &amp;<a name='503'>
                 DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT, &amp;<a name='504'>
                 RAINCV,PRATEC,NCA,                 &amp;<a name='505'>
                 flag_QI,flag_QS,warm_rain,         &amp;<a name='506'>
                 CUTOP,CUBOT,CUDT,                  &amp;<a name='507'>
                 ids,ide, jds,jde, kds,kde,         &amp;<a name='508'>
                 ims,ime, jms,jme, kms,kme,         &amp;<a name='509'>
                 its,ite, jts,jte, kts,kte,         &amp;<a name='510'>
<font color=#447700>!ckay<a name='511'></font>
                 cldfra_dp_KF,cldfra_sh_KF,w_up,    &amp;<a name='512'>
                 qc_KF,qi_KF,                       &amp;<a name='513'>
<font color=#447700>!kf_edrates<a name='514'></font>
                 UDR_KF,DDR_KF,                     &amp;<a name='515'>
                 UER_KF,DER_KF,                     &amp;<a name='516'>
                 TIMEC_KF,KF_EDRATES,               &amp;                 <a name='517'>
                 ZOL,WSTAR,UST,PBLH                 )<a name='518'>
<a name='519'>
            IF(PRESENT(rthcuten).AND.PRESENT(rqvcuten)) THEN<a name='520'>
              DO K=kts,kte<a name='521'>
                 RTHCUTEN(I,K,J)=DTDT(K)/pi(I,K,J)<a name='522'>
                 RQVCUTEN(I,K,J)=DQDT(K)<a name='523'>
              ENDDO<a name='524'>
            ENDIF<a name='525'>
<a name='526'>
            IF(PRESENT(rqrcuten).AND.PRESENT(rqccuten)) THEN<a name='527'>
              IF( F_QR )THEN<a name='528'>
                DO K=kts,kte<a name='529'>
                   RQRCUTEN(I,K,J)=DQRDT(K)<a name='530'>
                   RQCCUTEN(I,K,J)=DQCDT(K)<a name='531'>
                ENDDO<a name='532'>
              ELSE<a name='533'>
<font color=#447700>! This is the case for Eta microphysics without 3d rain field<a name='534'></font>
                DO K=kts,kte<a name='535'>
                   RQRCUTEN(I,K,J)=0.<a name='536'>
                   RQCCUTEN(I,K,J)=DQRDT(K)+DQCDT(K)<a name='537'>
                ENDDO<a name='538'>
              ENDIF<a name='539'>
            ENDIF<a name='540'>
<a name='541'>
<font color=#447700>!......     QSTEN STORES GRAUPEL TENDENCY IF IT EXISTS, OTHERISE SNOW (V2)<a name='542'></font>
<a name='543'>
<a name='544'>
            IF(PRESENT( rqicuten )) THEN<a name='545'>
              IF ( F_QI ) THEN<a name='546'>
                DO K=kts,kte<a name='547'>
                   RQICUTEN(I,K,J)=DQIDT(K)<a name='548'>
                ENDDO<a name='549'>
              ENDIF<a name='550'>
            ENDIF<a name='551'>
<a name='552'>
            IF(PRESENT( rqscuten )) THEN<a name='553'>
              IF ( F_QS ) THEN<a name='554'>
                DO K=kts,kte<a name='555'>
                   RQSCUTEN(I,K,J)=DQSDT(K)<a name='556'>
                ENDDO<a name='557'>
              ENDIF<a name='558'>
            ENDIF<a name='559'>
<font color=#447700>!<a name='560'></font>
         ENDIF <a name='561'>
       ENDDO     <font color=#447700>! i-loop<a name='562'></font>
     ENDDO       <font color=#447700>! j-loop<a name='563'></font>
<font color=#447700>!<a name='564'></font>
   END SUBROUTINE MSKF_CPS<a name='565'>
<font color=#447700>! ****************************************************************************<a name='566'></font>
<font color=#447700>!-----------------------------------------------------------<a name='567'></font>
<A NAME='KF_ETA_PARA'><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='568'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>KF_eta_PARA</font> (I, J,                           &amp; <A href='../../call_to/KF_ETA_PARA.html' TARGET='index'>1</A>,<A href='../../call_from/KF_ETA_PARA.html' TARGET='index'>34</A><a name='569'>
                      U0,V0,T0,QV0,P0,DZQ,W0AVG1D,         &amp;<a name='570'>
                      TPART_H0,TPART_V0,                   &amp;<a name='571'>
                      trigger,                             &amp;<a name='572'>
                      DT,DX,DXSQ,rhoe,                     &amp;<a name='573'>
                      XLV0,XLV1,XLS0,XLS1,CP,R,G,          &amp;<a name='574'>
                      EP2,SVP1,SVP2,SVP3,SVPT0,            &amp;<a name='575'>
                      DQDT,DQIDT,DQCDT,DQRDT,DQSDT,DTDT,   &amp;<a name='576'>
                      RAINCV,PRATEC,NCA,                   &amp;<a name='577'>
                      F_QI,F_QS,warm_rain,                 &amp;<a name='578'>
                      CUTOP,CUBOT,CUDT,                    &amp;<a name='579'>
                      ids,ide, jds,jde, kds,kde,           &amp;<a name='580'>
                      ims,ime, jms,jme, kms,kme,           &amp;<a name='581'>
                      its,ite, jts,jte, kts,kte,           &amp;<a name='582'>
<font color=#447700>!ckay<a name='583'></font>
                      cldfra_dp_KF,cldfra_sh_KF,w_up,      &amp;<a name='584'>
                      qc_KF,qi_KF,                         &amp;<a name='585'>
<font color=#447700>!kf_edrates<a name='586'></font>
                      UDR_KF,DDR_KF,                       &amp;<a name='587'>
                      UER_KF,DER_KF,                       &amp;<a name='588'>
                      TIMEC_KF,KF_EDRATES,                 &amp;<a name='589'>
                      ZOL,WSTAR,UST,PBLH                   )<a name='590'>
<font color=#447700>!-----------------------------------------------------------<a name='591'></font>
<font color=#447700>!***** The KF scheme that is currently used in experimental runs of EMCs <a name='592'></font>
<font color=#447700>!***** Eta model....jsk 8/00<a name='593'></font>
<font color=#447700>!<a name='594'></font>
      IMPLICIT NONE<a name='595'>
<font color=#447700>!-----------------------------------------------------------<a name='596'></font>
      INTEGER, INTENT(IN   ) :: ids,ide, jds,jde, kds,kde, &amp;<a name='597'>
                                ims,ime, jms,jme, kms,kme, &amp;<a name='598'>
                                its,ite, jts,jte, kts,kte, &amp;<a name='599'>
                                I,J<a name='600'>
          <font color=#447700>! ,P_QI,P_QS,P_FIRST_SCALAR<a name='601'></font>
      INTEGER, INTENT(IN   ) ::  trigger<a name='602'>
<a name='603'>
      LOGICAL, INTENT(IN   ) :: F_QI, F_QS<a name='604'>
<a name='605'>
      LOGICAL, INTENT(IN   ) :: warm_rain<a name='606'>
<font color=#447700>!<a name='607'></font>
      REAL, DIMENSION( kts:kte ),                          &amp;<a name='608'>
            INTENT(IN   ) ::                           U0, &amp;<a name='609'>
                                                       V0, &amp;<a name='610'>
                                                 TPART_H0, &amp;<a name='611'>
                                                 TPART_V0, &amp;<a name='612'>
                                                       T0, &amp;<a name='613'>
                                                      QV0, &amp;<a name='614'>
                                                       P0, &amp;<a name='615'>
                                                     rhoe, &amp;<a name='616'>
                                                      DZQ, &amp;<a name='617'>
                                                  W0AVG1D<a name='618'>
<font color=#447700>!<a name='619'></font>
      REAL,  INTENT(IN   ) :: DT,DX,DXSQ<a name='620'>
<font color=#447700>!<a name='621'></font>
<a name='622'>
      REAL,  INTENT(IN   ) :: XLV0,XLV1,XLS0,XLS1,CP,R,G<a name='623'>
      REAL,  INTENT(IN   ) :: EP2,SVP1,SVP2,SVP3,SVPT0<a name='624'>
<a name='625'>
<font color=#447700>!ckay<a name='626'></font>
      REAL, DIMENSION( ims:ime, jms:jme ),                 &amp;<a name='627'>
            INTENT(   IN) ::                          ZOL, &amp;<a name='628'>
                                                    WSTAR, &amp;<a name='629'>
                                                      UST, &amp;<a name='630'>
                                                     PBLH<a name='631'>
<font color=#447700>!<a name='632'></font>
      REAL, DIMENSION( kts:kte ), INTENT(INOUT) ::         &amp;<a name='633'>
                                                     DQDT, &amp;<a name='634'>
                                                    DQIDT, &amp;<a name='635'>
                                                    DQCDT, &amp;<a name='636'>
                                                    DQRDT, &amp;<a name='637'>
                                                    DQSDT, &amp;<a name='638'>
                                                     DTDT<a name='639'>
<a name='640'>
      REAL,    DIMENSION( ims:ime , jms:jme ),             &amp;<a name='641'>
            INTENT(INOUT) ::                          NCA<a name='642'>
<a name='643'>
<font color=#447700>!ckay<a name='644'></font>
      REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),      &amp;<a name='645'>
            INTENT(INOUT) ::                 cldfra_dp_KF, &amp;<a name='646'>
                                             cldfra_sh_KF, &amp;<a name='647'>
                                                    qc_KF, &amp;<a name='648'>
                                                    qi_KF<a name='649'>
<font color=#447700>!kf_edrates<a name='650'></font>
      REAL, DIMENSION( ims:ime , kms:kme , jms:jme ),      &amp;<a name='651'>
            INTENT(INOUT) ::       UDR_KF,       &amp;<a name='652'>
                                             DDR_KF,       &amp;<a name='653'>
                                             UER_KF,       &amp;<a name='654'>
                                             DER_KF<a name='655'>
<a name='656'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='657'>
            INTENT(INOUT) ::     TIMEC_KF<a name='658'>
<a name='659'>
      INTEGER, INTENT(IN) ::         KF_EDRATES<a name='660'>
<a name='661'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='662'>
            INTENT(INOUT) ::                       RAINCV<a name='663'>
<a name='664'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='665'>
            INTENT(INOUT) ::                       PRATEC<a name='666'>
<a name='667'>
      REAL, DIMENSION( ims:ime , jms:jme ),                &amp;<a name='668'>
            INTENT(OUT) ::                          CUBOT, &amp;<a name='669'>
                                                    CUTOP<a name='670'>
      REAL,  INTENT(IN   ) :: CUDT<a name='671'>
<a name='672'>
<font color=#447700>!ckaywup<a name='673'></font>
  REAL, DIMENSION( ims:ime,  kms:kme , jms:jme )         , &amp;<a name='674'>
        INTENT(  OUT) ::                             w_up                       <a name='675'>
<font color=#447700>!<a name='676'></font>
<font color=#447700>!...DEFINE LOCAL VARIABLES...<a name='677'></font>
<font color=#447700>!<a name='678'></font>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='679'>
            Q0,Z0,TV0,TU,TVU,QU,TZ,TVD,                    &amp;<a name='680'>
            QD,QES,THTES,TG,TVG,QG,WU,WD,W0,EMS,EMSD,      &amp;<a name='681'>
            UMF,UER,UDR,DMF,DER,DDR,UMF2,UER2,             &amp;<a name='682'>
            UDR2,DMF2,DER2,DDR2,DZA,THTA0,THETEE,          &amp;<a name='683'>
            THTAU,THETEU,THTAD,THETED,QLIQ,QICE,           &amp;<a name='684'>
            QLQOUT,QICOUT,PPTLIQ,PPTICE,DETLQ,DETIC,       &amp;<a name='685'>
            DETLQ2,DETIC2,RATIO,RATIO2<a name='686'>
<a name='687'>
<a name='688'>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='689'>
            DOMGDP,EXN,TVQU,DP,RH,EQFRC,WSPD,              &amp;<a name='690'>
            QDT,FXM,THTAG,THPA,THFXOUT,                    &amp;<a name='691'>
            THFXIN,QPA,QFXOUT,QFXIN,QLPA,QLFXIN,           &amp;<a name='692'>
            QLFXOUT,QIPA,QIFXIN,QIFXOUT,QRPA,              &amp;<a name='693'>
            QRFXIN,QRFXOUT,QSPA,QSFXIN,QSFXOUT,            &amp;<a name='694'>
            QL0,QLG,QI0,QIG,QR0,QRG,QS0,QSG<a name='695'>
<a name='696'>
<a name='697'>
      REAL, DIMENSION( kts:kte+1 ) :: OMG<a name='698'>
      REAL, DIMENSION( kts:kte ) :: RAINFB,SNOWFB<a name='699'>
      REAL, DIMENSION( kts:kte ) ::                        &amp;<a name='700'>
            CLDHGT,QSD,DILFRC,DDILFRC,TKE,TGU,QGU,THTEEG<a name='701'>
<a name='702'>
<font color=#447700>! LOCAL VARS<a name='703'></font>
<a name='704'>
      REAL    :: P00,T00,RLF,RHIC,RHBC,PIE,         &amp;<a name='705'>
                 TTFRZ,TBFRZ,C5,RATE<a name='706'>
      REAL    :: GDRY,ROCP,ALIQ,BLIQ,                      &amp;<a name='707'>
                 CLIQ,DLIQ<a name='708'>
      REAL    :: FBFRC,P300,DPTHMX,THMIX,QMIX,ZMIX,PMIX,   &amp;<a name='709'>
                 ROCPQ,TMIX,EMIX,TLOG,TDPT,TLCL,TVLCL,     &amp;<a name='710'>
                 CPORQ,PLCL,ES,DLP,TENV,QENV,TVEN,TVBAR,   &amp;<a name='711'>
                 ZLCL,WKL,WABS,TRPPT,WSIGNE,DTLCL,GDT,WLCL,&amp;<a name='712'>
                 TVAVG,QESE,WTW,RHOLCL,AU0,VMFLCL,UPOLD,   &amp;<a name='713'>
                 UPNEW,ABE,WKLCL,TTEMP,FRC1,   &amp;<a name='714'>
                 QNEWIC,RL,R1,QNWFRZ,EFFQ,BE,BOTERM,ENTERM,&amp;<a name='715'>
                 DZZ,UDLBE,REI,EE2,UD2,TTMP,F1,F2,         &amp;<a name='716'>
                 THTTMP,QTMP,TMPLIQ,TMPICE,TU95,TU10,EE1,  &amp;<a name='717'>
                 UD1,DPTT,QNEWLQ,DUMFDP,EE,TSAT,           &amp;<a name='718'>
                 THTA,VCONV,TIMEC,SHSIGN,VWS,PEF, &amp;<a name='719'>
                 CBH,RCBH,PEFCBH,PEFF,PEFF2,TDER,THTMIN,   &amp;<a name='720'>
                 DTMLTD,QS,TADVEC,DPDD,FRC,DPT,RDD,A1,     &amp;<a name='721'>
                 DSSDT,DTMP,T1RH,QSRH,PPTFLX,CPR,CNDTNF,   &amp;<a name='722'>
                 UPDINC,AINCM2,DEVDMF,PPR,RCED,DPPTDF,     &amp;<a name='723'>
                 DMFLFS,DMFLFS2,RCED2,DDINC,AINCMX,AINCM1, &amp;<a name='724'>
                 AINC,TDER2,PPTFL2,FABE,STAB,DTT,DTT1,     &amp;<a name='725'>
                 DTIME,TMA,TMB,TMM,BCOEFF,ACOEFF,QVDIFF,   &amp;<a name='726'>
                 TOPOMG,CPM,DQ,ABEG,DABE,DFDA,FRC2,DR,     &amp;<a name='727'>
                 UDFRC,TUC,QGS,RH0,RHG,QINIT,QFNL,ERR2,    &amp;<a name='728'>
                 RELERR,RLC,RLS,RNC,FABEOLD,AINCOLD,UEFRC, &amp;<a name='729'>
                 DDFRC,TDC,DEFRC,RHBAR,DMFFRC,DPMIN,DILBE<a name='730'>
   REAL    ::    ASTRT,TP,VALUE,AINTRP,TKEMAX,QFRZ,&amp;<a name='731'>
                 QSS,PPTMLT,DTMELT,RHH,EVAC,BINC<a name='732'>
<font color=#447700>!<a name='733'></font>
      INTEGER :: INDLU,NU,NUCHM,NNN,KLFS<a name='734'>
   REAL    :: CHMIN,PM15,CHMAX,DTRH,RAD,DPPP<a name='735'>
   REAL    :: TVDIFF,DTTOT,ABSOMG,ABSOMGTC,FRDP<a name='736'>
<font color=#447700>!ckay<a name='737'></font>
   REAL    :: xcldfra,UMF_new,DMF_new,FXM_new<a name='738'>
   REAL    :: sourceht, Scale_Fac, TOKIOKA, RATE_kay<a name='739'>
   REAL    :: capeDX, tempKay<a name='740'>
   REAL    :: SCLvel, ZLCL_KAY, zz_kay<a name='741'>
<a name='742'>
<font color=#447700>!ckaywup<a name='743'></font>
   REAL    :: envEsat, envQsat, envRH, envRHavg, denSplume<a name='744'>
   REAL    :: updil, Drag<a name='745'>
<a name='746'>
      INTEGER :: KX,K,KL<a name='747'>
<font color=#447700>!<a name='748'></font>
      INTEGER :: NCHECK<a name='749'>
      INTEGER, DIMENSION (kts:kte) :: KCHECK<a name='750'>
<a name='751'>
      INTEGER :: ISTOP,ML,L5,KMIX,LOW,                     &amp;<a name='752'>
                 LC,MXLAYR,LLFC,NLAYRS,NK,                 &amp;<a name='753'>
                 KPBL,KLCL,LCL,LET,IFLAG,                  &amp;<a name='754'>
                 NK1,LTOP,NJ,LTOP1,                        &amp;<a name='755'>
                 LTOPM1,LVF,KSTART,KMIN,LFS,               &amp;<a name='756'>
                 ND,NIC,LDB,LDT,ND1,NDK,                   &amp;<a name='757'>
                 NM,LMAX,NCOUNT,NOITR,                     &amp;<a name='758'>
                 NSTEP,NTC,NCHM,ISHALL,NSHALL<a name='759'>
      LOGICAL :: IPRNT<a name='760'>
      REAL :: u00,qslcl,rhlcl,dqssdt    <font color=#447700>!jfb<a name='761'></font>
      CHARACTER*1024 message<a name='762'>
<font color=#447700>!<a name='763'></font>
      DATA P00,T00/1.E5,273.16/<a name='764'>
      DATA RLF/3.339E5/<a name='765'>
      DATA RHIC,RHBC/1.,0.90/<a name='766'>
      DATA PIE,TTFRZ,TBFRZ,C5/3.141592654,268.16,248.16,1.0723E-3/<a name='767'>
      DATA RATE/0.03/   <font color=#447700>! wrf default<a name='768'></font>
<font color=#447700>!      DATA RATE/0.01/  ! value used in NRCM<a name='769'></font>
<font color=#447700>!      DATA RATE/0.001/  ! effectively turn off autoconversion<a name='770'></font>
<font color=#447700>!-----------------------------------------------------------<a name='771'></font>
      IPRNT=.FALSE.<a name='772'>
      GDRY=-G/CP<a name='773'>
      ROCP=R/CP<a name='774'>
      NSHALL = 0<a name='775'>
      KL=kte<a name='776'>
      KX=kte<a name='777'>
<font color=#447700>!<a name='778'></font>
<font color=#447700>!     ALIQ = 613.3<a name='779'></font>
<font color=#447700>!     BLIQ = 17.502<a name='780'></font>
<font color=#447700>!     CLIQ = 4780.8<a name='781'></font>
<font color=#447700>!     DLIQ = 32.19<a name='782'></font>
      ALIQ = SVP1*1000.<a name='783'>
      BLIQ = SVP2<a name='784'>
      CLIQ = SVP2*SVPT0<a name='785'>
      DLIQ = SVP3<a name='786'>
<font color=#447700>!<a name='787'></font>
      IF(DX.GE.24.999E3) THEN<a name='788'>
         Scale_Fac = 1.0<a name='789'>
         capeDX = 0.1<a name='790'>
      ELSE<a name='791'>
         Scale_Fac = 1.0 + (log(25.E3/DX))<a name='792'>
         capeDX = 0.1 *SQRT(Scale_Fac)<a name='793'>
      END IF<a name='794'>
<font color=#447700>!<a name='795'></font>
<font color=#447700>!****************************************************************************<a name='796'></font>
<font color=#447700>!                                                      ! PPT FB MODS<a name='797'></font>
<font color=#447700>!...OPTION TO FEED CONVECTIVELY GENERATED RAINWATER    ! PPT FB MODS<a name='798'></font>
<font color=#447700>!...INTO GRID-RESOLVED RAINWATER (OR SNOW/GRAUPEL)     ! PPT FB MODS<a name='799'></font>
<font color=#447700>!...FIELD.  "FBFRC" IS THE FRACTION OF AVAILABLE       ! PPT FB MODS<a name='800'></font>
<font color=#447700>!...PRECIPITATION TO BE FED BACK (0.0 - 1.0)...        ! PPT FB MODS<a name='801'></font>
      FBFRC=0.0                                        <font color=#447700>! PPT FB MODS<a name='802'></font>
<font color=#447700>!...mods to allow shallow convection...<a name='803'></font>
      NCHM = 0<a name='804'>
      ISHALL = 0<a name='805'>
      DPMIN = 5.E3<a name='806'>
<font color=#447700>!...<a name='807'></font>
      P300=P0(1)-30000.<a name='808'>
<font color=#447700>!<a name='809'></font>
<font color=#447700>!...PRESSURE PERTURBATION TERM IS ONLY DEFINED AT MID-POINT OF<a name='810'></font>
<font color=#447700>!...VERTICAL LAYERS...SINCE TOTAL PRESSURE IS NEEDED AT THE TOP AND<a name='811'></font>
<font color=#447700>!...BOTTOM OF LAYERS BELOW, DO AN INTERPOLATION...<a name='812'></font>
<font color=#447700>!<a name='813'></font>
<font color=#447700>!...INPUT A VERTICAL SOUNDING ... NOTE THAT MODEL LAYERS ARE NUMBERED<a name='814'></font>
<font color=#447700>!...FROM BOTTOM-UP IN THE KF SCHEME...<a name='815'></font>
<font color=#447700>!<a name='816'></font>
      ML=0 <a name='817'>
<font color=#447700>!SUE  tmprpsb=1./PSB(I,J)<a name='818'></font>
<font color=#447700>!SUE  CELL=PTOP*tmprpsb<a name='819'></font>
<font color=#447700>!<a name='820'></font>
      DO K=1,KX<a name='821'>
<font color=#447700>!<a name='822'></font>
<font color=#447700>!  Saturation vapor pressure (ES) is calculated following Buck (1981)<a name='823'></font>
<font color=#447700>!...IF Q0 IS ABOVE SATURATION VALUE, REDUCE IT TO SATURATION LEVEL...<a name='824'></font>
<font color=#447700>!<a name='825'></font>
         ES=ALIQ*EXP((BLIQ*T0(K)-CLIQ)/(T0(K)-DLIQ))<a name='826'>
         QES(K)=0.622*ES/(P0(K)-ES)<a name='827'>
         Q0(K)=AMIN1(QES(K),QV0(K))<a name='828'>
         Q0(K)=AMAX1(0.000001,Q0(K))<a name='829'>
         QL0(K)=0.<a name='830'>
         QI0(K)=0.<a name='831'>
         QR0(K)=0.<a name='832'>
         QS0(K)=0.<a name='833'>
         RH(K) = Q0(K)/QES(K)<a name='834'>
         DILFRC(K) = 1.<a name='835'>
         TV0(K)=T0(K)*(1.+0.608*Q0(K))<a name='836'>
<font color=#447700>!        RHOE(K)=P0(K)/(R*TV0(K))<a name='837'></font>
<font color=#447700>!   DP IS THE PRESSURE INTERVAL BETWEEN FULL SIGMA LEVELS...<a name='838'></font>
         DP(K)=rhoe(k)*g*DZQ(k)<a name='839'>
<font color=#447700>! IF Turbulent Kinetic Energy (TKE) is available from turbulent mixing scheme<a name='840'></font>
<font color=#447700>! use it for shallow convection...For now, assume it is not available....<a name='841'></font>
<font color=#447700>!         TKE(K) = Q2(I,J,NK)<a name='842'></font>
         TKE(K) = 0.<a name='843'>
         CLDHGT(K) = 0.<a name='844'>
<font color=#447700>!        IF(P0(K).GE.500E2)L5=K<a name='845'></font>
         IF(P0(K).GE.0.5*P0(1))L5=K<a name='846'>
         IF(P0(K).GE.P300)LLFC=K<a name='847'>
      ENDDO<a name='848'>
<font color=#447700>!<a name='849'></font>
<font color=#447700>!...DZQ IS DZ BETWEEN SIGMA SURFACES, DZA IS DZ BETWEEN MODEL HALF LEVEL<a name='850'></font>
        Z0(1)=.5*DZQ(1)<a name='851'>
<font color=#447700>!cdir novector<a name='852'></font>
        DO K=2,KL<a name='853'>
          Z0(K)=Z0(K-1)+.5*(DZQ(K)+DZQ(K-1))<a name='854'>
          DZA(K-1)=Z0(K)-Z0(K-1)<a name='855'>
        ENDDO   <a name='856'>
        DZA(KL)=0.<a name='857'>
<font color=#447700>!<a name='858'></font>
<font color=#447700>!<a name='859'></font>
<font color=#447700>!  To save time, specify a pressure interval to move up in sequential<a name='860'></font>
<font color=#447700>!  check of different ~50 mb deep groups of adjacent model layers in<a name='861'></font>
<font color=#447700>!  the process of identifying updraft source layer (USL).  Note that <a name='862'></font>
<font color=#447700>!  this search is terminated as soon as a buoyant parcel is found and <a name='863'></font>
<font color=#447700>!  this parcel can produce a cloud greater than specifed minimum depth<a name='864'></font>
<font color=#447700>!  (CHMIN)...For now, set interval at 15 mb...<a name='865'></font>
<font color=#447700>!<a name='866'></font>
       NCHECK = 1<a name='867'>
       KCHECK(NCHECK)=1<a name='868'>
       PM15 = P0(1)-15.E2<a name='869'>
       DO K=2,LLFC<a name='870'>
         IF(P0(K).LT.PM15)THEN<a name='871'>
           NCHECK = NCHECK+1<a name='872'>
           KCHECK(NCHECK) = K<a name='873'>
           PM15 = PM15-15.E2<a name='874'>
         ENDIF<a name='875'>
       ENDDO<a name='876'>
<font color=#447700>!<a name='877'></font>
       NU=0<a name='878'>
       NUCHM=0<a name='879'>
usl:   DO<a name='880'>
           NU = NU+1<a name='881'>
           IF(NU.GT.NCHECK)THEN <a name='882'>
             IF(ISHALL.EQ.1)THEN<a name='883'>
               CHMAX = 0.<a name='884'>
               NCHM = 0<a name='885'>
               DO NK = 1,NCHECK<a name='886'>
                 NNN=KCHECK(NK)<a name='887'>
                 IF(CLDHGT(NNN).GT.CHMAX)THEN<a name='888'>
                   NCHM = NNN<a name='889'>
                   NUCHM = NK<a name='890'>
                   CHMAX = CLDHGT(NNN)<a name='891'>
                 ENDIF<a name='892'>
               ENDDO<a name='893'>
               NU = NUCHM-1<a name='894'>
               FBFRC=1.<a name='895'>
               CYCLE usl<a name='896'>
             ELSE<a name='897'>
               RETURN<a name='898'>
             ENDIF<a name='899'>
           ENDIF      <a name='900'>
           KMIX = KCHECK(NU)<a name='901'>
           LOW=KMIX<a name='902'>
<font color=#447700>!...<a name='903'></font>
           LC = LOW<a name='904'>
<font color=#447700>!<a name='905'></font>
<font color=#447700>!...ASSUME THAT IN ORDER TO SUPPORT A DEEP UPDRAFT YOU NEED A LAYER OF<a name='906'></font>
<font color=#447700>!...UNSTABLE AIR AT LEAST 50 mb DEEP...TO APPROXIMATE THIS, ISOLATE A<a name='907'></font>
<font color=#447700>!...GROUP OF ADJACENT INDIVIDUAL MODEL LAYERS, WITH THE BASE AT LEVEL<a name='908'></font>
<font color=#447700>!...LC, SUCH THAT THE COMBINED DEPTH OF THESE LAYERS IS AT LEAST 50 mb..<a name='909'></font>
<font color=#447700>!   <a name='910'></font>
           NLAYRS=0<a name='911'>
           DPTHMX=0.<a name='912'>
           NK=LC-1<a name='913'>
           IF ( NK+1 .LT. KTS ) THEN<a name='914'>
             WRITE(message,*)'WOULD GO OFF BOTTOM: MSKF_PARA I,J,NK',I,J,NK<a name='915'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_631"> (TRIM(message)) <a name='916'>
           ELSE<a name='917'>
             DO <a name='918'>
               NK=NK+1   <a name='919'>
               IF ( NK .GT. KTE ) THEN<a name='920'>
                 WRITE(message,*)'WOULD GO OFF TOP: MSKF_PARA I,J,DPTHMX,DPMIN',I,J,DPTHMX,DPMIN<a name='921'>
                 CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_632"> (TRIM(message))<a name='922'>
                 EXIT<a name='923'>
               ENDIF<a name='924'>
               DPTHMX=DPTHMX+DP(NK)<a name='925'>
               NLAYRS=NLAYRS+1<a name='926'>
               IF(DPTHMX.GT.DPMIN)THEN<a name='927'>
                 EXIT <a name='928'>
               ENDIF<a name='929'>
             END DO    <a name='930'>
           ENDIF<a name='931'>
           IF(DPTHMX.LT.DPMIN)THEN <a name='932'>
             RETURN<a name='933'>
           ENDIF<a name='934'>
           KPBL=LC+NLAYRS-1   <a name='935'>
<font color=#447700>!<a name='936'></font>
<font color=#447700>!...********************************************************<a name='937'></font>
<font color=#447700>!...for computational simplicity without much loss in accuracy,<a name='938'></font>
<font color=#447700>!...mix temperature instead of theta for evaluating convective<a name='939'></font>
<font color=#447700>!...initiation (triggering) potential...<a name='940'></font>
<font color=#447700>!          THMIX=0.<a name='941'></font>
           TMIX=0.<a name='942'>
           QMIX=0.<a name='943'>
           ZMIX=0.<a name='944'>
           PMIX=0.<a name='945'>
<font color=#447700>!<a name='946'></font>
<font color=#447700>!...FIND THE THERMODYNAMIC CHARACTERISTICS OF THE LAYER BY<a name='947'></font>
<font color=#447700>!...MASS-WEIGHTING THE CHARACTERISTICS OF THE INDIVIDUAL MODEL<a name='948'></font>
<font color=#447700>!...LAYERS...<a name='949'></font>
<font color=#447700>!<a name='950'></font>
<font color=#447700>!cdir novector<a name='951'></font>
           DO NK=LC,KPBL<a name='952'>
             TMIX=TMIX+DP(NK)*T0(NK)<a name='953'>
             QMIX=QMIX+DP(NK)*Q0(NK)<a name='954'>
             ZMIX=ZMIX+DP(NK)*Z0(NK)<a name='955'>
             PMIX=PMIX+DP(NK)*P0(NK)<a name='956'>
           ENDDO   <a name='957'>
<font color=#447700>!         THMIX=THMIX/DPTHMX<a name='958'></font>
          TMIX=TMIX/DPTHMX<a name='959'>
          QMIX=QMIX/DPTHMX<a name='960'>
          ZMIX=ZMIX/DPTHMX<a name='961'>
          PMIX=PMIX/DPTHMX<a name='962'>
          EMIX=QMIX*PMIX/(0.622+QMIX)<a name='963'>
<font color=#447700>!<a name='964'></font>
<font color=#447700>!...FIND THE TEMPERATURE OF THE MIXTURE AT ITS LCL...<a name='965'></font>
<font color=#447700>!<a name='966'></font>
<font color=#447700>!        TLOG=ALOG(EMIX/ALIQ)<a name='967'></font>
<font color=#447700>! ...calculate dewpoint using lookup table...<a name='968'></font>
<font color=#447700>!<a name='969'></font>
          astrt=1.e-3<a name='970'>
          ainc=0.075<a name='971'>
          a1=emix/aliq<a name='972'>
          tp=(a1-astrt)/ainc<a name='973'>
          indlu=int(tp)+1<a name='974'>
          value=(indlu-1)*ainc+astrt<a name='975'>
          aintrp=(a1-value)/ainc<a name='976'>
          tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='977'>
          TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)<a name='978'>
          TLCL=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(TMIX-T00))*(TMIX-TDPT)<a name='979'>
          TLCL=AMIN1(TLCL,TMIX)<a name='980'>
          TVLCL=TLCL*(1.+0.608*QMIX)<a name='981'>
          ZLCL = ZMIX+(TLCL-TMIX)/GDRY<a name='982'>
     <font color=#447700>!     NK = LC-1<a name='983'></font>
     <font color=#447700>!     DO <a name='984'></font>
     <font color=#447700>!       NK = NK+1<a name='985'></font>
     <font color=#447700>!       KLCL=NK<a name='986'></font>
     <font color=#447700>!       IF(ZLCL.LE.Z0(NK) .or. NK.GT.KL)THEN<a name='987'></font>
     <font color=#447700>!         EXIT<a name='988'></font>
     <font color=#447700>!       ENDIF <a name='989'></font>
     <font color=#447700>!     ENDDO   <a name='990'></font>
     <font color=#447700>!     IF(NK.GT.KL)THEN<a name='991'></font>
     <font color=#447700>!       RETURN  <a name='992'></font>
     <font color=#447700>!     ENDIF<a name='993'></font>
<a name='994'>
       DO NK = LC, KL<a name='995'>
         KLCL = NK<a name='996'>
         IF ( ZLCL.LE.Z0(NK) )  EXIT<a name='997'>
     END DO<a name='998'>
     IF ( ZLCL.GT.Z0(KL) )  RETURN<a name='999'>
<a name='1000'>
          K=KLCL-1<a name='1001'>
<font color=#447700>! calculate DLP using Z instead of log(P)<a name='1002'></font>
          DLP=(ZLCL-Z0(K))/(Z0(KLCL)-Z0(K))<a name='1003'>
<font color=#447700>!     <a name='1004'></font>
<font color=#447700>!...ESTIMATE ENVIRONMENTAL TEMPERATURE AND MIXING RATIO AT THE LCL...<a name='1005'></font>
<font color=#447700>!     <a name='1006'></font>
          TENV=T0(K)+(T0(KLCL)-T0(K))*DLP<a name='1007'>
          QENV=Q0(K)+(Q0(KLCL)-Q0(K))*DLP<a name='1008'>
          TVEN=TENV*(1.+0.608*QENV)<a name='1009'>
<font color=#447700>!     <a name='1010'></font>
<font color=#447700>! ww: this needs to be initialized<a name='1011'></font>
          DTRH = 0.<a name='1012'>
<a name='1013'>
<font color=#447700>! Bechtold 2001 trigger with my Beta parameter<a name='1014'></font>
           DTLCL = W0AVG1D(KLCL)/Scale_Fac<a name='1015'>
           if(DTLCL.lt.0.0) then<a name='1016'>
              tempKay = -1.0<a name='1017'>
              DTLCL = tempKay * DTLCL<a name='1018'>
              DTLCL = (DTLCL)**0.3333<a name='1019'>
           else<a name='1020'>
              tempKay = 1.0<a name='1021'>
              DTLCL = tempKay * DTLCL<a name='1022'>
              DTLCL = (DTLCL)**0.3333<a name='1023'>
           end if<a name='1024'>
<a name='1025'>
           DTLCL = 6.0 * tempKay * DTLCL <a name='1026'>
<font color=#447700>!<a name='1027'></font>
<font color=#447700>! old trigger<a name='1028'></font>
<font color=#447700>! Stick with the old trigger for now... CGM July 2015<a name='1029'></font>
<font color=#447700>!<a name='1030'></font>
          IF(ZLCL.LT.2.E3)THEN        <font color=#447700>! Kain (2004) Eq. 2<a name='1031'></font>
            WKLCL=0.02*ZLCL/2.E3<a name='1032'>
          ELSE<a name='1033'>
            WKLCL=0.02                <font color=#447700>! units of m/s<a name='1034'></font>
          ENDIF<a name='1035'>
          WKL=(W0AVG1D(K)+(W0AVG1D(KLCL)-W0AVG1D(K))*DLP)*DX/25.E3-WKLCL<a name='1036'>
          IF(WKL.LT.0.0001)THEN<a name='1037'>
            DTLCL=0.<a name='1038'>
          ELSE<a name='1039'>
            DTLCL=4.64*WKL**0.33      <font color=#447700>! Kain (2004) Eq. 1<a name='1040'></font>
          ENDIF<a name='1041'>
<a name='1042'>
<a name='1043'>
<font color=#447700>!         IF(ISHALL.EQ.1)IPRNT=.TRUE.<a name='1044'></font>
<font color=#447700>!         IPRNT=.TRUE.<a name='1045'></font>
<font color=#447700>!         IF(TLCL+DTLCL.GT.TENV)GOTO 45<a name='1046'></font>
<a name='1047'>
           IF(TLCL+DTLCL.LT.TENV)THEN<a name='1048'>
<font color=#447700>!<a name='1049'></font>
<font color=#447700>! Parcel not buoyant, CYCLE back to start of trigger and evaluate next potential<a name='1050'></font>
<font color=#447700>! USL...<a name='1051'></font>
<font color=#447700>!<a name='1052'></font>
            CYCLE usl<a name='1053'>
<font color=#447700>!<a name='1054'></font>
          ELSE                            <font color=#447700>! Parcel is buoyant, determine updraft<a name='1055'></font>
<font color=#447700>!     <a name='1056'></font>
<font color=#447700>!...CONVECTIVE TRIGGERING CRITERIA HAS BEEN SATISFIED...COMPUTE<a name='1057'></font>
<font color=#447700>!...EQUIVALENT POTENTIAL TEMPERATURE<a name='1058'></font>
<font color=#447700>!...(THETEU) AND VERTICAL VELOCITY OF THE RISING PARCEL AT THE LCL...<a name='1059'></font>
<font color=#447700>!     <a name='1060'></font>
            CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_9">(PMIX,TMIX,QMIX,THETEU(K),ALIQ,BLIQ,CLIQ,DLIQ)<a name='1061'>
<font color=#447700>!<a name='1062'></font>
<font color=#447700>!...modify calculation of initial parcel vertical velocity...jsk 11/26/97<a name='1063'></font>
<font color=#447700>!<a name='1064'></font>
            DTTOT = DTLCL+DTRH<a name='1065'>
            IF(DTTOT.GT.1.E-4)THEN<a name='1066'>
              GDT=2.*G*DTTOT*500./TVEN     <font color=#447700>! Kain (2004) Eq. 3  (sort of)<a name='1067'></font>
              WLCL=1.+0.5*SQRT(GDT)<a name='1068'>
              WLCL = AMIN1(WLCL,3.)<a name='1069'>
            ELSE<a name='1070'>
              WLCL=1.<a name='1071'>
            ENDIF<a name='1072'>
            PLCL=P0(K)+(P0(KLCL)-P0(K))*DLP<a name='1073'>
            WTW=WLCL*WLCL<a name='1074'>
<font color=#447700>!<a name='1075'></font>
            TVLCL=TLCL*(1.+0.608*QMIX)<a name='1076'>
            RHOLCL=PLCL/(R*TVLCL)<a name='1077'>
<font color=#447700>!        <a name='1078'></font>
            LCL=KLCL<a name='1079'>
            LET=LCL<a name='1080'>
<font color=#447700>!ckay<a name='1081'></font>
<font color=#447700>! new formulation based on the LCL replacing the cloud radius concept<a name='1082'></font>
<font color=#447700>!introduce LCL instead of RAD based on WKL here<a name='1083'></font>
            RAD = ZLCL<a name='1084'>
<font color=#447700>!ckay Dec20<a name='1085'></font>
            sourceht = Z0(KPBL)<a name='1086'>
            RAD = amax1(sourceht, RAD)<a name='1087'>
<a name='1088'>
            RAD = AMIN1(4000.,RAD)  <font color=#447700>! max trap<a name='1089'></font>
            RAD = AMAX1(500.,RAD)  <font color=#447700>! min trap<a name='1090'></font>
<font color=#447700>!     <a name='1091'></font>
<font color=#447700>!*******************************************************************<a name='1092'></font>
<font color=#447700>!                                                                  *<a name='1093'></font>
<font color=#447700>!                 COMPUTE UPDRAFT PROPERTIES                       *<a name='1094'></font>
<font color=#447700>!                                                                  *<a name='1095'></font>
<font color=#447700>!*******************************************************************<a name='1096'></font>
<font color=#447700>!     <a name='1097'></font>
<font color=#447700>!     <a name='1098'></font>
<font color=#447700>!...<a name='1099'></font>
<font color=#447700>!...ESTIMATE INITIAL UPDRAFT MASS FLUX (UMF(K))...<a name='1100'></font>
<font color=#447700>!     <a name='1101'></font>
            WU(K)=WLCL<a name='1102'>
            AU0=0.01*DXSQ<a name='1103'>
            UMF(K)=RHOLCL*AU0<a name='1104'>
<a name='1105'>
            VMFLCL=UMF(K)<a name='1106'>
            UPOLD=VMFLCL<a name='1107'>
            UPNEW=UPOLD<a name='1108'>
<font color=#447700>!     <a name='1109'></font>
<font color=#447700>!...RATIO2 IS THE DEGREE OF GLACIATION IN THE CLOUD (0 TO 1),<a name='1110'></font>
<font color=#447700>!...UER IS THE ENVIR ENTRAINMENT RATE, ABE IS AVAILABLE<a name='1111'></font>
<font color=#447700>!...BUOYANT ENERGY, TRPPT IS THE TOTAL RATE OF PRECIPITATION<a name='1112'></font>
<font color=#447700>!...PRODUCTION...<a name='1113'></font>
<font color=#447700>!     <a name='1114'></font>
            RATIO2(K)=0.<a name='1115'>
            UER(K)=0.<a name='1116'>
            ABE=0.<a name='1117'>
            TRPPT=0.<a name='1118'>
            TU(K)=TLCL<a name='1119'>
            TVU(K)=TVLCL<a name='1120'>
            QU(K)=QMIX<a name='1121'>
            EQFRC(K)=1.<a name='1122'>
            QLIQ(K)=0.<a name='1123'>
            QICE(K)=0.<a name='1124'>
            QLQOUT(K)=0.<a name='1125'>
            QICOUT(K)=0.<a name='1126'>
            DETLQ(K)=0.<a name='1127'>
            DETIC(K)=0.<a name='1128'>
            PPTLIQ(K)=0.<a name='1129'>
            PPTICE(K)=0.<a name='1130'>
            IFLAG=0<a name='1131'>
<font color=#447700>!     <a name='1132'></font>
<font color=#447700>!...TTEMP IS USED DURING CALCULATION OF THE LINEAR GLACIATION<a name='1133'></font>
<font color=#447700>!...PROCESS; IT IS INITIALLY SET TO THE TEMPERATURE AT WHICH<a name='1134'></font>
<font color=#447700>!...FREEZING IS SPECIFIED TO BEGIN.  WITHIN THE GLACIATION<a name='1135'></font>
<font color=#447700>!...INTERVAL, IT IS SET EQUAL TO THE UPDRAFT TEMP AT THE<a name='1136'></font>
<font color=#447700>!...PREVIOUS MODEL LEVEL...<a name='1137'></font>
<font color=#447700>!     <a name='1138'></font>
            TTEMP=TTFRZ<a name='1139'>
<font color=#447700>!     <a name='1140'></font>
<font color=#447700>!...ENTER THE LOOP FOR UPDRAFT CALCULATIONS...CALCULATE UPDRAFT TEMP,<a name='1141'></font>
<font color=#447700>!...MIXING RATIO, VERTICAL MASS FLUX, LATERAL DETRAINMENT OF MASS AND<a name='1142'></font>
<font color=#447700>!...MOISTURE, PRECIPITATION RATES AT EACH MODEL LEVEL...<a name='1143'></font>
<font color=#447700>!     <a name='1144'></font>
<font color=#447700>!    **1 variables indicate the bottom of a model layer<a name='1145'></font>
<font color=#447700>!    **2 variables indicate the top of a model layer<a name='1146'></font>
<font color=#447700>!     <a name='1147'></font>
            EE1=1.<a name='1148'>
            UD1=0.<a name='1149'>
            REI = 0.<a name='1150'>
            DILBE = 0.<a name='1151'>
updraft:    DO NK=K,KL-1<a name='1152'>
              NK1=NK+1<a name='1153'>
              RATIO2(NK1)=RATIO2(NK)<a name='1154'>
              FRC1=0.<a name='1155'>
              TU(NK1)=T0(NK1)<a name='1156'>
              THETEU(NK1)=THETEU(NK)<a name='1157'>
              QU(NK1)=QU(NK)<a name='1158'>
              QLIQ(NK1)=QLIQ(NK)<a name='1159'>
              QICE(NK1)=QICE(NK)<a name='1160'>
              call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_4">(p0(nk1),theteu(nk1),tu(nk1),qu(nk1),qliq(nk1),        &amp;<a name='1161'>
                     qice(nk1),qnewlq,qnewic,XLV1,XLV0)<a name='1162'>
<font color=#447700>!<a name='1163'></font>
<font color=#447700>!<a name='1164'></font>
<font color=#447700>!...CHECK TO SEE IF UPDRAFT TEMP IS ABOVE THE TEMPERATURE AT WHICH<a name='1165'></font>
<font color=#447700>!...GLACIATION IS ASSUMED TO INITIATE; IF IT IS, CALCULATE THE<a name='1166'></font>
<font color=#447700>!...FRACTION OF REMAINING LIQUID WATER TO FREEZE...TTFRZ IS THE<a name='1167'></font>
<font color=#447700>!...TEMP AT WHICH FREEZING BEGINS, TBFRZ THE TEMP BELOW WHICH ALL<a name='1168'></font>
<font color=#447700>!...LIQUID WATER IS FROZEN AT EACH LEVEL...<a name='1169'></font>
<font color=#447700>!<a name='1170'></font>
              IF(TU(NK1).LE.TTFRZ)THEN<a name='1171'>
                IF(TU(NK1).GT.TBFRZ)THEN<a name='1172'>
                  IF(TTEMP.GT.TTFRZ)TTEMP=TTFRZ<a name='1173'>
                  FRC1=(TTEMP-TU(NK1))/(TTEMP-TBFRZ)<a name='1174'>
                ELSE<a name='1175'>
                  FRC1=1.<a name='1176'>
                  IFLAG=1<a name='1177'>
                ENDIF<a name='1178'>
                TTEMP=TU(NK1)<a name='1179'>
<font color=#447700>!<a name='1180'></font>
<font color=#447700>!  DETERMINE THE EFFECTS OF LIQUID WATER FREEZING WHEN TEMPERATURE<a name='1181'></font>
<font color=#447700>!...IS BELOW TTFRZ...<a name='1182'></font>
<font color=#447700>!<a name='1183'></font>
                QFRZ = (QLIQ(NK1)+QNEWLQ)*FRC1<a name='1184'>
                QNEWIC=QNEWIC+QNEWLQ*FRC1<a name='1185'>
                QNEWLQ=QNEWLQ-QNEWLQ*FRC1<a name='1186'>
                QICE(NK1) = QICE(NK1)+QLIQ(NK1)*FRC1<a name='1187'>
                QLIQ(NK1) = QLIQ(NK1)-QLIQ(NK1)*FRC1<a name='1188'>
                CALL <A href='../../html_code/phys/module_cu_mskf.F.html#DTFRZNEW'>DTFRZNEW</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DTFRZNEW_3">(TU(NK1),P0(NK1),THETEU(NK1),QU(NK1),QFRZ,         &amp;<a name='1189'>
                          QICE(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='1190'>
              ENDIF<a name='1191'>
              TVU(NK1)=TU(NK1)*(1.+0.608*QU(NK1))<a name='1192'>
<font color=#447700>!<a name='1193'></font>
<font color=#447700>!  CALCULATE UPDRAFT VERTICAL VELOCITY AND PRECIPITATION FALLOUT...<a name='1194'></font>
<font color=#447700>!<a name='1195'></font>
              IF(NK.EQ.K)THEN<a name='1196'>
                BE=(TVLCL+TVU(NK1))/(TVEN+TV0(NK1))-1.<a name='1197'>
                BOTERM=2.*(Z0(NK1)-ZLCL)*G*BE/1.5<a name='1198'>
                DZZ=Z0(NK1)-ZLCL<a name='1199'>
              ELSE<a name='1200'>
                BE=(TVU(NK)+TVU(NK1))/(TV0(NK)+TV0(NK1))-1.<a name='1201'>
                BOTERM=2.*DZA(NK)*G*BE/1.5<a name='1202'>
                DZZ=DZA(NK)<a name='1203'>
              ENDIF<a name='1204'>
              ENTERM=2.*REI*WTW/UPOLD<a name='1205'>
<font color=#447700>!<a name='1206'></font>
<font color=#447700>! ckay<a name='1207'></font>
<font color=#447700>! using corrected RATE_kay for Test simulation #2... CGM July 2015<a name='1208'></font>
<font color=#447700>!<a name='1209'></font>
              IF(DX.GE.24.999E3) then<a name='1210'>
                RATE_kay = RATE<a name='1211'>
              else<a name='1212'>
                RATE_kay = RATE / Scale_Fac <a name='1213'>
               end if<a name='1214'>
              CALL <A href='../../html_code/phys/module_cu_mskf.F.html#CONDLOAD'>CONDLOAD</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONDLOAD_3">(QLIQ(NK1),QICE(NK1),WTW,DZZ,BOTERM,ENTERM,      &amp;<a name='1215'>
                   RATE_kay,QNEWLQ,QNEWIC,QLQOUT(NK1),QICOUT(NK1),G)<a name='1216'>
<a name='1217'>
<font color=#447700>!<a name='1218'></font>
<font color=#447700>!...IF VERT VELOCITY IS LESS THAN ZERO, EXIT THE UPDRAFT LOOP AND,<a name='1219'></font>
<font color=#447700>!...IF CLOUD IS TALL ENOUGH, FINALIZE UPDRAFT CALCULATIONS...<a name='1220'></font>
<font color=#447700>!<a name='1221'></font>
              IF(WTW.LT.1.E-3)THEN<a name='1222'>
                EXIT<a name='1223'>
              ELSE<a name='1224'>
                WU(NK1)=SQRT(WTW)<a name='1225'>
              ENDIF<a name='1226'>
<font color=#447700>!...Calculate value of THETA-E in environment to entrain into updraft...<a name='1227'></font>
<font color=#447700>!<a name='1228'></font>
              CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_10">(P0(NK1),T0(NK1),Q0(NK1),THETEE(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='1229'>
<font color=#447700>!<a name='1230'></font>
<font color=#447700>!...REI IS THE RATE OF ENVIRONMENTAL INFLOW...<a name='1231'></font>
<font color=#447700>! New formulation for entrainment<a name='1232'></font>
<font color=#447700>!ckay introduce DX dependcy for the TOKIOKA Parameter =0.03<a name='1233'></font>
<font color=#447700>!ckay Kim et al 2011; Kang et al 2009; Lin et al 2013;  GCM findings<a name='1234'></font>
<a name='1235'>
              TOKIOKA = 0.03<a name='1236'>
              TOKIOKA = TOKIOKA * Scale_Fac<a name='1237'>
              REI=VMFLCL*DP(NK1)*TOKIOKA/RAD         <a name='1238'>
<font color=#447700>!ckay<a name='1239'></font>
              TVQU(NK1)=TU(NK1)*(1.+0.608*QU(NK1)-QLIQ(NK1)-QICE(NK1))<a name='1240'>
              IF(NK.EQ.K)THEN<a name='1241'>
                DILBE=((TVLCL+TVQU(NK1))/(TVEN+TV0(NK1))-1.)*DZZ<a name='1242'>
              ELSE<a name='1243'>
                DILBE=((TVQU(NK)+TVQU(NK1))/(TV0(NK)+TV0(NK1))-1.)*DZZ<a name='1244'>
              ENDIF<a name='1245'>
              IF(DILBE.GT.0.)ABE=ABE+DILBE*G<a name='1246'>
<font color=#447700>!<a name='1247'></font>
<font color=#447700>!...IF CLOUD PARCELS ARE VIRTUALLY COLDER THAN THE ENVIRONMENT, MINIMAL <a name='1248'></font>
<font color=#447700>!...ENTRAINMENT (0.5*REI) IS IMPOSED...<a name='1249'></font>
<font color=#447700>!<a name='1250'></font>
              IF(TVQU(NK1).LE.TV0(NK1))THEN    <font color=#447700>! Entrain/Detrain IF BLOCK<a name='1251'></font>
                EE2=0.5       <font color=#447700>! Kain (2004)  Eq. 4<a name='1252'></font>
                UD2=1.<a name='1253'>
                EQFRC(NK1)=0.<a name='1254'>
              ELSE<a name='1255'>
                LET=NK1<a name='1256'>
                TTMP=TVQU(NK1)<a name='1257'>
<font color=#447700>!<a name='1258'></font>
<font color=#447700>!...DETERMINE THE CRITICAL MIXED FRACTION OF UPDRAFT AND ENVIRONMENTAL AIR...<a name='1259'></font>
<font color=#447700>!<a name='1260'></font>
                F1=0.95<a name='1261'>
                F2=1.-F1<a name='1262'>
                THTTMP=F1*THETEE(NK1)+F2*THETEU(NK1)<a name='1263'>
                QTMP=F1*Q0(NK1)+F2*QU(NK1)<a name='1264'>
                TMPLIQ=F2*QLIQ(NK1)<a name='1265'>
                TMPICE=F2*QICE(NK1)<a name='1266'>
                call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_5">(p0(nk1),thttmp,ttmp,qtmp,tmpliq,tmpice,        &amp;<a name='1267'>
                           qnewlq,qnewic,XLV1,XLV0)<a name='1268'>
                TU95=TTMP*(1.+0.608*QTMP-TMPLIQ-TMPICE)<a name='1269'>
                IF(TU95.GT.TV0(NK1))THEN<a name='1270'>
                  EE2=1.<a name='1271'>
                  UD2=0.<a name='1272'>
                  EQFRC(NK1)=1.0<a name='1273'>
                ELSE<a name='1274'>
                  F1=0.10<a name='1275'>
                  F2=1.-F1<a name='1276'>
                  THTTMP=F1*THETEE(NK1)+F2*THETEU(NK1)<a name='1277'>
                  QTMP=F1*Q0(NK1)+F2*QU(NK1)<a name='1278'>
                  TMPLIQ=F2*QLIQ(NK1)<a name='1279'>
                  TMPICE=F2*QICE(NK1)<a name='1280'>
                  call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2'>tpmix2</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2_6">(p0(nk1),thttmp,ttmp,qtmp,tmpliq,tmpice,        &amp;<a name='1281'>
                               qnewlq,qnewic,XLV1,XLV0)<a name='1282'>
                  TU10=TTMP*(1.+0.608*QTMP-TMPLIQ-TMPICE)<a name='1283'>
                  TVDIFF = ABS(TU10-TVQU(NK1))<a name='1284'>
                  IF(TVDIFF.LT.1.e-3)THEN<a name='1285'>
                    EE2=1.<a name='1286'>
                    UD2=0.<a name='1287'>
                    EQFRC(NK1)=1.0<a name='1288'>
                  ELSE<a name='1289'>
                    EQFRC(NK1)=(TV0(NK1)-TVQU(NK1))*F1/(TU10-TVQU(NK1))<a name='1290'>
                    EQFRC(NK1)=AMAX1(0.0,EQFRC(NK1))<a name='1291'>
                    EQFRC(NK1)=AMIN1(1.0,EQFRC(NK1))<a name='1292'>
                    IF(EQFRC(NK1).EQ.1)THEN<a name='1293'>
                      EE2=1.<a name='1294'>
                      UD2=0.<a name='1295'>
                    ELSEIF(EQFRC(NK1).EQ.0.)THEN<a name='1296'>
                      EE2=0.<a name='1297'>
                      UD2=1.<a name='1298'>
                    ELSE<a name='1299'>
<font color=#447700>!<a name='1300'></font>
<font color=#447700>!...SUBROUTINE PROF5 INTEGRATES OVER THE GAUSSIAN DIST TO DETERMINE THE<a name='1301'></font>
<font color=#447700>!   FRACTIONAL ENTRAINMENT AND DETRAINMENT RATES...<a name='1302'></font>
<font color=#447700>!<a name='1303'></font>
                      CALL <A href='../../html_code/phys/module_cu_mskf.F.html#PROF5'>PROF5</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROF5_3">(EQFRC(NK1),EE2,UD2)<a name='1304'>
                    ENDIF<a name='1305'>
                  ENDIF<a name='1306'>
                ENDIF<a name='1307'>
              ENDIF                            <font color=#447700>! End of Entrain/Detrain IF BLOCK<a name='1308'></font>
<font color=#447700>!<a name='1309'></font>
<font color=#447700>!<a name='1310'></font>
<font color=#447700>!...NET ENTRAINMENT AND DETRAINMENT RATES ARE GIVEN BY THE AVERAGE FRACTIONAL<a name='1311'></font>
<font color=#447700>!   VALUES IN THE LAYER...<a name='1312'></font>
<font color=#447700>!<a name='1313'></font>
              EE2 = AMAX1(EE2,0.5)<a name='1314'>
              UD2 = 1.5*UD2<a name='1315'>
              UER(NK1)=0.5*REI*(EE1+EE2)<a name='1316'>
              UDR(NK1)=0.5*REI*(UD1+UD2)<a name='1317'>
<font color=#447700>!<a name='1318'></font>
<font color=#447700>!...IF THE CALCULATED UPDRAFT DETRAINMENT RATE IS GREATER THAN THE TOTAL<a name='1319'></font>
<font color=#447700>!   UPDRAFT MASS FLUX, ALL CLOUD MASS DETRAINS, EXIT UPDRAFT CALCULATIONS...<a name='1320'></font>
<font color=#447700>!<a name='1321'></font>
              IF(UMF(NK)-UDR(NK1).LT.10.)THEN<a name='1322'>
<font color=#447700>!<a name='1323'></font>
<font color=#447700>!...IF THE CALCULATED DETRAINED MASS FLUX IS GREATER THAN THE TOTAL UPD MASS<a name='1324'></font>
<font color=#447700>!   FLUX, IMPOSE TOTAL DETRAINMENT OF UPDRAFT MASS AT THE PREVIOUS MODEL LVL..<a name='1325'></font>
<font color=#447700>!   First, correct ABE calculation if needed...<a name='1326'></font>
<font color=#447700>!<a name='1327'></font>
                IF(DILBE.GT.0.)THEN<a name='1328'>
                  ABE=ABE-DILBE*G<a name='1329'>
                ENDIF<a name='1330'>
                LET=NK<a name='1331'>
<font color=#447700>!               WRITE(98,1015)P0(NK1)/100.<a name='1332'></font>
                EXIT <a name='1333'>
              ELSE<a name='1334'>
                EE1=EE2<a name='1335'>
                UD1=UD2<a name='1336'>
                UPOLD=UMF(NK)-UDR(NK1)<a name='1337'>
                UPNEW=UPOLD+UER(NK1)<a name='1338'>
                UMF(NK1)=UPNEW<a name='1339'>
                DILFRC(NK1) = UPNEW/UPOLD<a name='1340'>
<font color=#447700>!<a name='1341'></font>
<font color=#447700>!...DETLQ AND DETIC ARE THE RATES OF DETRAINMENT OF LIQUID AND<a name='1342'></font>
<font color=#447700>!...ICE IN THE DETRAINING UPDRAFT MASS...<a name='1343'></font>
<font color=#447700>!<a name='1344'></font>
                DETLQ(NK1)=QLIQ(NK1)*UDR(NK1)<a name='1345'>
                DETIC(NK1)=QICE(NK1)*UDR(NK1)<a name='1346'>
                QDT(NK1)=QU(NK1)<a name='1347'>
                QU(NK1)=(UPOLD*QU(NK1)+UER(NK1)*Q0(NK1))/UPNEW<a name='1348'>
                THETEU(NK1)=(THETEU(NK1)*UPOLD+THETEE(NK1)*UER(NK1))/UPNEW<a name='1349'>
                QLIQ(NK1)=QLIQ(NK1)*UPOLD/UPNEW<a name='1350'>
                QICE(NK1)=QICE(NK1)*UPOLD/UPNEW<a name='1351'>
<font color=#447700>!<a name='1352'></font>
<font color=#447700>!...PPTLIQ IS THE RATE OF GENERATION (FALLOUT) OF<a name='1353'></font>
<font color=#447700>!...LIQUID PRECIP AT A GIVEN MODEL LVL, PPTICE THE SAME FOR ICE,<a name='1354'></font>
<font color=#447700>!...TRPPT IS THE TOTAL RATE OF PRODUCTION OF PRECIP UP TO THE<a name='1355'></font>
<font color=#447700>!...CURRENT MODEL LEVEL...<a name='1356'></font>
<font color=#447700>!<a name='1357'></font>
                PPTLIQ(NK1)=QLQOUT(NK1)*UMF(NK)<a name='1358'>
                PPTICE(NK1)=QICOUT(NK1)*UMF(NK)<a name='1359'>
<font color=#447700>!<a name='1360'></font>
                TRPPT=TRPPT+PPTLIQ(NK1)+PPTICE(NK1)<a name='1361'>
                IF(NK1.LE.KPBL)UER(NK1)=UER(NK1)+VMFLCL*DP(NK1)/DPTHMX<a name='1362'>
              ENDIF<a name='1363'>
<font color=#447700>!<a name='1364'></font>
            END DO updraft<a name='1365'>
<font color=#447700>!<a name='1366'></font>
<font color=#447700>!...CHECK CLOUD DEPTH...IF CLOUD IS TALL ENOUGH, ESTIMATE THE EQUILIBRIUM<a name='1367'></font>
<font color=#447700>!   TEMPERATURE LEVEL (LET) AND ADJUST MASS FLUX PROFILE AT CLOUD TOP SO<a name='1368'></font>
<font color=#447700>!   THAT MASS FLUX DECREASES TO ZERO AS A LINEAR FUNCTION OF PRESSURE BETWEEN<a name='1369'></font>
<font color=#447700>!   THE LET AND CLOUD TOP...<a name='1370'></font>
<font color=#447700>!     <a name='1371'></font>
<font color=#447700>!...LTOP IS THE MODEL LEVEL JUST BELOW THE LEVEL AT WHICH VERTICAL VELOCITY<a name='1372'></font>
<font color=#447700>!   FIRST BECOMES NEGATIVE...<a name='1373'></font>
<font color=#447700>!     <a name='1374'></font>
            LTOP=NK<a name='1375'>
            CLDHGT(LC)=Z0(LTOP)-ZLCL <a name='1376'>
<font color=#447700>!<a name='1377'></font>
<font color=#447700>!...Instead of using the same minimum cloud height (for deep convection)<a name='1378'></font>
<font color=#447700>!...everywhere, try specifying minimum cloud depth as a function of TLCL...<a name='1379'></font>
<font color=#447700>!<a name='1380'></font>
<font color=#447700>!   Kain (2004)  Eq. 7<a name='1381'></font>
<font color=#447700>!<a name='1382'></font>
            IF(TLCL.GT.293.)THEN<a name='1383'>
              CHMIN = 4.E3<a name='1384'>
            ELSEIF(TLCL.LE.293. .and. TLCL.GE.273)THEN<a name='1385'>
              CHMIN = 2.E3 + 100.*(TLCL-273.)<a name='1386'>
            ELSEIF(TLCL.LT.273.)THEN<a name='1387'>
              CHMIN = 2.E3<a name='1388'>
            ENDIF<a name='1389'>
<font color=#447700>!ckay<a name='1390'></font>
            DO NK=K,LTOP<a name='1391'>
              qc_KF(I,NK,J)=QLIQ(NK)<a name='1392'>
              qi_KF(I,NK,J)=QICE(NK)<a name='1393'>
            END DO<a name='1394'>
<a name='1395'>
<font color=#447700>!ckay: if mean env RH with respect to water/ice is over 100% then dont allow KF<a name='1396'></font>
<font color=#447700>!ckay: added saturation w.r.to ice june 10, 2015<a name='1397'></font>
<font color=#447700>! to avoid double counting<a name='1398'></font>
          envRHavg = 0.0<a name='1399'>
          DO NK=K-1,LTOP+1<a name='1400'>
           if(T0(NK).LE.273.16) then<a name='1401'>
             envEsat = 6.112*exp(21.87*(T0(NK)-273.16)/(T0(NK)-7.66))<a name='1402'>
           else<a name='1403'>
             envEsat = 6.112*exp(17.67*(T0(NK)-273.16)/(243.5+T0(NK)-273.16))<a name='1404'>
           end if<a name='1405'>
           envEsat = envEsat * 100.0  <font color=#447700>! to hPa<a name='1406'></font>
           envQsat = 0.622*envEsat/(P0(NK)-envEsat)<a name='1407'>
           envRH  = Q0(NK)/envQsat<a name='1408'>
            if(NK.GT.K.and.envRH.LT.0.99)  then<a name='1409'>
              envRHavg = 0.0<a name='1410'>
              goto 2020<a name='1411'>
            end if<a name='1412'>
            envRHavg = envRHavg + envRH<a name='1413'>
          END DO<a name='1414'>
<font color=#447700>!ckay ; get vertically averaged envRHavg<a name='1415'></font>
         envRHavg = envRHavg / float(LTOP-K+1+2)<a name='1416'>
2020     continue<a name='1417'>
<a name='1418'>
<font color=#447700>!     <a name='1419'></font>
<font color=#447700>!...If cloud top height is less than the specified minimum for deep <a name='1420'></font>
<font color=#447700>!...convection, save value to consider this level as source for <a name='1421'></font>
<font color=#447700>!...shallow convection, go back up to check next level...<a name='1422'></font>
<font color=#447700>!     <a name='1423'></font>
<font color=#447700>!...Try specifying minimum cloud depth as a function of TLCL...<a name='1424'></font>
<font color=#447700>!<a name='1425'></font>
<font color=#447700>!<a name='1426'></font>
<font color=#447700>!...DO NOT ALLOW ANY CLOUD FROM THIS LAYER IF:<a name='1427'></font>
<font color=#447700>!<a name='1428'></font>
<font color=#447700>!...            1.) if there is no CAPE, or <a name='1429'></font>
<font color=#447700>!...            2.) cloud top is at model level just above LCL, or<a name='1430'></font>
<font color=#447700>!...            3.) cloud top is within updraft source layer, or<a name='1431'></font>
<font color=#447700>!...            4.) cloud-top detrainment layer begins within <a name='1432'></font>
<font color=#447700>!...                updraft source layer.<a name='1433'></font>
<font color=#447700>!...ckay        5.) if the environment is supersaturated i.e., RH &gt; 100%<a name='1434'></font>
<font color=#447700>!...ckay            For now, with respect to water<a name='1435'></font>
<font color=#447700>!<a name='1436'></font>
<a name='1437'>
            IF(LTOP.LE.KLCL .or. LTOP.LE.KPBL .or. LET+1.LE.KPBL &amp;<a name='1438'>
              .or. envRHavg.ge.1.01)THEN  <font color=#447700>! No Convection Allowed<a name='1439'></font>
<font color=#447700>!ckay<a name='1440'></font>
<a name='1441'>
              CLDHGT(LC)=0.<a name='1442'>
              DO NK=K,LTOP<a name='1443'>
                UMF(NK)=0.<a name='1444'>
                UDR(NK)=0.<a name='1445'>
                UER(NK)=0.<a name='1446'>
                DETLQ(NK)=0.<a name='1447'>
                DETIC(NK)=0.<a name='1448'>
                PPTLIQ(NK)=0.<a name='1449'>
                PPTICE(NK)=0.<a name='1450'>
<font color=#447700>!ckay<a name='1451'></font>
                cldfra_dp_KF(I,NK,J)=0.<a name='1452'>
                cldfra_sh_KF(I,NK,J)=0.<a name='1453'>
                qc_KF(I,NK,J)=0.<a name='1454'>
                qi_KF(I,NK,J)=0.<a name='1455'>
                w_up(I,NK,J)=0.<a name='1456'>
              ENDDO<a name='1457'>
<font color=#447700>!        <a name='1458'></font>
            ELSEIF(CLDHGT(LC).GT.CHMIN .and. ABE.GT.1)THEN      <font color=#447700>! Deep Convection allowed<a name='1459'></font>
              ISHALL=0<a name='1460'>
<font color=#447700>!ckay<a name='1461'></font>
              DO NK=K,LTOP<a name='1462'>
                cldfra_sh_KF(I,NK,J)=0.<a name='1463'>
              ENDDO<a name='1464'>
              EXIT usl<a name='1465'>
            ELSE<a name='1466'>
<font color=#447700>!<a name='1467'></font>
<font color=#447700>!...TO DISALLOW SHALLOW CONVECTION, COMMENT OUT NEXT LINE !!!!!!!!<a name='1468'></font>
              ISHALL = 1<a name='1469'>
<font color=#447700>!ckay<a name='1470'></font>
              DO NK=K,LTOP<a name='1471'>
                cldfra_dp_KF(I,NK,J)=0.<a name='1472'>
                w_up(I,NK,J)=0.<a name='1473'>
              ENDDO<a name='1474'>
              IF(NU.EQ.NUCHM)THEN<a name='1475'>
                EXIT usl               <font color=#447700>! Shallow Convection from this layer<a name='1476'></font>
              ELSE<a name='1477'>
<font color=#447700>! Remember this layer (by virtue of non-zero CLDHGT) as potential shallow-cloud layer<a name='1478'></font>
                DO NK=K,LTOP<a name='1479'>
                  UMF(NK)=0.<a name='1480'>
                  UDR(NK)=0.<a name='1481'>
                  UER(NK)=0.<a name='1482'>
                  DETLQ(NK)=0.<a name='1483'>
                  DETIC(NK)=0.<a name='1484'>
                  PPTLIQ(NK)=0.<a name='1485'>
                  PPTICE(NK)=0.<a name='1486'>
<font color=#447700>!ckay<a name='1487'></font>
                  cldfra_dp_KF(I,NK,J)=0.<a name='1488'>
                  cldfra_sh_KF(I,NK,J)=0.<a name='1489'>
                  qc_KF(I,NK,J)=0.<a name='1490'>
                  qi_KF(I,NK,J)=0.<a name='1491'>
                  w_up(I,NK,J)=0.<a name='1492'>
                ENDDO<a name='1493'>
              ENDIF<a name='1494'>
            ENDIF<a name='1495'>
          ENDIF  <font color=#447700>! for trigger<a name='1496'></font>
        END DO usl<a name='1497'>
    IF(ISHALL.EQ.1)THEN<a name='1498'>
      KSTART=MAX0(KPBL,KLCL)<a name='1499'>
      LET=KSTART<a name='1500'>
    endif<a name='1501'>
<font color=#447700>!     <a name='1502'></font>
<font color=#447700>!...IF THE LET AND LTOP ARE THE SAME, DETRAIN ALL OF THE UPDRAFT MASS FL<a name='1503'></font>
<font color=#447700>!   THIS LEVEL...<a name='1504'></font>
<font color=#447700>!     <a name='1505'></font>
    IF(LET.EQ.LTOP)THEN<a name='1506'>
      UDR(LTOP)=UMF(LTOP)+UDR(LTOP)-UER(LTOP)<a name='1507'>
      DETLQ(LTOP)=QLIQ(LTOP)*UDR(LTOP)*UPNEW/UPOLD<a name='1508'>
      DETIC(LTOP)=QICE(LTOP)*UDR(LTOP)*UPNEW/UPOLD<a name='1509'>
      UER(LTOP)=0.<a name='1510'>
      UMF(LTOP)=0.<a name='1511'>
    ELSE <a name='1512'>
<font color=#447700>!     <a name='1513'></font>
<font color=#447700>!   BEGIN TOTAL DETRAINMENT AT THE LEVEL ABOVE THE LET...<a name='1514'></font>
<font color=#447700>!     <a name='1515'></font>
      DPTT=0.<a name='1516'>
      DO NJ=LET+1,LTOP<a name='1517'>
        DPTT=DPTT+DP(NJ)<a name='1518'>
      ENDDO<a name='1519'>
      DUMFDP=UMF(LET)/DPTT<a name='1520'>
<font color=#447700>!     <a name='1521'></font>
<font color=#447700>!...ADJUST MASS FLUX PROFILES, DETRAINMENT RATES, AND PRECIPITATION FALL<a name='1522'></font>
<font color=#447700>!   RATES TO REFLECT THE LINEAR DECREASE IN MASS FLX BETWEEN THE LET AND<a name='1523'></font>
<font color=#447700>!     <a name='1524'></font>
      DO NK=LET+1,LTOP<a name='1525'>
<font color=#447700>!<a name='1526'></font>
<font color=#447700>!...entrainment is allowed at every level except for LTOP, so disallow<a name='1527'></font>
<font color=#447700>!...entrainment at LTOP and adjust entrainment rates between LET and LTOP<a name='1528'></font>
<font color=#447700>!...so the the dilution factor due to entrainment is not changed but <a name='1529'></font>
<font color=#447700>!...the actual entrainment rate will change due due forced total <a name='1530'></font>
<font color=#447700>!...detrainment in this layer...<a name='1531'></font>
<font color=#447700>!<a name='1532'></font>
        IF(NK.EQ.LTOP)THEN<a name='1533'>
          UDR(NK) = UMF(NK-1)<a name='1534'>
          UER(NK) = 0.<a name='1535'>
          DETLQ(NK) = UDR(NK)*QLIQ(NK)*DILFRC(NK)<a name='1536'>
          DETIC(NK) = UDR(NK)*QICE(NK)*DILFRC(NK)<a name='1537'>
        ELSE<a name='1538'>
          UMF(NK)=UMF(NK-1)-DP(NK)*DUMFDP<a name='1539'>
          UER(NK)=UMF(NK)*(1.-1./DILFRC(NK))<a name='1540'>
          UDR(NK)=UMF(NK-1)-UMF(NK)+UER(NK)<a name='1541'>
          DETLQ(NK)=UDR(NK)*QLIQ(NK)*DILFRC(NK)<a name='1542'>
          DETIC(NK)=UDR(NK)*QICE(NK)*DILFRC(NK)<a name='1543'>
        ENDIF<a name='1544'>
        IF(NK.GE.LET+2)THEN<a name='1545'>
          TRPPT=TRPPT-PPTLIQ(NK)-PPTICE(NK)<a name='1546'>
          PPTLIQ(NK)=UMF(NK-1)*QLQOUT(NK)<a name='1547'>
          PPTICE(NK)=UMF(NK-1)*QICOUT(NK)<a name='1548'>
          TRPPT=TRPPT+PPTLIQ(NK)+PPTICE(NK)<a name='1549'>
        ENDIF<a name='1550'>
      ENDDO<a name='1551'>
    ENDIF<a name='1552'>
<font color=#447700>!     <a name='1553'></font>
<font color=#447700>! Initialize some arrays below cloud base and above cloud top...<a name='1554'></font>
<font color=#447700>!<a name='1555'></font>
    DO NK=1,LTOP<a name='1556'>
      IF(T0(NK).GT.T00)ML=NK<a name='1557'>
    ENDDO<a name='1558'>
    DO NK=1,K<a name='1559'>
      IF(NK.GE.LC)THEN<a name='1560'>
        IF(NK.EQ.LC)THEN<a name='1561'>
          UMF(NK)=VMFLCL*DP(NK)/DPTHMX<a name='1562'>
          UER(NK)=VMFLCL*DP(NK)/DPTHMX<a name='1563'>
        ELSEIF(NK.LE.KPBL)THEN<a name='1564'>
          UER(NK)=VMFLCL*DP(NK)/DPTHMX<a name='1565'>
          UMF(NK)=UMF(NK-1)+UER(NK)<a name='1566'>
        ELSE<a name='1567'>
          UMF(NK)=VMFLCL<a name='1568'>
          UER(NK)=0.<a name='1569'>
        ENDIF<a name='1570'>
        TU(NK)=TMIX+(Z0(NK)-ZMIX)*GDRY<a name='1571'>
        QU(NK)=QMIX<a name='1572'>
        WU(NK)=WLCL<a name='1573'>
      ELSE<a name='1574'>
        TU(NK)=0.<a name='1575'>
        QU(NK)=0.<a name='1576'>
        UMF(NK)=0.<a name='1577'>
        WU(NK)=0.<a name='1578'>
        UER(NK)=0.<a name='1579'>
<font color=#447700>!ckay<a name='1580'></font>
        cldfra_dp_KF(I,NK,J)=0.<a name='1581'>
        cldfra_sh_KF(I,NK,J)=0.<a name='1582'>
        qc_KF(I,NK,J)=0.<a name='1583'>
        qi_KF(I,NK,J)=0.<a name='1584'>
        w_up (I,NK,J)=0.<a name='1585'>
      ENDIF<a name='1586'>
      UDR(NK)=0.<a name='1587'>
      QDT(NK)=0.<a name='1588'>
      QLIQ(NK)=0.<a name='1589'>
      QICE(NK)=0.<a name='1590'>
      QLQOUT(NK)=0.<a name='1591'>
      QICOUT(NK)=0.<a name='1592'>
      PPTLIQ(NK)=0.<a name='1593'>
      PPTICE(NK)=0.<a name='1594'>
      DETLQ(NK)=0.<a name='1595'>
      DETIC(NK)=0.<a name='1596'>
      RATIO2(NK)=0.<a name='1597'>
      CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_11">(P0(NK),T0(NK),Q0(NK),THETEE(NK),ALIQ,BLIQ,CLIQ,DLIQ)<a name='1598'>
      EQFRC(NK)=1.0<a name='1599'>
    ENDDO<a name='1600'>
<font color=#447700>!     <a name='1601'></font>
      LTOP1=LTOP+1<a name='1602'>
      LTOPM1=LTOP-1<a name='1603'>
<font color=#447700>!     <a name='1604'></font>
<font color=#447700>!...DEFINE VARIABLES ABOVE CLOUD TOP...<a name='1605'></font>
<font color=#447700>!     <a name='1606'></font>
      DO NK=LTOP1,KX<a name='1607'>
        UMF(NK)=0.<a name='1608'>
        UDR(NK)=0.<a name='1609'>
        UER(NK)=0.<a name='1610'>
        QDT(NK)=0.<a name='1611'>
        QLIQ(NK)=0.<a name='1612'>
        QICE(NK)=0.<a name='1613'>
        QLQOUT(NK)=0.<a name='1614'>
        QICOUT(NK)=0.<a name='1615'>
        DETLQ(NK)=0.<a name='1616'>
        DETIC(NK)=0.<a name='1617'>
        PPTLIQ(NK)=0.<a name='1618'>
        PPTICE(NK)=0.<a name='1619'>
        IF(NK.GT.LTOP1)THEN<a name='1620'>
          TU(NK)=0.<a name='1621'>
          QU(NK)=0.<a name='1622'>
          WU(NK)=0.<a name='1623'>
<font color=#447700>!ckay<a name='1624'></font>
          cldfra_dp_KF(I,NK,J)=0.<a name='1625'>
          cldfra_sh_KF(I,NK,J)=0.<a name='1626'>
          qc_KF(I,NK,J)=0.<a name='1627'>
          qi_KF(I,NK,J)=0.<a name='1628'>
          w_up(I,NK,J)=0.<a name='1629'>
        ENDIF<a name='1630'>
        THTA0(NK)=0.<a name='1631'>
        THTAU(NK)=0.<a name='1632'>
        EMS(NK)=0.<a name='1633'>
        EMSD(NK)=0.<a name='1634'>
        TG(NK)=T0(NK)<a name='1635'>
        QG(NK)=Q0(NK)<a name='1636'>
        QLG(NK)=0.<a name='1637'>
        QIG(NK)=0.<a name='1638'>
        QRG(NK)=0.<a name='1639'>
        QSG(NK)=0.<a name='1640'>
        OMG(NK)=0.<a name='1641'>
      ENDDO<a name='1642'>
        OMG(KX+1)=0.<a name='1643'>
        DO NK=1,LTOP<a name='1644'>
          EMS(NK)=DP(NK)*DXSQ/G<a name='1645'>
          EMSD(NK)=1./EMS(NK)<a name='1646'>
<font color=#447700>!     <a name='1647'></font>
<font color=#447700>!...INITIALIZE SOME VARIABLES TO BE USED LATER IN THE VERT ADVECTION SCHEME<a name='1648'></font>
<font color=#447700>!     <a name='1649'></font>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*QDT(NK)))<a name='1650'>
          THTAU(NK)=TU(NK)*EXN(NK)<a name='1651'>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*Q0(NK)))<a name='1652'>
          THTA0(NK)=T0(NK)*EXN(NK)<a name='1653'>
          DDILFRC(NK) = 1./DILFRC(NK)<a name='1654'>
          OMG(NK)=0.<a name='1655'>
        ENDDO<a name='1656'>
<font color=#447700>!     IF (XTIME.LT.10.)THEN<a name='1657'></font>
<font color=#447700>!      WRITE(98,1025)KLCL,ZLCL,DTLCL,LTOP,P0(LTOP),IFLAG,<a name='1658'></font>
<font color=#447700>!    * TMIX-T00,PMIX,QMIX,ABE<a name='1659'></font>
<font color=#447700>!      WRITE(98,1030)P0(LET)/100.,P0(LTOP)/100.,VMFLCL,PLCL/100.,<a name='1660'></font>
<font color=#447700>!    * WLCL,CLDHGT<a name='1661'></font>
<font color=#447700>!     ENDIF<a name='1662'></font>
<font color=#447700>!     <a name='1663'></font>
<font color=#447700>!...COMPUTE CONVECTIVE TIME SCALE(TIMEC). THE MEAN WIND AT THE LCL<a name='1664'></font>
<font color=#447700>!...AND MIDTROPOSPHERE IS USED.<a name='1665'></font>
<font color=#447700>!     <a name='1666'></font>
        WSPD(KLCL)=SQRT(U0(KLCL)*U0(KLCL)+V0(KLCL)*V0(KLCL))<a name='1667'>
        WSPD(L5)=SQRT(U0(L5)*U0(L5)+V0(L5)*V0(L5))<a name='1668'>
        WSPD(LTOP)=SQRT(U0(LTOP)*U0(LTOP)+V0(LTOP)*V0(LTOP))<a name='1669'>
        VCONV=.5*(WSPD(KLCL)+WSPD(L5))<a name='1670'>
<font color=#447700>!...for ETA model, DX is a function of location...<a name='1671'></font>
        TIMEC=DX/VCONV<a name='1672'>
        TADVEC=TIMEC<a name='1673'>
<font color=#447700>!<a name='1674'></font>
<font color=#447700>!ckay<a name='1675'></font>
<font color=#447700>!new dynTau based on subcloud layer scales : note Z0(KPBL)=altitude of source layer<a name='1676'></font>
<a name='1677'>
         TIMEC = Amax1(CHMIN,CLDHGT(LC))<a name='1678'>
         TIMEC = TIMEC*Scale_Fac<a name='1679'>
<a name='1680'>
<font color=#447700>!ckay SCLvel = SubCloudLayerVELOCITY = Wsb<a name='1681'></font>
         SCLvel = WSTAR(I,J)**3<a name='1682'>
         ZLCL_KAY = amax1(ZLCL,Z0(KPBL))<a name='1683'>
         SCLvel = SCLvel/PBLH(I,J)<a name='1684'>
         SCLvel = SCLvel*ZLCL_kay   <a name='1685'>
         SCLvel = SCLvel**0.333   <font color=#447700>! Wsb=SubCloudLayerVelocity for ConvectivePBL<a name='1686'></font>
         if(ZOL(i,J).le.0.0) then<a name='1687'>
           FRC2=3.8*Ust(I,J)*Ust(I,J)<a name='1688'>
           FRC2 = FRC2 + 0.22*SCLvel*SCLvel<a name='1689'>
           zz_kay = -1.0*ZOL(I,j)<a name='1690'>
           ZLCL_KAY = zz_kay**(2./3.)<a name='1691'>
           ZLCL_KAY = ZLCL_KAY * (1.9*Ust(I,J)*Ust(I,J))<a name='1692'>
           FRC2 = FRC2 + ZLCL_KAY<a name='1693'>
         else<a name='1694'>
           FRC2=3.8*Ust(I,J)*Ust(I,J)<a name='1695'>
         end if <a name='1696'>
<a name='1697'>
          FRC2 = SQRT(FRC2)  <a name='1698'>
          SCLvel =  FRC2  <font color=#447700>! Wsb=new subcloud layer velocity scale for all conditions<a name='1699'></font>
<a name='1700'>
         if(ABE.le.0.0) ABE = 1.0 <a name='1701'>
         TIMEC = TIMEC/((0.03*SCLvel*ABE)**0.3333)<a name='1702'>
<a name='1703'>
<font color=#447700>!ckay: this dynTau is good for the Deep as well as Shallow Cu clouds<a name='1704'></font>
        TIMEC = AMAX1(TADVEC, TIMEC)<a name='1705'>
 <a name='1706'>
         NIC=NINT(TIMEC/DT)<a name='1707'>
         TIMEC=FLOAT(NIC)*DT<a name='1708'>
<font color=#447700>!     <a name='1709'></font>
<font color=#447700>!...COMPUTE WIND SHEAR AND PRECIPITATION EFFICIENCY.<a name='1710'></font>
<font color=#447700>!     <a name='1711'></font>
        IF(WSPD(LTOP).GT.WSPD(KLCL))THEN<a name='1712'>
          SHSIGN=1.<a name='1713'>
        ELSE<a name='1714'>
          SHSIGN=-1.<a name='1715'>
        ENDIF<a name='1716'>
        VWS=(U0(LTOP)-U0(KLCL))*(U0(LTOP)-U0(KLCL))+(V0(LTOP)-V0(KLCL))*   &amp;<a name='1717'>
            (V0(LTOP)-V0(KLCL))<a name='1718'>
        VWS=1.E3*SHSIGN*SQRT(VWS)/(Z0(LTOP)-Z0(LCL))<a name='1719'>
        PEF=1.591+VWS*(-.639+VWS*(9.53E-2-VWS*4.96E-3))<a name='1720'>
        PEF=AMAX1(PEF,.2)<a name='1721'>
        PEF=AMIN1(PEF,.9)<a name='1722'>
<font color=#447700>!     <a name='1723'></font>
<font color=#447700>!...PRECIPITATION EFFICIENCY IS A FUNCTION OF THE HEIGHT OF CLOUD BASE.<a name='1724'></font>
<font color=#447700>!     <a name='1725'></font>
        CBH=(ZLCL-Z0(1))*3.281E-3<a name='1726'>
        IF(CBH.LT.3.)THEN<a name='1727'>
          RCBH=.02<a name='1728'>
        ELSE<a name='1729'>
          RCBH=.96729352+CBH*(-.70034167+CBH*(.162179896+CBH*(-            &amp;<a name='1730'>
               1.2569798E-2+CBH*(4.2772E-4-CBH*5.44E-6))))<a name='1731'>
        ENDIF<a name='1732'>
        IF(CBH.GT.25)RCBH=2.4<a name='1733'>
        PEFCBH=1./(1.+RCBH)<a name='1734'>
        PEFCBH=AMIN1(PEFCBH,.9)<a name='1735'>
<font color=#447700>!     <a name='1736'></font>
<font color=#447700>!... MEAN PEF. IS USED TO COMPUTE RAINFALL.<a name='1737'></font>
<font color=#447700>!     <a name='1738'></font>
        PEFF=.5*(PEF+PEFCBH)<a name='1739'>
        PEFF2 = PEFF                                <font color=#447700>! JSK MODS<a name='1740'></font>
       IF(IPRNT)THEN  <a name='1741'>
<font color=#447700>!         WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS<a name='1742'></font>
         WRITE(message,1035)PEF,PEFCBH,LC,LET,WKL,VWS<a name='1743'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_633">( message )<a name='1744'>
<font color=#447700>!       flush(98)   <a name='1745'></font>
       endif     <a name='1746'>
<font color=#447700>!        WRITE(98,1035)PEF,PEFCBH,LC,LET,WKL,VWS<a name='1747'></font>
<font color=#447700>!*****************************************************************<a name='1748'></font>
<font color=#447700>!                                                                *<a name='1749'></font>
<font color=#447700>!                  COMPUTE DOWNDRAFT PROPERTIES                  *<a name='1750'></font>
<font color=#447700>!                                                                *<a name='1751'></font>
<font color=#447700>!*****************************************************************<a name='1752'></font>
<font color=#447700>!     <a name='1753'></font>
<font color=#447700>!     <a name='1754'></font>
       TDER=0.<a name='1755'>
 devap:IF(ISHALL.EQ.1)THEN<a name='1756'>
         LFS = 1<a name='1757'>
       ELSE<a name='1758'>
<font color=#447700>!<a name='1759'></font>
<font color=#447700>!...start downdraft about 150 mb above cloud base...<a name='1760'></font>
<font color=#447700>!<a name='1761'></font>
<font color=#447700>!        KSTART=MAX0(KPBL,KLCL)<a name='1762'></font>
<font color=#447700>!        KSTART=KPBL                                  ! Changed 7/23/99<a name='1763'></font>
         KSTART=KPBL+1                                <font color=#447700>! Changed 7/23/99<a name='1764'></font>
         KLFS = LET-1<a name='1765'>
         DO NK = KSTART+1,KL<a name='1766'>
           DPPP = P0(KSTART)-P0(NK)<a name='1767'>
<font color=#447700>!          IF(DPPP.GT.200.E2)THEN<a name='1768'></font>
           IF(DPPP.GT.150.E2)THEN<a name='1769'>
             KLFS = NK<a name='1770'>
             EXIT <a name='1771'>
           ENDIF<a name='1772'>
         ENDDO<a name='1773'>
         KLFS = MIN0(KLFS,LET-1)<a name='1774'>
         LFS = KLFS<a name='1775'>
<font color=#447700>!<a name='1776'></font>
<font color=#447700>!...if LFS is not at least 50 mb above cloud base (implying that the <a name='1777'></font>
<font color=#447700>!...level of equil temp, LET, is just above cloud base) do not allow a<a name='1778'></font>
<font color=#447700>!...downdraft...<a name='1779'></font>
<font color=#447700>!<a name='1780'></font>
        IF((P0(KSTART)-P0(LFS)).GT.50.E2)THEN<a name='1781'>
          THETED(LFS) = THETEE(LFS)<a name='1782'>
          QD(LFS) = Q0(LFS)<a name='1783'>
<font color=#447700>!<a name='1784'></font>
<font color=#447700>!...call tpmix2dd to find wet-bulb temp, qv...<a name='1785'></font>
<font color=#447700>!<a name='1786'></font>
          call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_5">(p0(lfs),theted(lfs),tz(lfs),qss,i,j)<a name='1787'>
          THTAD(LFS)=TZ(LFS)*(P00/P0(LFS))**(0.2854*(1.-0.28*QSS))<a name='1788'>
<font color=#447700>!     <a name='1789'></font>
<font color=#447700>!...TAKE A FIRST GUESS AT THE INITIAL DOWNDRAFT MASS FLUX...<a name='1790'></font>
<font color=#447700>!     <a name='1791'></font>
          TVD(LFS)=TZ(LFS)*(1.+0.608*QSS)<a name='1792'>
          RDD=P0(LFS)/(R*TVD(LFS))<a name='1793'>
          A1=(1.-PEFF)*AU0<a name='1794'>
          DMF(LFS)=-A1*RDD<a name='1795'>
          DER(LFS)=DMF(LFS)<a name='1796'>
          DDR(LFS)=0.<a name='1797'>
          RHBAR = RH(LFS)*DP(LFS)<a name='1798'>
          DPTT = DP(LFS)<a name='1799'>
          DO ND = LFS-1,KSTART,-1<a name='1800'>
            ND1 = ND+1<a name='1801'>
            DER(ND)=DER(LFS)*EMS(ND)/EMS(LFS)<a name='1802'>
            DDR(ND)=0.<a name='1803'>
            DMF(ND)=DMF(ND1)+DER(ND)<a name='1804'>
            THETED(ND)=(THETED(ND1)*DMF(ND1)+THETEE(ND)*DER(ND))/DMF(ND)<a name='1805'>
            QD(ND)=(QD(ND1)*DMF(ND1)+Q0(ND)*DER(ND))/DMF(ND)    <a name='1806'>
            DPTT = DPTT+DP(ND)<a name='1807'>
            RHBAR = RHBAR+RH(ND)*DP(ND)<a name='1808'>
          ENDDO<a name='1809'>
          RHBAR = RHBAR/DPTT<a name='1810'>
          DMFFRC = 2.*(1.-RHBAR)    <font color=#447700>! Kain (2004) eq. 11<a name='1811'></font>
          DPDD = 0.<a name='1812'>
<font color=#447700>!...Calculate melting effect<a name='1813'></font>
<font color=#447700>!... first, compute total frozen precipitation generated...<a name='1814'></font>
<font color=#447700>!<a name='1815'></font>
          pptmlt = 0.<a name='1816'>
          DO NK = KLCL,LTOP<a name='1817'>
            PPTMLT = PPTMLT+PPTICE(NK)<a name='1818'>
          ENDDO<a name='1819'>
          if(lc.lt.ml)then<a name='1820'>
<font color=#447700>!...For now, calculate melting effect as if DMF = -UMF at KLCL, i.e., as<a name='1821'></font>
<font color=#447700>!...if DMFFRC=1.  Otherwise, for small DMFFRC, DTMELT gets too large!<a name='1822'></font>
<font color=#447700>!...12/14/98 jsk...<a name='1823'></font>
            DTMELT = RLF*PPTMLT/(CP*UMF(KLCL))<a name='1824'>
          else<a name='1825'>
            DTMELT = 0.<a name='1826'>
          endif<a name='1827'>
          LDT = MIN0(LFS-1,KSTART-1)<a name='1828'>
<font color=#447700>!<a name='1829'></font>
          call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_6">(p0(kstart),theted(kstart),tz(kstart),qss,i,j)<a name='1830'>
<font color=#447700>!<a name='1831'></font>
          tz(kstart) = tz(kstart)-dtmelt<a name='1832'>
          ES=ALIQ*EXP((BLIQ*TZ(KSTART)-CLIQ)/(TZ(KSTART)-DLIQ))<a name='1833'>
          QSS=0.622*ES/(P0(KSTART)-ES)<a name='1834'>
          THETED(KSTART)=TZ(KSTART)*(1.E5/P0(KSTART))**(0.2854*(1.-0.28*QSS))*    &amp;<a name='1835'>
                EXP((3374.6525/TZ(KSTART)-2.5403)*QSS*(1.+0.81*QSS))<a name='1836'>
<font color=#447700>!....  <a name='1837'></font>
          LDT = MIN0(LFS-1,KSTART-1)<a name='1838'>
          DO ND = LDT,1,-1<a name='1839'>
            DPDD = DPDD+DP(ND)<a name='1840'>
            THETED(ND) = THETED(KSTART)<a name='1841'>
            QD(ND)     = QD(KSTART)       <a name='1842'>
<font color=#447700>!<a name='1843'></font>
<font color=#447700>!...call tpmix2dd to find wet bulb temp, saturation mixing ratio...<a name='1844'></font>
<font color=#447700>!<a name='1845'></font>
            call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_7">(p0(nd),theted(nd),tz(nd),qss,i,j)<a name='1846'>
            qsd(nd) = qss<a name='1847'>
<font color=#447700>!<a name='1848'></font>
<font color=#447700>!...specify RH decrease of 20%/km in downdraft...<a name='1849'></font>
<font color=#447700>!<a name='1850'></font>
            RHH = 1.-0.2/1000.*(Z0(KSTART)-Z0(ND))<a name='1851'>
<font color=#447700>!<a name='1852'></font>
<font color=#447700>!...adjust downdraft TEMP, Q to specified RH:<a name='1853'></font>
<font color=#447700>!<a name='1854'></font>
            IF(RHH.LT.1.)THEN<a name='1855'>
              DSSDT=(CLIQ-BLIQ*DLIQ)/((TZ(ND)-DLIQ)*(TZ(ND)-DLIQ))<a name='1856'>
              RL=XLV0-XLV1*TZ(ND)<a name='1857'>
              DTMP=RL*QSS*(1.-RHH)/(CP+RL*RHH*QSS*DSSDT)<a name='1858'>
              T1RH=TZ(ND)+DTMP<a name='1859'>
              ES=RHH*ALIQ*EXP((BLIQ*T1RH-CLIQ)/(T1RH-DLIQ))<a name='1860'>
              QSRH=0.622*ES/(P0(ND)-ES)<a name='1861'>
<font color=#447700>!<a name='1862'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO AT SPECIFIED RH IS LESS THAN ACTUAL<a name='1863'></font>
<font color=#447700>!...MIXING RATIO...IF SO, ADJUST TO GIVE ZERO EVAPORATION...<a name='1864'></font>
<font color=#447700>!<a name='1865'></font>
              IF(QSRH.LT.QD(ND))THEN<a name='1866'>
                QSRH=QD(ND)<a name='1867'>
                T1RH=TZ(ND)+(QSS-QSRH)*RL/CP<a name='1868'>
              ENDIF<a name='1869'>
              TZ(ND)=T1RH<a name='1870'>
              QSS=QSRH<a name='1871'>
              QSD(ND) = QSS<a name='1872'>
            ENDIF         <a name='1873'>
            TVD(nd) = tz(nd)*(1.+0.608*qsd(nd))<a name='1874'>
            IF(TVD(ND).GT.TV0(ND).OR.ND.EQ.1)THEN<a name='1875'>
              LDB=ND<a name='1876'>
              EXIT<a name='1877'>
            ENDIF<a name='1878'>
          ENDDO<a name='1879'>
          IF((P0(LDB)-P0(LFS)) .gt. 50.E2)THEN   <font color=#447700>! minimum Downdraft depth! <a name='1880'></font>
            DO ND=LDT,LDB,-1<a name='1881'>
              ND1 = ND+1<a name='1882'>
              DDR(ND) = -DMF(KSTART)*DP(ND)/DPDD<a name='1883'>
              DER(ND) = 0.<a name='1884'>
              DMF(ND) = DMF(ND1)+DDR(ND)<a name='1885'>
              TDER=TDER+(QSD(nd)-QD(ND))*DDR(ND)<a name='1886'>
              QD(ND)=QSD(nd)<a name='1887'>
              THTAD(ND)=TZ(ND)*(P00/P0(ND))**(0.2854*(1.-0.28*QD(ND)))<a name='1888'>
            ENDDO<a name='1889'>
          ENDIF<a name='1890'>
        ENDIF<a name='1891'>
      ENDIF devap<a name='1892'>
<font color=#447700>!<a name='1893'></font>
<font color=#447700>!...IF DOWNDRAFT DOES NOT EVAPORATE ANY WATER FOR SPECIFIED RELATIVE<a name='1894'></font>
<font color=#447700>!...HUMIDITY, NO DOWNDRAFT IS ALLOWED...<a name='1895'></font>
<font color=#447700>!<a name='1896'></font>
d_mf:   IF(TDER.LT.1.)THEN<a name='1897'>
<font color=#447700>!           WRITE(98,3004)I,J <a name='1898'></font>
<font color=#447700>!3004       FORMAT(' ','No Downdraft!;  I=',I3,2X,'J=',I3,'ISHALL =',I2)<a name='1899'></font>
          PPTFLX=TRPPT<a name='1900'>
          CPR=TRPPT<a name='1901'>
          TDER=0.<a name='1902'>
          CNDTNF=0.<a name='1903'>
          UPDINC=1.<a name='1904'>
          LDB=LFS<a name='1905'>
          DO NDK=1,LTOP<a name='1906'>
            DMF(NDK)=0.<a name='1907'>
            DER(NDK)=0.<a name='1908'>
            DDR(NDK)=0.<a name='1909'>
            THTAD(NDK)=0.<a name='1910'>
            WD(NDK)=0.<a name='1911'>
            TZ(NDK)=0.<a name='1912'>
            QD(NDK)=0.<a name='1913'>
          ENDDO<a name='1914'>
          AINCM2=100.<a name='1915'>
        ELSE <a name='1916'>
          DDINC = -DMFFRC*UMF(KLCL)/DMF(KSTART)<a name='1917'>
          UPDINC=1.<a name='1918'>
          IF(TDER*DDINC.GT.TRPPT)THEN<a name='1919'>
            DDINC = TRPPT/TDER<a name='1920'>
          ENDIF<a name='1921'>
          TDER = TDER*DDINC<a name='1922'>
          DO NK=LDB,LFS<a name='1923'>
            DMF(NK)=DMF(NK)*DDINC<a name='1924'>
            DER(NK)=DER(NK)*DDINC<a name='1925'>
            DDR(NK)=DDR(NK)*DDINC<a name='1926'>
          ENDDO<a name='1927'>
         CPR=TRPPT<a name='1928'>
         PPTFLX = TRPPT-TDER<a name='1929'>
         PEFF=PPTFLX/TRPPT<a name='1930'>
         IF(IPRNT)THEN<a name='1931'>
<font color=#447700>!           write(98,*)'PRECIP EFFICIENCY =',PEFF<a name='1932'></font>
           write(message,*)'PRECIP EFFICIENCY =',PEFF<a name='1933'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_634">(message)<a name='1934'>
<font color=#447700>!          flush(98)   <a name='1935'></font>
         ENDIF<a name='1936'>
<font color=#447700>!<a name='1937'></font>
<font color=#447700>!<a name='1938'></font>
<font color=#447700>!...ADJUST UPDRAFT MASS FLUX, MASS DETRAINMENT RATE, AND LIQUID WATER AN<a name='1939'></font>
<font color=#447700>!   DETRAINMENT RATES TO BE CONSISTENT WITH THE TRANSFER OF THE ESTIMATE<a name='1940'></font>
<font color=#447700>!   FROM THE UPDRAFT TO THE DOWNDRAFT AT THE LFS...<a name='1941'></font>
<font color=#447700>!     <a name='1942'></font>
<font color=#447700>!         DO NK=LC,LFS<a name='1943'></font>
<font color=#447700>!           UMF(NK)=UMF(NK)*UPDINC<a name='1944'></font>
<font color=#447700>!           UDR(NK)=UDR(NK)*UPDINC<a name='1945'></font>
<font color=#447700>!           UER(NK)=UER(NK)*UPDINC<a name='1946'></font>
<font color=#447700>!           PPTLIQ(NK)=PPTLIQ(NK)*UPDINC<a name='1947'></font>
<font color=#447700>!           PPTICE(NK)=PPTICE(NK)*UPDINC<a name='1948'></font>
<font color=#447700>!           DETLQ(NK)=DETLQ(NK)*UPDINC<a name='1949'></font>
<font color=#447700>!           DETIC(NK)=DETIC(NK)*UPDINC<a name='1950'></font>
<font color=#447700>!         ENDDO<a name='1951'></font>
<font color=#447700>!     <a name='1952'></font>
<font color=#447700>!...ZERO OUT THE ARRAYS FOR DOWNDRAFT DATA AT LEVELS ABOVE AND BELOW THE<a name='1953'></font>
<font color=#447700>!...DOWNDRAFT...<a name='1954'></font>
<font color=#447700>!     <a name='1955'></font>
         IF(LDB.GT.1)THEN<a name='1956'>
           DO NK=1,LDB-1<a name='1957'>
             DMF(NK)=0.<a name='1958'>
             DER(NK)=0.<a name='1959'>
             DDR(NK)=0.<a name='1960'>
             WD(NK)=0.<a name='1961'>
             TZ(NK)=0.<a name='1962'>
             QD(NK)=0.<a name='1963'>
             THTAD(NK)=0.<a name='1964'>
           ENDDO<a name='1965'>
         ENDIF<a name='1966'>
         DO NK=LFS+1,KX<a name='1967'>
           DMF(NK)=0.<a name='1968'>
           DER(NK)=0.<a name='1969'>
           DDR(NK)=0.<a name='1970'>
           WD(NK)=0.<a name='1971'>
           TZ(NK)=0.<a name='1972'>
           QD(NK)=0.<a name='1973'>
           THTAD(NK)=0.<a name='1974'>
         ENDDO<a name='1975'>
         DO NK=LDT+1,LFS-1<a name='1976'>
           TZ(NK)=0.<a name='1977'>
           QD(NK)=0.<a name='1978'>
           THTAD(NK)=0.<a name='1979'>
         ENDDO<a name='1980'>
       ENDIF d_mf<a name='1981'>
<font color=#447700>!<a name='1982'></font>
<font color=#447700>!...SET LIMITS ON THE UPDRAFT AND DOWNDRAFT MASS FLUXES SO THAT THE INFLOW<a name='1983'></font>
<font color=#447700>!   INTO CONVECTIVE DRAFTS FROM A GIVEN LAYER IS NO MORE THAN IS AVAILABLE<a name='1984'></font>
<font color=#447700>!   IN THAT LAYER INITIALLY...<a name='1985'></font>
<font color=#447700>!     <a name='1986'></font>
       AINCMX=1000.<a name='1987'>
       LMAX=MAX0(KLCL,LFS)<a name='1988'>
       DO NK=LC,LMAX<a name='1989'>
         IF((UER(NK)-DER(NK)).GT.1.e-3)THEN<a name='1990'>
           AINCM1=EMS(NK)/((UER(NK)-DER(NK))*TIMEC)<a name='1991'>
           AINCMX=AMIN1(AINCMX,AINCM1)<a name='1992'>
         ENDIF<a name='1993'>
       ENDDO<a name='1994'>
       AINC=1.<a name='1995'>
       IF(AINCMX.LT.AINC)AINC=AINCMX<a name='1996'>
<font color=#447700>!     <a name='1997'></font>
<font color=#447700>!...SAVE THE RELEVENT VARIABLES FOR A UNIT UPDRAFT AND DOWNDRAFT...THEY WILL <a name='1998'></font>
<font color=#447700>!...BE ITERATIVELY ADJUSTED BY THE FACTOR AINC TO SATISFY THE STABILIZATION<a name='1999'></font>
<font color=#447700>!...CLOSURE...<a name='2000'></font>
<font color=#447700>!     <a name='2001'></font>
       TDER2=TDER<a name='2002'>
       PPTFL2=PPTFLX<a name='2003'>
       DO NK=1,LTOP<a name='2004'>
         DETLQ2(NK)=DETLQ(NK)<a name='2005'>
         DETIC2(NK)=DETIC(NK)<a name='2006'>
         UDR2(NK)=UDR(NK)<a name='2007'>
         UER2(NK)=UER(NK)<a name='2008'>
         DDR2(NK)=DDR(NK)<a name='2009'>
         DER2(NK)=DER(NK)<a name='2010'>
         UMF2(NK)=UMF(NK)<a name='2011'>
         DMF2(NK)=DMF(NK)<a name='2012'>
       ENDDO<a name='2013'>
       FABE=1.<a name='2014'>
       STAB=0.95<a name='2015'>
       NOITR=0<a name='2016'>
       ISTOP=0<a name='2017'>
<font color=#447700>!<a name='2018'></font>
        IF(ISHALL.EQ.1)THEN                              <font color=#447700>! First for shallow convection<a name='2019'></font>
<font color=#447700>!<a name='2020'></font>
<font color=#447700>! No iteration for shallow convection; if turbulent kinetic energy (TKE) is available<a name='2021'></font>
<font color=#447700>! from a turbulence parameterization, scale cloud-base updraft mass flux as a function<a name='2022'></font>
<font color=#447700>! of TKE, but for now, just specify shallow-cloud mass flux using TKEMAX = 5...<a name='2023'></font>
<font color=#447700>!<a name='2024'></font>
<font color=#447700>!...find the maximum TKE value between LC and KLCL...<a name='2025'></font>
<font color=#447700>!         TKEMAX = 0.<a name='2026'></font>
          TKEMAX = 5.<a name='2027'>
<font color=#447700>!          DO 173 K = LC,KLCL<a name='2028'></font>
<font color=#447700>!            NK = KX-K+1<a name='2029'></font>
<font color=#447700>!            TKEMAX = AMAX1(TKEMAX,Q2(I,J,NK))<a name='2030'></font>
<font color=#447700>! 173      CONTINUE<a name='2031'></font>
<font color=#447700>!          TKEMAX = AMIN1(TKEMAX,10.)<a name='2032'></font>
<font color=#447700>!          TKEMAX = AMAX1(TKEMAX,5.)<a name='2033'></font>
<font color=#447700>!c         TKEMAX = 10.<a name='2034'></font>
<font color=#447700>!c...3_24_99...DPMIN was changed for shallow convection so that it is the<a name='2035'></font>
<font color=#447700>!c...          the same as for deep convection (5.E3).  Since this doubles<a name='2036'></font>
<font color=#447700>!c...          (roughly) the value of DPTHMX, add a factor of 0.5 to calcu-<a name='2037'></font>
<font color=#447700>!c...          lation of EVAC...<a name='2038'></font>
<font color=#447700>!c         EVAC  = TKEMAX*0.1<a name='2039'></font>
          EVAC  = 0.5*TKEMAX*0.1<a name='2040'>
<font color=#447700>!         AINC = 0.1*DPTHMX*DXIJ*DXIJ/(VMFLCL*G*TIMEC)<a name='2041'></font>
<font color=#447700>!          AINC = EVAC*DPTHMX*DX(I,J)*DX(I,J)/(VMFLCL*G*TIMEC)<a name='2042'></font>
          AINC = EVAC*DPTHMX*DXSQ/(VMFLCL*G*TIMEC)<a name='2043'>
          TDER=TDER2*AINC<a name='2044'>
          PPTFLX=PPTFL2*AINC<a name='2045'>
          DO NK=1,LTOP<a name='2046'>
            UMF(NK)=UMF2(NK)*AINC<a name='2047'>
            DMF(NK)=DMF2(NK)*AINC<a name='2048'>
            DETLQ(NK)=DETLQ2(NK)*AINC<a name='2049'>
            DETIC(NK)=DETIC2(NK)*AINC<a name='2050'>
            UDR(NK)=UDR2(NK)*AINC<a name='2051'>
            UER(NK)=UER2(NK)*AINC<a name='2052'>
            DER(NK)=DER2(NK)*AINC<a name='2053'>
            DDR(NK)=DDR2(NK)*AINC<a name='2054'>
          ENDDO<a name='2055'>
        ENDIF                                           <font color=#447700>! Otherwise for deep convection<a name='2056'></font>
<font color=#447700>! use iterative procedure to find mass fluxes...<a name='2057'></font>
iter:     DO NCOUNT=1,10<a name='2058'>
<font color=#447700>!     <a name='2059'></font>
<font color=#447700>!*****************************************************************<a name='2060'></font>
<font color=#447700>!                                                                *<a name='2061'></font>
<font color=#447700>!           COMPUTE PROPERTIES FOR COMPENSATIONAL SUBSIDENCE     *<a name='2062'></font>
<font color=#447700>!                                                                *<a name='2063'></font>
<font color=#447700>!*****************************************************************<a name='2064'></font>
<font color=#447700>!     <a name='2065'></font>
<font color=#447700>!...DETERMINE OMEGA VALUE NECESSARY AT TOP AND BOTTOM OF EACH LAYER TO<a name='2066'></font>
<font color=#447700>!...SATISFY MASS CONTINUITY...<a name='2067'></font>
<font color=#447700>!     <a name='2068'></font>
            DTT=TIMEC<a name='2069'>
            DO NK=1,LTOP<a name='2070'>
              DOMGDP(NK)=-(UER(NK)-DER(NK)-UDR(NK)-DDR(NK))*EMSD(NK)<a name='2071'>
              IF(NK.GT.1)THEN<a name='2072'>
                OMG(NK)=OMG(NK-1)-DP(NK-1)*DOMGDP(NK-1)<a name='2073'>
                ABSOMG = ABS(OMG(NK))<a name='2074'>
                ABSOMGTC = ABSOMG*TIMEC<a name='2075'>
                FRDP = 0.75*DP(NK-1)<a name='2076'>
                IF(ABSOMGTC.GT.FRDP)THEN<a name='2077'>
                  DTT1 = FRDP/ABSOMG<a name='2078'>
                  DTT=AMIN1(DTT,DTT1)<a name='2079'>
                ENDIF<a name='2080'>
              ENDIF<a name='2081'>
            ENDDO<a name='2082'>
            DO NK=1,LTOP<a name='2083'>
              THPA(NK)=THTA0(NK)<a name='2084'>
              QPA(NK)=Q0(NK)<a name='2085'>
              NSTEP=NINT(TIMEC/DTT+1)<a name='2086'>
              DTIME=TIMEC/FLOAT(NSTEP)<a name='2087'>
              FXM(NK)=OMG(NK)*DXSQ/G<a name='2088'>
            ENDDO<a name='2089'>
<font color=#447700>!     <a name='2090'></font>
<font color=#447700>!...DO AN UPSTREAM/FORWARD-IN-TIME ADVECTION OF THETA, QV...<a name='2091'></font>
<font color=#447700>!     <a name='2092'></font>
        DO NTC=1,NSTEP<a name='2093'>
<font color=#447700>!     <a name='2094'></font>
<font color=#447700>!...ASSIGN THETA AND Q VALUES AT THE TOP AND BOTTOM OF EACH LAYER BASED ON<a name='2095'></font>
<font color=#447700>!...SIGN OF OMEGA...<a name='2096'></font>
<font color=#447700>!     <a name='2097'></font>
            DO  NK=1,LTOP<a name='2098'>
              THFXIN(NK)=0.<a name='2099'>
              THFXOUT(NK)=0.<a name='2100'>
              QFXIN(NK)=0.<a name='2101'>
              QFXOUT(NK)=0.<a name='2102'>
            ENDDO<a name='2103'>
            DO NK=2,LTOP<a name='2104'>
              IF(OMG(NK).LE.0.)THEN<a name='2105'>
                THFXIN(NK)=-FXM(NK)*THPA(NK-1)<a name='2106'>
                QFXIN(NK)=-FXM(NK)*QPA(NK-1)<a name='2107'>
                THFXOUT(NK-1)=THFXOUT(NK-1)+THFXIN(NK)<a name='2108'>
                QFXOUT(NK-1)=QFXOUT(NK-1)+QFXIN(NK)<a name='2109'>
              ELSE<a name='2110'>
                THFXOUT(NK)=FXM(NK)*THPA(NK)<a name='2111'>
                QFXOUT(NK)=FXM(NK)*QPA(NK)<a name='2112'>
                THFXIN(NK-1)=THFXIN(NK-1)+THFXOUT(NK)<a name='2113'>
                QFXIN(NK-1)=QFXIN(NK-1)+QFXOUT(NK)<a name='2114'>
              ENDIF<a name='2115'>
            ENDDO<a name='2116'>
<font color=#447700>!     <a name='2117'></font>
<font color=#447700>!...UPDATE THE THETA AND QV VALUES AT EACH LEVEL...<a name='2118'></font>
<font color=#447700>!     <a name='2119'></font>
            DO NK=1,LTOP<a name='2120'>
              THPA(NK)=THPA(NK)+(THFXIN(NK)+UDR(NK)*THTAU(NK)+DDR(NK)*      &amp;<a name='2121'>
                       THTAD(NK)-THFXOUT(NK)-(UER(NK)-DER(NK))*THTA0(NK))*  &amp;<a name='2122'>
                       DTIME*EMSD(NK)<a name='2123'>
              QPA(NK)=QPA(NK)+(QFXIN(NK)+UDR(NK)*QDT(NK)+DDR(NK)*QD(NK)-    &amp;<a name='2124'>
                      QFXOUT(NK)-(UER(NK)-DER(NK))*Q0(NK))*DTIME*EMSD(NK)<a name='2125'>
            ENDDO   <a name='2126'>
          ENDDO   <a name='2127'>
          DO NK=1,LTOP<a name='2128'>
            THTAG(NK)=THPA(NK)<a name='2129'>
            QG(NK)=QPA(NK)<a name='2130'>
          ENDDO<a name='2131'>
<font color=#447700>!     <a name='2132'></font>
<font color=#447700>!...CHECK TO SEE IF MIXING RATIO DIPS BELOW ZERO ANYWHERE;  IF SO, BORROW<a name='2133'></font>
<font color=#447700>!...MOISTURE FROM ADJACENT LAYERS TO BRING IT BACK UP ABOVE ZERO...<a name='2134'></font>
<font color=#447700>!     <a name='2135'></font>
        DO NK=1,LTOP<a name='2136'>
          IF(QG(NK).LT.0.)THEN<a name='2137'>
            IF(NK.EQ.1)THEN                             <font color=#447700>! JSK MODS<a name='2138'></font>
<font color=#447700>!              PRINT *,' PROBLEM WITH KF SCHEME:  ' ! JSK MODS<a name='2139'></font>
<font color=#447700>!              PRINT *,'QG = 0 AT THE SURFACE!!!!!!!'    ! JSK MODS<a name='2140'></font>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_614"> ( 'QG, QG(NK).LT.0') <font color=#447700>! JSK MODS<a name='2141'></font>
            ENDIF                                       <font color=#447700>! JSK MODS<a name='2142'></font>
            NK1=NK+1<a name='2143'>
            IF(NK.EQ.LTOP)THEN<a name='2144'>
              NK1=KLCL<a name='2145'>
            ENDIF<a name='2146'>
            TMA=QG(NK1)*EMS(NK1)<a name='2147'>
            TMB=QG(NK-1)*EMS(NK-1)<a name='2148'>
            TMM=(QG(NK)-1.E-9)*EMS(NK  )<a name='2149'>
            BCOEFF=-TMM/((TMA*TMA)/TMB+TMB)<a name='2150'>
            ACOEFF=BCOEFF*TMA/TMB<a name='2151'>
            TMB=TMB*(1.-BCOEFF)<a name='2152'>
            TMA=TMA*(1.-ACOEFF)<a name='2153'>
            IF(NK.EQ.LTOP)THEN<a name='2154'>
              QVDIFF=(QG(NK1)-TMA*EMSD(NK1))*100./QG(NK1)<a name='2155'>
<font color=#447700>!              IF(ABS(QVDIFF).GT.1.)THEN<a name='2156'></font>
<font color=#447700>!             PRINT *,'!!!WARNING!!! CLOUD BASE WATER VAPOR CHANGES BY ',     &amp;<a name='2157'></font>
<font color=#447700>!                      QVDIFF,                                                &amp;<a name='2158'></font>
<font color=#447700>!                     '% WHEN MOISTURE IS BORROWED TO PREVENT NEGATIVE ',     &amp;<a name='2159'></font>
<font color=#447700>!                     'VALUES IN KAIN-FRITSCH'<a name='2160'></font>
<font color=#447700>!              ENDIF<a name='2161'></font>
            ENDIF<a name='2162'>
            QG(NK)=1.E-9<a name='2163'>
            QG(NK1)=TMA*EMSD(NK1)<a name='2164'>
            QG(NK-1)=TMB*EMSD(NK-1)<a name='2165'>
          ENDIF<a name='2166'>
        ENDDO<a name='2167'>
        TOPOMG=(UDR(LTOP)-UER(LTOP))*DP(LTOP)*EMSD(LTOP)<a name='2168'>
        IF(ABS(TOPOMG-OMG(LTOP)).GT.1.E-3)THEN<a name='2169'>
<font color=#447700>!       WRITE(99,*)'ERROR:  MASS DOES NOT BALANCE IN KF SCHEME;            &amp;<a name='2170'></font>
<font color=#447700>!      TOPOMG, OMG =',TOPOMG,OMG(LTOP)<a name='2171'></font>
<font color=#447700>!      TOPOMG, OMG =',TOPOMG,OMG(LTOP)<a name='2172'></font>
          ISTOP=1<a name='2173'>
          IPRNT=.TRUE.<a name='2174'>
          EXIT iter<a name='2175'>
        ENDIF<a name='2176'>
<font color=#447700>!     <a name='2177'></font>
<font color=#447700>!...CONVERT THETA TO T...<a name='2178'></font>
<font color=#447700>!     <a name='2179'></font>
        DO NK=1,LTOP<a name='2180'>
          EXN(NK)=(P00/P0(NK))**(0.2854*(1.-0.28*QG(NK)))<a name='2181'>
          TG(NK)=THTAG(NK)/EXN(NK)<a name='2182'>
          TVG(NK)=TG(NK)*(1.+0.608*QG(NK))<a name='2183'>
        ENDDO<a name='2184'>
        IF(ISHALL.EQ.1)THEN<a name='2185'>
          EXIT iter<a name='2186'>
        ENDIF<a name='2187'>
<font color=#447700>!     <a name='2188'></font>
<font color=#447700>!*******************************************************************<a name='2189'></font>
<font color=#447700>!                                                                  *<a name='2190'></font>
<font color=#447700>!     COMPUTE NEW CLOUD AND CHANGE IN AVAILABLE BUOYANT ENERGY.    *<a name='2191'></font>
<font color=#447700>!                                                                  *<a name='2192'></font>
<font color=#447700>!*******************************************************************<a name='2193'></font>
<font color=#447700>!     <a name='2194'></font>
<font color=#447700>!...THE FOLLOWING COMPUTATIONS ARE SIMILAR TO THAT FOR UPDRAFT<a name='2195'></font>
<font color=#447700>!     <a name='2196'></font>
<font color=#447700>!        THMIX=0.<a name='2197'></font>
          TMIX=0.<a name='2198'>
          QMIX=0.<a name='2199'>
<font color=#447700>!<a name='2200'></font>
<font color=#447700>!...FIND THE THERMODYNAMIC CHARACTERISTICS OF THE LAYER BY<a name='2201'></font>
<font color=#447700>!...MASS-WEIGHTING THE CHARACTERISTICS OF THE INDIVIDUAL MODEL<a name='2202'></font>
<font color=#447700>!...LAYERS...<a name='2203'></font>
<font color=#447700>!<a name='2204'></font>
          DO NK=LC,KPBL<a name='2205'>
            TMIX=TMIX+DP(NK)*TG(NK)<a name='2206'>
            QMIX=QMIX+DP(NK)*QG(NK)  <a name='2207'>
          ENDDO<a name='2208'>
          TMIX=TMIX/DPTHMX<a name='2209'>
          QMIX=QMIX/DPTHMX<a name='2210'>
          ES=ALIQ*EXP((TMIX*BLIQ-CLIQ)/(TMIX-DLIQ))<a name='2211'>
          QSS=0.622*ES/(PMIX-ES)<a name='2212'>
<font color=#447700>!     <a name='2213'></font>
<font color=#447700>!...REMOVE SUPERSATURATION FOR DIAGNOSTIC PURPOSES, IF NECESSARY...<a name='2214'></font>
<font color=#447700>!     <a name='2215'></font>
          IF(QMIX.GT.QSS)THEN<a name='2216'>
            RL=XLV0-XLV1*TMIX<a name='2217'>
            CPM=CP*(1.+0.887*QMIX)<a name='2218'>
            DSSDT=QSS*(CLIQ-BLIQ*DLIQ)/((TMIX-DLIQ)*(TMIX-DLIQ))<a name='2219'>
            DQ=(QMIX-QSS)/(1.+RL*DSSDT/CPM)<a name='2220'>
            TMIX=TMIX+RL/CP*DQ<a name='2221'>
            QMIX=QMIX-DQ<a name='2222'>
            TLCL=TMIX<a name='2223'>
          ELSE<a name='2224'>
            QMIX=AMAX1(QMIX,0.)<a name='2225'>
            EMIX=QMIX*PMIX/(0.622+QMIX)<a name='2226'>
            astrt=1.e-3<a name='2227'>
            binc=0.075<a name='2228'>
            a1=emix/aliq<a name='2229'>
            tp=(a1-astrt)/binc<a name='2230'>
            indlu=int(tp)+1<a name='2231'>
            value=(indlu-1)*binc+astrt<a name='2232'>
            aintrp=(a1-value)/binc<a name='2233'>
            tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='2234'>
            TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)<a name='2235'>
            TLCL=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(TMIX-T00))*(TMIX-TDPT)<a name='2236'>
            TLCL=AMIN1(TLCL,TMIX)<a name='2237'>
          ENDIF<a name='2238'>
          TVLCL=TLCL*(1.+0.608*QMIX)<a name='2239'>
          ZLCL = ZMIX+(TLCL-TMIX)/GDRY<a name='2240'>
          DO NK = LC,KL<a name='2241'>
            KLCL=NK<a name='2242'>
            IF(ZLCL.LE.Z0(NK))THEN<a name='2243'>
              EXIT <a name='2244'>
            ENDIF<a name='2245'>
          ENDDO<a name='2246'>
          K=KLCL-1<a name='2247'>
          DLP=(ZLCL-Z0(K))/(Z0(KLCL)-Z0(K))<a name='2248'>
<font color=#447700>!     <a name='2249'></font>
<font color=#447700>!...ESTIMATE ENVIRONMENTAL TEMPERATURE AND MIXING RATIO AT THE LCL...<a name='2250'></font>
<font color=#447700>!     <a name='2251'></font>
          TENV=TG(K)+(TG(KLCL)-TG(K))*DLP<a name='2252'>
          QENV=QG(K)+(QG(KLCL)-QG(K))*DLP<a name='2253'>
          TVEN=TENV*(1.+0.608*QENV)<a name='2254'>
          PLCL=P0(K)+(P0(KLCL)-P0(K))*DLP<a name='2255'>
          THETEU(K)=TMIX*(1.E5/PMIX)**(0.2854*(1.-0.28*QMIX))*             &amp;<a name='2256'>
                  EXP((3374.6525/TLCL-2.5403)*QMIX*(1.+0.81*QMIX))<a name='2257'>
<font color=#447700>!     <a name='2258'></font>
<font color=#447700>!...COMPUTE ADJUSTED ABE(ABEG).<a name='2259'></font>
<font color=#447700>!     <a name='2260'></font>
          ABEG=0.<a name='2261'>
          DO NK=K,LTOPM1<a name='2262'>
            NK1=NK+1<a name='2263'>
            THETEU(NK1) = THETEU(NK)<a name='2264'>
<font color=#447700>!<a name='2265'></font>
            call <A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD'>tpmix2dd</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TPMIX2DD_8">(p0(nk1),theteu(nk1),tgu(nk1),qgu(nk1),i,j)<a name='2266'>
<font color=#447700>!<a name='2267'></font>
            TVQU(NK1)=TGU(NK1)*(1.+0.608*QGU(NK1)-QLIQ(NK1)-QICE(NK1))<a name='2268'>
            IF(NK.EQ.K)THEN<a name='2269'>
              DZZ=Z0(KLCL)-ZLCL<a name='2270'>
              DILBE=((TVLCL+TVQU(NK1))/(TVEN+TVG(NK1))-1.)*DZZ<a name='2271'>
            ELSE<a name='2272'>
              DZZ=DZA(NK)<a name='2273'>
              DILBE=((TVQU(NK)+TVQU(NK1))/(TVG(NK)+TVG(NK1))-1.)*DZZ<a name='2274'>
            ENDIF<a name='2275'>
            IF(DILBE.GT.0.)ABEG=ABEG+DILBE*G<a name='2276'>
<font color=#447700>!<a name='2277'></font>
<font color=#447700>!...DILUTE BY ENTRAINMENT BY THE RATE AS ORIGINAL UPDRAFT...<a name='2278'></font>
<font color=#447700>!<a name='2279'></font>
            CALL <A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT'>ENVIRTHT</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ENVIRTHT_12">(P0(NK1),TG(NK1),QG(NK1),THTEEG(NK1),ALIQ,BLIQ,CLIQ,DLIQ)<a name='2280'>
            THETEU(NK1)=THETEU(NK1)*DDILFRC(NK1)+THTEEG(NK1)*(1.-DDILFRC(NK1))<a name='2281'>
          ENDDO<a name='2282'>
<font color=#447700>!     <a name='2283'></font>
<font color=#447700>!...ASSUME AT LEAST 90% OF CAPE (ABE) IS REMOVED BY CONVECTION DURING<a name='2284'></font>
<font color=#447700>!...THE PERIOD TIMEC...<a name='2285'></font>
<font color=#447700>!     <a name='2286'></font>
          IF(NOITR.EQ.1)THEN<a name='2287'>
<font color=#447700>!         write(98,*)' '<a name='2288'></font>
<font color=#447700>!         write(98,*)'TAU, I, J, =',NTSD,I,J<a name='2289'></font>
<font color=#447700>!         WRITE(98,1060)FABE<a name='2290'></font>
<font color=#447700>!          GOTO 265<a name='2291'></font>
          EXIT iter<a name='2292'>
          ENDIF<a name='2293'>
          DABE=AMAX1(ABE-ABEG,capeDX*ABE)<a name='2294'>
<a name='2295'>
          FABE=ABEG/ABE<a name='2296'>
          IF(FABE.GT.1. .and. ISHALL.EQ.0)THEN<a name='2297'>
<font color=#447700>!          WRITE(98,*)'UPDRAFT/DOWNDRAFT COUPLET INCREASES CAPE AT THIS<a name='2298'></font>
<font color=#447700>!     *GRID POINT; NO CONVECTION ALLOWED!'<a name='2299'></font>
            RETURN  <a name='2300'>
          ENDIF<a name='2301'>
          IF(NCOUNT.NE.1)THEN<a name='2302'>
            IF(ABS(AINC-AINCOLD).LT.0.0001)THEN<a name='2303'>
              NOITR=1<a name='2304'>
              AINC=AINCOLD<a name='2305'>
              CYCLE iter<a name='2306'>
            ENDIF<a name='2307'>
            DFDA=(FABE-FABEOLD)/(AINC-AINCOLD)<a name='2308'>
            IF(DFDA.GT.0.)THEN<a name='2309'>
              NOITR=1<a name='2310'>
              AINC=AINCOLD<a name='2311'>
              CYCLE iter<a name='2312'>
            ENDIF<a name='2313'>
          ENDIF<a name='2314'>
          AINCOLD=AINC<a name='2315'>
          FABEOLD=FABE<a name='2316'>
          IF(AINC/AINCMX.GT.0.999.AND.FABE.GT.1.05-STAB)THEN<a name='2317'>
<font color=#447700>!           write(98,*)' '<a name='2318'></font>
<font color=#447700>!           write(98,*)'TAU, I, J, =',NTSD,I,J<a name='2319'></font>
<font color=#447700>!           WRITE(98,1055)FABE<a name='2320'></font>
<font color=#447700>!            GOTO 265<a name='2321'></font>
            EXIT<a name='2322'>
          ENDIF<a name='2323'>
          IF((FABE.LE.1.05-STAB.AND.FABE.GE.0.95-STAB) .or. NCOUNT.EQ.10)THEN<a name='2324'>
            EXIT iter<a name='2325'>
          ELSE<a name='2326'>
            IF(NCOUNT.GT.10)THEN<a name='2327'>
<font color=#447700>!             write(98,*)' '<a name='2328'></font>
<font color=#447700>!             write(98,*)'TAU, I, J, =',NTSD,I,J<a name='2329'></font>
<font color=#447700>!             WRITE(98,1060)FABE<a name='2330'></font>
<font color=#447700>!             GOTO 265<a name='2331'></font>
              EXIT<a name='2332'>
            ENDIF<a name='2333'>
<font color=#447700>!     <a name='2334'></font>
<font color=#447700>!...IF MORE THAN 10% OF THE ORIGINAL CAPE REMAINS, INCREASE THE CONVECTIVE<a name='2335'></font>
<font color=#447700>!...MASS FLUX BY THE FACTOR AINC:<a name='2336'></font>
<font color=#447700>!     <a name='2337'></font>
            IF(FABE.EQ.0.)THEN<a name='2338'>
              AINC=AINC*0.5<a name='2339'>
            ELSE<a name='2340'>
              IF(DABE.LT.1.e-4)THEN<a name='2341'>
                NOITR=1<a name='2342'>
                AINC=AINCOLD<a name='2343'>
                CYCLE iter<a name='2344'>
              ELSE<a name='2345'>
                AINC=AINC*STAB*ABE/DABE<a name='2346'>
              ENDIF<a name='2347'>
            ENDIF<a name='2348'>
<font color=#447700>!           AINC=AMIN1(AINCMX,AINC)<a name='2349'></font>
            AINC=AMIN1(AINCMX,AINC)<a name='2350'>
<font color=#447700>!...IF AINC BECOMES VERY SMALL, EFFECTS OF CONVECTION ! JSK MODS<a name='2351'></font>
<font color=#447700>!...WILL BE MINIMAL SO JUST IGNORE IT...              ! JSK MODS<a name='2352'></font>
            IF(AINC.LT.0.05)then<a name='2353'>
              RETURN                          <font color=#447700>! JSK MODS<a name='2354'></font>
            ENDIF<a name='2355'>
<font color=#447700>!            AINC=AMAX1(AINC,0.05)                        ! JSK MODS<a name='2356'></font>
            TDER=TDER2*AINC<a name='2357'>
            PPTFLX=PPTFL2*AINC<a name='2358'>
<font color=#447700>!           IF (XTIME.LT.10.)THEN<a name='2359'></font>
<font color=#447700>!           WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,<a name='2360'></font>
<font color=#447700>!          *              FABEOLD,AINCOLD <a name='2361'></font>
<font color=#447700>!           ENDIF<a name='2362'></font>
            DO NK=1,LTOP<a name='2363'>
              UMF(NK)=UMF2(NK)*AINC<a name='2364'>
              DMF(NK)=DMF2(NK)*AINC<a name='2365'>
              DETLQ(NK)=DETLQ2(NK)*AINC<a name='2366'>
              DETIC(NK)=DETIC2(NK)*AINC<a name='2367'>
              UDR(NK)=UDR2(NK)*AINC<a name='2368'>
              UER(NK)=UER2(NK)*AINC<a name='2369'>
              DER(NK)=DER2(NK)*AINC<a name='2370'>
              DDR(NK)=DDR2(NK)*AINC<a name='2371'>
            ENDDO<a name='2372'>
<font color=#447700>!     <a name='2373'></font>
<font color=#447700>!...GO BACK UP FOR ANOTHER ITERATION...<a name='2374'></font>
<font color=#447700>!     <a name='2375'></font>
          ENDIF<a name='2376'>
        ENDDO iter<a name='2377'>
<a name='2378'>
<font color=#447700>!ckay<a name='2379'></font>
<font color=#447700>! get the cloud fraction for layer NK+1=NK1<a name='2380'></font>
            updil = (100.-AINC)<a name='2381'>
            updil = updil/100.<a name='2382'>
            updil = updil*dxsq  <a name='2383'>
            Drag = 0.5   <a name='2384'>
<a name='2385'>
        IF(ISHALL.EQ.1) THEN<a name='2386'>
          DO NK=KLCL, LTOP<a name='2387'>
            UMF_new = UMF(NK)/updil<a name='2388'>
            denSplume = P0(NK)/(R*TU(NK))<a name='2389'>
            xcldfra = 0.07*alog(1.+(500.*UMF_new))<a name='2390'>
            xcldfra = amax1(0.01,xcldfra)<a name='2391'>
            cldfra_sh_KF(I,NK,J) = amin1(0.2,xcldfra)<a name='2392'>
<font color=#447700>!ckaywup<a name='2393'></font>
            DMF_new=DMF(NK)/updil<a name='2394'>
            FXM_new=FXM(NK)/dxsq<a name='2395'>
<font color=#447700>!           w_up(I,NK,J) = (UMF_new+DMF_new-FXM_new)/denSplume<a name='2396'></font>
<font color=#447700>!           w_up(I,NK,J) = w_up(I,NK,J)*Drag*DT/TIMEC<a name='2397'></font>
           w_up(I,NK,J) = (UMF_new/denSplume)*Drag*DT/TIMEC<a name='2398'>
          ENDDO<a name='2399'>
        ELSE <a name='2400'>
          DO NK=KLCL, LTOP<a name='2401'>
<font color=#447700>! ww: moved the next line up<a name='2402'></font>
            UMF_new = UMF(NK)/updil<a name='2403'>
            denSplume = P0(NK)/(R*TU(NK))<a name='2404'>
            xcldfra = 0.14*alog(1.+(500.*UMF_new))<a name='2405'>
            xcldfra = amax1(0.01,xcldfra)<a name='2406'>
            cldfra_dp_KF(I,NK,J) = amin1(0.6,xcldfra)<a name='2407'>
<font color=#447700>!new added downdraft impact<a name='2408'></font>
            DMF_new = DMF(NK)/updil<a name='2409'>
            FXM_new = FXM(NK)/dxsq<a name='2410'>
<font color=#447700>!           w_up(I,NK,J) = (UMF_new+DMF_new-FXM_new)/denSplume<a name='2411'></font>
<font color=#447700>!           w_up(I,NK,J) = w_up(I,NK,J)*Drag*DT/TIMEC<a name='2412'></font>
           w_up(I,NK,J) = (UMF_new/denSplume)*Drag*DT/TIMEC<a name='2413'>
<a name='2414'>
          ENDDO<a name='2415'>
        ENDIF<a name='2416'>
<font color=#447700>!ckaywup<a name='2417'></font>
          envRHavg = 0.0<a name='2418'>
          DO NK=KLCL-1,LTOP1<a name='2419'>
           envEsat = 6.112*exp(17.67*(T0(NK)-273.16)/(243.5+T0(NK)-273.16))<a name='2420'>
           envEsat = envEsat * 100.0  <font color=#447700>! to hPa<a name='2421'></font>
           envQsat = 0.622*envEsat/(P0(NK)-envEsat)<a name='2422'>
           envRH  = Q0(NK)/envQsat<a name='2423'>
            envRHavg = envRHavg + envRH<a name='2424'>
           if(envRH.gt.1.01) then<a name='2425'>
             w_up(I,NK,J) = 0.0<a name='2426'>
           end if<a name='2427'>
          END DO<a name='2428'>
<a name='2429'>
<font color=#447700>!kf_edrates<a name='2430'></font>
<font color=#447700>!Save up/down entrainment/detrainment rates as 3D variables<a name='2431'></font>
        IF (KF_EDRATES == 1) THEN <a name='2432'>
           DO NK=1,LTOP<a name='2433'>
             UDR_KF(I,NK,J)=UDR(NK)<a name='2434'>
             DDR_KF(I,NK,J)=DDR(NK)<a name='2435'>
             UER_KF(I,NK,J)=UER(NK)<a name='2436'>
             DER_KF(I,NK,J)=DER(NK)<a name='2437'>
           ENDDO<a name='2438'>
        ENDIF<a name='2439'>
<a name='2440'>
<font color=#447700>!     <a name='2441'></font>
<font color=#447700>!...COMPUTE HYDROMETEOR TENDENCIES AS IS DONE FOR T, QV...<a name='2442'></font>
<font color=#447700>!     <a name='2443'></font>
<font color=#447700>!...FRC2 IS THE FRACTION OF TOTAL CONDENSATE      !  PPT FB MODS<a name='2444'></font>
<font color=#447700>!...GENERATED THAT GOES INTO PRECIPITIATION       !  PPT FB MODS<a name='2445'></font>
<font color=#447700>!<a name='2446'></font>
<font color=#447700>!  Redistribute hydormeteors according to the final mass-flux values:<a name='2447'></font>
<font color=#447700>!<a name='2448'></font>
        IF(CPR.GT.0.)THEN <a name='2449'>
          FRC2=PPTFLX/(CPR*AINC)                    <font color=#447700>!  PPT FB MODS<a name='2450'></font>
        ELSE<a name='2451'>
           FRC2=0.<a name='2452'>
        ENDIF<a name='2453'>
        DO NK=1,LTOP<a name='2454'>
          QLPA(NK)=QL0(NK)<a name='2455'>
          QIPA(NK)=QI0(NK)<a name='2456'>
          QRPA(NK)=QR0(NK)<a name='2457'>
          QSPA(NK)=QS0(NK)<a name='2458'>
          RAINFB(NK)=PPTLIQ(NK)*AINC*FBFRC*FRC2   <font color=#447700>!  PPT FB MODS<a name='2459'></font>
          SNOWFB(NK)=PPTICE(NK)*AINC*FBFRC*FRC2   <font color=#447700>!  PPT FB MODS<a name='2460'></font>
        ENDDO<a name='2461'>
        DO NTC=1,NSTEP<a name='2462'>
<font color=#447700>!     <a name='2463'></font>
<font color=#447700>!...ASSIGN HYDROMETEORS CONCENTRATIONS AT THE TOP AND BOTTOM OF EACH LAYER<a name='2464'></font>
<font color=#447700>!...BASED ON THE SIGN OF OMEGA...<a name='2465'></font>
<font color=#447700>!     <a name='2466'></font>
          DO NK=1,LTOP<a name='2467'>
            QLFXIN(NK)=0.<a name='2468'>
            QLFXOUT(NK)=0.<a name='2469'>
            QIFXIN(NK)=0.<a name='2470'>
            QIFXOUT(NK)=0.<a name='2471'>
            QRFXIN(NK)=0.<a name='2472'>
            QRFXOUT(NK)=0.<a name='2473'>
            QSFXIN(NK)=0.<a name='2474'>
            QSFXOUT(NK)=0.<a name='2475'>
          ENDDO   <a name='2476'>
          DO NK=2,LTOP<a name='2477'>
            IF(OMG(NK).LE.0.)THEN<a name='2478'>
              QLFXIN(NK)=-FXM(NK)*QLPA(NK-1)<a name='2479'>
              QIFXIN(NK)=-FXM(NK)*QIPA(NK-1)<a name='2480'>
              QRFXIN(NK)=-FXM(NK)*QRPA(NK-1)<a name='2481'>
              QSFXIN(NK)=-FXM(NK)*QSPA(NK-1)<a name='2482'>
              QLFXOUT(NK-1)=QLFXOUT(NK-1)+QLFXIN(NK)<a name='2483'>
              QIFXOUT(NK-1)=QIFXOUT(NK-1)+QIFXIN(NK)<a name='2484'>
              QRFXOUT(NK-1)=QRFXOUT(NK-1)+QRFXIN(NK)<a name='2485'>
              QSFXOUT(NK-1)=QSFXOUT(NK-1)+QSFXIN(NK)<a name='2486'>
            ELSE<a name='2487'>
              QLFXOUT(NK)=FXM(NK)*QLPA(NK)<a name='2488'>
              QIFXOUT(NK)=FXM(NK)*QIPA(NK)<a name='2489'>
              QRFXOUT(NK)=FXM(NK)*QRPA(NK)<a name='2490'>
              QSFXOUT(NK)=FXM(NK)*QSPA(NK)<a name='2491'>
              QLFXIN(NK-1)=QLFXIN(NK-1)+QLFXOUT(NK)<a name='2492'>
              QIFXIN(NK-1)=QIFXIN(NK-1)+QIFXOUT(NK)<a name='2493'>
              QRFXIN(NK-1)=QRFXIN(NK-1)+QRFXOUT(NK)<a name='2494'>
              QSFXIN(NK-1)=QSFXIN(NK-1)+QSFXOUT(NK)<a name='2495'>
            ENDIF<a name='2496'>
          ENDDO   <a name='2497'>
<font color=#447700>!     <a name='2498'></font>
<font color=#447700>!...UPDATE THE HYDROMETEOR CONCENTRATION VALUES AT EACH LEVEL...<a name='2499'></font>
<font color=#447700>!     <a name='2500'></font>
          DO NK=1,LTOP<a name='2501'>
            QLPA(NK)=QLPA(NK)+(QLFXIN(NK)+DETLQ(NK)-QLFXOUT(NK))*DTIME*EMSD(NK)<a name='2502'>
            QIPA(NK)=QIPA(NK)+(QIFXIN(NK)+DETIC(NK)-QIFXOUT(NK))*DTIME*EMSD(NK)<a name='2503'>
            QRPA(NK)=QRPA(NK)+(QRFXIN(NK)-QRFXOUT(NK)+RAINFB(NK))*DTIME*EMSD(NK)         <font color=#447700>!  PPT FB MODS<a name='2504'></font>
            QSPA(NK)=QSPA(NK)+(QSFXIN(NK)-QSFXOUT(NK)+SNOWFB(NK))*DTIME*EMSD(NK)         <font color=#447700>!  PPT FB MODS<a name='2505'></font>
          ENDDO     <a name='2506'>
        ENDDO<a name='2507'>
        DO NK=1,LTOP<a name='2508'>
          QLG(NK)=QLPA(NK)<a name='2509'>
          QIG(NK)=QIPA(NK)<a name='2510'>
          QRG(NK)=QRPA(NK)<a name='2511'>
          QSG(NK)=QSPA(NK)<a name='2512'>
        ENDDO   <a name='2513'>
<a name='2514'>
<font color=#447700>!kf_edrates<a name='2515'></font>
<font color=#447700>!Save convective timescale (TIMEC) as 2D variable<a name='2516'></font>
        IF (KF_EDRATES == 1) THEN<a name='2517'>
           TIMEC_KF(I,J)=TIMEC<a name='2518'>
        ENDIF<a name='2519'>
<a name='2520'>
<font color=#447700>!<a name='2521'></font>
<font color=#447700>!...CLEAN THINGS UP, CALCULATE CONVECTIVE FEEDBACK TENDENCIES FOR THIS<a name='2522'></font>
<font color=#447700>!...GRID POINT...<a name='2523'></font>
<font color=#447700>!     <a name='2524'></font>
<font color=#447700>!     IF (XTIME.LT.10.)THEN<a name='2525'></font>
<font color=#447700>!     WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC <a name='2526'></font>
<font color=#447700>!     ENDIF<a name='2527'></font>
       IF(IPRNT)THEN  <a name='2528'>
<font color=#447700>!         WRITE(98,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC<a name='2529'></font>
         WRITE(message,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC<a name='2530'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_635">(message)<a name='2531'>
<font color=#447700>!        flush(98)   <a name='2532'></font>
       endif  <a name='2533'>
<font color=#447700>!     <a name='2534'></font>
<font color=#447700>!...SEND FINAL PARAMETERIZED VALUES TO OUTPUT FILES...<a name='2535'></font>
<font color=#447700>!     <a name='2536'></font>
<font color=#447700>!297   IF(IPRNT)then <a name='2537'></font>
       IF(IPRNT)then <a name='2538'>
<font color=#447700>!    if(I.eq.16 .and. J.eq.41)then<a name='2539'></font>
<font color=#447700>!      IF(ISTOP.EQ.1)THEN<a name='2540'></font>
         write(98,*)<a name='2541'>
<font color=#447700>!        write(98,*)'At t(h), I, J =',float(NTSD)*72./3600.,I,J<a name='2542'></font>
         write(message,*)'P(LC), DTP, WKL, WKLCL =',p0(LC)/100.,       &amp;<a name='2543'>
                     TLCL+DTLCL+dtrh-TENV,WKL,WKLCL<a name='2544'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_636">(message)<a name='2545'>
         write(message,*)'TLCL, DTLCL, DTRH, TENV =',TLCL,DTLCL,       &amp;<a name='2546'>
                      DTRH,TENV   <a name='2547'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_637">(message)<a name='2548'>
         WRITE(message,1025)KLCL,ZLCL,DTLCL,LTOP,P0(LTOP),IFLAG,       &amp;<a name='2549'>
         TMIX-T00,PMIX,QMIX,ABE<a name='2550'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_638">(message)<a name='2551'>
         WRITE(message,1030)P0(LET)/100.,P0(LTOP)/100.,VMFLCL,PLCL/100.,  &amp;<a name='2552'>
         WLCL,CLDHGT(LC)<a name='2553'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_639">(message)<a name='2554'>
         WRITE(message,1035)PEF,PEFCBH,LC,LET,WKL,VWS <a name='2555'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_640">(message)<a name='2556'>
         write(message,*)'PRECIP EFFICIENCY =',PEFF <a name='2557'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_641">(message)<a name='2558'>
      WRITE(message,1080)LFS,LDB,LDT,TIMEC,TADVEC,NSTEP,NCOUNT,FABE,AINC<a name='2559'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_642">(message)<a name='2560'>
<font color=#447700>!      ENDIF<a name='2561'></font>
<font color=#447700>!!!!! HERE !!!!!!!<a name='2562'></font>
           WRITE(message,1070)'  P  ','   DP ',' DT K/D ',' DR K/D ','   OMG  ',        &amp;<a name='2563'>
          ' DOMGDP ','   UMF  ','   UER  ','   UDR  ','   DMF  ','   DER  '        &amp;<a name='2564'>
          ,'   DDR  ','   EMS  ','    W0  ','  DETLQ ',' DETIC '<a name='2565'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_643">(message)<a name='2566'>
           write(message,*)'just before DO 300...'<a name='2567'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_644">(message)<a name='2568'>
<font color=#447700>!          flush(98)<a name='2569'></font>
           DO NK=1,LTOP<a name='2570'>
             K=LTOP-NK+1<a name='2571'>
             DTT=(TG(K)-T0(K))*86400./TIMEC<a name='2572'>
             RL=XLV0-XLV1*TG(K)<a name='2573'>
             DR=-(QG(K)-Q0(K))*RL*86400./(TIMEC*CP)<a name='2574'>
             UDFRC=UDR(K)*TIMEC*EMSD(K)<a name='2575'>
             UEFRC=UER(K)*TIMEC*EMSD(K)<a name='2576'>
             DDFRC=DDR(K)*TIMEC*EMSD(K)<a name='2577'>
             DEFRC=-DER(K)*TIMEC*EMSD(K)<a name='2578'>
             WRITE(message,1075)P0(K)/100.,DP(K)/100.,DTT,DR,OMG(K),DOMGDP(K)*1.E4,       &amp;<a name='2579'>
             UMF(K)/1.E6,UEFRC,UDFRC,DMF(K)/1.E6,DEFRC,DDFRC,EMS(K)/1.E11,           &amp;<a name='2580'>
             W0AVG1D(K)*1.E2,DETLQ(K)*TIMEC*EMSD(K)*1.E3,DETIC(K)*                   &amp;<a name='2581'>
             TIMEC*EMSD(K)*1.E3<a name='2582'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_645">(message)<a name='2583'>
           ENDDO<a name='2584'>
           WRITE(message,1085)'K','P','Z','T0','TG','DT','TU','TD','Q0','QG',             &amp;<a name='2585'>
                  'DQ','QU','QD','QLG','QIG','QRG','QSG','RH0','RHG'<a name='2586'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_646">(message)<a name='2587'>
           DO NK=1,KL<a name='2588'>
             K=KX-NK+1<a name='2589'>
             DTT=TG(K)-T0(K)<a name='2590'>
             TUC=TU(K)-T00<a name='2591'>
             IF(K.LT.LC.OR.K.GT.LTOP)TUC=0.<a name='2592'>
             TDC=TZ(K)-T00<a name='2593'>
             IF((K.LT.LDB.OR.K.GT.LDT).AND.K.NE.LFS)TDC=0.<a name='2594'>
             IF(T0(K).LT.T00)THEN<a name='2595'>
               ES=ALIQ*EXP((BLIQ*TG(K)-CLIQ)/(TG(K)-DLIQ))<a name='2596'>
             ELSE<a name='2597'>
               ES=ALIQ*EXP((BLIQ*TG(K)-CLIQ)/(TG(K)-DLIQ))<a name='2598'>
             ENDIF  <a name='2599'>
             QGS=ES*0.622/(P0(K)-ES)<a name='2600'>
             RH0=Q0(K)/QES(K)<a name='2601'>
             RHG=QG(K)/QGS<a name='2602'>
             WRITE(message,1090)K,P0(K)/100.,Z0(K),T0(K)-T00,TG(K)-T00,DTT,TUC,            &amp;<a name='2603'>
             TDC,Q0(K)*1000.,QG(K)*1000.,(QG(K)-Q0(K))*1000.,QU(K)*                   &amp;<a name='2604'>
             1000.,QD(K)*1000.,QLG(K)*1000.,QIG(K)*1000.,QRG(K)*1000.,                &amp;<a name='2605'>
             QSG(K)*1000.,RH0,RHG<a name='2606'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_647">(message)<a name='2607'>
           ENDDO<a name='2608'>
<font color=#447700>!     <a name='2609'></font>
<font color=#447700>!...IF CALCULATIONS ABOVE SHOW AN ERROR IN THE MASS BUDGET, PRINT OUT A<a name='2610'></font>
<font color=#447700>!...TO BE USED LATER FOR DIAGNOSTIC PURPOSES, THEN ABORT RUN...<a name='2611'></font>
<font color=#447700>!     <a name='2612'></font>
<font color=#447700>!         IF(ISTOP.EQ.1 .or. ISHALL.EQ.1)THEN<a name='2613'></font>
<a name='2614'>
<font color=#447700>!         IF(ISHALL.NE.1)THEN<a name='2615'></font>
<font color=#447700>!            write(98,4421)i,j,iyr,imo,idy,ihr,imn<a name='2616'></font>
<font color=#447700>!           write(98)i,j,iyr,imo,idy,ihr,imn,kl<a name='2617'></font>
<font color=#447700>! 4421       format(7i4)<a name='2618'></font>
<font color=#447700>!            write(98,4422)kl<a name='2619'></font>
<font color=#447700>! 4422       format(i6) <a name='2620'></font>
            DO 310 NK = 1,KL<a name='2621'>
              k = kl - nk + 1<a name='2622'>
              write(98,4455) p0(k)/100.,t0(k)-273.16,q0(k)*1000.,       &amp;<a name='2623'>
                       u0(k),v0(k),W0AVG1D(K),dp(k),tke(k)<a name='2624'>
<font color=#447700>!             write(98) p0,t0,q0,u0,v0,w0,dp,tke<a name='2625'></font>
<font color=#447700>!           WRITE(98,1115)Z0(K),P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,<a name='2626'></font>
<font color=#447700>!    *               U0(K),V0(K),DP(K)/100.,W0AVG(I,J,K)<a name='2627'></font>
 310        CONTINUE<a name='2628'>
            IF(ISTOP.EQ.1)THEN<a name='2629'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_615"> ( 'KAIN-FRITSCH, istop=1, diags' )<a name='2630'>
            ENDIF<a name='2631'>
<font color=#447700>!         ENDIF<a name='2632'></font>
  4455  format(8f11.3) <a name='2633'>
       ENDIF<a name='2634'>
        CNDTNF=(1.-EQFRC(LFS))*(QLIQ(LFS)+QICE(LFS))*DMF(LFS)<a name='2635'>
        PRATEC(I,J)=PPTFLX*(1.-FBFRC)/DXSQ<a name='2636'>
        RAINCV(I,J)=DT*PRATEC(I,J)     <font color=#447700>!  PPT FB MODS<a name='2637'></font>
<font color=#447700>!        RAINCV(I,J)=.1*.5*DT*PPTFLX/DXSQ               !  PPT FB MODS<a name='2638'></font>
<font color=#447700>!         RNC=0.1*TIMEC*PPTFLX/DXSQ<a name='2639'></font>
        RNC=RAINCV(I,J)*NIC<a name='2640'>
       IF(ISHALL.EQ.0.AND.IPRNT)write (98,909)I,J,RNC<a name='2641'>
<a name='2642'>
<font color=#447700>!     WRITE(98,1095)CPR*AINC,TDER+PPTFLX+CNDTNF<a name='2643'></font>
<font color=#447700>!     <a name='2644'></font>
<font color=#447700>!  EVALUATE MOISTURE BUDGET...<a name='2645'></font>
<font color=#447700>!     <a name='2646'></font>
<a name='2647'>
        QINIT=0.<a name='2648'>
        QFNL=0.<a name='2649'>
        DPT=0.<a name='2650'>
        DO 315 NK=1,LTOP<a name='2651'>
          DPT=DPT+DP(NK)<a name='2652'>
          QINIT=QINIT+Q0(NK)*EMS(NK)<a name='2653'>
          QFNL=QFNL+QG(NK)*EMS(NK)<a name='2654'>
          QFNL=QFNL+(QLG(NK)+QIG(NK)+QRG(NK)+QSG(NK))*EMS(NK)<a name='2655'>
  315   CONTINUE<a name='2656'>
        QFNL=QFNL+PPTFLX*TIMEC*(1.-FBFRC)       <font color=#447700>!  PPT FB MODS<a name='2657'></font>
<font color=#447700>!        QFNL=QFNL+PPTFLX*TIMEC                 !  PPT FB MODS<a name='2658'></font>
        ERR2=(QFNL-QINIT)*100./QINIT<a name='2659'>
       IF(IPRNT)WRITE(98,1110)QINIT,QFNL,ERR2<a name='2660'>
      IF(ABS(ERR2).GT.0.05 .AND. ISTOP.EQ.0)THEN <a name='2661'>
<font color=#447700>!       write(99,*)'!!!!!!!! MOISTURE BUDGET ERROR IN KFPARA !!!'<a name='2662'></font>
<font color=#447700>!       WRITE(99,1110)QINIT,QFNL,ERR2<a name='2663'></font>
        IPRNT=.TRUE.<a name='2664'>
        ISTOP=1<a name='2665'>
            write(98,4422)kl<a name='2666'>
 4422       format(i6)<a name='2667'>
            DO 311 NK = 1,KL<a name='2668'>
              k = kl - nk + 1<a name='2669'>
<font color=#447700>!             write(99,4455) p0(k)/100.,t0(k)-273.16,q0(k)*1000.,       &amp;<a name='2670'></font>
<font color=#447700>!                      u0(k),v0(k),W0AVG1D(K),dp(k)<a name='2671'></font>
<font color=#447700>!             write(98) p0,t0,q0,u0,v0,w0,dp,tke<a name='2672'></font>
<font color=#447700>!           WRITE(98,1115)P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,          &amp;<a name='2673'></font>
<font color=#447700>!                    U0(K),V0(K),W0AVG1D(K),dp(k)/100.,tke(k)<a name='2674'></font>
            WRITE(98,4456)P0(K)/100.,T0(K)-273.16,Q0(K)*1000.,          &amp;<a name='2675'>
                     U0(K),V0(K),W0AVG1D(K),dp(k)/100.,tke(k)<a name='2676'>
 311        CONTINUE<a name='2677'>
<font color=#447700>!           flush(98)<a name='2678'></font>
<a name='2679'>
<font color=#447700>!        GOTO 297<a name='2680'></font>
<font color=#447700>!         STOP 'QVERR'<a name='2681'></font>
      ENDIF<a name='2682'>
 1115 FORMAT (2X,F7.2,2X,F5.1,2X,F6.3,2(2X,F5.1),2X,F7.2,2X,F7.4)<a name='2683'>
 4456  format(8f12.3)<a name='2684'>
        IF(PPTFLX.GT.0.)THEN<a name='2685'>
          RELERR=ERR2*QINIT/(PPTFLX*TIMEC)<a name='2686'>
        ELSE<a name='2687'>
          RELERR=0.<a name='2688'>
        ENDIF<a name='2689'>
     IF(IPRNT)THEN<a name='2690'>
        WRITE(98,1120)RELERR<a name='2691'>
        WRITE(98,*)'TDER, CPR, TRPPT =',              &amp;<a name='2692'>
          TDER,CPR*AINC,TRPPT*AINC<a name='2693'>
     ENDIF<a name='2694'>
<font color=#447700>!     <a name='2695'></font>
<font color=#447700>!...FEEDBACK TO RESOLVABLE SCALE TENDENCIES.<a name='2696'></font>
<font color=#447700>!     <a name='2697'></font>
<font color=#447700>!...IF THE ADVECTIVE TIME PERIOD (TADVEC) IS LESS THAN SPECIFIED MINIMUM<a name='2698'></font>
<font color=#447700>!...TIMEC, ALLOW FEEDBACK TO OCCUR ONLY DURING TADVEC...<a name='2699'></font>
<font color=#447700>!     <a name='2700'></font>
        IF(TADVEC.LT.TIMEC)NIC=NINT(TADVEC/DT)<a name='2701'>
        NCA(I,J) = REAL(NIC)*DT<a name='2702'>
        IF(ISHALL.EQ.1)THEN<a name='2703'>
<font color=#447700>!          TIMEC = 2400.<a name='2704'></font>
           NCA(I,J) = CUDT*60.<a name='2705'>
           NSHALL = NSHALL+1<a name='2706'>
        ENDIF<a name='2707'>
<a name='2708'>
        DO K=1,KX<a name='2709'>
<font color=#447700>!         IF(IMOIST(INEST).NE.2)THEN<a name='2710'></font>
<font color=#447700>!<a name='2711'></font>
<font color=#447700>!...IF HYDROMETEORS ARE NOT ALLOWED, THEY MUST BE EVAPORATED OR SUBLIMATED<a name='2712'></font>
<font color=#447700>!...AND FED BACK AS VAPOR, ALONG WITH ASSOCIATED CHANGES IN TEMPERATURE.<a name='2713'></font>
<font color=#447700>!...NOTE:  THIS WILL INTRODUCE CHANGES IN THE CONVECTIVE TEMPERATURE AND<a name='2714'></font>
<font color=#447700>!...WATER VAPOR FEEDBACK TENDENCIES AND MAY LEAD TO SUPERSATURATED VALUE<a name='2715'></font>
<font color=#447700>!...OF QG...<a name='2716'></font>
<font color=#447700>!<a name='2717'></font>
<font color=#447700>!           RLC=XLV0-XLV1*TG(K)<a name='2718'></font>
<font color=#447700>!           RLS=XLS0-XLS1*TG(K)<a name='2719'></font>
<font color=#447700>!           CPM=CP*(1.+0.887*QG(K))<a name='2720'></font>
<font color=#447700>!           TG(K)=TG(K)-(RLC*(QLG(K)+QRG(K))+RLS*(QIG(K)+QSG(K)))/CPM<a name='2721'></font>
<font color=#447700>!           QG(K)=QG(K)+(QLG(K)+QRG(K)+QIG(K)+QSG(K))<a name='2722'></font>
<font color=#447700>!           DQLDT(I,J,NK)=0.<a name='2723'></font>
<font color=#447700>!           DQIDT(I,J,NK)=0.<a name='2724'></font>
<font color=#447700>!           DQRDT(I,J,NK)=0.<a name='2725'></font>
<font color=#447700>!           DQSDT(I,J,NK)=0.<a name='2726'></font>
<font color=#447700>!         ELSE<a name='2727'></font>
<font color=#447700>!<a name='2728'></font>
<font color=#447700>!...IF ICE PHASE IS NOT ALLOWED, MELT ALL FROZEN HYDROMETEORS...<a name='2729'></font>
<font color=#447700>!<a name='2730'></font>
          IF(warm_rain)THEN<a name='2731'>
<a name='2732'>
            CPM=CP*(1.+0.887*QG(K))<a name='2733'>
            TG(K)=TG(K)-(QIG(K)+QSG(K))*RLF/CPM<a name='2734'>
            DQCDT(K)=(QLG(K)+QIG(K)-QL0(K)-QI0(K))/TIMEC<a name='2735'>
            DQIDT(K)=0.<a name='2736'>
            DQRDT(K)=(QRG(K)+QSG(K)-QR0(K)-QS0(K))/TIMEC<a name='2737'>
            DQSDT(K)=0.<a name='2738'>
          ELSEIF(.NOT. F_QS)THEN<a name='2739'>
<font color=#447700>!<a name='2740'></font>
<font color=#447700>!...IF ICE PHASE IS ALLOWED, BUT MIXED PHASE IS NOT, MELT FROZEN HYDROMETEORS<a name='2741'></font>
<font color=#447700>!...BELOW THE MELTING LEVEL, FREEZE LIQUID WATER ABOVE THE MELTING LEVEL<a name='2742'></font>
<font color=#447700>!<a name='2743'></font>
            CPM=CP*(1.+0.887*QG(K))<a name='2744'>
            IF(K.LE.ML)THEN<a name='2745'>
              TG(K)=TG(K)-(QIG(K)+QSG(K))*RLF/CPM<a name='2746'>
            ELSEIF(K.GT.ML)THEN<a name='2747'>
              TG(K)=TG(K)+(QLG(K)+QRG(K))*RLF/CPM<a name='2748'>
            ENDIF<a name='2749'>
            DQCDT(K)=(QLG(K)+QIG(K)-QL0(K)-QI0(K))/TIMEC<a name='2750'>
            DQIDT(K)=0.<a name='2751'>
            DQRDT(K)=(QRG(K)+QSG(K)-QR0(K)-QS0(K))/TIMEC<a name='2752'>
            DQSDT(K)=0.<a name='2753'>
          ELSEIF(F_QS) THEN<a name='2754'>
<font color=#447700>!<a name='2755'></font>
<font color=#447700>!...IF MIXED PHASE HYDROMETEORS ARE ALLOWED, FEED BACK CONVECTIVE TENDENCIES<a name='2756'></font>
<font color=#447700>!...OF HYDROMETEORS DIRECTLY...<a name='2757'></font>
<font color=#447700>!<a name='2758'></font>
            DQCDT(K)=(QLG(K)-QL0(K))/TIMEC<a name='2759'>
            DQSDT(K)=(QSG(K)-QS0(K))/TIMEC<a name='2760'>
            DQRDT(K)=(QRG(K)-QR0(K))/TIMEC<a name='2761'>
            IF (F_QI) THEN<a name='2762'>
               DQIDT(K)=(QIG(K)-QI0(K))/TIMEC<a name='2763'>
            ELSE<a name='2764'>
               DQSDT(K)=DQSDT(K)+(QIG(K)-QI0(K))/TIMEC<a name='2765'>
            ENDIF<a name='2766'>
          ELSE<a name='2767'>
<font color=#447700>!              PRINT *,'THIS COMBINATION OF IMOIST, IEXICE, IICE NOT ALLOWED!'<a name='2768'></font>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_cu_mskf.F.html#KF_ETA_PARA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_616"> ( 'KAIN-FRITSCH, THIS MICROPHYSICS CHOICE IS NOT ALLOWED' )<a name='2769'>
          ENDIF<a name='2770'>
          DTDT(K)=(TG(K)-T0(K))/TIMEC<a name='2771'>
          DQDT(K)=(QG(K)-Q0(K))/TIMEC<a name='2772'>
        ENDDO<a name='2773'>
        PRATEC(I,J)=PPTFLX*(1.-FBFRC)/DXSQ<a name='2774'>
        RAINCV(I,J)=DT*PRATEC(I,J)<a name='2775'>
<font color=#447700>!        RAINCV(I,J)=.1*.5*DT*PPTFLX/DXSQ               !  PPT FB MODS<a name='2776'></font>
<font color=#447700>!         RNC=0.1*TIMEC*PPTFLX/DXSQ<a name='2777'></font>
        RNC=RAINCV(I,J)*NIC<a name='2778'>
 909     FORMAT('AT I, J =',i3,1x,i3,' CONVECTIVE RAINFALL =',F8.4,' mm')<a name='2779'>
<font color=#447700>!      write (98,909)I,J,RNC<a name='2780'></font>
<font color=#447700>!      write (6,909)I,J,RNC<a name='2781'></font>
<font color=#447700>!      WRITE(98,*)'at NTSD =',NTSD,',No. of KF points activated =',<a name='2782'></font>
<font color=#447700>!     *            NCCNT<a name='2783'></font>
<font color=#447700>!      flush(98)<a name='2784'></font>
1000  FORMAT(' ',10A8)<a name='2785'>
1005  FORMAT(' ',F6.0,2X,F6.4,2X,F7.3,1X,F6.4,2X,4(F6.3,2X),2(F7.3,1X))<a name='2786'>
1010  FORMAT(' ',' VERTICAL VELOCITY IS NEGATIVE AT ',F4.0,' MB')<a name='2787'>
1015   FORMAT(' ','ALL REMAINING MASS DETRAINS BELOW ',F4.0,' MB')<a name='2788'>
1025   FORMAT(5X,' KLCL=',I2,' ZLCL=',F7.1,'M',                         &amp;<a name='2789'>
        ' DTLCL=',F5.2,' LTOP=',I2,' P0(LTOP)=',-2PF5.1,'MB FRZ LV=',   &amp;<a name='2790'>
        I2,' TMIX=',0PF4.1,1X,'PMIX=',-2PF6.1,' QMIX=',3PF5.1,          &amp;<a name='2791'>
        ' CAPE=',0PF7.1)<a name='2792'>
1030   FORMAT(' ',' P0(LET) = ',F6.1,' P0(LTOP) = ',F6.1,' VMFLCL =',   &amp;<a name='2793'>
      E12.3,' PLCL =',F6.1,' WLCL =',F6.3,' CLDHGT =',                  &amp;<a name='2794'>
      F8.1)<a name='2795'>
1035  FORMAT(1X,'PEF(WS)=',F4.2,'(CB)=',F4.2,'LC,LET=',2I3,'WKL='       &amp;<a name='2796'>
      ,F6.3,'VWS=',F5.2)<a name='2797'>
<font color=#447700>!1055  FORMAT('*** DEGREE OF STABILIZATION =',F5.3,                  &amp;<a name='2798'></font>
<font color=#447700>!      ', NO MORE MASS FLUX IS ALLOWED!')<a name='2799'></font>
<font color=#447700>!1060     FORMAT(' ITERATION DOES NOT CONVERGE TO GIVE THE SPECIFIED    &amp;<a name='2800'></font>
<font color=#447700>!      &amp;DEGREE OF STABILIZATION!  FABE= ',F6.4) <a name='2801'></font>
 1070 FORMAT (16A8) <a name='2802'>
 1075 FORMAT (F8.2,3(F8.2),2(F8.3),F8.2,2F8.3,F8.2,6F8.3) <a name='2803'>
 1080 FORMAT(2X,'LFS,LDB,LDT =',3I3,' TIMEC, TADVEC, NSTEP=',           &amp;<a name='2804'>
              2(1X,F5.0),I3,'NCOUNT, FABE, AINC=',I2,1X,F5.3,F6.2) <a name='2805'>
 1085 FORMAT (A3,16A7,2A8) <a name='2806'>
 1090 FORMAT (I3,F7.2,F7.0,10F7.2,4F7.3,2F8.3) <a name='2807'>
 1095 FORMAT(' ','  PPT PRODUCTION RATE= ',F10.0,' TOTAL EVAP+PPT= ',F10.0)<a name='2808'>
1105   FORMAT(' ','NET LATENT HEAT RELEASE =',E12.5,' ACTUAL HEATING =',&amp;<a name='2809'>
       E12.5,' J/KG-S, DIFFERENCE = ',F9.3,'%')<a name='2810'>
1110   FORMAT(' ','INITIAL WATER =',E12.5,' FINAL WATER =',E12.5,       &amp;<a name='2811'>
       ' TOTAL WATER CHANGE =',F8.2,'%')<a name='2812'>
<font color=#447700>! 1115 FORMAT (2X,F6.0,2X,F7.2,2X,F5.1,2X,F6.3,2(2X,F5.1),2X,F7.2,2X,F7.4)<a name='2813'></font>
1120   FORMAT(' ','MOISTURE ERROR AS FUNCTION OF TOTAL PPT =',F9.3,'%')<a name='2814'>
<font color=#447700>!<a name='2815'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2816'></font>
<font color=#447700>!--------------SAVE CLOUD TOP AND BOTTOM FOR RADIATION------------------<a name='2817'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2818'></font>
<font color=#447700>!<a name='2819'></font>
      CUTOP(I,J)=REAL(LTOP)<a name='2820'>
      CUBOT(I,J)=REAL(LCL)<a name='2821'>
<font color=#447700>!<a name='2822'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2823'></font>
   END SUBROUTINE  KF_eta_PARA<a name='2824'>
<font color=#447700>!********************************************************************<a name='2825'></font>
<font color=#447700>! ***********************************************************************<a name='2826'></font>
<A NAME='TPMIX2'><A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2827'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TPMIX2</font>(p,thes,tu,qu,qliq,qice,qnewlq,qnewic,XLV1,XLV0) <A href='../../call_to/TPMIX2.html' TARGET='index'>6</A><a name='2828'>
<font color=#447700>!<a name='2829'></font>
<font color=#447700>! Lookup table variables:<a name='2830'></font>
<font color=#447700>!     INTEGER, PARAMETER :: (KFNT=250,KFNP=220)<a name='2831'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='2832'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='2833'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='2834'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='2835'></font>
<font color=#447700>! End of Lookup table variables:<a name='2836'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='2837'></font>
   IMPLICIT NONE<a name='2838'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2839'></font>
   REAL,         INTENT(IN   )   :: P,THES,XLV1,XLV0<a name='2840'>
   REAL,         INTENT(OUT  )   :: QNEWLQ,QNEWIC<a name='2841'>
   REAL,         INTENT(INOUT)   :: TU,QU,QLIQ,QICE<a name='2842'>
   REAL    ::    TP,QQ,BTH,TTH,PP,T00,T10,T01,T11,Q00,Q10,Q01,Q11,          &amp;<a name='2843'>
                 TEMP,QS,QNEW,DQ,QTOT,RLL,CPP<a name='2844'>
   INTEGER ::    IPTB,ITHTB<a name='2845'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2846'></font>
<a name='2847'>
<font color=#447700>!c******** LOOKUP TABLE VARIABLES... ****************************<a name='2848'></font>
<font color=#447700>!      parameter(kfnt=250,kfnp=220)<a name='2849'></font>
<font color=#447700>!c<a name='2850'></font>
<font color=#447700>!      COMMON/KFLUT/ ttab(kfnt,kfnp),qstab(kfnt,kfnp),the0k(kfnp),<a name='2851'></font>
<font color=#447700>!     *              alu(200),rdpr,rdthk,plutop <a name='2852'></font>
<font color=#447700>!C*************************************************************** <a name='2853'></font>
<font color=#447700>!c<a name='2854'></font>
<font color=#447700>!c***********************************************************************<a name='2855'></font>
<font color=#447700>!c     scaling pressure and tt table index                         <a name='2856'></font>
<font color=#447700>!c***********************************************************************<a name='2857'></font>
<font color=#447700>!c<a name='2858'></font>
      tp=(p-plutop)*rdpr<a name='2859'>
      qq=tp-aint(tp)<a name='2860'>
      iptb=int(tp)+1<a name='2861'>
<a name='2862'>
<font color=#447700>!<a name='2863'></font>
<font color=#447700>!***********************************************************************<a name='2864'></font>
<font color=#447700>!              base and scaling factor for the                           <a name='2865'></font>
<font color=#447700>!***********************************************************************<a name='2866'></font>
<font color=#447700>!<a name='2867'></font>
<font color=#447700>!  scaling the and tt table index                                        <a name='2868'></font>
      bth=(the0k(iptb+1)-the0k(iptb))*qq+the0k(iptb)<a name='2869'>
      tth=(thes-bth)*rdthk<a name='2870'>
      pp   =tth-aint(tth)<a name='2871'>
      ithtb=int(tth)+1<a name='2872'>
       IF(IPTB.GE.220 .OR. IPTB.LE.1 .OR. ITHTB.GE.250 .OR. ITHTB.LE.1)THEN<a name='2873'>
         write(98,*)'**** OUT OF BOUNDS *********'<a name='2874'>
<font color=#447700>!        flush(98)<a name='2875'></font>
       ENDIF<a name='2876'>
<font color=#447700>!<a name='2877'></font>
      t00=ttab(ithtb  ,iptb  )<a name='2878'>
      t10=ttab(ithtb+1,iptb  )<a name='2879'>
      t01=ttab(ithtb  ,iptb+1)<a name='2880'>
      t11=ttab(ithtb+1,iptb+1)<a name='2881'>
<font color=#447700>!<a name='2882'></font>
      q00=qstab(ithtb  ,iptb  )<a name='2883'>
      q10=qstab(ithtb+1,iptb  )<a name='2884'>
      q01=qstab(ithtb  ,iptb+1)<a name='2885'>
      q11=qstab(ithtb+1,iptb+1)<a name='2886'>
<font color=#447700>!<a name='2887'></font>
<font color=#447700>!***********************************************************************<a name='2888'></font>
<font color=#447700>!              parcel temperature                                        <a name='2889'></font>
<font color=#447700>!***********************************************************************<a name='2890'></font>
<font color=#447700>!<a name='2891'></font>
      temp=(t00+(t10-t00)*pp+(t01-t00)*qq+(t00-t10-t01+t11)*pp*qq)<a name='2892'>
<font color=#447700>!<a name='2893'></font>
      qs=(q00+(q10-q00)*pp+(q01-q00)*qq+(q00-q10-q01+q11)*pp*qq)<a name='2894'>
<font color=#447700>!<a name='2895'></font>
      DQ=QS-QU<a name='2896'>
      IF(DQ.LE.0.)THEN<a name='2897'>
        QNEW=QU-QS<a name='2898'>
        QU=QS<a name='2899'>
      ELSE <a name='2900'>
<font color=#447700>!<a name='2901'></font>
<font color=#447700>!   IF THE PARCEL IS SUBSATURATED, TEMPERATURE AND MIXING RATIO MUST BE<a name='2902'></font>
<font color=#447700>!   ADJUSTED...IF LIQUID WATER IS PRESENT, IT IS ALLOWED TO EVAPORATE<a name='2903'></font>
<font color=#447700>! <a name='2904'></font>
        QNEW=0.<a name='2905'>
        QTOT=QLIQ+QICE<a name='2906'>
<font color=#447700>!<a name='2907'></font>
<font color=#447700>!   IF THERE IS ENOUGH LIQUID OR ICE TO SATURATE THE PARCEL, TEMP STAYS AT ITS<a name='2908'></font>
<font color=#447700>!   WET BULB VALUE, VAPOR MIXING RATIO IS AT SATURATED LEVEL, AND THE MIXING<a name='2909'></font>
<font color=#447700>!   RATIOS OF LIQUID AND ICE ARE ADJUSTED TO MAKE UP THE ORIGINAL SATURATION<a name='2910'></font>
<font color=#447700>!   DEFICIT... OTHERWISE, ANY AVAILABLE LIQ OR ICE VAPORIZES AND APPROPRIATE<a name='2911'></font>
<font color=#447700>!   ADJUSTMENTS TO PARCEL TEMP; VAPOR, LIQUID, AND ICE MIXING RATIOS ARE MADE.<a name='2912'></font>
<font color=#447700>!<a name='2913'></font>
<font color=#447700>!...subsaturated values only occur in calculations involving various mixtures of<a name='2914'></font>
<font color=#447700>!...updraft and environmental air for estimation of entrainment and detrainment.<a name='2915'></font>
<font color=#447700>!...For these purposes, assume that reasonable estimates can be given using <a name='2916'></font>
<font color=#447700>!...liquid water saturation calculations only - i.e., ignore the effect of the<a name='2917'></font>
<font color=#447700>!...ice phase in this process only...will not affect conservative properties...<a name='2918'></font>
<font color=#447700>!<a name='2919'></font>
        IF(QTOT.GE.DQ)THEN<a name='2920'>
          qliq=qliq-dq*qliq/(qtot+1.e-10)<a name='2921'>
          qice=qice-dq*qice/(qtot+1.e-10)<a name='2922'>
          QU=QS<a name='2923'>
        ELSE<a name='2924'>
          RLL=XLV0-XLV1*TEMP<a name='2925'>
          CPP=1004.5*(1.+0.89*QU)<a name='2926'>
          IF(QTOT.LT.1.E-10)THEN<a name='2927'>
<font color=#447700>!<a name='2928'></font>
<font color=#447700>!...IF NO LIQUID WATER OR ICE IS AVAILABLE, TEMPERATURE IS GIVEN BY:<a name='2929'></font>
            TEMP=TEMP+RLL*(DQ/(1.+DQ))/CPP<a name='2930'>
          ELSE<a name='2931'>
<font color=#447700>!<a name='2932'></font>
<font color=#447700>!...IF SOME LIQ WATER/ICE IS AVAILABLE, BUT NOT ENOUGH TO ACHIEVE SATURATION,<a name='2933'></font>
<font color=#447700>!   THE TEMPERATURE IS GIVEN BY:<a name='2934'></font>
<font color=#447700>!<a name='2935'></font>
            TEMP=TEMP+RLL*((DQ-QTOT)/(1+DQ-QTOT))/CPP<a name='2936'>
            QU=QU+QTOT<a name='2937'>
            QTOT=0.<a name='2938'>
            QLIQ=0.<a name='2939'>
            QICE=0.<a name='2940'>
          ENDIF<a name='2941'>
        ENDIF<a name='2942'>
      ENDIF<a name='2943'>
      TU=TEMP<a name='2944'>
      qnewlq=qnew<a name='2945'>
      qnewic=0.<a name='2946'>
<font color=#447700>!<a name='2947'></font>
   END SUBROUTINE TPMIX2<a name='2948'>
<font color=#447700>!******************************************************************************<a name='2949'></font>
<A NAME='DTFRZNEW'><A href='../../html_code/phys/module_cu_mskf.F.html#DTFRZNEW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2950'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>DTFRZNEW</font>(TU,P,THTEU,QU,QFRZ,QICE,ALIQ,BLIQ,CLIQ,DLIQ) <A href='../../call_to/DTFRZNEW.html' TARGET='index'>3</A><a name='2951'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2952'></font>
   IMPLICIT NONE<a name='2953'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2954'></font>
   REAL,         INTENT(IN   )   :: P,QFRZ,ALIQ,BLIQ,CLIQ,DLIQ<a name='2955'>
   REAL,         INTENT(INOUT)   :: TU,THTEU,QU,QICE<a name='2956'>
   REAL    ::    RLC,RLS,RLF,CPP,A,DTFRZ,ES,QS,DQEVAP,PII<a name='2957'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2958'></font>
<font color=#447700>!<a name='2959'></font>
<font color=#447700>!...ALLOW THE FREEZING OF LIQUID WATER IN THE UPDRAFT TO PROCEED AS AN <a name='2960'></font>
<font color=#447700>!...APPROXIMATELY LINEAR FUNCTION OF TEMPERATURE IN THE TEMPERATURE RANGE <a name='2961'></font>
<font color=#447700>!...TTFRZ TO TBFRZ...<a name='2962'></font>
<font color=#447700>!...FOR COLDER TEMPERATURES, FREEZE ALL LIQUID WATER...<a name='2963'></font>
<font color=#447700>!...THERMODYNAMIC PROPERTIES ARE STILL CALCULATED WITH RESPECT TO LIQUID WATER<a name='2964'></font>
<font color=#447700>!...TO ALLOW THE USE OF LOOKUP TABLE TO EXTRACT TMP FROM THETAE...<a name='2965'></font>
<font color=#447700>!<a name='2966'></font>
      RLC=2.5E6-2369.276*(TU-273.16)<a name='2967'>
      RLS=2833922.-259.532*(TU-273.16)<a name='2968'>
      RLF=RLS-RLC<a name='2969'>
      CPP=1004.5*(1.+0.89*QU)<a name='2970'>
<font color=#447700>!<a name='2971'></font>
<font color=#447700>!  A = D(es)/DT IS THAT CALCULATED FROM BUCK (1981) EMPERICAL FORMULAS<a name='2972'></font>
<font color=#447700>!  FOR SATURATION VAPOR PRESSURE...<a name='2973'></font>
<font color=#447700>!<a name='2974'></font>
      A=(CLIQ-BLIQ*DLIQ)/((TU-DLIQ)*(TU-DLIQ))<a name='2975'>
      DTFRZ = RLF*QFRZ/(CPP+RLS*QU*A)<a name='2976'>
      TU = TU+DTFRZ<a name='2977'>
      <a name='2978'>
      ES = ALIQ*EXP((BLIQ*TU-CLIQ)/(TU-DLIQ))<a name='2979'>
      QS = ES*0.622/(P-ES)<a name='2980'>
<font color=#447700>!<a name='2981'></font>
<font color=#447700>!...FREEZING WARMS THE AIR AND IT BECOMES UNSATURATED...ASSUME THAT SOME OF THE <a name='2982'></font>
<font color=#447700>!...LIQUID WATER THAT IS AVAILABLE FOR FREEZING EVAPORATES TO MAINTAIN SATURA-<a name='2983'></font>
<font color=#447700>!...TION...SINCE THIS WATER HAS ALREADY BEEN TRANSFERRED TO THE ICE CATEGORY,<a name='2984'></font>
<font color=#447700>!...SUBTRACT IT FROM ICE CONCENTRATION, THEN SET UPDRAFT MIXING RATIO AT THE NEW<a name='2985'></font>
<font color=#447700>!...TEMPERATURE TO THE SATURATION VALUE...<a name='2986'></font>
<font color=#447700>!<a name='2987'></font>
      DQEVAP = QS-QU<a name='2988'>
      QICE = QICE-DQEVAP<a name='2989'>
      QU = QU+DQEVAP<a name='2990'>
      PII=(1.E5/P)**(0.2854*(1.-0.28*QU))<a name='2991'>
      THTEU=TU*PII*EXP((3374.6525/TU-2.5403)*QU*(1.+0.81*QU))<a name='2992'>
<font color=#447700>!<a name='2993'></font>
   END SUBROUTINE DTFRZNEW<a name='2994'>
<font color=#447700>! --------------------------------------------------------------------------------<a name='2995'></font>
<a name='2996'>
<A NAME='CONDLOAD'><A href='../../html_code/phys/module_cu_mskf.F.html#CONDLOAD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2997'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>CONDLOAD</font>(QLIQ,QICE,WTW,DZ,BOTERM,ENTERM,RATE,QNEWLQ,           &amp; <A href='../../call_to/CONDLOAD.html' TARGET='index'>3</A><a name='2998'>
                          QNEWIC,QLQOUT,QICOUT,G)<a name='2999'>
<a name='3000'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3001'></font>
   IMPLICIT NONE<a name='3002'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3003'></font>
<font color=#447700>!  9/18/88...THIS PRECIPITATION FALLOUT SCHEME IS BASED ON THE SCHEME US<a name='3004'></font>
<font color=#447700>!  BY OGURA AND CHO (1973).  LIQUID WATER FALLOUT FROM A PARCEL IS CAL-<a name='3005'></font>
<font color=#447700>!  CULATED USING THE EQUATION DQ=-RATE*Q*DT, BUT TO SIMULATE A QUASI-<a name='3006'></font>
<font color=#447700>!  CONTINUOUS PROCESS, AND TO ELIMINATE A DEPENDENCY ON VERTICAL<a name='3007'></font>
<font color=#447700>!  RESOLUTION THIS IS EXPRESSED AS Q=Q*EXP(-RATE*DZ).<a name='3008'></font>
<a name='3009'>
      REAL, INTENT(IN   )   :: G<a name='3010'>
      REAL, INTENT(IN   )   :: DZ,BOTERM,ENTERM,RATE<a name='3011'>
      REAL, INTENT(INOUT)   :: QLQOUT,QICOUT,WTW,QLIQ,QICE,QNEWLQ,QNEWIC<a name='3012'>
      REAL :: QTOT,QNEW,QEST,G1,WAVG,CONV,RATIO3,OLDQ,RATIO4,DQ,PPTDRG<a name='3013'>
<font color=#447700>!<a name='3014'></font>
      QTOT=QLIQ+QICE                                                    <a name='3015'>
      QNEW=QNEWLQ+QNEWIC                                                <a name='3016'>
<font color=#447700>!                                                                       <a name='3017'></font>
<font color=#447700>!  ESTIMATE THE VERTICAL VELOCITY SO THAT AN AVERAGE VERTICAL VELOCITY <a name='3018'></font>
<font color=#447700>!  BE CALCULATED TO ESTIMATE THE TIME REQUIRED FOR ASCENT BETWEEN MODEL <a name='3019'></font>
<font color=#447700>!  LEVELS...                                                            <a name='3020'></font>
<font color=#447700>!                                                                       <a name='3021'></font>
      QEST=0.5*(QTOT+QNEW)                                              <a name='3022'>
      G1=WTW+BOTERM-ENTERM-2.*G*DZ*QEST/1.5                             <a name='3023'>
      IF(G1.LT.0.0)G1=0.                                                <a name='3024'>
      WAVG=0.5*(SQRT(WTW)+SQRT(G1))                                      <a name='3025'>
      CONV=RATE*DZ/WAVG               <font color=#447700>! KF90  Eq. 9<a name='3026'></font>
<font color=#447700>!                                                                       <a name='3027'></font>
<font color=#447700>!  RATIO3 IS THE FRACTION OF LIQUID WATER IN FRESH CONDENSATE, RATIO4 IS<a name='3028'></font>
<font color=#447700>!  THE FRACTION OF LIQUID WATER IN THE TOTAL AMOUNT OF CONDENSATE INVOLV<a name='3029'></font>
<font color=#447700>!  IN THE PRECIPITATION PROCESS - NOTE THAT ONLY 60% OF THE FRESH CONDEN<a name='3030'></font>
<font color=#447700>!  SATE IS IS ALLOWED TO PARTICIPATE IN THE CONVERSION PROCESS...       <a name='3031'></font>
<font color=#447700>!                                                                       <a name='3032'></font>
      RATIO3=QNEWLQ/(QNEW+1.E-8)                                       <a name='3033'>
<font color=#447700>!     OLDQ=QTOT                                                         <a name='3034'></font>
      QTOT=QTOT+0.6*QNEW                                                <a name='3035'>
      OLDQ=QTOT                                                         <a name='3036'>
      RATIO4=(0.6*QNEWLQ+QLIQ)/(QTOT+1.E-8)                            <a name='3037'>
      QTOT=QTOT*EXP(-CONV)            <font color=#447700>! KF90  Eq. 9                                              <a name='3038'></font>
<font color=#447700>!                                                                       <a name='3039'></font>
<font color=#447700>!  DETERMINE THE AMOUNT OF PRECIPITATION THAT FALLS OUT OF THE UPDRAFT  <a name='3040'></font>
<font color=#447700>!  PARCEL AT THIS LEVEL...                                              <a name='3041'></font>
<font color=#447700>!                                                                       <a name='3042'></font>
      DQ=OLDQ-QTOT                                                      <a name='3043'>
      QLQOUT=RATIO4*DQ                                                  <a name='3044'>
      QICOUT=(1.-RATIO4)*DQ                                             <a name='3045'>
<font color=#447700>!                                                                       <a name='3046'></font>
<font color=#447700>!  ESTIMATE THE MEAN LOAD OF CONDENSATE ON THE UPDRAFT IN THE LAYER, CAL<a name='3047'></font>
<font color=#447700>!  LATE VERTICAL VELOCITY                                               <a name='3048'></font>
<font color=#447700>!                                                                       <a name='3049'></font>
      PPTDRG=0.5*(OLDQ+QTOT-0.2*QNEW)                                   <a name='3050'>
      WTW=WTW+BOTERM-ENTERM-2.*G*DZ*PPTDRG/1.5                          <a name='3051'>
      IF(ABS(WTW).LT.1.E-4)WTW=1.E-4<a name='3052'>
<font color=#447700>!                                                                       <a name='3053'></font>
<font color=#447700>!  DETERMINE THE NEW LIQUID WATER AND ICE CONCENTRATIONS INCLUDING LOSSE<a name='3054'></font>
<font color=#447700>!  DUE TO PRECIPITATION AND GAINS FROM CONDENSATION...                  <a name='3055'></font>
<font color=#447700>!                                                                       <a name='3056'></font>
      QLIQ=RATIO4*QTOT+RATIO3*0.4*QNEW                                  <a name='3057'>
      QICE=(1.-RATIO4)*QTOT+(1.-RATIO3)*0.4*QNEW                        <a name='3058'>
      QNEWLQ=0.                                                         <a name='3059'>
      QNEWIC=0.                                                         <a name='3060'>
<a name='3061'>
   END SUBROUTINE CONDLOAD<a name='3062'>
<a name='3063'>
<font color=#447700>! ----------------------------------------------------------------------<a name='3064'></font>
<A NAME='PROF5'><A href='../../html_code/phys/module_cu_mskf.F.html#PROF5' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3065'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>PROF5</font>(EQ,EE,UD)                                         <A href='../../call_to/PROF5.html' TARGET='index'>3</A><a name='3066'>
<font color=#447700>!<a name='3067'></font>
<font color=#447700>!***********************************************************************<a name='3068'></font>
<font color=#447700>!*****    GAUSSIAN TYPE MIXING PROFILE....******************************<a name='3069'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3070'></font>
<font color=#447700>!  THIS SUBROUTINE INTEGRATES THE AREA UNDER THE CURVE IN THE GAUSSIAN  <a name='3071'></font>
<font color=#447700>!  DISTRIBUTION...THE NUMERICAL APPROXIMATION TO THE INTEGRAL IS TAKEN FROM<a name='3072'></font>
<font color=#447700>!  "HANDBOOK OF MATHEMATICAL FUNCTIONS WITH FORMULAS, GRAPHS AND MATHEMATICS TABLES"<a name='3073'></font>
<font color=#447700>!  ED. BY ABRAMOWITZ AND STEGUN, NATL BUREAU OF STANDARDS APPLIED<a name='3074'></font>
<font color=#447700>!  MATHEMATICS SERIES.  JUNE, 1964., MAY, 1968.                         <a name='3075'></font>
<font color=#447700>!                                     JACK KAIN                         <a name='3076'></font>
<font color=#447700>!                                     7/6/89                            <a name='3077'></font>
<font color=#447700>!  Solves for KF90 Eq. 2<a name='3078'></font>
<font color=#447700>!<a name='3079'></font>
<font color=#447700>!CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<a name='3080'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3081'></font>
   IMPLICIT NONE<a name='3082'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3083'></font>
   REAL,         INTENT(IN   )   :: EQ<a name='3084'>
   REAL,         INTENT(INOUT)   :: EE,UD<a name='3085'>
   REAL ::       SQRT2P,A1,A2,A3,P,SIGMA,FE,X,Y,EY,E45,T1,T2,C1,C2<a name='3086'>
<a name='3087'>
      DATA SQRT2P,A1,A2,A3,P,SIGMA,FE/2.506628,0.4361836,-0.1201676,       &amp;<a name='3088'>
           0.9372980,0.33267,0.166666667,0.202765151/                        <a name='3089'>
      X=(EQ-0.5)/SIGMA                                                  <a name='3090'>
      Y=6.*EQ-3.                                                        <a name='3091'>
      EY=EXP(Y*Y/(-2))                                                  <a name='3092'>
      E45=EXP(-4.5)                                                     <a name='3093'>
      T2=1./(1.+P*ABS(Y))                                               <a name='3094'>
      T1=0.500498                                                       <a name='3095'>
      C1=A1*T1+A2*T1*T1+A3*T1*T1*T1                                     <a name='3096'>
      C2=A1*T2+A2*T2*T2+A3*T2*T2*T2                                     <a name='3097'>
      IF(Y.GE.0.)THEN                                                   <a name='3098'>
        EE=SIGMA*(0.5*(SQRT2P-E45*C1-EY*C2)+SIGMA*(E45-EY))-E45*EQ*EQ/2.<a name='3099'>
        UD=SIGMA*(0.5*(EY*C2-E45*C1)+SIGMA*(E45-EY))-E45*(0.5+EQ*EQ/2.-    &amp;<a name='3100'>
           EQ)                                                          <a name='3101'>
      ELSE                                                              <a name='3102'>
        EE=SIGMA*(0.5*(EY*C2-E45*C1)+SIGMA*(E45-EY))-E45*EQ*EQ/2.       <a name='3103'>
        UD=SIGMA*(0.5*(SQRT2P-E45*C1-EY*C2)+SIGMA*(E45-EY))-E45*(0.5+EQ*   &amp;<a name='3104'>
           EQ/2.-EQ)                                                    <a name='3105'>
      ENDIF                                                             <a name='3106'>
      EE=EE/FE                                                          <a name='3107'>
      UD=UD/FE                                                          <a name='3108'>
<a name='3109'>
   END SUBROUTINE PROF5<a name='3110'>
<a name='3111'>
<font color=#447700>! ------------------------------------------------------------------------<a name='3112'></font>
<A NAME='TPMIX2DD'><A href='../../html_code/phys/module_cu_mskf.F.html#TPMIX2DD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3113'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TPMIX2DD</font>(p,thes,ts,qs,i,j) <A href='../../call_to/TPMIX2DD.html' TARGET='index'>8</A><a name='3114'>
<font color=#447700>!<a name='3115'></font>
<font color=#447700>! Lookup table variables:<a name='3116'></font>
<font color=#447700>!     INTEGER, PARAMETER :: (KFNT=250,KFNP=220)<a name='3117'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='3118'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='3119'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='3120'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='3121'></font>
<font color=#447700>! End of Lookup table variables:<a name='3122'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3123'></font>
   IMPLICIT NONE<a name='3124'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3125'></font>
   REAL,         INTENT(IN   )   :: P,THES<a name='3126'>
   REAL,         INTENT(INOUT)   :: TS,QS<a name='3127'>
   INTEGER,      INTENT(IN   )   :: i,j     <font color=#447700>! avail for debugging<a name='3128'></font>
   REAL    ::    TP,QQ,BTH,TTH,PP,T00,T10,T01,T11,Q00,Q10,Q01,Q11<a name='3129'>
   INTEGER ::    IPTB,ITHTB<a name='3130'>
   CHARACTER*256 :: MESS<a name='3131'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3132'></font>
<a name='3133'>
<font color=#447700>!<a name='3134'></font>
<font color=#447700>!******** LOOKUP TABLE VARIABLES (F77 format)... ****************************<a name='3135'></font>
<font color=#447700>!     parameter(kfnt=250,kfnp=220)<a name='3136'></font>
<font color=#447700>!<a name='3137'></font>
<font color=#447700>!     COMMON/KFLUT/ ttab(kfnt,kfnp),qstab(kfnt,kfnp),the0k(kfnp),        &amp;<a name='3138'></font>
<font color=#447700>!                   alu(200),rdpr,rdthk,plutop <a name='3139'></font>
<font color=#447700>!*************************************************************** <a name='3140'></font>
<font color=#447700>!<a name='3141'></font>
<font color=#447700>!***********************************************************************<a name='3142'></font>
<font color=#447700>!     scaling pressure and tt table index                         <a name='3143'></font>
<font color=#447700>!***********************************************************************<a name='3144'></font>
<font color=#447700>!<a name='3145'></font>
      tp=(p-plutop)*rdpr<a name='3146'>
      qq=tp-aint(tp)<a name='3147'>
      iptb=int(tp)+1<a name='3148'>
<font color=#447700>!<a name='3149'></font>
<font color=#447700>!***********************************************************************<a name='3150'></font>
<font color=#447700>!              base and scaling factor for the                           <a name='3151'></font>
<font color=#447700>!***********************************************************************<a name='3152'></font>
<font color=#447700>!<a name='3153'></font>
<font color=#447700>!  scaling the and tt table index                                        <a name='3154'></font>
      bth=(the0k(iptb+1)-the0k(iptb))*qq+the0k(iptb)<a name='3155'>
      tth=(thes-bth)*rdthk<a name='3156'>
      pp   =tth-aint(tth)<a name='3157'>
      ithtb=int(tth)+1<a name='3158'>
<font color=#447700>!<a name='3159'></font>
      t00=ttab(ithtb  ,iptb  )<a name='3160'>
      t10=ttab(ithtb+1,iptb  )<a name='3161'>
      t01=ttab(ithtb  ,iptb+1)<a name='3162'>
      t11=ttab(ithtb+1,iptb+1)<a name='3163'>
<font color=#447700>!<a name='3164'></font>
      q00=qstab(ithtb  ,iptb  )<a name='3165'>
      q10=qstab(ithtb+1,iptb  )<a name='3166'>
      q01=qstab(ithtb  ,iptb+1)<a name='3167'>
      q11=qstab(ithtb+1,iptb+1)<a name='3168'>
<font color=#447700>!<a name='3169'></font>
<font color=#447700>!***********************************************************************<a name='3170'></font>
<font color=#447700>!              parcel temperature and saturation mixing ratio                                        <a name='3171'></font>
<font color=#447700>!***********************************************************************<a name='3172'></font>
<font color=#447700>!<a name='3173'></font>
      ts=(t00+(t10-t00)*pp+(t01-t00)*qq+(t00-t10-t01+t11)*pp*qq)<a name='3174'>
<font color=#447700>!<a name='3175'></font>
      qs=(q00+(q10-q00)*pp+(q01-q00)*qq+(q00-q10-q01+q11)*pp*qq)<a name='3176'>
<font color=#447700>!<a name='3177'></font>
   END SUBROUTINE TPMIX2DD<a name='3178'>
<a name='3179'>
<font color=#447700>! -----------------------------------------------------------------------<a name='3180'></font>
<A NAME='ENVIRTHT'><A href='../../html_code/phys/module_cu_mskf.F.html#ENVIRTHT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3181'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ENVIRTHT</font>(P1,T1,Q1,THT1,ALIQ,BLIQ,CLIQ,DLIQ)                        <A href='../../call_to/ENVIRTHT.html' TARGET='index'>12</A><a name='3182'>
<font color=#447700>!<a name='3183'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='3184'></font>
   IMPLICIT NONE<a name='3185'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3186'></font>
   REAL,         INTENT(IN   )   :: P1,T1,Q1,ALIQ,BLIQ,CLIQ,DLIQ<a name='3187'>
   REAL,         INTENT(INOUT)   :: THT1<a name='3188'>
   REAL    ::    EE,TLOG,ASTRT,AINC,A1,TP,VALUE,AINTRP,TDPT,TSAT,THT,      &amp;<a name='3189'>
                 T00,P00,C1,C2,C3,C4,C5<a name='3190'>
   INTEGER ::    INDLU<a name='3191'>
<font color=#447700>!-----------------------------------------------------------------------<a name='3192'></font>
      DATA T00,P00,C1,C2,C3,C4,C5/273.16,1.E5,3374.6525,2.5403,3114.834,   &amp;<a name='3193'>
           0.278296,1.0723E-3/                                          <a name='3194'>
<font color=#447700>!                                                                       <a name='3195'></font>
<font color=#447700>!  CALCULATE ENVIRONMENTAL EQUIVALENT POTENTIAL TEMPERATURE...          <a name='3196'></font>
<font color=#447700>!                                                                       <a name='3197'></font>
<font color=#447700>! NOTE: Calculations for mixed/ice phase no longer used...jsk 8/00<a name='3198'></font>
<font color=#447700>!        For example, KF90 Eq. 10 no longer used<a name='3199'></font>
<font color=#447700>!<a name='3200'></font>
      EE=Q1*P1/(0.622+Q1)                                             <a name='3201'>
<font color=#447700>!     TLOG=ALOG(EE/ALIQ)                                              <a name='3202'></font>
<font color=#447700>! ...calculate LOG term using lookup table...<a name='3203'></font>
<font color=#447700>!<a name='3204'></font>
      astrt=1.e-3<a name='3205'>
      ainc=0.075<a name='3206'>
      a1=ee/aliq<a name='3207'>
      tp=(a1-astrt)/ainc<a name='3208'>
      indlu=int(tp)+1<a name='3209'>
      value=(indlu-1)*ainc+astrt<a name='3210'>
      aintrp=(a1-value)/ainc<a name='3211'>
      tlog=aintrp*alu(indlu+1)+(1-aintrp)*alu(indlu)<a name='3212'>
<font color=#447700>!<a name='3213'></font>
      TDPT=(CLIQ-DLIQ*TLOG)/(BLIQ-TLOG)                               <a name='3214'>
      TSAT=TDPT-(.212+1.571E-3*(TDPT-T00)-4.36E-4*(T1-T00))*(T1-TDPT) <a name='3215'>
      THT=T1*(P00/P1)**(0.2854*(1.-0.28*Q1))                          <a name='3216'>
      THT1=THT*EXP((C1/TSAT-C2)*Q1*(1.+0.81*Q1))                      <a name='3217'>
<font color=#447700>!<a name='3218'></font>
  END SUBROUTINE ENVIRTHT                                                              <a name='3219'>
<font color=#447700>! ***********************************************************************<a name='3220'></font>
<font color=#447700>!====================================================================<a name='3221'></font>
<A NAME='MSKF_INIT'><A href='../../html_code/phys/module_cu_mskf.F.html#MSKF_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3222'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>mskf_init</font>(RTHCUTEN,RQVCUTEN,RQCCUTEN,RQRCUTEN,        &amp; <A href='../../call_to/MSKF_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/MSKF_INIT.html' TARGET='index'>1</A><a name='3223'>
                     RQICUTEN,RQSCUTEN,NCA,W0AVG,P_QI,P_QS,         &amp;<a name='3224'>
                     SVP1,SVP2,SVP3,SVPT0,                          &amp;<a name='3225'>
                     P_FIRST_SCALAR,restart,allowed_to_read,        &amp;<a name='3226'>
                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='3227'>
                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='3228'>
                     its, ite, jts, jte, kts, kte                   )<a name='3229'>
<font color=#447700>!--------------------------------------------------------------------<a name='3230'></font>
   IMPLICIT NONE<a name='3231'>
<font color=#447700>!--------------------------------------------------------------------<a name='3232'></font>
   LOGICAL , INTENT(IN)           ::  restart,allowed_to_read<a name='3233'>
   INTEGER , INTENT(IN)           ::  ids, ide, jds, jde, kds, kde, &amp;<a name='3234'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='3235'>
                                      its, ite, jts, jte, kts, kte<a name='3236'>
   INTEGER , INTENT(IN)           ::  P_QI,P_QS,P_FIRST_SCALAR<a name='3237'>
<a name='3238'>
   REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) ::       &amp;<a name='3239'>
                                                          RTHCUTEN, &amp;<a name='3240'>
                                                          RQVCUTEN, &amp;<a name='3241'>
                                                          RQCCUTEN, &amp;<a name='3242'>
                                                          RQRCUTEN, &amp;<a name='3243'>
                                                          RQICUTEN, &amp;<a name='3244'>
                                                          RQSCUTEN<a name='3245'>
<a name='3246'>
   REAL ,   DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) :: W0AVG<a name='3247'>
<a name='3248'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT):: NCA<a name='3249'>
<a name='3250'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3251'>
   REAL, INTENT(IN)    :: SVP1,SVP2,SVP3,SVPT0<a name='3252'>
<a name='3253'>
   jtf=min0(jte,jde-1)<a name='3254'>
   ktf=min0(kte,kde-1)<a name='3255'>
   itf=min0(ite,ide-1)<a name='3256'>
<a name='3257'>
   IF(.not.restart)THEN<a name='3258'>
<a name='3259'>
      DO j=jts,jtf<a name='3260'>
      DO k=kts,ktf<a name='3261'>
      DO i=its,itf<a name='3262'>
         RTHCUTEN(i,k,j)=0.<a name='3263'>
         RQVCUTEN(i,k,j)=0.<a name='3264'>
         RQCCUTEN(i,k,j)=0.<a name='3265'>
         RQRCUTEN(i,k,j)=0.<a name='3266'>
      ENDDO<a name='3267'>
      ENDDO<a name='3268'>
      ENDDO<a name='3269'>
<a name='3270'>
      IF (P_QI .ge. P_FIRST_SCALAR) THEN<a name='3271'>
         DO j=jts,jtf<a name='3272'>
         DO k=kts,ktf<a name='3273'>
         DO i=its,itf<a name='3274'>
            RQICUTEN(i,k,j)=0.<a name='3275'>
         ENDDO<a name='3276'>
         ENDDO<a name='3277'>
         ENDDO<a name='3278'>
      ENDIF<a name='3279'>
<a name='3280'>
      IF (P_QS .ge. P_FIRST_SCALAR) THEN<a name='3281'>
         DO j=jts,jtf<a name='3282'>
         DO k=kts,ktf<a name='3283'>
         DO i=its,itf<a name='3284'>
            RQSCUTEN(i,k,j)=0.<a name='3285'>
         ENDDO<a name='3286'>
         ENDDO<a name='3287'>
         ENDDO<a name='3288'>
      ENDIF<a name='3289'>
<a name='3290'>
      DO j=jts,jtf<a name='3291'>
      DO i=its,itf<a name='3292'>
         NCA(i,j)=-100.<a name='3293'>
      ENDDO<a name='3294'>
      ENDDO<a name='3295'>
<a name='3296'>
      DO j=jts,jtf<a name='3297'>
      DO k=kts,ktf<a name='3298'>
      DO i=its,itf<a name='3299'>
         W0AVG(i,k,j)=0.<a name='3300'>
      ENDDO<a name='3301'>
      ENDDO<a name='3302'>
      ENDDO<a name='3303'>
<a name='3304'>
   endif<a name='3305'>
 <a name='3306'>
   CALL <A href='../../html_code/phys/module_cu_mskf.F.html#KF_LUTAB'>KF_LUTAB</A><A href='../../html_code/phys/module_cu_mskf.F.html#MSKF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="KF_LUTAB_2">(SVP1,SVP2,SVP3,SVPT0)<a name='3307'>
<a name='3308'>
   END SUBROUTINE mskf_init<a name='3309'>
<a name='3310'>
<font color=#447700>!-------------------------------------------------------<a name='3311'></font>
<a name='3312'>
<A NAME='KF_LUTAB'><A href='../../html_code/phys/module_cu_mskf.F.html#KF_LUTAB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3313'>
      <font color=#993300>subroutine </font><font color=#cc0000>kf_lutab</font>(SVP1,SVP2,SVP3,SVPT0) <A href='../../call_to/KF_LUTAB.html' TARGET='index'>2</A><a name='3314'>
<font color=#447700>!<a name='3315'></font>
<font color=#447700>!  This subroutine is a lookup table.<a name='3316'></font>
<font color=#447700>!  Given a series of series of saturation equivalent potential <a name='3317'></font>
<font color=#447700>!  temperatures, the temperature is calculated.<a name='3318'></font>
<font color=#447700>!<a name='3319'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='3320'></font>
   IMPLICIT NONE<a name='3321'>
<font color=#447700>!--------------------------------------------------------------------<a name='3322'></font>
<font color=#447700>! Lookup table variables<a name='3323'></font>
<font color=#447700>!     INTEGER, SAVE, PARAMETER :: KFNT=250,KFNP=220<a name='3324'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNT,1:KFNP) :: TTAB,QSTAB<a name='3325'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:KFNP) :: THE0K<a name='3326'></font>
<font color=#447700>!     REAL, SAVE, DIMENSION(1:200) :: ALU<a name='3327'></font>
<font color=#447700>!     REAL, SAVE :: RDPR,RDTHK,PLUTOP<a name='3328'></font>
<font color=#447700>! End of Lookup table variables<a name='3329'></font>
<a name='3330'>
     INTEGER :: KP,IT,ITCNT,I<a name='3331'>
     REAL :: DTH,TMIN,TOLER,PBOT,DPR,                               &amp;<a name='3332'>
             TEMP,P,ES,QS,PI,THES,TGUES,THGUES,F0,T1,T0,THGS,F1,DT, &amp;<a name='3333'>
             ASTRT,AINC,A1,THTGS<a name='3334'>
<font color=#447700>!    REAL    :: ALIQ,BLIQ,CLIQ,DLIQ,SVP1,SVP2,SVP3,SVPT0<a name='3335'></font>
     REAL    :: ALIQ,BLIQ,CLIQ,DLIQ<a name='3336'>
     REAL, INTENT(IN)    :: SVP1,SVP2,SVP3,SVPT0<a name='3337'>
<font color=#447700>!<a name='3338'></font>
<font color=#447700>! equivalent potential temperature increment<a name='3339'></font>
      data dth/1./<a name='3340'>
<font color=#447700>! minimum starting temp <a name='3341'></font>
      data tmin/150./<a name='3342'>
<font color=#447700>! tolerance for accuracy of temperature <a name='3343'></font>
      data toler/0.001/<a name='3344'>
<font color=#447700>! top pressure (pascals)<a name='3345'></font>
      plutop=5000.0<a name='3346'>
<font color=#447700>! bottom pressure (pascals)<a name='3347'></font>
      pbot=110000.0<a name='3348'>
<a name='3349'>
      ALIQ = SVP1*1000.<a name='3350'>
      BLIQ = SVP2<a name='3351'>
      CLIQ = SVP2*SVPT0<a name='3352'>
      DLIQ = SVP3<a name='3353'>
<a name='3354'>
<font color=#447700>!<a name='3355'></font>
<font color=#447700>! compute parameters<a name='3356'></font>
<font color=#447700>!<a name='3357'></font>
<font color=#447700>! 1._over_(sat. equiv. theta increment)<a name='3358'></font>
      rdthk=1./dth<a name='3359'>
<font color=#447700>! pressure increment<a name='3360'></font>
<font color=#447700>!<a name='3361'></font>
      DPR=(PBOT-PLUTOP)/REAL(KFNP-1)<a name='3362'>
<font color=#447700>!      dpr=(pbot-plutop)/REAL(kfnp-1)<a name='3363'></font>
<font color=#447700>! 1._over_(pressure increment)<a name='3364'></font>
      rdpr=1./dpr<a name='3365'>
<font color=#447700>! compute the spread of thes<a name='3366'></font>
<font color=#447700>!     thespd=dth*(kfnt-1)<a name='3367'></font>
<font color=#447700>!<a name='3368'></font>
<font color=#447700>! calculate the starting sat. equiv. theta<a name='3369'></font>
<font color=#447700>!<a name='3370'></font>
      temp=tmin <a name='3371'>
      p=plutop-dpr<a name='3372'>
      do kp=1,kfnp<a name='3373'>
        p=p+dpr<a name='3374'>
        es=aliq*exp((bliq*temp-cliq)/(temp-dliq))<a name='3375'>
        qs=0.622*es/(p-es)<a name='3376'>
        pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='3377'>
        the0k(kp)=temp*pi*exp((3374.6525/temp-2.5403)*qs*        &amp;<a name='3378'>
               (1.+0.81*qs))<a name='3379'>
      enddo   <a name='3380'>
<font color=#447700>!<a name='3381'></font>
<font color=#447700>! compute temperatures for each sat. equiv. potential temp.<a name='3382'></font>
<font color=#447700>!<a name='3383'></font>
      p=plutop-dpr<a name='3384'>
      do kp=1,kfnp<a name='3385'>
        thes=the0k(kp)-dth<a name='3386'>
        p=p+dpr<a name='3387'>
        do it=1,kfnt<a name='3388'>
<font color=#447700>! define sat. equiv. pot. temp.<a name='3389'></font>
          thes=thes+dth<a name='3390'>
<font color=#447700>! iterate to find temperature<a name='3391'></font>
<font color=#447700>! find initial guess<a name='3392'></font>
          if(it.eq.1) then<a name='3393'>
            tgues=tmin<a name='3394'>
          else<a name='3395'>
            tgues=ttab(it-1,kp)<a name='3396'>
          endif<a name='3397'>
          es=aliq*exp((bliq*tgues-cliq)/(tgues-dliq))<a name='3398'>
          qs=0.622*es/(p-es)<a name='3399'>
          pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='3400'>
          thgues=tgues*pi*exp((3374.6525/tgues-2.5403)*qs*      &amp;<a name='3401'>
               (1.+0.81*qs))<a name='3402'>
          f0=thgues-thes<a name='3403'>
          t1=tgues-0.5*f0<a name='3404'>
          t0=tgues<a name='3405'>
          itcnt=0<a name='3406'>
<font color=#447700>! iteration loop<a name='3407'></font>
          do itcnt=1,11<a name='3408'>
            es=aliq*exp((bliq*t1-cliq)/(t1-dliq))<a name='3409'>
            qs=0.622*es/(p-es)<a name='3410'>
            pi=(1.e5/p)**(0.2854*(1.-0.28*qs))<a name='3411'>
            thtgs=t1*pi*exp((3374.6525/t1-2.5403)*qs*(1.+0.81*qs))<a name='3412'>
            f1=thtgs-thes<a name='3413'>
            if(abs(f1).lt.toler)then<a name='3414'>
              exit<a name='3415'>
            endif<a name='3416'>
<font color=#447700>!           itcnt=itcnt+1<a name='3417'></font>
            dt=f1*(t1-t0)/(f1-f0)<a name='3418'>
            t0=t1<a name='3419'>
            f0=f1<a name='3420'>
            t1=t1-dt<a name='3421'>
          enddo <a name='3422'>
          ttab(it,kp)=t1 <a name='3423'>
          qstab(it,kp)=qs<a name='3424'>
        enddo<a name='3425'>
      enddo   <a name='3426'>
<font color=#447700>!<a name='3427'></font>
<font color=#447700>! lookup table for tlog(emix/aliq)<a name='3428'></font>
<font color=#447700>!<a name='3429'></font>
<font color=#447700>! set up intial values for lookup tables<a name='3430'></font>
<font color=#447700>!<a name='3431'></font>
       astrt=1.e-3<a name='3432'>
       ainc=0.075<a name='3433'>
<font color=#447700>!<a name='3434'></font>
       a1=astrt-ainc<a name='3435'>
       do i=1,200<a name='3436'>
         a1=a1+ainc<a name='3437'>
         alu(i)=alog(a1)<a name='3438'>
       enddo   <a name='3439'>
<font color=#447700>!<a name='3440'></font>
   END SUBROUTINE KF_LUTAB<a name='3441'>
<a name='3442'>
END MODULE module_cu_mskf<a name='3443'>
</pre></body></html>