<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MEDIATION_LAYER:PHYSICS<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<A NAME='MODULE_SURFACE_DRIVER'><A href='../../html_code/phys/module_surface_driver.F.html#MODULE_SURFACE_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='4'>
<font color=#993300>MODULE </font><font color=#cc0000>module_surface_driver</font> <A href='../../call_to/MODULE_SURFACE_DRIVER.html' TARGET='index'>2</A><a name='5'>
CONTAINS<a name='6'>
<a name='7'>
<A NAME='SURFACE_DRIVER'><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>surface_driver</font>(                                         &amp; <A href='../../call_to/SURFACE_DRIVER.html' TARGET='index'>2</A>,<A href='../../call_from/SURFACE_DRIVER.html' TARGET='index'>142</A><a name='9'>
     &amp;           HYDRO_dt,sfcheadrt,INFXSRT,soldrain,                 &amp;<a name='10'>
     &amp;           acgrdflx,achfx,aclhf                                 &amp;<a name='11'>
     &amp;          ,acsnom,acsnow,snowfallac,akhs,akms,albedo,br,canwat  &amp;<a name='12'>
     &amp;          ,chklowq,dt,dx,dz8w,dzs,glw                           &amp;<a name='13'>
     &amp;          ,grdflx,gsw,swdown,gz1oz0,hfx,ht,ifsnow,isfflx        &amp;<a name='14'>
     &amp;          ,fractional_seaice,seaice_albedo_opt                  &amp;<a name='15'>
     &amp;          ,seaice_albedo_default,seaice_thickness_opt,          &amp;<a name='16'>
     &amp;          seaice_thickness_default                              &amp;<a name='17'>
     &amp;          ,seaice_snowdepth_opt,seaice_snowdepth_max            &amp;<a name='18'>
     &amp;          ,seaice_snowdepth_min,tice2tsk_if2cold                &amp;<a name='19'>
     &amp;          ,ifndalbsi, ifndicedepth, ifndsnowsi                  &amp;<a name='20'>
     &amp;          ,isltyp,itimestep,julian_in,ivgtyp,lowlyr,mavail,rmol &amp;<a name='21'>
     &amp;          ,num_soil_layers,p8w,pblh,pi_phy,pshltr,fm,fhh,psih   &amp;<a name='22'>
#if (NMM_CORE==1)<a name='23'>
     &amp;          ,psim,p_phy,q10,q2,qfx,taux,tauy,qsfc,qshltr,qz0      &amp;<a name='24'>
     &amp;          ,zkmax,ribn,charn,msang,scurx,scury,icoef_sf,iwavecpl,lcurr_sf &amp; <font color=#447700>!for gfdl-sf drag<a name='25'></font>
     &amp;          ,pert_Cd, ens_random_seed, ens_Cdamp                  &amp;<a name='26'>
     &amp;          ,cd_out,ch_out                                        &amp;<a name='27'>
#else<a name='28'>
     &amp;          ,psim,p_phy,q10,q2,qfx,qsfc,qshltr,qz0                &amp;<a name='29'>
#endif<a name='30'>
     &amp;          ,raincv,rho,sfcevp,sfcexc,sfcrunoff ,acrunoff         &amp;<a name='31'>
     &amp;          ,smois,smstav,smstot,snoalb,snow,snowc,snowh,stepbl   &amp;<a name='32'>
     &amp;          ,smcrel                                               &amp;<a name='33'>
     &amp;          ,th10,th2,thz0,th_phy,tmn,tshltr,tsk,tslb             &amp;<a name='34'>
     &amp;          ,tyr,tyra,tdly,tlag,lagday,nyear,nday,tmn_update,yr   &amp;<a name='35'>
     &amp;          ,t_phy,u10,udrunoff,ust,uz0                           &amp;<a name='36'>
     &amp;          ,u_frame,u_phy,v10,vegfra,uoce,voce                   &amp;<a name='37'>
     &amp;          ,vz0,v_frame,v_phy,warm_rain,wspd,xice,xland,z,znt    &amp;<a name='38'>
     &amp;          ,max_edom,cplmask                                     &amp;<a name='39'>
#if (HWRF==1)<a name='40'>
     &amp;          ,mznt                                                 &amp;<a name='41'>
#endif<a name='42'>
     &amp;          ,zs                                                   &amp; <a name='43'>
     &amp;          ,albsi, icedepth,snowsi                               &amp;<a name='44'>
#if (NMM_CORE==1)<a name='45'>
     &amp;          ,xicem,isice,iswater,ct,tke_pbl,sfenth                &amp;<a name='46'>
#else<a name='47'>
     &amp;          ,xicem,isice,iswater,ct,tke_pbl                       &amp;<a name='48'>
#endif<a name='49'>
     &amp;          ,albbck,embck,lh,sh2o,shdmax,shdmin,z0                &amp;<a name='50'>
     &amp;          ,flqc,flhc,psfc,sst,sst_input,sstsk,dtw,sst_update,sst_skin     &amp;<a name='51'>
     &amp;          ,scm_force_skintemp,scm_force_flux,t2,emiss           &amp;<a name='52'>
     &amp;          ,sf_sfclay_physics,sf_surface_physics,ra_lw_physics   &amp; <a name='53'>
     &amp;          ,mosaic_lu,mosaic_soil                                &amp;<a name='54'>
     &amp;          ,landusef,soilctop,soilcbot,ra,rs,nlcat,nscat,vegf_px &amp; <font color=#447700>! PX-LSM<a name='55'></font>
     &amp;          ,snowncv, anal_interval, lai, imperv, canfra          &amp; <font color=#447700>! PX-LSM<a name='56'></font>
     &amp;          ,pxlsm_smois_init, pxlsm_soil_nudge                   &amp; <font color=#447700>! PX-LSM<a name='57'></font>
     &amp;          ,idveg    ,iopt_crs  ,iopt_btr  ,iopt_run  ,iopt_sfc  ,iopt_frz     &amp;<a name='58'>
     &amp;          ,iopt_inf ,iopt_rad  ,iopt_alb  ,iopt_snf  ,iopt_tbot ,iopt_stc     &amp;<a name='59'>
     &amp;          ,iopt_gla ,iopt_rsf                                                 &amp;<a name='60'>
     &amp;          ,isnowxy  ,tvxy      ,tgxy      ,canicexy  ,canliqxy  ,eahxy        &amp;<a name='61'>
     &amp;          ,tahxy    ,cmxy      ,chxy      ,fwetxy    ,sneqvoxy  ,alboldxy     &amp;<a name='62'>
     &amp;          ,qsnowxy  ,wslakexy  ,zwtxy     ,waxy      ,wtxy      ,tsnoxy       &amp;<a name='63'>
     &amp;          ,zsnsoxy  ,snicexy   ,snliqxy   ,lfmassxy  ,rtmassxy  ,stmassxy     &amp;<a name='64'>
     &amp;          ,woodxy   ,stblcpxy  ,fastcpxy  ,xsaixy    ,taussxy                 &amp;<a name='65'>
     &amp;          ,grainxy  ,gddxy     ,cropcat   ,pgsxy                              &amp;<a name='66'>
     &amp;          ,planting ,harvest   ,season_gdd                                    &amp;<a name='67'>
     &amp;          ,t2mvxy   ,t2mbxy    ,q2mvxy    ,q2mbxy                             &amp;<a name='68'>
     &amp;          ,tradxy   ,neexy     ,gppxy     ,nppxy     ,fvegxy    ,runsfxy      &amp;<a name='69'>
     &amp;          ,runsbxy  ,ecanxy    ,edirxy    ,etranxy   ,fsaxy     ,firaxy       &amp;<a name='70'>
     &amp;          ,aparxy   ,psnxy     ,savxy     ,sagxy     ,rssunxy   ,rsshaxy      &amp;<a name='71'>
     &amp;          ,bgapxy   ,wgapxy    ,tgvxy     ,tgbxy     ,chvxy     ,chbxy        &amp;    <a name='72'>
     &amp;          ,shgxy    ,shcxy     ,shbxy     ,evgxy     ,evbxy     ,ghvxy        &amp;<a name='73'>
     &amp;          ,ghbxy    ,irgxy     ,ircxy     ,irbxy     ,trxy      ,evcxy        &amp;<a name='74'>
     &amp;          ,chleafxy ,chucxy    ,chv2xy    ,chb2xy    ,chstarxy                &amp;                      <a name='75'>
           <font color=#447700>! Noah-MP ground water<a name='76'></font>
     &amp;          ,smcwtdxy ,rechxy   ,deeprechxy,fdepthxy,areaxy   ,rivercondxy, riverbedxy &amp;<a name='77'>
     &amp;          ,eqzwt    ,pexpxy   ,qrfxy    ,qspringxy,qslatxy  ,qrfsxy   ,qspringsxy &amp;<a name='78'>
     &amp;          ,smoiseq  ,wtddt    ,stepwtd                                            &amp;<a name='79'>
     &amp;          ,opt_thcnd                                                 &amp;<a name='80'>
           <font color=#447700>! Noah UA changes<a name='81'></font>
     &amp;          ,ua_phys,flx4,fvb,fbur,fgsn                                  &amp;<a name='82'>
#if (EM_CORE==1)<a name='83'>
     &amp;          ,ch,tsq,qsq,cov,Sh3d,el_pbl,bl_mynn_cloudpdf          &amp; <font color=#447700>! MYNN<a name='84'></font>
     &amp;          ,icloud_bl,qc_bl,cldfra_bl                            &amp; <font color=#447700>! MYNN<a name='85'></font>
     &amp;          ,fgdp,dfgdp,vdfg,grav_settling                        &amp; <font color=#447700>! Katata - fog dep<a name='86'></font>
#endif<a name='87'>
     &amp;          ,lakedepth2d,  savedtke12d,  snowdp2d,   h2osno2d       &amp; <font color=#447700>!lake<a name='88'></font>
     &amp;          ,snl2d,        t_grnd2d,     t_lake3d,   lake_icefrac3d &amp; <font color=#447700>!lake<a name='89'></font>
     &amp;          ,z_lake3d,     dz_lake3d,    t_soisno3d, h2osoi_ice3d   &amp; <font color=#447700>!lake<a name='90'></font>
     &amp;          ,h2osoi_liq3d, h2osoi_vol3d, z3d,        dz3d           &amp; <font color=#447700>!lake<a name='91'></font>
     &amp;          ,zi3d,         watsat3d,     csol3d,     tkmg3d         &amp; <font color=#447700>!lake<a name='92'></font>
     &amp;          ,tkdry3d,      tksatu3d,     LakeModel,  lake_min_elev     &amp; <font color=#447700>!lake<a name='93'></font>
#if (EM_CORE==1)<a name='94'>
 <font color=#447700>!    &amp;          ,lakemask,  lakeflag                                  &amp; !lake<a name='95'></font>
     &amp;          ,lakemask                                  &amp; <font color=#447700>!lake<a name='96'></font>
#endif<a name='97'>
            <font color=#447700>!  cyl ocean variable<a name='98'></font>
                ,OM_TMP,OM_S,OM_U,OM_V,OM_DEPTH,OM_ML,OM_LON          &amp;<a name='99'>
     &amp;          ,OM_LAT,okms,okme,rdx,rdy,msfu,msfv,msft              &amp;<a name='100'>
     &amp;          ,XTIME,OM_TINI,OM_SINI,id,omdt                        &amp;<a name='101'>
<font color=#447700>! CLM variables<a name='102'></font>
     &amp;          ,numc,nump,sabv,sabg,lwup,snl,history_interval &amp;<a name='103'>
     &amp;          ,snowdp,wtc,wtp,h2osno,t_grnd,t_veg,         &amp;<a name='104'>
     &amp;           h2ocan,h2ocan_col,t2m_max,t2m_min,t2clm ,         &amp;<a name='105'>
     &amp;           t_ref2m,h2osoi_liq_s1,                 &amp;<a name='106'>
     &amp;           h2osoi_liq_s2,h2osoi_liq_s3,h2osoi_liq_s4,          &amp;<a name='107'>
     &amp;           h2osoi_liq_s5,h2osoi_liq1,h2osoi_liq2,              &amp;<a name='108'>
     &amp;           h2osoi_liq3,h2osoi_liq4,h2osoi_liq5,h2osoi_liq6,    &amp;<a name='109'>
     &amp;           h2osoi_liq7,h2osoi_liq8,h2osoi_liq9,h2osoi_liq10,   &amp;<a name='110'>
     &amp;           h2osoi_ice_s1,h2osoi_ice_s2,                        &amp;<a name='111'>
     &amp;           h2osoi_ice_s3,h2osoi_ice_s4,h2osoi_ice_s5,          &amp;<a name='112'>
     &amp;           h2osoi_ice1,h2osoi_ice2,h2osoi_ice3,h2osoi_ice4,    &amp;<a name='113'>
     &amp;           h2osoi_ice5,h2osoi_ice6,h2osoi_ice7,                &amp;<a name='114'>
     &amp;           h2osoi_ice8,h2osoi_ice9,h2osoi_ice10,               &amp;<a name='115'>
     &amp;           t_soisno_s1,t_soisno_s2,t_soisno_s3,t_soisno_s4,    &amp;<a name='116'>
     &amp;           t_soisno_s5,t_soisno1,t_soisno2,t_soisno3,          &amp;<a name='117'>
     &amp;           t_soisno4,t_soisno5,t_soisno6,t_soisno7,            &amp;<a name='118'>
     &amp;           t_soisno8,t_soisno9,t_soisno10,                     &amp;<a name='119'>
     &amp;           dzsnow1,dzsnow2,dzsnow3,dzsnow4,dzsnow5,            &amp;<a name='120'>
     &amp;           snowrds1,snowrds2,snowrds3,snowrds4,snowrds5,       &amp;<a name='121'>
     &amp;           t_lake1,t_lake2,t_lake3,t_lake4,t_lake5,            &amp;<a name='122'>
     &amp;           t_lake6,t_lake7,t_lake8,t_lake9,t_lake10,           &amp;<a name='123'>
     &amp;           h2osoi_vol1,h2osoi_vol2,h2osoi_vol3,                &amp;<a name='124'>
     &amp;           h2osoi_vol4,h2osoi_vol5,h2osoi_vol6,                &amp;<a name='125'>
     &amp;           h2osoi_vol7,h2osoi_vol8,                            &amp;<a name='126'>
     &amp;           h2osoi_vol9,h2osoi_vol10,                           &amp;<a name='127'>
     &amp;           maxpatch,inest,                                     &amp;<a name='128'>
     &amp;           ALBEDOsubgrid,LHsubgrid,HFXsubgrid,LWUPsubgrid,     &amp;<a name='129'>
     &amp;           Q2subgrid,SABVsubgrid,SABGsubgrid,NRAsubgrid,       &amp;<a name='130'>
     &amp;           SWUPsubgrid,LHsoi,LHveg,LHtran                      &amp;<a name='131'>
#ifdef CN<a name='132'>
<font color=#447700>!ADD_NEW_VAR for crop and cn<a name='133'></font>
     &amp;           ,dyntlai,dyntsai,dyntop,dynbot                              &amp;<a name='134'>
     &amp;           ,htmx,croplive,gdd1020,gdd820,gdd020,grainc,grainc_storage  &amp;<a name='135'>
     &amp;           ,grainc_xfer,grainn,grainn_storage,grainn_xfer,days_active  &amp;<a name='136'>
     &amp;           ,onset_flag,onset_counter,onset_gddflag,onset_fdd,onset_gdd &amp;<a name='137'>
     &amp;           ,onset_swi,offset_flag,offset_counter,offset_fdd,offset_swi &amp;<a name='138'>
     &amp;           ,dayl,annavg_t2m,tempavg_t2m,tempsum_potential_gpp          &amp;<a name='139'>
     &amp;           ,annsum_potential_gpp,tempmax_retransn,annmax_retransn      &amp;<a name='140'>
     &amp;           ,prev_leafc_to_litter,prev_frootc_to_litter,tempsum_npp     &amp;<a name='141'>
     &amp;           ,annsum_npp,leafc,leafc_storage,leafc_xfer,frootc           &amp;<a name='142'>
     &amp;           ,frootc_storage,frootc_xfer,livestemc,livestemc_storage     &amp;<a name='143'>
     &amp;           ,livestemc_xfer,deadstemc,deadstemc_storage,deadstemc_xfer  &amp;<a name='144'>
     &amp;           ,livecrootc,livecrootc_storage,livecrootc_xfer,deadcrootc   &amp;<a name='145'>
     &amp;           ,deadcrootc_storage,deadcrootc_xfer,cpool,pft_ctrunc        &amp;<a name='146'>
     &amp;           ,leafn,leafn_storage,leafn_xfer,frootn,frootn_storage       &amp;<a name='147'>
     &amp;           ,frootn_xfer,livestemn,livestemn_storage,livestemn_xfer     &amp;<a name='148'>
     &amp;           ,deadstemn,deadstemn_storage,deadstemn_xfer,livecrootn      &amp;<a name='149'>
     &amp;           ,livecrootn_storage,livecrootn_xfer,deadcrootn              &amp;<a name='150'>
     &amp;           ,deadcrootn_storage,deadcrootn_xfer,npool,pft_ntrunc        &amp;<a name='151'>
     &amp;           ,gresp_storage,gresp_xfer,xsmrpool,annsum_counter           &amp;<a name='152'>
     &amp;           ,cannsum_npp,cannavg_t2m,wf,me,mean_fire_prob,cwdc,litr1c   &amp;<a name='153'>
     &amp;           ,litr2c,litr3c,soil1c,soil2c,soil3c,soil4c,seedc,col_ctrunc &amp;<a name='154'>
     &amp;           ,prod10c,prod100c,cwdn,litr1n,litr2n,litr3n,soil1n,soil2n   &amp;<a name='155'>
     &amp;           ,soil3n,soil4n,seedn,col_ntrunc,prod10n,prod100n,sminn      &amp;<a name='156'>
     &amp;           ,totlitc,dwt_seedc_to_leaf,dwt_seedc_to_deadstem,dwt_conv_cflux &amp;<a name='157'>
     &amp;           ,dwt_prod10c_gain,dwt_prod100c_gain,prod100c_loss,dwt_frootc_to_litr1c &amp;<a name='158'>
     &amp;           ,dwt_frootc_to_litr2c,dwt_frootc_to_litr3c,dwt_livecrootc_to_cwdc &amp;<a name='159'>
     &amp;           ,dwt_deadcrootc_to_cwdc,dwt_seedn_to_leaf,dwt_seedn_to_deadstem &amp;<a name='160'>
     &amp;           ,dwt_conv_nflux,dwt_prod10n_gain,dwt_prod100n_gain,prod100n_loss &amp;<a name='161'>
     &amp;           ,dwt_frootn_to_litr1n,dwt_frootn_to_litr2n, dwt_frootn_to_litr3n &amp;<a name='162'>
     &amp;           ,dwt_livecrootn_to_cwdn,dwt_deadcrootn_to_cwdn,retransn &amp;<a name='163'>
#endif<a name='164'>
            <font color=#447700>!  Optional urban<a name='165'></font>
     &amp;          ,slope_rad,topo_shading,shadowmask                    &amp; <font color=#447700>!I solar<a name='166'></font>
     &amp;          ,swnorm,slope,slp_azi,diffuse_frac                    &amp; <font color=#447700>!I solar<a name='167'></font>
     &amp;          ,declin,solcon,coszen,hrang,xlat_urb2d                &amp; <font color=#447700>!I solar/urban<a name='168'></font>
     &amp;          ,num_roof_layers, num_wall_layers                     &amp; <font color=#447700>!I urban<a name='169'></font>
     &amp;          ,num_road_layers, dzr, dzb, dzg                       &amp; <font color=#447700>!I urban<a name='170'></font>
     &amp;          ,tr_urb2d,tb_urb2d,tg_urb2d,tc_urb2d,qc_urb2d         &amp; <font color=#447700>!H urban<a name='171'></font>
     &amp;          ,uc_urb2d                                             &amp; <font color=#447700>!H urban<a name='172'></font>
     &amp;          ,xxxr_urb2d,xxxb_urb2d,xxxg_urb2d,xxxc_urb2d          &amp; <font color=#447700>!H urban<a name='173'></font>
     &amp;          ,cmcr_urb2d,tgr_urb2d,tgrl_urb3d,smr_urb3d            &amp; <font color=#447700>!H urban<a name='174'></font>
     &amp;          ,julian,julyr,drelr_urb2d,drelb_urb2d,drelg_urb2d     &amp; <font color=#447700>!H urban<a name='175'></font>
     &amp;          ,flxhumr_urb2d,flxhumb_urb2d,flxhumg_urb2d            &amp; <font color=#447700>!H urban<a name='176'></font>
     &amp;          ,trl_urb3d,tbl_urb3d,tgl_urb3d                        &amp; <font color=#447700>!H urban<a name='177'></font>
     &amp;          ,sh_urb2d,lh_urb2d,g_urb2d,rn_urb2d,ts_urb2d          &amp; <font color=#447700>!H urban<a name='178'></font>
     &amp;          ,frc_urb2d, utype_urb2d                               &amp; <font color=#447700>!H urban<a name='179'></font>
     &amp;          ,cmr_sfcdif,chr_sfcdif,cmc_sfcdif,chc_sfcdif          &amp;<a name='180'>
     &amp;          ,cmgr_sfcdif,chgr_sfcdif                              &amp;<a name='181'>
<font color=#447700>!-----SSiB LSM (fds 06/2010)---------------------------------------------------<a name='182'></font>
     &amp;          ,alswvisdir, alswvisdif, alswnirdir, alswnirdif       &amp; <font color=#447700>! ssib<a name='183'></font>
     &amp;          ,swvisdir, swvisdif, swnirdir, swnirdif               &amp; <font color=#447700>! ssib<a name='184'></font>
     &amp;          ,ssib_br  ,ssib_fm  ,ssib_fh  ,ssib_cm  ,ssibxdd      &amp; <font color=#447700>! ssib<a name='185'></font>
     &amp;          ,ssib_lhf ,ssib_shf ,ssib_ghf ,ssib_egs ,ssib_eci     &amp; <font color=#447700>! ssib<a name='186'></font>
     &amp;          ,ssib_ect ,ssib_egi ,ssib_egt ,ssib_sdn ,ssib_sup     &amp; <font color=#447700>! ssib<a name='187'></font>
     &amp;          ,ssib_ldn ,ssib_lup ,ssib_wat ,ssib_shc ,ssib_shg     &amp; <font color=#447700>! ssib<a name='188'></font>
     &amp;          ,ssib_lai ,ssib_vcf ,ssib_z00 ,ssib_veg               &amp; <font color=#447700>! ssib<a name='189'></font>
     &amp;          ,ISNOW ,SWE ,SNOWDEN ,SNOWDEPTH ,TKAIR                &amp; <font color=#447700>! ssib-snow<a name='190'></font>
     &amp;          ,DZO1 ,WO1 ,TSSN1 ,TSSNO1 ,BWO1 ,BTO1                 &amp; <font color=#447700>! ssib-snow<a name='191'></font>
     &amp;          ,CTO1 ,FIO1 ,FLO1 ,BIO1 ,BLO1 ,HO1                    &amp; <font color=#447700>! ssib-snow<a name='192'></font>
     &amp;          ,DZO2 ,WO2 ,TSSN2 ,TSSNO2 ,BWO2 ,BTO2                 &amp; <font color=#447700>! ssib-snow<a name='193'></font>
     &amp;          ,CTO2 ,FIO2 ,FLO2 ,BIO2 ,BLO2 ,HO2                    &amp; <font color=#447700>! ssib-snow<a name='194'></font>
     &amp;          ,DZO3 ,WO3 ,TSSN3 ,TSSNO3 ,BWO3 ,BTO3                 &amp; <font color=#447700>! ssib-snow<a name='195'></font>
     &amp;          ,CTO3 ,FIO3 ,FLO3 ,BIO3 ,BLO3 ,HO3                    &amp; <font color=#447700>! ssib-snow<a name='196'></font>
     &amp;          ,DZO4 ,WO4 ,TSSN4 ,TSSNO4 ,BWO4 ,BTO4                 &amp; <font color=#447700>! ssib-snow<a name='197'></font>
     &amp;          ,CTO4 ,FIO4 ,FLO4 ,BIO4 ,BLO4 ,HO4                    &amp; <font color=#447700>! ssib-snow<a name='198'></font>
     &amp;          ,ra_sw_physics                                        &amp; <font color=#447700>! ssib <a name='199'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='200'></font>
     &amp;          , ids,ide,jds,jde,kds,kde                             &amp;<a name='201'>
     &amp;          , ims,ime,jms,jme,kms,kme                             &amp;<a name='202'>
     &amp;          , ips,ipe,jps,jpe,kps,kpe                             &amp;<a name='203'>
     &amp;          , i_start,i_end,j_start,j_end,kts,kte,num_tiles       &amp;<a name='204'>
             <font color=#447700>!  Optional moisture tracers<a name='205'></font>
     &amp;           ,qv_curr, qc_curr, qr_curr                           &amp;<a name='206'>
     &amp;           ,qi_curr, qs_curr, qg_curr                           &amp;<a name='207'>
             <font color=#447700>!  Optional moisture tracer flags<a name='208'></font>
     &amp;           ,f_qv,f_qc,f_qr                                      &amp;<a name='209'>
     &amp;           ,f_qi,f_qs,f_qg                                      &amp;<a name='210'>
             <font color=#447700>!  Other optionals (more or less em specific)<a name='211'></font>
     &amp;          ,capg,hol,mol                                         &amp;<a name='212'>
     &amp;          ,rainncv,rainshv,rainbl,regime,thc,graupelncv,hailncv &amp;<a name='213'>
     &amp;          ,qsg,qvg,qcg,soilt1,tsnav                             &amp;<a name='214'>
     &amp;          ,smfr3d,keepfr3dflag,dew,rhosnf,precipfr              &amp;<a name='215'>
             <font color=#447700>!  Other optionals (more or less nmm specific)<a name='216'></font>
     &amp;          ,potevp,snopcx,soiltb,sr                              &amp;<a name='217'>
             <font color=#447700>!  Optional observation PX LSM surface nudging<a name='218'></font>
     &amp;          ,t2_ndg_old, q2_ndg_old, t2_ndg_new, q2_ndg_new       &amp;<a name='219'>
     &amp;          ,sn_ndg_old, sn_ndg_new                               &amp;<a name='220'>
     &amp;          ,t2obs, q2obs                                         &amp;<a name='221'>
             <font color=#447700>! OPTIONAL, Required by TEMF surface layer 1/7/09 WA<a name='222'></font>
     &amp;          ,hd_temf,te_temf,fCor,exch_temf,wm_temf               &amp;<a name='223'>
             <font color=#447700>! Required by ideal SCM surface layer 1/6/10 WA<a name='224'></font>
     &amp;          ,hfx_force,lh_force,tsk_force                         &amp;<a name='225'>
     &amp;          ,hfx_force_tend,lh_force_tend,tsk_force_tend          &amp;<a name='226'>
             <font color=#447700>!  Optional observation nudging<a name='227'></font>
     &amp;          ,uratx,vratx,tratx                                    &amp;<a name='228'>
             <font color=#447700>!  Optional ocean model<a name='229'></font>
     &amp;          ,sf_ocean_physics,oml_hml0,oml_gamma                  &amp;<a name='230'>
     &amp;          ,tml,t0ml,hml,h0ml,huml,hvml,f,tmoml                  &amp;<a name='231'>
     &amp;          ,oml_relaxation_time                                  &amp;<a name='232'>
     &amp;          ,ustm,ck,cka,cd,cda,isftcflx,iz0tlnd                  &amp;<a name='233'>
     &amp;         ,isurban, mminlu                                       &amp;<a name='234'>
     &amp;          ,snotime                                              &amp;<a name='235'>
     &amp;           ,rdlai2d                                             &amp;<a name='236'>
     &amp;          ,usemonalb                                            &amp;<a name='237'>
     &amp;          ,noahres                                              &amp;<a name='238'>
             <font color=#447700>!  Optional adaptive time step<a name='239'></font>
     &amp;          ,bldt,curr_secs,adapt_step_flag,bldtacttime           &amp; <a name='240'>
         <font color=#447700>! Optional urban with BEP<a name='241'></font>
     &amp;          ,sf_urban_physics,gmt,xlat,xlong,julday               &amp;<a name='242'>
     &amp;          ,num_urban_layers                                     &amp; <font color=#447700>!multi-layer urban<a name='243'></font>
     &amp;          ,num_urban_hi                                         &amp; <font color=#447700>!multi-layer urban<a name='244'></font>
     &amp;          ,trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d              &amp; <font color=#447700>!multi-layer urban<a name='245'></font>
     &amp;          ,tlev_urb3d,qlev_urb3d                                &amp; <font color=#447700>!multi-layer urban<a name='246'></font>
     &amp;          ,tw1lev_urb3d,tw2lev_urb3d                            &amp; <font color=#447700>!multi-layer urban<a name='247'></font>
     &amp;          ,tglev_urb3d,tflev_urb3d                              &amp; <font color=#447700>!multi-layer urban<a name='248'></font>
     &amp;          ,sf_ac_urb3d,lf_ac_urb3d,cm_ac_urb3d                  &amp; <font color=#447700>!multi-layer urban<a name='249'></font>
     &amp;          ,sfvent_urb3d,lfvent_urb3d                            &amp; <font color=#447700>!multi-layer urban <a name='250'></font>
     &amp;          ,sfwin1_urb3d,sfwin2_urb3d                            &amp; <font color=#447700>!multi-layer urban       <a name='251'></font>
     &amp;          ,sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d            &amp; <font color=#447700>!multi-layer urban<a name='252'></font>
     &amp;          ,lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d                 &amp; <font color=#447700>!multi-layer urban<a name='253'></font>
     &amp;          ,mh_urb2d,stdh_urb2d,lf_urb2d                         &amp;           <a name='254'>
     &amp;          ,a_u_bep,a_v_bep,a_t_bep,a_q_bep                      &amp;<a name='255'>
     &amp;          ,b_u_bep,b_v_bep,b_t_bep,b_q_bep                      &amp;<a name='256'>
     &amp;          ,sf_bep,vl_bep                                        &amp;<a name='257'>
     &amp;          ,a_e_bep,b_e_bep,dlg_bep                              &amp;<a name='258'>
     &amp;          ,dl_u_bep                                             &amp;                          <a name='259'>
     &amp;          ,tsk_save                                             &amp; <font color=#447700>!for fractional seaice<a name='260'></font>
     &amp;          ,cldfra                                               &amp; <font color=#447700>!ssib<a name='261'></font>
     &amp;          ,sf_surface_mosaic,mosaic_cat,mosaic_cat_index                                    &amp; <font color=#447700>!danli mosaic<a name='262'></font>
     &amp;          ,landusef2,TSK_mosaic,QSFC_mosaic,TSLB_mosaic,SMOIS_mosaic,SH2O_mosaic            &amp; <font color=#447700>!danli mosaic<a name='263'></font>
     &amp;          ,CANWAT_mosaic,SNOW_mosaic,SNOWH_mosaic,SNOWC_mosaic                              &amp; <font color=#447700>!danli mosaic<a name='264'></font>
     &amp;          ,ALBEDO_mosaic,ALBBCK_mosaic, EMISS_mosaic, EMBCK_mosaic, ZNT_mosaic, Z0_mosaic   &amp; <font color=#447700>!danli mosaic<a name='265'></font>
     &amp;          ,HFX_mosaic,QFX_mosaic, LH_mosaic, GRDFLX_mosaic,SNOTIME_mosaic                   &amp; <font color=#447700>!danli mosaic<a name='266'></font>
     &amp;          ,TR_URB2D_mosaic,TB_URB2D_mosaic                      &amp;  <font color=#447700>!danli mosaic <a name='267'></font>
     &amp;          ,TG_URB2D_mosaic,TC_URB2D_mosaic                      &amp;  <font color=#447700>!danli mosaic <a name='268'></font>
     &amp;          ,QC_URB2D_mosaic,UC_URB2D_mosaic                      &amp;  <font color=#447700>!danli mosaic                  <a name='269'></font>
     &amp;          ,TRL_URB3D_mosaic,TBL_URB3D_mosaic                    &amp;  <font color=#447700>!danli mosaic <a name='270'></font>
     &amp;          ,TGL_URB3D_mosaic                                     &amp;  <font color=#447700>!danli mosaic <a name='271'></font>
     &amp;          ,SH_URB2D_mosaic,LH_URB2D_mosaic                      &amp;  <font color=#447700>!danli mosaic <a name='272'></font>
     &amp;          ,G_URB2D_mosaic,RN_URB2D_mosaic                       &amp;  <font color=#447700>!danli mosaic <a name='273'></font>
     &amp;          ,TS_URB2D_mosaic                                      &amp;  <font color=#447700>!danli mosaic <a name='274'></font>
     &amp;          ,TS_RUL2D_mosaic                                      &amp;  <font color=#447700>!danli mosaic     <a name='275'></font>
     &amp;          ,ZOL                                                  &amp;  <font color=#447700>!ckay<a name='276'></font>
     &amp;          ,SDA_HFX, SDA_QFX, HFX_BOTH, QFX_BOTH, QNORM, fasdas  &amp;  <font color=#447700>!fasdas<a name='277'></font>
     &amp;          ,spp_lsm,pattern_spp_lsm,field_sf                     &amp;  <font color=#447700>!SPP<a name='278'></font>
     &amp;          ,spp_pbl,pattern_spp_pbl                              &amp;  <font color=#447700>!SPP<a name='279'></font>
     &amp;                                                             )<a name='280'>
<a name='281'>
#if ( <font color=#447700>! NMM_CORE == 1 )<a name='282'></font>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_163">, ONLY : SFCLAYSCHEME              &amp;<a name='283'>
                                       ,SFCLAYREVSCHEME           &amp;<a name='284'>
                                       ,MYJSFCSCHEME              &amp;<a name='285'>
                                       ,QNSESFCSCHEME             &amp;<a name='286'>
                                       ,GFSSFCSCHEME              &amp;<a name='287'>
                                       ,PXSFCSCHEME               &amp;<a name='288'>
                                       ,NOAHMPSCHEME              &amp;<a name='289'>
                                       ,TEMFSFCSCHEME             &amp;<a name='290'>
                                       ,IDEALSCMSFCSCHEME         &amp;<a name='291'>
                                       ,SLABSCHEME                &amp;<a name='292'>
                                       ,LSMSCHEME                 &amp;<a name='293'>
                                       ,RUCLSMSCHEME              &amp;<a name='294'>
                                       ,PXLSMSCHEME               &amp;<a name='295'>
                                       ,CLMSCHEME                 &amp;<a name='296'>
                                       ,SSIBSCHEME                &amp; <font color=#447700>!ssib<a name='297'></font>
                                       ,MYNNSFCSCHEME             &amp;<a name='298'>
                                       ,OMLSCHEME                 &amp;<a name='299'>
                                       ,PWP3DSCHEME<a name='300'>
#else<a name='301'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_164">, ONLY : SFCLAYSCHEME              &amp;<a name='302'>
                                       ,SFCLAYREVSCHEME           &amp;<a name='303'>
                                       ,MYJSFCSCHEME              &amp;<a name='304'>
                                       ,QNSESFCSCHEME             &amp;<a name='305'>
                                       ,GFSSFCSCHEME              &amp;<a name='306'>
                                       ,PXSFCSCHEME               &amp;<a name='307'>
                                       ,NOAHMPSCHEME              &amp;<a name='308'>
                                       ,SLABSCHEME                &amp;<a name='309'>
                                       ,LSMSCHEME                 &amp;<a name='310'>
                                       ,RUCLSMSCHEME              &amp;<a name='311'>
                                       ,CLMSCHEME                 &amp;<a name='312'>
                                       ,PXLSMSCHEME               &amp;<a name='313'>
                                       ,TEMFSFCSCHEME             &amp;<a name='314'>
                                       ,GFDLSFCSCHEME             &amp;<a name='315'>
                                       ,SSIBSCHEME                &amp; <font color=#447700>! ssib<a name='316'></font>
                                       ,GFDLSLAB <a name='317'>
<a name='318'>
<a name='319'>
#endif<a name='320'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_103"><a name='321'>
<font color=#447700>! *** add new modules of schemes here<a name='322'></font>
<a name='323'>
   USE <A href='../../html_code/phys/module_sf_sfclay.F.html#MODULE_SF_SFCLAY'>module_sf_sfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SFCLAY_3"><a name='324'>
   USE <A href='../../html_code/phys/module_sf_myjsfc.F.html#MODULE_SF_MYJSFC'>module_sf_myjsfc</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_MYJSFC_3"><a name='325'>
   USE <A href='../../html_code/phys/module_sf_qnsesfc.F.html#MODULE_SF_QNSESFC'>module_sf_qnsesfc</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_QNSESFC_2"><a name='326'>
   USE <A href='../../html_code/phys/module_sf_gfs.F.html#MODULE_SF_GFS'>module_sf_gfs</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_GFS_1"><a name='327'>
   USE <A href='../../html_code/phys/module_sf_noahdrv.F.html#MODULE_SF_NOAHDRV'>module_sf_noahdrv</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHDRV_2">                           <font color=#447700>! danli mosaic, the " ,only : lsm " needs to be deleted <a name='328'></font>
   USE <A href='../../html_code/phys/module_sf_noahlsm.F.html#MODULE_SF_NOAHLSM'>module_sf_noahlsm</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHLSM_7">, only : LOW_DENSITY_RESIDENTIAL, HIGH_DENSITY_RESIDENTIAL, HIGH_INTENSITY_INDUSTRIAL<a name='329'>
   USE <A href='../../html_code/phys/module_sf_noahmpdrv.F.html#MODULE_SF_NOAHMPDRV'>module_sf_noahmpdrv</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHMPDRV_2">, only : noahmplsm, noahmp_urban<a name='330'>
   USE <A href='../../html_code/phys/module_sf_noahmp_groundwater.F.html#MODULE_SF_NOAHMP_GROUNDWATER'>module_sf_noahmp_groundwater</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAHMP_GROUNDWATER_2"><a name='331'>
   USE <A href='../../html_code/phys/module_sf_noah_seaice_drv.F.html#MODULE_SF_NOAH_SEAICE_DRV'>module_sf_noah_seaice_drv</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAH_SEAICE_DRV_1"><a name='332'>
#ifdef WRF_USE_CLM<a name='333'>
   USE <A href='../../html_code/phys/module_sf_clm.F.html#MODULE_SF_CLM'>module_sf_clm</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_CLM_2"><a name='334'>
#endif<a name='335'>
   USE <A href='../../html_code/phys/module_sf_ssib.F.html#MODULE_SF_SSIB'>module_sf_ssib</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SSIB_1">  <font color=#447700>! ssib<a name='336'></font>
   USE <A href='../../html_code/phys/module_sf_ruclsm.F.html#MODULE_SF_RUCLSM'>module_sf_ruclsm</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_RUCLSM_2"><a name='337'>
   USE <A href='../../html_code/phys/module_sf_pxsfclay.F.html#MODULE_SF_PXSFCLAY'>module_sf_pxsfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_PXSFCLAY_2"><a name='338'>
   USE <A href='../../html_code/phys/module_sf_pxlsm.F.html#MODULE_SF_PXLSM'>module_sf_pxlsm</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_PXLSM_2"><a name='339'>
   USE <A href='../../html_code/phys/module_sf_temfsfclay.F.html#MODULE_SF_TEMFSFCLAY'>module_sf_temfsfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_TEMFSFCLAY_2"><a name='340'>
   USE <A href='../../html_code/phys/module_sf_sfclayrev.F.html#MODULE_SF_SFCLAYREV'>module_sf_sfclayrev</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SFCLAYREV_2"><a name='341'>
   USE <A href='../../html_code/phys/module_sf_noah_seaice_drv.F.html#MODULE_SF_NOAH_SEAICE_DRV'>module_sf_noah_seaice_drv</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_NOAH_SEAICE_DRV_2"><a name='342'>
#if ( EM_CORE==1)<a name='343'>
   USE <A href='../../html_code/phys/module_sf_mynn.F.html#MODULE_SF_MYNN'>module_sf_mynn</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_MYNN_2"><a name='344'>
   USE <A href='../../html_code/phys/module_sf_fogdes.F.html#MODULE_SF_FOGDES'>module_sf_fogdes</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_FOGDES_1">    <font color=#447700>! Katata - fog deposition module<a name='345'></font>
   USE <A href='../../html_code/phys/module_sf_ocean_driver.F.html#MODULE_SF_OCEAN_DRIVER'>module_sf_ocean_driver</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_OCEAN_DRIVER_1"><a name='346'>
   USE <A href='../../html_code/phys/module_sf_idealscmsfclay.F.html#MODULE_SF_IDEALSCMSFCLAY'>module_sf_idealscmsfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_IDEALSCMSFCLAY_1"><a name='347'>
#endif<a name='348'>
   USE <A href='../../html_code/phys/module_sf_scmflux.F.html#MODULE_SF_SCMFLUX'>module_sf_scmflux</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SCMFLUX_1">       <a name='349'>
   USE <A href='../../html_code/phys/module_sf_scmskintemp.F.html#MODULE_SF_SCMSKINTEMP'>module_sf_scmskintemp</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SCMSKINTEMP_1"><a name='350'>
<a name='351'>
#if ( NMM_CORE == 1 )<a name='352'>
   USE <A href='../../html_code/phys/module_sf_gfdl.F.html#MODULE_SF_GFDL'>module_sf_gfdl</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_GFDL_2"><a name='353'>
#endif<a name='354'>
<a name='355'>
   USE <A href='../../html_code/phys/module_sf_slab.F.html#MODULE_SF_SLAB'>module_sf_slab</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SLAB_2"><a name='356'>
<font color=#447700>!<a name='357'></font>
   USE <A href='../../html_code/phys/module_sf_sfcdiags.F.html#MODULE_SF_SFCDIAGS'>module_sf_sfcdiags</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SFCDIAGS_1"><a name='358'>
   USE <A href='../../html_code/phys/module_sf_sfcdiags_ruclsm.F.html#MODULE_SF_SFCDIAGS_RUCLSM'>module_sf_sfcdiags_ruclsm</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SFCDIAGS_RUCLSM_1"><a name='359'>
   USE <A href='../../html_code/phys/module_sf_sstskin.F.html#MODULE_SF_SSTSKIN'>module_sf_sstskin</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SSTSKIN_1"><a name='360'>
   USE <A href='../../html_code/phys/module_sf_tmnupdate.F.html#MODULE_SF_TMNUPDATE'>module_sf_tmnupdate</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_TMNUPDATE_1"><a name='361'>
   USE <A href='../../html_code/phys/module_sf_lake.F.html#MODULE_SF_LAKE'>module_sf_lake</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_LAKE_3"><a name='362'>
   USE <A href='../../html_code/frame/module_cpl.F.html#MODULE_CPL'>module_cpl</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CPL_8">, ONLY : coupler_on, cpl_rcv<a name='363'>
<font color=#447700>!<a name='364'></font>
<font color=#447700>!  This driver calls subroutines for the surface parameterizations.<a name='365'></font>
<font color=#447700>!<a name='366'></font>
<font color=#447700>!  surface layer: (between surface and pbl)<a name='367'></font>
<font color=#447700>!      1. sfclay<a name='368'></font>
<font color=#447700>!      2. myjsfc<a name='369'></font>
<font color=#447700>!      7. Pleim surface layer<a name='370'></font>
<font color=#447700>!      5. MYNN surface layer<a name='371'></font>
<font color=#447700>!  surface: ground temp/lsm scheme:<a name='372'></font>
<font color=#447700>!      1. slab<a name='373'></font>
<font color=#447700>!      2. Noah LSM<a name='374'></font>
<font color=#447700>!      7. Pleim-Xiu LSM<a name='375'></font>
<font color=#447700>!     11. Revised sfclay (option 1) <a name='376'></font>
<font color=#447700>!<a name='377'></font>
<font color=#447700>!  surface: ground temp/lsm scheme for urban:<a name='378'></font>
<font color=#447700>!      2.  BEP<a name='379'></font>
<font color=#447700>!<a name='380'></font>
<font color=#447700>!  ocean mixed layer model<a name='381'></font>
<font color=#447700>!      sf_ocean_physics = 1<a name='382'></font>
<font color=#447700>!  ocean 3d PWP<a name='383'></font>
<font color=#447700>!      sf_ocean_physics = 2<a name='384'></font>
<font color=#447700>!------------------------------------------------------------------<a name='385'></font>
   IMPLICIT NONE<a name='386'>
<font color=#447700>!======================================================================<a name='387'></font>
<font color=#447700>! Grid structure in physics part of WRF<a name='388'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='389'></font>
<font color=#447700>! The horizontal velocities used in the physics are unstaggered<a name='390'></font>
<font color=#447700>! relative to temperature/moisture variables. All predicted<a name='391'></font>
<font color=#447700>! variables are carried at half levels except w, which is at full<a name='392'></font>
<font color=#447700>! levels. Some arrays with names (*8w) are at w (full) levels.<a name='393'></font>
<font color=#447700>!<a name='394'></font>
<font color=#447700>!----------------------------------------------------------------------<a name='395'></font>
<font color=#447700>! In WRF, kms (smallest number) is the bottom level and kme (largest<a name='396'></font>
<font color=#447700>! number) is the top level.  In your scheme, if 1 is at the top level,<a name='397'></font>
<font color=#447700>! then you have to reverse the order in the k direction.<a name='398'></font>
<font color=#447700>!<a name='399'></font>
<font color=#447700>!         kme      -   half level (no data at this level)<a name='400'></font>
<font color=#447700>!         kme    ----- full level<a name='401'></font>
<font color=#447700>!         kme-1    -   half level<a name='402'></font>
<font color=#447700>!         kme-1  ----- full level<a name='403'></font>
<font color=#447700>!         .<a name='404'></font>
<font color=#447700>!         kms+2    -   half level<a name='405'></font>
<font color=#447700>!         kms+2  ----- full level<a name='406'></font>
<font color=#447700>!         kms+1    -   half level<a name='407'></font>
<font color=#447700>!         kms+1  ----- full level<a name='408'></font>
<font color=#447700>!         kms      -   half level<a name='409'></font>
<font color=#447700>!         kms    ----- full level<a name='410'></font>
<font color=#447700>!<a name='411'></font>
<font color=#447700>!======================================================================<a name='412'></font>
<font color=#447700>! Definitions<a name='413'></font>
<font color=#447700>!-----------<a name='414'></font>
<font color=#447700>! Theta      potential temperature (K)<a name='415'></font>
<font color=#447700>! Qv         water vapor mixing ratio (kg/kg)<a name='416'></font>
<font color=#447700>! Qc         cloud water mixing ratio (kg/kg)<a name='417'></font>
<font color=#447700>! Qr         rain water mixing ratio (kg/kg)<a name='418'></font>
<font color=#447700>! Qi         cloud ice mixing ratio (kg/kg)<a name='419'></font>
<font color=#447700>! Qs         snow mixing ratio (kg/kg)<a name='420'></font>
<font color=#447700>!-----------------------------------------------------------------<a name='421'></font>
<font color=#447700>!-- itimestep     number of time steps<a name='422'></font>
<font color=#447700>!-- GLW           downward long wave flux at ground surface (W/m^2)<a name='423'></font>
<font color=#447700>!-- GSW           net short wave flux at ground surface (W/m^2)<a name='424'></font>
<font color=#447700>!-- SWDOWN        downward short wave flux at ground surface (W/m^2)<a name='425'></font>
<font color=#447700>!-- EMISS         surface emissivity (between 0 and 1)<a name='426'></font>
<font color=#447700>!-- TSK           surface temperature (K)<a name='427'></font>
<font color=#447700>!-- TMN           soil temperature at lower boundary (K)<a name='428'></font>
<font color=#447700>!-- TYR           annual mean surface temperature of previous year (K)<a name='429'></font>
<font color=#447700>!-- TYRA          accumulated surface temperature in the current year (K)<a name='430'></font>
<font color=#447700>!-- TLAG          mean surface temperature of previous 140 days (K)<a name='431'></font>
<font color=#447700>!-- TDLY          accumulated daily mean surface temperature of the current day (K)<a name='432'></font>
<font color=#447700>!-- XLAND         land mask (1 for land, 2 for water)<a name='433'></font>
<font color=#447700>!-- MAX_EDOM      number of external model domains<a name='434'></font>
<font color=#447700>!-- CPLMASK       coupling mask (0 for data read in wrflowinput, 1 data received from the coupler)<a name='435'></font>
<font color=#447700>!-- ZNT           thermal time-varying roughness length (m)<a name='436'></font>
<font color=#447700>!-- MZNT          momentum time-varying roughness length (m)<a name='437'></font>
<font color=#447700>!-- Z0            background roughness length (m)<a name='438'></font>
<font color=#447700>!-- MAVAIL        surface moisture availability (between 0 and 1)<a name='439'></font>
<font color=#447700>!-- UST           u* in similarity theory (m/s)<a name='440'></font>
<font color=#447700>!-- MOL           T* (similarity theory) (K)<a name='441'></font>
<font color=#447700>!-- HOL           PBL height over Monin-Obukhov length<a name='442'></font>
<font color=#447700>!-- PBLH          PBL height (m)<a name='443'></font>
<font color=#447700>!-- CAPG          heat capacity for soil (J/K/m^3)<a name='444'></font>
<font color=#447700>!-- THC           thermal inertia (Cal/cm/K/s^0.5)<a name='445'></font>
<font color=#447700>!-- SNOWC         flag indicating snow coverage (1 for snow cover)<a name='446'></font>
<font color=#447700>!-- HFX           net upward heat flux at the surface (W/m^2)<a name='447'></font>
<font color=#447700>!-- QFX           net upward moisture flux at the surface (kg/m^2/s)<a name='448'></font>
<font color=#447700>!-- TAUX          RHO*U**2 for ocean coupling<a name='449'></font>
<font color=#447700>!-- TAUY          RHO*U**2 for ocean coupling<a name='450'></font>
<font color=#447700>!-- LH            net upward latent heat flux at surface (W/m^2)<a name='451'></font>
<font color=#447700>!-- REGIME        flag indicating PBL regime (stable, unstable, etc.)<a name='452'></font>
<font color=#447700>!-- tke_pbl       turbulence kinetic energy from PBL schemes (m^2/s^2)<a name='453'></font>
<font color=#447700>!-- akhs          sfc exchange coefficient of heat/moisture from MYJ<a name='454'></font>
<font color=#447700>!-- akms          sfc exchange coefficient of momentum from MYJ<a name='455'></font>
<font color=#447700>!-- thz0          potential temperature at roughness length (K)<a name='456'></font>
<font color=#447700>!-- uz0           u wind component at roughness length (m/s)<a name='457'></font>
<font color=#447700>!-- vz0           v wind component at roughness length (m/s)<a name='458'></font>
<font color=#447700>!-- qsfc          specific humidity at lower boundary (kg/kg)<a name='459'></font>
<font color=#447700>!-- uratx         ratio of u over u10 (Added for obs-nudging)<a name='460'></font>
<font color=#447700>!-- vratx         ratio of v over v10 (Added for obs-nudging)<a name='461'></font>
<font color=#447700>!-- tratx         ratio of t over th2 (Added for obs-nudging)<a name='462'></font>
<font color=#447700>!-- u10           diagnostic 10-m u component from surface layer<a name='463'></font>
<font color=#447700>!-- v10           diagnostic 10-m v component from surface layer<a name='464'></font>
<font color=#447700>!-- UOCE          sea surface zonal currents (m s-1)<a name='465'></font>
<font color=#447700>!-- VOCE          sea surface meridional currents (m s-1)<a name='466'></font>
<font color=#447700>!-- th2           diagnostic 2-m theta from surface layer and lsm<a name='467'></font>
<font color=#447700>!-- t2            diagnostic 2-m temperature from surface layer and lsm<a name='468'></font>
<font color=#447700>!-- q2            diagnostic 2-m mixing ratio from surface layer and lsm<a name='469'></font>
<font color=#447700>!-- tshltr        diagnostic 2-m theta from MYJ<a name='470'></font>
<font color=#447700>!-- th10          diagnostic 10-m theta from MYJ<a name='471'></font>
<font color=#447700>!-- qshltr        diagnostic 2-m specific humidity from MYJ<a name='472'></font>
<font color=#447700>!-- q10           diagnostic 10-m specific humidity from MYJ<a name='473'></font>
<font color=#447700>!-- lowlyr        index of lowest model layer above ground<a name='474'></font>
<font color=#447700>!-- rr            dry air density (kg/m^3)<a name='475'></font>
<font color=#447700>!-- u_phy         u-velocity interpolated to theta points (m/s)<a name='476'></font>
<font color=#447700>!-- v_phy         v-velocity interpolated to theta points (m/s)<a name='477'></font>
<font color=#447700>!-- th_phy        potential temperature (K)<a name='478'></font>
<font color=#447700>!-- moist         moisture array (4D - last index is species) (kg/kg)<a name='479'></font>
<font color=#447700>!-- p_phy         pressure (Pa)<a name='480'></font>
<font color=#447700>!-- pi_phy        exner function (dimensionless)<a name='481'></font>
<font color=#447700>!-- pshltr        diagnostic shelter (2m) pressure from MYJ (Pa)<a name='482'></font>
<font color=#447700>!-- p8w           pressure at full levels (Pa)<a name='483'></font>
<font color=#447700>!-- t_phy         temperature (K)<a name='484'></font>
<font color=#447700>!-- dz8w          dz between full levels (m)<a name='485'></font>
<font color=#447700>!-- z             height above sea level (m)<a name='486'></font>
<font color=#447700>!-- DX            horizontal space interval (m)<a name='487'></font>
<font color=#447700>!-- DT            time step (second)<a name='488'></font>
<font color=#447700>!-- PSFC          pressure at the surface (Pa)<a name='489'></font>
<font color=#447700>!-- SST           sea-surface temperature (K)<a name='490'></font>
<font color=#447700>!-- SST_INPUT     sea-surface temperature read in wrflowinput (K) (= SST if no coupling)<a name='491'></font>
<font color=#447700>!-- SSTSK         skin sea-surface temperature (K)<a name='492'></font>
<font color=#447700>!-- DTW           warm layer temp diff (K)<a name='493'></font>
<font color=#447700>!-- TSLB<a name='494'></font>
<font color=#447700>!-- ZS<a name='495'></font>
<font color=#447700>!-- DZS<a name='496'></font>
<font color=#447700>!-- num_soil_layers number of soil layer<a name='497'></font>
<font color=#447700>!-- IFSNOW      ifsnow=1 for snow-cover effects<a name='498'></font>
<font color=#447700>!-- sf_ocean_physics       whether to call ocean model from slab (1 = oml, 2=3d PWP)<a name='499'></font>
<font color=#447700>!-- oml_hml0      initial mixed layer depth (if real-data not available, default 50 m)<a name='500'></font>
<font color=#447700>!-- oml_gamma     lapse rate below mixed layer in ocean (default 0.14 K m-1)<a name='501'></font>
<font color=#447700>!-- oml_relaxation_time   time the oml will take to get back to its original state (seconds)<a name='502'></font>
<font color=#447700>!-- ck            enthalpy exchange coeff at 10 meters<a name='503'></font>
<font color=#447700>!-- cd            momentum exchange coeff at 10 meters<a name='504'></font>
<font color=#447700>!-- cka           enthalpy exchange coeff at the lowest model level<a name='505'></font>
<font color=#447700>!-- cda           momentum exchange coeff at the lowest model level<a name='506'></font>
<font color=#447700>!!!!!!!!!!!!!!<a name='507'></font>
<font color=#447700>!<a name='508'></font>
<font color=#447700>!<a name='509'></font>
<font color=#447700>!-- LANDUSEF     Landuse fraction                      ! P-X LSM<a name='510'></font>
<font color=#447700>!-- SOILCTOP     Top soil fraction                     ! P-X LSM<a name='511'></font>
<font color=#447700>!-- SOILCBOT     Bottom soil fraction                  ! P-X LSM<a name='512'></font>
<font color=#447700>!-- RA           Aerodynamic resistence                ! P-X LSM<a name='513'></font>
<font color=#447700>!-- RS           Stomatal resistence                   ! P-X LSM<a name='514'></font>
<font color=#447700>!-- VEGF_PX      PX LSM internal LU-based Veg Fraction ! P-X LSM<a name='515'></font>
<font color=#447700>!-- IMPERV       Impervious surface fraction           ! P-X LSM<a name='516'></font>
<font color=#447700>!-- CANFRA       Canopy/Tree fraction                  ! P-X LSM<a name='517'></font>
<font color=#447700>!-- NLCAT        Number of landuse categories          ! P-X LSM<a name='518'></font>
<font color=#447700>!-- NSCAT        Number of soil categories             ! P-X LSM<a name='519'></font>
<font color=#447700>!-- ch - drag coefficient for heat/moisture            ! MYNN LSM<a name='520'></font>
<a name='521'>
<font color=#447700>!<a name='522'></font>
<font color=#447700>!-- ids           start index for i in domain<a name='523'></font>
<font color=#447700>!-- ide           end index for i in domain<a name='524'></font>
<font color=#447700>!-- jds           start index for j in domain<a name='525'></font>
<font color=#447700>!-- jde           end index for j in domain<a name='526'></font>
<font color=#447700>!-- kds           start index for k in domain<a name='527'></font>
<font color=#447700>!-- kde           end index for k in domain<a name='528'></font>
<font color=#447700>!-- ims           start index for i in memory<a name='529'></font>
<font color=#447700>!-- ime           end index for i in memory<a name='530'></font>
<font color=#447700>!-- jms           start index for j in memory<a name='531'></font>
<font color=#447700>!-- jme           end index for j in memory<a name='532'></font>
<font color=#447700>!-- kms           start index for k in memory<a name='533'></font>
<font color=#447700>!-- kme           end index for k in memory<a name='534'></font>
<font color=#447700>!-- ips           start index for i in patch<a name='535'></font>
<font color=#447700>!-- ipe           end index for i in patch<a name='536'></font>
<font color=#447700>!-- jps           start index for j in patch<a name='537'></font>
<font color=#447700>!-- jpe           end index for j in patch<a name='538'></font>
<font color=#447700>!-- kps           start index for k in patch<a name='539'></font>
<font color=#447700>!-- kpe           end index for k in patch<a name='540'></font>
<font color=#447700>!-- its           start index for i in tile<a name='541'></font>
<font color=#447700>!-- ite           end index for i in tile<a name='542'></font>
<font color=#447700>!-- jts           start index for j in tile<a name='543'></font>
<font color=#447700>!-- jte           end index for j in tile<a name='544'></font>
<font color=#447700>!-- kts           start index for k in tile<a name='545'></font>
<font color=#447700>!-- kte           end index for k in tile<a name='546'></font>
<font color=#447700>!<a name='547'></font>
<font color=#447700>!******************************************************************<a name='548'></font>
<font color=#447700>!------------------------------------------------------------------<a name='549'></font>
<a name='550'>
   INTEGER, INTENT(IN) ::                                             &amp;<a name='551'>
     &amp;           ids,ide,jds,jde,kds,kde                              &amp;<a name='552'>
     &amp;          ,ims,ime,jms,jme,kms,kme                              &amp;<a name='553'>
     &amp;          ,ips,ipe,jps,jpe,kps,kpe                              &amp;<a name='554'>
     &amp;          ,kts,kte,num_tiles<a name='555'>
<a name='556'>
   INTEGER, INTENT(IN)::   FRACTIONAL_SEAICE<a name='557'>
   INTEGER, INTENT(IN)::   SEAICE_ALBEDO_OPT<a name='558'>
   REAL,    INTENT(IN)::   SEAICE_ALBEDO_DEFAULT<a name='559'>
   INTEGER, INTENT(IN)::   SEAICE_THICKNESS_OPT<a name='560'>
   REAL,    INTENT(IN)::   SEAICE_THICKNESS_DEFAULT<a name='561'>
   INTEGER, INTENT(IN)::   SEAICE_SNOWDEPTH_OPT<a name='562'>
   REAL,    INTENT(IN)::   SEAICE_SNOWDEPTH_MAX<a name='563'>
   REAL,    INTENT(IN)::   SEAICE_SNOWDEPTH_MIN<a name='564'>
   INTEGER, INTENT(IN)::   IFNDALBSI<a name='565'>
   INTEGER, INTENT(IN)::   IFNDICEDEPTH<a name='566'>
   INTEGER, INTENT(IN)::   IFNDSNOWSI<a name='567'>
<a name='568'>
   INTEGER, INTENT(IN)::   NLCAT, mosaic_lu, mosaic_soil<a name='569'>
   INTEGER, INTENT(IN)::   NSCAT<a name='570'>
   INTEGER,  INTENT(IN )  :: LakeModel<a name='571'>
   REAL,     INTENT(IN)   :: lake_min_elev<a name='572'>
<a name='573'>
   INTEGER, INTENT(IN)::   history_interval<a name='574'>
<a name='575'>
   INTEGER, INTENT(IN) :: sf_sfclay_physics, sf_surface_physics,      &amp;<a name='576'>
                          sf_urban_physics,ra_lw_physics,sst_update,  &amp;<a name='577'>
                          ra_sw_physics                    <a name='578'>
   INTEGER, INTENT(IN),OPTIONAL :: sst_skin, tmn_update,              &amp;<a name='579'>
                                   scm_force_skintemp, scm_force_flux <a name='580'>
<a name='581'>
   INTEGER, DIMENSION(num_tiles), INTENT(IN) ::                       &amp;<a name='582'>
     &amp;           i_start,i_end,j_start,j_end<a name='583'>
<a name='584'>
   INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT )::  ISLTYP<a name='585'>
   INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   IVGTYP<a name='586'>
   INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   LOWLYR<a name='587'>
   INTEGER, INTENT(IN )::   IFSNOW<a name='588'>
   INTEGER, INTENT(IN )::   ISFFLX<a name='589'>
   INTEGER, INTENT(IN )::   ITIMESTEP<a name='590'>
   INTEGER, INTENT(IN )::   NUM_SOIL_LAYERS<a name='591'>
   REAL,    INTENT(IN ),OPTIONAL ::   JULIAN_in<a name='592'>
   INTEGER, INTENT(IN )::   LAGDAY<a name='593'>
   INTEGER, INTENT(IN )::   STEPBL<a name='594'>
   INTEGER, INTENT(IN )::   ISICE<a name='595'>
   INTEGER, INTENT(IN )::   ISWATER<a name='596'>
   INTEGER, INTENT(IN ), OPTIONAL :: ISURBAN<a name='597'>
   CHARACTER(LEN=*), INTENT(IN ), OPTIONAL :: MMINLU<a name='598'>
   LOGICAL, INTENT(IN )::   WARM_RAIN<a name='599'>
   LOGICAL, INTENT(IN)::   tice2tsk_if2cold<a name='600'>
   INTEGER, INTENT(INOUT ),OPTIONAL ::   NYEAR<a name='601'>
   REAL   , INTENT(INOUT ),OPTIONAL ::   NDAY<a name='602'>
   INTEGER, INTENT(IN ),OPTIONAL ::   YR<a name='603'>
   REAL , INTENT(IN )::   U_FRAME<a name='604'>
   REAL , INTENT(IN )::   V_FRAME<a name='605'>
<a name='606'>
  <font color=#447700>!added by Wei Yu for WRF_HYDRO <a name='607'></font>
   real ::  HYDRO_dt<a name='608'>
   REAL, DIMENSION( ims:ime , jms:jme ):: sfcheadrt,INFXSRT, soldrain<a name='609'>
<a name='610'>
#if (NMM_CORE==1)<a name='611'>
   real , intent(IN )::   SFENTH<a name='612'>
   INTEGER, INTENT(IN)::   ICOEF_SF<a name='613'>
   INTEGER, INTENT(IN)::   IWAVECPL<a name='614'>
   LOGICAL, INTENT(IN)::   LCURR_SF<a name='615'>
   logical,intent(in),optional  :: pert_Cd<a name='616'>
   integer,intent(in),optional  :: ens_random_seed<a name='617'>
   real,intent(in),optional     :: ens_Cdamp<a name='618'>
#endif<a name='619'>
   REAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), INTENT(INOUT)::   SMOIS<a name='620'>
   REAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), INTENT(INOUT)::   TSLB<a name='621'>
   REAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), INTENT(OUT)  ::   SMCREL<a name='622'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   GLW<a name='623'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   GSW,SWDOWN<a name='624'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   HT<a name='625'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   RAINCV<a name='626'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   SST<a name='627'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT ),OPTIONAL ::   SSTSK<a name='628'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN    ),OPTIONAL ::   SST_INPUT<a name='629'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT ),OPTIONAL ::   DTW<a name='630'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   TMN<a name='631'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT ),OPTIONAL ::   TYR<a name='632'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT ),OPTIONAL ::   TYRA<a name='633'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT ),OPTIONAL ::   TDLY<a name='634'>
   REAL, DIMENSION( ims:ime , 1:lagday , jms:jme ), INTENT(INOUT ),OPTIONAL ::   TLAG<a name='635'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   VEGFRA<a name='636'>
<font color=#447700>!------fds (06/2010)--------------------------<a name='637'></font>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   XICE<a name='638'>
<font color=#447700>!---------------------------------------------<a name='639'></font>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   ALBSI<a name='640'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   ICEDEPTH<a name='641'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   SNOWSI<a name='642'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   XLAND<a name='643'>
   INTEGER,                                          INTENT(IN   ) ::   MAX_EDOM<a name='644'>
   REAL, DIMENSION( ims:ime , 1:max_edom, jms:jme ), INTENT(IN   ), OPTIONAL ::   CPLMASK<a name='645'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   XICEM<a name='646'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   MAVAIL<a name='647'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT)::   SNOALB<a name='648'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   ACSNOW<a name='649'>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SNOTIME<a name='650'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   AKHS<a name='651'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   AKMS<a name='652'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   ALBEDO<a name='653'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   CANWAT<a name='654'>
<a name='655'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   GRDFLX<a name='656'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   HFX<a name='657'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   RMOL<a name='658'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   PBLH<a name='659'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   Q2<a name='660'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   QFX<a name='661'>
#if (NMM_CORE==1)<a name='662'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT):: TAUX<a name='663'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT):: TAUY<a name='664'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT):: cd_out<a name='665'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT):: ch_out<a name='666'>
#endif<a name='667'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   QSFC<a name='668'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   QZ0<a name='669'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   SFCRUNOFF<a name='670'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   ACRUNOFF<a name='671'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   SMSTAV<a name='672'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   SMSTOT<a name='673'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   SNOW<a name='674'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   SNOWC<a name='675'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   SNOWH<a name='676'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   TH2<a name='677'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   THZ0<a name='678'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   TSK<a name='679'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   UDRUNOFF<a name='680'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   UST<a name='681'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   UZ0<a name='682'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   VZ0<a name='683'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   WSPD<a name='684'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   ZNT<a name='685'>
#if (HWRF==1)<a name='686'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)::   MZNT<a name='687'>
#endif<a name='688'>
<font color=#447700>!-----fds (06/2010)---------------------------------------------<a name='689'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_LHF <font color=#447700>! SSiB output<a name='690'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_SHF <font color=#447700>! SSiB output<a name='691'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_GHF <font color=#447700>! SSiB output<a name='692'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_EGS <font color=#447700>! SSiB output<a name='693'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_ECI <font color=#447700>! SSiB output<a name='694'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_ECT <font color=#447700>! SSiB output<a name='695'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_EGI <font color=#447700>! SSiB output<a name='696'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_EGT <font color=#447700>! SSiB output<a name='697'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_SDN <font color=#447700>! SSiB output<a name='698'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_SUP <font color=#447700>! SSiB output<a name='699'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_LDN <font color=#447700>! SSiB output<a name='700'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_LUP <font color=#447700>! SSiB output<a name='701'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_WAT <font color=#447700>! SSiB output<a name='702'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_SHC <font color=#447700>! SSiB output<a name='703'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_SHG <font color=#447700>! SSiB output<a name='704'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_LAI <font color=#447700>! SSiB output<a name='705'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_VCF <font color=#447700>! SSiB output<a name='706'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_Z00 <font color=#447700>! SSiB output<a name='707'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   SSIB_VEG <font color=#447700>! SSiB output<a name='708'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   ALSWVISDIR<font color=#447700>! SSiB<a name='709'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   ALSWVISDIF<font color=#447700>! SSiB<a name='710'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   ALSWNIRDIR<font color=#447700>! SSiB<a name='711'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(OUT)::   ALSWNIRDIF<font color=#447700>! SSiB<a name='712'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(IN)::      SWVISDIR<font color=#447700>! SSiB<a name='713'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(IN)::      SWVISDIF<font color=#447700>! SSiB<a name='714'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(IN)::      SWNIRDIR<font color=#447700>! SSiB<a name='715'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(IN)::      SWNIRDIF<font color=#447700>! SSiB<a name='716'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SSiB_BR <font color=#447700>! SSiB<a name='717'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SSiB_FM <font color=#447700>! SSiB<a name='718'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SSiB_FH <font color=#447700>! SSiB<a name='719'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SSiB_CM <font color=#447700>! SSiB<a name='720'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SSiBXDD <font color=#447700>! SSiB<a name='721'></font>
   INTEGER, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT):: ISNOW  <font color=#447700>! ssib-snow<a name='722'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SWE     <font color=#447700>! ssib-snow<a name='723'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SNOWDEN <font color=#447700>! ssib-snow<a name='724'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT):: SNOWDEPTH <font color=#447700>! ssib-snow<a name='725'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TKAIR   <font color=#447700>! ssib-snow<a name='726'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   DZO1    <font color=#447700>! ssib-snow<a name='727'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   WO1     <font color=#447700>! ssib-snow<a name='728'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TSSN1   <font color=#447700>! ssib-snow<a name='729'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TSSNO1  <font color=#447700>! ssib-snow<a name='730'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BWO1    <font color=#447700>! ssib-snow<a name='731'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BTO1    <font color=#447700>! ssib-snow<a name='732'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   CTO1    <font color=#447700>! ssib-snow<a name='733'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   FIO1    <font color=#447700>! ssib-snow<a name='734'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   FLO1    <font color=#447700>! ssib-snow<a name='735'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BIO1    <font color=#447700>! ssib-snow<a name='736'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BLO1    <font color=#447700>! ssib-snow<a name='737'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   HO1     <font color=#447700>! ssib-snow<a name='738'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   DZO2    <font color=#447700>! ssib-snow<a name='739'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   WO2     <font color=#447700>! ssib-snow<a name='740'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TSSN2   <font color=#447700>! ssib-snow<a name='741'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TSSNO2  <font color=#447700>! ssib-snow<a name='742'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BWO2    <font color=#447700>! ssib-snow<a name='743'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BTO2    <font color=#447700>! ssib-snow<a name='744'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   CTO2    <font color=#447700>! ssib-snow<a name='745'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   FIO2    <font color=#447700>! ssib-snow<a name='746'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   FLO2    <font color=#447700>! ssib-snow<a name='747'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BIO2    <font color=#447700>! ssib-snow<a name='748'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BLO2    <font color=#447700>! ssib-snow<a name='749'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   HO2     <font color=#447700>! ssib-snow<a name='750'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   DZO3    <font color=#447700>! ssib-snow<a name='751'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   WO3     <font color=#447700>! ssib-snow<a name='752'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TSSN3   <font color=#447700>! ssib-snow<a name='753'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TSSNO3  <font color=#447700>! ssib-snow<a name='754'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BWO3    <font color=#447700>! ssib-snow<a name='755'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BTO3    <font color=#447700>! ssib-snow<a name='756'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   CTO3    <font color=#447700>! ssib-snow<a name='757'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   FIO3    <font color=#447700>! ssib-snow<a name='758'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   FLO3    <font color=#447700>! ssib-snow<a name='759'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BIO3    <font color=#447700>! ssib-snow<a name='760'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BLO3    <font color=#447700>! ssib-snow<a name='761'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   HO3     <font color=#447700>! ssib-snow<a name='762'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   DZO4    <font color=#447700>! ssib-snow<a name='763'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   WO4     <font color=#447700>! ssib-snow<a name='764'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TSSN4   <font color=#447700>! ssib-snow<a name='765'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   TSSNO4  <font color=#447700>! ssib-snow<a name='766'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BWO4    <font color=#447700>! ssib-snow<a name='767'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BTO4    <font color=#447700>! ssib-snow<a name='768'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   CTO4    <font color=#447700>! ssib-snow<a name='769'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   FIO4    <font color=#447700>! ssib-snow<a name='770'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   FLO4    <font color=#447700>! ssib-snow<a name='771'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BIO4    <font color=#447700>! ssib-snow<a name='772'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   BLO4    <font color=#447700>! ssib-snow<a name='773'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT)::   HO4     <font color=#447700>! ssib-snow<a name='774'></font>
#if (NMM_CORE==1)<a name='775'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)::    CHARN, MSANG, SCURX, SCURY<a name='776'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   RIBN, ZKMAX<a name='777'>
#endif<a name='778'>
<font color=#447700>!----------------------------------------------------------<a name='779'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   BR<a name='780'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   CHKLOWQ<a name='781'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   GZ1OZ0<a name='782'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   PSHLTR<a name='783'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   FHH<a name='784'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   FM<a name='785'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   PSIH<a name='786'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   PSIM<a name='787'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   Q10<a name='788'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   QSHLTR<a name='789'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   TH10<a name='790'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   TSHLTR<a name='791'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   U10<a name='792'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   V10<a name='793'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   UOCE<a name='794'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   VOCE<a name='795'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(OUT)::   PSFC<a name='796'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)::   ACSNOM<a name='797'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)::   SFCEVP<a name='798'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT),OPTIONAL ::   ACHFX<a name='799'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT),OPTIONAL ::   ACLHF<a name='800'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT),OPTIONAL ::   ACGRDFLX<a name='801'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)::   SFCEXC<a name='802'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)::   FLHC<a name='803'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)::   FLQC<a name='804'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) ::   CT<a name='805'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   DZ8W<a name='806'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   P8W<a name='807'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   PI_PHY<a name='808'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   P_PHY<a name='809'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   RHO<a name='810'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   TH_PHY<a name='811'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   T_PHY<a name='812'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   U_PHY<a name='813'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   V_PHY<a name='814'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN )::   Z<a name='815'>
<a name='816'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::   TKE_PBL<a name='817'>
<a name='818'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),INTENT(INOUT),OPTIONAL ::   pattern_spp_lsm,field_sf<a name='819'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),INTENT(INOUT),OPTIONAL ::   pattern_spp_pbl<a name='820'>
   INTEGER, INTENT(IN), OPTIONAL                 ::     spp_lsm,spp_pbl<a name='821'>
<a name='822'>
   REAL, DIMENSION(1:num_soil_layers), INTENT(IN)::   DZS<a name='823'>
   REAL, DIMENSION(1:num_soil_layers), INTENT(IN)::   ZS<a name='824'>
   REAL, INTENT(IN )::   DT<a name='825'>
   REAL, INTENT(IN )::   DX<a name='826'>
   REAL,       INTENT(IN   ),OPTIONAL    ::     bldt<a name='827'>
   REAL,       INTENT(IN   ),OPTIONAL    ::     curr_secs<a name='828'>
   LOGICAL,    INTENT(IN   ),OPTIONAL    ::     adapt_step_flag<a name='829'>
   REAL,       INTENT(INOUT),OPTIONAL    ::     bldtacttime  <a name='830'>
<a name='831'>
<font color=#447700>!  arguments for NCAR surface physics<a name='832'></font>
<a name='833'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT )::   ALBBCK  <font color=#447700>! INOUT needed for NMM<a name='834'></font>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT )::   EMBCK<a name='835'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT )::   LH<a name='836'>
   REAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), INTENT(INOUT)::   SH2O<a name='837'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   SHDMAX<a name='838'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN )::   SHDMIN<a name='839'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT )::   Z0<a name='840'>
<a name='841'>
<font color=#447700>!  NoahMP specific fields<a name='842'></font>
<a name='843'>
   INTEGER, OPTIONAL, INTENT(IN) ::    idveg, iopt_crs, iopt_btr, iopt_run, iopt_sfc , iopt_frz, &amp;<a name='844'>
                                    iopt_inf, iopt_rad, iopt_alb, iopt_snf, iopt_tbot, iopt_stc, &amp;<a name='845'>
				    iopt_gla, iopt_rsf<a name='846'>
<a name='847'>
   INTEGER, OPTIONAL, DIMENSION(ims:ime , jms:jme),                    INTENT(INOUT) :: ISNOWXY,   PGSXY<a name='848'>
   REAL,    OPTIONAL, DIMENSION(ims:ime ,-2:num_soil_layers, jms:jme), INTENT(INOUT) :: ZSNSOXY<a name='849'>
   REAL,    OPTIONAL, DIMENSION(ims:ime ,-2:0,               jms:jme), INTENT(INOUT) :: TSNOXY, SNICEXY, SNLIQXY<a name='850'>
   REAL,    OPTIONAL, DIMENSION(ims:ime , jms:jme),                    INTENT(INOUT) ::                    &amp;<a name='851'>
           TVXY,    TGXY,CANICEXY,CANLIQXY,   EAHXY,   TAHXY,    CMXY,    CHXY,  FWETXY,SNEQVOXY,ALBOLDXY, &amp;<a name='852'>
        QSNOWXY,WSLAKEXY,   ZWTXY,    WAXY,    WTXY,LFMASSXY,RTMASSXY,STMASSXY,  WOODXY,STBLCPXY,FASTCPXY, &amp;<a name='853'>
	GRAINXY,   GDDXY,                                                                                  &amp;<a name='854'>
	 XSAIXY, TAUSSXY,  T2MVXY,  T2MBXY,  Q2MVXY,  Q2MBXY,  TRADXY,   NEEXY,   GPPXY,                   &amp;<a name='855'>
          NPPXY,  FVEGXY, RUNSFXY, RUNSBXY,  ECANXY,  EDIRXY, ETRANXY,   FSAXY,  FIRAXY,  APARXY,   PSNXY, &amp;<a name='856'>
	  SAVXY,   SAGXY, RSSUNXY, RSSHAXY,  BGAPXY,  WGAPXY,   TGVXY,   TGBXY,   CHVXY,   CHBXY,   SHGXY, &amp;<a name='857'>
	  SHCXY,   SHBXY,   EVGXY,   EVBXY,   GHVXY,   GHBXY,   IRGXY,   IRCXY,   IRBXY,    TRXY,   EVCXY, &amp;<a name='858'>
       CHLEAFXY,  CHUCXY,  CHV2XY,  CHB2XY,CHSTARXY                         <a name='859'>
   INTEGER,    OPTIONAL, DIMENSION(ims:ime , jms:jme), INTENT(IN) :: CROPCAT<a name='860'>
   REAL,    OPTIONAL, DIMENSION(ims:ime , jms:jme), INTENT(IN) :: PLANTING<a name='861'>
   REAL,    OPTIONAL, DIMENSION(ims:ime , jms:jme), INTENT(IN) :: HARVEST<a name='862'>
   REAL,    OPTIONAL, DIMENSION(ims:ime , jms:jme), INTENT(IN) :: SEASON_GDD<a name='863'>
<a name='864'>
<font color=#447700>!  NoahMP specific fields - runoff option 5<a name='865'></font>
<a name='866'>
   INTEGER, OPTIONAL, INTENT(IN)      :: stepwtd<a name='867'>
   REAL,    OPTIONAL, INTENT(IN)      :: wtddt<a name='868'>
   REAL,    OPTIONAL, DIMENSION(ims:ime , 1:num_soil_layers, jms:jme ), INTENT(INOUT)::  smoiseq<a name='869'>
   REAL,    OPTIONAL, DIMENSION(ims:ime , jms:jme),                    INTENT(INOUT) ::  &amp;<a name='870'>
    SMCWTDXY,   RECHXY, DEEPRECHXY, FDEPTHXY,  AREAXY,  RIVERCONDXY, RIVERBEDXY,  &amp;<a name='871'>
    EQZWT,      PEXPXY, QRFXY,      QSPRINGXY, QSLATXY, QRFSXY,      QSPRINGSXY                         <a name='872'>
<a name='873'>
   INTEGER, INTENT(IN )::   OPT_THCND<a name='874'>
<font color=#447700>! Noah UA changes<a name='875'></font>
   LOGICAL, INTENT(IN) :: ua_phys<a name='876'>
   REAL, DIMENSION(ims:ime , jms:jme), INTENT(OUT) ::  flx4,fvb,fbur,fgsn<a name='877'>
<a name='878'>
<font color=#447700>! Variables for multi-layer UCM<a name='879'></font>
   REAL, OPTIONAL, INTENT(IN  )   ::                                   GMT <a name='880'>
   INTEGER, OPTIONAL, INTENT(IN  ) ::                               JULDAY<a name='881'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   )        ::XLAT, XLONG<a name='882'>
   INTEGER, INTENT(IN )::   NUM_URBAN_LAYERS<a name='883'>
   INTEGER, INTENT(IN )::   NUM_URBAN_HI<a name='884'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: trb_urb4d<a name='885'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1_urb4d<a name='886'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2_urb4d<a name='887'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tgb_urb4d<a name='888'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tlev_urb3d<a name='889'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: qlev_urb3d<a name='890'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw1lev_urb3d<a name='891'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tw2lev_urb3d<a name='892'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tglev_urb3d<a name='893'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: tflev_urb3d<a name='894'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: lf_ac_urb3d<a name='895'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: sf_ac_urb3d<a name='896'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: cm_ac_urb3d<a name='897'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: sfvent_urb3d<a name='898'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: lfvent_urb3d<a name='899'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin1_urb3d<a name='900'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfwin2_urb3d<a name='901'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw1_urb3d<a name='902'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfw2_urb3d<a name='903'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfr_urb3d<a name='904'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_layers, jms:jme ), INTENT(INOUT) :: sfg_urb3d<a name='905'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_urban_hi, jms:jme ), INTENT(IN)  :: hi_urb2d  <font color=#447700>!urban<a name='906'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)  :: lp_urb2d  <font color=#447700>!urban<a name='907'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)  :: lb_urb2d  <font color=#447700>!urban<a name='908'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)  :: hgt_urb2d <font color=#447700>!urban<a name='909'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)  :: mh_urb2d  <font color=#447700>!urban<a name='910'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN)  :: stdh_urb2d<font color=#447700>!urban<a name='911'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, 4, jms:jme ), INTENT(IN)  :: lf_urb2d  <font color=#447700>!urban<a name='912'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_u_bep   <font color=#447700>!Implicit momemtum component X-direction<a name='913'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_v_bep   <font color=#447700>!Implicit momemtum component Y-direction<a name='914'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_t_bep   <font color=#447700>!Implicit component pot. temperature<a name='915'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_e_bep   <font color=#447700>!Implicit component TKE<a name='916'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::a_q_bep   <font color=#447700>!Implicit component TKE<a name='917'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_u_bep   <font color=#447700>!Explicit momentum component X-direction<a name='918'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_v_bep   <font color=#447700>!Explicit momentum component Y-direction<a name='919'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_t_bep   <font color=#447700>!Explicit component pot. temperature<a name='920'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_e_bep   <font color=#447700>!Explicit component TKE<a name='921'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::b_q_bep   <font color=#447700>!Explicit component TKE<a name='922'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::vl_bep    <font color=#447700>!Fraction air volume in grid cell<a name='923'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::dlg_bep   <font color=#447700>!Height above ground<a name='924'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::sf_bep  <font color=#447700>!Fraction air at the face of grid cell<a name='925'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) ::dl_u_bep  <font color=#447700>!Length scale<a name='926'></font>
<a name='927'>
<font color=#447700>!  arguments for Ocean Mixed Layer Model<a name='928'></font>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL, INTENT(INOUT )::   TML, T0ML, HML, H0ML, HUML, HVML<a name='929'>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL, INTENT(IN    )::   F, TMOML<a name='930'>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL, INTENT(OUT   )::   CK, CKA, CD, CDA<a name='931'>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL, INTENT(INOUT )::   USTM<a name='932'>
<a name='933'>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL, INTENT(INOUT )::   TSK_SAVE<a name='934'>
<a name='935'>
#if ( EM_CORE==1)<a name='936'>
   REAL, DIMENSION( ims:ime , jms:jme ), &amp;<a name='937'>
        &amp;OPTIONAL, INTENT(INOUT   ):: ch<a name='938'>
<a name='939'>
<font color=#447700>!Katata-added - extra in-output<a name='940'></font>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL, INTENT(INOUT):: fgdp,dfgdp,vdfg<a name='941'>
   INTEGER, OPTIONAL, INTENT(IN)                                :: grav_settling<a name='942'>
<font color=#447700>!Katata-end<a name='943'></font>
<a name='944'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ), &amp;<a name='945'>
        &amp;OPTIONAL, INTENT(IN   ):: tsq,qsq,cov,Sh3d,el_pbl,qc_bl,cldfra_bl<a name='946'>
   INTEGER, OPTIONAL, INTENT(IN)                                :: bl_mynn_cloudpdf, &amp;<a name='947'>
                                                                   icloud_bl<a name='948'>
#endif<a name='949'>
<a name='950'>
<a name='951'>
   INTEGER, OPTIONAL, INTENT(IN )::   slope_rad, topo_shading<a name='952'>
   INTEGER, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN):: shadowmask<a name='953'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT):: swnorm<a name='954'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN):: slope,slp_azi<a name='955'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN):: diffuse_frac<a name='956'>
<a name='957'>
   INTEGER, OPTIONAL, INTENT(IN )::   ISFTCFLX,IZ0TLND<a name='958'>
   INTEGER, OPTIONAL, INTENT(IN )::   SF_OCEAN_PHYSICS<a name='959'>
   REAL   , OPTIONAL, INTENT(IN )::   OML_HML0<a name='960'>
   REAL   , OPTIONAL, INTENT(IN )::   OML_GAMMA<a name='961'>
   REAL   , OPTIONAL, INTENT(IN )::   OML_RELAXATION_TIME<a name='962'>
<font color=#447700>!<a name='963'></font>
<font color=#447700>!  Observation nudging<a name='964'></font>
<font color=#447700>!<a name='965'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(OUT)::   uratx  <font color=#447700>!Added for obs-nudging<a name='966'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(OUT)::   vratx  <font color=#447700>!Added for obs-nudging<a name='967'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(OUT)::   tratx  <font color=#447700>!Added for obs-nudging<a name='968'></font>
<font color=#447700>!<a name='969'></font>
<font color=#447700>!  PX LSM Surface Grid Analysis nudging<a name='970'></font>
<font color=#447700>!<a name='971'></font>
   INTEGER, OPTIONAL, INTENT(IN)    :: pxlsm_smois_init, pxlsm_soil_nudge, ANAL_INTERVAL<a name='972'>
   REAL, DIMENSION( ims:ime, NLCAT, jms:jme ) , OPTIONAL, INTENT(INOUT)::   LANDUSEF<a name='973'>
   REAL, DIMENSION( ims:ime, NSCAT, jms:jme ) , OPTIONAL, INTENT(INOUT)::   SOILCTOP, SOILCBOT<a name='974'>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL, INTENT(INOUT):: IMPERV, CANFRA<a name='975'>
   REAL, DIMENSION( ims:ime , jms:jme ), OPTIONAL, INTENT(INOUT):: VEGF_PX<a name='976'>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT):: RA<a name='977'>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT):: RS<a name='978'>
   REAL, DIMENSION( ims:ime, jms:jme ) , OPTIONAL, INTENT(INOUT):: LAI<a name='979'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(OUT)::   T2OBS<a name='980'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(OUT)::   Q2OBS<a name='981'>
<a name='982'>
   REAL,       DIMENSION( ims:ime,  jms:jme ),                           &amp;<a name='983'>
               OPTIONAL, INTENT(INOUT)    ::      t2_ndg_old,            &amp;<a name='984'>
                                                  q2_ndg_old,            &amp;<a name='985'>
                                                  t2_ndg_new,            &amp;<a name='986'>
                                                  q2_ndg_new,            &amp;<a name='987'>
                                                  sn_ndg_old,            &amp;<a name='988'>
                                                  sn_ndg_new<a name='989'>
<font color=#447700>!<a name='990'></font>
<font color=#447700>!<a name='991'></font>
<font color=#447700>! Flags relating to the optional tendency arrays declared above<a name='992'></font>
<font color=#447700>! Models that carry the optional tendencies will provdide the<a name='993'></font>
<font color=#447700>! optional arguments at compile time; these flags all the model<a name='994'></font>
<font color=#447700>! to determine at run-time whether a particular tracer is in<a name='995'></font>
<font color=#447700>! use or not.<a name='996'></font>
<font color=#447700>!<a name='997'></font>
   LOGICAL, INTENT(IN), OPTIONAL ::                             &amp;<a name='998'>
                                                      f_qv      &amp;<a name='999'>
                                                     ,f_qc      &amp;<a name='1000'>
                                                     ,f_qr      &amp;<a name='1001'>
                                                     ,f_qi      &amp;<a name='1002'>
                                                     ,f_qs      &amp;<a name='1003'>
                                                     ,f_qg<a name='1004'>
<a name='1005'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                 &amp;<a name='1006'>
         OPTIONAL, INTENT(INOUT) ::                              &amp;<a name='1007'>
                      <font color=#447700>! optional moisture tracers<a name='1008'></font>
                      <font color=#447700>! 2 time levels; if only one then use CURR<a name='1009'></font>
                      qv_curr, qc_curr, qr_curr                  &amp;<a name='1010'>
                     ,qi_curr, qs_curr, qg_curr<a name='1011'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN)   ::   snowncv<a name='1012'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN)   ::   graupelncv<a name='1013'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN)   ::   hailncv<a name='1014'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   capg<a name='1015'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   emiss<a name='1016'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   hol<a name='1017'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   mol<a name='1018'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   regime<a name='1019'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN )::     rainncv<a name='1020'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN )::     rainshv<a name='1021'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   RAINBL<a name='1022'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   t2<a name='1023'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(IN )::     thc<a name='1024'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   qsg<a name='1025'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   qvg<a name='1026'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   qcg<a name='1027'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   dew<a name='1028'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   soilt1<a name='1029'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   tsnav<a name='1030'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   potevp <font color=#447700>! NMM LSM<a name='1031'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   snopcx <font color=#447700>! NMM LSM<a name='1032'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   soiltb <font color=#447700>! NMM LSM<a name='1033'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   sr <font color=#447700>! NMM and RUC LSM<a name='1034'></font>
   REAL, DIMENSION( ims:ime, 1:num_soil_layers, jms:jme ), OPTIONAL, INTENT(INOUT)::   smfr3d<a name='1035'>
   REAL, DIMENSION( ims:ime, 1:num_soil_layers, jms:jme ), OPTIONAL, INTENT(INOUT)::   keepfr3dflag<a name='1036'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   rhosnf <font color=#447700>!  density of snowfall<a name='1037'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(OUT) ::    precipfr <font color=#447700>! time-step frozen precip from RUC LSM<a name='1038'></font>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT)::   snowfallac <font color=#447700>!  density of snowfall<a name='1039'></font>
<a name='1040'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(OUT), OPTIONAL  ::   NOAHRES<a name='1041'>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT)          ::   ZOL<a name='1042'>
<a name='1043'>
   INTEGER, INTENT(IN) :: MAXPATCH, inest<a name='1044'>
<a name='1045'>
  integer, optional,  dimension(ims:ime,jms:jme ),intent(inout) :: numc,nump<a name='1046'>
  real,    optional,  dimension(ims:ime,jms:jme ),intent(inout) :: sabv,sabg,lwup<a name='1047'>
  integer, optional,  dimension(ims:ime,1:maxpatch,jms:jme ),intent(inout) :: snl<a name='1048'>
  real,    optional,  dimension(ims:ime,jms:jme ),intent(inout) ::t2m_max,t2m_min,t2clm<a name='1049'>
  real,    optional,  dimension(ims:ime,1:maxpatch,jms:jme ),intent(inout) ::  &amp;<a name='1050'>
                snowdp,wtc,wtp,h2osno,t_grnd,t_veg,         &amp;<a name='1051'>
                h2ocan,h2ocan_col,   &amp;<a name='1052'>
                t_ref2m,h2osoi_liq_s1,              &amp;<a name='1053'>
                h2osoi_liq_s2,h2osoi_liq_s3,h2osoi_liq_s4,          &amp;<a name='1054'>
                h2osoi_liq_s5,h2osoi_liq1,h2osoi_liq2,              &amp;<a name='1055'>
                h2osoi_liq3,h2osoi_liq4,h2osoi_liq5,h2osoi_liq6,    &amp;<a name='1056'>
                h2osoi_liq7,h2osoi_liq8,h2osoi_liq9,h2osoi_liq10,   &amp;<a name='1057'>
                h2osoi_ice_s1,h2osoi_ice_s2,                        &amp;<a name='1058'>
                h2osoi_ice_s3,h2osoi_ice_s4,h2osoi_ice_s5,          &amp;<a name='1059'>
                h2osoi_ice1,h2osoi_ice2,h2osoi_ice3,h2osoi_ice4,    &amp;<a name='1060'>
                h2osoi_ice5,h2osoi_ice6,h2osoi_ice7,                &amp;<a name='1061'>
                h2osoi_ice8,h2osoi_ice9,h2osoi_ice10,               &amp;<a name='1062'>
                t_soisno_s1,t_soisno_s2,t_soisno_s3,t_soisno_s4,    &amp;<a name='1063'>
                t_soisno_s5,t_soisno1,t_soisno2,t_soisno3,          &amp;<a name='1064'>
                t_soisno4,t_soisno5,t_soisno6,t_soisno7,            &amp;<a name='1065'>
                t_soisno8,t_soisno9,t_soisno10,                     &amp;<a name='1066'>
                dzsnow1,dzsnow2,dzsnow3,dzsnow4,dzsnow5,            &amp;<a name='1067'>
                snowrds1,snowrds2,snowrds3,snowrds4,snowrds5,       &amp;<a name='1068'>
                t_lake1,t_lake2,t_lake3,t_lake4,t_lake5,            &amp;<a name='1069'>
                t_lake6,t_lake7,t_lake8,t_lake9,t_lake10,           &amp;<a name='1070'>
                h2osoi_vol1,h2osoi_vol2,h2osoi_vol3,                &amp;<a name='1071'>
                h2osoi_vol4,h2osoi_vol5,h2osoi_vol6,                &amp;<a name='1072'>
                h2osoi_vol7,h2osoi_vol8,                            &amp;<a name='1073'>
                h2osoi_vol9,h2osoi_vol10,                           &amp;<a name='1074'>
                ALBEDOsubgrid,LHsubgrid,HFXsubgrid,LWUPsubgrid,     &amp;<a name='1075'>
                Q2subgrid,SABVsubgrid,SABGsubgrid,NRAsubgrid,SWUPsubgrid ,&amp;<a name='1076'>
                LHsoi,LHveg,LHtran<a name='1077'>
#ifdef CN<a name='1078'>
<font color=#447700>!ylu 05/31/2011<a name='1079'></font>
<a name='1080'>
<font color=#447700>!CROP&amp;CN restart and potential output<a name='1081'></font>
  integer, optional,  dimension(ims:ime,1:maxpatch,jms:jme ),intent(inout) :: croplive<a name='1082'>
  real,optional,dimension(ims:ime,1:maxpatch,jms:jme),intent(inout) :: &amp;<a name='1083'>
                 dyntlai,dyntsai,dyntop,dynbot,   &amp;<a name='1084'>
                 htmx,gdd1020,gdd820,gdd020,grainc,grainc_storage  &amp;<a name='1085'>
                ,grainc_xfer,grainn,grainn_storage,grainn_xfer,days_active  &amp;<a name='1086'>
                ,onset_flag,onset_counter,onset_gddflag,onset_fdd,onset_gdd &amp;<a name='1087'>
                ,onset_swi,offset_flag,offset_counter,offset_fdd,offset_swi &amp;<a name='1088'>
                ,dayl,annavg_t2m,tempavg_t2m,tempsum_potential_gpp          &amp;<a name='1089'>
                ,annsum_potential_gpp,tempmax_retransn,annmax_retransn      &amp;<a name='1090'>
                ,prev_leafc_to_litter,prev_frootc_to_litter,tempsum_npp     &amp;<a name='1091'>
                ,annsum_npp,leafc,leafc_storage,leafc_xfer,frootc           &amp;<a name='1092'>
                ,frootc_storage,frootc_xfer,livestemc,livestemc_storage     &amp;<a name='1093'>
                ,livestemc_xfer,deadstemc,deadstemc_storage,deadstemc_xfer  &amp;<a name='1094'>
                ,livecrootc,livecrootc_storage,livecrootc_xfer,deadcrootc   &amp;<a name='1095'>
                ,deadcrootc_storage,deadcrootc_xfer,cpool,pft_ctrunc        &amp;<a name='1096'>
                ,leafn,leafn_storage,leafn_xfer,frootn,frootn_storage       &amp;<a name='1097'>
                ,frootn_xfer,livestemn,livestemn_storage,livestemn_xfer     &amp;<a name='1098'>
                ,deadstemn,deadstemn_storage,deadstemn_xfer,livecrootn      &amp;<a name='1099'>
                ,livecrootn_storage,livecrootn_xfer,deadcrootn              &amp;<a name='1100'>
                ,deadcrootn_storage,deadcrootn_xfer,npool,pft_ntrunc        &amp;<a name='1101'>
                ,gresp_storage,gresp_xfer,xsmrpool,annsum_counter           &amp;<a name='1102'>
                ,cannsum_npp,cannavg_t2m,wf,me,mean_fire_prob,cwdc,litr1c   &amp;<a name='1103'>
                ,litr2c,litr3c,soil1c,soil2c,soil3c,soil4c,seedc,col_ctrunc &amp;<a name='1104'>
                ,prod10c,prod100c,cwdn,litr1n,litr2n,litr3n,soil1n,soil2n   &amp;<a name='1105'>
                ,soil3n,soil4n,seedn,col_ntrunc,prod10n,prod100n,sminn      &amp;<a name='1106'>
                ,totlitc,dwt_seedc_to_leaf,dwt_seedc_to_deadstem,dwt_conv_cflux &amp;<a name='1107'>
                ,dwt_prod10c_gain,dwt_prod100c_gain,prod100c_loss,dwt_frootc_to_litr1c &amp;<a name='1108'>
                ,dwt_frootc_to_litr2c,dwt_frootc_to_litr3c,dwt_livecrootc_to_cwdc &amp;<a name='1109'>
                ,dwt_deadcrootc_to_cwdc,dwt_seedn_to_leaf,dwt_seedn_to_deadstem &amp;<a name='1110'>
                ,dwt_conv_nflux,dwt_prod10n_gain,dwt_prod100n_gain,prod100n_loss &amp;<a name='1111'>
                ,dwt_frootn_to_litr1n,dwt_frootn_to_litr2n, dwt_frootn_to_litr3n &amp;<a name='1112'>
                , dwt_livecrootn_to_cwdn,dwt_deadcrootn_to_cwdn,retransn<a name='1113'>
#endif<a name='1114'>
<a name='1115'>
<a name='1116'>
<font color=#447700>! Variables for TEMF surface layer<a name='1117'></font>
   REAL,OPTIONAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT) :: te_temf<a name='1118'>
   REAL,OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: hd_temf, exch_temf, wm_temf<a name='1119'>
   REAL,OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: fCor<a name='1120'>
<a name='1121'>
<font color=#447700>! Variables for ideal SCM surface layer<a name='1122'></font>
   REAL,OPTIONAL, INTENT(INOUT) :: hfx_force,lh_force,tsk_force<a name='1123'>
   REAL,OPTIONAL, INTENT(IN   ) :: hfx_force_tend,lh_force_tend,tsk_force_tend<a name='1124'>
<a name='1125'>
<font color=#447700>!  LOCAL  VAR<a name='1126'></font>
<a name='1127'>
   REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ) ::v_phytmp<a name='1128'>
   REAL,       DIMENSION( ims:ime, kms:kme, jms:jme ) ::u_phytmp<a name='1129'>
<a name='1130'>
   REAL,       DIMENSION( ims:ime, jms:jme )          ::          &amp;<a name='1131'>
                                                             QGH, &amp;<a name='1132'>
                                                             CHS, &amp;<a name='1133'>
                                                             CQS, &amp;<a name='1134'>
                                                             CPM, &amp;<a name='1135'>
                                                            CHS2, &amp;<a name='1136'>
                                                            CQS2<a name='1137'>
<a name='1138'>
<font color=#447700>! SSIB local variables<a name='1139'></font>
   REAL ZDIFF<a name='1140'>
   REAL, DIMENSION( ims:ime , jms:jme ) :: XICE_save<a name='1141'>
<font color=#447700>!<a name='1142'></font>
   REAL    :: DTMIN,DTBL<a name='1143'>
<font color=#447700>!<a name='1144'></font>
   INTEGER :: i,J,K,NK,jj,ij<a name='1145'>
   INTEGER :: gfdl_ntsflg<a name='1146'>
   LOGICAL :: radiation, myj, frpcpn, isisfc<a name='1147'>
   LOGICAL, INTENT(in), OPTIONAL :: rdlai2d<a name='1148'>
   LOGICAL, INTENT(in), OPTIONAL :: usemonalb<a name='1149'>
   REAL    :: total_depth,mid_point_depth<a name='1150'>
   REAL    :: tconst,tprior,tnew,yrday,deltat<a name='1151'>
   REAL    :: SWSAVE<a name='1152'>
   REAL,       DIMENSION( ims:ime, jms:jme )          ::  GSWSAVE<a name='1153'>
<font color=#447700>!-------------------------------------------------<a name='1154'></font>
<font color=#447700>! urban related variables are added to declaration<a name='1155'></font>
<font color=#447700>!-------------------------------------------------<a name='1156'></font>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMR_SFCDIF<a name='1157'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHR_SFCDIF<a name='1158'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMGR_SFCDIF<a name='1159'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHGR_SFCDIF<a name='1160'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMC_SFCDIF<a name='1161'>
   REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CHC_SFCDIF<a name='1162'>
     REAL, OPTIONAL, INTENT(IN) :: DECLIN, SOLCON<a name='1163'>
     REAL, OPTIONAL , DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: COSZEN<a name='1164'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: HRANG<a name='1165'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: XLAT_URB2D  <font color=#447700>!urban<a name='1166'></font>
     INTEGER,  INTENT(IN) :: num_roof_layers                         <font color=#447700>!urban<a name='1167'></font>
     INTEGER,  INTENT(IN) :: num_wall_layers                         <font color=#447700>!urban<a name='1168'></font>
     INTEGER,  INTENT(IN) :: num_road_layers                         <font color=#447700>!urban<a name='1169'></font>
     INTEGER,  INTENT(IN), OPTIONAL :: julian,julyr                            <font color=#447700>!urban<a name='1170'></font>
     REAL, OPTIONAL, DIMENSION(1:num_soil_layers), INTENT(IN) :: DZR          <font color=#447700>!urban<a name='1171'></font>
     REAL, OPTIONAL, DIMENSION(1:num_soil_layers), INTENT(IN) :: DZB          <font color=#447700>!urban<a name='1172'></font>
     REAL, OPTIONAL, DIMENSION(1:num_soil_layers), INTENT(IN) :: DZG          <font color=#447700>!urban<a name='1173'></font>
<a name='1174'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  :: TR_URB2D <font color=#447700>!urban<a name='1175'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  :: TB_URB2D <font color=#447700>!urban<a name='1176'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  :: TG_URB2D <font color=#447700>!urban<a name='1177'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: TC_URB2D <font color=#447700>!urban<a name='1178'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: QC_URB2D <font color=#447700>!urban<a name='1179'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: UC_URB2D <font color=#447700>!urban<a name='1180'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: XXXR_URB2D <font color=#447700>!urban<a name='1181'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: XXXB_URB2D <font color=#447700>!urban<a name='1182'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: XXXG_URB2D <font color=#447700>!urban<a name='1183'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: XXXC_URB2D <font color=#447700>!urban<a name='1184'></font>
<a name='1185'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELR_URB2D<a name='1186'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELB_URB2D<a name='1187'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: DRELG_URB2D<a name='1188'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMR_URB2D<a name='1189'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMB_URB2D<a name='1190'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: FLXHUMG_URB2D<a name='1191'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: CMCR_URB2D<a name='1192'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: TGR_URB2D<a name='1193'>
<a name='1194'>
     REAL, OPTIONAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;       <font color=#447700>!urban<a name='1195'></font>
           INTENT(INOUT)  :: TGRL_URB3D                                 <font color=#447700>!urban<a name='1196'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;       <font color=#447700>!urban<a name='1197'></font>
           INTENT(INOUT)  :: SMR_URB3D                                 <font color=#447700>!urban<a name='1198'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;       <font color=#447700>!urban<a name='1199'></font>
           INTENT(INOUT)  :: TRL_URB3D                                 <font color=#447700>!urban<a name='1200'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;       <font color=#447700>!urban<a name='1201'></font>
           INTENT(INOUT)  :: TBL_URB3D                                 <font color=#447700>!urban<a name='1202'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime , 1:num_soil_layers, jms:jme ), &amp;       <font color=#447700>!urban<a name='1203'></font>
           INTENT(INOUT)  :: TGL_URB3D                                 <font color=#447700>!urban<a name='1204'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  :: SH_URB2D <font color=#447700>!urban<a name='1205'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: LH_URB2D <font color=#447700>!urban<a name='1206'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: G_URB2D  <font color=#447700>!urban<a name='1207'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: RN_URB2D <font color=#447700>!urban<a name='1208'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT):: TS_URB2D <font color=#447700>!urban<a name='1209'></font>
<font color=#447700>!<a name='1210'></font>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  :: FRC_URB2D  <font color=#447700>!urban<a name='1211'></font>
     INTEGER, OPTIONAL, DIMENSION( ims:ime, jms:jme ), INTENT(INOUT)  :: UTYPE_URB2D  <font color=#447700>!urban<a name='1212'></font>
<a name='1213'>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: PSIM_URB2D  <font color=#447700>!urban local var<a name='1214'></font>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: PSIH_URB2D  <font color=#447700>!urban local var<a name='1215'></font>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: GZ1OZ0_URB2D  <font color=#447700>!urban local var<a name='1216'></font>
<font color=#447700>!m     REAL, DIMENSION( ims:ime, jms:jme ) :: AKHS_URB2D  !urban local var<a name='1217'></font>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: AKMS_URB2D  <font color=#447700>!urban local var<a name='1218'></font>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: U10_URB2D   <font color=#447700>!urban local var<a name='1219'></font>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: V10_URB2D   <font color=#447700>!urban local var<a name='1220'></font>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: TH2_URB2D   <font color=#447700>!urban local var<a name='1221'></font>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: Q2_URB2D    <font color=#447700>!urban local var<a name='1222'></font>
     REAL,  DIMENSION( ims:ime, jms:jme )  :: UST_URB2D  <font color=#447700>!urban local var<a name='1223'></font>
     <a name='1224'>
<font color=#447700>!-------------------------------------------------<a name='1225'></font>
<font color=#447700>! Noah-mosaic related variables are added to declaration  (danli)<a name='1226'></font>
<font color=#447700>!-------------------------------------------------<a name='1227'></font>
  <a name='1228'>
  INTEGER, INTENT(IN) :: sf_surface_mosaic<a name='1229'>
  INTEGER, INTENT(IN) :: mosaic_cat<a name='1230'>
  INTEGER, DIMENSION( ims:ime, NLCAT, jms:jme ), INTENT(INOUT), OPTIONAL :: mosaic_cat_index<a name='1231'>
  REAL,    DIMENSION( ims:ime, NLCAT, jms:jme ), INTENT(INOUT), OPTIONAL :: landusef2<a name='1232'>
<a name='1233'>
  REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::   &amp;<a name='1234'>
        TSK_mosaic, QSFC_mosaic, CANWAT_mosaic, SNOW_mosaic,SNOWH_mosaic, SNOWC_mosaic<a name='1235'>
  REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::   &amp;<a name='1236'>
        ALBEDO_mosaic,ALBBCK_mosaic, EMISS_mosaic, EMBCK_mosaic, ZNT_mosaic, Z0_mosaic,   &amp;<a name='1237'>
        HFX_mosaic,QFX_mosaic, LH_mosaic, GRDFLX_mosaic,SNOTIME_mosaic    <a name='1238'>
  REAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), OPTIONAL, INTENT(INOUT)::   &amp;<a name='1239'>
        TSLB_mosaic,SMOIS_mosaic,SH2O_mosaic<a name='1240'>
<a name='1241'>
   REAL, DIMENSION( ims:ime, 1:mosaic_cat, jms:jme ) , OPTIONAL, INTENT(INOUT)::  &amp;<a name='1242'>
         TR_URB2D_mosaic, TB_URB2D_mosaic, TG_URB2D_mosaic, TC_URB2D_mosaic,QC_URB2D_mosaic, UC_URB2D_mosaic, &amp;<a name='1243'>
         SH_URB2D_mosaic,LH_URB2D_mosaic,G_URB2D_mosaic,RN_URB2D_mosaic,TS_URB2D_mosaic, TS_RUL2D_mosaic  <a name='1244'>
                  <a name='1245'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TRL_URB3D_mosaic<a name='1246'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TBL_URB3D_mosaic<a name='1247'>
   REAL, OPTIONAL, DIMENSION( ims:ime, 1:num_soil_layers*mosaic_cat, jms:jme ), INTENT(INOUT) :: TGL_URB3D_mosaic<a name='1248'>
     <a name='1249'>
<font color=#447700>!-------------------------------------------------<a name='1250'></font>
<font color=#447700>! End of Noah-mosaic related variables <a name='1251'></font>
<font color=#447700>!-------------------------------------------------     <a name='1252'></font>
     <a name='1253'>
<font color=#447700>!--------fds (06/2010)---------------------------------------------<a name='1254'></font>
     REAL,  DIMENSION( ims:ime, kms:kme, jms:jme ),               &amp;<a name='1255'>
            OPTIONAL, INTENT(IN) ::                                 CLDFRA<a name='1256'>
     REAL   :: DAY, CLOUDFRAC, UV10<a name='1257'>
<font color=#447700>!------------------------------------------------------------------<a name='1258'></font>
<font color=#447700>!<a name='1259'></font>
     REAL, DIMENSION( ims:ime, jms:jme ) :: HFX_SEA<a name='1260'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: QFX_SEA<a name='1261'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: LH_SEA<a name='1262'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: QSFC_SEA<a name='1263'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: TSK_SEA<a name='1264'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: ZNT_SEA<a name='1265'>
<a name='1266'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: CHS_SEA<a name='1267'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: CHS2_SEA<a name='1268'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: CQS2_SEA<a name='1269'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: CPM_SEA<a name='1270'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: FLHC_SEA<a name='1271'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: FLQC_SEA<a name='1272'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: QGH_SEA<a name='1273'>
<font color=#447700>!<a name='1274'></font>
     REAL, DIMENSION( ims:ime, jms:jme ) :: PSIH_SEA<a name='1275'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: PBLH_SEA<a name='1276'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: RMOL_SEA<a name='1277'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: UST_SEA<a name='1278'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: QZ0_SEA<a name='1279'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: TSK_LOCAL<a name='1280'>
    <font color=#447700>! lake varibles ,inout(14)<a name='1281'></font>
    real,    dimension(ims:ime,jms:jme ),intent(inout)                      :: savedtke12d<a name='1282'>
    real,    dimension(ims:ime,jms:jme ),intent(inout)                      :: snowdp2d,       &amp;<a name='1283'>
                                                                               h2osno2d,       &amp;<a name='1284'>
                                                                               snl2d,          &amp;<a name='1285'>
                                                                               t_grnd2d<a name='1286'>
 <a name='1287'>
    real,    dimension( ims:ime,1:nlevlake, jms:jme ),INTENT(inout)          :: t_lake3d,       &amp;<a name='1288'>
                                                                               lake_icefrac3d<a name='1289'>
    real,    dimension( ims:ime,-nlevsnow+1:nlevsoil, jms:jme ),INTENT(inout) :: t_soisno3d,     &amp;<a name='1290'>
                                                                               h2osoi_ice3d,   &amp;<a name='1291'>
                                                                               h2osoi_liq3d,   &amp;<a name='1292'>
                                                                               h2osoi_vol3d,   &amp;<a name='1293'>
                                                                               z3d,            &amp;<a name='1294'>
                                                                               dz3d<a name='1295'>
    real,    dimension( ims:ime,-nlevsnow+0:nlevsoil, jms:jme ),INTENT(inout) :: zi3d<a name='1296'>
    <font color=#447700>! in(8)<a name='1297'></font>
    real,    dimension( ims:ime,1:nlevlake, jms:jme ),INTENT(in)             :: z_lake3d,       &amp;<a name='1298'>
                                                                               dz_lake3d<a name='1299'>
    real,    dimension( ims:ime,1:nlevsoil, jms:jme ),INTENT(in)             :: watsat3d,       &amp;<a name='1300'>
                                                                               csol3d,         &amp;<a name='1301'>
                                                                               tkmg3d,         &amp;<a name='1302'>
                                                                               tkdry3d,        &amp;<a name='1303'>
                                                                               tksatu3d<a name='1304'>
    real,    dimension(ims:ime,jms:jme ),intent(in)                         :: lakedepth2d<a name='1305'>
#if (EM_CORE==1)<a name='1306'>
    real ,    dimension(ims:ime,jms:jme )  ::  lakemask       <a name='1307'>
<font color=#447700>!    INTEGER  :: lakeflag<a name='1308'></font>
#endif<a name='1309'>
<font color=#447700>!    logical, dimension(ims:ime,jms:jme ),intent(in)                         :: lake <a name='1310'></font>
 <a name='1311'>
<font color=#447700>!<a name='1312'></font>
   REAL   :: xice_threshold<a name='1313'>
<a name='1314'>
<font color=#447700>! cyl 3d ocean variable <a name='1315'></font>
   integer :: okms, okme<a name='1316'>
   real, optional , dimension(ims:ime, okms:okme, jms:jme), INTENT(INOUT):: OM_TMP,OM_S,OM_U,OM_V,OM_DEPTH<a name='1317'>
   real, optional , dimension(ims:ime, okms:okme, jms:jme), INTENT(IN):: OM_TINI,OM_SINI<a name='1318'>
   real, optional , dimension(ims:ime, jms:jme),INTENT(INOUT):: OM_ML, OM_LAT, OM_LON<a name='1319'>
   REAL, OPTIONAL , INTENT(IN   ) :: rdx, rdy,xtime,omdt<a name='1320'>
   REAL , OPTIONAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: msfu, msfv, msft<a name='1321'>
   INTEGER , OPTIONAL , INTENT(IN)        :: id<a name='1322'>
<font color=#447700>!<a name='1323'></font>
  real,    dimension(ims:ime,1:maxpatch,jms:jme ) ::  q_ref2m   <font color=#447700>! clm<a name='1324'></font>
<a name='1325'>
<a name='1326'>
<font color=#447700>!------------------------------------------------------------------<a name='1327'></font>
   CHARACTER*256 :: message<a name='1328'>
   REAL    :: next_bl_time<a name='1329'>
   LOGICAL :: run_param , doing_adapt_dt , decided<a name='1330'>
   LOGICAL :: do_adapt<a name='1331'>
<font color=#447700>!<a name='1332'></font>
<font color=#447700>! FASDAS<a name='1333'></font>
<font color=#447700>!<a name='1334'></font>
   REAL, DIMENSION( ims:ime, jms:jme ) , INTENT(INOUT), OPTIONAL ::   SDA_HFX,SDA_QFX,HFX_BOTH, QFX_BOTH, QNORM<a name='1335'>
   INTEGER, INTENT(IN   )                              ::   fasdas<a name='1336'>
<font color=#447700>! local vars<a name='1337'></font>
   REAL, DIMENSION( ims:ime, jms:jme )                 ::   HFXOLD, QFXOLD<a name='1338'>
   REAL                                                ::   HFX_KAY, QFX_KAY<a name='1339'>
<font color=#447700>! local var for SPP_LSM<a name='1340'></font>
   INTEGER                                             ::   spp_lsm_loc<a name='1341'>
<font color=#447700>!<a name='1342'></font>
<font color=#447700>!------------------------------------------------------------------<a name='1343'></font>
<font color=#447700>! Initialize local variables<a name='1344'></font>
  q_ref2m = 0.0<a name='1345'>
<font color=#447700>!------------------------------------------------------------------<a name='1346'></font>
<font color=#447700>!<a name='1347'></font>
<font color=#447700>! stop run if using ssib and fractional seaice=0  (fds 12/2010)<a name='1348'></font>
<a name='1349'>
  if(sf_surface_physics .eq. SSIBSCHEME .and. fractional_seaice .eq. 0) then<a name='1350'>
    WRITE( message,* ) 'Please activate fractional seaice option when using SSiB model'<a name='1351'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1277"> ( message )<a name='1352'>
  endif<a name='1353'>
<a name='1354'>
  if (sf_sfclay_physics .eq. 0) return<a name='1355'>
<a name='1356'>
  if ( fractional_seaice == 0 ) then<a name='1357'>
     xice_threshold = 0.5<a name='1358'>
  else if ( fractional_seaice == 1 ) then<a name='1359'>
     xice_threshold = 0.02<a name='1360'>
  endif<a name='1361'>
<a name='1362'>
  if ( ( seaice_albedo_opt == 2 ) .and. ( ifndalbsi == 0 ) ) then<a name='1363'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1278">("Field ALBSI not found in input.  Field ALBSI is required if SEAICE_ALBEDO_OPT=2")<a name='1364'>
  endif<a name='1365'>
<a name='1366'>
  if ( ( seaice_thickness_opt == 1 ) .and. ( ifndicedepth == 0 ) ) then<a name='1367'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1279">("Field ICEDEPTH not found in input.  Field ICEDEPTH is required if SEAICE_THICKNESS_OPT=1")<a name='1368'>
  endif<a name='1369'>
<a name='1370'>
  if ( ( seaice_snowdepth_opt == 1 ) .and. ( ifndsnowsi == 0 ) ) then<a name='1371'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1280">("Field SNOWSI not found in input.  Field SNOWSI is required if SEAICE_SNOWDEPTH_OPT=1")<a name='1372'>
  endif<a name='1373'>
<a name='1374'>
  IF ( coupler_on .and. present(cplmask) .and. present(sst_input) ) THEN<a name='1375'>
     <a name='1376'>
     CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_RCV'>cpl_rcv</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_RCV_1">( id, 'SST',            &amp;<a name='1377'>
        &amp;              ids, ide, jds, jde, kds, kde, &amp;<a name='1378'>
        &amp;              ims, ime, jms, jme, kms, kme, &amp;<a name='1379'>
        &amp;              ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1380'>
        &amp;              max_edom, cplmask, SST, SST_INPUT )<a name='1381'>
     <a name='1382'>
     CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_RCV'>cpl_rcv</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_RCV_2">( id, 'UOCE',            &amp;<a name='1383'>
        &amp;              ids, ide, jds, jde, kds, kde, &amp;<a name='1384'>
        &amp;              ims, ime, jms, jme, kms, kme, &amp;<a name='1385'>
        &amp;              ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1386'>
        &amp;              max_edom, cplmask, UOCE )<a name='1387'>
     <a name='1388'>
     CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_RCV'>cpl_rcv</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_RCV_3">( id, 'VOCE',            &amp;<a name='1389'>
        &amp;              ids, ide, jds, jde, kds, kde, &amp;<a name='1390'>
        &amp;              ims, ime, jms, jme, kms, kme, &amp;<a name='1391'>
        &amp;              ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1392'>
        &amp;              max_edom, cplmask, VOCE )<a name='1393'>
     <a name='1394'>
  END IF<a name='1395'>
<a name='1396'>
#if (EM_CORE==1)<a name='1397'>
     spp_lsm_loc = spp_lsm<a name='1398'>
#else<a name='1399'>
     spp_lsm_loc = 0<a name='1400'>
#endif<a name='1401'>
<a name='1402'>
  <a name='1403'>
<font color=#447700>!$OMP PARALLEL DO &amp;<a name='1404'></font>
<font color=#447700>!$OMP PRIVATE (ij, i, j, k)<a name='1405'></font>
  DO ij = 1,num_tiles<a name='1406'>
    DO j = j_start(ij),j_end(ij)<a name='1407'>
      DO k = kms,kme<a name='1408'>
        DO i = i_start(ij),i_end(ij)<a name='1409'>
          v_phytmp(i, k, j) = 0.<a name='1410'>
          u_phytmp(i, k, j) = 0.<a name='1411'>
        ENDDO<a name='1412'>
      ENDDO<a name='1413'>
      DO i = i_start(ij),i_end(ij)<a name='1414'>
         QGH(i,j) = 0.<a name='1415'>
         CHS(i,j) = 0.<a name='1416'>
         CPM(i,j) = 0.<a name='1417'>
         CHS2(i,j) = 0.<a name='1418'>
#if (NMM_CORE==1)<a name='1419'>
         Cd_out(i,j) = 0.<a name='1420'>
         Ch_out(i,j) = 0.<a name='1421'>
#endif<a name='1422'>
      ENDDO<a name='1423'>
    ENDDO<a name='1424'>
  ENDDO<a name='1425'>
  DTMIN = 0.<a name='1426'>
  DTBL = 0.<a name='1427'>
<a name='1428'>
<font color=#447700>! RAINBL in mm (Accumulation between PBL calls)<a name='1429'></font>
<a name='1430'>
  IF ( PRESENT( rainncv ) .AND. PRESENT( rainbl ) ) THEN<a name='1431'>
    <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1432'></font>
    <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='1433'></font>
    DO ij = 1 , num_tiles<a name='1434'>
      DO j=j_start(ij),j_end(ij)<a name='1435'>
      DO i=i_start(ij),i_end(ij)<a name='1436'>
         RAINBL(i,j) = RAINBL(i,j) + RAINCV(i,j) + RAINNCV(i,j)<a name='1437'>
         IF ( PRESENT( rainshv ))RAINBL(i,j) = RAINBL(i,j) + RAINSHV(i,j)<a name='1438'>
         RAINBL(i,j) = MAX (RAINBL(i,j), 0.0)<a name='1439'>
      ENDDO<a name='1440'>
      ENDDO<a name='1441'>
    ENDDO<a name='1442'>
    <font color=#447700>!$OMP END PARALLEL DO<a name='1443'></font>
  ELSE IF ( PRESENT( rainbl ) ) THEN<a name='1444'>
    <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1445'></font>
    <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='1446'></font>
    DO ij = 1 , num_tiles<a name='1447'>
      DO j=j_start(ij),j_end(ij)<a name='1448'>
      DO i=i_start(ij),i_end(ij)<a name='1449'>
         RAINBL(i,j) = RAINBL(i,j) + RAINCV(i,j)<a name='1450'>
         IF ( PRESENT( rainshv ))RAINBL(i,j) = RAINBL(i,j) + RAINSHV(i,j)<a name='1451'>
         RAINBL(i,j) = MAX (RAINBL(i,j), 0.0)<a name='1452'>
      ENDDO<a name='1453'>
      ENDDO<a name='1454'>
    ENDDO<a name='1455'>
    <font color=#447700>!$OMP END PARALLEL DO<a name='1456'></font>
  ENDIF<a name='1457'>
<font color=#447700>! Update SST<a name='1458'></font>
  IF (sst_update .EQ. 1) THEN<a name='1459'>
    CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_841">( 100, 'SST_UPDATE is on' )<a name='1460'>
    <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1461'></font>
    <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='1462'></font>
    DO ij = 1 , num_tiles<a name='1463'>
      DO j=j_start(ij),j_end(ij)<a name='1464'>
      DO i=i_start(ij),i_end(ij)<a name='1465'>
 <font color=#447700>! check for lake model <a name='1466'></font>
#if (EM_CORE==1)<a name='1467'>
          if ( lakemodel==1) then<a name='1468'>
            if(lakemask(i,j).eq.1.) then<a name='1469'>
              if ( xice(i,j).gt.xice_threshold) then   <font color=#447700>!mchen<a name='1470'></font>
                   xice(i,j)=0.0<a name='1471'>
               endif<a name='1472'>
             endif<a name='1473'>
          endif <a name='1474'>
#else<a name='1475'>
          if ( lakemodel==1) then<a name='1476'>
            if(ht(i,j)&gt;=lake_min_elev) then<a name='1477'>
              if ( xice(i,j).gt.xice_threshold) then   <font color=#447700>!mchen<a name='1478'></font>
                   xice(i,j)=0.0<a name='1479'>
               endif<a name='1480'>
             endif<a name='1481'>
          endif <a name='1482'>
#endif<a name='1483'>
<font color=#447700>! end check lake model    <a name='1484'></font>
         XICE_save(I,J) = XICEM(I,J) <a name='1485'>
<a name='1486'>
         IF ( FRACTIONAL_SEAICE == 1 ) then<a name='1487'>
            IF ( ( XICE(I,J) .NE. XICEM(I,J) ) .AND. ( XICEM(I,J) .GT. XICE_THRESHOLD ) ) THEN<a name='1488'>
               <font color=#447700>! Fractional values of ALBEDO and EMISSIVITY are valid according to the <a name='1489'></font>
               <font color=#447700>! earlier fractional seaice value, XICEM.  Recompute them for the new <a name='1490'></font>
               <font color=#447700>! seaice value XICE.<a name='1491'></font>
                IF ( SEAICE_ALBEDO_OPT ==2 ) THEN<a name='1492'>
                    IF ( ALBSI(I,J) &lt; -1.E6 ) THEN<a name='1493'>
                        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1281">("Field ALBSI not found in input.  Field ALBSI is required if SEAICE_ALBEDO_OPT=2")<a name='1494'>
                    ENDIF<a name='1495'>
                    ALBEDO(I,J) = 0.08 + XICE(I,J)/XICEM(I,J) * ( ALBSI(I,J) - 0.08 )<a name='1496'>
                ELSE<a name='1497'>
                    ALBEDO(I,J) = 0.08 + XICE(I,J)/XICEM(I,J) * ( ALBEDO(I,J) - 0.08 )<a name='1498'>
                ENDIF<a name='1499'>
                EMISS (I,J) = 0.98 + XICE(I,J)/XICEM(I,J) * ( EMISS (I,J) - 0.98 )<a name='1500'>
<font color=#447700>! use old tsk from seaice part<a name='1501'></font>
                TSK(I,J) = TSK_SAVE(I,J)*XICE(I,J) + (1.-XICE(I,J))*SST(I,J)<a name='1502'>
            ENDIF<a name='1503'>
         ENDIF<a name='1504'>
<a name='1505'>
        IF ( XLAND(i,j) .GT. 1.5 .AND. XICE(I,J) .GE. XICE_THRESHOLD .AND. XICEM(I,J) .LT. XICE_THRESHOLD ) THEN<a name='1506'>
          <font color=#447700>! water point turns to sea-ice point<a name='1507'></font>
          XICEM(I,J) = XICE(I,J)<a name='1508'>
          XLAND(I,J) = 1.<a name='1509'>
          IVGTYP(I,J) = ISICE<a name='1510'>
          ISLTYP(I,J) = 16<a name='1511'>
          VEGFRA(I,J) = 0.<a name='1512'>
          TMN(I,J) = 271.4<a name='1513'>
<a name='1514'>
          <font color=#447700>! Over new ice, initial guesses of ALBEDO and EMISS are<a name='1515'></font>
          <font color=#447700>! based on default water and ice values for albedo and<a name='1516'></font>
          <font color=#447700>! emissivity.  The land-surface schemes can update these<a name='1517'></font>
          <font color=#447700>! values<a name='1518'></font>
<a name='1519'>
          SELECT CASE ( SEAICE_ALBEDO_OPT )<a name='1520'>
          CASE ( 0, 1 )<a name='1521'>
<a name='1522'>
              ALBEDO(I,J) = SEAICE_ALBEDO_DEFAULT * XICE(I,J) + 0.08 * ( 1.0-XICE(I,J) )<a name='1523'>
              ALBBCK(I,J) = SEAICE_ALBEDO_DEFAULT<a name='1524'>
<a name='1525'>
          CASE ( 2 ) <a name='1526'>
              <a name='1527'>
              IF ( ALBSI(I,J) &lt; -1.E6 ) THEN<a name='1528'>
                  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1282">("Field ALBSI not found in input.  Field ALBSI is required if SEAICE_ALBEDO_OPT=2")<a name='1529'>
              ENDIF<a name='1530'>
<a name='1531'>
              ALBEDO(I,J) = ALBSI(I,J) * XICE(I,J) + 0.08 * ( 1.0-XICE(I,J) )<a name='1532'>
              ALBBCK(I,J) = ALBSI(I,J)<a name='1533'>
<a name='1534'>
          END SELECT<a name='1535'>
<a name='1536'>
          EMISS(I,J)  = 0.98 * XICE(I,J) + 0.98 * ( 1.0-XICE(I,J) )<a name='1537'>
          EMBCK(I,J)  = 0.98<a name='1538'>
          DO nk = 1, num_soil_layers<a name='1539'>
            TSLB(I,NK,J) = TSK(I,J)<a name='1540'>
            SMOIS(I,NK,J) = 1.0<a name='1541'>
            SH2O(I,NK,J) = 0.0<a name='1542'>
          ENDDO<a name='1543'>
        ENDIF<a name='1544'>
     IF (lakemodel.ne.1) then<a name='1545'>
         IF(XLAND(i,j) .GT. 1.5) THEN<a name='1546'>
           IF ( SST(i,j) .LT. 350. .and. SST(i,j) .GT. 250.) THEN<a name='1547'>
            TSK(i,j)   =SST(i,j)<a name='1548'>
            TSLB(i,1,j)=SST(i,j)<a name='1549'>
           ENDIF<a name='1550'>
          ENDIF<a name='1551'>
     ELSE<a name='1552'>
#if (EM_CORE==1)<a name='1553'>
<font color=#447700>!       if(lakeflag.eq.1) then<a name='1554'></font>
<font color=#447700>!         IF(XLAND(i,j) .GT. 1.5.AND.LAKEMASK(I,J).NE.1) THEN<a name='1555'></font>
<font color=#447700>!           IF ( SST(i,j) .LT. 350. .and. SST(i,j) .GT. 250.) THEN<a name='1556'></font>
<font color=#447700>!            TSK(i,j)   =SST(i,j)<a name='1557'></font>
<font color=#447700>!            TSLB(i,1,j)=SST(i,j)<a name='1558'></font>
<font color=#447700>!           ENDIF<a name='1559'></font>
<font color=#447700>!          ENDIF<a name='1560'></font>
<font color=#447700>!       else<a name='1561'></font>
<font color=#447700>!         if(XLAND(i,j) .GT. 1.5.and.ht(i,j).lt.lake_min_elev) then<a name='1562'></font>
<font color=#447700>!           IF ( SST(i,j) .LT. 350. .and. SST(i,j) .GT. 250.) THEN<a name='1563'></font>
<font color=#447700>!            TSK(i,j)   =SST(i,j)<a name='1564'></font>
<font color=#447700>!            TSLB(i,1,j)=SST(i,j)<a name='1565'></font>
<font color=#447700>!           ENDIF<a name='1566'></font>
<font color=#447700>!          ENDIF<a name='1567'></font>
<font color=#447700>!       endif   ! (lakeflag=1)<a name='1568'></font>
         IF(XLAND(i,j) .GT. 1.5.AND.LAKEMASK(I,J).NE.1) THEN<a name='1569'>
           IF ( SST(i,j) .LT. 350. .and. SST(i,j) .GT. 250.) THEN<a name='1570'>
            TSK(i,j)   =SST(i,j)<a name='1571'>
            TSLB(i,1,j)=SST(i,j)<a name='1572'>
           ENDIF<a name='1573'>
          ENDIF<a name='1574'>
#else<a name='1575'>
       IF(XLAND(i,j) .GT. 1.5.and.ht(i,j).lt.lake_min_elev) then<a name='1576'>
           IF ( SST(i,j) .LT. 350. .and. SST(i,j) .GT. 250.) THEN<a name='1577'>
            TSK(i,j)   =SST(i,j)<a name='1578'>
            TSLB(i,1,j)=SST(i,j)<a name='1579'>
           ENDIF<a name='1580'>
       ENDIF<a name='1581'>
#endif<a name='1582'>
     ENDIF  <font color=#447700>! (lakemodel=1)<a name='1583'></font>
        IF ( XLAND(i,j) .LT. 1.5 .AND. XICEM(I,J) .GE. XICE_THRESHOLD .AND. XICE(I,J) .LT. XICE_THRESHOLD ) THEN<a name='1584'>
<font color=#447700>! sea-ice point turns to water point<a name='1585'></font>
          XICEM(I,J) = XICE(I,J)<a name='1586'>
          XLAND(I,J) = 2.<a name='1587'>
          IVGTYP(I,J) = ISWATER<a name='1588'>
          ISLTYP(I,J) = 14<a name='1589'>
          VEGFRA(I,J) = 0.<a name='1590'>
          SNOW(I,J)  = 0.<a name='1591'>
          SNOWC(I,J) = 0.<a name='1592'>
          SNOWH(I,J) = 0.<a name='1593'>
          TMN(I,J) = SST(I,J)<a name='1594'>
          ALBEDO(I,J) = 0.08<a name='1595'>
          ALBBCK(I,J) = 0.08<a name='1596'>
          EMISS(I,J)  = 0.98<a name='1597'>
          EMBCK(I,J)  = 0.98<a name='1598'>
          DO nk = 1, num_soil_layers<a name='1599'>
            TSLB(I,NK,J) = SST(I,J)<a name='1600'>
            SMOIS(I,NK,J) = 1.0<a name='1601'>
            SH2O(I,NK,J) = 1.0<a name='1602'>
          ENDDO<a name='1603'>
        ENDIF<a name='1604'>
<a name='1605'>
        XICE_save(I,J) = XICEM(I,J)<a name='1606'>
        XICEM(i,j) = XICE(i,j)<a name='1607'>
        TSK_SAVE(I,J) = TSK(I, J)<a name='1608'>
<a name='1609'>
      ENDDO<a name='1610'>
      ENDDO<a name='1611'>
    ENDDO<a name='1612'>
    <font color=#447700>!$OMP END PARALLEL DO<a name='1613'></font>
  ENDIF<a name='1614'>
<a name='1615'>
  IF(PRESENT(SST_SKIN))THEN<a name='1616'>
    IF (sst_skin .EQ. 1) THEN<a name='1617'>
<font color=#447700>! Calculate skin sst based on Zeng and Beljaars (2005)<a name='1618'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_842">( 100, 'in SST_SKIN_UPDATE' )<a name='1619'>
      <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1620'></font>
      <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='1621'></font>
      DO ij = 1 , num_tiles<a name='1622'>
        DO j=j_start(ij),j_end(ij)<a name='1623'>
          DO i=i_start(ij),i_end(ij)<a name='1624'>
            IF(XLAND(i,j) .GT. 1.5 .and. sst_update .NE. 1) THEN<a name='1625'>
              TSK(i,j)   =SST(i,j)<a name='1626'>
              TSLB(i,1,j)=SST(i,j)<a name='1627'>
            ENDIF<a name='1628'>
          ENDDO<a name='1629'>
        ENDDO<a name='1630'>
        CALL <A href='../../html_code/phys/module_sf_sstskin.F.html#SST_SKIN_UPDATE'>sst_skin_update</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SST_SKIN_UPDATE_1">(xland,glw,gsw,hfx,qfx,tsk,ust,         &amp;<a name='1631'>
                emiss,dtw,sstsk,dt,stbolt,                          &amp;<a name='1632'>
                ids, ide, jds, jde, kds, kde,                       &amp;<a name='1633'>
                ims, ime, jms, jme, kms, kme,                       &amp;<a name='1634'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte   )<a name='1635'>
        DO j=j_start(ij),j_end(ij)<a name='1636'>
          DO i=i_start(ij),i_end(ij)<a name='1637'>
            IF(XLAND(i,j) .GT. 1.5)TSK(i,j)=SSTSK(i,j)<a name='1638'>
          ENDDO<a name='1639'>
        ENDDO<a name='1640'>
      ENDDO<a name='1641'>
    <font color=#447700>!$OMP END PARALLEL DO<a name='1642'></font>
    ENDIF<a name='1643'>
  ENDIF<a name='1644'>
<a name='1645'>
  IF(PRESENT(TMN_UPDATE))THEN<a name='1646'>
  IF (tmn_update .EQ. 1) THEN<a name='1647'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_843">( 100, 'in TMN_UPDATE' )<a name='1648'>
      CALL <A href='../../html_code/phys/module_sf_tmnupdate.F.html#TMNUPDATE'>tmnupdate</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TMNUPDATE_1">(tsk,tmn,tlag,tyr,tyra,tdly,nday,nyear,lagday, &amp;<a name='1649'>
                julian_in, dt, yr,                                  &amp;<a name='1650'>
                ids, ide, jds, jde, kds, kde,                       &amp;<a name='1651'>
                ims, ime, jms, jme, kms, kme,                       &amp;<a name='1652'>
                i_start,i_end, j_start,j_end, kts,kte, num_tiles   )<a name='1653'>
<a name='1654'>
  ENDIF<a name='1655'>
  ENDIF<a name='1656'>
<font color=#447700>!<a name='1657'></font>
<font color=#447700>! Modified for adaptive time step<a name='1658'></font>
<font color=#447700>!<a name='1659'></font>
   doing_adapt_dt = .FALSE.<a name='1660'>
   IF ( PRESENT(adapt_step_flag) ) THEN<a name='1661'>
      IF ( adapt_step_flag ) THEN<a name='1662'>
         doing_adapt_dt = .TRUE.<a name='1663'>
      END IF<a name='1664'>
   END IF<a name='1665'>
<a name='1666'>
<font color=#447700>!  Do we run through this scheme or not?<a name='1667'></font>
<a name='1668'>
<font color=#447700>!    Test 1:  If this is the initial model time, then yes.<a name='1669'></font>
<font color=#447700>!                ITIMESTEP=1<a name='1670'></font>
<font color=#447700>!    Test 2:  If the user asked for the surface to be run every time step, then yes.<a name='1671'></font>
<font color=#447700>!                BLDT=0 or STEPBL=1<a name='1672'></font>
<font color=#447700>!    Test 3:  If not adaptive dt, and this is on the requested surface frequency, then yes.<a name='1673'></font>
<font color=#447700>!                MOD(ITIMESTEP,STEPBL)=0<a name='1674'></font>
<font color=#447700>!    Test 4:  If using adaptive dt and the current time is past the last requested activate surface time, then yes.<a name='1675'></font>
<font color=#447700>!                CURR_SECS &gt;= BLDTACTTIME<a name='1676'></font>
<a name='1677'>
<font color=#447700>!  If we do run through the scheme, we set the flag run_param to TRUE and we set the decided flag<a name='1678'></font>
<font color=#447700>!  to TRUE.  The decided flag says that one of these tests was able to say "yes", run the scheme.<a name='1679'></font>
<font color=#447700>!  We only proceed to other tests if the previous tests all have left decided as FALSE.<a name='1680'></font>
<a name='1681'>
   run_param = .FALSE.<a name='1682'>
   decided = .FALSE.<a name='1683'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='1684'>
        ( itimestep .EQ. 1 ) ) THEN<a name='1685'>
      run_param   = .TRUE.<a name='1686'>
      decided     = .TRUE.<a name='1687'>
   END IF<a name='1688'>
<a name='1689'>
   IF ( PRESENT(bldt) )THEN<a name='1690'>
      IF ( ( .NOT. decided ) .AND. &amp;<a name='1691'>
           ( ( bldt .EQ. 0. ) .OR. ( stepbl .EQ. 1 ) ) ) THEN<a name='1692'>
         run_param   = .TRUE.<a name='1693'>
         decided     = .TRUE.<a name='1694'>
      END IF<a name='1695'>
   ELSE<a name='1696'>
      IF ( ( .NOT. decided ) .AND. &amp;<a name='1697'>
                                   ( stepbl .EQ. 1 )   ) THEN<a name='1698'>
         run_param   = .TRUE.<a name='1699'>
         decided     = .TRUE.<a name='1700'>
      END IF<a name='1701'>
   END IF<a name='1702'>
<a name='1703'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='1704'>
        ( .NOT. doing_adapt_dt ) .AND. &amp;<a name='1705'>
        ( MOD(itimestep,stepbl) .EQ. 0 ) ) THEN<a name='1706'>
      run_param   = .TRUE.<a name='1707'>
      decided     = .TRUE.<a name='1708'>
   END IF<a name='1709'>
<a name='1710'>
   IF ( ( .NOT. decided ) .AND. &amp;<a name='1711'>
        ( doing_adapt_dt ) .AND. &amp;<a name='1712'>
        ( curr_secs .GE. bldtacttime ) ) THEN<a name='1713'>
      run_param   = .TRUE.<a name='1714'>
      decided     = .TRUE.<a name='1715'>
   END IF<a name='1716'>
<a name='1717'>
  IF ( run_param ) then<a name='1718'>
<a name='1719'>
  radiation = .false.<a name='1720'>
  frpcpn = .false.<a name='1721'>
  myj    = ((sf_sfclay_physics .EQ. MYJSFCSCHEME) .OR. &amp;<a name='1722'>
            (sf_sfclay_physics .EQ. QNSESFCSCHEME) )<a name='1723'>
  isisfc = ( FRACTIONAL_SEAICE .EQ. 1  .AND. (          &amp;<a name='1724'>
            (sf_sfclay_physics .EQ. SFCLAYSCHEME ) .OR. &amp;<a name='1725'>
            (sf_sfclay_physics .EQ. SFCLAYREVSCHEME ) .OR. &amp;<a name='1726'>
            (sf_sfclay_physics .EQ. PXSFCSCHEME  ) .OR. &amp;<a name='1727'>
            (sf_sfclay_physics .EQ. MYJSFCSCHEME ) .OR. &amp;<a name='1728'>
            (sf_sfclay_physics .EQ. QNSESFCSCHEME ) .OR. &amp;  <font color=#447700>!emt<a name='1729'></font>
#if (EM_CORE==1)<a name='1730'>
            (sf_sfclay_physics .EQ. MYNNSFCSCHEME ) .OR. &amp;<a name='1731'>
#endif<a name='1732'>
            (sf_sfclay_physics .EQ. GFSSFCSCHEME ) )    &amp;<a name='1733'>
           )<a name='1734'>
<a name='1735'>
  IF (ra_lw_physics .gt. 0) radiation = .true.<a name='1736'>
<a name='1737'>
  IF( PRESENT(slope_rad).AND. radiation )THEN<a name='1738'>
<font color=#447700>! topographic slope effects modify SWDOWN and GSW here<a name='1739'></font>
    IF (slope_rad .EQ. 1) THEN<a name='1740'>
    <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1741'></font>
    <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='1742'></font>
    DO ij = 1 , num_tiles<a name='1743'>
           CALL <A href='../../html_code/phys/module_surface_driver.F.html#TOPO_RAD_ADJ_DRVR'>TOPO_RAD_ADJ_DRVR</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOPO_RAD_ADJ_DRVR_1"> (XLAT,XLONG,COSZEN,             &amp;<a name='1744'>
                    shadowmask,diffuse_frac,                      &amp;<a name='1745'>
                    declin,                                       &amp;<a name='1746'>
                    SWDOWN,GSW,SWNORM,GSWSAVE,solcon,hrang,       &amp;<a name='1747'>
                    slope,slp_azi,                                &amp;<a name='1748'>
                ids, ide, jds, jde, kds, kde,                     &amp;<a name='1749'>
                ims, ime, jms, jme, kms, kme,                     &amp;<a name='1750'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte   )<a name='1751'>
    ENDDO<a name='1752'>
    <font color=#447700>!$OMP END PARALLEL DO<a name='1753'></font>
<a name='1754'>
    ENDIF<a name='1755'>
  ENDIF<a name='1756'>
<font color=#447700>!----<a name='1757'></font>
<font color=#447700>! CALCULATE CONSTANT<a name='1758'></font>
<a name='1759'>
     DTMIN=DT/60.<a name='1760'>
<font color=#447700>! Surface schemes need PBL time step for updates and accumulations<a name='1761'></font>
<font color=#447700>! Assume these schemes provide no tendencies<a name='1762'></font>
<a name='1763'>
    if (PRESENT(adapt_step_flag)) then<a name='1764'>
       if (adapt_step_flag) then<a name='1765'>
          do_adapt = .TRUE.<a name='1766'>
       else<a name='1767'>
          do_adapt = .FALSE.<a name='1768'>
       endif<a name='1769'>
    else<a name='1770'>
       do_adapt = .FALSE.<a name='1771'>
    endif<a name='1772'>
<a name='1773'>
    if (PRESENT(BLDT)) then<a name='1774'>
       if (bldt .eq. 0) then<a name='1775'>
          DTBL = dt<a name='1776'>
       ELSE<a name='1777'>
          if (do_adapt) then<a name='1778'>
             IF ( curr_secs .LT. 2. * dt ) THEN<a name='1779'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1071">("WARNING: When using an adaptive time-step the boundary layer"// &amp;<a name='1780'>
                                 " time-step should be 0 (i.e., equivalent to model time-step)." )<a name='1781'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1072">("In order to proceed, for surface calculations, the "// &amp;<a name='1782'>
                                 "boundary layer time-step"// &amp;<a name='1783'>
                                 " will be rounded to the nearest minute," )<a name='1784'>
                call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1073">("possibly resulting in innacurate results.")<a name='1785'>
             END IF<a name='1786'>
             DTBL=bldt*60<a name='1787'>
          else<a name='1788'>
             DTBL=DT*STEPBL<a name='1789'>
          endif<a name='1790'>
       endif<a name='1791'>
    else<a name='1792'>
       DTBL=DT*STEPBL<a name='1793'>
    endif<a name='1794'>
<a name='1795'>
<font color=#447700>! SAVE OLD VALUES<a name='1796'></font>
<a name='1797'>
<a name='1798'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1799'></font>
     <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='1800'></font>
     DO ij = 1 , num_tiles<a name='1801'>
       DO j=j_start(ij),j_end(ij)<a name='1802'>
       DO i=i_start(ij),i_end(ij)<a name='1803'>
<font color=#447700>! PSFC : in Pa<a name='1804'></font>
          PSFC(I,J)=p8w(I,kts,J)<a name='1805'>
<font color=#447700>! REVERSE ORDER IN THE VERTICAL DIRECTION<a name='1806'></font>
          DO k=kts,kte<a name='1807'>
            v_phytmp(i,k,j)=v_phy(i,k,j)+v_frame<a name='1808'>
            u_phytmp(i,k,j)=u_phy(i,k,j)+u_frame<a name='1809'>
          ENDDO<a name='1810'>
<font color=#447700>! remove surface currents for atmospheric low-level winds<a name='1811'></font>
          u_phytmp(i,kts,j)=u_phytmp(i,kts,j)-uoce(i,j)<a name='1812'>
          v_phytmp(i,kts,j)=v_phytmp(i,kts,j)-voce(i,j)<a name='1813'>
       ENDDO<a name='1814'>
       ENDDO<a name='1815'>
     ENDDO<a name='1816'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='1817'></font>
<a name='1818'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1819'></font>
     <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='1820'></font>
     DO ij = 1 , num_tiles<a name='1821'>
     sfclay_select: SELECT CASE(sf_sfclay_physics)<a name='1822'>
<a name='1823'>
     CASE (SFCLAYSCHEME)<a name='1824'>
<font color=#447700>! DX varies spatially in NMM, therefore, SFCLAY cannot be called<a name='1825'></font>
<font color=#447700>! because it takes a scalar DX. NMM passes in a dummy value for this<a name='1826'></font>
<font color=#447700>! scalar.  NEEDS FURTHER ATTENTION. JM 20050215<a name='1827'></font>
       IF(PRESENT(SCM_FORCE_FLUX))THEN<a name='1828'>
         IF (scm_force_flux .EQ. 1) THEN<a name='1829'>
<font color=#447700>! surface forcing by observed fluxes<a name='1830'></font>
         CALL <A href='../../html_code/phys/module_sf_scmflux.F.html#SCMFLUX'>scmflux</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCMFLUX_1">(u_phytmp, v_phytmp, t_phy, qv_curr, p_phy, dz8w,   &amp;<a name='1831'>
                     cp, rcp, xlv, psfc, cpm, xland,                     &amp;<a name='1832'>
                     psim, psih, hfx, qfx, lh, tsk, flhc, flqc,          &amp;<a name='1833'>
                     znt, gz1oz0, wspd,                                  &amp;<a name='1834'>
                     julian_in, karman, p1000mb,                         &amp;<a name='1835'>
                     itimestep,chklowq,                                  &amp;<a name='1836'>
                     ids, ide, jds, jde, kds, kde,                       &amp;<a name='1837'>
                     ims, ime, jms, jme, kms, kme,                       &amp;<a name='1838'>
                     i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte   )<a name='1839'>
         ENDIF<a name='1840'>
       ENDIF<a name='1841'>
       IF(PRESENT(SCM_FORCE_SKINTEMP))THEN<a name='1842'>
         IF (scm_force_skintemp .EQ. 1) THEN<a name='1843'>
<font color=#447700>! surface forcing by observed skin temperature<a name='1844'></font>
         CALL <A href='../../html_code/phys/module_sf_scmskintemp.F.html#SCMSKINTEMP'>scmskintemp</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCMSKINTEMP_1">(tsk, julian_in, itimestep,                     &amp;<a name='1845'>
                     ids, ide, jds, jde, kds, kde,                       &amp;<a name='1846'>
                     ims, ime, jms, jme, kms, kme,                       &amp;<a name='1847'>
                     i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte   )<a name='1848'>
         ENDIF<a name='1849'>
<font color=#447700>!         IF (scm_force_skintemp .EQ. 2) THEN<a name='1850'></font>
<font color=#447700>! surface forcing by gabls2 skin temperature<a name='1851'></font>
<font color=#447700>!         CALL scmgabls2(tsk, itimestep, dt,                              &amp;<a name='1852'></font>
<font color=#447700>!                     ids, ide, jds, jde, kds, kde,                       &amp;<a name='1853'></font>
<font color=#447700>!                     ims, ime, jms, jme, kms, kme,                       &amp;<a name='1854'></font>
<font color=#447700>!                     i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte   )<a name='1855'></font>
<font color=#447700>!         ENDIF<a name='1856'></font>
       ENDIF<a name='1857'>
       IF (PRESENT(qv_curr)                            .AND.    &amp;<a name='1858'>
           PRESENT(mol)        .AND.  PRESENT(regime)  .AND.    &amp;<a name='1859'>
                                                      .TRUE. ) THEN<a name='1860'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_844">( 100, 'in SFCLAY' )<a name='1861'>
         IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='1862'>
            CALL <A href='../../html_code/phys/module_surface_driver.F.html#SFCLAY_SEAICE_WRAPPER'>SFCLAY_SEAICE_WRAPPER</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAY_SEAICE_WRAPPER_1">(u_phytmp,v_phytmp,t_phy,qv_curr,&amp;<a name='1863'>
                 p_phy,dz8w,cp,g,rcp,r_d,xlv,psfc,chs,chs2,cqs2,cpm, &amp;<a name='1864'>
                 znt,ust,pblh,mavail,zol,mol,regime,psim,psih,fm,fhh, &amp;<a name='1865'>
                 xland,hfx,qfx,lh,tsk,flhc,flqc,qgh,qsfc,rmol,       &amp;<a name='1866'>
                 u10,v10,th2,t2,q2,                                  &amp;<a name='1867'>
                 gz1oz0,wspd,br,isfflx,dx,                           &amp;<a name='1868'>
                 svp1,svp2,svp3,svpt0,ep_1,ep_2,karman,eomeg,stbolt, &amp;<a name='1869'>
                 P1000mb,                                            &amp;<a name='1870'>
                 XICE,SST,TSK_SEA,                                                  &amp;<a name='1871'>
                 CHS2_SEA,CHS_SEA,CPM_SEA,CQS2_SEA,FLHC_SEA,FLQC_SEA,               &amp;<a name='1872'>
                 HFX_SEA,LH_SEA,QFX_SEA,QGH_SEA,QSFC_SEA,ZNT_SEA,                   &amp;<a name='1873'>
                 ITIMESTEP,TICE2TSK_IF2COLD,XICE_THRESHOLD,                         &amp;<a name='1874'>
                 ids,ide, jds,jde, kds,kde,                          &amp;<a name='1875'>
                 ims,ime, jms,jme, kms,kme,                          &amp;<a name='1876'>
                 i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,    &amp;<a name='1877'>
                 ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,                &amp;<a name='1878'>
                 sf_surface_physics  )<a name='1879'>
         ELSE<a name='1880'>
         CALL <A href='../../html_code/phys/module_sf_sfclay.F.html#SFCLAY'>SFCLAY</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAY_1">(u_phytmp,v_phytmp,t_phy,qv_curr,              &amp;<a name='1881'>
               p_phy,dz8w,cp,g,rcp,r_d,xlv,psfc,chs,chs2,cqs2,cpm, &amp;<a name='1882'>
               znt,ust,pblh,mavail,zol,mol,regime,psim,psih,fm,fhh, &amp;<a name='1883'>
               xland,hfx,qfx,lh,tsk,flhc,flqc,qgh,qsfc,rmol,       &amp;<a name='1884'>
               u10,v10,th2,t2,q2,                                  &amp;<a name='1885'>
               gz1oz0,wspd,br,isfflx,dx,                           &amp;<a name='1886'>
               svp1,svp2,svp3,svpt0,ep_1,ep_2,karman,eomeg,stbolt, &amp;<a name='1887'>
               P1000mb,                                            &amp;<a name='1888'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='1889'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='1890'>
               i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,    &amp;<a name='1891'>
               ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,scm_force_flux  )<a name='1892'>
#if ( EM_CORE==1)<a name='1893'>
           DO j = j_start(ij),j_end(ij)<a name='1894'>
           DO i = i_start(ij),i_end(ij)<a name='1895'>
             ch(i,j) = chs (i,j)<a name='1896'>
<font color=#447700>!!             ch(i,j) = flhc(i,j)/( cpm(i,j)*rho(i,kts,j) )<a name='1897'></font>
           end do<a name='1898'>
           end do<a name='1899'>
#endif<a name='1900'>
         ENDIF<a name='1901'>
       ELSE<a name='1902'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1283">('Lacking arguments for SFCLAY in surface driver')<a name='1903'>
       ENDIF<a name='1904'>
<a name='1905'>
     CASE (SFCLAYREVSCHEME)<a name='1906'>
<font color=#447700>! DX varies spatially in NMM, therefore, SFCLAY cannot be called<a name='1907'></font>
<font color=#447700>! because it takes a scalar DX. NMM passes in a dummy value for this<a name='1908'></font>
<font color=#447700>! scalar.  NEEDS FURTHER ATTENTION. JM 20050215<a name='1909'></font>
       IF (PRESENT(qv_curr)                            .AND.    &amp;<a name='1910'>
           PRESENT(mol)        .AND.  PRESENT(regime)  .AND.    &amp;<a name='1911'>
                                                      .TRUE. ) THEN<a name='1912'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_845">( 100, 'in SFCLAY' )<a name='1913'>
         IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='1914'>
            CALL <A href='../../html_code/phys/module_surface_driver.F.html#SFCLAYREV_SEAICE_WRAPPER'>SFCLAYREV_SEAICE_WRAPPER</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAYREV_SEAICE_WRAPPER_1">(u_phytmp,v_phytmp,t_phy,qv_curr,&amp;<a name='1915'>
                 p_phy,dz8w,cp,g,rcp,r_d,xlv,psfc,chs,chs2,cqs2,cpm, &amp;<a name='1916'>
                 znt,ust,pblh,mavail,zol,mol,regime,psim,psih,fm,fhh, &amp;<a name='1917'>
                 xland,hfx,qfx,lh,tsk,flhc,flqc,qgh,qsfc,rmol,       &amp;<a name='1918'>
                 u10,v10,th2,t2,q2,                                  &amp;<a name='1919'>
                 gz1oz0,wspd,br,isfflx,dx,                           &amp;<a name='1920'>
                 svp1,svp2,svp3,svpt0,ep_1,ep_2,karman,eomeg,stbolt, &amp;<a name='1921'>
                 P1000mb,                                            &amp;<a name='1922'>
                 XICE,SST,TSK_SEA,                                                  &amp;<a name='1923'>
                 CHS2_SEA,CHS_SEA,CPM_SEA,CQS2_SEA,FLHC_SEA,FLQC_SEA,               &amp;<a name='1924'>
                 HFX_SEA,LH_SEA,QFX_SEA,QGH_SEA,QSFC_SEA,ZNT_SEA,                   &amp;<a name='1925'>
                 ITIMESTEP,TICE2TSK_IF2COLD,XICE_THRESHOLD,                         &amp;<a name='1926'>
                 ids,ide, jds,jde, kds,kde,                          &amp;<a name='1927'>
                 ims,ime, jms,jme, kms,kme,                          &amp;<a name='1928'>
                 i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,    &amp;<a name='1929'>
                 ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,                &amp;<a name='1930'>
                 sf_surface_physics  )<a name='1931'>
         ELSE<a name='1932'>
         CALL <A href='../../html_code/phys/module_sf_sfclayrev.F.html#SFCLAYREV'>SFCLAYREV</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAYREV_1">(u_phytmp,v_phytmp,t_phy,qv_curr,&amp;<a name='1933'>
               p_phy,dz8w,cp,g,rcp,r_d,xlv,psfc,chs,chs2,cqs2,cpm, &amp;<a name='1934'>
               znt,ust,pblh,mavail,zol,mol,regime,psim,psih,fm,fhh, &amp;<a name='1935'>
               xland,hfx,qfx,lh,tsk,flhc,flqc,qgh,qsfc,rmol,       &amp;<a name='1936'>
               u10,v10,th2,t2,q2,                                  &amp;<a name='1937'>
               gz1oz0,wspd,br,isfflx,dx,                           &amp;<a name='1938'>
               svp1,svp2,svp3,svpt0,ep_1,ep_2,karman,eomeg,stbolt, &amp;<a name='1939'>
               P1000mb,                                            &amp;<a name='1940'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='1941'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='1942'>
               i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,    &amp;<a name='1943'>
               ustm,ck,cka,cd,cda,isftcflx,iz0tlnd, scm_force_flux    )<a name='1944'>
#if ( EM_CORE==1)<a name='1945'>
           DO j = j_start(ij),j_end(ij)<a name='1946'>
           DO i = i_start(ij),i_end(ij)<a name='1947'>
             ch(i,j) = chs (i,j)<a name='1948'>
<font color=#447700>!!             ch(i,j) = flhc(i,j)/( cpm(i,j)*rho(i,kts,j) )<a name='1949'></font>
           end do<a name='1950'>
           end do<a name='1951'>
#endif<a name='1952'>
         ENDIF<a name='1953'>
       ELSE<a name='1954'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1284">('Lacking arguments for SFCLAY in surface driver')<a name='1955'>
       ENDIF<a name='1956'>
<a name='1957'>
     CASE (PXSFCSCHEME)<a name='1958'>
#if (NMM_CORE <font color=#447700>!= 1)<a name='1959'></font>
       IF (PRESENT(qv_curr)                            .AND.    &amp;<a name='1960'>
           PRESENT(mol)        .AND.  PRESENT(regime)  .AND.    &amp;<a name='1961'>
                                                      .TRUE. ) THEN<a name='1962'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_846">( 100, 'in PX Surface Layer scheme' )<a name='1963'>
         IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='1964'>
            CALL <A href='../../html_code/phys/module_surface_driver.F.html#PXSFCLAY_SEAICE_WRAPPER'>PXSFCLAY_SEAICE_WRAPPER</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXSFCLAY_SEAICE_WRAPPER_1">(u_phytmp,v_phytmp,t_phy,th_phy,qv_curr,&amp;<a name='1965'>
                 p_phy,dz8w,cp,g,rcp,r_d,xlv,psfc,chs,chs2,cqs2,cpm, &amp;<a name='1966'>
                 znt,ust,pblh,mavail,zol,mol,regime,psim,psih,       &amp;<a name='1967'>
                 xland,hfx,qfx,lh,tsk,flhc,flqc,qgh,qsfc,rmol,       &amp;<a name='1968'>
                 u10,v10,                                            &amp;<a name='1969'>
                 gz1oz0,wspd,br,isfflx,dx,                           &amp;<a name='1970'>
                 svp1,svp2,svp3,svpt0,ep_1,ep_2,karman,              &amp;<a name='1971'>
                 XICE, SST, ITIMESTEP, TICE2TSK_IF2COLD,XICE_THRESHOLD, &amp;<a name='1972'>
                 CHS_SEA, CHS2_SEA, CPM_SEA, CQS2_SEA,FLHC_SEA,FLQC_SEA,&amp;<a name='1973'>
                 HFX_SEA, LH_SEA, QFX_SEA, QGH_SEA, QSFC_SEA, TSK_SEA,  &amp;<a name='1974'>
                 ids,ide, jds,jde, kds,kde,                          &amp;<a name='1975'>
                 ims,ime, jms,jme, kms,kme,                          &amp;<a name='1976'>
                 i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='1977'>
         ELSE<a name='1978'>
         CALL <A href='../../html_code/phys/module_sf_pxsfclay.F.html#PXSFCLAY'>PXSFCLAY</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXSFCLAY_1">(u_phytmp,v_phytmp,t_phy,th_phy,qv_curr,&amp;<a name='1979'>
               p_phy,dz8w,cp,g,rcp,r_d,xlv,psfc,chs,chs2,cqs2,cpm, &amp;<a name='1980'>
               znt,ust,pblh,mavail,zol,mol,regime,psim,psih,       &amp;<a name='1981'>
               xland,hfx,qfx,lh,tsk,flhc,flqc,qgh,qsfc,rmol,       &amp;<a name='1982'>
               u10,v10,                                            &amp;<a name='1983'>
               gz1oz0,wspd,br,isfflx,dx,                           &amp;<a name='1984'>
               svp1,svp2,svp3,svpt0,ep_1,ep_2,karman,itimestep,    &amp;<a name='1985'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='1986'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='1987'>
               i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='1988'>
         ENDIF<a name='1989'>
       ELSE<a name='1990'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1285">('Lacking arguments for PX Surface Layer in surface driver')<a name='1991'>
       ENDIF<a name='1992'>
#else<a name='1993'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1286">('PX Surface Layer scheme cannot be used with NMM')<a name='1994'>
#endif<a name='1995'>
<a name='1996'>
      CASE (MYJSFCSCHEME)<a name='1997'>
       IF (PRESENT(qv_curr)    .AND.  PRESENT(qc_curr) .AND.    &amp;<a name='1998'>
                                                      .TRUE. ) THEN<a name='1999'>
<a name='2000'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_847">(100,'in MYJSFC')<a name='2001'>
        IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='2002'>
           CALL <A href='../../html_code/phys/module_surface_driver.F.html#MYJSFC_SEAICE_WRAPPER'>MYJSFC_SEAICE_WRAPPER</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYJSFC_SEAICE_WRAPPER_1">(itimestep,ht,dz8w,             &amp;<a name='2003'>
                p_phy,p8w,th_phy,t_phy,                              &amp;<a name='2004'>
                qv_curr,qc_curr,                                     &amp;<a name='2005'>
                u_phy,v_phy,tke_pbl,                                 &amp;<a name='2006'>
                tsk,qsfc,thz0,qz0,uz0,vz0,                           &amp;<a name='2007'>
                lowlyr,                                              &amp;<a name='2008'>
                xland,ivgtyp,isurban,iz0tlnd,                        &amp;<a name='2009'>
                TICE2TSK_IF2COLD,                                    &amp; <font color=#447700>! Extra for wrapper.<a name='2010'></font>
                XICE_THRESHOLD,                                      &amp; <font color=#447700>! Extra for wrapper.<a name='2011'></font>
                XICE, SST,                                           &amp; <font color=#447700>! Extra for wrapper.<a name='2012'></font>
                CHS_SEA, CHS2_SEA, CQS2_SEA, CPM_SEA,            &amp;<a name='2013'>
                FLHC_SEA, FLQC_SEA, QSFC_SEA, &amp;<a name='2014'>
                QGH_SEA, QZ0_SEA, HFX_SEA, QFX_SEA, LH_SEA,         &amp;<a name='2015'>
                TSK_SEA,                                             &amp;<a name='2016'>
                ust,znt,z0,pblh,mavail,rmol,                         &amp;<a name='2017'>
                akhs,akms,                                           &amp;<a name='2018'>
                br,                                                 &amp;<a name='2019'>
                chs,chs2,cqs2,hfx,qfx,lh,flhc,flqc,qgh,cpm,ct,       &amp;<a name='2020'>
                u10,v10,t2,th2,tshltr,th10,q2,qshltr,q10,pshltr,               &amp;<a name='2021'>
                p1000mb,                                             &amp;<a name='2022'>
                ids,ide, jds,jde, kds,kde,                           &amp;<a name='2023'>
                ims,ime, jms,jme, kms,kme,                           &amp;<a name='2024'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='2025'>
        ELSE<a name='2026'>
            CALL <A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFC'>MYJSFC</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYJSFC_1">(itimestep,ht,dz8w,                         &amp;<a name='2027'>
              p_phy,p8w,th_phy,t_phy,                              &amp;<a name='2028'>
              qv_curr,qc_curr,                                      &amp;<a name='2029'>
              u_phy,v_phy,tke_pbl,                                 &amp;<a name='2030'>
              tsk,qsfc,thz0,qz0,uz0,vz0,                           &amp;<a name='2031'>
              lowlyr,                                              &amp;<a name='2032'>
              xland,ivgtyp,isurban,iz0tlnd,                        &amp;<a name='2033'>
              ust,znt,z0,pblh,mavail,rmol,                         &amp;<a name='2034'>
              akhs,akms,                                           &amp;<a name='2035'>
              br,                                                 &amp;<a name='2036'>
              chs,chs2,cqs2,hfx,qfx,lh,flhc,flqc,qgh,cpm,ct,       &amp;<a name='2037'>
              u10,v10,t2,th2,tshltr,th10,q2,qshltr,q10,pshltr,               &amp;<a name='2038'>
              p1000mb,                                             &amp;<a name='2039'>
              ids,ide, jds,jde, kds,kde,                           &amp;<a name='2040'>
              ims,ime, jms,jme, kms,kme,                           &amp;<a name='2041'>
              i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='2042'>
#if ( EM_CORE==1)<a name='2043'>
         DO j = j_start(ij),j_end(ij)<a name='2044'>
            DO i = i_start(ij),i_end(ij)<a name='2045'>
               wspd(i,j) = MAX(SQRT(u_phy(i,kts,j)**2+v_phy(i,kts,j)**2),0.001)<a name='2046'>
               ch(i,j) = chs (i,j)<a name='2047'>
<font color=#447700>!!           ch(i,j) = flhc(i,j)/( cpm(i,j)*rho(i,kts,j) )<a name='2048'></font>
            END DO<a name='2049'>
         END DO<a name='2050'>
#endif         <a name='2051'>
<a name='2052'>
        ENDIF<a name='2053'>
       ELSE<a name='2054'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1287">('Lacking arguments for MYJSFC in surface driver')<a name='2055'>
       ENDIF<a name='2056'>
<a name='2057'>
      CASE (QNSESFCSCHEME)<a name='2058'>
       IF(PRESENT(SCM_FORCE_FLUX))THEN<a name='2059'>
         IF (scm_force_flux .EQ. 1) THEN<a name='2060'>
<font color=#447700>! surface forcing by observed fluxes<a name='2061'></font>
         CALL <A href='../../html_code/phys/module_sf_scmflux.F.html#SCMFLUX'>scmflux</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCMFLUX_2">(u_phytmp, v_phytmp, t_phy, qv_curr, p_phy, dz8w,   &amp;<a name='2062'>
                     cp, rcp, xlv, psfc, cpm, xland,                     &amp;<a name='2063'>
                     psim, psih, hfx, qfx, lh, tsk, flhc, flqc,          &amp;<a name='2064'>
                     znt, gz1oz0, wspd,                                  &amp;<a name='2065'>
                     julian_in, karman, p1000mb,                         &amp;<a name='2066'>
                     itimestep,chklowq,                                  &amp;<a name='2067'>
                     ids, ide, jds, jde, kds, kde,                       &amp;<a name='2068'>
                     ims, ime, jms, jme, kms, kme,                       &amp;<a name='2069'>
                     i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte   )<a name='2070'>
         ENDIF<a name='2071'>
       ENDIF<a name='2072'>
       IF(PRESENT(SCM_FORCE_SKINTEMP))THEN<a name='2073'>
         IF (scm_force_skintemp .EQ. 1) THEN<a name='2074'>
<font color=#447700>! surface forcing by observed skin temperature<a name='2075'></font>
         CALL <A href='../../html_code/phys/module_sf_scmskintemp.F.html#SCMSKINTEMP'>scmskintemp</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SCMSKINTEMP_2">(tsk, julian_in, itimestep,                     &amp;<a name='2076'>
                     ids, ide, jds, jde, kds, kde,                       &amp;<a name='2077'>
                     ims, ime, jms, jme, kms, kme,                       &amp;<a name='2078'>
                     i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte   )<a name='2079'>
         ENDIF<a name='2080'>
       ENDIF<a name='2081'>
<a name='2082'>
       IF (PRESENT(qv_curr)    .AND.  PRESENT(qc_curr) .AND.    &amp;<a name='2083'>
                                                      .TRUE. ) THEN<a name='2084'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_848">(100,'in QNSESFC')<a name='2085'>
             IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='2086'>
           CALL <A href='../../html_code/phys/module_surface_driver.F.html#QNSESFC_SEAICE_WRAPPER'>QNSESFC_SEAICE_WRAPPER</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QNSESFC_SEAICE_WRAPPER_1">(itimestep,ht,dz8w,             &amp;<a name='2087'>
                p_phy,p8w,th_phy,t_phy,                              &amp;<a name='2088'>
                qv_curr,qc_curr,                                     &amp;<a name='2089'>
                u_phy,v_phy,tke_pbl,                                 &amp;<a name='2090'>
                tsk,qsfc,thz0,qz0,uz0,vz0,                           &amp;<a name='2091'>
                lowlyr,                                              &amp;<a name='2092'>
                xland,                                               &amp;<a name='2093'>
                TICE2TSK_IF2COLD,                                    &amp; <font color=#447700>! Extra for wrapper.<a name='2094'></font>
                XICE_THRESHOLD,                                      &amp; <font color=#447700>! Extra for wrapper.<a name='2095'></font>
                XICE, SST,                                           &amp; <font color=#447700>! Extra for wrapper.<a name='2096'></font>
                CHS_SEA, CHS2_SEA, CQS2_SEA, CPM_SEA,            &amp;<a name='2097'>
                FLHC_SEA, FLQC_SEA, QSFC_SEA, &amp;<a name='2098'>
                QGH_SEA, QZ0_SEA, HFX_SEA, QFX_SEA, LH_SEA,         &amp;<a name='2099'>
                TSK_SEA,                                             &amp;<a name='2100'>
                ust,znt,z0,pblh,mavail,rmol,                         &amp;<a name='2101'>
                akhs,akms,                                           &amp;<a name='2102'>
                br,                                                 &amp;<a name='2103'>
                chs,chs2,cqs2,hfx,qfx,lh,flhc,flqc,qgh,cpm,ct,       &amp;<a name='2104'>
                u10,v10,t2,th2,tshltr,th10,q2,qshltr,q10,pshltr,               &amp;<a name='2105'>
                ids,ide, jds,jde, kds,kde,                           &amp;<a name='2106'>
                ims,ime, jms,jme, kms,kme,                           &amp;<a name='2107'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,SCM_FORCE_FLUX    )<a name='2108'>
           ELSE<a name='2109'>
            CALL <A href='../../html_code/phys/module_sf_qnsesfc.F.html#QNSESFC'>QNSESFC</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QNSESFC_1">(itimestep,ht,dz8w,                         &amp;<a name='2110'>
              p_phy,p8w,th_phy,t_phy,                              &amp;<a name='2111'>
              qv_curr,qc_curr,                                     &amp;<a name='2112'>
              u_phy,v_phy,tke_pbl,                                 &amp;<a name='2113'>
              tsk,qsfc,thz0,qz0,uz0,vz0,                           &amp;<a name='2114'>
              lowlyr,                                              &amp;<a name='2115'>
              xland,                                               &amp;<a name='2116'>
              ust,znt,z0,pblh,mavail,rmol,                         &amp;<a name='2117'>
              akhs,akms,                                           &amp;<a name='2118'>
              br,                                                 &amp;<a name='2119'>
              chs,chs2,cqs2,hfx,qfx,lh,flhc,flqc,qgh,cpm,ct,       &amp;<a name='2120'>
              u10,v10,t2,th2,tshltr,th10,q2,qshltr,q10,pshltr,               &amp;<a name='2121'>
              ids,ide, jds,jde, kds,kde,                           &amp;<a name='2122'>
              ims,ime, jms,jme, kms,kme,                           &amp;<a name='2123'>
              i_start(ij),i_end(ij), j_start(ij),j_end(ij),     &amp;<a name='2124'>
              kts,kte,scm_force_flux    )<a name='2125'>
#if ( EM_CORE==1)<a name='2126'>
         DO j = j_start(ij),j_end(ij)<a name='2127'>
            DO i = i_start(ij),i_end(ij)<a name='2128'>
               wspd(i,j) = MAX(SQRT(u_phy(i,kts,j)**2+v_phy(i,kts,j)**2),0.001)<a name='2129'>
               ch(i,j) = chs (i,j)<a name='2130'>
<font color=#447700>!!           ch(i,j) = flhc(i,j)/( cpm(i,j)*rho(i,kts,j) )<a name='2131'></font>
            END DO<a name='2132'>
         END DO<a name='2133'>
#endif         <a name='2134'>
<a name='2135'>
        ENDIF<a name='2136'>
        ELSE<a name='2137'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1288">('Lacking arguments for QNSESFC in surface driver')<a name='2138'>
       ENDIF<a name='2139'>
<a name='2140'>
     CASE (GFSSFCSCHEME)<a name='2141'>
       IF (PRESENT(qv_curr) .AND. .TRUE. ) THEN<a name='2142'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_849">( 100, 'in GFSSFC' )<a name='2143'>
       IF (FRACTIONAL_SEAICE == 1) THEN<a name='2144'>
          CALL <A href='../../html_code/phys/module_surface_driver.F.html#SF_GFS_SEAICE_WRAPPER'>SF_GFS_SEAICE_WRAPPER</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SF_GFS_SEAICE_WRAPPER_1">(u_phytmp,v_phytmp,t_phy,qv_curr, &amp;<a name='2145'>
               p_phy,CP,RCP,R_d,XLV,PSFC,CHS,CHS2,CQS2,CPM,        &amp;<a name='2146'>
               ZNT,UST,PSIM,PSIH,                                  &amp;<a name='2147'>
               XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,                     &amp;<a name='2148'>
               QGH,QSFC,U10,V10,                                   &amp;<a name='2149'>
               GZ1OZ0,WSPD,BR,ISFFLX,                              &amp;<a name='2150'>
               EP_1,EP_2,KARMAN,itimestep,                         &amp;<a name='2151'>
               TICE2TSK_IF2COLD,                            &amp;<a name='2152'>
               XICE_THRESHOLD,                              &amp;<a name='2153'>
               CHS_SEA, CHS2_SEA, CPM_SEA, CQS2_SEA,        &amp;<a name='2154'>
               FLHC_SEA, FLQC_SEA,                          &amp;<a name='2155'>
               HFX_SEA, LH_SEA, QFX_SEA, QGH_SEA, QSFC_SEA, &amp;<a name='2156'>
               UST_SEA, ZNT_SEA, SST, XICE,                 &amp;<a name='2157'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='2158'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='2159'>
               i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='2160'>
      ELSE<a name='2161'>
         CALL <A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS'>SF_GFS</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SF_GFS_1">(u_phytmp,v_phytmp,t_phy,qv_curr,              &amp;<a name='2162'>
               p_phy,CP,RCP,R_d,XLV,PSFC,CHS,CHS2,CQS2,CPM,        &amp;<a name='2163'>
               ZNT,UST,PSIM,PSIH,                                  &amp;<a name='2164'>
               XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,                     &amp;<a name='2165'>
               QGH,QSFC,U10,V10,                                   &amp;<a name='2166'>
               GZ1OZ0,WSPD,BR,ISFFLX,                              &amp;<a name='2167'>
               EP_1,EP_2,KARMAN,itimestep,                         &amp;<a name='2168'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='2169'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='2170'>
               i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='2171'>
      ENDIF<a name='2172'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_850">(100,'in SFCDIAGS')<a name='2173'>
       ELSE<a name='2174'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1289">('Lacking arguments for SF_GFS in surface driver')<a name='2175'>
      ENDIF<a name='2176'>
<a name='2177'>
#if ( EM_CORE==1)<a name='2178'>
    CASE(MYNNSFCSCHEME)<a name='2179'>
<a name='2180'>
       IF (PRESENT(qv_curr)    .AND.  PRESENT(qc_curr)     &amp;<a name='2181'>
            &amp; .AND.  PRESENT(qcg) ) THEN<a name='2182'>
          <a name='2183'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_851">(100,'in MYNNSFC')          <a name='2184'>
<a name='2185'>
         IF (FRACTIONAL_SEAICE == 1) THEN<a name='2186'>
          CALL <A href='../../html_code/phys/module_surface_driver.F.html#MYNN_SEAICE_WRAPPER'>MYNN_SEAICE_WRAPPER</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYNN_SEAICE_WRAPPER_1">(u_phytmp,v_phytmp,t_phy,qv_curr,&amp;<a name='2187'>
               p_phy,dz8w,cp,g,rcp,r_d,xlv,psfc,chs,chs2,cqs2,cpm, &amp;<a name='2188'>
               znt,ust,pblh,mavail,zol,mol,regime,psim,psih,       &amp;<a name='2189'>
               xland,hfx,qfx,lh,tsk,flhc,flqc,qgh,qsfc,rmol,       &amp;<a name='2190'>
               u10,v10,th2,t2,q2,SNOWH,                            &amp;<a name='2191'>
               gz1oz0,wspd,br,isfflx,dx,                           &amp;<a name='2192'>
               svp1,svp2,svp3,svpt0,ep_1,ep_2,karman,              &amp;<a name='2193'>
               &amp;itimestep,ch,th_phy,pi_phy,qc_curr,rho,            &amp;<a name='2194'>
               &amp;tsq,qsq,cov,Sh3d,el_pbl,qcg,                       &amp;<a name='2195'>
               &amp;icloud_bl,qc_bl,cldfra_bl,                         &amp;<a name='2196'>
               &amp;spp_pbl,pattern_spp_pbl,                           &amp;<a name='2197'>
               XICE,SST,TSK_SEA,                                   &amp;<a name='2198'>
               CHS2_SEA,CHS_SEA,CPM_SEA,CQS2_SEA,FLHC_SEA,FLQC_SEA,&amp;<a name='2199'>
               HFX_SEA,LH_SEA,QFX_SEA,QGH_SEA,QSFC_SEA,ZNT_SEA,    &amp;<a name='2200'>
               TICE2TSK_IF2COLD,XICE_THRESHOLD,                    &amp;<a name='2201'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='2202'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='2203'>
               i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte, &amp;   <a name='2204'>
               ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,bl_mynn_cloudpdf)<a name='2205'>
         ELSE<a name='2206'>
          CALL <A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY_MYNN'>SFCLAY_mynn</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAY_MYNN_1">(u_phytmp,v_phytmp,t_phy,qv_curr,        &amp;<a name='2207'>
               p_phy,dz8w,cp,g,rcp,r_d,xlv,psfc,chs,chs2,cqs2,cpm, &amp;<a name='2208'>
               znt,ust,pblh,mavail,zol,mol,regime,psim,psih,       &amp;<a name='2209'>
               xland,hfx,qfx,lh,tsk,flhc,flqc,qgh,qsfc,rmol,       &amp;<a name='2210'>
               u10,v10,th2,t2,q2,SNOWH,                            &amp;<a name='2211'>
               gz1oz0,wspd,br,isfflx,dx,                           &amp;<a name='2212'>
               svp1,svp2,svp3,svpt0,ep_1,ep_2,karman,              &amp;<a name='2213'>
               &amp;itimestep,ch,th_phy,pi_phy,qc_curr,rho,            &amp;<a name='2214'>
               &amp;tsq,qsq,cov,Sh3D,el_pbl,qcg,                       &amp;<a name='2215'>
               &amp;icloud_bl,qc_bl,cldfra_bl,                         &amp;<a name='2216'>
               &amp;spp_pbl,pattern_spp_pbl,                           &amp;<a name='2217'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='2218'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='2219'>
               i_start(ij),i_end(ij),j_start(ij),j_end(ij),kts,kte,&amp;<a name='2220'>
               ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,bl_mynn_cloudpdf)<a name='2221'>
         ENDIF<a name='2222'>
       ELSE<a name='2223'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1290">('Lacking arguments for SFCLAY_mynn in surface driver')<a name='2224'>
 <a name='2225'>
       ENDIF<a name='2226'>
#endif<a name='2227'>
<a name='2228'>
#if ( EM_CORE==1)<a name='2229'>
     CASE (TEMFSFCSCHEME)<a name='2230'>
       IF (PRESENT(qv_curr).and.PRESENT(hd_temf)) THEN<a name='2231'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_852">( 100, 'in TEMFSFCLAY' )<a name='2232'>
<font color=#447700>! WA 9/7/09 must initialize Z0 and ZNT for TEMF in ideal cases<a name='2233'></font>
       <font color=#447700>! DO J=j_start(ij),j_end(ij)<a name='2234'></font>
       <font color=#447700>! DO I=i_start(ij),i_end(ij)<a name='2235'></font>
       <font color=#447700>!    CHKLOWQ(i,j) = 1.0<a name='2236'></font>
       <font color=#447700>!    Z0(i,j) = 0.03      ! For GABLS2<a name='2237'></font>
       <font color=#447700>!    ZNT(i,j) = 0.03     ! For GABLS2<a name='2238'></font>
       <font color=#447700>! ENDDO<a name='2239'></font>
       <font color=#447700>! ENDDO<a name='2240'></font>
         CALL <A href='../../html_code/phys/module_sf_temfsfclay.F.html#TEMFSFCLAY'>TEMFSFCLAY</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TEMFSFCLAY_1">(u3d=u_phytmp,v3d=v_phytmp,th3d=th_phy,    &amp;<a name='2241'>
               qv3d=qv_curr,p3d=p_phy,pi3d=pi_phy,rho=rho,z=z,ht=ht, &amp;<a name='2242'>
               CP=cp,G=g,ROVCP=rcp,R=r_d,XLV=xlv,psfc=psfc,chs=chs,&amp;<a name='2243'>
               chs2=chs2,cqs2=cqs2,CPM=cpm,znt=znt,ust=ust,        &amp;<a name='2244'>
               MAVAIL=mavail,XLAND=xland,HFX=hfx,QFX=qfx,LH=lh,   &amp;<a name='2245'>
               TSK=tsk,FLHC=flhc,FLQC=flqc,QGH=qgh,qsfc=qsfc,      &amp;<a name='2246'>
               U10=u10,V10=v10,TH2=th2,T2=t2,Q2=q2,                &amp;<a name='2247'>
               SVP1=svp1,SVP2=svp2,SVP3=svp3,SVPT0=svpt0,EP1=ep_1, &amp;<a name='2248'>
               EP2=ep_2,KARMAN=karman,fCor=fCor,te_temf=te_temf,   &amp;<a name='2249'>
               hd_temf=hd_temf,exch_temf=exch_temf,wm_temf=wm_temf,&amp;<a name='2250'>
               ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde,  &amp;<a name='2251'>
               ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme,  &amp;<a name='2252'>
               its=i_start(ij),ite=i_end(ij),                      &amp;<a name='2253'>
               jts=j_start(ij),jte=j_end(ij), kts=kts,kte=kte )<a name='2254'>
       ELSE<a name='2255'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1291">('Lacking arguments for TEMFSFCLAY in surface driver')<a name='2256'>
       ENDIF<a name='2257'>
<a name='2258'>
     CASE (IDEALSCMSFCSCHEME)<a name='2259'>
       IF (PRESENT(qv_curr)) THEN<a name='2260'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_853">( 100, 'in IDEALSCMSFCLAY' )<a name='2261'>
         CALL <A href='../../html_code/phys/module_sf_idealscmsfclay.F.html#IDEALSCMSFCLAY'>IDEALSCMSFCLAY</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IDEALSCMSFCLAY_1">(u3d=u_phytmp,v3d=v_phytmp,th3d=th_phy,    &amp;<a name='2262'>
               qv3d=qv_curr,p3d=p_phy,pi3d=pi_phy,rho=rho,z=z,ht=ht, &amp;<a name='2263'>
               CP=cp,G=g,ROVCP=rcp,R=r_d,XLV=xlv,psfc=psfc,chs=chs,  &amp;<a name='2264'>
               chs2=chs2,cqs2=cqs2,CPM=cpm,znt=znt,ust=ust,        &amp;<a name='2265'>
               MAVAIL=mavail,XLAND=xland,HFX=hfx,QFX=qfx,LH=lh,   &amp;<a name='2266'>
               TSK=tsk,FLHC=flhc,FLQC=flqc,QGH=qgh,qsfc=qsfc,      &amp;<a name='2267'>
               U10=u10,V10=v10,TH2=th2,T2=t2,Q2=q2,                &amp;<a name='2268'>
               SVP1=svp1,SVP2=svp2,SVP3=svp3,SVPT0=svpt0,EP1=ep_1, &amp;<a name='2269'>
               EP2=ep_2,KARMAN=karman,fCor=fCor,   &amp;<a name='2270'>
               exch_temf=exch_temf,                &amp;<a name='2271'>
               hfx_force=hfx_force,lh_force=lh_force,tsk_force=tsk_force, &amp;<a name='2272'>
               hfx_force_tend=hfx_force_tend,                      &amp;<a name='2273'>
               lh_force_tend=lh_force_tend,                        &amp;<a name='2274'>
               tsk_force_tend=tsk_force_tend,                      &amp;<a name='2275'>
               dt=dt,itimestep=itimestep,                          &amp;<a name='2276'>
               ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde,  &amp;<a name='2277'>
               ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme,  &amp;<a name='2278'>
               its=i_start(ij),ite=i_end(ij),                      &amp;<a name='2279'>
               jts=j_start(ij),jte=j_end(ij), kts=kts,kte=kte )<a name='2280'>
       ELSE<a name='2281'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1292">('Lacking arguments for IDEALSCMSFCLAY in surface driver')<a name='2282'>
       ENDIF<a name='2283'>
#endif<a name='2284'>
<a name='2285'>
#if (NMM_CORE==1)<a name='2286'>
<a name='2287'>
    CASE (GFDLSFCSCHEME)<a name='2288'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_854">( 100, 'in GFDLSFC' )<a name='2289'>
<a name='2290'>
      IF(sf_surface_physics .eq. 88)THEN<a name='2291'>
        GFDL_NTSFLG=1<a name='2292'>
      ELSE<a name='2293'>
        GFDL_NTSFLG=0<a name='2294'>
      ENDIF<a name='2295'>
<a name='2296'>
      CALL <A href='../../html_code/phys/module_sf_gfdl.F.html#SF_GFDL'>SF_GFDL</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SF_GFDL_1">(u_phytmp,v_phytmp,t_phy,qv_curr,p_phy, &amp;<a name='2297'>
                   CP,RCP,R_d,XLV,PSFC,CHS,CHS2,CQS2,CPM,                 &amp;<a name='2298'>
                   DTBL, SMOIS,num_soil_layers,ISLTYP,ZNT,                &amp;<a name='2299'>
#if (HWRF==1)<a name='2300'>
                   MZNT,                                                  &amp;<a name='2301'>
#endif<a name='2302'>
                   UST,PSIM,PSIH,                                         &amp;  <a name='2303'>
                   XLAND,HFX,QFX,TAUX,TAUY,LH,GSW,GLW,TSK,FLHC,FLQC,  &amp; <font color=#447700>! gopal's doing for Ocean coupling<a name='2304'></font>
                   QGH,QSFC,U10,V10,                              &amp;<a name='2305'>
                   ICOEF_SF,IWAVECPL,LCURR_SF,CHARN, MSANG, SCURX, SCURY, &amp;<a name='2306'>
                   pert_Cd, ens_random_seed, ens_Cdamp,           &amp;<a name='2307'>
                   GZ1OZ0,WSPD,BR,ZKMAX, ISFFLX,                  &amp;<a name='2308'>
                   EP_1,EP_2,KARMAN,GFDL_NTSFLG,SFENTH,           &amp;<a name='2309'>
                   cd_out, ch_out,                                &amp;<a name='2310'>
                   ids,ide, jds,jde, kds,kde,                     &amp;<a name='2311'>
                   ims,ime, jms,jme, kms,kme,                             &amp;<a name='2312'>
                   i_start(ij),i_end(ij),j_start(ij),j_end(ij),kts,kte    )<a name='2313'>
           RIBN = BR<a name='2314'>
           DO j=j_start(ij),j_end(ij)<a name='2315'>
           DO i=i_start(ij),i_end(ij)<a name='2316'>
              CHKLOWQ(I,J)= 1.0<a name='2317'>
           ENDDO<a name='2318'>
           ENDDO<a name='2319'>
<a name='2320'>
#endif<a name='2321'>
     CASE DEFAULT<a name='2322'>
<a name='2323'>
       WRITE( message , * )                                &amp;<a name='2324'>
   'The sfclay option does not exist: sf_sfclay_physics = ', sf_sfclay_physics<a name='2325'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1293"> ( message )<a name='2326'>
<a name='2327'>
     END SELECT sfclay_select<a name='2328'>
<a name='2329'>
<font color=#447700>!  Compute uratx, vratx, tratx for obs nudging<a name='2330'></font>
     IF(PRESENT(uratx) .and. PRESENT(vratx) .and. PRESENT(tratx))THEN<a name='2331'>
        DO J=j_start(ij),j_end(ij)<a name='2332'>
        DO I=i_start(ij),i_end(ij)<a name='2333'>
           IF(ABS(U10(I,J)) .GT. 1.E-10) THEN<a name='2334'>
              uratx(I,J) = U_PHYTMP(I,1,J)/U10(I,J)<a name='2335'>
           ELSE<a name='2336'>
              uratx(I,J) = 1.2<a name='2337'>
           END IF<a name='2338'>
           IF(ABS(V10(I,J)) .GT. 1.E-10) THEN<a name='2339'>
              vratx(I,J) = V_PHYTMP(I,1,J)/V10(I,J)<a name='2340'>
           ELSE<a name='2341'>
              vratx(I,J) = 1.2<a name='2342'>
           END IF<a name='2343'>
<font color=#447700>! (Quotient P1000mb/P_PHY must be conditioned due to large value of P1000mb)<a name='2344'></font>
           tratx(I,J) = (T_PHY(I,1,J)*(P1000mb*0.001/(P_PHY(I,1,J)/1000.))**RCP)  &amp;<a name='2345'>
                        /TH2(I,J)<a name='2346'>
        ENDDO<a name='2347'>
        ENDDO<a name='2348'>
     ENDIF<a name='2349'>
<a name='2350'>
#if ( EM_CORE==1)<a name='2351'>
<font color=#447700>!Katata-added - fog (cloud) water deposition calculation<a name='2352'></font>
     IF ( grav_settling .EQ. 0 ) THEN<a name='2353'>
        <font color=#447700>!vdfg = 0.<a name='2354'></font>
        DO j=j_start(ij),j_end(ij)<a name='2355'>
        DO i=i_start(ij),i_end(ij)<a name='2356'>
           vdfg(i,j)=0.<a name='2357'>
        ENDDO<a name='2358'>
        ENDDO<a name='2359'>
     ELSE<a name='2360'>
        IF ( PRESENT(dfgdp) .AND. PRESENT(fgdp) .AND. &amp;<a name='2361'>
           &amp; PRESENT(rainbl) .AND. PRESENT(vdfg)) THEN<a name='2362'>
           DO j=j_start(ij),j_end(ij)<a name='2363'>
           DO i=i_start(ij),i_end(ij)<a name='2364'>
              dfgdp(i,j)=0.<a name='2365'>
           ENDDO<a name='2366'>
           ENDDO<a name='2367'>
<a name='2368'>
           CALL <A href='../../html_code/phys/module_sf_fogdes.F.html#SF_FOGDES'>sf_fogdes</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SF_FOGDES_1">(                                  &amp;<a name='2369'>
                vdfg,fgdp,dfgdp,ivgtyp,lai,wspd,qc_curr,    &amp;<a name='2370'>
                dtbl,rho,dz8w,grav_settling,nlcat,          &amp;<a name='2371'>
                ids,ide, jds,jde, kds,kde,                  &amp;<a name='2372'>
                ims,ime, jms,jme, kms,kme,                  &amp;<a name='2373'>
                i_start(ij),i_end(ij),                      &amp;<a name='2374'>
                j_start(ij),j_end(ij),kts,kte               )<a name='2375'>
<a name='2376'>
           <font color=#447700>!Add fog dep to RAINBL in mm (Accumulation between PBL calls).<a name='2377'></font>
           DO j=j_start(ij),j_end(ij)<a name='2378'>
           DO i=i_start(ij),i_end(ij)<a name='2379'>
              RAINBL(i,j) = RAINBL(i,j) + dfgdp(i,j)<a name='2380'>
              RAINBL(i,j) = MAX(RAINBL(i,j), 0.0)<a name='2381'>
           ENDDO<a name='2382'>
           ENDDO<a name='2383'>
<a name='2384'>
        ELSE<a name='2385'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1294">('Missing args for FGDP in surface driver')<a name='2386'>
        ENDIF<a name='2387'>
     ENDIF<a name='2388'>
<font color=#447700>!Katata/Joe-END<a name='2389'></font>
#endif<a name='2390'>
<a name='2391'>
     ENDDO<a name='2392'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='2393'></font>
<a name='2394'>
     IF (ISFFLX.EQ.0 ) GOTO 430<a name='2395'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2396'></font>
     <font color=#447700>!$OMP PRIVATE ( ij, i, j, k ) firstprivate(frpcpn)<a name='2397'></font>
     DO ij = 1 , num_tiles<a name='2398'>
<a name='2399'>
     sfc_select: SELECT CASE(sf_surface_physics)<a name='2400'>
<a name='2401'>
     CASE (SLABSCHEME)<a name='2402'>
<a name='2403'>
       IF (PRESENT(qv_curr)                            .AND.    &amp;<a name='2404'>
           PRESENT(capg)        .AND.    &amp;<a name='2405'>
                                                      .TRUE. ) THEN<a name='2406'>
           DO j=j_start(ij),j_end(ij)<a name='2407'>
           DO i=i_start(ij),i_end(ij)<a name='2408'>
<font color=#447700>!          CQS2 ACCOUNTS FOR MAVAIL FOR SFCDIAGS 2M Q<a name='2409'></font>
              CQS2(I,J)= CQS2(I,J)*MAVAIL(I,J)<a name='2410'>
           ENDDO<a name='2411'>
           ENDDO<a name='2412'>
<a name='2413'>
           IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='2414'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1295">('SLAB scheme cannot be used with fractional seaice')<a name='2415'>
           ENDIF<a name='2416'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_855">(100,'in SLAB')<a name='2417'>
          CALL <A href='../../html_code/phys/module_sf_slab.F.html#SLAB'>SLAB</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SLAB_1">(t_phy,qv_curr,p_phy,flhc,flqc,  &amp;<a name='2418'>
             psfc,xland,tmn,hfx,qfx,lh,tsk,qsfc,chklowq,          &amp;<a name='2419'>
             gsw,glw,capg,thc,snowc,emiss,mavail,                 &amp;<a name='2420'>
             dtbl,rcp,xlv,dtmin,ifsnow,                           &amp;<a name='2421'>
             svp1,svp2,svp3,svpt0,ep_2,karman,eomeg,stbolt,       &amp;<a name='2422'>
             tslb,zs,dzs,num_soil_layers,radiation,               &amp;<a name='2423'>
             p1000mb,                                             &amp;<a name='2424'>
             ids,ide, jds,jde, kds,kde,                           &amp;<a name='2425'>
             ims,ime, jms,jme, kms,kme,                           &amp;<a name='2426'>
             i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte)<a name='2427'>
<a name='2428'>
           DO j=j_start(ij),j_end(ij)<a name='2429'>
           DO i=i_start(ij),i_end(ij)<a name='2430'>
              SFCEVP(I,J)= SFCEVP(I,J) + QFX(I,J)*DTBL<a name='2431'>
              IF(PRESENT(ACHFX))ACHFX(I,J)=ACHFX(I,J) + HFX(I,J)*DT<a name='2432'>
              IF(PRESENT(ACLHF))ACLHF(I,J)=ACLHF(I,J) + LH(I,J)*DT<a name='2433'>
           ENDDO<a name='2434'>
           ENDDO<a name='2435'>
<a name='2436'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_856">(100,'in SFCDIAGS')<a name='2437'>
          CALL <A href='../../html_code/phys/module_sf_sfcdiags.F.html#SFCDIAGS'>SFCDIAGS</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIAGS_1">(hfx,qfx,tsk,qsfc,chs2,cqs2,t2,th2,q2,      &amp;<a name='2438'>
                     psfc,cp,r_d,rcp,CHS,t_phy,qv_curr,ua_phys,    &amp;<a name='2439'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='2440'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='2441'>
             i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='2442'>
<a name='2443'>
       ENDIF<a name='2444'>
<a name='2445'>
     CASE (LSMSCHEME)<a name='2446'>
<a name='2447'>
       IF (PRESENT(qv_curr)    .AND.  PRESENT(rainbl)        .AND.    &amp;<a name='2448'>
<font color=#447700>!          PRESENT(emiss)      .AND.  PRESENT(t2)            .AND.    &amp;<a name='2449'></font>
<font color=#447700>!          PRESENT(declin) .AND.  PRESENT(coszen)    .AND.    &amp;<a name='2450'></font>
<font color=#447700>!          PRESENT(hrang)  .AND. PRESENT( xlat_urb2d)    .AND.    &amp;<a name='2451'></font>
<font color=#447700>!          PRESENT(dzr)       .AND.    &amp;<a name='2452'></font>
<font color=#447700>!          PRESENT( dzb)            .AND. PRESENT(dzg)       .AND.    &amp;<a name='2453'></font>
<font color=#447700>!          PRESENT(tr_urb2d) .AND. PRESENT(tb_urb2d)         .AND.    &amp;<a name='2454'></font>
<font color=#447700>!          PRESENT(tg_urb2d) .AND. PRESENT(tc_urb2d) .AND.            &amp;<a name='2455'></font>
<font color=#447700>!          PRESENT(qc_urb2d) .AND. PRESENT(uc_urb2d) .AND.            &amp;<a name='2456'></font>
<font color=#447700>!          PRESENT(xxxr_urb2d) .AND. PRESENT(xxxb_urb2d) .AND.        &amp;<a name='2457'></font>
<font color=#447700>!          PRESENT(xxxg_urb2d) .AND.                                  &amp;<a name='2458'></font>
<font color=#447700>!          PRESENT(xxxc_urb2d) .AND. PRESENT(trl_urb3d) .AND.         &amp;<a name='2459'></font>
<font color=#447700>!          PRESENT(tbl_urb3d)   .AND. PRESENT(tgl_urb3d)  .AND.       &amp;<a name='2460'></font>
<font color=#447700>!          PRESENT(sh_urb2d) .AND. PRESENT(lh_urb2d)  .AND.           &amp;<a name='2461'></font>
<font color=#447700>!          PRESENT(g_urb2d)   .AND. PRESENT(rn_urb2d) .AND.           &amp;<a name='2462'></font>
<font color=#447700>!          PRESENT(ts_urb2d)                          .AND.           &amp;<a name='2463'></font>
<font color=#447700>!          PRESENT(frc_urb2d) .AND. PRESENT(utype_urb2d)   .AND.      &amp;<a name='2464'></font>
                                                      .TRUE. ) THEN<a name='2465'>
<font color=#447700>!------------------------------------------------------------------<a name='2466'></font>
         IF( PRESENT(sr) ) THEN<a name='2467'>
           frpcpn=.true.<a name='2468'>
         ENDIF<a name='2469'>
         IF ( FRACTIONAL_SEAICE == 1) THEN<a name='2470'>
            <font color=#447700>! The fields passed to LSM need to represent the full ice values, not<a name='2471'></font>
            <font color=#447700>! the fractional values.  Convert ALBEDO and EMISS from the blended value <a name='2472'></font>
            <font color=#447700>! to a value representing only the sea-ice portion.   Albedo over open <a name='2473'></font>
            <font color=#447700>! water is taken to be 0.08. Emissivity over open water is taken to be 0.98<a name='2474'></font>
            DO j = j_start(ij) , j_end(ij)<a name='2475'>
               DO i = i_start(ij) , i_end(ij)<a name='2476'>
                  IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1 ) ) THEN<a name='2477'>
                     ALBEDO(I,J) = (ALBEDO(I,J)-(1.-XICE(I,J))*0.08)/XICE(I,J)<a name='2478'>
                     EMISS(I,J) = (EMISS(I,J)-(1.-XICE(I,J))*0.98)/XICE(I,J)<a name='2479'>
                  ENDIF<a name='2480'>
               ENDDO<a name='2481'>
            ENDDO<a name='2482'>
<a name='2483'>
            IF ( isisfc ) THEN<a name='2484'>
               <font color=#447700>! Use surface layer routine values from the ice portion of grid point<a name='2485'></font>
            ELSE<a name='2486'>
               <font color=#447700>!<a name='2487'></font>
               <font color=#447700>! We don't have surface layer routine values at this time, so<a name='2488'></font>
               <font color=#447700>! just use what we have.  Use ice component of TSK<a name='2489'></font>
               <font color=#447700>!<a name='2490'></font>
               CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_1">( ims, ime, jms, jme,                   &amp;<a name='2491'>
                                       i_start(ij), i_end(ij),               &amp; <a name='2492'>
                                       j_start(ij), j_end(ij),               &amp;<a name='2493'>
                                       itimestep, .false., tice2tsk_if2cold, &amp;<a name='2494'>
                                       XICE, XICE_THRESHOLD,                 &amp;<a name='2495'>
                                       SST, TSK, TSK_SEA, TSK_LOCAL )<a name='2496'>
<a name='2497'>
               DO j = j_start(ij) , j_end(ij)<a name='2498'>
                  DO i = i_start(ij) , i_end(ij)<a name='2499'>
                     TSK(i,j) = TSK_LOCAL(i,j)<a name='2500'>
                  ENDDO<a name='2501'>
               ENDDO<a name='2502'>
            ENDIF<a name='2503'>
         ENDIF<a name='2504'>
<a name='2505'>
<font color=#447700>!added for WRF_HYDRO<a name='2506'></font>
#ifdef WRF_HYDRO<a name='2507'>
         if(HYDRO_dt .ge. 0) HYDRO_dt = dtbl<a name='2508'>
#endif<a name='2509'>
<a name='2510'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_857">(100,'in NOAH DRV')<a name='2511'>
                <a name='2512'>
         IF (sf_surface_mosaic == 1) THEN<a name='2513'>
          <a name='2514'>
           IF ( PRESENT( TSK_mosaic ) .AND. PRESENT( HFX_mosaic ) ) THEN<a name='2515'>
             CALL <A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM_MOSAIC'>lsm_mosaic</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LSM_MOSAIC_1">(dz8w,qv_curr,p8w,t_phy,tsk,                 &amp;<a name='2516'>
                hfx,qfx,lh,grdflx,qgh,gsw,swdown,glw,smstav,smstot,    &amp;<a name='2517'>
                sfcrunoff,udrunoff,ivgtyp,isltyp,isurban,isice,vegfra,        &amp;<a name='2518'>
                albedo,albbck,znt,z0, tmn,xland,xice,emiss, embck,    &amp;<a name='2519'>
                snowc,qsfc,rainbl,                              &amp;<a name='2520'>
                mminlu,                                         &amp;<a name='2521'>
                num_soil_layers,dtbl,dzs,itimestep,             &amp;<a name='2522'>
                smois,tslb,snow,canwat,                         &amp;<a name='2523'>
                chs, chs2, cqs2, cpm,rcp,SR,chklowq,lai,qz0,    &amp;<a name='2524'>
                myj,frpcpn,                                     &amp;<a name='2525'>
		sh2o,snowh,                                     &amp; <font color=#447700>!h<a name='2526'></font>
                u_phy,v_phy,                                    &amp; <font color=#447700>!I<a name='2527'></font>
                snoalb,shdmin,shdmax,                           &amp; <font color=#447700>!i<a name='2528'></font>
                snotime,                                        &amp; <font color=#447700>!o<a name='2529'></font>
                acsnom,acsnow,                                  &amp; <font color=#447700>!o<a name='2530'></font>
                snopcx,                                         &amp; <font color=#447700>!o<a name='2531'></font>
                potevp,                                         &amp; <font color=#447700>!o<a name='2532'></font>
                smcrel,                                         &amp; <font color=#447700>!o<a name='2533'></font>
                xice_threshold,                                 &amp;<a name='2534'>
                rdlai2d,usemonalb,                              &amp;<a name='2535'>
                br,                                             &amp; <font color=#447700>!?<a name='2536'></font>
                NOAHRES,opt_thcnd,                              &amp;<a name='2537'>
                NLCAT,landusef,landusef2,                       &amp; <font color=#447700>! danli mosaic<a name='2538'></font>
                sf_surface_mosaic,mosaic_cat,mosaic_cat_index,  &amp; <font color=#447700>! danli mosaic <a name='2539'></font>
                TSK_mosaic,QSFC_mosaic,                         &amp; <font color=#447700>! danli mosaic <a name='2540'></font>
                TSLB_mosaic,SMOIS_mosaic,SH2O_mosaic,           &amp; <font color=#447700>! danli mosaic <a name='2541'></font>
                CANWAT_mosaic,SNOW_mosaic,                      &amp; <font color=#447700>! danli mosaic<a name='2542'></font>
                SNOWH_mosaic,SNOWC_mosaic,                      &amp; <font color=#447700>! danli mosaic <a name='2543'></font>
                ALBEDO_mosaic,ALBBCK_mosaic,                    &amp; <font color=#447700>! danli mosaic<a name='2544'></font>
                EMISS_mosaic, EMBCK_mosaic,                     &amp; <font color=#447700>! danli mosaic<a name='2545'></font>
                ZNT_mosaic, Z0_mosaic,                          &amp; <font color=#447700>! danli mosaic <a name='2546'></font>
                HFX_mosaic,QFX_mosaic,                          &amp; <font color=#447700>! danli mosaic<a name='2547'></font>
                LH_mosaic, GRDFLX_mosaic, SNOTIME_mosaic,       &amp; <font color=#447700>! danli mosaic          <a name='2548'></font>
                ua_phys,flx4,fvb,fbur,fgsn,                     &amp;<a name='2549'>
                ids,ide, jds,jde, kds,kde,                      &amp;<a name='2550'>
                ims,ime, jms,jme, kms,kme,                      &amp;<a name='2551'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,    &amp;<a name='2552'>
                sf_urban_physics                                &amp;<a name='2553'>
<font color=#447700>!Optional urban<a name='2554'></font>
                ,cmr_sfcdif,chr_sfcdif,cmc_sfcdif,chc_sfcdif    &amp;<a name='2555'>
                ,cmgr_sfcdif,chgr_sfcdif                        &amp;<a name='2556'>
                ,tr_urb2d,tb_urb2d,tg_urb2d,tc_urb2d,qc_urb2d,  &amp; <font color=#447700>!H urban<a name='2557'></font>
                uc_urb2d,                                       &amp; <font color=#447700>!H urban<a name='2558'></font>
                xxxr_urb2d,xxxb_urb2d,xxxg_urb2d,xxxc_urb2d,    &amp; <font color=#447700>!H urban<a name='2559'></font>
                trl_urb3d,tbl_urb3d,tgl_urb3d,                  &amp; <font color=#447700>!H urban<a name='2560'></font>
                sh_urb2d,lh_urb2d,g_urb2d,rn_urb2d,ts_urb2d,    &amp; <font color=#447700>!H urban<a name='2561'></font>
                TR_URB2D_mosaic,TB_URB2D_mosaic,                &amp; <font color=#447700>!H urban  danli mosaic<a name='2562'></font>
                TG_URB2D_mosaic,TC_URB2D_mosaic,                &amp; <font color=#447700>!H urban  danli mosaic<a name='2563'></font>
                QC_URB2D_mosaic,UC_URB2D_mosaic,                &amp; <font color=#447700>!H urban  danli mosaic                  <a name='2564'></font>
                TRL_URB3D_mosaic,TBL_URB3D_mosaic,              &amp; <font color=#447700>!H urban  danli mosaic<a name='2565'></font>
                TGL_URB3D_mosaic,                               &amp; <font color=#447700>!H urban  danli mosaic<a name='2566'></font>
                SH_URB2D_mosaic,LH_URB2D_mosaic,                &amp; <font color=#447700>!H urban  danli mosaic<a name='2567'></font>
                G_URB2D_mosaic,RN_URB2D_mosaic,                 &amp; <font color=#447700>!H urban  danli mosaic<a name='2568'></font>
                TS_URB2D_mosaic,                                &amp; <font color=#447700>!H urban  danli mosaic<a name='2569'></font>
                TS_RUL2D_mosaic,                                &amp; <font color=#447700>!H urban  danli mosaic                <a name='2570'></font>
                psim_urb2d,psih_urb2d,u10_urb2d,v10_urb2d,      &amp; <font color=#447700>!O urban<a name='2571'></font>
                GZ1OZ0_urb2d, AKMS_URB2D,                       &amp; <font color=#447700>!O urban<a name='2572'></font>
                th2_urb2d,q2_urb2d,ust_urb2d,                   &amp; <font color=#447700>!O urban<a name='2573'></font>
                declin,coszen,hrang,                            &amp; <font color=#447700>!I solar<a name='2574'></font>
                xlat_urb2d,                                     &amp; <font color=#447700>!I urban<a name='2575'></font>
                num_roof_layers, num_wall_layers,               &amp; <font color=#447700>!I urban<a name='2576'></font>
                num_road_layers, DZR, DZB, DZG,                 &amp; <font color=#447700>!I urban<a name='2577'></font>
                CMCR_URB2D,TGR_URB2D,TGRL_URB3D,SMR_URB3D,      &amp; <font color=#447700>!H urban<a name='2578'></font>
                julian,julyr,                                   &amp; <font color=#447700>!H urban<a name='2579'></font>
                DRELR_URB2D,DRELB_URB2D,DRELG_URB2D,            &amp; <font color=#447700>!H urban<a name='2580'></font>
                FLXHUMR_URB2D,FLXHUMB_URB2D,FLXHUMG_URB2D,      &amp; <font color=#447700>!H urban<a name='2581'></font>
                FRC_URB2D, UTYPE_URB2D,                         &amp; <font color=#447700>!I urban<a name='2582'></font>
                num_urban_layers,                               &amp; <font color=#447700>!I multi-layer urban<a name='2583'></font>
                num_urban_hi,                                   &amp; <font color=#447700>!I multi-layer urban<a name='2584'></font>
                trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,        &amp; <font color=#447700>!H multi-layer urban<a name='2585'></font>
                tlev_urb3d,qlev_urb3d,                          &amp; <font color=#447700>!H multi-layer urban<a name='2586'></font>
                tw1lev_urb3d,tw2lev_urb3d,                      &amp; <font color=#447700>!H multi-layer urban<a name='2587'></font>
                tglev_urb3d,tflev_urb3d,                        &amp; <font color=#447700>!H multi-layer urban<a name='2588'></font>
                sf_ac_urb3d,lf_ac_urb3d,cm_ac_urb3d,            &amp; <font color=#447700>!H multi-layer urban<a name='2589'></font>
                sfvent_urb3d,lfvent_urb3d,                      &amp; <font color=#447700>!H multi-layer urban<a name='2590'></font>
                sfwin1_urb3d,sfwin2_urb3d,                      &amp; <font color=#447700>!H multi-layer urban<a name='2591'></font>
                sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,      &amp; <font color=#447700>!H multi-layer urban<a name='2592'></font>
                lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,           &amp; <font color=#447700>!H multi-layer urban<a name='2593'></font>
                mh_urb2d,stdh_urb2D,lf_urb2d,                   &amp; <font color=#447700>!SLUCM<a name='2594'></font>
                th_phy,rho,p_phy,ust,                           &amp; <font color=#447700>!I multi-layer urban<a name='2595'></font>
                gmt,julday,xlong,xlat,                          &amp; <font color=#447700>!I multi-layer urban<a name='2596'></font>
                a_u_bep,a_v_bep,a_t_bep,a_q_bep,                &amp; <font color=#447700>!O multi-layer urban<a name='2597'></font>
                a_e_bep,b_u_bep,b_v_bep,                        &amp; <font color=#447700>!O multi-layer urban<a name='2598'></font>
                b_t_bep,b_q_bep,b_e_bep,dlg_bep,                &amp; <font color=#447700>!O multi-layer urban<a name='2599'></font>
                dl_u_bep,sf_bep,vl_bep                          &amp; <font color=#447700>!O multi-layer urban<a name='2600'></font>
                ,sfcheadrt,INFXSRT, soldrain                    &amp; <font color=#447700>!hydro<a name='2601'></font>
                ,SDA_HFX, SDA_QFX, HFX_BOTH, QFX_BOTH, QNORM, fasdas    &amp; <font color=#447700>! fasdas<a name='2602'></font>
                )<a name='2603'>
<a name='2604'>
           ELSE<a name='2605'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1296">('Lack arguments to call lsm_mosaic')<a name='2606'>
           ENDIF<a name='2607'>
<a name='2608'>
	  ELSEIF (sf_surface_mosaic == 0) THEN<a name='2609'>
	                  <a name='2610'>
<font color=#447700>!<a name='2611'></font>
<font color=#447700>!  FASDAS<a name='2612'></font>
<font color=#447700>!<a name='2613'></font>
             IF( fasdas == 1 ) THEN<a name='2614'>
               DO j=j_start(ij),j_end(ij)<a name='2615'>
               DO i=i_start(ij),i_end(ij)<a name='2616'>
<a name='2617'>
<font color=#447700>!ckay2015 only do indirect nudging over land areas <a name='2618'></font>
                     IF(XLAND(i,j) .GT. 1.5) then<a name='2619'>
                      SDA_QFX(I,J) = 0.0<a name='2620'>
                      SDA_HFX(I,J) = 0.0<a name='2621'>
                     END IF<a name='2622'>
<a name='2623'>
<font color=#447700>! TWG2015 Removed lines that update fluxes to ensure this section only defines<a name='2624'></font>
<font color=#447700>! the output<a name='2625'></font>
                    QFXOLD(I,J)=QFX(I,J)<a name='2626'>
                    QFX_KAY = SDA_QFX(I,J)*RHO(I,1,J)*DZ8W(I,1,J)<a name='2627'>
                    QFX_KAY = QFX_KAY * QNORM(I,J)<a name='2628'>
                    QFX_BOTH(I,J)=QFX(I,J)+QFX_KAY<a name='2629'>
<a name='2630'>
                    HFXOLD(I,J)=HFX(I,J)<a name='2631'>
                    HFX_KAY = SDA_HFX(I,J)*RHO(I,1,J)*CPM(I,J)*DZ8W(I,1,J)<a name='2632'>
                    HFX_BOTH(I,J)=HFX(I,J)+HFX_KAY<a name='2633'>
<a name='2634'>
               ENDDO<a name='2635'>
               ENDDO<a name='2636'>
             END IF<a name='2637'>
<font color=#447700>!<a name='2638'></font>
<font color=#447700>!  END FASDAS<a name='2639'></font>
<font color=#447700>!<a name='2640'></font>
               CALL <A href='../../html_code/phys/module_sf_noahdrv.F.html#LSM'>lsm</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LSM_1">(dz8w,qv_curr,p8w,t_phy,tsk,                 &amp;<a name='2641'>
                hfx,qfx,lh,grdflx,qgh,gsw,swdown,glw,smstav,smstot,    &amp;<a name='2642'>
                sfcrunoff,udrunoff,ivgtyp,isltyp,isurban,isice,vegfra,        &amp;<a name='2643'>
                albedo,albbck,znt,z0, tmn,xland,xice,emiss, embck,    &amp;<a name='2644'>
                snowc,qsfc,rainbl,                              &amp;<a name='2645'>
                mminlu,                                         &amp;<a name='2646'>
                num_soil_layers,dtbl,dzs,itimestep,             &amp;<a name='2647'>
                smois,tslb,snow,canwat,                         &amp;<a name='2648'>
                chs, chs2, cqs2, cpm,rcp,SR,chklowq,lai,qz0,    &amp;<a name='2649'>
                myj,frpcpn,                                     &amp;<a name='2650'>
		sh2o,snowh,                                     &amp; <font color=#447700>!h<a name='2651'></font>
                u_phy,v_phy,                                    &amp; <font color=#447700>!I<a name='2652'></font>
                snoalb,shdmin,shdmax,                           &amp; <font color=#447700>!i<a name='2653'></font>
                snotime,                                        &amp; <font color=#447700>!o<a name='2654'></font>
                acsnom,acsnow,                                  &amp; <font color=#447700>!o<a name='2655'></font>
                snopcx,                                         &amp; <font color=#447700>!o<a name='2656'></font>
                potevp,                                         &amp; <font color=#447700>!o<a name='2657'></font>
                smcrel,                                         &amp; <font color=#447700>!o<a name='2658'></font>
                xice_threshold,                                 &amp;<a name='2659'>
                rdlai2d,usemonalb,                              &amp;<a name='2660'>
                br,                                             &amp; <font color=#447700>!?<a name='2661'></font>
                NOAHRES,opt_thcnd,                              &amp;<a name='2662'>
                ua_phys,flx4,fvb,fbur,fgsn,                     &amp;<a name='2663'>
                ids,ide, jds,jde, kds,kde,                      &amp;<a name='2664'>
                ims,ime, jms,jme, kms,kme,                      &amp;<a name='2665'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,    &amp;<a name='2666'>
                sf_urban_physics                                &amp;<a name='2667'>
<font color=#447700>!Optional urban<a name='2668'></font>
                ,cmr_sfcdif,chr_sfcdif,cmc_sfcdif,chc_sfcdif    &amp;<a name='2669'>
                ,cmgr_sfcdif,chgr_sfcdif                        &amp;<a name='2670'>
                ,tr_urb2d,tb_urb2d,tg_urb2d,tc_urb2d,qc_urb2d,  &amp; <font color=#447700>!H urban<a name='2671'></font>
                uc_urb2d,                                       &amp; <font color=#447700>!H urban<a name='2672'></font>
                xxxr_urb2d,xxxb_urb2d,xxxg_urb2d,xxxc_urb2d,    &amp; <font color=#447700>!H urban<a name='2673'></font>
                trl_urb3d,tbl_urb3d,tgl_urb3d,                  &amp; <font color=#447700>!H urban<a name='2674'></font>
                sh_urb2d,lh_urb2d,g_urb2d,rn_urb2d,ts_urb2d,    &amp; <font color=#447700>!H urban<a name='2675'></font>
                psim_urb2d,psih_urb2d,u10_urb2d,v10_urb2d,      &amp; <font color=#447700>!O urban<a name='2676'></font>
                GZ1OZ0_urb2d, AKMS_URB2D,                       &amp; <font color=#447700>!O urban<a name='2677'></font>
                th2_urb2d,q2_urb2d,ust_urb2d,                   &amp; <font color=#447700>!O urban<a name='2678'></font>
                declin,coszen,hrang,                            &amp; <font color=#447700>!I solar<a name='2679'></font>
                xlat_urb2d,                                     &amp; <font color=#447700>!I urban<a name='2680'></font>
                num_roof_layers, num_wall_layers,               &amp; <font color=#447700>!I urban<a name='2681'></font>
                num_road_layers, DZR, DZB, DZG,                 &amp; <font color=#447700>!I urban<a name='2682'></font>
                CMCR_URB2D,TGR_URB2D,TGRL_URB3D,SMR_URB3D,      &amp; <font color=#447700>!H urban<a name='2683'></font>
                DRELR_URB2D,DRELB_URB2D,DRELG_URB2D,            &amp; <font color=#447700>!H urban<a name='2684'></font>
                FLXHUMR_URB2D,FLXHUMB_URB2D,FLXHUMG_URB2D,      &amp; <font color=#447700>!H urban<a name='2685'></font>
                julian, julyr,                                  &amp; <font color=#447700>!H urban<a name='2686'></font>
                FRC_URB2D, UTYPE_URB2D,                         &amp; <font color=#447700>!I urban<a name='2687'></font>
                num_urban_layers,                               &amp; <font color=#447700>!I multi-layer urban<a name='2688'></font>
                num_urban_hi,                                   &amp; <font color=#447700>!I multi-layer urban<a name='2689'></font>
                trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,        &amp; <font color=#447700>!H multi-layer urban<a name='2690'></font>
                tlev_urb3d,qlev_urb3d,                          &amp; <font color=#447700>!H multi-layer urban<a name='2691'></font>
                tw1lev_urb3d,tw2lev_urb3d,                      &amp; <font color=#447700>!H multi-layer urban<a name='2692'></font>
                tglev_urb3d,tflev_urb3d,                        &amp; <font color=#447700>!H multi-layer urban<a name='2693'></font>
                sf_ac_urb3d,lf_ac_urb3d,cm_ac_urb3d,            &amp; <font color=#447700>!H multi-layer urban<a name='2694'></font>
                sfvent_urb3d,lfvent_urb3d,                      &amp; <font color=#447700>!H multi-layer urban<a name='2695'></font>
                sfwin1_urb3d,sfwin2_urb3d,                      &amp; <font color=#447700>!H multi-layer urban<a name='2696'></font>
                sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,      &amp; <font color=#447700>!H multi-layer urban<a name='2697'></font>
                lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,           &amp; <font color=#447700>!H multi-layer urban<a name='2698'></font>
                mh_urb2d,stdh_urb2D,lf_urb2d,                   &amp; <font color=#447700>!SLUCM<a name='2699'></font>
                th_phy,rho,p_phy,ust,                           &amp; <font color=#447700>!I multi-layer urban<a name='2700'></font>
                gmt,julday,xlong,xlat,                          &amp; <font color=#447700>!I multi-layer urban<a name='2701'></font>
                a_u_bep,a_v_bep,a_t_bep,a_q_bep,                &amp; <font color=#447700>!O multi-layer urban<a name='2702'></font>
                a_e_bep,b_u_bep,b_v_bep,                        &amp; <font color=#447700>!O multi-layer urban<a name='2703'></font>
                b_t_bep,b_q_bep,b_e_bep,dlg_bep,                &amp; <font color=#447700>!O multi-layer urban<a name='2704'></font>
                dl_u_bep,sf_bep,vl_bep                          &amp; <font color=#447700>!O multi-layer urban<a name='2705'></font>
                ,sfcheadrt,INFXSRT, soldrain &amp;<a name='2706'>
<font color=#447700>!<a name='2707'></font>
<font color=#447700>!  FASDAS<a name='2708'></font>
<font color=#447700>!<a name='2709'></font>
                ,SDA_HFX, SDA_QFX, HFX_BOTH, QFX_BOTH, QNORM, fasdas    &amp;<a name='2710'>
<font color=#447700>!<a name='2711'></font>
<font color=#447700>!  END FASDAS<a name='2712'></font>
<font color=#447700>!<a name='2713'></font>
                )<a name='2714'>
         ENDIF<a name='2715'>
<a name='2716'>
         call <A href='../../html_code/phys/module_sf_noah_seaice_drv.F.html#SEAICE_NOAH'>seaice_noah</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEAICE_NOAH_1">( SEAICE_ALBEDO_OPT, SEAICE_ALBEDO_DEFAULT, SEAICE_THICKNESS_OPT, &amp;<a name='2717'>
              &amp;            SEAICE_THICKNESS_DEFAULT, SEAICE_SNOWDEPTH_OPT,             &amp;<a name='2718'>
              &amp;            SEAICE_SNOWDEPTH_MAX, SEAICE_SNOWDEPTH_MIN,                 &amp;<a name='2719'>
              &amp;            t_phy, qv_curr, p8w, dz8w, num_soil_layers, dt, frpcpn, sr, &amp;<a name='2720'>
              &amp;            glw, swdown, rainbl, snoalb, qgh, xice, xice_threshold,     &amp;<a name='2721'>
              &amp;            albsi, icedepth, snowsi,                                    &amp;<a name='2722'>
              &amp;            tslb, emiss, albedo, z0, tsk, snow, snowc, snowh,           &amp;<a name='2723'>
              &amp;            chs, chs2, cqs2,                                            &amp;<a name='2724'>
              &amp;            br, znt, lh, hfx, qfx, potevp, grdflx, qsfc, acsnow,        &amp;<a name='2725'>
              &amp;            acsnom, snopcx, sfcrunoff, noahres,                         &amp;<a name='2726'>
              &amp;            sf_urban_physics, b_t_bep, b_q_bep, rho,                    &amp;<a name='2727'>
              &amp;            ids,ide, jds,jde, kds,kde,                                  &amp;<a name='2728'>
              &amp;            ims,ime, jms,jme, kms,kme,                                  &amp;<a name='2729'>
              &amp;            i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte )<a name='2730'>
<a name='2731'>
         IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='2732'>
            <font color=#447700>! LSM Returns full land/ice values, no fractional values.<a name='2733'></font>
            <font color=#447700>! We return to a fractional component here.  SFLX currently hard-wires<a name='2734'></font>
            <font color=#447700>! emissivity over sea ice to 0.98, the same value as over open water, so<a name='2735'></font>
            <font color=#447700>! the fractional consideration doesn't have any effect for emissivity.<a name='2736'></font>
            DO j=j_start(ij),j_end(ij)<a name='2737'>
               DO i=i_start(ij),i_end(ij)<a name='2738'>
                  IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='2739'>
                     albedo(i,j) = ( albedo(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.08  )<a name='2740'>
                     emiss(i,j) = ( emiss(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.98  )<a name='2741'>
                  ENDIF<a name='2742'>
               ENDDO<a name='2743'>
            ENDDO<a name='2744'>
<a name='2745'>
            IF ( isisfc ) THEN<a name='2746'>
               DO j=j_start(ij),j_end(ij)<a name='2747'>
                  DO i=i_start(ij),i_end(ij)<a name='2748'>
                     IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='2749'>
                        <font color=#447700>!  Weighted average of fields between ice-cover values and open-water values.<a name='2750'></font>
                        flhc(i,j) = ( flhc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * flhc_sea(i,j) )<a name='2751'>
                        flqc(i,j) = ( flqc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * flqc_sea(i,j) )<a name='2752'>
                        cpm(i,j)  = ( cpm(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * cpm_sea(i,j)  )<a name='2753'>
                        cqs2(i,j) = ( cqs2(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * cqs2_sea(i,j) )<a name='2754'>
                        chs2(i,j) = ( chs2(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * chs2_sea(i,j) )<a name='2755'>
                        chs(i,j)  = ( chs(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * chs_sea(i,j)  )<a name='2756'>
                        qsfc(i,j) = ( qsfc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qsfc_sea(i,j) )<a name='2757'>
                        qgh(i,j)  = ( qgh(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qgh_sea(i,j)  )<a name='2758'>
                        qz0(i,j)  = ( qz0(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qz0_sea(i,j)  )<a name='2759'>
                                                            <font color=#447700>!  print *,'hfx =',hfx_sea(170,20)<a name='2760'></font>
                                                            <font color=#447700>!   print *,'XICE =',XICE(170,20)<a name='2761'></font>
                                                            <font color=#447700>!    print *,'QSFC =',QSFC(170,20)<a name='2762'></font>
                        hfx(i,j)  = ( hfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * hfx_sea(i,j)  )<a name='2763'>
                        qfx(i,j)  = ( qfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qfx_sea(i,j)  )<a name='2764'>
                        lh(i,j)   = ( lh(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * lh_sea(i,j)   )<a name='2765'>
<font color=#447700>!save old tsk_ice<a name='2766'></font>
                        tsk_save(i,j)  = tsk(i,j)<a name='2767'>
                        tsk(i,j)  = ( tsk(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * tsk_sea(i,j)  )<a name='2768'>
                     ENDIF<a name='2769'>
                  ENDDO<a name='2770'>
               ENDDO<a name='2771'>
            ELSE<a name='2772'>
               DO j = j_start(ij) , j_end(ij)<a name='2773'>
                  DO i = i_start(ij) , i_end(ij)<a name='2774'>
                     IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='2775'>
                        <font color=#447700>! Compute TSK as the open-water and ice-cover average<a name='2776'></font>
                        tsk(i,j) = ( tsk(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * tsk_sea(i,j) )<a name='2777'>
                     ENDIF<a name='2778'>
                  ENDDO<a name='2779'>
               ENDDO<a name='2780'>
            ENDIF<a name='2781'>
         ENDIF<a name='2782'>
           DO j=j_start(ij),j_end(ij)<a name='2783'>
           DO i=i_start(ij),i_end(ij)<a name='2784'>
<font color=#447700>!              CHKLOWQ(I,J)= 1.0<a name='2785'></font>
               SFCEVP(I,J)= SFCEVP(I,J) + QFX(I,J)*DTBL<a name='2786'>
               SFCEXC(I,J)= CHS(I,J)<a name='2787'>
               IF(PRESENT(ACHFX))ACHFX(I,J)=ACHFX(I,J) + HFX(I,J)*DT<a name='2788'>
               IF(PRESENT(ACLHF))ACLHF(I,J)=ACLHF(I,J) + LH(I,J)*DT<a name='2789'>
               IF(PRESENT(ACGRDFLX))ACGRDFLX(I,J)=ACGRDFLX(I,J) + GRDFLX(I,J)*DT<a name='2790'>
           ENDDO<a name='2791'>
           ENDDO<a name='2792'>
<a name='2793'>
          CALL <A href='../../html_code/phys/module_sf_sfcdiags.F.html#SFCDIAGS'>SFCDIAGS</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIAGS_2">(HFX,QFX,TSK,QSFC,CHS2,CQS2,T2,TH2,Q2,      &amp;<a name='2794'>
                     PSFC,CP,R_d,RCP,CHS,t_phy,qv_curr,ua_phys,    &amp;<a name='2795'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='2796'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='2797'>
             i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='2798'>
<font color=#447700>!urban<a name='2799'></font>
     IF(SF_URBAN_PHYSICS.eq.1) THEN<a name='2800'>
       DO j=j_start(ij),j_end(ij)                             <font color=#447700>!urban<a name='2801'></font>
         DO i=i_start(ij),i_end(ij)                           <font color=#447700>!urban<a name='2802'></font>
          IF( IVGTYP(I,J) == ISURBAN .or. &amp;<a name='2803'>
	      IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp; <font color=#447700>!urban<a name='2804'></font>
              IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or.&amp;<a name='2805'>
	      IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN  <font color=#447700>!urban<a name='2806'></font>
             U10(I,J)  = U10_URB2D(I,J)                       <font color=#447700>!urban<a name='2807'></font>
             V10(I,J)  = V10_URB2D(I,J)                       <font color=#447700>!urban<a name='2808'></font>
             PSIM(I,J) = PSIM_URB2D(I,J)                      <font color=#447700>!urban<a name='2809'></font>
             PSIH(I,J) = PSIH_URB2D(I,J)                      <font color=#447700>!urban<a name='2810'></font>
             GZ1OZ0(I,J) = GZ1OZ0_URB2D(I,J)                  <font color=#447700>!urban<a name='2811'></font>
<font color=#447700>!m             AKHS(I,J) = AKHS_URB2D(I,J)                    !urban<a name='2812'></font>
             AKHS(I,J) = CHS(I,J)                             <font color=#447700>!urban<a name='2813'></font>
             AKMS(I,J) = AKMS_URB2D(I,J)                      <font color=#447700>!urban<a name='2814'></font>
           END IF                                             <font color=#447700>!urban<a name='2815'></font>
         ENDDO                                                <font color=#447700>!urban<a name='2816'></font>
       ENDDO                                                  <font color=#447700>!urban<a name='2817'></font>
     ENDIF<a name='2818'>
<font color=#447700>! urban BEP<a name='2819'></font>
     IF((SF_URBAN_PHYSICS.eq.2).OR.(SF_URBAN_PHYSICS.eq.3)) THEN<a name='2820'>
       DO j=j_start(ij),j_end(ij)                             <font color=#447700>!urban<a name='2821'></font>
         DO i=i_start(ij),i_end(ij)                           <font color=#447700>!urban<a name='2822'></font>
          IF( IVGTYP(I,J) == ISURBAN .or. &amp;<a name='2823'>
	      IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp; <font color=#447700>!urban<a name='2824'></font>
              IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. &amp;<a name='2825'>
	      IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL) THEN <font color=#447700>!urban<a name='2826'></font>
            T2(I,J)   = TH_PHY(i,1,j)/((1.E5/PSFC(I,J))**RCP) <font color=#447700>!urban<a name='2827'></font>
            TH2(I,J) = TH_PHY(i,1,j) <font color=#447700>!urban<a name='2828'></font>
            Q2(I,J)   = qv_curr(i,1,j)  <font color=#447700>!urban<a name='2829'></font>
            U10(I,J)  = U_phy(I,1,J)                       <font color=#447700>!urban<a name='2830'></font>
            V10(I,J)  = V_phy(I,1,J)                       <font color=#447700>!urban<a name='2831'></font>
           END IF                                             <font color=#447700>!urban<a name='2832'></font>
         ENDDO                                                <font color=#447700>!urban<a name='2833'></font>
       ENDDO                                                  <font color=#447700>!urban<a name='2834'></font>
     ENDIF<a name='2835'>
<a name='2836'>
<font color=#447700>!------------------------------------------------------------------<a name='2837'></font>
<a name='2838'>
       ELSE<a name='2839'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1297">('Lacking arguments for LSM in surface driver')<a name='2840'>
       ENDIF<a name='2841'>
<a name='2842'>
     CASE (NOAHMPSCHEME)<a name='2843'>
       IF (PRESENT(qv_curr)    .AND.  PRESENT(rainbl)        .AND.    &amp;<a name='2844'>
<font color=#447700>!          PRESENT(emiss)      .AND.  PRESENT(t2)            .AND.    &amp;<a name='2845'></font>
<font color=#447700>!          PRESENT(declin) .AND.  PRESENT(coszen)    .AND.    &amp;<a name='2846'></font>
<font color=#447700>!          PRESENT(hrang)  .AND. PRESENT( xlat_urb2d)    .AND.    &amp;<a name='2847'></font>
<font color=#447700>!          PRESENT(dzr)       .AND.    &amp;<a name='2848'></font>
<font color=#447700>!          PRESENT( dzb)            .AND. PRESENT(dzg)       .AND.    &amp;<a name='2849'></font>
<font color=#447700>!          PRESENT(tr_urb2d) .AND. PRESENT(tb_urb2d)         .AND.    &amp;<a name='2850'></font>
<font color=#447700>!          PRESENT(tg_urb2d) .AND. PRESENT(tc_urb2d) .AND.            &amp;<a name='2851'></font>
<font color=#447700>!          PRESENT(qc_urb2d) .AND. PRESENT(uc_urb2d) .AND.            &amp;<a name='2852'></font>
<font color=#447700>!          PRESENT(xxxr_urb2d) .AND. PRESENT(xxxb_urb2d) .AND.        &amp;<a name='2853'></font>
<font color=#447700>!          PRESENT(xxxg_urb2d) .AND.                                  &amp;<a name='2854'></font>
<font color=#447700>!          PRESENT(xxxc_urb2d) .AND. PRESENT(trl_urb3d) .AND.         &amp;<a name='2855'></font>
<font color=#447700>!          PRESENT(tbl_urb3d)   .AND. PRESENT(tgl_urb3d)  .AND.       &amp;<a name='2856'></font>
<font color=#447700>!          PRESENT(sh_urb2d) .AND. PRESENT(lh_urb2d)  .AND.           &amp;<a name='2857'></font>
<font color=#447700>!          PRESENT(g_urb2d)   .AND. PRESENT(rn_urb2d) .AND.           &amp;<a name='2858'></font>
<font color=#447700>!          PRESENT(ts_urb2d)                          .AND.           &amp;<a name='2859'></font>
<font color=#447700>!          PRESENT(frc_urb2d) .AND. PRESENT(utype_urb2d)   .AND.      &amp;<a name='2860'></font>
#if (EM_CORE==1)<a name='2861'>
           PRESENT(smcwtdxy)       .AND.                              &amp;<a name='2862'>
           PRESENT(rechxy)         .AND.                              &amp;   <a name='2863'>
           PRESENT(deeprechxy)     .AND.                              &amp;<a name='2864'>
           PRESENT(fdepthxy)       .AND.                              &amp;<a name='2865'>
           PRESENT(areaxy)         .AND.                              &amp;   <a name='2866'>
           PRESENT(rivercondxy)    .AND.                              &amp;<a name='2867'>
           PRESENT(riverbedxy)     .AND.                              &amp; <a name='2868'>
           PRESENT(eqzwt)          .AND.                              &amp;    <a name='2869'>
           PRESENT(pexpxy)         .AND.                              &amp;   <a name='2870'>
           PRESENT(qrfxy)          .AND.                              &amp;    <a name='2871'>
           PRESENT(qspringxy)      .AND.                              &amp;<a name='2872'>
           PRESENT(qslatxy)        .AND.                              &amp;  <a name='2873'>
           PRESENT(qrfsxy)         .AND.                              &amp;   <a name='2874'>
           PRESENT(qspringsxy)     .AND.                              &amp; <a name='2875'>
           PRESENT(smoiseq)        .AND.                              &amp;  <a name='2876'>
           PRESENT(wtddt)          .AND.                              &amp;    <a name='2877'>
           PRESENT(stepwtd)        .AND.                              &amp;<a name='2878'>
#endif<a name='2879'>
                                                      .TRUE. ) THEN<a name='2880'>
<font color=#447700>!------------------------------------------------------------------<a name='2881'></font>
<a name='2882'>
<a name='2883'>
         IF ( FRACTIONAL_SEAICE == 1) THEN<a name='2884'>
            <font color=#447700>! The fields passed to LSM need to represent the full ice values, not<a name='2885'></font>
            <font color=#447700>! the fractional values.  Convert ALBEDO and EMISS from the blended value <a name='2886'></font>
            <font color=#447700>! to a value representing only the sea-ice portion.   Albedo over open <a name='2887'></font>
            <font color=#447700>! water is taken to be 0.08. Emissivity over open water is taken to be 0.98<a name='2888'></font>
            DO j = j_start(ij) , j_end(ij)<a name='2889'>
               DO i = i_start(ij) , i_end(ij)<a name='2890'>
                  IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1 ) ) THEN<a name='2891'>
                     ALBEDO(I,J) = (ALBEDO(I,J)-(1.-XICE(I,J))*0.08)/XICE(I,J)<a name='2892'>
                     EMISS(I,J) = (EMISS(I,J)-(1.-XICE(I,J))*0.98)/XICE(I,J)<a name='2893'>
                  ENDIF<a name='2894'>
               ENDDO<a name='2895'>
            ENDDO<a name='2896'>
<a name='2897'>
            IF ( isisfc ) THEN<a name='2898'>
               <font color=#447700>! Use surface layer routine values from the ice portion of grid point<a name='2899'></font>
            ELSE<a name='2900'>
               <font color=#447700>!<a name='2901'></font>
               <font color=#447700>! We don't have surface layer routine values at this time, so<a name='2902'></font>
               <font color=#447700>! just use what we have.  Use ice component of TSK<a name='2903'></font>
               <font color=#447700>!<a name='2904'></font>
               CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_2">( ims, ime, jms, jme,                   &amp;<a name='2905'>
                                       i_start(ij), i_end(ij),               &amp;<a name='2906'>
                                       j_start(ij), j_end(ij),               &amp;<a name='2907'>
                                       itimestep, .false., tice2tsk_if2cold, &amp;<a name='2908'>
                                       XICE, XICE_THRESHOLD,                 &amp;<a name='2909'>
                                       SST, TSK, TSK_SEA, TSK_LOCAL )<a name='2910'>
<a name='2911'>
               DO j = j_start(ij) , j_end(ij)<a name='2912'>
                  DO i = i_start(ij) , i_end(ij)<a name='2913'>
                     TSK(i,j) = TSK_LOCAL(i,j)<a name='2914'>
                  ENDDO<a name='2915'>
               ENDDO<a name='2916'>
            ENDIF<a name='2917'>
         ENDIF<a name='2918'>
<a name='2919'>
<font color=#447700>!added for WRF_HYDRO<a name='2920'></font>
#ifdef WRF_HYDRO<a name='2921'>
         if(HYDRO_dt .ge. 0) HYDRO_dt = dtbl<a name='2922'>
#endif<a name='2923'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_858">(100,'in NOAHMP DRV')<a name='2924'>
         CALL <A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMPLSM'>noahmplsm</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMPLSM_1">(ITIMESTEP,       YR, JULIAN_IN,   COSZEN, XLAT,XLONG, &amp;<a name='2925'>
	           DZ8W,     DTBL,      DZS,     NUM_SOIL_LAYERS,         DX, &amp;<a name='2926'>
		 IVGTYP,   ISLTYP,   VEGFRA,   SHDMAX,       TMN,             &amp;<a name='2927'>
		  XLAND,     XICE,     XICE_THRESHOLD,   CROPCAT,             &amp;<a name='2928'>
               PLANTING,  HARVEST,SEASON_GDD,                               &amp;<a name='2929'>
                  IDVEG, IOPT_CRS, IOPT_BTR, IOPT_RUN,  IOPT_SFC,   IOPT_FRZ, &amp;<a name='2930'>
	       IOPT_INF, IOPT_RAD, IOPT_ALB, IOPT_SNF, IOPT_TBOT,   IOPT_STC, &amp;<a name='2931'>
	       IOPT_GLA, IOPT_RSF,  IZ0TLND, SF_URBAN_PHYSICS,                &amp;<a name='2932'>
		  T_PHY,  QV_CURR,    U_PHY,    V_PHY,    SWDOWN,        GLW, &amp;<a name='2933'>
		    P8W,   RAINBL,       SR,                                  &amp;<a name='2934'>
		    TSK,      HFX,      QFX,       LH,    GRDFLX,     SMSTAV, &amp;<a name='2935'>
		 SMSTOT,SFCRUNOFF, UDRUNOFF,   ALBEDO,     SNOWC,      SMOIS, &amp;<a name='2936'>
		   SH2O,     TSLB,     SNOW,    SNOWH,    CANWAT,     ACSNOM, &amp;<a name='2937'>
		 ACSNOW,    EMISS,     QSFC,                                  &amp;<a name='2938'>
 		     Z0,      ZNT,                                            &amp; <font color=#447700>! IN/OUT LSM eqv<a name='2939'></font>
		ISNOWXY,     TVXY,     TGXY, CANICEXY,  CANLIQXY,      EAHXY, &amp;<a name='2940'>
		  TAHXY,     CMXY,     CHXY,   FWETXY,  SNEQVOXY,   ALBOLDXY, &amp;<a name='2941'>
		QSNOWXY, WSLAKEXY,    ZWTXY,     WAXY,      WTXY,     TSNOXY, &amp;<a name='2942'>
		ZSNSOXY,  SNICEXY,  SNLIQXY, LFMASSXY,  RTMASSXY,   STMASSXY, &amp;<a name='2943'>
		 WOODXY, STBLCPXY, FASTCPXY,      LAI,    XSAIXY,    TAUSSXY, &amp;<a name='2944'>
	        SMOISEQ, SMCWTDXY,DEEPRECHXY,  RECHXY,   GRAINXY,      GDDXY,PGSXY, &amp; <font color=#447700>! IN/OUT Noah MP only<a name='2945'></font>
	         T2MVXY,   T2MBXY,   Q2MVXY,   Q2MBXY,                        &amp;<a name='2946'>
                 TRADXY,    NEEXY,    GPPXY,    NPPXY,    FVEGXY,    RUNSFXY, &amp;<a name='2947'>
	        RUNSBXY,   ECANXY,   EDIRXY,  ETRANXY,     FSAXY,     FIRAXY, &amp;<a name='2948'>
                 APARXY,    PSNXY,    SAVXY,    SAGXY,   RSSUNXY,    RSSHAXY, &amp;<a name='2949'>
                 BGAPXY,   WGAPXY,    TGVXY,    TGBXY,     CHVXY,      CHBXY, &amp;<a name='2950'>
		  SHGXY,    SHCXY,    SHBXY,    EVGXY,     EVBXY,      GHVXY, &amp;<a name='2951'>
		  GHBXY,    IRGXY,    IRCXY,    IRBXY,      TRXY,      EVCXY, &amp;<a name='2952'>
	       CHLEAFXY,   CHUCXY,   CHV2XY,   CHB2XY,                        &amp;                          <a name='2953'>
#ifdef WRF_HYDRO<a name='2954'>
                 sfcheadrt,INFXSRT,soldrain,                          &amp;    <font color=#447700>!O<a name='2955'></font>
#endif<a name='2956'>
                ids,ide, jds,jde, kds,kde,                      &amp;<a name='2957'>
                ims,ime, jms,jme, kms,kme,                      &amp;<a name='2958'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,        &amp;<a name='2959'>
<font color=#447700>! variables below are optional<a name='2960'></font>
                MP_RAINC =  RAINCV, MP_RAINNC =    RAINNCV, MP_SHCV = RAINSHV,&amp;<a name='2961'>
		MP_SNOW  = SNOWNCV, MP_GRAUP  = GRAUPELNCV, MP_HAIL = HAILNCV )<a name='2962'>
<a name='2963'>
         IF(SF_URBAN_PHYSICS &gt; 0 ) THEN  <font color=#447700>!urban<a name='2964'></font>
         <a name='2965'>
	   call <A href='../../html_code/phys/module_sf_noahmpdrv.F.html#NOAHMP_URBAN'>noahmp_urban</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NOAHMP_URBAN_1"> (sf_urban_physics,     NUM_SOIL_LAYERS,     IVGTYP,ITIMESTEP,  &amp; <font color=#447700>! IN : Model configuration <a name='2966'></font>
                                 DT,         COSZEN,     XLAT_URB2D,                        &amp; <font color=#447700>! IN : Time/Space-related<a name='2967'></font>
                              T_PHY,        QV_CURR,          U_PHY,      V_PHY,   SWDOWN,  &amp; <font color=#447700>! IN : Forcing<a name='2968'></font>
		                GLW,            P8W,         RAINBL,       DZ8W,      ZNT,  &amp; <font color=#447700>! IN : Forcing<a name='2969'></font>
                                TSK,            HFX,            QFX,         LH,   GRDFLX,  &amp; <font color=#447700>! IN/OUT : LSM <a name='2970'></font>
		             ALBEDO,          EMISS,           QSFC,                        &amp; <font color=#447700>! IN/OUT : LSM <a name='2971'></font>
                            ids,ide,        jds,jde,        kds,kde,                        &amp;<a name='2972'>
                            ims,ime,        jms,jme,        kms,kme,                        &amp;<a name='2973'>
              i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte,                        &amp;<a name='2974'>
                         cmr_sfcdif,     chr_sfcdif,     cmc_sfcdif,                        &amp;<a name='2975'>
	                 chc_sfcdif,    cmgr_sfcdif,    chgr_sfcdif,                        &amp;<a name='2976'>
                           tr_urb2d,       tb_urb2d,       tg_urb2d,                        &amp; <font color=#447700>!H urban<a name='2977'></font>
	                   tc_urb2d,       qc_urb2d,       uc_urb2d,                        &amp; <font color=#447700>!H urban<a name='2978'></font>
                         xxxr_urb2d,     xxxb_urb2d,     xxxg_urb2d, xxxc_urb2d,            &amp; <font color=#447700>!H urban<a name='2979'></font>
                          trl_urb3d,      tbl_urb3d,      tgl_urb3d,                        &amp; <font color=#447700>!H urban<a name='2980'></font>
                           sh_urb2d,       lh_urb2d,        g_urb2d,   rn_urb2d,  ts_urb2d, &amp; <font color=#447700>!H urban<a name='2981'></font>
                         psim_urb2d,     psih_urb2d,      u10_urb2d,  v10_urb2d,            &amp; <font color=#447700>!O urban<a name='2982'></font>
                       GZ1OZ0_urb2d,     AKMS_URB2D,                                        &amp; <font color=#447700>!O urban<a name='2983'></font>
                          th2_urb2d,       q2_urb2d,      ust_urb2d,                        &amp; <font color=#447700>!O urban<a name='2984'></font>
                             declin,          hrang,                                        &amp; <font color=#447700>!I urban<a name='2985'></font>
                    num_roof_layers,num_wall_layers,num_road_layers,                        &amp; <font color=#447700>!I urban<a name='2986'></font>
                                dzr,            dzb,            dzg,                        &amp; <font color=#447700>!I urban<a name='2987'></font>
                         cmcr_urb2d,      tgr_urb2d,     tgrl_urb3d,  smr_urb3d,            &amp; <font color=#447700>!H urban<a name='2988'></font>
                        drelr_urb2d,    drelb_urb2d,    drelg_urb2d,                        &amp; <font color=#447700>!H urban<a name='2989'></font>
                      flxhumr_urb2d,  flxhumb_urb2d,  flxhumg_urb2d,                        &amp; <font color=#447700>!H urban<a name='2990'></font>
                             julian,          julyr,                                        &amp; <font color=#447700>!H urban<a name='2991'></font>
                          frc_urb2d,    utype_urb2d,                                        &amp; <font color=#447700>!I urban<a name='2992'></font>
                                chs,           chs2,           cqs2,                        &amp; <font color=#447700>!H<a name='2993'></font>
                   num_urban_layers,                                                        &amp; <font color=#447700>!I multi-layer urban<a name='2994'></font>
                       num_urban_hi,                                                        &amp; <font color=#447700>!I multi-layer urban<a name='2995'></font>
                          trb_urb4d,      tw1_urb4d,      tw2_urb4d,  tgb_urb4d,            &amp; <font color=#447700>!H multi-layer urban<a name='2996'></font>
                         tlev_urb3d,     qlev_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='2997'></font>
                       tw1lev_urb3d,   tw2lev_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='2998'></font>
                        tglev_urb3d,    tflev_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='2999'></font>
                        sf_ac_urb3d,    lf_ac_urb3d,    cm_ac_urb3d,                        &amp; <font color=#447700>!H multi-layer urban<a name='3000'></font>
                       sfvent_urb3d,   lfvent_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='3001'></font>
                       sfwin1_urb3d,   sfwin2_urb3d,                                        &amp; <font color=#447700>!H multi-layer urban<a name='3002'></font>
                         sfw1_urb3d,     sfw2_urb3d,      sfr_urb3d,  sfg_urb3d,            &amp; <font color=#447700>!H multi-layer urban<a name='3003'></font>
                           lp_urb2d,       hi_urb2d,       lb_urb2d,  hgt_urb2d,            &amp; <font color=#447700>!H multi-layer urban<a name='3004'></font>
                           mh_urb2d,     stdh_urb2d,       lf_urb2d,                        &amp; <font color=#447700>!SLUCM<a name='3005'></font>
                             th_phy,            rho,          p_phy,        ust,            &amp; <font color=#447700>!I multi-layer urban<a name='3006'></font>
                                gmt,         julday,          xlong,       xlat,            &amp; <font color=#447700>!I multi-layer urban<a name='3007'></font>
                            a_u_bep,        a_v_bep,        a_t_bep,    a_q_bep,            &amp; <font color=#447700>!O multi-layer urban<a name='3008'></font>
                            a_e_bep,        b_u_bep,        b_v_bep,                        &amp; <font color=#447700>!O multi-layer urban<a name='3009'></font>
                            b_t_bep,        b_q_bep,        b_e_bep,    dlg_bep,            &amp; <font color=#447700>!O multi-layer urban<a name='3010'></font>
                           dl_u_bep,         sf_bep,         vl_bep)                          <font color=#447700>!O multi-layer urban<a name='3011'></font>
	 <a name='3012'>
	 ENDIF <a name='3013'>
<a name='3014'>
  if(iopt_run.eq.5.and.mod(itimestep,STEPWTD).eq.0)then<a name='3015'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_859">( 100, 'calling WTABLE' )<a name='3016'>
<a name='3017'>
<font color=#447700>!gmm update wtable from lateral flow and shed water to rivers<a name='3018'></font>
<a name='3019'>
           CALL <A href='../../html_code/phys/module_sf_noahmp_groundwater.F.html#WTABLE_MMF_NOAHMP'>WTABLE_mmf_noahmp</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WTABLE_MMF_NOAHMP_1">(num_soil_layers,xland,xice, xice_threshold, isice,        &amp;<a name='3020'>
                                  isltyp,smoiseq,dzs,wtddt,                                 &amp;<a name='3021'>
                                  fdepthxy,areaxy,ht,isurban,ivgtyp,                         &amp;<a name='3022'>
                                  rivercondxy,riverbedxy,eqzwt,pexpxy,                      &amp;<a name='3023'>
                                  smois,sh2o,smcwtdxy,zwtxy,qrfxy,deeprechxy,qspringxy,     &amp;<a name='3024'>
                                  qslatxy,qrfsxy,qspringsxy,rechxy,                        &amp;<a name='3025'>
                                  ids,ide, jds,jde, kds,kde,                             &amp;<a name='3026'>
                                  ims,ime, jms,jme, kms,kme,                             &amp;<a name='3027'>
                                  i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte )<a name='3028'>
<a name='3029'>
  endif<a name='3030'>
<a name='3031'>
         call <A href='../../html_code/phys/module_sf_noah_seaice_drv.F.html#SEAICE_NOAH'>seaice_noah</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SEAICE_NOAH_2">( SEAICE_ALBEDO_OPT, SEAICE_ALBEDO_DEFAULT, SEAICE_THICKNESS_OPT, &amp;<a name='3032'>
              &amp;            SEAICE_THICKNESS_DEFAULT, SEAICE_SNOWDEPTH_OPT,             &amp;<a name='3033'>
              &amp;            SEAICE_SNOWDEPTH_MAX, SEAICE_SNOWDEPTH_MIN,                 &amp;<a name='3034'>
              &amp;            t_phy, qv_curr, p8w, dz8w, num_soil_layers, dt, frpcpn, sr, &amp;<a name='3035'>
              &amp;            glw, swdown, rainbl, snoalb, qgh, xice, xice_threshold,     &amp;<a name='3036'>
              &amp;            albsi, icedepth, snowsi,                                    &amp;<a name='3037'>
              &amp;            tslb, emiss, albedo, z0, tsk, snow, snowc, snowh,           &amp;<a name='3038'>
              &amp;            chs, chs2, cqs2,                                            &amp;<a name='3039'>
              &amp;            br, znt, lh, hfx, qfx, potevp, grdflx, qsfc, acsnow,        &amp;<a name='3040'>
              &amp;            acsnom, snopcx, sfcrunoff, noahres,                         &amp;<a name='3041'>
              &amp;            sf_urban_physics, b_t_bep, b_q_bep, rho,                    &amp;<a name='3042'>
              &amp;            ids,ide, jds,jde, kds,kde,                                  &amp;<a name='3043'>
              &amp;            ims,ime, jms,jme, kms,kme,                                  &amp;<a name='3044'>
              &amp;            i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte )<a name='3045'>
<a name='3046'>
         IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3047'>
            <font color=#447700>! LSM Returns full land/ice values, no fractional values.<a name='3048'></font>
            <font color=#447700>! We return to a fractional component here.  SFLX currently hard-wires<a name='3049'></font>
            <font color=#447700>! emissivity over sea ice to 0.98, the same value as over open water, so<a name='3050'></font>
            <font color=#447700>! the fractional consideration doesn't have any effect for emissivity.<a name='3051'></font>
            DO j=j_start(ij),j_end(ij)<a name='3052'>
               DO i=i_start(ij),i_end(ij)<a name='3053'>
                  IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3054'>
                     albedo(i,j) = ( albedo(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.08  )<a name='3055'>
                     emiss(i,j) = ( emiss(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.98  )<a name='3056'>
                  ENDIF<a name='3057'>
               ENDDO<a name='3058'>
            ENDDO<a name='3059'>
<a name='3060'>
            IF ( isisfc ) THEN<a name='3061'>
               DO j=j_start(ij),j_end(ij)<a name='3062'>
                  DO i=i_start(ij),i_end(ij)<a name='3063'>
                     IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3064'>
                        <font color=#447700>!  Weighted average of fields between ice-cover values and open-water values.<a name='3065'></font>
                        flhc(i,j) = ( flhc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * flhc_sea(i,j) )<a name='3066'>
                        flqc(i,j) = ( flqc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * flqc_sea(i,j) )<a name='3067'>
                        cpm(i,j)  = ( cpm(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * cpm_sea(i,j)  )<a name='3068'>
                        cqs2(i,j) = ( cqs2(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * cqs2_sea(i,j) )<a name='3069'>
                        chs2(i,j) = ( chs2(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * chs2_sea(i,j) )<a name='3070'>
                        chs(i,j)  = ( chs(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * chs_sea(i,j)  )<a name='3071'>
                        qsfc(i,j) = ( qsfc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qsfc_sea(i,j) )<a name='3072'>
                        qgh(i,j)  = ( qgh(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qgh_sea(i,j)  )<a name='3073'>
                        qz0(i,j)  = ( qz0(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qz0_sea(i,j)  )<a name='3074'>
                        hfx(i,j)  = ( hfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * hfx_sea(i,j)  )<a name='3075'>
                        qfx(i,j)  = ( qfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qfx_sea(i,j)  )<a name='3076'>
                        lh(i,j)   = ( lh(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * lh_sea(i,j)   )<a name='3077'>
<font color=#447700>!save old tsk_ice<a name='3078'></font>
                        tsk_save(i,j)  = tsk(i,j)<a name='3079'>
                        tsk(i,j)  = ( tsk(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * tsk_sea(i,j)  )<a name='3080'>
                     ENDIF<a name='3081'>
                  ENDDO<a name='3082'>
               ENDDO<a name='3083'>
            ELSE<a name='3084'>
               DO j = j_start(ij) , j_end(ij)<a name='3085'>
                  DO i = i_start(ij) , i_end(ij)<a name='3086'>
                     IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3087'>
                        <font color=#447700>! Compute TSK as the open-water and ice-cover average<a name='3088'></font>
                        tsk(i,j) = ( tsk(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * tsk_sea(i,j) )<a name='3089'>
                     ENDIF<a name='3090'>
                  ENDDO<a name='3091'>
               ENDDO<a name='3092'>
            ENDIF<a name='3093'>
         ENDIF<a name='3094'>
           DO j=j_start(ij),j_end(ij)<a name='3095'>
           DO i=i_start(ij),i_end(ij)<a name='3096'>
              CHKLOWQ(I,J)= 1.0<a name='3097'>
               SFCEVP(I,J)= SFCEVP(I,J) + QFX(I,J)*DTBL<a name='3098'>
               SFCEXC(I,J)= CHS(I,J)<a name='3099'>
               IF(PRESENT(ACHFX))ACHFX(I,J)=ACHFX(I,J) + HFX(I,J)*DT<a name='3100'>
               IF(PRESENT(ACLHF))ACLHF(I,J)=ACLHF(I,J) + LH(I,J)*DT<a name='3101'>
               IF(PRESENT(ACGRDFLX))ACGRDFLX(I,J)=ACGRDFLX(I,J) + GRDFLX(I,J)*DT<a name='3102'>
<a name='3103'>
               <font color=#447700>! Check that SFCDIAGS can declare these as intent(out)<a name='3104'></font>
               T2(I,J)  = -1.E36<a name='3105'>
               TH2(I,J) = -1.E36<a name='3106'>
               Q2(I,J)  = -1.E36<a name='3107'>
           ENDDO<a name='3108'>
           ENDDO<a name='3109'>
           <a name='3110'>
<font color=#447700>!jref: sfc diagnostics<a name='3111'></font>
           DO j=j_start(ij),j_end(ij)<a name='3112'>
           DO i=i_start(ij),i_end(ij)<a name='3113'>
<font color=#447700>!             IF (IVGTYP(I,J) == ISWATER .OR. XICE(I,J) .GE. XICE_THRESHOLD) THEN<a name='3114'></font>
              IF (IVGTYP(I,J) == ISWATER .OR. (IVGTYP(I,J) == ISICE .AND. XICE(I,J) .GE. XICE_THRESHOLD)) THEN<a name='3115'>
                 IF(CQS2(I,J).lt.1.E-5) then<a name='3116'>
                   Q2(I,J)=QSFC(I,J)<a name='3117'>
                 ELSE<a name='3118'>
                   Q2(I,J) = QSFC(I,J) - QFX(I,J)/(PSFC(I,J)/(R_d * TSK(I,J))*CQS2(I,J))<a name='3119'>
                 ENDIF<a name='3120'>
                 IF(CHS2(I,J).lt.1.E-5) then<a name='3121'>
                   T2(I,J) = TSK(I,J) <a name='3122'>
                 ELSE<a name='3123'>
                   T2(I,J) = TSK(I,J) - HFX(I,J)/(PSFC(I,J)/(R_d * TSK(I,J))*CP*CHS2(I,J))<a name='3124'>
                 ENDIF<a name='3125'>
                   TH2(I,J) = T2(I,J)*(1.E5/PSFC(I,J))**RCP<a name='3126'>
<font color=#447700>!             ELSEIF (IVGTYP(I,J) == ISURBAN .OR. IVGTYP(I,J) == ISICE .OR. FVEGXY(I,J) == 0.0 ) THEN<a name='3127'></font>
              ELSEIF (IVGTYP(I,J) == ISURBAN                   .or. &amp;<a name='3128'>
	              IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL   .or. &amp; <font color=#447700>!urban<a name='3129'></font>
                      IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL  .or. &amp; <font color=#447700>!urban<a name='3130'></font>
	              IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL .or. &amp; <font color=#447700>!urban<a name='3131'></font>
	              (IVGTYP(I,J) == ISICE .AND. XICE(I,J) .LT. XICE_THRESHOLD)) THEN<a name='3132'>
                   Q2(I,J)  = Q2MBXY(I,J)<a name='3133'>
                   T2(I,J)  = T2MBXY(I,J)<a name='3134'>
                   TH2(I,J) = T2(i,j)*(1.E5/PSFC(i,j))**RCP<a name='3135'>
              ELSE<a name='3136'>
                 T2(I,J)  = FVEGXY(I,J)*T2MVXY(I,J) + (1.-FVEGXY(I,J))*T2MBXY(I,J)<a name='3137'>
                 Q2(I,J)  = FVEGXY(I,J)*Q2MVXY(I,J) + (1.-FVEGXY(I,J))*Q2MBXY(I,J)<a name='3138'>
                 TH2(I,J) = T2(i,j)*(1.E5/PSFC(i,j))**RCP<a name='3139'>
              ENDIF<a name='3140'>
           ENDDO<a name='3141'>
           ENDDO<a name='3142'>
           <a name='3143'>
<font color=#447700>!          CALL SFCDIAGS(HFX,QFX,TSK,QSFC,CHS2,CQS2,T2,TH2,Q2,      &amp;<a name='3144'></font>
<font color=#447700>!                     PSFC,CP,R_d,RCP,CHS,t_phy,qv_curr,ua_phys,    &amp;<a name='3145'></font>
<font color=#447700>!                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='3146'></font>
<font color=#447700>!                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='3147'></font>
<font color=#447700>!             i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='3148'></font>
<a name='3149'>
<font color=#447700>!jref: sfc diagnostics end<a name='3150'></font>
<a name='3151'>
         IF(SF_URBAN_PHYSICS.eq.1) THEN<a name='3152'>
           DO j=j_start(ij),j_end(ij)                             <font color=#447700>!urban<a name='3153'></font>
             DO i=i_start(ij),i_end(ij)                           <font color=#447700>!urban<a name='3154'></font>
              IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;  <font color=#447700>!urban<a name='3155'></font>
                  IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL ) THEN <font color=#447700>!urban<a name='3156'></font>
                 Q2(I,J)  = (FVEGXY(I,J)*Q2MVXY(I,J) + (1.-FVEGXY(I,J))*Q2MBXY(I,J))*(1.-FRC_URB2D(I,J)) +   &amp;<a name='3157'>
                             Q2_URB2D(I,J)*FRC_URB2D(I,J)<a name='3158'>
                 T2(I,J)  = (FVEGXY(I,J)*T2MVXY(I,J) + (1.-FVEGXY(I,J))*T2MBXY(I,J))*(1.-FRC_URB2D(I,J)) +   &amp;<a name='3159'>
                             (TH2_URB2D(i,j)/((1.E5/PSFC(i,j))**RCP))*FRC_URB2D(I,J)<a name='3160'>
                 TH2(I,J) = T2(i,j)*(1.E5/PSFC(i,j))**RCP<a name='3161'>
                 U10(I,J)  = U10_URB2D(I,J)                       <font color=#447700>!urban<a name='3162'></font>
                 V10(I,J)  = V10_URB2D(I,J)                       <font color=#447700>!urban<a name='3163'></font>
                 PSIM(I,J) = PSIM_URB2D(I,J)                      <font color=#447700>!urban<a name='3164'></font>
                 PSIH(I,J) = PSIH_URB2D(I,J)                      <font color=#447700>!urban<a name='3165'></font>
                 GZ1OZ0(I,J) = GZ1OZ0_URB2D(I,J)                  <font color=#447700>!urban<a name='3166'></font>
                 AKHS(I,J) = CHS(I,J)                             <font color=#447700>!urban<a name='3167'></font>
                 AKMS(I,J) = AKMS_URB2D(I,J)                      <font color=#447700>!urban<a name='3168'></font>
               END IF                                             <font color=#447700>!urban<a name='3169'></font>
             ENDDO                                                <font color=#447700>!urban<a name='3170'></font>
           ENDDO                                                  <font color=#447700>!urban<a name='3171'></font>
         ENDIF<a name='3172'>
<a name='3173'>
         IF((SF_URBAN_PHYSICS.eq.2).OR.(SF_URBAN_PHYSICS.eq.3)) THEN<a name='3174'>
           DO j=j_start(ij),j_end(ij)                             <font color=#447700>!urban<a name='3175'></font>
             DO i=i_start(ij),i_end(ij)                           <font color=#447700>!urban<a name='3176'></font>
              IF( IVGTYP(I,J) == ISURBAN .or. IVGTYP(I,J) == LOW_DENSITY_RESIDENTIAL .or. &amp;  <font color=#447700>!urban<a name='3177'></font>
                  IVGTYP(I,J) == HIGH_DENSITY_RESIDENTIAL .or. IVGTYP(I,J) == HIGH_INTENSITY_INDUSTRIAL ) THEN <font color=#447700>!urban<a name='3178'></font>
                T2(I,J)   = TH_PHY(i,1,j)/((1.E5/PSFC(I,J))**RCP) <font color=#447700>!urban<a name='3179'></font>
                TH2(I,J) = TH_PHY(i,1,j) <font color=#447700>!urban<a name='3180'></font>
                Q2(I,J)   = qv_curr(i,1,j)  <font color=#447700>!urban<a name='3181'></font>
                U10(I,J)  = U_phy(I,1,J)                       <font color=#447700>!urban<a name='3182'></font>
                V10(I,J)  = V_phy(I,1,J)                       <font color=#447700>!urban<a name='3183'></font>
               END IF                                             <font color=#447700>!urban<a name='3184'></font>
             ENDDO                                                <font color=#447700>!urban<a name='3185'></font>
           ENDDO                                                  <font color=#447700>!urban<a name='3186'></font>
         ENDIF<a name='3187'>
<a name='3188'>
<font color=#447700>!------------------------------------------------------------------<a name='3189'></font>
<a name='3190'>
       ELSE<a name='3191'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1298">('Lacking arguments for NOAHMPLSM in surface driver')<a name='3192'>
       ENDIF<a name='3193'>
<a name='3194'>
     CASE (RUCLSMSCHEME)<a name='3195'>
       IF (PRESENT(qv_curr)    .AND.  PRESENT(qc_curr) .AND.    &amp;<a name='3196'>
<font color=#447700>!           PRESENT(emiss)      .AND.  PRESENT(t2)      .AND.    &amp;<a name='3197'></font>
           PRESENT(qsg)        .AND.  PRESENT(qvg)     .AND.    &amp;<a name='3198'>
           PRESENT(qcg)        .AND.  PRESENT(soilt1)  .AND.    &amp;<a name='3199'>
           PRESENT(tsnav)      .AND.  PRESENT(smfr3d)  .AND.    &amp;<a name='3200'>
           PRESENT(keepfr3dflag) .AND. PRESENT(rainbl) .AND.    &amp;<a name='3201'>
           PRESENT(dew)                                 .AND.   &amp;<a name='3202'>
                                                      .TRUE. ) THEN<a name='3203'>
<a name='3204'>
           IF( PRESENT(sr) ) THEN<a name='3205'>
               frpcpn=.true.<a name='3206'>
           ELSE<a name='3207'>
               SR = 1.<a name='3208'>
           ENDIF<a name='3209'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_860">(100,'in RUC LSM')<a name='3210'>
           DO j = j_start(ij) , j_end(ij)<a name='3211'>
              DO i = i_start(ij) , i_end(ij)<a name='3212'>
                 IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1. ) ) THEN<a name='3213'>
                    ALBBCK(I,J) = SEAICE_ALBEDO_DEFAULT<a name='3214'>
                 ENDIF<a name='3215'>
              ENDDO<a name='3216'>
           ENDDO<a name='3217'>
           IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3218'>
              <font color=#447700>! The fields passed to LSMRUC need to represent the full ice values, not<a name='3219'></font>
              <font color=#447700>! the fractional values.  Convert ALBEDO and EMISS from the blended value <a name='3220'></font>
              <font color=#447700>! to a value representing only the sea-ice portion.   Albedo over open <a name='3221'></font>
              <font color=#447700>! water is taken to be 0.08. Emissivity over open water is taken to be 0.98<a name='3222'></font>
              DO j = j_start(ij) , j_end(ij)<a name='3223'>
                 DO i = i_start(ij) , i_end(ij)<a name='3224'>
                    IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1 ) ) THEN<a name='3225'>
                       ALBEDO(I,J) = (ALBEDO(I,J) - (1.-XICE(I,J))*0.08) / XICE(I,J)<a name='3226'>
                       EMISS(I,J)  = (EMISS(I,J)  - (1.-XICE(I,J))*0.98) / XICE(I,J)<a name='3227'>
<font color=#447700>! also set skin temperature to saved sea-ice portion only<a name='3228'></font>
                       TSK(I,J) = TSK_SAVE(I,J)<a name='3229'>
                    ENDIF<a name='3230'>
                 ENDDO<a name='3231'>
              ENDDO<a name='3232'>
<a name='3233'>
              IF ( isisfc ) THEN<a name='3234'>
                 <font color=#447700>!<a name='3235'></font>
                 <font color=#447700>! use surface layer routine values from the ice portion of grid point<a name='3236'></font>
                 <font color=#447700>!<a name='3237'></font>
              ELSE<a name='3238'>
                 <font color=#447700>!<a name='3239'></font>
                 <font color=#447700>! don't have srfc layer routine values at this time, so just use what you have<a name='3240'></font>
                 <font color=#447700>! use ice component of TSK<a name='3241'></font>
                 <font color=#447700>!<a name='3242'></font>
                 CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_3">( ims, ime, jms, jme,                   &amp;<a name='3243'>
                                         i_start(ij), i_end(ij),               &amp;<a name='3244'>
                                         j_start(ij), j_end(ij),               &amp;<a name='3245'>
                                         itimestep, .false., tice2tsk_if2cold, &amp;<a name='3246'>
                                         XICE, XICE_THRESHOLD,                 &amp;<a name='3247'>
                                         SST, TSK, TSK_SEA, TSK_LOCAL )<a name='3248'>
                 DO j = j_start(ij) , j_end(ij)<a name='3249'>
                    DO i = i_start(ij) , i_end(ij)<a name='3250'>
                       TSK(i,j) = TSK_LOCAL(i,j)<a name='3251'>
                    ENDDO<a name='3252'>
                 ENDDO<a name='3253'>
              ENDIF<a name='3254'>
           ENDIF<a name='3255'>
<a name='3256'>
           CALL <A href='../../html_code/phys/module_sf_ruclsm.F.html#LSMRUC'>LSMRUC</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LSMRUC_1">( spp_lsm_loc,                            &amp;<a name='3257'>
#if (EM_CORE==1)<a name='3258'>
                pattern_spp_lsm,field_sf,                       &amp;<a name='3259'>
#endif<a name='3260'>
                dtbl,itimestep,num_soil_layers,                 &amp;<a name='3261'>
#if (EM_CORE==1)<a name='3262'>
                lakemodel,lakemask,                             &amp;<a name='3263'>
                graupelncv,snowncv,rainncv,                     &amp;<a name='3264'>
#endif<a name='3265'>
                zs,rainbl,snow,snowh,snowc,sr,frpcpn,           &amp;<a name='3266'>
                rhosnf,precipfr,                                &amp;<a name='3267'>
                dz8w,p_phy,t_phy,qv_curr,qc_curr,rho,           &amp; <font color=#447700>!p_phy in [pa]<a name='3268'></font>
                glw,gsw,emiss,chklowq,                          &amp;<a name='3269'>
                chs,flqc,flhc,mavail,canwat,vegfra,albedo,znt,  &amp;<a name='3270'>
                z0,snoalb, albbck, lai,                         &amp;   <font color=#447700>!new<a name='3271'></font>
                mminlu, landusef, nlcat, mosaic_lu,             &amp;<a name='3272'>
                mosaic_soil, soilctop, nscat,                   &amp;   <font color=#447700>!new<a name='3273'></font>
                qsfc,qsg,qvg,qcg,dew,soilt1,tsnav,              &amp;<a name='3274'>
                tmn,ivgtyp,isltyp,xland,                        &amp;<a name='3275'>
                iswater,isice,xice,xice_threshold,              &amp;<a name='3276'>
                cp ,rcp,g,xlv,stbolt,                           &amp;<a name='3277'>
                smois,sh2o,smstav,smstot,tslb,tsk,hfx,qfx,lh,   &amp;<a name='3278'>
                sfcrunoff,udrunoff,acrunoff,sfcexc,             &amp;<a name='3279'>
                sfcevp,grdflx,snowfallac,acsnow,acsnom,         &amp;<a name='3280'>
                smfr3d,keepfr3dflag,                            &amp;<a name='3281'>
                myj,shdmin,shdmax,rdlai2d,                      &amp;<a name='3282'>
                ids,ide, jds,jde, kds,kde,                      &amp;<a name='3283'>
                ims,ime, jms,jme, kms,kme,                      &amp;<a name='3284'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='3285'>
<a name='3286'>
           IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3287'>
              <font color=#447700>! LSMRUC Returns full land/ice values, no fractional values.<a name='3288'></font>
              <font color=#447700>! We return to a fractional component here.<a name='3289'></font>
              DO j=j_start(ij),j_end(ij)<a name='3290'>
                 DO i=i_start(ij),i_end(ij)<a name='3291'>
                    IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3292'>
                       albedo(i,j) = ( albedo(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.08  )<a name='3293'>
                       emiss(i,j)  = ( emiss(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.98  )<a name='3294'>
                    ENDIF<a name='3295'>
                 ENDDO<a name='3296'>
              ENDDO<a name='3297'>
              if ( isisfc ) then<a name='3298'>
                 <font color=#447700>!<a name='3299'></font>
                 <font color=#447700>!  back to ice and ocean average<a name='3300'></font>
                 <font color=#447700>!<a name='3301'></font>
                 DO j=j_start(ij),j_end(ij)<a name='3302'>
                    DO i=i_start(ij),i_end(ij)<a name='3303'>
                       IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3304'>
                          flhc(i,j) = ( flhc(i,j) * XICE(i,j) ) + ( (1.-XICE(i,j)) * flhc_sea(i,j) )<a name='3305'>
                          flqc(i,j) = ( flqc(i,j) * XICE(i,j) ) + ( (1.-XICE(i,j)) * flqc_sea(i,j) )<a name='3306'>
                          cpm(i,j)  = ( cpm(i,j)  * XICE(i,j) ) + ( (1.-XICE(i,j)) * cpm_sea(i,j)  )<a name='3307'>
                          cqs2(i,j) = ( cqs2(i,j) * XICE(i,j) ) + ( (1.-XICE(i,j)) * cqs2_sea(i,j) )<a name='3308'>
                          chs2(i,j) = ( chs2(i,j) * XICE(i,j) ) + ( (1.-XICE(i,j)) * chs2_sea(i,j) )<a name='3309'>
                          chs(i,j)  = ( chs(i,j)  * XICE(i,j) ) + ( (1.-XICE(i,j)) * chs_sea(i,j)  )<a name='3310'>
                          qsfc(i,j) = ( qsfc(i,j) * XICE(i,j) ) + ( (1.-XICE(i,j)) * QSFC_SEA(i,j) )<a name='3311'>
                          qgh(i,j)  = ( qgh(i,j)  * XICE(i,j) ) + ( (1.-XICE(i,j)) * qgh_sea(i,j)  )<a name='3312'>
                          hfx(i,j)  = ( hfx(i,j)  * XICE(i,j) ) + ( (1.-XICE(i,j)) * HFX_SEA(i,j)  )<a name='3313'>
                          qfx(i,j)  = ( qfx(i,j)  * XICE(i,j) ) + ( (1.-XICE(i,j)) * QFX_SEA(i,j)  )<a name='3314'>
                          lh(i,j)   = ( lh(i,j)   * XICE(i,j) ) + ( (1.-XICE(i,j)) * LH_SEA(i,j)   )<a name='3315'>
<font color=#447700>!save old tsk_ice<a name='3316'></font>
                          tsk_save(i,j)  = tsk(i,j)<a name='3317'>
                          tsk(i,j)  = ( tsk(i,j)  * XICE(i,j) ) + ( (1.-XICE(i,j)) * TSK_SEA(i,j)  )<a name='3318'>
                       ENDIF<a name='3319'>
                    ENDDO<a name='3320'>
                 ENDDO<a name='3321'>
              else<a name='3322'>
                 <font color=#447700>!<a name='3323'></font>
                 <font color=#447700>! tsk back to liquid and ice average<a name='3324'></font>
                 <font color=#447700>!<a name='3325'></font>
                 DO j = j_start(ij) , j_end(ij)<a name='3326'>
                    DO i = i_start(ij) , i_end(ij)<a name='3327'>
                       IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3328'>
                          tsk(i,j) = ( tsk(i,j) * XICE(i,j) ) + ( (1.-XICE(i,j)) * TSK_SEA(i,j) )<a name='3329'>
                       ENDIF<a name='3330'>
                    ENDDO<a name='3331'>
                 ENDDO<a name='3332'>
              endif<a name='3333'>
           ENDIF<a name='3334'>
<a name='3335'>
<font color=#447700>! Compute CHS and CQS that will be used in 2-m diagnostics<a name='3336'></font>
            DO j=j_start(ij),j_end(ij)<a name='3337'>
               DO i=i_start(ij),i_end(ij)<a name='3338'>
                     cqs(i,j)=flqc(i,j)/(mavail(i,j)*rho(i,kts,j))<a name='3339'>
                     chs(i,j)=flhc(i,j)/(cpm(i,j)*rho(i,kts,j) )<a name='3340'>
               ENDDO<a name='3341'>
            ENDDO<a name='3342'>
<a name='3343'>
          CALL <A href='../../html_code/phys/module_sf_sfcdiags_ruclsm.F.html#SFCDIAGS_RUCLSM'>SFCDIAGS_RUCLSM</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIAGS_RUCLSM_1">(HFX,QFX,TSK,QSFC,CQS,CQS2,CHS,CHS2,T2,TH2,Q2,  &amp;<a name='3344'>
                     T_PHY,QV_CURR,RHO,P_PHY,PSFC,SNOW,                       &amp;<a name='3345'>
                     CP,R_d,RCP,                                              &amp;<a name='3346'>
                     ids,ide, jds,jde, kds,kde,                               &amp;<a name='3347'>
                     ims,ime, jms,jme, kms,kme,                               &amp;<a name='3348'>
                     i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte   )<a name='3349'>
<a name='3350'>
       ELSE<a name='3351'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1299">('Lacking arguments for RUCLSM in surface driver')<a name='3352'>
       ENDIF<a name='3353'>
<a name='3354'>
     CASE (PXLSMSCHEME)<a name='3355'>
       IF (PRESENT(qv_curr)    .AND.  PRESENT(qc_curr) .AND.    &amp;<a name='3356'>
           PRESENT(emiss)      .AND.  PRESENT(t2)      .AND.    &amp;<a name='3357'>
           PRESENT(rainbl) .AND.    &amp;<a name='3358'>
                                                      .TRUE. ) THEN<a name='3359'>
          IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3360'>
<a name='3361'>
             IF ( isisfc ) THEN<a name='3362'>
                <font color=#447700>!<a name='3363'></font>
                <font color=#447700>! use surface layer routine values from the ice portion of grid point<a name='3364'></font>
                <font color=#447700>!<a name='3365'></font>
             ELSE<a name='3366'>
                <font color=#447700>!<a name='3367'></font>
                <font color=#447700>! don't have srfc layer routine values at this time, so just use what you have<a name='3368'></font>
                <font color=#447700>! use ice component of TSK<a name='3369'></font>
                <font color=#447700>!<a name='3370'></font>
                CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_4">( ims, ime, jms, jme,                   &amp;<a name='3371'>
                                        i_start(ij), i_end(ij),               &amp;<a name='3372'>
                                        j_start(ij), j_end(ij),               &amp;<a name='3373'>
                                        itimestep, .false., tice2tsk_if2cold, &amp;<a name='3374'>
                                        XICE, XICE_THRESHOLD,                 &amp;<a name='3375'>
                                        SST, TSK, TSK_SEA, TSK_LOCAL )<a name='3376'>
                DO j = j_start(ij) , j_end(ij)<a name='3377'>
                   DO i=i_start(ij) , i_end(ij)<a name='3378'>
                      TSK(i,j) = TSK_LOCAL(i,j)<a name='3379'>
                   ENDDO<a name='3380'>
                ENDDO<a name='3381'>
             ENDIF<a name='3382'>
          ENDIF<a name='3383'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_861">(100,'in P-X LSM')<a name='3384'>
          CALL <A href='../../html_code/phys/module_sf_pxlsm.F.html#PXLSM'>PXLSM</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXLSM_1">(u_phy, v_phy, dz8w, qv_curr, t_phy, th_phy, rho,&amp;<a name='3385'>
                     psfc, gsw, glw, rainbl, emiss,                  &amp;<a name='3386'>
                     ITIMESTEP, curr_secs, num_soil_layers, DT,      &amp;<a name='3387'>
                     anal_interval, xland, xice, albbck, albedo,     &amp;<a name='3388'>
                     snoalb, smois, tslb, mavail,T2, Q2, qsfc,       &amp;<a name='3389'>
                     zs, dzs, psih,                                  &amp;<a name='3390'>
                     landusef,soilctop,soilcbot,vegfra, vegf_px,     &amp;<a name='3391'>
                     isltyp,ra,rs,lai,imperv,canfra,nlcat,nscat,     &amp;<a name='3392'>
                     hfx,qfx,lh,tsk,sst,znt,canwat,                  &amp;<a name='3393'>
                     grdflx,shdmin,shdmax,                           &amp;<a name='3394'>
                     snowc,pblh,rmol,ust,capg,dtbl,                  &amp;<a name='3395'>
                     t2_ndg_old,t2_ndg_new,q2_ndg_old,q2_ndg_new,    &amp;<a name='3396'>
                     sn_ndg_old, sn_ndg_new, snow, snowh,snowncv,    &amp;<a name='3397'>
                     t2obs, q2obs,pxlsm_smois_init,pxlsm_soil_nudge, &amp;<a name='3398'>
                     ids,ide, jds,jde, kds,kde,                      &amp;<a name='3399'>
                     ims,ime, jms,jme, kms,kme,                      &amp;<a name='3400'>
                     i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte)<a name='3401'>
          IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3402'>
             IF ( isisfc ) THEN<a name='3403'>
                <font color=#447700>!<a name='3404'></font>
                <font color=#447700>!  back to ice and ocean average<a name='3405'></font>
                <font color=#447700>!<a name='3406'></font>
                DO j = j_start(ij) , j_end(ij)<a name='3407'>
                   DO i = i_start(ij) , i_end(ij)<a name='3408'>
                      IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3409'>
                         flhc(i,j) = ( flhc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * flhc_sea(i,j) )<a name='3410'>
                         flqc(i,j) = ( flqc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * flqc_sea(i,j) )<a name='3411'>
                         cpm(i,j)  = ( cpm(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * cpm_sea(i,j)  )<a name='3412'>
                         cqs2(i,j) = ( cqs2(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * cqs2_sea(i,j) )<a name='3413'>
                         chs2(i,j) = ( chs2(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * chs2_sea(i,j) )<a name='3414'>
                         chs(i,j)  = ( chs(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * chs_sea(i,j)  )<a name='3415'>
                         qsfc(i,j) = ( qsfc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * QSFC_SEA(i,j) )<a name='3416'>
                         qgh(i,j)  = ( qgh(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * QGH_SEA(i,j)  )<a name='3417'>
                         hfx(i,j)  = ( hfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * HFX_SEA(i,j)  )<a name='3418'>
                         qfx(i,j)  = ( qfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * QFX_SEA(i,j)  )<a name='3419'>
                         lh(i,j)   = ( lh(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * LH_SEA(i,j)   )<a name='3420'>
<font color=#447700>!save old tsk_ice<a name='3421'></font>
                         tsk_save(i,j)  = tsk(i,j)<a name='3422'>
                         tsk(i,j)  = ( tsk(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * TSK_SEA(i,j)  )<a name='3423'>
                         pblh(i,j) = ( pblh(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * PBLH_SEA(i,j) )<a name='3424'>
                      ENDIF<a name='3425'>
                   ENDDO<a name='3426'>
                ENDDO<a name='3427'>
             ELSE<a name='3428'>
                <font color=#447700>!<a name='3429'></font>
                <font color=#447700>! tsk back to liquid and ice average<a name='3430'></font>
                <font color=#447700>!<a name='3431'></font>
                DO j=j_start(ij),j_end(ij)<a name='3432'>
                   DO i=i_start(ij),i_end(ij)<a name='3433'>
                      IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3434'>
<font color=#447700>!save old tsk_ice<a name='3435'></font>
                         tsk_save(i,j)  = tsk(i,j)<a name='3436'>
                         tsk(i,j)=tsk(i,j)*XICE(i,j)+(1.0-XICE(i,j))*TSK_SEA(i,j)<a name='3437'>
                      ENDIF<a name='3438'>
                   ENDDO<a name='3439'>
                ENDDO<a name='3440'>
             ENDIF<a name='3441'>
          ENDIF<a name='3442'>
           DO j=j_start(ij),j_end(ij)<a name='3443'>
           DO i=i_start(ij),i_end(ij)<a name='3444'>
              CHKLOWQ(I,J)= 1.0<a name='3445'>
              TH2(I,J) = T2(I,J)*(1.E5/PSFC(I,J))**RCP<a name='3446'>
              SFCEVP(I,J)= SFCEVP(I,J) + QFX(I,J)*DTBL<a name='3447'>
           ENDDO<a name='3448'>
           ENDDO<a name='3449'>
<a name='3450'>
       ELSE<a name='3451'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1300">('Lacking arguments for P-X LSM in surface driver')<a name='3452'>
       ENDIF<a name='3453'>
#ifdef WRF_USE_CLM<a name='3454'>
<font color=#447700>!---------------------------------------------------------------------<a name='3455'></font>
<font color=#447700>! CLM coupling currently version 4 added by Yaqiong Lu and Jiming Jin<a name='3456'></font>
<a name='3457'>
     CASE (CLMSCHEME)<a name='3458'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_862">(100,'in CLM')<a name='3459'>
<a name='3460'>
     IF (MYJ) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1301">('CLM is not currently compatible with MYJ.  Please pick different PBL Schemes')<a name='3461'>
<a name='3462'>
     IF (present(qv_curr) .and.  present(rainbl) .and.    &amp;<a name='3463'>
                                                      .true. ) then<a name='3464'>
<a name='3465'>
       <font color=#447700>! print *, "itimestep = ", itimestep<a name='3466'></font>
      <font color=#447700>!  print *," in module_surface_driver.F :  dz8w(i,1,j) = ",dz8w(:,1,:)<a name='3467'></font>
         IF( PRESENT(sr) ) THEN<a name='3468'>
           frpcpn=.true.<a name='3469'>
         ENDIF<a name='3470'>
         IF ( FRACTIONAL_SEAICE == 1) THEN<a name='3471'>
            <font color=#447700>! The fields passed to LSM need to represent the full ice values, not<a name='3472'></font>
            <font color=#447700>! the fractional values.  Convert ALBEDO and EMISS from the blended value <a name='3473'></font>
            <font color=#447700>! to a value representing only the sea-ice portion.   Albedo over open <a name='3474'></font>
            <font color=#447700>! water is taken to be 0.08. Emissivity over open water is taken to be 0.98<a name='3475'></font>
            DO j = j_start(ij) , j_end(ij)<a name='3476'>
               DO i = i_start(ij) , i_end(ij)<a name='3477'>
                  IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE.  1 ) ) THEN<a name='3478'>
                     ALBEDO(I,J) = (ALBEDO(I,J)-(1.-XICE(I,J))*0.08)/XICE(I,J)<a name='3479'>
                     EMISS(I,J) = (EMISS(I,J)-(1.-XICE(I,J))*0.98)/XICE(I,J)<a name='3480'>
                  ENDIF<a name='3481'>
               ENDDO<a name='3482'>
            ENDDO<a name='3483'>
            IF ( isisfc ) THEN<a name='3484'>
              <font color=#447700>! Use surface layer routine values from the ice portion of grid<a name='3485'></font>
              <font color=#447700>! point<a name='3486'></font>
            ELSE<a name='3487'>
               <font color=#447700>!    <a name='3488'></font>
               <font color=#447700>! We don't have surface layer routine values at this time, so<a name='3489'></font>
               <font color=#447700>! just use what we have.  Use ice component of TSK<a name='3490'></font>
               <font color=#447700>!    <a name='3491'></font>
               DO j = j_start(ij) , j_end(ij)<a name='3492'>
                  DO i = i_start(ij) , i_end(ij)<a name='3493'>
                     IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1 ) ) THEN<a name='3494'>
                        IF ( SST(i,j) .LT. 271.4 ) THEN<a name='3495'>
                           SST(i,j) = 271.4<a name='3496'>
                        ENDIF<a name='3497'>
                        TSK_SEA(i,j) = SST(i,j)<a name='3498'>
                        <font color=#447700>! Convert TSK from our ice/water average value to value<a name='3499'></font>
                        <font color=#447700>! good for solid-ice surface.<a name='3500'></font>
                        TSK(i,j) = ( TSK(i,j) - (1.-XICE(i,j)) *SST(i,j) ) / XICE(i,j)<a name='3501'>
                        IF (XICE(i,j).lt.0.2 .and. TSK(i,j).lt.253.15) THEN<a name='3502'>
                           TSK(i,j) = 253.15<a name='3503'>
                        ENDIF<a name='3504'>
                        IF (XICE(i,j).lt.0.1 .and. TSK(i,j).lt.263.15) THEN<a name='3505'>
                           TSK(i,j) = 263.15<a name='3506'>
                        ENDIF<a name='3507'>
                     ELSE<a name='3508'>
                        TSK_SEA(i,j) = TSK(i,j)<a name='3509'>
                     ENDIF<a name='3510'>
                  ENDDO<a name='3511'>
               ENDDO<a name='3512'>
            ENDIF<a name='3513'>
         ENDIF<a name='3514'>
<a name='3515'>
<a name='3516'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_863">(100,'in clmdrv')<a name='3517'>
<a name='3518'>
       CALL <A href='../../html_code/phys/module_sf_clm.F.html#CLMDRV'>clmdrv</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLMDRV_1">(dz8w,qv_curr,p8w, t_phy,tsk,                   &amp;<a name='3519'>
                hfx,qfx,lh,grdflx,qgh,gsw,swdown,               &amp;<a name='3520'>
                ra_sw_physics,history_interval,glw,smstav,smstot, &amp;<a name='3521'>
                sfcrunoff,udrunoff,ivgtyp,isltyp,vegfra,        &amp;<a name='3522'>
                albedo,znt,z0, tmn,xland,xice, emiss,           &amp;<a name='3523'>
                snowc,qsfc,rainbl,maxpatch,                     &amp;<a name='3524'>
                num_soil_layers,dtbl,xtime, dt,dzs,             &amp;<a name='3525'>
                smois,tslb,snow,canwat,                         &amp;<a name='3526'>
                chs,chs2,sh2o,snowh,                            &amp;<a name='3527'>
                u_phy,v_phy,                                    &amp;<a name='3528'>
                shdmin,shdmax,                                  &amp;<a name='3529'>
                acsnom,acsnow,                                  &amp;<a name='3530'>
                dx,xlat,xlong,ht,                               &amp;<a name='3531'>
                ids,ide, jds,jde, kds,kde,                      &amp;<a name='3532'>
                ims,ime, jms,jme, kms,kme,                      &amp;<a name='3533'>
                i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte, &amp;<a name='3534'>
                inest,sf_urban_physics, nlcat                   &amp;<a name='3535'>
<font color=#447700>!Optional urban<a name='3536'></font>
               ,cmr_sfcdif,chr_sfcdif,cmc_sfcdif,chc_sfcdif    &amp;<a name='3537'>
               ,cmgr_sfcdif,chgr_sfcdif                        &amp;<a name='3538'>
               ,tr_urb2d,tb_urb2d,tg_urb2d,tc_urb2d,qc_urb2d,  &amp; <font color=#447700>!H urban<a name='3539'></font>
                uc_urb2d,                                       &amp; <font color=#447700>!H urban<a name='3540'></font>
                xxxr_urb2d,xxxb_urb2d,xxxg_urb2d,xxxc_urb2d,    &amp; <font color=#447700>!H urban<a name='3541'></font>
                trl_urb3d,tbl_urb3d,tgl_urb3d,                  &amp; <font color=#447700>!H urban<a name='3542'></font>
                sh_urb2d,lh_urb2d,g_urb2d,rn_urb2d,ts_urb2d,    &amp; <font color=#447700>!H urban<a name='3543'></font>
                psim_urb2d,psih_urb2d,u10_urb2d,v10_urb2d,      &amp; <font color=#447700>!O urban<a name='3544'></font>
                GZ1OZ0_urb2d, AKMS_URB2D,                       &amp; <font color=#447700>!O urban<a name='3545'></font>
                th2_urb2d,q2_urb2d,ust_urb2d,                   &amp; <font color=#447700>!O urban<a name='3546'></font>
                declin,coszen,hrang,                            &amp; <font color=#447700>!I urban   !  by hongping Gu<a name='3547'></font>
                xlat_urb2d,                                     &amp; <font color=#447700>!I urban<a name='3548'></font>
                num_roof_layers, num_wall_layers,               &amp; <font color=#447700>!I urban<a name='3549'></font>
                num_road_layers, DZR, DZB, DZG,                 &amp; <font color=#447700>!I urban<a name='3550'></font>
                FRC_URB2D, UTYPE_URB2D,                         &amp; <font color=#447700>!I urban<a name='3551'></font>
                cmcr_urb2d,tgr_urb2d,tgrl_urb3d,smr_urb3d,      &amp; <font color=#447700>! urban<a name='3552'></font>
                drelr_urb2d,drelb_urb2d,drelg_urb2d,            &amp; <font color=#447700>! urban<a name='3553'></font>
                flxhumr_urb2d,flxhumb_urb2d,flxhumg_urb2d,      &amp;<a name='3554'>
<font color=#447700>! CLM subgrids<a name='3555'></font>
                numc,nump,sabv,sabg,lwup,snl, &amp;<a name='3556'>
                snowdp,wtc,wtp,h2osno,t_grnd,t_veg,         &amp;<a name='3557'>
                h2ocan,h2ocan_col,t2m_max,t2m_min,t2clm ,    &amp;<a name='3558'>
                t_ref2m,h2osoi_liq_s1,                 &amp;<a name='3559'>
                h2osoi_liq_s2,h2osoi_liq_s3,h2osoi_liq_s4,          &amp;<a name='3560'>
                h2osoi_liq_s5,h2osoi_liq1,h2osoi_liq2,              &amp;<a name='3561'>
                h2osoi_liq3,h2osoi_liq4,h2osoi_liq5,h2osoi_liq6,    &amp;<a name='3562'>
                h2osoi_liq7,h2osoi_liq8,h2osoi_liq9,h2osoi_liq10,   &amp;<a name='3563'>
                h2osoi_ice_s1,h2osoi_ice_s2,                        &amp;<a name='3564'>
                h2osoi_ice_s3,h2osoi_ice_s4,h2osoi_ice_s5,          &amp;<a name='3565'>
                h2osoi_ice1,h2osoi_ice2,h2osoi_ice3,h2osoi_ice4,    &amp;<a name='3566'>
                h2osoi_ice5,h2osoi_ice6,h2osoi_ice7,                &amp;<a name='3567'>
                h2osoi_ice8,h2osoi_ice9,h2osoi_ice10,               &amp;<a name='3568'>
                t_soisno_s1,t_soisno_s2,t_soisno_s3,t_soisno_s4,    &amp;<a name='3569'>
                t_soisno_s5,t_soisno1,t_soisno2,t_soisno3,          &amp;<a name='3570'>
                t_soisno4,t_soisno5,t_soisno6,t_soisno7,            &amp;<a name='3571'>
                t_soisno8,t_soisno9,t_soisno10,                     &amp;<a name='3572'>
                dzsnow1,dzsnow2,dzsnow3,dzsnow4,dzsnow5,            &amp;<a name='3573'>
                snowrds1,snowrds2,snowrds3,snowrds4,snowrds5,       &amp;<a name='3574'>
                t_lake1,t_lake2,t_lake3,t_lake4,t_lake5,            &amp;<a name='3575'>
                t_lake6,t_lake7,t_lake8,t_lake9,t_lake10,           &amp;<a name='3576'>
                h2osoi_vol1,h2osoi_vol2,h2osoi_vol3,                &amp;<a name='3577'>
                h2osoi_vol4,h2osoi_vol5,h2osoi_vol6,                &amp;<a name='3578'>
                h2osoi_vol7,h2osoi_vol8,                            &amp;<a name='3579'>
                h2osoi_vol9,h2osoi_vol10,                           &amp;<a name='3580'>
                q_ref2m,                                   &amp;<a name='3581'>
                ALBEDOsubgrid,LHsubgrid,HFXsubgrid,LWUPsubgrid,     &amp;<a name='3582'>
                Q2subgrid,SABVsubgrid,SABGsubgrid,NRAsubgrid,SWUPsubgrid,&amp;<a name='3583'>
                LHsoi,LHveg,LHtran, &amp;<a name='3584'>
                alswvisdir, alswvisdif, alswnirdir, alswnirdif,      &amp; <font color=#447700>! clm<a name='3585'></font>
                swvisdir, swvisdif, swnirdir, swnirdif               &amp; <font color=#447700>! clm<a name='3586'></font>
#ifdef CN<a name='3587'>
<font color=#447700>!CROP&amp;CN RESTART AND OUTPUTS<a name='3588'></font>
                ,dyntlai,dyntsai,dyntop,dynbot &amp;<a name='3589'>
                ,htmx,croplive,gdd1020,gdd820,gdd020,grainc,grainc_storage  &amp;<a name='3590'>
                ,grainc_xfer,grainn,grainn_storage,grainn_xfer,days_active  &amp;<a name='3591'>
                ,onset_flag,onset_counter,onset_gddflag,onset_fdd,onset_gdd &amp;<a name='3592'>
                ,onset_swi,offset_flag,offset_counter,offset_fdd,offset_swi &amp;<a name='3593'>
                ,dayl,annavg_t2m,tempavg_t2m,tempsum_potential_gpp          &amp;<a name='3594'>
                ,annsum_potential_gpp,tempmax_retransn,annmax_retransn      &amp;<a name='3595'>
                ,prev_leafc_to_litter,prev_frootc_to_litter,tempsum_npp     &amp;<a name='3596'>
                ,annsum_npp,leafc,leafc_storage,leafc_xfer,frootc           &amp;<a name='3597'>
                ,frootc_storage,frootc_xfer,livestemc,livestemc_storage     &amp;<a name='3598'>
                ,livestemc_xfer,deadstemc,deadstemc_storage,deadstemc_xfer  &amp;<a name='3599'>
                ,livecrootc,livecrootc_storage,livecrootc_xfer,deadcrootc   &amp;<a name='3600'>
                ,deadcrootc_storage,deadcrootc_xfer,cpool,pft_ctrunc        &amp;<a name='3601'>
                ,leafn,leafn_storage,leafn_xfer,frootn,frootn_storage       &amp;<a name='3602'>
                ,frootn_xfer,livestemn,livestemn_storage,livestemn_xfer     &amp;<a name='3603'>
                ,deadstemn,deadstemn_storage,deadstemn_xfer,livecrootn      &amp;<a name='3604'>
                ,livecrootn_storage,livecrootn_xfer,deadcrootn              &amp;<a name='3605'>
                ,deadcrootn_storage,deadcrootn_xfer,npool,pft_ntrunc        &amp;<a name='3606'>
                ,gresp_storage,gresp_xfer,xsmrpool,annsum_counter           &amp;<a name='3607'>
                ,cannsum_npp,cannavg_t2m,wf,me,mean_fire_prob,cwdc,litr1c   &amp;<a name='3608'>
                ,litr2c,litr3c,soil1c,soil2c,soil3c,soil4c,seedc,col_ctrunc &amp;<a name='3609'>
                ,prod10c,prod100c,cwdn,litr1n,litr2n,litr3n,soil1n,soil2n   &amp;<a name='3610'>
                ,soil3n,soil4n,seedn,col_ntrunc,prod10n,prod100n,sminn      &amp;<a name='3611'>
                ,totlitc,dwt_seedc_to_leaf,dwt_seedc_to_deadstem,dwt_conv_cflux &amp;<a name='3612'>
                ,dwt_prod10c_gain,dwt_prod100c_gain,prod100c_loss,dwt_frootc_to_litr1c &amp;<a name='3613'>
                ,dwt_frootc_to_litr2c,dwt_frootc_to_litr3c,dwt_livecrootc_to_cwdc &amp;<a name='3614'>
                ,dwt_deadcrootc_to_cwdc,dwt_seedn_to_leaf,dwt_seedn_to_deadstem &amp;<a name='3615'>
                ,dwt_conv_nflux,dwt_prod10n_gain,dwt_prod100n_gain,prod100n_loss &amp;<a name='3616'>
                ,dwt_frootn_to_litr1n,dwt_frootn_to_litr2n, dwt_frootn_to_litr3n &amp;<a name='3617'>
                ,dwt_livecrootn_to_cwdn,dwt_deadcrootn_to_cwdn,retransn &amp;<a name='3618'>
#endif<a name='3619'>
                 )<a name='3620'>
<a name='3621'>
         IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3622'>
            DO j=j_start(ij),j_end(ij)<a name='3623'>
               DO i=i_start(ij),i_end(ij)<a name='3624'>
                  IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE.  1.0 ) ) THEN<a name='3625'>
                     albedo(i,j) = ( albedo(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.08  )<a name='3626'>
                     emiss(i,j) = ( emiss(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.98  )<a name='3627'>
                  ENDIF<a name='3628'>
               ENDDO<a name='3629'>
            ENDDO<a name='3630'>
<a name='3631'>
            IF ( isisfc ) THEN<a name='3632'>
               DO j=j_start(ij),j_end(ij)<a name='3633'>
                  DO i=i_start(ij),i_end(ij)<a name='3634'>
                     IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3635'>
                        <font color=#447700>!  Weighted average of fields between ice-cover values<a name='3636'></font>
                        <font color=#447700>!  and open-water values.<a name='3637'></font>
                        flhc(i,j) = ( flhc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * flhc_sea(i,j) )<a name='3638'>
                        flqc(i,j) = ( flqc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * flqc_sea(i,j) )<a name='3639'>
                        cpm(i,j)  = ( cpm(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * cpm_sea(i,j)  )<a name='3640'>
                        cqs2(i,j) = ( cqs2(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * cqs2_sea(i,j) )<a name='3641'>
                        chs2(i,j) = ( chs2(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * chs2_sea(i,j) )<a name='3642'>
                        chs(i,j)  = ( chs(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * chs_sea(i,j)  )<a name='3643'>
                        qsfc(i,j) = ( qsfc(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qsfc_sea(i,j) )<a name='3644'>
                        qgh(i,j)  = ( qgh(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qgh_sea(i,j)  )<a name='3645'>
                        qz0(i,j)  = ( qz0(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qz0_sea(i,j)  )<a name='3646'>
                        hfx(i,j)  = ( hfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * hfx_sea(i,j)  )<a name='3647'>
                        qfx(i,j)  = ( qfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qfx_sea(i,j)  )<a name='3648'>
                        lh(i,j)   = ( lh(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * lh_sea(i,j)   )<a name='3649'>
<font color=#447700>!save old tsk_ice<a name='3650'></font>
                        tsk_save(i,j)  = tsk(i,j)<a name='3651'>
                        tsk(i,j)  = ( tsk(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * tsk_sea(i,j)  )<a name='3652'>
                     ENDIF<a name='3653'>
                  ENDDO<a name='3654'>
               ENDDO<a name='3655'>
            ELSE<a name='3656'>
               DO j = j_start(ij) , j_end(ij)<a name='3657'>
                  DO i = i_start(ij) , i_end(ij)<a name='3658'>
                     IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3659'>
                        <font color=#447700>! Compute TSK as the open-water and ice-cover average<a name='3660'></font>
                        tsk(i,j) = ( tsk(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * tsk_sea(i,j) )<a name='3661'>
                     ENDIF<a name='3662'>
                  ENDDO<a name='3663'>
               ENDDO<a name='3664'>
            ENDIF<a name='3665'>
         ENDIF<a name='3666'>
          CALL <A href='../../html_code/phys/module_sf_sfcdiags.F.html#SFCDIAGS'>SFCDIAGS</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCDIAGS_3">(HFX,QFX,TSK,QSFC,CHS2,CQS2,T2,TH2,Q2,      &amp;<a name='3667'>
                     PSFC,CP,R_d,RCP,CHS,t_phy,qv_curr,ua_phys,    &amp;<a name='3668'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='3669'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='3670'>
             i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte    )<a name='3671'>
<a name='3672'>
           DO j=j_start(ij),j_end(ij)<a name='3673'>
           DO i=i_start(ij),i_end(ij)<a name='3674'>
              CHKLOWQ(I,J)= 1.0<a name='3675'>
              SFCEVP(I,J)= SFCEVP(I,J) + QFX(I,J)*DTBL<a name='3676'>
<a name='3677'>
<font color=#447700>! update land variables from CLM<a name='3678'></font>
              IF(XLAND(I,J).LT.1.5) then<a name='3679'>
                  Q2(I,J) = sum(q_ref2m(i,1:nump(i,j),j)*wtp(i,1:nump(i,j),j))<a name='3680'>
<a name='3681'>
<font color=#447700>! convert specific humidty to mixing ratio unit: kg/kg)<a name='3682'></font>
                  Q2(I,J) = Q2(I,J)/(1.0-Q2(I,J))<a name='3683'>
<a name='3684'>
                  T2(I,J) = sum(t_ref2m(i,1:nump(i,j),j)*wtp(i,1:nump(i,j),j))<a name='3685'>
                  TH2(I,J)= T2(I,J)*(1.E5/PSFC(I,J))**RCP<a name='3686'>
              END IF<a name='3687'>
           ENDDO<a name='3688'>
           ENDDO<a name='3689'>
<a name='3690'>
       ELSE<a name='3691'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1302">('Lacking arguments for CLM in surface driver')<a name='3692'>
       ENDIF<a name='3693'>
<a name='3694'>
<font color=#447700>! end of CLM scehme<a name='3695'></font>
<font color=#447700>! -------------------------------------------------------------------<a name='3696'></font>
#endif<a name='3697'>
<a name='3698'>
     CASE (SSIBSCHEME)<a name='3699'>
     IF(PRESENT(alswvisdir))THEN<a name='3700'>
<font color=#447700>!---Fernando De Sales (fds 06/2010)--------------------------------------<a name='3701'></font>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_864">(100,'in SSIB')<a name='3702'>
<font color=#447700>!<a name='3703'></font>
       IF ( FRACTIONAL_SEAICE == 1) THEN<a name='3704'>
          <font color=#447700>! The fields passed to SSIB need to represent the full ice values, not<a name='3705'></font>
          <font color=#447700>! the fractional values.  Convert ALBEDO from the blended value<a name='3706'></font>
          <font color=#447700>! to a value representing only the sea-ice portion.   Albedo over open<a name='3707'></font>
          <font color=#447700>! water is taken to be 0.08.<a name='3708'></font>
          DO j = j_start(ij) , j_end(ij)<a name='3709'>
             DO i = i_start(ij) , i_end(ij)<a name='3710'>
                IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1 ) ) THEN<a name='3711'>
                   ALBEDO(I,J) = (ALBEDO(I,J)-(1.-XICE(I,J))*0.08)/XICE(I,J)<a name='3712'>
                ENDIF<a name='3713'>
             ENDDO<a name='3714'>
          ENDDO<a name='3715'>
       ELSE<a name='3716'>
<font color=#447700>!  we shouldn't be here. must have fractional seaice for SSIB to work properly (fds 12/2010)<a name='3717'></font>
       ENDIF<a name='3718'>
<font color=#447700>!<a name='3719'></font>
<font color=#447700>!This stuff is not needed anymore since isisfc is always TRUE for SSIB<a name='3720'></font>
<font color=#447700>!Keep it for later use when code is adapted for isisfc=FALSE<a name='3721'></font>
<font color=#447700>!          IF ( isisfc ) THEN<a name='3722'></font>
<font color=#447700>!             ! Use surface layer routine values from the ice portion of grid point<a name='3723'></font>
<font color=#447700>!          ELSE<a name='3724'></font>
<font color=#447700>!             !<a name='3725'></font>
<font color=#447700>!             ! We don't have surface layer routine values at this time, so<a name='3726'></font>
<font color=#447700>!             ! just use what we have.  Use ice component of TSK<a name='3727'></font>
<font color=#447700>!             !<a name='3728'></font>
<font color=#447700>!             DO j = j_start(ij) , j_end(ij)<a name='3729'></font>
<font color=#447700>!                DO i = i_start(ij) , i_end(ij)<a name='3730'></font>
<font color=#447700>!                   IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1 ) ) THEN<a name='3731'></font>
<font color=#447700>!                      IF ( SST(i,j) .LT. 271.4 ) THEN<a name='3732'></font>
<font color=#447700>!                         SST(i,j) = 271.4<a name='3733'></font>
<font color=#447700>!                      ENDIF<a name='3734'></font>
<font color=#447700>!                      TSK_SEA(i,j) = SST(i,j)<a name='3735'></font>
<font color=#447700>!                      ! Convert TSK from our ice/water average value to value good for solid-ice surface.<a name='3736'></font>
<font color=#447700>!                      TSK(i,j) = ( TSK(i,j) - (1.-XICE(i,j)) *SST(i,j) ) / XICE(i,j)<a name='3737'></font>
<font color=#447700>!                      IF (XICE(i,j).lt.0.2 .and. TSK(i,j).lt.253.15) THEN<a name='3738'></font>
<font color=#447700>!                         TSK(i,j) = 253.15<a name='3739'></font>
<font color=#447700>!                      ENDIF<a name='3740'></font>
<font color=#447700>!                      IF (XICE(i,j).lt.0.1 .and. TSK(i,j).lt.263.15) THEN<a name='3741'></font>
<font color=#447700>!                         TSK(i,j) = 263.15<a name='3742'></font>
<font color=#447700>!                      ENDIF<a name='3743'></font>
<font color=#447700>!                   ELSE<a name='3744'></font>
<font color=#447700>!                      TSK_SEA(i,j) = TSK(i,j)<a name='3745'></font>
<font color=#447700>!                   ENDIF<a name='3746'></font>
<font color=#447700>!                ENDDO<a name='3747'></font>
<font color=#447700>!             ENDDO<a name='3748'></font>
<font color=#447700>!          ENDIF<a name='3749'></font>
<font color=#447700>!<a name='3750'></font>
       day=float(int(julian_in+0.01))+1.<a name='3751'>
       DO j=j_start(ij),j_end(ij)<a name='3752'>
       DO i=i_start(ij),i_end(ij)<a name='3753'>
<a name='3754'>
<font color=#447700>!check land mask and land-use map !fds (02/2012)<a name='3755'></font>
<font color=#447700>!       IF(itimestep .EQ. 1 ) THEN<a name='3756'></font>
<font color=#447700>!          IF(IVGTYP(i,j).NE.ISWATER)THEN<a name='3757'></font>
<font color=#447700>!            XLAND(I,J)=1.0<a name='3758'></font>
<font color=#447700>!          ELSE<a name='3759'></font>
<font color=#447700>!            XLAND(I,J)=2.0<a name='3760'></font>
<font color=#447700>!          ENDIF<a name='3761'></font>
<font color=#447700>!          IF (IVGTYP(I,J).LE.0 .AND. XLAND(I,J).NE.ISWATER ) IVGTYP(I,J) = 7.0<a name='3762'></font>
<font color=#447700>!       ENDIF<a name='3763'></font>
<a name='3764'>
       IF(XLAND(I,J).LT.1.5) THEN <font color=#447700>! seaice and land points<a name='3765'></font>
<a name='3766'>
           CLOUDFRAC=0.<a name='3767'>
           IF(PRESENT(CLDFRA))THEN<a name='3768'>
           DO K=KMS,KME<a name='3769'>
             CLOUDFRAC=AMAX1(CLOUDFRAC,AMIN1(CLDFRA(I,K,J),1.0))<a name='3770'>
           ENDDO<a name='3771'>
           ENDIF<a name='3772'>
<a name='3773'>
         IF (XICE(I,J) .GE. XICE_THRESHOLD) THEN <font color=#447700>!sea ice points only<a name='3774'></font>
<a name='3775'>
           CALL <A href='../../html_code/phys/module_sf_ssib.F.html#SSIB_SEAICE'>ssib_seaice</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSIB_SEAICE_1">                                                        &amp;<a name='3776'>
                    ( i, j, DTBL, itimestep, xlat_urb2d(i,j), coszen(i,j),         &amp;<a name='3777'>
                      rainncv(i,j), raincv(i,j), glw(i,j), dz8w(i,1,j),            &amp;<a name='3778'>
                      smois(i,1,j), smois(i,2,j), smois(i,3,j),                    &amp;<a name='3779'>
                      tslb(i,1,j), tslb(i,2,j), tslb(i,3,j),                       &amp;<a name='3780'>
                      snow(i,j), sfcrunoff(i,j), xice_save(i,j),                   &amp;<a name='3781'>
                      u_phytmp(i,1,j),v_phytmp(i,1,j),qv_curr(i,1,j),t_phy(i,1,j), &amp;<a name='3782'>
                      p_phy(i,1,j), psfc(i,j),                                     &amp;<a name='3783'>
                      swdown(i,j), canwat(i,j),                                    &amp;<a name='3784'>
                 alswvisdir(i,j),alswvisdif(i,j),alswnirdir(i,j),alswnirdif(i,j),  &amp;<a name='3785'>
                      swvisdir(i,j), swvisdif(i,j), swnirdir(i,j), swnirdif(i,j),  &amp;<a name='3786'>
                      hfx(i,j), lh(i,j), grdflx(i,j), qfx(i,j), tsk(i,j),          &amp;<a name='3787'>
                      ust(i,j), ssib_br(i,j), ssib_fm(i,j), ssib_fh(i,j), ssib_cm(i,j), &amp;<a name='3788'>
                      ssib_lhf(i,j), ssib_shf(i,j), ssib_ghf(i,j),                 &amp;<a name='3789'>
                      ssib_sdn(i,j), ssib_sup(i,j), ssib_ldn(i,j), ssib_lup(i,j),  &amp;<a name='3790'>
                      ssib_wat(i,j),                                               &amp;<a name='3791'>
                                     ssib_z00(i,j), ssib_veg(i,j),                 &amp;<a name='3792'>
                      day, cloudfrac, q2(i,j), t2(i,j), albedo(i,j), uv10,         &amp;<a name='3793'>
                      ra_sw_physics,xice_threshold                                 &amp;<a name='3794'>
                                                                                   )<a name='3795'>
         ELSE  <font color=#447700>!land points only (including land ice)<a name='3796'></font>
<a name='3797'>
           CALL <A href='../../html_code/phys/module_sf_ssib.F.html#SSIB'>ssib</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SSIB_1">( i, j, DTBL, itimestep, xlat_urb2d(i,j), coszen(i,j),        &amp;<a name='3798'>
                     rainncv(i,j), raincv(i,j), glw(i,j), dz8w(i,1,j),            &amp;<a name='3799'>
                     smois(i,1,j), smois(i,2,j), smois(i,3,j),                    &amp;<a name='3800'>
                     tslb(i,1,j), tslb(i,2,j), tslb(i,3,j),                       &amp;<a name='3801'>
                     snow(i,j), sfcrunoff(i,j),                                   &amp;<a name='3802'>
                     u_phytmp(i,1,j),v_phytmp(i,1,j),qv_curr(i,1,j),t_phy(i,1,j), &amp;<a name='3803'>
                     p_phy(i,1,j), psfc(i,j), ivgtyp(i,j),                        &amp;<a name='3804'>
                     swdown(i,j), canwat(i,j),                                    &amp;<a name='3805'>
                alswvisdir(i,j),alswvisdif(i,j),alswnirdir(i,j),alswnirdif(i,j),  &amp;<a name='3806'>
                     swvisdir(i,j), swvisdif(i,j), swnirdir(i,j), swnirdif(i,j),  &amp;<a name='3807'>
                     hfx(i,j), lh(i,j), grdflx(i,j), qfx(i,j), tsk(i,j),          &amp;<a name='3808'>
                     ust(i,j), ssib_br(i,j), ssib_fm(i,j), ssib_fh(i,j), ssib_cm(i,j), &amp;<a name='3809'>
                     ssib_lhf(i,j), ssib_shf(i,j), ssib_ghf(i,j), ssib_egs(i,j),  &amp; <a name='3810'>
                     ssib_eci(i,j), ssib_ect(i,j), ssib_egi(i,j), ssib_egt(i,j),  &amp;<a name='3811'>
                     ssib_sdn(i,j), ssib_sup(i,j), ssib_ldn(i,j), ssib_lup(i,j),  &amp;<a name='3812'>
                     ssib_wat(i,j), ssib_shc(i,j), ssib_shg(i,j), ssib_lai(i,j),  &amp;<a name='3813'>
                     ssib_vcf(i,j), ssib_z00(i,j), ssib_veg(i,j), ssibxdd(i,j),   &amp;<a name='3814'>
                     isnow(i,j), swe(i,j), snowden(i,j), snowdepth(i,j),tkair(i,j),  &amp;<a name='3815'>
                     dzo1(i,j),  wo1(i,j),   tssn1(i,j), tssno1(i,j), bwo1(i,j), bto1(i,j),  &amp;<a name='3816'>
                     cto1(i,j), fio1(i,j),    flo1(i,j),   bio1(i,j), blo1(i,j),  ho1(i,j),  &amp;<a name='3817'>
                     dzo2(i,j),  wo2(i,j),   tssn2(i,j), tssno2(i,j), bwo2(i,j), bto2(i,j),  &amp;<a name='3818'>
                     cto2(i,j), fio2(i,j),    flo2(i,j),   bio2(i,j), blo2(i,j),  ho2(i,j),  &amp;<a name='3819'>
                     dzo3(i,j),  wo3(i,j),   tssn3(i,j), tssno3(i,j), bwo3(i,j), bto3(i,j),  &amp;<a name='3820'>
                     cto3(i,j), fio3(i,j),    flo3(i,j),   bio3(i,j), blo3(i,j),  ho3(i,j),  &amp;<a name='3821'>
                     dzo4(i,j),  wo4(i,j),   tssn4(i,j), tssno4(i,j), bwo4(i,j), bto4(i,j),  &amp;<a name='3822'>
                     cto4(i,j), fio4(i,j),    flo4(i,j),   bio4(i,j), blo4(i,j),  ho4(i,j),  &amp;<a name='3823'>
                     day, cloudfrac, q2(i,j), t2(i,j), albedo(i,j), uv10,          &amp;<a name='3824'>
                     ra_sw_physics, mminlu                                        &amp;<a name='3825'>
                                                                                  )<a name='3826'>
         ENDIF<a name='3827'>
<font color=#447700>!<a name='3828'></font>
         BR(i,j)=ssib_br(i,j)<a name='3829'>
         ZNT(i,j) = ssib_z00(i,j)<a name='3830'>
         SFCEVP(I,J)= SFCEVP(I,J) + QFX(I,J)*DTBL<a name='3831'>
         t2(i,j) = tsk(i,j)  <font color=#447700>!keep this<a name='3832'></font>
         IF (itimestep .ne. 1) THEN<a name='3833'>
           ZDIFF=(0.5*dz8w(i,1,j))-SSiBXDD(I,J)<a name='3834'>
           IF(ZDIFF.LE.ZNT(I,J)) ZDIFF=ZNT(I,J)+0.2<a name='3835'>
           GZ1OZ0(I,J)=ALOG(ZDIFF/ZNT(I,J))<a name='3836'>
         ENDIF<a name='3837'>
         IF (XICE(I,J) .GE. XICE_THRESHOLD) THEN<a name='3838'>
           snowh(i,j) = 0.0<a name='3839'>
         ELSE<a name='3840'>
           snowh(i,j) = snowdepth(i,j)<a name='3841'>
         ENDIF<a name='3842'>
         U10(i,j) = UV10*u_phytmp(i,1,j)/SQRT(u_phytmp(i,1,j)**2+v_phytmp(i,1,j)**2)<a name='3843'>
         V10(i,j) = UV10*v_phytmp(i,1,j)/SQRT(u_phytmp(i,1,j)**2+v_phytmp(i,1,j)**2)<a name='3844'>
<font color=#447700>!        Overwrite WSPD to remove convective velocity (wspd=wspd1 in YSU)<a name='3845'></font>
         WSPD(I,J)=sqrt( u_phytmp(i,1,j)*u_phytmp(i,1,j) +      &amp;<a name='3846'>
                         v_phytmp(i,1,j)*v_phytmp(i,1,j) ) + 1.e-9<a name='3847'>
<font color=#447700>!<a name='3848'></font>
       ENDIF<a name='3849'>
<font color=#447700>!<a name='3850'></font>
       ENDDO<a name='3851'>
       ENDDO<a name='3852'>
<font color=#447700>!<a name='3853'></font>
       IF ( FRACTIONAL_SEAICE == 1 ) THEN<a name='3854'>
          <font color=#447700>! SSIB_seaice returns full land/ice albedo values, no fractional values.<a name='3855'></font>
          <font color=#447700>! We return to a fractional component here. <a name='3856'></font>
          DO j=j_start(ij),j_end(ij)<a name='3857'>
             DO i=i_start(ij),i_end(ij)<a name='3858'>
                IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3859'>
                   albedo(i,j) = ( albedo(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * 0.08  )<a name='3860'>
                ENDIF<a name='3861'>
             ENDDO<a name='3862'>
          ENDDO<a name='3863'>
<font color=#447700>!<a name='3864'></font>
          IF ( isisfc ) THEN<a name='3865'>
             DO j=j_start(ij),j_end(ij)<a name='3866'>
                DO i=i_start(ij),i_end(ij)<a name='3867'>
                   IF ( ( XICE(I,J) .GE. XICE_THRESHOLD) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3868'>
                      <font color=#447700>!  Weighted average of fields between ice-cover values and open-water values.<a name='3869'></font>
                      hfx(i,j)  = ( hfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * hfx_sea(i,j)  )<a name='3870'>
                      qfx(i,j)  = ( qfx(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * qfx_sea(i,j)  )<a name='3871'>
                      lh(i,j)   = ( lh(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * lh_sea(i,j)   )<a name='3872'>
<font color=#447700>!save old tsk_ice<a name='3873'></font>
                      tsk_save(i,j)  = tsk(i,j)<a name='3874'>
                      tsk(i,j)  = ( tsk(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * tsk_sea(i,j)  )<a name='3875'>
                   ENDIF<a name='3876'>
                ENDDO<a name='3877'>
             ENDDO<a name='3878'>
          ELSE<a name='3879'>
             DO j = j_start(ij) , j_end(ij)<a name='3880'>
                DO i = i_start(ij) , i_end(ij)<a name='3881'>
                   IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='3882'>
                      <font color=#447700>! Compute TSK as the open-water and ice-cover average<a name='3883'></font>
                      tsk(i,j) = ( tsk(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * tsk_sea(i,j) )<a name='3884'>
                   ENDIF<a name='3885'>
                ENDDO<a name='3886'>
             ENDDO<a name='3887'>
          ENDIF<a name='3888'>
       ENDIF<a name='3889'>
       ELSE<a name='3890'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1303">('Lacking arguments for SSIB in surface driver')<a name='3891'>
       ENDIF<a name='3892'>
<font color=#447700>!end ssib<a name='3893'></font>
<font color=#447700>!-------------------------------------------------------------------<a name='3894'></font>
<a name='3895'>
     CASE DEFAULT<a name='3896'>
<a name='3897'>
       IF ( itimestep .eq. 1 ) THEN<a name='3898'>
       WRITE( message , * ) &amp;<a name='3899'>
        'No land surface physics option is used: sf_surface_physics = ', sf_surface_physics<a name='3900'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_1074"> ( message )<a name='3901'>
       ENDIF<a name='3902'>
<a name='3903'>
     END SELECT sfc_select<a name='3904'>
<a name='3905'>
     ENDDO<a name='3906'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='3907'></font>
<a name='3908'>
 430 CONTINUE<a name='3909'>
<a name='3910'>
#if ( EM_CORE==1)<a name='3911'>
   IF (sf_ocean_physics .EQ. OMLSCHEME .or. sf_ocean_physics .EQ. PWP3DSCHEME) THEN<a name='3912'>
<font color=#447700>! simple ocean mixed layer model based Pollard, Rhines and Thompson (1973)<a name='3913'></font>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_865">( 100, 'Call OCEANML' )<a name='3914'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3915'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='3916'></font>
     DO ij = 1 , num_tiles<a name='3917'>
        CALL <A href='../../html_code/phys/module_sf_ocean_driver.F.html#OCEAN_DRIVER'>ocean_driver</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OCEAN_DRIVER_1">(tml,t0ml,hml,h0ml,huml,hvml,ust,u_phy,v_phy, &amp;<a name='3918'>
                     tmoml,f,g,oml_gamma,                         &amp;<a name='3919'>
                     xland,hfx,lh,tsk,gsw,glw,emiss,              &amp;<a name='3920'>
                     dtbl,STBOLT,oml_relaxation_time,             &amp;<a name='3921'>
                     ids,ide, jds,jde, kds,kde,                   &amp;<a name='3922'>
                     ims,ime, jms,jme, kms,kme,                   &amp;<a name='3923'>
                     i_start(ij),i_end(ij), j_start(ij),j_end(ij), kts,kte, &amp; <a name='3924'>
                     sf_ocean_physics,okms, okme,                 &amp; <font color=#447700>!cyl<a name='3925'></font>
                     om_tmp,om_s,om_u, om_v,  om_depth, om_ml,    &amp; <font color=#447700>!cyl<a name='3926'></font>
                     om_lat, om_lon,                              &amp; <font color=#447700>!cyl<a name='3927'></font>
                     QFX,                                         &amp; <font color=#447700>!cyl <a name='3928'></font>
                     rdx, rdy, msfu, msfv, msft,xtime,            &amp; <font color=#447700>!cyl <a name='3929'></font>
                     om_tini,om_sini,id,omdt,                     &amp; <font color=#447700>!cyl <a name='3930'></font>
                     itimestep )                                    <font color=#447700>!cyl<a name='3931'></font>
     ENDDO<a name='3932'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='3933'></font>
   ENDIF<a name='3934'>
#endif<a name='3935'>
<font color=#447700>! adding a lake model -- 07/02/2010<a name='3936'></font>
   IF ( LakeModel == 1 ) THEN<a name='3937'>
 <a name='3938'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_866">( 100, 'Call LakeModel' )<a name='3939'>
 <a name='3940'>
      DO ij = 1 , num_tiles<a name='3941'>
 <a name='3942'>
         CALL <A href='../../html_code/phys/module_sf_lake.F.html#LAKE'>Lake</A><A href='../../html_code/phys/module_surface_driver.F.html#SURFACE_DRIVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LAKE_1">(  t_phy        ,p8w            ,dz8w         ,qv_curr         ,&amp;  <font color=#447700>!i<a name='3943'></font>
                     u_phy        ,v_phy          , glw         ,emiss           ,&amp;<a name='3944'>
                     rainbl       ,dtbl           ,swdown       ,albedo          ,&amp;<a name='3945'>
                     xlat_urb2d   ,z_lake3d       ,dz_lake3d    ,lakedepth2d     ,&amp;<a name='3946'>
                     watsat3d     ,csol3d         ,tkmg3d       ,tkdry3d         ,&amp;<a name='3947'>
                     tksatu3d     ,ivgtyp         ,ht           ,xland           ,&amp;<a name='3948'>
                     iswater      ,xice           ,xice_threshold, lake_min_elev    ,&amp;<a name='3949'>
                     ids          ,ide            ,jds          ,jde             ,&amp;<a name='3950'>
                     kds          ,kde            ,ims          ,ime             ,&amp;<a name='3951'>
                     jms          ,jme            ,kms          ,kme             ,&amp;<a name='3952'>
                     i_start(ij)  ,i_end(ij)      ,j_start(ij)  ,j_end(ij)       ,&amp;<a name='3953'>
                     kts          ,kte                                           ,&amp;<a name='3954'>
                     h2osno2d     ,snowdp2d       ,snl2d        ,z3d             ,&amp;  <font color=#447700>!h<a name='3955'></font>
                     dz3d         ,zi3d           ,h2osoi_vol3d ,h2osoi_liq3d    ,&amp;<a name='3956'>
                     h2osoi_ice3d ,t_grnd2d       ,t_soisno3d   ,t_lake3d        ,&amp;<a name='3957'>
                     savedtke12d  ,lake_icefrac3d                                ,&amp;<a name='3958'>
#if ( EM_CORE==1)<a name='3959'>
  <font color=#447700>!                   lakemask  ,lakeflag                                         ,&amp;<a name='3960'></font>
                     lakemask                                           ,&amp;<a name='3961'>
#endif<a name='3962'>
                     hfx          ,lh             ,grdflx       ,tsk             ,&amp;  <font color=#447700>!o<a name='3963'></font>
                     qfx          ,t2             ,th2          ,q2 )<a name='3964'>
 <a name='3965'>
 <a name='3966'>
      ENDDO<a name='3967'>
 <a name='3968'>
   ENDIF<a name='3969'>
<a name='3970'>
<font color=#447700>! Reset RAINBL in mm (Accumulation between PBL calls)<a name='3971'></font>
<a name='3972'>
     IF ( PRESENT( rainbl ) ) THEN<a name='3973'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3974'></font>
       <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='3975'></font>
       DO ij = 1 , num_tiles<a name='3976'>
         DO j=j_start(ij),j_end(ij)<a name='3977'>
         DO i=i_start(ij),i_end(ij)<a name='3978'>
            RAINBL(i,j) = 0.<a name='3979'>
         ENDDO<a name='3980'>
         ENDDO<a name='3981'>
       ENDDO<a name='3982'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='3983'></font>
     ENDIF<a name='3984'>
<a name='3985'>
     IF( PRESENT(slope_rad).AND. radiation )THEN<a name='3986'>
<font color=#447700>! topographic slope effects removed from SWDOWN and GSW here for output<a name='3987'></font>
       IF (slope_rad .EQ. 1) THEN<a name='3988'>
<a name='3989'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3990'></font>
       <font color=#447700>!$OMP PRIVATE ( ij, i, j, k )<a name='3991'></font>
       DO ij = 1 , num_tiles<a name='3992'>
         DO j=j_start(ij),j_end(ij)<a name='3993'>
         DO i=i_start(ij),i_end(ij)<a name='3994'>
         IF(SWNORM(I,J) .GT. 1.E-3)THEN  <font color=#447700>! daytime<a name='3995'></font>
            SWSAVE = SWDOWN(i,j)<a name='3996'>
<font color=#447700>! SWDOWN contains unaffected SWDOWN in output<a name='3997'></font>
            SWDOWN(i,j) = SWNORM(i,j)<a name='3998'>
<font color=#447700>! SWNORM contains slope-affected SWDOWN in output<a name='3999'></font>
            SWNORM(i,j) = SWSAVE<a name='4000'>
            GSW(i,j) = GSWSAVE(i,j)<a name='4001'>
         ENDIF<a name='4002'>
         ENDDO<a name='4003'>
         ENDDO<a name='4004'>
       ENDDO<a name='4005'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='4006'></font>
<a name='4007'>
       ENDIF<a name='4008'>
     ENDIF<a name='4009'>
<a name='4010'>
   ENDIF<a name='4011'>
<a name='4012'>
   END SUBROUTINE surface_driver<a name='4013'>
<a name='4014'>
<font color=#447700>!-------------------------------------------------------------------------<a name='4015'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='4016'></font>
<a name='4017'>
<A NAME='MYJSFC_SEAICE_WRAPPER'><A href='../../html_code/phys/module_surface_driver.F.html#MYJSFC_SEAICE_WRAPPER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4018'>
   <font color=#993300>subroutine </font><font color=#cc0000>myjsfc_seaice_wrapper</font>(ITIMESTEP,HT,DZ,      &amp; <A href='../../call_to/MYJSFC_SEAICE_WRAPPER.html' TARGET='index'>1</A>,<A href='../../call_from/MYJSFC_SEAICE_WRAPPER.html' TARGET='index'>4</A><a name='4019'>
        &amp;     PMID,PINT,TH,T,QV,QC,U,V,Q2,                &amp;<a name='4020'>
        &amp;     TSK,QSFC,THZ0,QZ0,UZ0,VZ0,                  &amp;<a name='4021'>
        &amp;     LOWLYR,XLAND,IVGTYP,ISURBAN,IZ0TLND,        &amp;<a name='4022'>
        &amp;     TICE2TSK_IF2COLD,                           &amp;  <font color=#447700>! Extra for wrapper<a name='4023'></font>
        &amp;     XICE_THRESHOLD,                             &amp;  <font color=#447700>! Extra for wrapper<a name='4024'></font>
        &amp;     XICE,SST,                                   &amp;  <font color=#447700>! Extra for wrapper<a name='4025'></font>
        &amp;     CHS_SEA, CHS2_SEA, CQS2_SEA, CPM_SEA,       &amp;  <font color=#447700>! Extra for wrapper<a name='4026'></font>
        &amp;     FLHC_SEA, FLQC_SEA, QSFC_SEA,               &amp;  <font color=#447700>! Extra for wrapper<a name='4027'></font>
        &amp;     QGH_SEA, QZ0_SEA, HFX_SEA, QFX_SEA,         &amp;  <font color=#447700>! Extra for wrapper<a name='4028'></font>
        &amp;     FLX_LH_SEA, TSK_SEA,                        &amp;  <font color=#447700>! Extra for wrapper<a name='4029'></font>
        &amp;     USTAR,ZNT,Z0BASE,PBLH,MAVAIL,RMOL,          &amp;<a name='4030'>
        &amp;     AKHS,AKMS,                                  &amp;<a name='4031'>
        &amp;     BR,                                         &amp;<a name='4032'>
        &amp;     CHS,CHS2,CQS2,HFX,QFX,FLX_LH,FLHC,FLQC,     &amp;<a name='4033'>
        &amp;     QGH,CPM,CT,                                 &amp;<a name='4034'>
        &amp;     U10,V10,T02,TH02,TSHLTR,TH10,Q02,QSHLTR,Q10,PSHLTR,          &amp;<a name='4035'>
        &amp;     P1000,                                        &amp;<a name='4036'>
        &amp;     IDS,IDE,JDS,JDE,KDS,KDE,                        &amp;<a name='4037'>
        &amp;     IMS,IME,JMS,JME,KMS,KME,                        &amp;<a name='4038'>
        &amp;     ITS,ITE,JTS,JTE,KTS,KTE )<a name='4039'>
<font color=#447700>!     USE module_model_constants<a name='4040'></font>
     USE <A href='../../html_code/phys/module_sf_myjsfc.F.html#MODULE_SF_MYJSFC'>module_sf_myjsfc</A><A href='../../html_code/phys/module_surface_driver.F.html#MYJSFC_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_MYJSFC_4"><a name='4041'>
<a name='4042'>
     IMPLICIT NONE<a name='4043'>
<a name='4044'>
     INTEGER,                                INTENT(IN)    :: ITIMESTEP<a name='4045'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: HT<a name='4046'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: DZ<a name='4047'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: PMID<a name='4048'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: PINT<a name='4049'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: TH<a name='4050'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: T<a name='4051'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: QV<a name='4052'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: QC<a name='4053'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: U<a name='4054'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: V<a name='4055'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: Q2   <font color=#447700>! Q2 is TKE?<a name='4056'></font>
<a name='4057'>
     <font color=#447700>! REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: TSK<a name='4058'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT)    :: TSK<a name='4059'>
<a name='4060'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: QSFC<a name='4061'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: THZ0<a name='4062'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: QZ0<a name='4063'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: UZ0<a name='4064'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: VZ0<a name='4065'>
     INTEGER,DIMENSION(IMS:IME,JMS:JME),     INTENT(IN)    :: LOWLYR<a name='4066'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: XLAND<a name='4067'>
     INTEGER,DIMENSION(IMS:IME,JMS:JME),     INTENT(IN)    :: IVGTYP<a name='4068'>
     INTEGER                                               :: ISURBAN<a name='4069'>
     INTEGER                                               :: IZ0TLND<a name='4070'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: XICE       <font color=#447700>! Extra for wrapper<a name='4071'></font>
     <font color=#447700>! REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: SST        ! Extra for wrapper<a name='4072'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: SST        <font color=#447700>! Extra for wrapper<a name='4073'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: BR<a name='4074'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CHS_SEA    <font color=#447700>! Extra for wrapper<a name='4075'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CHS2_SEA   <font color=#447700>! Extra for wrapper<a name='4076'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CQS2_SEA   <font color=#447700>! Extra for wrapper<a name='4077'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CPM_SEA    <font color=#447700>! Extra for wrapper<a name='4078'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QZ0_SEA   <font color=#447700>! Extra for wrapper<a name='4079'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QSFC_SEA   <font color=#447700>! Extra for wrapper<a name='4080'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QGH_SEA   <font color=#447700>! Extra for wrapper<a name='4081'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLHC_SEA  <font color=#447700>! Extra for wrapper<a name='4082'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLQC_SEA  <font color=#447700>! Extra for wrapper<a name='4083'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: HFX_SEA    <font color=#447700>! Extra for wrapper<a name='4084'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QFX_SEA    <font color=#447700>! Extra for wrapper<a name='4085'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLX_LH_SEA <font color=#447700>! Extra for wrapper<a name='4086'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: TSK_SEA    <font color=#447700>! Extra for wrapper<a name='4087'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: USTAR<a name='4088'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: ZNT<a name='4089'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: Z0BASE<a name='4090'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: PBLH<a name='4091'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: MAVAIL<a name='4092'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: RMOL<a name='4093'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: AKHS<a name='4094'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: AKMS<a name='4095'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CHS<a name='4096'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CHS2<a name='4097'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CQS2<a name='4098'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: HFX<a name='4099'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QFX<a name='4100'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLX_LH<a name='4101'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLHC<a name='4102'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLQC<a name='4103'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QGH<a name='4104'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CPM<a name='4105'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CT<a name='4106'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: U10<a name='4107'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: V10<a name='4108'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: T02<a name='4109'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: TH02<a name='4110'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: TSHLTR<a name='4111'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: TH10<a name='4112'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: Q02<a name='4113'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QSHLTR<a name='4114'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: Q10<a name='4115'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: PSHLTR<a name='4116'>
     REAL,                                   INTENT(IN)    :: P1000<a name='4117'>
     REAL,                                   INTENT(IN)    :: XICE_THRESHOLD<a name='4118'>
     LOGICAL,                                INTENT(IN)    :: TICE2TSK_IF2COLD<a name='4119'>
     INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE,       &amp;<a name='4120'>
          &amp;                IMS,IME,JMS,JME,KMS,KME,       &amp;<a name='4121'>
          &amp;                ITS,ITE,JTS,JTE,KTS,KTE<a name='4122'>
<a name='4123'>
<a name='4124'>
     <font color=#447700>! Local<a name='4125'></font>
     INTEGER :: i<a name='4126'>
     INTEGER :: j<a name='4127'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: ct_sea<a name='4128'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: u10_sea<a name='4129'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: v10_sea<a name='4130'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: t02_sea<a name='4131'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: th02_sea<a name='4132'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: tshltr_sea<a name='4133'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: pshltr_sea<a name='4134'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: qshltr_sea<a name='4135'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: th10_sea<a name='4136'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: q02_sea<a name='4137'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: q10_sea<a name='4138'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: thz0_sea<a name='4139'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: uz0_sea<a name='4140'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: vz0_sea<a name='4141'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: ustar_sea<a name='4142'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: pblh_sea<a name='4143'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: rmol_sea<a name='4144'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: akhs_sea<a name='4145'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: akms_sea<a name='4146'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: xland_sea<a name='4147'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: mavail_sea<a name='4148'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: znt_sea<a name='4149'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: z0base_sea<a name='4150'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: br_sea<a name='4151'>
<a name='4152'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: QSFC_HOLD<a name='4153'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: QZ0_HOLD<a name='4154'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: THZ0_HOLD<a name='4155'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: UZ0_HOLD<a name='4156'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: VZ0_HOLD<a name='4157'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: USTAR_HOLD<a name='4158'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: ZNT_HOLD<a name='4159'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: PBLH_HOLD<a name='4160'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: RMOL_HOLD<a name='4161'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: AKHS_HOLD<a name='4162'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: AKMS_HOLD<a name='4163'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: TSK_LOCAL<a name='4164'>
     REAL :: PSFC<a name='4165'>
<a name='4166'>
     <font color=#447700>! Set things up for the frozen-surface call to myjsfc<a name='4167'></font>
     <font color=#447700>! Is SST local here, or are the changes to be fed back to the calling routines?<a name='4168'></font>
<a name='4169'>
     <font color=#447700>! We want a TSK valid for the ice-covered regions of the grid cell.<a name='4170'></font>
<a name='4171'>
     CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#MYJSFC_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_5">( ims, ime, jms, jme, its, ite, jts, jte,  &amp;<a name='4172'>
                             itimestep, .true., tice2tsk_if2cold,     &amp;<a name='4173'>
                             XICE, XICE_THRESHOLD,                    &amp;<a name='4174'>
                             SST, TSK, TSK_SEA, TSK_LOCAL )<a name='4175'>
     DO j = JTS , JTE<a name='4176'>
        DO i = ITS , ITE<a name='4177'>
           TSK(i,j) = TSK_LOCAL(i,j)<a name='4178'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='4179'>
<a name='4180'>
              <font color=#447700>! Over fractional sea-ice points, back out an ice portion of QSFC as well.<a name='4181'></font>
              <font color=#447700>! QSFC_SEA calculation as done in myjsfc for open water points<a name='4182'></font>
              PSFC = PINT(I,LOWLYR(I,J),J)<a name='4183'>
              QSFC_SEA(i,j) = PQ0SEA/PSFC*EXP(A2S*(TSK(i,j)-A3S)/(TSK(i,j)-A4S))<a name='4184'>
              QSFC(i,j) = QSFC(i,j) - (1.0-XICE(i,j)) * QSFC_SEA(i,j) / XICE(i,j)<a name='4185'>
<font color=#447700>!<a name='4186'></font>
              HFX_SEA(i,j)  = HFX(i,j)<a name='4187'>
              QFX_SEA(i,j)  = QFX(i,j)<a name='4188'>
              FLX_LH_SEA(i,j)   = FLX_LH(i,j)<a name='4189'>
           ENDIF<a name='4190'>
        ENDDO<a name='4191'>
     ENDDO<a name='4192'>
<a name='4193'>
<font color=#447700>!<a name='4194'></font>
<font color=#447700>! frozen ocean call for sea ice points<a name='4195'></font>
<font color=#447700>!<a name='4196'></font>
<a name='4197'>
<font color=#447700>! Strictly INTENT(IN) to MYJSFC, should be unchanged by call.<a name='4198'></font>
<a name='4199'>
     <font color=#447700>! DZ<a name='4200'></font>
     <font color=#447700>! HT<a name='4201'></font>
     <font color=#447700>! LOWLYR<a name='4202'></font>
     <font color=#447700>! MAVAIL<a name='4203'></font>
     <font color=#447700>! PINT<a name='4204'></font>
     <font color=#447700>! PMID<a name='4205'></font>
     <font color=#447700>! QC<a name='4206'></font>
     <font color=#447700>! QV<a name='4207'></font>
     <font color=#447700>! Q2<a name='4208'></font>
     <font color=#447700>! T<a name='4209'></font>
     <font color=#447700>! TH<a name='4210'></font>
     <font color=#447700>! TSK<a name='4211'></font>
     <font color=#447700>! U<a name='4212'></font>
     <font color=#447700>! V<a name='4213'></font>
     <font color=#447700>! XLAND<a name='4214'></font>
     <font color=#447700>! Z0BASE<a name='4215'></font>
<a name='4216'>
<font color=#447700>! INTENT (INOUT),  updated by MYJSFC.  Values will need to be saved before the first call to MYJSFC, so that<a name='4217'></font>
<font color=#447700>! the second call to MYJSFC does not double-count the effect.<a name='4218'></font>
<a name='4219'>
     <font color=#447700>! Save INTENT(INOUT) variables before the frozen-water/true-land call to MYJSFC:<a name='4220'></font>
     QSFC_HOLD  = QSFC<a name='4221'>
     QZ0_HOLD   = QZ0<a name='4222'>
     THZ0_HOLD  = THZ0<a name='4223'>
     UZ0_HOLD   = UZ0<a name='4224'>
     VZ0_HOLD   = VZ0<a name='4225'>
     USTAR_HOLD = USTAR<a name='4226'>
     ZNT_HOLD   = ZNT<a name='4227'>
     PBLH_HOLD  = PBLH<a name='4228'>
     RMOL_HOLD  = RMOL<a name='4229'>
     AKHS_HOLD  = AKHS<a name='4230'>
     AKMS_HOLD  = AKMS<a name='4231'>
<a name='4232'>
<font color=#447700>! Strictly INTENT(OUT):  Set by MYJSFC<a name='4233'></font>
<a name='4234'>
     <font color=#447700>! CHS<a name='4235'></font>
     <font color=#447700>! CHS2<a name='4236'></font>
     <font color=#447700>! CPM<a name='4237'></font>
     <font color=#447700>! CQS2<a name='4238'></font>
     <font color=#447700>! CT<a name='4239'></font>
     <font color=#447700>! FLHC<a name='4240'></font>
     <font color=#447700>! FLQC<a name='4241'></font>
     <font color=#447700>! FLX_LH<a name='4242'></font>
     <font color=#447700>! HFX<a name='4243'></font>
     <font color=#447700>! PSHLTR<a name='4244'></font>
     <font color=#447700>! QFX<a name='4245'></font>
     <font color=#447700>! QGH<a name='4246'></font>
     <font color=#447700>! QSHLTR<a name='4247'></font>
     <font color=#447700>! Q02<a name='4248'></font>
     <font color=#447700>! Q10<a name='4249'></font>
     <font color=#447700>! TH02<a name='4250'></font>
     <font color=#447700>! TH10<a name='4251'></font>
     <font color=#447700>! TSHLTR<a name='4252'></font>
     <font color=#447700>! T02<a name='4253'></font>
     <font color=#447700>! U10<a name='4254'></font>
     <font color=#447700>! V10<a name='4255'></font>
<a name='4256'>
     <font color=#447700>! Frozen-water/true-land call.<a name='4257'></font>
     CALL <A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFC'>MYJSFC</A><A href='../../html_code/phys/module_surface_driver.F.html#MYJSFC_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYJSFC_2"> ( ITIMESTEP, HT, DZ,                              &amp;  <font color=#447700>! I,I,I,<a name='4258'></font>
          &amp;        PMID, PINT, TH, T, QV, QC, U, V, Q2,            &amp;  <font color=#447700>! I,I,I,I,I,I,I,I,I,<a name='4259'></font>
          &amp;        TSK, QSFC, THZ0, QZ0, UZ0, VZ0,                 &amp;  <font color=#447700>! I,IO,IO,IO,IO,IO,<a name='4260'></font>
          &amp;        LOWLYR, XLAND, IVGTYP, ISURBAN, IZ0TLND,        &amp;  <font color=#447700>! I,I,I,I,I<a name='4261'></font>
          &amp;        USTAR, ZNT, Z0BASE, PBLH, MAVAIL, RMOL,         &amp;  <font color=#447700>! IO,IO,I,IO,I,IO,<a name='4262'></font>
          &amp;        AKHS, AKMS,                                     &amp;  <font color=#447700>! IO,IO,<a name='4263'></font>
          &amp;        BR,                                             &amp;  <font color=#447700>! O<a name='4264'></font>
          &amp;        CHS, CHS2, CQS2, HFX, QFX, FLX_LH, FLHC, FLQC,  &amp;  <font color=#447700>! O,O,O,0,0,0,0,0,<a name='4265'></font>
          &amp;        QGH, CPM, CT, U10, V10, T02,                    &amp;  <font color=#447700>! 0,0,0,0,0,0,<a name='4266'></font>
          &amp;        TH02, TSHLTR, TH10, Q02,                        &amp;  <font color=#447700>! 0,0,0,0,<a name='4267'></font>
          &amp;        QSHLTR, Q10, PSHLTR,                            &amp;  <font color=#447700>! 0,0,0,<a name='4268'></font>
          &amp;        P1000,                                        &amp;  <font color=#447700>! I<a name='4269'></font>
          &amp;        ids,ide, jds,jde, kds,kde,                      &amp;<a name='4270'>
          &amp;        ims,ime, jms,jme, kms,kme,                      &amp;<a name='4271'>
          &amp;        its,ite, jts,jte, kts,kte    )<a name='4272'>
<a name='4273'>
     <font color=#447700>! Set up things for the open ocean call.<a name='4274'></font>
     DO j = JTS, JTE<a name='4275'>
        DO i = ITS, ITE<a name='4276'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='4277'>
              XLAND_SEA(i,j)=2.<a name='4278'>
              MAVAIL_SEA(I,J)  = 1.<a name='4279'>
              ZNT_SEA(I,J) = 0.0001<a name='4280'>
              Z0BASE_SEA(I,J) = ZNT_SEA(I,J)<a name='4281'>
              IF ( SST(i,j) .LT. 271.4 ) THEN<a name='4282'>
                 SST(i,j) = 271.4<a name='4283'>
              ENDIF<a name='4284'>
              TSK_SEA(i,j) = SST(i,j)<a name='4285'>
              PSFC = PINT(I,LOWLYR(I,J),J)<a name='4286'>
              QSFC_SEA(I,J) = PQ0SEA/PSFC*EXP(A2S*(TSK_SEA(i,j)-A3S)/(TSK_SEA(i,j)-A4S))<a name='4287'>
           ELSE<a name='4288'>
              <font color=#447700>! This should be a land point or a true open water point<a name='4289'></font>
              XLAND_SEA(i,j)=xland(i,j)<a name='4290'>
              MAVAIL_SEA(i,j) = mavail(i,j)<a name='4291'>
              ZNT_SEA(I,J)    = ZNT_HOLD(I,J)<a name='4292'>
              Z0BASE_SEA(I,J) = Z0BASE(I,J)<a name='4293'>
              TSK_SEA(i,j)  = TSK(i,j)<a name='4294'>
              QSFC_SEA(i,j) = QSFC_HOLD(i,j)<a name='4295'>
           ENDIF<a name='4296'>
        ENDDO<a name='4297'>
     ENDDO<a name='4298'>
<a name='4299'>
     QZ0_SEA  = QZ0_HOLD<a name='4300'>
     THZ0_SEA = THZ0_HOLD<a name='4301'>
     UZ0_SEA  = UZ0_HOLD<a name='4302'>
     VZ0_SEA  = VZ0_HOLD<a name='4303'>
     USTAR_SEA = USTAR_HOLD<a name='4304'>
     PBLH_SEA = PBLH_HOLD<a name='4305'>
     RMOL_SEA = RMOL_HOLD<a name='4306'>
     AKHS_SEA = AKHS_HOLD<a name='4307'>
     AKMS_SEA = AKMS_HOLD<a name='4308'>
<a name='4309'>
<font color=#447700>!<a name='4310'></font>
<font color=#447700>! open water call<a name='4311'></font>
<font color=#447700>!<a name='4312'></font>
     CALL <A href='../../html_code/phys/module_sf_myjsfc.F.html#MYJSFC'>MYJSFC</A><A href='../../html_code/phys/module_surface_driver.F.html#MYJSFC_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MYJSFC_3"> ( ITIMESTEP, HT, DZ,                                                          &amp; <font color=#447700>! I,I,I,<a name='4313'></font>
          &amp;        PMID, PINT, TH, T, QV, QC, U, V, Q2,                                        &amp; <font color=#447700>! I,I,I,I,I,I,I,I,I,<a name='4314'></font>
          &amp;        TSK_SEA, QSFC_SEA, THZ0_SEA, QZ0_SEA, UZ0_SEA, VZ0_SEA,                     &amp; <font color=#447700>! I,IO,IO,IO,IO,IO,<a name='4315'></font>
          &amp;        LOWLYR, XLAND_SEA, IVGTYP, ISURBAN, IZ0TLND,                                &amp; <font color=#447700>! I,I,I,I,I,<a name='4316'></font>
          &amp;        USTAR_SEA, ZNT_SEA, Z0BASE_SEA, PBLH_SEA, MAVAIL_SEA, RMOL_SEA,             &amp; <font color=#447700>! IO,IO,I,IO,I,IO,<a name='4317'></font>
          &amp;        AKHS_SEA, AKMS_SEA,                                                         &amp; <font color=#447700>! IO,IO,<a name='4318'></font>
          &amp;        BR_SEA,                                                                     &amp; <font color=#447700>! dummy space holder<a name='4319'></font>
          &amp;        CHS_SEA, CHS2_SEA, CQS2_SEA, HFX_SEA, QFX_SEA, FLX_LH_SEA, FLHC_SEA,        &amp; <font color=#447700>! 0,0,0,0,0,0,0,<a name='4320'></font>
          &amp;        FLQC_SEA, QGH_SEA, CPM_SEA, CT_SEA, U10_SEA, V10_SEA, T02_SEA, TH02_SEA,    &amp; <font color=#447700>! 0,0,0,0,0,0,0,0,<a name='4321'></font>
          &amp;        TSHLTR_SEA, TH10_SEA, Q02_SEA, QSHLTR_SEA, Q10_SEA, PSHLTR_SEA,             &amp; <font color=#447700>! 0,0,0,0,0,0,<a name='4322'></font>
          &amp;        p1000,                                                                    &amp; <font color=#447700>! I<a name='4323'></font>
          &amp;        ids,ide, jds,jde, kds,kde,                                                  &amp;<a name='4324'>
          &amp;        ims,ime, jms,jme, kms,kme,                                                  &amp;<a name='4325'>
          &amp;        its,ite, jts,jte, kts,kte    )<a name='4326'>
<a name='4327'>
<font color=#447700>!<a name='4328'></font>
<font color=#447700>! Scale the appropriate terms between open-water values and ice-covered values<a name='4329'></font>
<font color=#447700>!<a name='4330'></font>
<a name='4331'>
     DO j = JTS, JTE<a name='4332'>
        DO i = ITS, ITE<a name='4333'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='4334'>
              <font color=#447700>! Over sea-ice points, blend the results.<a name='4335'></font>
<a name='4336'>
              <font color=#447700>! INTENT(OUT) from MYJSFC<a name='4337'></font>
              <font color=#447700>! CHS  wait<a name='4338'></font>
              <font color=#447700>! CHS2 wait<a name='4339'></font>
              <font color=#447700>! CPM  wait<a name='4340'></font>
              <font color=#447700>! CQS2 wait<a name='4341'></font>
              CT(i,j)     = CT(i,j)     * XICE(i,j) + (1.0-XICE(i,j)) * CT_SEA (i,j)<a name='4342'>
              <font color=#447700>! FLHC(i,j)   = FLHC(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * FLHC_SEA (i,j)<a name='4343'></font>
              <font color=#447700>! FLQC(i,j)   = FLQC(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * FLQC_SEA (i,j)<a name='4344'></font>
              <font color=#447700>! FLX_LH wait<a name='4345'></font>
              <font color=#447700>! HFX  wait<a name='4346'></font>
              PSHLTR(i,j) = PSHLTR(i,j) * XICE(i,j) + (1.0-XICE(i,j)) * PSHLTR_SEA(i,j)<a name='4347'>
              <font color=#447700>! QFX  wait<a name='4348'></font>
              <font color=#447700>! QGH  wait<a name='4349'></font>
              QSHLTR(i,j) = QSHLTR(i,j) * XICE(i,j) + (1.0-XICE(i,j)) * QSHLTR_SEA(i,j)<a name='4350'>
              Q02(i,j)    = Q02(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * Q02_SEA(i,j)<a name='4351'>
              Q10(i,j)    = Q10(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * Q10_SEA(i,j)<a name='4352'>
              TH02(i,j)   = TH02(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * TH02_SEA(i,j)<a name='4353'>
              TH10(i,j)   = TH10(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * TH10_SEA(i,j)<a name='4354'>
              TSHLTR(i,j) = TSHLTR(i,j) * XICE(i,j) + (1.0-XICE(i,j)) * TSHLTR_SEA(i,j)<a name='4355'>
              T02(i,j)    = T02(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * T02_SEA(i,j)<a name='4356'>
              U10(i,j)    = U10(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * U10_SEA(i,j)<a name='4357'>
              V10(i,j)    = V10(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * V10_SEA(i,j)<a name='4358'>
<a name='4359'>
              <font color=#447700>! INTENT(INOUT):  updated by MYJSFC<a name='4360'></font>
              <font color=#447700>! QSFC:  wait<a name='4361'></font>
              THZ0(i,j)   = THZ0(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * THZ0_SEA(i,j)<a name='4362'>
              <font color=#447700>! qz0 wait<a name='4363'></font>
              UZ0(i,j)    = UZ0(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * UZ0_SEA(i,j)<a name='4364'>
              VZ0(i,j)    = VZ0(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * VZ0_SEA(i,j)<a name='4365'>
              USTAR(i,j)  = USTAR(i,j)  * XICE(i,j) + (1.0-XICE(i,j)) * USTAR_SEA(i,j)<a name='4366'>
              <font color=#447700>! ZNT wait<a name='4367'></font>
              PBLH(i,j)   = PBLH(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * PBLH_SEA(i,j)<a name='4368'>
              RMOL(i,j)   = RMOL(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * RMOL_SEA(i,j)<a name='4369'>
              AKHS(i,j)   = AKHS(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * AKHS_SEA(i,j)<a name='4370'>
              AKMS(i,j)   = AKMS(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * AKMS_SEA(i,j)<a name='4371'>
<a name='4372'>
              <font color=#447700>!         tsk(i,j) = tsk(i,j)*XICE(i,j) + (1.0-XICE(i,j))*TSK_SEA(i,j)<a name='4373'></font>
           ELSE<a name='4374'>
              <font color=#447700>! We're not over sea ice.  Take the results from the first call.<a name='4375'></font>
           ENDIF<a name='4376'>
        ENDDO<a name='4377'>
     ENDDO<a name='4378'>
<a name='4379'>
   END SUBROUTINE myjsfc_seaice_wrapper<a name='4380'>
<a name='4381'>
<font color=#447700>!------------------------------------------------------------------------<a name='4382'></font>
<a name='4383'>
<A NAME='QNSESFC_SEAICE_WRAPPER'><A href='../../html_code/phys/module_surface_driver.F.html#QNSESFC_SEAICE_WRAPPER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4384'>
 <font color=#993300>subroutine </font><font color=#cc0000>qnsesfc_seaice_wrapper</font>(ITIMESTEP,HT,DZ,      &amp; <A href='../../call_to/QNSESFC_SEAICE_WRAPPER.html' TARGET='index'>1</A>,<A href='../../call_from/QNSESFC_SEAICE_WRAPPER.html' TARGET='index'>4</A><a name='4385'>
        &amp;     PMID,PINT,TH,T,QV,QC,U,V,Q2,                &amp;<a name='4386'>
        &amp;     TSK,QSFC,THZ0,QZ0,UZ0,VZ0,                  &amp;<a name='4387'>
        &amp;     LOWLYR,XLAND,       &amp;<a name='4388'>
        &amp;     TICE2TSK_IF2COLD,                           &amp;  <font color=#447700>! Extra for wrapper<a name='4389'></font>
        &amp;     XICE_THRESHOLD,                             &amp;  <font color=#447700>! Extra for wrapper<a name='4390'></font>
        &amp;     XICE,SST,                                   &amp;  <font color=#447700>! Extra for wrapper<a name='4391'></font>
        &amp;     CHS_SEA, CHS2_SEA, CQS2_SEA, CPM_SEA,       &amp;  <font color=#447700>! Extra for wrapper<a name='4392'></font>
        &amp;     FLHC_SEA, FLQC_SEA, QSFC_SEA,               &amp;  <font color=#447700>! Extra for wrapper<a name='4393'></font>
        &amp;     QGH_SEA, QZ0_SEA, HFX_SEA, QFX_SEA,         &amp;  <font color=#447700>! Extra for wrapper<a name='4394'></font>
        &amp;     FLX_LH_SEA, TSK_SEA,                        &amp;  <font color=#447700>! Extra for wrapper<a name='4395'></font>
        &amp;     USTAR,ZNT,Z0BASE,PBLH,MAVAIL,RMOL,          &amp;<a name='4396'>
        &amp;     AKHS,AKMS,                                  &amp;<a name='4397'>
        &amp;     BR,                                         &amp;<a name='4398'>
        &amp;     CHS,CHS2,CQS2,HFX,QFX,FLX_LH,FLHC,FLQC,     &amp;<a name='4399'>
        &amp;     QGH,CPM,CT,                                 &amp;<a name='4400'>
        &amp;     U10,V10,T02,TH02,TSHLTR,TH10,Q02,QSHLTR,Q10,PSHLTR,          &amp;<a name='4401'>
        &amp;     IDS,IDE,JDS,JDE,KDS,KDE,                        &amp;<a name='4402'>
        &amp;     IMS,IME,JMS,JME,KMS,KME,                        &amp;<a name='4403'>
        &amp;     ITS,ITE,JTS,JTE,KTS,KTE,SCM_FORCE_FLUX )<a name='4404'>
<font color=#447700>!     USE module_model_constants<a name='4405'></font>
     USE <A href='../../html_code/phys/module_sf_qnsesfc.F.html#MODULE_SF_QNSESFC'>module_sf_qnsesfc</A><A href='../../html_code/phys/module_surface_driver.F.html#QNSESFC_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_QNSESFC_3"><a name='4406'>
<a name='4407'>
     IMPLICIT NONE<a name='4408'>
<a name='4409'>
     INTEGER,                                INTENT(IN)    :: ITIMESTEP<a name='4410'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: HT<a name='4411'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: DZ<a name='4412'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: PMID<a name='4413'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: PINT<a name='4414'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: TH<a name='4415'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: T<a name='4416'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: QV<a name='4417'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: QC<a name='4418'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: U<a name='4419'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: V<a name='4420'>
     REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN)    :: Q2   <font color=#447700>! Q2 is TKE?<a name='4421'></font>
<a name='4422'>
     <font color=#447700>! REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: TSK<a name='4423'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT)    :: TSK<a name='4424'>
<a name='4425'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: QSFC<a name='4426'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: THZ0<a name='4427'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: QZ0<a name='4428'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: UZ0<a name='4429'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: VZ0<a name='4430'>
     INTEGER,DIMENSION(IMS:IME,JMS:JME),     INTENT(IN)    :: LOWLYR<a name='4431'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: XLAND<a name='4432'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: XICE       <font color=#447700>! Extra for wrapper<a name='4433'></font>
     <font color=#447700>! REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: SST        ! Extra for wrapper<a name='4434'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: SST        <font color=#447700>! Extra for wrapper<a name='4435'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: BR<a name='4436'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CHS_SEA    <font color=#447700>! Extra for wrapper<a name='4437'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CHS2_SEA   <font color=#447700>! Extra for wrapper<a name='4438'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CQS2_SEA   <font color=#447700>! Extra for wrapper<a name='4439'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CPM_SEA    <font color=#447700>! Extra for wrapper<a name='4440'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QZ0_SEA   <font color=#447700>! Extra for wrapper<a name='4441'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QSFC_SEA   <font color=#447700>! Extra for wrapper<a name='4442'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QGH_SEA   <font color=#447700>! Extra for wrapper<a name='4443'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLHC_SEA  <font color=#447700>! Extra for wrapper<a name='4444'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLQC_SEA  <font color=#447700>! Extra for wrapper<a name='4445'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: HFX_SEA    <font color=#447700>! Extra for wrapper<a name='4446'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QFX_SEA    <font color=#447700>! Extra for wrapper<a name='4447'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLX_LH_SEA <font color=#447700>! Extra for wrapper<a name='4448'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: TSK_SEA    <font color=#447700>! Extra for wrapper<a name='4449'></font>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: USTAR<a name='4450'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: ZNT<a name='4451'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: Z0BASE<a name='4452'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: PBLH<a name='4453'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(IN)    :: MAVAIL<a name='4454'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: RMOL<a name='4455'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: AKHS<a name='4456'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(INOUT) :: AKMS<a name='4457'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CHS<a name='4458'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CHS2<a name='4459'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CQS2<a name='4460'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: HFX<a name='4461'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QFX<a name='4462'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLX_LH<a name='4463'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLHC<a name='4464'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: FLQC<a name='4465'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QGH<a name='4466'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CPM<a name='4467'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: CT<a name='4468'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: U10<a name='4469'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: V10<a name='4470'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: T02<a name='4471'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: TH02<a name='4472'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: TSHLTR<a name='4473'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: TH10<a name='4474'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: Q02<a name='4475'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: QSHLTR<a name='4476'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: Q10<a name='4477'>
     REAL,DIMENSION(IMS:IME,JMS:JME),        INTENT(OUT)   :: PSHLTR<a name='4478'>
     REAL,                                   INTENT(IN)    :: XICE_THRESHOLD<a name='4479'>
     LOGICAL,                                INTENT(IN)    :: TICE2TSK_IF2COLD<a name='4480'>
     INTEGER,                                INTENT(IN)    :: SCM_FORCE_FLUX<a name='4481'>
     INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE,       &amp;<a name='4482'>
          &amp;                IMS,IME,JMS,JME,KMS,KME,       &amp;<a name='4483'>
          &amp;                ITS,ITE,JTS,JTE,KTS,KTE<a name='4484'>
<a name='4485'>
<a name='4486'>
     <font color=#447700>! Local<a name='4487'></font>
     INTEGER :: i<a name='4488'>
     INTEGER :: j<a name='4489'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: ct_sea<a name='4490'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: u10_sea<a name='4491'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: v10_sea<a name='4492'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: t02_sea<a name='4493'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: th02_sea<a name='4494'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: tshltr_sea<a name='4495'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: pshltr_sea<a name='4496'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: qshltr_sea<a name='4497'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: th10_sea<a name='4498'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: q02_sea<a name='4499'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: q10_sea<a name='4500'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: thz0_sea<a name='4501'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: uz0_sea<a name='4502'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: vz0_sea<a name='4503'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: ustar_sea<a name='4504'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: pblh_sea<a name='4505'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: rmol_sea<a name='4506'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: akhs_sea<a name='4507'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: akms_sea<a name='4508'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: xland_sea<a name='4509'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: mavail_sea<a name='4510'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: znt_sea<a name='4511'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: z0base_sea<a name='4512'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: br_sea<a name='4513'>
<a name='4514'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: QSFC_HOLD<a name='4515'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: QZ0_HOLD<a name='4516'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: THZ0_HOLD<a name='4517'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: UZ0_HOLD<a name='4518'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: VZ0_HOLD<a name='4519'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: USTAR_HOLD<a name='4520'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: ZNT_HOLD<a name='4521'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: PBLH_HOLD<a name='4522'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: RMOL_HOLD<a name='4523'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: AKHS_HOLD<a name='4524'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: AKMS_HOLD<a name='4525'>
     REAL, DIMENSION( ims:ime, jms:jme ) :: TSK_LOCAL<a name='4526'>
     REAL :: PSFC<a name='4527'>
<a name='4528'>
     <font color=#447700>! Set things up for the frozen-surface call to qnsesfc<a name='4529'></font>
<a name='4530'>
     <font color=#447700>! We want a TSK valid for the ice-covered regions of the grid cell.<a name='4531'></font>
<a name='4532'>
     CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#QNSESFC_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_6">( ims, ime, jms, jme, its, ite, jts, jte,  &amp;<a name='4533'>
                             itimestep, .true., tice2tsk_if2cold,     &amp;<a name='4534'>
                             XICE, XICE_THRESHOLD,                    &amp;<a name='4535'>
                             SST, TSK, TSK_SEA, TSK_LOCAL )<a name='4536'>
     DO j = JTS , JTE<a name='4537'>
        DO i = ITS , ITE<a name='4538'>
           TSK(i,j) = TSK_LOCAL(i,j)<a name='4539'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='4540'>
<a name='4541'>
              <font color=#447700>! Over fractional sea-ice points, back out an ice portion of QSFC as well.<a name='4542'></font>
              <font color=#447700>! QSFC_SEA calculation as done in qnsesfc for open water points<a name='4543'></font>
              PSFC = PINT(I,LOWLYR(I,J),J)<a name='4544'>
              QSFC_SEA(i,j) = PQ0SEA/PSFC*EXP(A2S*(TSK(i,j)-A3S)/(TSK(i,j)-A4S))<a name='4545'>
              QSFC(i,j) = QSFC(i,j) - (1.0-XICE(i,j)) * QSFC_SEA(i,j) / XICE(i,j)<a name='4546'>
<font color=#447700>!<a name='4547'></font>
              HFX_SEA(i,j)  = HFX(i,j)<a name='4548'>
              QFX_SEA(i,j)  = QFX(i,j)<a name='4549'>
              FLX_LH_SEA(i,j)   = FLX_LH(i,j)<a name='4550'>
           ENDIF<a name='4551'>
        ENDDO<a name='4552'>
     ENDDO<a name='4553'>
<a name='4554'>
<font color=#447700>!<a name='4555'></font>
<font color=#447700>! frozen ocean call for sea ice points<a name='4556'></font>
<font color=#447700>!<a name='4557'></font>
<a name='4558'>
<font color=#447700>! Strictly INTENT(IN) to QNSESFC, should be unchanged by call.<a name='4559'></font>
<a name='4560'>
     <font color=#447700>! DZ<a name='4561'></font>
     <font color=#447700>! HT<a name='4562'></font>
     <font color=#447700>! LOWLYR<a name='4563'></font>
     <font color=#447700>! MAVAIL<a name='4564'></font>
     <font color=#447700>! PINT<a name='4565'></font>
     <font color=#447700>! PMID<a name='4566'></font>
     <font color=#447700>! QC<a name='4567'></font>
     <font color=#447700>! QV<a name='4568'></font>
     <font color=#447700>! Q2<a name='4569'></font>
     <font color=#447700>! T<a name='4570'></font>
     <font color=#447700>! TH<a name='4571'></font>
     <font color=#447700>! TSK<a name='4572'></font>
     <font color=#447700>! U<a name='4573'></font>
     <font color=#447700>! V<a name='4574'></font>
     <font color=#447700>! XLAND<a name='4575'></font>
     <font color=#447700>! Z0BASE<a name='4576'></font>
<a name='4577'>
<font color=#447700>! INTENT (INOUT),  updated by QNSESFC.  Values will need to be saved before the first call to QNSESFC, so that<a name='4578'></font>
<font color=#447700>! the second call to QNSESFC does not double-count the effect.<a name='4579'></font>
<a name='4580'>
     <font color=#447700>! Save INTENT(INOUT) variables before the frozen-water/true-land call to QNSESFC:<a name='4581'></font>
     QSFC_HOLD  = QSFC<a name='4582'>
     QZ0_HOLD   = QZ0<a name='4583'>
     THZ0_HOLD  = THZ0<a name='4584'>
     UZ0_HOLD   = UZ0<a name='4585'>
     VZ0_HOLD   = VZ0<a name='4586'>
     USTAR_HOLD = USTAR<a name='4587'>
     ZNT_HOLD   = ZNT<a name='4588'>
     PBLH_HOLD  = PBLH<a name='4589'>
     RMOL_HOLD  = RMOL<a name='4590'>
     AKHS_HOLD  = AKHS<a name='4591'>
     AKMS_HOLD  = AKMS<a name='4592'>
<a name='4593'>
<font color=#447700>! Strictly INTENT(OUT):  Set by QNSESFC<a name='4594'></font>
<a name='4595'>
     <font color=#447700>! CHS<a name='4596'></font>
     <font color=#447700>! CHS2<a name='4597'></font>
     <font color=#447700>! CPM<a name='4598'></font>
     <font color=#447700>! CQS2<a name='4599'></font>
     <font color=#447700>! CT<a name='4600'></font>
     <font color=#447700>! FLHC<a name='4601'></font>
     <font color=#447700>! FLQC<a name='4602'></font>
     <font color=#447700>! FLX_LH<a name='4603'></font>
     <font color=#447700>! HFX<a name='4604'></font>
     <font color=#447700>! PSHLTR<a name='4605'></font>
     <font color=#447700>! QFX<a name='4606'></font>
     <font color=#447700>! QGH<a name='4607'></font>
     <font color=#447700>! QSHLTR<a name='4608'></font>
     <font color=#447700>! Q02<a name='4609'></font>
     <font color=#447700>! Q10<a name='4610'></font>
     <font color=#447700>! TH02<a name='4611'></font>
     <font color=#447700>! TH10<a name='4612'></font>
     <font color=#447700>! TSHLTR<a name='4613'></font>
     <font color=#447700>! T02<a name='4614'></font>
     <font color=#447700>! U10<a name='4615'></font>
     <font color=#447700>! V10<a name='4616'></font>
<a name='4617'>
     <font color=#447700>! Frozen-water/true-land call.<a name='4618'></font>
     CALL <A href='../../html_code/phys/module_sf_qnsesfc.F.html#QNSESFC'>QNSESFC</A><A href='../../html_code/phys/module_surface_driver.F.html#QNSESFC_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QNSESFC_2"> ( ITIMESTEP, HT, DZ,                              &amp;  <font color=#447700>! I,I,I,<a name='4619'></font>
          &amp;        PMID, PINT, TH, T, QV, QC, U, V, Q2,            &amp;  <font color=#447700>! I,I,I,I,I,I,I,I,I,<a name='4620'></font>
          &amp;        TSK, QSFC, THZ0, QZ0, UZ0, VZ0,                 &amp;  <font color=#447700>! I,IO,IO,IO,IO,IO,<a name='4621'></font>
          &amp;        LOWLYR, XLAND,      &amp;  <font color=#447700>! I,I<a name='4622'></font>
          &amp;        USTAR, ZNT, Z0BASE, PBLH, MAVAIL, RMOL,         &amp;  <font color=#447700>! IO,IO,I,IO,I,IO,<a name='4623'></font>
          &amp;        AKHS, AKMS,                                     &amp;  <font color=#447700>! IO,IO,<a name='4624'></font>
          &amp;        BR,                                             &amp;  <font color=#447700>! O<a name='4625'></font>
          &amp;        CHS, CHS2, CQS2, HFX, QFX, FLX_LH, FLHC, FLQC,  &amp;  <font color=#447700>! O,O,O,0,0,0,0,0,<a name='4626'></font>
          &amp;        QGH, CPM, CT, U10, V10,T02,TH02,                    &amp;  <font color=#447700>! 0,0,0,0,0,0,0<a name='4627'></font>
          &amp;        TSHLTR, TH10, Q02,                    &amp;  <font color=#447700>! 0,0,0<a name='4628'></font>
          &amp;        QSHLTR, Q10, PSHLTR,                            &amp;  <font color=#447700>! 0,0,0,<a name='4629'></font>
          &amp;        ids,ide, jds,jde, kds,kde,                      &amp;<a name='4630'>
          &amp;        ims,ime, jms,jme, kms,kme,                      &amp;<a name='4631'>
          &amp;        its,ite, jts,jte, kts,kte, SCM_FORCE_FLUX    )<a name='4632'>
<a name='4633'>
     <font color=#447700>! Set up things for the open ocean call.<a name='4634'></font>
     DO j = JTS, JTE<a name='4635'>
        DO i = ITS, ITE<a name='4636'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .AND. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='4637'>
              XLAND_SEA(i,j)=2.<a name='4638'>
              MAVAIL_SEA(I,J)  = 1.<a name='4639'>
              ZNT_SEA(I,J) = 0.0001<a name='4640'>
              Z0BASE_SEA(I,J) = ZNT_SEA(I,J)<a name='4641'>
              IF ( SST(i,j) .LT. 271.4 ) THEN<a name='4642'>
                 SST(i,j) = 271.4<a name='4643'>
              ENDIF<a name='4644'>
              TSK_SEA(i,j) = SST(i,j)<a name='4645'>
              PSFC = PINT(I,LOWLYR(I,J),J)<a name='4646'>
              QSFC_SEA(I,J) = PQ0SEA/PSFC*EXP(A2S*(TSK_SEA(i,j)-A3S)/(TSK_SEA(i,j)-A4S))<a name='4647'>
           ELSE<a name='4648'>
              <font color=#447700>! This should be a land point or a true open water point<a name='4649'></font>
              XLAND_SEA(i,j)=xland(i,j)<a name='4650'>
              MAVAIL_SEA(i,j) = mavail(i,j)<a name='4651'>
              ZNT_SEA(I,J)    = ZNT_HOLD(I,J)<a name='4652'>
              Z0BASE_SEA(I,J) = Z0BASE(I,J)<a name='4653'>
              TSK_SEA(i,j)  = TSK(i,j)<a name='4654'>
              QSFC_SEA(i,j) = QSFC_HOLD(i,j)<a name='4655'>
           ENDIF<a name='4656'>
        ENDDO<a name='4657'>
     ENDDO<a name='4658'>
<a name='4659'>
     QZ0_SEA  = QZ0_HOLD<a name='4660'>
     THZ0_SEA = THZ0_HOLD<a name='4661'>
     UZ0_SEA  = UZ0_HOLD<a name='4662'>
     VZ0_SEA  = VZ0_HOLD<a name='4663'>
     USTAR_SEA = USTAR_HOLD<a name='4664'>
     PBLH_SEA = PBLH_HOLD<a name='4665'>
     RMOL_SEA = RMOL_HOLD<a name='4666'>
     AKHS_SEA = AKHS_HOLD<a name='4667'>
     AKMS_SEA = AKMS_HOLD<a name='4668'>
<a name='4669'>
<font color=#447700>!<a name='4670'></font>
<font color=#447700>! open water call<a name='4671'></font>
<font color=#447700>!<a name='4672'></font>
     CALL <A href='../../html_code/phys/module_sf_qnsesfc.F.html#QNSESFC'>QNSESFC</A><A href='../../html_code/phys/module_surface_driver.F.html#QNSESFC_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QNSESFC_3"> ( ITIMESTEP, HT, DZ,                                                          &amp; <font color=#447700>! I,I,I,<a name='4673'></font>
          &amp;        PMID, PINT, TH, T, QV, QC, U, V, Q2,                                        &amp; <font color=#447700>! I,I,I,I,I,I,I,I,I,<a name='4674'></font>
          &amp;        TSK_SEA, QSFC_SEA, THZ0_SEA, QZ0_SEA, UZ0_SEA, VZ0_SEA,                     &amp; <font color=#447700>! I,IO,IO,IO,IO,IO,<a name='4675'></font>
          &amp;        LOWLYR, XLAND_SEA,                             &amp; <font color=#447700>! I,I,<a name='4676'></font>
          &amp;        USTAR_SEA, ZNT_SEA, Z0BASE_SEA, PBLH_SEA, MAVAIL_SEA, RMOL_SEA,             &amp; <font color=#447700>! IO,IO,I,IO,I,IO,<a name='4677'></font>
          &amp;        AKHS_SEA, AKMS_SEA,                                                         &amp; <font color=#447700>! IO,IO,<a name='4678'></font>
          &amp;        BR_SEA,                                                                     &amp; <font color=#447700>! dummy space holder<a name='4679'></font>
          &amp;        CHS_SEA, CHS2_SEA, CQS2_SEA, HFX_SEA, QFX_SEA, FLX_LH_SEA, FLHC_SEA,        &amp; <font color=#447700>! 0,0,0,0,0,0,0,<a name='4680'></font>
          &amp;        FLQC_SEA, QGH_SEA, CPM_SEA, CT_SEA, U10_SEA, V10_SEA,T02_SEA,TH02_SEA,   &amp; <font color=#447700>! 0,0,0,0,0,0,0,0<a name='4681'></font>
          &amp;        TSHLTR_SEA, TH10_SEA, Q02_SEA, QSHLTR_SEA, Q10_SEA, PSHLTR_SEA,             &amp; <font color=#447700>! 0,0,0,0,0,0<a name='4682'></font>
          &amp;        ids,ide, jds,jde, kds,kde,                                                  &amp;<a name='4683'>
          &amp;        ims,ime, jms,jme, kms,kme,                                                  &amp;<a name='4684'>
          &amp;        its,ite, jts,jte, kts,kte, SCM_FORCE_FLUX    )<a name='4685'>
<a name='4686'>
<font color=#447700>!<a name='4687'></font>
<font color=#447700>! Scale the appropriate terms between open-water values and ice-covered values<a name='4688'></font>
         <a name='4689'>
<a name='4690'>
     DO j = JTS, JTE<a name='4691'>
        DO i = ITS, ITE<a name='4692'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='4693'>
              <font color=#447700>! Over sea-ice points, blend the results.<a name='4694'></font>
<a name='4695'>
              <font color=#447700>! INTENT(OUT) from QNSESFC<a name='4696'></font>
              <font color=#447700>! CHS  wait<a name='4697'></font>
              <font color=#447700>! CHS2 wait<a name='4698'></font>
              <font color=#447700>! CPM  wait<a name='4699'></font>
              <font color=#447700>! CQS2 wait<a name='4700'></font>
              CT(i,j)     = CT(i,j)     * XICE(i,j) + (1.0-XICE(i,j)) * CT_SEA (i,j)<a name='4701'>
              <font color=#447700>! FLHC(i,j)   = FLHC(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * FLHC_SEA (i,j)<a name='4702'></font>
              <font color=#447700>! FLQC(i,j)   = FLQC(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * FLQC_SEA (i,j)<a name='4703'></font>
              <font color=#447700>! FLX_LH wait<a name='4704'></font>
              <font color=#447700>! HFX  wait<a name='4705'></font>
              PSHLTR(i,j) = PSHLTR(i,j) * XICE(i,j) + (1.0-XICE(i,j)) * PSHLTR_SEA(i,j)<a name='4706'>
              <font color=#447700>! QFX  wait<a name='4707'></font>
              <font color=#447700>! QGH  wait<a name='4708'></font>
              QSHLTR(i,j) = QSHLTR(i,j) * XICE(i,j) + (1.0-XICE(i,j)) * QSHLTR_SEA(i,j)<a name='4709'>
              Q10(i,j)    = Q10(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * Q10_SEA(i,j)<a name='4710'>
              Q02(i,j)    = Q02(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * Q02_SEA(i,j)<a name='4711'>
              TH10(i,j)   = TH10(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * TH10_SEA(i,j)<a name='4712'>
               TH02(i,j)   = TH02(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * TH02_SEA(i,j)<a name='4713'>
              TSHLTR(i,j) = TSHLTR(i,j) * XICE(i,j) + (1.0-XICE(i,j)) * TSHLTR_SEA(i,j)<a name='4714'>
              T02(i,j)    = T02(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * T02_SEA(i,j)<a name='4715'>
              U10(i,j)    = U10(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * U10_SEA(i,j)<a name='4716'>
              V10(i,j)    = V10(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * V10_SEA(i,j)<a name='4717'>
<a name='4718'>
              <font color=#447700>! INTENT(INOUT):  updated by QNSESFC<a name='4719'></font>
              <font color=#447700>! QSFC:  wait<a name='4720'></font>
              THZ0(i,j)   = THZ0(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * THZ0_SEA(i,j)<a name='4721'>
              <font color=#447700>! qz0 wait<a name='4722'></font>
              UZ0(i,j)    = UZ0(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * UZ0_SEA(i,j)<a name='4723'>
              VZ0(i,j)    = VZ0(i,j)    * XICE(i,j) + (1.0-XICE(i,j)) * VZ0_SEA(i,j)<a name='4724'>
              USTAR(i,j)  = USTAR(i,j)  * XICE(i,j) + (1.0-XICE(i,j)) * USTAR_SEA(i,j)<a name='4725'>
              <font color=#447700>! ZNT wait<a name='4726'></font>
              PBLH(i,j)   = PBLH(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * PBLH_SEA(i,j)<a name='4727'>
              RMOL(i,j)   = RMOL(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * RMOL_SEA(i,j)<a name='4728'>
              AKHS(i,j)   = AKHS(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * AKHS_SEA(i,j)<a name='4729'>
              AKMS(i,j)   = AKMS(i,j)   * XICE(i,j) + (1.0-XICE(i,j)) * AKMS_SEA(i,j)<a name='4730'>
<a name='4731'>
              <font color=#447700>!         tsk(i,j) = tsk(i,j)*XICE(i,j) + (1.0-XICE(i,j))*TSK_SEA(i,j)<a name='4732'></font>
           ELSE<a name='4733'>
              <font color=#447700>! We're not over sea ice.  Take the results from the first call.<a name='4734'></font>
           ENDIF<a name='4735'>
        ENDDO<a name='4736'>
     ENDDO<a name='4737'>
<a name='4738'>
   END SUBROUTINE qnsesfc_seaice_wrapper<a name='4739'>
<a name='4740'>
<a name='4741'>
<font color=#447700>!-------------------------------------------------------------------------<a name='4742'></font>
<a name='4743'>
<A NAME='MYNN_SEAICE_WRAPPER'><A href='../../html_code/phys/module_surface_driver.F.html#MYNN_SEAICE_WRAPPER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4744'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>mynn_seaice_wrapper</font>(U3D,V3D,T3D,QV3D,P3D,dz8w,     &amp; <A href='../../call_to/MYNN_SEAICE_WRAPPER.html' TARGET='index'>1</A>,<A href='../../call_from/MYNN_SEAICE_WRAPPER.html' TARGET='index'>4</A><a name='4745'>
                     CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,      &amp;<a name='4746'>
                     ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='4747'>
                     XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='4748'>
                     U10,V10,TH2,T2,Q2,SNOWH,                      &amp;<a name='4749'>
                     GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='4750'>
                     SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,          &amp;<a name='4751'>
               &amp;itimestep,ch,th3d,pi3d,qc3d,rho,                   &amp;<a name='4752'>
               &amp;tsq,qsq,cov,Sh3d,el_pbl,qcg,                       &amp;<a name='4753'>
               &amp;icloud_bl,qc_bl,cldfra_bl,                         &amp;<a name='4754'>
               &amp;spp_pbl,pattern_spp_pbl,                           &amp;<a name='4755'>
XICE,SST,TSK_SEA,                                                  &amp;<a name='4756'>
CHS2_SEA,CHS_SEA,CPM_SEA,CQS2_SEA,FLHC_SEA,FLQC_SEA,               &amp;<a name='4757'>
HFX_SEA,LH_SEA,QFX_SEA,QGH_SEA,QSFC_SEA,ZNT_SEA,                   &amp;<a name='4758'>
TICE2TSK_IF2COLD,XICE_THRESHOLD,                                   &amp;<a name='4759'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='4760'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='4761'>
                     its,ite, jts,jte, kts,kte,                    &amp;<a name='4762'>
               ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,bl_mynn_cloudpdf)<a name='4763'>
<a name='4764'>
     USE <A href='../../html_code/phys/module_sf_mynn.F.html#MODULE_SF_MYNN'>module_sf_mynn</A><A href='../../html_code/phys/module_surface_driver.F.html#MYNN_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_MYNN_3">, ONLY: sfclay_mynn<a name='4765'>
     implicit none<a name='4766'>
<a name='4767'>
     INTEGER,  INTENT(IN )   ::        ids,ide, jds,jde, kds,kde,  &amp;<a name='4768'>
                                       ims,ime, jms,jme, kms,kme,  &amp;<a name='4769'>
                                       its,ite, jts,jte, kts,kte<a name='4770'>
<a name='4771'>
     INTEGER,  INTENT(IN )   ::        ISFFLX,bl_mynn_cloudpdf,icloud_bl<a name='4772'>
     REAL,     INTENT(IN )   ::        SVP1,SVP2,SVP3,SVPT0<a name='4773'>
     REAL,     INTENT(IN )   ::        EP1,EP2,KARMAN<a name='4774'>
<a name='4775'>
     INTEGER,  INTENT(IN)      ::     spp_pbl<a name='4776'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )             &amp;<a name='4777'>
                             ::   pattern_spp_pbl<a name='4778'>
<a name='4779'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='4780'>
               INTENT(IN   )   ::                           dz8w<a name='4781'>
<a name='4782'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='4783'>
               INTENT(IN   )   ::                           QV3D, &amp;<a name='4784'>
                                                             P3D, &amp;<a name='4785'>
                                                             T3D,rho<a name='4786'>
<a name='4787'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='4788'>
               INTENT(IN   )               ::             MAVAIL, &amp;<a name='4789'>
                                                            PBLH, &amp;<a name='4790'>
                                                           XLAND<a name='4791'>
<a name='4792'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='4793'>
               INTENT(OUT  )               ::                U10, &amp;<a name='4794'>
                                                             V10, &amp;<a name='4795'>
                                                             TH2, &amp;<a name='4796'>
                                                              T2, &amp;<a name='4797'>
                                                              Q2, &amp;<a name='4798'>
                                                            QSFC,SNOWH<a name='4799'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='4800'>
               INTENT(INOUT)               ::             REGIME, &amp;<a name='4801'>
                                                             HFX, &amp;<a name='4802'>
                                                             QFX, &amp;<a name='4803'>
                                                              LH, &amp;<a name='4804'>
                                                         MOL,RMOL,TSK<a name='4805'>
<a name='4806'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='4807'>
               INTENT(INOUT)   ::                 GZ1OZ0,WSPD,BR, &amp;<a name='4808'>
                                                        PSIM,PSIH<a name='4809'>
<a name='4810'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='4811'>
               INTENT(IN   )   ::                            U3D, &amp;<a name='4812'>
                                                             V3D<a name='4813'>
<a name='4814'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='4815'>
               INTENT(IN   )               ::               PSFC<a name='4816'>
<a name='4817'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='4818'>
               INTENT(INOUT)   ::                            ZNT, &amp;<a name='4819'>
                                                             ZOL, &amp;<a name='4820'>
                                                             UST, &amp;<a name='4821'>
                                                             CPM, &amp;<a name='4822'>
                                                            CHS2, &amp;<a name='4823'>
                                                            CQS2, &amp;<a name='4824'>
                                                             CHS<a name='4825'>
<a name='4826'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='4827'>
               INTENT(INOUT)   ::                      FLHC,FLQC<a name='4828'>
<a name='4829'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='4830'>
               INTENT(INOUT)   ::                                 &amp;<a name='4831'>
                                                              QGH<a name='4832'>
<a name='4833'>
     REAL,     INTENT(IN   )               ::   CP,G,ROVCP,R,XLV,DX<a name='4834'>
<font color=#447700>! from mynn subroutine<a name='4835'></font>
     INTEGER, INTENT(in) :: itimestep<a name='4836'>
     REAL,     DIMENSION( ims:ime, jms:jme ), INTENT(IN) :: qcg<a name='4837'>
     REAL,     DIMENSION( ims:ime, jms:jme ), INTENT(INOUT) :: ch<a name='4838'>
     REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) ::     &amp;<a name='4839'>
                                                             &amp;QC3D,&amp;<a name='4840'>
                            &amp;th3d,pi3d,tsq,qsq,cov,Sh3d,el_pbl,&amp;<a name='4841'>
                                              &amp;qc_bl,cldfra_bl<a name='4842'>
<a name='4843'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme )              , &amp;<a name='4844'>
               INTENT(OUT)     ::                   ck,cka,cd,cda<a name='4845'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme )              , &amp;<a name='4846'>
               INTENT(INOUT)   ::                            ustm<a name='4847'>
     INTEGER,  OPTIONAL,  INTENT(IN )   ::     ISFTCFLX,IZ0TLND<a name='4848'>
<a name='4849'>
<font color=#447700>!--------------------------------------------------------------------<a name='4850'></font>
<font color=#447700>!    New for wrapper<a name='4851'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='4852'></font>
     LOGICAL,  INTENT(IN)               ::      TICE2TSK_IF2COLD<a name='4853'>
     REAL,     INTENT(IN)               ::      XICE_THRESHOLD<a name='4854'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='4855'>
               INTENT(IN)               ::      XICE<a name='4856'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='4857'>
               INTENT(INOUT)            ::      SST<a name='4858'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='4859'>
               INTENT(OUT)              ::      TSK_SEA,          &amp;<a name='4860'>
                                                CHS2_SEA,         &amp;<a name='4861'>
                                                CHS_SEA,          &amp;<a name='4862'>
                                                CPM_SEA,          &amp;<a name='4863'>
                                                CQS2_SEA,         &amp;<a name='4864'>
                                                FLHC_SEA,         &amp;<a name='4865'>
                                                FLQC_SEA,         &amp;<a name='4866'>
                                                HFX_SEA,          &amp;<a name='4867'>
                                                LH_SEA,           &amp;<a name='4868'>
                                                QFX_SEA,          &amp;<a name='4869'>
                                                QGH_SEA,          &amp;<a name='4870'>
                                                QSFC_SEA,         &amp;<a name='4871'>
                                                ZNT_SEA<a name='4872'>
<a name='4873'>
<font color=#447700>!--------------------------------------------------------------------<a name='4874'></font>
<font color=#447700>!    Local<a name='4875'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='4876'></font>
     INTEGER :: I, J<a name='4877'>
     REAL,     DIMENSION( ims:ime, jms:jme ) :: XLAND_SEA,        &amp;<a name='4878'>
                                                MAVAIL_sea,       &amp;<a name='4879'>
                                                TSK_LOCAL,        &amp;<a name='4880'>
                                                BR_HOLD,          &amp;<a name='4881'>
                                                CHS2_HOLD,        &amp;<a name='4882'>
                                                CHS_HOLD,         &amp;<a name='4883'>
                                                CPM_HOLD,         &amp;<a name='4884'>
                                                CQS2_HOLD,        &amp;<a name='4885'>
                                                FLHC_HOLD,        &amp;<a name='4886'>
                                                FLQC_HOLD,        &amp;<a name='4887'>
                                                GZ1OZ0_HOLD,      &amp;<a name='4888'>
                                                HFX_HOLD,         &amp;<a name='4889'>
                                                LH_HOLD,          &amp;<a name='4890'>
                                                MOL_HOLD,         &amp;<a name='4891'>
                                                PSIH_HOLD,        &amp;<a name='4892'>
                                                PSIM_HOLD,        &amp;<a name='4893'>
                                                QFX_HOLD,         &amp;<a name='4894'>
                                                QGH_HOLD,         &amp;<a name='4895'>
                                                REGIME_HOLD,      &amp;<a name='4896'>
                                                RMOL_HOLD,        &amp;<a name='4897'>
                                                UST_HOLD,         &amp;<a name='4898'>
                                                WSPD_HOLD,        &amp;<a name='4899'>
                                                ZNT_HOLD,         &amp;<a name='4900'>
                                                CH_HOLD,          &amp; <font color=#447700>! new<a name='4901'></font>
                                                ZOL_HOLD,         &amp;<a name='4902'>
                                                Q2_SEA,           &amp;<a name='4903'>
                                                T2_SEA,           &amp;<a name='4904'>
                                                TH2_SEA,          &amp;<a name='4905'>
                                                U10_SEA,          &amp;<a name='4906'>
                                                V10_SEA,          &amp;<a name='4907'>
                                                CD_SEA,           &amp;<a name='4908'>
                                                CDA_SEA,          &amp;<a name='4909'>
                                                CK_SEA,           &amp;<a name='4910'>
                                                CKA_SEA,          &amp;<a name='4911'>
                                                USTM_SEA<a name='4912'>
<a name='4913'>
     REAL,     DIMENSION( ims:ime, jms:jme ) ::                   &amp;<a name='4914'>
                                                BR_SEA,           &amp;<a name='4915'>
                                                GZ1OZ0_SEA,       &amp;<a name='4916'>
                                                MOL_SEA,          &amp;<a name='4917'>
                                                PSIH_SEA,         &amp;<a name='4918'>
                                                PSIM_SEA,         &amp;<a name='4919'>
                                                REGIME_SEA,       &amp;<a name='4920'>
                                                RMOL_SEA,         &amp;<a name='4921'>
                                                UST_SEA,          &amp;<a name='4922'>
                                                WSPD_SEA,         &amp;<a name='4923'>
                                                CH_SEA,           &amp; <font color=#447700>! new<a name='4924'></font>
                                                ZOL_SEA<a name='4925'>
<font color=#447700>! INTENT(IN) to SFCLAY; unchanged by the call<a name='4926'></font>
      <font color=#447700>! ISFFLX<a name='4927'></font>
      <font color=#447700>! SVP1,SVP2,SVP3,SVPT0<a name='4928'></font>
      <font color=#447700>! EP1,EP2,KARMAN,EOMEG,STBOLT<a name='4929'></font>
      <font color=#447700>! CP,G,ROVCP,R,XLV,DX<a name='4930'></font>
      <font color=#447700>! dz8w<a name='4931'></font>
      <font color=#447700>! QV3D<a name='4932'></font>
      <font color=#447700>! P3D<a name='4933'></font>
      <font color=#447700>! T3D<a name='4934'></font>
      <font color=#447700>! MAVAIL<a name='4935'></font>
      <font color=#447700>! PBLH<a name='4936'></font>
      <font color=#447700>! XLAND<a name='4937'></font>
      <font color=#447700>! TSK<a name='4938'></font>
      <font color=#447700>! U3D<a name='4939'></font>
      <font color=#447700>! V3D<a name='4940'></font>
      <font color=#447700>! PSFC<a name='4941'></font>
<a name='4942'>
    CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#MYNN_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_7">( ims, ime, jms, jme, its, ite, jts, jte,  &amp;<a name='4943'>
                             itimestep, .true., tice2tsk_if2cold,     &amp;<a name='4944'>
                             XICE, XICE_THRESHOLD,                    &amp;<a name='4945'>
                             SST, TSK, TSK_SEA, TSK_LOCAL )<a name='4946'>
<a name='4947'>
<font color=#447700>! DFS 8/25/10 Set TSK to ice value<a name='4948'></font>
    DO j = JTS , JTE<a name='4949'>
        DO i = ITS , ITE<a name='4950'>
            TSK(i,j) = TSK_LOCAL(i,j)<a name='4951'>
        ENDDO<a name='4952'>
    ENDDO<a name='4953'>
<a name='4954'>
<font color=#447700>! INTENT (INOUT) to SFCLAY:  Save the variables before the first call<a name='4955'></font>
<font color=#447700>! (for land/frozen water) to SFCLAY, to keep from double-counting the<a name='4956'></font>
<font color=#447700>! effects of that routine<a name='4957'></font>
     BR_HOLD   = BR<a name='4958'>
     CHS2_HOLD = CHS2<a name='4959'>
     CHS_HOLD  = CHS<a name='4960'>
     CPM_HOLD  = CPM<a name='4961'>
     CQS2_HOLD = CQS2<a name='4962'>
     FLHC_HOLD = FLHC<a name='4963'>
     FLQC_HOLD = FLQC<a name='4964'>
     GZ1OZ0_HOLD = GZ1OZ0<a name='4965'>
     HFX_HOLD  = HFX<a name='4966'>
     LH_HOLD   = LH<a name='4967'>
     MOL_HOLD  = MOL<a name='4968'>
     PSIH_HOLD = PSIH<a name='4969'>
     PSIM_HOLD = PSIM<a name='4970'>
     QFX_HOLD  = QFX<a name='4971'>
     QGH_HOLD  = QGH<a name='4972'>
     REGIME_HOLD = REGIME<a name='4973'>
     RMOL_HOLD = RMOL<a name='4974'>
     UST_HOLD  = UST<a name='4975'>
     WSPD_HOLD = WSPD<a name='4976'>
     ZNT_HOLD  = ZNT<a name='4977'>
     ZOL_HOLD  = ZOL<a name='4978'>
     CH_HOLD   = CH<a name='4979'>
<a name='4980'>
<font color=#447700>! INTENT(OUT) from SFCLAY.  Input shouldn't matter, but we'll want to<a name='4981'></font>
<font color=#447700>! keep things around for weighting after the second call to SFCLAY.<a name='4982'></font>
     <font color=#447700>! Q2<a name='4983'></font>
     <font color=#447700>! QSFC<a name='4984'></font>
     <font color=#447700>! T2<a name='4985'></font>
     <font color=#447700>! TH2<a name='4986'></font>
     <font color=#447700>! U10<a name='4987'></font>
     <font color=#447700>! V10<a name='4988'></font>
<a name='4989'>
     <font color=#447700>! land/frozen-water call<a name='4990'></font>
<font color=#447700>!     call sfclay(U3D,V3D,T3D,QV3D,P3D,dz8w,                    &amp; ! I<a name='4991'></font>
<font color=#447700>!                 CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,      &amp; !<a name='4992'></font>
<font color=#447700>!                 I,I,I,I,I,I,IO,IO,IO,IO,<a name='4993'></font>
<font color=#447700>!                 ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='4994'></font>
<font color=#447700>!                 XLAND,HFX,QFX,LH,TSK_LOCAL,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='4995'></font>
<font color=#447700>!                 U10,V10,TH2,T2,Q2,                            &amp;<a name='4996'></font>
<font color=#447700>!                 GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='4997'></font>
<font color=#447700>!                 SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='4998'></font>
<font color=#447700>!                 KARMAN,EOMEG,STBOLT,                          &amp;<a name='4999'></font>
<font color=#447700>!                 P1000,                                      &amp;<a name='5000'></font>
<font color=#447700>!                 ids,ide, jds,jde, kds,kde,                    &amp;<a name='5001'></font>
<font color=#447700>!                 ims,ime, jms,jme, kms,kme,                    &amp;<a name='5002'></font>
<font color=#447700>!                 its,ite, jts,jte, kts,kte,                    &amp;<a name='5003'></font>
<font color=#447700>!                 ustm,ck,cka,cd,cda,isftcflx,iz0tlnd           )<a name='5004'></font>
<a name='5005'>
          CALL <A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY_MYNN'>SFCLAY_mynn</A><A href='../../html_code/phys/module_surface_driver.F.html#MYNN_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAY_MYNN_2">(U3D,V3D,T3D,QV3D,P3D,dz8w,              &amp;<a name='5006'>
               CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,            &amp;<a name='5007'>
               ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH,       &amp;<a name='5008'>
               XLAND,HFX,QFX,LH,TSK_LOCAL,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='5009'>
               U10,V10,TH2,T2,Q2,SNOWH,                            &amp;<a name='5010'>
               GZ1OZ0,WSPD,BR,ISFFLX,DX,                           &amp;<a name='5011'>
               SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,                &amp;<a name='5012'>
               &amp;itimestep,ch,th3d,pi3d,qc3d,rho,                   &amp;<a name='5013'>
               &amp;tsq,qsq,cov,sh3d,el_pbl,qcg,                       &amp;<a name='5014'>
               &amp;icloud_bl,qc_bl,cldfra_bl,                         &amp;<a name='5015'>
               &amp;spp_pbl,pattern_spp_pbl,                           &amp;<a name='5016'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='5017'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='5018'>
               its,ite, jts,jte, kts,kte,                          &amp;<a name='5019'>
               ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,bl_mynn_cloudpdf)<a name='5020'>
<a name='5021'>
     <font color=#447700>! Set up for open-water call<a name='5022'></font>
     DO j = JTS , JTE<a name='5023'>
        DO i = ITS , ITE<a name='5024'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='5025'>
              XLAND_SEA(i,j)=2.<a name='5026'>
              MAVAIL_SEA(I,J)  =1.<a name='5027'>
              ZNT_SEA(I,J) = 0.0001<a name='5028'>
              TSK_SEA(i,j) = SST(i,j)<a name='5029'>
              IF ( SST(i,j) .LT. 271.4 ) THEN<a name='5030'>
                 SST(i,j) = 271.4<a name='5031'>
                 TSK_SEA(i,j) = SST(i,j)<a name='5032'>
              ENDIF<a name='5033'>
           ELSE<a name='5034'>
              XLAND_SEA(i,j) = XLAND(i,j)<a name='5035'>
              MAVAIL_SEA(i,j) = MAVAIL(i,j)<a name='5036'>
              ZNT_SEA(i,j)  = ZNT_HOLD(i,j)<a name='5037'>
              TSK_SEA(i,j) = TSK_LOCAL(i,j)<a name='5038'>
           ENDIF<a name='5039'>
        ENDDO<a name='5040'>
     ENDDO<a name='5041'>
<a name='5042'>
     <font color=#447700>! Restore the values from before the land/frozen-water call<a name='5043'></font>
     BR_SEA   = BR_HOLD<a name='5044'>
     CHS2_SEA = CHS2_HOLD<a name='5045'>
     CHS_SEA  = CHS_HOLD<a name='5046'>
     CPM_SEA  = CPM_HOLD<a name='5047'>
     CQS2_SEA = CQS2_HOLD<a name='5048'>
     FLHC_SEA = FLHC_HOLD<a name='5049'>
     FLQC_SEA = FLQC_HOLD<a name='5050'>
     GZ1OZ0_SEA = GZ1OZ0_HOLD<a name='5051'>
     HFX_SEA  = HFX_HOLD<a name='5052'>
     LH_SEA   = LH_HOLD<a name='5053'>
     MOL_SEA  = MOL_HOLD<a name='5054'>
     PSIH_SEA = PSIH_HOLD<a name='5055'>
     PSIM_SEA = PSIM_HOLD<a name='5056'>
     QFX_SEA  = QFX_HOLD<a name='5057'>
     QGH_SEA  = QGH_HOLD<a name='5058'>
     REGIME_SEA = REGIME_HOLD<a name='5059'>
     RMOL_SEA = RMOL_HOLD<a name='5060'>
     UST_SEA  = UST_HOLD<a name='5061'>
     WSPD_SEA = WSPD_HOLD<a name='5062'>
     ZOL_SEA  = ZOL_HOLD<a name='5063'>
     CH_SEA   = CH_HOLD<a name='5064'>
<a name='5065'>
     <font color=#447700>! open-water call<a name='5066'></font>
<font color=#447700>!     call sfclay(U3D,V3D,T3D,QV3D,P3D,dz8w,                    &amp; ! I<a name='5067'></font>
<font color=#447700>!                 CP,G,ROVCP,R,XLV,PSFC,                        &amp; ! I<a name='5068'></font>
<font color=#447700>!                 CHS_SEA,CHS2_SEA,CQS2_SEA,CPM_SEA,            &amp; ! I/O<a name='5069'></font>
<font color=#447700>!                 ZNT_SEA,UST_SEA,                              &amp; ! I/O<a name='5070'></font>
<font color=#447700>!                 PBLH,MAVAIL_SEA,                              &amp; ! I<a name='5071'></font>
<font color=#447700>!                 ZOL_SEA,MOL_SEA,REGIME_SEA,PSIM_SEA,PSIH_SEA, &amp; ! I/O<a name='5072'></font>
<font color=#447700>!                 XLAND_SEA,                              &amp; ! I<a name='5073'></font>
<font color=#447700>!                 HFX_SEA,QFX_SEA,LH_SEA,                       &amp; ! I/O<a name='5074'></font>
<font color=#447700>!                 TSK_SEA,                                      &amp; ! I<a name='5075'></font>
<font color=#447700>!                 FLHC_SEA,FLQC_SEA,QGH_SEA,QSFC_sea,RMOL_SEA,  &amp; ! I/O<a name='5076'></font>
<font color=#447700>!                 U10_sea,V10_sea,TH2_sea,T2_sea,Q2_sea,        &amp; ! O<a name='5077'></font>
<font color=#447700>!                 GZ1OZ0_SEA,WSPD_SEA,BR_SEA,                   &amp; ! I/O<a name='5078'></font>
<font color=#447700>!                 ISFFLX,DX,                                    &amp;<a name='5079'></font>
<font color=#447700>!                 SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='5080'></font>
<font color=#447700>!                 KARMAN,EOMEG,STBOLT,<a name='5081'></font>
<font color=#447700>!                 P1000,                                      &amp;<a name='5082'></font>
<font color=#447700>!                 ids,ide, jds,jde, kds,kde,                    &amp;<a name='5083'></font>
<font color=#447700>!                 ims,ime, jms,jme, kms,kme,                    &amp;<a name='5084'></font>
<font color=#447700>!                 its,ite, jts,jte, kts,kte,                    &amp; ! 0<a name='5085'></font>
<font color=#447700>!                 ustm_sea,ck_sea,cka_sea,cd_sea,cda_sea,isftcflx,iz0tlnd )<a name='5086'></font>
          CALL <A href='../../html_code/phys/module_sf_mynn.F.html#SFCLAY_MYNN'>SFCLAY_mynn</A><A href='../../html_code/phys/module_surface_driver.F.html#MYNN_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAY_MYNN_3">(U3D,V3D,T3D,QV3D,P3D,dz8w,              &amp;<a name='5087'>
               CP,G,ROVCP,R,XLV,PSFC,                              &amp;<a name='5088'>
               CHS_SEA,CHS2_SEA,CQS2_SEA,CPM_SEA,                  &amp;<a name='5089'>
               ZNT_SEA,UST_SEA,                                    &amp;<a name='5090'>
               PBLH,MAVAIL_SEA,                                    &amp;<a name='5091'>
               ZOL_SEA,MOL_SEA,REGIME_SEA,PSIM_SEA,PSIH_SEA,       &amp;<a name='5092'>
               XLAND_SEA,                                          &amp;<a name='5093'>
               HFX_SEA,QFX_SEA,LH_SEA,                             &amp;<a name='5094'>
               TSK_SEA,                                            &amp;<a name='5095'>
               FLHC_SEA,FLQC_SEA,QGH_SEA,QSFC_sea,RMOL_SEA,        &amp;<a name='5096'>
               U10_sea,V10_sea,TH2_sea,T2_sea,Q2_sea,SNOWH,        &amp;<a name='5097'>
               GZ1OZ0_SEA,WSPD_SEA,BR_SEA,                         &amp;<a name='5098'>
               ISFFLX,DX,                                          &amp;<a name='5099'>
               SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,                &amp;<a name='5100'>
               &amp;itimestep,CH_SEA,th3d,pi3d,qc3d,rho,               &amp;<a name='5101'>
               &amp;tsq,qsq,cov,sh3d,el_pbl,qcg,                       &amp;<a name='5102'>
               &amp;icloud_bl,qc_bl,cldfra_bl,                         &amp;<a name='5103'>
               &amp;spp_pbl,pattern_spp_pbl,                           &amp;<a name='5104'>
               ids,ide, jds,jde, kds,kde,                          &amp;<a name='5105'>
               ims,ime, jms,jme, kms,kme,                          &amp;<a name='5106'>
               its,ite, jts,jte, kts,kte,                          &amp;<a name='5107'>
               ustm_sea,ck_sea,cka_sea,cd_sea,cda_sea,isftcflx,    &amp;<a name='5108'>
               iz0tlnd,bl_mynn_cloudpdf )<a name='5109'>
<a name='5110'>
     DO j = JTS , JTE<a name='5111'>
        DO i = ITS, ITE<a name='5112'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD )  .and.( XICE(i,j) .LE. 1.0 ) ) THEN<a name='5113'>
              <font color=#447700>! weighted average for sea ice points<a name='5114'></font>
              br(i,j)     = ( br(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * br_sea(i,j)     )<a name='5115'>
              <font color=#447700>! CHS2 -- wait<a name='5116'></font>
              <font color=#447700>! CHS  -- wait<a name='5117'></font>
              <font color=#447700>! CPM  -- wait<a name='5118'></font>
              <font color=#447700>! CQS2 -- wait<a name='5119'></font>
              <font color=#447700>! FLHC -- wait<a name='5120'></font>
              <font color=#447700>! FLQC -- wait<a name='5121'></font>
              gz1oz0(i,j) = ( gz1oz0(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * gz1oz0_sea(i,j) )<a name='5122'>
              <font color=#447700>! HFX  -- wait<a name='5123'></font>
              <font color=#447700>! LH   -- wait<a name='5124'></font>
              mol(i,j)    = ( mol(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * mol_sea(i,j)    )<a name='5125'>
              psih(i,j)   = ( psih(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * psih_sea(i,j)   )<a name='5126'>
              psim(i,j)   = ( psim(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * psim_sea(i,j)   )<a name='5127'>
              <font color=#447700>! QFX  -- wait<a name='5128'></font>
              <font color=#447700>! QGH  -- wait<a name='5129'></font>
              if ( XICE(i,j).GE. 0.5 ) regime(i,j) = regime_hold(i,j)<a name='5130'>
              rmol(i,j)   = ( rmol(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * rmol_sea(i,j)   )<a name='5131'>
              ust(i,j)    = ( ust(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * ust_sea(i,j)    )<a name='5132'>
              wspd(i,j)   = ( wspd(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * wspd_sea(i,j)   )<a name='5133'>
              zol(i,j)    = ( zol(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * zol_sea(i,j)    )<a name='5134'>
              ch(i,j)     = ( ch(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * ch_sea(i,j)    )<a name='5135'>
              <font color=#447700>! INTENT(OUT)<a name='5136'></font>
              <font color=#447700>! --------------------------------------------------------------------<a name='5137'></font>
              IF ( PRESENT ( CD ) ) THEN<a name='5138'>
                 CD(i,j)  = ( CD(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CD_sea(i,j)    )<a name='5139'>
              ENDIF<a name='5140'>
              IF ( PRESENT ( CDA ) ) THEN<a name='5141'>
                 CDA(i,j) = ( CDA(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CDA_sea(i,j)   )<a name='5142'>
              ENDIF<a name='5143'>
              IF ( PRESENT ( CK ) ) THEN<a name='5144'>
                 CK(i,j)  = ( CK(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CK_sea(i,j)    )<a name='5145'>
              ENDIF<a name='5146'>
              IF ( PRESENT ( CKA ) ) THEN<a name='5147'>
                 CKA(i,j) = ( CKA(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CKA_sea(i,j)   )<a name='5148'>
              ENDIF<a name='5149'>
              q2(i,j)     = ( q2(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * q2_sea(i,j)     )<a name='5150'>
              <font color=#447700>! QSFC -- wait<a name='5151'></font>
              t2(i,j)     = ( t2(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * t2_sea(i,j)     )<a name='5152'>
              th2(i,j)    = ( th2(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * th2_sea(i,j)    )<a name='5153'>
              u10(i,j)    = ( u10(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * u10_sea(i,j)    )<a name='5154'>
              IF ( PRESENT ( USTM ) ) THEN<a name='5155'>
                 USTM(i,j) = ( USTM(i,j)  * XICE(i,j) ) + ( (1.0-XICE(i,j)) * USTM_sea(i,j)   )<a name='5156'>
              ENDIF<a name='5157'>
              v10(i,j)    = ( v10(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * v10_sea(i,j)    )<a name='5158'>
           ENDIF<a name='5159'>
        END DO<a name='5160'>
     END DO<a name='5161'>
<font color=#447700>!<a name='5162'></font>
<font color=#447700>!         tsk(i,j) = tsk(i,j)*XICE(i,j) + (1.0-XICE(i,j))*TSK_SEA(i,j)<a name='5163'></font>
<font color=#447700>!<a name='5164'></font>
   END SUBROUTINE mynn_seaice_wrapper<a name='5165'>
<a name='5166'>
<font color=#447700>!-------------------------------------------------------------------------<a name='5167'></font>
<a name='5168'>
<A NAME='SF_GFS_SEAICE_WRAPPER'><A href='../../html_code/phys/module_surface_driver.F.html#SF_GFS_SEAICE_WRAPPER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5169'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>sf_gfs_seaice_wrapper</font>(U3D,V3D,T3D,QV3D,P3D,        &amp; <A href='../../call_to/SF_GFS_SEAICE_WRAPPER.html' TARGET='index'>1</A>,<A href='../../call_from/SF_GFS_SEAICE_WRAPPER.html' TARGET='index'>4</A><a name='5170'>
		 CP,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,          &amp;<a name='5171'>
                     ZNT,UST,PSIM,PSIH,                          &amp;<a name='5172'>
                     XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,             &amp;<a name='5173'>
                     QGH,QSFC,U10,V10,                           &amp;<a name='5174'>
                     GZ1OZ0,WSPD,BR,ISFFLX,                      &amp;<a name='5175'>
                     EP1,EP2,KARMAN,itimestep,                   &amp;<a name='5176'>
                     TICE2TSK_IF2COLD,                           &amp;<a name='5177'>
                     XICE_THRESHOLD,                             &amp;<a name='5178'>
                     CHS_SEA, CHS2_SEA, CPM_SEA, CQS2_SEA,       &amp;<a name='5179'>
                     FLHC_SEA, FLQC_SEA,                         &amp;<a name='5180'>
                     HFX_SEA, LH_SEA, QFX_SEA, QGH_SEA, QSFC_SEA,&amp;<a name='5181'>
                     UST_SEA, ZNT_SEA, SST, XICE,                &amp;<a name='5182'>
                     ids,ide, jds,jde, kds,kde,                  &amp;<a name='5183'>
                     ims,ime, jms,jme, kms,kme,                  &amp;<a name='5184'>
                     its,ite, jts,jte, kts,kte                   )<a name='5185'>
     USE <A href='../../html_code/phys/module_sf_gfs.F.html#MODULE_SF_GFS'>module_sf_gfs</A><A href='../../html_code/phys/module_surface_driver.F.html#SF_GFS_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_GFS_2"><a name='5186'>
     implicit none<a name='5187'>
<a name='5188'>
     INTEGER, INTENT(IN) ::             ids,ide, jds,jde, kds,kde,      &amp;<a name='5189'>
                                        ims,ime, jms,jme, kms,kme,      &amp;<a name='5190'>
                                        its,ite, jts,jte, kts,kte,      &amp;<a name='5191'>
                                        ISFFLX,itimestep<a name='5192'>
<a name='5193'>
      REAL,    INTENT(IN) ::                                            &amp;<a name='5194'>
                                        CP,                             &amp;<a name='5195'>
                                        EP1,                            &amp;<a name='5196'>
                                        EP2,                            &amp;<a name='5197'>
                                        KARMAN,                         &amp;<a name='5198'>
                                        R,                              &amp;<a name='5199'>
                                        ROVCP,                          &amp;<a name='5200'>
                                        XLV<a name='5201'>
<a name='5202'>
      REAL,    DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN) ::      &amp;<a name='5203'>
                                        P3D,                            &amp;<a name='5204'>
                                        QV3D,                           &amp;<a name='5205'>
                                        T3D,                            &amp;<a name='5206'>
                                        U3D,                            &amp;<a name='5207'>
                                        V3D<a name='5208'>
<a name='5209'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(IN) ::               &amp;<a name='5210'>
                                        TSK,                            &amp;<a name='5211'>
                                        PSFC,                           &amp;<a name='5212'>
                                        XLAND<a name='5213'>
<a name='5214'>
      REAL,    DIMENSION(ims:ime, jms:jme), INTENT(INOUT) ::            &amp;<a name='5215'>
                                        UST,                            &amp;<a name='5216'>
                                        ZNT<a name='5217'>
<a name='5218'>
      REAL, DIMENSION(ims:ime, jms:jme), INTENT(OUT) ::                 &amp;<a name='5219'>
                                        BR,                             &amp;<a name='5220'>
                                        CHS,                            &amp;<a name='5221'>
                                        CHS2,                           &amp;<a name='5222'>
                                        CPM,                            &amp;<a name='5223'>
                                        CQS2,                           &amp;<a name='5224'>
                                        FLHC,                           &amp;<a name='5225'>
                                        FLQC,                           &amp;<a name='5226'>
                                        GZ1OZ0,                         &amp;<a name='5227'>
                                        HFX,                            &amp;<a name='5228'>
                                        LH,                             &amp;<a name='5229'>
                                        PSIM,                           &amp;<a name='5230'>
                                        PSIH,                           &amp;<a name='5231'>
                                        QFX,                            &amp;<a name='5232'>
                                        QGH,                            &amp;<a name='5233'>
                                        QSFC,                           &amp;<a name='5234'>
                                        U10,                            &amp;<a name='5235'>
                                        V10,                            &amp;<a name='5236'>
                                        WSPD<a name='5237'>
<a name='5238'>
      REAL, DIMENSION(ims:ime, jms:jme), INTENT(IN) ::                  &amp;<a name='5239'>
                                        XICE<a name='5240'>
      REAL, DIMENSION(ims:ime, jms:jme), INTENT(OUT) ::                 &amp;<a name='5241'>
                                        CHS_SEA,                        &amp;<a name='5242'>
                                        CHS2_SEA,                       &amp;<a name='5243'>
                                        CPM_SEA,                        &amp;<a name='5244'>
                                        CQS2_SEA,                       &amp;<a name='5245'>
                                        FLHC_SEA,                       &amp;<a name='5246'>
                                        FLQC_SEA,                       &amp;<a name='5247'>
                                        HFX_SEA,                        &amp;<a name='5248'>
                                        LH_SEA,                         &amp;<a name='5249'>
                                        QFX_SEA,                        &amp;<a name='5250'>
                                        QGH_SEA,                        &amp;<a name='5251'>
                                        QSFC_SEA,                       &amp;<a name='5252'>
                                        UST_SEA,                        &amp;<a name='5253'>
                                        ZNT_SEA<a name='5254'>
      REAL, DIMENSION(ims:ime, jms:jme), INTENT(INOUT) ::               &amp;<a name='5255'>
                                        SST<a name='5256'>
<a name='5257'>
      REAL,                              INTENT(IN)    ::               &amp;<a name='5258'>
                                        XICE_THRESHOLD<a name='5259'>
      LOGICAL,                          INTENT(IN)     :: TICE2TSK_IF2COLD<a name='5260'>
<a name='5261'>
<font color=#447700>!-------------------------------------------------------------------------<a name='5262'></font>
<font color=#447700>!   Local<a name='5263'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='5264'></font>
      INTEGER :: I<a name='5265'>
      INTEGER :: J<a name='5266'>
      REAL, DIMENSION(ims:ime, jms:jme) ::                              &amp;<a name='5267'>
                                        BR_SEA,                         &amp;<a name='5268'>
                                        GZ1OZ0_SEA,                     &amp;<a name='5269'>
                                        PSIM_SEA,                       &amp;<a name='5270'>
                                        PSIH_SEA,                       &amp;<a name='5271'>
                                        U10_SEA,                        &amp;<a name='5272'>
                                        V10_SEA,                        &amp;<a name='5273'>
                                        WSPD_SEA,                       &amp;<a name='5274'>
                                        XLAND_SEA,                &amp;<a name='5275'>
                                        TSK_SEA,                        &amp;<a name='5276'>
                                        UST_HOLD,                       &amp;<a name='5277'>
                                        ZNT_HOLD,                       &amp;<a name='5278'>
                                        TSK_LOCAL<a name='5279'>
<a name='5280'>
      CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#SF_GFS_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_8">( ims, ime, jms, jme, its, ite, jts, jte,  &amp;<a name='5281'>
                              itimestep, .true., tice2tsk_if2cold,     &amp;<a name='5282'>
                              XICE, XICE_THRESHOLD,                    &amp;<a name='5283'>
                              SST, TSK, TSK_SEA, TSK_LOCAL )<a name='5284'>
<a name='5285'>
<font color=#447700>!<a name='5286'></font>
<font color=#447700>! Set up for frozen ocean call for sea ice points<a name='5287'></font>
<font color=#447700>!<a name='5288'></font>
<a name='5289'>
<font color=#447700>! Strictly INTENT(IN), Should be unchanged by SF_GFS:<a name='5290'></font>
<font color=#447700>!     CP<a name='5291'></font>
<font color=#447700>!     EP1<a name='5292'></font>
<font color=#447700>!     EP2<a name='5293'></font>
<font color=#447700>!     KARMAN<a name='5294'></font>
<font color=#447700>!     R<a name='5295'></font>
<font color=#447700>!     ROVCP<a name='5296'></font>
<font color=#447700>!     XLV<a name='5297'></font>
<font color=#447700>!     P3D<a name='5298'></font>
<font color=#447700>!     QV3D<a name='5299'></font>
<font color=#447700>!     T3D<a name='5300'></font>
<font color=#447700>!     U3D<a name='5301'></font>
<font color=#447700>!     V3D<a name='5302'></font>
<font color=#447700>!     TSK<a name='5303'></font>
<font color=#447700>!     PSFC<a name='5304'></font>
<font color=#447700>!     XLAND<a name='5305'></font>
<font color=#447700>!     ISFFLX<a name='5306'></font>
<font color=#447700>!     ITIMESTEP<a name='5307'></font>
<a name='5308'>
<a name='5309'>
<font color=#447700>! Intent (INOUT), original value is used and changed by SF_GFS.<a name='5310'></font>
<font color=#447700>!     UST<a name='5311'></font>
<font color=#447700>!     ZNT<a name='5312'></font>
<a name='5313'>
     ZNT_HOLD = ZNT<a name='5314'>
     UST_HOLD = UST<a name='5315'>
<a name='5316'>
<font color=#447700>! Strictly INTENT (OUT), set by SF_GFS:<a name='5317'></font>
<font color=#447700>!     BR<a name='5318'></font>
<font color=#447700>!     CHS     -- used by LSM routines<a name='5319'></font>
<font color=#447700>!     CHS2    -- used by LSM routines<a name='5320'></font>
<font color=#447700>!     CPM     -- used by LSM routines<a name='5321'></font>
<font color=#447700>!     CQS2    -- used by LSM routines<a name='5322'></font>
<font color=#447700>!     FLHC<a name='5323'></font>
<font color=#447700>!     FLQC<a name='5324'></font>
<font color=#447700>!     GZ1OZ0<a name='5325'></font>
<font color=#447700>!     HFX     -- used by LSM routines<a name='5326'></font>
<font color=#447700>!     LH      -- used by LSM routines<a name='5327'></font>
<font color=#447700>!     PSIM<a name='5328'></font>
<font color=#447700>!     PSIH<a name='5329'></font>
<font color=#447700>!     QFX     -- used by LSM routines<a name='5330'></font>
<font color=#447700>!     QGH     -- used by LSM routines<a name='5331'></font>
<font color=#447700>!     QSFC    -- used by LSM routines<a name='5332'></font>
<font color=#447700>!     U10<a name='5333'></font>
<font color=#447700>!     V10<a name='5334'></font>
<font color=#447700>!     WSPD<a name='5335'></font>
<a name='5336'>
<font color=#447700>!<a name='5337'></font>
<font color=#447700>! Frozen ocean / true land call.<a name='5338'></font>
<font color=#447700>!<a name='5339'></font>
     CALL <A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS'>SF_GFS</A><A href='../../html_code/phys/module_surface_driver.F.html#SF_GFS_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SF_GFS_2">(U3D,V3D,T3D,QV3D,P3D,                  &amp;<a name='5340'>
          CP,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM_SEA,    &amp;<a name='5341'>
          ZNT,UST,PSIM,PSIH,                            &amp;<a name='5342'>
          XLAND,HFX,QFX,LH,TSK_LOCAL,FLHC,FLQC,         &amp;<a name='5343'>
          QGH,QSFC,U10,V10,                             &amp;<a name='5344'>
          GZ1OZ0,WSPD,BR,ISFFLX,                        &amp;<a name='5345'>
          EP1,EP2,KARMAN,ITIMESTEP,                     &amp;<a name='5346'>
          ids,ide, jds,jde, kds,kde,                    &amp;<a name='5347'>
          ims,ime, jms,jme, kms,kme,                    &amp;<a name='5348'>
          its,ite, jts,jte, kts,kte                     )<a name='5349'>
<a name='5350'>
<font color=#447700>! Set up for open-water call<a name='5351'></font>
<a name='5352'>
     DO j = JTS , JTE<a name='5353'>
        DO i = ITS , ITE<a name='5354'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='5355'>
              <font color=#447700>! Sets up things for open ocean fraction of sea-ice points<a name='5356'></font>
              XLAND_SEA(i,j)=2.<a name='5357'>
              ZNT_SEA(I,J) = 0.0001<a name='5358'>
              IF ( SST(i,j) .LT. 271.4 ) THEN<a name='5359'>
                 SST(i,j) = 271.4<a name='5360'>
              ENDIF<a name='5361'>
              TSK_SEA(i,j) = SST(i,j)<a name='5362'>
           ELSE<a name='5363'>
              <font color=#447700>! Fully open ocean or true land points<a name='5364'></font>
              XLAND_SEA(i,j)=xland(i,j)<a name='5365'>
              ZNT_SEA(I,J) = ZNT_HOLD(I,J)<a name='5366'>
              UST_SEA(i,j) = UST_HOLD(i,j)<a name='5367'>
              TSK_SEA(i,j) = TSK(i,j)<a name='5368'>
           ENDIF<a name='5369'>
        ENDDO<a name='5370'>
     ENDDO<a name='5371'>
<a name='5372'>
     <font color=#447700>! Open-water call<a name='5373'></font>
     <font color=#447700>! _SEA variables are held for later use as the result of the open-water call.<a name='5374'></font>
     CALL <A href='../../html_code/phys/module_sf_gfs.F.html#SF_GFS'>SF_GFS</A><A href='../../html_code/phys/module_surface_driver.F.html#SF_GFS_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SF_GFS_3">(U3D,V3D,T3D,QV3D,P3D,                  &amp;<a name='5375'>
          CP,ROVCP,R,XLV,PSFC,CHS_SEA,CHS2_SEA,CQS2_SEA,CPM,        &amp;<a name='5376'>
          ZNT_SEA,UST_SEA,PSIM_SEA,PSIH_SEA,                        &amp;<a name='5377'>
          XLAND,HFX_SEA,QFX_SEA,LH_SEA,TSK_SEA,FLHC_SEA,FLQC_SEA,   &amp;<a name='5378'>
          QGH_SEA,QSFC_SEA,U10_SEA,V10_SEA,                         &amp;<a name='5379'>
          GZ1OZ0_SEA,WSPD_SEA,BR_SEA,ISFFLX,                        &amp;<a name='5380'>
          EP1,EP2,KARMAN,ITIMESTEP,                     &amp;<a name='5381'>
          ids,ide, jds,jde, kds,kde,                    &amp;<a name='5382'>
          ims,ime, jms,jme, kms,kme,                    &amp;<a name='5383'>
          its,ite, jts,jte, kts,kte                     )<a name='5384'>
<a name='5385'>
<font color=#447700>! Weighting, after our two calls to SF_GFS<a name='5386'></font>
<a name='5387'>
     DO j = JTS , JTE<a name='5388'>
        DO i = ITS , ITE<a name='5389'>
           <font color=#447700>! Over sea-ice points, weight the results.  Otherwise, just take the results from the<a name='5390'></font>
           <font color=#447700>! first call to SF_GFS_<a name='5391'></font>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='5392'>
              <font color=#447700>! Weight a number of fields (between open-water results<a name='5393'></font>
              <font color=#447700>! and full ice results) by sea-ice fraction.<a name='5394'></font>
<a name='5395'>
              BR(i,j)     = ( BR(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * BR_SEA(i,j)     )<a name='5396'>
              <font color=#447700>! CHS, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5397'></font>
              <font color=#447700>! CHS2, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5398'></font>
              <font color=#447700>! CPM, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5399'></font>
              <font color=#447700>! CQS2, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5400'></font>
              <font color=#447700>! FLHC(i,j) = ( FLHC(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * FLHC_SEA(i,j) )<a name='5401'></font>
              <font color=#447700>! FLQC(i,j) = ( FLQC(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * FLQC_SEA(i,j) )<a name='5402'></font>
              GZ1OZ0(i,j) = ( GZ1OZ0(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * GZ1OZ0_SEA(i,j) )<a name='5403'>
              <font color=#447700>! HFX, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5404'></font>
              <font color=#447700>! LH, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5405'></font>
              PSIM(i,j)   = ( PSIM(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * PSIM_SEA(i,j)   )<a name='5406'>
              PSIH(i,j)   = ( PSIH(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * PSIH_SEA(i,j)   )<a name='5407'>
              <font color=#447700>! QFX, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5408'></font>
              <font color=#447700>! QGH, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5409'></font>
              <font color=#447700>! QSFC, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5410'></font>
              U10(i,j)    = ( U10(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * U10_SEA(i,j)    )<a name='5411'>
              V10(i,j)    = ( V10(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * V10_SEA(i,j)    )<a name='5412'>
              WSPD(i,j)   = ( WSPD(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * WSPD_SEA(i,j)   )<a name='5413'>
              <font color=#447700>! UST, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5414'></font>
              <font color=#447700>! ZNT, used by the LSM routines, is not updated yet.  Return results from both calls in separate variables<a name='5415'></font>
<a name='5416'>
           ENDIF<a name='5417'>
        ENDDO<a name='5418'>
     ENDDO<a name='5419'>
<a name='5420'>
   END SUBROUTINE sf_gfs_seaice_wrapper<a name='5421'>
<a name='5422'>
<font color=#447700>!-------------------------------------------------------------------------<a name='5423'></font>
<a name='5424'>
<font color=#447700>!-------------------------------------------------------------------------<a name='5425'></font>
<a name='5426'>
<A NAME='SFCLAYREV_SEAICE_WRAPPER'><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAYREV_SEAICE_WRAPPER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5427'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>sfclayrev_seaice_wrapper</font>(U3D,V3D,T3D,QV3D,P3D,dz8w,     &amp; <A href='../../call_to/SFCLAYREV_SEAICE_WRAPPER.html' TARGET='index'>1</A>,<A href='../../call_from/SFCLAYREV_SEAICE_WRAPPER.html' TARGET='index'>4</A><a name='5428'>
                     CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,      &amp;<a name='5429'>
                     ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='5430'>
                     FM,FH,                                        &amp;<a name='5431'>
                     XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='5432'>
                     U10,V10,TH2,T2,Q2,                            &amp;<a name='5433'>
                     GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='5434'>
                     SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='5435'>
                     KARMAN,EOMEG,STBOLT,                          &amp;<a name='5436'>
                     P1000,                                      &amp;<a name='5437'>
                     XICE,SST,TSK_SEA,                                                  &amp;<a name='5438'>
                     CHS2_SEA,CHS_SEA,CPM_SEA,CQS2_SEA,FLHC_SEA,FLQC_SEA,               &amp;<a name='5439'>
                     HFX_SEA,LH_SEA,QFX_SEA,QGH_SEA,QSFC_SEA,ZNT_SEA,                   &amp;<a name='5440'>
                     ITIMESTEP,TICE2TSK_IF2COLD,XICE_THRESHOLD,                         &amp;<a name='5441'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='5442'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='5443'>
                     its,ite, jts,jte, kts,kte,                    &amp;<a name='5444'>
                     ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,          &amp;<a name='5445'>
                     sf_surface_physics                             )<a name='5446'>
<a name='5447'>
     USE <A href='../../html_code/phys/module_sf_sfclayrev.F.html#MODULE_SF_SFCLAYREV'>module_sf_sfclayrev</A><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAYREV_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SFCLAYREV_3"><a name='5448'>
     implicit none<a name='5449'>
<a name='5450'>
     INTEGER,  INTENT(IN )   ::        ids,ide, jds,jde, kds,kde,  &amp;<a name='5451'>
                                       ims,ime, jms,jme, kms,kme,  &amp;<a name='5452'>
                                       its,ite, jts,jte, kts,kte<a name='5453'>
<a name='5454'>
     INTEGER,  INTENT(IN )   ::        ISFFLX<a name='5455'>
     REAL,     INTENT(IN )   ::        SVP1,SVP2,SVP3,SVPT0<a name='5456'>
     REAL,     INTENT(IN )   ::        EP1,EP2,KARMAN,EOMEG,STBOLT<a name='5457'>
     REAL,     INTENT(IN )   ::        P1000<a name='5458'>
<a name='5459'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='5460'>
               INTENT(IN   )   ::                           dz8w<a name='5461'>
<a name='5462'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='5463'>
               INTENT(IN   )   ::                           QV3D, &amp;<a name='5464'>
                                                             P3D, &amp;<a name='5465'>
                                                             T3D<a name='5466'>
<a name='5467'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5468'>
               INTENT(IN   )               ::             MAVAIL, &amp;<a name='5469'>
                                                            PBLH, &amp;<a name='5470'>
                                                           XLAND, &amp;<a name='5471'>
                                                             TSK<a name='5472'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5473'>
               INTENT(OUT  )               ::                U10, &amp;<a name='5474'>
                                                             V10, &amp;<a name='5475'>
                                                             TH2, &amp;<a name='5476'>
                                                              T2, &amp;<a name='5477'>
                                                              Q2, &amp;<a name='5478'>
                                                            QSFC<a name='5479'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5480'>
               INTENT(INOUT)               ::             REGIME, &amp;<a name='5481'>
                                                             HFX, &amp;<a name='5482'>
                                                             QFX, &amp;<a name='5483'>
                                                              LH, &amp;<a name='5484'>
                                                         MOL,RMOL<a name='5485'>
<a name='5486'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5487'>
               INTENT(INOUT)   ::                 GZ1OZ0,WSPD,BR, &amp;<a name='5488'>
                                                 PSIM,PSIH,FM,FH<a name='5489'>
<a name='5490'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='5491'>
               INTENT(IN   )   ::                            U3D, &amp;<a name='5492'>
                                                             V3D<a name='5493'>
<a name='5494'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5495'>
               INTENT(IN   )               ::               PSFC<a name='5496'>
<a name='5497'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5498'>
               INTENT(INOUT)   ::                            ZNT, &amp;<a name='5499'>
                                                             ZOL, &amp;<a name='5500'>
                                                             UST, &amp;<a name='5501'>
                                                             CPM, &amp;<a name='5502'>
                                                            CHS2, &amp;<a name='5503'>
                                                            CQS2, &amp;<a name='5504'>
                                                             CHS<a name='5505'>
<a name='5506'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5507'>
               INTENT(INOUT)   ::                      FLHC,FLQC<a name='5508'>
<a name='5509'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5510'>
               INTENT(INOUT)   ::                                 &amp;<a name='5511'>
                                                              QGH<a name='5512'>
<a name='5513'>
     REAL,     INTENT(IN   )               ::   CP,G,ROVCP,R,XLV,DX<a name='5514'>
<a name='5515'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme )              , &amp;<a name='5516'>
               INTENT(OUT)     ::                   ck,cka,cd,cda<a name='5517'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme )              , &amp;<a name='5518'>
               INTENT(INOUT)   ::                            ustm<a name='5519'>
<a name='5520'>
     INTEGER,  OPTIONAL,  INTENT(IN )   ::     ISFTCFLX,IZ0TLND<a name='5521'>
<a name='5522'>
<font color=#447700>!--------------------------------------------------------------------<a name='5523'></font>
<font color=#447700>!    New for wrapper<a name='5524'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='5525'></font>
     INTEGER,  INTENT(IN)          ::    ITIMESTEP, sf_surface_physics<a name='5526'>
     LOGICAL,  INTENT(IN)               ::      TICE2TSK_IF2COLD<a name='5527'>
     REAL,     INTENT(IN)               ::      XICE_THRESHOLD<a name='5528'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='5529'>
               INTENT(IN)               ::      XICE<a name='5530'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='5531'>
               INTENT(INOUT)            ::      SST<a name='5532'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='5533'>
               INTENT(OUT)              ::      TSK_SEA,          &amp;<a name='5534'>
                                                CHS2_SEA,         &amp;<a name='5535'>
                                                CHS_SEA,          &amp;<a name='5536'>
                                                CPM_SEA,          &amp;<a name='5537'>
                                                CQS2_SEA,         &amp;<a name='5538'>
                                                FLHC_SEA,         &amp;<a name='5539'>
                                                FLQC_SEA,         &amp;<a name='5540'>
                                                HFX_SEA,          &amp;<a name='5541'>
                                                LH_SEA,           &amp;<a name='5542'>
                                                QFX_SEA,          &amp;<a name='5543'>
                                                QGH_SEA,          &amp;<a name='5544'>
                                                QSFC_SEA,         &amp;<a name='5545'>
                                                ZNT_SEA<a name='5546'>
<a name='5547'>
<font color=#447700>!--------------------------------------------------------------------<a name='5548'></font>
<font color=#447700>!    Local<a name='5549'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='5550'></font>
     INTEGER :: I, J<a name='5551'>
     REAL,     DIMENSION( ims:ime, jms:jme ) :: XLAND_SEA,        &amp;<a name='5552'>
                                                MAVAIL_sea,       &amp;<a name='5553'>
                                                TSK_LOCAL,        &amp;<a name='5554'>
                                                BR_HOLD,          &amp;<a name='5555'>
                                                CHS2_HOLD,        &amp;<a name='5556'>
                                                CHS_HOLD,         &amp;<a name='5557'>
                                                CPM_HOLD,         &amp;<a name='5558'>
                                                CQS2_HOLD,        &amp;<a name='5559'>
                                                FLHC_HOLD,        &amp;<a name='5560'>
                                                FLQC_HOLD,        &amp;<a name='5561'>
                                                GZ1OZ0_HOLD,      &amp;<a name='5562'>
                                                HFX_HOLD,         &amp;<a name='5563'>
                                                LH_HOLD,          &amp;<a name='5564'>
                                                MOL_HOLD,         &amp;<a name='5565'>
                                                PSIH_HOLD,        &amp;<a name='5566'>
                                                PSIM_HOLD,        &amp;<a name='5567'>
                                                FH_HOLD,          &amp;<a name='5568'>
                                                FM_HOLD,          &amp;<a name='5569'>
                                                QFX_HOLD,         &amp;<a name='5570'>
                                                QGH_HOLD,         &amp;<a name='5571'>
                                                REGIME_HOLD,      &amp;<a name='5572'>
                                                RMOL_HOLD,        &amp;<a name='5573'>
                                                UST_HOLD,         &amp;<a name='5574'>
                                                WSPD_HOLD,        &amp;<a name='5575'>
                                                ZNT_HOLD,         &amp;<a name='5576'>
                                                ZOL_HOLD,         &amp;<a name='5577'>
                                                TH2_HOLD,         &amp; <font color=#447700>!ssib<a name='5578'></font>
                                                T2_HOLD,          &amp; <font color=#447700>!ssib<a name='5579'></font>
                                                Q2_HOLD,          &amp; <font color=#447700>!ssib<a name='5580'></font>
                                                TSK_HOLD,         &amp; <font color=#447700>!ssib<a name='5581'></font>
                                                CD_SEA,           &amp;<a name='5582'>
                                                CDA_SEA,          &amp;<a name='5583'>
                                                CK_SEA,           &amp;<a name='5584'>
                                                CKA_SEA,          &amp;<a name='5585'>
                                                Q2_SEA,           &amp;<a name='5586'>
                                                T2_SEA,           &amp;<a name='5587'>
                                                TH2_SEA,          &amp;<a name='5588'>
                                                U10_SEA,          &amp;<a name='5589'>
                                                USTM_SEA,         &amp;<a name='5590'>
                                                V10_SEA<a name='5591'>
<a name='5592'>
     REAL,     DIMENSION( ims:ime, jms:jme ) ::                   &amp;<a name='5593'>
                                                BR_SEA,           &amp;<a name='5594'>
                                                GZ1OZ0_SEA,       &amp;<a name='5595'>
                                                MOL_SEA,          &amp;<a name='5596'>
                                                PSIH_SEA,         &amp;<a name='5597'>
                                                PSIM_SEA,         &amp;<a name='5598'>
                                                FH_SEA,           &amp;<a name='5599'>
                                                FM_SEA,           &amp;<a name='5600'>
                                                REGIME_SEA,       &amp;<a name='5601'>
                                                RMOL_SEA,         &amp;<a name='5602'>
                                                UST_SEA,          &amp;<a name='5603'>
                                                WSPD_SEA,         &amp;<a name='5604'>
                                                ZOL_SEA<a name='5605'>
<a name='5606'>
<font color=#447700>! INTENT(IN) to SFCLAY; unchanged by the call<a name='5607'></font>
      <font color=#447700>! ISFFLX<a name='5608'></font>
      <font color=#447700>! SVP1,SVP2,SVP3,SVPT0<a name='5609'></font>
      <font color=#447700>! EP1,EP2,KARMAN,EOMEG,STBOLT<a name='5610'></font>
      <font color=#447700>! CP,G,ROVCP,R,XLV,DX<a name='5611'></font>
      <font color=#447700>! ISFTCFLX,IZ0TLND<a name='5612'></font>
      <font color=#447700>! P1000<a name='5613'></font>
      <font color=#447700>! dz8w<a name='5614'></font>
      <font color=#447700>! QV3D<a name='5615'></font>
      <font color=#447700>! P3D<a name='5616'></font>
      <font color=#447700>! T3D<a name='5617'></font>
      <font color=#447700>! MAVAIL<a name='5618'></font>
      <font color=#447700>! PBLH<a name='5619'></font>
      <font color=#447700>! XLAND<a name='5620'></font>
      <font color=#447700>! TSK<a name='5621'></font>
      <font color=#447700>! U3D<a name='5622'></font>
      <font color=#447700>! V3D<a name='5623'></font>
      <font color=#447700>! PSFC<a name='5624'></font>
<a name='5625'>
     CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAYREV_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_9">( ims, ime, jms, jme, its, ite, jts, jte,  &amp;<a name='5626'>
                             itimestep, .true., tice2tsk_if2cold,     &amp;<a name='5627'>
                             XICE, XICE_THRESHOLD,                    &amp;<a name='5628'>
                             SST, TSK, TSK_SEA, TSK_LOCAL )<a name='5629'>
<a name='5630'>
<a name='5631'>
<font color=#447700>! INTENT (INOUT) to SFCLAY:  Save the variables before the first call<a name='5632'></font>
<font color=#447700>! (for land/frozen water) to SFCLAY, to keep from double-counting the<a name='5633'></font>
<font color=#447700>! effects of that routine<a name='5634'></font>
     BR_HOLD   = BR<a name='5635'>
     CHS2_HOLD = CHS2<a name='5636'>
     CHS_HOLD  = CHS<a name='5637'>
     CPM_HOLD  = CPM<a name='5638'>
     CQS2_HOLD = CQS2<a name='5639'>
     FLHC_HOLD = FLHC<a name='5640'>
     FLQC_HOLD = FLQC<a name='5641'>
     GZ1OZ0_HOLD = GZ1OZ0<a name='5642'>
     HFX_HOLD  = HFX<a name='5643'>
     LH_HOLD   = LH<a name='5644'>
     MOL_HOLD  = MOL<a name='5645'>
     PSIH_HOLD = PSIH<a name='5646'>
     PSIM_HOLD = PSIM<a name='5647'>
     FH_HOLD   = FH<a name='5648'>
     FM_HOLD   = FM<a name='5649'>
     QFX_HOLD  = QFX<a name='5650'>
     QGH_HOLD  = QGH<a name='5651'>
     REGIME_HOLD = REGIME<a name='5652'>
     RMOL_HOLD = RMOL<a name='5653'>
     UST_HOLD  = UST<a name='5654'>
     WSPD_HOLD = WSPD<a name='5655'>
     ZNT_HOLD  = ZNT<a name='5656'>
     ZOL_HOLD  = ZOL<a name='5657'>
<font color=#447700>!also save these variables for SSIB (fds 12/2010)<a name='5658'></font>
     TH2_HOLD = TH2<a name='5659'>
     T2_HOLD = T2<a name='5660'>
     Q2_HOLD = Q2<a name='5661'>
     TSK_HOLD = TSK<a name='5662'>
     <a name='5663'>
<font color=#447700>! INTENT(OUT) from SFCLAY.  Input shouldn't matter, but we'll want to<a name='5664'></font>
<font color=#447700>! keep things around for weighting after the second call to SFCLAY.<a name='5665'></font>
     <font color=#447700>! CD<a name='5666'></font>
     <font color=#447700>! CDA<a name='5667'></font>
     <font color=#447700>! CK<a name='5668'></font>
     <font color=#447700>! CKA<a name='5669'></font>
     <font color=#447700>! Q2<a name='5670'></font>
     <font color=#447700>! QSFC<a name='5671'></font>
     <font color=#447700>! T2<a name='5672'></font>
     <font color=#447700>! TH2<a name='5673'></font>
     <font color=#447700>! U10<a name='5674'></font>
     <font color=#447700>! USTM<a name='5675'></font>
     <font color=#447700>! V10<a name='5676'></font>
<a name='5677'>
<a name='5678'>
     <font color=#447700>! land/frozen-water call<a name='5679'></font>
     call <A href='../../html_code/phys/module_sf_sfclayrev.F.html#SFCLAYREV'>sfclayrev</A><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAYREV_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAYREV_2">(U3D,V3D,T3D,QV3D,P3D,dz8w,                    &amp; <font color=#447700>! I<a name='5680'></font>
                 CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,      &amp; <font color=#447700>! I,I,I,I,I,I,IO,IO,IO,IO,<a name='5681'></font>
                 ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='5682'>
                 FM,FH,                                        &amp;<a name='5683'>
                 XLAND,HFX,QFX,LH,TSK_LOCAL,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='5684'>
                 U10,V10,TH2,T2,Q2,                            &amp;<a name='5685'>
                 GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='5686'>
                 SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='5687'>
                 KARMAN,EOMEG,STBOLT,                          &amp;<a name='5688'>
                 P1000,                                      &amp;<a name='5689'>
                 ids,ide, jds,jde, kds,kde,                    &amp;<a name='5690'>
                 ims,ime, jms,jme, kms,kme,                    &amp;<a name='5691'>
                 its,ite, jts,jte, kts,kte,                    &amp;<a name='5692'>
                 ustm,ck,cka,cd,cda,isftcflx,iz0tlnd           )<a name='5693'>
<font color=#447700>!<a name='5694'></font>
<font color=#447700>!Restore land-point values calculated by SSiB (fds 12/2010)<a name='5695'></font>
     IF (itimestep .gt. 1 .and. sf_surface_physics .EQ. 8) then<a name='5696'>
     DO j = JTS , JTE<a name='5697'>
        DO i = ITS, ITE<a name='5698'>
           IF ( XLAND(I,J) .LT. 1.5 ) THEN<a name='5699'>
              BR(I,J) = BR_HOLD(I,J)<a name='5700'>
              TH2(I,J) = TH2_HOLD(I,J)<a name='5701'>
              T2(I,J) = T2_HOLD(I,J)<a name='5702'>
              Q2(I,J) = Q2_HOLD(I,J)<a name='5703'>
              HFX(I,J) = HFX_HOLD(I,J)<a name='5704'>
              QFX(I,J) = QFX_HOLD(I,J)<a name='5705'>
              LH(I,J) = LH_HOLD(I,J)<a name='5706'>
              GZ1OZ0(I,J) = GZ1OZ0_HOLD(I,J)<a name='5707'>
              WSPD(I,J) = WSPD_HOLD(I,J)<a name='5708'>
              ZNT(I,J) = ZNT_HOLD(I,J)<a name='5709'>
              UST(I,J) = UST_HOLD(I,J)<a name='5710'>
<font color=#447700>!             TSK(I,J) = TSK_HOLD(I,J)<a name='5711'></font>
           ENDIF<a name='5712'>
        ENDDO<a name='5713'>
     ENDDO<a name='5714'>
     ENDIF<a name='5715'>
<font color=#447700>!<a name='5716'></font>
     <font color=#447700>! Set up for open-water call<a name='5717'></font>
     DO j = JTS , JTE<a name='5718'>
        DO i = ITS , ITE<a name='5719'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='5720'>
              XLAND_SEA(i,j)=2.<a name='5721'>
              MAVAIL_SEA(I,J)  =1.<a name='5722'>
              ZNT_SEA(I,J) = 0.0001<a name='5723'>
              TSK_SEA(i,j) = SST(i,j)<a name='5724'>
              IF ( SST(i,j) .LT. 271.4 ) THEN<a name='5725'>
                 SST(i,j) = 271.4<a name='5726'>
                 TSK_SEA(i,j) = SST(i,j)<a name='5727'>
              ENDIF<a name='5728'>
           ELSE<a name='5729'>
              XLAND_SEA(i,j) = XLAND(i,j)<a name='5730'>
              MAVAIL_SEA(i,j) = MAVAIL(i,j)<a name='5731'>
              ZNT_SEA(i,j)  = ZNT_HOLD(i,j)<a name='5732'>
              TSK_SEA(i,j) = TSK_LOCAL(i,j)<a name='5733'>
           ENDIF<a name='5734'>
        ENDDO<a name='5735'>
     ENDDO<a name='5736'>
<a name='5737'>
     <font color=#447700>! Restore the values from before the land/frozen-water call<a name='5738'></font>
     BR_SEA   = BR_HOLD<a name='5739'>
     CHS2_SEA = CHS2_HOLD<a name='5740'>
     CHS_SEA  = CHS_HOLD<a name='5741'>
     CPM_SEA  = CPM_HOLD<a name='5742'>
     CQS2_SEA = CQS2_HOLD<a name='5743'>
     FLHC_SEA = FLHC_HOLD<a name='5744'>
     FLQC_SEA = FLQC_HOLD<a name='5745'>
     GZ1OZ0_SEA = GZ1OZ0_HOLD<a name='5746'>
     HFX_SEA  = HFX_HOLD<a name='5747'>
     LH_SEA   = LH_HOLD<a name='5748'>
     MOL_SEA  = MOL_HOLD<a name='5749'>
     PSIH_SEA = PSIH_HOLD<a name='5750'>
     PSIM_SEA = PSIM_HOLD<a name='5751'>
     FH_SEA   = FH_HOLD<a name='5752'>
     FM_SEA   = FM_HOLD<a name='5753'>
     QFX_SEA  = QFX_HOLD<a name='5754'>
     QGH_SEA  = QGH_HOLD<a name='5755'>
     REGIME_SEA = REGIME_HOLD<a name='5756'>
     RMOL_SEA = RMOL_HOLD<a name='5757'>
     UST_SEA  = UST_HOLD<a name='5758'>
     WSPD_SEA = WSPD_HOLD<a name='5759'>
     ZOL_SEA  = ZOL_HOLD<a name='5760'>
<font color=#447700>!<a name='5761'></font>
     <font color=#447700>! open-water call<a name='5762'></font>
     call <A href='../../html_code/phys/module_sf_sfclayrev.F.html#SFCLAYREV'>sfclayrev</A><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAYREV_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAYREV_3">(U3D,V3D,T3D,QV3D,P3D,dz8w,                    &amp; <font color=#447700>! I<a name='5763'></font>
                 CP,G,ROVCP,R,XLV,PSFC,                        &amp; <font color=#447700>! I<a name='5764'></font>
                 CHS_SEA,CHS2_SEA,CQS2_SEA,CPM_SEA,            &amp; <font color=#447700>! I/O<a name='5765'></font>
                 ZNT_SEA,UST_SEA,                              &amp; <font color=#447700>! I/O<a name='5766'></font>
                 PBLH,MAVAIL_SEA,                              &amp; <font color=#447700>! I<a name='5767'></font>
                 ZOL_SEA,MOL_SEA,REGIME_SEA,PSIM_SEA,PSIH_SEA, &amp; <font color=#447700>! I/O<a name='5768'></font>
                 FM_SEA,FH_SEA,                                &amp;<a name='5769'>
                 XLAND_SEA,                              &amp; <font color=#447700>! I<a name='5770'></font>
                 HFX_SEA,QFX_SEA,LH_SEA,                       &amp; <font color=#447700>! I/O<a name='5771'></font>
                 TSK_SEA,                                      &amp; <font color=#447700>! I<a name='5772'></font>
                 FLHC_SEA,FLQC_SEA,QGH_SEA,QSFC_sea,RMOL_SEA,  &amp; <font color=#447700>! I/O<a name='5773'></font>
                 U10_sea,V10_sea,TH2_sea,T2_sea,Q2_sea,        &amp; <font color=#447700>! O<a name='5774'></font>
                 GZ1OZ0_SEA,WSPD_SEA,BR_SEA,                   &amp; <font color=#447700>! I/O<a name='5775'></font>
                 ISFFLX,DX,                                    &amp;<a name='5776'>
                 SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='5777'>
                 KARMAN,EOMEG,STBOLT,                          &amp;<a name='5778'>
                 P1000,                                      &amp;<a name='5779'>
                 ids,ide, jds,jde, kds,kde,                    &amp;<a name='5780'>
                 ims,ime, jms,jme, kms,kme,                    &amp;<a name='5781'>
                 its,ite, jts,jte, kts,kte,                    &amp; <font color=#447700>! 0<a name='5782'></font>
                 ustm_sea,ck_sea,cka_sea,cd_sea,cda_sea,isftcflx,iz0tlnd )<a name='5783'>
<font color=#447700>!<a name='5784'></font>
     DO j = JTS , JTE<a name='5785'>
        DO i = ITS, ITE<a name='5786'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD )  .and.( XICE(i,j) .LE. 1.0 ) ) THEN<a name='5787'>
              <font color=#447700>! weighted average for sea ice points<a name='5788'></font>
              br(i,j)     = ( br(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * br_sea(i,j)     )<a name='5789'>
              <font color=#447700>! CHS2 -- wait<a name='5790'></font>
              <font color=#447700>! CHS  -- wait<a name='5791'></font>
              <font color=#447700>! CPM  -- wait<a name='5792'></font>
              <font color=#447700>! CQS2 -- wait<a name='5793'></font>
              <font color=#447700>! FLHC -- wait<a name='5794'></font>
              <font color=#447700>! FLQC -- wait<a name='5795'></font>
              gz1oz0(i,j) = ( gz1oz0(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * gz1oz0_sea(i,j) )<a name='5796'>
              <font color=#447700>! HFX  -- wait<a name='5797'></font>
              <font color=#447700>! LH   -- wait<a name='5798'></font>
              mol(i,j)    = ( mol(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * mol_sea(i,j)    )<a name='5799'>
              psih(i,j)   = ( psih(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * psih_sea(i,j)   )<a name='5800'>
              psim(i,j)   = ( psim(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * psim_sea(i,j)   )<a name='5801'>
              fh(i,j)    = ( fh(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * fh_sea(i,j)   )<a name='5802'>
              fm(i,j)    = ( fm(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * fm_sea(i,j)   )<a name='5803'>
              <font color=#447700>! QFX  -- wait<a name='5804'></font>
              <font color=#447700>! QGH  -- wait<a name='5805'></font>
              if ( XICE(i,j).GE. 0.5 ) regime(i,j) = regime_hold(i,j)<a name='5806'>
              rmol(i,j)   = ( rmol(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * rmol_sea(i,j)   )<a name='5807'>
              ust(i,j)    = ( ust(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * ust_sea(i,j)    )<a name='5808'>
              wspd(i,j)   = ( wspd(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * wspd_sea(i,j)   )<a name='5809'>
              zol(i,j)    = ( zol(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * zol_sea(i,j)    )<a name='5810'>
              <font color=#447700>! INTENT(OUT) --------------------------------------------------------------------<a name='5811'></font>
              IF ( PRESENT ( CD ) ) THEN<a name='5812'>
                 CD(i,j)     = ( CD(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CD_sea(i,j)     )<a name='5813'>
              ENDIF<a name='5814'>
              IF ( PRESENT ( CDA ) ) THEN<a name='5815'>
                 CDA(i,j)     = ( CDA(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CDA_sea(i,j)     )<a name='5816'>
              ENDIF<a name='5817'>
              IF ( PRESENT ( CK ) ) THEN<a name='5818'>
                 CK(i,j)     = ( CK(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CK_sea(i,j)     )<a name='5819'>
              ENDIF<a name='5820'>
              IF ( PRESENT ( CKA ) ) THEN<a name='5821'>
                 CKA(i,j)     = ( CKA(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CKA_sea(i,j)     )<a name='5822'>
              ENDIF<a name='5823'>
              q2(i,j)     = ( q2(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * q2_sea(i,j)     )<a name='5824'>
              <font color=#447700>! QSFC -- wait<a name='5825'></font>
              t2(i,j)     = ( t2(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * t2_sea(i,j)     )<a name='5826'>
              th2(i,j)    = ( th2(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * th2_sea(i,j)    )<a name='5827'>
              u10(i,j)    = ( u10(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * u10_sea(i,j)    )<a name='5828'>
              IF ( PRESENT ( USTM ) ) THEN<a name='5829'>
                 USTM(i,j)    = ( USTM(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * USTM_sea(i,j)    )<a name='5830'>
              ENDIF<a name='5831'>
              v10(i,j)    = ( v10(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * v10_sea(i,j)    )<a name='5832'>
           ENDIF<a name='5833'>
        END DO<a name='5834'>
     END DO<a name='5835'>
<font color=#447700>!<a name='5836'></font>
<font color=#447700>!         tsk(i,j) = tsk(i,j)*XICE(i,j) + (1.0-XICE(i,j))*TSK_SEA(i,j)<a name='5837'></font>
<font color=#447700>!<a name='5838'></font>
   END SUBROUTINE sfclayrev_seaice_wrapper<a name='5839'>
<a name='5840'>
<font color=#447700>!-------------------------------------------------------------------------<a name='5841'></font>
<a name='5842'>
<A NAME='SFCLAY_SEAICE_WRAPPER'><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAY_SEAICE_WRAPPER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5843'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>sfclay_seaice_wrapper</font>(U3D,V3D,T3D,QV3D,P3D,dz8w,     &amp; <A href='../../call_to/SFCLAY_SEAICE_WRAPPER.html' TARGET='index'>1</A>,<A href='../../call_from/SFCLAY_SEAICE_WRAPPER.html' TARGET='index'>4</A><a name='5844'>
                     CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,      &amp;<a name='5845'>
                     ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='5846'>
                     FM,FH,                                        &amp;<a name='5847'>
                     XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='5848'>
                     U10,V10,TH2,T2,Q2,                            &amp;<a name='5849'>
                     GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='5850'>
                     SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='5851'>
                     KARMAN,EOMEG,STBOLT,                          &amp;<a name='5852'>
                     P1000,                                      &amp;<a name='5853'>
XICE,SST,TSK_SEA,                                                  &amp;<a name='5854'>
CHS2_SEA,CHS_SEA,CPM_SEA,CQS2_SEA,FLHC_SEA,FLQC_SEA,               &amp;<a name='5855'>
HFX_SEA,LH_SEA,QFX_SEA,QGH_SEA,QSFC_SEA,ZNT_SEA,                   &amp;<a name='5856'>
ITIMESTEP,TICE2TSK_IF2COLD,XICE_THRESHOLD,                         &amp;<a name='5857'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='5858'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='5859'>
                     its,ite, jts,jte, kts,kte,                    &amp;<a name='5860'>
                     ustm,ck,cka,cd,cda,isftcflx,iz0tlnd,          &amp;<a name='5861'>
                     sf_surface_physics                             )<a name='5862'>
<a name='5863'>
     USE <A href='../../html_code/phys/module_sf_sfclay.F.html#MODULE_SF_SFCLAY'>module_sf_sfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAY_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_SFCLAY_4"><a name='5864'>
     implicit none<a name='5865'>
<a name='5866'>
     INTEGER,  INTENT(IN )   ::        ids,ide, jds,jde, kds,kde,  &amp;<a name='5867'>
                                       ims,ime, jms,jme, kms,kme,  &amp;<a name='5868'>
                                       its,ite, jts,jte, kts,kte<a name='5869'>
<a name='5870'>
     INTEGER,  INTENT(IN )   ::        ISFFLX<a name='5871'>
     REAL,     INTENT(IN )   ::        SVP1,SVP2,SVP3,SVPT0<a name='5872'>
     REAL,     INTENT(IN )   ::        EP1,EP2,KARMAN,EOMEG,STBOLT<a name='5873'>
     REAL,     INTENT(IN )   ::        P1000<a name='5874'>
<a name='5875'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='5876'>
               INTENT(IN   )   ::                           dz8w<a name='5877'>
<a name='5878'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='5879'>
               INTENT(IN   )   ::                           QV3D, &amp;<a name='5880'>
                                                             P3D, &amp;<a name='5881'>
                                                             T3D<a name='5882'>
<a name='5883'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5884'>
               INTENT(IN   )               ::             MAVAIL, &amp;<a name='5885'>
                                                            PBLH, &amp;<a name='5886'>
                                                           XLAND, &amp;<a name='5887'>
                                                             TSK<a name='5888'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5889'>
               INTENT(OUT  )               ::                U10, &amp;<a name='5890'>
                                                             V10, &amp;<a name='5891'>
                                                             TH2, &amp;<a name='5892'>
                                                              T2, &amp;<a name='5893'>
                                                              Q2, &amp;<a name='5894'>
                                                            QSFC<a name='5895'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5896'>
               INTENT(INOUT)               ::             REGIME, &amp;<a name='5897'>
                                                             HFX, &amp;<a name='5898'>
                                                             QFX, &amp;<a name='5899'>
                                                              LH, &amp;<a name='5900'>
                                                         MOL,RMOL<a name='5901'>
<a name='5902'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5903'>
               INTENT(INOUT)   ::                 GZ1OZ0,WSPD,BR, &amp;<a name='5904'>
                                                 PSIM,PSIH,FM,FH<a name='5905'>
<a name='5906'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='5907'>
               INTENT(IN   )   ::                            U3D, &amp;<a name='5908'>
                                                             V3D<a name='5909'>
<a name='5910'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5911'>
               INTENT(IN   )               ::               PSFC<a name='5912'>
<a name='5913'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5914'>
               INTENT(INOUT)   ::                            ZNT, &amp;<a name='5915'>
                                                             ZOL, &amp;<a name='5916'>
                                                             UST, &amp;<a name='5917'>
                                                             CPM, &amp;<a name='5918'>
                                                            CHS2, &amp;<a name='5919'>
                                                            CQS2, &amp;<a name='5920'>
                                                             CHS<a name='5921'>
<a name='5922'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5923'>
               INTENT(INOUT)   ::                      FLHC,FLQC<a name='5924'>
<a name='5925'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='5926'>
               INTENT(INOUT)   ::                                 &amp;<a name='5927'>
                                                              QGH<a name='5928'>
<a name='5929'>
     REAL,     INTENT(IN   )               ::   CP,G,ROVCP,R,XLV,DX<a name='5930'>
<a name='5931'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme )              , &amp;<a name='5932'>
               INTENT(OUT)     ::                   ck,cka,cd,cda<a name='5933'>
     REAL, OPTIONAL, DIMENSION( ims:ime, jms:jme )              , &amp;<a name='5934'>
               INTENT(INOUT)   ::                            ustm<a name='5935'>
<a name='5936'>
     INTEGER,  OPTIONAL,  INTENT(IN )   ::     ISFTCFLX,IZ0TLND<a name='5937'>
<a name='5938'>
<font color=#447700>!--------------------------------------------------------------------<a name='5939'></font>
<font color=#447700>!    New for wrapper<a name='5940'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='5941'></font>
     INTEGER,  INTENT(IN)          ::    ITIMESTEP, sf_surface_physics<a name='5942'>
     LOGICAL,  INTENT(IN)               ::      TICE2TSK_IF2COLD<a name='5943'>
     REAL,     INTENT(IN)               ::      XICE_THRESHOLD<a name='5944'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='5945'>
               INTENT(IN)               ::      XICE<a name='5946'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='5947'>
               INTENT(INOUT)            ::      SST<a name='5948'>
     REAL,     DIMENSION( ims:ime, jms:jme ),                     &amp;<a name='5949'>
               INTENT(OUT)              ::      TSK_SEA,          &amp;<a name='5950'>
                                                CHS2_SEA,         &amp;<a name='5951'>
                                                CHS_SEA,          &amp;<a name='5952'>
                                                CPM_SEA,          &amp;<a name='5953'>
                                                CQS2_SEA,         &amp;<a name='5954'>
                                                FLHC_SEA,         &amp;<a name='5955'>
                                                FLQC_SEA,         &amp;<a name='5956'>
                                                HFX_SEA,          &amp;<a name='5957'>
                                                LH_SEA,           &amp;<a name='5958'>
                                                QFX_SEA,          &amp;<a name='5959'>
                                                QGH_SEA,          &amp;<a name='5960'>
                                                QSFC_SEA,         &amp;<a name='5961'>
                                                ZNT_SEA<a name='5962'>
<a name='5963'>
<font color=#447700>!--------------------------------------------------------------------<a name='5964'></font>
<font color=#447700>!    Local<a name='5965'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='5966'></font>
     INTEGER :: I, J<a name='5967'>
     REAL,     DIMENSION( ims:ime, jms:jme ) :: XLAND_SEA,        &amp;<a name='5968'>
                                                MAVAIL_sea,       &amp;<a name='5969'>
                                                TSK_LOCAL,        &amp;<a name='5970'>
                                                BR_HOLD,          &amp;<a name='5971'>
                                                CHS2_HOLD,        &amp;<a name='5972'>
                                                CHS_HOLD,         &amp;<a name='5973'>
                                                CPM_HOLD,         &amp;<a name='5974'>
                                                CQS2_HOLD,        &amp;<a name='5975'>
                                                FLHC_HOLD,        &amp;<a name='5976'>
                                                FLQC_HOLD,        &amp;<a name='5977'>
                                                GZ1OZ0_HOLD,      &amp;<a name='5978'>
                                                HFX_HOLD,         &amp;<a name='5979'>
                                                LH_HOLD,          &amp;<a name='5980'>
                                                MOL_HOLD,         &amp;<a name='5981'>
                                                PSIH_HOLD,        &amp;<a name='5982'>
                                                PSIM_HOLD,        &amp;<a name='5983'>
                                                FH_HOLD,          &amp;<a name='5984'>
                                                FM_HOLD,          &amp;<a name='5985'>
                                                QFX_HOLD,         &amp;<a name='5986'>
                                                QGH_HOLD,         &amp;<a name='5987'>
                                                REGIME_HOLD,      &amp;<a name='5988'>
                                                RMOL_HOLD,        &amp;<a name='5989'>
                                                UST_HOLD,         &amp;<a name='5990'>
                                                WSPD_HOLD,        &amp;<a name='5991'>
                                                ZNT_HOLD,         &amp;<a name='5992'>
                                                ZOL_HOLD,         &amp;<a name='5993'>
                                                TH2_HOLD,         &amp; <font color=#447700>!ssib<a name='5994'></font>
                                                T2_HOLD,          &amp; <font color=#447700>!ssib<a name='5995'></font>
                                                Q2_HOLD,          &amp; <font color=#447700>!ssib<a name='5996'></font>
                                                TSK_HOLD,         &amp; <font color=#447700>!ssib<a name='5997'></font>
                                                U10_HOLD,         &amp; <font color=#447700>!ssib<a name='5998'></font>
                                                V10_HOLD,         &amp; <font color=#447700>!ssib<a name='5999'></font>
                                                CD_SEA,           &amp;<a name='6000'>
                                                CDA_SEA,          &amp;<a name='6001'>
                                                CK_SEA,           &amp;<a name='6002'>
                                                CKA_SEA,          &amp;<a name='6003'>
                                                Q2_SEA,           &amp;<a name='6004'>
                                                T2_SEA,           &amp;<a name='6005'>
                                                TH2_SEA,          &amp;<a name='6006'>
                                                U10_SEA,          &amp;<a name='6007'>
                                                USTM_SEA,         &amp;<a name='6008'>
                                                V10_SEA<a name='6009'>
<a name='6010'>
     REAL,     DIMENSION( ims:ime, jms:jme ) ::                   &amp;<a name='6011'>
                                                BR_SEA,           &amp;<a name='6012'>
                                                GZ1OZ0_SEA,       &amp;<a name='6013'>
                                                MOL_SEA,          &amp;<a name='6014'>
                                                PSIH_SEA,         &amp;<a name='6015'>
                                                PSIM_SEA,         &amp;<a name='6016'>
                                                FH_SEA,           &amp;<a name='6017'>
                                                FM_SEA,           &amp;<a name='6018'>
                                                REGIME_SEA,       &amp;<a name='6019'>
                                                RMOL_SEA,         &amp;<a name='6020'>
                                                UST_SEA,          &amp;<a name='6021'>
                                                WSPD_SEA,         &amp;<a name='6022'>
                                                ZOL_SEA<a name='6023'>
<a name='6024'>
<font color=#447700>! INTENT(IN) to SFCLAY; unchanged by the call<a name='6025'></font>
      <font color=#447700>! ISFFLX<a name='6026'></font>
      <font color=#447700>! SVP1,SVP2,SVP3,SVPT0<a name='6027'></font>
      <font color=#447700>! EP1,EP2,KARMAN,EOMEG,STBOLT<a name='6028'></font>
      <font color=#447700>! CP,G,ROVCP,R,XLV,DX<a name='6029'></font>
      <font color=#447700>! ISFTCFLX,IZ0TLND<a name='6030'></font>
      <font color=#447700>! P1000<a name='6031'></font>
      <font color=#447700>! dz8w<a name='6032'></font>
      <font color=#447700>! QV3D<a name='6033'></font>
      <font color=#447700>! P3D<a name='6034'></font>
      <font color=#447700>! T3D<a name='6035'></font>
      <font color=#447700>! MAVAIL<a name='6036'></font>
      <font color=#447700>! PBLH<a name='6037'></font>
      <font color=#447700>! XLAND<a name='6038'></font>
      <font color=#447700>! TSK<a name='6039'></font>
      <font color=#447700>! U3D<a name='6040'></font>
      <font color=#447700>! V3D<a name='6041'></font>
      <font color=#447700>! PSFC<a name='6042'></font>
<a name='6043'>
     CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAY_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_10">( ims, ime, jms, jme, its, ite, jts, jte,  &amp;<a name='6044'>
                             itimestep, .true., tice2tsk_if2cold,     &amp;<a name='6045'>
                             XICE, XICE_THRESHOLD,                    &amp;<a name='6046'>
                             SST, TSK, TSK_SEA, TSK_LOCAL )<a name='6047'>
<a name='6048'>
<a name='6049'>
<font color=#447700>! INTENT (INOUT) to SFCLAY:  Save the variables before the first call<a name='6050'></font>
<font color=#447700>! (for land/frozen water) to SFCLAY, to keep from double-counting the<a name='6051'></font>
<font color=#447700>! effects of that routine<a name='6052'></font>
     BR_HOLD   = BR<a name='6053'>
     CHS2_HOLD = CHS2<a name='6054'>
     CHS_HOLD  = CHS<a name='6055'>
     CPM_HOLD  = CPM<a name='6056'>
     CQS2_HOLD = CQS2<a name='6057'>
     FLHC_HOLD = FLHC<a name='6058'>
     FLQC_HOLD = FLQC<a name='6059'>
     GZ1OZ0_HOLD = GZ1OZ0<a name='6060'>
     HFX_HOLD  = HFX<a name='6061'>
     LH_HOLD   = LH<a name='6062'>
     MOL_HOLD  = MOL<a name='6063'>
     PSIH_HOLD = PSIH<a name='6064'>
     PSIM_HOLD = PSIM<a name='6065'>
     FH_HOLD   = FH<a name='6066'>
     FM_HOLD   = FM<a name='6067'>
     QFX_HOLD  = QFX<a name='6068'>
     QGH_HOLD  = QGH<a name='6069'>
     REGIME_HOLD = REGIME<a name='6070'>
     RMOL_HOLD = RMOL<a name='6071'>
     UST_HOLD  = UST<a name='6072'>
     WSPD_HOLD = WSPD<a name='6073'>
     ZNT_HOLD  = ZNT<a name='6074'>
     ZOL_HOLD  = ZOL<a name='6075'>
<font color=#447700>!also save these variables for SSIB (fds 12/2010)<a name='6076'></font>
     TH2_HOLD = TH2<a name='6077'>
     T2_HOLD = T2<a name='6078'>
     Q2_HOLD = Q2<a name='6079'>
     TSK_HOLD = TSK<a name='6080'>
     U10_HOLD = U10 <font color=#447700>!fds (01/2014)<a name='6081'></font>
     V10_HOLD = V10 <font color=#447700>!fds (01/2014)<a name='6082'></font>
     <a name='6083'>
<font color=#447700>! INTENT(OUT) from SFCLAY.  Input shouldn't matter, but we'll want to<a name='6084'></font>
<font color=#447700>! keep things around for weighting after the second call to SFCLAY.<a name='6085'></font>
     <font color=#447700>! CD<a name='6086'></font>
     <font color=#447700>! CDA<a name='6087'></font>
     <font color=#447700>! CK<a name='6088'></font>
     <font color=#447700>! CKA<a name='6089'></font>
     <font color=#447700>! Q2<a name='6090'></font>
     <font color=#447700>! QSFC<a name='6091'></font>
     <font color=#447700>! T2<a name='6092'></font>
     <font color=#447700>! TH2<a name='6093'></font>
     <font color=#447700>! U10<a name='6094'></font>
     <font color=#447700>! USTM<a name='6095'></font>
     <font color=#447700>! V10<a name='6096'></font>
<a name='6097'>
<a name='6098'>
     <font color=#447700>! land/frozen-water call<a name='6099'></font>
     call <A href='../../html_code/phys/module_sf_sfclay.F.html#SFCLAY'>sfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAY_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAY_2">(U3D,V3D,T3D,QV3D,P3D,dz8w,                    &amp; <font color=#447700>! I<a name='6100'></font>
                 CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,      &amp; <font color=#447700>! I,I,I,I,I,I,IO,IO,IO,IO,<a name='6101'></font>
                 ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='6102'>
                 FM,FH,                                        &amp;<a name='6103'>
                 XLAND,HFX,QFX,LH,TSK_LOCAL,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='6104'>
                 U10,V10,TH2,T2,Q2,                            &amp;<a name='6105'>
                 GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='6106'>
                 SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='6107'>
                 KARMAN,EOMEG,STBOLT,                          &amp;<a name='6108'>
                 P1000,                                      &amp;<a name='6109'>
                 ids,ide, jds,jde, kds,kde,                    &amp;<a name='6110'>
                 ims,ime, jms,jme, kms,kme,                    &amp;<a name='6111'>
                 its,ite, jts,jte, kts,kte,                    &amp;<a name='6112'>
                 ustm,ck,cka,cd,cda,isftcflx,iz0tlnd           )<a name='6113'>
<font color=#447700>!<a name='6114'></font>
<font color=#447700>!Restore land-point values calculated by SSiB (fds 12/2010)<a name='6115'></font>
     IF (itimestep .gt. 1 .and. sf_surface_physics .EQ. 8) then<a name='6116'>
     DO j = JTS , JTE<a name='6117'>
        DO i = ITS, ITE<a name='6118'>
           IF ( XLAND(I,J) .LT. 1.5 ) THEN<a name='6119'>
              BR(I,J) = BR_HOLD(I,J)<a name='6120'>
              TH2(I,J) = TH2_HOLD(I,J)<a name='6121'>
              T2(I,J) = T2_HOLD(I,J)<a name='6122'>
              Q2(I,J) = Q2_HOLD(I,J)<a name='6123'>
              HFX(I,J) = HFX_HOLD(I,J)<a name='6124'>
              QFX(I,J) = QFX_HOLD(I,J)<a name='6125'>
              LH(I,J) = LH_HOLD(I,J)<a name='6126'>
              GZ1OZ0(I,J) = GZ1OZ0_HOLD(I,J)<a name='6127'>
              WSPD(I,J) = WSPD_HOLD(I,J)<a name='6128'>
              ZNT(I,J) = ZNT_HOLD(I,J)<a name='6129'>
              UST(I,J) = UST_HOLD(I,J)<a name='6130'>
<font color=#447700>!             TSK(I,J) = TSK_HOLD(I,J)<a name='6131'></font>
              U10(I,J) = U10_HOLD(I,J) <font color=#447700>!fds (01/2014)<a name='6132'></font>
              V10(I,J) = V10_HOLD(I,J) <font color=#447700>!fds (01/2014)<a name='6133'></font>
           ENDIF<a name='6134'>
        ENDDO<a name='6135'>
     ENDDO<a name='6136'>
     ENDIF<a name='6137'>
<font color=#447700>!<a name='6138'></font>
     <font color=#447700>! Set up for open-water call<a name='6139'></font>
     DO j = JTS , JTE<a name='6140'>
        DO i = ITS , ITE<a name='6141'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='6142'>
              XLAND_SEA(i,j)=2.<a name='6143'>
              MAVAIL_SEA(I,J)  =1.<a name='6144'>
              ZNT_SEA(I,J) = 0.0001<a name='6145'>
              TSK_SEA(i,j) = SST(i,j)<a name='6146'>
              IF ( SST(i,j) .LT. 271.4 ) THEN<a name='6147'>
                 SST(i,j) = 271.4<a name='6148'>
                 TSK_SEA(i,j) = SST(i,j)<a name='6149'>
              ENDIF<a name='6150'>
           ELSE<a name='6151'>
              XLAND_SEA(i,j) = XLAND(i,j)<a name='6152'>
              MAVAIL_SEA(i,j) = MAVAIL(i,j)<a name='6153'>
              ZNT_SEA(i,j)  = ZNT_HOLD(i,j)<a name='6154'>
              TSK_SEA(i,j) = TSK_LOCAL(i,j)<a name='6155'>
           ENDIF<a name='6156'>
        ENDDO<a name='6157'>
     ENDDO<a name='6158'>
<a name='6159'>
     <font color=#447700>! Restore the values from before the land/frozen-water call<a name='6160'></font>
     BR_SEA   = BR_HOLD<a name='6161'>
     CHS2_SEA = CHS2_HOLD<a name='6162'>
     CHS_SEA  = CHS_HOLD<a name='6163'>
     CPM_SEA  = CPM_HOLD<a name='6164'>
     CQS2_SEA = CQS2_HOLD<a name='6165'>
     FLHC_SEA = FLHC_HOLD<a name='6166'>
     FLQC_SEA = FLQC_HOLD<a name='6167'>
     GZ1OZ0_SEA = GZ1OZ0_HOLD<a name='6168'>
     HFX_SEA  = HFX_HOLD<a name='6169'>
     LH_SEA   = LH_HOLD<a name='6170'>
     MOL_SEA  = MOL_HOLD<a name='6171'>
     PSIH_SEA = PSIH_HOLD<a name='6172'>
     PSIM_SEA = PSIM_HOLD<a name='6173'>
     FH_SEA   = FH_HOLD<a name='6174'>
     FM_SEA   = FM_HOLD<a name='6175'>
     QFX_SEA  = QFX_HOLD<a name='6176'>
     QGH_SEA  = QGH_HOLD<a name='6177'>
     REGIME_SEA = REGIME_HOLD<a name='6178'>
     RMOL_SEA = RMOL_HOLD<a name='6179'>
     UST_SEA  = UST_HOLD<a name='6180'>
     WSPD_SEA = WSPD_HOLD<a name='6181'>
     ZOL_SEA  = ZOL_HOLD<a name='6182'>
<font color=#447700>!<a name='6183'></font>
     <font color=#447700>! open-water call<a name='6184'></font>
     call <A href='../../html_code/phys/module_sf_sfclay.F.html#SFCLAY'>sfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#SFCLAY_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SFCLAY_3">(U3D,V3D,T3D,QV3D,P3D,dz8w,                    &amp; <font color=#447700>! I<a name='6185'></font>
                 CP,G,ROVCP,R,XLV,PSFC,                        &amp; <font color=#447700>! I<a name='6186'></font>
                 CHS_SEA,CHS2_SEA,CQS2_SEA,CPM_SEA,            &amp; <font color=#447700>! I/O<a name='6187'></font>
                 ZNT_SEA,UST_SEA,                              &amp; <font color=#447700>! I/O<a name='6188'></font>
                 PBLH,MAVAIL_SEA,                              &amp; <font color=#447700>! I<a name='6189'></font>
                 ZOL_SEA,MOL_SEA,REGIME_SEA,PSIM_SEA,PSIH_SEA, &amp; <font color=#447700>! I/O<a name='6190'></font>
                 FM_SEA,FH_SEA,                                &amp;<a name='6191'>
                 XLAND_SEA,                              &amp; <font color=#447700>! I<a name='6192'></font>
                 HFX_SEA,QFX_SEA,LH_SEA,                       &amp; <font color=#447700>! I/O<a name='6193'></font>
                 TSK_SEA,                                      &amp; <font color=#447700>! I<a name='6194'></font>
                 FLHC_SEA,FLQC_SEA,QGH_SEA,QSFC_sea,RMOL_SEA,  &amp; <font color=#447700>! I/O<a name='6195'></font>
                 U10_sea,V10_sea,TH2_sea,T2_sea,Q2_sea,        &amp; <font color=#447700>! O<a name='6196'></font>
                 GZ1OZ0_SEA,WSPD_SEA,BR_SEA,                   &amp; <font color=#447700>! I/O<a name='6197'></font>
                 ISFFLX,DX,                                    &amp;<a name='6198'>
                 SVP1,SVP2,SVP3,SVPT0,EP1,EP2,                 &amp;<a name='6199'>
                 KARMAN,EOMEG,STBOLT,                          &amp;<a name='6200'>
                 P1000,                                      &amp;<a name='6201'>
                 ids,ide, jds,jde, kds,kde,                    &amp;<a name='6202'>
                 ims,ime, jms,jme, kms,kme,                    &amp;<a name='6203'>
                 its,ite, jts,jte, kts,kte,                    &amp; <font color=#447700>! 0<a name='6204'></font>
                 ustm_sea,ck_sea,cka_sea,cd_sea,cda_sea,isftcflx,iz0tlnd )<a name='6205'>
<font color=#447700>!<a name='6206'></font>
     DO j = JTS , JTE<a name='6207'>
        DO i = ITS, ITE<a name='6208'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD )  .and.( XICE(i,j) .LE. 1.0 ) ) THEN<a name='6209'>
              <font color=#447700>! weighted average for sea ice points<a name='6210'></font>
              br(i,j)     = ( br(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * br_sea(i,j)     )<a name='6211'>
              <font color=#447700>! CHS2 -- wait<a name='6212'></font>
              <font color=#447700>! CHS  -- wait<a name='6213'></font>
              <font color=#447700>! CPM  -- wait<a name='6214'></font>
              <font color=#447700>! CQS2 -- wait<a name='6215'></font>
              <font color=#447700>! FLHC -- wait<a name='6216'></font>
              <font color=#447700>! FLQC -- wait<a name='6217'></font>
              gz1oz0(i,j) = ( gz1oz0(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * gz1oz0_sea(i,j) )<a name='6218'>
              <font color=#447700>! HFX  -- wait<a name='6219'></font>
              <font color=#447700>! LH   -- wait<a name='6220'></font>
              mol(i,j)    = ( mol(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * mol_sea(i,j)    )<a name='6221'>
              psih(i,j)   = ( psih(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * psih_sea(i,j)   )<a name='6222'>
              psim(i,j)   = ( psim(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * psim_sea(i,j)   )<a name='6223'>
              fh(i,j)    = ( fh(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * fh_sea(i,j)   )<a name='6224'>
              fm(i,j)    = ( fm(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * fm_sea(i,j)   )<a name='6225'>
              <font color=#447700>! QFX  -- wait<a name='6226'></font>
              <font color=#447700>! QGH  -- wait<a name='6227'></font>
              if ( XICE(i,j).GE. 0.5 ) regime(i,j) = regime_hold(i,j)<a name='6228'>
              rmol(i,j)   = ( rmol(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * rmol_sea(i,j)   )<a name='6229'>
              ust(i,j)    = ( ust(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * ust_sea(i,j)    )<a name='6230'>
              wspd(i,j)   = ( wspd(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * wspd_sea(i,j)   )<a name='6231'>
              zol(i,j)    = ( zol(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * zol_sea(i,j)    )<a name='6232'>
              <font color=#447700>! INTENT(OUT) --------------------------------------------------------------------<a name='6233'></font>
              IF ( PRESENT ( CD ) ) THEN<a name='6234'>
                 CD(i,j)     = ( CD(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CD_sea(i,j)     )<a name='6235'>
              ENDIF<a name='6236'>
              IF ( PRESENT ( CDA ) ) THEN<a name='6237'>
                 CDA(i,j)     = ( CDA(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CDA_sea(i,j)     )<a name='6238'>
              ENDIF<a name='6239'>
              IF ( PRESENT ( CK ) ) THEN<a name='6240'>
                 CK(i,j)     = ( CK(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CK_sea(i,j)     )<a name='6241'>
              ENDIF<a name='6242'>
              IF ( PRESENT ( CKA ) ) THEN<a name='6243'>
                 CKA(i,j)     = ( CKA(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * CKA_sea(i,j)     )<a name='6244'>
              ENDIF<a name='6245'>
              q2(i,j)     = ( q2(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * q2_sea(i,j)     )<a name='6246'>
              <font color=#447700>! QSFC -- wait<a name='6247'></font>
              t2(i,j)     = ( t2(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * t2_sea(i,j)     )<a name='6248'>
              th2(i,j)    = ( th2(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * th2_sea(i,j)    )<a name='6249'>
              u10(i,j)    = ( u10(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * u10_sea(i,j)    )<a name='6250'>
              IF ( PRESENT ( USTM ) ) THEN<a name='6251'>
                 USTM(i,j)    = ( USTM(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * USTM_sea(i,j)    )<a name='6252'>
              ENDIF<a name='6253'>
              v10(i,j)    = ( v10(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * v10_sea(i,j)    )<a name='6254'>
           ENDIF<a name='6255'>
        END DO<a name='6256'>
     END DO<a name='6257'>
<font color=#447700>!<a name='6258'></font>
<font color=#447700>!         tsk(i,j) = tsk(i,j)*XICE(i,j) + (1.0-XICE(i,j))*TSK_SEA(i,j)<a name='6259'></font>
<font color=#447700>!<a name='6260'></font>
   END SUBROUTINE sfclay_seaice_wrapper<a name='6261'>
<a name='6262'>
<font color=#447700>!-------------------------------------------------------------------------<a name='6263'></font>
<font color=#447700>!-------------------------------------------------------------------------<a name='6264'></font>
<a name='6265'>
<A NAME='PXSFCLAY_SEAICE_WRAPPER'><A href='../../html_code/phys/module_surface_driver.F.html#PXSFCLAY_SEAICE_WRAPPER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6266'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>pxsfclay_seaice_wrapper</font>(U3D,V3D,T3D,TH3D,QV3D,P3D,dz8w, &amp; <A href='../../call_to/PXSFCLAY_SEAICE_WRAPPER.html' TARGET='index'>1</A>,<A href='../../call_from/PXSFCLAY_SEAICE_WRAPPER.html' TARGET='index'>4</A><a name='6267'>
                     CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,      &amp;<a name='6268'>
                     ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='6269'>
                     XLAND,HFX,QFX,LH,TSK,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='6270'>
                     U10,V10,                                      &amp;<a name='6271'>
                     GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='6272'>
                     SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,          &amp;<a name='6273'>
XICE, SST, ITIMESTEP, TICE2TSK_IF2COLD,XICE_THRESHOLD,             &amp;<a name='6274'>
CHS_SEA, CHS2_SEA, CPM_SEA, CQS2_SEA, FLHC_SEA, FLQC_SEA,          &amp;<a name='6275'>
HFX_SEA, LH_SEA, QFX_SEA, QGH_SEA, QSFC_SEA, TSK_SEA,  &amp;<a name='6276'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='6277'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='6278'>
                     its,ite, jts,jte, kts,kte                     )<a name='6279'>
     USE <A href='../../html_code/phys/module_sf_pxsfclay.F.html#MODULE_SF_PXSFCLAY'>module_sf_pxsfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#PXSFCLAY_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SF_PXSFCLAY_3"><a name='6280'>
     implicit none<a name='6281'>
     INTEGER,  INTENT(IN )   ::        ids,ide, jds,jde, kds,kde, &amp;<a name='6282'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='6283'>
                                       its,ite, jts,jte, kts,kte<a name='6284'>
<a name='6285'>
     INTEGER,  INTENT(IN )   ::        ISFFLX<a name='6286'>
     LOGICAL,  INTENT(IN )   ::        TICE2TSK_IF2COLD<a name='6287'>
     REAL,     INTENT(IN )   ::        SVP1,SVP2,SVP3,SVPT0<a name='6288'>
     REAL,     INTENT(IN )   ::        EP1,EP2,KARMAN<a name='6289'>
<a name='6290'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='6291'>
               INTENT(IN   )   ::                           dz8w<a name='6292'>
<a name='6293'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='6294'>
               INTENT(IN   )   ::                           QV3D, &amp;<a name='6295'>
                                                             P3D, &amp;<a name='6296'>
                                                             T3D, &amp;<a name='6297'>
                                                            TH3D<a name='6298'>
<a name='6299'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6300'>
               INTENT(IN   )               ::             MAVAIL, &amp;<a name='6301'>
                                                            PBLH, &amp;<a name='6302'>
                                                           XLAND, &amp;<a name='6303'>
                                                             TSK<a name='6304'>
     REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )           , &amp;<a name='6305'>
               INTENT(IN   )   ::                            U3D, &amp;<a name='6306'>
                                                             V3D<a name='6307'>
<a name='6308'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6309'>
               INTENT(IN   )               ::               PSFC<a name='6310'>
<a name='6311'>
     REAL,     INTENT(IN   )                  ::   CP,G,ROVCP,R,XLV,DX<a name='6312'>
<a name='6313'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6314'>
               INTENT(OUT  )               ::                U10, &amp;<a name='6315'>
                                                             V10, &amp;<a name='6316'>
                                                            QSFC<a name='6317'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6318'>
               INTENT(INOUT)               ::             REGIME, &amp;<a name='6319'>
                                                             HFX, &amp;<a name='6320'>
                                                             QFX, &amp;<a name='6321'>
                                                              LH, &amp;<a name='6322'>
                                                         MOL,RMOL<a name='6323'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6324'>
               INTENT(INOUT)   ::                 GZ1OZ0,WSPD,BR, &amp;<a name='6325'>
                                                       PSIM,PSIH<a name='6326'>
<a name='6327'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6328'>
               INTENT(INOUT)   ::                            ZNT, &amp;<a name='6329'>
                                                             ZOL, &amp;<a name='6330'>
                                                             UST, &amp;<a name='6331'>
                                                             CPM, &amp;<a name='6332'>
                                                            CHS2, &amp;<a name='6333'>
                                                            CQS2, &amp;<a name='6334'>
                                                             CHS<a name='6335'>
<a name='6336'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6337'>
               INTENT(INOUT)   ::                      FLHC,FLQC<a name='6338'>
<a name='6339'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6340'>
               INTENT(INOUT)   ::                            QGH<a name='6341'>
<a name='6342'>
<font color=#447700>!--------------------------------------------------------------------<a name='6343'></font>
<font color=#447700>!    For wrapper<a name='6344'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='6345'></font>
<a name='6346'>
     INTEGER,  INTENT(IN)                           :: ITIMESTEP<a name='6347'>
     REAL,     INTENT(IN)                           :: XICE_THRESHOLD<a name='6348'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6349'>
               INTENT(IN)                           ::      XICE<a name='6350'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6351'>
               INTENT(OUT)                        ::     TSK_SEA<a name='6352'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6353'>
               INTENT(INOUT)              ::                 SST<a name='6354'>
<a name='6355'>
<font color=#447700>!--------------------------------------------------------------------<a name='6356'></font>
<font color=#447700>!    Local<a name='6357'></font>
<font color=#447700>!--------------------------------------------------------------------<a name='6358'></font>
     INTEGER :: I, J<a name='6359'>
     REAL,     DIMENSION( ims:ime, jms:jme )                    , &amp;<a name='6360'>
               INTENT(OUT)    ::                         CHS_SEA, &amp;<a name='6361'>
                                                        CHS2_SEA, &amp;<a name='6362'>
                                                         CPM_SEA, &amp;<a name='6363'>
                                                        CQS2_SEA, &amp;<a name='6364'>
                                                        FLHC_SEA, &amp;<a name='6365'>
                                                        FLQC_SEA, &amp;<a name='6366'>
                                                         HFX_SEA, &amp;<a name='6367'>
                                                          LH_SEA, &amp;<a name='6368'>
                                                         QFX_SEA, &amp;<a name='6369'>
                                                         QGH_SEA, &amp;<a name='6370'>
                                                        QSFC_SEA<a name='6371'>
<a name='6372'>
     REAL,     DIMENSION( ims:ime, jms:jme ) ::          BR_HOLD, &amp;<a name='6373'>
                                                        CHS_HOLD, &amp;<a name='6374'>
                                                       CHS2_HOLD, &amp;<a name='6375'>
                                                        CPM_HOLD, &amp;<a name='6376'>
                                                       CQS2_HOLD, &amp;<a name='6377'>
                                                       FLHC_HOLD, &amp;<a name='6378'>
                                                       FLQC_HOLD, &amp;<a name='6379'>
                                                     GZ1OZ0_HOLD, &amp;<a name='6380'>
                                                        HFX_HOLD, &amp;<a name='6381'>
                                                         LH_HOLD, &amp;<a name='6382'>
                                                        MOL_HOLD, &amp;<a name='6383'>
                                                       PSIH_HOLD, &amp;<a name='6384'>
                                                       PSIM_HOLD, &amp;<a name='6385'>
                                                        QFX_HOLD, &amp;<a name='6386'>
                                                        QGH_HOLD, &amp;<a name='6387'>
                                                     REGIME_HOLD, &amp;<a name='6388'>
                                                       RMOL_HOLD, &amp;<a name='6389'>
                                                        UST_HOLD, &amp;<a name='6390'>
                                                       WSPD_HOLD, &amp;<a name='6391'>
                                                        ZNT_HOLD, &amp;<a name='6392'>
                                                        ZOL_HOLD, &amp;<a name='6393'>
                                                       TSK_LOCAL<a name='6394'>
<a name='6395'>
     REAL,     DIMENSION( ims:ime, jms:jme ) ::        XLAND_SEA, &amp;<a name='6396'>
                                                      MAVAIL_SEA, &amp;<a name='6397'>
                                                          BR_SEA, &amp;<a name='6398'>
                                                      GZ1OZ0_SEA, &amp;<a name='6399'>
                                                         MOL_SEA, &amp;<a name='6400'>
                                                        PSIH_SEA, &amp;<a name='6401'>
                                                        PSIM_SEA, &amp;<a name='6402'>
                                                      REGIME_SEA, &amp;<a name='6403'>
                                                        RMOL_SEA, &amp;<a name='6404'>
                                                         UST_SEA, &amp;<a name='6405'>
                                                        WSPD_SEA, &amp;<a name='6406'>
                                                         ZNT_SEA, &amp;<a name='6407'>
                                                         ZOL_SEA, &amp;<a name='6408'>
                                                         U10_SEA, &amp;<a name='6409'>
                                                         V10_SEA<a name='6410'>
<a name='6411'>
     CALL <A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK'>get_local_ice_tsk</A><A href='../../html_code/phys/module_surface_driver.F.html#PXSFCLAY_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_LOCAL_ICE_TSK_11">( ims, ime, jms, jme, its, ite, jts, jte,  &amp;<a name='6412'>
                             itimestep, .true., tice2tsk_if2cold,     &amp;<a name='6413'>
                             XICE, XICE_THRESHOLD,                    &amp;<a name='6414'>
                             SST, TSK, TSK_SEA, TSK_LOCAL )<a name='6415'>
<font color=#447700>!<a name='6416'></font>
<font color=#447700>! INTENT (INOUT) to PXSFCLAY:  Save the variables before the first call<a name='6417'></font>
<font color=#447700>! (for land/frozen water) to SFCLAY, to keep from double-counting the<a name='6418'></font>
<font color=#447700>! effects of that routine<a name='6419'></font>
<font color=#447700>!<a name='6420'></font>
     BR_HOLD     = BR<a name='6421'>
     CHS_HOLD    = CHS<a name='6422'>
     CHS2_HOLD   = CHS2<a name='6423'>
     CPM_HOLD    = CPM<a name='6424'>
     CQS2_HOLD   = CQS2<a name='6425'>
     FLHC_HOLD   = FLHC<a name='6426'>
     FLQC_HOLD   = FLQC<a name='6427'>
     GZ1OZ0_HOLD = GZ1OZ0<a name='6428'>
     HFX_HOLD    = HFX<a name='6429'>
     LH_HOLD     = LH<a name='6430'>
     MOL_HOLD    = MOL<a name='6431'>
     PSIH_HOLD   = PSIH<a name='6432'>
     PSIM_HOLD   = PSIM<a name='6433'>
     QFX_HOLD    = QFX<a name='6434'>
     QGH_HOLD    = QGH<a name='6435'>
     REGIME_HOLD = REGIME<a name='6436'>
     RMOL_HOLD   = RMOL<a name='6437'>
     UST_HOLD    = UST<a name='6438'>
     WSPD_HOLD   = WSPD<a name='6439'>
     ZNT_HOLD    = ZNT<a name='6440'>
     ZOL_HOLD    = ZOL<a name='6441'>
<a name='6442'>
<font color=#447700>! INTENT(OUT) from PXSFCLAY.  Input shouldn't matter, but we'll want to<a name='6443'></font>
<font color=#447700>! keep things around for weighting after the second call to PXSFCLAY.<a name='6444'></font>
     <font color=#447700>! U10<a name='6445'></font>
     <font color=#447700>! V10<a name='6446'></font>
     <font color=#447700>! QSFC<a name='6447'></font>
<a name='6448'>
<font color=#447700>! Land/frozen-water call.<a name='6449'></font>
     CALL <A href='../../html_code/phys/module_sf_pxsfclay.F.html#PXSFCLAY'>pxsfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#PXSFCLAY_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXSFCLAY_2">(U3D,V3D,T3D,TH3D,QV3D,P3D,dz8w,                 &amp;<a name='6450'>
                     CP,G,ROVCP,R,XLV,PSFC,CHS,CHS2,CQS2,CPM,      &amp;<a name='6451'>
                     ZNT,UST,PBLH,MAVAIL,ZOL,MOL,REGIME,PSIM,PSIH, &amp;<a name='6452'>
                     XLAND,HFX,QFX,LH,TSK_LOCAL,FLHC,FLQC,QGH,QSFC,RMOL, &amp;<a name='6453'>
                     U10,V10,                                      &amp;<a name='6454'>
                     GZ1OZ0,WSPD,BR,ISFFLX,DX,                     &amp;<a name='6455'>
                     SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,ITIMESTEP,&amp;<a name='6456'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='6457'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='6458'>
                     its,ite, jts,jte, kts,kte                     )<a name='6459'>
<a name='6460'>
     DO j = JTS , JTE<a name='6461'>
        DO i= ITS , ITE<a name='6462'>
           IF( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='6463'>
              <font color=#447700>! Sets up things for open ocean.<a name='6464'></font>
              XLAND_SEA(i,j)=2.<a name='6465'>
              MAVAIL_SEA(I,J)  =1.<a name='6466'>
              ZNT_SEA(I,J) = 0.0001<a name='6467'>
              TSK_SEA(i,j)  = SST(i,j)<a name='6468'>
              if ( SST(i,j) .LT. 271.4 ) then<a name='6469'>
                 SST(i,j) = 271.4<a name='6470'>
                 TSK_SEA(i,j) = SST(i,j)<a name='6471'>
              endif<a name='6472'>
           ELSE<a name='6473'>
              XLAND_SEA(i,j)=xland(i,j)<a name='6474'>
              MAVAIL_SEA(i,j) = mavail(i,j)<a name='6475'>
              ZNT_SEA(I,J)  = ZNT_HOLD(I,J)<a name='6476'>
              TSK_SEA(i,j)  = TSK(i,j)<a name='6477'>
           ENDIF<a name='6478'>
        ENDDO<a name='6479'>
     ENDDO<a name='6480'>
<a name='6481'>
     <font color=#447700>! INTENT(INOUT) variables held over from before the first call to PXSFCLAY:<a name='6482'></font>
     BR_SEA     = BR_HOLD<a name='6483'>
     CHS_SEA    = CHS_HOLD<a name='6484'>
     CHS2_SEA   = CHS2_HOLD<a name='6485'>
     CPM_SEA    = CPM_HOLD<a name='6486'>
     CQS2_SEA   = CQS2_HOLD<a name='6487'>
     FLHC_SEA   = FLHC_HOLD<a name='6488'>
     FLQC_SEA   = FLQC_HOLD<a name='6489'>
     GZ1OZ0_SEA = GZ1OZ0_HOLD<a name='6490'>
     HFX_SEA    = HFX_HOLD<a name='6491'>
     LH_SEA     = LH_HOLD<a name='6492'>
     MOL_SEA    = MOL_HOLD<a name='6493'>
     PSIH_SEA   = PSIH_HOLD<a name='6494'>
     PSIM_SEA   = PSIM_HOLD<a name='6495'>
     QFX_SEA    = QFX_HOLD<a name='6496'>
     QGH_SEA    = QGH_HOLD<a name='6497'>
     REGIME_SEA = REGIME_HOLD<a name='6498'>
     RMOL_SEA   = RMOL_HOLD<a name='6499'>
     UST_SEA    = UST_HOLD<a name='6500'>
     WSPD_SEA   = WSPD_HOLD<a name='6501'>
     ZOL_SEA    = ZOL_HOLD<a name='6502'>
<a name='6503'>
<font color=#447700>! Open-water call.<a name='6504'></font>
     <font color=#447700>! Variables newly set (INTENT(OUT)) or changed (INTENT(INOUT)) by<a name='6505'></font>
     <font color=#447700>! PXSFCLAY are here appended with the "_SEA" label.<a name='6506'></font>
     <font color=#447700>! Special intent(IN) variables here:  XLAND_SEA, MAVAIL_SEA, TSK_SEA<a name='6507'></font>
     CALL <A href='../../html_code/phys/module_sf_pxsfclay.F.html#PXSFCLAY'>pxsfclay</A><A href='../../html_code/phys/module_surface_driver.F.html#PXSFCLAY_SEAICE_WRAPPER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXSFCLAY_3">(U3D,V3D,T3D,TH3D,QV3D,P3D,dz8w,                 &amp;<a name='6508'>
                     CP,G,ROVCP,R,XLV,PSFC,CHS_SEA,CHS2_SEA,CQS2_SEA,CPM_SEA,      &amp;<a name='6509'>
                     ZNT_SEA,UST_SEA,PBLH,MAVAIL_SEA,ZOL_SEA,MOL_SEA,REGIME_SEA,PSIM_SEA,PSIH_SEA, &amp;<a name='6510'>
                     XLAND_SEA,HFX_SEA,QFX_SEA,LH_SEA,TSK_SEA,FLHC_SEA,FLQC_SEA,QGH_SEA,QSFC_SEA,RMOL_SEA, &amp;<a name='6511'>
                     U10_SEA,V10_SEA,                              &amp;<a name='6512'>
                     GZ1OZ0_SEA,WSPD_SEA,BR_SEA,ISFFLX,DX,         &amp;<a name='6513'>
                     SVP1,SVP2,SVP3,SVPT0,EP1,EP2,KARMAN,ITIMESTEP,&amp;<a name='6514'>
                     ids,ide, jds,jde, kds,kde,                    &amp;<a name='6515'>
                     ims,ime, jms,jme, kms,kme,                    &amp;<a name='6516'>
                     its,ite, jts,jte, kts,kte                     )<a name='6517'>
<a name='6518'>
     DO j = JTS , JTE<a name='6519'>
        DO i = ITS , ITE<a name='6520'>
           IF ( ( XICE(I,J) .GE. XICE_THRESHOLD ) .and. ( XICE(i,j) .LE. 1.0 ) ) THEN<a name='6521'>
              <font color=#447700>! INTENT (INOUT) for PXSFCLAY:<a name='6522'></font>
              br(i,j)     = ( br(i,j)     * XICE(i,j) ) + ( (1.0-XICE(i,j)) * br_sea(i,j)     )<a name='6523'>
              gz1oz0(i,j) = ( gz1oz0(i,j) * XICE(i,j) ) + ( (1.0-XICE(i,j)) * gz1oz0_sea(i,j) )<a name='6524'>
              mol(i,j)    = ( mol(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * mol_sea(i,j)    )<a name='6525'>
              psih(i,j)   = ( psih(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * psih_sea(i,j)   )<a name='6526'>
              psim(i,j)   = ( psim(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * psim_sea(i,j)   )<a name='6527'>
              rmol(i,j)   = ( rmol(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * rmol_sea(i,j)   )<a name='6528'>
              ust(i,j)    = ( ust(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * ust_sea(i,j)    )<a name='6529'>
              wspd(i,j)   = ( wspd(i,j)   * XICE(i,j) ) + ( (1.0-XICE(i,j)) * wspd_sea(i,j)   )<a name='6530'>
              zol(i,j)    = ( zol(i,j)    * XICE(i,j) ) + ( (1.0-XICE(i,j)) * zol_sea(i,j)    )<a name='6531'>
              <font color=#447700>! REGIME:  Special case for this variable.  Just take the land values.<a name='6532'></font>
              <font color=#447700>! CHS -- wait<a name='6533'></font>
              <font color=#447700>! CHS2 -- wait<a name='6534'></font>
              <font color=#447700>! CPM -- wait<a name='6535'></font>
              <font color=#447700>! CQS2 -- wait<a name='6536'></font>
              <font color=#447700>! FLHC -- wait<a name='6537'></font>
              <font color=#447700>! FLQC -- wait<a name='6538'></font>
              <font color=#447700>! HFX -- wait<a name='6539'></font>
              <font color=#447700>! LH -- wait<a name='6540'></font>
              <font color=#447700>! QFX -- wait<a name='6541'></font>
              <font color=#447700>! QGH -- wait<a name='6542'></font>
<a name='6543'>
              <font color=#447700>! INTENT (OUT) from PXSFCLAY:<a name='6544'></font>
              u10(i,j) = ( u10(i,j)       * XICE(i,j) ) + ( (1.0-XICE(i,j)) * u10_sea(i,j)    )<a name='6545'>
              v10(i,j) = ( v10(i,j)       * XICE(i,j) ) + ( (1.0-XICE(i,j)) * v10_sea(i,j)    )<a name='6546'>
              <font color=#447700>! QSFC -- wait<a name='6547'></font>
           ENDIF<a name='6548'>
        ENDDO<a name='6549'>
     ENDDO<a name='6550'>
<a name='6551'>
   END SUBROUTINE pxsfclay_seaice_wrapper<a name='6552'>
<a name='6553'>
<font color=#447700>!-------------------------------------------------------------------------<a name='6554'></font>
<a name='6555'>
<A NAME='TOPO_RAD_ADJ_DRVR'><A href='../../html_code/phys/module_surface_driver.F.html#TOPO_RAD_ADJ_DRVR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6556'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TOPO_RAD_ADJ_DRVR</font> (XLAT,XLONG,COSZEN,               &amp; <A href='../../call_to/TOPO_RAD_ADJ_DRVR.html' TARGET='index'>1</A>,<A href='../../call_from/TOPO_RAD_ADJ_DRVR.html' TARGET='index'>1</A><a name='6557'>
                    shadowmask, diffuse_frac,                     &amp;<a name='6558'>
                    declin,                                       &amp;<a name='6559'>
                    SWDOWN,GSW,SWNORM,GSWSAVE,solcon,hrang2d,     &amp;<a name='6560'>
                    slope_in,slp_azi_in,                          &amp;<a name='6561'>
                ids, ide, jds, jde, kds, kde,                     &amp;<a name='6562'>
                ims, ime, jms, jme, kms, kme,                     &amp;<a name='6563'>
                its, ite, jts, jte, kts, kte                      )<a name='6564'>
<font color=#447700>!------------------------------------------------------------------<a name='6565'></font>
   IMPLICIT NONE<a name='6566'>
<font color=#447700>!------------------------------------------------------------------<a name='6567'></font>
   INTEGER, INTENT(IN)   ::       its,ite,jts,jte,kts,kte,        &amp;<a name='6568'>
                                  ims,ime,jms,jme,kms,kme,        &amp;<a name='6569'>
                                  ids,ide,jds,jde,kds,kde<a name='6570'>
   INTEGER, DIMENSION( ims:ime, jms:jme ),                        &amp;<a name='6571'>
         INTENT(IN)      ::       shadowmask<a name='6572'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='6573'>
         INTENT(IN)      ::       diffuse_frac<a name='6574'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='6575'>
         INTENT(IN   )   ::       XLAT,XLONG<a name='6576'>
   REAL, DIMENSION( ims:ime, jms:jme ),                           &amp;<a name='6577'>
         INTENT(INOUT)   ::       SWDOWN,GSW,SWNORM,GSWSAVE<a name='6578'>
   real,intent(in)  :: solcon   <a name='6579'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: hrang2d,coszen <a name='6580'>
<a name='6581'>
<a name='6582'>
   REAL, INTENT(IN    )  ::       declin<a name='6583'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: slope_in,slp_azi_in<a name='6584'>
<a name='6585'>
<a name='6586'>
<font color=#447700>! LOCAL VARS<a name='6587'></font>
   integer    :: i,j<a name='6588'>
   real       :: pi,degrad<a name='6589'>
   integer    :: shadow<a name='6590'>
   real       :: swdown_teradj,swdown_in,xlat1,xlong1<a name='6591'>
<a name='6592'>
<font color=#447700>!------------------------------------------------------------------<a name='6593'></font>
<a name='6594'>
     pi = 4.*atan(1.)<a name='6595'>
     degrad=pi/180.<a name='6596'>
<a name='6597'>
       DO J=jts,jte<a name='6598'>
       DO I=its,ite<a name='6599'>
         SWNORM(i,j) = SWDOWN(i,j)     <font color=#447700>! save<a name='6600'></font>
         IF(SWDOWN(I,J) .GT. 1.E-3)THEN  <font color=#447700>! daytime<a name='6601'></font>
             shadow = shadowmask(i,j)<a name='6602'>
<a name='6603'>
         SWDOWN_IN = SWDOWN(i,j)<a name='6604'>
         XLAT1 = XLAT(i,j)<a name='6605'>
         XLONG1 = XLONG(i,j)<a name='6606'>
         CALL <A href='../../html_code/phys/module_surface_driver.F.html#TOPO_RAD_ADJ'>TOPO_RAD_ADJ</A><A href='../../html_code/phys/module_surface_driver.F.html#TOPO_RAD_ADJ_DRVR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOPO_RAD_ADJ_1"> (XLAT1,XLONG1,COSZEN(i,j),             &amp;<a name='6607'>
                    diffuse_frac(i,j),DECLIN,DEGRAD,              &amp;<a name='6608'>
                    SWDOWN_IN,solcon,hrang2d(i,j),SWDOWN_teradj,  &amp;<a name='6609'>
                    kts,kte,                                      &amp;<a name='6610'>
                    slope_in(i,j),slp_azi_in(i,j),                &amp;<a name='6611'>
                    shadow , i,j                                  &amp;<a name='6612'>
                    )<a name='6613'>
<a name='6614'>
         GSWSAVE(I,J) = GSW(I,J)       <font color=#447700>! save<a name='6615'></font>
         GSW(I,J) = GSW(I,J)*SWDOWN_teradj/SWDOWN(i,j)<a name='6616'>
         SWDOWN(i,j) = SWDOWN_teradj<a name='6617'>
<a name='6618'>
         ENDIF <font color=#447700>! daytime<a name='6619'></font>
       ENDDO  <font color=#447700>! i_loop<a name='6620'></font>
       ENDDO  <font color=#447700>! j_loop<a name='6621'></font>
<a name='6622'>
<a name='6623'>
   END SUBROUTINE TOPO_RAD_ADJ_DRVR<a name='6624'>
<font color=#447700>!------------------------------------------------------------------<a name='6625'></font>
<font color=#447700>!------------------------------------------------------------------<a name='6626'></font>
<A NAME='TOPO_RAD_ADJ'><A href='../../html_code/phys/module_surface_driver.F.html#TOPO_RAD_ADJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6627'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>TOPO_RAD_ADJ</font> (XLAT1,XLONG1,COSZEN,                 &amp; <A href='../../call_to/TOPO_RAD_ADJ.html' TARGET='index'>1</A><a name='6628'>
                    diffuse_frac_in,DECLIN,DEGRAD,               &amp;<a name='6629'>
                    SWDOWN_IN,solcon,hrang,SWDOWN_teradj,        &amp;<a name='6630'>
                    kts,kte,                                     &amp;<a name='6631'>
                    slope,slp_azi,                               &amp;<a name='6632'>
                    shadow                                       &amp;<a name='6633'>
                    ,i,j)<a name='6634'>
<a name='6635'>
<font color=#447700>!------------------------------------------------------------------<a name='6636'></font>
   IMPLICIT NONE<a name='6637'>
<font color=#447700>!------------------------------------------------------------------<a name='6638'></font>
  INTEGER, INTENT(IN)       :: kts,kte<a name='6639'>
  REAL, INTENT(IN)          :: COSZEN,DECLIN,              &amp;<a name='6640'>
                               XLAT1,XLONG1,DEGRAD<a name='6641'>
  REAL, INTENT(IN)          :: SWDOWN_IN,solcon,hrang<a name='6642'>
  INTEGER, INTENT(IN)       :: shadow<a name='6643'>
  REAL, INTENT(IN)          :: slp_azi,slope<a name='6644'>
  REAL, INTENT(IN)          :: diffuse_frac_in<a name='6645'>
<a name='6646'>
  REAL, INTENT(OUT)         :: SWDOWN_teradj<a name='6647'>
<a name='6648'>
<font color=#447700>! LOCAL VARS<a name='6649'></font>
   REAL            :: XT24,TLOCTM,CSZA,XXLAT<a name='6650'>
   REAL            :: diffuse_frac,corr_fac,csza_slp<a name='6651'>
   integer         :: i,j<a name='6652'>
<a name='6653'>
<a name='6654'>
<font color=#447700>!------------------------------------------------------------------<a name='6655'></font>
<a name='6656'>
     SWDOWN_teradj=SWDOWN_IN<a name='6657'>
<a name='6658'>
     CSZA=COSZEN<a name='6659'>
     XXLAT=XLAT1*DEGRAD<a name='6660'>
<a name='6661'>
<font color=#447700>! RETURN IF NIGHT<a name='6662'></font>
         IF(CSZA.LE.1.E-4) return <a name='6663'>
        <a name='6664'>
<font color=#447700>!  Parameterize diffuse fraction of global solar radiation as a function of the ratio <a name='6665'></font>
<font color=#447700>!    between TOA radiation and surface global radiation<a name='6666'></font>
<font color=#447700>!             diffuse_frac = min(1.,1./(max(0.1,2.1-2.8*log(log(csza*solcon/max(SWDOWN_IN,1.e-3))))))<a name='6667'></font>
              diffuse_frac = diffuse_frac_in<a name='6668'>
        if ((slope.eq.0).or.(diffuse_frac.eq.1).or.(csza.le.1.e-4)) then<a name='6669'>
<font color=#447700>!  no topographic effects when all radiation diffuse or sun too close to horizon<a name='6670'></font>
          corr_fac = 1<a name='6671'>
          if(shadow.eq.1) corr_fac = diffuse_frac<a name='6672'>
          goto 140<a name='6673'>
        endif<a name='6674'>
<a name='6675'>
<font color=#447700>! cosine of zenith angle over sloping topography<a name='6676'></font>
        csza_slp = ((SIN(XXLAT)*COS(HRANG))*                                          &amp;<a name='6677'>
                    (-cos(slp_azi)*sin(slope))-SIN(HRANG)*(sin(slp_azi)*sin(slope))+  &amp;<a name='6678'>
                    (COS(XXLAT)*COS(HRANG))*cos(slope))*                              &amp;<a name='6679'>
                   COS(DECLIN)+(COS(XXLAT)*(cos(slp_azi)*sin(slope))+                 &amp;<a name='6680'>
                   SIN(XXLAT)*cos(slope))*SIN(DECLIN)<a name='6681'>
        IF(csza_slp.LE.1.E-4) csza_slp = 0<a name='6682'>
<a name='6683'>
<font color=#447700>! Topographic shading<a name='6684'></font>
        if (shadow.eq.1) csza_slp = 0<a name='6685'>
<a name='6686'>
<font color=#447700>! Correction factor for sloping topography; the diffuse fraction of solar radiation <a name='6687'></font>
<font color=#447700>!   is assumed to be unaffected by the slope<a name='6688'></font>
        corr_fac = diffuse_frac + (1-diffuse_frac)*csza_slp/csza<a name='6689'>
<a name='6690'>
 140        continue<a name='6691'>
<a name='6692'>
      SWDOWN_teradj=(1.)*SWDOWN_IN*corr_fac<a name='6693'>
<a name='6694'>
   END SUBROUTINE TOPO_RAD_ADJ<a name='6695'>
<a name='6696'>
<font color=#447700>!=======================================================================<a name='6697'></font>
<a name='6698'>
<A NAME='GET_LOCAL_ICE_TSK'><A href='../../html_code/phys/module_surface_driver.F.html#GET_LOCAL_ICE_TSK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6699'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_local_ice_tsk</font> ( ims, ime, jms, jme,     &amp; <A href='../../call_to/GET_LOCAL_ICE_TSK.html' TARGET='index'>11</A><a name='6700'>
                                  its, ite, jts, jte,     &amp;<a name='6701'>
                                  itimestep,              &amp;<a name='6702'>
                                  sfc_layer_values,       &amp;<a name='6703'>
                                  tice2tsk_if2cold,       &amp;<a name='6704'>
                                  XICE, XICE_THRESHOLD,   &amp;<a name='6705'>
                                  SST, TSK, TSK_SEA, TSK_ICE )<a name='6706'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='6707'></font>
<font color=#447700>!<a name='6708'></font>
<font color=#447700>! For grid cells with a fractional ice area, derive the ice surface <a name='6709'></font>
<font color=#447700>! temperature from the area-averaged surface temperature (the blended<a name='6710'></font>
<font color=#447700>! result of the open-water values (SST) and the ice-covered value).<a name='6711'></font>
<font color=#447700>!<a name='6712'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='6713'></font>
<a name='6714'>
      IMPLICIT NONE<a name='6715'>
<a name='6716'>
      INTEGER, INTENT(IN) :: ims, ime, jms, jme    <font color=#447700>!-- start/end index for i/j in memory<a name='6717'></font>
      INTEGER, INTENT(IN) :: its, ite, jts, jte    <font color=#447700>!-- start/end index for i/j in tile<a name='6718'></font>
      INTEGER, INTENT(IN) :: itimestep             <font color=#447700>!-- timestep<a name='6719'></font>
      LOGICAL, INTENT(IN) :: sfc_layer_values      <font color=#447700>!-- True if there are surface layer routine values<a name='6720'></font>
                                                   <font color=#447700>!-- available from the ice portion of the grid point<a name='6721'></font>
                                                   <font color=#447700>!-- (i.e. called from a seaice_wrapper subroutine)<a name='6722'></font>
      LOGICAL, INTENT(IN) :: tice2tsk_if2cold      <font color=#447700>!-- True to set TSK_ICE to TSK.  This may be<a name='6723'></font>
                                                   <font color=#447700>!-- necessary to avoid unphysically low ice<a name='6724'></font>
                                                   <font color=#447700>!-- temperatures is there is a mis-match between<a name='6725'></font>
                                                   <font color=#447700>!-- ice fraction and surface temperature.<a name='6726'></font>
<a name='6727'>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN)    :: XICE        <font color=#447700>! Ice fraction<a name='6728'></font>
      REAL                                , INTENT(IN)    :: XICE_THRESHOLD <a name='6729'>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN)    :: TSK         <font color=#447700>! Surface temperature (K)<a name='6730'></font>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT) :: SST         <font color=#447700>! Sea surface temperature (K)<a name='6731'></font>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(OUT)   :: TSK_SEA     <font color=#447700>! Sfc temp of open water portion of grid cell <a name='6732'></font>
      REAL, DIMENSION( ims:ime , jms:jme ), INTENT(OUT)   :: TSK_ICE     <font color=#447700>! Sfc temp of ice oprtion of grid cell<a name='6733'></font>
<a name='6734'>
<font color=#447700>! Local<a name='6735'></font>
      INTEGER :: i,j<a name='6736'>
      REAL    :: TICE_MIN<a name='6737'>
<a name='6738'>
      TICE_MIN = 221.4<a name='6739'>
<a name='6740'>
      DO j = JTS , JTE<a name='6741'>
         DO i = ITS , ITE<a name='6742'>
            IF ( ( XICE(i,j) &gt;= XICE_THRESHOLD ) .AND. ( XICE(I,J) &lt;= 1.0 ) ) THEN<a name='6743'>
 <a name='6744'>
               IF ( SST(i,j) &lt; 271.4 ) THEN<a name='6745'>
                  SST(i,j) = 271.4<a name='6746'>
               ENDIF<a name='6747'>
 <a name='6748'>
               IF (sfc_layer_values) THEN<a name='6749'>
                  IF ( SST(i,j) &gt; 273. .AND. itimestep &lt;= 3) then<a name='6750'>
                     <font color=#447700>! Why the dependence on the time step count, here?<a name='6751'></font>
                     IF ( XICE(i,j) &gt;= 0.6 ) THEN<a name='6752'>
                        SST(i,j) = 271.4<a name='6753'>
                     ELSEIF ( XICE(i,j) &gt;= 0.4 ) THEN<a name='6754'>
                        SST(i,j) = 273.<a name='6755'>
                     ELSEIF (XICE(i,j) &gt;= 0.2 .AND. SST(i,j) &gt; 275.) THEN<a name='6756'>
                        SST(i,j) = 275.<a name='6757'>
                     ELSEIF (SST(i,j) &gt; 278.) THEN<a name='6758'>
                        SST(i,j) = 278.<a name='6759'>
                     ENDIF<a name='6760'>
                  ENDIF<a name='6761'>
               ENDIF<a name='6762'>
               TSK_SEA(i,j) = SST(i,j)<a name='6763'>
 <a name='6764'>
               IF ( tice2tsk_if2cold ) THEN<a name='6765'>
<font color=#447700>!------------------------------------------------------------------------------------<a name='6766'></font>
<font color=#447700>! This avoids unphysically low ice temperatures for grid cells with low ice fractions<a name='6767'></font>
<font color=#447700>! and low area-averaged temperatures.  This can happen when the initial ice fraction <a name='6768'></font>
<font color=#447700>! and surface temperature come from different data sets.<a name='6769'></font>
<font color=#447700>!------------------------------------------------------------------------------------<a name='6770'></font>
                  TSK_ICE(i,j) = MIN( TSK(i,j), 273.15 )<a name='6771'>
               ELSE<a name='6772'>
                  TSK_ICE(i,j) = ( TSK(i,j) - (1.0-XICE(i,j)) * SST(i,j) ) / XICE(i,j)<a name='6773'>
                  IF ( TSK_ICE(i,j) &lt; TICE_MIN ) TSK_ICE(i,j) = TICE_MIN<a name='6774'>
               ENDIF<a name='6775'>
 <a name='6776'>
               IF ( ( XICE(i,j) &lt; 0.2 ) .AND. ( TSK(i,j) &lt; 253.15 ) ) THEN<a name='6777'>
                  TSK_ICE(i,j) = 253.15<a name='6778'>
               ENDIF<a name='6779'>
               IF ( ( XICE(i,j) &lt; 0.1 ) .AND. ( TSK(i,j) &lt; 263.15 ) ) THEN<a name='6780'>
                  TSK_ICE(i,j) = 263.15<a name='6781'>
               ENDIF<a name='6782'>
            ELSE<a name='6783'>
               <font color=#447700>! land/open-water point<a name='6784'></font>
               TSK_SEA(i,j) = TSK(i,j)<a name='6785'>
               TSK_ICE(i,j) = TSK(i,j)<a name='6786'>
            ENDIF<a name='6787'>
         ENDDO<a name='6788'>
      ENDDO<a name='6789'>
<a name='6790'>
   END SUBROUTINE get_local_ice_tsk<a name='6791'>
<a name='6792'>
<font color=#447700>!=======================================================================<a name='6793'></font>
<font color=#447700>!=======================================================================<a name='6794'></font>
<a name='6795'>
END MODULE module_surface_driver<a name='6796'>
</pre></body></html>