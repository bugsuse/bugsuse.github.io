<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( NMM_CORE == 1)<a name='2'>
<A NAME='MODULE_DIAG_MISC'><A href='../../html_code/phys/module_diag_misc.F.html#MODULE_DIAG_MISC' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>MODULE </font><font color=#cc0000>module_diag_misc</font> <A href='../../call_to/MODULE_DIAG_MISC.html' TARGET='index'>1</A><a name='4'>
CONTAINS<a name='5'>
<A NAME='DIAG_MISC_STUB'><A href='../../html_code/phys/module_diag_misc.F.html#DIAG_MISC_STUB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>diag_misc_stub</font><a name='7'>
   END SUBROUTINE diag_misc_stub<a name='8'>
END MODULE module_diag_misc<a name='9'>
#else<a name='10'>
<font color=#447700>!WRF:MEDIATION_LAYER:PHYSICS<a name='11'></font>
<font color=#447700>!<a name='12'></font>
<a name='13'>
<A NAME='MODULE_DIAG_MISC'><A href='../../html_code/phys/module_diag_misc.F.html#MODULE_DIAG_MISC' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='14'>
<font color=#993300>MODULE </font><font color=#cc0000>module_diag_misc</font> <A href='../../call_to/MODULE_DIAG_MISC.html' TARGET='index'>1</A><a name='15'>
      PRIVATE :: WGAMMA<a name='16'>
      PRIVATE :: GAMMLN<a name='17'>
CONTAINS<a name='18'>
<A NAME='DIAGNOSTIC_OUTPUT_CALC'><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='19'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>diagnostic_output_calc</font>(                                 &amp; <A href='../../call_to/DIAGNOSTIC_OUTPUT_CALC.html' TARGET='index'>6</A>,<A href='../../call_from/DIAGNOSTIC_OUTPUT_CALC.html' TARGET='index'>22</A><a name='20'>
                      ids,ide, jds,jde, kds,kde,                      &amp;<a name='21'>
                      ims,ime, jms,jme, kms,kme,                      &amp;<a name='22'>
                      ips,ipe, jps,jpe, kps,kpe,                      &amp; <font color=#447700>! patch  dims<a name='23'></font>
                      i_start,i_end,j_start,j_end,kts,kte,num_tiles   &amp;<a name='24'>
                     ,dpsdt,dmudt                                     &amp;<a name='25'>
                     ,p8w,pk1m,mu_2,mu_2m                             &amp;<a name='26'>
                     ,u,v, temp                                       &amp;<a name='27'>
                     ,raincv,rainncv,rainc,rainnc                     &amp;<a name='28'>
                     ,i_rainc,i_rainnc                                &amp;<a name='29'>
                     ,hfx,sfcevp,lh                                   &amp;<a name='30'>
                     ,ACSWUPT,ACSWUPTC,ACSWDNT,ACSWDNTC               &amp; <font color=#447700>! Optional<a name='31'></font>
                     ,ACSWUPB,ACSWUPBC,ACSWDNB,ACSWDNBC               &amp; <font color=#447700>! Optional<a name='32'></font>
                     ,ACLWUPT,ACLWUPTC,ACLWDNT,ACLWDNTC               &amp; <font color=#447700>! Optional<a name='33'></font>
                     ,ACLWUPB,ACLWUPBC,ACLWDNB,ACLWDNBC               &amp; <font color=#447700>! Optional<a name='34'></font>
                     ,I_ACSWUPT,I_ACSWUPTC,I_ACSWDNT,I_ACSWDNTC       &amp; <font color=#447700>! Optional<a name='35'></font>
                     ,I_ACSWUPB,I_ACSWUPBC,I_ACSWDNB,I_ACSWDNBC       &amp; <font color=#447700>! Optional<a name='36'></font>
                     ,I_ACLWUPT,I_ACLWUPTC,I_ACLWDNT,I_ACLWDNTC       &amp; <font color=#447700>! Optional<a name='37'></font>
                     ,I_ACLWUPB,I_ACLWUPBC,I_ACLWDNB,I_ACLWDNBC       &amp; <font color=#447700>! Optional<a name='38'></font>
                     ,dt,xtime,sbw,t2                                 &amp;<a name='39'>
                     ,diag_print                                      &amp;<a name='40'>
                     ,bucket_mm, bucket_J                             &amp;<a name='41'>
                     ,mphysics_opt                                    &amp;<a name='42'>
                     ,gsfcgce_hail, gsfcgce_2ice                      &amp;<a name='43'>
                     ,mpuse_hail                                      &amp;<a name='44'>
                     ,nssl_cnoh, nssl_cnohl                           &amp;<a name='45'>
                     ,nssl_rho_qh, nssl_rho_qhl                       &amp;<a name='46'>
                     ,nssl_alphah, nssl_alphahl                       &amp;<a name='47'>
                     ,prec_acc_c, prec_acc_nc, snow_acc_nc            &amp;<a name='48'>
                     ,snowncv, prec_acc_dt, curr_secs2                &amp;<a name='49'>
                     ,nwp_diagnostics, diagflag                       &amp;<a name='50'>
                     ,history_interval                                &amp;<a name='51'>
                     ,itimestep                                       &amp;<a name='52'>
                     ,u10,v10,w                                       &amp;<a name='53'>
                     ,wspd10max                                       &amp;<a name='54'>
                     ,up_heli_max                                     &amp;<a name='55'>
                     ,w_up_max,w_dn_max                               &amp;<a name='56'>
                     ,znw,w_colmean                                   &amp;<a name='57'>
                     ,numcolpts,w_mean                                &amp;<a name='58'>
                     ,grpl_max,grpl_colint,refd_max,refl_10cm         &amp;<a name='59'>
                     ,hail_maxk1,hail_max2d                           &amp;<a name='60'>
                     ,qg_curr                                         &amp;<a name='61'>
                     ,ng_curr,qh_curr,nh_curr,qr_curr,nr_curr         &amp; <font color=#447700>!  Optional (gthompsn)<a name='62'></font>
                     ,rho,ph,phb,g                                    &amp;<a name='63'>
                                                                      )<a name='64'>
<font color=#447700>!----------------------------------------------------------------------<a name='65'></font>
<a name='66'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_146">, ONLY: wrf_dm_sum_real, wrf_dm_maxval<a name='67'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_118">, ONLY :                                  &amp;<a name='68'>
      KESSLERSCHEME, LINSCHEME, SBU_YLINSCHEME, WSM3SCHEME, WSM5SCHEME, &amp;<a name='69'>
      WSM6SCHEME, ETAMPNEW, THOMPSON, THOMPSONAERO,                     &amp;<a name='70'>
      MORR_TWO_MOMENT, GSFCGCESCHEME, WDM5SCHEME, WDM6SCHEME,           &amp;<a name='71'>
      NSSL_2MOM, NSSL_2MOMG, NSSL_2MOMCCN, NSSL_1MOM, NSSL_1MOMLFO,                 &amp;<a name='72'>
      MILBRANDT2MOM , CAMMGMPSCHEME, FAST_KHAIN_LYNN, FULL_KHAIN_LYNN    <font color=#447700>!,MILBRANDT3MOM, NSSL_3MOM<a name='73'></font>
<a name='74'>
   IMPLICIT NONE<a name='75'>
<font color=#447700>!======================================================================<a name='76'></font>
<font color=#447700>! Definitions<a name='77'></font>
<font color=#447700>!-----------<a name='78'></font>
<font color=#447700>!-- DIAG_PRINT    print control: 0 - no diagnostics; 1 - dmudt only; 2 - all<a name='79'></font>
<font color=#447700>!-- DT            time step (second)<a name='80'></font>
<font color=#447700>!-- XTIME         forecast time<a name='81'></font>
<font color=#447700>!-- SBW           specified boundary width - used later<a name='82'></font>
<font color=#447700>!<a name='83'></font>
<font color=#447700>!-- P8W           3D pressure array at full eta levels<a name='84'></font>
<font color=#447700>!-- MU            dry column hydrostatic pressure<a name='85'></font>
<font color=#447700>!-- RAINC         cumulus scheme precipitation since hour 0<a name='86'></font>
<font color=#447700>!-- RAINCV        cumulus scheme precipitation in one time step (mm)<a name='87'></font>
<font color=#447700>!-- RAINNC        explicit scheme precipitation since hour 0<a name='88'></font>
<font color=#447700>!-- RAINNCV       explicit scheme precipitation in one time step (mm)<a name='89'></font>
<font color=#447700>!-- SNOWNCV       explicit scheme snow in one time step (mm)<a name='90'></font>
<font color=#447700>!-- HFX           surface sensible heat flux<a name='91'></font>
<font color=#447700>!-- LH            surface latent heat flux<a name='92'></font>
<font color=#447700>!-- SFCEVP        total surface evaporation<a name='93'></font>
<font color=#447700>!-- U             u component of wind - to be used later to compute k.e.<a name='94'></font>
<font color=#447700>!-- V             v component of wind - to be used later to compute k.e.<a name='95'></font>
<font color=#447700>!-- PREC_ACC_C    accumulated convective precip over accumulation time prec_acc_dt<a name='96'></font>
<font color=#447700>!-- PREC_ACC_NC   accumulated explicit precip over accumulation time prec_acc_dt<a name='97'></font>
<font color=#447700>!-- SNOW_ACC_NC   accumulated explicit snow precip over accumulation time prec_acc_dt<a name='98'></font>
<font color=#447700>!-- PREC_ACC_DT   precip accumulation time, default is 60 min<a name='99'></font>
<font color=#447700>!-- CURR_SECS2    Time (s) since the beginning of the restart<a name='100'></font>
<font color=#447700>!-- NWP_DIAGNOSTICS  = 1, compute hourly maximum fields<a name='101'></font>
<font color=#447700>!-- DIAGFLAG      logical flag to indicate if this is a history output time<a name='102'></font>
<font color=#447700>!-- U10, V10      10 m wind components<a name='103'></font>
<font color=#447700>!-- WSPD10MAX     10 m max wind speed<a name='104'></font>
<font color=#447700>!-- UP_HELI_MAX   max updraft helicity<a name='105'></font>
<font color=#447700>!-- W_UP_MAX      max updraft vertical velocity<a name='106'></font>
<font color=#447700>!-- W_DN_MAX      max downdraft vertical velocity<a name='107'></font>
<font color=#447700>!-- W_COLMEAN     column mean vertical velocity<a name='108'></font>
<font color=#447700>!-- NUMCOLPTS     no of column points<a name='109'></font>
<font color=#447700>!-- GRPL_MAX      max column-integrated graupel<a name='110'></font>
<font color=#447700>!-- GRPL_COLINT   column-integrated graupel<a name='111'></font>
<font color=#447700>!-- REF_MAX       max derived radar reflectivity<a name='112'></font>
<font color=#447700>!-- REFL_10CM     model computed 3D reflectivity<a name='113'></font>
<font color=#447700>!<a name='114'></font>
<font color=#447700>!-- ids           start index for i in domain<a name='115'></font>
<font color=#447700>!-- ide           end index for i in domain<a name='116'></font>
<font color=#447700>!-- jds           start index for j in domain<a name='117'></font>
<font color=#447700>!-- jde           end index for j in domain<a name='118'></font>
<font color=#447700>!-- kds           start index for k in domain<a name='119'></font>
<font color=#447700>!-- kde           end index for k in domain<a name='120'></font>
<font color=#447700>!-- ims           start index for i in memory<a name='121'></font>
<font color=#447700>!-- ime           end index for i in memory<a name='122'></font>
<font color=#447700>!-- jms           start index for j in memory<a name='123'></font>
<font color=#447700>!-- jme           end index for j in memory<a name='124'></font>
<font color=#447700>!-- ips           start index for i in patch<a name='125'></font>
<font color=#447700>!-- ipe           end index for i in patch<a name='126'></font>
<font color=#447700>!-- jps           start index for j in patch<a name='127'></font>
<font color=#447700>!-- jpe           end index for j in patch<a name='128'></font>
<font color=#447700>!-- kms           start index for k in memory<a name='129'></font>
<font color=#447700>!-- kme           end index for k in memory<a name='130'></font>
<font color=#447700>!-- i_start       start indices for i in tile<a name='131'></font>
<font color=#447700>!-- i_end         end indices for i in tile<a name='132'></font>
<font color=#447700>!-- j_start       start indices for j in tile<a name='133'></font>
<font color=#447700>!-- j_end         end indices for j in tile<a name='134'></font>
<font color=#447700>!-- kts           start index for k in tile<a name='135'></font>
<font color=#447700>!-- kte           end index for k in tile<a name='136'></font>
<font color=#447700>!-- num_tiles     number of tiles<a name='137'></font>
<font color=#447700>!<a name='138'></font>
<font color=#447700>!======================================================================<a name='139'></font>
<a name='140'>
   INTEGER,      INTENT(IN   )    ::                             &amp;<a name='141'>
                                      ids,ide, jds,jde, kds,kde, &amp;<a name='142'>
                                      ims,ime, jms,jme, kms,kme, &amp;<a name='143'>
                                      ips,ipe, jps,jpe, kps,kpe, &amp;<a name='144'>
                                                        kts,kte, &amp;<a name='145'>
                                                      num_tiles<a name='146'>
<a name='147'>
   INTEGER, DIMENSION(num_tiles), INTENT(IN) ::                  &amp;<a name='148'>
     &amp;           i_start,i_end,j_start,j_end<a name='149'>
<a name='150'>
   INTEGER,      INTENT(IN   )    ::   diag_print<a name='151'>
   REAL,      INTENT(IN   )    ::   bucket_mm, bucket_J<a name='152'>
   INTEGER,   INTENT(IN   )    ::   mphysics_opt<a name='153'>
   INTEGER, INTENT(IN) :: gsfcgce_hail, gsfcgce_2ice, mpuse_hail<a name='154'>
   REAL, INTENT(IN)    ::   nssl_cnoh, nssl_cnohl                &amp;<a name='155'>
                           ,nssl_rho_qh, nssl_rho_qhl            &amp;<a name='156'>
                           ,nssl_alphah, nssl_alphahl<a name='157'>
   INTEGER,   INTENT(IN   )    ::   nwp_diagnostics<a name='158'>
   LOGICAL,   INTENT(IN   )    ::   diagflag<a name='159'>
<a name='160'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),                 &amp;<a name='161'>
         INTENT(IN ) ::                                       u  &amp;<a name='162'>
                                                    ,         v  &amp;<a name='163'>
                                                    ,       p8w<a name='164'>
<a name='165'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN) ::           &amp;<a name='166'>
                                                           MU_2  &amp;<a name='167'>
                                                    ,   RAINNCV  &amp;<a name='168'>
                                                    ,    RAINCV  &amp;<a name='169'>
                                                    ,   SNOWNCV  &amp;<a name='170'>
                                                    ,       HFX  &amp;<a name='171'>
                                                    ,        LH  &amp;<a name='172'>
                                                    ,    SFCEVP  &amp;  <a name='173'>
                                                    ,        T2     <a name='174'>
<a name='175'>
   REAL, DIMENSION( ims:ime , jms:jme ),                         &amp;<a name='176'>
          INTENT(INOUT) ::                                DPSDT  &amp;<a name='177'>
                                                    ,     DMUDT  &amp;<a name='178'>
                                                    ,    RAINNC  &amp;<a name='179'>
                                                    ,     RAINC  &amp;<a name='180'>
                                                    ,     MU_2M  &amp;<a name='181'>
                                                    ,      PK1M<a name='182'>
 <a name='183'>
   REAL,  INTENT(IN   ) :: DT, XTIME<a name='184'>
   INTEGER,  INTENT(IN   ) :: SBW<a name='185'>
   INTEGER, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT) ::     &amp;<a name='186'>
                                                       I_RAINC,  &amp;<a name='187'>
                                                       I_RAINNC<a name='188'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT) ::&amp;<a name='189'>
                      ACSWUPT,ACSWUPTC,ACSWDNT,ACSWDNTC,          &amp;<a name='190'>
                      ACSWUPB,ACSWUPBC,ACSWDNB,ACSWDNBC,          &amp;<a name='191'>
                      ACLWUPT,ACLWUPTC,ACLWDNT,ACLWDNTC,          &amp;<a name='192'>
                      ACLWUPB,ACLWUPBC,ACLWDNB,ACLWDNBC<a name='193'>
   INTEGER, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT) ::&amp;<a name='194'>
                      I_ACSWUPT,I_ACSWUPTC,I_ACSWDNT,I_ACSWDNTC,  &amp;<a name='195'>
                      I_ACSWUPB,I_ACSWUPBC,I_ACSWDNB,I_ACSWDNBC,  &amp;<a name='196'>
                      I_ACLWUPT,I_ACLWUPTC,I_ACLWDNT,I_ACLWDNTC,  &amp;<a name='197'>
                      I_ACLWUPB,I_ACLWUPBC,I_ACLWDNB,I_ACLWDNBC<a name='198'>
<a name='199'>
   REAL, DIMENSION( ims:ime, jms:jme ), OPTIONAL, INTENT(INOUT) ::&amp;<a name='200'>
                      PREC_ACC_C, PREC_ACC_NC, SNOW_ACC_NC<a name='201'>
<a name='202'>
   REAL, OPTIONAL, INTENT(IN)::  PREC_ACC_DT, CURR_SECS2<a name='203'>
<a name='204'>
   INTEGER :: i,j,k,its,ite,jts,jte,ij<a name='205'>
   INTEGER :: idp,jdp,irc,jrc,irnc,jrnc,isnh,jsnh<a name='206'>
<a name='207'>
   REAL              :: no_points<a name='208'>
   REAL              :: dpsdt_sum, dmudt_sum, dardt_sum, drcdt_sum, drndt_sum<a name='209'>
   REAL              :: hfx_sum, lh_sum, sfcevp_sum, rainc_sum, rainnc_sum, raint_sum<a name='210'>
   REAL              :: dmumax, raincmax, rainncmax, snowhmax<a name='211'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='212'>
   CHARACTER*256     :: outstring<a name='213'>
   CHARACTER*6       :: grid_str<a name='214'>
<a name='215'>
   INTEGER, INTENT(IN) ::                                        &amp;<a name='216'>
                                     history_interval,itimestep<a name='217'>
<a name='218'>
   REAL, DIMENSION( kms:kme ), INTENT(IN) ::                     &amp;<a name='219'>
                                                            znw<a name='220'>
<a name='221'>
   REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN) ::   &amp;<a name='222'>
                                                              w  &amp;<a name='223'>
                                                          ,temp  &amp;<a name='224'>
                                                       ,qg_curr  &amp;<a name='225'>
                                                           ,rho  &amp;<a name='226'>
                                                     ,refl_10cm  &amp;<a name='227'>
                                                        ,ph,phb<a name='228'>
<a name='229'>
   REAL, DIMENSION(ims:ime,kms:kme,jms:jme), OPTIONAL, INTENT(IN) ::    &amp;<a name='230'>
                                       ng_curr, qh_curr, nh_curr        &amp;<a name='231'>
                                               ,qr_curr, nr_curr<a name='232'>
<a name='233'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN) ::            &amp;<a name='234'>
                                                            u10  &amp;<a name='235'>
                                                           ,v10<a name='236'>
<a name='237'>
   REAL, INTENT(IN) :: g<a name='238'>
<a name='239'>
   REAL, DIMENSION( ims:ime , jms:jme ), INTENT(INOUT) ::        &amp;<a name='240'>
                                                      wspd10max  &amp;<a name='241'>
                                                   ,up_heli_max  &amp;<a name='242'>
                                             ,w_up_max,w_dn_max  &amp;<a name='243'>
                                    ,w_colmean,numcolpts,w_mean  &amp;<a name='244'>
                                          ,grpl_max,grpl_colint  &amp;<a name='245'>
                                         ,hail_maxk1,hail_max2d  &amp;<a name='246'>
                                                      ,refd_max<a name='247'>
<a name='248'>
   REAL, DIMENSION(ims:ime,kms:kme,jms:jme):: temp_qg, temp_ng, temp_qr, temp_nr<a name='249'>
<a name='250'>
   INTEGER :: idump<a name='251'>
<a name='252'>
   REAL :: wind_vel<a name='253'>
   REAL :: depth<a name='254'>
<a name='255'>
      DOUBLE PRECISION:: hail_max<a name='256'>
      REAL:: hail_max_sp<a name='257'>
      DOUBLE PRECISION, PARAMETER:: thresh_conc = 0.001d0                  <font color=#447700>! number conc. of graupel/hail per cubic meter<a name='258'></font>
      LOGICAL:: scheme_has_graupel<a name='259'>
      INTEGER, PARAMETER:: ngbins=50<a name='260'>
      DOUBLE PRECISION, DIMENSION(ngbins+1):: xxDx<a name='261'>
      DOUBLE PRECISION, DIMENSION(ngbins):: xxDg, xdtg<a name='262'>
      REAL:: xrho_g, xam_g, xbm_g, xmu_g<a name='263'>
      REAL, DIMENSION(3):: cge, cgg<a name='264'>
      DOUBLE PRECISION:: f_d, sum_ng, lamg, ilamg, N0_g, lam_exp, N0exp<a name='265'>
      DOUBLE PRECISION:: lamr, N0min<a name='266'>
      REAL:: mvd_r, xslw1, ygra1, zans1<a name='267'>
      INTEGER:: ng, n<a name='268'>
<a name='269'>
<font color=#447700>!-----------------------------------------------------------------<a name='270'></font>
<font color=#447700>! Handle accumulations with buckets to prevent round-off truncation in long runs<a name='271'></font>
<font color=#447700>! This is done every 360 minutes assuming time step fits exactly into 360 minutes<a name='272'></font>
   IF(bucket_mm .gt. 0. .AND. MOD(NINT(XTIME),360) .EQ. 0)THEN<a name='273'>
<font color=#447700>! SET START AND END POINTS FOR TILES<a name='274'></font>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='275'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='276'></font>
<a name='277'>
   DO ij = 1 , num_tiles<a name='278'>
<a name='279'>
      IF (xtime .eq. 0.0)THEN<a name='280'>
        DO j=j_start(ij),j_end(ij)<a name='281'>
        DO i=i_start(ij),i_end(ij)<a name='282'>
          i_rainnc(i,j) = 0<a name='283'>
          i_rainc(i,j) = 0<a name='284'>
        ENDDO      <a name='285'>
        ENDDO<a name='286'>
      ENDIF<a name='287'>
      DO j=j_start(ij),j_end(ij)<a name='288'>
      DO i=i_start(ij),i_end(ij)<a name='289'>
        IF(rainnc(i,j) .gt. bucket_mm)THEN<a name='290'>
          rainnc(i,j) = rainnc(i,j) - bucket_mm<a name='291'>
          i_rainnc(i,j) =  i_rainnc(i,j) + 1<a name='292'>
        ENDIF<a name='293'>
        IF(rainc(i,j) .gt. bucket_mm)THEN<a name='294'>
          rainc(i,j) = rainc(i,j) - bucket_mm<a name='295'>
          i_rainc(i,j) =  i_rainc(i,j) + 1<a name='296'>
        ENDIF<a name='297'>
      ENDDO      <a name='298'>
      ENDDO<a name='299'>
<a name='300'>
      IF (xtime .eq. 0.0 .and. bucket_J .gt. 0.0 .and. PRESENT(ACSWUPT))THEN<a name='301'>
        DO j=j_start(ij),j_end(ij)<a name='302'>
        DO i=i_start(ij),i_end(ij)<a name='303'>
          i_acswupt(i,j) = 0<a name='304'>
          i_acswuptc(i,j) = 0<a name='305'>
          i_acswdnt(i,j) = 0<a name='306'>
          i_acswdntc(i,j) = 0<a name='307'>
          i_acswupb(i,j) = 0<a name='308'>
          i_acswupbc(i,j) = 0<a name='309'>
          i_acswdnb(i,j) = 0<a name='310'>
          i_acswdnbc(i,j) = 0<a name='311'>
        ENDDO      <a name='312'>
        ENDDO<a name='313'>
      ENDIF<a name='314'>
      IF (xtime .eq. 0.0  .and. bucket_J .gt. 0.0 .and. PRESENT(ACLWUPT))THEN<a name='315'>
        DO j=j_start(ij),j_end(ij)<a name='316'>
        DO i=i_start(ij),i_end(ij)<a name='317'>
          i_aclwupt(i,j) = 0<a name='318'>
          i_aclwuptc(i,j) = 0<a name='319'>
          i_aclwdnt(i,j) = 0<a name='320'>
          i_aclwdntc(i,j) = 0<a name='321'>
          i_aclwupb(i,j) = 0<a name='322'>
          i_aclwupbc(i,j) = 0<a name='323'>
          i_aclwdnb(i,j) = 0<a name='324'>
          i_aclwdnbc(i,j) = 0<a name='325'>
        ENDDO      <a name='326'>
        ENDDO<a name='327'>
      ENDIF<a name='328'>
      IF (PRESENT(ACSWUPT) .and. bucket_J .gt. 0.0)THEN<a name='329'>
      DO j=j_start(ij),j_end(ij)<a name='330'>
      DO i=i_start(ij),i_end(ij)<a name='331'>
        IF(acswupt(i,j) .gt. bucket_J)THEN<a name='332'>
          acswupt(i,j) = acswupt(i,j) - bucket_J<a name='333'>
          i_acswupt(i,j) =  i_acswupt(i,j) + 1<a name='334'>
        ENDIF<a name='335'>
        IF(acswuptc(i,j) .gt. bucket_J)THEN<a name='336'>
          acswuptc(i,j) = acswuptc(i,j) - bucket_J<a name='337'>
          i_acswuptc(i,j) =  i_acswuptc(i,j) + 1<a name='338'>
        ENDIF<a name='339'>
        IF(acswdnt(i,j) .gt. bucket_J)THEN<a name='340'>
          acswdnt(i,j) = acswdnt(i,j) - bucket_J<a name='341'>
          i_acswdnt(i,j) =  i_acswdnt(i,j) + 1<a name='342'>
        ENDIF<a name='343'>
        IF(acswdntc(i,j) .gt. bucket_J)THEN<a name='344'>
          acswdntc(i,j) = acswdntc(i,j) - bucket_J<a name='345'>
          i_acswdntc(i,j) =  i_acswdntc(i,j) + 1<a name='346'>
        ENDIF<a name='347'>
        IF(acswupb(i,j) .gt. bucket_J)THEN<a name='348'>
          acswupb(i,j) = acswupb(i,j) - bucket_J<a name='349'>
          i_acswupb(i,j) =  i_acswupb(i,j) + 1<a name='350'>
        ENDIF<a name='351'>
        IF(acswupbc(i,j) .gt. bucket_J)THEN<a name='352'>
          acswupbc(i,j) = acswupbc(i,j) - bucket_J<a name='353'>
          i_acswupbc(i,j) =  i_acswupbc(i,j) + 1<a name='354'>
        ENDIF<a name='355'>
        IF(acswdnb(i,j) .gt. bucket_J)THEN<a name='356'>
          acswdnb(i,j) = acswdnb(i,j) - bucket_J<a name='357'>
          i_acswdnb(i,j) =  i_acswdnb(i,j) + 1<a name='358'>
        ENDIF<a name='359'>
        IF(acswdnbc(i,j) .gt. bucket_J)THEN<a name='360'>
          acswdnbc(i,j) = acswdnbc(i,j) - bucket_J<a name='361'>
          i_acswdnbc(i,j) =  i_acswdnbc(i,j) + 1<a name='362'>
        ENDIF<a name='363'>
      ENDDO      <a name='364'>
      ENDDO<a name='365'>
      ENDIF<a name='366'>
      IF (PRESENT(ACLWUPT) .and. bucket_J .gt. 0.0)THEN<a name='367'>
      DO j=j_start(ij),j_end(ij)<a name='368'>
      DO i=i_start(ij),i_end(ij)<a name='369'>
        IF(aclwupt(i,j) .gt. bucket_J)THEN<a name='370'>
          aclwupt(i,j) = aclwupt(i,j) - bucket_J<a name='371'>
          i_aclwupt(i,j) =  i_aclwupt(i,j) + 1<a name='372'>
        ENDIF<a name='373'>
        IF(aclwuptc(i,j) .gt. bucket_J)THEN<a name='374'>
          aclwuptc(i,j) = aclwuptc(i,j) - bucket_J<a name='375'>
          i_aclwuptc(i,j) =  i_aclwuptc(i,j) + 1<a name='376'>
        ENDIF<a name='377'>
        IF(aclwdnt(i,j) .gt. bucket_J)THEN<a name='378'>
          aclwdnt(i,j) = aclwdnt(i,j) - bucket_J<a name='379'>
          i_aclwdnt(i,j) =  i_aclwdnt(i,j) + 1<a name='380'>
        ENDIF<a name='381'>
        IF(aclwdntc(i,j) .gt. bucket_J)THEN<a name='382'>
          aclwdntc(i,j) = aclwdntc(i,j) - bucket_J<a name='383'>
          i_aclwdntc(i,j) =  i_aclwdntc(i,j) + 1<a name='384'>
        ENDIF<a name='385'>
        IF(aclwupb(i,j) .gt. bucket_J)THEN<a name='386'>
          aclwupb(i,j) = aclwupb(i,j) - bucket_J<a name='387'>
          i_aclwupb(i,j) =  i_aclwupb(i,j) + 1<a name='388'>
        ENDIF<a name='389'>
        IF(aclwupbc(i,j) .gt. bucket_J)THEN<a name='390'>
          aclwupbc(i,j) = aclwupbc(i,j) - bucket_J<a name='391'>
          i_aclwupbc(i,j) =  i_aclwupbc(i,j) + 1<a name='392'>
        ENDIF<a name='393'>
        IF(aclwdnb(i,j) .gt. bucket_J)THEN<a name='394'>
          aclwdnb(i,j) = aclwdnb(i,j) - bucket_J<a name='395'>
          i_aclwdnb(i,j) =  i_aclwdnb(i,j) + 1<a name='396'>
        ENDIF<a name='397'>
        IF(aclwdnbc(i,j) .gt. bucket_J)THEN<a name='398'>
          aclwdnbc(i,j) = aclwdnbc(i,j) - bucket_J<a name='399'>
          i_aclwdnbc(i,j) =  i_aclwdnbc(i,j) + 1<a name='400'>
        ENDIF<a name='401'>
      ENDDO      <a name='402'>
      ENDDO<a name='403'>
      ENDIF<a name='404'>
   ENDDO<a name='405'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='406'></font>
   ENDIF<a name='407'>
<a name='408'>
<font color=#447700>! Compute precipitation accumulation in a given time window: prec_acc_dt<a name='409'></font>
   IF (prec_acc_dt .gt. 0.) THEN<a name='410'>
<a name='411'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='412'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='413'></font>
<a name='414'>
   DO ij = 1 , num_tiles<a name='415'>
<a name='416'>
      DO j=j_start(ij),j_end(ij)<a name='417'>
      DO i=i_start(ij),i_end(ij)<a name='418'>
         IF (mod(curr_secs2, 60.* prec_acc_dt) == 0.) THEN<a name='419'>
            prec_acc_c(i,j)  = 0.<a name='420'>
            prec_acc_nc(i,j) = 0.<a name='421'>
            snow_acc_nc(i,j)  = 0.<a name='422'>
         ENDIF<a name='423'>
         prec_acc_c(i,j)  = prec_acc_c(i,j)  +  RAINCV(i,j)<a name='424'>
         prec_acc_nc(i,j) = prec_acc_nc(i,j) + RAINNCV(i,j)<a name='425'>
         prec_acc_c(i,j)  = MAX (prec_acc_c(i,j), 0.0)<a name='426'>
         prec_acc_nc(i,j) = MAX (prec_acc_nc(i,j), 0.0)<a name='427'>
         snow_acc_nc(i,j)   = snow_acc_nc(i,j) + SNOWNCV(I,J)<a name='428'>
<font color=#447700>! add convective precip to snow bucket if t2 &lt; 273.15<a name='429'></font>
         IF ( t2(i,j) .lt. 273.15 ) THEN<a name='430'>
         snow_acc_nc(i,j)   = snow_acc_nc(i,j) +  RAINCV(i,j)<a name='431'>
         snow_acc_nc(i,j)   = MAX (snow_acc_nc(i,j), 0.0)<a name='432'>
         ENDIF<a name='433'>
      ENDDO     <a name='434'>
      ENDDO     <a name='435'>
<a name='436'>
   ENDDO     <a name='437'>
<a name='438'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='439'></font>
   ENDIF<a name='440'>
<a name='441'>
<a name='442'>
<a name='443'>
<font color=#447700>! NSSL<a name='444'></font>
<a name='445'>
   IF ( nwp_diagnostics .EQ. 1 ) THEN<a name='446'>
<a name='447'>
     idump = (history_interval * 60.) / dt<a name='448'>
<a name='449'>
<font color=#447700>!   print *,' history_interval = ', history_interval<a name='450'></font>
<font color=#447700>!   print *,' itimestep        = ', itimestep<a name='451'></font>
<font color=#447700>!   print *,' idump            = ', idump<a name='452'></font>
<font color=#447700>!   print *,' xtime            = ', xtime<a name='453'></font>
<a name='454'>
<a name='455'>
<font color=#447700>! IF ( MOD(itimestep, idump) .eq. 0 ) THEN<a name='456'></font>
<font color=#447700>!    WRITE(outstring,*) 'Computing PH0 for this domain with curr_secs2 = ', curr_secs2<a name='457'></font>
<font color=#447700>!    CALL wrf_message ( TRIM(outstring) )<a name='458'></font>
<a name='459'>
   IF ( MOD((itimestep - 1), idump) .eq. 0 ) THEN<a name='460'>
     WRITE(outstring,*) 'NSSL Diagnostics: Resetting max arrays for domain with dt = ', dt<a name='461'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_574"> ( 10,TRIM(outstring) )<a name='462'>
<a name='463'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='464'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='465'></font>
     DO ij = 1 , num_tiles<a name='466'>
       DO j=j_start(ij),j_end(ij)<a name='467'>
       DO i=i_start(ij),i_end(ij)<a name='468'>
         wspd10max(i,j)   = 0.<a name='469'>
         up_heli_max(i,j) = 0.<a name='470'>
         w_up_max(i,j)    = 0.<a name='471'>
         w_dn_max(i,j)    = 0.<a name='472'>
         w_mean(i,j)      = 0.<a name='473'>
         grpl_max(i,j)    = 0.<a name='474'>
         refd_max(i,j)    = 0.<a name='475'>
         hail_maxk1(i,j)  = 0.<a name='476'>
         hail_max2d(i,j)  = 0.<a name='477'>
       ENDDO<a name='478'>
       ENDDO<a name='479'>
     ENDDO<a name='480'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='481'></font>
   ENDIF<a name='482'>
<a name='483'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='484'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='485'></font>
   DO ij = 1 , num_tiles<a name='486'>
     DO j=j_start(ij),j_end(ij)<a name='487'>
     DO i=i_start(ij),i_end(ij)<a name='488'>
<a name='489'>
<font color=#447700>! Zero some accounting arrays that will be used below<a name='490'></font>
<a name='491'>
       w_colmean(i,j)   = 0.<a name='492'>
       numcolpts(i,j)   = 0.<a name='493'>
       grpl_colint(i,j) = 0.<a name='494'>
     ENDDO<a name='495'>
     ENDDO<a name='496'>
   ENDDO<a name='497'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='498'></font>
<a name='499'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='500'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='501'></font>
   DO ij = 1 , num_tiles<a name='502'>
     DO j=j_start(ij),j_end(ij)<a name='503'>
     DO k=kms,kme<a name='504'>
     DO i=i_start(ij),i_end(ij)<a name='505'>
<a name='506'>
<font color=#447700>! Find vertical velocity max (up and down) below 400 mb<a name='507'></font>
<a name='508'>
       IF ( p8w(i,k,j) .GT. 40000. .AND. w(i,k,j) .GT. w_up_max(i,j) ) THEN<a name='509'>
         w_up_max(i,j) = w(i,k,j)<a name='510'>
       ENDIF<a name='511'>
<a name='512'>
       IF ( p8w(i,k,j) .GT. 40000. .AND. w(i,k,j) .LT. w_dn_max(i,j) ) THEN<a name='513'>
         w_dn_max(i,j) = w(i,k,j)<a name='514'>
       ENDIF<a name='515'>
<a name='516'>
<font color=#447700>! For the column mean vertical velocity calculation, first<a name='517'></font>
<font color=#447700>! total the vertical velocity between sigma levels 0.5 and 0.8<a name='518'></font>
<a name='519'>
       IF ( znw(k) .GE. 0.5 .AND. znw(k) .LE. 0.8 ) THEN<a name='520'>
         w_colmean(i,j) = w_colmean(i,j) + w(i,k,j)<a name='521'>
         numcolpts(i,j) = numcolpts(i,j) + 1<a name='522'>
       ENDIF<a name='523'>
     ENDDO<a name='524'>
     ENDDO<a name='525'>
     ENDDO<a name='526'>
   ENDDO<a name='527'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='528'></font>
<a name='529'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='530'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='531'></font>
   DO ij = 1 , num_tiles<a name='532'>
     DO j=j_start(ij),j_end(ij)<a name='533'>
     DO k=kms,kme-1<a name='534'>
     DO i=i_start(ij),i_end(ij)<a name='535'>
<a name='536'>
<font color=#447700>! Calculate the column integrated graupel<a name='537'></font>
<a name='538'>
       depth = ( ( ph(i,k+1,j) + phb(i,k+1,j) ) / g ) - &amp;<a name='539'>
               ( ( ph(i,k  ,j) + phb(i,k  ,j) ) / g )<a name='540'>
       grpl_colint(i,j) = grpl_colint(i,j) + qg_curr(i,k,j) * depth * rho(i,k,j)<a name='541'>
     ENDDO<a name='542'>
     ENDDO<a name='543'>
     ENDDO<a name='544'>
   ENDDO<a name='545'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='546'></font>
<a name='547'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='548'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='549'></font>
   DO ij = 1 , num_tiles<a name='550'>
     DO j=j_start(ij),j_end(ij)<a name='551'>
     DO i=i_start(ij),i_end(ij)<a name='552'>
<a name='553'>
<font color=#447700>! Calculate the max 10 m wind speed between output times<a name='554'></font>
<a name='555'>
       wind_vel = sqrt ( u10(i,j)*u10(i,j) + v10(i,j)*v10(i,j) )<a name='556'>
       IF ( wind_vel .GT. wspd10max(i,j) ) THEN<a name='557'>
         wspd10max(i,j) = wind_vel<a name='558'>
       ENDIF<a name='559'>
<a name='560'>
<font color=#447700>! Calculate the column mean vertical velocity between output times<a name='561'></font>
<a name='562'>
       w_mean(i,j) = w_mean(i,j) + w_colmean(i,j) / numcolpts(i,j)<a name='563'>
<a name='564'>
       IF ( MOD(itimestep, idump) .eq. 0 ) THEN<a name='565'>
         w_mean(i,j) = w_mean(i,j) / idump<a name='566'>
       ENDIF<a name='567'>
<a name='568'>
<font color=#447700>! Calculate the max column integrated graupel between output times<a name='569'></font>
<a name='570'>
       IF ( grpl_colint(i,j) .gt. grpl_max(i,j) ) THEN<a name='571'>
          grpl_max(i,j) = grpl_colint(i,j)<a name='572'>
       ENDIF<a name='573'>
<a name='574'>
   <font color=#447700>! Calculate the max radar reflectivity between output times<a name='575'></font>
<a name='576'>
       IF ( refl_10cm(i,kms,j) .GT. refd_max(i,j) ) THEN<a name='577'>
         refd_max(i,j) = refl_10cm(i,kms,j)<a name='578'>
       ENDIF<a name='579'>
     ENDDO<a name='580'>
     ENDDO<a name='581'>
   ENDDO<a name='582'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='583'></font>
<a name='584'>
<a name='585'>
<a name='586'>
<font color=#447700>!+---+-----------------------------------------------------------------+ <a name='587'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+ <a name='588'></font>
<font color=#447700>!..Calculate a maximum hail diameter from the characteristics of the<a name='589'></font>
<font color=#447700>!.. graupel category mixing ratio and number concentration (or hail, if<a name='590'></font>
<font color=#447700>!.. available).  This diagnostic uses the actual spectral distribution<a name='591'></font>
<font color=#447700>!.. assumptions, calculated by breaking the distribution into 50 bins<a name='592'></font>
<font color=#447700>!.. from 0.5mm to 7.5cm.  Once a minimum number concentration of 0.01<a name='593'></font>
<font color=#447700>!.. particle per cubic meter of air is reached, from the upper size<a name='594'></font>
<font color=#447700>!.. limit, then this bin is considered the max size.<a name='595'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+ <a name='596'></font>
<a name='597'>
      WRITE(outstring,*) 'GT-Diagnostics, computing max-hail diameter'<a name='598'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_575"> (100, TRIM(outstring))<a name='599'>
<a name='600'>
<a name='601'>
   IF (PRESENT(qh_curr)) THEN<a name='602'>
   WRITE(outstring,*) 'GT-Debug, this mp scheme, ', mphysics_opt, ' has hail mixing ratio'<a name='603'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_576"> (150, TRIM(outstring))<a name='604'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='605'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='606'></font>
   DO ij = 1 , num_tiles<a name='607'>
     DO j=j_start(ij),j_end(ij)<a name='608'>
     DO k=kms,kme-1<a name='609'>
     DO i=i_start(ij),i_end(ij)<a name='610'>
        temp_qg(i,k,j) = MAX(1.E-12, qh_curr(i,k,j)*rho(i,k,j))<a name='611'>
     ENDDO<a name='612'>
     ENDDO<a name='613'>
     ENDDO<a name='614'>
   ENDDO<a name='615'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='616'></font>
   ELSE<a name='617'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='618'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='619'></font>
   DO ij = 1 , num_tiles<a name='620'>
     DO j=j_start(ij),j_end(ij)<a name='621'>
     DO k=kms,kme-1<a name='622'>
     DO i=i_start(ij),i_end(ij)<a name='623'>
        temp_qg(i,k,j) = MAX(1.E-12, qg_curr(i,k,j)*rho(i,k,j))<a name='624'>
     ENDDO<a name='625'>
     ENDDO<a name='626'>
     ENDDO<a name='627'>
   ENDDO<a name='628'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='629'></font>
   ENDIF<a name='630'>
<a name='631'>
   IF (PRESENT(nh_curr)) THEN<a name='632'>
   WRITE(outstring,*) 'GT-Debug, this mp scheme, ', mphysics_opt, ' has hail number concentration'<a name='633'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_577"> (150, TRIM(outstring))<a name='634'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='635'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='636'></font>
   DO ij = 1 , num_tiles<a name='637'>
     DO j=j_start(ij),j_end(ij)<a name='638'>
     DO k=kms,kme-1<a name='639'>
     DO i=i_start(ij),i_end(ij)<a name='640'>
        temp_ng(i,k,j) = MAX(1.E-8, nh_curr(i,k,j)*rho(i,k,j))<a name='641'>
     ENDDO<a name='642'>
     ENDDO<a name='643'>
     ENDDO<a name='644'>
   ENDDO<a name='645'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='646'></font>
   ELSEIF (PRESENT(ng_curr)) THEN<a name='647'>
   WRITE(outstring,*) 'GT-Debug, this mp scheme, ', mphysics_opt, ' has graupel number concentration'<a name='648'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='649'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='650'></font>
   DO ij = 1 , num_tiles<a name='651'>
     DO j=j_start(ij),j_end(ij)<a name='652'>
     DO k=kms,kme-1<a name='653'>
     DO i=i_start(ij),i_end(ij)<a name='654'>
        temp_ng(i,k,j) = MAX(1.E-8, ng_curr(i,k,j)*rho(i,k,j))<a name='655'>
     ENDDO<a name='656'>
     ENDDO<a name='657'>
     ENDDO<a name='658'>
   ENDDO<a name='659'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='660'></font>
   ELSE<a name='661'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='662'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='663'></font>
   DO ij = 1 , num_tiles<a name='664'>
     DO j=j_start(ij),j_end(ij)<a name='665'>
     DO k=kms,kme-1<a name='666'>
     DO i=i_start(ij),i_end(ij)<a name='667'>
        temp_ng(i,k,j) = 1.E-8<a name='668'>
     ENDDO<a name='669'>
     ENDDO<a name='670'>
     ENDDO<a name='671'>
   ENDDO<a name='672'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='673'></font>
   ENDIF<a name='674'>
<a name='675'>
<a name='676'>
      <font color=#447700>! Calculate the max hail size from graupel/hail parameters in microphysics scheme (gthompsn 12Mar2015)<a name='677'></font>
      <font color=#447700>! First, we do know multiple schemes have assumed inverse-exponential distribution with constant<a name='678'></font>
      <font color=#447700>! intercept parameter and particle density.  Please leave next 4 settings alone for common<a name='679'></font>
      <font color=#447700>! use and copy these and cge constants to re-assign per scheme if needed (e.g. NSSL).<a name='680'></font>
<a name='681'>
      xrho_g = 500.<a name='682'>
      xam_g = 3.1415926536/6.0*xrho_g     <font color=#447700>! Assumed m(D) = a*D**b, where a=PI/6*rho_g and b=3<a name='683'></font>
      xbm_g = 3.                          <font color=#447700>! in other words, spherical graupel/hail<a name='684'></font>
      xmu_g = 0.<a name='685'>
      scheme_has_graupel = .false.<a name='686'>
<a name='687'>
      <font color=#447700>!..Some constants. These *MUST* get changed below per scheme<a name='688'></font>
      <font color=#447700>!.. *IF* either xbm_g or xmu_g value is changed from 3 and zero, respectively.<a name='689'></font>
<a name='690'>
      cge(1) = xbm_g + 1.<a name='691'>
      cge(2) = xmu_g + 1.<a name='692'>
      cge(3) = xbm_g + xmu_g + 1.<a name='693'>
      do n = 1, 3<a name='694'>
         cgg(n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_1">(cge(n))<a name='695'>
      enddo<a name='696'>
<a name='697'>
   mp_select: SELECT CASE(mphysics_opt)<a name='698'>
<a name='699'>
     CASE (KESSLERSCHEME)<a name='700'>
<font color=#447700>!      nothing to do here<a name='701'></font>
<a name='702'>
     CASE (LINSCHEME)<a name='703'>
       scheme_has_graupel = .true.<a name='704'>
       xrho_g = 917.<a name='705'>
       xam_g = 3.1415926536/6.0*xrho_g<a name='706'>
       N0exp = 4.e4<a name='707'>
<font color=#447700>!      !$OMP PARALLEL DO   &amp;<a name='708'></font>
<font color=#447700>!      !$OMP PRIVATE ( ij )<a name='709'></font>
       DO ij = 1 , num_tiles<a name='710'>
         DO j=j_start(ij),j_end(ij)<a name='711'>
         DO k=kme-1, kms, -1<a name='712'>
         DO i=i_start(ij),i_end(ij)<a name='713'>
           if (temp_qg(i,k,j) .LT. 1.E-6) CYCLE<a name='714'>
           lam_exp = (N0exp*xam_g*cgg(1)/temp_qg(i,k,j))**(1./cge(1))<a name='715'>
           temp_ng(i,k,j) = N0exp*cgg(2)*lam_exp**(-cge(2))<a name='716'>
         ENDDO<a name='717'>
         ENDDO<a name='718'>
         ENDDO<a name='719'>
       ENDDO<a name='720'>
<font color=#447700>!      !$OMP END PARALLEL DO<a name='721'></font>
<a name='722'>
     CASE (WSM3SCHEME)<a name='723'>
<font color=#447700>!      nothing to do here<a name='724'></font>
<a name='725'>
     CASE (WSM5SCHEME)<a name='726'>
<font color=#447700>!      nothing to do here<a name='727'></font>
<a name='728'>
     CASE (WSM6SCHEME)<a name='729'>
       scheme_has_graupel = .true.<a name='730'>
       xrho_g = 500.<a name='731'>
       xam_g = 3.1415926536/6.0*xrho_g<a name='732'>
       N0exp = 4.e6<a name='733'>
<font color=#447700>!      !$OMP PARALLEL DO   &amp;<a name='734'></font>
<font color=#447700>!      !$OMP PRIVATE ( ij )<a name='735'></font>
       DO ij = 1 , num_tiles<a name='736'>
         DO j=j_start(ij),j_end(ij)<a name='737'>
         DO k=kme-1, kms, -1<a name='738'>
         DO i=i_start(ij),i_end(ij)<a name='739'>
           if (temp_qg(i,k,j) .LT. 1.E-6) CYCLE<a name='740'>
           lam_exp = (N0exp*xam_g*cgg(1)/temp_qg(i,k,j))**(1./cge(1))<a name='741'>
           temp_ng(i,k,j) = N0exp*cgg(2)*lam_exp**(-cge(2))<a name='742'>
         ENDDO<a name='743'>
         ENDDO<a name='744'>
         ENDDO<a name='745'>
       ENDDO<a name='746'>
<font color=#447700>!      !$OMP END PARALLEL DO<a name='747'></font>
<a name='748'>
     CASE (WDM5SCHEME)<a name='749'>
<font color=#447700>!      nothing to do here<a name='750'></font>
<a name='751'>
     CASE (WDM6SCHEME)<a name='752'>
       scheme_has_graupel = .true.<a name='753'>
       xrho_g = 500.<a name='754'>
       N0exp = 4.e6<a name='755'>
       if (mpuse_hail .eq. 1) then<a name='756'>
         xrho_g = 700.<a name='757'>
         N0exp = 4.e4<a name='758'>
       endif<a name='759'>
       xam_g = 3.1415926536/6.0*xrho_g<a name='760'>
<font color=#447700>!      !$OMP PARALLEL DO   &amp;<a name='761'></font>
<font color=#447700>!      !$OMP PRIVATE ( ij )<a name='762'></font>
       DO ij = 1 , num_tiles<a name='763'>
         DO j=j_start(ij),j_end(ij)<a name='764'>
         DO k=kme-1, kms, -1<a name='765'>
         DO i=i_start(ij),i_end(ij)<a name='766'>
           if (temp_qg(i,k,j) .LT. 1.E-6) CYCLE<a name='767'>
           lam_exp = (N0exp*xam_g*cgg(1)/temp_qg(i,k,j))**(1./cge(1))<a name='768'>
           temp_ng(i,k,j) = N0exp*cgg(2)*lam_exp**(-cge(2))<a name='769'>
         ENDDO<a name='770'>
         ENDDO<a name='771'>
         ENDDO<a name='772'>
       ENDDO<a name='773'>
<font color=#447700>!      !$OMP END PARALLEL DO<a name='774'></font>
<a name='775'>
     CASE (GSFCGCESCHEME)<a name='776'>
      if (gsfcgce_2ice.eq.0 .OR. gsfcgce_2ice.eq.2) then<a name='777'>
       scheme_has_graupel = .true.<a name='778'>
       if (gsfcgce_hail .eq. 1) then<a name='779'>
          xrho_g = 900.<a name='780'>
       else<a name='781'>
          xrho_g = 400.<a name='782'>
       endif<a name='783'>
       xam_g = 3.1415926536/6.0*xrho_g<a name='784'>
       N0exp = 4.e4<a name='785'>
<font color=#447700>!      !$OMP PARALLEL DO   &amp;<a name='786'></font>
<font color=#447700>!      !$OMP PRIVATE ( ij )<a name='787'></font>
       DO ij = 1 , num_tiles<a name='788'>
         DO j=j_start(ij),j_end(ij)<a name='789'>
         DO k=kme-1, kms, -1<a name='790'>
         DO i=i_start(ij),i_end(ij)<a name='791'>
           if (temp_qg(i,k,j) .LT. 1.E-6) CYCLE<a name='792'>
           lam_exp = (N0exp*xam_g*cgg(1)/temp_qg(i,k,j))**(1./cge(1))<a name='793'>
           temp_ng(i,k,j) = N0exp*cgg(2)*lam_exp**(-cge(2))<a name='794'>
         ENDDO<a name='795'>
         ENDDO<a name='796'>
         ENDDO<a name='797'>
       ENDDO<a name='798'>
<font color=#447700>!      !$OMP END PARALLEL DO<a name='799'></font>
      endif<a name='800'>
<a name='801'>
     CASE (SBU_YLINSCHEME)<a name='802'>
<font color=#447700>!      scheme_has_graupel = .true.  ! Can be calculated from rime fraction variable.<a name='803'></font>
<font color=#447700>!      no time to implement<a name='804'></font>
<a name='805'>
     CASE (ETAMPNEW)<a name='806'>
<font color=#447700>!      scheme_has_graupel = .true.  ! Can be calculated from rime fraction variable.<a name='807'></font>
<font color=#447700>!      no time to implement<a name='808'></font>
<a name='809'>
     CASE (THOMPSON, THOMPSONAERO)<a name='810'>
<a name='811'>
       scheme_has_graupel = .true.<a name='812'>
<a name='813'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='814'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='815'></font>
      DO ij = 1 , num_tiles<a name='816'>
       DO j=j_start(ij),j_end(ij)<a name='817'>
       DO k=kms,kme-1<a name='818'>
       DO i=i_start(ij),i_end(ij)<a name='819'>
          temp_qr(i,k,j) = MAX(1.E-10, qr_curr(i,k,j)*rho(i,k,j))<a name='820'>
          temp_nr(i,k,j) = MAX(1.E-8, nr_curr(i,k,j)*rho(i,k,j))<a name='821'>
       ENDDO<a name='822'>
       ENDDO<a name='823'>
       ENDDO<a name='824'>
      ENDDO<a name='825'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='826'></font>
<a name='827'>
       <font color=#447700>! Technically, the equation below for lambda-r should have constants<a name='828'></font>
       <font color=#447700>! for the rain mass-diameter relation and mu, but these are currently<a name='829'></font>
       <font color=#447700>! the same as graupel, so we are cheating to avoid passing more<a name='830'></font>
       <font color=#447700>! constants from mp_thompson.<a name='831'></font>
<a name='832'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='833'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='834'></font>
      DO ij = 1 , num_tiles<a name='835'>
       DO j=j_start(ij),j_end(ij)<a name='836'>
       DO i=i_start(ij),i_end(ij)<a name='837'>
        N0min = 1.E6<a name='838'>
        DO k=kme-1, kms, -1<a name='839'>
         if (temp_qg(i,k,j) .LT. 1.E-6) CYCLE<a name='840'>
         lamr = (1000.0*3.1415926536/6.0*cgg(3)/cgg(2)*temp_nr(i,k,j)/temp_qr(i,k,j))**(1./3.)<a name='841'>
         mvd_r = 3.672 / lamr   <font color=#447700>! Technically this should have (+mu_r)<a name='842'></font>
         mvd_r = MAX(100.E-6, MIN(mvd_r, 2.5E-3))<a name='843'>
         if (temp(i,k,j).lt.270.65 .and. mvd_r.gt.100.E-6) then<a name='844'>
            xslw1 = 4.01 + alog10(mvd_r)<a name='845'>
         else<a name='846'>
            xslw1 = 0.01<a name='847'>
         endif<a name='848'>
         ygra1 = 4.31 + alog10(max(5.E-5, temp_qg(i,k,j)))<a name='849'>
         zans1 = 3.1 + (100./(300.*xslw1*ygra1/(10./xslw1+1.+0.25*ygra1)+30.+10.*ygra1))<a name='850'>
         N0exp = 10.**(zans1)<a name='851'>
         N0exp = MAX(DBLE(1.E4), MIN(N0exp, DBLE(1.E6)))<a name='852'>
         N0min = MIN(N0exp, N0min)<a name='853'>
         N0exp = N0min<a name='854'>
         lam_exp = (N0exp*xam_g*cgg(1)/temp_qg(i,k,j))**(1./cge(1))<a name='855'>
         lamg = lam_exp * (cgg(3)/cgg(2)/cgg(1))**(1./xbm_g)<a name='856'>
         N0_g = N0exp/(cgg(2)*lam_exp) * lamg**cge(2)<a name='857'>
         temp_ng(i,k,j) = N0_g*cgg(2)*lamg**(-cge(2))<a name='858'>
         if (N0exp .ge. 1.E4 .AND. N0exp.le.1.E5) then<a name='859'>
         WRITE(outstring,*) 'GT-Debug, ', N0exp, temp_qr(i,k,j)*1000., temp_ng(i,k,j)<a name='860'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_578"> (850, TRIM(outstring))<a name='861'>
         endif<a name='862'>
        ENDDO<a name='863'>
       ENDDO<a name='864'>
       ENDDO<a name='865'>
      ENDDO<a name='866'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='867'></font>
<a name='868'>
<a name='869'>
<font color=#447700>!    CASE (MORR_MILB_P3)<a name='870'></font>
<font color=#447700>!      scheme_has_graupel = .true.<a name='871'></font>
<font color=#447700>!      either Hugh or Jason need to implement.<a name='872'></font>
<a name='873'>
     CASE (MORR_TWO_MOMENT)<a name='874'>
       scheme_has_graupel = .true.<a name='875'>
       xrho_g = 400.<a name='876'>
       if (mpuse_hail .eq. 1) xrho_g = 900.<a name='877'>
       xam_g = 3.1415926536/6.0*xrho_g<a name='878'>
<a name='879'>
     CASE (MILBRANDT2MOM)<a name='880'>
       WRITE(outstring,*) 'GT-Debug, using Milbrandt2mom, which has 2-moment hail'<a name='881'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_579"> (150, TRIM(outstring))<a name='882'>
       scheme_has_graupel = .true.<a name='883'>
       xrho_g = 900.<a name='884'>
       xam_g = 3.1415926536/6.0*xrho_g<a name='885'>
<a name='886'>
<font color=#447700>!    CASE (MILBRANDT3MOM)<a name='887'></font>
<font color=#447700>!      coming in future?<a name='888'></font>
<a name='889'>
     CASE (NSSL_1MOMLFO, NSSL_1MOM, NSSL_2MOM, NSSL_2MOMG, NSSL_2MOMCCN)<a name='890'>
<a name='891'>
       scheme_has_graupel = .true.<a name='892'>
       xrho_g = nssl_rho_qh<a name='893'>
       N0exp = nssl_cnoh<a name='894'>
       if (PRESENT(qh_curr)) then<a name='895'>
          xrho_g = nssl_rho_qhl<a name='896'>
          N0exp = nssl_cnohl<a name='897'>
       endif<a name='898'>
       xam_g = 3.1415926536/6.0*xrho_g<a name='899'>
<a name='900'>
       if (PRESENT(ng_curr)) xmu_g = nssl_alphah<a name='901'>
       if (PRESENT(nh_curr)) xmu_g = nssl_alphahl<a name='902'>
<a name='903'>
       if (xmu_g .NE. 0.) then<a name='904'>
          cge(1) = xbm_g + 1.<a name='905'>
          cge(2) = xmu_g + 1.<a name='906'>
          cge(3) = xbm_g + xmu_g + 1.<a name='907'>
          do n = 1, 3<a name='908'>
             cgg(n) = <A href='../../html_code/phys/module_mp_thompson.F.html#WGAMMA'>WGAMMA</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WGAMMA_2">(cge(n))<a name='909'>
          enddo<a name='910'>
       endif<a name='911'>
<a name='912'>
       <font color=#447700>! NSSL scheme has many options, but, if single-moment, just fill<a name='913'></font>
       <font color=#447700>! in the number array for graupel from built-in assumptions.<a name='914'></font>
<a name='915'>
       if (.NOT.(PRESENT(nh_curr).OR.PRESENT(ng_curr)) ) then<a name='916'>
<font color=#447700>!      !$OMP PARALLEL DO   &amp;<a name='917'></font>
<font color=#447700>!      !$OMP PRIVATE ( ij )<a name='918'></font>
       DO ij = 1 , num_tiles<a name='919'>
         DO j=j_start(ij),j_end(ij)<a name='920'>
         DO k=kme-1, kms, -1<a name='921'>
         DO i=i_start(ij),i_end(ij)<a name='922'>
           if (temp_qg(i,k,j) .LT. 1.E-6) CYCLE<a name='923'>
           lam_exp = (N0exp*xam_g*cgg(1)/temp_qg(i,k,j))**(1./cge(1))<a name='924'>
           temp_ng(i,k,j) = N0exp*cgg(2)*lam_exp**(-cge(2))<a name='925'>
         ENDDO<a name='926'>
         ENDDO<a name='927'>
         ENDDO<a name='928'>
       ENDDO<a name='929'>
<font color=#447700>!      !$OMP END PARALLEL DO<a name='930'></font>
       endif<a name='931'>
<a name='932'>
<font color=#447700>!    CASE (NSSL_3MOM)<a name='933'></font>
<font color=#447700>!      coming in future?<a name='934'></font>
<a name='935'>
     CASE (CAMMGMPSCHEME)<a name='936'>
<font color=#447700>!      nothing to do here<a name='937'></font>
<a name='938'>
     CASE (FULL_KHAIN_LYNN)<a name='939'>
<font color=#447700>!      explicit bin scheme so code below not applicable<a name='940'></font>
<font color=#447700>!      scheme authors need to implement if desired.<a name='941'></font>
<a name='942'>
     CASE (FAST_KHAIN_LYNN)<a name='943'>
<font color=#447700>!      explicit bin scheme so code below not applicable<a name='944'></font>
<font color=#447700>!      scheme authors need to implement if desired.<a name='945'></font>
<a name='946'>
     CASE DEFAULT<a name='947'>
<a name='948'>
   END SELECT mp_select<a name='949'>
<a name='950'>
<a name='951'>
   if (scheme_has_graupel) then<a name='952'>
<a name='953'>
<font color=#447700>!..Create bins of graupel/hail (from 500 microns up to 7.5 cm).<a name='954'></font>
      xxDx(1) = 500.D-6<a name='955'>
      xxDx(ngbins+1) = 0.075d0<a name='956'>
      do n = 2, ngbins<a name='957'>
         xxDx(n) = DEXP(DFLOAT(n-1)/DFLOAT(ngbins) &amp;<a name='958'>
                  *DLOG(xxDx(ngbins+1)/xxDx(1)) +DLOG(xxDx(1)))<a name='959'>
      enddo<a name='960'>
      do n = 1, ngbins<a name='961'>
         xxDg(n) = DSQRT(xxDx(n)*xxDx(n+1))<a name='962'>
         xdtg(n) = xxDx(n+1) - xxDx(n)<a name='963'>
      enddo<a name='964'>
<a name='965'>
<a name='966'>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='967'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='968'></font>
      DO ij = 1 , num_tiles<a name='969'>
        DO j=j_start(ij),j_end(ij)<a name='970'>
        DO k=kms,kme-1<a name='971'>
        DO i=i_start(ij),i_end(ij)<a name='972'>
           if (temp_qg(i,k,j) .LT. 1.E-6) CYCLE<a name='973'>
           lamg = (xam_g*cgg(3)/cgg(2)*temp_ng(i,k,j)/temp_qg(i,k,j))**(1./xbm_g)<a name='974'>
           N0_g = temp_ng(i,k,j)/cgg(2)*lamg**cge(2)<a name='975'>
           sum_ng = 0.0d0<a name='976'>
           do ng = ngbins, 1, -1<a name='977'>
              f_d = N0_g*xxDg(ng)**xmu_g * DEXP(-lamg*xxDg(ng))*xdtg(ng)<a name='978'>
              sum_ng = sum_ng + f_d<a name='979'>
              if (sum_ng .gt. thresh_conc) then<a name='980'>
                 exit<a name='981'>
              endif<a name='982'>
           enddo<a name='983'>
           if (ng .ge. ngbins) then<a name='984'>
              hail_max = xxDg(ngbins)<a name='985'>
           elseif (xxDg(ng+1) .gt. 1.E-3) then<a name='986'>
              hail_max = xxDg(ng+1)<a name='987'>
           else<a name='988'>
              hail_max = 1.E-4<a name='989'>
           endif<a name='990'>
           if (hail_max .gt. 1E-2) then<a name='991'>
            WRITE(outstring,*) 'GT-Debug-Hail, ', hail_max*1000.<a name='992'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_580"> (350, TRIM(outstring))<a name='993'>
           endif<a name='994'>
           hail_max_sp = hail_max<a name='995'>
           if (k.eq.kms) then<a name='996'>
              hail_maxk1(i,j) = MAX(hail_maxk1(i,j), hail_max_sp)<a name='997'>
           endif<a name='998'>
           hail_max2d(i,j) = MAX(hail_max2d(i,j), hail_max_sp)<a name='999'>
        ENDDO<a name='1000'>
        ENDDO<a name='1001'>
        ENDDO<a name='1002'>
      ENDDO<a name='1003'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='1004'></font>
<a name='1005'>
   endif<a name='1006'>
<a name='1007'>
<a name='1008'>
   ENDIF<a name='1009'>
<font color=#447700>! NSSL<a name='1010'></font>
<a name='1011'>
   if (diag_print .eq. 0 ) return<a name='1012'>
<a name='1013'>
   IF ( xtime .ne. 0. ) THEN<a name='1014'>
<a name='1015'>
<font color=#447700>! COMPUTE THE NUMBER OF MASS GRID POINTS<a name='1016'></font>
   no_points = float((ide-ids)*(jde-jds))<a name='1017'>
<a name='1018'>
<font color=#447700>! SET START AND END POINTS FOR TILES<a name='1019'></font>
<font color=#447700>!  !$OMP PARALLEL DO   &amp;<a name='1020'></font>
<font color=#447700>!  !$OMP PRIVATE ( ij )<a name='1021'></font>
<a name='1022'>
   dmumax = 0.<a name='1023'>
   DO ij = 1 , num_tiles<a name='1024'>
<a name='1025'>
<font color=#447700>!     print *, i_start(ij),i_end(ij),j_start(ij),j_end(ij)<a name='1026'></font>
      DO j=j_start(ij),j_end(ij)<a name='1027'>
      DO i=i_start(ij),i_end(ij)<a name='1028'>
         dpsdt(i,j)=(p8w(i,kms,j)-pk1m(i,j))/dt<a name='1029'>
         dmudt(i,j)=(mu_2(i,j)-mu_2m(i,j))/dt<a name='1030'>
         if(abs(dmudt(i,j)*dt).gt.dmumax)then<a name='1031'>
           dmumax=abs(dmudt(i,j)*dt)<a name='1032'>
           idp=i<a name='1033'>
           jdp=j<a name='1034'>
         endif<a name='1035'>
      ENDDO      <a name='1036'>
      ENDDO<a name='1037'>
<a name='1038'>
   ENDDO<a name='1039'>
<font color=#447700>!  !$OMP END PARALLEL DO<a name='1040'></font>
<a name='1041'>
<font color=#447700>! convert DMUMAX from (PA) to (bars) per time step<a name='1042'></font>
   dmumax = dmumax*1.e-5<a name='1043'>
<font color=#447700>! compute global MAX<a name='1044'></font>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>wrf_dm_maxval</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_7"> ( dmumax,  idp, jdp )<a name='1045'>
<a name='1046'>
<font color=#447700>!  print *, 'p8w(30,1,30),pk1m(30,30) : ', p8w(30,1,30),pk1m(30,30)<a name='1047'></font>
<font color=#447700>!  print *, 'mu_2(30,30),mu_2m(30,30) : ', mu_2(30,30),mu_2m(30,30)<a name='1048'></font>
   dpsdt_sum = 0.<a name='1049'>
   dmudt_sum = 0.<a name='1050'>
<a name='1051'>
   DO j = jps, min(jpe,jde-1)<a name='1052'>
     DO i = ips, min(ipe,ide-1)<a name='1053'>
       dpsdt_sum = dpsdt_sum + abs(dpsdt(i,j))<a name='1054'>
       dmudt_sum = dmudt_sum + abs(dmudt(i,j))<a name='1055'>
     ENDDO<a name='1056'>
   ENDDO<a name='1057'>
<a name='1058'>
<font color=#447700>! compute global sum<a name='1059'></font>
   dpsdt_sum = wrf_dm_sum_real ( dpsdt_sum )<a name='1060'>
   dmudt_sum = wrf_dm_sum_real ( dmudt_sum )<a name='1061'>
<a name='1062'>
<font color=#447700>!  print *, 'dpsdt, dmudt : ', dpsdt_sum, dmudt_sum<a name='1063'></font>
<a name='1064'>
   IF ( diag_print .eq. 2 ) THEN<a name='1065'>
   dardt_sum = 0.<a name='1066'>
   drcdt_sum = 0.<a name='1067'>
   drndt_sum = 0.<a name='1068'>
   rainc_sum = 0.<a name='1069'>
   raint_sum = 0.<a name='1070'>
   rainnc_sum = 0.<a name='1071'>
   sfcevp_sum = 0.<a name='1072'>
   hfx_sum = 0.<a name='1073'>
   lh_sum = 0.<a name='1074'>
   raincmax = 0.<a name='1075'>
   rainncmax = 0.<a name='1076'>
<a name='1077'>
   DO j = jps, min(jpe,jde-1)<a name='1078'>
     DO i = ips, min(ipe,ide-1)<a name='1079'>
       drcdt_sum = drcdt_sum + abs(raincv(i,j))<a name='1080'>
       drndt_sum = drndt_sum + abs(rainncv(i,j))<a name='1081'>
       dardt_sum = dardt_sum + abs(raincv(i,j)) + abs(rainncv(i,j))<a name='1082'>
       rainc_sum = rainc_sum + abs(rainc(i,j))<a name='1083'>
<font color=#447700>! MAX for accumulated conv precip<a name='1084'></font>
       IF(rainc(i,j).gt.raincmax)then<a name='1085'>
          raincmax=rainc(i,j)<a name='1086'>
          irc=i<a name='1087'>
          jrc=j<a name='1088'>
       ENDIF<a name='1089'>
       rainnc_sum = rainnc_sum + abs(rainnc(i,j))<a name='1090'>
<font color=#447700>! MAX for accumulated resolved precip<a name='1091'></font>
       IF(rainnc(i,j).gt.rainncmax)then<a name='1092'>
          rainncmax=rainnc(i,j)<a name='1093'>
          irnc=i<a name='1094'>
          jrnc=j<a name='1095'>
       ENDIF<a name='1096'>
       raint_sum = raint_sum + abs(rainc(i,j)) + abs(rainnc(i,j))<a name='1097'>
       sfcevp_sum = sfcevp_sum + abs(sfcevp(i,j))<a name='1098'>
       hfx_sum = hfx_sum + abs(hfx(i,j))<a name='1099'>
       lh_sum = lh_sum + abs(lh(i,j))<a name='1100'>
     ENDDO<a name='1101'>
   ENDDO<a name='1102'>
<a name='1103'>
<font color=#447700>! compute global MAX<a name='1104'></font>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>wrf_dm_maxval</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_8"> ( raincmax, irc, jrc )<a name='1105'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>wrf_dm_maxval</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_9"> ( rainncmax, irnc, jrnc )<a name='1106'>
<a name='1107'>
<font color=#447700>! compute global sum<a name='1108'></font>
   drcdt_sum = wrf_dm_sum_real ( drcdt_sum )<a name='1109'>
   drndt_sum = wrf_dm_sum_real ( drndt_sum )<a name='1110'>
   dardt_sum = wrf_dm_sum_real ( dardt_sum )<a name='1111'>
   rainc_sum = wrf_dm_sum_real ( rainc_sum )<a name='1112'>
   rainnc_sum = wrf_dm_sum_real ( rainnc_sum )<a name='1113'>
   raint_sum = wrf_dm_sum_real ( raint_sum )<a name='1114'>
   sfcevp_sum = wrf_dm_sum_real ( sfcevp_sum )<a name='1115'>
   hfx_sum = wrf_dm_sum_real ( hfx_sum )<a name='1116'>
   lh_sum = wrf_dm_sum_real ( lh_sum )<a name='1117'>
<a name='1118'>
   ENDIF<a name='1119'>
<a name='1120'>
<font color=#447700>! print out the average values<a name='1121'></font>
<a name='1122'>
   CALL <A href='../../html_code/io_netcdf/diffwrf.F90.html#GET_CURRENT_GRID_NAME'>get_current_grid_name</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CURRENT_GRID_NAME_3">( grid_str )<a name='1123'>
<a name='1124'>
#ifdef DM_PARALLEL<a name='1125'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='1126'>
#endif<a name='1127'>
     WRITE(outstring,*) grid_str,'Domain average of dpsdt, dmudt (mb/3h): ', xtime, &amp;<a name='1128'>
           dpsdt_sum/no_points*108., &amp;<a name='1129'>
           dmudt_sum/no_points*108.<a name='1130'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_648"> ( TRIM(outstring) )<a name='1131'>
<a name='1132'>
     WRITE(outstring,*) grid_str,'Max mu change time step: ', idp,jdp,dmumax<a name='1133'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_649"> ( TRIM(outstring) )<a name='1134'>
<a name='1135'>
     IF ( diag_print .eq. 2) THEN<a name='1136'>
     WRITE(outstring,*) grid_str,'Domain average of dardt, drcdt, drndt (mm/sec): ', xtime, &amp;<a name='1137'>
           dardt_sum/dt/no_points, &amp;<a name='1138'>
           drcdt_sum/dt/no_points, &amp;<a name='1139'>
           drndt_sum/dt/no_points<a name='1140'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_650"> ( TRIM(outstring) )<a name='1141'>
     WRITE(outstring,*) grid_str,'Domain average of rt_sum, rc_sum, rnc_sum (mm): ', xtime, &amp;<a name='1142'>
           raint_sum/no_points, &amp;<a name='1143'>
           rainc_sum/no_points, &amp;<a name='1144'>
           rainnc_sum/no_points<a name='1145'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_651"> ( TRIM(outstring) )<a name='1146'>
     WRITE(outstring,*) grid_str,'Max Accum Resolved Precip,   I,J  (mm): '               ,&amp;<a name='1147'>
           rainncmax,irnc,jrnc<a name='1148'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_652"> ( TRIM(outstring) )<a name='1149'>
     WRITE(outstring,*) grid_str,'Max Accum Convective Precip,   I,J  (mm): '             ,&amp;<a name='1150'>
           raincmax,irc,jrc<a name='1151'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_653"> ( TRIM(outstring) )<a name='1152'>
     WRITE(outstring,*) grid_str,'Domain average of sfcevp, hfx, lh: ', xtime, &amp;<a name='1153'>
           sfcevp_sum/no_points, &amp;<a name='1154'>
           hfx_sum/no_points, &amp;<a name='1155'>
           lh_sum/no_points<a name='1156'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/phys/module_diag_misc.F.html#DIAGNOSTIC_OUTPUT_CALC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_654"> ( TRIM(outstring) )<a name='1157'>
     ENDIF<a name='1158'>
#ifdef DM_PARALLEL<a name='1159'>
   ENDIF<a name='1160'>
#endif<a name='1161'>
<a name='1162'>
   ENDIF<a name='1163'>
<a name='1164'>
<font color=#447700>! save values at this time step<a name='1165'></font>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1166'></font>
   <font color=#447700>!$OMP PRIVATE ( ij,i,j )<a name='1167'></font>
   DO ij = 1 , num_tiles<a name='1168'>
<a name='1169'>
      DO j=j_start(ij),j_end(ij)<a name='1170'>
      DO i=i_start(ij),i_end(ij)<a name='1171'>
         pk1m(i,j)=p8w(i,kms,j)<a name='1172'>
         mu_2m(i,j)=mu_2(i,j)<a name='1173'>
      ENDDO<a name='1174'>
      ENDDO<a name='1175'>
<a name='1176'>
      IF ( xtime .lt. 0.0001 ) THEN<a name='1177'>
      DO j=j_start(ij),j_end(ij)<a name='1178'>
      DO i=i_start(ij),i_end(ij)<a name='1179'>
         dpsdt(i,j)=0.<a name='1180'>
         dmudt(i,j)=0.<a name='1181'>
      ENDDO<a name='1182'>
      ENDDO<a name='1183'>
      ENDIF<a name='1184'>
<a name='1185'>
   ENDDO<a name='1186'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='1187'></font>
<a name='1188'>
   END SUBROUTINE diagnostic_output_calc<a name='1189'>
<a name='1190'>
<a name='1191'>
<font color=#447700>!+---+-----------------------------------------------------------------+ <a name='1192'></font>
<A NAME='GAMMLN'><A href='../../html_code/phys/module_diag_misc.F.html#GAMMLN' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1193'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>GAMMLN</font>(XX) <A href='../../call_to/GAMMLN.html' TARGET='index'>4</A><a name='1194'>
<font color=#447700>!     --- RETURNS THE VALUE LN(GAMMA(XX)) FOR XX &gt; 0.<a name='1195'></font>
      IMPLICIT NONE<a name='1196'>
      REAL, INTENT(IN):: XX<a name='1197'>
      DOUBLE PRECISION, PARAMETER:: STP = 2.5066282746310005D0<a name='1198'>
      DOUBLE PRECISION, DIMENSION(6), PARAMETER:: &amp;<a name='1199'>
               COF = (/76.18009172947146D0, -86.50532032941677D0, &amp;<a name='1200'>
                       24.01409824083091D0, -1.231739572450155D0, &amp;<a name='1201'>
                      .1208650973866179D-2, -.5395239384953D-5/)<a name='1202'>
      DOUBLE PRECISION:: SER,TMP,X,Y<a name='1203'>
      INTEGER:: J<a name='1204'>
<a name='1205'>
      X=XX<a name='1206'>
      Y=X<a name='1207'>
      TMP=X+5.5D0<a name='1208'>
      TMP=(X+0.5D0)*LOG(TMP)-TMP<a name='1209'>
      SER=1.000000000190015D0<a name='1210'>
      DO 11 J=1,6<a name='1211'>
        Y=Y+1.D0<a name='1212'>
        SER=SER+COF(J)/Y<a name='1213'>
11    CONTINUE<a name='1214'>
      GAMMLN=TMP+LOG(STP*SER/X)<a name='1215'>
      END FUNCTION GAMMLN<a name='1216'>
<font color=#447700>!  (C) Copr. 1986-92 Numerical Recipes Software 2.02<a name='1217'></font>
<font color=#447700>!+---+-----------------------------------------------------------------+ <a name='1218'></font>
<A NAME='WGAMMA'><A href='../../html_code/phys/module_diag_misc.F.html#WGAMMA' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1219'>
      REAL <font color=#993300>FUNCTION </font><font color=#cc0000>WGAMMA</font>(y) <A href='../../call_to/WGAMMA.html' TARGET='index'>20</A><a name='1220'>
<a name='1221'>
      IMPLICIT NONE<a name='1222'>
      REAL, INTENT(IN):: y<a name='1223'>
<a name='1224'>
      WGAMMA = EXP(GAMMLN(y))<a name='1225'>
<a name='1226'>
      END FUNCTION WGAMMA<a name='1227'>
<font color=#447700>!+---+-----------------------------------------------------------------+ <a name='1228'></font>
<a name='1229'>
<a name='1230'>
END MODULE module_diag_misc<a name='1231'>
#endif<a name='1232'>
</pre></body></html>