<HTML> <BODY BGCOLOR=#ddddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:model_layer:physics<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>!<a name='6'></font>
<A NAME='MODULE_BL_GWDO'><A href='../../html_code/phys/module_bl_gwdo.F.html#MODULE_BL_GWDO' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='7'>
<font color=#993300>module </font><font color=#cc0000>module_bl_gwdo</font> <A href='../../call_to/MODULE_BL_GWDO.html' TARGET='index'>1</A><a name='8'>
contains<a name='9'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='10'></font>
<A NAME='GWDO'><A href='../../html_code/phys/module_bl_gwdo.F.html#GWDO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11'>
   <font color=#993300>subroutine </font><font color=#cc0000>gwdo</font>(u3d,v3d,t3d,qv3d,p3d,p3di,pi3d,z,                           &amp; <A href='../../call_to/GWDO.html' TARGET='index'>1</A>,<A href='../../call_from/GWDO.html' TARGET='index'>1</A><a name='12'>
                  rublten,rvblten,                                             &amp;<a name='13'>
                  dtaux3d,dtauy3d,dusfcg,dvsfcg,                               &amp;<a name='14'>
                  var2d,oc12d,oa2d1,oa2d2,oa2d3,oa2d4,ol2d1,ol2d2,ol2d3,ol2d4, &amp;<a name='15'>
                  znu,znw,p_top,                                               &amp;<a name='16'>
                  cp,g,rd,rv,ep1,pi,                                           &amp;<a name='17'>
                  dt,dx,kpbl2d,itimestep,                                      &amp;<a name='18'>
                  ids,ide, jds,jde, kds,kde,                                   &amp;<a name='19'>
                  ims,ime, jms,jme, kms,kme,                                   &amp;<a name='20'>
                  its,ite, jts,jte, kts,kte)<a name='21'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='22'></font>
   implicit none<a name='23'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='24'></font>
<font color=#447700>!                                                                       <a name='25'></font>
<font color=#447700>!-- u3d         3d u-velocity interpolated to theta points (m/s)<a name='26'></font>
<font color=#447700>!-- v3d         3d v-velocity interpolated to theta points (m/s)<a name='27'></font>
<font color=#447700>!-- t3d         temperature (k)<a name='28'></font>
<font color=#447700>!-- qv3d        3d water vapor mixing ratio (kg/kg)<a name='29'></font>
<font color=#447700>!-- p3d         3d pressure (pa)<a name='30'></font>
<font color=#447700>!-- p3di        3d pressure (pa) at interface level<a name='31'></font>
<font color=#447700>!-- pi3d        3d exner function (dimensionless)<a name='32'></font>
<font color=#447700>!-- rublten     u tendency due to pbl parameterization (m/s/s) <a name='33'></font>
<font color=#447700>!-- rvblten     v tendency due to pbl parameterization (m/s/s)<a name='34'></font>
<font color=#447700>!-- znu         eta values (sigma values)<a name='35'></font>
<font color=#447700>!-- cp          heat capacity at constant pressure for dry air (j/kg/k)<a name='36'></font>
<font color=#447700>!-- g           acceleration due to gravity (m/s^2)<a name='37'></font>
<font color=#447700>!-- rd          gas constant for dry air (j/kg/k)<a name='38'></font>
<font color=#447700>!-- z           height above sea level (m)<a name='39'></font>
<font color=#447700>!-- rv          gas constant for water vapor (j/kg/k)<a name='40'></font>
<font color=#447700>!-- dt          time step (s)<a name='41'></font>
<font color=#447700>!-- dx          model grid interval (m)<a name='42'></font>
<font color=#447700>!-- ep1         constant for virtual temperature (r_v/r_d - 1) (dimensionless)<a name='43'></font>
<font color=#447700>!-- ids         start index for i in domain<a name='44'></font>
<font color=#447700>!-- ide         end index for i in domain<a name='45'></font>
<font color=#447700>!-- jds         start index for j in domain<a name='46'></font>
<font color=#447700>!-- jde         end index for j in domain<a name='47'></font>
<font color=#447700>!-- kds         start index for k in domain<a name='48'></font>
<font color=#447700>!-- kde         end index for k in domain<a name='49'></font>
<font color=#447700>!-- ims         start index for i in memory<a name='50'></font>
<font color=#447700>!-- ime         end index for i in memory<a name='51'></font>
<font color=#447700>!-- jms         start index for j in memory<a name='52'></font>
<font color=#447700>!-- jme         end index for j in memory<a name='53'></font>
<font color=#447700>!-- kms         start index for k in memory<a name='54'></font>
<font color=#447700>!-- kme         end index for k in memory<a name='55'></font>
<font color=#447700>!-- its         start index for i in tile<a name='56'></font>
<font color=#447700>!-- ite         end index for i in tile<a name='57'></font>
<font color=#447700>!-- jts         start index for j in tile<a name='58'></font>
<font color=#447700>!-- jte         end index for j in tile<a name='59'></font>
<font color=#447700>!-- kts         start index for k in tile<a name='60'></font>
<font color=#447700>!-- kte         end index for k in tile<a name='61'></font>
<font color=#447700>!<a name='62'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='63'></font>
  integer,  intent(in   )   ::      ids,ide, jds,jde, kds,kde,                 &amp;<a name='64'>
                                     ims,ime, jms,jme, kms,kme,                &amp;<a name='65'>
                                     its,ite, jts,jte, kts,kte<a name='66'>
  integer,  intent(in   )   ::      itimestep<a name='67'>
<font color=#447700>!<a name='68'></font>
  real,     intent(in   )   ::      dt,dx,cp,g,rd,rv,ep1,pi<a name='69'>
<font color=#447700>!<a name='70'></font>
  real,     dimension( ims:ime, kms:kme, jms:jme )                           , &amp;<a name='71'>
            intent(in   )   ::                                           qv3d, &amp;<a name='72'>
                                                                          p3d, &amp;<a name='73'>
                                                                         pi3d, &amp;<a name='74'>
                                                                          t3d, &amp;<a name='75'>
                                                                             z<a name='76'>
  real,     dimension( ims:ime, kms:kme, jms:jme )                           , &amp;<a name='77'>
            intent(in   )   ::                                           p3di<a name='78'>
<font color=#447700>!<a name='79'></font>
  real,     dimension( ims:ime, kms:kme, jms:jme )                           , &amp;<a name='80'>
            intent(inout)   ::                                        rublten, &amp;<a name='81'>
                                                                      rvblten<a name='82'>
  real,     dimension( ims:ime, kms:kme, jms:jme )                           , &amp;<a name='83'>
            intent(inout)   ::                                        dtaux3d, &amp;<a name='84'>
                                                                      dtauy3d<a name='85'>
<font color=#447700>!<a name='86'></font>
  real,      dimension( ims:ime, kms:kme, jms:jme )                          , &amp;<a name='87'>
             intent(in   )   ::                                           u3d, &amp;<a name='88'>
                                                                          v3d<a name='89'>
<font color=#447700>!<a name='90'></font>
  integer,   dimension( ims:ime, jms:jme )                                   , &amp;<a name='91'>
             intent(in  )   ::                                         kpbl2d<a name='92'>
  real,   dimension( ims:ime, jms:jme )                                      , &amp;<a name='93'>
             intent(inout  )   ::                                      dusfcg, &amp;<a name='94'>
                                                                       dvsfcg<a name='95'>
<font color=#447700>!<a name='96'></font>
  real,   dimension( ims:ime, jms:jme )                                      , &amp;<a name='97'>
             intent(in  )   ::                                          var2d, &amp;<a name='98'>
                                                                        oc12d, &amp;<a name='99'>
                                                      oa2d1,oa2d2,oa2d3,oa2d4, &amp;<a name='100'>
                                                      ol2d1,ol2d2,ol2d3,ol2d4<a name='101'>
<font color=#447700>!<a name='102'></font>
  real,     dimension( kms:kme )                                             , &amp;<a name='103'>
            optional                                                         , &amp;<a name='104'>
            intent(in  )   ::                                             znu, &amp;<a name='105'>
                                                                          znw<a name='106'>
<font color=#447700>!<a name='107'></font>
  real,     optional, intent(in  )   ::                                 p_top<a name='108'>
<font color=#447700>!<a name='109'></font>
<font color=#447700>!local<a name='110'></font>
<font color=#447700>!<a name='111'></font>
  real,   dimension( its:ite, kts:kte )  ::                           delprsi, &amp;<a name='112'>
                                                                          pdh<a name='113'>
  real,     dimension( its:ite, kts:kte+1 )   ::                         pdhi<a name='114'>
  real,   dimension( its:ite, 4 )        ::                               oa4, &amp;<a name='115'>
                                                                          ol4<a name='116'>
  integer ::  i,j,k,kdt,kpblmax<a name='117'>
<font color=#447700>!<a name='118'></font>
   do k = kts,kte<a name='119'>
     if(znu(k).gt.0.6) kpblmax = k + 1<a name='120'>
   enddo<a name='121'>
<font color=#447700>!<a name='122'></font>
   do j = jts,jte<a name='123'>
      do k = kts,kte+1<a name='124'>
        do i = its,ite<a name='125'>
           if(k.le.kte)pdh(i,k) = p3d(i,k,j)<a name='126'>
           pdhi(i,k) = p3di(i,k,j)<a name='127'>
        enddo<a name='128'>
      enddo<a name='129'>
<font color=#447700>!<a name='130'></font>
      do k = kts,kte<a name='131'>
        do i = its,ite<a name='132'>
          delprsi(i,k) = pdhi(i,k)-pdhi(i,k+1)<a name='133'>
        enddo<a name='134'>
      enddo<a name='135'>
        do i = its,ite<a name='136'>
            oa4(i,1) = oa2d1(i,j)<a name='137'>
            oa4(i,2) = oa2d2(i,j)<a name='138'>
            oa4(i,3) = oa2d3(i,j)<a name='139'>
            oa4(i,4) = oa2d4(i,j)<a name='140'>
            ol4(i,1) = ol2d1(i,j)<a name='141'>
            ol4(i,2) = ol2d2(i,j)<a name='142'>
            ol4(i,3) = ol2d3(i,j)<a name='143'>
            ol4(i,4) = ol2d4(i,j)<a name='144'>
        enddo<a name='145'>
      call <A href='../../html_code/phys/module_bl_gwdo.F.html#GWDO2D'>gwdo2d</A><A href='../../html_code/phys/module_bl_gwdo.F.html#GWDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GWDO2D_1">(dudt=rublten(ims,kms,j),dvdt=rvblten(ims,kms,j)              &amp;<a name='146'>
              ,dtaux2d=dtaux3d(ims,kms,j),dtauy2d=dtauy3d(ims,kms,j)           &amp;<a name='147'>
              ,u1=u3d(ims,kms,j),v1=v3d(ims,kms,j)                             &amp;<a name='148'>
              ,t1=t3d(ims,kms,j),q1=qv3d(ims,kms,j)                            &amp;<a name='149'>
              ,del=delprsi(its,kts)                                            &amp;<a name='150'>
              ,prsi=pdhi(its,kts)                                              &amp;<a name='151'>
              ,prsl=pdh(its,kts),prslk=pi3d(ims,kms,j)                         &amp;<a name='152'>
              ,zl=z(ims,kms,j),rcl=1.0                                         &amp;<a name='153'>
              ,kpblmax=kpblmax                                                 &amp;<a name='154'>
              ,dusfc=dusfcg(ims,j),dvsfc=dvsfcg(ims,j)                         &amp;<a name='155'>
              ,var=var2d(ims,j),oc1=oc12d(ims,j)                               &amp;<a name='156'>
              ,oa4=oa4,ol4=ol4                                                 &amp;<a name='157'>
              ,g=g,cp=cp,rd=rd,rv=rv,fv=ep1,pi=pi                              &amp;<a name='158'>
              ,dxmeter=dx,deltim=dt                                            &amp;<a name='159'>
              ,kpbl=kpbl2d(ims,j),kdt=itimestep,lat=j                          &amp;<a name='160'>
              ,ids=ids,ide=ide, jds=jds,jde=jde, kds=kds,kde=kde               &amp;<a name='161'>
              ,ims=ims,ime=ime, jms=jms,jme=jme, kms=kms,kme=kme               &amp;<a name='162'>
              ,its=its,ite=ite, jts=jts,jte=jte, kts=kts,kte=kte   )<a name='163'>
   enddo<a name='164'>
<font color=#447700>!<a name='165'></font>
   end subroutine gwdo<a name='166'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='167'></font>
<font color=#447700>!<a name='168'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='169'></font>
<A NAME='GWDO2D'><A href='../../html_code/phys/module_bl_gwdo.F.html#GWDO2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='170'>
   <font color=#993300>subroutine </font><font color=#cc0000>gwdo2d</font>(dudt,dvdt,dtaux2d,dtauy2d,                                &amp; <A href='../../call_to/GWDO2D.html' TARGET='index'>1</A><a name='171'>
                    u1,v1,t1,q1,                                               &amp;<a name='172'>
                    del,                                                       &amp;<a name='173'>
                    prsi,prsl,prslk,zl,rcl,kpblmax,                            &amp;<a name='174'>
                    var,oc1,oa4,ol4,dusfc,dvsfc,                               &amp;<a name='175'>
                    g,cp,rd,rv,fv,pi,dxmeter,deltim,kpbl,kdt,lat,              &amp;<a name='176'>
                    ids,ide, jds,jde, kds,kde,                                 &amp;<a name='177'>
                    ims,ime, jms,jme, kms,kme,                                 &amp;<a name='178'>
                    its,ite, jts,jte, kts,kte)<a name='179'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='180'></font>
<font color=#447700>!  <a name='181'></font>
<font color=#447700>!  this code handles the time tendencies of u v due to the effect of  mountain <a name='182'></font>
<font color=#447700>!  induced gravity wave drag from sub-grid scale orography. this routine <a name='183'></font>
<font color=#447700>!  not only treats the traditional upper-level wave breaking due to mountain <a name='184'></font>
<font color=#447700>!  variance (alpert 1988), but also the enhanced lower-tropospheric wave <a name='185'></font>
<font color=#447700>!  breaking due to mountain convexity and asymmetry (kim and arakawa 1995). <a name='186'></font>
<font color=#447700>!  thus, in addition to the terrain height data in a model grid gox, <a name='187'></font>
<font color=#447700>!  additional 10-2d topographic statistics files are needed, including <a name='188'></font>
<font color=#447700>!  orographic standard  deviation (var), convexity (oc1), asymmetry (oa4) <a name='189'></font>
<font color=#447700>!  and ol (ol4). these data sets are prepared based on the 30 sec usgs orography<a name='190'></font>
<font color=#447700>!  hong (1999). the current scheme was implmented as in hong et al.(2008)<a name='191'></font>
<font color=#447700>!<a name='192'></font>
<font color=#447700>!  coded by song-you hong and young-joon kim and implemented by song-you hong<a name='193'></font>
<font color=#447700>!<a name='194'></font>
<font color=#447700>!  program history log:<a name='195'></font>
<font color=#447700>!    2014-10-01  Hyun-Joo Choi (from KIAPS)  flow-blocking drag of kim and doyle<a name='196'></font>
<font color=#447700>!                              with blocked height by dividing streamline theory<a name='197'></font>
<font color=#447700>!<a name='198'></font>
<font color=#447700>!  references:<a name='199'></font>
<font color=#447700>!        hong et al. (2008), wea. and forecasting<a name='200'></font>
<font color=#447700>!        kim and doyle (2005), Q. J. R. Meteor. Soc.<a name='201'></font>
<font color=#447700>!        kim and arakawa (1995), j. atmos. sci.<a name='202'></font>
<font color=#447700>!        alpet et al. (1988), NWP conference.<a name='203'></font>
<font color=#447700>!        hong (1999), NCEP office note 424.<a name='204'></font>
<font color=#447700>!<a name='205'></font>
<font color=#447700>!  notice : comparible or lower resolution orography files than model resolution<a name='206'></font>
<font color=#447700>!           are desirable in preprocess (wps) to prevent weakening of the drag<a name='207'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='208'></font>
<font color=#447700>!<a name='209'></font>
<font color=#447700>!  input                                                                <a name='210'></font>
<font color=#447700>!        dudt (ims:ime,kms:kme)  non-lin tendency for u wind component<a name='211'></font>
<font color=#447700>!        dvdt (ims:ime,kms:kme)  non-lin tendency for v wind component<a name='212'></font>
<font color=#447700>!        u1(ims:ime,kms:kme) zonal wind / sqrt(rcl)  m/sec  at t0-dt<a name='213'></font>
<font color=#447700>!        v1(ims:ime,kms:kme) meridional wind / sqrt(rcl) m/sec at t0-dt<a name='214'></font>
<font color=#447700>!        t1(ims:ime,kms:kme) temperature deg k at t0-dt<a name='215'></font>
<font color=#447700>!        q1(ims:ime,kms:kme) specific humidity at t0-dt<a name='216'></font>
<font color=#447700>!<a name='217'></font>
<font color=#447700>!        rcl     a scaling factor = reciprocal of square of cos(lat)<a name='218'></font>
<font color=#447700>!                for gmp.  rcl=1 if u1 and v1 are wind components.<a name='219'></font>
<font color=#447700>!        deltim  time step    secs                                       <a name='220'></font>
<font color=#447700>!        del(kts:kte)  positive increment of pressure across layer (pa)<a name='221'></font>
<font color=#447700>!                                                                       <a name='222'></font>
<font color=#447700>!  output<a name='223'></font>
<font color=#447700>!        dudt, dvdt    wind tendency due to gwdo<a name='224'></font>
<font color=#447700>!<a name='225'></font>
<font color=#447700>!-------------------------------------------------------------------------------<a name='226'></font>
   implicit none<a name='227'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='228'></font>
   integer              ::  kdt,lat,latd,lond,kpblmax,                         &amp;<a name='229'>
                            ids,ide, jds,jde, kds,kde,                         &amp;<a name='230'>
                            ims,ime, jms,jme, kms,kme,                         &amp;<a name='231'>
                            its,ite, jts,jte, kts,kte<a name='232'>
<font color=#447700>!<a name='233'></font>
   real                 ::  g,rd,rv,fv,cp,pi,dxmeter,deltim,rcl<a name='234'>
   real                 ::  dudt(ims:ime,kms:kme),dvdt(ims:ime,kms:kme),       &amp;<a name='235'>
                            dtaux2d(ims:ime,kms:kme),dtauy2d(ims:ime,kms:kme), &amp;<a name='236'>
                            u1(ims:ime,kms:kme),v1(ims:ime,kms:kme),           &amp; <a name='237'>
                            t1(ims:ime,kms:kme),q1(ims:ime,kms:kme),           &amp;<a name='238'>
                            zl(ims:ime,kms:kme),prsl(its:ite,kts:kte),         &amp;<a name='239'>
                            prslk(ims:ime,kms:kme)<a name='240'>
   real                 ::  prsi(its:ite,kts:kte+1),del(its:ite,kts:kte)<a name='241'>
   real                 ::  oa4(its:ite,4),ol4(its:ite,4)<a name='242'>
<font color=#447700>!<a name='243'></font>
   integer              ::  kpbl(ims:ime)<a name='244'>
   real                 ::  var(ims:ime),oc1(ims:ime),                         &amp;<a name='245'>
                            dusfc(ims:ime),dvsfc(ims:ime)<a name='246'>
<font color=#447700>!<a name='247'></font>
<font color=#447700>! critical richardson number for wave breaking : ! larger drag with larger value<a name='248'></font>
<font color=#447700>!<a name='249'></font>
   real,parameter       ::  ric     = 0.25  <a name='250'>
<font color=#447700>!<a name='251'></font>
   real,parameter       ::  dw2min  = 1.<a name='252'>
   real,parameter       ::  rimin   = -100.<a name='253'>
   real,parameter       ::  bnv2min = 1.0e-5<a name='254'>
   real,parameter       ::  efmin   = 0.0<a name='255'>
   real,parameter       ::  efmax   = 10.0<a name='256'>
   real,parameter       ::  xl      = 4.0e4  <a name='257'>
   real,parameter       ::  critac  = 1.0e-5<a name='258'>
   real,parameter       ::  gmax    = 1.    <a name='259'>
   real,parameter       ::  veleps  = 1.0                                                 <a name='260'>
   real,parameter       ::  factop  = 0.5                                                  <a name='261'>
   real,parameter       ::  frc     = 1.0      <a name='262'>
   real,parameter       ::  ce      = 0.8     <a name='263'>
   real,parameter       ::  cg      = 0.5    <a name='264'>
   integer,parameter    ::  kpblmin = 2<a name='265'>
<font color=#447700>!<a name='266'></font>
<font color=#447700>!  local variables<a name='267'></font>
<font color=#447700>!<a name='268'></font>
   integer              ::  i,k,lcap,lcapp1,nwd,idir,                          &amp;<a name='269'>
                            klcap,kp1,ikount,kk<a name='270'>
<font color=#447700>!<a name='271'></font>
   real                 ::  rcs,rclcs,csg,fdir,cleff,cs,rcsks,                 &amp;<a name='272'>
                            wdir,ti,rdz,temp,tem2,dw2,shr2,bvf2,rdelks,        &amp;<a name='273'>
                            wtkbj,tem,gfobnv,hd,fro,rim,temc,tem1,efact,       &amp;<a name='274'>
                            temv,dtaux,dtauy<a name='275'>
<font color=#447700>!<a name='276'></font>
   logical              ::  ldrag(its:ite),icrilv(its:ite),                    &amp;<a name='277'>
                            flag(its:ite),kloop1(its:ite)<a name='278'>
<font color=#447700>!                                                                       <a name='279'></font>
   real                 ::  taub(its:ite),taup(its:ite,kts:kte+1),             &amp;<a name='280'>
                            xn(its:ite),yn(its:ite),                           &amp;<a name='281'>
                            ubar(its:ite),vbar(its:ite),                       &amp;<a name='282'>
                            fr(its:ite),ulow(its:ite),                         &amp;<a name='283'>
                            rulow(its:ite),bnv(its:ite),                       &amp;<a name='284'>
                            oa(its:ite),ol(its:ite),                           &amp;<a name='285'>
                            roll(its:ite),dtfac(its:ite),                      &amp;<a name='286'>
                            brvf(its:ite),xlinv(its:ite),                      &amp;<a name='287'>
                            delks(its:ite),delks1(its:ite),                    &amp;<a name='288'>
                            bnv2(its:ite,kts:kte),usqj(its:ite,kts:kte),       &amp;<a name='289'>
                            taud(its:ite,kts:kte),ro(its:ite,kts:kte),         &amp;<a name='290'>
                            vtk(its:ite,kts:kte),vtj(its:ite,kts:kte),         &amp;<a name='291'>
                            zlowtop(its:ite),velco(its:ite,kts:kte-1),         &amp;<a name='292'>
                            coefm(its:ite)<a name='293'>
<font color=#447700>!<a name='294'></font>
   integer              ::  kbl(its:ite),klowtop(its:ite)<a name='295'>
<font color=#447700>!<a name='296'></font>
   logical :: iope<a name='297'>
   integer,parameter    ::  mdir=8<a name='298'>
   integer              ::  nwdir(mdir)<a name='299'>
   data nwdir/6,7,5,8,2,3,1,4/<a name='300'>
<font color=#447700>!<a name='301'></font>
<font color=#447700>!  variables for flow-blocking drag<a name='302'></font>
<font color=#447700>!<a name='303'></font>
   real,parameter       :: frmax  = 10.<a name='304'>
   real,parameter       :: olmin  = 1.0e-5<a name='305'>
   real,parameter       :: odmin  = 0.1 <a name='306'>
   real,parameter       :: odmax  = 10. <a name='307'>
   real,parameter       :: erad   = 6371.315e+3<a name='308'>
   integer              :: komax(its:ite)<a name='309'>
   integer              :: kblk<a name='310'>
   real                 :: cd<a name='311'>
   real                 :: zblk,tautem<a name='312'>
   real                 :: pe,ke <a name='313'>
   real                 :: delx,dely,dxy4(4),dxy4p(4)<a name='314'>
   real                 :: dxy(its:ite),dxyp(its:ite)<a name='315'>
   real                 :: ol4p(4),olp(its:ite),od(its:ite)<a name='316'>
   real                 :: taufb(its:ite,kts:kte+1)<a name='317'>
<font color=#447700>!<a name='318'></font>
<font color=#447700>!---- constants                                                         <a name='319'></font>
<font color=#447700>!                                                                       <a name='320'></font>
   rcs    = sqrt(rcl)                                                   <a name='321'>
   cs     = 1. / sqrt(rcl)                                                     <a name='322'>
   csg    = cs * g                                                      <a name='323'>
   lcap   = kte                                                         <a name='324'>
   lcapp1 = lcap + 1                                                 <a name='325'>
   fdir   = mdir / (2.0*pi)<a name='326'>
<font color=#447700>!<a name='327'></font>
<font color=#447700>!--- calculate length of grid for flow-blocking drag<a name='328'></font>
<font color=#447700>!<a name='329'></font>
   delx   = dxmeter <a name='330'>
   dely   = dxmeter<a name='331'>
   dxy4(1)  = delx<a name='332'>
   dxy4(2)  = dely<a name='333'>
   dxy4(3)  = sqrt(delx*delx + dely*dely)<a name='334'>
   dxy4(4)  = dxy4(3)<a name='335'>
   dxy4p(1) = dxy4(2)<a name='336'>
   dxy4p(2) = dxy4(1)<a name='337'>
   dxy4p(3) = dxy4(4)<a name='338'>
   dxy4p(4) = dxy4(3)<a name='339'>
<font color=#447700>!<a name='340'></font>
<font color=#447700>!<a name='341'></font>
<font color=#447700>!-----initialize arrays                                                 <a name='342'></font>
<font color=#447700>!                                                                       <a name='343'></font>
   dtaux = 0.0<a name='344'>
   dtauy = 0.0<a name='345'>
   do i = its,ite                                                       <a name='346'>
     klowtop(i)    = 0<a name='347'>
     kbl(i)        = 0<a name='348'>
   enddo                                                             <a name='349'>
<font color=#447700>!<a name='350'></font>
   do i = its,ite                                                       <a name='351'>
     xn(i)         = 0.0<a name='352'>
     yn(i)         = 0.0<a name='353'>
     ubar (i)      = 0.0<a name='354'>
     vbar (i)      = 0.0<a name='355'>
     roll (i)      = 0.0<a name='356'>
     taub (i)      = 0.0<a name='357'>
     taup(i,1)     = 0.0<a name='358'>
     oa(i)         = 0.0<a name='359'>
     ol(i)         = 0.0<a name='360'>
     ulow (i)      = 0.0<a name='361'>
     dtfac(i)      = 1.0<a name='362'>
     ldrag(i)      = .false.<a name='363'>
     icrilv(i)     = .false. <a name='364'>
     flag(i)       = .true.<a name='365'>
   enddo                                                             <a name='366'>
<font color=#447700>!<a name='367'></font>
   do k = kts,kte<a name='368'>
     do i = its,ite<a name='369'>
       usqj(i,k) = 0.0<a name='370'>
       bnv2(i,k) = 0.0<a name='371'>
       vtj(i,k)  = 0.0<a name='372'>
       vtk(i,k)  = 0.0<a name='373'>
       taup(i,k) = 0.0<a name='374'>
       taud(i,k) = 0.0<a name='375'>
       dtaux2d(i,k)= 0.0<a name='376'>
       dtauy2d(i,k)= 0.0<a name='377'>
     enddo<a name='378'>
   enddo<a name='379'>
<font color=#447700>!<a name='380'></font>
   do i = its,ite<a name='381'>
     taup(i,kte+1) = 0.0<a name='382'>
     xlinv(i)     = 1.0/xl                                                   <a name='383'>
   enddo<a name='384'>
<font color=#447700>!<a name='385'></font>
<font color=#447700>!  initialize array for flow-blocking drag<a name='386'></font>
<font color=#447700>!<a name='387'></font>
   taufb(its:ite,kts:kte+1) = 0.0<a name='388'>
   komax(its:ite) = 0<a name='389'>
<font color=#447700>!<a name='390'></font>
   do k = kts,kte<a name='391'>
     do i = its,ite<a name='392'>
       vtj(i,k)  = t1(i,k)  * (1.+fv*q1(i,k))<a name='393'>
       vtk(i,k)  = vtj(i,k) / prslk(i,k)<a name='394'>
       ro(i,k)   = 1./rd * prsl(i,k) / vtj(i,k) <font color=#447700>! density kg/m**3<a name='395'></font>
     enddo<a name='396'>
   enddo<a name='397'>
<font color=#447700>!<a name='398'></font>
<font color=#447700>!  determine reference level: maximum of 2*var and pbl heights<a name='399'></font>
<font color=#447700>!<a name='400'></font>
   do i = its,ite<a name='401'>
     zlowtop(i) = 2. * var(i)<a name='402'>
   enddo<a name='403'>
<font color=#447700>!<a name='404'></font>
   do i = its,ite<a name='405'>
     kloop1(i) = .true.<a name='406'>
   enddo<a name='407'>
<font color=#447700>!<a name='408'></font>
   do k = kts+1,kte<a name='409'>
     do i = its,ite<a name='410'>
       if(kloop1(i).and.zl(i,k)-zl(i,1).ge.zlowtop(i)) then<a name='411'>
         klowtop(i) = k+1<a name='412'>
         kloop1(i)  = .false.<a name='413'>
       endif<a name='414'>
     enddo<a name='415'>
   enddo<a name='416'>
<font color=#447700>!<a name='417'></font>
   do i = its,ite<a name='418'>
     kbl(i)   = max(kpbl(i), klowtop(i))<a name='419'>
     kbl(i)   = max(min(kbl(i),kpblmax),kpblmin)<a name='420'>
   enddo<a name='421'>
<font color=#447700>!<a name='422'></font>
<font color=#447700>!  determine the level of maximum orographic height<a name='423'></font>
<font color=#447700>!<a name='424'></font>
   komax(:) = kbl(:)<a name='425'>
<font color=#447700>!<a name='426'></font>
   do i = its,ite<a name='427'>
     delks(i)  = 1.0 / (prsi(i,1) - prsi(i,kbl(i)))<a name='428'>
     delks1(i) = 1.0 / (prsl(i,1) - prsl(i,kbl(i)))<a name='429'>
   enddo<a name='430'>
<font color=#447700>!<a name='431'></font>
<font color=#447700>!  compute low level averages within pbl<a name='432'></font>
<font color=#447700>!<a name='433'></font>
   do k = kts,kpblmax<a name='434'>
     do i = its,ite<a name='435'>
       if (k.lt.kbl(i)) then<a name='436'>
         rcsks   = rcs     * del(i,k) * delks(i)<a name='437'>
         rdelks  = del(i,k)  * delks(i)<a name='438'>
         ubar(i) = ubar(i) + rcsks  * u1(i,k)      <font color=#447700>! pbl u  mean<a name='439'></font>
         vbar(i) = vbar(i) + rcsks  * v1(i,k)      <font color=#447700>! pbl v  mean<a name='440'></font>
         roll(i) = roll(i) + rdelks * ro(i,k)      <font color=#447700>! ro mean<a name='441'></font>
       endif<a name='442'>
     enddo<a name='443'>
   enddo<a name='444'>
<font color=#447700>!<a name='445'></font>
<font color=#447700>!     figure out low-level horizontal wind direction <a name='446'></font>
<font color=#447700>!<a name='447'></font>
<font color=#447700>!             nwd  1   2   3   4   5   6   7   8<a name='448'></font>
<font color=#447700>!              wd  w   s  sw  nw   e   n  ne  se<a name='449'></font>
<font color=#447700>!<a name='450'></font>
   do i = its,ite                                                       <a name='451'>
     wdir   = atan2(ubar(i),vbar(i)) + pi<a name='452'>
     idir   = mod(nint(fdir*wdir),mdir) + 1<a name='453'>
     nwd    = nwdir(idir)<a name='454'>
     oa(i)  = (1-2*int( (nwd-1)/4 )) * oa4(i,mod(nwd-1,4)+1)<a name='455'>
     ol(i) = ol4(i,mod(nwd-1,4)+1) <a name='456'>
<font color=#447700>!<a name='457'></font>
<font color=#447700>!----- compute orographic width along (ol) and perpendicular (olp)<a name='458'></font>
<font color=#447700>!----- the direction of wind<a name='459'></font>
<font color=#447700>!<a name='460'></font>
     ol4p(1) = ol4(i,2)<a name='461'>
     ol4p(2) = ol4(i,1)<a name='462'>
     ol4p(3) = ol4(i,4)<a name='463'>
     ol4p(4) = ol4(i,3)<a name='464'>
     olp(i)  = ol4p(mod(nwd-1,4)+1) <a name='465'>
<font color=#447700>!<a name='466'></font>
<font color=#447700>!----- compute orographic direction (horizontal orographic aspect ratio)<a name='467'></font>
<font color=#447700>!<a name='468'></font>
     od(i) = olp(i)/max(ol(i),olmin)<a name='469'>
     od(i) = min(od(i),odmax)<a name='470'>
     od(i) = max(od(i),odmin)<a name='471'>
<font color=#447700>!<a name='472'></font>
<font color=#447700>!----- compute length of grid in the along(dxy) and cross(dxyp) wind directions<a name='473'></font>
<font color=#447700>!<a name='474'></font>
     dxy(i)  = dxy4(MOD(nwd-1,4)+1)<a name='475'>
     dxyp(i) = dxy4p(MOD(nwd-1,4)+1)<a name='476'>
   enddo<a name='477'>
<font color=#447700>!                                                                       <a name='478'></font>
<font color=#447700>!---  saving richardson number in usqj for migwdi                       <a name='479'></font>
<font color=#447700>!<a name='480'></font>
   do k = kts,kte-1                                                     <a name='481'>
     do i = its,ite                                                     <a name='482'>
       ti        = 2.0 / (t1(i,k)+t1(i,k+1))                                <a name='483'>
       rdz       = 1./(zl(i,k+1) - zl(i,k))<a name='484'>
       tem1      = u1(i,k) - u1(i,k+1)<a name='485'>
       tem2      = v1(i,k) - v1(i,k+1)   <a name='486'>
       dw2       = rcl*(tem1*tem1 + tem2*tem2)<a name='487'>
       shr2      = max(dw2,dw2min) * rdz * rdz<a name='488'>
       bvf2      = g*(g/cp+rdz*(vtj(i,k+1)-vtj(i,k))) * ti                <a name='489'>
       usqj(i,k) = max(bvf2/shr2,rimin)                            <a name='490'>
       bnv2(i,k) = 2.0*g*rdz*(vtk(i,k+1)-vtk(i,k))/(vtk(i,k+1)+vtk(i,k))<a name='491'>
       bnv2(i,k) = max( bnv2(i,k), bnv2min )<a name='492'>
     enddo                                                          <a name='493'>
   enddo                                                             <a name='494'>
<font color=#447700>!<a name='495'></font>
<font color=#447700>!----compute the "low level" or 1/3 wind magnitude (m/s)                <a name='496'></font>
<font color=#447700>!                                                                       <a name='497'></font>
   do i = its,ite                                                       <a name='498'>
     ulow(i) = max(sqrt(ubar(i)*ubar(i) + vbar(i)*vbar(i)), 1.0)<a name='499'>
     rulow(i) = 1./ulow(i)<a name='500'>
   enddo                                                             <a name='501'>
<font color=#447700>!<a name='502'></font>
   do k = kts,kte-1                                                    <a name='503'>
     do i = its,ite                                                   <a name='504'>
       velco(i,k)  = (0.5*rcs) * ((u1(i,k)+u1(i,k+1)) * ubar(i)                &amp;<a name='505'>
                                + (v1(i,k)+v1(i,k+1)) * vbar(i))                 <a name='506'>
       velco(i,k)  = velco(i,k) * rulow(i)                               <a name='507'>
       if ((velco(i,k).lt.veleps) .and. (velco(i,k).gt.0.)) then<a name='508'>
         velco(i,k) = veleps                                      <a name='509'>
       endif<a name='510'>
     enddo                                                          <a name='511'>
   enddo                                                             <a name='512'>
<font color=#447700>!                                                                       <a name='513'></font>
<font color=#447700>!  no drag when critical level in the base layer                        <a name='514'></font>
<font color=#447700>!                                                                       <a name='515'></font>
   do i = its,ite                                                       <a name='516'>
     ldrag(i) = velco(i,1).le.0.                                    <a name='517'>
   enddo                                                             <a name='518'>
<font color=#447700>!<a name='519'></font>
<font color=#447700>!  no drag when velco.lt.0                                               <a name='520'></font>
<font color=#447700>!                                                                       <a name='521'></font>
   do k = kpblmin,kpblmax<a name='522'>
     do i = its,ite                                                    <a name='523'>
       if (k .lt. kbl(i)) ldrag(i) = ldrag(i).or. velco(i,k).le.0.<a name='524'>
     enddo                                                          <a name='525'>
   enddo                                                             <a name='526'>
<font color=#447700>!                                                                       <a name='527'></font>
<font color=#447700>!  no drag when bnv2.lt.0                                               <a name='528'></font>
<font color=#447700>!                                                                       <a name='529'></font>
   do k = kts,kpblmax<a name='530'>
     do i = its,ite                                                    <a name='531'>
       if (k .lt. kbl(i)) ldrag(i) = ldrag(i).or. bnv2(i,k).lt.0.<a name='532'>
     enddo                                                          <a name='533'>
   enddo                                                             <a name='534'>
<font color=#447700>!                                                                       <a name='535'></font>
<font color=#447700>!-----the low level weighted average ri is stored in usqj(1,1; im)      <a name='536'></font>
<font color=#447700>!-----the low level weighted average n**2 is stored in bnv2(1,1; im)    <a name='537'></font>
<font color=#447700>!---- this is called bnvl2 in phys_gwd_alpert_sub not bnv2                           <a name='538'></font>
<font color=#447700>!---- rdelks (del(k)/delks) vert ave factor so we can * instead of /    <a name='539'></font>
<font color=#447700>!                                                                       <a name='540'></font>
   do i = its,ite                                                       <a name='541'>
     wtkbj     = (prsl(i,1)-prsl(i,2)) * delks1(i)<a name='542'>
     bnv2(i,1) = wtkbj * bnv2(i,1)                                <a name='543'>
     usqj(i,1) = wtkbj * usqj(i,1)                                <a name='544'>
   enddo                                                             <a name='545'>
<font color=#447700>!<a name='546'></font>
   do k = kpblmin,kpblmax                                                <a name='547'>
     do i = its,ite                                                    <a name='548'>
       if (k .lt. kbl(i)) then<a name='549'>
         rdelks    = (prsl(i,k)-prsl(i,k+1)) * delks1(i)<a name='550'>
         bnv2(i,1) = bnv2(i,1) + bnv2(i,k) * rdelks<a name='551'>
         usqj(i,1) = usqj(i,1) + usqj(i,k) * rdelks<a name='552'>
       endif<a name='553'>
     enddo                                                          <a name='554'>
   enddo                                                             <a name='555'>
<font color=#447700>!                                                                       <a name='556'></font>
   do i = its,ite                                                       <a name='557'>
     ldrag(i) = ldrag(i) .or. bnv2(i,1).le.0.0                         <a name='558'>
     ldrag(i) = ldrag(i) .or. ulow(i).eq.1.0                           <a name='559'>
     ldrag(i) = ldrag(i) .or. var(i) .le. 0.0<a name='560'>
   enddo                                                             <a name='561'>
<font color=#447700>!                                                                       <a name='562'></font>
<font color=#447700>!  set all ri low level values to the low level value          <a name='563'></font>
<font color=#447700>!                                                                       <a name='564'></font>
   do k = kpblmin,kpblmax<a name='565'>
     do i = its,ite                                                    <a name='566'>
       if (k .lt. kbl(i)) usqj(i,k) = usqj(i,1)<a name='567'>
     enddo                                                          <a name='568'>
   enddo                                                             <a name='569'>
<font color=#447700>!<a name='570'></font>
   do i = its,ite <a name='571'>
     if (.not.ldrag(i))   then   <a name='572'>
       bnv(i) = sqrt( bnv2(i,1) )                                  <a name='573'>
       fr(i) = bnv(i)  * rulow(i) * 2. * var(i) * od(i)<a name='574'>
       fr(i) = min(fr(i),frmax)<a name='575'>
       xn(i)  = ubar(i) * rulow(i)<a name='576'>
       yn(i)  = vbar(i) * rulow(i)<a name='577'>
     endif<a name='578'>
   enddo<a name='579'>
<font color=#447700>!<a name='580'></font>
<font color=#447700>!  compute the base level stress and store it in taub<a name='581'></font>
<font color=#447700>!  calculate enhancement factor, number of mountains &amp; aspect        <a name='582'></font>
<font color=#447700>!  ratio const. use simplified relationship between standard            <a name='583'></font>
<font color=#447700>!  deviation &amp; critical hgt                                          <a name='584'></font>
<font color=#447700>!<a name='585'></font>
   do i = its,ite                                                       <a name='586'>
     if (.not. ldrag(i))   then   <a name='587'>
       efact    = (oa(i) + 2.) ** (ce*fr(i)/frc)                         <a name='588'>
       efact    = min( max(efact,efmin), efmax )                            <a name='589'>
<font color=#447700>!!!!!!! cleff (effective grid length) is highly tunable parameter<a name='590'></font>
<font color=#447700>!!!!!!! the bigger (smaller) value produce weaker (stronger) wave drag<a name='591'></font>
       cleff    = sqrt(dxy(i)**2. + dxyp(i)**2.)<a name='592'>
       cleff    = 3. * max(dxmeter,cleff)<a name='593'>
       coefm(i) = (1. + ol(i)) ** (oa(i)+1.)                   <a name='594'>
       xlinv(i) = coefm(i) / cleff                                             <a name='595'>
       tem      = fr(i) * fr(i) * oc1(i)<a name='596'>
       gfobnv   = gmax * tem / ((tem + cg)*bnv(i))   <a name='597'>
       taub(i)  = xlinv(i) * roll(i) * ulow(i) * ulow(i)                       &amp;<a name='598'>
                * ulow(i) * gfobnv * efact          <a name='599'>
     else                                                          <a name='600'>
       taub(i) = 0.0                                             <a name='601'>
       xn(i)   = 0.0                                             <a name='602'>
       yn(i)   = 0.0                                             <a name='603'>
     endif                                                         <a name='604'>
   enddo                                                             <a name='605'>
<font color=#447700>!                                                                       <a name='606'></font>
<font color=#447700>!   now compute vertical structure of the stress.<a name='607'></font>
<font color=#447700>!<a name='608'></font>
   do k = kts,kpblmax<a name='609'>
     do i = its,ite<a name='610'>
       if (k .le. kbl(i)) taup(i,k) = taub(i)<a name='611'>
     enddo<a name='612'>
   enddo<a name='613'>
<font color=#447700>!<a name='614'></font>
   do k = kpblmin, kte-1                   <font color=#447700>! vertical level k loop!<a name='615'></font>
     kp1 = k + 1<a name='616'>
     do i = its,ite<a name='617'>
<font color=#447700>!<a name='618'></font>
<font color=#447700>!   unstablelayer if ri &lt; ric<a name='619'></font>
<font color=#447700>!   unstable layer if upper air vel comp along surf vel &lt;=0 (crit lay)<a name='620'></font>
<font color=#447700>!   at (u-c)=0. crit layer exists and bit vector should be set (.le.)<a name='621'></font>
<font color=#447700>!<a name='622'></font>
       if (k .ge. kbl(i)) then<a name='623'>
         icrilv(i) = icrilv(i) .or. ( usqj(i,k) .lt. ric)                      &amp;<a name='624'>
                               .or. (velco(i,k) .le. 0.0)<a name='625'>
         brvf(i)  = max(bnv2(i,k),bnv2min) <font color=#447700>! brunt-vaisala frequency squared<a name='626'></font>
         brvf(i)  = sqrt(brvf(i))          <font color=#447700>! brunt-vaisala frequency<a name='627'></font>
       endif<a name='628'>
     enddo<a name='629'>
<font color=#447700>!<a name='630'></font>
     do i = its,ite<a name='631'>
       if (k .ge. kbl(i) .and. (.not. ldrag(i)))   then   <a name='632'>
         if (.not.icrilv(i) .and. taup(i,k) .gt. 0.0 ) then<a name='633'>
           temv = 1.0 / velco(i,k)<a name='634'>
           tem1 = coefm(i)/dxy(i)*(ro(i,kp1)+ro(i,k))*brvf(i)*velco(i,k)*0.5<a name='635'>
           hd   = sqrt(taup(i,k) / tem1)<a name='636'>
           fro  = brvf(i) * hd * temv<a name='637'>
<font color=#447700>!<a name='638'></font>
<font color=#447700>!  rim is the  minimum-richardson number by shutts (1985)<a name='639'></font>
<font color=#447700>!<a name='640'></font>
           tem2   = sqrt(usqj(i,k))<a name='641'>
           tem    = 1. + tem2 * fro<a name='642'>
           rim    = usqj(i,k) * (1.-fro) / (tem * tem)<a name='643'>
<font color=#447700>!<a name='644'></font>
<font color=#447700>!  check stability to employ the 'saturation hypothesis'<a name='645'></font>
<font color=#447700>!  of lindzen (1981) except at tropospheric downstream regions<a name='646'></font>
<font color=#447700>!<a name='647'></font>
           if (rim .le. ric) then  <font color=#447700>! saturation hypothesis!<a name='648'></font>
             if ((oa(i) .le. 0.).or.(kp1 .ge. kpblmin )) then<a name='649'>
               temc = 2.0 + 1.0 / tem2<a name='650'>
               hd   = velco(i,k) * (2.*sqrt(temc)-temc) / brvf(i)<a name='651'>
               taup(i,kp1) = tem1 * hd * hd<a name='652'>
             endif<a name='653'>
           else                    <font color=#447700>! no wavebreaking!<a name='654'></font>
             taup(i,kp1) = taup(i,k)<a name='655'>
           endif<a name='656'>
         endif<a name='657'>
       endif<a name='658'>
     enddo      <a name='659'>
   enddo<a name='660'>
<font color=#447700>!<a name='661'></font>
   if(lcap.lt.kte) then                                               <a name='662'>
     do klcap = lcapp1,kte                                          <a name='663'>
       do i = its,ite                                                 <a name='664'>
         taup(i,klcap) = prsi(i,klcap) / prsi(i,lcap) * taup(i,lcap)      <a name='665'>
       enddo                                                       <a name='666'>
     enddo                                                          <a name='667'>
   endif                                                             <a name='668'>
   do i = its,ite<a name='669'>
     if(.not.ldrag(i)) then<a name='670'>
<font color=#447700>!<a name='671'></font>
<font color=#447700>!------- determine the height of flow-blocking layer<a name='672'></font>
<font color=#447700>!<a name='673'></font>
        kblk = 0<a name='674'>
        pe = 0.0<a name='675'>
        do k = kte, kpblmin, -1<a name='676'>
          if(kblk.eq.0 .and. k.le.komax(i)) then<a name='677'>
            pe = pe + bnv2(i,k)*(zl(i,komax(i))-zl(i,k))*del(i,k)/g/ro(i,k)<a name='678'>
            ke = 0.5*((rcs*u1(i,k))**2.+(rcs*v1(i,k))**2.)<a name='679'>
<font color=#447700>!<a name='680'></font>
<font color=#447700>!---------- apply flow-blocking drag when pe &gt;= ke <a name='681'></font>
<font color=#447700>!<a name='682'></font>
            if(pe.ge.ke) then<a name='683'>
              kblk = k<a name='684'>
              kblk = min(kblk,kbl(i))<a name='685'>
              zblk = zl(i,kblk)-zl(i,kts)<a name='686'>
            endif<a name='687'>
          endif<a name='688'>
        enddo<a name='689'>
        if(kblk.ne.0) then<a name='690'>
<font color=#447700>!<a name='691'></font>
<font color=#447700>!--------- compute flow-blocking stress<a name='692'></font>
<font color=#447700>!<a name='693'></font>
          cd = max(2.0-1.0/od(i),0.0)<a name='694'>
          taufb(i,kts) = 0.5 * roll(i) * coefm(i) / dxy(i)**2 * cd * dxyp(i)   &amp;<a name='695'>
                         * olp(i) * zblk * ulow(i)**2<a name='696'>
          tautem = taufb(i,kts)/float(kblk-kts)<a name='697'>
          do k = kts+1, kblk<a name='698'>
            taufb(i,k) = taufb(i,k-1) - tautem<a name='699'>
          enddo<a name='700'>
<font color=#447700>!<a name='701'></font>
<font color=#447700>!----------sum orographic GW stress and flow-blocking stress<a name='702'></font>
<font color=#447700>!<a name='703'></font>
          taup(i,:) = taup(i,:) + taufb(i,:)<a name='704'>
        endif<a name='705'>
     endif<a name='706'>
   enddo <a name='707'>
<font color=#447700>!                                                                       <a name='708'></font>
<font color=#447700>!  calculate - (g)*d(tau)/d(pressure) and deceleration terms dtaux, dtauy<a name='709'></font>
<font color=#447700>!<a name='710'></font>
   do k = kts,kte                                                       <a name='711'>
     do i = its,ite                                                       <a name='712'>
       taud(i,k) = 1. * (taup(i,k+1) - taup(i,k)) * csg / del(i,k)<a name='713'>
     enddo                                                             <a name='714'>
   enddo                                                             <a name='715'>
<font color=#447700>!                                                                       <a name='716'></font>
<font color=#447700>!  limit de-acceleration (momentum deposition ) at top to 1/2 value <a name='717'></font>
<font color=#447700>!  the idea is some stuff must go out the 'top'                     <a name='718'></font>
<font color=#447700>!                                                                       <a name='719'></font>
   do klcap = lcap,kte                                               <a name='720'>
     do i = its,ite                                                    <a name='721'>
       taud(i,klcap) = taud(i,klcap) * factop<a name='722'>
     enddo                                                          <a name='723'>
   enddo                                                             <a name='724'>
<font color=#447700>!                                                                       <a name='725'></font>
<font color=#447700>!  if the gravity wave drag would force a critical line             <a name='726'></font>
<font color=#447700>!  in the lower ksmm1 layers during the next deltim timestep,     <a name='727'></font>
<font color=#447700>!  then only apply drag until that critical line is reached.        <a name='728'></font>
<font color=#447700>!                                                                       <a name='729'></font>
   do k = kts,kpblmax-1                                                    <a name='730'>
     do i = its,ite                                                    <a name='731'>
       if (k .le. kbl(i)) then<a name='732'>
         if(taud(i,k).ne.0.)                                                   &amp;<a name='733'>
         dtfac(i) = min(dtfac(i),abs(velco(i,k)                                &amp;<a name='734'>
                   /(deltim*rcs*taud(i,k))))<a name='735'>
       endif<a name='736'>
     enddo                                                          <a name='737'>
   enddo                                                             <a name='738'>
<font color=#447700>!<a name='739'></font>
   do i = its,ite<a name='740'>
     dusfc(i) = 0.<a name='741'>
     dvsfc(i) = 0.<a name='742'>
   enddo<a name='743'>
<font color=#447700>!<a name='744'></font>
   do k = kts,kte                                                       <a name='745'>
     do i = its,ite <a name='746'>
       taud(i,k)  = taud(i,k) * dtfac(i)                              <a name='747'>
       dtaux = taud(i,k) * xn(i)<a name='748'>
       dtauy = taud(i,k) * yn(i)<a name='749'>
       dtaux2d(i,k) = dtaux<a name='750'>
       dtauy2d(i,k) = dtauy<a name='751'>
       dudt(i,k)  = dtaux + dudt(i,k)<a name='752'>
       dvdt(i,k)  = dtauy + dvdt(i,k)<a name='753'>
       dusfc(i)   = dusfc(i) + dtaux * del(i,k)<a name='754'>
       dvsfc(i)   = dvsfc(i) + dtauy * del(i,k)<a name='755'>
     enddo                                                          <a name='756'>
   enddo                                                             <a name='757'>
<font color=#447700>!<a name='758'></font>
   do i = its,ite<a name='759'>
     dusfc(i) = (-1./g*rcs) * dusfc(i)<a name='760'>
     dvsfc(i) = (-1./g*rcs) * dvsfc(i)<a name='761'>
   enddo<a name='762'>
<font color=#447700>!<a name='763'></font>
   return                                                            <a name='764'>
   end subroutine gwdo2d<a name='765'>
<font color=#447700>!-------------------------------------------------------------------<a name='766'></font>
end module module_bl_gwdo<a name='767'>
</pre></body></html>