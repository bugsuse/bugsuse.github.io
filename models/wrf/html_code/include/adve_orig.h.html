<HTML> <BODY BGCOLOR=#ccccdd LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A href='../../html_code/include/adve_orig.h.html' TARGET='top_target'><IMG SRC="../../gif/bar_grey.gif" border=0></A><a name='adve_orig.h'><a name='2'>
<font color=#993300>include file: </font><font color=#cc0000>adve_orig.h</font><a name='3'>
<font color=#447700>!*********************************************************************** <a name='4'></font>
<A NAME='ADVE'><A href='../../html_code/include/adve_orig.h.html#ADVE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>ADVE</font>(NTSD,DT,DETA1,DETA2,PDTOP                         &amp; <A href='../../call_to/ADVE.html' TARGET='index'>1</A>,<A href='../../call_from/ADVE.html' TARGET='index'>2</A><a name='6'>
     &amp;               ,CURV,F,FAD,F4D,EM_LOC,EMT_LOC,EN,ENT,DX,DY        &amp;<a name='7'>
     &amp;               ,HTM,HBM2,VTM,VBM2,LMH,LMV                         &amp;<a name='8'>
     &amp;               ,T,U,V,PDSLO,TOLD,UOLD,VOLD                        &amp;<a name='9'>
     &amp;               ,PETDT,UPSTRM                                      &amp;<a name='10'>
     &amp;               ,FEW,FNS,FNE,FSE                                   &amp;<a name='11'>
     &amp;               ,ADT,ADU,ADV                                       &amp;<a name='12'>
     &amp;               ,N_IUP_H,N_IUP_V                                   &amp;<a name='13'>
     &amp;               ,N_IUP_ADH,N_IUP_ADV                               &amp;<a name='14'>
     &amp;               ,IUP_H,IUP_V,IUP_ADH,IUP_ADV                       &amp;<a name='15'>
     &amp;               ,IHE,IHW,IVE,IVW,INDX3_WRK                         &amp;<a name='16'>
     &amp;               ,IDS,IDE,JDS,JDE,KDS,KDE                           &amp;<a name='17'>
     &amp;               ,IMS,IME,JMS,JME,KMS,KME                           &amp;<a name='18'>
     &amp;               ,ITS,ITE,JTS,JTE,KTS,KTE)<a name='19'>
<font color=#447700>!***********************************************************************<a name='20'></font>
<font color=#447700>!$$$  SUBPROGRAM DOCUMENTATION BLOCK<a name='21'></font>
<font color=#447700>!                .      .    .     <a name='22'></font>
<font color=#447700>! SUBPROGRAM:    ADVE        HORIZONTAL AND VERTICAL ADVECTION<a name='23'></font>
<font color=#447700>!   PRGRMMR: JANJIC          ORG: W/NP22     DATE: 93-10-28       <a name='24'></font>
<font color=#447700>!     <a name='25'></font>
<font color=#447700>! ABSTRACT:<a name='26'></font>
<font color=#447700>!     ADVE CALCULATES THE CONTRIBUTION OF THE HORIZONTAL AND VERTICAL<a name='27'></font>
<font color=#447700>!     ADVECTION TO THE TENDENCIES OF TEMPERATURE AND WIND AND THEN<a name='28'></font>
<font color=#447700>!     UPDATES THOSE VARIABLES.<a name='29'></font>
<font color=#447700>!     THE JANJIC ADVECTION SCHEME FOR THE ARAKAWA E GRID IS USED<a name='30'></font>
<font color=#447700>!     FOR ALL VARIABLES INSIDE THE FIFTH ROW.  AN UPSTREAM SCHEME<a name='31'></font>
<font color=#447700>!     IS USED ON ALL VARIABLES IN THE THIRD, FOURTH, AND FIFTH<a name='32'></font>
<font color=#447700>!     OUTERMOST ROWS.  THE ADAMS-BASHFORTH TIME SCHEME IS USED.<a name='33'></font>
<font color=#447700>!     <a name='34'></font>
<font color=#447700>! PROGRAM HISTORY LOG:<a name='35'></font>
<font color=#447700>!   87-06-??  JANJIC     - ORIGINATOR<a name='36'></font>
<font color=#447700>!   95-03-25  BLACK      - CONVERSION FROM 1-D TO 2-D IN HORIZONTAL<a name='37'></font>
<font color=#447700>!   96-03-28  BLACK      - ADDED EXTERNAL EDGE<a name='38'></font>
<font color=#447700>!   98-10-30  BLACK      - MODIFIED FOR DISTRIBUTED MEMORY<a name='39'></font>
<font color=#447700>!   99-07-    JANJIC     - CONVERTED TO ADAMS-BASHFORTH SCHEME<a name='40'></font>
<font color=#447700>!                          COMBINING HORIZONTAL AND VERTICAL ADVECTION<a name='41'></font>
<font color=#447700>!   02-02-04  BLACK      - ADDED VERTICAL CFL CHECK<a name='42'></font>
<font color=#447700>!   02-02-05  BLACK      - CONVERTED TO WRF FORMAT<a name='43'></font>
<font color=#447700>!   02-08-29  MICHALAKES - CONDITIONAL COMPILATION OF MPI<a name='44'></font>
<font color=#447700>!                          CONVERT TO GLOBAL INDEXING<a name='45'></font>
<font color=#447700>!   02-09-06  WOLFE      - MORE CONVERSION TO GLOBAL INDEXING<a name='46'></font>
<font color=#447700>!   04-05-29  JANJIC,BLACK - CRANK-NICHOLSON VERTICAL ADVECTION<a name='47'></font>
<font color=#447700>!     <a name='48'></font>
<font color=#447700>! USAGE: CALL ADVE FROM SUBROUTINE SOLVE_RUNSTREAM<a name='49'></font>
<font color=#447700>!   INPUT ARGUMENT LIST:<a name='50'></font>
<font color=#447700>!  <a name='51'></font>
<font color=#447700>!   OUTPUT ARGUMENT LIST: <a name='52'></font>
<font color=#447700>!     <a name='53'></font>
<font color=#447700>!   OUTPUT FILES:<a name='54'></font>
<font color=#447700>!     NONE<a name='55'></font>
<font color=#447700>!     <a name='56'></font>
<font color=#447700>!   SUBPROGRAMS CALLED:<a name='57'></font>
<font color=#447700>!  <a name='58'></font>
<font color=#447700>!     UNIQUE: NONE<a name='59'></font>
<font color=#447700>!  <a name='60'></font>
<font color=#447700>!     LIBRARY: NONE<a name='61'></font>
<font color=#447700>!  <a name='62'></font>
<font color=#447700>! ATTRIBUTES:<a name='63'></font>
<font color=#447700>!   LANGUAGE: FORTRAN 90<a name='64'></font>
<font color=#447700>!   MACHINE : IBM SP<a name='65'></font>
<font color=#447700>!$$$  <a name='66'></font>
<font color=#447700>!***********************************************************************<a name='67'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='68'></font>
<font color=#447700>!<a name='69'></font>
      IMPLICIT NONE<a name='70'>
<font color=#447700>!<a name='71'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='72'></font>
<font color=#447700>!<a name='73'></font>
      INTEGER,INTENT(IN) :: IDS,IDE,JDS,JDE,KDS,KDE                     &amp;<a name='74'>
     &amp;                     ,IMS,IME,JMS,JME,KMS,KME                     &amp;<a name='75'>
     &amp;                     ,ITS,ITE,JTS,JTE,KTS,KTE<a name='76'>
<font color=#447700>!<a name='77'></font>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: IHE,IHW,IVE,IVW<a name='78'>
      INTEGER,DIMENSION(JMS:JME),INTENT(IN) :: N_IUP_H,N_IUP_V          &amp;<a name='79'>
     &amp;                                        ,N_IUP_ADH,N_IUP_ADV<a name='80'>
      INTEGER,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: IUP_H,IUP_V      &amp;<a name='81'>
     &amp;                                                ,IUP_ADH,IUP_ADV  &amp;<a name='82'>
     &amp;                                                ,LMH,LMV<a name='83'>
<font color=#447700>!<a name='84'></font>
<font color=#447700>!***  NMM_MAX_DIM is set in configure.wrf and must agree with<a name='85'></font>
<font color=#447700>!***  the value of dimspec q in the Registry/Registry<a name='86'></font>
<font color=#447700>!<a name='87'></font>
      INTEGER,DIMENSION(-3:3,NMM_MAX_DIM,0:6),INTENT(IN) :: INDX3_WRK<a name='88'>
<font color=#447700>!<a name='89'></font>
      INTEGER,INTENT(IN) :: NTSD<a name='90'>
<font color=#447700>!<a name='91'></font>
      REAL,INTENT(IN) :: DT,DY,EN,ENT,F4D,PDTOP<a name='92'>
<font color=#447700>!<a name='93'></font>
      REAL,DIMENSION(NMM_MAX_DIM),INTENT(IN) :: EM_LOC,EMT_LOC<a name='94'>
<font color=#447700>!<a name='95'></font>
      REAL,DIMENSION(KMS:KME),INTENT(IN) :: DETA1,DETA2<a name='96'>
<font color=#447700>!<a name='97'></font>
      REAL,DIMENSION(IMS:IME,JMS:JME),INTENT(IN) :: CURV,DX,F,FAD,HBM2  &amp;<a name='98'>
     &amp;                                             ,PDSLO,VBM2<a name='99'>
<font color=#447700>!<a name='100'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: PETDT<a name='101'>
<font color=#447700>!<a name='102'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(IN) :: HTM,VTM<a name='103'>
<font color=#447700>!<a name='104'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(INOUT) :: T,TOLD   &amp;<a name='105'>
     &amp;                                                        ,U,UOLD   &amp;<a name='106'>
     &amp;                                                        ,V,VOLD<a name='107'>
<font color=#447700>!<a name='108'></font>
      REAL,DIMENSION(IMS:IME,KMS:KME,JMS:JME),INTENT(OUT) :: ADT,ADU    &amp;<a name='109'>
     &amp;                                                      ,ADV        &amp;<a name='110'>
     &amp;                                                      ,FEW,FNE    &amp;<a name='111'>
     &amp;                                                      ,FNS,FSE<a name='112'>
<font color=#447700>!<a name='113'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='114'></font>
<font color=#447700>!<a name='115'></font>
<font color=#447700>!***  LOCAL VARIABLES<a name='116'></font>
<font color=#447700>!<a name='117'></font>
      LOGICAL :: UPSTRM<a name='118'>
<font color=#447700>!<a name='119'></font>
      INTEGER :: I,IEND,IFP,IFQ,II,IPQ,ISP,ISQ,ISTART                   &amp;<a name='120'>
     &amp;          ,IUP_ADH_J,IVH,IVL                                      &amp;<a name='121'>
     &amp;          ,J,J1,JA,JAK,JEND,JGLOBAL,JJ,JKNT,JP2,JSTART            &amp;<a name='122'>
     &amp;          ,K,KNTI_ADH,KSTART,KSTOP,LMHK,LMVK                      &amp;<a name='123'>
     &amp;          ,N,N_IUPH_J,N_IUPADH_J,N_IUPADV_J<a name='124'>
<font color=#447700>!<a name='125'></font>
      INTEGER :: MY_IS_GLB,MY_IE_GLB,MY_JS_GLB,MY_JE_GLB<a name='126'>
<font color=#447700>!<a name='127'></font>
      INTEGER :: J0_P3,J0_P2,J0_P1,J0_00,J0_M1,J1_P2,J1_P1,J1_00,J1_M1  &amp;<a name='128'>
     &amp;          ,J2_P1,J2_00,J2_M1,J3_P2,J3_P1,J3_00                    &amp;<a name='129'>
     &amp;          ,J4_P1,J4_00,J4_M1,J5_00,J5_M1,J6_P1,J6_00<a name='130'>
<font color=#447700>!<a name='131'></font>
      INTEGER,DIMENSION(ITS-5:ITE+5,KTS:KTE) :: ISPA,ISQA<a name='132'>
<font color=#447700>!<a name='133'></font>
      REAL :: ARRAY3_X,CFT,CFU,CFV,CMT,CMU,CMV                          &amp;<a name='134'>
     &amp;       ,DPDE_P3,DTE,DTQ                                           &amp;<a name='135'>
     &amp;       ,F0,F1,F2,F3,FEW_00,FEW_P1,FNE_X,FNS_P1,FNS_X,FPP,FSE_X    &amp;<a name='136'>
     &amp;       ,HM,PDOP,PDOPU,PDOPV,PP                                    &amp;<a name='137'>
     &amp;       ,PVVLO,PVVLOU,PVVLOV,PVVUP,PVVUPU,PVVUPV                   &amp;<a name='138'>
     &amp;       ,QP,RDP,RDPD,RDPDX,RDPDY,RDPU,RDPV                         &amp;<a name='139'>
     &amp;       ,T_UP,TEMPA,TEMPB,TTA,TTB,U_UP,UDY_P1,UDY_X                &amp;<a name='140'>
     &amp;       ,VXD_X,VDX_P2,V_UP,VDX_X,VM,VTA,VUA,VVA                    &amp;<a name='141'>
     &amp;       ,VVLO,VVLOU,VVLOV,VVUP,VVUPU,VVUPV<a name='142'>
<font color=#447700>!<a name='143'></font>
      REAL,DIMENSION(ITS-5:ITE+5,KTS:KTE) :: ARRAY0,ARRAY1              &amp;<a name='144'>
     &amp;                                      ,ARRAY2,ARRAY3              &amp;<a name='145'>
     &amp;                                      ,VAD_TEND_T,VAD_TEND_U      &amp;<a name='146'>
     &amp;                                      ,VAD_TEND_V<a name='147'>
<font color=#447700>!<a name='148'></font>
      REAL,DIMENSION(ITS-5:ITE+5,KTS:KTE) :: TEW,UEW,VEW<a name='149'>
<font color=#447700>!<a name='150'></font>
      REAL,DIMENSION(KTS:KTE) :: CRT,CRU,CRV,DETA1_PDTOP                &amp;<a name='151'>
     &amp;                          ,RCMT,RCMU,RCMV,RSTT,RSTU,RSTV,TN,UN    &amp;<a name='152'>
     &amp;                          ,VAD_TNDX_T,VAD_TNDX_U,VAD_TNDX_V,VN<a name='153'>
<font color=#447700>!<a name='154'></font>
      REAL,DIMENSION(ITS-5:ITE+5,-1:1) :: PETDTK<a name='155'>
<font color=#447700>!<a name='156'></font>
      REAL,DIMENSION(ITS-5:ITE+5) :: TDN,UDN,VDN<a name='157'>
<font color=#447700>!<a name='158'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='159'></font>
<font color=#447700>!<a name='160'></font>
<font color=#447700>!***  TYPE 0 WORKING ARRAY<a name='161'></font>
<font color=#447700>!<a name='162'></font>
      REAL,DIMENSION(ITS-5:ITE+5,KMS:KME,-3:3) :: DPDE<a name='163'>
<font color=#447700>!<a name='164'></font>
<font color=#447700>!***  TYPE 1 WORKING ARRAY<a name='165'></font>
<font color=#447700>!<a name='166'></font>
      REAL,DIMENSION(ITS-5:ITE+5,KMS:KME,-2:2) :: TST,UDY,UST,VDX,VST<a name='167'>
<font color=#447700>!<a name='168'></font>
<font color=#447700>!***  TYPE 4 WORKING ARRAY<a name='169'></font>
<font color=#447700>!<a name='170'></font>
      REAL,DIMENSION(ITS-5:ITE+5,KMS:KME,-1:1) :: TNS,UNS,VNS<a name='171'>
<font color=#447700>!<a name='172'></font>
<font color=#447700>!***  TYPE 5 WORKING ARRAY<a name='173'></font>
<font color=#447700>!<a name='174'></font>
      REAL,DIMENSION(ITS-5:ITE+5,KMS:KME,-1:0) :: TNE,UNE,VNE<a name='175'>
<font color=#447700>!<a name='176'></font>
<font color=#447700>!***  TYPE 6 WORKING ARRAY<a name='177'></font>
<font color=#447700>!<a name='178'></font>
      REAL,DIMENSION(ITS-5:ITE+5,KMS:KME, 0:1) :: TSE,USE,VSE<a name='179'>
<font color=#447700>!-----------------------------------------------------------------------<a name='180'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='181'></font>
<font color=#447700>!***********************************************************************<a name='182'></font>
<font color=#447700>!<a name='183'></font>
<font color=#447700>!                         DPDE      -----  3<a name='184'></font>
<font color=#447700>!                          |                      J Increasing<a name='185'></font>
<font color=#447700>!                          |                        <a name='186'></font>
<font color=#447700>!                          |                            ^<a name='187'></font>
<font color=#447700>!                         FNS       -----  2            |<a name='188'></font>
<font color=#447700>!                          |                            |<a name='189'></font>
<font color=#447700>!                          |                            |<a name='190'></font>
<font color=#447700>!                          |                            |<a name='191'></font>
<font color=#447700>!                         VNS       -----  1            |<a name='192'></font>
<font color=#447700>!                          |<a name='193'></font>
<font color=#447700>!                          |<a name='194'></font>
<font color=#447700>!                          |<a name='195'></font>
<font color=#447700>!                         ADV       -----  0  ------&gt; Current J<a name='196'></font>
<font color=#447700>!                          |<a name='197'></font>
<font color=#447700>!                          |<a name='198'></font>
<font color=#447700>!                          |<a name='199'></font>
<font color=#447700>!                         VNS       ----- -1<a name='200'></font>
<font color=#447700>!                          |<a name='201'></font>
<font color=#447700>!                          |<a name='202'></font>
<font color=#447700>!                          |<a name='203'></font>
<font color=#447700>!                         FNS       ----- -2<a name='204'></font>
<font color=#447700>!                          |<a name='205'></font>
<font color=#447700>!                          |<a name='206'></font>
<font color=#447700>!                          |<a name='207'></font>
<font color=#447700>!                         DPDE      ----- -3<a name='208'></font>
<font color=#447700>!<a name='209'></font>
<font color=#447700>!***********************************************************************<a name='210'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='211'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='212'></font>
<font color=#447700>!<a name='213'></font>
      ISTART=MYIS_P2<a name='214'>
      IEND=MYIE_P2 <a name='215'>
      IF(ITE==IDE)IEND=MYIE-3 <a name='216'>
<font color=#447700>!<a name='217'></font>
      DTQ=DT*0.25<a name='218'>
      DTE=DT*(0.5*0.25)<a name='219'>
<font color=#447700>!***<a name='220'></font>
<font color=#447700>!***  INITIALIZE SOME WORKING ARRAYS TO ZERO<a name='221'></font>
<font color=#447700>!***<a name='222'></font>
      DO K=KTS,KTE<a name='223'>
      DO I=ITS-5,ITE+5<a name='224'>
        TEW(I,K)=0.<a name='225'>
        UEW(I,K)=0.<a name='226'>
        VEW(I,K)=0.<a name='227'>
      ENDDO<a name='228'>
      ENDDO<a name='229'>
<font color=#447700>!<a name='230'></font>
<font color=#447700>!***  TYPE 0<a name='231'></font>
<font color=#447700>!<a name='232'></font>
      DO N=-3,3<a name='233'>
        DO K=KTS,KTE<a name='234'>
        DO I=ITS-5,ITE+5<a name='235'>
          DPDE(I,K,N)=0.<a name='236'>
        ENDDO<a name='237'>
        ENDDO<a name='238'>
      ENDDO<a name='239'>
<font color=#447700>!<a name='240'></font>
<font color=#447700>!***  TYPE 1<a name='241'></font>
<font color=#447700>!<a name='242'></font>
      DO N=-2,2<a name='243'>
        DO K=KTS,KTE<a name='244'>
        DO I=ITS-5,ITE+5<a name='245'>
          TST(I,K,N)=0.<a name='246'>
          UST(I,K,N)=0.<a name='247'>
          VST(I,K,N)=0.<a name='248'>
          UDY(I,K,N)=0.<a name='249'>
          VDX(I,K,N)=0.<a name='250'>
        ENDDO<a name='251'>
        ENDDO<a name='252'>
      ENDDO<a name='253'>
<font color=#447700>!<a name='254'></font>
<font color=#447700>!***  TYPES 5 AND 6<a name='255'></font>
<font color=#447700>!<a name='256'></font>
      DO N=-1,0<a name='257'>
        DO K=KTS,KTE<a name='258'>
        DO I=ITS-5,ITE+5<a name='259'>
          TNE(I,K,N)=0.<a name='260'>
          TSE(I,K,N+1)=0.<a name='261'>
          UNE(I,K,N)=0.<a name='262'>
          USE(I,K,N+1)=0.<a name='263'>
          VNE(I,K,N)=0.<a name='264'>
          VSE(I,K,N+1)=0.<a name='265'>
        ENDDO<a name='266'>
        ENDDO<a name='267'>
      ENDDO<a name='268'>
<font color=#447700>!-----------------------------------------------------------------------<a name='269'></font>
<font color=#447700>!***<a name='270'></font>
<font color=#447700>!***  PRECOMPUTE DETA1 TIMES PDTOP.<a name='271'></font>
<font color=#447700>!***<a name='272'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='273'></font>
<font color=#447700>!<a name='274'></font>
      DO K=KTS,KTE<a name='275'>
        DETA1_PDTOP(K)=DETA1(K)*PDTOP<a name='276'>
      ENDDO<a name='277'>
<font color=#447700>!-----------------------------------------------------------------------<a name='278'></font>
<font color=#447700>!***<a name='279'></font>
<font color=#447700>!***  WE NEED THE STARTING AND ENDING J FOR THIS TASK'S INTEGRATION<a name='280'></font>
<font color=#447700>!***<a name='281'></font>
      JSTART=MYJS2<a name='282'>
      JEND=MYJE2<a name='283'>
<font color=#447700>!<a name='284'></font>
<font color=#447700>!<a name='285'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='286'></font>
<font color=#447700>!<a name='287'></font>
<font color=#447700>!***  START THE HORIZONTAL ADVECTION IN THE INITIAL SOUTHERN SLABS.<a name='288'></font>
<font color=#447700>!<a name='289'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='290'></font>
<font color=#447700>!<a name='291'></font>
      DO J=-2,1<a name='292'>
        JJ=JSTART+J<a name='293'>
        DO K=KTS,KTE<a name='294'>
        DO I=MYIS_P4,MYIE_P4<a name='295'>
          TST(I,K,J)=T(I,K,JJ)*FFC+TOLD(I,K,JJ)*FBC<a name='296'>
          UST(I,K,J)=U(I,K,JJ)*FFC+UOLD(I,K,JJ)*FBC<a name='297'>
          VST(I,K,J)=V(I,K,JJ)*FFC+VOLD(I,K,JJ)*FBC<a name='298'>
        ENDDO<a name='299'>
        ENDDO<a name='300'>
      ENDDO<a name='301'>
<font color=#447700>!<a name='302'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='303'></font>
<font color=#447700>!***  MARCH NORTHWARD THROUGH THE SOUTHERNMOST SLABS TO BEGIN<a name='304'></font>
<font color=#447700>!***  FILLING THE MAIN WORKING ARRAYS WHICH ARE MULTI-DIMENSIONED<a name='305'></font>
<font color=#447700>!***  IN J BECAUSE THEY ARE DIFFERENCED OR AVERAGED IN J.<a name='306'></font>
<font color=#447700>!***  ONLY THE NORTHERNMOST OF EACH OF THE WORKING ARRAYS WILL BE<a name='307'></font>
<font color=#447700>!***  FILLED IN THE PRIMARY INTEGRATION SECTION.<a name='308'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='309'></font>
<font color=#447700>!<a name='310'></font>
      J1=-3<a name='311'>
      IF(JTS==JDS)J1=-2  <font color=#447700>! Cannot go 3 south from J=2 for south tasks<a name='312'></font>
<font color=#447700>!<a name='313'></font>
      DO J=J1,2<a name='314'>
        JJ=JSTART+J<a name='315'>
<font color=#447700>!<a name='316'></font>
        DO K=KTS,KTE<a name='317'>
        DO I=MYIS_P4,MYIE_P4<a name='318'>
          DPDE(I,K,J)=DETA1_PDTOP(K)+DETA2(K)*PDSLO(I,JJ)<a name='319'>
        ENDDO<a name='320'>
        ENDDO<a name='321'>
<font color=#447700>!<a name='322'></font>
      ENDDO<a name='323'>
<font color=#447700>!<a name='324'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='325'></font>
      DO J=-2,1<a name='326'>
        JJ=JSTART+J<a name='327'>
<font color=#447700>!<a name='328'></font>
        DO K=KTS,KTE<a name='329'>
        DO I=MYIS_P4,MYIE_P4<a name='330'>
          UDY(I,K,J)=U(I,K,JJ)*DY<a name='331'>
          VDX_X=V(I,K,JJ)*DX(I,JJ)<a name='332'>
          FNS(I,K,JJ)=VDX_X*(DPDE(I,K,J-1)+DPDE(I,K,J+1))<a name='333'>
          VDX(I,K,J)=VDX_X<a name='334'>
        ENDDO<a name='335'>
        ENDDO<a name='336'>
<font color=#447700>!<a name='337'></font>
      ENDDO<a name='338'>
<font color=#447700>!<a name='339'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='340'></font>
      DO J=-2,0<a name='341'>
        JJ=JSTART+J<a name='342'>
<font color=#447700>!<a name='343'></font>
        DO K=KTS,KTE<a name='344'>
        DO I=MYIS_P3,MYIE_P3<a name='345'>
          TEMPA=(UDY(I+IHE(JJ),K,J)+VDX(I+IHE(JJ),K,J))                 &amp;<a name='346'>
     &amp;         +(UDY(I,K,J+1)      +VDX(I,K,J+1))<a name='347'>
          FNE(I,K,JJ)=TEMPA*(DPDE(I,K,J)+DPDE(I+IHE(JJ),K,J+1))<a name='348'>
        ENDDO<a name='349'>
        ENDDO<a name='350'>
<font color=#447700>!<a name='351'></font>
      ENDDO<a name='352'>
<font color=#447700>!<a name='353'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='354'></font>
      DO J=-1,1<a name='355'>
        JJ=JSTART+J<a name='356'>
<font color=#447700>!<a name='357'></font>
        DO K=KTS,KTE<a name='358'>
        DO I=MYIS_P3,MYIE_P3<a name='359'>
          TEMPB=(UDY(I+IHE(JJ),K,J)-VDX(I+IHE(JJ),K,J))                 &amp;<a name='360'>
     &amp;         +(UDY(I,K,J-1)      -VDX(I,K,J-1))<a name='361'>
          FSE(I,K,JJ)=TEMPB*(DPDE(I,K,J)+DPDE(I+IHE(JJ),K,J-1))<a name='362'>
        ENDDO<a name='363'>
        ENDDO<a name='364'>
<font color=#447700>!<a name='365'></font>
      ENDDO<a name='366'>
<font color=#447700>!<a name='367'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='368'></font>
      DO J=-1,0<a name='369'>
        JJ=JSTART+J<a name='370'>
<font color=#447700>!<a name='371'></font>
        DO K=KTS,KTE<a name='372'>
        DO I=MYIS1_P3,MYIE1_P3<a name='373'>
          FNS_X=FNS(I,K,JJ)<a name='374'>
          TNS(I,K,J)=FNS_X*(TST(I,K,J+1)-TST(I,K,J-1))<a name='375'>
<font color=#447700>!<a name='376'></font>
          UDY_X=U(I,K,JJ)*DY<a name='377'>
          FEW(I,K,JJ)=UDY_X*(DPDE(I+IVW(JJ),K,J)+DPDE(I+IVE(JJ),K,J))   <a name='378'>
        ENDDO<a name='379'>
        ENDDO<a name='380'>
<font color=#447700>!<a name='381'></font>
        DO K=KTS,KTE<a name='382'>
        DO I=MYIS1_P4,MYIE1_P4<a name='383'>
          UNS(I,K,J)=(FNS(I+IHW(JJ),K,JJ)+FNS(I+IHE(JJ),K,JJ))          &amp;<a name='384'>
     &amp;              *(UST(I,K,J+1)-UST(I,K,J-1))<a name='385'>
          VNS(I,K,J)=(FNS(I,K,JJ-1)+FNS(I,K,JJ+1))                      &amp;<a name='386'>
     &amp;              *(VST(I,K,J+1)-VST(I,K,J-1))<a name='387'>
        ENDDO<a name='388'>
        ENDDO<a name='389'>
<font color=#447700>!<a name='390'></font>
      ENDDO<a name='391'>
<font color=#447700>!<a name='392'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='393'></font>
      JJ=JSTART-1<a name='394'>
<font color=#447700>!<a name='395'></font>
      DO K=KTS,KTE<a name='396'>
      DO I=MYIS1_P2,MYIE1_P2<a name='397'>
        FNE_X=FNE(I,K,JJ)<a name='398'>
        TNE(I,K,-1)=FNE_X*(TST(I+IHE(JJ),K,0)-TST(I,K,-1))<a name='399'>
<font color=#447700>!<a name='400'></font>
        FSE_X=FSE(I,K,JJ+1)<a name='401'>
        TSE(I,K,0)=FSE_X*(TST(I+IHE(JJ+1),K,-1)-TST(I,K,0))<a name='402'>
<font color=#447700>!<a name='403'></font>
        UNE(I,K,-1)=(FNE(I+IVW(JJ),K,JJ)+FNE(I+IVE(JJ),K,JJ))           &amp;<a name='404'>
     &amp;             *(UST(I+IVE(JJ),K,0)-UST(I,K,-1))<a name='405'>
        USE(I,K,0)=(FSE(I+IVW(JJ+1),K,JJ+1)+FSE(I+IVE(JJ+1),K,JJ+1))    &amp;<a name='406'>
     &amp;            *(UST(I+IVE(JJ+1),K,-1)-UST(I,K,0))<a name='407'>
        VNE(I,K,-1)=(FNE(I,K,JJ-1)+FNE(I,K,JJ+1))                       &amp;<a name='408'>
     &amp;             *(VST(I+IVE(JJ),K,0)-VST(I,K,-1))<a name='409'>
        VSE(I,K,0)=(FSE(I,K,JJ)+FSE(I,K,JJ+2))                          &amp;<a name='410'>
     &amp;            *(VST(I+IVE(JJ+1),K,-1)-VST(I,K,0))<a name='411'>
      ENDDO<a name='412'>
      ENDDO<a name='413'>
<font color=#447700>!<a name='414'></font>
      JKNT=0<a name='415'>
<font color=#447700>!<a name='416'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='417'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='418'></font>
<font color=#447700>!<a name='419'></font>
      main_integration : DO J=JSTART,JEND<a name='420'>
<font color=#447700>!<a name='421'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='422'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='423'></font>
<font color=#447700>!***<a name='424'></font>
<font color=#447700>!***  SET THE 3RD INDEX IN THE WORKING ARRAYS (SEE SUBROUTINE INIT<a name='425'></font>
<font color=#447700>!***                                           AND PFDHT DIAGRAMS)<a name='426'></font>
<font color=#447700>!***<a name='427'></font>
<font color=#447700>!***  J[TYPE]_NN WHERE "TYPE" IS THE WORKING ARRAY TYPE SEEN IN THE<a name='428'></font>
<font color=#447700>!***  LOCAL DECLARATION ABOVE (DEPENDENT UPON THE J EXTENT) AND<a name='429'></font>
<font color=#447700>!***  NN IS THE NUMBER OF ROWS NORTH OF THE CENTRAL ROW WHOSE J IS<a name='430'></font>
<font color=#447700>!***  THE CURRENT VALUE OF THE main_integration LOOP.<a name='431'></font>
<font color=#447700>!***  (P3 denotes +3, M1 denotes -1, etc.)<a name='432'></font>
<font color=#447700>!***<a name='433'></font>
<a name='434'>
<font color=#447700>!<a name='435'></font>
<font color=#447700>! John and Tom both think this is all right, even for tiles,<a name='436'></font>
<font color=#447700>! as long as the slab arrays being indexed by these things<a name='437'></font>
<font color=#447700>! are locally defined.<a name='438'></font>
<font color=#447700>!<a name='439'></font>
      JKNT=JKNT+1<a name='440'>
<font color=#447700>!<a name='441'></font>
      J0_P3=INDX3_WRK(3,JKNT,0)<a name='442'>
      J0_P2=INDX3_WRK(2,JKNT,0)<a name='443'>
      J0_P1=INDX3_WRK(1,JKNT,0)<a name='444'>
      J0_00=INDX3_WRK(0,JKNT,0)<a name='445'>
      J0_M1=INDX3_WRK(-1,JKNT,0)<a name='446'>
<font color=#447700>!<a name='447'></font>
      J1_P2=INDX3_WRK(2,JKNT,1)<a name='448'>
      J1_P1=INDX3_WRK(1,JKNT,1)<a name='449'>
      J1_00=INDX3_WRK(0,JKNT,1)<a name='450'>
      J1_M1=INDX3_WRK(-1,JKNT,1)<a name='451'>
<font color=#447700>!<a name='452'></font>
      J2_P1=INDX3_WRK(1,JKNT,2)<a name='453'>
      J2_00=INDX3_WRK(0,JKNT,2)<a name='454'>
      J2_M1=INDX3_WRK(-1,JKNT,2)<a name='455'>
<font color=#447700>!<a name='456'></font>
      J3_P2=INDX3_WRK(2,JKNT,3)<a name='457'>
      J3_P1=INDX3_WRK(1,JKNT,3)<a name='458'>
      J3_00=INDX3_WRK(0,JKNT,3)<a name='459'>
<font color=#447700>!<a name='460'></font>
      J4_P1=INDX3_WRK(1,JKNT,4)<a name='461'>
      J4_00=INDX3_WRK(0,JKNT,4)<a name='462'>
      J4_M1=INDX3_WRK(-1,JKNT,4)<a name='463'>
<font color=#447700>!<a name='464'></font>
      J5_00=INDX3_WRK(0,JKNT,5)<a name='465'>
      J5_M1=INDX3_WRK(-1,JKNT,5)<a name='466'>
<font color=#447700>!<a name='467'></font>
      J6_P1=INDX3_WRK(1,JKNT,6)<a name='468'>
      J6_00=INDX3_WRK(0,JKNT,6)<a name='469'>
<font color=#447700>!<a name='470'></font>
      MY_IS_GLB=1  <font color=#447700>! make this a noop for global indexing<a name='471'></font>
      MY_IE_GLB=1  <font color=#447700>! make this a noop for global indexing<a name='472'></font>
      MY_JS_GLB=1  <font color=#447700>! make this a noop for global indexing<a name='473'></font>
      MY_JE_GLB=1  <font color=#447700>! make this a noop for global indexing<a name='474'></font>
<font color=#447700>!  <a name='475'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='476'></font>
<font color=#447700>!***  THE WORKING ARRAYS FOR THE PRIMARY VARIABLES<a name='477'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='478'></font>
<font color=#447700>!<a name='479'></font>
      DO K=KTS,KTE<a name='480'>
      DO I=MYIS_P4,MYIE_P4<a name='481'>
        TST(I,K,J1_P2)=T(I,K,J+2)*FFC+TOLD(I,K,J+2)*FBC<a name='482'>
        UST(I,K,J1_P2)=U(I,K,J+2)*FFC+UOLD(I,K,J+2)*FBC<a name='483'>
        VST(I,K,J1_P2)=V(I,K,J+2)*FFC+VOLD(I,K,J+2)*FBC<a name='484'>
      ENDDO<a name='485'>
      ENDDO<a name='486'>
<font color=#447700>!<a name='487'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='488'></font>
<font color=#447700>!***  MASS FLUXES AND MASS POINT ADVECTION COMPONENTS<a name='489'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='490'></font>
<font color=#447700>!<a name='491'></font>
      DO K=KTS,KTE<a name='492'>
      DO I=MYIS_P4,MYIE_P4<a name='493'>
<font color=#447700>!<a name='494'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='495'></font>
<font color=#447700>!***  THE NS AND EW FLUXES IN THE FOLLOWING LOOP ARE ON V POINTS<a name='496'></font>
<font color=#447700>!***  FOR T.<a name='497'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='498'></font>
<font color=#447700>!<a name='499'></font>
        DPDE_P3=DETA1_PDTOP(K)+DETA2(K)*PDSLO(I,J+3)<a name='500'>
        DPDE(I,K,J0_P3)=DPDE_P3<a name='501'>
<font color=#447700>!<a name='502'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='503'></font>
        UDY(I,K,J1_P2)=U(I,K,J+2)*DY<a name='504'>
        VDX_P2=V(I,K,J+2)*DX(I,J+2)<a name='505'>
        VDX(I,K,J1_P2)=VDX_P2<a name='506'>
        FNS(I,K,J+2)=VDX_P2*(DPDE(I,K,J0_P1)+DPDE_P3)<a name='507'>
      ENDDO<a name='508'>
      ENDDO<a name='509'>
<font color=#447700>!<a name='510'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='511'></font>
      DO K=KTS,KTE<a name='512'>
      DO I=MYIS_P3,MYIE_P3<a name='513'>
        TEMPA=(UDY(I+IHE(J+1),K,J1_P1)+VDX(I+IHE(J+1),K,J1_P1))         &amp;<a name='514'>
     &amp;       +(UDY(I,K,J1_P2)         +VDX(I,K,J1_P2))<a name='515'>
        FNE(I,K,J+1)=TEMPA*(DPDE(I,K,J0_P1)+DPDE(I+IHE(J+1),K,J0_P2))<a name='516'>
<font color=#447700>!<a name='517'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='518'></font>
        TEMPB=(UDY(I+IHE(J+2),K,J1_P2)-VDX(I+IHE(J+2),K,J1_P2))         &amp;<a name='519'>
     &amp;       +(UDY(I,K,J1_P1)         -VDX(I,K,J1_P1))<a name='520'>
        FSE(I,K,J+2)=TEMPB*(DPDE(I,K,J0_P2)+DPDE(I+IHE(J),K,J0_P1))<a name='521'>
<font color=#447700>!<a name='522'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='523'></font>
        FNS_P1=FNS(I,K,J+1)<a name='524'>
        TNS(I,K,J4_P1)=FNS_P1*(TST(I,K,J1_P2)-TST(I,K,J1_00))<a name='525'>
<font color=#447700>!<a name='526'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='527'></font>
        UDY_P1=U(I,K,J+1)*DY<a name='528'>
        FEW(I,K,J+1)=UDY_P1*(DPDE(I+IVW(J+1),K,J0_P1)                   &amp;<a name='529'>
     &amp;                        +DPDE(I+IVE(J+1),K,J0_P1))<a name='530'>
        FEW_00=FEW(I,K,J)<a name='531'>
        TEW(I,K)=FEW_00*(TST(I+IVE(J),K,J1_00)-TST(I+IVW(J),K,J1_00))<a name='532'>
<font color=#447700>!<a name='533'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='534'></font>
<font color=#447700>!***  THE NE AND SE FLUXES ARE ASSOCIATED WITH H POINTS<a name='535'></font>
<font color=#447700>!***  (ACTUALLY JUST TO THE NE AND SE OF EACH H POINT).<a name='536'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='537'></font>
<font color=#447700>!<a name='538'></font>
        FNE_X=FNE(I,K,J)<a name='539'>
        TNE(I,K,J5_00)=FNE_X*(TST(I+IHE(J),K,J1_P1)-TST(I,K,J1_00))<a name='540'>
<font color=#447700>!<a name='541'></font>
        FSE_X=FSE(I,K,J+1)<a name='542'>
        TSE(I,K,J6_P1)=FSE_X*(TST(I+IHE(J+1),K,J1_00)-TST(I,K,J1_P1))<a name='543'>
      ENDDO<a name='544'>
      ENDDO<a name='545'>
<font color=#447700>!<a name='546'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='547'></font>
<font color=#447700>!***  CALCULATION OF MOMENTUM ADVECTION COMPONENTS<a name='548'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='549'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='550'></font>
<font color=#447700>!***  THE NS AND EW FLUXES ARE ON H POINTS FOR U AND V.<a name='551'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='552'></font>
<font color=#447700>!<a name='553'></font>
      DO K=KTS,KTE<a name='554'>
      DO I=MYIS_P2,MYIE_P2<a name='555'>
        UEW(I,K)=(FEW(I+IHW(J),K,J)+FEW(I+IHE(J),K,J))                  &amp;<a name='556'>
     &amp;          *(UST(I+IHE(J),K,J1_00)-UST(I+IHW(J),K,J1_00))<a name='557'>
        UNS(I,K,J4_P1)=(FNS(I+IHW(J+1),K,J+1)                           &amp;<a name='558'>
     &amp;                 +FNS(I+IHE(J+1),K,J+1))                          &amp;<a name='559'>
     &amp;                *(UST(I,K,J1_P2)-UST(I,K,J1_00))<a name='560'>
        VEW(I,K)=(FEW(I,K,J-1)+FEW(I,K,J+1))                            &amp;<a name='561'>
     &amp;          *(VST(I+IHE(J),K,J1_00)-VST(I+IHW(J),K,J1_00))<a name='562'>
        VNS(I,K,J4_P1)=(FNS(I,K,J)+FNS(I,K,J+2))                        &amp;<a name='563'>
     &amp;                *(VST(I,K,J1_P2)-VST(I,K,J1_00))<a name='564'>
<font color=#447700>!<a name='565'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='566'></font>
<font color=#447700>!***  THE FOLLOWING NE AND SE FLUXES ARE TIED TO V POINTS AND ARE<a name='567'></font>
<font color=#447700>!***  LOCATED JUST TO THE NE AND SE OF THE GIVEN I,J.<a name='568'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='569'></font>
<font color=#447700>!<a name='570'></font>
        UNE(I,K,J5_00)=(FNE(I+IVW(J),K,J)+FNE(I+IVE(J),K,J))            &amp;<a name='571'>
     &amp;                *(UST(I+IVE(J),K,J1_P1)-UST(I,K,J1_00))<a name='572'>
        USE(I,K,J6_P1)=(FSE(I+IVW(J+1),K,J+1)                           &amp;<a name='573'>
     &amp;                 +FSE(I+IVE(J+1),K,J+1))                          &amp;<a name='574'>
     &amp;                *(UST(I+IVE(J+1),K,J1_00)-UST(I,K,J1_P1))<a name='575'>
        VNE(I,K,J5_00)=(FNE(I,K,J-1)+FNE(I,K,J+1))                      &amp;<a name='576'>
     &amp;                *(VST(I+IVE(J),K,J1_P1)-VST(I,K,J1_00))<a name='577'>
        VSE(I,K,J6_P1)=(FSE(I,K,J)+FSE(I,K,J+2))                        &amp;<a name='578'>
     &amp;                *(VST(I+IVE(J+1),K,J1_00)-VST(I,K,J1_P1))<a name='579'>
      ENDDO<a name='580'>
      ENDDO<a name='581'>
<font color=#447700>!<a name='582'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='583'></font>
<font color=#447700>!***  COMPUTE THE ADVECTION TENDENCIES FOR T.<a name='584'></font>
<font color=#447700>!***  THE AD ARRAYS ARE ON H POINTS.<a name='585'></font>
<font color=#447700>!***  SKIP TO UPSTREAM IF THESE ROWS HAVE ONLY UPSTREAM POINTS.<a name='586'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='587'></font>
<font color=#447700>!<a name='588'></font>
      <a name='589'>
      JGLOBAL=J+MY_JS_GLB-1<a name='590'>
      IF(JGLOBAL&gt;=6.AND.JGLOBAL&lt;=JDE-5)THEN<a name='591'>
<font color=#447700>!<a name='592'></font>
        JJ=J+MY_JS_GLB-1   <font color=#447700>! okay because MY_JS_GLB is 1<a name='593'></font>
        IF(ITS==IDS)ISTART=3+MOD(JJ,2)  <font color=#447700>! need to think about this<a name='594'></font>
                                        <font color=#447700>! more in terms of how to <a name='595'></font>
                                        <font color=#447700>! convert to global indexing<a name='596'></font>
<font color=#447700>!<a name='597'></font>
        DO K=KTS,KTE<a name='598'>
        DO I=ISTART,IEND<a name='599'>
          RDPD=1./DPDE(I,K,J0_00)<a name='600'>
<font color=#447700>!<a name='601'></font>
          ADT(I,K,J)=(TEW(I+IHW(J),K)+TEW(I+IHE(J),K)                   &amp;<a name='602'>
     &amp;               +TNS(I,K,J4_M1)+TNS(I,K,J4_P1)                     &amp;<a name='603'>
     &amp;               +TNE(I+IHW(J),K,J5_M1)+TNE(I,K,J5_00)              &amp;<a name='604'>
     &amp;               +TSE(I,K,J6_00)+TSE(I+IHW(J),K,J6_P1))             &amp;<a name='605'>
     &amp;               *RDPD*FAD(I,J)<a name='606'>
<font color=#447700>!<a name='607'></font>
        ENDDO<a name='608'>
        ENDDO<a name='609'>
<font color=#447700>!<a name='610'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='611'></font>
<font color=#447700>!***  COMPUTE THE ADVECTION TENDENCIES FOR U AND V.<a name='612'></font>
<font color=#447700>!***  THE AD ARRAYS ARE ON VELOCITY POINTS.<a name='613'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='614'></font>
<font color=#447700>!<a name='615'></font>
        IF(ITS==IDS)ISTART=3+MOD(JJ+1,2)<a name='616'>
<font color=#447700>!<a name='617'></font>
        DO K=KTS,KTE<a name='618'>
        DO I=ISTART,IEND<a name='619'>
          RDPDX=1./(DPDE(I+IVW(J),K,J0_00)+DPDE(I+IVE(J),K,J0_00))<a name='620'>
          RDPDY=1./(DPDE(I,K,J0_M1)+DPDE(I,K,J0_P1))<a name='621'>
<font color=#447700>!<a name='622'></font>
          ADU(I,K,J)=(UEW(I+IVW(J),K)+UEW(I+IVE(J),K)                   &amp;<a name='623'>
     &amp;               +UNS(I,K,J4_M1)+UNS(I,K,J4_P1)                     &amp;<a name='624'>
     &amp;               +UNE(I+IVW(J),K,J5_M1)+UNE(I,K,J5_00)              &amp;<a name='625'>
     &amp;               +USE(I,K,J6_00)+USE(I+IVW(J),K,J6_P1))             &amp;<a name='626'>
     &amp;               *RDPDX*FAD(I+IVW(J),J)<a name='627'>
<font color=#447700>!<a name='628'></font>
          ADV(I,K,J)=(VEW(I+IVW(J),K)+VEW(I+IVE(J),K)                   &amp;<a name='629'>
     &amp;               +VNS(I,K,J4_M1)+VNS(I,K,J4_P1)                     &amp;<a name='630'>
     &amp;               +VNE(I+IVW(J),K,J5_M1)+VNE(I,K,J5_00)              &amp;<a name='631'>
     &amp;               +VSE(I,K,J6_00)+VSE(I+IVW(J),K,J6_P1))             &amp;<a name='632'>
     &amp;               *RDPDY*FAD(I+IVW(J),J)<a name='633'>
<font color=#447700>!<a name='634'></font>
        ENDDO<a name='635'>
        ENDDO<a name='636'>
<font color=#447700>!<a name='637'></font>
      ENDIF<a name='638'>
<font color=#447700>!<a name='639'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='640'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='641'></font>
<font color=#447700>!<a name='642'></font>
<font color=#447700>!***  END OF JANJIC HORIZONTAL ADVECTION <a name='643'></font>
<font color=#447700>!<a name='644'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='645'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='646'></font>
<font color=#447700>!***  UPSTREAM ADVECTION OF T, U, AND V<a name='647'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='648'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='649'></font>
<font color=#447700>!<a name='650'></font>
      upstream : IF(UPSTRM)THEN<a name='651'>
<font color=#447700>!<a name='652'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='653'></font>
<font color=#447700>!***<a name='654'></font>
<font color=#447700>!***  COMPUTE UPSTREAM COMPUTATIONS ON THIS TASK'S ROWS.<a name='655'></font>
<font color=#447700>!***<a name='656'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='657'></font>
<font color=#447700>!<a name='658'></font>
          N_IUPH_J=N_IUP_H(J)   <font color=#447700>! See explanation in INIT<a name='659'></font>
<font color=#447700>!<a name='660'></font>
          DO K=KTS,KTE<a name='661'>
<font color=#447700>!<a name='662'></font>
            DO II=0,N_IUPH_J-1<a name='663'>
              I=IUP_H(IMS+II,J)<a name='664'>
              TTA=EMT_LOC(J)*(UST(I,K,J1_M1)+UST(I+IHW(J),K,J1_00)      &amp;<a name='665'>
     &amp;                       +UST(I+IHE(J),K,J1_00)+UST(I,K,J1_P1))<a name='666'>
              TTB=ENT       *(VST(I,K,J1_M1)+VST(I+IHW(J),K,J1_00)      &amp;<a name='667'>
     &amp;                       +VST(I+IHE(J),K,J1_00)+VST(I,K,J1_P1))<a name='668'>
              PP=-TTA-TTB<a name='669'>
              QP= TTA-TTB<a name='670'>
<font color=#447700>!<a name='671'></font>
              IF(PP&lt;0.)THEN<a name='672'>
                ISPA(I,K)=-1<a name='673'>
              ELSE<a name='674'>
                ISPA(I,K)= 1<a name='675'>
              ENDIF<a name='676'>
<font color=#447700>!<a name='677'></font>
              IF(QP&lt;0.)THEN<a name='678'>
                ISQA(I,K)=-1<a name='679'>
              ELSE<a name='680'>
                ISQA(I,K)= 1<a name='681'>
              ENDIF<a name='682'>
<font color=#447700>!<a name='683'></font>
              PP=ABS(PP)<a name='684'>
              QP=ABS(QP)<a name='685'>
              ARRAY3_X=PP*QP<a name='686'>
              ARRAY0(I,K)=ARRAY3_X-PP-QP<a name='687'>
              ARRAY1(I,K)=PP-ARRAY3_X<a name='688'>
              ARRAY2(I,K)=QP-ARRAY3_X<a name='689'>
              ARRAY3(I,K)=ARRAY3_X<a name='690'>
            ENDDO<a name='691'>
<font color=#447700>!<a name='692'></font>
          ENDDO<a name='693'>
<font color=#447700>!-----------------------------------------------------------------------<a name='694'></font>
<font color=#447700>!<a name='695'></font>
          N_IUPADH_J=N_IUP_ADH(J) <a name='696'>
<font color=#447700>!<a name='697'></font>
          DO K=KTS,KTE<a name='698'>
<font color=#447700>!<a name='699'></font>
            KNTI_ADH=1<a name='700'>
            IUP_ADH_J=IUP_ADH(IMS,J)<a name='701'>
<font color=#447700>!<a name='702'></font>
            DO II=0,N_IUPH_J-1<a name='703'>
              I=IUP_H(IMS+II,J)<a name='704'>
<font color=#447700>!<a name='705'></font>
              ISP=ISPA(I,K)<a name='706'>
              ISQ=ISQA(I,K)<a name='707'>
              IFP=(ISP-1)/2<a name='708'>
              IFQ=(-ISQ-1)/2<a name='709'>
              IPQ=(ISP-ISQ)/2<a name='710'>
<font color=#447700>!<a name='711'></font>
              IF(HTM(I+IHE(J)+IFP,K,J+ISP)                              &amp;<a name='712'>
     &amp;          *HTM(I+IHE(J)+IFQ,K,J+ISQ)                              &amp;<a name='713'>
     &amp;          *HTM(I+IPQ,K,J+ISP+ISQ)&gt;0.1)THEN<a name='714'>
                 GO TO 150<a name='715'>
              ENDIF<a name='716'>
<font color=#447700>!<a name='717'></font>
              IF(HTM(I+IHE(J)+IFP,K,J+ISP)                              &amp;<a name='718'>
     &amp;          +HTM(I+IHE(J)+IFQ,K,J+ISQ)                              &amp;<a name='719'>
     &amp;          +HTM(I+IPQ,K,J+ISP+ISQ)&lt;0.1)THEN <a name='720'>
<font color=#447700>!<a name='721'></font>
                T(I+IHE(J)+IFP,K,J+ISP)=T(I,K,J)<a name='722'>
                T(I+IHE(J)+IFQ,K,J+ISQ)=T(I,K,J)<a name='723'>
                T(I+IPQ,K,J+ISP+ISQ)=T(I,K,J)<a name='724'>
<font color=#447700>!<a name='725'></font>
              ELSEIF                                                    &amp;<a name='726'>
     &amp;        (HTM(I+IHE(J)+IFP,K,J+ISP)+HTM(I+IPQ,K,J+ISP+ISQ)         &amp;<a name='727'>
     &amp;         &lt;0.99)THEN<a name='728'>
<font color=#447700>!<a name='729'></font>
                T(I+IHE(J)+IFP,K,J+ISP)=T(I,K,J)<a name='730'>
                T(I+IPQ,K,J+ISP+ISQ)=T(I+IHE(J)+IFQ,K,J+ISQ)<a name='731'>
<font color=#447700>!<a name='732'></font>
              ELSEIF                                                    &amp;<a name='733'>
     &amp;        (HTM(I+IHE(J)+IFQ,K,J+ISQ)+HTM(I+IPQ,K,J+ISP+ISQ)         &amp;<a name='734'>
               &lt;0.99)THEN<a name='735'>
<font color=#447700>!<a name='736'></font>
                T(I+IHE(J)+IFQ,K,J+ISQ)=T(I,K,J)<a name='737'>
                T(I+IPQ,K,J+ISP+ISQ)=T(I+IHE(J)+IFP,K,J+ISP)<a name='738'>
<font color=#447700>!<a name='739'></font>
              ELSEIF                                                    &amp;<a name='740'>
     &amp;        (HTM(I+IHE(J)+IFP,K,J+ISP)                                &amp;<a name='741'>
     &amp;        +HTM(I+IHE(J)+IFQ,K,J+ISQ)&lt;0.99)THEN<a name='742'>
                T(I+IHE(J)+IFP,K,J+ISP)=0.5*(T(I,K,J)                   &amp;<a name='743'>
     &amp;                                      +T(I+IPQ,K,J+ISP+ISQ))<a name='744'>
                T(I+IHE(J)+IFQ,K,J+ISQ)=T(I+IHE(J)+IFP,K,J+ISP)<a name='745'>
<font color=#447700>!<a name='746'></font>
              ELSEIF(HTM(I+IHE(J)+IFP,K,J+ISP)&lt;0.99)THEN<a name='747'>
                T(I+IHE(J)+IFP,K,J+ISP)=T(I,K,J)                        &amp;<a name='748'>
     &amp;                                 +T(I+IPQ,K,J+ISP+ISQ)            &amp;<a name='749'>
     &amp;                                 -T(I+IHE(J)+IFQ,K,J+ISQ)<a name='750'>
<font color=#447700>!<a name='751'></font>
              ELSEIF(HTM(I+IHE(J)+IFQ,K,J+ISQ)&lt;0.99)THEN<a name='752'>
                T(I+IHE(J)+IFQ,K,J+ISQ)=T(I,K,J)                        &amp;<a name='753'>
     &amp;                                 +T(I+IPQ,K,J+ISP+ISQ)            &amp;<a name='754'>
     &amp;                                 -T(I+IHE(J)+IFP,K,J+ISP)<a name='755'>
<font color=#447700>!<a name='756'></font>
              ELSE<a name='757'>
                T(I+IPQ,K,J+ISP+ISQ)=T(I+IHE(J)+IFP,K,J+ISP)            &amp;<a name='758'>
     &amp;                              +T(I+IHE(J)+IFQ,K,J+ISQ)            &amp;<a name='759'>
     &amp;                              -T(I,K,J)<a name='760'>
<font color=#447700>!<a name='761'></font>
              ENDIF<a name='762'>
<font color=#447700>!<a name='763'></font>
  150         CONTINUE<a name='764'>
<font color=#447700>!<a name='765'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='766'></font>
<font color=#447700>!<a name='767'></font>
              IF(I==IUP_ADH_J)THEN  <font color=#447700>! Update advection H tendencies<a name='768'></font>
<font color=#447700>!<a name='769'></font>
                ISP=ISPA(I,K)<a name='770'>
                ISQ=ISQA(I,K)<a name='771'>
                IFP=(ISP-1)/2<a name='772'>
                IFQ=(-ISQ-1)/2<a name='773'>
                IPQ=(ISP-ISQ)/2<a name='774'>
<font color=#447700>!<a name='775'></font>
                F0=ARRAY0(I,K)<a name='776'>
                F1=ARRAY1(I,K)<a name='777'>
                F2=ARRAY2(I,K)<a name='778'>
                F3=ARRAY3(I,K)<a name='779'>
<font color=#447700>!<a name='780'></font>
                ADT(I,K,J)=F0*T(I,K,J)                                  &amp;<a name='781'>
     &amp;                    +F1*T(I+IHE(J)+IFP,K,J+ISP)                   &amp;<a name='782'>
     &amp;                    +F2*T(I+IHE(J)+IFQ,K,J+ISQ)                   &amp;<a name='783'>
                          +F3*T(I+IPQ,K,J+ISP+ISQ)<a name='784'>
<font color=#447700>!<a name='785'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='786'></font>
<font color=#447700>!<a name='787'></font>
                IF(KNTI_ADH&lt;N_IUPADH_J)THEN<a name='788'>
                  IUP_ADH_J=IUP_ADH(IMS+KNTI_ADH,J)<a name='789'>
                  KNTI_ADH=KNTI_ADH+1<a name='790'>
                ENDIF<a name='791'>
<font color=#447700>!<a name='792'></font>
              ENDIF  <font color=#447700>! End of advection H tendency IF block<a name='793'></font>
<font color=#447700>!<a name='794'></font>
            ENDDO  <font color=#447700>! End of II loop<a name='795'></font>
<font color=#447700>!<a name='796'></font>
          ENDDO  <font color=#447700>! End of K loop<a name='797'></font>
<font color=#447700>!<a name='798'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='799'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='800'></font>
<font color=#447700>!***  UPSTREAM ADVECTION OF VELOCITY COMPONENTS<a name='801'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='802'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='803'></font>
<font color=#447700>!<a name='804'></font>
          N_IUPADV_J=N_IUP_ADV(J)<a name='805'>
<font color=#447700>!<a name='806'></font>
          DO K=KTS,KTE<a name='807'>
<font color=#447700>!<a name='808'></font>
            DO II=0,N_IUPADV_J-1<a name='809'>
              I=IUP_ADV(IMS+II,J)<a name='810'>
<font color=#447700>!<a name='811'></font>
              TTA=EM_LOC(J)*UST(I,K,J1_00)<a name='812'>
              TTB=EN       *VST(I,K,J1_00)<a name='813'>
              PP=-TTA-TTB<a name='814'>
              QP=TTA-TTB<a name='815'>
<font color=#447700>!<a name='816'></font>
              IF(PP&lt;0.)THEN<a name='817'>
                ISP=-1<a name='818'>
              ELSE<a name='819'>
                ISP= 1<a name='820'>
              ENDIF<a name='821'>
<font color=#447700>!<a name='822'></font>
              IF(QP&lt;0.)THEN<a name='823'>
                ISQ=-1<a name='824'>
              ELSE<a name='825'>
                ISQ= 1<a name='826'>
              ENDIF<a name='827'>
<font color=#447700>!<a name='828'></font>
              IFP=(ISP-1)/2<a name='829'>
              IFQ=(-ISQ-1)/2<a name='830'>
              IPQ=(ISP-ISQ)/2<a name='831'>
              PP=ABS(PP)<a name='832'>
              QP=ABS(QP)<a name='833'>
              F3=PP*QP<a name='834'>
              F0=F3-PP-QP<a name='835'>
              F1=PP-F3<a name='836'>
              F2=QP-F3<a name='837'>
<font color=#447700>!<a name='838'></font>
              ADU(I,K,J)=F0*U(I,K,J)                                    &amp;<a name='839'>
     &amp;                  +F1*U(I+IVE(J)+IFP,K,J+ISP)                     &amp;<a name='840'>
     &amp;                  +F2*U(I+IVE(J)+IFQ,K,J+ISQ)                     &amp;<a name='841'>
     &amp;                  +F3*U(I+IPQ,K,J+ISP+ISQ)<a name='842'>
<font color=#447700>! <a name='843'></font>
              ADV(I,K,J)=F0*V(I,K,J)                                    &amp;<a name='844'>
     &amp;                  +F1*V(I+IVE(J)+IFP,K,J+ISP)                     &amp;<a name='845'>
     &amp;                  +F2*V(I+IVE(J)+IFQ,K,J+ISQ)                     &amp;<a name='846'>
     &amp;                  +F3*V(I+IPQ,K,J+ISP+ISQ)<a name='847'>
<font color=#447700>!<a name='848'></font>
            ENDDO<a name='849'>
<font color=#447700>!<a name='850'></font>
          ENDDO  <font color=#447700>!  End of K loop<a name='851'></font>
<font color=#447700>!<a name='852'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='853'></font>
<font color=#447700>!<a name='854'></font>
        ENDIF upstream<a name='855'>
<font color=#447700>!<a name='856'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='857'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='858'></font>
<font color=#447700>!***  END OF THIS UPSTREAM REGION<a name='859'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='860'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='861'></font>
<font color=#447700>!<a name='862'></font>
<font color=#447700>!***  COMPUTE VERTICAL ADVECTION TENDENCIES USING CRANK-NICHOLSON.<a name='863'></font>
<font color=#447700>!<a name='864'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='865'></font>
<font color=#447700>!***  FIRST THE TEMPERATURE<a name='866'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='867'></font>
<font color=#447700>!<a name='868'></font>
      iloop_for_t:  DO I=MYIS1,MYIE1<a name='869'>
<font color=#447700>!<a name='870'></font>
        PDOP=PDSLO(I,J)<a name='871'>
        PVVLO=PETDT(I,KTE-1,J)*DTQ<a name='872'>
        VVLO=PVVLO/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOP)<a name='873'>
        CMT=-VVLO+1.<a name='874'>
        RCMT(KTE)=1./CMT<a name='875'>
        CRT(KTE)=VVLO<a name='876'>
        RSTT(KTE)=-VVLO*(T(I,KTE-1,J)-T(I,KTE,J))+T(I,KTE,J)<a name='877'>
<font color=#447700>!<a name='878'></font>
        LMHK=KTE-LMH(I,J)+1<a name='879'>
        DO K=KTE-1,LMHK+1,-1<a name='880'>
          RDP=1./(DETA1_PDTOP(K)+DETA2(K)*PDOP)<a name='881'>
          PVVUP=PVVLO<a name='882'>
          PVVLO=PETDT(I,K-1,J)*DTQ<a name='883'>
          VVUP=PVVUP*RDP<a name='884'>
          VVLO=PVVLO*RDP<a name='885'>
          CFT=-VVUP*RCMT(K+1)<a name='886'>
          CMT=-CRT(K+1)*CFT+(VVUP-VVLO+1.)<a name='887'>
          RCMT(K)=1./CMT<a name='888'>
          CRT(K)=VVLO<a name='889'>
          RSTT(K)=-RSTT(K+1)*CFT+T(I,K,J)                               &amp;<a name='890'>
     &amp;            -(T(I,K,J)-T(I,K+1,J))*VVUP                           &amp;<a name='891'>
     &amp;            -(T(I,K-1,J)-T(I,K,J))*VVLO<a name='892'>
        ENDDO<a name='893'>
<font color=#447700>!<a name='894'></font>
        PVVUP=PVVLO<a name='895'>
        VVUP=PVVUP/(DETA1_PDTOP(LMHK)+DETA2(LMHK)*PDOP)<a name='896'>
        CFT=-VVUP*RCMT(LMHK+1)<a name='897'>
        CMT=-CRT(LMHK+1)*CFT+VVUP+1.<a name='898'>
        CRT(LMHK)=0.<a name='899'>
        RSTT(LMHK)=-(T(I,LMHK,J)-T(I,LMHK+1,J))*VVUP                    &amp;<a name='900'>
     &amp;               -RSTT(LMHK+1)*CFT+T(I,LMHK,J)<a name='901'>
        TN(LMHK)=RSTT(LMHK)/CMT<a name='902'>
        VAD_TEND_T(I,LMHK)=TN(LMHK)-T(I,LMHK,J)<a name='903'>
<font color=#447700>!<a name='904'></font>
        DO K=LMHK+1,KTE<a name='905'>
          TN(K)=(-CRT(K)*TN(K-1)+RSTT(K))*RCMT(K)<a name='906'>
          VAD_TEND_T(I,K)=TN(K)-T(I,K,J)<a name='907'>
        ENDDO<a name='908'>
<font color=#447700>!<a name='909'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='910'></font>
<font color=#447700>!***  The following section is only for checking the implicit solution<a name='911'></font>
<font color=#447700>!***  using back-substitution.  Remove this section otherwise.<a name='912'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='913'></font>
<font color=#447700>!<a name='914'></font>
<font color=#447700>!       IF(I==ITEST.AND.J==JTEST)THEN<a name='915'></font>
<font color=#447700>!!<a name='916'></font>
<font color=#447700>!         PVVLO=PETDT(I,KTE-1,J)*DT*0.25<a name='917'></font>
<font color=#447700>!         VVLO=PVVLO/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOP)<a name='918'></font>
<font color=#447700>!         TTLO=VVLO*(T(I,KTE-1,J)-T(I,KTE,J)                            &amp;<a name='919'></font>
<font color=#447700>!    &amp;              +TN(KTE-1)-TN(KTE))<a name='920'></font>
<font color=#447700>!         ADTP=TTLO+TN(KTE)-T(I,KTE,J)<a name='921'></font>
<font color=#447700>!         WRITE(0,*)' NTSD=',NTSD,' I=',ITEST,' J=',JTEST,' K=',KTE     &amp;<a name='922'></font>
<font color=#447700>!    &amp;,             ' ADTP=',ADTP<a name='923'></font>
<font color=#447700>!         WRITE(0,*)' T=',T(I,KTE,J),' TN=',TN(KTE)                     &amp;<a name='924'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_T=',VAD_TEND_T(I,KTE)<a name='925'></font>
<font color=#447700>!         WRITE(0,*)' '<a name='926'></font>
<font color=#447700>!!<a name='927'></font>
<font color=#447700>!         DO K=KTE-1,LMHK+1,-1<a name='928'></font>
<font color=#447700>!           RDP=1./(DETA1_PDTOP(K)+DETA2(K)*PDOP)<a name='929'></font>
<font color=#447700>!           PVVUP=PVVLO<a name='930'></font>
<font color=#447700>!           PVVLO=PETDT(I,K-1,J)*DT*0.25<a name='931'></font>
<font color=#447700>!           VVUP=PVVUP*RDP<a name='932'></font>
<font color=#447700>!           VVLO=PVVLO*RDP<a name='933'></font>
<font color=#447700>!           TTUP=VVUP*(T(I,K,J)-T(I,K+1,J)+TN(K)-TN(K+1))<a name='934'></font>
<font color=#447700>!           TTLO=VVLO*(T(I,K-1,J)-T(I,K,J)+TN(K-1)-TN(K))<a name='935'></font>
<font color=#447700>!           ADTP=TTLO+TTUP+TN(K)-T(I,K,J)<a name='936'></font>
<font color=#447700>!           WRITE(0,*)' NTSD=',NTSD,' I=',I,' J=',J,' K=',K             &amp;<a name='937'></font>
<font color=#447700>!    &amp;,               ' ADTP=',ADTP<a name='938'></font>
<font color=#447700>!           WRITE(0,*)' T=',T(I,K,J),' TN=',TN(K)                       &amp;<a name='939'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_T=',VAD_TEND_T(I,K)<a name='940'></font>
<font color=#447700>!           WRITE(0,*)' '<a name='941'></font>
<font color=#447700>!         ENDDO<a name='942'></font>
<font color=#447700>!!<a name='943'></font>
<font color=#447700>!         IF(LMHK==KTS)THEN<a name='944'></font>
<font color=#447700>!           PVVUP=PVVLO<a name='945'></font>
<font color=#447700>!           VVUP=PVVUP/(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOP)<a name='946'></font>
<font color=#447700>!           TTUP=VVUP*(T(I,KTS,J)-T(I,KTS+1,J)+TN(KTS)-TN(KTS+1))<a name='947'></font>
<font color=#447700>!           ADTP=TTUP+TN(KTS)-T(I,KTS,J)<a name='948'></font>
<font color=#447700>!           WRITE(0,*)' NTSD=',NTSD,' I=',I,' J=',J,' K=',KTS           &amp;<a name='949'></font>
<font color=#447700>!    &amp;,               ' ADTP=',ADTP<a name='950'></font>
<font color=#447700>!           WRITE(0,*)' T=',T(I,KTS,J),' TN=',TN(KTS)                   &amp;<a name='951'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_T=',VAD_TEND_T(I,KTS)<a name='952'></font>
<font color=#447700>!           WRITE(0,*)' '<a name='953'></font>
<font color=#447700>!         ENDIF<a name='954'></font>
<font color=#447700>!       ENDIF<a name='955'></font>
<font color=#447700>!<a name='956'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='957'></font>
<font color=#447700>!***  End of check.<a name='958'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='959'></font>
<font color=#447700>!<a name='960'></font>
      ENDDO iloop_for_t<a name='961'>
<font color=#447700>!<a name='962'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='963'></font>
<font color=#447700>!***  NOW VERTICAL ADVECTION OF WIND COMPONENTS<a name='964'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='965'></font>
<font color=#447700>!<a name='966'></font>
      iloop_for_uv:  DO I=MYIS1,MYIE1<a name='967'>
<font color=#447700>!<a name='968'></font>
        PDOPU=(PDSLO(I+IVW(J),J)+PDSLO(I+IVE(J),J))*0.5<a name='969'>
        PDOPV=(PDSLO(I,J-1)+PDSLO(I,J+1))*0.5<a name='970'>
        PVVLOU=(PETDT(I+IVW(J),KTE-1,J)+PETDT(I+IVE(J),KTE-1,J))*DTE<a name='971'>
        PVVLOV=(PETDT(I,KTE-1,J-1)+PETDT(I,KTE-1,J+1))*DTE<a name='972'>
        VVLOU=PVVLOU/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOPU)<a name='973'>
        VVLOV=PVVLOV/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOPV)<a name='974'>
        CMU=-VVLOU+1.<a name='975'>
        CMV=-VVLOV+1.<a name='976'>
        RCMU(KTE)=1./CMU<a name='977'>
        RCMV(KTE)=1./CMV<a name='978'>
        CRU(KTE)=VVLOU<a name='979'>
        CRV(KTE)=VVLOV<a name='980'>
        RSTU(KTE)=-VVLOU*(U(I,KTE-1,J)-U(I,KTE,J))+U(I,KTE,J)<a name='981'>
        RSTV(KTE)=-VVLOV*(V(I,KTE-1,J)-V(I,KTE,J))+V(I,KTE,J)<a name='982'>
<font color=#447700>!<a name='983'></font>
        LMVK=KTE-LMV(I,J)+1<a name='984'>
        DO K=KTE-1,LMVK+1,-1<a name='985'>
          RDPU=1./(DETA1_PDTOP(K)+DETA2(K)*PDOPU)<a name='986'>
          RDPV=1./(DETA1_PDTOP(K)+DETA2(K)*PDOPV)<a name='987'>
          PVVUPU=PVVLOU<a name='988'>
          PVVUPV=PVVLOV<a name='989'>
          PVVLOU=(PETDT(I+IVW(J),K-1,J)+PETDT(I+IVE(J),K-1,J))*DTE<a name='990'>
          PVVLOV=(PETDT(I,K-1,J-1)+PETDT(I,K-1,J+1))*DTE<a name='991'>
          VVUPU=PVVUPU*RDPU<a name='992'>
          VVUPV=PVVUPV*RDPV<a name='993'>
          VVLOU=PVVLOU*RDPU<a name='994'>
          VVLOV=PVVLOV*RDPV<a name='995'>
          CFU=-VVUPU*RCMU(K+1)<a name='996'>
          CFV=-VVUPV*RCMV(K+1)<a name='997'>
          CMU=-CRU(K+1)*CFU+VVUPU-VVLOU+1.<a name='998'>
          CMV=-CRV(K+1)*CFV+VVUPV-VVLOV+1.<a name='999'>
          RCMU(K)=1./CMU<a name='1000'>
          RCMV(K)=1./CMV<a name='1001'>
          CRU(K)=VVLOU<a name='1002'>
          CRV(K)=VVLOV<a name='1003'>
          RSTU(K)=-RSTU(K+1)*CFU+U(I,K,J)                               &amp;<a name='1004'>
     &amp;            -(U(I,K,J)-U(I,K+1,J))*VVUPU                          &amp;<a name='1005'>
     &amp;            -(U(I,K-1,J)-U(I,K,J))*VVLOU<a name='1006'>
          RSTV(K)=-RSTV(K+1)*CFV+V(I,K,J)                               &amp;<a name='1007'>
     &amp;            -(V(I,K,J)-V(I,K+1,J))*VVUPV                          &amp;<a name='1008'>
     &amp;            -(V(I,K-1,J)-V(I,K,J))*VVLOV<a name='1009'>
        ENDDO<a name='1010'>
<font color=#447700>!<a name='1011'></font>
        RDPU=1./(DETA1_PDTOP(LMVK)+DETA2(LMVK)*PDOPU)<a name='1012'>
        RDPV=1./(DETA1_PDTOP(LMVK)+DETA2(LMVK)*PDOPV)<a name='1013'>
        PVVUPU=PVVLOU<a name='1014'>
        PVVUPV=PVVLOV<a name='1015'>
        VVUPU=PVVUPU*RDPU<a name='1016'>
        VVUPV=PVVUPV*RDPV<a name='1017'>
        CFU=-VVUPU*RCMU(LMVK+1)<a name='1018'>
        CFV=-VVUPV*RCMV(LMVK+1)<a name='1019'>
        CMU=-CRU(LMVK+1)*CFU+VVUPU+1.<a name='1020'>
        CMV=-CRV(LMVK+1)*CFV+VVUPV+1.<a name='1021'>
        CRU(LMVK)=0.<a name='1022'>
        CRV(LMVK)=0.<a name='1023'>
        RSTU(LMVK)=-(U(I,LMVK,J)-U(I,LMVK+1,J))*VVUPU                   &amp;<a name='1024'>
     &amp;               -RSTU(LMVK+1)*CFU+U(I,LMVK,J)<a name='1025'>
        RSTV(LMVK)=-(V(I,LMVK,J)-V(I,LMVK+1,J))*VVUPV                   &amp;<a name='1026'>
     &amp;               -RSTV(LMVK+1)*CFV+V(I,LMVK,J)<a name='1027'>
        UN(LMVK)=RSTU(LMVK)/CMU<a name='1028'>
        VN(LMVK)=RSTV(LMVK)/CMV<a name='1029'>
        VAD_TEND_U(I,LMVK)=UN(LMVK)-U(I,LMVK,J)<a name='1030'>
        VAD_TEND_V(I,LMVK)=VN(LMVK)-V(I,LMVK,J)<a name='1031'>
<font color=#447700>!<a name='1032'></font>
        DO K=LMVK+1,KTE<a name='1033'>
          UN(K)=(-CRU(K)*UN(K-1)+RSTU(K))*RCMU(K)<a name='1034'>
          VN(K)=(-CRV(K)*VN(K-1)+RSTV(K))*RCMV(K)<a name='1035'>
          VAD_TEND_U(I,K)=UN(K)-U(I,K,J)<a name='1036'>
          VAD_TEND_V(I,K)=VN(K)-V(I,K,J)<a name='1037'>
        ENDDO<a name='1038'>
<font color=#447700>!<a name='1039'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1040'></font>
<font color=#447700>!***  The following section is only for checking the implicit solution<a name='1041'></font>
<font color=#447700>!***  using back-substitution.  Remove this section otherwise.<a name='1042'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1043'></font>
<font color=#447700>!<a name='1044'></font>
<font color=#447700>!       IF(I==ITEST.AND.J==JTEST)THEN<a name='1045'></font>
<font color=#447700>!!<a name='1046'></font>
<font color=#447700>!         PDOPU=(PDSLO(I+IVW(J),J)+PDSLO(I+IVE(J),J))*0.5<a name='1047'></font>
<font color=#447700>!         PDOPV=(PDSLO(I,J-1)+PDSLO(I,J+1))*0.5<a name='1048'></font>
<font color=#447700>!         PVVLOU=(PETDT(I+IVW(J),KTE-1,J)                               &amp;<a name='1049'></font>
<font color=#447700>!    &amp;           +PETDT(I+IVE(J),KTE-1,J))*DTE<a name='1050'></font>
<font color=#447700>!         PVVLOV=(PETDT(I,KTE-1,J-1)                                    &amp;<a name='1051'></font>
<font color=#447700>!    &amp;           +PETDT(I,KTE-1,J+1))*DTE<a name='1052'></font>
<font color=#447700>!         VVLOU=PVVLOU/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOPU)<a name='1053'></font>
<font color=#447700>!         VVLOV=PVVLOV/(DETA1_PDTOP(KTE)+DETA2(KTE)*PDOPV)<a name='1054'></font>
<font color=#447700>!         TULO=VVLOU*(U(I,KTE-1,J)-U(I,KTE,J)+UN(KTE-1)-UN(KTE))<a name='1055'></font>
<font color=#447700>!         TVLO=VVLOV*(V(I,KTE-1,J)-V(I,KTE,J)+VN(KTE-1)-VN(KTE))<a name='1056'></font>
<font color=#447700>!         ADUP=TULO+UN(KTE)-U(I,KTE,J)<a name='1057'></font>
<font color=#447700>!         ADVP=TVLO+VN(KTE)-V(I,KTE,J)<a name='1058'></font>
<font color=#447700>!         WRITE(0,*)' NTSD=',NTSD,' I=',I,' J=',J,' K=',KTE             &amp;<a name='1059'></font>
<font color=#447700>!    &amp;,             ' ADUP=',ADUP,' ADVP=',ADVP<a name='1060'></font>
<font color=#447700>!         WRITE(0,*)' U=',U(I,KTE,J),' UN=',UN(KTE)                     &amp;<a name='1061'></font>
<font color=#447700>!    &amp;,             ' VAD_TEND_U=',VAD_TEND_U(I,KTE)                    &amp;<a name='1062'></font>
<font color=#447700>!    &amp;,             ' V=',V(I,KTE,J),' VN=',VN(KTE)                     &amp;<a name='1063'></font>
<font color=#447700>!    &amp;,             ' VAD_TEND_V=',VAD_TEND_V(I,KTE)<a name='1064'></font>
<font color=#447700>!         WRITE(0,*)' '<a name='1065'></font>
<font color=#447700>!!<a name='1066'></font>
<font color=#447700>!         DO K=KTE-1,LMVK+1,-1<a name='1067'></font>
<font color=#447700>!           RDPU=1./(DETA1_PDTOP(K)+DETA2(K)*PDOPU)<a name='1068'></font>
<font color=#447700>!           RDPV=1./(DETA1_PDTOP(K)+DETA2(K)*PDOPV)<a name='1069'></font>
<font color=#447700>!           PVVUPU=PVVLOU<a name='1070'></font>
<font color=#447700>!           PVVUPV=PVVLOV<a name='1071'></font>
<font color=#447700>!           PVVLOU=(PETDT(I+IVW(J),K-1,J)                               &amp;<a name='1072'></font>
<font color=#447700>!    &amp;            +PETDT(I+IVE(J),K-1,J))*DTE<a name='1073'></font>
<font color=#447700>!           PVVLOV=(PETDT(I,K-1,J-1)+PETDT(I,K-1,J+1))*DTE<a name='1074'></font>
<font color=#447700>!           VVUPU=PVVUPU*RDPU<a name='1075'></font>
<font color=#447700>!           VVUPV=PVVUPV*RDPV<a name='1076'></font>
<font color=#447700>!           VVLOU=PVVLOU*RDPU<a name='1077'></font>
<font color=#447700>!           VVLOV=PVVLOV*RDPV<a name='1078'></font>
<font color=#447700>!           TUUP=VVUPU*(U(I,K,J)-U(I,K+1,J)+UN(K)-UN(K+1))<a name='1079'></font>
<font color=#447700>!           TVUP=VVUPV*(V(I,K,J)-V(I,K+1,J)+VN(K)-VN(K+1))<a name='1080'></font>
<font color=#447700>!           TULO=VVLOU*(U(I,K-1,J)-U(I,K,J)+UN(K-1)-UN(K))<a name='1081'></font>
<font color=#447700>!           TVLO=VVLOV*(V(I,K-1,J)-V(I,K,J)+VN(K-1)-VN(K))<a name='1082'></font>
<font color=#447700>!           ADUP=TUUP+TULO+UN(K)-U(I,K,J)<a name='1083'></font>
<font color=#447700>!           ADVP=TVUP+TVLO+VN(K)-V(I,K,J)<a name='1084'></font>
<font color=#447700>!           WRITE(0,*)' NTSD=',NTSD,' I=',ITEST,' J=',JTEST,' K=',K     &amp;<a name='1085'></font>
<font color=#447700>!    &amp;,               ' ADUP=',ADUP,' ADVP=',ADVP<a name='1086'></font>
<font color=#447700>!           WRITE(0,*)' U=',U(I,K,J),' UN=',UN(K)                       &amp;<a name='1087'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_U=',VAD_TEND_U(I,K)                    &amp;<a name='1088'></font>
<font color=#447700>!    &amp;,               ' V=',V(I,K,J),' VN=',VN(K)                       &amp;<a name='1089'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_V=',VAD_TEND_V(I,K)<a name='1090'></font>
<font color=#447700>!           WRITE(0,*)' '<a name='1091'></font>
<font color=#447700>!         ENDDO<a name='1092'></font>
<font color=#447700>!!<a name='1093'></font>
<font color=#447700>!         IF(LMVK==KTS)THEN<a name='1094'></font>
<font color=#447700>!           PVVUPU=PVVLOU<a name='1095'></font>
<font color=#447700>!           PVVUPV=PVVLOV<a name='1096'></font>
<font color=#447700>!           VVUPU=PVVUPU/(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOPU)<a name='1097'></font>
<font color=#447700>!           VVUPV=PVVUPV/(DETA1_PDTOP(KTS)+DETA2(KTS)*PDOPV)<a name='1098'></font>
<font color=#447700>!           TUUP=VVUPU*(U(I,KTS,J)-U(I,KTS+1,J)+UN(KTS)-UN(KTS+1))<a name='1099'></font>
<font color=#447700>!           TVUP=VVUPV*(V(I,KTS,J)-V(I,KTS+1,J)+VN(KTS)-VN(KTS+1))<a name='1100'></font>
<font color=#447700>!           ADUP=TUUP+UN(KTS)-U(I,KTS,J)<a name='1101'></font>
<font color=#447700>!           ADVP=TVUP+VN(KTS)-V(I,KTS,J)<a name='1102'></font>
<font color=#447700>!           WRITE(0,*)' NTSD=',NTSD,' I=',ITEST,' J=',JTEST,' K=',KTS   &amp;<a name='1103'></font>
<font color=#447700>!    &amp;,               ' ADUP=',ADUP,' ADVP=',ADVP<a name='1104'></font>
<font color=#447700>!           WRITE(0,*)' U=',U(I,KTS,J),' UN=',UN(KTS)                   &amp;<a name='1105'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_U=',VAD_TEND_U(I,KTS)                  &amp;<a name='1106'></font>
<font color=#447700>!    &amp;,               ' V=',V(I,KTS,J),' VN=',VN(KTS)                   &amp;<a name='1107'></font>
<font color=#447700>!    &amp;,               ' VAD_TEND_V=',VAD_TEND_V(I,KTS)<a name='1108'></font>
<font color=#447700>!           WRITE(0,*)' '<a name='1109'></font>
<font color=#447700>!         ENDIF<a name='1110'></font>
<font color=#447700>!       ENDIF<a name='1111'></font>
<font color=#447700>!<a name='1112'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1113'></font>
<font color=#447700>!***  End of check.<a name='1114'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1115'></font>
<font color=#447700>!<a name='1116'></font>
      ENDDO iloop_for_uv<a name='1117'>
<font color=#447700>!<a name='1118'></font>
<font color=#447700>!<a name='1119'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1120'></font>
<font color=#447700>!<a name='1121'></font>
<font color=#447700>!***  NOW SUM THE VERTICAL AND HORIZONTAL TENDENCIES,<a name='1122'></font>
<font color=#447700>!***  CURVATURE AND CORIOLIS TERMS<a name='1123'></font>
<font color=#447700>!<a name='1124'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1125'></font>
<font color=#447700>!<a name='1126'></font>
      DO K=KTS,KTE<a name='1127'>
      DO I=MYIS1,MYIE1<a name='1128'>
        HM=HTM(I,K,J)*HBM2(I,J)<a name='1129'>
        VM=VTM(I,K,J)*VBM2(I,J)<a name='1130'>
        ADT(I,K,J)=(VAD_TEND_T(I,K)+2.*ADT(I,K,J))*HM<a name='1131'>
<font color=#447700>!<a name='1132'></font>
        FPP=CURV(I,J)*2.*UST(I,K,J1_00)+F(I,J)*2.<a name='1133'>
        ADU(I,K,J)=(VAD_TEND_U(I,K)+2.*ADU(I,K,J)+VST(I,K,J1_00)*FPP)   &amp;<a name='1134'>
     &amp;             *VM<a name='1135'>
        ADV(I,K,J)=(VAD_TEND_V(I,K)+2.*ADV(I,K,J)-UST(I,K,J1_00)*FPP)   &amp;<a name='1136'>
     &amp;             *VM<a name='1137'>
      ENDDO<a name='1138'>
      ENDDO<a name='1139'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1140'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1141'></font>
<font color=#447700>!<a name='1142'></font>
      ENDDO main_integration<a name='1143'>
<font color=#447700>!<a name='1144'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1145'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1146'></font>
<font color=#447700>!<a name='1147'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1148'></font>
<font color=#447700>!***  SAVE THE OLD VALUES FOR TIMESTEPPING<a name='1149'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1150'></font>
<font color=#447700>!<a name='1151'></font>
      DO J=MYJS_P4,MYJE_P4<a name='1152'>
        DO K=KTS,KTE<a name='1153'>
        DO I=MYIS_P4,MYIE_P4<a name='1154'>
          TOLD(I,K,J)=T(I,K,J)<a name='1155'>
          UOLD(I,K,J)=U(I,K,J)<a name='1156'>
          VOLD(I,K,J)=V(I,K,J)<a name='1157'>
        ENDDO<a name='1158'>
        ENDDO<a name='1159'>
      ENDDO<a name='1160'>
<font color=#447700>!<a name='1161'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1162'></font>
<font color=#447700>!***  FINALLY UPDATE THE PROGNOSTIC VARIABLES<a name='1163'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1164'></font>
<font color=#447700>!<a name='1165'></font>
      DO J=MYJS2,MYJE2<a name='1166'>
        DO K=KTS,KTE<a name='1167'>
        DO I=MYIS1,MYIE1<a name='1168'>
          T(I,K,J)=ADT(I,K,J)+T(I,K,J)<a name='1169'>
          U(I,K,J)=ADU(I,K,J)+U(I,K,J)<a name='1170'>
          V(I,K,J)=ADV(I,K,J)+V(I,K,J)<a name='1171'>
        ENDDO<a name='1172'>
        ENDDO<a name='1173'>
      ENDDO<a name='1174'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1175'></font>
      END SUBROUTINE ADVE<a name='1176'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1177'></font>
</pre></body></html>