<HTML> <BODY BGCOLOR=#eeeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!  Create an initial data set for the WRF model based on an ideal condition<a name='2'></font>
<font color=#447700>!  This program is specifically set up for the NMM core.<a name='3'></font>
<a name='4'>
<A NAME='IDEAL_NMM'><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_yellow.gif" border=0></A><a name='5'>
<font color=#993300>PROGRAM </font><font color=#cc0000>ideal_nmm</font>,<A href='../../call_from/IDEAL_NMM.html' TARGET='index'>38</A><a name='6'>
<a name='7'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_15"><a name='8'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_175"><a name='9'>
   USE <A href='../../html_code/dyn_em/module_initialize_b_wave.F.html#MODULE_INITIALIZE_IDEAL'>module_initialize_ideal</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INITIALIZE_IDEAL_3"><a name='10'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_6"><a name='11'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_47"><a name='12'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_116"><a name='13'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_34"><a name='14'>
   USE <A href='../../html_code/share/module_check_a_mundo.F.html#MODULE_CHECK_A_MUNDO'>module_check_a_mundo</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CHECK_A_MUNDO_1"><a name='15'>
#if ( WRF_CHEM == 1 )<a name='16'>
   USE module_input_chem_data<a name='17'>
   USE module_input_chem_bioemiss<a name='18'>
#endif<a name='19'>
   USE module_utility<a name='20'>
#ifdef DM_PARALLEL<a name='21'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_134"><a name='22'>
#endif<a name='23'>
<a name='24'>
   IMPLICIT NONE<a name='25'>
<a name='26'>
   REAL    :: time , bdyfrq<a name='27'>
<a name='28'>
   INTEGER :: loop , levels_to_process , debug_level<a name='29'>
<a name='30'>
<a name='31'>
   TYPE(domain) , POINTER :: null_domain<a name='32'>
   TYPE(domain) , POINTER :: grid<a name='33'>
   TYPE (grid_config_rec_type)              :: config_flags<a name='34'>
   INTEGER                :: number_at_same_level<a name='35'>
<a name='36'>
   INTEGER :: max_dom, domain_id<a name='37'>
   INTEGER :: idum1, idum2 <a name='38'>
#ifdef DM_PARALLEL<a name='39'>
   INTEGER                 :: nbytes<a name='40'>
<font color=#447700>!   INTEGER, PARAMETER      :: configbuflen = 2*1024<a name='41'></font>
   INTEGER, PARAMETER      :: configbuflen = 4*CONFIG_BUF_LEN<a name='42'>
   INTEGER                 :: configbuf( configbuflen )<a name='43'>
   LOGICAL , EXTERNAL      :: wrf_dm_on_monitor<a name='44'>
#endif<a name='45'>
<a name='46'>
   INTEGER :: ids , ide , jds , jde , kds , kde<a name='47'>
   INTEGER :: ims , ime , jms , jme , kms , kme<a name='48'>
   INTEGER :: ips , ipe , jps , jpe , kps , kpe<a name='49'>
   INTEGER :: ijds , ijde , spec_bdy_width<a name='50'>
   INTEGER :: i , j , k , idts<a name='51'>
<a name='52'>
#ifdef DEREF_KLUDGE<a name='53'>
<font color=#447700>!  see http://www.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='54'></font>
   INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='55'>
   INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='56'>
   INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='57'>
#endif<a name='58'>
<a name='59'>
   CHARACTER (LEN=80)     :: message<a name='60'>
<a name='61'>
   INTEGER :: start_year , start_month , start_day <a name='62'>
   INTEGER :: start_hour , start_minute , start_second<a name='63'>
   INTEGER :: end_year ,   end_month ,   end_day ,   &amp;<a name='64'>
              end_hour ,   end_minute ,   end_second<a name='65'>
   INTEGER :: interval_seconds , real_data_init_type<a name='66'>
   INTEGER :: time_loop_max , time_loop, rc<a name='67'>
   REAL    :: t1,t2<a name='68'>
<a name='69'>
#include "<A href='../../html_code/include/version_decl.html'>version_decl</A>"<A NAME="version_decl_1"><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='70'>
<a name='71'>
   INTERFACE<a name='72'>
     SUBROUTINE Setup_Timekeeping( grid )<a name='73'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_176"><a name='74'>
      TYPE(domain), POINTER :: grid<a name='75'>
     END SUBROUTINE Setup_Timekeeping<a name='76'>
   END INTERFACE<a name='77'>
<a name='78'>
   <font color=#447700>!  Define the name of this program (program_name defined in module_domain)<a name='79'></font>
<a name='80'>
   program_name = "IDEAL_HWRF " // TRIM(release_version) // " PREPROCESSOR"<a name='81'>
<a name='82'>
#ifdef DM_PARALLEL<a name='83'>
   CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING'>disable_quilting</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DISABLE_QUILTING_2"><a name='84'>
#endif<a name='85'>
<a name='86'>
<font color=#447700>!       CALL start()<a name='87'></font>
<a name='88'>
   <font color=#447700>!  Initialize the modules used by the WRF system.  <a name='89'></font>
   <font color=#447700>!  Many of the CALLs made from the<a name='90'></font>
   <font color=#447700>!  init_modules routine are NO-OPs.  Typical initializations <a name='91'></font>
   <font color=#447700>!  are: the size of a<a name='92'></font>
   <font color=#447700>!  REAL, setting the file handles to a pre-use value, defining moisture and<a name='93'></font>
   <font color=#447700>!  chemistry indices, etc.<a name='94'></font>
<a name='95'>
   CALL       wrf_debug ( 100 , 'ideal_hwrf: calling init_modules ' )<a name='96'>
<a name='97'>
<font color=#447700>!!!!   CALL init_modules<a name='98'></font>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_5">(1)   <font color=#447700>! Phase 1 returns after MPI_INIT() (if it is called)<a name='99'></font>
   CALL WRFU_Initialize( defaultCalKind=WRFU_CAL_GREGORIAN, rc=rc )<a name='100'>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_6">(2)   <font color=#447700>! Phase 2 resumes after MPI_INIT() (if it is called)<a name='101'></font>
<a name='102'>
   <font color=#447700>!  The configuration switches mostly come from the NAMELIST input.<a name='103'></font>
<a name='104'>
#ifdef DM_PARALLEL<a name='105'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='106'>
      write(message,*) 'call initial_config'<a name='107'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_405"> ( message )<a name='108'>
      CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_5"><a name='109'>
   ENDIF<a name='110'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_5">( configbuf, configbuflen, nbytes )<a name='111'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_108">( configbuf, nbytes )<a name='112'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_5">( configbuf, configbuflen )<a name='113'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_INITIALIZE'>wrf_dm_initialize</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_INITIALIZE_3"><a name='114'>
#else<a name='115'>
   CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_6"><a name='116'>
#endif<a name='117'>
<a name='118'>
   CALL <A href='../../html_code/share/module_check_a_mundo.F.html#CHECK_NML_CONSISTENCY'>check_nml_consistency</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_NML_CONSISTENCY_1"><a name='119'>
   CALL <A href='../../html_code/share/module_check_a_mundo.F.html#SET_PHYSICS_RCONFIGS'>set_physics_rconfigs</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICS_RCONFIGS_1"><a name='120'>
<a name='121'>
   CALL nl_get_debug_level ( 1, debug_level )<a name='122'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#SET_WRF_DEBUG_LEVEL'>set_wrf_debug_level</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_WRF_DEBUG_LEVEL_5"> ( debug_level )<a name='123'>
<a name='124'>
   CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_406"> ( program_name )<a name='125'>
<a name='126'>
   <font color=#447700>!  Allocate the space for the mother of all domains.<a name='127'></font>
<a name='128'>
   NULLIFY( null_domain )<a name='129'>
   CALL  wrf_debug ( 100 , 'ideal_hwrf: calling alloc_and_configure_domain ' )<a name='130'>
   CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_4"> ( domain_id  = 1           , &amp;<a name='131'>
                                     grid       = head_grid   , &amp;<a name='132'>
                                     parent     = null_domain , &amp;<a name='133'>
                                     kid        = -1            )<a name='134'>
<a name='135'>
   grid =&gt; head_grid<a name='136'>
<a name='137'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_2"><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='138'>
   CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_3"> ( grid )<a name='139'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_2">( grid, &amp;<a name='140'>
                          time_step_seconds=model_config_rec%interval_seconds )<a name='141'>
   CALL wrf_debug ( 100 , 'ideal_hwrf: calling set_scalar_indices_from_config ' )<a name='142'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_10"> ( grid%id , idum1, idum2 )<a name='143'>
<a name='144'>
   CALL     wrf_debug ( 100 , 'ideal_hwrf: calling model_to_grid_config_rec ' )<a name='145'>
<a name='146'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_21"> ( grid%id , model_config_rec , config_flags )<a name='147'>
<a name='148'>
   write(message,*) 'after model_to_grid_config_rec, e_we, e_sn are: ', &amp;<a name='149'>
                    config_flags%e_we, config_flags%e_sn<a name='150'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_407">(message)<a name='151'>
<a name='152'>
   <font color=#447700>!  Initialize the WRF IO: open files, init file handles, etc.<a name='153'></font>
<a name='154'>
   CALL       wrf_debug ( 100 , 'ideal_hwrf: calling init_wrfio' )<a name='155'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#INIT_WRFIO'>init_wrfio</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_WRFIO_3"><a name='156'>
<a name='157'>
<font color=#447700>!  Some of the configuration values may have been modified from the initial READ<a name='158'></font>
<font color=#447700>!  of the NAMELIST, so we re-broadcast the configuration records.<a name='159'></font>
<a name='160'>
#ifdef DM_PARALLEL<a name='161'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_308"> ( 100 , 'ideal_hwrf: re-broadcast the configuration records' )<a name='162'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_6">( configbuf, configbuflen, nbytes )<a name='163'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_109">( configbuf, nbytes )<a name='164'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_6">( configbuf, configbuflen )<a name='165'>
#endif<a name='166'>
<a name='167'>
   <font color=#447700>!   No looping in this layer.  <a name='168'></font>
<a name='169'>
   CALL <A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT'>med_sidata_input</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_SIDATA_INPUT_1"> ( grid , config_flags )<a name='170'>
<a name='171'>
   <font color=#447700>!  We are done.<a name='172'></font>
<a name='173'>
   CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_309"> (   0 , 'ideal_hwrf: SUCCESS COMPLETE IDEAL_HWRF INIT' )<a name='174'>
<a name='175'>
#ifdef DM_PARALLEL<a name='176'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SHUTDOWN'>wrf_dm_shutdown</A><A href='../../html_code/main/ideal_nmm.F.html#IDEAL_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_SHUTDOWN_2"><a name='177'>
#endif<a name='178'>
<a name='179'>
   CALL WRFU_Finalize( rc=rc )<a name='180'>
<a name='181'>
END PROGRAM ideal_nmm<a name='182'>
<a name='183'>
<A NAME='MED_SIDATA_INPUT'><A href='../../html_code/main/ideal_nmm.F.html#MED_SIDATA_INPUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='184'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>med_sidata_input</font> ( grid , config_flags ) <A href='../../call_to/MED_SIDATA_INPUT.html' TARGET='index'>3</A>,<A href='../../call_from/MED_SIDATA_INPUT.html' TARGET='index'>170</A><a name='185'>
  <font color=#447700>! Driver layer<a name='186'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_177"><a name='187'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_7"><a name='188'>
  <font color=#447700>! Model layer<a name='189'></font>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_117"><a name='190'>
   USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_1"><a name='191'>
   USE <A href='../../html_code/dyn_em/module_initialize_b_wave.F.html#MODULE_INITIALIZE_IDEAL'>module_initialize_ideal</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INITIALIZE_IDEAL_4"><a name='192'>
   USE <A href='../../html_code/share/module_optional_input.F.html#MODULE_OPTIONAL_INPUT'>module_optional_input</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_OPTIONAL_INPUT_3"><a name='193'>
#if ( WRF_CHEM == 1 )<a name='194'>
   USE module_input_chem_data<a name='195'>
   USE module_input_chem_bioemiss<a name='196'>
#endif<a name='197'>
<a name='198'>
   USE <A href='../../html_code/dyn_nmm/module_si_io_nmm.F.html#MODULE_SI_IO_NMM'>module_si_io_nmm</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SI_IO_NMM_1"><a name='199'>
<a name='200'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_2"><a name='201'>
<a name='202'>
   IMPLICIT NONE<a name='203'>
<a name='204'>
<a name='205'>
  <font color=#447700>! Interface <a name='206'></font>
   INTERFACE<a name='207'>
     SUBROUTINE start_domain ( grid , allowed_to_read )<a name='208'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_178"><a name='209'>
       TYPE (domain) grid<a name='210'>
       LOGICAL, INTENT(IN) :: allowed_to_read<a name='211'>
     END SUBROUTINE start_domain<a name='212'>
   END INTERFACE<a name='213'>
<a name='214'>
  <font color=#447700>! Arguments<a name='215'></font>
   TYPE(domain)                :: grid<a name='216'>
   TYPE (grid_config_rec_type) :: config_flags<a name='217'>
  <font color=#447700>! Local<a name='218'></font>
   INTEGER                :: time_step_begin_restart<a name='219'>
   INTEGER                :: idsi , ierr , myproc<a name='220'>
   CHARACTER (LEN=256)     :: si_inpname<a name='221'>
   CHARACTER (LEN=132)     :: message<a name='222'>
<a name='223'>
   CHARACTER(LEN=19) :: start_date_char , end_date_char , &amp;<a name='224'>
                        current_date_char , next_date_char<a name='225'>
<a name='226'>
   INTEGER :: time_loop_max , loop<a name='227'>
   INTEGER :: julyr , julday , LEN<a name='228'>
<a name='229'>
   INTEGER :: io_form_auxinput1<a name='230'>
   INTEGER, EXTERNAL :: use_package<a name='231'>
<a name='232'>
   LOGICAL :: using_binary_wrfsi<a name='233'>
<a name='234'>
   REAL :: gmt<a name='235'>
   REAL :: t1,t2<a name='236'>
<a name='237'>
   INTEGER :: numx_sm_levels_input,numx_st_levels_input<a name='238'>
   REAL,DIMENSION(100) :: smx_levels_input,stx_levels_input<a name='239'>
<a name='240'>
<a name='241'>
#ifdef DEREF_KLUDGE<a name='242'>
<font color=#447700>!  see http://www.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='243'></font>
   INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='244'>
   INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='245'>
   INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='246'>
#endif<a name='247'>
<a name='248'>
#if ( HWRF == 1 )<a name='249'>
  <font color=#447700>! Sam Says:<a name='250'></font>
<a name='251'>
  <font color=#447700>! The *INIT arrays are used to read init data written out by hwrf_prep_hybrid<a name='252'></font>
  REAL,ALLOCATABLE,DIMENSION(:,:,:)::TINIT,UINIT,VINIT,QINIT,CWMINIT<a name='253'>
  REAL,ALLOCATABLE,DIMENSION(:,:,:)::PINIT<a name='254'>
  REAL,ALLOCATABLE,DIMENSION(:,:)::PDINIT<a name='255'>
<a name='256'>
  <font color=#447700>! The *B arrays are used to read boundary data written out by hwrf_prep_hybrid<a name='257'></font>
  REAL,ALLOCATABLE,DIMENSION(:,:,:)::TB,UB,VB,QB,CWMB<a name='258'>
  REAL,ALLOCATABLE,DIMENSION(:,:)::PDB<a name='259'>
<a name='260'>
  INTEGER :: KB, LM, IM, JM, iunit_gfs, N<a name='261'>
<a name='262'>
  integer :: i,j,k<a name='263'>
  LOGICAL,EXTERNAL :: WRF_DM_ON_MONITOR<a name='264'>
  integer :: ids,ide, jds,jde, kds,kde<a name='265'>
  integer :: ims,ime, jms,jme, kms,kme<a name='266'>
  integer :: its,ite, jts,jte, kts,kte<a name='267'>
<a name='268'>
  integer :: ioerror<a name='269'>
#endif<a name='270'>
<a name='271'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_3"><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='272'>
<a name='273'>
<a name='274'>
   grid%input_from_file = .true.<a name='275'>
   grid%input_from_file = .false.<a name='276'>
<a name='277'>
   CALL <A href='../../html_code/main/real_nmm.F.html#COMPUTE_SI_START_AND_END'>compute_si_start_and_end</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_SI_START_AND_END_1"> ( model_config_rec%start_year  (grid%id) , &amp;<a name='278'>
                                   model_config_rec%start_month (grid%id) , &amp;<a name='279'>
                                   model_config_rec%start_day   (grid%id) , &amp;<a name='280'>
                                   model_config_rec%start_hour  (grid%id) , &amp;<a name='281'>
                                   model_config_rec%start_minute(grid%id) , &amp;<a name='282'>
                                   model_config_rec%start_second(grid%id) , &amp;<a name='283'>
                                   model_config_rec%  end_year  (grid%id) , &amp; <a name='284'>
                                   model_config_rec%  end_month (grid%id) , &amp;<a name='285'>
                                   model_config_rec%  end_day   (grid%id) , &amp;<a name='286'>
                                   model_config_rec%  end_hour  (grid%id) , &amp;<a name='287'>
                                   model_config_rec%  end_minute(grid%id) , &amp;<a name='288'>
                                   model_config_rec%  end_second(grid%id) , &amp;<a name='289'>
                                   model_config_rec%interval_seconds      , &amp;<a name='290'>
                                   model_config_rec%real_data_init_type   , &amp;<a name='291'>
                                   start_date_char , end_date_char , time_loop_max )<a name='292'>
<a name='293'>
   <font color=#447700>!  Here we define the initial time to process, for later use by the code.<a name='294'></font>
<a name='295'>
   current_date_char = start_date_char<a name='296'>
<font color=#447700>!   start_date = start_date_char // '.0000'<a name='297'></font>
   start_date = start_date_char <a name='298'>
   current_date = start_date<a name='299'>
<a name='300'>
   CALL nl_set_bdyfrq ( grid%id , REAL(model_config_rec%interval_seconds) )<a name='301'>
<a name='302'>
   <font color=#447700>!  Loop over each time period to process.<a name='303'></font>
<a name='304'>
   write(message,*) 'time_loop_max: ', time_loop_max<a name='305'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_408">(message)<a name='306'>
   DO loop = 1 , time_loop_max<a name='307'>
<a name='308'>
     internal_time_loop=loop<a name='309'>
                                                                                                                                              <a name='310'>
      write(message,*) 'loop=', loop<a name='311'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_409">(message)<a name='312'>
                                                                                                                                              <a name='313'>
      write(message,*) '-----------------------------------------------------------'<a name='314'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_410">(message)<a name='315'>
                      <a name='316'>
      write(message,*) ' '<a name='317'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_411">(message)<a name='318'>
      write(message,'(A,A,A,I2,A,I2)') ' Current date being processed: ', &amp;<a name='319'>
        current_date, ', which is loop #',loop,' out of ',time_loop_max<a name='320'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_412">(message)<a name='321'>
<a name='322'>
      <font color=#447700>!  After current_date has been set, fill in the julgmt stuff.<a name='323'></font>
<a name='324'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_JULGMT'>geth_julgmt</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_JULGMT_1"> ( config_flags%julyr , config_flags%julday , &amp;<a name='325'>
                                              config_flags%gmt )<a name='326'>
<a name='327'>
      <font color=#447700>!  Now that the specific Julian info is available, <a name='328'></font>
      <font color=#447700>!  save these in the model config record.<a name='329'></font>
<a name='330'>
      CALL nl_set_gmt (grid%id, config_flags%gmt)<a name='331'>
      CALL nl_set_julyr (grid%id, config_flags%julyr)<a name='332'>
      CALL nl_set_julday (grid%id, config_flags%julday)<a name='333'>
<a name='334'>
      CALL nl_get_io_form_auxinput1( 1, io_form_auxinput1 )<a name='335'>
      using_binary_wrfsi=.false.<a name='336'>
       <a name='337'>
       <a name='338'>
      write(message,*) 'TRIM(config_flags%auxinput1_inname): ', TRIM(config_flags%auxinput1_inname)<a name='339'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_413">(message)<a name='340'>
       <a name='341'>
#if ( HWRF == 1 )<a name='342'>
     ifph_onlyfirst: if(.not.grid%use_prep_hybrid .or. loop==1) then<a name='343'>
#endif<a name='344'>
      IF (config_flags%auxinput1_inname(1:10) .eq. 'real_input') THEN<a name='345'>
         using_binary_wrfsi=.true.<a name='346'>
      ENDIF<a name='347'>
<a name='348'>
      SELECT CASE ( use_package(io_form_auxinput1) )<a name='349'>
#if defined(NETCDF) <a name='350'>
      CASE ( IO_NETCDF )<a name='351'>
<a name='352'>
      <font color=#447700>!  Open the wrfinput file.<a name='353'></font>
<a name='354'>
        current_date_char(11:11)='_'<a name='355'>
 <a name='356'>
       WRITE ( wrf_err_message , FMT='(A,A)' )'med_sidata_input: calling open_r_dataset for ',TRIM(config_flags%auxinput1_inname)<a name='357'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_310"> ( 100 , wrf_err_message )<a name='358'>
       IF ( config_flags%auxinput1_inname(1:8) .NE. 'wrf_real' ) THEN<a name='359'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME4A'>construct_filename4a</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME4A_1">( si_inpname , config_flags%auxinput1_inname , grid%id , 2 , current_date_char , &amp;<a name='360'>
                                     config_flags%io_form_auxinput1 )<a name='361'>
       ELSE<a name='362'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_4">( si_inpname , config_flags%auxinput1_inname , grid%id , 2 , current_date_char )<a name='363'>
       END IF<a name='364'>
       CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_2"> ( idsi, TRIM(si_inpname) , grid , config_flags , "DATASET=AUXINPUT1", ierr )<a name='365'>
 <a name='366'>
       IF ( ierr .NE. 0 ) THEN<a name='367'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_387">( 'error opening ' // TRIM(si_inpname) // ' for input; bad date in namelist or file not in directory' )<a name='368'>
       ENDIF<a name='369'>
<a name='370'>
      <font color=#447700>!  Input data.<a name='371'></font>
<a name='372'>
      CALL wrf_debug (100, 'med_sidata_input: call input_auxinput1_wrf')<a name='373'>
<a name='374'>
      CALL input_auxinput1 ( idsi, grid, config_flags, ierr )<a name='375'>
<a name='376'>
      <font color=#447700>!  Possible optional SI input.  This sets flags used by init_domain.<a name='377'></font>
<a name='378'>
      IF ( loop .EQ. 1 ) THEN<a name='379'>
         CALL  wrf_debug (100, 'med_sidata_input: call init_module_optional_input' )<a name='380'>
         CALL <A href='../../html_code/share/module_optional_input.F.html#INIT_MODULE_OPTIONAL_INPUT'>init_module_optional_input</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULE_OPTIONAL_INPUT_1"> ( grid , config_flags )<a name='381'>
      CALL wrf_debug ( 100 , 'med_sidata_input: calling optional_input' )<a name='382'>
<font color=#447700>!<a name='383'></font>
      CALL <A href='../../html_code/share/module_optional_input.F.html#OPTIONAL_INPUT'>optional_input</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPTIONAL_INPUT_1"> ( grid , idsi , config_flags )<a name='384'>
	write(0,*) 'maxval st_input(1) within ideal_hwrf: ', maxval(st_input(:,1,:))<a name='385'>
      END IF<a name='386'>
<font color=#447700>!<a name='387'></font>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_3"> ( idsi , config_flags , "DATASET=AUXINPUT1" )<a name='388'>
<a name='389'>
#endif<a name='390'>
#ifdef INTIO<a name='391'>
      CASE ( IO_INTIO )<a name='392'>
<a name='393'>
      <font color=#447700>!  Possible optional SI input.  This sets flags used by init_domain.<a name='394'></font>
<a name='395'>
      IF ( loop .EQ. 1 ) THEN<a name='396'>
         CALL  wrf_debug (100, 'med_sidata_input: call init_module_optional_input' )<a name='397'>
         CALL <A href='../../html_code/share/module_optional_input.F.html#INIT_MODULE_OPTIONAL_INPUT'>init_module_optional_input</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULE_OPTIONAL_INPUT_2"> ( grid , config_flags )<a name='398'>
      END IF<a name='399'>
<a name='400'>
      IF (using_binary_wrfsi) THEN<a name='401'>
<a name='402'>
        current_date_char(11:11)='_'<a name='403'>
        CALL <A href='../../html_code/dyn_nmm/module_si_io_nmm.F.html#READ_SI'>read_si</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_SI_1"> ( grid, current_date_char )<a name='404'>
        current_date_char(11:11)='T'<a name='405'>
<a name='406'>
      ELSE<a name='407'>
                                                                                                                                              <a name='408'>
        write(message,*) 'binary WPS branch'<a name='409'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_414">(message)<a name='410'>
        current_date_char(11:11)='_'<a name='411'>
        CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME4A'>construct_filename4a</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME4A_2">( si_inpname , config_flags%auxinput1_inname , grid%id , 2 , current_date_char , &amp;<a name='412'>
                                     config_flags%io_form_auxinput1 )<a name='413'>
        CALL <A href='../../html_code/dyn_nmm/module_si_io_nmm.F.html#READ_WPS'>read_wps</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="READ_WPS_1"> ( grid, trim(si_inpname), current_date_char, config_flags%num_metgrid_levels )<a name='414'>
<font color=#447700>!!! bogus set some flags??<a name='415'></font>
      flag_metgrid=1<a name='416'>
      flag_soilhgt=1<a name='417'>
<a name='418'>
<a name='419'>
          ENDIF<a name='420'>
<a name='421'>
#endif<a name='422'>
      CASE DEFAULT<a name='423'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_388">('ideal_hwrf: not valid io_form_auxinput1')<a name='424'>
      END SELECT<a name='425'>
#if ( HWRF == 1 )<a name='426'>
     endif ifph_onlyfirst<a name='427'>
#endif<a name='428'>
<a name='429'>
      grid%islope=1<a name='430'>
      grid%vegfra=grid%vegfrc<a name='431'>
      grid%dfrlg=grid%dfl/9.81<a name='432'>
<a name='433'>
      grid%isurban=1<a name='434'>
      grid%isoilwater=14<a name='435'>
<a name='436'>
      <font color=#447700>!  Initialize the mother domain for this time period with input data.<a name='437'></font>
<a name='438'>
      CALL wrf_debug ( 100 , 'med_sidata_input: calling init_domain' )<a name='439'>
      grid%input_from_file = .true.<a name='440'>
<a name='441'>
      CALL <A href='../../html_code/dyn_em/module_initialize_b_wave.F.html#INIT_DOMAIN'>init_domain</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_DOMAIN_2"> ( grid )<a name='442'>
<a name='443'>
#if ( HWRF == 1 )<a name='444'>
     read_phinit: if(grid%use_prep_hybrid) then<a name='445'>
#if defined(DM_PARALLEL)<a name='446'>
        if(.not. wrf_dm_on_monitor()) then<a name='447'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_389">('ideal_hwrf: in use_prep_hybrid mode, threading and mpi are forbidden.')<a name='448'>
        endif<a name='449'>
#endif<a name='450'>
<a name='451'>
        ph_loop1: if(loop==1) then<a name='452'>
<a name='453'>
           <font color=#447700>! determine kds, ids, jds<a name='454'></font>
           SELECT CASE ( model_data_order )<a name='455'>
           CASE ( DATA_ORDER_ZXY )<a name='456'>
              kds = grid%sd31 ; kde = grid%ed31 ;<a name='457'>
              ids = grid%sd32 ; ide = grid%ed32 ;<a name='458'>
              jds = grid%sd33 ; jde = grid%ed33 ;<a name='459'>
<a name='460'>
              kms = grid%sm31 ; kme = grid%em31 ;<a name='461'>
              ims = grid%sm32 ; ime = grid%em32 ;<a name='462'>
              jms = grid%sm33 ; jme = grid%em33 ;<a name='463'>
<a name='464'>
              kts = grid%sp31 ; kte = grid%ep31 ; <font color=#447700>! tile is entire patch<a name='465'></font>
              its = grid%sp32 ; ite = grid%ep32 ; <font color=#447700>! tile is entire patch<a name='466'></font>
              jts = grid%sp33 ; jte = grid%ep33 ; <font color=#447700>! tile is entire patch<a name='467'></font>
<a name='468'>
           CASE ( DATA_ORDER_XYZ )<a name='469'>
              ids = grid%sd31 ; ide = grid%ed31 ;<a name='470'>
              jds = grid%sd32 ; jde = grid%ed32 ;<a name='471'>
              kds = grid%sd33 ; kde = grid%ed33 ;<a name='472'>
<a name='473'>
              ims = grid%sm31 ; ime = grid%em31 ;<a name='474'>
              jms = grid%sm32 ; jme = grid%em32 ;<a name='475'>
              kms = grid%sm33 ; kme = grid%em33 ;<a name='476'>
<a name='477'>
              its = grid%sp31 ; ite = grid%ep31 ; <font color=#447700>! tile is entire patch<a name='478'></font>
              jts = grid%sp32 ; jte = grid%ep32 ; <font color=#447700>! tile is entire patch<a name='479'></font>
              kts = grid%sp33 ; kte = grid%ep33 ; <font color=#447700>! tile is entire patch<a name='480'></font>
<a name='481'>
           CASE ( DATA_ORDER_XZY )<a name='482'>
              ids = grid%sd31 ; ide = grid%ed31 ;<a name='483'>
              kds = grid%sd32 ; kde = grid%ed32 ;<a name='484'>
              jds = grid%sd33 ; jde = grid%ed33 ;<a name='485'>
<a name='486'>
              ims = grid%sm31 ; ime = grid%em31 ;<a name='487'>
              kms = grid%sm32 ; kme = grid%em32 ;<a name='488'>
              jms = grid%sm33 ; jme = grid%em33 ;<a name='489'>
<a name='490'>
              its = grid%sp31 ; ite = grid%ep31 ; <font color=#447700>! tile is entire patch<a name='491'></font>
              kts = grid%sp32 ; kte = grid%ep32 ; <font color=#447700>! tile is entire patch<a name='492'></font>
              jts = grid%sp33 ; jte = grid%ep33 ; <font color=#447700>! tile is entire patch<a name='493'></font>
<a name='494'>
           END SELECT<a name='495'>
           <font color=#447700>! Allocate 3D initialization arrays:<a name='496'></font>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_415">('ALLOCATE PREP_HYBRID INIT ARRAYS')<a name='497'>
           ALLOCATE ( TINIT  (ids:(ide-1),kds:(kde-1)  ,jds:(jde-1)) )<a name='498'>
           ALLOCATE ( PINIT  (ids:(ide-1),kds:kde      ,jds:(jde-1)) )<a name='499'>
           ALLOCATE ( UINIT  (ids:(ide-1),kds:(kde-1)  ,jds:(jde-1)) )<a name='500'>
           ALLOCATE ( VINIT  (ids:(ide-1),kds:(kde-1)  ,jds:(jde-1)) )<a name='501'>
           ALLOCATE ( QINIT  (ids:(ide-1),kds:(kde-1)  ,jds:(jde-1)) )<a name='502'>
           ALLOCATE ( CWMINIT(ids:(ide-1),kds:(kde-1)  ,jds:(jde-1)) )<a name='503'>
           ALLOCATE ( PDINIT (ids:(ide-1),              jds:(jde-1)) )<a name='504'>
<a name='505'>
           REWIND 900<a name='506'>
           READ(900,iostat=ioerror) PDINIT,TINIT,QINIT,CWMINIT,UINIT,VINIT,PINIT<a name='507'>
           if(ioerror/=0) then<a name='508'>
              call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_390">('Unable to read MAKBND output from unit 900.')<a name='509'>
           endif<a name='510'>
           WRITE(0,*) 'U V T AT 10 10 10 ',UINIT(10,10,10),VINIT(10,10,10),TINIT(10,10,10)<a name='511'>
           <font color=#447700>! Switch from IKJ to IJK ordering<a name='512'></font>
           DO I = ids,ide-1<a name='513'>
              DO J = jds,jde-1<a name='514'>
                 grid%pd(I,J) = PDINIT(I,J)<a name='515'>
                 DO K = kds,kde-1<a name='516'>
                    grid%q2(I,J,K) = 0<a name='517'>
                    grid%u(I,J,K) = UINIT(I,K,J)<a name='518'>
                    grid%v(I,J,K) = VINIT(I,K,J)<a name='519'>
                    grid%t(I,J,K) = TINIT(I,K,J)<a name='520'>
                    grid%q(I,J,K) = QINIT(I,K,J)<a name='521'>
                    grid%cwm(I,J,K) = CWMINIT(I,K,J)<a name='522'>
                 ENDDO<a name='523'>
                 <font color=#447700>!  Was commented out in original V2 HWRF too:<a name='524'></font>
                 <font color=#447700>!      DO K = kds,kde<a name='525'></font>
                 <font color=#447700>!         grid%nmm_pint(I,J,K) = pinit(I,K,J)<a name='526'></font>
                 <font color=#447700>!      ENDDO<a name='527'></font>
              ENDDO<a name='528'>
           ENDDO<a name='529'>
<a name='530'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_416">('DEALLOCATE PREP_HYBRID INIT ARRAYS')<a name='531'>
           deallocate(TINIT,PINIT,UINIT,VINIT,QINIT,CWMINIT,PDINIT)<a name='532'>
        end if ph_loop1<a name='533'>
     end if read_phinit<a name='534'>
#endif<a name='535'>
<a name='536'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_22"> ( grid%id, model_config_rec, config_flags )<a name='537'>
<a name='538'>
      <font color=#447700>!  Close this file that is output from the SI and input to this pre-proc.<a name='539'></font>
<a name='540'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_311"> ( 100 , 'med_sidata_input: back from init_domain' )<a name='541'>
<a name='542'>
<a name='543'>
<font color=#447700>!!! not sure about this, but doesnt seem like needs to be called each time<a name='544'></font>
      IF ( loop .EQ. 1 ) THEN<a name='545'>
        CALL <A href='../../html_code/share/start_domain.F.html#START_DOMAIN'>start_domain</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_DOMAIN_1"> ( grid , .TRUE.)<a name='546'>
      END IF<a name='547'>
<a name='548'>
#if ( WRF_CHEM == 1 )<a name='549'>
      IF ( loop == 1 ) THEN<a name='550'>
<font color=#447700>!        IF ( ( grid%chem_opt .EQ. RADM2     ) .OR. &amp;<a name='551'></font>
<font color=#447700>!             ( grid%chem_opt .EQ. RADM2SORG ) .OR. &amp;<a name='552'></font>
<font color=#447700>!             ( grid%chem_opt .EQ. RACM      ) .OR. &amp;<a name='553'></font>
<font color=#447700>!             ( grid%chem_opt .EQ. RACMSORG  ) ) THEN<a name='554'></font>
         IF( grid%chem_opt &gt; 0 ) then<a name='555'>
           <font color=#447700>! Read the chemistry data from a previous wrf forecast (wrfout file)<a name='556'></font>
           IF(grid%chem_in_opt == 1 ) THEN<a name='557'>
              message = 'INITIALIZING CHEMISTRY WITH OLD SIMULATION'<a name='558'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_417"> ( message )<a name='559'>
<a name='560'>
              CALL input_ext_chem_file( grid )<a name='561'>
<a name='562'>
              IF(grid%bio_emiss_opt == BEIS311 ) THEN<a name='563'>
                 message = 'READING BEIS3.11 EMISSIONS DATA'<a name='564'>
                 CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_418"> ( message )<a name='565'>
                 CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS'>med_read_wrf_chem_bioemiss</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_BIOEMISS_5"> ( grid , config_flags)<a name='566'>
              else IF(grid%bio_emiss_opt == 3 ) THEN <font color=#447700>!shc<a name='567'></font>
                 message = 'READING MEGAN 2 EMISSIONS DATA'<a name='568'>
                 CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_419"> ( message )<a name='569'>
                 CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS'>med_read_wrf_chem_bioemiss</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_BIOEMISS_6"> ( grid , config_flags)<a name='570'>
              END IF<a name='571'>
<a name='572'>
           ELSEIF(grid%chem_in_opt == 0)then<a name='573'>
              <font color=#447700>! Generate chemistry data from a idealized vertical profile<a name='574'></font>
              message = 'STARTING WITH BACKGROUND CHEMISTRY '<a name='575'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_420"> ( message )<a name='576'>
<a name='577'>
              write(message,*)' ETA1 '<a name='578'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_421"> ( message )<a name='579'>
<font color=#447700>!             write(message,*) grid%eta1<a name='580'></font>
<font color=#447700>!             CALL  wrf_message ( message )<a name='581'></font>
<a name='582'>
              CALL input_chem_profile ( grid )<a name='583'>
<a name='584'>
              IF(grid%bio_emiss_opt == BEIS311 ) THEN<a name='585'>
                 message = 'READING BEIS3.11 EMISSIONS DATA'<a name='586'>
                 CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_422"> ( message )<a name='587'>
                 CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS'>med_read_wrf_chem_bioemiss</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_BIOEMISS_7"> ( grid , config_flags)<a name='588'>
              else IF(grid%bio_emiss_opt == 3 ) THEN <font color=#447700>!shc<a name='589'></font>
                 message = 'READING MEGAN 2 EMISSIONS DATA'<a name='590'>
                 CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_423"> ( message )<a name='591'>
                 CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS'>med_read_wrf_chem_bioemiss</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_BIOEMISS_8"> ( grid , config_flags)<a name='592'>
              END IF<a name='593'>
<a name='594'>
           ELSE<a name='595'>
             message = 'RUNNING WITHOUT CHEMISTRY INITIALIZATION'<a name='596'>
             CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_424"> ( message )<a name='597'>
           ENDIF<a name='598'>
         ENDIF<a name='599'>
      ENDIF<a name='600'>
#endif<a name='601'>
<a name='602'>
      config_flags%isurban=1<a name='603'>
      config_flags%isoilwater=14<a name='604'>
<a name='605'>
      CALL <A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT'>assemble_output</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ASSEMBLE_OUTPUT_1"> ( grid , config_flags , loop , time_loop_max )<a name='606'>
<a name='607'>
      <font color=#447700>!  Here we define the next time that we are going to process.<a name='608'></font>
<a name='609'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_2"> ( current_date_char , start_date_char , &amp;<a name='610'>
                          loop * model_config_rec%interval_seconds )<a name='611'>
      current_date =  current_date_char // '.0000'<a name='612'>
<a name='613'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_3">( grid, current_date(1:19) )<a name='614'>
<a name='615'>
      write(message,*) 'current_date= ', current_date<a name='616'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#MED_SIDATA_INPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_425">(message)<a name='617'>
<a name='618'>
   END DO<a name='619'>
END SUBROUTINE med_sidata_input<a name='620'>
<a name='621'>
<A NAME='COMPUTE_SI_START_AND_END'><A href='../../html_code/main/ideal_nmm.F.html#COMPUTE_SI_START_AND_END' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='622'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>compute_si_start_and_end</font> (  &amp; <A href='../../call_to/COMPUTE_SI_START_AND_END.html' TARGET='index'>3</A>,<A href='../../call_from/COMPUTE_SI_START_AND_END.html' TARGET='index'>10</A><a name='623'>
          start_year, start_month, start_day, start_hour, &amp;<a name='624'>
          start_minute, start_second, &amp;<a name='625'>
          end_year ,   end_month ,   end_day ,   end_hour , &amp;<a name='626'>
          end_minute ,   end_second , &amp;<a name='627'>
          interval_seconds , real_data_init_type , &amp;<a name='628'>
          start_date_char , end_date_char , time_loop_max )<a name='629'>
<a name='630'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/main/real_nmm.F.html#COMPUTE_SI_START_AND_END' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_3"><a name='631'>
<a name='632'>
   IMPLICIT NONE<a name='633'>
<a name='634'>
   INTEGER :: start_year , start_month , start_day , &amp;<a name='635'>
              start_hour , start_minute , start_second<a name='636'>
   INTEGER ::   end_year ,   end_month ,   end_day , &amp;<a name='637'>
                end_hour ,   end_minute ,   end_second<a name='638'>
   INTEGER :: interval_seconds , real_data_init_type<a name='639'>
   INTEGER :: time_loop_max , time_loop<a name='640'>
<a name='641'>
   CHARACTER(LEN=132) :: message<a name='642'>
   CHARACTER(LEN=19)  :: current_date_char , start_date_char , &amp;<a name='643'>
                        end_date_char , next_date_char<a name='644'>
<a name='645'>
<font color=#447700>!   WRITE ( start_date_char , FMT = &amp;<a name='646'></font>
<font color=#447700>!         '(I4.4,"-",I2.2,"-",I2.2,"_",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='647'></font>
<font color=#447700>!         start_year,start_month,start_day,start_hour,start_minute,start_second<a name='648'></font>
<font color=#447700>!   WRITE (   end_date_char , FMT = &amp;<a name='649'></font>
<font color=#447700>!         '(I4.4,"-",I2.2,"-",I2.2,"_",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='650'></font>
<font color=#447700>!          end_year,  end_month,  end_day,  end_hour,  end_minute,  end_second<a name='651'></font>
<a name='652'>
   WRITE ( start_date_char , FMT = &amp;<a name='653'>
         '(I4.4,"-",I2.2,"-",I2.2,"T",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='654'>
         start_year,start_month,start_day,start_hour,start_minute,start_second<a name='655'>
   WRITE (   end_date_char , FMT = &amp;<a name='656'>
         '(I4.4,"-",I2.2,"-",I2.2,"T",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='657'>
          end_year,  end_month,  end_day,  end_hour,  end_minute,  end_second<a name='658'>
<a name='659'>
<font color=#447700>!  start_date = start_date_char // '.0000'<a name='660'></font>
<a name='661'>
   <font color=#447700>!  Figure out our loop count for the processing times.<a name='662'></font>
<a name='663'>
   time_loop = 1<a name='664'>
   PRINT '(A,I4,A,A,A)','Time period #',time_loop, &amp;<a name='665'>
                        ' to process = ',start_date_char,'.'<a name='666'>
   current_date_char = start_date_char<a name='667'>
   loop_count : DO<a name='668'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/real_nmm.F.html#COMPUTE_SI_START_AND_END' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_3"> (next_date_char, current_date_char, interval_seconds )<a name='669'>
      IF      ( next_date_char .LT. end_date_char ) THEN<a name='670'>
         time_loop = time_loop + 1<a name='671'>
         PRINT '(A,I4,A,A,A)','Time period #',time_loop,&amp;<a name='672'>
                              ' to process = ',next_date_char,'.'<a name='673'>
         current_date_char = next_date_char<a name='674'>
      ELSE IF ( next_date_char .EQ. end_date_char ) THEN<a name='675'>
         time_loop = time_loop + 1<a name='676'>
         PRINT '(A,I4,A,A,A)','Time period #',time_loop,&amp;<a name='677'>
                              ' to process = ',next_date_char,'.'<a name='678'>
         PRINT '(A,I4,A)','Total analysis times to input = ',time_loop,'.'<a name='679'>
         time_loop_max = time_loop<a name='680'>
         EXIT loop_count<a name='681'>
      ELSE IF ( next_date_char .GT. end_date_char ) THEN<a name='682'>
         PRINT '(A,I4,A)','Total analysis times to input = ',time_loop,'.'<a name='683'>
         time_loop_max = time_loop<a name='684'>
         EXIT loop_count<a name='685'>
      END IF<a name='686'>
   END DO loop_count<a name='687'>
        write(message,*) 'done in si_start_and_end'<a name='688'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/real_nmm.F.html#COMPUTE_SI_START_AND_END' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_426">(message)<a name='689'>
END SUBROUTINE compute_si_start_and_end<a name='690'>
<a name='691'>
<A NAME='ASSEMBLE_OUTPUT'><A href='../../html_code/main/ideal_nmm.F.html#ASSEMBLE_OUTPUT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='692'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>assemble_output</font> ( grid , config_flags , loop , time_loop_max ) <A href='../../call_to/ASSEMBLE_OUTPUT.html' TARGET='index'>4</A>,<A href='../../call_from/ASSEMBLE_OUTPUT.html' TARGET='index'>248</A><a name='693'>
<a name='694'>
<font color=#447700>!!! replace with something?   USE module_big_step_utilities_em<a name='695'></font>
<a name='696'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_179"><a name='697'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_8"><a name='698'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_118"><a name='699'>
   USE <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_4"><a name='700'>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_12"><a name='701'>
   IMPLICIT NONE<a name='702'>
<a name='703'>
#if ( HWRF == 1 )<a name='704'>
  external get_wrf_debug_level<a name='705'>
  integer :: debug<a name='706'>
#endif<a name='707'>
<a name='708'>
   TYPE(domain)                 :: grid<a name='709'>
   TYPE (grid_config_rec_type)  :: config_flags<a name='710'>
   INTEGER , INTENT(IN)         :: loop , time_loop_max<a name='711'>
<a name='712'>
   INTEGER :: ids , ide , jds , jde , kds , kde<a name='713'>
   INTEGER :: ims , ime , jms , jme , kms , kme<a name='714'>
   INTEGER :: ips , ipe , jps , jpe , kps , kpe<a name='715'>
   INTEGER :: ijds , ijde , spec_bdy_width<a name='716'>
   INTEGER :: inc_h,inc_v<a name='717'>
   INTEGER :: i , j , k , idts<a name='718'>
<a name='719'>
   INTEGER :: id1 , interval_seconds , ierr, rc, sst_update<a name='720'>
   INTEGER , SAVE :: id ,id4<a name='721'>
   CHARACTER (LEN=80) :: inpname , bdyname<a name='722'>
   CHARACTER(LEN= 4) :: loop_char<a name='723'>
   CHARACTER(LEN=132) :: message<a name='724'>
character *19 :: temp19<a name='725'>
character *24 :: temp24 , temp24b<a name='726'>
<a name='727'>
   REAL, DIMENSION(:,:,:), ALLOCATABLE, SAVE :: ubdy3dtemp1 , vbdy3dtemp1 ,&amp;<a name='728'>
                                                tbdy3dtemp1 , &amp;<a name='729'>
				                cwmbdy3dtemp1 , qbdy3dtemp1,&amp;<a name='730'>
                                                q2bdy3dtemp1 , pdbdy2dtemp1<a name='731'>
   REAL, DIMENSION(:,:,:), ALLOCATABLE, SAVE :: ubdy3dtemp2 , vbdy3dtemp2 , &amp;<a name='732'>
                                                tbdy3dtemp2 , &amp; <a name='733'>
                                                cwmbdy3dtemp2 , qbdy3dtemp2, &amp;<a name='734'>
                                                q2bdy3dtemp2, pdbdy2dtemp2<a name='735'>
   REAL :: t1,t2<a name='736'>
<a name='737'>
#ifdef DEREF_KLUDGE<a name='738'>
<font color=#447700>!  see http://www.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='739'></font>
   INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='740'>
   INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='741'>
   INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='742'>
#endif<a name='743'>
<a name='744'>
#if ( HWRF == 1 )<a name='745'>
  <font color=#447700>! Sam says:<a name='746'></font>
<a name='747'>
  <font color=#447700>! The *B arrays are used to read boundary data written out by hwrf_prep_hybrid<a name='748'></font>
  REAL,ALLOCATABLE,DIMENSION(:,:,:)::TB,UB,VB,QB,CWMB<a name='749'>
  REAL,ALLOCATABLE,DIMENSION(:,:)::PDB<a name='750'>
<a name='751'>
  <font color=#447700>! Dimensions and looping variables:<a name='752'></font>
  INTEGER :: KB, LM, IM, JM, N<a name='753'>
<a name='754'>
  <font color=#447700>! Unit number to read boundary data from (changes each time)<a name='755'></font>
  INTEGER :: iunit_gfs<a name='756'>
<a name='757'>
  <font color=#447700>! Did we allocate the prep_hybrid input arrays?<a name='758'></font>
  LOGICAL :: alloc_ph_arrays<a name='759'>
<a name='760'>
  integer :: ioerror<a name='761'>
#endif<a name='762'>
<a name='763'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_4"><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='764'>
<a name='765'>
#if ( HWRF == 1 )<a name='766'>
  alloc_ph_arrays=.false.<a name='767'>
  call <A href='../../html_code/frame/wrf_debug.F.html#GET_WRF_DEBUG_LEVEL'>get_wrf_debug_level</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_WRF_DEBUG_LEVEL_4">(debug)<a name='768'>
#endif<a name='769'>
<a name='770'>
   <font color=#447700>!  Various sizes that we need to be concerned about.<a name='771'></font>
<a name='772'>
   ids = grid%sd31<a name='773'>
   ide = grid%ed31-1 <font color=#447700>! 030730tst<a name='774'></font>
   jds = grid%sd32<a name='775'>
   jde = grid%ed32-1 <font color=#447700>! 030730tst<a name='776'></font>
   kds = grid%sd33<a name='777'>
   kde = grid%ed33-1 <font color=#447700>! 030730tst<a name='778'></font>
<a name='779'>
   ims = grid%sm31<a name='780'>
   ime = grid%em31<a name='781'>
   jms = grid%sm32<a name='782'>
   jme = grid%em32<a name='783'>
   kms = grid%sm33<a name='784'>
   kme = grid%em33<a name='785'>
<a name='786'>
   ips = grid%sp31<a name='787'>
   ipe = grid%ep31-1 <font color=#447700>! 030730tst<a name='788'></font>
   jps = grid%sp32<a name='789'>
   jpe = grid%ep32-1 <font color=#447700>! 030730tst<a name='790'></font>
   kps = grid%sp33<a name='791'>
   kpe = grid%ep33-1 <font color=#447700>! 030730tst<a name='792'></font>
<a name='793'>
        if (IPE .ne. IDE) IPE=IPE+1<a name='794'>
        if (JPE .ne. JDE) JPE=JPE+1<a name='795'>
<a name='796'>
        write(message,*) 'assemble output (ids,ide): ', ids,ide<a name='797'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_427">(message)<a name='798'>
        write(message,*) 'assemble output (ims,ime): ', ims,ime<a name='799'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_428">(message)<a name='800'>
        write(message,*) 'assemble output (ips,ipe): ', ips,ipe<a name='801'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_429">(message)<a name='802'>
 <a name='803'>
        write(message,*) 'assemble output (jds,jde): ', jds,jde<a name='804'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_430">(message)<a name='805'>
        write(message,*) 'assemble output (jms,jme): ', jms,jme<a name='806'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_431">(message)<a name='807'>
        write(message,*) 'assemble output (jps,jpe): ', jps,jpe<a name='808'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_432">(message)<a name='809'>
 <a name='810'>
        write(message,*) 'assemble output (kds,kde): ', kds,kde<a name='811'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_433">(message)<a name='812'>
        write(message,*) 'assemble output (kms,kme): ', kms,kme<a name='813'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_434">(message)<a name='814'>
        write(message,*) 'assemble output (kps,kpe): ', kps,kpe<a name='815'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_435">(message)<a name='816'>
<a name='817'>
   ijds = MIN ( ids , jds )<a name='818'>
<font color=#447700>!mptest030805   ijde = MAX ( ide , jde )<a name='819'></font>
   ijde = MAX ( ide , jde ) + 1   <font color=#447700>! to make stuff_bdy dimensions consistent with alloc<a name='820'></font>
<a name='821'>
   <font color=#447700>!  Boundary width, scalar value.<a name='822'></font>
<a name='823'>
   spec_bdy_width = model_config_rec%spec_bdy_width<a name='824'>
   interval_seconds = model_config_rec%interval_seconds<a name='825'>
   sst_update = model_config_rec%sst_update<a name='826'>
<a name='827'>
<font color=#447700>!-----------------------------------------------------------------------<a name='828'></font>
<font color=#447700>!<a name='829'></font>
   main_loop_test: IF ( loop .EQ. 1 ) THEN<a name='830'>
<font color=#447700>!<a name='831'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='832'></font>
<a name='833'>
      IF ( time_loop_max .NE. 1 ) THEN<a name='834'>
         IF(sst_update .EQ. 1)THEN<a name='835'>
           CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_3">( inpname , 'wrflowinp' , grid%id , 2 )<a name='836'>
           CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_3"> ( id4, TRIM(inpname) , grid , config_flags , output_auxinput4 , "DATASET=AUXINPUT4", ierr )<a name='837'>
           IF ( ierr .NE. 0 ) THEN<a name='838'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_391">( 'ideal_hwrf: error opening wrflowinp for writing' )<a name='839'>
           END IF<a name='840'>
           CALL output_auxinput4 ( id4, grid , config_flags , ierr )<a name='841'>
         END IF<a name='842'>
      END IF<a name='843'>
<a name='844'>
<a name='845'>
   <font color=#447700>!  This is the space needed to save the current 3d data for use in computing<a name='846'></font>
   <font color=#447700>!  the lateral boundary tendencies.<a name='847'></font>
<a name='848'>
      ALLOCATE ( ubdy3dtemp1(ims:ime,jms:jme,kms:kme) )<a name='849'>
      ALLOCATE ( vbdy3dtemp1(ims:ime,jms:jme,kms:kme) )<a name='850'>
      ALLOCATE ( tbdy3dtemp1(ims:ime,jms:jme,kms:kme) )<a name='851'>
      ALLOCATE ( qbdy3dtemp1(ims:ime,jms:jme,kms:kme) )<a name='852'>
      ALLOCATE ( cwmbdy3dtemp1(ims:ime,jms:jme,kms:kme) )<a name='853'>
      ALLOCATE ( q2bdy3dtemp1(ims:ime,jms:jme,kms:kme) )<a name='854'>
      ALLOCATE ( pdbdy2dtemp1(ims:ime,jms:jme,1:1) )<a name='855'>
<a name='856'>
	ubdy3dtemp1=0.<a name='857'>
	vbdy3dtemp1=0.<a name='858'>
	tbdy3dtemp1=0.<a name='859'>
	qbdy3dtemp1=0.<a name='860'>
	cwmbdy3dtemp1=0.<a name='861'>
	q2bdy3dtemp1=0.<a name='862'>
	pdbdy2dtemp1=0.<a name='863'>
<a name='864'>
      ALLOCATE ( ubdy3dtemp2(ims:ime,jms:jme,kms:kme) )<a name='865'>
      ALLOCATE ( vbdy3dtemp2(ims:ime,jms:jme,kms:kme) )<a name='866'>
      ALLOCATE ( tbdy3dtemp2(ims:ime,jms:jme,kms:kme) )<a name='867'>
      ALLOCATE ( qbdy3dtemp2(ims:ime,jms:jme,kms:kme) )<a name='868'>
      ALLOCATE ( cwmbdy3dtemp2(ims:ime,jms:jme,kms:kme) )<a name='869'>
      ALLOCATE ( q2bdy3dtemp2(ims:ime,jms:jme,kms:kme) )<a name='870'>
      ALLOCATE ( pdbdy2dtemp2(ims:ime,jms:jme,1:1) )<a name='871'>
<a name='872'>
	ubdy3dtemp2=0.<a name='873'>
	vbdy3dtemp2=0.<a name='874'>
	tbdy3dtemp2=0.<a name='875'>
	qbdy3dtemp2=0.<a name='876'>
	cwmbdy3dtemp2=0.<a name='877'>
	q2bdy3dtemp2=0.<a name='878'>
	pdbdy2dtemp2=0.<a name='879'>
<a name='880'>
      <font color=#447700>!  Open the wrfinput file.  From this program, this is an *output* file.<a name='881'></font>
<a name='882'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_4">( inpname , 'wrfinput' , grid%id , 2 )<a name='883'>
<a name='884'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_4"> ( id1, TRIM(inpname) , grid , config_flags , &amp;<a name='885'>
                            output_input , "DATASET=INPUT", ierr )<a name='886'>
<a name='887'>
      IF ( ierr .NE. 0 ) THEN<a name='888'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_392">( 'ideal_hwrf: error opening wrfinput for writing' )<a name='889'>
      ENDIF<a name='890'>
<a name='891'>
<font color=#447700>!     CALL calc_current_date ( grid%id , 0. )<a name='892'></font>
<font color=#447700>!      grid%write_metadata = .true.<a name='893'></font>
<a name='894'>
        write(message,*) 'making call to output_input'<a name='895'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_436">(message)<a name='896'>
<a name='897'>
        CALL output_input ( id1, grid , config_flags , ierr )<a name='898'>
<a name='899'>
<font color=#447700>!***<a name='900'></font>
<font color=#447700>!***  CLOSE THE WRFINPUT DATASET<a name='901'></font>
<font color=#447700>!***<a name='902'></font>
      CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_4"> ( id1 , config_flags , "DATASET=INPUT" )<a name='903'>
<a name='904'>
      <font color=#447700>!  We need to save the 3d data to compute a <a name='905'></font>
      <font color=#447700>!  difference during the next loop. <a name='906'></font>
<a name='907'>
<font color=#447700>!<a name='908'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='909'></font>
<font color=#447700>!***  SOUTHERN BOUNDARY<a name='910'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='911'></font>
<font color=#447700>!<a name='912'></font>
<a name='913'>
        IF(JPS==JDS)THEN<a name='914'>
          J=1<a name='915'>
          DO k = kps , MIN(kde,kpe)<a name='916'>
          DO i = ips , MIN(ide,ipe)<a name='917'>
            ubdy3dtemp1(i,j,k) = grid%u(i,j,k)<a name='918'>
            vbdy3dtemp1(i,j,k) = grid%v(i,j,k)<a name='919'>
            tbdy3dtemp1(i,j,k) = grid%t(i,j,k)<a name='920'>
            qbdy3dtemp1(i,j,k) = grid%q(i,j,k)<a name='921'>
            cwmbdy3dtemp1(i,j,k) = grid%cwm(i,j,k)<a name='922'>
            q2bdy3dtemp1(i,j,k) = grid%q2(i,j,k)<a name='923'>
          END DO<a name='924'>
          END DO<a name='925'>
<a name='926'>
          DO i = ips , MIN(ide,ipe)<a name='927'>
            pdbdy2dtemp1(i,j,1) = grid%pd(i,j)<a name='928'>
          END DO<a name='929'>
        ENDIF<a name='930'>
<a name='931'>
<font color=#447700>!<a name='932'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='933'></font>
<font color=#447700>!***  NORTHERN BOUNDARY<a name='934'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='935'></font>
<font color=#447700>!<a name='936'></font>
        IF(JPE==JDE)THEN<a name='937'>
          J=MIN(JDE,JPE)<a name='938'>
          DO k = kps , MIN(kde,kpe)<a name='939'>
          DO i = ips , MIN(ide,ipe)<a name='940'>
            ubdy3dtemp1(i,j,k) = grid%u(i,j,k)<a name='941'>
            vbdy3dtemp1(i,j,k) = grid%v(i,j,k)<a name='942'>
            tbdy3dtemp1(i,j,k) = grid%t(i,j,k)<a name='943'>
            qbdy3dtemp1(i,j,k) = grid%q(i,j,k)<a name='944'>
            cwmbdy3dtemp1(i,j,k) = grid%cwm(i,j,k)<a name='945'>
            q2bdy3dtemp1(i,j,k) = grid%q2(i,j,k)<a name='946'>
          END DO<a name='947'>
          END DO<a name='948'>
<a name='949'>
          DO i = ips , MIN(ide,ipe)<a name='950'>
            pdbdy2dtemp1(i,j,1) = grid%pd(i,j)<a name='951'>
          END DO<a name='952'>
        ENDIF<a name='953'>
<a name='954'>
<font color=#447700>!<a name='955'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='956'></font>
<font color=#447700>!***  WESTERN BOUNDARY<a name='957'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='958'></font>
<font color=#447700>!<a name='959'></font>
        write(message,*) 'western boundary, store winds over J: ', jps, min(jpe,jde)<a name='960'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_437">(message)<a name='961'>
<a name='962'>
        IF(IPS==IDS)THEN<a name='963'>
          I=1<a name='964'>
          DO k = kps , MIN(kde,kpe)<a name='965'>
          inc_h=mod(jps+1,2)<a name='966'>
          DO j = jps+inc_h, min(jde,jpe),2<a name='967'>
<a name='968'>
        if (J .ge. 3 .and. J .le. JDE-2 .and. mod(J,2) .eq. 1) then<a name='969'>
            tbdy3dtemp1(i,j,k) = grid%t(i,j,k)<a name='970'>
            qbdy3dtemp1(i,j,k) = grid%q(i,j,k)<a name='971'>
            cwmbdy3dtemp1(i,j,k) = grid%cwm(i,j,k)<a name='972'>
            q2bdy3dtemp1(i,j,k) = grid%q2(i,j,k)<a name='973'>
      if(k==1)then<a name='974'>
        write(message,*)' loop=',loop,' i=',i,' j=',j,' tbdy3dtemp1(i,j,k)=',tbdy3dtemp1(i,j,k)<a name='975'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_312">(10,message)<a name='976'>
      endif<a name='977'>
	endif<a name='978'>
          END DO<a name='979'>
          END DO<a name='980'>
<a name='981'>
          DO k = kps , MIN(kde,kpe)<a name='982'>
          inc_v=mod(jps,2)<a name='983'>
          DO j = jps+inc_v, min(jde,jpe),2<a name='984'>
        if (J .ge. 2 .and. J .le. JDE-1 .and. mod(J,2) .eq. 0) then<a name='985'>
            ubdy3dtemp1(i,j,k) = grid%u(i,j,k)<a name='986'>
            vbdy3dtemp1(i,j,k) = grid%v(i,j,k)<a name='987'>
	endif<a name='988'>
          END DO<a name='989'>
          END DO<a name='990'>
<font color=#447700>!<a name='991'></font>
          inc_h=mod(jps+1,2)<a name='992'>
        DO j = jps+inc_h, min(jde,jpe),2<a name='993'>
        if (J .ge. 3 .and. J .le. JDE-2 .and. mod(J,2) .eq. 1) then<a name='994'>
            pdbdy2dtemp1(i,j,1) = grid%pd(i,j)<a name='995'>
          write(message,*)' loop=',loop,' i=',i,' j=',j,' pdbdy2dtemp1(i,j)=',pdbdy2dtemp1(i,j,1)<a name='996'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_313">(10,message)<a name='997'>
	endif<a name='998'>
          END DO<a name='999'>
        ENDIF<a name='1000'>
<font color=#447700>!<a name='1001'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1002'></font>
<font color=#447700>!***  EASTERN BOUNDARY<a name='1003'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1004'></font>
<font color=#447700>!<a name='1005'></font>
        IF(IPE==IDE)THEN<a name='1006'>
          I=MIN(IDE,IPE)<a name='1007'>
<font color=#447700>!<a name='1008'></font>
          DO k = kps , MIN(kde,kpe)<a name='1009'>
<font color=#447700>!<a name='1010'></font>
<font color=#447700>!***   Make sure the J loop is on the global boundary<a name='1011'></font>
<font color=#447700>!<a name='1012'></font>
          inc_h=mod(jps+1,2)<a name='1013'>
          DO j = jps+inc_h, min(jde,jpe),2<a name='1014'>
        if (J .ge. 3 .and. J .le. JDE-2 .and. mod(J,2) .eq. 1) then<a name='1015'>
            tbdy3dtemp1(i,j,k) = grid%t(i,j,k)<a name='1016'>
            qbdy3dtemp1(i,j,k) = grid%q(i,j,k)<a name='1017'>
            cwmbdy3dtemp1(i,j,k) = grid%cwm(i,j,k)<a name='1018'>
            q2bdy3dtemp1(i,j,k) = grid%q2(i,j,k)<a name='1019'>
	endif<a name='1020'>
          END DO<a name='1021'>
          END DO<a name='1022'>
<a name='1023'>
          DO k = kps , MIN(kde,kpe)<a name='1024'>
          inc_v=mod(jps,2)<a name='1025'>
          DO j = jps+inc_v, min(jde,jpe),2<a name='1026'>
        if (J .ge. 2 .and. J .le. JDE-1 .and. mod(J,2) .eq. 0) then<a name='1027'>
            ubdy3dtemp1(i,j,k) = grid%u(i,j,k)<a name='1028'>
            vbdy3dtemp1(i,j,k) = grid%v(i,j,k)<a name='1029'>
        endif<a name='1030'>
          END DO<a name='1031'>
          END DO<a name='1032'>
<font color=#447700>!<a name='1033'></font>
          inc_h=mod(jps+1,2)<a name='1034'>
          DO j = jps+inc_h, min(jde,jpe),2<a name='1035'>
        if (J .ge. 3 .and. J .le. JDE-2 .and. mod(J,2) .eq. 1) then<a name='1036'>
            pdbdy2dtemp1(i,j,1) = grid%pd(i,j)<a name='1037'>
	endif<a name='1038'>
          END DO<a name='1039'>
        ENDIF<a name='1040'>
<a name='1041'>
<a name='1042'>
      <font color=#447700>!  There are 2 components to the lateral boundaries.  <a name='1043'></font>
      <font color=#447700>!  First, there is the starting<a name='1044'></font>
      <font color=#447700>!  point of this time period - just the outer few rows and columns.<a name='1045'></font>
<a name='1046'>
<a name='1047'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_1"> (ubdy3dtemp1, grid%u_bxs, grid%u_bxe, &amp;<a name='1048'>
                                  grid%u_bys, grid%u_bye, &amp;<a name='1049'>
                                  'N', spec_bdy_width  , &amp;<a name='1050'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1051'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1052'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1053'>
<a name='1054'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_2"> (vbdy3dtemp1, grid%v_bxs, grid%v_bxe, &amp;<a name='1055'>
                                  grid%v_bys, grid%v_bye, &amp;<a name='1056'>
                                  'N', spec_bdy_width  , &amp;<a name='1057'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1058'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1059'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1060'>
<a name='1061'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_3"> (tbdy3dtemp1, grid%t_bxs, grid%t_bxe, &amp;<a name='1062'>
                                  grid%t_bys, grid%t_bye, &amp;<a name='1063'>
                                  'N', spec_bdy_width  , &amp;<a name='1064'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1065'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1066'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1067'>
<a name='1068'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_4"> (cwmbdy3dtemp1, grid%cwm_bxs, grid%cwm_bxe, &amp;<a name='1069'>
                                  grid%cwm_bys, grid%cwm_bye, &amp;<a name='1070'>
                                  'N', spec_bdy_width  , &amp;<a name='1071'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1072'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1073'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1074'>
<a name='1075'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_5"> (qbdy3dtemp1, grid%q_bxs, grid%q_bxe, &amp;<a name='1076'>
                                  grid%q_bys, grid%q_bye, &amp;<a name='1077'>
                                  'N', spec_bdy_width  , &amp;<a name='1078'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1079'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1080'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1081'>
<a name='1082'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_6"> (q2bdy3dtemp1, grid%q2_bxs, grid%q2_bxe, &amp;<a name='1083'>
                                  grid%q2_bys, grid%q2_bye, &amp;<a name='1084'>
                                  'N', spec_bdy_width  , &amp;<a name='1085'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1086'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1087'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1088'>
<a name='1089'>
<a name='1090'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_7"> (pdbdy2dtemp1, grid%pd_bxs, grid%pd_bxe, &amp;<a name='1091'>
                                   grid%pd_bys, grid%pd_bye, &amp;<a name='1092'>
                                   'M', spec_bdy_width, &amp;<a name='1093'>
                                   ids , ide+1 , jds , jde+1 , 1 , 1 , &amp;<a name='1094'>
                                   ims , ime , jms , jme , 1 , 1 , &amp;<a name='1095'>
                                   ips , ipe , jps , jpe , 1 , 1 )<a name='1096'>
<a name='1097'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1098'></font>
<font color=#447700>!<a name='1099'></font>
   ELSE IF ( loop .GT. 1 ) THEN<a name='1100'>
<font color=#447700>!<a name='1101'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1102'></font>
<a name='1103'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_314">(1,'LOOP&gt;1, so start making non-init boundary conditions')<a name='1104'>
#if ( HWRF == 1 )<a name='1105'>
<a name='1106'>
     bdytmp_useph: if(grid%use_prep_hybrid) then<a name='1107'>
        call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_315">(1,'ALLOCATE PREP_HYBRID BOUNDARY ARRAYS')<a name='1108'>
        <font color=#447700>!! When running in prep_hybrid mode, we must read in the data here.<a name='1109'></font>
<a name='1110'>
        <font color=#447700>! Allocate boundary arrays:<a name='1111'></font>
        KB = 2*IDE + JDE - 3<a name='1112'>
        LM = KDE<a name='1113'>
        IM = IDE<a name='1114'>
        JM = JDE<a name='1115'>
        ALLOCATE(TB(KB,LM,2))<a name='1116'>
        ALLOCATE(QB(KB,LM,2))<a name='1117'>
        ALLOCATE(CWMB(KB,LM,2))<a name='1118'>
        ALLOCATE(UB(KB,LM,2))<a name='1119'>
        ALLOCATE(VB(KB,LM,2))<a name='1120'>
        ALLOCATE(PDB(KB,2))<a name='1121'>
        alloc_ph_arrays=.true.<a name='1122'>
<a name='1123'>
        <font color=#447700>! Read in the data:<a name='1124'></font>
        IUNIT_GFS = 900 + LOOP - 1<a name='1125'>
        READ(IUNIT_GFS,iostat=ioerror) PDB,TB,QB,CWMB,UB,VB<a name='1126'>
        if(ioerror/=0) then<a name='1127'>
           write(message,*) 'Unable to read MAKBND output from unit ',IUNIT_GFS<a name='1128'>
           call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_393">(message)<a name='1129'>
        endif<a name='1130'>
<a name='1131'>
        <font color=#447700>! Now copy the data into the temporary boundary arrays, and<a name='1132'></font>
        <font color=#447700>! switch from IKJ to IJK while we do it.<a name='1133'></font>
<a name='1134'>
        <font color=#447700>!!    Southern boundary<a name='1135'></font>
<a name='1136'>
        IF(JPS.EQ.JDS)THEN<a name='1137'>
           J=1<a name='1138'>
<a name='1139'>
           DO k = kps , MIN(kde,kpe)<a name='1140'>
              N=1<a name='1141'>
              DO i = ips , MIN(ide,ipe)<a name='1142'>
                 tbdy3dtemp2(i,j,k) =   TB(N,k,1)<a name='1143'>
                 qbdy3dtemp2(i,j,k) =   QB(N,k,1)<a name='1144'>
                 cwmbdy3dtemp2(i,j,k) = CWMB(N,k,1)<a name='1145'>
                 q2bdy3dtemp2(i,j,k) =  0.0        <font color=#447700>!KWON<a name='1146'></font>
                 write(message,*)'southtend t',k,i,n,tbdy3dtemp2(i,j,k)<a name='1147'>
                 call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_316">(10,message)<a name='1148'>
                 write(message,*)'southtend q',k,i,n,qbdy3dtemp2(i,j,k)<a name='1149'>
                 call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_317">(10,message)<a name='1150'>
                 if (K .eq. 1 ) then<a name='1151'>
                    write(0,*) 'S boundary values T,Q : ', I,tbdy3dtemp2(i,j,k),  &amp;<a name='1152'>
                         qbdy3dtemp2(i,j,k)<a name='1153'>
                 endif<a name='1154'>
                 N=N+1<a name='1155'>
              END DO<a name='1156'>
           END DO<a name='1157'>
<a name='1158'>
           DO k = kps , MIN(kde,kpe)<a name='1159'>
              N=1<a name='1160'>
              DO i = ips , MIN(ide,ipe)<a name='1161'>
                 ubdy3dtemp2(i,j,k) = UB(N,k,1)<a name='1162'>
                 vbdy3dtemp2(i,j,k) = VB(N,k,1)<a name='1163'>
                 N=N+1<a name='1164'>
              ENDDO<a name='1165'>
           END DO<a name='1166'>
<a name='1167'>
           N=1<a name='1168'>
           DO i = ips , MIN(ide,ipe)<a name='1169'>
              pdbdy2dtemp2(i,j,1) = PDB(N,1)<a name='1170'>
              write(message,*)'southtend p',i,n,pdbdy2dtemp1(i,j,1)<a name='1171'>
              call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_318">(10,message)<a name='1172'>
              N=N+1<a name='1173'>
           END DO<a name='1174'>
<a name='1175'>
        ENDIF<a name='1176'>
<a name='1177'>
        <font color=#447700>!     Northern boundary<a name='1178'></font>
<a name='1179'>
        IF(JPE.EQ.JDE)THEN<a name='1180'>
<a name='1181'>
           J=MIN(JDE,JPE)<a name='1182'>
           DO k = kps , MIN(kde,kpe)<a name='1183'>
              N=IM+1<a name='1184'>
              DO i = ips , MIN(ide,ipe)<a name='1185'>
                 tbdy3dtemp2(i,j,k) =   TB(N,k,1)<a name='1186'>
                 qbdy3dtemp2(i,j,k) =   QB(N,k,1)<a name='1187'>
                 cwmbdy3dtemp2(i,j,k) = CWMB(N,k,1)<a name='1188'>
                 q2bdy3dtemp2(i,j,k) =  0.0        <font color=#447700>!KWON<a name='1189'></font>
                    write(message,*)'northtend t',k,i,n,tbdy3dtemp2(i,j,k)<a name='1190'>
                    call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_319">(10,message)<a name='1191'>
                    write(message,*)'northtend q',k,i,n,qbdy3dtemp2(i,j,k)<a name='1192'>
                    call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_320">(10,message)<a name='1193'>
                 N=N+1<a name='1194'>
              END DO<a name='1195'>
           END DO<a name='1196'>
<a name='1197'>
           DO k = kps , MIN(kde,kpe)<a name='1198'>
              N=IM<a name='1199'>
              DO i = ips , MIN(ide,ipe)<a name='1200'>
                 ubdy3dtemp2(i,j,k) = UB(N,k,1)<a name='1201'>
                 vbdy3dtemp2(i,j,k) = VB(N,k,1)<a name='1202'>
                 N=N+1<a name='1203'>
              END DO<a name='1204'>
           END DO<a name='1205'>
<a name='1206'>
           N=IM+1<a name='1207'>
           DO i = ips , MIN(ide,ipe)<a name='1208'>
              pdbdy2dtemp2(i,j,1) = PDB(N,1)<a name='1209'>
                 write(message,*)'northtend p',i,n,pdbdy2dtemp1(i,j,1)<a name='1210'>
                 call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_321">(10,message)<a name='1211'>
              N=N+1<a name='1212'>
           END DO<a name='1213'>
<a name='1214'>
        ENDIF<a name='1215'>
<a name='1216'>
        <font color=#447700>!!     Western boundary<a name='1217'></font>
<a name='1218'>
        IF(IPS.EQ.IDS)THEN<a name='1219'>
           I=1<a name='1220'>
           DO k = kps , MIN(kde,kpe)<a name='1221'>
              N=2*IM+1<a name='1222'>
              inc_h=mod(jps+1,2)<a name='1223'>
              DO j = jps+inc_h, MIN(jde,jpe),2<a name='1224'>
                 if (J .ge. 3 .and. J .le. jde-2 .and. mod(J,2) .eq. 1) then<a name='1225'>
                    tbdy3dtemp2(i,j,k) =   TB(N,k,1)<a name='1226'>
                    qbdy3dtemp2(i,j,k) =   QB(N,k,1)<a name='1227'>
                    cwmbdy3dtemp2(i,j,k) = CWMB(N,k,1)<a name='1228'>
                    q2bdy3dtemp2(i,j,k) =  0.0        <font color=#447700>!KWON<a name='1229'></font>
                       write(message,*)'westtend t',k,j,n,tbdy3dtemp2(i,j,k)<a name='1230'>
                       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_322">(10,message)<a name='1231'>
                       write(message,*)'westtend q',k,j,n,qbdy3dtemp2(i,j,k)<a name='1232'>
                       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_323">(10,message)<a name='1233'>
                    N=N+1<a name='1234'>
                 endif<a name='1235'>
              END DO<a name='1236'>
           END DO<a name='1237'>
<a name='1238'>
           DO k = kps , MIN(kde,kpe)<a name='1239'>
              N=2*IM-1<a name='1240'>
              inc_v=mod(jps,2)<a name='1241'>
              DO j = jps+inc_v, MIN(jde,jpe),2<a name='1242'>
                 if (J .ge. 2 .and. J .le. jde-1 .and. mod(J,2) .eq. 0) then<a name='1243'>
                    ubdy3dtemp2(i,j,k) = UB(N,k,1)<a name='1244'>
                    vbdy3dtemp2(i,j,k) = VB(N,k,1)<a name='1245'>
                    N=N+1<a name='1246'>
                 endif<a name='1247'>
              END DO<a name='1248'>
           END DO<a name='1249'>
<a name='1250'>
           N=2*IM+1<a name='1251'>
           inc_h=mod(jps+1,2)<a name='1252'>
           DO j = jps+inc_h, MIN(jde,jpe),2<a name='1253'>
              if (J .ge. 3 .and. J .le. jde-2 .and. mod(J,2) .eq. 1) then<a name='1254'>
                 pdbdy2dtemp2(i,j,1) = PDB(N,1)<a name='1255'>
                    write(message,*)'westtend p',j,n,pdbdy2dtemp1(i,j,1)<a name='1256'>
                    call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_324">(10,message)<a name='1257'>
                 N=N+1<a name='1258'>
              endif<a name='1259'>
           END DO<a name='1260'>
<a name='1261'>
        ENDIF<a name='1262'>
<a name='1263'>
        <font color=#447700>!!     Eastern boundary<a name='1264'></font>
<a name='1265'>
        IF(IPE.EQ.IDE)THEN<a name='1266'>
<a name='1267'>
           I=MIN(IDE,IPE)<a name='1268'>
<a name='1269'>
           DO k = kps , MIN(kde,kpe)<a name='1270'>
              N=2*IM+(JM/2)<a name='1271'>
              inc_h=mod(jps+1,2)<a name='1272'>
              DO j = jps+inc_h, MIN(jde,jpe),2<a name='1273'>
                 if (J .ge. 3 .and. J .le. jde-2 .and. mod(J,2) .eq. 1) then<a name='1274'>
                    tbdy3dtemp2(i,j,k) =   TB(N,k,1)<a name='1275'>
                    qbdy3dtemp2(i,j,k) =   QB(N,k,1)<a name='1276'>
                    cwmbdy3dtemp2(i,j,k) = CWMB(N,k,1)<a name='1277'>
                    q2bdy3dtemp2(i,j,k) =  0.0        <font color=#447700>!KWON<a name='1278'></font>
                       write(message,*)'easttend t',k,j,n,tbdy3dtemp2(i,j,k)<a name='1279'>
                       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_325">(10,message)<a name='1280'>
                       write(message,*)'easttend q',k,j,n,qbdy3dtemp2(i,j,k)<a name='1281'>
                       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_326">(10,message)<a name='1282'>
                    N=N+1<a name='1283'>
                 endif<a name='1284'>
              END DO<a name='1285'>
           END DO<a name='1286'>
<a name='1287'>
           DO k = kps , MIN(kde,kpe)<a name='1288'>
              N=2*IM+(JM/2)-1<a name='1289'>
              inc_v=mod(jps,2)<a name='1290'>
              DO j = jps+inc_v, MIN(jde,jpe),2<a name='1291'>
                 if (J .ge. 2 .and. J .le. jde-1 .and. mod(J,2) .eq. 0) then<a name='1292'>
                    ubdy3dtemp2(i,j,k) = UB(N,k,1)<a name='1293'>
                    vbdy3dtemp2(i,j,k) = VB(N,k,1)<a name='1294'>
                    N=N+1<a name='1295'>
                 endif<a name='1296'>
              END DO<a name='1297'>
           END DO<a name='1298'>
<a name='1299'>
           N=2*IM+(JM/2)<a name='1300'>
           inc_h=mod(jps+1,2)<a name='1301'>
           DO j = jps+inc_h, MIN(jde,jpe),2<a name='1302'>
              if (J .ge. 3 .and. J .le. jde-2 .and. mod(J,2) .eq. 1) then<a name='1303'>
                 pdbdy2dtemp2(i,j,1) = PDB(N,1)<a name='1304'>
                    write(message,*)'easttend p',j,n,pdbdy2dtemp1(i,j,1)<a name='1305'>
                    call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_327">(10,message)<a name='1306'>
                 N=N+1<a name='1307'>
              endif<a name='1308'>
           END DO<a name='1309'>
<a name='1310'>
        ENDIF<a name='1311'>
     else<a name='1312'>
#endif<a name='1313'>
<a name='1314'>
           CALL output_auxinput4 ( id4, grid , config_flags , ierr )<a name='1315'>
<a name='1316'>
#if ( HWRF == 1 )<a name='1317'>
     endif bdytmp_useph<a name='1318'>
#endif<a name='1319'>
<a name='1320'>
      write(message,*)' assemble_output loop=',loop,' in IF block'<a name='1321'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_438">(message)<a name='1322'>
<a name='1323'>
      <font color=#447700>!  Open the boundary file.<a name='1324'></font>
<a name='1325'>
      IF ( loop .eq. 2 ) THEN<a name='1326'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_5">( bdyname , 'wrfbdy' , grid%id , 2 )<a name='1327'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_5"> ( id, TRIM(bdyname) , grid , config_flags , &amp;<a name='1328'>
                          output_boundary , "DATASET=BOUNDARY", ierr )<a name='1329'>
         IF ( ierr .NE. 0 ) THEN<a name='1330'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_394">( 'ideal_hwrf: error opening wrfbdy for writing' )<a name='1331'>
         ENDIF<a name='1332'>
<font color=#447700>!         grid%write_metadata = .true.<a name='1333'></font>
      ELSE<a name='1334'>
<font color=#447700>! what's this do?<a name='1335'></font>
<font color=#447700>!         grid%write_metadata = .true.<a name='1336'></font>
<font color=#447700>!         grid%write_metadata = .false.<a name='1337'></font>
         CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCKADVANCE'>domain_clockadvance</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCKADVANCE_2">( grid )<a name='1338'>
      END IF<a name='1339'>
<a name='1340'>
#if ( HWRF == 1 )<a name='1341'>
     bdytmp_notph: if(.not.grid%use_prep_hybrid) then<a name='1342'>
#endif<a name='1343'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1344'></font>
<font color=#447700>!***  SOUTHERN BOUNDARY<a name='1345'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1346'></font>
<font color=#447700>!<a name='1347'></font>
        IF(JPS==JDS)THEN<a name='1348'>
          J=1<a name='1349'>
          DO k = kps , MIN(kde,kpe)<a name='1350'>
          DO i = ips , MIN(ide,ipe)<a name='1351'>
            ubdy3dtemp2(i,j,k) = grid%u(i,j,k)<a name='1352'>
            vbdy3dtemp2(i,j,k) = grid%v(i,j,k)<a name='1353'>
            tbdy3dtemp2(i,j,k) = grid%t(i,j,k)<a name='1354'>
            qbdy3dtemp2(i,j,k) = grid%q(i,j,k)<a name='1355'>
            cwmbdy3dtemp2(i,j,k) = grid%cwm(i,j,k)<a name='1356'>
            q2bdy3dtemp2(i,j,k) = grid%q2(i,j,k)<a name='1357'>
          END DO<a name='1358'>
          END DO<a name='1359'>
<font color=#447700>!<a name='1360'></font>
          DO i = ips , MIN(ide,ipe)<a name='1361'>
            pdbdy2dtemp2(i,j,1) = grid%pd(i,j)<a name='1362'>
          END DO<a name='1363'>
        ENDIF<a name='1364'>
<a name='1365'>
<font color=#447700>!<a name='1366'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1367'></font>
<font color=#447700>!***  NORTHERN BOUNDARY<a name='1368'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1369'></font>
<font color=#447700>!<a name='1370'></font>
        IF(JPE==JDE)THEN<a name='1371'>
          J=MIN(JDE,JPE)<a name='1372'>
          DO k = kps , MIN(kde,kpe)<a name='1373'>
          DO i = ips , MIN(ide,ipe)<a name='1374'>
            ubdy3dtemp2(i,j,k) = grid%u(i,j,k)<a name='1375'>
            vbdy3dtemp2(i,j,k) = grid%v(i,j,k)<a name='1376'>
            tbdy3dtemp2(i,j,k) = grid%t(i,j,k)<a name='1377'>
            qbdy3dtemp2(i,j,k) = grid%q(i,j,k)<a name='1378'>
            cwmbdy3dtemp2(i,j,k) = grid%cwm(i,j,k)<a name='1379'>
            q2bdy3dtemp2(i,j,k) = grid%q2(i,j,k)<a name='1380'>
          END DO<a name='1381'>
          END DO<a name='1382'>
<a name='1383'>
          DO i = ips , MIN(ide,ipe)<a name='1384'>
            pdbdy2dtemp2(i,j,1) = grid%pd(i,j)<a name='1385'>
          END DO<a name='1386'>
        ENDIF<a name='1387'>
<font color=#447700>!<a name='1388'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1389'></font>
<font color=#447700>!***  WESTERN BOUNDARY<a name='1390'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1391'></font>
<font color=#447700>!<a name='1392'></font>
        IF(IPS==IDS)THEN<a name='1393'>
          I=1<a name='1394'>
          DO k = kps , MIN(kde,kpe)<a name='1395'>
          inc_h=mod(jps+1,2)<a name='1396'>
      if(k==1)then<a name='1397'>
        write(message,*)' assemble_ouput loop=',loop,' inc_h=',inc_h,' jps=',jps<a name='1398'>
        call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_328">(10,message)<a name='1399'>
      endif<a name='1400'>
          DO j = jps+inc_h, MIN(jde,jpe),2<a name='1401'>
        if (J .ge. 3 .and. J .le. jde-2 .and. mod(J,2) .eq. 1) then<a name='1402'>
            tbdy3dtemp2(i,j,k) = grid%t(i,j,k)<a name='1403'>
      if(k==1)then<a name='1404'>
        write(message,*)' loop=',loop,' i=',i,' j=',j,' tbdy3dtemp1(i,j,k)=',tbdy3dtemp1(i,j,k)<a name='1405'>
        call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_329">(10,message)<a name='1406'>
      endif<a name='1407'>
            qbdy3dtemp2(i,j,k) = grid%q(i,j,k)<a name='1408'>
            cwmbdy3dtemp2(i,j,k) = grid%cwm(i,j,k)<a name='1409'>
            q2bdy3dtemp2(i,j,k) = grid%q2(i,j,k)<a name='1410'>
	endif<a name='1411'>
          END DO<a name='1412'>
          END DO<a name='1413'>
<font color=#447700>!<a name='1414'></font>
          DO k = kps , MIN(kde,kpe)<a name='1415'>
          inc_v=mod(jps,2)<a name='1416'>
          DO j = jps+inc_v, MIN(jde,jpe),2<a name='1417'>
        if (J .ge. 2 .and. J .le. jde-1 .and. mod(J,2) .eq. 0) then<a name='1418'>
            ubdy3dtemp2(i,j,k) = grid%u(i,j,k)<a name='1419'>
            vbdy3dtemp2(i,j,k) = grid%v(i,j,k)<a name='1420'>
	endif<a name='1421'>
          END DO<a name='1422'>
          END DO<a name='1423'>
<a name='1424'>
          inc_h=mod(jps+1,2)<a name='1425'>
        DO j = jps+inc_h, MIN(jde,jpe),2<a name='1426'>
        if (J .ge. 3 .and. J .le. jde-2 .and. mod(J,2) .eq. 1) then<a name='1427'>
          pdbdy2dtemp2(i,j,1) = grid%pd(i,j)<a name='1428'>
          write(message,*)' loop=',loop,' i=',i,' j=',j,' pdbdy2dtemp1(i,j)=',pdbdy2dtemp1(i,j,1)<a name='1429'>
          CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_330">(10,message)<a name='1430'>
	endif<a name='1431'>
          END DO<a name='1432'>
        ENDIF<a name='1433'>
<font color=#447700>!<a name='1434'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1435'></font>
<font color=#447700>!***  EASTERN BOUNDARY<a name='1436'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1437'></font>
<font color=#447700>!<a name='1438'></font>
        IF(IPE==IDE)THEN<a name='1439'>
          I=MIN(IDE,IPE)<a name='1440'>
<a name='1441'>
          DO k = kps , MIN(kde,kpe)<a name='1442'>
          inc_h=mod(jps+1,2)<a name='1443'>
          DO j = jps+inc_h, MIN(jde,jpe),2<a name='1444'>
        if (J .ge. 3 .and. J .le. jde-2 .and. mod(J,2) .eq. 1) then<a name='1445'>
            tbdy3dtemp2(i,j,k) = grid%t(i,j,k)<a name='1446'>
            qbdy3dtemp2(i,j,k) = grid%q(i,j,k)<a name='1447'>
            cwmbdy3dtemp2(i,j,k) = grid%cwm(i,j,k)<a name='1448'>
            q2bdy3dtemp2(i,j,k) = grid%q2(i,j,k)<a name='1449'>
	endif<a name='1450'>
          END DO<a name='1451'>
          END DO<a name='1452'>
<a name='1453'>
          DO k = kps , MIN(kde,kpe)<a name='1454'>
          inc_v=mod(jps,2)<a name='1455'>
          DO j = jps+inc_v, MIN(jde,jpe),2<a name='1456'>
        if (J .ge. 2 .and. J .le. jde-1 .and. mod(J,2) .eq. 0) then<a name='1457'>
            ubdy3dtemp2(i,j,k) = grid%u(i,j,k)<a name='1458'>
            vbdy3dtemp2(i,j,k) = grid%v(i,j,k)<a name='1459'>
	endif<a name='1460'>
          END DO<a name='1461'>
          END DO<a name='1462'>
<a name='1463'>
          inc_h=mod(jps+1,2)<a name='1464'>
          DO j = jps+inc_h, MIN(jde,jpe),2<a name='1465'>
        if (J .ge. 3 .and. J .le. jde-2 .and. mod(J,2) .eq. 1) then<a name='1466'>
            pdbdy2dtemp2(i,j,1) = grid%pd(i,j)<a name='1467'>
	endif<a name='1468'>
          END DO<a name='1469'>
        ENDIF<a name='1470'>
#if ( HWRF == 1 )<a name='1471'>
     endif bdytmp_notph<a name='1472'>
#endif<a name='1473'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1474'></font>
      <font color=#447700>!  During all of the loops after the first loop, <a name='1475'></font>
      <font color=#447700>!  we first compute the boundary<a name='1476'></font>
      <font color=#447700>!  tendencies with the current data values <a name='1477'></font>
      <font color=#447700>!  (*bdy3dtemp2 arrays) and the previously <a name='1478'></font>
      <font color=#447700>!  saved information stored in the *bdy3dtemp1 arrays.<a name='1479'></font>
<a name='1480'>
<a name='1481'>
      CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND_IJK'>stuff_bdytend_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_IJK_1"> ( ubdy3dtemp2 , ubdy3dtemp1 , REAL(interval_seconds),&amp;<a name='1482'>
                                   grid%u_btxs, grid%u_btxe, &amp;<a name='1483'>
                                   grid%u_btys, grid%u_btye, &amp;<a name='1484'>
                                   'N',  spec_bdy_width      , &amp;<a name='1485'>
                                   ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1486'>
                                   ims , ime , jms , jme , kms , kme , &amp;<a name='1487'>
                                   ips , ipe , jps , jpe , kps , kpe+1 )<a name='1488'>
<a name='1489'>
      CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND_IJK'>stuff_bdytend_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_IJK_2"> ( vbdy3dtemp2 , vbdy3dtemp1 , REAL(interval_seconds),&amp;<a name='1490'>
                                   grid%v_btxs, grid%v_btxe, &amp;<a name='1491'>
                                   grid%v_btys, grid%v_btye, &amp;<a name='1492'>
                                   'N',  spec_bdy_width      , &amp;<a name='1493'>
                                   ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1494'>
                                   ims , ime , jms , jme , kms , kme , &amp;<a name='1495'>
                                   ips , ipe , jps , jpe , kps , kpe+1 )<a name='1496'>
<a name='1497'>
      CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND_IJK'>stuff_bdytend_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_IJK_3"> ( tbdy3dtemp2 , tbdy3dtemp1 , REAL(interval_seconds),&amp;<a name='1498'>
                                   grid%t_btxs, grid%t_btxe, &amp;<a name='1499'>
                                   grid%t_btys, grid%t_btye, &amp;<a name='1500'>
                                   'N',  spec_bdy_width      , &amp;<a name='1501'>
                                   ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1502'>
                                   ims , ime , jms , jme , kms , kme , &amp;<a name='1503'>
                                   ips , ipe , jps , jpe , kps , kpe+1 )<a name='1504'>
<a name='1505'>
      CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND_IJK'>stuff_bdytend_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_IJK_4"> ( cwmbdy3dtemp2 , cwmbdy3dtemp1 , REAL(interval_seconds),&amp;<a name='1506'>
                                   grid%cwm_btxs, grid%cwm_btxe, &amp;<a name='1507'>
                                   grid%cwm_btys, grid%cwm_btye, &amp;<a name='1508'>
                                   'N',  spec_bdy_width      , &amp;<a name='1509'>
                                   ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1510'>
                                   ims , ime , jms , jme , kms , kme , &amp;<a name='1511'>
                                   ips , ipe , jps , jpe , kps , kpe+1 )<a name='1512'>
<a name='1513'>
      CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND_IJK'>stuff_bdytend_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_IJK_5"> ( qbdy3dtemp2 , qbdy3dtemp1 , REAL(interval_seconds),&amp;<a name='1514'>
                                   grid%q_btxs, grid%q_btxe, &amp;<a name='1515'>
                                   grid%q_btys, grid%q_btye, &amp;<a name='1516'>
                                   'N',  spec_bdy_width      , &amp;<a name='1517'>
                                   ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1518'>
                                   ims , ime , jms , jme , kms , kme , &amp;<a name='1519'>
                                   ips , ipe , jps , jpe , kps , kpe+1 )<a name='1520'>
<a name='1521'>
      CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND_IJK'>stuff_bdytend_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_IJK_6"> ( q2bdy3dtemp2 , q2bdy3dtemp1 , REAL(interval_seconds),&amp;<a name='1522'>
                                   grid%q2_btxs, grid%q2_btxe, &amp;<a name='1523'>
                                   grid%q2_btys, grid%q2_btye, &amp;<a name='1524'>
                                   'N',  spec_bdy_width      , &amp;<a name='1525'>
                                   ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1526'>
                                   ims , ime , jms , jme , kms , kme , &amp;<a name='1527'>
                                   ips , ipe , jps , jpe , kps , kpe+1 )<a name='1528'>
<a name='1529'>
      CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND_IJK'>stuff_bdytend_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_IJK_7">( pdbdy2dtemp2 , pdbdy2dtemp1, REAL(interval_seconds),&amp;<a name='1530'>
                                   grid%pd_btxs, grid%pd_btxe, &amp;<a name='1531'>
                                   grid%pd_btys, grid%pd_btye, &amp;<a name='1532'>
                                   'M',  spec_bdy_width      , &amp;<a name='1533'>
                                   ids , ide+1 , jds , jde+1 , 1 , 1 , &amp;<a name='1534'>
                                   ims , ime   , jms , jme   , 1 , 1 , &amp;<a name='1535'>
                                   ips , ipe   , jps , jpe   , 1 , 1 )<a name='1536'>
<a name='1537'>
<a name='1538'>
<a name='1539'>
      <font color=#447700>!  Both pieces of the boundary data are now <a name='1540'></font>
      <font color=#447700>!  available to be written (initial time and tendency).<a name='1541'></font>
      <font color=#447700>!  This looks ugly, these date shifting things.  <a name='1542'></font>
      <font color=#447700>!  What's it for?  We want the "Times" variable<a name='1543'></font>
      <font color=#447700>!  in the lateral BDY file to have the valid times <a name='1544'></font>
      <font color=#447700>!  of when the initial fields are written.<a name='1545'></font>
      <font color=#447700>!  That's what the loop-2 thingy is for with the start date.  <a name='1546'></font>
      <font color=#447700>!  We increment the start_date so<a name='1547'></font>
      <font color=#447700>!  that the starting time in the attributes is the <a name='1548'></font>
      <font color=#447700>!  second time period.  Why you may ask.  I<a name='1549'></font>
      <font color=#447700>!  agree, why indeed.<a name='1550'></font>
<a name='1551'>
      temp24= current_date<a name='1552'>
      temp24b=start_date<a name='1553'>
      start_date = current_date<a name='1554'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_4"> ( temp19 , temp24b(1:19) , &amp;<a name='1555'>
                         (loop-2) * model_config_rec%interval_seconds )<a name='1556'>
      current_date = temp19 //  '.0000'<a name='1557'>
       CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_4">( grid, current_date(1:19) )<a name='1558'>
      write(message,*) 'LBC valid between these times ',current_date, ' ',start_date<a name='1559'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_439">(message)<a name='1560'>
<a name='1561'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OUTPUT_BOUNDARY'>output_boundary</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_BOUNDARY_2"> ( id, grid , config_flags , ierr )<a name='1562'>
      current_date = temp24<a name='1563'>
      start_date = temp24b<a name='1564'>
<a name='1565'>
      <font color=#447700>!  OK, for all of the loops, we output the initialzation <a name='1566'></font>
      <font color=#447700>!  data, which would allow us to<a name='1567'></font>
      <font color=#447700>!  start the model at any of the available analysis time periods.<a name='1568'></font>
<a name='1569'>
<font color=#447700>!  WRITE ( loop_char , FMT = '(I4.4)' ) loop<a name='1570'></font>
<font color=#447700>!  CALL open_w_dataset ( id1, 'wrfinput'//loop_char , grid , config_flags , output_input , "DATASET=INPUT", ierr )<a name='1571'></font>
<font color=#447700>!  IF ( ierr .NE. 0 ) THEN<a name='1572'></font>
<font color=#447700>!    CALL wrf_error_fatal( 'ideal_hwrf: error opening wrfinput'//loop_char//' for writing' )<a name='1573'></font>
<font color=#447700>!  ENDIF<a name='1574'></font>
<font color=#447700>!  grid%write_metadata = .true.<a name='1575'></font>
<a name='1576'>
<font color=#447700>!  CALL calc_current_date ( grid%id , 0. )<a name='1577'></font>
<font color=#447700>!  CALL output_input ( id1, grid , config_flags , ierr )<a name='1578'></font>
<font color=#447700>!  CALL close_dataset ( id1 , config_flags , "DATASET=INPUT" )<a name='1579'></font>
<a name='1580'>
  <font color=#447700>!  Is this or is this not the last time time?  We can remove some unnecessary<a name='1581'></font>
  <font color=#447700>!  stores if it is not.<a name='1582'></font>
<a name='1583'>
      IF     ( loop .LT. time_loop_max ) THEN<a name='1584'>
<a name='1585'>
         <font color=#447700>!  We need to save the 3d data to compute a <a name='1586'></font>
         <font color=#447700>!  difference during the next loop.  Couple the<a name='1587'></font>
         <font color=#447700>!  3d fields with total mu (mub + mu_2) and the <a name='1588'></font>
         <font color=#447700>!  stagger-specific map scale factor.<a name='1589'></font>
         <font color=#447700>!  We load up the boundary data again for use in the next loop.<a name='1590'></font>
<a name='1591'>
<a name='1592'>
<font color=#447700>!mp	change these limits?????????<a name='1593'></font>
<a name='1594'>
         DO k = kps , kpe<a name='1595'>
            DO j = jps , jpe<a name='1596'>
               DO i = ips , ipe<a name='1597'>
                  ubdy3dtemp1(i,j,k) = ubdy3dtemp2(i,j,k)<a name='1598'>
                  vbdy3dtemp1(i,j,k) = vbdy3dtemp2(i,j,k)<a name='1599'>
                  tbdy3dtemp1(i,j,k) = tbdy3dtemp2(i,j,k)<a name='1600'>
                  cwmbdy3dtemp1(i,j,k) = cwmbdy3dtemp2(i,j,k)<a name='1601'>
                  qbdy3dtemp1(i,j,k) = qbdy3dtemp2(i,j,k)<a name='1602'>
                  q2bdy3dtemp1(i,j,k) = q2bdy3dtemp2(i,j,k)<a name='1603'>
               END DO<a name='1604'>
            END DO<a name='1605'>
         END DO<a name='1606'>
<a name='1607'>
<font color=#447700>!mp	change these limits?????????<a name='1608'></font>
<a name='1609'>
         DO j = jps , jpe<a name='1610'>
            DO i = ips , ipe<a name='1611'>
               pdbdy2dtemp1(i,j,1) = pdbdy2dtemp2(i,j,1)<a name='1612'>
            END DO<a name='1613'>
         END DO<a name='1614'>
<a name='1615'>
  <font color=#447700>!  There are 2 components to the lateral boundaries.  <a name='1616'></font>
  <font color=#447700>!   First, there is the starting<a name='1617'></font>
  <font color=#447700>!  point of this time period - just the outer few rows and columns.<a name='1618'></font>
<a name='1619'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_8"> (ubdy3dtemp1, grid%u_bxs, grid%u_bxe, &amp;<a name='1620'>
                                  grid%u_bys, grid%u_bye, &amp;<a name='1621'>
                                  'N', spec_bdy_width  , &amp;<a name='1622'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1623'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1624'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1625'>
<a name='1626'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_9"> (vbdy3dtemp1, grid%v_bxs, grid%v_bxe, &amp;<a name='1627'>
                                  grid%v_bys, grid%v_bye, &amp;<a name='1628'>
                                  'N', spec_bdy_width  , &amp;<a name='1629'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1630'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1631'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1632'>
<a name='1633'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_10"> (tbdy3dtemp1, grid%t_bxs, grid%t_bxe, &amp;<a name='1634'>
                                  grid%t_bys, grid%t_bye, &amp;<a name='1635'>
                                  'N', spec_bdy_width  , &amp;<a name='1636'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1637'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1638'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1639'>
<a name='1640'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_11"> (cwmbdy3dtemp1, grid%cwm_bxs, grid%cwm_bxe, &amp;<a name='1641'>
                                  grid%cwm_bys, grid%cwm_bye, &amp;<a name='1642'>
                                  'N', spec_bdy_width  , &amp;<a name='1643'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1644'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1645'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1646'>
<a name='1647'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_12"> (qbdy3dtemp1, grid%q_bxs, grid%q_bxe, &amp;<a name='1648'>
                                  grid%q_bys, grid%q_bye, &amp;<a name='1649'>
                                  'N', spec_bdy_width  , &amp;<a name='1650'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1651'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1652'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1653'>
<a name='1654'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_13"> (q2bdy3dtemp1, grid%q2_bxs, grid%q2_bxe, &amp;<a name='1655'>
                                  grid%q2_bys, grid%q2_bye, &amp;<a name='1656'>
                                  'N', spec_bdy_width  , &amp;<a name='1657'>
                                  ids , ide+1 , jds , jde+1 , kds , kde+1 , &amp;<a name='1658'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1659'>
                                  ips , ipe , jps , jpe , kps , kpe+1 )<a name='1660'>
<a name='1661'>
 CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY_IJK'>stuff_bdy_ijk</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_IJK_14"> (pdbdy2dtemp1,grid%pd_bxs, grid%pd_bxe, &amp;<a name='1662'>
                                  grid%pd_bys, grid%pd_bye, &amp;<a name='1663'>
                                  'M', spec_bdy_width  , &amp;<a name='1664'>
                                  ids , ide+1 , jds , jde+1 , 1 , 1 , &amp;<a name='1665'>
                                  ims , ime , jms , jme , 1 , 1 , &amp;<a name='1666'>
                                  ips , ipe , jps , jpe , 1 , 1 )<a name='1667'>
<a name='1668'>
      ELSE IF ( loop .EQ. time_loop_max ) THEN<a name='1669'>
<a name='1670'>
    <font color=#447700>!  If this is the last time through here, we need to close the files.<a name='1671'></font>
<a name='1672'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_5"> ( id , config_flags , "DATASET=BOUNDARY" )<a name='1673'>
<a name='1674'>
      END IF<a name='1675'>
<a name='1676'>
   END IF main_loop_test<a name='1677'>
<a name='1678'>
#if ( HWRF == 1 )<a name='1679'>
  if(alloc_ph_arrays) then<a name='1680'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/tc_em.F.html#ASSEMBLE_OUTPUT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_331">(1,'DEALLOCATE PREP_HYBRID BOUNARY ARRAYS')<a name='1681'>
     deallocate(TB,QB,CWMB,UB,VB,PDB)<a name='1682'>
  endif<a name='1683'>
#endif<a name='1684'>
<a name='1685'>
END SUBROUTINE assemble_output<a name='1686'>
</pre></body></html>