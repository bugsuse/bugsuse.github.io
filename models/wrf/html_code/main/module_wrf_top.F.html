<HTML> <BODY BGCOLOR=#eeeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:TOP<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<font color=#447700>!TBH:  $$$  move this to ../frame?  <a name='5'></font>
<a name='6'>
<A NAME='MODULE_WRF_TOP'><A href='../../html_code/main/module_wrf_top.F.html#MODULE_WRF_TOP' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='7'>
<font color=#993300>MODULE </font><font color=#cc0000>module_wrf_top</font> <A href='../../call_to/MODULE_WRF_TOP.html' TARGET='index'>2</A><a name='8'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='9'></font>
<font color=#447700>! This module defines top-level wrf_init(), wrf_run(), and wrf_finalize() <a name='10'></font>
<font color=#447700>! routines.  <a name='11'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='12'></font>
<a name='13'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_16"><a name='14'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_180"><a name='15'>
   USE <A href='../../html_code/frame/module_integrate.F.html#MODULE_INTEGRATE'>module_integrate</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTEGRATE_1"><a name='16'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_48"><a name='17'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_119"><a name='18'>
   USE <A href='../../html_code/share/module_check_a_mundo.F.html#MODULE_CHECK_A_MUNDO'>module_check_a_mundo</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CHECK_A_MUNDO_2"><a name='19'>
<a name='20'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_35"><a name='21'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_38"><a name='22'>
   USE <A href='../../html_code/frame/module_nesting.F.html#MODULE_NESTING'>module_nesting</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_NESTING_3"><a name='23'>
<a name='24'>
#ifdef DM_PARALLEL<a name='25'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_135">, ONLY : wrf_dm_initialize,wrf_get_hostid,domain_active_this_task,mpi_comm_allcompute<a name='26'>
#else<a name='27'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_136">, ONLY : domain_active_this_task<a name='28'>
#endif<a name='29'>
<a name='30'>
   USE <A href='../../html_code/frame/module_cpl.F.html#MODULE_CPL'>module_cpl</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CPL_7">, ONLY : coupler_on, cpl_finalize, cpl_defdomain<a name='31'>
<a name='32'>
   IMPLICIT NONE<a name='33'>
<a name='34'>
   REAL    :: time<a name='35'>
<a name='36'>
   INTEGER :: loop , &amp;<a name='37'>
              levels_to_process<a name='38'>
<a name='39'>
   TYPE (domain) , POINTER :: keep_grid, grid_ptr, null_domain<a name='40'>
   TYPE (domain) , pointer :: parent_grid, new_nest<a name='41'>
   LOGICAL                                :: a_nest_was_opened<a name='42'>
   TYPE (grid_config_rec_type), SAVE :: config_flags<a name='43'>
   INTEGER        :: kid, nestid<a name='44'>
   INTEGER                 :: number_at_same_level<a name='45'>
   INTEGER                 :: time_step_begin_restart<a name='46'>
<a name='47'>
   INTEGER :: max_dom , domain_id , fid , oid , idum1 , idum2 , ierr<a name='48'>
   INTEGER :: debug_level<a name='49'>
   LOGICAL :: input_from_file<a name='50'>
<a name='51'>
#ifdef DM_PARALLEL<a name='52'>
   INTEGER                 :: nbytes<a name='53'>
   INTEGER, PARAMETER      :: configbuflen = 4* CONFIG_BUF_LEN<a name='54'>
   INTEGER                 :: configbuf( configbuflen )<a name='55'>
   LOGICAL , EXTERNAL      :: wrf_dm_on_monitor<a name='56'>
#endif<a name='57'>
<a name='58'>
   CHARACTER (LEN=256)     :: rstname<a name='59'>
   CHARACTER (LEN=80)      :: message<a name='60'>
   CHARACTER (LEN=256) , PRIVATE :: a_message<a name='61'>
<a name='62'>
   INTERFACE <a name='63'>
     SUBROUTINE Setup_Timekeeping( grid )<a name='64'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_181"><a name='65'>
      TYPE(domain), POINTER :: grid<a name='66'>
     END SUBROUTINE Setup_Timekeeping<a name='67'>
<a name='68'>
<font color=#447700>! #if (EM_CORE == 1)<a name='69'></font>
     SUBROUTINE wrf_dfi_write_initialized_state( )<a name='70'>
     END SUBROUTINE wrf_dfi_write_initialized_state<a name='71'>
 <a name='72'>
     SUBROUTINE wrf_dfi_startfwd_init( )<a name='73'>
     END SUBROUTINE wrf_dfi_startfwd_init<a name='74'>
     <a name='75'>
     SUBROUTINE wrf_dfi_startbck_init( )<a name='76'>
     END SUBROUTINE wrf_dfi_startbck_init<a name='77'>
     <a name='78'>
     SUBROUTINE wrf_dfi_bck_init( )<a name='79'>
     END SUBROUTINE wrf_dfi_bck_init<a name='80'>
     <a name='81'>
     SUBROUTINE wrf_dfi_fwd_init( )<a name='82'>
     END SUBROUTINE wrf_dfi_fwd_init<a name='83'>
     <a name='84'>
     SUBROUTINE wrf_dfi_fst_init( )<a name='85'>
     END SUBROUTINE wrf_dfi_fst_init<a name='86'>
     <a name='87'>
     SUBROUTINE wrf_dfi_array_reset ( )<a name='88'>
     END SUBROUTINE wrf_dfi_array_reset<a name='89'>
<font color=#447700>! #endif<a name='90'></font>
<a name='91'>
     SUBROUTINE med_nest_initial ( parent , grid , config_flags )<a name='92'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_182"><a name='93'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/module_wrf_top.F.html#module_wrf_top.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_120"><a name='94'>
       TYPE (domain), POINTER ::  grid , parent<a name='95'>
       TYPE (grid_config_rec_type) config_flags<a name='96'>
     END SUBROUTINE med_nest_initial<a name='97'>
<a name='98'>
   END INTERFACE<a name='99'>
<a name='100'>
<a name='101'>
CONTAINS<a name='102'>
<a name='103'>
<a name='104'>
<A NAME='WRF_INIT'><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='105'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_init</font>( no_init1 ) <A href='../../call_to/WRF_INIT.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_INIT.html' TARGET='index'>44</A><a name='106'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='107'></font>
<font color=#447700>!     WRF initialization routine.<a name='108'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='109'></font>
#ifdef _OPENMP<a name='110'>
     use omp_lib<a name='111'>
#endif<a name='112'>
#ifdef _ACCEL<a name='113'>
     use accel_lib<a name='114'>
#endif<a name='115'>
     LOGICAL, OPTIONAL, INTENT(IN) :: no_init1<a name='116'>
     INTEGER i, myproc, nproc, hostid, loccomm, ierr, buddcounter, mydevice, save_comm<a name='117'>
     INTEGER, ALLOCATABLE :: hostids(:), budds(:)<a name='118'>
     CHARACTER*512 hostname<a name='119'>
     CHARACTER*512 mminlu_loc<a name='120'>
#ifdef _ACCEL<a name='121'>
     INTEGER :: it, nt, in, devnum<a name='122'>
#endif<a name='123'>
#if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI) &amp;&amp; ( defined(RUN_ON_GPU) || defined(_ACCEL))<a name='124'></font>
     include "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_1"><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='125'>
#endif<a name='126'>
#include "<A href='../../html_code/include/version_decl.html'>version_decl</A>"<A NAME="version_decl_2"><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='127'>
<a name='128'>
<a name='129'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='130'></font>
<font color=#447700>! Program_name, a global variable defined in frame/module_domain.F, is<a name='131'></font>
<font color=#447700>! set, then a routine &lt;a href=init_modules.html&gt;init_modules&lt;/a&gt; is<a name='132'></font>
<font color=#447700>! called. This calls all the init programs that are provided by the<a name='133'></font>
<font color=#447700>! modules that are linked into WRF.  These include initialization of<a name='134'></font>
<font color=#447700>! external I/O packages.   Also, some key initializations for<a name='135'></font>
<font color=#447700>! distributed-memory parallelism occur here if DM_PARALLEL is specified<a name='136'></font>
<font color=#447700>! in the compile: setting up I/O quilt processes to act as I/O servers<a name='137'></font>
<font color=#447700>! and dividing up MPI communicators among those as well as initializing<a name='138'></font>
<font color=#447700>! external communication packages such as RSL or RSL_LITE.<a name='139'></font>
<font color=#447700>!<a name='140'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='141'></font>
<a name='142'>
   program_name = "WRF " // TRIM(release_version) // " MODEL"<a name='143'>
<a name='144'>
   <font color=#447700>! Initialize WRF modules:  <a name='145'></font>
   <font color=#447700>! Phase 1 returns after MPI_INIT() (if it is called)<a name='146'></font>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_7">(1)<a name='147'>
   IF ( .NOT. PRESENT( no_init1 ) ) THEN<a name='148'>
     <font color=#447700>! Initialize utilities (time manager, etc.)<a name='149'></font>
#ifdef NO_LEAP_CALENDAR<a name='150'>
     CALL WRFU_Initialize( defaultCalKind=WRFU_CAL_NOLEAP )<a name='151'>
#else<a name='152'>
     CALL WRFU_Initialize( defaultCalKind=WRFU_CAL_GREGORIAN )<a name='153'>
#endif<a name='154'>
   ENDIF<a name='155'>
   <font color=#447700>! Phase 2 resumes after MPI_INIT() (if it is called)<a name='156'></font>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_8">(2)<a name='157'>
<a name='158'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='159'></font>
<font color=#447700>! The wrf namelist.input file is read and stored in the USE associated<a name='160'></font>
<font color=#447700>! structure model_config_rec, defined in frame/module_configure.F, by the<a name='161'></font>
<font color=#447700>! call to &lt;a href=initial_config.html&gt;initial_config&lt;/a&gt;.  On distributed<a name='162'></font>
<font color=#447700>! memory parallel runs this is done only on one processor, and then<a name='163'></font>
<font color=#447700>! broadcast as a buffer.  For distributed-memory, the broadcast of the<a name='164'></font>
<font color=#447700>! configuration information is accomplished by first putting the<a name='165'></font>
<font color=#447700>! configuration information into a buffer (&lt;a<a name='166'></font>
<font color=#447700>! href=get_config_as_buffer.html&gt;get_config_as_buffer&lt;/a&gt;), broadcasting<a name='167'></font>
<font color=#447700>! the buffer, then setting the configuration information (&lt;a<a name='168'></font>
<font color=#447700>! href=set_config_as_buffer.html&gt;set_config_as_buffer&lt;/a&gt;).<a name='169'></font>
<font color=#447700>!<a name='170'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='171'></font>
<a name='172'>
#ifdef DM_PARALLEL<a name='173'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_48">( save_comm )<a name='174'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_9">( mpi_comm_allcompute )<a name='175'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='176'>
     CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_7"><a name='177'>
   ENDIF<a name='178'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_7">( configbuf, configbuflen, nbytes )<a name='179'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_110">( configbuf, nbytes )<a name='180'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_7">( configbuf, configbuflen )<a name='181'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_INITIALIZE'>wrf_dm_initialize</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_INITIALIZE_4"><a name='182'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_10">( save_comm )<a name='183'>
#else<a name='184'>
   CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_8"><a name='185'>
#endif<a name='186'>
<a name='187'>
   CALL <A href='../../html_code/main/module_wrf_top.F.html#SET_DERIVED_RCONFIGS'>set_derived_rconfigs</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_DERIVED_RCONFIGS_1"><a name='188'>
   CALL <A href='../../html_code/share/module_check_a_mundo.F.html#CHECK_NML_CONSISTENCY'>check_nml_consistency</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_NML_CONSISTENCY_2"><a name='189'>
   CALL <A href='../../html_code/share/module_check_a_mundo.F.html#SETUP_PHYSICS_SUITE'>setup_physics_suite</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_PHYSICS_SUITE_1"><a name='190'>
   CALL <A href='../../html_code/share/module_check_a_mundo.F.html#SET_PHYSICS_RCONFIGS'>set_physics_rconfigs</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICS_RCONFIGS_2"><a name='191'>
<a name='192'>
#ifdef _ACCEL<a name='193'>
   buddcounter = 1<a name='194'>
   mydevice = 0<a name='195'>
# if defined(DM_PARALLEL) &amp;&amp; <font color=#447700>!defined(STUBMPI) <a name='196'></font>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_34">( myproc )<a name='197'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_18">( nproc )<a name='198'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_GET_HOSTID'>wrf_get_hostid</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_HOSTID_1"> ( hostid )<a name='199'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_49"> ( loccomm )<a name='200'>
<a name='201'>
   ALLOCATE( hostids(nproc) )<a name='202'>
   ALLOCATE( budds(nproc) )<a name='203'>
   CALL mpi_allgather( hostid, 1, MPI_INTEGER, hostids, 1, MPI_INTEGER, loccomm, ierr )<a name='204'>
   if ( ierr .NE. 0 ) print * ,'error in mpi_allgather ',ierr<a name='205'>
   budds = -1<a name='206'>
   buddcounter = 0<a name='207'>
   <font color=#447700>! mark the ones i am on the same node with<a name='208'></font>
   DO i = 1, nproc<a name='209'>
      IF ( hostid .EQ. hostids(i) ) THEN<a name='210'>
         budds(i) = buddcounter<a name='211'>
         buddcounter = buddcounter + 1<a name='212'>
      ENDIF<a name='213'>
   ENDDO<a name='214'>
   mydevice = budds(myproc+1)<a name='215'>
   DEALLOCATE( hostids )<a name='216'>
   DEALLOCATE( budds )<a name='217'>
# endif<a name='218'>
   in = acc_get_num_devices(acc_device_nvidia)<a name='219'>
   if (in .le. 0) print *, 'error:  No GPUS present: ',in<a name='220'>
# ifdef _OPENMP<a name='221'>
   <font color=#447700>!$OMP PARALLEL SHARED(mydevice,in) PRIVATE(it,nt,devnum)<a name='222'></font>
   it = omp_get_thread_num()<a name='223'>
   nt = omp_get_num_threads()<a name='224'>
   devnum = mod(mod(mydevice*nt,in) + it, in)<a name='225'>
# ifdef _ACCEL_PROF<a name='226'>
   print *, "Process, Thread, Device: ",mydevice, it, devnum<a name='227'>
# endif<a name='228'>
   call acc_set_device_num(devnum, acc_device_nvidia)<a name='229'>
<a name='230'>
   <font color=#447700>!$OMP END PARALLEL<a name='231'></font>
# else<a name='232'>
   it = 0<a name='233'>
   nt = 1<a name='234'>
   devnum = mod(mod(mydevice*nt,in) + it, in)<a name='235'>
#  ifdef _ACCEL_PROF<a name='236'>
   print *, "Process, Thread, Device: ",mydevice, it, devnum<a name='237'>
#  endif<a name='238'>
   call acc_set_device_num(devnum, acc_device_nvidia)<a name='239'>
# endif<a name='240'>
#endif<a name='241'>
<a name='242'>
#ifdef RUN_ON_GPU<a name='243'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_35">( myproc )<a name='244'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_19">( nproc )<a name='245'>
# ifdef DM_PARALLEL<a name='246'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_GET_HOSTID'>wrf_get_hostid</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_HOSTID_2"> ( hostid ) <a name='247'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_50"> ( loccomm )<a name='248'>
   ALLOCATE( hostids(nproc) )<a name='249'>
   ALLOCATE( budds(nproc) )<a name='250'>
   CALL mpi_allgather( hostid, 1, MPI_INTEGER, hostids, 1, MPI_INTEGER, loccomm, ierr )<a name='251'>
   IF ( ierr .NE. 0 ) THEN<a name='252'>
      write(a_message,*)__FILE__,__LINE__,'error in mpi_allgather ',ierr<a name='253'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_440"> ( a_message ) <a name='254'>
   END IF<a name='255'>
   budds = -1<a name='256'>
   buddcounter = 0 <a name='257'>
   <font color=#447700>! mark the ones i am on the same node with<a name='258'></font>
   DO i = 1, nproc <a name='259'>
      IF ( hostid .EQ. hostids(i) ) THEN<a name='260'>
         budds(i) = buddcounter <a name='261'>
         buddcounter = buddcounter + 1<a name='262'>
      ENDIF<a name='263'>
   ENDDO<a name='264'>
   mydevice = budds(myproc+1)<a name='265'>
   DEALLOCATE( hostids )<a name='266'>
   DEALLOCATE( budds )<a name='267'>
# else<a name='268'>
   mydevice = 0<a name='269'>
# endif<a name='270'>
   CALL wsm5_gpu_init( myproc, nproc, mydevice )<a name='271'>
#endif<a name='272'>
<a name='273'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='274'></font>
<font color=#447700>! Among the configuration variables read from the namelist is<a name='275'></font>
<font color=#447700>! debug_level. This is retrieved using nl_get_debug_level (Registry<a name='276'></font>
<font color=#447700>! generated and defined in frame/module_configure.F).  The value is then<a name='277'></font>
<font color=#447700>! used to set the debug-print information level for use by &lt;a<a name='278'></font>
<font color=#447700>! href=wrf_debug.html&gt;wrf_debug&lt;/a&gt; throughout the code. Debug_level<a name='279'></font>
<font color=#447700>! of zero (the default) causes no information to be printed when the<a name='280'></font>
<font color=#447700>! model runs. The higher the number (up to 1000) the more information is<a name='281'></font>
<font color=#447700>! printed.<a name='282'></font>
<font color=#447700>! <a name='283'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='284'></font>
<a name='285'>
   CALL nl_get_debug_level ( 1, debug_level )<a name='286'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#SET_WRF_DEBUG_LEVEL'>set_wrf_debug_level</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_WRF_DEBUG_LEVEL_6"> ( debug_level )<a name='287'>
<a name='288'>
   <font color=#447700>! allocated and configure the mother domain<a name='289'></font>
<a name='290'>
   NULLIFY( null_domain )<a name='291'>
<a name='292'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='293'></font>
<font color=#447700>! RSL is required for WRF nesting options.<a name='294'></font>
<font color=#447700>! The non-MPI build that allows nesting is only supported on machines<a name='295'></font>
<font color=#447700>! with the -DSTUBMPI option.  Check to see if the WRF model is being asked <a name='296'></font>
<font color=#447700>! for a for a multi-domain run (max_dom &gt; 1, from the namelist).  If so,<a name='297'></font>
<font color=#447700>! then we check to make sure that we are under the parallel<a name='298'></font>
<font color=#447700>! run option or we are on an acceptable machine.<a name='299'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='300'></font>
<a name='301'>
   CALL nl_get_max_dom( 1, max_dom )<a name='302'>
   IF ( max_dom &gt; 1 ) THEN<a name='303'>
#if ( <font color=#447700>! defined(DM_PARALLEL)  &amp;&amp;   ! defined(STUBMPI) )<a name='304'></font>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_395">( &amp;<a name='305'>
     'nesting requires either an MPI build or use of the -DSTUBMPI option' ) <a name='306'>
#endif<a name='307'>
   END IF<a name='308'>
<a name='309'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='310'></font>
<font color=#447700>! The top-most domain in the simulation is then allocated and configured<a name='311'></font>
<font color=#447700>! by calling &lt;a href=alloc_and_configure_domain.html&gt;alloc_and_configure_domain&lt;/a&gt;.<a name='312'></font>
<font color=#447700>! Here, in the case of this root domain, the routine is passed the<a name='313'></font>
<font color=#447700>! globally accessible pointer to TYPE(domain), head_grid, defined in<a name='314'></font>
<font color=#447700>! frame/module_domain.F.  The parent is null and the child index is given<a name='315'></font>
<font color=#447700>! as negative, signifying none.  Afterwards, because the call to<a name='316'></font>
<font color=#447700>! alloc_and_configure_domain may modify the model's configuration data<a name='317'></font>
<font color=#447700>! stored in model_config_rec, the configuration information is again<a name='318'></font>
<font color=#447700>! repacked into a buffer, broadcast, and unpacked on each task (for<a name='319'></font>
<font color=#447700>! DM_PARALLEL compiles). The call to &lt;a<a name='320'></font>
<font color=#447700>! href=setup_timekeeping.html&gt;setup_timekeeping&lt;/a&gt; for head_grid relies<a name='321'></font>
<font color=#447700>! on this configuration information, and it must occur after the second<a name='322'></font>
<font color=#447700>! broadcast of the configuration information.<a name='323'></font>
<font color=#447700>! <a name='324'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='325'></font>
   CALL       <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_441"> ( program_name )<a name='326'>
   CALL       wrf_debug ( 100 , 'wrf: calling alloc_and_configure_domain ' )<a name='327'>
   CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_5"> ( domain_id  = 1 ,                  &amp;<a name='328'>
                               active_this_task = domain_active_this_task(1), &amp;<a name='329'>
                                     grid       = head_grid ,          &amp;<a name='330'>
                                     parent     = null_domain ,        &amp;<a name='331'>
                                     kid        = -1                   )<a name='332'>
<a name='333'>
   CALL       wrf_debug ( 100 , 'wrf: calling model_to_grid_config_rec ' )<a name='334'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_23"> ( head_grid%id , model_config_rec , config_flags )<a name='335'>
   CALL       wrf_debug ( 100 , 'wrf: calling set_scalar_indices_from_config ' )<a name='336'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_11"> ( head_grid%id , idum1, idum2 )<a name='337'>
   CALL       wrf_debug ( 100 , 'wrf: calling init_wrfio' )<a name='338'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#INIT_WRFIO'>init_wrfio</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_WRFIO_4"><a name='339'>
<a name='340'>
#ifdef DM_PARALLEL<a name='341'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_51">( save_comm )<a name='342'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_11">( mpi_comm_allcompute )<a name='343'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_8">( configbuf, configbuflen, nbytes )<a name='344'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_111">( configbuf, nbytes )<a name='345'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_8">( configbuf, configbuflen )<a name='346'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_12">( save_comm )<a name='347'>
#endif<a name='348'>
<a name='349'>
<font color=#447700>! #if (EM_CORE == 1)<a name='350'></font>
   <font color=#447700>! In case we are doing digital filter initialization, set dfi_stage = DFI_SETUP <a name='351'></font>
   <font color=#447700>!   to indicate in Setup_Timekeeping that we want forecast start and<a name='352'></font>
   <font color=#447700>!   end times at this point <a name='353'></font>
   IF ( head_grid%dfi_opt .NE. DFI_NODFI ) head_grid%dfi_stage = DFI_SETUP<a name='354'>
<font color=#447700>! #endif<a name='355'></font>
<a name='356'>
   CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_4"> (head_grid)<a name='357'>
<a name='358'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='359'></font>
<font color=#447700>! The head grid is initialized with read-in data through the call to &lt;a<a name='360'></font>
<font color=#447700>! href=med_initialdata_input.html&gt;med_initialdata_input&lt;/a&gt;, which is<a name='361'></font>
<font color=#447700>! passed the pointer head_grid and a locally declared configuration data<a name='362'></font>
<font color=#447700>! structure, config_flags, that is set by a call to &lt;a<a name='363'></font>
<font color=#447700>! href=model_to_grid_config_rec.html&gt;model_to_grid_config_rec&lt;/a&gt;.  It is<a name='364'></font>
<font color=#447700>! also necessary that the indices into the 4d tracer arrays such as<a name='365'></font>
<font color=#447700>! moisture be set with a call to &lt;a<a name='366'></font>
<font color=#447700>! href=set_scalar_indices_from_config.html&gt;set_scalar_indices_from_config&lt;/a&gt;<a name='367'></font>
<font color=#447700>! prior to the call to initialize the domain.  Both of these calls are<a name='368'></font>
<font color=#447700>! told which domain they are setting up for by passing in the integer id<a name='369'></font>
<font color=#447700>! of the head domain as &lt;tt&gt;head_grid%id&lt;/tt&gt;, which is 1 for the<a name='370'></font>
<font color=#447700>! top-most domain.<a name='371'></font>
<font color=#447700>! <a name='372'></font>
<font color=#447700>! In the case that write_restart_at_0h is set to true in the namelist,<a name='373'></font>
<font color=#447700>! the model simply generates a restart file using the just read-in data<a name='374'></font>
<font color=#447700>! and then shuts down. This is used for ensemble breeding, and is not<a name='375'></font>
<font color=#447700>! typically enabled.<a name='376'></font>
<font color=#447700>! <a name='377'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='378'></font>
<a name='379'>
 IF ( domain_active_this_task(1) ) THEN<a name='380'>
   CALL <A href='../../html_code/share/mediation_wrfmain.F.html#MED_INITIALDATA_INPUT'>med_initialdata_input</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INITIALDATA_INPUT_1">( head_grid , config_flags )<a name='381'>
<a name='382'>
   IF ( config_flags%write_restart_at_0h ) THEN<a name='383'>
      CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_RESTART_OUT'>med_restart_out</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_RESTART_OUT_1"> ( head_grid, config_flags )<a name='384'>
#ifndef AUTODOC_BUILD<a name='385'>
<font color=#447700>! prevent this from showing up before the call to integrate in the autogenerated call tree<a name='386'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_332"> ( 0 , ' 0 h restart only wrf: SUCCESS COMPLETE WRF' )<a name='387'>
<font color=#447700>! TBH:  $$$ Unscramble this later...  <a name='388'></font>
<font color=#447700>! TBH:  $$$ Need to add state to avoid calling wrf_finalize() twice when ESMF <a name='389'></font>
<font color=#447700>! TBH:  $$$ library is used.  Maybe just set clock stop_time=start_time and <a name='390'></font>
<font color=#447700>! TBH:  $$$ do not call wrf_finalize here...  <a name='391'></font>
      CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_FINALIZE'>wrf_finalize</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_FINALIZE_1">( )<a name='392'>
#endif<a name='393'>
   END IF<a name='394'>
  ENDIF  <font color=#447700>! domain_active_this_task<a name='395'></font>
<a name='396'>
   <font color=#447700>! set default values for subtimes<a name='397'></font>
   head_grid%start_subtime = domain_get_start_time ( head_grid )<a name='398'>
   head_grid%stop_subtime = domain_get_stop_time ( head_grid )<a name='399'>
<a name='400'>
 IF ( domain_active_this_task(1) ) THEN<a name='401'>
   <font color=#447700>!  For EM (but not DA), if this is a DFI run, we can allocate some space.  We are<a name='402'></font>
   <font color=#447700>!  not allowing anyting tricky for nested DFI.  If there are any nested domains,<a name='403'></font>
   <font color=#447700>!  they all need to start at the same time.  Otherwise, why even do the DFI?  If<a name='404'></font>
   <font color=#447700>!  the domains do not all start at the same time, then there will be inconsistencies,<a name='405'></font>
   <font color=#447700>!  which is what DFI is supposed to address.<a name='406'></font>
<a name='407'>
#if (EM_CORE == 1)<a name='408'>
   IF ( head_grid%dfi_opt .NE. DFI_NODFI ) THEN<a name='409'>
      CALL <A href='../../html_code/main/module_wrf_top.F.html#ALLOC_DOMS_FOR_DFI'>alloc_doms_for_dfi</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_DOMS_FOR_DFI_1"> ( head_grid )<a name='410'>
   END IF<a name='411'>
#endif<a name='412'>
<a name='413'>
   IF (coupler_on) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_DEFDOMAIN'>cpl_defdomain</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_DEFDOMAIN_2">( head_grid ) <a name='414'>
  ENDIF  <font color=#447700>! domain_active_this_task<a name='415'></font>
<a name='416'>
   END SUBROUTINE wrf_init<a name='417'>
<a name='418'>
<a name='419'>
<a name='420'>
<A NAME='WRF_RUN'><A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='421'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_run</font>( ) <A href='../../call_to/WRF_RUN.html' TARGET='index'>7</A>,<A href='../../call_from/WRF_RUN.html' TARGET='index'>2</A><a name='422'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='423'></font>
<font color=#447700>!     WRF run routine.<a name='424'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='425'></font>
<a name='426'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='427'></font>
<font color=#447700>! Once the top-level domain has been allocated, configured, and<a name='428'></font>
<font color=#447700>! initialized, the model time integration is ready to proceed.  The start<a name='429'></font>
<font color=#447700>! and stop times for the domain are set to the start and stop time of the<a name='430'></font>
<font color=#447700>! model run, and then &lt;a href=integrate.html&gt;integrate&lt;/a&gt; is called to<a name='431'></font>
<font color=#447700>! advance the domain forward through that specified time interval.  On<a name='432'></font>
<font color=#447700>! return, the simulation is completed.  <a name='433'></font>
<font color=#447700>! <a name='434'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='435'></font>
<a name='436'>
   <font color=#447700>!  The forecast integration for the most coarse grid is now started.  The<a name='437'></font>
   <font color=#447700>!  integration is from the first step (1) to the last step of the simulation.<a name='438'></font>
<a name='439'>
   CALL       wrf_debug ( 100 , 'wrf: calling integrate' )<a name='440'>
   CALL <A href='../../html_code/frame/module_integrate.F.html#INTEGRATE'>integrate</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTEGRATE_2"> ( head_grid )<a name='441'>
   CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_333"> ( 100 , 'wrf: back from integrate' )<a name='442'>
<a name='443'>
   END SUBROUTINE wrf_run<a name='444'>
<a name='445'>
<a name='446'>
<a name='447'>
<A NAME='WRF_FINALIZE'><A href='../../html_code/main/module_wrf_top.F.html#WRF_FINALIZE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='448'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_finalize</font>( no_shutdown ) <A href='../../call_to/WRF_FINALIZE.html' TARGET='index'>3</A>,<A href='../../call_from/WRF_FINALIZE.html' TARGET='index'>5</A><a name='449'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='450'></font>
<font color=#447700>!     WRF finalize routine.<a name='451'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='452'></font>
<a name='453'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='454'></font>
<font color=#447700>! A Mediation Layer-provided<a name='455'></font>
<font color=#447700>! subroutine, &lt;a href=med_shutdown_io.html&gt;med_shutdown_io&lt;/a&gt; is called<a name='456'></font>
<font color=#447700>! to allow the the model to do any I/O specific cleanup and shutdown, and<a name='457'></font>
<font color=#447700>! then the WRF Driver Layer routine &lt;a<a name='458'></font>
<font color=#447700>! href=wrf_shutdown.html&gt;wrf_shutdown&lt;/a&gt; (quilt servers would be<a name='459'></font>
<font color=#447700>! directed to shut down here) is called to properly end the run,<a name='460'></font>
<font color=#447700>! including shutting down the communications (for example, most comm<a name='461'></font>
<font color=#447700>! layers would call MPI_FINALIZE at this point if they're using MPI).<a name='462'></font>
<font color=#447700>! <a name='463'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='464'></font>
     LOGICAL, OPTIONAL, INTENT(IN) :: no_shutdown<a name='465'>
<a name='466'>
   <font color=#447700>! shut down I/O<a name='467'></font>
   CALL <A href='../../html_code/share/mediation_wrfmain.F.html#MED_SHUTDOWN_IO'>med_shutdown_io</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_FINALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_SHUTDOWN_IO_2"> ( head_grid , config_flags )<a name='468'>
   CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_FINALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_334"> ( 100 , 'wrf: back from med_shutdown_io' )<a name='469'>
<a name='470'>
   CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_FINALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_335"> (   0 , 'wrf: SUCCESS COMPLETE WRF' )<a name='471'>
<a name='472'>
   <font color=#447700>! Call wrf_shutdown() (which calls MPI_FINALIZE() <a name='473'></font>
   <font color=#447700>! for DM parallel runs).  <a name='474'></font>
   IF ( .NOT. PRESENT( no_shutdown ) ) THEN<a name='475'>
     <font color=#447700>! Finalize time manager<a name='476'></font>
      IF (coupler_on) THEN <a name='477'>
         CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_FINALIZE'>cpl_finalize</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_FINALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_FINALIZE_4">() <a name='478'>
      ELSE<a name='479'>
         CALL WRFU_Finalize<a name='480'>
         CALL <A href='../../html_code/frame/wrf_shutdown.F.html#WRF_SHUTDOWN'>wrf_shutdown</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_FINALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SHUTDOWN_3"><a name='481'>
      ENDIF<a name='482'>
   ENDIF<a name='483'>
<a name='484'>
   END SUBROUTINE wrf_finalize<a name='485'>
<a name='486'>
<a name='487'>
<A NAME='WRF_DFI'><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='488'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dfi</font>() <A href='../../call_to/WRF_DFI.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DFI.html' TARGET='index'>29</A><a name='489'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='490'></font>
<font color=#447700>! Runs a digital filter initialization procedure.<a name='491'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='492'></font>
      IMPLICIT NONE<a name='493'>
<a name='494'>
<font color=#447700>! #if (EM_CORE == 1)<a name='495'></font>
      <font color=#447700>! Initialization procedure<a name='496'></font>
      IF ( config_flags%dfi_opt .NE. DFI_NODFI ) THEN<a name='497'>
   <a name='498'>
         SELECT CASE ( config_flags%dfi_opt ) <a name='499'>
     <a name='500'>
            CASE (DFI_DFL)<a name='501'>
               wrf_err_message = 'Initializing with DFL'<a name='502'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_442">(TRIM(wrf_err_message))<a name='503'>
   <a name='504'>
               wrf_err_message = '   Filtering forward in time'<a name='505'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_443">(TRIM(wrf_err_message))<a name='506'>
   <a name='507'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_FWD_INIT'>wrf_dfi_fwd_init</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_FWD_INIT_1">()<a name='508'>
               CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN'>wrf_run</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_RUN_1">()<a name='509'>
   <a name='510'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET'>wrf_dfi_array_reset</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_ARRAY_RESET_1">()<a name='511'>
   <a name='512'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_FST_INIT'>wrf_dfi_fst_init</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_FST_INIT_1">()<a name='513'>
   <a name='514'>
               IF ( config_flags%dfi_write_filtered_input ) THEN<a name='515'>
                  CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_WRITE_INITIALIZED_STATE'>wrf_dfi_write_initialized_state</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_WRITE_INITIALIZED_STATE_1">()<a name='516'>
               END IF<a name='517'>
   <a name='518'>
            CASE (DFI_DDFI)<a name='519'>
               wrf_err_message = 'Initializing with DDFI'<a name='520'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_444">(TRIM(wrf_err_message))<a name='521'>
   <a name='522'>
               wrf_err_message = '   Integrating backward in time'<a name='523'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_445">(TRIM(wrf_err_message))<a name='524'>
   <a name='525'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_BCK_INIT'>wrf_dfi_bck_init</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_BCK_INIT_1">()<a name='526'>
               CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN'>wrf_run</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_RUN_2">()<a name='527'>
   <a name='528'>
               wrf_err_message = '   Filtering forward in time'<a name='529'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_446">(TRIM(wrf_err_message))<a name='530'>
   <a name='531'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_FWD_INIT'>wrf_dfi_fwd_init</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_FWD_INIT_2">()<a name='532'>
               CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN'>wrf_run</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_RUN_3">()<a name='533'>
   <a name='534'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET'>wrf_dfi_array_reset</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_ARRAY_RESET_2">()<a name='535'>
   <a name='536'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_FST_INIT'>wrf_dfi_fst_init</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_FST_INIT_2">()<a name='537'>
   <a name='538'>
               IF ( config_flags%dfi_write_filtered_input ) THEN<a name='539'>
                  CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_WRITE_INITIALIZED_STATE'>wrf_dfi_write_initialized_state</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_WRITE_INITIALIZED_STATE_2">()<a name='540'>
               END IF<a name='541'>
   <a name='542'>
            CASE (DFI_TDFI)<a name='543'>
               wrf_err_message = 'Initializing with TDFI'<a name='544'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_447">(TRIM(wrf_err_message))<a name='545'>
   <a name='546'>
               wrf_err_message = '   Integrating backward in time'<a name='547'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_448">(TRIM(wrf_err_message))<a name='548'>
   <a name='549'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_BCK_INIT'>wrf_dfi_bck_init</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_BCK_INIT_2">()<a name='550'>
               CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN'>wrf_run</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_RUN_4">()<a name='551'>
   <a name='552'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET'>wrf_dfi_array_reset</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_ARRAY_RESET_3">()<a name='553'>
   <a name='554'>
               wrf_err_message = '   Filtering forward in time'<a name='555'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_449">(TRIM(wrf_err_message))<a name='556'>
   <a name='557'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_FWD_INIT'>wrf_dfi_fwd_init</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_FWD_INIT_3">()<a name='558'>
               CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN'>wrf_run</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_RUN_5">()<a name='559'>
   <a name='560'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_ARRAY_RESET'>wrf_dfi_array_reset</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_ARRAY_RESET_4">()<a name='561'>
   <a name='562'>
               CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_FST_INIT'>wrf_dfi_fst_init</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_FST_INIT_3">()<a name='563'>
   <a name='564'>
               IF ( config_flags%dfi_write_filtered_input ) THEN<a name='565'>
                  CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_WRITE_INITIALIZED_STATE'>wrf_dfi_write_initialized_state</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_WRITE_INITIALIZED_STATE_3">()<a name='566'>
               END IF<a name='567'>
   <a name='568'>
            CASE DEFAULT<a name='569'>
               wrf_err_message = 'Unrecognized DFI_OPT in namelist'<a name='570'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/module_wrf_top.F.html#WRF_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_396">(TRIM(wrf_err_message))<a name='571'>
   <a name='572'>
         END SELECT<a name='573'>
   <a name='574'>
      END IF<a name='575'>
<font color=#447700>! #endif<a name='576'></font>
<a name='577'>
   END SUBROUTINE wrf_dfi<a name='578'>
<a name='579'>
<A NAME='SET_DERIVED_RCONFIGS'><A href='../../html_code/main/module_wrf_top.F.html#SET_DERIVED_RCONFIGS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='580'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_derived_rconfigs</font> <A href='../../call_to/SET_DERIVED_RCONFIGS.html' TARGET='index'>1</A><a name='581'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='582'></font>
<font color=#447700>! Some derived rconfig entries need to be set based on the value of other,<a name='583'></font>
<font color=#447700>! non-derived entries before package-dependent memory allocation takes place.<a name='584'></font>
<font color=#447700>! This might be employed when, for example, we want to allocate arrays in<a name='585'></font>
<font color=#447700>! a package that depends on the setting of two or more namelist variables.<a name='586'></font>
<font color=#447700>! In this subroutine, we do just that.<a name='587'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='588'></font>
<a name='589'>
      IMPLICIT NONE<a name='590'>
<a name='591'>
      INTEGER :: i<a name='592'>
<a name='593'>
<a name='594'>
<font color=#447700>! #if (EM_CORE == 1)<a name='595'></font>
      IF ( model_config_rec % dfi_opt .EQ. DFI_NODFI ) THEN<a name='596'>
        DO i = 1, model_config_rec % max_dom<a name='597'>
           model_config_rec % mp_physics_dfi(i) = -1<a name='598'>
        ENDDO<a name='599'>
      ELSE<a name='600'>
        DO i = 1, model_config_rec % max_dom<a name='601'>
           model_config_rec % mp_physics_dfi(i) = model_config_rec % mp_physics(i)<a name='602'>
        ENDDO<a name='603'>
      END IF<a name='604'>
<font color=#447700>! #endif<a name='605'></font>
<a name='606'>
#if (EM_CORE == 1)<a name='607'>
      IF ( model_config_rec % dfi_opt .EQ. DFI_NODFI ) THEN<a name='608'>
        DO i = 1, model_config_rec % max_dom<a name='609'>
           model_config_rec % bl_pbl_physics_dfi(i) = -1<a name='610'>
        ENDDO<a name='611'>
      ELSE<a name='612'>
        DO i = 1, model_config_rec % max_dom<a name='613'>
           model_config_rec % bl_pbl_physics_dfi(i) = model_config_rec % bl_pbl_physics(i)<a name='614'>
        ENDDO<a name='615'>
      END IF<a name='616'>
#endif<a name='617'>
<a name='618'>
#if (DA_CORE == 1)<a name='619'>
      IF ( model_config_rec % dyn_opt .EQ. 2 ) THEN<a name='620'>
        DO i = 1, model_config_rec % max_dom<a name='621'>
           model_config_rec % mp_physics_4dvar(i) = -1<a name='622'>
        ENDDO<a name='623'>
      ELSE<a name='624'>
        DO i = 1, model_config_rec % max_dom<a name='625'>
           model_config_rec % mp_physics_4dvar(i) = model_config_rec % mp_physics(i)<a name='626'>
        ENDDO<a name='627'>
      END IF<a name='628'>
#endif<a name='629'>
<a name='630'>
   END SUBROUTINE set_derived_rconfigs<a name='631'>
<a name='632'>
<A NAME='ALLOC_DOMS_FOR_DFI'><A href='../../html_code/main/module_wrf_top.F.html#ALLOC_DOMS_FOR_DFI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='633'>
   RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>alloc_doms_for_dfi</font> ( grid ) <A href='../../call_to/ALLOC_DOMS_FOR_DFI.html' TARGET='index'>2</A>,<A href='../../call_from/ALLOC_DOMS_FOR_DFI.html' TARGET='index'>5</A><a name='634'>
   <a name='635'>
      <font color=#447700>!  Input variables.<a name='636'></font>
<a name='637'>
      TYPE (domain) , pointer :: grid<a name='638'>
<a name='639'>
      <font color=#447700>!  Local variables.<a name='640'></font>
<a name='641'>
      TYPE (domain) , pointer :: new_nest_loc<a name='642'>
      TYPE (grid_config_rec_type) :: parent_config_flags<a name='643'>
      INTEGER :: nestid_loc , kid_loc<a name='644'>
   <a name='645'>
         <font color=#447700>!  Are there any subdomains from this level.  The output is the nestid (the domain<a name='646'></font>
         <font color=#447700>!  ID of the nest), and kid (an index to which of the parent's children this new nested<a name='647'></font>
         <font color=#447700>!  domain represents).<a name='648'></font>
   <a name='649'>
         DO WHILE ( nests_to_open( grid , nestid_loc , kid_loc ) )<a name='650'>
<a name='651'>
            <font color=#447700>!  If we found another child domain, we continue on: allocate, set up time keeping, <a name='652'></font>
            <font color=#447700>!  initialize.<a name='653'></font>
   <a name='654'>
            CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/module_wrf_top.F.html#ALLOC_DOMS_FOR_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_6"> ( domain_id  = nestid_loc   , &amp;<a name='655'>
                                              grid       = new_nest_loc , &amp;<a name='656'>
                                              parent     = grid         , &amp;<a name='657'>
                                              kid        = kid_loc        )<a name='658'>
         <a name='659'>
print *,'for parent domain id #',grid%id,', found child domain #',nestid_loc<a name='660'>
            <font color=#447700>!  Since this is a DFI run, set the DFI switches to the same for all domains.<a name='661'></font>
<a name='662'>
            new_nest_loc%dfi_opt = head_grid%dfi_opt<a name='663'>
            new_nest_loc%dfi_stage = DFI_SETUP<a name='664'>
         <a name='665'>
            <font color=#447700>!  Set up time keeping for the fine grid space that was just allocated.<a name='666'></font>
<a name='667'>
            CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/module_wrf_top.F.html#ALLOC_DOMS_FOR_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_5"> (new_nest_loc)<a name='668'>
<a name='669'>
            <font color=#447700>!  With space allocated, and timers set, the fine grid can be initialized with data.<a name='670'></font>
<a name='671'>
            CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/module_wrf_top.F.html#ALLOC_DOMS_FOR_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_24"> ( grid%id , model_config_rec , parent_config_flags )<a name='672'>
            CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL'>med_nest_initial</A><A href='../../html_code/main/module_wrf_top.F.html#ALLOC_DOMS_FOR_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_INITIAL_2"> ( grid , new_nest_loc , config_flags )<a name='673'>
<a name='674'>
            <font color=#447700>!  Here's the recursive part.  For each of these child domains, we call this same routine.<a name='675'></font>
            <font color=#447700>!  This will find all of "new_nest_loc" first generation progeny.<a name='676'></font>
   <a name='677'>
            CALL <A href='../../html_code/main/module_wrf_top.F.html#ALLOC_DOMS_FOR_DFI'>alloc_doms_for_dfi</A><A href='../../html_code/main/module_wrf_top.F.html#ALLOC_DOMS_FOR_DFI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_DOMS_FOR_DFI_2"> ( new_nest_loc )<a name='678'>
   <a name='679'>
         END DO<a name='680'>
   <a name='681'>
   END SUBROUTINE alloc_doms_for_dfi<a name='682'>
<a name='683'>
END MODULE module_wrf_top<a name='684'>
</pre></body></html>