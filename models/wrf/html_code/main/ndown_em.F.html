<HTML> <BODY BGCOLOR=#eeeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:MAIN<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='NDOWN_EM'><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='top_target'><IMG SRC="../../gif/bar_yellow.gif" border=0></A><a name='5'>
<font color=#993300>PROGRAM </font><font color=#cc0000>ndown_em</font>,<A href='../../call_from/NDOWN_EM.html' TARGET='index'>188</A><a name='6'>
<a name='7'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_17"><a name='8'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_183">, ONLY : domain, head_grid, alloc_and_configure_domain, &amp;<a name='9'>
                             domain_clock_set, domain_clock_get, get_ijk_from_grid<a name='10'>
   USE <A href='../../html_code/frame/module_domain_type.F.html#MODULE_DOMAIN_TYPE'>module_domain_type</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_TYPE_8">, ONLY : program_name<a name='11'>
   USE module_initialize_real, ONLY : wrfu_initialize, rebalance_driver<a name='12'>
   USE <A href='../../html_code/frame/module_integrate.F.html#MODULE_INTEGRATE'>module_integrate</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTEGRATE_2"><a name='13'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_49"><a name='14'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_121">, ONLY : grid_config_rec_type, model_config_rec<a name='15'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_9"><a name='16'>
   USE module_utility<a name='17'>
   USE <A href='../../html_code/share/module_check_a_mundo.F.html#MODULE_CHECK_A_MUNDO'>module_check_a_mundo</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CHECK_A_MUNDO_3"><a name='18'>
<a name='19'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_36"><a name='20'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_39"><a name='21'>
#ifdef DM_PARALLEL<a name='22'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_137"><a name='23'>
#endif<a name='24'>
<a name='25'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='26'></font>
<font color=#447700>!new for bc<a name='27'></font>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_13"><a name='28'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_5"><a name='29'>
   USE <A href='../../html_code/share/module_get_file_names.F.html#MODULE_GET_FILE_NAMES'>module_get_file_names</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GET_FILE_NAMES_1"><a name='30'>
#if ( WRF_CHEM == 1 )<a name='31'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='32'></font>
<font color=#447700>! for chemistry<a name='33'></font>
   USE module_input_chem_data<a name='34'>
<font color=#447700>!  USE module_input_chem_bioemiss<a name='35'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='36'></font>
#endif<a name='37'>
<a name='38'>
   IMPLICIT NONE<a name='39'>
 <font color=#447700>! interface<a name='40'></font>
   INTERFACE<a name='41'>
     <font color=#447700>! mediation-supplied<a name='42'></font>
     SUBROUTINE med_read_wrf_chem_bioemiss ( grid , config_flags)<a name='43'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_184"><a name='44'>
       TYPE (domain) grid<a name='45'>
       TYPE (grid_config_rec_type) config_flags<a name='46'>
     END SUBROUTINE med_read_wrf_chem_bioemiss<a name='47'>
<a name='48'>
     SUBROUTINE init_domain_constants_em_ptr ( parent , nest )<a name='49'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_185"><a name='50'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_122"><a name='51'>
       TYPE(domain), POINTER  :: parent , nest<a name='52'>
     END SUBROUTINE init_domain_constants_em_ptr<a name='53'>
<a name='54'>
     SUBROUTINE vertical_interp (nested_grid,znw_c,znu_c,cf1_c,cf2_c,cf3_c,cfn_c,cfn1_c,k_dim_c,c3h,c4h,c3f,c4f)<a name='55'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_186"><a name='56'>
         USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_123"><a name='57'>
         TYPE(domain), POINTER ::  nested_grid<a name='58'>
         INTEGER , INTENT (IN) :: k_dim_c<a name='59'>
         REAL , INTENT (IN) :: cf1_c,cf2_c,cf3_c,cfn_c,cfn1_c<a name='60'>
         REAL , DIMENSION(k_dim_c) , INTENT (IN) ::  znw_c,znu_c<a name='61'>
         REAL , DIMENSION(k_dim_c) , INTENT (IN) ::  c3h,c4h,c3f,c4f<a name='62'>
      END SUBROUTINE vertical_interp<a name='63'>
<a name='64'>
<a name='65'>
   END INTERFACE<a name='66'>
   INTEGER :: ids , ide , jds , jde , kds , kde<a name='67'>
   INTEGER :: ims , ime , jms , jme , kms , kme<a name='68'>
   INTEGER :: ips , ipe , jps , jpe , kps , kpe<a name='69'>
   INTEGER :: its , ite , jts , jte , kts , kte<a name='70'>
   INTEGER :: nids, nide, njds, njde, nkds, nkde,    &amp;<a name='71'>
              nims, nime, njms, njme, nkms, nkme,    &amp;<a name='72'>
              nips, nipe, njps, njpe, nkps, nkpe<a name='73'>
   INTEGER :: spec_bdy_width<a name='74'>
   INTEGER :: i , j , k , nvchem, nvmoist, nvscalar<a name='75'>
   INTEGER :: time_loop_max , time_loop<a name='76'>
   INTEGER :: total_time_sec , file_counter<a name='77'>
   INTEGER :: julyr , julday , iswater , map_proj<a name='78'>
   INTEGER :: icnt<a name='79'>
<a name='80'>
   REAL    :: dt , new_bdy_frq<a name='81'>
   REAL    :: gmt , cen_lat , cen_lon , dx , dy , truelat1 , truelat2 , moad_cen_lat , stand_lon<a name='82'>
<a name='83'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: ubdy3dtemp1 , vbdy3dtemp1 , tbdy3dtemp1 , pbdy3dtemp1 , qbdy3dtemp1<a name='84'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: mbdy2dtemp1<a name='85'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: ubdy3dtemp2 , vbdy3dtemp2 , tbdy3dtemp2 , pbdy3dtemp2 , qbdy3dtemp2<a name='86'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: mbdy2dtemp2<a name='87'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: cbdy3dtemp1 , cbdy3dtemp2<a name='88'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: sbdy3dtemp1 , sbdy3dtemp2<a name='89'>
   REAL , DIMENSION(:,:,:,:) , ALLOCATABLE :: cbdy3dtemp0<a name='90'>
   REAL , DIMENSION(:,:,:,:) , ALLOCATABLE :: qbdy3dtemp1_coupled, qbdy3dtemp2_coupled<a name='91'>
   REAL , DIMENSION(:,:,:,:) , ALLOCATABLE :: sbdy3dtemp1_coupled, sbdy3dtemp2_coupled<a name='92'>
<a name='93'>
   CHARACTER(LEN=19) :: start_date_char , current_date_char , end_date_char<a name='94'>
   CHARACTER(LEN=19) :: stopTimeStr<a name='95'>
<a name='96'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='97'></font>
<a name='98'>
   INTEGER :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='99'>
<a name='100'>
   REAL    :: time<a name='101'>
   INTEGER :: rc<a name='102'>
<a name='103'>
   INTEGER :: loop , levels_to_process<a name='104'>
   INTEGER , PARAMETER :: max_sanity_file_loop = 100<a name='105'>
<a name='106'>
   TYPE (domain) , POINTER :: keep_grid, grid_ptr, null_domain, parent_grid , nested_grid<a name='107'>
   TYPE (domain)           :: dummy<a name='108'>
   TYPE (grid_config_rec_type)              :: config_flags<a name='109'>
   INTEGER                 :: number_at_same_level<a name='110'>
   INTEGER                 :: time_step_begin_restart<a name='111'>
<a name='112'>
   INTEGER :: max_dom , domain_id , fid , fido, fidb , oid , idum1 , idum2 , ierr<a name='113'>
   INTEGER :: status_next_var<a name='114'>
   INTEGER :: debug_level<a name='115'>
   LOGICAL :: input_from_file , need_new_file<a name='116'>
   CHARACTER (LEN=19) :: date_string<a name='117'>
<a name='118'>
#ifdef DM_PARALLEL<a name='119'>
   INTEGER                 :: nbytes<a name='120'>
   INTEGER, PARAMETER      :: configbuflen = 4* CONFIG_BUF_LEN<a name='121'>
   INTEGER                 :: configbuf( configbuflen )<a name='122'>
   LOGICAL , EXTERNAL      :: wrf_dm_on_monitor<a name='123'>
#endif<a name='124'>
<a name='125'>
   INTEGER                 :: idsi<a name='126'>
   CHARACTER (LEN=256)     :: inpname , outname , bdyname<a name='127'>
   CHARACTER (LEN=256)     :: si_inpname<a name='128'>
character *19 :: temp19<a name='129'>
character *24 :: temp24 , temp24b<a name='130'>
character(len=24) :: start_date_hold<a name='131'>
<a name='132'>
   CHARACTER (LEN=256)     :: message<a name='133'>
integer :: ii<a name='134'>
<a name='135'>
#include "<A href='../../html_code/include/version_decl.html'>version_decl</A>"<A NAME="version_decl_1"><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='136'>
<a name='137'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!    mousta   <a name='138'></font>
    integer ::  n_ref_m,k_dim_c,k_dim_n<a name='139'>
real :: cf1_c,cf2_c,cf3_c,cfn_c,cfn1_c<a name='140'>
   REAL , DIMENSION(:) , ALLOCATABLE :: znw_c,znu_c<a name='141'>
   REAL , DIMENSION(:) , ALLOCATABLE :: c3h,c4h,c3f,c4f<a name='142'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!11<a name='143'></font>
<a name='144'>
   <font color=#447700>!  Interface block for routine that passes pointers and needs to know that they<a name='145'></font>
   <font color=#447700>!  are receiving pointers.<a name='146'></font>
<a name='147'>
   INTERFACE<a name='148'>
<a name='149'>
      SUBROUTINE med_interp_domain ( parent_grid , nested_grid )<a name='150'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_187"><a name='151'>
         USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_124"><a name='152'>
         TYPE(domain), POINTER :: parent_grid , nested_grid<a name='153'>
      END SUBROUTINE med_interp_domain<a name='154'>
<a name='155'>
      SUBROUTINE Setup_Timekeeping( parent_grid )<a name='156'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_188"><a name='157'>
         TYPE(domain), POINTER :: parent_grid<a name='158'>
      END SUBROUTINE Setup_Timekeeping<a name='159'>
<a name='160'>
      SUBROUTINE vert_cor(parent_grid,znw_c,k_dim_c)<a name='161'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_189"><a name='162'>
         TYPE(domain), POINTER :: parent_grid<a name='163'>
         integer , intent(in) :: k_dim_c<a name='164'>
         real , dimension(k_dim_c), INTENT(IN) :: znw_c<a name='165'>
      END SUBROUTINE vert_cor<a name='166'>
   END INTERFACE<a name='167'>
<a name='168'>
   <font color=#447700>!  Define the name of this program (program_name defined in module_domain)<a name='169'></font>
<a name='170'>
   program_name = "NDOWN_EM " // TRIM(release_version) // " PREPROCESSOR"<a name='171'>
<a name='172'>
#ifdef DM_PARALLEL<a name='173'>
   CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING'>disable_quilting</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DISABLE_QUILTING_3"><a name='174'>
#else<a name='175'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_397"> ( 'NDOWN :  HAVE TO BUILD FOR NESTING' )<a name='176'>
#endif<a name='177'>
<a name='178'>
   <font color=#447700>!  Initialize the modules used by the WRF system.  Many of the CALLs made from the<a name='179'></font>
   <font color=#447700>!  init_modules routine are NO-OPs.  Typical initializations are: the size of a <a name='180'></font>
   <font color=#447700>!  REAL, setting the file handles to a pre-use value, defining moisture and <a name='181'></font>
   <font color=#447700>!  chemistry indices, etc.<a name='182'></font>
<a name='183'>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_9">(1)   <font color=#447700>! Phase 1 returns after MPI_INIT() (if it is called)<a name='184'></font>
#ifdef NO_LEAP_CALENDAR<a name='185'>
   CALL WRFU_Initialize( defaultCalKind=WRFU_CAL_NOLEAP, rc=rc )<a name='186'>
#else<a name='187'>
   CALL WRFU_Initialize( defaultCalKind=WRFU_CAL_GREGORIAN, rc=rc )<a name='188'>
#endif<a name='189'>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_10">(2)   <font color=#447700>! Phase 2 resumes after MPI_INIT() (if it is called)<a name='190'></font>
<a name='191'>
   <font color=#447700>!  Get the NAMELIST data.  This is handled in the initial_config routine.  All of the<a name='192'></font>
   <font color=#447700>!  NAMELIST input variables are assigned to the model_config_rec structure.  Below,<a name='193'></font>
   <font color=#447700>!  note for parallel processing, only the monitor processor handles the raw Fortran<a name='194'></font>
   <font color=#447700>!  I/O, and then broadcasts the info to each of the other nodes.<a name='195'></font>
<a name='196'>
#ifdef DM_PARALLEL<a name='197'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='198'>
     CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_9"><a name='199'>
   ENDIF<a name='200'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_9">( configbuf, configbuflen, nbytes )<a name='201'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_112">( configbuf, nbytes )<a name='202'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_9">( configbuf, configbuflen )<a name='203'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_INITIALIZE'>wrf_dm_initialize</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_INITIALIZE_5"><a name='204'>
#else<a name='205'>
   CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_10"><a name='206'>
#endif<a name='207'>
<a name='208'>
   CALL <A href='../../html_code/share/module_check_a_mundo.F.html#CHECK_NML_CONSISTENCY'>check_nml_consistency</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_NML_CONSISTENCY_3"><a name='209'>
   CALL <A href='../../html_code/share/module_check_a_mundo.F.html#SETUP_PHYSICS_SUITE'>setup_physics_suite</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_PHYSICS_SUITE_2"><a name='210'>
   CALL <A href='../../html_code/share/module_check_a_mundo.F.html#SET_PHYSICS_RCONFIGS'>set_physics_rconfigs</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICS_RCONFIGS_3"><a name='211'>
<a name='212'>
   <font color=#447700>!  If we are running ndown, and that is WHERE we are now, make sure that we account<a name='213'></font>
   <font color=#447700>!  for folks forgetting to say that the aux_input2 stream is in place.<a name='214'></font>
<a name='215'>
   IF ( model_config_rec%io_form_auxinput2 .EQ. 0 ) THEN<a name='216'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_398">( 'ndown: Please set io_form_auxinput2 in the time_control namelist record (probably to 2).')<a name='217'>
   END IF<a name='218'>
<a name='219'>
<font color=#447700>!!!!!!!!!!!!!!! mousta<a name='220'></font>
   n_ref_m = model_config_rec % vert_refine_fact<a name='221'>
   k_dim_c = model_config_rec % e_vert(1)<a name='222'>
   k_dim_n = k_dim_c<a name='223'>
   if (n_ref_m .ge. 2) k_dim_n = (k_dim_c - 1) *  n_ref_m + 1<a name='224'>
   model_config_rec % e_vert(1) = k_dim_n<a name='225'>
   model_config_rec % e_vert(2) = k_dim_n<a name='226'>
   ALLOCATE(znw_c(k_dim_c))<a name='227'>
   ALLOCATE(znu_c(k_dim_c))<a name='228'>
   ALLOCATE(c3h(k_dim_c))<a name='229'>
   ALLOCATE(c4h(k_dim_c))<a name='230'>
   ALLOCATE(c3f(k_dim_c))<a name='231'>
   ALLOCATE(c4f(k_dim_c))<a name='232'>
   WRITE ( message , FMT = '(A,3I5)' ) 'KDIM_C', k_dim_c , model_config_rec % e_vert(1) , model_config_rec % e_vert(2)<a name='233'>
   CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_336"> (  99,message )<a name='234'>
<font color=#447700>!!!!!!!!!!!!!!! mousta<a name='235'></font>
<a name='236'>
   <font color=#447700>!  And here is an instance of using the information in the NAMELIST.  <a name='237'></font>
<a name='238'>
   CALL nl_get_debug_level ( 1, debug_level )<a name='239'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#SET_WRF_DEBUG_LEVEL'>set_wrf_debug_level</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_WRF_DEBUG_LEVEL_7"> ( debug_level )<a name='240'>
<a name='241'>
   <font color=#447700>!  Allocated and configure the mother domain.  Since we are in the nesting down<a name='242'></font>
   <font color=#447700>!  mode, we know a) we got a nest, and b) we only got 1 nest.<a name='243'></font>
<a name='244'>
   NULLIFY( null_domain )<a name='245'>
<a name='246'>
   CALL       <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_450"> ( program_name )<a name='247'>
   CALL       wrf_debug ( 100 , 'ndown_em: calling alloc_and_configure_domain coarse ' )<a name='248'>
   CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_7"> ( domain_id  = 1 ,                  &amp;<a name='249'>
                                     grid       = head_grid ,          &amp;<a name='250'>
                                     parent     = null_domain ,        &amp;<a name='251'>
                                     kid        = -1                   )<a name='252'>
<a name='253'>
   parent_grid =&gt; head_grid<a name='254'>
<a name='255'>
   <font color=#447700>!  Set up time initializations.<a name='256'></font>
<a name='257'>
   CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_6"> ( parent_grid )<a name='258'>
<a name='259'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_5">( head_grid, &amp;<a name='260'>
                          time_step_seconds=model_config_rec%interval_seconds )<a name='261'>
   CALL       wrf_debug ( 100 , 'ndown_em: calling model_to_grid_config_rec ' )<a name='262'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_25"> ( parent_grid%id , model_config_rec , config_flags )<a name='263'>
   CALL       wrf_debug ( 100 , 'ndown_em: calling set_scalar_indices_from_config ' )<a name='264'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_12"> ( parent_grid%id , idum1, idum2 )<a name='265'>
<a name='266'>
   <font color=#447700>!  Initialize the I/O for WRF.<a name='267'></font>
<a name='268'>
   CALL       wrf_debug ( 100 , 'ndown_em: calling init_wrfio' )<a name='269'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#INIT_WRFIO'>init_wrfio</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_WRFIO_5"><a name='270'>
<a name='271'>
   <font color=#447700>!  Some of the configuration values may have been modified from the initial READ<a name='272'></font>
   <font color=#447700>!  of the NAMELIST, so we re-broadcast the configuration records.<a name='273'></font>
<a name='274'>
#ifdef DM_PARALLEL<a name='275'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_10">( configbuf, configbuflen, nbytes )<a name='276'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_113">( configbuf, nbytes )<a name='277'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_10">( configbuf, configbuflen )<a name='278'>
#endif<a name='279'>
<a name='280'>
   <font color=#447700>!  We need to current and starting dates for the output files.  The times need to be incremented<a name='281'></font>
   <font color=#447700>!  so that the lateral BC files are not overwritten.<a name='282'></font>
<a name='283'>
#ifdef PLANET<a name='284'>
   WRITE ( start_date_char , FMT = '(I4.4,"-",I5.5,"_",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='285'>
           model_config_rec%start_year  (parent_grid%id) , &amp;<a name='286'>
           model_config_rec%start_day   (parent_grid%id) , &amp;<a name='287'>
           model_config_rec%start_hour  (parent_grid%id) , &amp;<a name='288'>
           model_config_rec%start_minute(parent_grid%id) , &amp;<a name='289'>
           model_config_rec%start_second(parent_grid%id) <a name='290'>
<a name='291'>
   WRITE (   end_date_char , FMT = '(I4.4,"-",I5.5,"_",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='292'>
           model_config_rec%  end_year  (parent_grid%id) , &amp;<a name='293'>
           model_config_rec%  end_day   (parent_grid%id) , &amp;<a name='294'>
           model_config_rec%  end_hour  (parent_grid%id) , &amp;<a name='295'>
           model_config_rec%  end_minute(parent_grid%id) , &amp;<a name='296'>
           model_config_rec%  end_second(parent_grid%id) <a name='297'>
#else<a name='298'>
   WRITE ( start_date_char , FMT = '(I4.4,"-",I2.2,"-",I2.2,"_",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='299'>
           model_config_rec%start_year  (parent_grid%id) , &amp;<a name='300'>
           model_config_rec%start_month (parent_grid%id) , &amp;<a name='301'>
           model_config_rec%start_day   (parent_grid%id) , &amp;<a name='302'>
           model_config_rec%start_hour  (parent_grid%id) , &amp;<a name='303'>
           model_config_rec%start_minute(parent_grid%id) , &amp;<a name='304'>
           model_config_rec%start_second(parent_grid%id) <a name='305'>
<a name='306'>
   WRITE (   end_date_char , FMT = '(I4.4,"-",I2.2,"-",I2.2,"_",I2.2,":",I2.2,":",I2.2)' ) &amp;<a name='307'>
           model_config_rec%  end_year  (parent_grid%id) , &amp;<a name='308'>
           model_config_rec%  end_month (parent_grid%id) , &amp;<a name='309'>
           model_config_rec%  end_day   (parent_grid%id) , &amp;<a name='310'>
           model_config_rec%  end_hour  (parent_grid%id) , &amp;<a name='311'>
           model_config_rec%  end_minute(parent_grid%id) , &amp;<a name='312'>
           model_config_rec%  end_second(parent_grid%id) <a name='313'>
#endif<a name='314'>
<a name='315'>
   <font color=#447700>!  Override stop time with value computed above.<a name='316'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_6">( parent_grid, stop_timestr=end_date_char )<a name='317'>
<a name='318'>
   CALL <A href='../../html_code/io_grib_share/io_grib_share.F.html#GETH_IDTS'>geth_idts</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_IDTS_1"> ( end_date_char , start_date_char , total_time_sec ) <a name='319'>
<a name='320'>
   new_bdy_frq = model_config_rec%interval_seconds<a name='321'>
   time_loop_max = total_time_sec / model_config_rec%interval_seconds + 1<a name='322'>
<a name='323'>
   start_date        = start_date_char // '.0000' <a name='324'>
   current_date      = start_date_char // '.0000' <a name='325'>
   start_date_hold   = start_date_char // '.0000'<a name='326'>
   current_date_char = start_date_char<a name='327'>
<a name='328'>
   <font color=#447700>!  Get a list of available file names to try.  This fills up the eligible_file_name<a name='329'></font>
   <font color=#447700>!  array with number_of_eligible_files entries.  This routine issues a nonstandard<a name='330'></font>
   <font color=#447700>!  call (system).<a name='331'></font>
<a name='332'>
   file_counter = 1<a name='333'>
   need_new_file = .FALSE.<a name='334'>
   CALL <A href='../../html_code/share/module_get_file_names.F.html#UNIX_LS'>unix_ls</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNIX_LS_1"> ( 'wrfout' , parent_grid%id )<a name='335'>
<a name='336'>
   <font color=#447700>!  Open the input data (wrfout_d01_xxxxxx) for reading.<a name='337'></font>
   <a name='338'>
   CALL wrf_debug          ( 100 , 'ndown_em main: calling open_r_dataset for ' // TRIM(eligible_file_name(file_counter)) )<a name='339'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_3">     ( fid, TRIM(eligible_file_name(file_counter)) , head_grid , config_flags , "DATASET=AUXINPUT1", ierr )<a name='340'>
   IF ( ierr .NE. 0 ) THEN<a name='341'>
      WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(eligible_file_name(file_counter)), &amp;<a name='342'>
                                                  ' for reading ierr=',ierr<a name='343'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_399"> ( wrf_err_message )<a name='344'>
   ENDIF<a name='345'>
<a name='346'>
   <font color=#447700>!  We know how many time periods to process, so we begin.<a name='347'></font>
<a name='348'>
   big_time_loop_thingy : DO time_loop = 1 , time_loop_max<a name='349'>
<a name='350'>
      <font color=#447700>!  Which date are we currently soliciting?<a name='351'></font>
<a name='352'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_5"> ( date_string , start_date_char , ( time_loop - 1 ) * NINT ( new_bdy_frq) )<a name='353'>
      WRITE ( message , FMT = '(A,I5," ",A,A)' ) '--------&gt;&gt;&gt;  Processing data: loop=',time_loop,'  date/time = ',date_string<a name='354'>
      CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_337"> (  99,message )<a name='355'>
      current_date_char = date_string<a name='356'>
      current_date      = date_string // '.0000'<a name='357'>
      start_date        = date_string // '.0000'<a name='358'>
      WRITE ( message , FMT = '(A,I5," ",A,A)' ) 'loopmax = ', time_loop_max, '   ending date = ',end_date_char<a name='359'>
      CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_338"> (  99,message )<a name='360'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_7">( parent_grid, &amp;<a name='361'>
                             current_timestr=current_date(1:19) )<a name='362'>
<a name='363'>
      <font color=#447700>!  Which times are in this file, and more importantly, are any of them the<a name='364'></font>
      <font color=#447700>!  ones that we want?  We need to loop over times in each files, loop<a name='365'></font>
      <font color=#447700>!  over files.<a name='366'></font>
<a name='367'>
      get_the_right_time : DO<a name='368'>
      <a name='369'>
         CALL <A href='../../html_code/frame/module_io.F.html#WRF_GET_NEXT_TIME'>wrf_get_next_time</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NEXT_TIME_1"> ( fid , date_string , status_next_var )<a name='370'>
         WRITE ( message , FMT = '(A,A,A,A,A,I5)' ) 'file date/time = ',date_string,'     desired date = ',&amp;<a name='371'>
         current_date_char,'     status = ', status_next_var<a name='372'>
         CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_339"> (  99,message )<a name='373'>
<a name='374'>
         IF      (  status_next_var .NE. 0 ) THEN<a name='375'>
            CALL wrf_debug          ( 100 , 'ndown_em main: calling close_dataset  for ' // TRIM(eligible_file_name(file_counter)) )<a name='376'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_6">      ( fid , config_flags , "DATASET=INPUT" )<a name='377'>
            file_counter = file_counter + 1<a name='378'>
            IF ( file_counter .GT. number_of_eligible_files ) THEN<a name='379'>
               WRITE( wrf_err_message , FMT='(A)' ) 'program ndown: opening too many files'<a name='380'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_451"> ( TRIM(wrf_err_message) )<a name='381'>
               WRITE( wrf_err_message , FMT='(A)' ) 'Usually, this is caused by trying to run ndown past the last time available d01 model output'<a name='382'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_452"> ( TRIM(wrf_err_message) )<a name='383'>
               WRITE( wrf_err_message , FMT='(A)' ) 'The CG model output is used to supply lateral boundary conditions'<a name='384'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_453"> ( TRIM(wrf_err_message) )<a name='385'>
               WRITE( wrf_err_message , FMT='(A)' ) 'The ndown program uses the start and end times, the WRF model for d01 likely used the run times option.'<a name='386'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_454"> ( TRIM(wrf_err_message) )<a name='387'>
               WRITE( wrf_err_message , FMT='(A)' ) 'Check the namelist.input time_control section for inconsistencies.'<a name='388'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_400"> ( wrf_err_message )<a name='389'>
            END IF<a name='390'>
            CALL wrf_debug      ( 100 , 'ndown_em main: calling open_r_dataset for ' // TRIM(eligible_file_name(file_counter)) )<a name='391'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_4"> ( fid, TRIM(eligible_file_name(file_counter)) , head_grid , config_flags , "DATASET=INPUT", ierr )<a name='392'>
            IF ( ierr .NE. 0 ) THEN<a name='393'>
               WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(eligible_file_name(file_counter)), &amp;<a name='394'>
                                                           ' for reading ierr=',ierr<a name='395'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_401"> ( wrf_err_message )<a name='396'>
            ENDIF<a name='397'>
            CYCLE get_the_right_time<a name='398'>
         ELSE IF ( TRIM(date_string) .LT. TRIM(current_date_char) ) THEN<a name='399'>
            CYCLE get_the_right_time<a name='400'>
         ELSE IF ( TRIM(date_string) .EQ. TRIM(current_date_char) ) THEN<a name='401'>
            EXIT get_the_right_time<a name='402'>
         ELSE IF ( TRIM(date_string) .GT. TRIM(current_date_char) ) THEN<a name='403'>
            WRITE( wrf_err_message , FMT='(A,A,A,A,A)' ) 'Found ',TRIM(date_string),' before I found ',TRIM(current_date_char),'.'<a name='404'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_402"> ( wrf_err_message )<a name='405'>
         END IF<a name='406'>
      END DO get_the_right_time <a name='407'>
<a name='408'>
      CALL wrf_debug          ( 100 , 'wrf: calling input_history' )<a name='409'>
      CALL <A href='../../html_code/frame/module_io.F.html#WRF_GET_PREVIOUS_TIME'>wrf_get_previous_time</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_PREVIOUS_TIME_1"> ( fid , date_string , status_next_var )<a name='410'>
      WRITE ( message , * ) 'CFB' ,cf1_c,cf2_c,cf3_c,cfn_c,cfn1_c,znw_c(1),znu_c(1)<a name='411'>
      CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_340"> (  99,message )<a name='412'>
      CALL input_history ( fid , head_grid , config_flags, ierr)<a name='413'>
<font color=#447700>!!!!!!!!!!!!!1   mousta<a name='414'></font>
      cf1_c = head_grid%cf1<a name='415'>
      cf2_c = head_grid%cf2<a name='416'>
      cf3_c = head_grid%cf3<a name='417'>
<a name='418'>
      cfn_c = head_grid%cfn<a name='419'>
      cfn1_c = head_grid%cfn1<a name='420'>
<a name='421'>
      do k = 1,k_dim_c<a name='422'>
      znw_c(k) = head_grid%znw(k)<a name='423'>
      znu_c(k) = head_grid%znu(k)<a name='424'>
      enddo<a name='425'>
      do k = 1,k_dim_c<a name='426'>
      c3h(k) = head_grid%c3h(k)<a name='427'>
      c4h(k) = head_grid%c4h(k)<a name='428'>
      c3f(k) = head_grid%c3f(k)<a name='429'>
      c4f(k) = head_grid%c4f(k)<a name='430'>
      enddo<a name='431'>
      call <A href='../../html_code/main/ndown_em.F.html#VERT_COR'>vert_cor</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_COR_1">(head_grid,znw_c,k_dim_c)<a name='432'>
      WRITE ( message , * ) 'CFA' ,cf1_c,cf2_c,cf3_c,cfn_c,cfn1_c,znw_c(1),znu_c(1)<a name='433'>
      CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_341"> (  99,message )<a name='434'>
      WRITE ( message , * ) 'CFV' ,head_grid%cf1,head_grid%cf2,head_grid%cf3,head_grid%cfn,head_grid%cfn1,&amp;<a name='435'>
      head_grid%znw(1),head_grid%znu(1) , head_grid%e_vert , parent_grid%cf1 , parent_grid%znw(1) , parent_grid%znu(1)<a name='436'>
      CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_342"> (  99,message )<a name='437'>
<font color=#447700>!!!!!!!!!!!!!1   mousta<a name='438'></font>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_343">          ( 100 , 'wrf: back from input_history' )<a name='439'>
<a name='440'>
      <font color=#447700>!  Get the coarse grid info for later transfer to the fine grid domain.<a name='441'></font>
<a name='442'>
      CALL wrf_get_dom_ti_integer ( fid , 'MAP_PROJ' , map_proj , 1 , icnt , ierr ) <a name='443'>
      CALL wrf_get_dom_ti_real    ( fid , 'DX'  , dx  , 1 , icnt , ierr ) <a name='444'>
      CALL wrf_get_dom_ti_real    ( fid , 'DY'  , dy  , 1 , icnt , ierr ) <a name='445'>
      CALL wrf_get_dom_ti_real    ( fid , 'CEN_LAT' , cen_lat , 1 , icnt , ierr ) <a name='446'>
      CALL wrf_get_dom_ti_real    ( fid , 'CEN_LON' , cen_lon , 1 , icnt , ierr ) <a name='447'>
      CALL wrf_get_dom_ti_real    ( fid , 'TRUELAT1' , truelat1 , 1 , icnt , ierr ) <a name='448'>
      CALL wrf_get_dom_ti_real    ( fid , 'TRUELAT2' , truelat2 , 1 , icnt , ierr ) <a name='449'>
      CALL wrf_get_dom_ti_real    ( fid , 'MOAD_CEN_LAT' , moad_cen_lat , 1 , icnt , ierr ) <a name='450'>
      CALL wrf_get_dom_ti_real    ( fid , 'STAND_LON' , stand_lon , 1 , icnt , ierr ) <a name='451'>
<font color=#447700>!     CALL wrf_get_dom_ti_real    ( fid , 'GMT' , gmt , 1 , icnt , ierr ) <a name='452'></font>
<font color=#447700>!     CALL wrf_get_dom_ti_integer ( fid , 'JULYR' , julyr , 1 , icnt , ierr ) <a name='453'></font>
<font color=#447700>!     CALL wrf_get_dom_ti_integer ( fid , 'JULDAY' , julday , 1 , icnt , ierr ) <a name='454'></font>
      CALL wrf_get_dom_ti_integer ( fid , 'ISWATER' , iswater , 1 , icnt , ierr ) <a name='455'>
<a name='456'>
      <font color=#447700>!  First time in, do this: allocate sapce for the fine grid, get the config flags, open the <a name='457'></font>
      <font color=#447700>!  wrfinput and wrfbdy files.  This COULD be done outside the time loop, I think, so check it<a name='458'></font>
      <font color=#447700>!  out and move it up if you can.<a name='459'></font>
<a name='460'>
      IF ( time_loop .EQ. 1 ) THEN<a name='461'>
<a name='462'>
         CALL       <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_455"> ( program_name )<a name='463'>
         CALL       wrf_debug ( 100 , 'wrf: calling alloc_and_configure_domain fine ' )<a name='464'>
         CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_8"> ( domain_id  = 2 ,                  &amp;<a name='465'>
                                           grid       = nested_grid ,        &amp;<a name='466'>
                                           parent     = parent_grid ,        &amp;<a name='467'>
                                           kid        = 1                   )<a name='468'>
   <a name='469'>
         CALL       wrf_debug ( 100 , 'wrf: calling model_to_grid_config_rec ' )<a name='470'>
         CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_26"> ( nested_grid%id , model_config_rec , config_flags )<a name='471'>
         CALL       wrf_debug ( 100 , 'wrf: calling set_scalar_indices_from_config ' )<a name='472'>
         CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_13"> ( nested_grid%id , idum1, idum2 )<a name='473'>
<a name='474'>
         <font color=#447700>!  Set up time initializations for the fine grid.<a name='475'></font>
<a name='476'>
         CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_7"> ( nested_grid )<a name='477'>
         <font color=#447700>! Strictly speaking, nest stop time should come from model_config_rec...  <a name='478'></font>
         CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_34">( parent_grid, stop_timestr=stopTimeStr )<a name='479'>
         CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_8">( nested_grid,                        &amp;<a name='480'>
                                current_timestr=current_date(1:19), &amp;<a name='481'>
                                stop_timestr=stopTimeStr ,          &amp;<a name='482'>
                                time_step_seconds=                  &amp;<a name='483'>
                                  model_config_rec%interval_seconds )<a name='484'>
<a name='485'>
         <font color=#447700>!  Generate an output file from this program, which will be an input file to WRF.<a name='486'></font>
<a name='487'>
         CALL nl_set_bdyfrq ( nested_grid%id , new_bdy_frq )<a name='488'>
         config_flags%bdyfrq = new_bdy_frq<a name='489'>
<a name='490'>
#if ( WRF_CHEM == 1 )<a name='491'>
nested_grid%chem_opt    = parent_grid%chem_opt<a name='492'>
nested_grid%chem_in_opt = parent_grid%chem_in_opt<a name='493'>
#endif<a name='494'>
<a name='495'>
         <font color=#447700>!  Initialize constants and 1d arrays in fine grid from the parent.<a name='496'></font>
<a name='497'>
         CALL <A href='../../html_code/main/ndown_em.F.html#INIT_DOMAIN_CONSTANTS_EM_PTR'>init_domain_constants_em_ptr</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_DOMAIN_CONSTANTS_EM_PTR_1"> ( parent_grid , nested_grid ) <a name='498'>
<a name='499'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='500'></font>
   <a name='501'>
         CALL wrf_debug          ( 100 , 'ndown_em main: calling open_w_dataset for wrfinput' )<a name='502'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_6">( outname , 'wrfinput' , nested_grid%id , 2 )<a name='503'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_6">     ( fido, TRIM(outname) , nested_grid , config_flags , output_input , "DATASET=INPUT", ierr )<a name='504'>
         IF ( ierr .NE. 0 ) THEN<a name='505'>
            WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(outname),' for reading ierr=',ierr<a name='506'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_403"> ( wrf_err_message )<a name='507'>
         ENDIF<a name='508'>
<a name='509'>
         <font color=#447700>!  Various sizes that we need to be concerned about.<a name='510'></font>
<a name='511'>
         ids = nested_grid%sd31<a name='512'>
         ide = nested_grid%ed31<a name='513'>
         kds = nested_grid%sd32<a name='514'>
         kde = nested_grid%ed32<a name='515'>
         jds = nested_grid%sd33<a name='516'>
         jde = nested_grid%ed33<a name='517'>
<a name='518'>
         ims = nested_grid%sm31<a name='519'>
         ime = nested_grid%em31<a name='520'>
         kms = nested_grid%sm32<a name='521'>
         kme = nested_grid%em32<a name='522'>
         jms = nested_grid%sm33<a name='523'>
         jme = nested_grid%em33<a name='524'>
<a name='525'>
         ips = nested_grid%sp31<a name='526'>
         ipe = nested_grid%ep31<a name='527'>
         kps = nested_grid%sp32<a name='528'>
         kpe = nested_grid%ep32<a name='529'>
         jps = nested_grid%sp33<a name='530'>
         jpe = nested_grid%ep33<a name='531'>
<a name='532'>
<a name='533'>
<font color=#447700>!        print *, ids , ide , jds , jde , kds , kde<a name='534'></font>
<font color=#447700>!        print *, ims , ime , jms , jme , kms , kme<a name='535'></font>
<font color=#447700>!        print *, ips , ipe , jps , jpe , kps , kpe<a name='536'></font>
<a name='537'>
         spec_bdy_width = model_config_rec%spec_bdy_width<a name='538'>
<a name='539'>
         <font color=#447700>!  This is the space needed to save the current 3d data for use in computing<a name='540'></font>
         <font color=#447700>!  the lateral boundary tendencies.<a name='541'></font>
<a name='542'>
         ALLOCATE ( ubdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='543'>
         ALLOCATE ( vbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='544'>
         ALLOCATE ( tbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='545'>
         ALLOCATE ( pbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='546'>
         ALLOCATE ( qbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='547'>
         ALLOCATE ( mbdy2dtemp1(ims:ime,1:1,    jms:jme) )<a name='548'>
         ALLOCATE ( ubdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='549'>
         ALLOCATE ( vbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='550'>
         ALLOCATE ( tbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='551'>
         ALLOCATE ( pbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='552'>
         ALLOCATE ( qbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='553'>
         ALLOCATE ( qbdy3dtemp1_coupled(ims:ime,kms:kme,jms:jme,1:num_moist) )<a name='554'>
         ALLOCATE ( qbdy3dtemp2_coupled(ims:ime,kms:kme,jms:jme,1:num_moist) )<a name='555'>
         ALLOCATE ( mbdy2dtemp2(ims:ime,1:1,    jms:jme) )<a name='556'>
         ALLOCATE ( cbdy3dtemp0(ims:ime,kms:kme,jms:jme,1:num_chem) )<a name='557'>
         ALLOCATE ( cbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='558'>
         ALLOCATE ( cbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='559'>
         ALLOCATE ( sbdy3dtemp1(ims:ime,kms:kme,jms:jme) )<a name='560'>
         ALLOCATE ( sbdy3dtemp2(ims:ime,kms:kme,jms:jme) )<a name='561'>
         ALLOCATE ( sbdy3dtemp1_coupled(ims:ime,kms:kme,jms:jme,1:num_scalar) )<a name='562'>
         ALLOCATE ( sbdy3dtemp2_coupled(ims:ime,kms:kme,jms:jme,1:num_scalar) )<a name='563'>
<a name='564'>
<a name='565'>
      END IF<a name='566'>
<a name='567'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_9">( nested_grid,                        &amp;<a name='568'>
                             current_timestr=current_date(1:19), &amp;<a name='569'>
                             time_step_seconds=                  &amp;<a name='570'>
                               model_config_rec%interval_seconds )<a name='571'>
<a name='572'>
      <font color=#447700>!  Do the horizontal interpolation.<a name='573'></font>
<a name='574'>
      nested_grid%imask_nostag = 1<a name='575'>
      nested_grid%imask_xstag = 1<a name='576'>
      nested_grid%imask_ystag = 1<a name='577'>
      nested_grid%imask_xystag = 1<a name='578'>
<a name='579'>
      CALL <A href='../../html_code/share/mediation_interp_domain.F.html#MED_INTERP_DOMAIN'>med_interp_domain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_INTERP_DOMAIN_1"> ( head_grid , nested_grid )<a name='580'>
      WRITE ( message , * ) 'MOUSTA_L', nested_grid%mu_2(ips,jps) , nested_grid%u_2(ips,kde-2,jps)<a name='581'>
      CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_344"> (  99,message )<a name='582'>
      CALL <A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP'>vertical_interp</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_INTERP_1"> (nested_grid,znw_c,znu_c,cf1_c,cf2_c,cf3_c,cfn_c,cfn1_c,k_dim_c,c3h,c4h,c3f,c4f)<a name='583'>
      WRITE ( message , * ) 'MOUSTA_V', nested_grid%mu_2(ips,jps) , nested_grid%u_2(ips,kde-2,jps)<a name='584'>
      CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_345"> (  99,message )<a name='585'>
      nested_grid%ht_int = nested_grid%ht<a name='586'>
<a name='587'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='588'></font>
<a name='589'>
      IF ( time_loop .EQ. 1 ) THEN<a name='590'>
<a name='591'>
         <font color=#447700>!  Dimension info for fine grid.<a name='592'></font>
<a name='593'>
         CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_96"> (  nested_grid ,                   &amp;<a name='594'>
                                   nids, nide, njds, njde, nkds, nkde,    &amp;<a name='595'>
                                   nims, nime, njms, njme, nkms, nkme,    &amp;<a name='596'>
                                   nips, nipe, njps, njpe, nkps, nkpe    )<a name='597'>
<a name='598'>
         <font color=#447700>!  Store horizontally interpolated terrain in temp location<a name='599'></font>
<a name='600'>
         CALL  <A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD'>copy_3d_field</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COPY_3D_FIELD_1"> ( nested_grid%ht_fine , nested_grid%ht , &amp;<a name='601'>
                               nids , nide , njds , njde , 1   , 1   , &amp;<a name='602'>
                               nims , nime , njms , njme , 1   , 1   , &amp;<a name='603'>
                               nips , nipe , njps , njpe , 1   , 1   )<a name='604'>
<a name='605'>
         <font color=#447700>!  Open the fine grid SI static file.<a name='606'></font>
   <a name='607'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_7">( si_inpname , 'wrfndi' , nested_grid%id , 2 )<a name='608'>
         CALL       wrf_debug ( 100 , 'med_sidata_input: calling open_r_dataset for ' // TRIM(si_inpname) )<a name='609'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_5"> ( idsi, TRIM(si_inpname) , nested_grid , config_flags , "DATASET=INPUT", ierr )<a name='610'>
         IF ( ierr .NE. 0 ) THEN<a name='611'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_404">( 'real: error opening FG input for reading: ' // TRIM (si_inpname) )<a name='612'>
         END IF<a name='613'>
<a name='614'>
         <font color=#447700>!  Input data.<a name='615'></font>
   <a name='616'>
         CALL       wrf_debug ( 100 , 'ndown_em: calling input_auxinput2' )<a name='617'>
         CALL input_auxinput2 ( idsi , nested_grid , config_flags , ierr )<a name='618'>
         nested_grid%ht_input = nested_grid%ht<a name='619'>
   <a name='620'>
         <font color=#447700>!  Close this fine grid static input file.<a name='621'></font>
   <a name='622'>
         CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_346"> ( 100 , 'ndown_em: closing fine grid static input' )<a name='623'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_7"> ( idsi , config_flags , "DATASET=INPUT" )<a name='624'>
<a name='625'>
         <font color=#447700>!  Blend parent and nest field of terrain.<a name='626'></font>
<a name='627'>
         CALL <A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN'>blend_terrain</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BLEND_TERRAIN_1"> ( nested_grid%ht_fine , nested_grid%ht , &amp;<a name='628'>
                               nids , nide , njds , njde , 1   , 1   , &amp;<a name='629'>
                               nims , nime , njms , njme , 1   , 1   , &amp;<a name='630'>
                               nips , nipe , njps , njpe , 1   , 1   )<a name='631'>
<a name='632'>
         nested_grid%ht_input = nested_grid%ht<a name='633'>
         nested_grid%ht_int   = nested_grid%ht_fine<a name='634'>
<a name='635'>
         <font color=#447700>!  We need a fine grid landuse in the interpolation.  So we need to generate<a name='636'></font>
         <font color=#447700>!  that field now.<a name='637'></font>
<a name='638'>
         IF      ( ( nested_grid%ivgtyp(ips,jps) .GT. 0 ) .AND. &amp;<a name='639'>
                   ( nested_grid%isltyp(ips,jps) .GT. 0 ) ) THEN<a name='640'>
            DO j = jps, MIN(jde-1,jpe)<a name='641'>
               DO i = ips, MIN(ide-1,ipe)<a name='642'>
                  nested_grid% vegcat(i,j) = nested_grid%ivgtyp(i,j)<a name='643'>
                  nested_grid%soilcat(i,j) = nested_grid%isltyp(i,j)<a name='644'>
               END DO<a name='645'>
            END DO<a name='646'>
<a name='647'>
         ELSE IF ( ( nested_grid% vegcat(ips,jps) .GT. 0.5 ) .AND. &amp;<a name='648'>
                   ( nested_grid%soilcat(ips,jps) .GT. 0.5 ) ) THEN<a name='649'>
            DO j = jps, MIN(jde-1,jpe)<a name='650'>
               DO i = ips, MIN(ide-1,ipe)<a name='651'>
                  nested_grid%ivgtyp(i,j) = NINT(nested_grid% vegcat(i,j))<a name='652'>
                  nested_grid%isltyp(i,j) = NINT(nested_grid%soilcat(i,j))<a name='653'>
               END DO<a name='654'>
            END DO<a name='655'>
<a name='656'>
         ELSE<a name='657'>
            num_veg_cat      = SIZE ( nested_grid%landusef , DIM=2 )<a name='658'>
            num_soil_top_cat = SIZE ( nested_grid%soilctop , DIM=2 )<a name='659'>
            num_soil_bot_cat = SIZE ( nested_grid%soilcbot , DIM=2 )<a name='660'>
   <a name='661'>
            CALL <A href='../../html_code/main/nup_em.F.html#LAND_PERCENTAGES'>land_percentages</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LAND_PERCENTAGES_1"> (  nested_grid%xland , &amp;<a name='662'>
                                     nested_grid%landusef , nested_grid%soilctop , nested_grid%soilcbot , &amp;<a name='663'>
                                     nested_grid%isltyp , nested_grid%ivgtyp , &amp;<a name='664'>
                                     num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='665'>
                                     ids , ide , jds , jde , kds , kde , &amp;<a name='666'>
                                     ims , ime , jms , jme , kms , kme , &amp;<a name='667'>
                                     ips , ipe , jps , jpe , kps , kpe , &amp;<a name='668'>
                                     model_config_rec%iswater(nested_grid%id) )<a name='669'>
<a name='670'>
          END IF<a name='671'>
<a name='672'>
          DO j = jps, MIN(jde-1,jpe)<a name='673'>
            DO i = ips, MIN(ide-1,ipe)<a name='674'>
               nested_grid%lu_index(i,j) = nested_grid%ivgtyp(i,j)<a name='675'>
            END DO<a name='676'>
         END DO<a name='677'>
<a name='678'>
#ifndef PLANET<a name='679'>
         CALL <A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY'>check_consistency</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_CONSISTENCY_1"> ( nested_grid%ivgtyp , nested_grid%isltyp , nested_grid%landmask , &amp;<a name='680'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='681'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='682'>
                                  ips , ipe , jps , jpe , kps , kpe , &amp;<a name='683'>
                                  model_config_rec%iswater(nested_grid%id) )<a name='684'>
<a name='685'>
         CALL <A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2'>check_consistency2</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_CONSISTENCY2_1">( nested_grid%ivgtyp , nested_grid%isltyp , nested_grid%landmask , &amp;<a name='686'>
                                  nested_grid%tmn , nested_grid%tsk , nested_grid%sst , nested_grid%xland , &amp;<a name='687'>
                                  nested_grid%tslb , nested_grid%smois , nested_grid%sh2o , &amp;<a name='688'>
                                  config_flags%num_soil_layers , nested_grid%id , &amp;<a name='689'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='690'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='691'>
                                  ips , ipe , jps , jpe , kps , kpe , &amp;<a name='692'>
                                  model_config_rec%iswater(nested_grid%id) )<a name='693'>
#endif<a name='694'>
<a name='695'>
      END IF<a name='696'>
<a name='697'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='698'></font>
   <a name='699'>
      <font color=#447700>!  We have 2 terrain elevations.  One is from input and the other is from the<a name='700'></font>
      <font color=#447700>!  the horizontal interpolation.<a name='701'></font>
<a name='702'>
      nested_grid%ht_fine = nested_grid%ht_input<a name='703'>
      nested_grid%ht      = nested_grid%ht_int<a name='704'>
<a name='705'>
      <font color=#447700>!  We have both the interpolated fields and the higher-resolution static fields.  From these<a name='706'></font>
      <font color=#447700>!  the rebalancing is now done.  Note also that the field nested_grid%ht is now from the <a name='707'></font>
      <font color=#447700>!  fine grid input file (after this call is completed).<a name='708'></font>
<a name='709'>
      CALL rebalance_driver ( nested_grid ) <a name='710'>
<a name='711'>
      <font color=#447700>!  Different things happen during the different time loops:<a name='712'></font>
      <font color=#447700>!      first loop - write wrfinput file, close data set, copy files to holder arrays<a name='713'></font>
      <font color=#447700>!      middle loops - diff 3d/2d arrays, compute and output bc<a name='714'></font>
      <font color=#447700>!      last loop - diff 3d/2d arrays, compute and output bc, write wrfbdy file, close wrfbdy file<a name='715'></font>
<a name='716'>
      IF ( time_loop .EQ. 1 ) THEN<a name='717'>
<a name='718'>
         <font color=#447700>!  Set the time info.<a name='719'></font>
<a name='720'>
<font color=#447700>!        print *,'current_date = ',current_date<a name='721'></font>
         CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_10">( nested_grid, &amp;<a name='722'>
                                current_timestr=current_date(1:19) )<a name='723'>
#if ( WRF_CHEM == 1 )<a name='724'>
<font color=#447700>!<a name='725'></font>
<font color=#447700>!         Put in chemistry data<a name='726'></font>
<font color=#447700>!<a name='727'></font>
         IF( nested_grid%chem_opt .NE. 0 ) then<a name='728'>
<font color=#447700>!           IF( nested_grid%chem_in_opt .EQ. 0 ) then<a name='729'></font>
             <font color=#447700>! Read the chemistry data from a previous wrf forecast (wrfout file)<a name='730'></font>
              <font color=#447700>! Generate chemistry data from a idealized vertical profile<a name='731'></font>
<font color=#447700>!             message = 'STARTING WITH BACKGROUND CHEMISTRY '<a name='732'></font>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_456"> ( message )<a name='733'>
<a name='734'>
<font color=#447700>!             CALL input_chem_profile ( nested_grid )<a name='735'></font>
<a name='736'>
              if(nested_grid%biomass_burn_opt == BIOMASSB) THEN<a name='737'>
                message = 'READING BIOMASS BURNING EMISSIONS DATA '<a name='738'>
                CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_457"> ( message )<a name='739'>
                CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_EMISSOPT3'>med_read_wrf_chem_emissopt3</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_EMISSOPT3_3"> ( nested_grid , config_flags)<a name='740'>
              end if<a name='741'>
<a name='742'>
              if(nested_grid%dust_opt == 1 .or. nested_grid%dmsemis_opt == 1         &amp;<a name='743'>
                 .or. nested_grid%chem_opt == 300  .or. nested_grid%chem_opt == 301) then <a name='744'>
                 message = 'READING GOCART BG AND/OR DUST and DMS REF FIELDS'<a name='745'>
                 CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_458"> ( message )<a name='746'>
                 CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_GOCART_BG'>med_read_wrf_chem_gocart_bg</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_GOCART_BG_3"> ( nested_grid , config_flags)<a name='747'>
              end if<a name='748'>
<a name='749'>
              if( nested_grid%bio_emiss_opt .eq. 2 )then<a name='750'>
                 message = 'READING BEIS3.11 EMISSIONS DATA'<a name='751'>
                 CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_459"> ( message )<a name='752'>
                 CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS'>med_read_wrf_chem_bioemiss</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_BIOEMISS_9"> ( nested_grid , config_flags)<a name='753'>
              else if( nested_grid%bio_emiss_opt == 3 ) THEN <a name='754'>
                 message = 'READING MEGAN 2 EMISSIONS DATA'<a name='755'>
                 CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_460"> ( message )<a name='756'>
                 CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS'>med_read_wrf_chem_bioemiss</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_BIOEMISS_10"> ( nested_grid , config_flags)<a name='757'>
              endif<a name='758'>
<font color=#447700>!           ELSE<a name='759'></font>
<font color=#447700>!             message = 'RUNNING WITHOUT CHEMISTRY INITIALIZATION'<a name='760'></font>
<font color=#447700>!             CALL  wrf_message ( message )<a name='761'></font>
<font color=#447700>!           ENDIF<a name='762'></font>
         ENDIF<a name='763'>
#endif<a name='764'>
<a name='765'>
         <font color=#447700>!  Output the first time period of the data.<a name='766'></font>
   <a name='767'>
         CALL output_input ( fido , nested_grid , config_flags , ierr )<a name='768'>
<a name='769'>
         CALL wrf_put_dom_ti_integer ( fido , 'MAP_PROJ' , map_proj , 1 , ierr ) <a name='770'>
<font color=#447700>!        CALL wrf_put_dom_ti_real    ( fido , 'DX'  , dx  , 1 , ierr ) <a name='771'></font>
<font color=#447700>!        CALL wrf_put_dom_ti_real    ( fido , 'DY'  , dy  , 1 , ierr ) <a name='772'></font>
         CALL wrf_put_dom_ti_real    ( fido , 'CEN_LAT' , cen_lat , 1 , ierr ) <a name='773'>
         CALL wrf_put_dom_ti_real    ( fido , 'CEN_LON' , cen_lon , 1 , ierr ) <a name='774'>
         CALL wrf_put_dom_ti_real    ( fido , 'TRUELAT1' , truelat1 , 1 , ierr ) <a name='775'>
         CALL wrf_put_dom_ti_real    ( fido , 'TRUELAT2' , truelat2 , 1 , ierr ) <a name='776'>
         CALL wrf_put_dom_ti_real    ( fido , 'MOAD_CEN_LAT' , moad_cen_lat , 1 , ierr ) <a name='777'>
         CALL wrf_put_dom_ti_real    ( fido , 'STAND_LON' , stand_lon , 1 , ierr ) <a name='778'>
         CALL wrf_put_dom_ti_integer ( fido , 'ISWATER' , iswater , 1 , ierr ) <a name='779'>
<a name='780'>
         <font color=#447700>!  These change if the initial time for the nest is not the same as the<a name='781'></font>
         <font color=#447700>!  first time period in the WRF output file.<a name='782'></font>
         <font color=#447700>!  Now that we know the starting date, we need to set the GMT, JULYR, and JULDAY<a name='783'></font>
         <font color=#447700>!  values for the global attributes.  This call is based on the setting of the <a name='784'></font>
         <font color=#447700>!  current_date string.<a name='785'></font>
<a name='786'>
         CALL <A href='../../html_code/share/module_date_time.F.html#GETH_JULGMT'>geth_julgmt</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_JULGMT_2"> ( julyr , julday , gmt)<a name='787'>
         CALL nl_set_julyr  ( nested_grid%id , julyr  )<a name='788'>
         CALL nl_set_julday ( nested_grid%id , julday )<a name='789'>
         CALL nl_set_gmt    ( nested_grid%id , gmt    )<a name='790'>
         CALL wrf_put_dom_ti_real    ( fido , 'GMT' , gmt , 1 , ierr ) <a name='791'>
         CALL wrf_put_dom_ti_integer ( fido , 'JULYR' , julyr , 1 , ierr ) <a name='792'>
         CALL wrf_put_dom_ti_integer ( fido , 'JULDAY' , julday , 1 , ierr ) <a name='793'>
<font color=#447700>!print *,'current_date =',current_date<a name='794'></font>
<font color=#447700>!print *,'julyr=',julyr<a name='795'></font>
<font color=#447700>!print *,'julday=',julday<a name='796'></font>
<font color=#447700>!print *,'gmt=',gmt<a name='797'></font>
         <a name='798'>
         <font color=#447700>!  Close the input (wrfout_d01_000000, for example) file.  That's right, the <a name='799'></font>
         <font color=#447700>!  input is an output file.  Who'd've thunk.<a name='800'></font>
   <a name='801'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_8">      ( fido , config_flags , "DATASET=INPUT" )<a name='802'>
<a name='803'>
         <font color=#447700>!  We need to save the 3d/2d data to compute a difference during the next loop.  Couple the<a name='804'></font>
         <font color=#447700>!  3d fields with total mu (mub + mu_2) and the stagger-specific map scale factor.<a name='805'></font>
<a name='806'>
         <font color=#447700>! u, theta, h, scalars coupled with my, v coupled with mx<a name='807'></font>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_1"> ( nested_grid%mu_2 , nested_grid%mub , ubdy3dtemp1 , nested_grid%u_2                 , &amp;<a name='808'>
                       'u' , nested_grid%msfuy , &amp;<a name='809'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='810'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='811'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_2"> ( nested_grid%mu_2 , nested_grid%mub , vbdy3dtemp1 , nested_grid%v_2                 , &amp;<a name='812'>
                       'v' , nested_grid%msfvx , &amp;<a name='813'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='814'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='815'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_3"> ( nested_grid%mu_2 , nested_grid%mub , tbdy3dtemp1 , nested_grid%t_2                 , &amp;<a name='816'>
                       't' , nested_grid%msfty , &amp;<a name='817'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='818'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='819'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_4"> ( nested_grid%mu_2 , nested_grid%mub , pbdy3dtemp1 , nested_grid%ph_2                , &amp;<a name='820'>
                       'h' , nested_grid%msfty , &amp;<a name='821'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='822'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='823'>
         DO nvmoist=PARAM_FIRST_SCALAR, num_moist<a name='824'>
           CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_5"> ( nested_grid%mu_2 , nested_grid%mub , qbdy3dtemp1 , nested_grid%moist(ims:ime,kms:kme,jms:jme,nvmoist)    , &amp;<a name='825'>
                         't' , nested_grid%msfty , &amp;<a name='826'>
                         nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='827'>
                         ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='828'>
           qbdy3dtemp1_coupled(:,:,:,nvmoist) =  qbdy3dtemp1<a name='829'>
         END DO<a name='830'>
         DO nvscalar=PARAM_FIRST_SCALAR, num_scalar<a name='831'>
           CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_6"> ( nested_grid%mu_2 , nested_grid%mub , sbdy3dtemp1 , nested_grid%scalar(ims:ime,kms:kme,jms:jme,nvscalar)    , &amp;<a name='832'>
                         't' , nested_grid%msfty , &amp;<a name='833'>
                         nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='834'>
                         ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='835'>
           sbdy3dtemp1_coupled(:,:,:,nvscalar) =  sbdy3dtemp1<a name='836'>
         END DO<a name='837'>
<a name='838'>
          DO j = jps , jpe<a name='839'>
             DO i = ips , ipe<a name='840'>
                mbdy2dtemp1(i,1,j) = nested_grid%mu_2(i,j)<a name='841'>
             END DO<a name='842'>
          END DO<a name='843'>
<a name='844'>
         <font color=#447700>!  There are 2 components to the lateral boundaries.  First, there is the starting<a name='845'></font>
         <font color=#447700>!  point of this time period - just the outer few rows and columns.<a name='846'></font>
<a name='847'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_1">     ( ubdy3dtemp1 , nested_grid%u_bxs, nested_grid%u_bxe,                        &amp;<a name='848'>
                                            nested_grid%u_bys, nested_grid%u_bye,                        &amp;<a name='849'>
                                                                     'U' ,               spec_bdy_width      , &amp;<a name='850'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='851'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='852'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='853'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_2">     ( vbdy3dtemp1 , nested_grid%v_bxs, nested_grid%v_bxe,                        &amp;<a name='854'>
                                            nested_grid%v_bys, nested_grid%v_bye,                        &amp;<a name='855'>
                                                                     'V' ,               spec_bdy_width      , &amp;<a name='856'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='857'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='858'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='859'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_3">     ( tbdy3dtemp1 , nested_grid%t_bxs, nested_grid%t_bxe,                        &amp;<a name='860'>
                                            nested_grid%t_bys, nested_grid%t_bye,                        &amp;<a name='861'>
                                                                     'T' ,               spec_bdy_width      , &amp;<a name='862'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='863'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='864'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='865'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_4">     ( pbdy3dtemp1 , nested_grid%ph_bxs, nested_grid%ph_bxe,                      &amp;<a name='866'>
                                            nested_grid%ph_bys, nested_grid%ph_bye,                      &amp;<a name='867'>
                                                                     'W' ,               spec_bdy_width      , &amp;<a name='868'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='869'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='870'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='871'>
         DO nvmoist=PARAM_FIRST_SCALAR, num_moist<a name='872'>
           qbdy3dtemp1 = qbdy3dtemp1_coupled(:,:,:,nvmoist)<a name='873'>
           CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_5">     ( qbdy3dtemp1 , nested_grid%moist_bxs(jms:jme,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='874'>
                                              nested_grid%moist_bxe(jms:jme,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='875'>
                                              nested_grid%moist_bys(ims:ime,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='876'>
                                              nested_grid%moist_bye(ims:ime,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='877'>
                                                                    'T' ,               spec_bdy_width      , &amp;<a name='878'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='879'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='880'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='881'>
         END DO<a name='882'>
<a name='883'>
         DO nvscalar=PARAM_FIRST_SCALAR, num_scalar<a name='884'>
           sbdy3dtemp1 = sbdy3dtemp1_coupled(:,:,:,nvscalar)<a name='885'>
           CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_6">     ( sbdy3dtemp1 , nested_grid%scalar_bxs(jms:jme,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='886'>
                                              nested_grid%scalar_bxe(jms:jme,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='887'>
                                              nested_grid%scalar_bys(ims:ime,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='888'>
                                              nested_grid%scalar_bye(ims:ime,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='889'>
                                                                     'T' ,                 spec_bdy_width      , &amp;<a name='890'>
                                                                             ids , ide , jds , jde , kds , kde , &amp;<a name='891'>
                                                                             ims , ime , jms , jme , kms , kme , &amp;<a name='892'>
                                                                             ips , ipe , jps , jpe , kps , kpe )<a name='893'>
         END DO<a name='894'>
<a name='895'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_7">     ( mbdy2dtemp1 , nested_grid%mu_bxs, nested_grid%mu_bxe,                      &amp;<a name='896'>
                                            nested_grid%mu_bys, nested_grid%mu_bye,                      &amp;<a name='897'>
                                                                     'M' ,               spec_bdy_width      , &amp;<a name='898'>
                                                                           ids , ide , jds , jde , 1 , 1 , &amp;<a name='899'>
                                                                           ims , ime , jms , jme , 1 , 1 , &amp;<a name='900'>
                                                                           ips , ipe , jps , jpe , 1 , 1 )<a name='901'>
#if ( WRF_CHEM == 1 )<a name='902'>
         do nvchem=1,num_chem<a name='903'>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='904'></font>
<font color=#447700>!          write(0,*)'fill ch_b',cbdy3dtemp1(5,1,5),nvchem<a name='905'></font>
<font color=#447700>!        endif<a name='906'></font>
         cbdy3dtemp1(ips:ipe,kps:kpe,jps:jpe)=nested_grid%chem(ips:ipe,kps:kpe,jps:jpe,nvchem)<a name='907'>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='908'></font>
<font color=#447700>!          write(0,*)'fill ch_b',cbdy3dtemp1(5,1,5)<a name='909'></font>
<font color=#447700>!        endif<a name='910'></font>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_8">     ( cbdy3dtemp1 , nested_grid%chem_bxs(jms:jme,kms:kme,1:spec_bdy_width,nvchem),                                &amp;<a name='911'>
                                            nested_grid%chem_bxe(jms:jme,kms:kme,1:spec_bdy_width,nvchem),                                &amp;<a name='912'>
                                            nested_grid%chem_bys(ims:ime,kms:kme,1:spec_bdy_width,nvchem),                                &amp;<a name='913'>
                                            nested_grid%chem_bye(ims:ime,kms:kme,1:spec_bdy_width,nvchem),                                &amp;<a name='914'>
                                                                     'T' ,               spec_bdy_width      , &amp;<a name='915'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='916'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='917'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='918'>
           cbdy3dtemp0(ips:ipe,kps:kpe,jps:jpe,nvchem)=cbdy3dtemp1(ips:ipe,kps:kpe,jps:jpe)<a name='919'>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='920'></font>
<font color=#447700>!          write(0,*)'filled ch_b',time_loop,cbdy3dtemp1(ips,kps,jps),cbdy3dtemp0(ips,kps,jps,nvchem)<a name='921'></font>
<font color=#447700>!        endif<a name='922'></font>
         enddo<a name='923'>
#endif<a name='924'>
      ELSE IF ( ( time_loop .GT. 1 ) .AND. ( time_loop .LT. time_loop_max ) ) THEN<a name='925'>
<a name='926'>
         <font color=#447700>! u, theta, h, scalars coupled with my, v coupled with mx<a name='927'></font>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_7"> ( nested_grid%mu_2 , nested_grid%mub , ubdy3dtemp2 , nested_grid%u_2                 , &amp;<a name='928'>
                       'u' , nested_grid%msfuy , &amp;<a name='929'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='930'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='931'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_8"> ( nested_grid%mu_2 , nested_grid%mub , vbdy3dtemp2 , nested_grid%v_2                 , &amp;<a name='932'>
                       'v' , nested_grid%msfvx , &amp;<a name='933'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='934'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='935'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_9"> ( nested_grid%mu_2 , nested_grid%mub , tbdy3dtemp2 , nested_grid%t_2                 , &amp;<a name='936'>
                       't' , nested_grid%msfty , &amp;<a name='937'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='938'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='939'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_10"> ( nested_grid%mu_2 , nested_grid%mub , pbdy3dtemp2 , nested_grid%ph_2                , &amp;<a name='940'>
                       'h' , nested_grid%msfty , &amp;<a name='941'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='942'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='943'>
         DO nvmoist=PARAM_FIRST_SCALAR, num_moist<a name='944'>
           CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_11"> ( nested_grid%mu_2 , nested_grid%mub , qbdy3dtemp2 , nested_grid%moist(ims:ime,kms:kme,jms:jme,nvmoist)    , &amp;<a name='945'>
                         't' , nested_grid%msfty , &amp;<a name='946'>
                         nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='947'>
                         ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='948'>
           qbdy3dtemp2_coupled(:,:,:,nvmoist) =  qbdy3dtemp2<a name='949'>
         END DO<a name='950'>
         DO nvscalar=PARAM_FIRST_SCALAR, num_scalar<a name='951'>
           CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_12"> ( nested_grid%mu_2 , nested_grid%mub , sbdy3dtemp2 , nested_grid%scalar(ims:ime,kms:kme,jms:jme,nvscalar)    , &amp;<a name='952'>
                         't' , nested_grid%msfty , &amp;<a name='953'>
                         nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='954'>
                         ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='955'>
           sbdy3dtemp2_coupled(:,:,:,nvscalar) =  sbdy3dtemp2<a name='956'>
         END DO<a name='957'>
<a name='958'>
          DO j = jps , jpe<a name='959'>
             DO i = ips , ipe<a name='960'>
                mbdy2dtemp2(i,1,j) = nested_grid%mu_2(i,j)<a name='961'>
             END DO<a name='962'>
          END DO<a name='963'>
<a name='964'>
         <font color=#447700>!  During all of the loops after the first loop, we first compute the boundary<a name='965'></font>
         <font color=#447700>!  tendencies with the current data values and the previously save information<a name='966'></font>
         <font color=#447700>!  stored in the *bdy3dtemp1 arrays.<a name='967'></font>
<a name='968'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_1"> ( ubdy3dtemp2 , ubdy3dtemp1 , new_bdy_frq ,                               &amp;<a name='969'>
                                            nested_grid%u_btxs, nested_grid%u_btxe   ,          &amp;<a name='970'>
                                            nested_grid%u_btys, nested_grid%u_btye   ,          &amp;<a name='971'>
                                                                  'U'  , &amp;<a name='972'>
                                                                                spec_bdy_width      , &amp;<a name='973'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='974'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='975'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='976'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_2"> ( vbdy3dtemp2 , vbdy3dtemp1 , new_bdy_frq ,                               &amp;<a name='977'>
                                            nested_grid%v_btxs, nested_grid%v_btxe   ,          &amp;<a name='978'>
                                            nested_grid%v_btys, nested_grid%v_btye   ,          &amp;<a name='979'>
                                                                  'V'  , &amp;<a name='980'>
                                                                                spec_bdy_width      , &amp;<a name='981'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='982'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='983'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='984'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_3"> ( tbdy3dtemp2 , tbdy3dtemp1 , new_bdy_frq ,                               &amp;<a name='985'>
                                            nested_grid%t_btxs, nested_grid%t_btxe   ,          &amp;<a name='986'>
                                            nested_grid%t_btys, nested_grid%t_btye   ,          &amp;<a name='987'>
                                                                  'T'  , &amp;<a name='988'>
                                                                                spec_bdy_width      , &amp;<a name='989'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='990'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='991'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='992'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_4"> ( pbdy3dtemp2 , pbdy3dtemp1 , new_bdy_frq ,                               &amp;<a name='993'>
                                            nested_grid%ph_btxs, nested_grid%ph_btxe   ,        &amp;<a name='994'>
                                            nested_grid%ph_btys, nested_grid%ph_btye   ,        &amp;<a name='995'>
                                                                  'W' , &amp;<a name='996'>
                                                                                spec_bdy_width      , &amp;<a name='997'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='998'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='999'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1000'>
         DO nvmoist=PARAM_FIRST_SCALAR, num_moist<a name='1001'>
           qbdy3dtemp1 = qbdy3dtemp1_coupled(:,:,:,nvmoist)<a name='1002'>
           qbdy3dtemp2 = qbdy3dtemp2_coupled(:,:,:,nvmoist)<a name='1003'>
           CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_5"> ( qbdy3dtemp2 , qbdy3dtemp1 , new_bdy_frq ,                               &amp;<a name='1004'>
                                              nested_grid%moist_btxs(jms:jme,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='1005'>
                                              nested_grid%moist_btxe(jms:jme,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='1006'>
                                              nested_grid%moist_btys(ims:ime,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='1007'>
                                              nested_grid%moist_btye(ims:ime,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='1008'>
                                                                  'T' , &amp;<a name='1009'>
                                                                                spec_bdy_width      , &amp;<a name='1010'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1011'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1012'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1013'>
         END DO<a name='1014'>
<a name='1015'>
         DO nvscalar=PARAM_FIRST_SCALAR, num_scalar<a name='1016'>
           sbdy3dtemp1 = sbdy3dtemp1_coupled(:,:,:,nvscalar)<a name='1017'>
           sbdy3dtemp2 = sbdy3dtemp2_coupled(:,:,:,nvscalar)<a name='1018'>
           CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_6"> ( sbdy3dtemp2 , sbdy3dtemp1 , new_bdy_frq ,  &amp;<a name='1019'>
                                              nested_grid%scalar_btxs(jms:jme,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1020'>
                                              nested_grid%scalar_btxe(jms:jme,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1021'>
                                              nested_grid%scalar_btys(ims:ime,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1022'>
                                              nested_grid%scalar_btye(ims:ime,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1023'>
                                                                 'T' , &amp;<a name='1024'>
                                                                                spec_bdy_width,       &amp;<a name='1025'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1026'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1027'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1028'>
         END DO<a name='1029'>
<a name='1030'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_7"> ( mbdy2dtemp2 , mbdy2dtemp1 , new_bdy_frq ,                               &amp;<a name='1031'>
                                            nested_grid%mu_btxs, nested_grid%mu_btxe   ,        &amp;<a name='1032'>
                                            nested_grid%mu_btys, nested_grid%mu_btye   ,        &amp;<a name='1033'>
                                                                  'M' , &amp;<a name='1034'>
                                                                                spec_bdy_width      , &amp;<a name='1035'>
                                                                  ids , ide , jds , jde , 1 , 1 , &amp;<a name='1036'>
                                                                  ims , ime , jms , jme , 1 , 1 , &amp;<a name='1037'>
                                                                  ips , ipe , jps , jpe , 1 , 1 )<a name='1038'>
#if ( WRF_CHEM == 1 )<a name='1039'>
         do nvchem=1,num_chem<a name='1040'>
         cbdy3dtemp1(ips:ipe,kps:kpe,jps:jpe)=cbdy3dtemp0(ips:ipe,kps:kpe,jps:jpe,nvchem) <a name='1041'>
         cbdy3dtemp2(ips:ipe,kps:kpe,jps:jpe)=nested_grid%chem(ips:ipe,kps:kpe,jps:jpe,nvchem)<a name='1042'>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='1043'></font>
<font color=#447700>!          write(0,*)'fill 1ch_b2',time_loop,cbdy3dtemp1(ips,kps,jps),cbdy3dtemp0(ips,kps,jps,nvchem),cbdy3dtemp2(ips,kps,jps)<a name='1044'></font>
<font color=#447700>!        endif<a name='1045'></font>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_8"> ( cbdy3dtemp2 , cbdy3dtemp1 , new_bdy_frq ,  &amp;<a name='1046'>
                                            nested_grid%chem_btxs(jms:jme,kms:kme,1:spec_bdy_width,nvchem), &amp;<a name='1047'>
                                            nested_grid%chem_btxe(jms:jme,kms:kme,1:spec_bdy_width,nvchem), &amp;<a name='1048'>
                                            nested_grid%chem_btys(ims:ime,kms:kme,1:spec_bdy_width,nvchem), &amp;<a name='1049'>
                                            nested_grid%chem_btye(ims:ime,kms:kme,1:spec_bdy_width,nvchem), &amp;<a name='1050'>
                                                                 'T' , &amp;<a name='1051'>
                                                                                spec_bdy_width      , &amp;<a name='1052'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1053'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1054'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1055'>
         cbdy3dtemp0(ips:ipe,kps:kpe,jps:jpe,nvchem)=cbdy3dtemp2(ips:ipe,kps:kpe,jps:jpe) <a name='1056'>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='1057'></font>
<font color=#447700>!          write(0,*)'fill 2ch_b2',cbdy3dtemp1(ips,kps,jps),cbdy3dtemp0(ips,kps,jps,nvchem),cbdy3dtemp2(ips,kps,jps)<a name='1058'></font>
<font color=#447700>!        endif<a name='1059'></font>
         enddo<a name='1060'>
#endif<a name='1061'>
         IF ( time_loop .EQ. 2 ) THEN<a name='1062'>
   <a name='1063'>
            <font color=#447700>!  Generate an output file from this program, which will be an input file to WRF.<a name='1064'></font>
<a name='1065'>
            CALL wrf_debug          ( 100 , 'ndown_em main: calling open_w_dataset for wrfbdy' )<a name='1066'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_8">( bdyname , 'wrfbdy' , nested_grid%id , 2 )<a name='1067'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_7">     ( fidb, TRIM(bdyname) , nested_grid , config_flags , output_boundary , &amp;<a name='1068'>
                                      "DATASET=BOUNDARY", ierr )<a name='1069'>
            IF ( ierr .NE. 0 ) THEN<a name='1070'>
               WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(bdyname),' for reading ierr=',ierr<a name='1071'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_405"> ( wrf_err_message )<a name='1072'>
            ENDIF<a name='1073'>
<a name='1074'>
         END IF<a name='1075'>
<a name='1076'>
         <font color=#447700>!  Both pieces of the boundary data are now available to be written.<a name='1077'></font>
         <a name='1078'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_11">( nested_grid, &amp;<a name='1079'>
                             current_timestr=current_date(1:19) )<a name='1080'>
      temp24= current_date<a name='1081'>
      temp24b=start_date_hold<a name='1082'>
      start_date = start_date_hold<a name='1083'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_6"> ( temp19 , temp24b(1:19) , (time_loop-2) * model_config_rec%interval_seconds )<a name='1084'>
      current_date = temp19 //  '.0000'<a name='1085'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_JULGMT'>geth_julgmt</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_JULGMT_3"> ( julyr , julday , gmt)<a name='1086'>
      CALL nl_set_julyr  ( nested_grid%id , julyr  )<a name='1087'>
      CALL nl_set_julday ( nested_grid%id , julday )<a name='1088'>
      CALL nl_set_gmt    ( nested_grid%id , gmt    )<a name='1089'>
      CALL wrf_put_dom_ti_real    ( fidb , 'GMT' , gmt , 1 , ierr ) <a name='1090'>
      CALL wrf_put_dom_ti_integer ( fidb , 'JULYR' , julyr , 1 , ierr ) <a name='1091'>
      CALL wrf_put_dom_ti_integer ( fidb , 'JULDAY' , julday , 1 , ierr ) <a name='1092'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_12">( nested_grid, &amp;<a name='1093'>
                             current_timestr=current_date(1:19) )<a name='1094'>
print *,'bdy time = ',time_loop-1,'  bdy date = ',current_date,' ',start_date<a name='1095'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OUTPUT_BOUNDARY'>output_boundary</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_BOUNDARY_3"> ( fidb , nested_grid , config_flags , ierr )<a name='1096'>
      current_date = temp24<a name='1097'>
      start_date = temp24b<a name='1098'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_13">( nested_grid, &amp;<a name='1099'>
                             current_timestr=current_date(1:19) )<a name='1100'>
<a name='1101'>
         IF ( time_loop .EQ. 2 ) THEN<a name='1102'>
            CALL wrf_put_dom_ti_real    ( fidb , 'BDYFRQ' , new_bdy_frq , 1 , ierr ) <a name='1103'>
         END IF<a name='1104'>
<a name='1105'>
         <font color=#447700>!  We need to save the 3d data to compute a difference during the next loop.  Couple the<a name='1106'></font>
         <font color=#447700>!  3d fields with total mu (mub + mu_2) and the stagger-specific map scale factor.<a name='1107'></font>
         <font color=#447700>!  We load up the boundary data again for use in the next loop.<a name='1108'></font>
<a name='1109'>
          DO j = jps , jpe<a name='1110'>
             DO k = kps , kpe<a name='1111'>
                DO i = ips , ipe<a name='1112'>
                   ubdy3dtemp1(i,k,j) = ubdy3dtemp2(i,k,j)<a name='1113'>
                   vbdy3dtemp1(i,k,j) = vbdy3dtemp2(i,k,j)<a name='1114'>
                   tbdy3dtemp1(i,k,j) = tbdy3dtemp2(i,k,j)<a name='1115'>
                   pbdy3dtemp1(i,k,j) = pbdy3dtemp2(i,k,j)<a name='1116'>
                   qbdy3dtemp1_coupled(i,k,j,:) = qbdy3dtemp2_coupled(i,k,j,:)<a name='1117'>
                   sbdy3dtemp1_coupled(i,k,j,:) = sbdy3dtemp2_coupled(i,k,j,:)<a name='1118'>
                END DO<a name='1119'>
             END DO<a name='1120'>
          END DO<a name='1121'>
<a name='1122'>
          DO j = jps , jpe<a name='1123'>
             DO i = ips , ipe<a name='1124'>
                mbdy2dtemp1(i,1,j) = mbdy2dtemp2(i,1,j)<a name='1125'>
             END DO<a name='1126'>
          END DO<a name='1127'>
<a name='1128'>
         <font color=#447700>!  There are 2 components to the lateral boundaries.  First, there is the starting<a name='1129'></font>
         <font color=#447700>!  point of this time period - just the outer few rows and columns.<a name='1130'></font>
<a name='1131'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_9">     ( ubdy3dtemp1 , &amp;<a name='1132'>
                              nested_grid%u_bxs, nested_grid%u_bxe     ,                   &amp;<a name='1133'>
                              nested_grid%u_bys, nested_grid%u_bye     ,                   &amp;<a name='1134'>
                                                       'U' ,               spec_bdy_width      , &amp;<a name='1135'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='1136'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='1137'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='1138'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_10">     ( vbdy3dtemp1 , &amp;<a name='1139'>
                              nested_grid%v_bxs, nested_grid%v_bxe     ,                   &amp;<a name='1140'>
                              nested_grid%v_bys, nested_grid%v_bye     ,                   &amp;<a name='1141'>
                                                       'V' ,               spec_bdy_width      , &amp;<a name='1142'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='1143'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='1144'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='1145'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_11">     ( tbdy3dtemp1 , &amp;<a name='1146'>
                              nested_grid%t_bxs, nested_grid%t_bxe     ,                   &amp;<a name='1147'>
                              nested_grid%t_bys, nested_grid%t_bye     ,                   &amp;<a name='1148'>
                                                       'T' ,               spec_bdy_width      , &amp;<a name='1149'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='1150'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='1151'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='1152'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_12">     ( pbdy3dtemp1 , &amp;<a name='1153'>
                              nested_grid%ph_bxs, nested_grid%ph_bxe     ,                   &amp;<a name='1154'>
                              nested_grid%ph_bys, nested_grid%ph_bye     ,                   &amp;<a name='1155'>
                                                       'W' ,               spec_bdy_width      , &amp;<a name='1156'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='1157'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='1158'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='1159'>
         DO nvmoist=PARAM_FIRST_SCALAR, num_moist<a name='1160'>
           qbdy3dtemp1 = qbdy3dtemp1_coupled(:,:,:,nvmoist)<a name='1161'>
           CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_13">     ( qbdy3dtemp1 , &amp;<a name='1162'>
                                nested_grid%moist_bxs(jms:jme,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='1163'>
                                nested_grid%moist_bxe(jms:jme,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='1164'>
                                nested_grid%moist_bys(ims:ime,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='1165'>
                                nested_grid%moist_bye(ims:ime,kms:kme,1:spec_bdy_width,nvmoist), &amp;<a name='1166'>
                                                       'T' ,               spec_bdy_width      , &amp;<a name='1167'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='1168'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='1169'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='1170'>
         END DO<a name='1171'>
<a name='1172'>
         DO nvscalar=PARAM_FIRST_SCALAR, num_scalar<a name='1173'>
           sbdy3dtemp1 = sbdy3dtemp1_coupled(:,:,:,nvscalar)<a name='1174'>
           CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_14">     ( sbdy3dtemp1 , &amp;<a name='1175'>
                                nested_grid%scalar_bxs(jms:jme,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1176'>
                                nested_grid%scalar_bxe(jms:jme,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1177'>
                                nested_grid%scalar_bys(ims:ime,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1178'>
                                nested_grid%scalar_bye(ims:ime,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1179'>
                                                      'T' ,                  spec_bdy_width,   &amp;<a name='1180'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='1181'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='1182'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='1183'>
         END DO <a name='1184'>
<a name='1185'>
<a name='1186'>
#if ( WRF_CHEM == 1 )<a name='1187'>
         do nvchem=1,num_chem<a name='1188'>
         cbdy3dtemp1(ips:ipe,kps:kpe,jps:jpe)=cbdy3dtemp0(ips:ipe,kps:kpe,jps:jpe,nvchem) <a name='1189'>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='1190'></font>
<font color=#447700>!          write(0,*)'fill 2ch_b3',cbdy3dtemp1(ips,kps,jps),cbdy3dtemp0(ips,kps,jps,nvchem)<a name='1191'></font>
<font color=#447700>!        endif<a name='1192'></font>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_15">     ( cbdy3dtemp1 , &amp;<a name='1193'>
                              nested_grid%chem_bxs(jms:jme,kms:kme,1:spec_bdy_width,nvchem), &amp;<a name='1194'>
                              nested_grid%chem_bxe(jms:jme,kms:kme,1:spec_bdy_width,nvchem),     &amp;<a name='1195'>
                              nested_grid%chem_bys(ims:ime,kms:kme,1:spec_bdy_width,nvchem), &amp;<a name='1196'>
                              nested_grid%chem_bye(ims:ime,kms:kme,1:spec_bdy_width,nvchem),     &amp;<a name='1197'>
                                                                    'T' ,               spec_bdy_width      , &amp;<a name='1198'>
                                                                           ids , ide , jds , jde , kds , kde , &amp;<a name='1199'>
                                                                           ims , ime , jms , jme , kms , kme , &amp;<a name='1200'>
                                                                           ips , ipe , jps , jpe , kps , kpe )<a name='1201'>
<font color=#447700>!          cbdy3dtemp0(ips:ipe,kps:kpe,jps:jpe,nvchem)=cbdy3dtemp1(ips:ipe,kps:kpe,jps:jpe)<a name='1202'></font>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='1203'></font>
<font color=#447700>!          write(0,*)'fill 2ch_b3',cbdy3dtemp1(ips,kps,jps),cbdy3dtemp0(ips,kps,jps,nvchem)<a name='1204'></font>
<font color=#447700>!        endif<a name='1205'></font>
         enddo<a name='1206'>
#endif<a name='1207'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDY'>stuff_bdy</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDY_16">     ( mbdy2dtemp1 , &amp;<a name='1208'>
                              nested_grid%mu_bxs, nested_grid%mu_bxe    ,  &amp;<a name='1209'>
                              nested_grid%mu_bys, nested_grid%mu_bye    ,  &amp;<a name='1210'>
                                                                     'M' ,               spec_bdy_width      , &amp;<a name='1211'>
                                                                           ids , ide , jds , jde , 1 , 1 , &amp;<a name='1212'>
                                                                           ims , ime , jms , jme , 1 , 1 , &amp;<a name='1213'>
                                                                           ips , ipe , jps , jpe , 1 , 1 )<a name='1214'>
<a name='1215'>
      ELSE IF ( time_loop .EQ. time_loop_max ) THEN<a name='1216'>
<a name='1217'>
         <font color=#447700>! u, theta, h, scalars coupled with my, v coupled with mx<a name='1218'></font>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_13"> ( nested_grid%mu_2 , nested_grid%mub , ubdy3dtemp2 , nested_grid%u_2                 , &amp;<a name='1219'>
                       'u' , nested_grid%msfuy , &amp;<a name='1220'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='1221'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='1222'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_14"> ( nested_grid%mu_2 , nested_grid%mub , vbdy3dtemp2 , nested_grid%v_2                 , &amp;<a name='1223'>
                       'v' , nested_grid%msfvx , &amp;<a name='1224'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='1225'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='1226'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_15"> ( nested_grid%mu_2 , nested_grid%mub , tbdy3dtemp2 , nested_grid%t_2                 , &amp;<a name='1227'>
                       't' , nested_grid%msfty , &amp;<a name='1228'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='1229'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='1230'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_16"> ( nested_grid%mu_2 , nested_grid%mub , pbdy3dtemp2 , nested_grid%ph_2                , &amp;<a name='1231'>
                       'h' , nested_grid%msfty , &amp;<a name='1232'>
                       nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='1233'>
                       ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='1234'>
         DO nvmoist=PARAM_FIRST_SCALAR, num_moist<a name='1235'>
           CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_17"> ( nested_grid%mu_2 , nested_grid%mub , qbdy3dtemp2 , nested_grid%moist(ims:ime,kms:kme,jms:jme,nvmoist)    , &amp;<a name='1236'>
                         't' , nested_grid%msfty , &amp;<a name='1237'>
                         nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='1238'>
                         ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='1239'>
           qbdy3dtemp2_coupled(:,:,:,nvmoist) = qbdy3dtemp2<a name='1240'>
         END DO<a name='1241'>
         DO nvscalar=PARAM_FIRST_SCALAR, num_scalar<a name='1242'>
           CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE'>couple</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_18"> ( nested_grid%mu_2 , nested_grid%mub , sbdy3dtemp2 , nested_grid%scalar(ims:ime,kms:kme,jms:jme,nvscalar)    , &amp;<a name='1243'>
                         't' , nested_grid%msfty , &amp;<a name='1244'>
                         nested_grid%c1h, nested_grid%c2h, nested_grid%c1f, nested_grid%c2f, &amp;<a name='1245'>
                         ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, ips, ipe, jps, jpe, kps, kpe )<a name='1246'>
           sbdy3dtemp2_coupled(:,:,:,nvscalar) = sbdy3dtemp2<a name='1247'>
         END DO<a name='1248'>
         mbdy2dtemp2(:,1,:) = nested_grid%mu_2(:,:)<a name='1249'>
<a name='1250'>
         <font color=#447700>!  During all of the loops after the first loop, we first compute the boundary<a name='1251'></font>
         <font color=#447700>!  tendencies with the current data values and the previously save information<a name='1252'></font>
         <font color=#447700>!  stored in the *bdy3dtemp1 arrays.<a name='1253'></font>
#if ( WRF_CHEM == 1 )<a name='1254'>
         do nvchem=1,num_chem<a name='1255'>
         cbdy3dtemp1(ips:ipe,kps:kpe,jps:jpe)=cbdy3dtemp0(ips:ipe,kps:kpe,jps:jpe,nvchem) <a name='1256'>
         cbdy3dtemp2(ips:ipe,kps:kpe,jps:jpe)=nested_grid%chem(ips:ipe,kps:kpe,jps:jpe,nvchem)<a name='1257'>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='1258'></font>
<font color=#447700>!          write(0,*)'fill 1ch_b4',cbdy3dtemp1(ips,kps,jps),cbdy3dtemp0(ips,kps,jps,nvchem),cbdy3dtemp2(ips,kps,jps)<a name='1259'></font>
<font color=#447700>!        endif<a name='1260'></font>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_9"> ( cbdy3dtemp2 , cbdy3dtemp1 , new_bdy_frq ,  &amp;<a name='1261'>
                              nested_grid%chem_btxs(jms:jme,kms:kme,1:spec_bdy_width,nvchem),  &amp;<a name='1262'>
                              nested_grid%chem_btxe(jms:jme,kms:kme,1:spec_bdy_width,nvchem), &amp;<a name='1263'>
                              nested_grid%chem_btys(ims:ime,kms:kme,1:spec_bdy_width,nvchem),  &amp;<a name='1264'>
                              nested_grid%chem_btye(ims:ime,kms:kme,1:spec_bdy_width,nvchem), &amp;<a name='1265'>
                                                                  'T' , &amp;<a name='1266'>
                                                                                spec_bdy_width      , &amp;<a name='1267'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1268'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1269'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1270'>
         cbdy3dtemp0(ips:ipe,kps:kpe,jps:jpe,nvchem)=cbdy3dtemp2(ips:ipe,kps:kpe,jps:jpe) <a name='1271'>
<font color=#447700>!        if(nvchem.eq.p_o3)then<a name='1272'></font>
<font color=#447700>!          write(0,*)'fill 2ch_b4',cbdy3dtemp1(ips,kps,jps),cbdy3dtemp0(ips,kps,jps,nvchem),cbdy3dtemp2(ips,kps,jps)<a name='1273'></font>
<font color=#447700>!        endif<a name='1274'></font>
         enddo<a name='1275'>
#endif<a name='1276'>
<a name='1277'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_10"> ( ubdy3dtemp2 , ubdy3dtemp1 , new_bdy_frq , &amp;<a name='1278'>
                              nested_grid%u_btxs  , nested_grid%u_btxe , &amp;<a name='1279'>
                              nested_grid%u_btys  , nested_grid%u_btye , &amp;<a name='1280'>
                                                             'U'  , &amp;<a name='1281'>
                                                                                spec_bdy_width      , &amp;<a name='1282'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1283'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1284'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1285'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_11"> ( vbdy3dtemp2 , vbdy3dtemp1 , new_bdy_frq , &amp;<a name='1286'>
                              nested_grid%v_btxs  , nested_grid%v_btxe , &amp;<a name='1287'>
                              nested_grid%v_btys  , nested_grid%v_btye , &amp;<a name='1288'>
                                                             'V'  , &amp;<a name='1289'>
                                                                                spec_bdy_width      , &amp;<a name='1290'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1291'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1292'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1293'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_12"> ( tbdy3dtemp2 , tbdy3dtemp1 , new_bdy_frq , &amp;<a name='1294'>
                              nested_grid%t_btxs  , nested_grid%t_btxe , &amp;<a name='1295'>
                              nested_grid%t_btys  , nested_grid%t_btye , &amp;<a name='1296'>
                                                             'T'  , &amp;<a name='1297'>
                                                                                spec_bdy_width      , &amp;<a name='1298'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1299'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1300'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1301'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_13"> ( pbdy3dtemp2 , pbdy3dtemp1 , new_bdy_frq , &amp;<a name='1302'>
                              nested_grid%ph_btxs  , nested_grid%ph_btxe , &amp;<a name='1303'>
                              nested_grid%ph_btys  , nested_grid%ph_btye , &amp;<a name='1304'>
                                                             'W' , &amp;<a name='1305'>
                                                                                spec_bdy_width      , &amp;<a name='1306'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1307'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1308'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1309'>
         DO nvmoist=PARAM_FIRST_SCALAR, num_moist<a name='1310'>
           qbdy3dtemp1 = qbdy3dtemp1_coupled(:,:,:,nvmoist)<a name='1311'>
           qbdy3dtemp2 = qbdy3dtemp2_coupled(:,:,:,nvmoist)<a name='1312'>
           CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_14"> ( qbdy3dtemp2 , qbdy3dtemp1 , new_bdy_frq , &amp;<a name='1313'>
                                nested_grid%moist_btxs(jms:jme,kms:kme,1:spec_bdy_width,nvmoist) , &amp;<a name='1314'>
                                nested_grid%moist_btxe(jms:jme,kms:kme,1:spec_bdy_width,nvmoist) , &amp;<a name='1315'>
                                nested_grid%moist_btys(ims:ime,kms:kme,1:spec_bdy_width,nvmoist) , &amp;<a name='1316'>
                                nested_grid%moist_btye(ims:ime,kms:kme,1:spec_bdy_width,nvmoist) , &amp;<a name='1317'>
                                                             'T' , &amp;<a name='1318'>
                                                                                spec_bdy_width      , &amp;<a name='1319'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1320'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1321'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1322'>
         END DO<a name='1323'>
<a name='1324'>
         DO nvscalar=PARAM_FIRST_SCALAR, num_scalar<a name='1325'>
           sbdy3dtemp1 = sbdy3dtemp1_coupled(:,:,:,nvscalar)<a name='1326'>
           sbdy3dtemp2 = sbdy3dtemp2_coupled(:,:,:,nvscalar)<a name='1327'>
           CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_15"> ( sbdy3dtemp2 , sbdy3dtemp1 , new_bdy_frq ,  &amp;<a name='1328'>
                              nested_grid%scalar_btxs(jms:jme,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1329'>
                              nested_grid%scalar_btxe(jms:jme,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1330'>
                              nested_grid%scalar_btys(ims:ime,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1331'>
                              nested_grid%scalar_btye(ims:ime,kms:kme,1:spec_bdy_width,nvscalar), &amp;<a name='1332'>
                                                                  'T' , &amp;<a name='1333'>
                                                                                spec_bdy_width ,  &amp;<a name='1334'>
                                                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1335'>
                                                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1336'>
                                                                  ips , ipe , jps , jpe , kps , kpe )<a name='1337'>
         END DO  <a name='1338'>
<a name='1339'>
         CALL <A href='../../html_code/share/module_bc.F.html#STUFF_BDYTEND'>stuff_bdytend</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STUFF_BDYTEND_16"> ( mbdy2dtemp2 , mbdy2dtemp1 , new_bdy_frq , &amp;<a name='1340'>
                              nested_grid%mu_btxs  , nested_grid%mu_btxe , &amp;<a name='1341'>
                              nested_grid%mu_btys  , nested_grid%mu_btye , &amp;<a name='1342'>
                                                             'M' , &amp;<a name='1343'>
                                                                                spec_bdy_width      , &amp;<a name='1344'>
                                                                  ids , ide , jds , jde , 1 , 1 , &amp;<a name='1345'>
                                                                  ims , ime , jms , jme , 1 , 1 , &amp;<a name='1346'>
                                                                  ips , ipe , jps , jpe , 1 , 1 )<a name='1347'>
<a name='1348'>
         IF ( time_loop .EQ. 2 ) THEN<a name='1349'>
   <a name='1350'>
            <font color=#447700>!  Generate an output file from this program, which will be an input file to WRF.<a name='1351'></font>
<a name='1352'>
            CALL wrf_debug          ( 100 , 'ndown_em main: calling open_w_dataset for wrfbdy' )<a name='1353'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME1'>construct_filename1</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME1_9">( bdyname , 'wrfbdy' , nested_grid%id , 2 )<a name='1354'>
            CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_8">     ( fidb, TRIM(bdyname) , nested_grid , config_flags , output_boundary , &amp;<a name='1355'>
                                      "DATASET=BOUNDARY", ierr )<a name='1356'>
            IF ( ierr .NE. 0 ) THEN<a name='1357'>
               WRITE( wrf_err_message , FMT='(A,A,A,I8)' ) 'program ndown: error opening ',TRIM(bdyname),' for reading ierr=',ierr<a name='1358'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_406"> ( wrf_err_message )<a name='1359'>
            ENDIF<a name='1360'>
<a name='1361'>
         END IF<a name='1362'>
<a name='1363'>
         <font color=#447700>!  Both pieces of the boundary data are now available to be written.<a name='1364'></font>
<a name='1365'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_14">( nested_grid, &amp;<a name='1366'>
                             current_timestr=current_date(1:19) )<a name='1367'>
      temp24= current_date<a name='1368'>
      temp24b=start_date_hold<a name='1369'>
      start_date = start_date_hold<a name='1370'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_7"> ( temp19 , temp24b(1:19) , (time_loop-2) * model_config_rec%interval_seconds )<a name='1371'>
      current_date = temp19 //  '.0000'<a name='1372'>
      CALL <A href='../../html_code/share/module_date_time.F.html#GETH_JULGMT'>geth_julgmt</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_JULGMT_4"> ( julyr , julday , gmt)<a name='1373'>
      CALL nl_set_julyr  ( nested_grid%id , julyr  )<a name='1374'>
      CALL nl_set_julday ( nested_grid%id , julday )<a name='1375'>
      CALL nl_set_gmt    ( nested_grid%id , gmt    )<a name='1376'>
      CALL wrf_put_dom_ti_real    ( fidb , 'GMT' , gmt , 1 , ierr ) <a name='1377'>
      CALL wrf_put_dom_ti_integer ( fidb , 'JULYR' , julyr , 1 , ierr ) <a name='1378'>
      CALL wrf_put_dom_ti_integer ( fidb , 'JULDAY' , julday , 1 , ierr ) <a name='1379'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_15">( nested_grid, &amp;<a name='1380'>
                             current_timestr=current_date(1:19) )<a name='1381'>
      CALL <A href='../../html_code/share/module_io_domain.F.html#OUTPUT_BOUNDARY'>output_boundary</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTPUT_BOUNDARY_4"> ( fidb , nested_grid , config_flags , ierr )<a name='1382'>
      current_date = temp24<a name='1383'>
      start_date = temp24b<a name='1384'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_16">( nested_grid, &amp;<a name='1385'>
                             current_timestr=current_date(1:19) )<a name='1386'>
<a name='1387'>
         IF ( time_loop .EQ. 2 ) THEN<a name='1388'>
            CALL wrf_put_dom_ti_real    ( fidb , 'BDYFRQ' , new_bdy_frq , 1 , ierr ) <a name='1389'>
         END IF<a name='1390'>
<a name='1391'>
         <font color=#447700>!  Since this is the last time through here, we need to close the boundary file.<a name='1392'></font>
<a name='1393'>
         CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_27"> ( nested_grid%id , model_config_rec , config_flags )<a name='1394'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_9"> ( fidb , config_flags , "DATASET=BOUNDARY" )<a name='1395'>
<a name='1396'>
<a name='1397'>
      END IF<a name='1398'>
<a name='1399'>
      <font color=#447700>!  Process which time now?<a name='1400'></font>
<a name='1401'>
   END DO big_time_loop_thingy<a name='1402'>
   DEALLOCATE(znw_c)<a name='1403'>
   DEALLOCATE(znu_c)<a name='1404'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_28"> ( parent_grid%id , model_config_rec , config_flags )<a name='1405'>
   CALL <A href='../../html_code/share/mediation_wrfmain.F.html#MED_SHUTDOWN_IO'>med_shutdown_io</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_SHUTDOWN_IO_3"> ( parent_grid , config_flags )<a name='1406'>
<a name='1407'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_347"> ( 0 , 'ndown_em: SUCCESS COMPLETE NDOWN_EM INIT' )<a name='1408'>
<a name='1409'>
   CALL <A href='../../html_code/frame/wrf_shutdown.F.html#WRF_SHUTDOWN'>wrf_shutdown</A><A href='../../html_code/main/ndown_em.F.html#NDOWN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SHUTDOWN_4"><a name='1410'>
<a name='1411'>
   CALL WRFU_Finalize( rc=rc )<a name='1412'>
<a name='1413'>
END PROGRAM ndown_em<a name='1414'>
<a name='1415'>
<A NAME='LAND_PERCENTAGES'><A href='../../html_code/main/ndown_em.F.html#LAND_PERCENTAGES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1416'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>land_percentages</font> ( xland , &amp; <A href='../../call_to/LAND_PERCENTAGES.html' TARGET='index'>2</A>,<A href='../../call_from/LAND_PERCENTAGES.html' TARGET='index'>4</A><a name='1417'>
                              landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='1418'>
                              isltyp , ivgtyp , &amp;<a name='1419'>
                              num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='1420'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='1421'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1422'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='1423'>
                              iswater )<a name='1424'>
   USE <A href='../../html_code/share/module_soil_pre.F.html#MODULE_SOIL_PRE'>module_soil_pre</A><A href='../../html_code/main/nup_em.F.html#LAND_PERCENTAGES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SOIL_PRE_4"><a name='1425'>
<a name='1426'>
   IMPLICIT NONE<a name='1427'>
<a name='1428'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1429'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='1430'>
                           its , ite , jts , jte , kts , kte , &amp;<a name='1431'>
                           iswater<a name='1432'>
<a name='1433'>
   INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='1434'>
   REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landuse_frac<a name='1435'>
   REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(IN):: soil_top_cat<a name='1436'>
   REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(IN):: soil_bot_cat<a name='1437'>
   INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='1438'>
   REAL , DIMENSION(ims:ime,jms:jme) , INTENT(OUT) :: xland<a name='1439'>
<a name='1440'>
   CALL <A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW'>process_percent_cat_new</A><A href='../../html_code/main/nup_em.F.html#LAND_PERCENTAGES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROCESS_PERCENT_CAT_NEW_1"> ( xland , &amp;<a name='1441'>
                                  landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='1442'>
                                  isltyp , ivgtyp , &amp;<a name='1443'>
                                  num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='1444'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1445'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1446'>
                                  its , ite , jts , jte , kts , kte , &amp;<a name='1447'>
                                  iswater )<a name='1448'>
<a name='1449'>
END SUBROUTINE land_percentages<a name='1450'>
<a name='1451'>
<A NAME='CHECK_CONSISTENCY'><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1452'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>check_consistency</font> ( ivgtyp , isltyp , landmask , &amp; <A href='../../call_to/CHECK_CONSISTENCY.html' TARGET='index'>2</A>,<A href='../../call_from/CHECK_CONSISTENCY.html' TARGET='index'>2</A><a name='1453'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='1454'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='1455'>
                                  its , ite , jts , jte , kts , kte , &amp;<a name='1456'>
                                  iswater )<a name='1457'>
<a name='1458'>
   IMPLICIT NONE<a name='1459'>
<a name='1460'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1461'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='1462'>
                           its , ite , jts , jte , kts , kte , &amp;<a name='1463'>
                           iswater<a name='1464'>
   INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: isltyp , ivgtyp<a name='1465'>
   REAL    , DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: landmask<a name='1466'>
<a name='1467'>
   LOGICAL :: oops<a name='1468'>
   INTEGER :: oops_count , i , j<a name='1469'>
<a name='1470'>
   oops = .FALSE.<a name='1471'>
   oops_count = 0<a name='1472'>
<a name='1473'>
   DO j = jts, MIN(jde-1,jte)<a name='1474'>
      DO i = its, MIN(ide-1,ite)<a name='1475'>
         IF ( ( ( landmask(i,j) .LT. 0.5 ) .AND. ( ivgtyp(i,j) .NE. iswater ) ) .OR. &amp;<a name='1476'>
              ( ( landmask(i,j) .GT. 0.5 ) .AND. ( ivgtyp(i,j) .EQ. iswater ) ) ) THEN<a name='1477'>
            print *,'mismatch in landmask and veg type'<a name='1478'>
            print *,'i,j=',i,j, '  landmask =',NINT(landmask(i,j)),'  ivgtyp=',ivgtyp(i,j)<a name='1479'>
            oops = .TRUE.<a name='1480'>
            oops_count = oops_count + 1<a name='1481'>
landmask(i,j) = 0<a name='1482'>
ivgtyp(i,j)=16<a name='1483'>
isltyp(i,j)=14<a name='1484'>
         END IF<a name='1485'>
      END DO<a name='1486'>
   END DO<a name='1487'>
<a name='1488'>
   IF ( oops ) THEN<a name='1489'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_348">( 0, 'mismatch in check_consistency, turned to water points, be careful' )<a name='1490'>
   END IF<a name='1491'>
<a name='1492'>
END SUBROUTINE check_consistency<a name='1493'>
<a name='1494'>
<A NAME='CHECK_CONSISTENCY2'><A href='../../html_code/main/ndown_em.F.html#CHECK_CONSISTENCY2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1495'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>check_consistency2</font>( ivgtyp , isltyp , landmask , &amp; <A href='../../call_to/CHECK_CONSISTENCY2.html' TARGET='index'>2</A>,<A href='../../call_from/CHECK_CONSISTENCY2.html' TARGET='index'>12</A><a name='1496'>
                               tmn , tsk , sst , xland , &amp;<a name='1497'>
                               tslb , smois , sh2o , &amp;<a name='1498'>
                               num_soil_layers , id , &amp;<a name='1499'>
                               ids , ide , jds , jde , kds , kde , &amp;<a name='1500'>
                               ims , ime , jms , jme , kms , kme , &amp;<a name='1501'>
                               its , ite , jts , jte , kts , kte , &amp;<a name='1502'>
                               iswater )<a name='1503'>
<a name='1504'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_125"><a name='1505'>
   USE <A href='../../html_code/share/module_optional_input.F.html#MODULE_OPTIONAL_INPUT'>module_optional_input</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_OPTIONAL_INPUT_4"><a name='1506'>
<a name='1507'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='1508'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='1509'>
                           its , ite , jts , jte , kts , kte <a name='1510'>
   INTEGER , INTENT(IN) :: num_soil_layers , id<a name='1511'>
<a name='1512'>
   INTEGER , DIMENSION(ims:ime,jms:jme) :: ivgtyp , isltyp<a name='1513'>
   REAL    , DIMENSION(ims:ime,jms:jme) :: landmask , tmn , tsk , sst , xland<a name='1514'>
   REAL    , DIMENSION(ims:ime,num_soil_layers,jms:jme) :: tslb , smois , sh2o<a name='1515'>
<a name='1516'>
   INTEGER :: oops1 , oops2<a name='1517'>
   INTEGER :: i , j , k<a name='1518'>
<a name='1519'>
      fix_tsk_tmn : SELECT CASE ( model_config_rec%sf_surface_physics(id) )<a name='1520'>
<a name='1521'>
         CASE ( SLABSCHEME , LSMSCHEME , RUCLSMSCHEME )<a name='1522'>
            DO j = jts, MIN(jde-1,jte)<a name='1523'>
               DO i = its, MIN(ide-1,ite)<a name='1524'>
                  IF ( ( landmask(i,j) .LT. 0.5 ) .AND. ( flag_sst .EQ. 1 ) ) THEN<a name='1525'>
                     tmn(i,j) = sst(i,j)<a name='1526'>
                     tsk(i,j) = sst(i,j)<a name='1527'>
                  ELSE IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='1528'>
                     tmn(i,j) = tsk(i,j)<a name='1529'>
                  END IF<a name='1530'>
               END DO<a name='1531'>
            END DO<a name='1532'>
      END SELECT fix_tsk_tmn<a name='1533'>
<a name='1534'>
      <font color=#447700>!  Is the TSK reasonable?<a name='1535'></font>
<a name='1536'>
      DO j = jts, MIN(jde-1,jte)<a name='1537'>
         DO i = its, MIN(ide-1,ite)<a name='1538'>
            IF ( tsk(i,j) .LT. 170 .or. tsk(i,j) .GT. 400. ) THEN<a name='1539'>
               print *,'error in the TSK'<a name='1540'>
               print *,'i,j=',i,j<a name='1541'>
               print *,'landmask=',landmask(i,j)<a name='1542'>
               print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='1543'>
               if(tmn(i,j).gt.170. .and. tmn(i,j).lt.400.)then<a name='1544'>
                  tsk(i,j)=tmn(i,j)<a name='1545'>
               else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='1546'>
                  tsk(i,j)=sst(i,j)<a name='1547'>
               else<a name='1548'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_407"> ( 'TSK unreasonable' )<a name='1549'>
               end if<a name='1550'>
            END IF<a name='1551'>
         END DO<a name='1552'>
      END DO<a name='1553'>
<a name='1554'>
      <font color=#447700>!  Is the TMN reasonable?<a name='1555'></font>
<a name='1556'>
      DO j = jts, MIN(jde-1,jte)<a name='1557'>
         DO i = its, MIN(ide-1,ite)<a name='1558'>
            IF ( ( ( tmn(i,j) .LT. 170. ) .OR. ( tmn(i,j) .GT. 400. ) ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='1559'>
                  print *,'error in the TMN'<a name='1560'>
                  print *,'i,j=',i,j<a name='1561'>
                  print *,'landmask=',landmask(i,j)<a name='1562'>
                  print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='1563'>
               if(tsk(i,j).gt.170. .and. tsk(i,j).lt.400.)then<a name='1564'>
                  tmn(i,j)=tsk(i,j)<a name='1565'>
               else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='1566'>
                  tmn(i,j)=sst(i,j)<a name='1567'>
               else<a name='1568'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_408"> ( 'TMN unreasonable' )<a name='1569'>
               endif<a name='1570'>
            END IF<a name='1571'>
         END DO<a name='1572'>
      END DO<a name='1573'>
<a name='1574'>
      <font color=#447700>!  Is the TSLB reasonable?<a name='1575'></font>
<a name='1576'>
      DO j = jts, MIN(jde-1,jte)<a name='1577'>
         DO i = its, MIN(ide-1,ite)<a name='1578'>
            IF ( ( ( tslb(i,1,j) .LT. 170. ) .OR. ( tslb(i,1,j) .GT. 400. ) ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='1579'>
                  print *,'error in the TSLB'<a name='1580'>
                  print *,'i,j=',i,j<a name='1581'>
                  print *,'landmask=',landmask(i,j)<a name='1582'>
                  print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='1583'>
                  print *,'tslb = ',tslb(i,:,j)<a name='1584'>
                  print *,'old smois = ',smois(i,:,j)<a name='1585'>
                  DO l = 1 , num_soil_layers<a name='1586'>
                     sh2o(i,l,j) = 0.0<a name='1587'>
                  END DO<a name='1588'>
                  DO l = 1 , num_soil_layers<a name='1589'>
                     smois(i,l,j) = 0.3<a name='1590'>
                  END DO<a name='1591'>
                  if(tsk(i,j).gt.170. .and. tsk(i,j).lt.400.)then<a name='1592'>
                     DO l = 1 , num_soil_layers<a name='1593'>
                        tslb(i,l,j)=tsk(i,j)<a name='1594'>
                     END DO<a name='1595'>
                  else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='1596'>
                     DO l = 1 , num_soil_layers<a name='1597'>
                        tslb(i,l,j)=sst(i,j)<a name='1598'>
                     END DO<a name='1599'>
                  else if(tmn(i,j).gt.170. .and. tmn(i,j).lt.400.)then<a name='1600'>
                     DO l = 1 , num_soil_layers<a name='1601'>
                        tslb(i,l,j)=tmn(i,j)<a name='1602'>
                     END DO<a name='1603'>
                  else<a name='1604'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_409"> ( 'TSLB unreasonable' )<a name='1605'>
                  endif<a name='1606'>
            END IF<a name='1607'>
         END DO<a name='1608'>
      END DO<a name='1609'>
<a name='1610'>
      <font color=#447700>!  Let us make sure (again) that the landmask and the veg/soil categories match.<a name='1611'></font>
<a name='1612'>
oops1=0<a name='1613'>
oops2=0<a name='1614'>
      DO j = jts, MIN(jde-1,jte)<a name='1615'>
         DO i = its, MIN(ide-1,ite)<a name='1616'>
            IF ( ( ( landmask(i,j) .LT. 0.5 ) .AND. ( ivgtyp(i,j) .NE. iswater .OR. isltyp(i,j) .NE. 14 ) ) .OR. &amp;<a name='1617'>
                 ( ( landmask(i,j) .GT. 0.5 ) .AND. ( ivgtyp(i,j) .EQ. iswater .OR. isltyp(i,j) .EQ. 14 ) ) ) THEN<a name='1618'>
               IF ( tslb(i,1,j) .GT. 1. ) THEN<a name='1619'>
oops1=oops1+1<a name='1620'>
                  ivgtyp(i,j) = 5<a name='1621'>
                  isltyp(i,j) = 8<a name='1622'>
                  landmask(i,j) = 1<a name='1623'>
                  xland(i,j) = 1<a name='1624'>
               ELSE IF ( sst(i,j) .GT. 1. ) THEN<a name='1625'>
oops2=oops2+1<a name='1626'>
                  ivgtyp(i,j) = iswater<a name='1627'>
                  isltyp(i,j) = 14<a name='1628'>
                  landmask(i,j) = 0<a name='1629'>
                  xland(i,j) = 2<a name='1630'>
               ELSE<a name='1631'>
                  print *,'the landmask and soil/veg cats do not match'<a name='1632'>
                  print *,'i,j=',i,j<a name='1633'>
                  print *,'landmask=',landmask(i,j)<a name='1634'>
                  print *,'ivgtyp=',ivgtyp(i,j)<a name='1635'>
                  print *,'isltyp=',isltyp(i,j)<a name='1636'>
                  print *,'iswater=', iswater<a name='1637'>
                  print *,'tslb=',tslb(i,:,j)<a name='1638'>
                  print *,'sst=',sst(i,j)<a name='1639'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_410"> ( 'mismatch_landmask_ivgtyp' )<a name='1640'>
               END IF<a name='1641'>
            END IF<a name='1642'>
         END DO<a name='1643'>
      END DO<a name='1644'>
if (oops1.gt.0) then<a name='1645'>
print *,'points artificially set to land : ',oops1<a name='1646'>
endif<a name='1647'>
if(oops2.gt.0) then<a name='1648'>
print *,'points artificially set to water: ',oops2<a name='1649'>
endif<a name='1650'>
<a name='1651'>
END SUBROUTINE check_consistency2<a name='1652'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!11<a name='1653'></font>
<A NAME='VERT_COR'><A href='../../html_code/main/ndown_em.F.html#VERT_COR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1654'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>vert_cor</font>(parent,znw_c,k_dim_c) <A href='../../call_to/VERT_COR.html' TARGET='index'>1</A>,<A href='../../call_from/VERT_COR.html' TARGET='index'>1</A><a name='1655'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#VERT_COR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_190"><a name='1656'>
   IMPLICIT NONE<a name='1657'>
         TYPE(domain), POINTER :: parent<a name='1658'>
         integer , intent(in) :: k_dim_c<a name='1659'>
         real , dimension(k_dim_c), INTENT(IN) :: znw_c<a name='1660'>
<a name='1661'>
       integer :: kde_c , kde_n ,n_refine,ii,kkk,k<a name='1662'>
       real :: dznw_m,cof1,cof2<a name='1663'>
<a name='1664'>
        kde_c = k_dim_c<a name='1665'>
        kde_n = parent%e_vert<a name='1666'>
        n_refine = parent % vert_refine_fact<a name='1667'>
<a name='1668'>
<a name='1669'>
         kkk = 0<a name='1670'>
         do k = 1 , kde_c-1<a name='1671'>
         dznw_m = znw_c(k+1) - znw_c(k)<a name='1672'>
         do ii = 1,n_refine<a name='1673'>
         kkk = kkk + 1<a name='1674'>
         parent%znw(kkk) = znw_c(k) + float(ii-1)/float(n_refine)*dznw_m<a name='1675'>
         enddo<a name='1676'>
         enddo<a name='1677'>
         parent%znw(kde_n) = znw_c(kde_c)<a name='1678'>
         parent%znw(1) = znw_c(1)<a name='1679'>
<a name='1680'>
      DO k=1, kde_n-1<a name='1681'>
         parent%dnw(k) = parent%znw(k+1) - parent%znw(k)<a name='1682'>
         parent%rdnw(k) = 1./parent%dnw(k)<a name='1683'>
         parent%znu(k) = 0.5*(parent%znw(k+1)+parent%znw(k))<a name='1684'>
      END DO<a name='1685'>
<a name='1686'>
      DO k=2, kde_n-1<a name='1687'>
         parent%dn(k) = 0.5*(parent%dnw(k)+parent%dnw(k-1))<a name='1688'>
         parent%rdn(k) = 1./parent%dn(k)<a name='1689'>
         parent%fnp(k) = .5* parent%dnw(k  )/parent%dn(k)<a name='1690'>
         parent%fnm(k) = .5* parent%dnw(k-1)/parent%dn(k)<a name='1691'>
      END DO<a name='1692'>
<a name='1693'>
  cof1 = (2.*parent%dn(2)+parent%dn(3))/(parent%dn(2)+parent%dn(3))*parent%dnw(1)/parent%dn(2)<a name='1694'>
  cof2 =     parent%dn(2)        /(parent%dn(2)+parent%dn(3))*parent%dnw(1)/parent%dn(3)<a name='1695'>
<a name='1696'>
      parent%cf1  = parent%fnp(2) + cof1<a name='1697'>
      parent%cf2  = parent%fnm(2) - cof1 - cof2<a name='1698'>
      parent%cf3  = cof2<a name='1699'>
<a name='1700'>
      parent%cfn  = (.5*parent%dnw(kde_n-1)+parent%dn(kde_n-1))/parent%dn(kde_n-1)<a name='1701'>
      parent%cfn1 = -.5*parent%dnw(kde_n-1)/parent%dn(kde_n-1)<a name='1702'>
<a name='1703'>
<a name='1704'>
<a name='1705'>
      END SUBROUTINE vert_cor<a name='1706'>
<a name='1707'>
<a name='1708'>
<A NAME='INIT_DOMAIN_CONSTANTS_EM_PTR'><A href='../../html_code/main/ndown_em.F.html#INIT_DOMAIN_CONSTANTS_EM_PTR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1709'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>init_domain_constants_em_ptr</font> ( parent , nest )  <A href='../../call_to/INIT_DOMAIN_CONSTANTS_EM_PTR.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_DOMAIN_CONSTANTS_EM_PTR.html' TARGET='index'>5</A><a name='1710'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#INIT_DOMAIN_CONSTANTS_EM_PTR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_191"><a name='1711'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#INIT_DOMAIN_CONSTANTS_EM_PTR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_126"><a name='1712'>
   IMPLICIT NONE<a name='1713'>
   TYPE(domain), POINTER  :: parent , nest<a name='1714'>
   INTERFACE <a name='1715'>
   SUBROUTINE init_domain_constants_em ( parent , nest )<a name='1716'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#INIT_DOMAIN_CONSTANTS_EM_PTR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_192"><a name='1717'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#INIT_DOMAIN_CONSTANTS_EM_PTR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_127"><a name='1718'>
      TYPE(domain)  :: parent , nest<a name='1719'>
   END SUBROUTINE init_domain_constants_em<a name='1720'>
   END INTERFACE <a name='1721'>
   CALL <A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_CONSTANTS_EM'>init_domain_constants_em</A><A href='../../html_code/main/ndown_em.F.html#INIT_DOMAIN_CONSTANTS_EM_PTR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_DOMAIN_CONSTANTS_EM_1"> ( parent , nest )<a name='1722'>
END SUBROUTINE init_domain_constants_em_ptr<a name='1723'>
<a name='1724'>
<a name='1725'>
<A NAME='VERTICAL_INTERP'><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1726'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_interp</font> (parent_grid,znw_c,znu_c,cf1_c,cf2_c,cf3_c,cfn_c,cfn1_c,k_dim_c,c3h,c4h,c3f,c4f) <A href='../../call_to/VERTICAL_INTERP.html' TARGET='index'>1</A>,<A href='../../call_from/VERTICAL_INTERP.html' TARGET='index'>16</A><a name='1727'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_193"><a name='1728'>
         USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_128"><a name='1729'>
   IMPLICIT NONE<a name='1730'>
         TYPE(domain), POINTER ::  parent_grid<a name='1731'>
         INTEGER , INTENT (IN) :: k_dim_c<a name='1732'>
         REAL , INTENT (IN) :: cf1_c,cf2_c,cf3_c,cfn_c,cfn1_c<a name='1733'>
         REAL , DIMENSION(k_dim_c) , INTENT (IN) ::  znw_c,znu_c<a name='1734'>
         REAL , DIMENSION(k_dim_c) , INTENT (IN) ::  c3h,c4h,c3f,c4f<a name='1735'>
<a name='1736'>
       integer :: kde_c , kde_n ,n_refine,ii,kkk<a name='1737'>
       integer :: i , j, k , itrace<a name='1738'>
       real :: p_top_m  , p_surf_m , mu_m , hsca_m , pre_c ,pre_n<a name='1739'>
<a name='1740'>
       real, allocatable, dimension(:) ::  alt_w_c , alt_u_c ,pro_w_c , pro_u_c<a name='1741'>
       real, allocatable, dimension(:) ::  alt_w_n , alt_u_n ,pro_w_n , pro_u_n<a name='1742'>
<a name='1743'>
   INTEGER :: nids, nide, njds, njde, nkds, nkde, &amp;<a name='1744'>
              nims, nime, njms, njme, nkms, nkme, &amp;<a name='1745'>
              nips, nipe, njps, njpe, nkps, nkpe<a name='1746'>
<a name='1747'>
      <a name='1748'>
         hsca_m = 6.7<a name='1749'>
         n_refine = model_config_rec % vert_refine_fact<a name='1750'>
         kde_c = k_dim_c<a name='1751'>
         kde_n = parent_grid%e_vert<a name='1752'>
<a name='1753'>
         CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_97"> ( parent_grid , &amp;<a name='1754'>
                                   nids, nide, njds, njde, nkds, nkde, &amp;<a name='1755'>
                                   nims, nime, njms, njme, nkms, nkme, &amp;<a name='1756'>
                                   nips, nipe, njps, njpe, nkps, nkpe )<a name='1757'>
<a name='1758'>
<font color=#447700>!     print * , 'MOUSTA_VER  ',parent_grid%e_vert , kde_c , kde_n<a name='1759'></font>
<font color=#447700>!        print *, nids , nide , njds , njde , nkds , nkde<a name='1760'></font>
<font color=#447700>!        print *, nims , nime , njms , njme , nkms , nkme<a name='1761'></font>
<font color=#447700>!        print *, nips , nipe , njps , njpe , nkps , nkpe<a name='1762'></font>
<a name='1763'>
<a name='1764'>
<a name='1765'>
         allocate (alt_w_c(kde_c))<a name='1766'>
         allocate (alt_u_c(kde_c+1))<a name='1767'>
         allocate (pro_w_c(kde_c))<a name='1768'>
         allocate (pro_u_c(kde_c+1))<a name='1769'>
<a name='1770'>
         allocate (alt_w_n(kde_n))<a name='1771'>
         allocate (alt_u_n(kde_n+1))<a name='1772'>
         allocate (pro_w_n(kde_n))<a name='1773'>
         allocate (pro_u_n(kde_n+1))<a name='1774'>
<a name='1775'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11111<a name='1776'></font>
         p_top_m = parent_grid%p_top<a name='1777'>
         p_surf_m = 1.e5<a name='1778'>
         mu_m = p_surf_m - p_top_m<a name='1779'>
<font color=#447700>!        print * , 'p_top_m', p_top_m<a name='1780'></font>
<font color=#447700>!    parent<a name='1781'></font>
         do  k = 1,kde_c<a name='1782'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='1783'></font>
         pre_c = mu_m * znw_c(k) + p_top_m<a name='1784'>
#elif ( HYBRID_COORD==1 )<a name='1785'>
         pre_c = mu_m * c3f(k) + c4f(k) + p_top_m<a name='1786'>
#endif<a name='1787'>
         alt_w_c(k) =  -hsca_m * alog(pre_c/p_surf_m)<a name='1788'>
         enddo<a name='1789'>
         do  k = 1,kde_c-1<a name='1790'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='1791'></font>
         pre_c = mu_m * znu_c(k) + p_top_m<a name='1792'>
#elif ( HYBRID_COORD==1 )<a name='1793'>
         pre_c = mu_m * c3h(k) + c4h(k) + p_top_m<a name='1794'>
#endif<a name='1795'>
         alt_u_c(k+1) =  -hsca_m * alog(pre_c/p_surf_m)<a name='1796'>
         enddo<a name='1797'>
         alt_u_c(1) =  alt_w_c(1) <a name='1798'>
         alt_u_c(kde_c+1) =  alt_w_c(kde_c) <a name='1799'>
<font color=#447700>!    nest<a name='1800'></font>
         do  k = 1,kde_n<a name='1801'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='1802'></font>
         pre_n = mu_m * parent_grid%znw(k) + p_top_m<a name='1803'>
#elif ( HYBRID_COORD==1 )<a name='1804'>
         pre_n = mu_m * parent_grid%c3f(k) + parent_grid%c4f(k) + p_top_m<a name='1805'>
#endif<a name='1806'>
         alt_w_n(k) =  -hsca_m * alog(pre_n/p_surf_m)<a name='1807'>
         enddo<a name='1808'>
         do  k = 1,kde_n-1<a name='1809'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='1810'></font>
         pre_n = mu_m * parent_grid%znu(k) + p_top_m<a name='1811'>
#elif ( HYBRID_COORD==1 )<a name='1812'>
         pre_n = mu_m * parent_grid%c3h(k) + parent_grid%c4h(k) + p_top_m<a name='1813'>
#endif<a name='1814'>
         alt_u_n(k+1) =  -hsca_m * alog(pre_n/p_surf_m)<a name='1815'>
         enddo<a name='1816'>
         alt_u_n(1) =  alt_w_n(1)<a name='1817'>
         alt_u_n(kde_n+1) =  alt_w_n(kde_n)<a name='1818'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='1819'></font>
<a name='1820'>
IF ( SIZE( parent_grid%u_2, 1 ) * SIZE( parent_grid%u_2, 3 ) .GT. 1 ) THEN <a name='1821'>
do j = njms , njme<a name='1822'>
do i = nims , nime<a name='1823'>
    <a name='1824'>
    do k = 1,kde_c-1<a name='1825'>
    pro_u_c(k+1) = parent_grid%u_2(i,k,j)<a name='1826'>
    enddo<a name='1827'>
    pro_u_c(1      ) = cf1_c*parent_grid%u_2(i,1,j) &amp;<a name='1828'>
                     + cf2_c*parent_grid%u_2(i,2,j) &amp;<a name='1829'>
                     + cf3_c*parent_grid%u_2(i,3,j)<a name='1830'>
<a name='1831'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%u_2(i,kde_c-1,j) &amp;<a name='1832'>
                     + cfn1_c*parent_grid%u_2(i,kde_c-2,j) <a name='1833'>
<a name='1834'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_1">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='1835'>
<a name='1836'>
    do k = 1,kde_n-1<a name='1837'>
    parent_grid%u_2(i,k,j) = pro_u_n(k+1)<a name='1838'>
    enddo<a name='1839'>
<a name='1840'>
enddo<a name='1841'>
enddo<a name='1842'>
ENDIF<a name='1843'>
<a name='1844'>
IF ( SIZE( parent_grid%v_2, 1 ) * SIZE( parent_grid%v_2, 3 ) .GT. 1 ) THEN<a name='1845'>
do j = njms , njme<a name='1846'>
do i = nims , nime<a name='1847'>
<a name='1848'>
    do k = 1,kde_c-1<a name='1849'>
    pro_u_c(k+1) = parent_grid%v_2(i,k,j)<a name='1850'>
    enddo<a name='1851'>
    pro_u_c(1      ) = cf1_c*parent_grid%v_2(i,1,j) &amp;<a name='1852'>
                     + cf2_c*parent_grid%v_2(i,2,j) &amp;<a name='1853'>
                     + cf3_c*parent_grid%v_2(i,3,j)<a name='1854'>
<a name='1855'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%v_2(i,kde_c-1,j) &amp;<a name='1856'>
                     + cfn1_c*parent_grid%v_2(i,kde_c-2,j)<a name='1857'>
<a name='1858'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_2">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='1859'>
<a name='1860'>
    do k = 1,kde_n-1<a name='1861'>
    parent_grid%v_2(i,k,j) = pro_u_n(k+1)<a name='1862'>
    enddo<a name='1863'>
<a name='1864'>
enddo<a name='1865'>
enddo<a name='1866'>
ENDIF<a name='1867'>
<a name='1868'>
IF ( SIZE( parent_grid%w_2, 1 ) * SIZE( parent_grid%w_2, 3 ) .GT. 1 ) THEN<a name='1869'>
do j = njms , njme<a name='1870'>
do i = nims , nime<a name='1871'>
<a name='1872'>
    do k = 1,kde_c<a name='1873'>
    pro_w_c(k) = parent_grid%w_2(i,k,j)<a name='1874'>
    enddo<a name='1875'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_3">(pro_w_c,alt_w_c,kde_c,pro_w_n,alt_w_n,kde_n)<a name='1876'>
<a name='1877'>
    do k = 1,kde_n<a name='1878'>
    parent_grid%w_2(i,k,j) = pro_w_n(k)<a name='1879'>
    enddo<a name='1880'>
enddo<a name='1881'>
enddo<a name='1882'>
ENDIF<a name='1883'>
<a name='1884'>
IF ( SIZE( parent_grid%t_2, 1 ) * SIZE( parent_grid%t_2, 3 ) .GT. 1 ) THEN<a name='1885'>
do j = njms , njme<a name='1886'>
do i = nims , nime<a name='1887'>
<a name='1888'>
    do k = 1,kde_c-1<a name='1889'>
    pro_u_c(k+1) = parent_grid%t_2(i,k,j)<a name='1890'>
    enddo<a name='1891'>
    pro_u_c(1      ) = cf1_c*parent_grid%t_2(i,1,j) &amp;<a name='1892'>
                     + cf2_c*parent_grid%t_2(i,2,j) &amp;<a name='1893'>
                     + cf3_c*parent_grid%t_2(i,3,j)<a name='1894'>
<a name='1895'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%t_2(i,kde_c-1,j) &amp;<a name='1896'>
                     + cfn1_c*parent_grid%t_2(i,kde_c-2,j)<a name='1897'>
<a name='1898'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_4">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='1899'>
<a name='1900'>
    do k = 1,kde_n-1<a name='1901'>
    parent_grid%t_2(i,k,j) = pro_u_n(k+1)<a name='1902'>
    enddo<a name='1903'>
<a name='1904'>
enddo<a name='1905'>
enddo<a name='1906'>
ENDIF<a name='1907'>
<a name='1908'>
DO itrace = PARAM_FIRST_SCALAR, num_moist<a name='1909'>
IF ( SIZE( parent_grid%moist, 1 ) * SIZE( parent_grid%moist, 3 ) .GT. 1 ) THEN<a name='1910'>
do j = njms , njme<a name='1911'>
do i = nims , nime<a name='1912'>
<a name='1913'>
    do k = 1,kde_c-1<a name='1914'>
    pro_u_c(k+1) = parent_grid%moist(i,k,j,itrace)<a name='1915'>
    enddo<a name='1916'>
    pro_u_c(1      ) = cf1_c*parent_grid%moist(i,1,j,itrace) &amp;<a name='1917'>
                     + cf2_c*parent_grid%moist(i,2,j,itrace) &amp;<a name='1918'>
                     + cf3_c*parent_grid%moist(i,3,j,itrace)<a name='1919'>
<a name='1920'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%moist(i,kde_c-1,j,itrace) &amp;<a name='1921'>
                     + cfn1_c*parent_grid%moist(i,kde_c-2,j,itrace)<a name='1922'>
<a name='1923'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_5">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='1924'>
<a name='1925'>
    do k = 1,kde_n-1<a name='1926'>
    parent_grid%moist(i,k,j,itrace) = pro_u_n(k+1)<a name='1927'>
    enddo<a name='1928'>
<a name='1929'>
enddo<a name='1930'>
enddo<a name='1931'>
ENDIF<a name='1932'>
ENDDO<a name='1933'>
<a name='1934'>
DO itrace = PARAM_FIRST_SCALAR, num_dfi_moist<a name='1935'>
IF ( SIZE( parent_grid%dfi_moist, 1 ) * SIZE( parent_grid%dfi_moist, 3 ) .GT. 1 ) THEN<a name='1936'>
do j = njms , njme<a name='1937'>
do i = nims , nime<a name='1938'>
<a name='1939'>
    do k = 1,kde_c-1<a name='1940'>
    pro_u_c(k+1) = parent_grid%dfi_moist(i,k,j,itrace)<a name='1941'>
    enddo<a name='1942'>
    pro_u_c(1      ) = cf1_c*parent_grid%dfi_moist(i,1,j,itrace) &amp;<a name='1943'>
                     + cf2_c*parent_grid%dfi_moist(i,2,j,itrace) &amp;<a name='1944'>
                     + cf3_c*parent_grid%dfi_moist(i,3,j,itrace)<a name='1945'>
<a name='1946'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%dfi_moist(i,kde_c-1,j,itrace) &amp;<a name='1947'>
                     + cfn1_c*parent_grid%dfi_moist(i,kde_c-2,j,itrace)<a name='1948'>
<a name='1949'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_6">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='1950'>
<a name='1951'>
    do k = 1,kde_n-1<a name='1952'>
    parent_grid%dfi_moist(i,k,j,itrace) = pro_u_n(k+1)<a name='1953'>
    enddo<a name='1954'>
<a name='1955'>
enddo<a name='1956'>
enddo<a name='1957'>
ENDIF<a name='1958'>
ENDDO<a name='1959'>
<a name='1960'>
DO itrace = PARAM_FIRST_SCALAR, num_scalar<a name='1961'>
IF ( SIZE( parent_grid%scalar, 1 ) * SIZE( parent_grid%scalar, 3 ) .GT. 1 ) THEN<a name='1962'>
do j = njms , njme<a name='1963'>
do i = nims , nime<a name='1964'>
<a name='1965'>
    do k = 1,kde_c-1<a name='1966'>
    pro_u_c(k+1) = parent_grid%scalar(i,k,j,itrace)<a name='1967'>
    enddo<a name='1968'>
    pro_u_c(1      ) = cf1_c*parent_grid%scalar(i,1,j,itrace) &amp;<a name='1969'>
                     + cf2_c*parent_grid%scalar(i,2,j,itrace) &amp;<a name='1970'>
                     + cf3_c*parent_grid%scalar(i,3,j,itrace)<a name='1971'>
<a name='1972'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%scalar(i,kde_c-1,j,itrace) &amp;<a name='1973'>
                     + cfn1_c*parent_grid%scalar(i,kde_c-2,j,itrace)<a name='1974'>
<a name='1975'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_7">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='1976'>
<a name='1977'>
    do k = 1,kde_n-1<a name='1978'>
    parent_grid%scalar(i,k,j,itrace) = pro_u_n(k+1)<a name='1979'>
    enddo<a name='1980'>
<a name='1981'>
enddo<a name='1982'>
enddo<a name='1983'>
ENDIF<a name='1984'>
ENDDO<a name='1985'>
<a name='1986'>
DO itrace = PARAM_FIRST_SCALAR, num_dfi_scalar<a name='1987'>
IF ( SIZE( parent_grid%dfi_scalar, 1 ) * SIZE( parent_grid%dfi_scalar, 3 ) .GT. 1 ) THEN<a name='1988'>
do j = njms , njme<a name='1989'>
do i = nims , nime<a name='1990'>
<a name='1991'>
    do k = 1,kde_c-1<a name='1992'>
    pro_u_c(k+1) = parent_grid%dfi_scalar(i,k,j,itrace)<a name='1993'>
    enddo<a name='1994'>
    pro_u_c(1      ) = cf1_c*parent_grid%dfi_scalar(i,1,j,itrace) &amp;<a name='1995'>
                     + cf2_c*parent_grid%dfi_scalar(i,2,j,itrace) &amp;<a name='1996'>
                     + cf3_c*parent_grid%dfi_scalar(i,3,j,itrace)<a name='1997'>
<a name='1998'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%dfi_scalar(i,kde_c-1,j,itrace) &amp;<a name='1999'>
                     + cfn1_c*parent_grid%dfi_scalar(i,kde_c-2,j,itrace)<a name='2000'>
<a name='2001'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_8">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='2002'>
<a name='2003'>
    do k = 1,kde_n-1<a name='2004'>
    parent_grid%dfi_scalar(i,k,j,itrace) = pro_u_n(k+1)<a name='2005'>
    enddo<a name='2006'>
<a name='2007'>
enddo<a name='2008'>
enddo<a name='2009'>
ENDIF<a name='2010'>
ENDDO<a name='2011'>
<a name='2012'>
<a name='2013'>
<a name='2014'>
IF ( SIZE( parent_grid%f_ice_phy, 1 ) * SIZE( parent_grid%f_ice_phy, 3 ) .GT. 1 ) THEN<a name='2015'>
do j = njms , njme<a name='2016'>
do i = nims , nime<a name='2017'>
<a name='2018'>
    do k = 1,kde_c-1<a name='2019'>
    pro_u_c(k+1) = parent_grid%f_ice_phy(i,k,j)<a name='2020'>
    enddo<a name='2021'>
    pro_u_c(1      ) = cf1_c*parent_grid%f_ice_phy(i,1,j) &amp;<a name='2022'>
                     + cf2_c*parent_grid%f_ice_phy(i,2,j) &amp;<a name='2023'>
                     + cf3_c*parent_grid%f_ice_phy(i,3,j)<a name='2024'>
<a name='2025'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%f_ice_phy(i,kde_c-1,j) &amp;<a name='2026'>
                     + cfn1_c*parent_grid%f_ice_phy(i,kde_c-2,j)<a name='2027'>
<a name='2028'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_9">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='2029'>
<a name='2030'>
    do k = 1,kde_n-1<a name='2031'>
    parent_grid%f_ice_phy(i,k,j) = pro_u_n(k+1)<a name='2032'>
    enddo<a name='2033'>
<a name='2034'>
enddo<a name='2035'>
enddo<a name='2036'>
ENDIF<a name='2037'>
<a name='2038'>
IF ( SIZE( parent_grid%f_rain_phy, 1 ) * SIZE( parent_grid%f_rain_phy, 3 ) .GT. 1 ) THEN<a name='2039'>
do j = njms , njme<a name='2040'>
do i = nims , nime<a name='2041'>
<a name='2042'>
    do k = 1,kde_c-1<a name='2043'>
    pro_u_c(k+1) = parent_grid%f_rain_phy(i,k,j)<a name='2044'>
    enddo<a name='2045'>
    pro_u_c(1      ) = cf1_c*parent_grid%f_rain_phy(i,1,j) &amp;<a name='2046'>
                     + cf2_c*parent_grid%f_rain_phy(i,2,j) &amp;<a name='2047'>
                     + cf3_c*parent_grid%f_rain_phy(i,3,j)<a name='2048'>
<a name='2049'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%f_rain_phy(i,kde_c-1,j) &amp;<a name='2050'>
                     + cfn1_c*parent_grid%f_rain_phy(i,kde_c-2,j)<a name='2051'>
<a name='2052'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_10">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='2053'>
<a name='2054'>
    do k = 1,kde_n-1<a name='2055'>
    parent_grid%f_rain_phy(i,k,j) = pro_u_n(k+1)<a name='2056'>
    enddo<a name='2057'>
<a name='2058'>
enddo<a name='2059'>
enddo<a name='2060'>
ENDIF<a name='2061'>
<a name='2062'>
<a name='2063'>
IF ( SIZE( parent_grid%f_rimef_phy, 1 ) * SIZE( parent_grid%f_rimef_phy, 3 ) .GT. 1 ) THEN<a name='2064'>
do j = njms , njme<a name='2065'>
do i = nims , nime<a name='2066'>
<a name='2067'>
    do k = 1,kde_c-1<a name='2068'>
    pro_u_c(k+1) = parent_grid%f_rimef_phy(i,k,j)<a name='2069'>
    enddo<a name='2070'>
    pro_u_c(1      ) = cf1_c*parent_grid%f_rimef_phy(i,1,j) &amp;<a name='2071'>
                     + cf2_c*parent_grid%f_rimef_phy(i,2,j) &amp;<a name='2072'>
                     + cf3_c*parent_grid%f_rimef_phy(i,3,j)<a name='2073'>
<a name='2074'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%f_rimef_phy(i,kde_c-1,j) &amp;<a name='2075'>
                     + cfn1_c*parent_grid%f_rimef_phy(i,kde_c-2,j)<a name='2076'>
<a name='2077'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_11">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='2078'>
<a name='2079'>
    do k = 1,kde_n-1<a name='2080'>
    parent_grid%f_rimef_phy(i,k,j) = pro_u_n(k+1)<a name='2081'>
    enddo<a name='2082'>
<a name='2083'>
enddo<a name='2084'>
enddo<a name='2085'>
ENDIF<a name='2086'>
<a name='2087'>
IF ( SIZE( parent_grid%h_diabatic, 1 ) * SIZE( parent_grid%h_diabatic, 3 ) .GT. 1 ) THEN<a name='2088'>
do j = njms , njme<a name='2089'>
do i = nims , nime<a name='2090'>
<a name='2091'>
    do k = 1,kde_c-1<a name='2092'>
    pro_u_c(k+1) = parent_grid%h_diabatic(i,k,j)<a name='2093'>
    enddo<a name='2094'>
    pro_u_c(1      ) = cf1_c*parent_grid%h_diabatic(i,1,j) &amp;<a name='2095'>
                     + cf2_c*parent_grid%h_diabatic(i,2,j) &amp;<a name='2096'>
                     + cf3_c*parent_grid%h_diabatic(i,3,j)<a name='2097'>
<a name='2098'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%h_diabatic(i,kde_c-1,j) &amp;<a name='2099'>
                     + cfn1_c*parent_grid%h_diabatic(i,kde_c-2,j)<a name='2100'>
<a name='2101'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_12">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='2102'>
<a name='2103'>
    do k = 1,kde_n-1<a name='2104'>
    parent_grid%h_diabatic(i,k,j) = pro_u_n(k+1)<a name='2105'>
    enddo<a name='2106'>
<a name='2107'>
enddo<a name='2108'>
enddo<a name='2109'>
ENDIF<a name='2110'>
<a name='2111'>
IF ( SIZE( parent_grid%rthraten, 1 ) * SIZE( parent_grid%rthraten, 3 ) .GT. 1 ) THEN<a name='2112'>
do j = njms , njme<a name='2113'>
do i = nims , nime<a name='2114'>
<a name='2115'>
    do k = 1,kde_c-1<a name='2116'>
    pro_u_c(k+1) =  parent_grid%rthraten(i,k,j)<a name='2117'>
    enddo<a name='2118'>
    pro_u_c(1      ) = cf1_c*parent_grid%rthraten(i,1,j) &amp;<a name='2119'>
                     + cf2_c*parent_grid%rthraten(i,2,j) &amp;<a name='2120'>
                     + cf3_c*parent_grid%rthraten(i,3,j)<a name='2121'>
<a name='2122'>
    pro_u_c(kde_c+1) = cfn_c *parent_grid%rthraten(i,kde_c-1,j) &amp;<a name='2123'>
                     + cfn1_c*parent_grid%rthraten(i,kde_c-2,j)<a name='2124'>
<a name='2125'>
    call <A href='../../html_code/main/ndown_em.F.html#INTER'>inter</A><A href='../../html_code/main/ndown_em.F.html#VERTICAL_INTERP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTER_13">(pro_u_c,alt_u_c,kde_c+1,pro_u_n,alt_u_n,kde_n+1)<a name='2126'>
<a name='2127'>
    do k = 1,kde_n-1<a name='2128'>
    parent_grid%rthraten(i,k,j) = pro_u_n(k+1)<a name='2129'>
    enddo<a name='2130'>
<a name='2131'>
enddo<a name='2132'>
enddo<a name='2133'>
ENDIF<a name='2134'>
<a name='2135'>
<a name='2136'>
<a name='2137'>
<a name='2138'>
<a name='2139'>
<a name='2140'>
<a name='2141'>
<a name='2142'>
<a name='2143'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2144'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2145'></font>
         deallocate (alt_w_c)<a name='2146'>
         deallocate (alt_u_c)<a name='2147'>
         deallocate (pro_w_c)<a name='2148'>
         deallocate (pro_u_c)<a name='2149'>
<a name='2150'>
         deallocate (alt_w_n)<a name='2151'>
         deallocate (alt_u_n)<a name='2152'>
         deallocate (pro_w_n)<a name='2153'>
         deallocate (pro_u_n)<a name='2154'>
<a name='2155'>
<a name='2156'>
      END SUBROUTINE vertical_interp<a name='2157'>
<a name='2158'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!11<a name='2159'></font>
<A NAME='INTER'><A href='../../html_code/main/ndown_em.F.html#INTER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2160'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>inter</font>(pro_c,alt_c,kde_c,pro_n,alt_n,kde_n) <A href='../../call_to/INTER.html' TARGET='index'>13</A>,<A href='../../call_from/INTER.html' TARGET='index'>1</A><a name='2161'>
<a name='2162'>
  IMPLICIT NONE<a name='2163'>
   INTEGER , INTENT(IN) :: kde_c,kde_n<a name='2164'>
   REAL , DIMENSION(kde_c) , INTENT(IN ) :: pro_c,alt_c<a name='2165'>
   REAL , DIMENSION(kde_n) , INTENT(IN ) :: alt_n<a name='2166'>
   REAL , DIMENSION(kde_n) , INTENT(OUT) :: pro_n<a name='2167'>
<a name='2168'>
      real ,dimension(kde_c) :: a,b,c,d<a name='2169'>
      real :: p<a name='2170'>
      integer :: i,j<a name='2171'>
<a name='2172'>
<a name='2173'>
      call <A href='../../html_code/main/ndown_em.F.html#COEFF_MON'>coeff_mon</A><A href='../../html_code/main/ndown_em.F.html#INTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COEFF_MON_1">(alt_c,pro_c,a,b,c,d,kde_c)<a name='2174'>
<a name='2175'>
       do i = 1,kde_n-1<a name='2176'>
<a name='2177'>
          do j=1,kde_c-1<a name='2178'>
<a name='2179'>
               if ( (alt_n(i) .ge. alt_c(j)).and.(alt_n(i) .lt. alt_c(j+1)) ) then<a name='2180'>
                p =  alt_n(i)-alt_c(j)<a name='2181'>
                pro_n(i) = p*( p*(a(j)*p+b(j))+c(j)) + d(j)<a name='2182'>
                goto 20<a name='2183'>
               endif<a name='2184'>
           enddo<a name='2185'>
20             continue<a name='2186'>
       enddo<a name='2187'>
<a name='2188'>
       pro_n(kde_n) = pro_c(kde_c)<a name='2189'>
<a name='2190'>
<a name='2191'>
   END SUBROUTINE inter<a name='2192'>
<a name='2193'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11<a name='2194'></font>
<a name='2195'>
<A NAME='COEFF_MON'><A href='../../html_code/main/ndown_em.F.html#COEFF_MON' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2196'>
     <font color=#993300>subroutine  </font><font color=#cc0000>coeff_mon</font>(x,y,a,b,c,d,n) <A href='../../call_to/COEFF_MON.html' TARGET='index'>1</A><a name='2197'>
<a name='2198'>
      implicit none<a name='2199'>
<a name='2200'>
      integer :: n<a name='2201'>
      real ,dimension(n) :: x,y,a,b,c,d<a name='2202'>
      real ,dimension(n) :: h,s,p,yp<a name='2203'>
<a name='2204'>
       integer :: i<a name='2205'>
<a name='2206'>
<a name='2207'>
      do i=1,n-1<a name='2208'>
      h(i) = (x(i+1)-x(i))<a name='2209'>
      s(i) = (y(i+1)-y(i)) / h(i)<a name='2210'>
      enddo<a name='2211'>
<a name='2212'>
      do i=2,n-1<a name='2213'>
      p(i) = (s(i-1)*h(i)+s(i)*h(i-1)) / (h(i-1)+h(i))<a name='2214'>
      enddo<a name='2215'>
<a name='2216'>
      p(1) = s(1)<a name='2217'>
      p(n) = s(n-1)<a name='2218'>
<a name='2219'>
      do i=1,n<a name='2220'>
      yp(i) = p(i)<a name='2221'>
      enddo<a name='2222'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!<a name='2223'></font>
<a name='2224'>
      do i=2,n-1<a name='2225'>
      yp(i) = (sign(1.,s(i-1))+sign(1.,s(i)))* min( abs(s(i-1)),abs(s(i)),0.5*abs(p(i)))<a name='2226'>
      enddo<a name='2227'>
<a name='2228'>
      do i = 1,n-1<a name='2229'>
      a(i) = (yp(i)+yp(i+1)-2.*s(i))/(h(i)*h(i))<a name='2230'>
      b(i) = (3.*s(i)-2.*yp(i)-yp(i+1))/h(i)<a name='2231'>
      c(i) = yp(i)<a name='2232'>
      d(i) = y(i)<a name='2233'>
      enddo<a name='2234'>
<a name='2235'>
      end  subroutine  coeff_mon<a name='2236'>
<a name='2237'>
<a name='2238'>
</pre></body></html>