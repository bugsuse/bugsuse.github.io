<HTML> <BODY BGCOLOR=#eeeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:MAIN<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5'></font>
<font color=#447700>! ESMF-specific modules for building WRF as an ESMF component.  <a name='6'></font>
<font color=#447700>!<a name='7'></font>
<font color=#447700>! This source file is only built when ESMF coupling is used.  <a name='8'></font>
<font color=#447700>!<a name='9'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='10'></font>
<a name='11'>
<a name='12'>
<a name='13'>
<A NAME='MODULE_METADATAUTILS'><A href='../../html_code/main/wrf_ESMFMod.F.html#MODULE_METADATAUTILS' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='14'>
<font color=#993300>MODULE </font><font color=#cc0000>module_metadatautils</font> <A href='../../call_to/MODULE_METADATAUTILS.html' TARGET='index'>5</A><a name='15'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='16'></font>
<font color=#447700>! This module defines component-independent "model metadata" utilities <a name='17'></font>
<font color=#447700>! used for ESMF coupling.  <a name='18'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='19'></font>
<font color=#447700>!TODO:  Upgrade this later to support multiple coupling intervals via Alarms <a name='20'></font>
<font color=#447700>!TODO:  associated with top-level clock.  Do this by adding TimesAttachedToState() <a name='21'></font>
<font color=#447700>!TODO:  inquiry function that will test an ESMF_State to see if the times are <a name='22'></font>
<font color=#447700>!TODO:  present via names defined in this module.  Then call it for every <a name='23'></font>
<font color=#447700>!TODO:  component and resolve conflicts (somehow) for cases where two components <a name='24'></font>
<font color=#447700>!TODO:  define conflicting clocks.  Of course, a component is allowed to not attach <a name='25'></font>
<font color=#447700>!TODO:  times to a state at all, if it can handle any time step.  <a name='26'></font>
<font color=#447700>!<a name='27'></font>
<font color=#447700>!TODO:  Replace meta-data names with "model metadata" conventions such as CF <a name='28'></font>
<font color=#447700>!TODO:  (once they exist)<a name='29'></font>
<font color=#447700>!<a name='30'></font>
<font color=#447700>!TODO:  Refactor to remove duplication of hard-coded names.  <a name='31'></font>
<font color=#447700>!<a name='32'></font>
   USE ESMF<a name='33'>
<a name='34'>
   IMPLICIT NONE<a name='35'>
<a name='36'>
   <font color=#447700>! everything is private by default<a name='37'></font>
   PRIVATE<a name='38'>
<a name='39'>
   <font color=#447700>! Public interfaces<a name='40'></font>
   PUBLIC AttachTimesToState<a name='41'>
   PUBLIC GetTimesFromStates<a name='42'>
   PUBLIC AttachDecompToState<a name='43'>
   PUBLIC GetDecompFromState<a name='44'>
<a name='45'>
   <font color=#447700>! private stuff<a name='46'></font>
   CHARACTER (ESMF_MAXSTR) :: str<a name='47'>
<a name='48'>
<a name='49'>
CONTAINS<a name='50'>
<a name='51'>
<a name='52'>
   <font color=#447700>! Attach time information to state as meta-data.  <a name='53'></font>
   <font color=#447700>! Update later to use some form of meta-data standards/conventions for <a name='54'></font>
   <font color=#447700>! model "time" meta-data.  <a name='55'></font>
<A NAME='ATTACHTIMESTOSTATE'><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHTIMESTOSTATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='56'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>AttachTimesToState</font>( state, startTime, stopTime, couplingInterval ) <A href='../../call_to/ATTACHTIMESTOSTATE.html' TARGET='index'>2</A>,<A href='../../call_from/ATTACHTIMESTOSTATE.html' TARGET='index'>6</A><a name='57'>
     TYPE(ESMF_State),        INTENT(INOUT) :: state<a name='58'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: startTime<a name='59'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: stopTime<a name='60'>
     TYPE(ESMF_TimeInterval), INTENT(INOUT) :: couplingInterval<a name='61'>
     <font color=#447700>! locals<a name='62'></font>
     INTEGER :: rc<a name='63'>
     INTEGER :: year, month, day, hour, minute, second<a name='64'>
     INTEGER(ESMF_KIND_I4) :: timevals(6)   <font color=#447700>! big enough to hold the vars listed above<a name='65'></font>
     <font color=#447700>! start time<a name='66'></font>
     CALL ESMF_TimeGet(startTime, yy=year, mm=month, dd=day, &amp;<a name='67'>
                       h=hour, m=minute, s=second, rc=rc)<a name='68'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='69'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHTIMESTOSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_443"> ( 'ESMF_TimeGet(startTime) failed' )<a name='70'>
     ENDIF<a name='71'>
     timevals(1) = year<a name='72'>
     timevals(2) = month<a name='73'>
     timevals(3) = day<a name='74'>
     timevals(4) = hour<a name='75'>
     timevals(5) = minute<a name='76'>
     timevals(6) = second<a name='77'>
     CALL ESMF_AttributeSet(state, 'ComponentStartTime', timevals, itemCount=SIZE(timevals), rc=rc)<a name='78'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='79'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHTIMESTOSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_444"> ( 'ESMF_AttributeSet(ComponentStartTime) failed' )<a name='80'>
     ENDIF<a name='81'>
     <font color=#447700>! stop time<a name='82'></font>
     CALL ESMF_TimeGet(stopTime, yy=year, mm=month, dd=day, &amp;<a name='83'>
                       h=hour, m=minute, s=second, rc=rc)<a name='84'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='85'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHTIMESTOSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_445"> ( 'ESMF_TimeGet(stopTime) failed' )<a name='86'>
     ENDIF<a name='87'>
     timevals(1) = year<a name='88'>
     timevals(2) = month<a name='89'>
     timevals(3) = day<a name='90'>
     timevals(4) = hour<a name='91'>
     timevals(5) = minute<a name='92'>
     timevals(6) = second<a name='93'>
     CALL ESMF_AttributeSet(state, 'ComponentStopTime', timevals, itemCount=SIZE(timevals), rc=rc)<a name='94'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='95'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHTIMESTOSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_446"> ( 'ESMF_AttributeSet(ComponentStopTime) failed' )<a name='96'>
     ENDIF<a name='97'>
     <font color=#447700>! coupling time step<a name='98'></font>
     CALL ESMF_TimeIntervalGet(couplingInterval, yy=year, mm=month, d=day, &amp;<a name='99'>
                               h=hour, m=minute, s=second, rc=rc)<a name='100'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='101'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHTIMESTOSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_447"> ( 'ESMF_TimeIntervalGet(couplingInterval) failed' )<a name='102'>
     ENDIF<a name='103'>
     timevals(1) = year<a name='104'>
     timevals(2) = month<a name='105'>
     timevals(3) = day<a name='106'>
     timevals(4) = hour<a name='107'>
     timevals(5) = minute<a name='108'>
     timevals(6) = second<a name='109'>
     CALL ESMF_AttributeSet(state, 'ComponentCouplingInterval', timevals, itemCount=SIZE(timevals), rc=rc)<a name='110'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='111'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHTIMESTOSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_448"> ( 'ESMF_AttributeSet(ComponentCouplingInterval) failed' )<a name='112'>
     ENDIF<a name='113'>
   END SUBROUTINE AttachTimesToState<a name='114'>
<a name='115'>
<a name='116'>
<a name='117'>
   <font color=#447700>! Extract time information attached as meta-data from a single <a name='118'></font>
   <font color=#447700>! ESMF_State.  <a name='119'></font>
   <font color=#447700>! Update later to use some form of meta-data standards/conventions for <a name='120'></font>
   <font color=#447700>! model "time" meta-data.  <a name='121'></font>
<A NAME='GETTIMESFROMSTATE'><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='122'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>GetTimesFromState</font>( state, startTime, stopTime, couplingInterval, rc ) <A href='../../call_to/GETTIMESFROMSTATE.html' TARGET='index'>3</A>,<A href='../../call_from/GETTIMESFROMSTATE.html' TARGET='index'>3</A><a name='123'>
     TYPE(ESMF_State),        INTENT(INOUT) :: state<a name='124'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: startTime<a name='125'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: stopTime<a name='126'>
     TYPE(ESMF_TimeInterval), INTENT(INOUT) :: couplingInterval<a name='127'>
     INTEGER, INTENT(INOUT) :: rc<a name='128'>
     <font color=#447700>! locals<a name='129'></font>
     INTEGER :: year, month, day, hour, minute, second<a name='130'>
     INTEGER(ESMF_KIND_I4) :: timevals(6)   <font color=#447700>! big enough to hold the vars listed above<a name='131'></font>
     INTEGER :: thecount  <font color=#447700>! 'one attribute ... ah ah ah. TWO attributes!  ah ah ah!!<a name='132'></font>
     CHARACTER*256 mess<a name='133'>
     <font color=#447700>! start time<a name='134'></font>
     thecount = SIZE(timevals)<a name='135'>
     CALL ESMF_AttributeGet(state, 'ComponentStartTime', timevals, itemCount=thecount, rc=rc)<a name='136'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='137'>
<font color=#447700>!JM return but don't fail; let the caller figure out what to do<a name='138'></font>
       RETURN<a name='139'>
     ENDIF<a name='140'>
     year   = timevals(1)<a name='141'>
     month  = timevals(2)<a name='142'>
     day    = timevals(3)<a name='143'>
     hour   = timevals(4)<a name='144'>
     minute = timevals(5)<a name='145'>
     second = timevals(6)<a name='146'>
     CALL ESMF_TimeSet(startTime, yy=year, mm=month, dd=day, &amp;<a name='147'>
                       h=hour, m=minute, s=second, rc=rc)<a name='148'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='149'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_449"> ( 'ESMF_TimeSet(startTime) failed' )<a name='150'>
     ENDIF<a name='151'>
     <font color=#447700>! stop time<a name='152'></font>
     thecount = SIZE(timevals)<a name='153'>
     CALL ESMF_AttributeGet(state, 'ComponentStopTime', timevals, itemCount=thecount, rc=rc)<a name='154'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='155'>
<font color=#447700>!JM return but don't fail; let the caller figure out what to do<a name='156'></font>
       <font color=#447700>!CALL wrf_error_fatal ( 'ESMF_AttributeGet(ComponentStopTime) failed' )<a name='157'></font>
       RETURN<a name='158'>
     ENDIF<a name='159'>
     year   = timevals(1)<a name='160'>
     month  = timevals(2)<a name='161'>
     day    = timevals(3)<a name='162'>
     hour   = timevals(4)<a name='163'>
     minute = timevals(5)<a name='164'>
     second = timevals(6)<a name='165'>
     CALL ESMF_TimeSet(stopTime, yy=year, mm=month, dd=day, &amp;<a name='166'>
                       h=hour, m=minute, s=second, rc=rc)<a name='167'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='168'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_450"> ( 'ESMF_TimeSet(stopTime) failed' )<a name='169'>
     ENDIF<a name='170'>
     <font color=#447700>! coupling time step<a name='171'></font>
     thecount = SIZE(timevals)<a name='172'>
     CALL ESMF_AttributeGet(state, 'ComponentCouplingInterval', timevals, itemCount=thecount, rc=rc)<a name='173'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='174'>
<font color=#447700>!JM return but don't fail; let the caller figure out what to do<a name='175'></font>
       <font color=#447700>!CALL wrf_error_fatal ( 'ESMF_AttributeGet(ComponentCouplingInterval) failed' )<a name='176'></font>
       RETURN<a name='177'>
     ENDIF<a name='178'>
     year   = timevals(1)<a name='179'>
     month  = timevals(2)<a name='180'>
     day    = timevals(3)<a name='181'>
     hour   = timevals(4)<a name='182'>
     minute = timevals(5)<a name='183'>
     second = timevals(6)<a name='184'>
     CALL ESMF_TimeIntervalSet(couplingInterval, yy=year, mm=month, d=day, &amp;<a name='185'>
                               h=hour, m=minute, s=second, rc=rc)<a name='186'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='187'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_451"> ( 'ESMF_TimeIntervalSet(couplingInterval) failed' )<a name='188'>
     ENDIF<a name='189'>
   END SUBROUTINE GetTimesFromState<a name='190'>
<a name='191'>
<a name='192'>
<a name='193'>
   <font color=#447700>! Extract time information attached as meta-data from one or more <a name='194'></font>
   <font color=#447700>! ESMF_States.  To use this with more than one ESMF_State, put the <a name='195'></font>
   <font color=#447700>! ESMF_States into a single ESMF_State.  If times differ, an attempt <a name='196'></font>
   <font color=#447700>! is made to reconcile them.  <a name='197'></font>
<A NAME='GETTIMESFROMSTATES'><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='198'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>GetTimesFromStates</font>( state, startTime, stopTime, couplingInterval ) <A href='../../call_to/GETTIMESFROMSTATES.html' TARGET='index'>1</A>,<A href='../../call_from/GETTIMESFROMSTATES.html' TARGET='index'>9</A><a name='199'>
   USE ESMF<a name='200'>
     TYPE(ESMF_State),        INTENT(INOUT) :: state<a name='201'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: startTime<a name='202'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: stopTime<a name='203'>
     TYPE(ESMF_TimeInterval), INTENT(INOUT) :: couplingInterval<a name='204'>
     <font color=#447700>! locals<a name='205'></font>
     INTEGER :: rc<a name='206'>
     INTEGER :: numItems, numStates, i, istate<a name='207'>
     TYPE(ESMF_StateItem_Flag), ALLOCATABLE :: itemTypes(:)<a name='208'>
     TYPE(ESMF_State) :: tmpState<a name='209'>
     CHARACTER (len=ESMF_MAXSTR), ALLOCATABLE :: itemNames(:)<a name='210'>
     TYPE(ESMF_Time),         ALLOCATABLE :: startTimes(:)<a name='211'>
     TYPE(ESMF_Time),         ALLOCATABLE :: stopTimes(:)<a name='212'>
     TYPE(ESMF_TimeInterval), ALLOCATABLE :: couplingIntervals(:)<a name='213'>
     CHARACTER (len=132) :: mess<a name='214'>
<a name='215'>
<font color=#447700>! Unfortunately, implementing this is unnecessarily difficult due <a name='216'></font>
<font color=#447700>! to lack of Iterators for ESMF_State.  <a name='217'></font>
<a name='218'>
     <font color=#447700>! Since there are no convenient iterators for ESMF_State, <a name='219'></font>
     <font color=#447700>! write a lot of code...  <a name='220'></font>
     <font color=#447700>! Figure out how many items are in the ESMF_State<a name='221'></font>
     CALL ESMF_StateGet(state, itemCount=numItems, rc=rc)<a name='222'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='223'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_452"> ( 'ESMF_StateGet(numItems) failed' )<a name='224'>
     ENDIF<a name='225'>
     <font color=#447700>! allocate an array to hold the types of all items<a name='226'></font>
     ALLOCATE( itemTypes(numItems) )<a name='227'>
     <font color=#447700>! allocate an array to hold the names of all items<a name='228'></font>
     ALLOCATE( itemNames(numItems) )<a name='229'>
     <font color=#447700>! get the item types and names<a name='230'></font>
     CALL ESMF_StateGet(state, itemtypeList=itemTypes, &amp;<a name='231'>
                        itemNameList=itemNames, rc=rc)<a name='232'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='233'>
       WRITE(str,*) 'ESMF_StateGet itemTypes failed with rc = ', rc<a name='234'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_453"> ( str )<a name='235'>
     ENDIF<a name='236'>
     <font color=#447700>! count how many items are ESMF_States<a name='237'></font>
     numStates = 0<a name='238'>
     DO i=1,numItems<a name='239'>
       IF ( itemTypes(i) == ESMF_STATEITEM_STATE ) THEN<a name='240'>
         numStates = numStates + 1<a name='241'>
       ENDIF<a name='242'>
     ENDDO<a name='243'>
     ALLOCATE( startTimes(numStates), stopTimes(numStates), &amp;<a name='244'>
               couplingIntervals(numStates) )<a name='245'>
     IF ( numStates &gt; 0) THEN<a name='246'>
       <font color=#447700>! finally, extract nested ESMF_States by name, if there are any<a name='247'></font>
       <font color=#447700>! (should be able to do this by index at least!)<a name='248'></font>
       istate = 0<a name='249'>
       DO i=1,numItems<a name='250'>
         IF ( itemTypes(i) == ESMF_STATEITEM_STATE ) THEN<a name='251'>
           CALL ESMF_StateGet( state, itemName=TRIM(itemNames(i)), &amp;<a name='252'>
                               nestedState=tmpState, rc=rc )<a name='253'>
           IF ( rc /= ESMF_SUCCESS) THEN<a name='254'>
             WRITE(str,*) 'ESMF_StateGet(',TRIM(itemNames(i)),') failed'<a name='255'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_454"> ( str )<a name='256'>
           ENDIF<a name='257'>
           istate = istate + 1<a name='258'>
           CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATE'>GetTimesFromState</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETTIMESFROMSTATE_1">( tmpState, startTimes(istate),         &amp;<a name='259'>
                                             stopTimes(istate),          &amp;<a name='260'>
                                             couplingIntervals(istate), rc )<a name='261'>
           IF ( rc /= ESMF_SUCCESS ) THEN<a name='262'>
             istate = istate - 1<a name='263'>
           ENDIF<a name='264'>
         ENDIF<a name='265'>
       ENDDO<a name='266'>
       IF ( istate .EQ. 1 ) THEN<a name='267'>
        <font color=#447700>! this presupposes that 1 of the child states exist and has<a name='268'></font>
        <font color=#447700>! valid times in it.  Use that one.<a name='269'></font>
          WRITE(mess,*)'WARNING: Only ',TRIM(itemNames(1)),&amp;<a name='270'>
                       ' is valid and has time info in it.  Using that.'<a name='271'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_524">(mess) <a name='272'>
          CALL ESMF_StateGet( state, itemName=TRIM(itemNames(1)), &amp;<a name='273'>
                              nestedState=tmpState, rc=rc )<a name='274'>
          CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATE'>GetTimesFromState</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETTIMESFROMSTATE_2">( tmpState, startTime, stopTime, &amp;<a name='275'>
                                  couplingInterval , rc )<a name='276'>
       ELSE IF ( istate .GT. 1 ) THEN<a name='277'>
          CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#RECONCILETIMES'>ReconcileTimes</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RECONCILETIMES_1">( startTimes, stopTimes, couplingIntervals, &amp;<a name='278'>
                               startTime,  stopTime,  couplingInterval )<a name='279'>
       ELSE <a name='280'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_455">('no valid states with times found. giving up.')<a name='281'>
       ENDIF<a name='282'>
     ELSE<a name='283'>
       <font color=#447700>! there are no nested ESMF_States so use parent state only<a name='284'></font>
       CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATE'>GetTimesFromState</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETTIMESFROMSTATES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETTIMESFROMSTATE_3">( state, startTime, stopTime, &amp;<a name='285'>
                               couplingInterval , rc )<a name='286'>
     ENDIF<a name='287'>
<a name='288'>
     <font color=#447700>! deallocate locals<a name='289'></font>
     DEALLOCATE( itemTypes )<a name='290'>
     DEALLOCATE( itemNames )<a name='291'>
     DEALLOCATE( startTimes, stopTimes, couplingIntervals )<a name='292'>
<a name='293'>
   END SUBROUTINE GetTimesFromStates<a name='294'>
<a name='295'>
<a name='296'>
   <font color=#447700>! Reconcile all times and intervals in startTimes, stopTimes, and <a name='297'></font>
   <font color=#447700>! couplingIntervals and return the results in startTime, stopTime, and <a name='298'></font>
   <font color=#447700>! couplingInterval.  Abort if reconciliation is not possible.  <a name='299'></font>
<A NAME='RECONCILETIMES'><A href='../../html_code/main/wrf_ESMFMod.F.html#RECONCILETIMES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='300'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>ReconcileTimes</font>( startTimes, stopTimes, couplingIntervals, &amp; <A href='../../call_to/RECONCILETIMES.html' TARGET='index'>1</A>,<A href='../../call_from/RECONCILETIMES.html' TARGET='index'>6</A><a name='301'>
                              startTime,  stopTime,  couplingInterval )<a name='302'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: startTimes(:)<a name='303'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: stopTimes(:)<a name='304'>
     TYPE(ESMF_TimeInterval), INTENT(INOUT) :: couplingIntervals(:)<a name='305'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: startTime<a name='306'>
     TYPE(ESMF_Time),         INTENT(INOUT) :: stopTime<a name='307'>
     TYPE(ESMF_TimeInterval), INTENT(INOUT) :: couplingInterval<a name='308'>
     <font color=#447700>! locals<a name='309'></font>
     INTEGER :: numTimes, numTimesTmp, i<a name='310'>
<a name='311'>
     <font color=#447700>! how many sets of time info?<a name='312'></font>
     numTimes = SIZE(startTimes)<a name='313'>
     IF ( numTimes &lt; 2 ) THEN<a name='314'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#RECONCILETIMES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_456"> ( 'SIZE(startTimes) too small' )<a name='315'>
     ENDIF<a name='316'>
     numTimesTmp = SIZE(stopTimes)<a name='317'>
     IF ( numTimes /= numTimesTmp ) THEN<a name='318'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#RECONCILETIMES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_457"> ( 'incorrect SIZE(stopTimes)' )<a name='319'>
     ENDIF<a name='320'>
     numTimesTmp = SIZE(couplingIntervals)<a name='321'>
     IF ( numTimes /= numTimesTmp ) THEN<a name='322'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#RECONCILETIMES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_458"> ( 'incorrect SIZE(couplingIntervals)' )<a name='323'>
     ENDIF<a name='324'>
<a name='325'>
     <font color=#447700>! reconcile<a name='326'></font>
<font color=#447700>!TODO:  For now this is very simple.  Fancy it up later.  <a name='327'></font>
     DO i = 1, numTimes<a name='328'>
       IF ( i == 1 ) THEN<a name='329'>
         startTime = startTimes(i)<a name='330'>
         stopTime = stopTimes(i)<a name='331'>
         couplingInterval = couplingIntervals(i)<a name='332'>
       ELSE<a name='333'>
<font color=#447700>!jm         IF ( startTimes(i) /= startTime ) THEN<a name='334'></font>
<font color=#447700>!jm           CALL wrf_message ( 'ReconcileTimes:  inconsistent startTimes. Using first.' )<a name='335'></font>
<font color=#447700>!jm           startTimes(i) = startTime<a name='336'></font>
<font color=#447700>!jm         ENDIF<a name='337'></font>
<font color=#447700>!jm         IF ( stopTimes(i) /= stopTime ) THEN<a name='338'></font>
<font color=#447700>!jm           CALL wrf_message ( 'ReconcileTimes:  inconsistent stopTimes. Using first.' )<a name='339'></font>
<font color=#447700>!jm           stopTimes(i) = stopTime<a name='340'></font>
<font color=#447700>!jm         ENDIF<a name='341'></font>
         IF ( startTimes(i) &gt; startTime ) THEN<a name='342'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/wrf_ESMFMod.F.html#RECONCILETIMES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_525"> ( 'ReconcileTimes:  inconsistent startTimes. Using later.' )<a name='343'>
           startTime = startTimes(i)<a name='344'>
         ENDIF<a name='345'>
         IF ( stopTimes(i) &lt; stopTime ) THEN<a name='346'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/wrf_ESMFMod.F.html#RECONCILETIMES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_526"> ( 'ReconcileTimes:  inconsistent stopTimes. Using earlier.' )<a name='347'>
           stopTime = stopTimes(i)<a name='348'>
         ENDIF<a name='349'>
         IF ( couplingIntervals(i) /= couplingInterval ) THEN<a name='350'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/wrf_ESMFMod.F.html#RECONCILETIMES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_527"> ( 'ReconcileTimes:  inconsistent couplingIntervals. Using first.' )<a name='351'>
           couplingIntervals(i) = couplingInterval<a name='352'>
         ENDIF<a name='353'>
       ENDIF<a name='354'>
     ENDDO<a name='355'>
     stopTimes = stopTime<a name='356'>
     startTimes = startTime<a name='357'>
<a name='358'>
   END SUBROUTINE ReconcileTimes<a name='359'>
<a name='360'>
<a name='361'>
<a name='362'>
   <font color=#447700>!TODO:  Eliminate this once this information can be derived via other <a name='363'></font>
   <font color=#447700>!TODO:  means.  <a name='364'></font>
<A NAME='ATTACHDECOMPTOSTATE'><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHDECOMPTOSTATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='365'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>AttachDecompToState</font>( state,                        &amp;  <A href='../../call_to/ATTACHDECOMPTOSTATE.html' TARGET='index'>3</A>,<A href='../../call_from/ATTACHDECOMPTOSTATE.html' TARGET='index'>2</A><a name='366'>
                                   ids, ide, jds, jde, kds, kde, &amp;<a name='367'>
                                   ims, ime, jms, jme, kms, kme, &amp;<a name='368'>
                                   ips, ipe, jps, jpe, kps, kpe, &amp;<a name='369'>
                                   domdesc, bdy_mask )<a name='370'>
     TYPE(ESMF_State), INTENT(INOUT) :: state<a name='371'>
     INTEGER,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde<a name='372'>
     INTEGER,          INTENT(IN   ) :: ims, ime, jms, jme, kms, kme<a name='373'>
     INTEGER,          INTENT(IN   ) :: ips, ipe, jps, jpe, kps, kpe<a name='374'>
     INTEGER,          INTENT(IN   ) :: domdesc<a name='375'>
     LOGICAL,          INTENT(IN   ) :: bdy_mask(4)<a name='376'>
     <font color=#447700>! locals<a name='377'></font>
     INTEGER :: i, rc<a name='378'>
     <font color=#447700>! big enough to hold the integer values listed above<a name='379'></font>
     INTEGER(ESMF_KIND_I4) :: intvals(19)<a name='380'>
     <font color=#447700>! big enough to hold the logical values listed above<a name='381'></font>
<font color=#447700>!     TYPE(ESMF_Logical) :: logvals(4)<a name='382'></font>
     logical :: logvals(4)<a name='383'>
<a name='384'>
     <font color=#447700>! first the logicals<a name='385'></font>
     <font color=#447700>! Usually, when writing an API for a target language, it is considered <a name='386'></font>
     <font color=#447700>! good practice to use native types of the target language in the <a name='387'></font>
     <font color=#447700>! interfaces.  <a name='388'></font>
     logvals = .FALSE.<a name='389'>
     DO i = 1, SIZE(bdy_mask)<a name='390'>
       IF (bdy_mask(i)) THEN<a name='391'>
         logvals(i) = .TRUE.<a name='392'>
       ENDIF<a name='393'>
     ENDDO<a name='394'>
     CALL ESMF_AttributeSet(state, 'DecompositionLogicals', logvals, itemCount=SIZE(logvals), rc=rc)<a name='395'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='396'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHDECOMPTOSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_459"> ( 'ESMF_AttributeSet(DecompositionLogicals) failed' )<a name='397'>
     ENDIF<a name='398'>
     <font color=#447700>! now the integers<a name='399'></font>
     intvals(1) = ids<a name='400'>
     intvals(2) = ide<a name='401'>
     intvals(3) = jds<a name='402'>
     intvals(4) = jde<a name='403'>
     intvals(5) = kds<a name='404'>
     intvals(6) = kde<a name='405'>
     intvals(7) = ims<a name='406'>
     intvals(8) = ime<a name='407'>
     intvals(9) = jms<a name='408'>
     intvals(10) = jme<a name='409'>
     intvals(11) = kms<a name='410'>
     intvals(12) = kme<a name='411'>
     intvals(13) = ips<a name='412'>
     intvals(14) = ipe<a name='413'>
     intvals(15) = jps<a name='414'>
     intvals(16) = jpe<a name='415'>
     intvals(17) = kps<a name='416'>
     intvals(18) = kpe<a name='417'>
     intvals(19) = domdesc<a name='418'>
     CALL ESMF_AttributeSet(state, 'DecompositionIntegers', intvals, itemCount=SIZE(intvals), rc=rc)<a name='419'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='420'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHDECOMPTOSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_460"> ( 'ESMF_AttributeSet(DecompositionIntegers) failed' )<a name='421'>
     ENDIF<a name='422'>
   END SUBROUTINE AttachDecompToState<a name='423'>
<a name='424'>
<a name='425'>
<a name='426'>
   <font color=#447700>!TODO:  Eliminate this once this information can be derived via other <a name='427'></font>
   <font color=#447700>!TODO:  means.  <a name='428'></font>
<A NAME='GETDECOMPFROMSTATE'><A href='../../html_code/main/wrf_ESMFMod.F.html#GETDECOMPFROMSTATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='429'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>GetDecompFromState</font>( state,                        &amp;  <A href='../../call_to/GETDECOMPFROMSTATE.html' TARGET='index'>2</A>,<A href='../../call_from/GETDECOMPFROMSTATE.html' TARGET='index'>7</A><a name='430'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='431'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='432'>
                                  ips, ipe, jps, jpe, kps, kpe, &amp;<a name='433'>
                                  domdesc, bdy_mask )<a name='434'>
     TYPE(ESMF_State), INTENT(INOUT) :: state<a name='435'>
     INTEGER,          INTENT(  OUT) :: ids, ide, jds, jde, kds, kde<a name='436'>
     INTEGER,          INTENT(  OUT) :: ims, ime, jms, jme, kms, kme<a name='437'>
     INTEGER,          INTENT(  OUT) :: ips, ipe, jps, jpe, kps, kpe<a name='438'>
     INTEGER,          INTENT(  OUT) :: domdesc<a name='439'>
     LOGICAL,          INTENT(  OUT) :: bdy_mask(4)<a name='440'>
     <font color=#447700>! locals<a name='441'></font>
     INTEGER :: i, rc<a name='442'>
     <font color=#447700>! big enough to hold the integer values listed above<a name='443'></font>
     INTEGER(ESMF_KIND_I4) :: intvals(19)<a name='444'>
     <font color=#447700>! big enough to hold the logical values listed above<a name='445'></font>
     logical :: logvals(4)<a name='446'>
     integer :: thecount <font color=#447700>! ah ah ah<a name='447'></font>
<a name='448'>
     <font color=#447700>! first the logicals<a name='449'></font>
     thecount = SIZE(logvals)<a name='450'>
     CALL ESMF_AttributeGet(state, 'DecompositionLogicals', logvals, itemCount=thecount, rc=rc)<a name='451'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='452'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETDECOMPFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_461"> ( 'ESMF_AttributeGet(DecompositionLogicals) failed' )<a name='453'>
     ENDIF<a name='454'>
     <font color=#447700>! Usually, when writing an API for a target language, it is considered <a name='455'></font>
     <font color=#447700>! good practice to use native types of the target language in the <a name='456'></font>
     <font color=#447700>! interfaces.  <a name='457'></font>
     bdy_mask = .FALSE.<a name='458'>
     DO i = 1, SIZE(logvals)<a name='459'>
       IF (logvals(i) ) THEN<a name='460'>
         bdy_mask(i) = .TRUE.<a name='461'>
       ENDIF<a name='462'>
     ENDDO<a name='463'>
     <font color=#447700>! now the integers<a name='464'></font>
     thecount = SIZE(intvals)<a name='465'>
     CALL ESMF_AttributeGet(state, 'DecompositionIntegers', intvals, itemCount=thecount, rc=rc)<a name='466'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='467'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETDECOMPFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_462"> ( 'ESMF_AttributeGet(DecompositionIntegers) failed' )<a name='468'>
     ENDIF<a name='469'>
     ids = intvals(1)<a name='470'>
     ide = intvals(2)<a name='471'>
     jds = intvals(3)<a name='472'>
     jde = intvals(4)<a name='473'>
     kds = intvals(5)<a name='474'>
     kde = intvals(6)<a name='475'>
     ims = intvals(7)<a name='476'>
     ime = intvals(8)<a name='477'>
     jms = intvals(9)<a name='478'>
     jme = intvals(10)<a name='479'>
     kms = intvals(11)<a name='480'>
     kme = intvals(12)<a name='481'>
     ips = intvals(13)<a name='482'>
     ipe = intvals(14)<a name='483'>
     jps = intvals(15)<a name='484'>
     jpe = intvals(16)<a name='485'>
     kps = intvals(17)<a name='486'>
     kpe = intvals(18)<a name='487'>
     domdesc = intvals(19)<a name='488'>
   END SUBROUTINE GetDecompFromState<a name='489'>
<a name='490'>
<a name='491'>
<a name='492'>
END MODULE module_metadatautils<a name='493'>
<a name='494'>
<a name='495'>
<a name='496'>
<A NAME='MODULE_WRF_COMPONENT_TOP'><A href='../../html_code/main/wrf_ESMFMod.F.html#MODULE_WRF_COMPONENT_TOP' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='497'>
<font color=#993300>MODULE </font><font color=#cc0000>module_wrf_component_top</font> <A href='../../call_to/MODULE_WRF_COMPONENT_TOP.html' TARGET='index'>1</A><a name='498'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='499'></font>
<font color=#447700>! This module defines wrf_component_init1(), wrf_component_init2(), <a name='500'></font>
<font color=#447700>! wrf_component_run(), and wrf_component_finalize() routines that are called <a name='501'></font>
<font color=#447700>! when WRF is run as an ESMF component.  <a name='502'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='503'></font>
<a name='504'>
   USE ESMF<a name='505'>
   USE <A href='../../html_code/main/module_wrf_top.F.html#MODULE_WRF_TOP'>module_wrf_top</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETDECOMPFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_TOP_2">, ONLY : wrf_init, wrf_run, wrf_finalize<a name='506'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETDECOMPFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_219">, ONLY : head_grid, get_ijk_from_grid<a name='507'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETDECOMPFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_107"><a name='508'>
   USE <A href='../../html_code/frame/module_streams.F.html#MODULE_STREAMS'>module_streams</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETDECOMPFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STREAMS_4"><a name='509'>
<a name='510'>
   USE module_esmf_extensions<a name='511'>
   USE <A href='../../html_code/main/wrf_ESMFMod.F.html#MODULE_METADATAUTILS'>module_metadatautils</A><A href='../../html_code/main/wrf_ESMFMod.F.html#GETDECOMPFROMSTATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_METADATAUTILS_1">, ONLY: AttachTimesToState, AttachDecompToState<a name='512'>
<a name='513'>
<a name='514'>
<a name='515'>
   IMPLICIT NONE<a name='516'>
<a name='517'>
   <font color=#447700>! everything is private by default<a name='518'></font>
   PRIVATE<a name='519'>
<a name='520'>
   <font color=#447700>! Public entry points<a name='521'></font>
   PUBLIC wrf_component_init1<a name='522'>
   PUBLIC wrf_component_init2<a name='523'>
   PUBLIC wrf_component_run<a name='524'>
   PUBLIC wrf_component_finalize<a name='525'>
<a name='526'>
   <font color=#447700>! private stuff<a name='527'></font>
   CHARACTER (ESMF_MAXSTR) :: str<a name='528'>
<a name='529'>
CONTAINS<a name='530'>
<a name='531'>
<a name='532'>
<A NAME='WRF_COMPONENT_INIT1'><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='533'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_component_init1</font>( gcomp, importState, exportState, clock, rc ),<A href='../../call_from/WRF_COMPONENT_INIT1.html' TARGET='index'>15</A><a name='534'>
     TYPE(ESMF_GridComp), TARGET, INTENT(INOUT) :: gcomp<a name='535'>
     TYPE(ESMF_State),    TARGET, INTENT(INOUT) :: importState<a name='536'>
     TYPE(ESMF_State),    TARGET, INTENT(INOUT) :: exportState<a name='537'>
     TYPE(ESMF_Clock),    TARGET, INTENT(INOUT) :: clock<a name='538'>
#ifdef DM_PARALLEL<a name='539'>
     TYPE(ESMF_VM) :: vm<a name='540'>
     INTEGER :: mpicomtmp<a name='541'>
#endif<a name='542'>
     INTEGER,                     INTENT(  OUT) :: rc<a name='543'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='544'></font>
<font color=#447700>!     WRF component init routine, phase 1.  Passes relevant coupling <a name='545'></font>
<font color=#447700>!     information back as metadata on exportState.  <a name='546'></font>
<font color=#447700>!<a name='547'></font>
<font color=#447700>!     The arguments are:<a name='548'></font>
<font color=#447700>!       gcomp           Component<a name='549'></font>
<font color=#447700>!       importState     Importstate<a name='550'></font>
<font color=#447700>!       exportState     Exportstate<a name='551'></font>
<font color=#447700>!       clock           External clock<a name='552'></font>
<font color=#447700>!       rc              Return code; equals ESMF_SUCCESS if there are no errors,<a name='553'></font>
<font color=#447700>!                       otherwise ESMF_FAILURE.<a name='554'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='555'></font>
<font color=#447700>!TODO:  Note that much of the decomposition-related meta-data attached to the <a name='556'></font>
<font color=#447700>!TODO:  exportState are WRF-specific and are only useful if other components <a name='557'></font>
<font color=#447700>!TODO:  want to re-use the WRF IOAPI with the same decomposition as the WRF <a name='558'></font>
<font color=#447700>!TODO:  model.  This is true for the simple WRF+CPL+SST test case, but will <a name='559'></font>
<font color=#447700>!TODO:  not be in general.  Of course other components are free to ignore this <a name='560'></font>
<font color=#447700>!TODO:  information.  <a name='561'></font>
<a name='562'>
     <font color=#447700>! Local variables<a name='563'></font>
     TYPE(ESMF_GridComp), POINTER :: p_gcomp<a name='564'>
     TYPE(ESMF_State),    POINTER :: p_importState<a name='565'>
     TYPE(ESMF_State),    POINTER :: p_exportState<a name='566'>
     TYPE(ESMF_Clock),    POINTER :: p_clock<a name='567'>
     <font color=#447700>! Time hackery<a name='568'></font>
     TYPE(ESMF_Time) :: startTime<a name='569'>
     TYPE(ESMF_Time) :: stopTime<a name='570'>
     TYPE(ESMF_TimeInterval) :: couplingInterval<a name='571'>
     <font color=#447700>! decomposition hackery<a name='572'></font>
     INTEGER :: ids, ide, jds, jde, kds, kde<a name='573'>
     INTEGER :: ims, ime, jms, jme, kms, kme<a name='574'>
     INTEGER :: ips, ipe, jps, jpe, kps, kpe<a name='575'>
     INTEGER :: domdesc<a name='576'>
     LOGICAL :: bdy_mask(4)<a name='577'>
     CHARACTER(LEN=256) :: couplingIntervalString<a name='578'>
<a name='579'>
     rc = ESMF_SUCCESS<a name='580'>
<a name='581'>
     p_gcomp =&gt; gcomp<a name='582'>
     p_importState =&gt; importState<a name='583'>
     p_exportState =&gt; exportState<a name='584'>
     p_clock =&gt; clock<a name='585'>
     <font color=#447700>! NOTE:  It will be possible to remove this call once ESMF supports <a name='586'></font>
     <font color=#447700>!        interfaces ESMF_ClockGetCurrent(), ESMF_ImportStateGetCurrent(), <a name='587'></font>
     <font color=#447700>!        ESMF_ExportStateGetCurrent(), and ESMF_GridCompGetCurrent().  <a name='588'></font>
     CALL ESMF_SetCurrent( gcomp=p_gcomp, importState=p_importState, &amp;<a name='589'>
                           exportState=p_exportState, clock=p_clock )<a name='590'>
<a name='591'>
#ifdef DM_PARALLEL<a name='592'>
     CALL ESMF_VMGetCurrent(vm, rc=rc)<a name='593'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='594'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_463"> ( 'wrf_component_init1:  ESMF_VMGetCurrent failed' )<a name='595'>
     ENDIF<a name='596'>
     CALL ESMF_VMGet(vm, mpiCommunicator=mpicomtmp, rc=rc)<a name='597'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='598'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_464"> ( 'wrf_component_init1:  ESMF_VMGet failed' )<a name='599'>
     ENDIF<a name='600'>
     CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_13">( mpicomtmp )<a name='601'>
#endif<a name='602'>
<a name='603'>
     <font color=#447700>! Call WRF "init" routine, which, for a DM_PARALLEL run, will recognize <a name='604'></font>
     <font color=#447700>! that ESMF has already called MPI_INIT and respond appropriately.  <a name='605'></font>
     CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_INIT'>wrf_init</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_INIT_2">( no_init1=.TRUE. )<a name='606'>
<a name='607'>
     <font color=#447700>! For now, use settings from WRF component intialization to set up <a name='608'></font>
     <font color=#447700>! top-level clock.  Per suggestion from ESMF Core team, these are passed <a name='609'></font>
     <font color=#447700>! back as attributes on exportState.  <a name='610'></font>
     CALL <A href='../../html_code/share/module_date_time.F.html#WRF_CLOCKPRINT'>wrf_clockprint</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CLOCKPRINT_2">( 100, head_grid%domain_clock, &amp;<a name='611'>
            'DEBUG wrf_component_init1():  head_grid%domain_clock,' )<a name='612'>
     CALL ESMF_ClockGet(head_grid%domain_clock, startTime=startTime, &amp;<a name='613'>
                        stopTime=stopTime, rc=rc)<a name='614'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='615'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_465"> ( 'wrf_component_init1:  ESMF_ClockGet failed' )<a name='616'>
     ENDIF<a name='617'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_401">( 500, 'DEBUG wrf_component_init1():  before wrf_findCouplingInterval' )<a name='618'>
     CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_FINDCOUPLINGINTERVAL'>wrf_findCouplingInterval</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_FINDCOUPLINGINTERVAL_1">( startTime, stopTime, couplingInterval )<a name='619'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_402">( 500, 'DEBUG wrf_component_init1():  after wrf_findCouplingInterval' )<a name='620'>
     CALL ESMF_TimeIntervalGet( couplingInterval, TimeString=couplingIntervalString, &amp;<a name='621'>
                                rc=rc )<a name='622'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='623'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_466"> ( 'wrf_component_init1:  ESMF_TimeIntervalGet failed' )<a name='624'>
     ENDIF<a name='625'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_403">( 100, 'DEBUG wrf_component_init1():  couplingInterval = '//TRIM(couplingIntervalString) )<a name='626'>
     CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHTIMESTOSTATE'>AttachTimesToState</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ATTACHTIMESTOSTATE_1">( exportState, startTime, stopTime, couplingInterval )<a name='627'>
     CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_GETDECOMPINFO'>wrf_getDecompInfo</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GETDECOMPINFO_1">( ids, ide, jds, jde, kds, kde, &amp;<a name='628'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='629'>
                             ips, ipe, jps, jpe, kps, kpe, &amp;<a name='630'>
                             domdesc, bdy_mask )<a name='631'>
     CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHDECOMPTOSTATE'>AttachDecompToState</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ATTACHDECOMPTOSTATE_1">( exportState,                  &amp;<a name='632'>
                               ids, ide, jds, jde, kds, kde, &amp;<a name='633'>
                               ims, ime, jms, jme, kms, kme, &amp;<a name='634'>
                               ips, ipe, jps, jpe, kps, kpe, &amp;<a name='635'>
                               domdesc, bdy_mask )<a name='636'>
     CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#ATTACHDECOMPTOSTATE'>AttachDecompToState</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ATTACHDECOMPTOSTATE_2">( importState,                  &amp;<a name='637'>
                               ids, ide, jds, jde, kds, kde, &amp;<a name='638'>
                               ims, ime, jms, jme, kms, kme, &amp;<a name='639'>
                               ips, ipe, jps, jpe, kps, kpe, &amp;<a name='640'>
                               domdesc, bdy_mask )<a name='641'>
<a name='642'>
   END SUBROUTINE wrf_component_init1<a name='643'>
<a name='644'>
<a name='645'>
<a name='646'>
<A NAME='WRF_COMPONENT_INIT2'><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='647'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_component_init2</font>( gcomp, importState, exportState, clock, rc ),<A href='../../call_from/WRF_COMPONENT_INIT2.html' TARGET='index'>24</A><a name='648'>
     TYPE(ESMF_GridComp), TARGET, INTENT(INOUT) :: gcomp<a name='649'>
     TYPE(ESMF_State),    TARGET, INTENT(INOUT) :: importState<a name='650'>
     TYPE(ESMF_State),    TARGET, INTENT(INOUT) :: exportState<a name='651'>
     TYPE(ESMF_Clock),    TARGET, INTENT(INOUT) :: clock<a name='652'>
     INTEGER,                     INTENT(  OUT) :: rc<a name='653'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='654'></font>
<font color=#447700>!     WRF component init routine, phase 2.  Initializes importState and <a name='655'></font>
<font color=#447700>!     exportState.  <a name='656'></font>
<font color=#447700>!<a name='657'></font>
<font color=#447700>!     The arguments are:<a name='658'></font>
<font color=#447700>!       gcomp           Component<a name='659'></font>
<font color=#447700>!       importState     Importstate<a name='660'></font>
<font color=#447700>!       exportState     Exportstate<a name='661'></font>
<font color=#447700>!       clock           External clock<a name='662'></font>
<font color=#447700>!       rc              Return code; equals ESMF_SUCCESS if there are no errors,<a name='663'></font>
<font color=#447700>!                       otherwise ESMF_FAILURE.<a name='664'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='665'></font>
<a name='666'>
     <font color=#447700>! Local variables<a name='667'></font>
     TYPE(ESMF_GridComp), POINTER :: p_gcomp<a name='668'>
     TYPE(ESMF_State),    POINTER :: p_importState<a name='669'>
     TYPE(ESMF_State),    POINTER :: p_exportState<a name='670'>
     TYPE(ESMF_Clock),    POINTER :: p_clock<a name='671'>
     <font color=#447700>! Time hackery<a name='672'></font>
     TYPE(ESMF_Time) :: startTime<a name='673'>
     TYPE(ESMF_Time) :: stopTime<a name='674'>
     TYPE(ESMF_TimeInterval) :: couplingInterval<a name='675'>
     <font color=#447700>! decomposition hackery<a name='676'></font>
     INTEGER :: ids, ide, jds, jde, kds, kde<a name='677'>
     INTEGER :: ims, ime, jms, jme, kms, kme<a name='678'>
     INTEGER :: ips, ipe, jps, jpe, kps, kpe<a name='679'>
     INTEGER :: domdesc<a name='680'>
     LOGICAL :: bdy_mask(4)<a name='681'>
     INTEGER :: itemCount, i<a name='682'>
     TYPE(ESMF_StateIntent_Flag) :: stateintent<a name='683'>
     CHARACTER (ESMF_MAXSTR) :: statename<a name='684'>
     CHARACTER (ESMF_MAXSTR), ALLOCATABLE :: itemNames(:)<a name='685'>
     TYPE(ESMF_StateItem_Flag), ALLOCATABLE :: itemTypes(:)<a name='686'>
<a name='687'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_404"> ( 100, 'wrf_component_init2():  begin' )<a name='688'>
<a name='689'>
     <font color=#447700>! check exportState<a name='690'></font>
     CALL ESMF_StateGet( exportState, itemCount=itemCount, &amp;<a name='691'>
                         stateintent=stateintent, rc=rc )<a name='692'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='693'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_467">("wrf_component_init2:  ESMF_StateGet(exportState) failed" )<a name='694'>
     ENDIF<a name='695'>
     WRITE (str,*) 'wrf_component_init2: exportState itemCount = ', itemCount<a name='696'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_405"> ( 100 , TRIM(str) )<a name='697'>
     IF ( stateintent /= ESMF_STATEINTENT_EXPORT ) THEN<a name='698'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_468">("wrf_component_init2:  exportState is not an export state" )<a name='699'>
     ENDIF<a name='700'>
<a name='701'>
     <font color=#447700>! check importState<a name='702'></font>
     CALL ESMF_StateGet( importState, itemCount=itemCount, &amp;<a name='703'>
                         stateintent=stateintent, rc=rc )<a name='704'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='705'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_469">("wrf_component_init2:  ESMF_StateGet(importState) failed" )<a name='706'>
     ENDIF<a name='707'>
     WRITE (str,*) 'wrf_component_init2: importState itemCount = ', itemCount<a name='708'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_406"> ( 100 , TRIM(str) )<a name='709'>
     IF ( stateintent /= ESMF_STATEINTENT_IMPORT ) THEN<a name='710'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_470">("wrf_component_init2:  importState is not an import state" )<a name='711'>
     ENDIF<a name='712'>
<a name='713'>
     p_gcomp =&gt; gcomp<a name='714'>
     p_importState =&gt; importState<a name='715'>
     p_exportState =&gt; exportState<a name='716'>
     p_clock =&gt; clock<a name='717'>
     <font color=#447700>! NOTE:  It will be possible to remove this call once ESMF supports <a name='718'></font>
     <font color=#447700>!        interfaces ESMF_ClockGetCurrent(), ESMF_ImportStateGetCurrent(), <a name='719'></font>
     <font color=#447700>!        ESMF_ExportStateGetCurrent(), and ESMF_GridCompGetCurrent().  <a name='720'></font>
     CALL ESMF_SetCurrent( gcomp=p_gcomp, importState=p_importState, &amp;<a name='721'>
                           exportState=p_exportState, clock=p_clock )<a name='722'>
<a name='723'>
     <font color=#447700>! populate ESMF import and export states<a name='724'></font>
     CALL <A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE'>wrf_state_populate</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_STATE_POPULATE_1">( rc )<a name='725'>
     IF ( rc /= 0 ) THEN<a name='726'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_471"> ( 'wrf_component_init2:  wrf_state_populate failed' )<a name='727'>
     ENDIF<a name='728'>
<a name='729'>
     <font color=#447700>! examine importState<a name='730'></font>
     WRITE (str,*) 'wrf_component_init2: EXAMINING importState...'<a name='731'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_407"> ( 100 , TRIM(str) )<a name='732'>
     CALL ESMF_StateGet( importState, itemCount=itemCount, &amp;<a name='733'>
                         stateintent=stateintent, name=statename, rc=rc )<a name='734'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='735'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_472">("wrf_component_init2:  ESMF_StateGet(importState) failed B" )<a name='736'>
     ENDIF<a name='737'>
     IF ( stateintent /= ESMF_STATEINTENT_IMPORT ) THEN<a name='738'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_473">("wrf_component_init2:  importState is not an import state" )<a name='739'>
     ENDIF<a name='740'>
     WRITE (str,*) 'wrf_component_init2: importState &lt;',TRIM(statename), &amp;<a name='741'>
                   '&gt; itemCount = ', itemCount<a name='742'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_408"> ( 100 , TRIM(str) )<a name='743'>
     ALLOCATE ( itemNames(itemCount), itemTypes(itemCount) )<a name='744'>
     CALL ESMF_StateGet( importState, itemNameList=itemNames, &amp;<a name='745'>
                         itemtypeList=itemTypes, rc=rc )<a name='746'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='747'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_474">("wrf_component_init2:  ESMF_StateGet(importState) failed C" )<a name='748'>
     ENDIF<a name='749'>
     DO i=1, itemCount<a name='750'>
       IF ( itemTypes(i) == ESMF_STATEITEM_FIELD ) THEN<a name='751'>
         WRITE(str,*) 'wrf_component_init2: importState contains field &lt;',TRIM(itemNames(i)),'&gt;'<a name='752'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_409"> ( 100 , TRIM(str) )<a name='753'>
       ENDIF<a name='754'>
     ENDDO<a name='755'>
     DEALLOCATE ( itemNames, itemTypes )<a name='756'>
     WRITE (str,*) 'wrf_component_init2: DONE EXAMINING importState...'<a name='757'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_410"> ( 100 , TRIM(str) )<a name='758'>
<a name='759'>
     <font color=#447700>! examine exportState<a name='760'></font>
     WRITE (str,*) 'wrf_component_init2: EXAMINING exportState...'<a name='761'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_411"> ( 100 , TRIM(str) )<a name='762'>
     CALL ESMF_StateGet( exportState, itemCount=itemCount, &amp;<a name='763'>
                         stateintent=stateintent, name=statename, rc=rc )<a name='764'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='765'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_475">("wrf_component_init2:  ESMF_StateGet(exportState) failed B" )<a name='766'>
     ENDIF<a name='767'>
     IF ( stateintent /= ESMF_STATEINTENT_EXPORT ) THEN<a name='768'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_476">("wrf_component_init2:  exportState is not an export state" )<a name='769'>
     ENDIF<a name='770'>
     WRITE (str,*) 'wrf_component_init2: exportState &lt;',TRIM(statename), &amp;<a name='771'>
                   '&gt; itemCount = ', itemCount<a name='772'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_412"> ( 100 , TRIM(str) )<a name='773'>
     ALLOCATE ( itemNames(itemCount), itemTypes(itemCount) )<a name='774'>
     CALL ESMF_StateGet( exportState, itemNameList=itemNames, &amp;<a name='775'>
                         itemtypeList=itemTypes, rc=rc )<a name='776'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='777'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_477">("wrf_component_init2:  ESMF_StateGet(exportState) failed C" )<a name='778'>
     ENDIF<a name='779'>
     DO i=1, itemCount<a name='780'>
       IF ( itemTypes(i) == ESMF_STATEITEM_FIELD ) THEN<a name='781'>
         WRITE(str,*) 'wrf_component_init2: exportState contains field &lt;',TRIM(itemNames(i)),'&gt;'<a name='782'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_413"> ( 100 , TRIM(str) )<a name='783'>
       ENDIF<a name='784'>
     ENDDO<a name='785'>
     DEALLOCATE ( itemNames, itemTypes )<a name='786'>
     WRITE (str,*) 'wrf_component_init2: DONE EXAMINING exportState...'<a name='787'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_414"> ( 100 , TRIM(str) )<a name='788'>
<a name='789'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_INIT2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_415"> ( 100, 'DEBUG wrf_component_init2():  end' )<a name='790'>
<a name='791'>
   END SUBROUTINE wrf_component_init2<a name='792'>
<a name='793'>
<a name='794'>
<a name='795'>
<A NAME='WRF_COMPONENT_RUN'><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='796'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_component_run</font>( gcomp, importState, exportState, clock, rc ),<A href='../../call_from/WRF_COMPONENT_RUN.html' TARGET='index'>11</A><a name='797'>
     TYPE(ESMF_GridComp), TARGET, INTENT(INOUT) :: gcomp<a name='798'>
     TYPE(ESMF_State),    TARGET, INTENT(INOUT) :: importState, exportState<a name='799'>
     TYPE(ESMF_Clock),    TARGET, INTENT(INOUT) :: clock<a name='800'>
     INTEGER,                     INTENT(  OUT) :: rc<a name='801'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='802'></font>
<font color=#447700>!     WRF component run routine.<a name='803'></font>
<font color=#447700>!<a name='804'></font>
<font color=#447700>!     The arguments are:<a name='805'></font>
<font color=#447700>!       gcomp           Component<a name='806'></font>
<font color=#447700>!       importState     Importstate<a name='807'></font>
<font color=#447700>!       exportState     Exportstate<a name='808'></font>
<font color=#447700>!       clock           External clock<a name='809'></font>
<font color=#447700>!       rc              Return code; equals ESMF_SUCCESS if there are no errors,<a name='810'></font>
<font color=#447700>!                       otherwise ESMF_FAILURE.<a name='811'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='812'></font>
<a name='813'>
     <font color=#447700>! Local variables<a name='814'></font>
     TYPE(ESMF_GridComp), POINTER :: p_gcomp<a name='815'>
     TYPE(ESMF_State),    POINTER :: p_importState<a name='816'>
     TYPE(ESMF_State),    POINTER :: p_exportState<a name='817'>
     TYPE(ESMF_Clock),    POINTER :: p_clock<a name='818'>
     <font color=#447700>! timing<a name='819'></font>
     TYPE(ESMF_Time) :: currentTime, nextTime<a name='820'>
     TYPE(ESMF_TimeInterval) :: runLength     <font color=#447700>! how long to run in this call<a name='821'></font>
     CHARACTER(LEN=256) :: timeStr<a name='822'>
<a name='823'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_416"> ( 100 , 'DEBUG wrf_component_run():  begin' )<a name='824'>
<a name='825'>
     p_gcomp =&gt; gcomp<a name='826'>
     p_importState =&gt; importState<a name='827'>
     p_exportState =&gt; exportState<a name='828'>
     p_clock =&gt; clock<a name='829'>
     <font color=#447700>! NOTE:  It will be possible to remove this call once ESMF supports <a name='830'></font>
     <font color=#447700>!        interfaces ESMF_ClockGetCurrent(), ESMF_ImportStateGetCurrent(), <a name='831'></font>
     <font color=#447700>!        ESMF_ExportStateGetCurrent(), and ESMF_GridCompGetCurrent().  <a name='832'></font>
     CALL ESMF_SetCurrent( gcomp=p_gcomp, importState=p_importState, &amp;<a name='833'>
                           exportState=p_exportState, clock=p_clock )<a name='834'>
<a name='835'>
     <font color=#447700>! connect ESMF clock with WRF domain clock<a name='836'></font>
     CALL ESMF_ClockGet( clock, currTime=currentTime, timeStep=runLength, rc=rc )<a name='837'>
     IF ( rc /= ESMF_SUCCESS ) THEN<a name='838'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_478"> ( 'wrf_component_run:  ESMF_ClockGet failed' )<a name='839'>
     ENDIF<a name='840'>
     CALL <A href='../../html_code/share/module_date_time.F.html#WRF_CLOCKPRINT'>wrf_clockprint</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_CLOCKPRINT_3">(100, clock, &amp;<a name='841'>
            'DEBUG wrf_component_run():  clock,')<a name='842'>
     nextTime = currentTime + runLength<a name='843'>
     head_grid%start_subtime = currentTime<a name='844'>
     head_grid%stop_subtime = nextTime<a name='845'>
     CALL <A href='../../html_code/share/module_date_time.F.html#WRF_TIMETOA'>wrf_timetoa</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_TIMETOA_6"> ( head_grid%start_subtime, timeStr )<a name='846'>
     WRITE (str,*) 'wrf_component_run:  head_grid%start_subtime ',TRIM(timeStr)<a name='847'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_417"> ( 100 , TRIM(str) )<a name='848'>
     CALL <A href='../../html_code/share/module_date_time.F.html#WRF_TIMETOA'>wrf_timetoa</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_TIMETOA_7"> ( head_grid%stop_subtime, timeStr )<a name='849'>
     WRITE (str,*) 'wrf_component_run:  head_grid%stop_subtime ',TRIM(timeStr)<a name='850'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_418"> ( 100 , TRIM(str) )<a name='851'>
<a name='852'>
     <font color=#447700>! Call WRF "run" routine<a name='853'></font>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_419"> ( 100 , 'DEBUG wrf_component_run():  calling wrf_run()' )<a name='854'>
     CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_RUN'>wrf_run</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_RUN_7">( )<a name='855'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_420"> ( 100 , 'DEBUG wrf_component_run():  back from wrf_run()' )<a name='856'>
<a name='857'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_RUN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_421"> ( 100 , 'DEBUG wrf_component_run():  end' )<a name='858'>
<a name='859'>
   END SUBROUTINE wrf_component_run<a name='860'>
<a name='861'>
<a name='862'>
<a name='863'>
<A NAME='WRF_COMPONENT_FINALIZE'><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_FINALIZE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='864'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_component_finalize</font>( gcomp, importState, exportState, clock, rc ),<A href='../../call_from/WRF_COMPONENT_FINALIZE.html' TARGET='index'>1</A><a name='865'>
     TYPE(ESMF_GridComp), TARGET, INTENT(INOUT) :: gcomp<a name='866'>
     TYPE(ESMF_State),    TARGET, INTENT(INOUT) :: importState, exportState<a name='867'>
     TYPE(ESMF_Clock),    TARGET, INTENT(INOUT) :: clock<a name='868'>
     INTEGER,                     INTENT(  OUT) :: rc<a name='869'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='870'></font>
<font color=#447700>!     WRF component finalize routine.<a name='871'></font>
<font color=#447700>!<a name='872'></font>
<font color=#447700>!     The arguments are:<a name='873'></font>
<font color=#447700>!       gcomp           Component<a name='874'></font>
<font color=#447700>!       importState     Importstate<a name='875'></font>
<font color=#447700>!       exportState     Exportstate<a name='876'></font>
<font color=#447700>!       clock           External clock<a name='877'></font>
<font color=#447700>!       rc              Return code; equals ESMF_SUCCESS if there are no errors,<a name='878'></font>
<font color=#447700>!                       otherwise ESMF_FAILURE.<a name='879'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='880'></font>
<a name='881'>
     <font color=#447700>! Local variables<a name='882'></font>
     TYPE(ESMF_GridComp), POINTER :: p_gcomp<a name='883'>
     TYPE(ESMF_State),    POINTER :: p_importState<a name='884'>
     TYPE(ESMF_State),    POINTER :: p_exportState<a name='885'>
     TYPE(ESMF_Clock),    POINTER :: p_clock<a name='886'>
     INTEGER :: rc<a name='887'>
     p_gcomp =&gt; gcomp<a name='888'>
     p_importState =&gt; importState<a name='889'>
     p_exportState =&gt; exportState<a name='890'>
     p_clock =&gt; clock<a name='891'>
     <font color=#447700>! NOTE:  It will be possible to remove this call once ESMF supports <a name='892'></font>
     <font color=#447700>!        interfaces ESMF_ClockGetCurrent(), ESMF_ImportStateGetCurrent(), <a name='893'></font>
     <font color=#447700>!        ESMF_ExportStateGetCurrent(), and ESMF_GridCompGetCurrent().  <a name='894'></font>
     CALL ESMF_SetCurrent( gcomp=p_gcomp, importState=p_importState, &amp;<a name='895'>
                           exportState=p_exportState, clock=p_clock )<a name='896'>
<a name='897'>
     <font color=#447700>! Call WRF "finalize" routine, suppressing call to MPI_FINALIZE so <a name='898'></font>
     <font color=#447700>! ESMF can do it (if needed) during ESMF_Finalize().  <a name='899'></font>
     CALL <A href='../../html_code/main/module_wrf_top.F.html#WRF_FINALIZE'>wrf_finalize</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_COMPONENT_FINALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_FINALIZE_3">( no_shutdown=.TRUE. )<a name='900'>
<a name='901'>
     rc = ESMF_SUCCESS<a name='902'>
<a name='903'>
   END SUBROUTINE wrf_component_finalize<a name='904'>
<a name='905'>
<a name='906'>
<a name='907'>
<A NAME='WRF_FINDCOUPLINGINTERVAL'><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_FINDCOUPLINGINTERVAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='908'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_findCouplingInterval</font>( startTime, stopTime, couplingInterval ) <A href='../../call_to/WRF_FINDCOUPLINGINTERVAL.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_FINDCOUPLINGINTERVAL.html' TARGET='index'>5</A><a name='909'>
     TYPE(ESMF_Time),         INTENT(IN   ) :: startTime<a name='910'>
     TYPE(ESMF_Time),         INTENT(IN   ) :: stopTime<a name='911'>
     TYPE(ESMF_TimeInterval), INTENT(  OUT) :: couplingInterval<a name='912'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='913'></font>
<font color=#447700>!     WRF convenience routine for deducing coupling interval.  The startTime <a name='914'></font>
<font color=#447700>!     and stopTime arguments are only used for determining a default value <a name='915'></font>
<font color=#447700>!     when coupling is not actually being done.  <a name='916'></font>
<font color=#447700>!<a name='917'></font>
<font color=#447700>!     The arguments are:<a name='918'></font>
<font color=#447700>!       startTime          start time<a name='919'></font>
<font color=#447700>!       stopTime           stop time<a name='920'></font>
<font color=#447700>!       couplingInterval   coupling interval<a name='921'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='922'></font>
     <font color=#447700>! locals<a name='923'></font>
     LOGICAL :: foundcoupling<a name='924'>
     INTEGER :: rc<a name='925'>
     INTEGER :: io_form<a name='926'>
     <font color=#447700>! external function prototype<a name='927'></font>
     INTEGER, EXTERNAL :: use_package<a name='928'>
<a name='929'>
     <font color=#447700>! deduce coupling time-step<a name='930'></font>
     foundcoupling = .FALSE.<a name='931'>
<font color=#447700>!TODO:  This bit just finds the FIRST case and extracts coupling interval...  <a name='932'></font>
<font color=#447700>!TODO:  Add error-checking for over-specification.  <a name='933'></font>
<font color=#447700>!TODO:  Add support for multiple coupling intervals later...  <a name='934'></font>
<font color=#447700>!TODO:  Add support for coupling that does not begin immediately later...  <a name='935'></font>
<font color=#447700>!TODO:  Get rid of duplication once I/O refactoring is finished (and <a name='936'></font>
<font color=#447700>!TODO:  auxio streams can be addressed via index).  <a name='937'></font>
<a name='938'>
#include "<A href='../../html_code/include/med_find_esmf_coupling.inc.html'>med_find_esmf_coupling.inc</A>"<A NAME="med_find_esmf_coupling.inc_1"><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_FINDCOUPLINGINTERVAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='939'>
<a name='940'>
     <font color=#447700>! look for erroneous use of io_form...  <a name='941'></font>
     CALL nl_get_io_form_restart( 1, io_form )<a name='942'>
     IF ( use_package( io_form ) == IO_ESMF ) THEN<a name='943'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_FINDCOUPLINGINTERVAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_479"> ( 'wrf_findCouplingInterval:  ERROR:  ESMF cannot be used for WRF restart I/O' )<a name='944'>
     ENDIF<a name='945'>
     CALL nl_get_io_form_input( 1, io_form )<a name='946'>
     IF ( use_package( io_form ) == IO_ESMF ) THEN<a name='947'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_FINDCOUPLINGINTERVAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_480"> ( 'wrf_findCouplingInterval:  ERROR:  ESMF cannot be used for WRF input' )<a name='948'>
     ENDIF<a name='949'>
     CALL nl_get_io_form_history( 1, io_form )<a name='950'>
     IF ( use_package( io_form ) == IO_ESMF ) THEN<a name='951'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_FINDCOUPLINGINTERVAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_481"> ( 'wrf_findCouplingInterval:  ERROR:  ESMF cannot be used for WRF history output' )<a name='952'>
     ENDIF<a name='953'>
     CALL nl_get_io_form_boundary( 1, io_form )<a name='954'>
     IF ( use_package( io_form ) == IO_ESMF ) THEN<a name='955'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_FINDCOUPLINGINTERVAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_482"> ( 'wrf_findCouplingInterval:  ERROR:  ESMF cannot be used for WRF boundary I/O' )<a name='956'>
     ENDIF<a name='957'>
<a name='958'>
     <font color=#447700>! If nobody uses IO_ESMF, then default is to run WRF all the way to <a name='959'></font>
     <font color=#447700>! the end.  <a name='960'></font>
     IF ( .NOT. foundcoupling ) THEN<a name='961'>
       couplingInterval = stopTime - startTime<a name='962'>
       call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_FINDCOUPLINGINTERVAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_422"> ( 1, 'WARNING:  ESMF coupling not used in this WRF run' )<a name='963'>
     ENDIF<a name='964'>
<a name='965'>
   END SUBROUTINE wrf_findCouplingInterval<a name='966'>
<a name='967'>
<a name='968'>
<a name='969'>
<A NAME='WRF_GETDECOMPINFO'><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_GETDECOMPINFO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='970'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_getDecompInfo</font>( ids, ide, jds, jde, kds, kde, &amp; <A href='../../call_to/WRF_GETDECOMPINFO.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_GETDECOMPINFO.html' TARGET='index'>1</A><a name='971'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='972'>
                                 ips, ipe, jps, jpe, kps, kpe, &amp;<a name='973'>
                                 domdesc, bdy_mask )<a name='974'>
     INTEGER, INTENT(OUT) :: ids, ide, jds, jde, kds, kde<a name='975'>
     INTEGER, INTENT(OUT) :: ims, ime, jms, jme, kms, kme<a name='976'>
     INTEGER, INTENT(OUT) :: ips, ipe, jps, jpe, kps, kpe<a name='977'>
     INTEGER, INTENT(OUT) :: domdesc<a name='978'>
     LOGICAL, INTENT(OUT) :: bdy_mask(4)<a name='979'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='980'></font>
<font color=#447700>!     WRF convenience routine for deducing decomposition information.  <a name='981'></font>
<font color=#447700>!TODO:  Note that domdesc is meaningful only for SPMD alternating event loops.  <a name='982'></font>
<font color=#447700>!TODO:  For concurrent operation (SPMD or MPMD), we will need to create a new <a name='983'></font>
<font color=#447700>!TODO:  "domdesc" suitable for the task layout of the SST component.  For <a name='984'></font>
<font color=#447700>!TODO:  MPMD alternating event loops, we will need to serialize domdesc and <a name='985'></font>
<font color=#447700>!TODO:  store it as metadata within the export state.  Similar arguments apply<a name='986'></font>
<font color=#447700>!TODO:  to [ij][mp][se] and bdy_mask.<a name='987'></font>
<font color=#447700>!<a name='988'></font>
<font color=#447700>!     The arguments are:<a name='989'></font>
<font color=#447700>!       ids, ide, jds, jde, kds, kde    Domain extent.  <a name='990'></font>
<font color=#447700>!       ims, ime, jms, jme, kms, kme    Memory extent.  <a name='991'></font>
<font color=#447700>!       ips, ipe, jps, jpe, kps, kpe    Patch extent.  <a name='992'></font>
<font color=#447700>!       domdesc                         Domain descriptor for external <a name='993'></font>
<font color=#447700>!                                       distributed-memory communication <a name='994'></font>
<font color=#447700>!                                       package (opaque to WRF).  <a name='995'></font>
<font color=#447700>!       bdy_mask                        Boundary mask flags indicating which <a name='996'></font>
<font color=#447700>!                                       domain boundaries are on this task.  <a name='997'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='998'></font>
     <font color=#447700>! extract decomposition information from head_grid<a name='999'></font>
     CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_GETDECOMPINFO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_98">( head_grid ,                   &amp;<a name='1000'>
                             ids, ide, jds, jde, kds, kde, &amp;<a name='1001'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='1002'>
                             ips, ipe, jps, jpe, kps, kpe  )<a name='1003'>
#if 0<a name='1004'>
<font color=#447700>! JM<a name='1005'></font>
<font color=#447700>! with version 3 of ESMF's staggering concepts, WRF's non-staggered grid is equivalent to <a name='1006'></font>
<font color=#447700>! esmf's 'exclusive' region -- that is the set of points that are owned by the 'DE' (eyeroll)<a name='1007'></font>
<font color=#447700>! WRF, on the other hand, is returning the 'staggered' dimensions here.  So convert to the<a name='1008'></font>
<font color=#447700>! unstaggered dims before returning.<a name='1009'></font>
<font color=#447700>! Don't bother with vertical dimension for the time being, since we're only doing 2D coupling.<a name='1010'></font>
<font color=#447700>!<a name='1011'></font>
     ide = ide-1 ; ipe = MIN(ide,ipe)<a name='1012'>
     jde = jde-1 ; jpe = MIN(jde,jpe)<a name='1013'>
#else<a name='1014'>
<font color=#447700>! JM<a name='1015'></font>
<font color=#447700>! with version 4 I have no damned clue at this writing... just random shots for now<a name='1016'></font>
<font color=#447700>! see if this works.<a name='1017'></font>
     ipe = MIN(ide-1,ipe)<a name='1018'>
     jpe = MIN(jde-1,jpe)<a name='1019'>
#endif<a name='1020'>
<a name='1021'>
     domdesc = head_grid%domdesc<a name='1022'>
     bdy_mask = head_grid%bdy_mask<a name='1023'>
   END SUBROUTINE wrf_getDecompInfo<a name='1024'>
<a name='1025'>
<a name='1026'>
<A NAME='WRF_STATE_POPULATE'><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1027'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_state_populate</font>( ierr ) <A href='../../call_to/WRF_STATE_POPULATE.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_STATE_POPULATE.html' TARGET='index'>7</A><a name='1028'>
     <font color=#447700>! Driver layer<a name='1029'></font>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_220">, ONLY : domain<a name='1030'>
     USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_21"><a name='1031'>
     <font color=#447700>! Model layer<a name='1032'></font>
     USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_143">, ONLY : grid_config_rec_type, model_to_grid_config_rec<a name='1033'>
     USE <A href='../../html_code/share/module_bc_time_utilities.F.html#MODULE_BC_TIME_UTILITIES'>module_bc_time_utilities</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_TIME_UTILITIES_5"><a name='1034'>
<a name='1035'>
     IMPLICIT NONE<a name='1036'>
<a name='1037'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1038'></font>
<font color=#447700>!     Populate WRF import and export states from Registry-generated code.  <a name='1039'></font>
<font color=#447700>!     For now, only head_grid can be coupled.  <a name='1040'></font>
<font color=#447700>!<a name='1041'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1042'></font>
<font color=#447700>!TODO:  Extend later to include child <a name='1043'></font>
<font color=#447700>!TODO:  domains, possibly via nested ESMF_State's.  <a name='1044'></font>
<a name='1045'>
     <font color=#447700>! Arguments<a name='1046'></font>
     INTEGER, INTENT(OUT)       :: ierr<a name='1047'>
     <font color=#447700>! Local<a name='1048'></font>
     TYPE(domain), POINTER      :: grid<a name='1049'>
     TYPE(grid_config_rec_type) :: config_flags<a name='1050'>
     INTEGER                    :: stream, idum1, idum2, io_form<a name='1051'>
     CHARACTER*80               :: fname, n2<a name='1052'>
     <font color=#447700>! external function prototype<a name='1053'></font>
     INTEGER, EXTERNAL          :: use_package<a name='1054'>
<a name='1055'>
     <font color=#447700>! for now support coupling to head_grid only<a name='1056'></font>
     grid =&gt; head_grid<a name='1057'>
<font color=#447700>! TODO:  Use actual grid via current_grid%id via something like this...  <a name='1058'></font>
<font color=#447700>!  IF ( current_grid_set ) THEN<a name='1059'></font>
<font color=#447700>!    grid =&gt; current_grid<a name='1060'></font>
<font color=#447700>!  ELSE<a name='1061'></font>
<font color=#447700>!    ERROR<a name='1062'></font>
<font color=#447700>!  ENDIF<a name='1063'></font>
<a name='1064'>
     CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_47"> ( grid%id , model_config_rec , config_flags )<a name='1065'>
     CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_19"> ( grid%id , idum1 , idum2 )<a name='1066'>
<a name='1067'>
     stream = 0 <a name='1068'>
     ierr = 0<a name='1069'>
<a name='1070'>
#include "<A href='../../html_code/include/med_open_esmf_calls.inc.html'>med_open_esmf_calls.inc</A>"<A NAME="med_open_esmf_calls.inc_2"><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1071'>
<a name='1072'>
   END SUBROUTINE wrf_state_populate<a name='1073'>
<a name='1074'>
END MODULE module_wrf_component_top<a name='1075'>
<a name='1076'>
<a name='1077'>
<a name='1078'>
<A NAME='MODULE_WRF_SETSERVICES'><A href='../../html_code/main/wrf_ESMFMod.F.html#MODULE_WRF_SETSERVICES' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='1079'>
<font color=#993300>MODULE </font><font color=#cc0000>module_wrf_setservices</font> <A href='../../call_to/MODULE_WRF_SETSERVICES.html' TARGET='index'>1</A><a name='1080'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1081'></font>
<font color=#447700>! This module defines WRF "Set Services" method wrf_register() <a name='1082'></font>
<font color=#447700>! used for ESMF coupling.  <a name='1083'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1084'></font>
<a name='1085'>
   USE <A href='../../html_code/main/wrf_ESMFMod.F.html#MODULE_WRF_COMPONENT_TOP'>module_wrf_component_top</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_STATE_POPULATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_COMPONENT_TOP_1">, ONLY: wrf_component_init1, &amp;<a name='1086'>
                                       wrf_component_init2, &amp;<a name='1087'>
                                       wrf_component_run,   &amp;<a name='1088'>
                                       wrf_component_finalize<a name='1089'>
   USE ESMF<a name='1090'>
<a name='1091'>
   IMPLICIT NONE<a name='1092'>
<a name='1093'>
   <font color=#447700>! everything is private by default<a name='1094'></font>
   PRIVATE<a name='1095'>
<a name='1096'>
   <font color=#447700>! Public entry point for ESMF_GridCompSetServices()<a name='1097'></font>
   PUBLIC WRF_register<a name='1098'>
<a name='1099'>
   <font color=#447700>! private stuff<a name='1100'></font>
   CHARACTER (ESMF_MAXSTR) :: str<a name='1101'>
<a name='1102'>
CONTAINS<a name='1103'>
<a name='1104'>
<a name='1105'>
<A NAME='WRF_REGISTER'><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_REGISTER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1106'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_register</font>(gcomp, rc),<A href='../../call_from/WRF_REGISTER.html' TARGET='index'>4</A><a name='1107'>
     TYPE(ESMF_GridComp), INTENT(INOUT) :: gcomp<a name='1108'>
     INTEGER, INTENT(OUT) :: rc<a name='1109'>
<font color=#447700>!<a name='1110'></font>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1111'></font>
<font color=#447700>!     WRF_register - Externally visible registration routine<a name='1112'></font>
<font color=#447700>!<a name='1113'></font>
<font color=#447700>!     User-supplied SetServices routine.<a name='1114'></font>
<font color=#447700>!     The Register routine sets the subroutines to be called<a name='1115'></font>
<font color=#447700>!     as the init, run, and finalize routines.  Note that these are<a name='1116'></font>
<font color=#447700>!     private to the module.<a name='1117'></font>
<font color=#447700>!<a name='1118'></font>
<font color=#447700>!     The arguments are:<a name='1119'></font>
<font color=#447700>!       gcomp           Component<a name='1120'></font>
<font color=#447700>!       rc              Return code; equals ESMF_SUCCESS if there are no errors,<a name='1121'></font>
<font color=#447700>!                       otherwise ESMF_FAILURE.<a name='1122'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1123'></font>
<a name='1124'>
     rc = ESMF_SUCCESS<a name='1125'>
     <font color=#447700>! Register the callback routines.<a name='1126'></font>
     call ESMF_GridCompSetEntryPoint(gcomp, ESMF_METHOD_INITIALIZE, &amp;<a name='1127'>
                                     wrf_component_init1, phase=1, rc=rc)<a name='1128'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='1129'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_REGISTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_483"> ( 'wrf_register:  ESMF_GridCompSetEntryPoint(wrf_component_init1) failed' )<a name='1130'>
     ENDIF<a name='1131'>
     call ESMF_GridCompSetEntryPoint(gcomp, ESMF_METHOD_INITIALIZE, &amp;<a name='1132'>
                                     wrf_component_init2, phase=2, rc=rc)<a name='1133'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='1134'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_REGISTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_484"> ( 'wrf_register:  ESMF_GridCompSetEntryPoint(wrf_component_init2) failed' )<a name='1135'>
     ENDIF<a name='1136'>
     call ESMF_GridCompSetEntryPoint(gcomp, ESMF_METHOD_RUN, &amp;<a name='1137'>
                                     wrf_component_run,  rc=rc)<a name='1138'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='1139'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_REGISTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_485"> ( 'wrf_register:  ESMF_GridCompSetEntryPoint(wrf_component_run) failed' )<a name='1140'>
     ENDIF<a name='1141'>
     call ESMF_GridCompSetEntryPoint(gcomp, ESMF_METHOD_FINALIZE, &amp;<a name='1142'>
                                     wrf_component_finalize,  rc=rc)<a name='1143'>
     IF ( rc /= ESMF_SUCCESS) THEN<a name='1144'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/wrf_ESMFMod.F.html#WRF_REGISTER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_486"> ( 'wrf_register:  ESMF_GridCompSetEntryPoint(wrf_component_finalize) failed' )<a name='1145'>
     ENDIF<a name='1146'>
     PRINT *,'WRF:  Registered Initialize, Run, and Finalize routines'<a name='1147'>
<a name='1148'>
   END SUBROUTINE wrf_register<a name='1149'>
<a name='1150'>
END MODULE module_wrf_setservices<a name='1151'>
<a name='1152'>
</pre></body></html>