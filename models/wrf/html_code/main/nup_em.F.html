<HTML> <BODY BGCOLOR=#eeeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:MAIN<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<font color=#447700>! "Nest up" program in WRFV2.<a name='5'></font>
<font color=#447700>! <a name='6'></font>
<font color=#447700>! Description:<a name='7'></font>
<font color=#447700>! <a name='8'></font>
<font color=#447700>! The nest up (nup.exe) program reads from wrfout_d02_&lt;date&gt; files for<a name='9'></font>
<font color=#447700>! the nest and generates wrfout_d01_&lt;date&gt; files for the same periods as<a name='10'></font>
<font color=#447700>! are in the input files.  The fields in the output are the fields in the<a name='11'></font>
<font color=#447700>! input for state variables that have 'h' and 'u' in the I/O string of<a name='12'></font>
<font color=#447700>! the Registry.  In other words, these are the fields that are normally<a name='13'></font>
<font color=#447700>! fed back from nest-&gt;parent during 2-way nesting.  It will read and<a name='14'></font>
<font color=#447700>! output over multiple files of nest data and generate an equivalent<a name='15'></font>
<font color=#447700>! number of files of parent data.  The dimensions of the fields in the<a name='16'></font>
<font color=#447700>! output are the size of the nest fields divided by the nesting ratio.<a name='17'></font>
<font color=#447700>! <a name='18'></font>
<font color=#447700>! Source file:   main/nup_em.F<a name='19'></font>
<font color=#447700>! <a name='20'></font>
<font color=#447700>! Compile with WRF: compile em_real<a name='21'></font>
<font color=#447700>! <a name='22'></font>
<font color=#447700>! Resulting executable:  <a name='23'></font>
<font color=#447700>! <a name='24'></font>
<font color=#447700>!     main/nup.exe <a name='25'></font>
<font color=#447700>!      -and-<a name='26'></font>
<font color=#447700>!     symbolic link in test/em_real/nup.exe<a name='27'></font>
<font color=#447700>! <a name='28'></font>
<font color=#447700>! Run as:  nup.exe (no arguments)<a name='29'></font>
<font color=#447700>! <a name='30'></font>
<font color=#447700>! Namelist information:<a name='31'></font>
<font color=#447700>! <a name='32'></font>
<font color=#447700>! Nup.exe uses the same namelist as a nested run of the wrf.exe.<a name='33'></font>
<font color=#447700>! Important settings are:<a name='34'></font>
<font color=#447700>! <a name='35'></font>
<font color=#447700>!  &amp;time_control<a name='36'></font>
<font color=#447700>! <a name='37'></font>
<font color=#447700>!    start_*            &lt;start time information for both domains&gt;<a name='38'></font>
<font color=#447700>!    end_*              &lt;start time information for both domains&gt;<a name='39'></font>
<font color=#447700>!    history_interval   &lt;interval between frames in input/output files&gt;<a name='40'></font>
<font color=#447700>!    frames_per_outfile &lt;number of frames in input/output files&gt;<a name='41'></font>
<font color=#447700>!    io_form_history    &lt;2 for NetCDF&gt;<a name='42'></font>
<font color=#447700>! <a name='43'></font>
<font color=#447700>!  &amp;domains<a name='44'></font>
<font color=#447700>!     ...<a name='45'></font>
<font color=#447700>!    max_dom            &lt;number of domains; must be 2&gt;<a name='46'></font>
<font color=#447700>!    e_we               &lt;col 2 is size of nested grid in west-east&gt;<a name='47'></font>
<font color=#447700>!                       &lt;col 1 is ignored in the namelist&gt;<a name='48'></font>
<font color=#447700>!    e_sn               &lt;col 2 is size of nested grid in south-north&gt;<a name='49'></font>
<font color=#447700>!                       &lt;col 1 is ignored in the namelist&gt;<a name='50'></font>
<font color=#447700>!    parent_grid_ratio  &lt;col 2 is nesting ratio in both dims&gt;<a name='51'></font>
<font color=#447700>!    feedback           &lt;must be 1&gt;<a name='52'></font>
<font color=#447700>!    smooth_option      &lt;recommend 0&gt;<a name='53'></font>
<font color=#447700>! <a name='54'></font>
<font color=#447700>!  &amp;physics<a name='55'></font>
<font color=#447700>!             &lt;all options in this section should be the same<a name='56'></font>
<font color=#447700>!              as the run that generated the nest data&gt;<a name='57'></font>
<font color=#447700>! <a name='58'></font>
<font color=#447700>!  created: JM 2006 01 25 <a name='59'></font>
<a name='60'>
<A NAME='NUP_EM'><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='top_target'><IMG SRC="../../gif/bar_yellow.gif" border=0></A><a name='61'>
<font color=#993300>PROGRAM </font><font color=#cc0000>nup_em</font>,<A href='../../call_from/NUP_EM.html' TARGET='index'>67</A><a name='62'>
<a name='63'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_18"><a name='64'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_194">, ONLY : domain, wrfu_timeinterval, alloc_and_configure_domain, &amp;<a name='65'>
      domain_clock_set, domain_get_current_time, domain_get_stop_time, head_grid, &amp;<a name='66'>
      domain_clock_get, domain_clockadvance<a name='67'>
   USE <A href='../../html_code/frame/module_domain_type.F.html#MODULE_DOMAIN_TYPE'>module_domain_type</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_TYPE_9">, ONLY : program_name<a name='68'>
   USE <A href='../../html_code/frame/module_streams.F.html#MODULE_STREAMS'>module_streams</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STREAMS_3"><a name='69'>
   USE module_initialize_real, only : wrfu_initialize<a name='70'>
   USE <A href='../../html_code/frame/module_integrate.F.html#MODULE_INTEGRATE'>module_integrate</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTEGRATE_3"><a name='71'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_50"><a name='72'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_129">, only : grid_config_rec_type, model_config_rec<a name='73'>
   USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_10"><a name='74'>
   USE module_utility<a name='75'>
<a name='76'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_37"><a name='77'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_40"><a name='78'>
#ifdef DM_PARALLEL<a name='79'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_138"><a name='80'>
#endif<a name='81'>
<font color=#447700>!  USE read_util_module<a name='82'></font>
<a name='83'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='84'></font>
<font color=#447700>!new for bc<a name='85'></font>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_14"><a name='86'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_6"><a name='87'>
   USE <A href='../../html_code/share/module_get_file_names.F.html#MODULE_GET_FILE_NAMES'>module_get_file_names</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_GET_FILE_NAMES_2"><a name='88'>
#if ( WRF_CHEM == 1 )<a name='89'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='90'></font>
<font color=#447700>! for chemistry<a name='91'></font>
   USE module_input_chem_data<a name='92'>
<font color=#447700>!  USE module_input_chem_bioemiss<a name='93'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='94'></font>
#endif<a name='95'>
<a name='96'>
   IMPLICIT NONE<a name='97'>
 <font color=#447700>! interface<a name='98'></font>
   INTERFACE<a name='99'>
     <font color=#447700>! mediation-supplied<a name='100'></font>
     SUBROUTINE med_read_wrf_chem_bioemiss ( grid , config_flags)<a name='101'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_195"><a name='102'>
       TYPE (domain) grid<a name='103'>
       TYPE (grid_config_rec_type) config_flags<a name='104'>
     END SUBROUTINE med_read_wrf_chem_bioemiss<a name='105'>
     SUBROUTINE nup ( parent_grid , nested_grid, in_id, out_id, newly_opened )<a name='106'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_196"><a name='107'>
       TYPE (domain), POINTER :: parent_grid, nested_grid<a name='108'>
       INTEGER, INTENT(IN) :: in_id, out_id    <font color=#447700>! io units<a name='109'></font>
       LOGICAL, INTENT(IN) :: newly_opened     <font color=#447700>! whether to add global metadata<a name='110'></font>
     END SUBROUTINE nup<a name='111'>
<a name='112'>
   END INTERFACE<a name='113'>
<a name='114'>
   TYPE(WRFU_TimeInterval) :: RingInterval<a name='115'>
<a name='116'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='117'></font>
<font color=#447700>!new for bc<a name='118'></font>
   INTEGER :: ids , ide , jds , jde , kds , kde<a name='119'>
   INTEGER :: ims , ime , jms , jme , kms , kme<a name='120'>
   INTEGER :: ips , ipe , jps , jpe , kps , kpe<a name='121'>
   INTEGER :: its , ite , jts , jte , kts , kte<a name='122'>
   INTEGER :: ijds , ijde , spec_bdy_width<a name='123'>
   INTEGER :: i , j , k<a name='124'>
   INTEGER :: time_loop_max , time_loop<a name='125'>
   INTEGER :: total_time_sec , file_counter<a name='126'>
   INTEGER :: julyr , julday , iswater , map_proj<a name='127'>
   INTEGER :: icnt<a name='128'>
<a name='129'>
   REAL    :: dt , new_bdy_frq<a name='130'>
   REAL    :: gmt , cen_lat , cen_lon , dx , dy , truelat1 , truelat2 , moad_cen_lat , stand_lon<a name='131'>
<a name='132'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: ubdy3dtemp1 , vbdy3dtemp1 , tbdy3dtemp1 , pbdy3dtemp1 , qbdy3dtemp1<a name='133'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: mbdy2dtemp1<a name='134'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: ubdy3dtemp2 , vbdy3dtemp2 , tbdy3dtemp2 , pbdy3dtemp2 , qbdy3dtemp2<a name='135'>
   REAL , DIMENSION(:,:,:) , ALLOCATABLE :: mbdy2dtemp2<a name='136'>
<a name='137'>
   CHARACTER(LEN=19) :: start_timestr , current_timestr , end_timestr, timestr<a name='138'>
   CHARACTER(LEN=19) :: stopTimeStr<a name='139'>
<a name='140'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='141'></font>
<a name='142'>
   INTEGER :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='143'>
<a name='144'>
   REAL    :: time<a name='145'>
   INTEGER :: rc<a name='146'>
<a name='147'>
   INTEGER :: loop , levels_to_process<a name='148'>
   INTEGER , PARAMETER :: max_sanity_file_loop = 100<a name='149'>
<a name='150'>
   TYPE (domain) , POINTER :: keep_grid, grid_ptr, null_domain, parent_grid , nested_grid<a name='151'>
   TYPE (domain)           :: dummy<a name='152'>
   TYPE (grid_config_rec_type)              :: config_flags<a name='153'>
   INTEGER                 :: number_at_same_level<a name='154'>
   INTEGER                 :: time_step_begin_restart<a name='155'>
<a name='156'>
   INTEGER :: max_dom , domain_id , fid , fido, fidb , idum1 , idum2 , ierr<a name='157'>
   INTEGER :: status_next_var<a name='158'>
   INTEGER :: debug_level<a name='159'>
   LOGICAL :: newly_opened<a name='160'>
   CHARACTER (LEN=19) :: date_string<a name='161'>
<a name='162'>
#ifdef DM_PARALLEL<a name='163'>
   INTEGER                 :: nbytes<a name='164'>
   INTEGER, PARAMETER      :: configbuflen = 4* CONFIG_BUF_LEN<a name='165'>
   INTEGER                 :: configbuf( configbuflen )<a name='166'>
   LOGICAL , EXTERNAL      :: wrf_dm_on_monitor<a name='167'>
#endif<a name='168'>
<a name='169'>
   INTEGER                 :: idsi, in_id, out_id<a name='170'>
   INTEGER                 :: e_sn, e_we, pgr<a name='171'>
   CHARACTER (LEN=80)      :: inpname , outname , bdyname<a name='172'>
   CHARACTER (LEN=80)      :: si_inpname<a name='173'>
   CHARACTER *19 :: temp19<a name='174'>
   CHARACTER *24 :: temp24 , temp24b<a name='175'>
   CHARACTER *256 :: fname<a name='176'>
   CHARACTER(len=24) :: start_date_hold<a name='177'>
<a name='178'>
   CHARACTER (LEN=80)      :: message<a name='179'>
integer :: ii<a name='180'>
<a name='181'>
#include "<A href='../../html_code/include/version_decl.html'>version_decl</A>"<A NAME="version_decl_1"><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='182'>
<a name='183'>
   <font color=#447700>!  Interface block for routine that passes pointers and needs to know that they<a name='184'></font>
   <font color=#447700>!  are receiving pointers.<a name='185'></font>
<a name='186'>
   INTERFACE<a name='187'>
<a name='188'>
      SUBROUTINE med_feedback_domain ( parent_grid , nested_grid )<a name='189'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_197"><a name='190'>
         USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_130"><a name='191'>
         TYPE(domain), POINTER :: parent_grid , nested_grid<a name='192'>
      END SUBROUTINE med_feedback_domain<a name='193'>
<a name='194'>
      SUBROUTINE Setup_Timekeeping( parent_grid )<a name='195'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_198"><a name='196'>
         TYPE(domain), POINTER :: parent_grid<a name='197'>
      END SUBROUTINE Setup_Timekeeping<a name='198'>
<a name='199'>
   END INTERFACE<a name='200'>
<a name='201'>
   <font color=#447700>!  Define the name of this program (program_name defined in module_domain)<a name='202'></font>
<a name='203'>
   program_name = "NUP_EM " // TRIM(release_version) // " PREPROCESSOR"<a name='204'>
<a name='205'>
#ifdef DM_PARALLEL<a name='206'>
   CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING'>disable_quilting</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DISABLE_QUILTING_4"><a name='207'>
#endif<a name='208'>
<a name='209'>
   <font color=#447700>!  Initialize the modules used by the WRF system.  Many of the CALLs made from the<a name='210'></font>
   <font color=#447700>!  init_modules routine are NO-OPs.  Typical initializations are: the size of a <a name='211'></font>
   <font color=#447700>!  REAL, setting the file handles to a pre-use value, defining moisture and <a name='212'></font>
   <font color=#447700>!  chemistry indices, etc.<a name='213'></font>
<a name='214'>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_11">(1)   <font color=#447700>! Phase 1 returns after MPI_INIT() (if it is called)<a name='215'></font>
#ifdef NO_LEAP_CALENDAR<a name='216'>
   CALL WRFU_Initialize( defaultCalKind=WRFU_CAL_NOLEAP, rc=rc )<a name='217'>
#else<a name='218'>
   CALL WRFU_Initialize( defaultCalKind=WRFU_CAL_GREGORIAN, rc=rc )<a name='219'>
#endif<a name='220'>
   CALL <A href='../../html_code/share/init_modules.F.html#INIT_MODULES'>init_modules</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULES_12">(2)   <font color=#447700>! Phase 2 resumes after MPI_INIT() (if it is called)<a name='221'></font>
<a name='222'>
   <font color=#447700>!  Get the NAMELIST data.  This is handled in the initial_config routine.  All of the<a name='223'></font>
   <font color=#447700>!  NAMELIST input variables are assigned to the model_config_rec structure.  Below,<a name='224'></font>
   <font color=#447700>!  note for parallel processing, only the monitor processor handles the raw Fortran<a name='225'></font>
   <font color=#447700>!  I/O, and then broadcasts the info to each of the other nodes.<a name='226'></font>
<a name='227'>
#ifdef DM_PARALLEL<a name='228'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='229'>
     CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_11"><a name='230'>
   ENDIF<a name='231'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_11">( configbuf, configbuflen, nbytes )<a name='232'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_114">( configbuf, nbytes )<a name='233'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_11">( configbuf, configbuflen )<a name='234'>
   CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_INITIALIZE'>wrf_dm_initialize</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_INITIALIZE_6"><a name='235'>
#else<a name='236'>
   CALL <A href='../../html_code/frame/module_configure.F.html#INITIAL_CONFIG'>initial_config</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIAL_CONFIG_12"><a name='237'>
#endif<a name='238'>
<a name='239'>
   <font color=#447700>!  And here is an instance of using the information in the NAMELIST.  <a name='240'></font>
<a name='241'>
   CALL nl_get_debug_level ( 1, debug_level )<a name='242'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#SET_WRF_DEBUG_LEVEL'>set_wrf_debug_level</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_WRF_DEBUG_LEVEL_8"> ( debug_level )<a name='243'>
<a name='244'>
   <font color=#447700>! set the specified boundary to zero so the feedback goes all the way<a name='245'></font>
   <font color=#447700>! to the edge of the coarse domain<a name='246'></font>
   CALL nl_set_spec_zone( 1, 0 )<a name='247'>
<a name='248'>
   <font color=#447700>!  Allocated and configure the mother domain.  Since we are in the nesting down<a name='249'></font>
   <font color=#447700>!  mode, we know a) we got a nest, and b) we only got 1 nest.<a name='250'></font>
<a name='251'>
   NULLIFY( null_domain )<a name='252'>
<a name='253'>
<font color=#447700>!!!! set up the parent grid  (for nup_em, this is the grid we do output from)<a name='254'></font>
<a name='255'>
   CALL       nl_set_shw( 1, 0 )<a name='256'>
   CALL       nl_set_shw( 2, 0 )<a name='257'>
   CALL       nl_set_i_parent_start( 2, 1 )<a name='258'>
   CALL       nl_set_j_parent_start( 2, 1 )<a name='259'>
   CALL       nl_get_e_we( 2, e_we )<a name='260'>
   CALL       nl_get_e_sn( 2, e_sn )<a name='261'>
   CALL       nl_get_parent_grid_ratio( 2, pgr )<a name='262'>
<a name='263'>
   <font color=#447700>! parent grid must cover the entire nest, which is always dimensioned a factor of 3 + 1<a name='264'></font>
   <font color=#447700>! so add two here temporarily, then remove later after nest is allocated. <a name='265'></font>
<a name='266'>
   e_we = e_we / pgr + 2<a name='267'>
   e_sn = e_sn / pgr + 2 <a name='268'>
   CALL       nl_set_e_we( 1, e_we )<a name='269'>
   CALL       nl_set_e_sn( 1, e_sn )<a name='270'>
<a name='271'>
   CALL       <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_461"> ( program_name )<a name='272'>
   CALL       wrf_debug ( 100 , 'nup_em: calling alloc_and_configure_domain coarse ' )<a name='273'>
   CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_9"> ( domain_id  = 1 ,                  &amp;<a name='274'>
                                     grid       = head_grid ,          &amp;<a name='275'>
                                     parent     = null_domain ,        &amp;<a name='276'>
                                     kid        = -1                   )<a name='277'>
<a name='278'>
   parent_grid =&gt; head_grid<a name='279'>
<a name='280'>
   <font color=#447700>!  Set up time initializations.<a name='281'></font>
<a name='282'>
   CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_8"> ( parent_grid )<a name='283'>
<a name='284'>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_17">( head_grid, &amp;<a name='285'>
                          time_step_seconds=model_config_rec%interval_seconds )<a name='286'>
<a name='287'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_29"> ( parent_grid%id , model_config_rec , config_flags )<a name='288'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_14"> ( parent_grid%id , idum1, idum2 )<a name='289'>
<a name='290'>
<font color=#447700>!!!! set up the fine grid  (for nup_em, this is the grid we do input into)<a name='291'></font>
<a name='292'>
   CALL       <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_462"> ( program_name )<a name='293'>
   CALL       wrf_debug ( 100 , 'wrf: calling alloc_and_configure_domain fine ' )<a name='294'>
   CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_10"> ( domain_id  = 2 ,                  &amp;<a name='295'>
                                     grid       = nested_grid ,        &amp;<a name='296'>
                                     parent     = parent_grid ,        &amp;<a name='297'>
                                     kid        = 1                   )<a name='298'>
<a name='299'>
<font color=#447700>! now that the nest is allocated, pinch off the extra two rows/columns of the parent<a name='300'></font>
<font color=#447700>! note the IKJ assumption here.<a name='301'></font>
   parent_grid%ed31 = parent_grid%ed31 - 2<a name='302'>
   parent_grid%ed33 = parent_grid%ed33 - 2<a name='303'>
   CALL       nl_set_e_we( 1, e_we-2 )<a name='304'>
   CALL       nl_set_e_sn( 1, e_sn-2 )<a name='305'>
<a name='306'>
<font color=#447700>!write(0,*)'after alloc_and_configure_domain ',associated(nested_grid%intermediate_grid)<a name='307'></font>
<a name='308'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_30"> ( nested_grid%id , model_config_rec , config_flags )<a name='309'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_15"> ( nested_grid%id , idum1, idum2 )<a name='310'>
<a name='311'>
   <font color=#447700>!  Set up time initializations for the fine grid.<a name='312'></font>
<a name='313'>
   CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_9"> ( nested_grid )<a name='314'>
   <font color=#447700>!  Adjust the time step on the clock so that it's the same as the history interval<a name='315'></font>
<a name='316'>
   CALL WRFU_AlarmGet( nested_grid%alarms(HISTORY_ALARM), RingInterval=RingInterval )<a name='317'>
   CALL WRFU_ClockSet( nested_grid%domain_clock, TimeStep=RingInterval, rc=rc )<a name='318'>
   CALL WRFU_ClockSet( parent_grid%domain_clock, TimeStep=RingInterval, rc=rc )<a name='319'>
   <a name='320'>
   <font color=#447700>!  Get and store the history interval from the fine grid; use for time loop <a name='321'></font>
<a name='322'>
<a name='323'>
   <font color=#447700>!  Initialize the I/O for WRF.<a name='324'></font>
<a name='325'>
   CALL <A href='../../html_code/share/module_io_domain.F.html#INIT_WRFIO'>init_wrfio</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_WRFIO_6"><a name='326'>
<a name='327'>
   <font color=#447700>!  Some of the configuration values may have been modified from the initial READ<a name='328'></font>
   <font color=#447700>!  of the NAMELIST, so we re-broadcast the configuration records.<a name='329'></font>
<a name='330'>
#ifdef DM_PARALLEL<a name='331'>
   CALL <A href='../../html_code/frame/module_configure.F.html#GET_CONFIG_AS_BUFFER'>get_config_as_buffer</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CONFIG_AS_BUFFER_12">( configbuf, configbuflen, nbytes )<a name='332'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_115">( configbuf, nbytes )<a name='333'>
   CALL <A href='../../html_code/frame/module_configure.F.html#SET_CONFIG_AS_BUFFER'>set_config_as_buffer</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CONFIG_AS_BUFFER_12">( configbuf, configbuflen )<a name='334'>
#endif<a name='335'>
<a name='336'>
   <font color=#447700>!  Open the input data (wrfout_d01_xxxxxx) for reading.<a name='337'></font>
   in_id = 0<a name='338'>
   out_id = 0<a name='339'>
   main_loop : DO WHILE ( domain_get_current_time(nested_grid) .LT. domain_get_stop_time(nested_grid) )<a name='340'>
<a name='341'>
      IF( WRFU_AlarmIsRinging( nested_grid%alarms( HISTORY_ALARM ), rc=rc ) ) THEN<a name='342'>
        CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_35">( nested_grid, current_timestr=timestr )<a name='343'>
        newly_opened = .FALSE.<a name='344'>
        IF ( in_id.EQ. 0 ) THEN<a name='345'>
          CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_31"> ( nested_grid%id , model_config_rec , config_flags )<a name='346'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_5"> ( fname , config_flags%history_outname , nested_grid%id , 2 , timestr )<a name='347'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_6"> ( in_id, TRIM(fname), nested_grid ,  &amp;<a name='348'>
                                 config_flags , 'DATASET=HISTORY' , ierr )<a name='349'>
          IF ( ierr .NE. 0 ) THEN<a name='350'>
            WRITE(message,*)'Failed to open ',TRIM(fname),' for reading. '<a name='351'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_463">(message)<a name='352'>
            EXIT main_loop<a name='353'>
          ENDIF<a name='354'>
<a name='355'>
          CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_32"> ( parent_grid%id , model_config_rec , config_flags )<a name='356'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2A'>construct_filename2a</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2A_6"> ( fname , config_flags%history_outname , parent_grid%id , 2 , timestr )<a name='357'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_W_DATASET'>open_w_dataset</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_W_DATASET_9"> ( out_id, TRIM(fname), parent_grid ,  &amp;<a name='358'>
                                 config_flags , output_history, 'DATASET=HISTORY' , ierr )<a name='359'>
          IF ( ierr .NE. 0 ) THEN<a name='360'>
            WRITE(message,*)'Failed to open ',TRIM(fname),' for writing. '<a name='361'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_464">(message)<a name='362'>
            EXIT main_loop<a name='363'>
          ENDIF<a name='364'>
          newly_opened = .TRUE.<a name='365'>
        ENDIF<a name='366'>
<a name='367'>
        CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_33"> ( nested_grid%id , model_config_rec , config_flags )<a name='368'>
        CALL input_history ( in_id, nested_grid , config_flags , ierr )<a name='369'>
        IF ( ierr .NE. 0 ) THEN<a name='370'>
          WRITE(message,*)'Unable to read time ',timestr<a name='371'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_465">(message)<a name='372'>
          EXIT main_loop<a name='373'>
        ENDIF<a name='374'>
<font color=#447700>!<a name='375'></font>
        CALL <A href='../../html_code/main/nup_em.F.html#NUP'>nup</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="NUP_1"> ( nested_grid , parent_grid, in_id, out_id, newly_opened  )<a name='376'>
<font color=#447700>!<a name='377'></font>
        CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_34"> ( parent_grid%id , model_config_rec , config_flags )<a name='378'>
        CALL output_history ( out_id, parent_grid , config_flags , ierr )<a name='379'>
        IF ( ierr .NE. 0 ) THEN<a name='380'>
          WRITE(message,*)'Unable to write time ',timestr<a name='381'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_466">(message)<a name='382'>
          EXIT main_loop<a name='383'>
        ENDIF<a name='384'>
<a name='385'>
        nested_grid%nframes(history_only) = nested_grid%nframes(history_only) + 1<a name='386'>
        IF ( nested_grid%nframes(history_only) &gt;= config_flags%frames_per_outfile ) THEN<a name='387'>
          CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_35"> ( nested_grid%id , model_config_rec , config_flags )<a name='388'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_10"> ( in_id , config_flags , "DATASET=HISTORY" )<a name='389'>
          CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_36"> ( parent_grid%id , model_config_rec , config_flags )<a name='390'>
          CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_11"> ( out_id , config_flags , "DATASET=HISTORY" )<a name='391'>
          in_id = 0<a name='392'>
          out_id = 0<a name='393'>
          nested_grid%nframes(history_only) = 0<a name='394'>
        ENDIF<a name='395'>
        CALL WRFU_AlarmRingerOff( nested_grid%alarms( HISTORY_ALARM ), rc=rc )<a name='396'>
      ENDIF<a name='397'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCKADVANCE'>domain_clockadvance</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCKADVANCE_3">( nested_grid )<a name='398'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCKADVANCE'>domain_clockadvance</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCKADVANCE_4">( parent_grid )<a name='399'>
   ENDDO main_loop<a name='400'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_37"> ( parent_grid%id , model_config_rec , config_flags )<a name='401'>
   CALL <A href='../../html_code/share/mediation_wrfmain.F.html#MED_SHUTDOWN_IO'>med_shutdown_io</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_SHUTDOWN_IO_4"> ( parent_grid , config_flags )<a name='402'>
<a name='403'>
   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/nup_em.F.html#NUP_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_349"> ( 0 , 'nup_em: SUCCESS COMPLETE NUP_EM INIT' )<a name='404'>
<a name='405'>
<font color=#447700>!  CALL wrf_shutdown<a name='406'></font>
<a name='407'>
   CALL WRFU_Finalize( rc=rc )<a name='408'>
<a name='409'>
END PROGRAM nup_em<a name='410'>
<a name='411'>
<A NAME='NUP'><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='412'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>nup</font> ( nested_grid, parent_grid , in_id, out_id, newly_opened )  <A href='../../call_to/NUP.html' TARGET='index'>1</A>,<A href='../../call_from/NUP.html' TARGET='index'>23</A><a name='413'>
  USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_199"><a name='414'>
  USE <A href='../../html_code/share/module_io_domain.F.html#MODULE_IO_DOMAIN'>module_io_domain</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_IO_DOMAIN_11"><a name='415'>
  USE module_utility<a name='416'>
  USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_38"><a name='417'>
  USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_41"><a name='418'>
<font color=#447700>!<a name='419'></font>
  IMPLICIT NONE<a name='420'>
<a name='421'>
<font color=#447700>! Args<a name='422'></font>
  TYPE(domain), POINTER :: parent_grid, nested_grid<a name='423'>
  INTEGER, INTENT(IN) :: in_id, out_id    <font color=#447700>! io descriptors <a name='424'></font>
  LOGICAL, INTENT(IN) :: newly_opened     <font color=#447700>! whether to add global metadata<a name='425'></font>
<font color=#447700>! Local<a name='426'></font>
  INTEGER :: julyr , julday , iswater , map_proj<a name='427'>
  INTEGER :: icnt, ierr<a name='428'>
  REAL    :: dt , new_bdy_frq<a name='429'>
  REAL    :: gmt , cen_lat , cen_lon , dx , dy , truelat1 , truelat2 , moad_cen_lat , stand_lon<a name='430'>
  REAL , DIMENSION(:,:,:) , ALLOCATABLE :: ubdy3dtemp1 , vbdy3dtemp1 , tbdy3dtemp1 , pbdy3dtemp1 , qbdy3dtemp1<a name='431'>
  REAL , DIMENSION(:,:,:) , ALLOCATABLE :: mbdy2dtemp1<a name='432'>
  REAL , DIMENSION(:,:,:) , ALLOCATABLE :: ubdy3dtemp2 , vbdy3dtemp2 , tbdy3dtemp2 , pbdy3dtemp2 , qbdy3dtemp2<a name='433'>
  REAL , DIMENSION(:,:,:) , ALLOCATABLE :: mbdy2dtemp2<a name='434'>
  INTEGER :: ids , ide , jds , jde , kds , kde<a name='435'>
  INTEGER :: ims , ime , jms , jme , kms , kme<a name='436'>
  INTEGER :: ips , ipe , jps , jpe , kps , kpe<a name='437'>
  INTEGER :: its , ite , jts , jte , kts , kte<a name='438'>
<a name='439'>
  INTERFACE<a name='440'>
     SUBROUTINE med_feedback_domain ( parent_grid , nested_grid )<a name='441'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_200"><a name='442'>
        USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_131"><a name='443'>
        TYPE(domain), POINTER :: parent_grid , nested_grid<a name='444'>
     END SUBROUTINE med_feedback_domain<a name='445'>
     SUBROUTINE med_interp_domain ( parent_grid , nested_grid )<a name='446'>
        USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_201"><a name='447'>
        USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_132"><a name='448'>
        TYPE(domain), POINTER :: parent_grid , nested_grid<a name='449'>
     END SUBROUTINE med_interp_domain<a name='450'>
  END INTERFACE<a name='451'>
<a name='452'>
  IF ( newly_opened ) THEN<a name='453'>
    CALL wrf_get_dom_ti_integer ( in_id , 'MAP_PROJ' , map_proj , 1 , icnt , ierr ) <a name='454'>
    CALL wrf_get_dom_ti_real    ( in_id , 'DX'  , dx  , 1 , icnt , ierr ) <a name='455'>
    CALL wrf_get_dom_ti_real    ( in_id , 'DY'  , dy  , 1 , icnt , ierr ) <a name='456'>
    CALL wrf_get_dom_ti_real    ( in_id , 'CEN_LAT' , cen_lat , 1 , icnt , ierr ) <a name='457'>
    CALL wrf_get_dom_ti_real    ( in_id , 'CEN_LON' , cen_lon , 1 , icnt , ierr ) <a name='458'>
    CALL wrf_get_dom_ti_real    ( in_id , 'TRUELAT1' , truelat1 , 1 , icnt , ierr ) <a name='459'>
    CALL wrf_get_dom_ti_real    ( in_id , 'TRUELAT2' , truelat2 , 1 , icnt , ierr ) <a name='460'>
    CALL wrf_get_dom_ti_real    ( in_id , 'MOAD_CEN_LAT' , moad_cen_lat , 1 , icnt , ierr ) <a name='461'>
    CALL wrf_get_dom_ti_real    ( in_id , 'STAND_LON' , stand_lon , 1 , icnt , ierr ) <a name='462'>
<font color=#447700>!     CALL wrf_get_dom_ti_real    ( in_id , 'GMT' , gmt , 1 , icnt , ierr ) <a name='463'></font>
<font color=#447700>!     CALL wrf_get_dom_ti_integer ( in_id , 'JULYR' , julyr , 1 , icnt , ierr ) <a name='464'></font>
<font color=#447700>!     CALL wrf_get_dom_ti_integer ( in_id , 'JULDAY' , julday , 1 , icnt , ierr ) <a name='465'></font>
    CALL wrf_get_dom_ti_integer ( in_id , 'ISWATER' , iswater , 1 , icnt , ierr ) <a name='466'>
  ENDIF<a name='467'>
<a name='468'>
  parent_grid%fnm    = nested_grid%fnm<a name='469'>
  parent_grid%fnp    = nested_grid%fnp<a name='470'>
  parent_grid%rdnw   = nested_grid%rdnw<a name='471'>
  parent_grid%rdn    = nested_grid%rdn<a name='472'>
  parent_grid%dnw    = nested_grid%dnw<a name='473'>
  parent_grid%dn     = nested_grid%dn <a name='474'>
  parent_grid%znu    = nested_grid%znu<a name='475'>
  parent_grid%znw    = nested_grid%znw<a name='476'>
<a name='477'>
  parent_grid%zs        = nested_grid%zs<a name='478'>
  parent_grid%dzs       = nested_grid%dzs<a name='479'>
<a name='480'>
  parent_grid%p_top     = nested_grid%p_top<a name='481'>
  parent_grid%rdx       = nested_grid%rdx * 3.<a name='482'>
  parent_grid%rdy       = nested_grid%rdy * 3.<a name='483'>
  parent_grid%resm      = nested_grid%resm<a name='484'>
  parent_grid%zetatop   = nested_grid%zetatop<a name='485'>
  parent_grid%cf1       = nested_grid%cf1<a name='486'>
  parent_grid%cf2       = nested_grid%cf2<a name='487'>
  parent_grid%cf3       = nested_grid%cf3<a name='488'>
<a name='489'>
  parent_grid%cfn       = nested_grid%cfn <a name='490'>
  parent_grid%cfn1      = nested_grid%cfn1<a name='491'>
<a name='492'>
#if ( WRF_CHEM == 1 )<a name='493'>
  parent_grid%chem_opt    = nested_grid%chem_opt<a name='494'>
  parent_grid%chem_in_opt = nested_grid%chem_in_opt<a name='495'>
#endif<a name='496'>
<a name='497'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='498'></font>
<a name='499'>
  <font color=#447700>!  Various sizes that we need to be concerned about.<a name='500'></font>
<a name='501'>
  ids = parent_grid%sd31<a name='502'>
  ide = parent_grid%ed31<a name='503'>
  kds = parent_grid%sd32<a name='504'>
  kde = parent_grid%ed32<a name='505'>
  jds = parent_grid%sd33<a name='506'>
  jde = parent_grid%ed33<a name='507'>
<a name='508'>
  ims = parent_grid%sm31<a name='509'>
  ime = parent_grid%em31<a name='510'>
  kms = parent_grid%sm32<a name='511'>
  kme = parent_grid%em32<a name='512'>
  jms = parent_grid%sm33<a name='513'>
  jme = parent_grid%em33<a name='514'>
<a name='515'>
  ips = parent_grid%sp31<a name='516'>
  ipe = parent_grid%ep31<a name='517'>
  kps = parent_grid%sp32<a name='518'>
  kpe = parent_grid%ep32<a name='519'>
  jps = parent_grid%sp33<a name='520'>
  jpe = parent_grid%ep33<a name='521'>
<a name='522'>
  nested_grid%imask_nostag = 1<a name='523'>
  nested_grid%imask_xstag = 1<a name='524'>
  nested_grid%imask_ystag = 1<a name='525'>
  nested_grid%imask_xystag = 1<a name='526'>
<a name='527'>
<font color=#447700>! Interpolate from nested_grid back onto parent_grid<a name='528'></font>
  CALL <A href='../../html_code/share/mediation_feedback_domain.F.html#MED_FEEDBACK_DOMAIN'>med_feedback_domain</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_FEEDBACK_DOMAIN_1"> ( parent_grid , nested_grid )<a name='529'>
<a name='530'>
  parent_grid%ht_int = parent_grid%ht<a name='531'>
<a name='532'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='533'></font>
<a name='534'>
#if 0<a name='535'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CONSTRUCT_FILENAME2'>construct_filename2</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CONSTRUCT_FILENAME2_1">( si_inpname , 'wrf_real_input_em' , parent_grid%id , 2 , start_date_char )<a name='536'>
         CALL       wrf_debug ( 100 , 'med_sidata_input: calling open_r_dataset for ' // TRIM(si_inpname) )<a name='537'>
         CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_38"> ( parent_grid%id , model_config_rec , config_flags )<a name='538'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#OPEN_R_DATASET'>open_r_dataset</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OPEN_R_DATASET_7"> ( idsi, TRIM(si_inpname) , parent_grid , config_flags , "DATASET=INPUT", ierr )<a name='539'>
         IF ( ierr .NE. 0 ) THEN<a name='540'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_411">( 'real: error opening wrf_real_input_em for reading: ' // TRIM (si_inpname) )<a name='541'>
         END IF<a name='542'>
<a name='543'>
         <font color=#447700>!  Input data.<a name='544'></font>
   <a name='545'>
         CALL       wrf_debug ( 100 , 'nup_em: calling input_aux_model_input2' )<a name='546'>
         CALL input_aux_model_input2 ( idsi , parent_grid , config_flags , ierr )<a name='547'>
         parent_grid%ht_input = parent_grid%ht<a name='548'>
   <a name='549'>
         <font color=#447700>!  Close this fine grid static input file.<a name='550'></font>
   <a name='551'>
         CALL       <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_350"> ( 100 , 'nup_em: closing fine grid static input' )<a name='552'>
         CALL <A href='../../html_code/share/module_io_domain.F.html#CLOSE_DATASET'>close_dataset</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CLOSE_DATASET_12"> ( idsi , config_flags , "DATASET=INPUT" )<a name='553'>
<a name='554'>
         <font color=#447700>!  We need a parent grid landuse in the interpolation.  So we need to generate<a name='555'></font>
         <font color=#447700>!  that field now.<a name='556'></font>
<a name='557'>
         IF      ( ( parent_grid%ivgtyp(ips,jps) .GT. 0 ) .AND. &amp;<a name='558'>
                   ( parent_grid%isltyp(ips,jps) .GT. 0 ) ) THEN<a name='559'>
            DO j = jps, MIN(jde-1,jpe)<a name='560'>
               DO i = ips, MIN(ide-1,ipe)<a name='561'>
                  parent_grid% vegcat(i,j) = parent_grid%ivgtyp(i,j)<a name='562'>
                  parent_grid%soilcat(i,j) = parent_grid%isltyp(i,j)<a name='563'>
               END DO<a name='564'>
            END DO<a name='565'>
<a name='566'>
         ELSE IF ( ( parent_grid% vegcat(ips,jps) .GT. 0.5 ) .AND. &amp;<a name='567'>
                   ( parent_grid%soilcat(ips,jps) .GT. 0.5 ) ) THEN<a name='568'>
            DO j = jps, MIN(jde-1,jpe)<a name='569'>
               DO i = ips, MIN(ide-1,ipe)<a name='570'>
                  parent_grid%ivgtyp(i,j) = NINT(parent_grid% vegcat(i,j))<a name='571'>
                  parent_grid%isltyp(i,j) = NINT(parent_grid%soilcat(i,j))<a name='572'>
               END DO<a name='573'>
            END DO<a name='574'>
<a name='575'>
         ELSE<a name='576'>
            num_veg_cat      = SIZE ( parent_grid%landusef , DIM=2 )<a name='577'>
            num_soil_top_cat = SIZE ( parent_grid%soilctop , DIM=2 )<a name='578'>
            num_soil_bot_cat = SIZE ( parent_grid%soilcbot , DIM=2 )<a name='579'>
   <a name='580'>
            CALL <A href='../../html_code/main/nup_em.F.html#LAND_PERCENTAGES'>land_percentages</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LAND_PERCENTAGES_2"> (  parent_grid%xland , &amp;<a name='581'>
                                     parent_grid%landusef , parent_grid%soilctop , parent_grid%soilcbot , &amp;<a name='582'>
                                     parent_grid%isltyp , parent_grid%ivgtyp , &amp;<a name='583'>
                                     num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='584'>
                                     ids , ide , jds , jde , kds , kde , &amp;<a name='585'>
                                     ims , ime , jms , jme , kms , kme , &amp;<a name='586'>
                                     ips , ipe , jps , jpe , kps , kpe , &amp;<a name='587'>
                                     model_config_rec%iswater(parent_grid%id) )<a name='588'>
<a name='589'>
          END IF<a name='590'>
<a name='591'>
          DO j = jps, MIN(jde-1,jpe)<a name='592'>
            DO i = ips, MIN(ide-1,ipe)<a name='593'>
               parent_grid%lu_index(i,j) = parent_grid%ivgtyp(i,j)<a name='594'>
            END DO<a name='595'>
         END DO<a name='596'>
<a name='597'>
         CALL <A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY'>check_consistency</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_CONSISTENCY_2"> ( parent_grid%ivgtyp , parent_grid%isltyp , parent_grid%landmask , &amp;<a name='598'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='599'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='600'>
                                  ips , ipe , jps , jpe , kps , kpe , &amp;<a name='601'>
                                  model_config_rec%iswater(parent_grid%id) )<a name='602'>
<a name='603'>
         CALL <A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2'>check_consistency2</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CHECK_CONSISTENCY2_2">( parent_grid%ivgtyp , parent_grid%isltyp , parent_grid%landmask , &amp;<a name='604'>
                                  parent_grid%tmn , parent_grid%tsk , parent_grid%sst , parent_grid%xland , &amp;<a name='605'>
                                  parent_grid%tslb , parent_grid%smois , parent_grid%sh2o , &amp;<a name='606'>
                                  config_flags%num_soil_layers , parent_grid%id , &amp;<a name='607'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='608'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='609'>
                                  ips , ipe , jps , jpe , kps , kpe , &amp;<a name='610'>
                                  model_config_rec%iswater(parent_grid%id) )<a name='611'>
<a name='612'>
<a name='613'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='614'></font>
   <a name='615'>
      <font color=#447700>!  We have 2 terrain elevations.  One is from input and the other is from the<a name='616'></font>
      <font color=#447700>!  the horizontal interpolation.<a name='617'></font>
<a name='618'>
      parent_grid%ht_fine = parent_grid%ht_input<a name='619'>
      parent_grid%ht      = parent_grid%ht_int<a name='620'>
<a name='621'>
      <font color=#447700>!  We have both the interpolated fields and the higher-resolution static fields.  From these<a name='622'></font>
      <font color=#447700>!  the rebalancing is now done.  Note also that the field parent_grid%ht is now from the <a name='623'></font>
      <font color=#447700>!  fine grid input file (after this call is completed).<a name='624'></font>
<a name='625'>
      CALL rebalance_driver ( parent_grid ) <a name='626'>
<a name='627'>
      <font color=#447700>!  Different things happen during the different time loops:<a name='628'></font>
      <font color=#447700>!      first loop - write wrfinput file, close data set, copy files to holder arrays<a name='629'></font>
      <font color=#447700>!      middle loops - diff 3d/2d arrays, compute and output bc<a name='630'></font>
      <font color=#447700>!      last loop - diff 3d/2d arrays, compute and output bc, write wrfbdy file, close wrfbdy file<a name='631'></font>
<a name='632'>
         <font color=#447700>!  Set the time info.<a name='633'></font>
<a name='634'>
         print *,'current_date = ',current_date<a name='635'>
         CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_SET'>domain_clock_set</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_SET_18">( parent_grid, &amp;<a name='636'>
                                current_timestr=current_date(1:19) )<a name='637'>
<font color=#447700>!<a name='638'></font>
<font color=#447700>! SEP     Put in chemistry data<a name='639'></font>
<font color=#447700>!<a name='640'></font>
#if ( WRF_CHEM == 1 )<a name='641'>
         IF( parent_grid%chem_opt .NE. 0 ) then<a name='642'>
            IF( parent_grid%chem_in_opt .EQ. 0 ) then<a name='643'>
             <font color=#447700>! Read the chemistry data from a previous wrf forecast (wrfout file)<a name='644'></font>
              <font color=#447700>! Generate chemistry data from a idealized vertical profile<a name='645'></font>
              message = 'STARTING WITH BACKGROUND CHEMISTRY '<a name='646'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_467"> ( message )<a name='647'>
<a name='648'>
              CALL input_chem_profile ( parent_grid )<a name='649'>
<a name='650'>
              message = 'READING BEIS3.11 EMISSIONS DATA'<a name='651'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_468"> ( message )<a name='652'>
<a name='653'>
              CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_READ_WRF_CHEM_BIOEMISS'>med_read_wrf_chem_bioemiss</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_READ_WRF_CHEM_BIOEMISS_11"> ( parent_grid , config_flags)<a name='654'>
            ELSE<a name='655'>
              message = 'RUNNING WITHOUT CHEMISTRY INITIALIZATION'<a name='656'>
              CALL  <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/main/nup_em.F.html#NUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_469"> ( message )<a name='657'>
            ENDIF<a name='658'>
         ENDIF<a name='659'>
#endif<a name='660'>
<a name='661'>
#endif<a name='662'>
<a name='663'>
         <font color=#447700>!  Output the first time period of the data.<a name='664'></font>
   <a name='665'>
  IF ( newly_opened ) THEN<a name='666'>
    CALL wrf_put_dom_ti_integer ( out_id , 'MAP_PROJ' , map_proj , 1 , ierr ) <a name='667'>
<font color=#447700>!     CALL wrf_put_dom_ti_real    ( out_id , 'DX'  , dx  , 1 , ierr ) <a name='668'></font>
<font color=#447700>!     CALL wrf_put_dom_ti_real    ( out_id , 'DY'  , dy  , 1 , ierr ) <a name='669'></font>
    CALL wrf_put_dom_ti_real    ( out_id , 'CEN_LAT' , cen_lat , 1 , ierr ) <a name='670'>
    CALL wrf_put_dom_ti_real    ( out_id , 'CEN_LON' , cen_lon , 1 , ierr ) <a name='671'>
    CALL wrf_put_dom_ti_real    ( out_id , 'TRUELAT1' , truelat1 , 1 , ierr ) <a name='672'>
    CALL wrf_put_dom_ti_real    ( out_id , 'TRUELAT2' , truelat2 , 1 , ierr ) <a name='673'>
    CALL wrf_put_dom_ti_real    ( out_id , 'MOAD_CEN_LAT' , moad_cen_lat , 1 , ierr ) <a name='674'>
    CALL wrf_put_dom_ti_real    ( out_id , 'STAND_LON' , stand_lon , 1 , ierr ) <a name='675'>
    CALL wrf_put_dom_ti_integer ( out_id , 'ISWATER' , iswater , 1 , ierr ) <a name='676'>
<a name='677'>
    CALL wrf_put_dom_ti_real    ( out_id , 'GMT' , gmt , 1 , ierr ) <a name='678'>
    CALL wrf_put_dom_ti_integer ( out_id , 'JULYR' , julyr , 1 , ierr ) <a name='679'>
    CALL wrf_put_dom_ti_integer ( out_id , 'JULDAY' , julday , 1 , ierr ) <a name='680'>
  ENDIF<a name='681'>
<a name='682'>
END SUBROUTINE nup<a name='683'>
<a name='684'>
<A NAME='LAND_PERCENTAGES'><A href='../../html_code/main/nup_em.F.html#LAND_PERCENTAGES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='685'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>land_percentages</font> ( xland , &amp; <A href='../../call_to/LAND_PERCENTAGES.html' TARGET='index'>2</A>,<A href='../../call_from/LAND_PERCENTAGES.html' TARGET='index'>4</A><a name='686'>
                              landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='687'>
                              isltyp , ivgtyp , &amp;<a name='688'>
                              num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='689'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='690'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='691'>
                              its , ite , jts , jte , kts , kte , &amp;<a name='692'>
                              iswater )<a name='693'>
   USE <A href='../../html_code/share/module_soil_pre.F.html#MODULE_SOIL_PRE'>module_soil_pre</A><A href='../../html_code/main/nup_em.F.html#LAND_PERCENTAGES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SOIL_PRE_5"><a name='694'>
<a name='695'>
   IMPLICIT NONE<a name='696'>
<a name='697'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='698'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='699'>
                           its , ite , jts , jte , kts , kte , &amp;<a name='700'>
                           iswater<a name='701'>
<a name='702'>
   INTEGER , INTENT(IN) :: num_veg_cat , num_soil_top_cat , num_soil_bot_cat<a name='703'>
   REAL , DIMENSION(ims:ime,1:num_veg_cat,jms:jme) , INTENT(INOUT):: landuse_frac<a name='704'>
   REAL , DIMENSION(ims:ime,1:num_soil_top_cat,jms:jme) , INTENT(IN):: soil_top_cat<a name='705'>
   REAL , DIMENSION(ims:ime,1:num_soil_bot_cat,jms:jme) , INTENT(IN):: soil_bot_cat<a name='706'>
   INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(OUT) :: isltyp , ivgtyp<a name='707'>
   REAL , DIMENSION(ims:ime,jms:jme) , INTENT(OUT) :: xland<a name='708'>
<a name='709'>
   CALL <A href='../../html_code/share/module_soil_pre.F.html#PROCESS_PERCENT_CAT_NEW'>process_percent_cat_new</A><A href='../../html_code/main/nup_em.F.html#LAND_PERCENTAGES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PROCESS_PERCENT_CAT_NEW_2"> ( xland , &amp;<a name='710'>
                                  landuse_frac , soil_top_cat , soil_bot_cat , &amp;<a name='711'>
                                  isltyp , ivgtyp , &amp;<a name='712'>
                                  num_veg_cat , num_soil_top_cat , num_soil_bot_cat , &amp;<a name='713'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='714'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='715'>
                                  its , ite , jts , jte , kts , kte , &amp;<a name='716'>
                                  iswater )<a name='717'>
<a name='718'>
END SUBROUTINE land_percentages<a name='719'>
<a name='720'>
<A NAME='CHECK_CONSISTENCY'><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='721'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>check_consistency</font> ( ivgtyp , isltyp , landmask , &amp; <A href='../../call_to/CHECK_CONSISTENCY.html' TARGET='index'>2</A>,<A href='../../call_from/CHECK_CONSISTENCY.html' TARGET='index'>2</A><a name='722'>
                                  ids , ide , jds , jde , kds , kde , &amp;<a name='723'>
                                  ims , ime , jms , jme , kms , kme , &amp;<a name='724'>
                                  its , ite , jts , jte , kts , kte , &amp;<a name='725'>
                                  iswater )<a name='726'>
<a name='727'>
   IMPLICIT NONE<a name='728'>
<a name='729'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='730'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='731'>
                           its , ite , jts , jte , kts , kte , &amp;<a name='732'>
                           iswater<a name='733'>
   INTEGER , DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: isltyp , ivgtyp<a name='734'>
   REAL    , DIMENSION(ims:ime,jms:jme), INTENT(INOUT) :: landmask<a name='735'>
<a name='736'>
   LOGICAL :: oops<a name='737'>
   INTEGER :: oops_count , i , j<a name='738'>
<a name='739'>
   oops = .FALSE.<a name='740'>
   oops_count = 0<a name='741'>
<a name='742'>
   DO j = jts, MIN(jde-1,jte)<a name='743'>
      DO i = its, MIN(ide-1,ite)<a name='744'>
         IF ( ( ( landmask(i,j) .LT. 0.5 ) .AND. ( ivgtyp(i,j) .NE. iswater ) ) .OR. &amp;<a name='745'>
              ( ( landmask(i,j) .GT. 0.5 ) .AND. ( ivgtyp(i,j) .EQ. iswater ) ) ) THEN<a name='746'>
            print *,'mismatch in landmask and veg type'<a name='747'>
            print *,'i,j=',i,j, '  landmask =',NINT(landmask(i,j)),'  ivgtyp=',ivgtyp(i,j)<a name='748'>
            oops = .TRUE.<a name='749'>
            oops_count = oops_count + 1<a name='750'>
landmask(i,j) = 0<a name='751'>
ivgtyp(i,j)=16<a name='752'>
isltyp(i,j)=14<a name='753'>
         END IF<a name='754'>
      END DO<a name='755'>
   END DO<a name='756'>
<a name='757'>
   IF ( oops ) THEN<a name='758'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_351">( 0, 'mismatch in check_consistency, turned to water points, be careful' )<a name='759'>
   END IF<a name='760'>
<a name='761'>
END SUBROUTINE check_consistency<a name='762'>
<a name='763'>
<A NAME='CHECK_CONSISTENCY2'><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='764'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>check_consistency2</font>( ivgtyp , isltyp , landmask , &amp; <A href='../../call_to/CHECK_CONSISTENCY2.html' TARGET='index'>2</A>,<A href='../../call_from/CHECK_CONSISTENCY2.html' TARGET='index'>12</A><a name='765'>
                               tmn , tsk , sst , xland , &amp;<a name='766'>
                               tslb , smois , sh2o , &amp;<a name='767'>
                               num_soil_layers , id , &amp;<a name='768'>
                               ids , ide , jds , jde , kds , kde , &amp;<a name='769'>
                               ims , ime , jms , jme , kms , kme , &amp;<a name='770'>
                               its , ite , jts , jte , kts , kte , &amp;<a name='771'>
                               iswater )<a name='772'>
<a name='773'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_133"><a name='774'>
   USE <A href='../../html_code/share/module_optional_input.F.html#MODULE_OPTIONAL_INPUT'>module_optional_input</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_OPTIONAL_INPUT_5"><a name='775'>
<a name='776'>
   INTEGER , INTENT(IN) :: ids , ide , jds , jde , kds , kde , &amp;<a name='777'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='778'>
                           its , ite , jts , jte , kts , kte <a name='779'>
   INTEGER , INTENT(IN) :: num_soil_layers , id<a name='780'>
<a name='781'>
   INTEGER , DIMENSION(ims:ime,jms:jme) :: ivgtyp , isltyp<a name='782'>
   REAL    , DIMENSION(ims:ime,jms:jme) :: landmask , tmn , tsk , sst , xland<a name='783'>
   REAL    , DIMENSION(ims:ime,num_soil_layers,jms:jme) :: tslb , smois , sh2o<a name='784'>
<a name='785'>
   INTEGER :: oops1 , oops2<a name='786'>
   INTEGER :: i , j , k<a name='787'>
<a name='788'>
      fix_tsk_tmn : SELECT CASE ( model_config_rec%sf_surface_physics(id) )<a name='789'>
<a name='790'>
         CASE ( SLABSCHEME , LSMSCHEME , RUCLSMSCHEME )<a name='791'>
            DO j = jts, MIN(jde-1,jte)<a name='792'>
               DO i = its, MIN(ide-1,ite)<a name='793'>
                  IF ( ( landmask(i,j) .LT. 0.5 ) .AND. ( flag_sst .EQ. 1 ) ) THEN<a name='794'>
                     tmn(i,j) = sst(i,j)<a name='795'>
                     tsk(i,j) = sst(i,j)<a name='796'>
                  ELSE IF ( landmask(i,j) .LT. 0.5 ) THEN<a name='797'>
                     tmn(i,j) = tsk(i,j)<a name='798'>
                  END IF<a name='799'>
               END DO<a name='800'>
            END DO<a name='801'>
      END SELECT fix_tsk_tmn<a name='802'>
<a name='803'>
      <font color=#447700>!  Is the TSK reasonable?<a name='804'></font>
<a name='805'>
      DO j = jts, MIN(jde-1,jte)<a name='806'>
         DO i = its, MIN(ide-1,ite)<a name='807'>
            IF ( tsk(i,j) .LT. 170 .or. tsk(i,j) .GT. 400. ) THEN<a name='808'>
               print *,'error in the TSK'<a name='809'>
               print *,'i,j=',i,j<a name='810'>
               print *,'landmask=',landmask(i,j)<a name='811'>
               print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='812'>
               if(tmn(i,j).gt.170. .and. tmn(i,j).lt.400.)then<a name='813'>
                  tsk(i,j)=tmn(i,j)<a name='814'>
               else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='815'>
                  tsk(i,j)=sst(i,j)<a name='816'>
               else<a name='817'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_412"> ( 'TSK unreasonable' )<a name='818'>
               end if<a name='819'>
            END IF<a name='820'>
         END DO<a name='821'>
      END DO<a name='822'>
<a name='823'>
      <font color=#447700>!  Is the TMN reasonable?<a name='824'></font>
<a name='825'>
      DO j = jts, MIN(jde-1,jte)<a name='826'>
         DO i = its, MIN(ide-1,ite)<a name='827'>
            IF ( ( ( tmn(i,j) .LT. 170. ) .OR. ( tmn(i,j) .GT. 400. ) ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='828'>
                  print *,'error in the TMN'<a name='829'>
                  print *,'i,j=',i,j<a name='830'>
                  print *,'landmask=',landmask(i,j)<a name='831'>
                  print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='832'>
               if(tsk(i,j).gt.170. .and. tsk(i,j).lt.400.)then<a name='833'>
                  tmn(i,j)=tsk(i,j)<a name='834'>
               else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='835'>
                  tmn(i,j)=sst(i,j)<a name='836'>
               else<a name='837'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_413"> ( 'TMN unreasonable' )<a name='838'>
               endif<a name='839'>
            END IF<a name='840'>
         END DO<a name='841'>
      END DO<a name='842'>
<a name='843'>
      <font color=#447700>!  Is the TSLB reasonable?<a name='844'></font>
<a name='845'>
      DO j = jts, MIN(jde-1,jte)<a name='846'>
         DO i = its, MIN(ide-1,ite)<a name='847'>
            IF ( ( ( tslb(i,1,j) .LT. 170. ) .OR. ( tslb(i,1,j) .GT. 400. ) ) .AND. ( landmask(i,j) .GT. 0.5 ) ) THEN<a name='848'>
                  print *,'error in the TSLB'<a name='849'>
                  print *,'i,j=',i,j<a name='850'>
                  print *,'landmask=',landmask(i,j)<a name='851'>
                  print *,'tsk, sst, tmn=',tsk(i,j),sst(i,j),tmn(i,j)<a name='852'>
                  print *,'tslb = ',tslb(i,:,j)<a name='853'>
                  print *,'old smois = ',smois(i,:,j)<a name='854'>
                  DO l = 1 , num_soil_layers<a name='855'>
                     sh2o(i,l,j) = 0.0<a name='856'>
                  END DO<a name='857'>
                  DO l = 1 , num_soil_layers<a name='858'>
                     smois(i,l,j) = 0.3<a name='859'>
                  END DO<a name='860'>
                  if(tsk(i,j).gt.170. .and. tsk(i,j).lt.400.)then<a name='861'>
                     DO l = 1 , num_soil_layers<a name='862'>
                        tslb(i,l,j)=tsk(i,j)<a name='863'>
                     END DO<a name='864'>
                  else if(sst(i,j).gt.170. .and. sst(i,j).lt.400.)then<a name='865'>
                     DO l = 1 , num_soil_layers<a name='866'>
                        tslb(i,l,j)=sst(i,j)<a name='867'>
                     END DO<a name='868'>
                  else if(tmn(i,j).gt.170. .and. tmn(i,j).lt.400.)then<a name='869'>
                     DO l = 1 , num_soil_layers<a name='870'>
                        tslb(i,l,j)=tmn(i,j)<a name='871'>
                     END DO<a name='872'>
                  else<a name='873'>
                     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_414"> ( 'TSLB unreasonable' )<a name='874'>
                  endif<a name='875'>
            END IF<a name='876'>
         END DO<a name='877'>
      END DO<a name='878'>
<a name='879'>
      <font color=#447700>!  Let us make sure (again) that the landmask and the veg/soil categories match.<a name='880'></font>
<a name='881'>
oops1=0<a name='882'>
oops2=0<a name='883'>
      DO j = jts, MIN(jde-1,jte)<a name='884'>
         DO i = its, MIN(ide-1,ite)<a name='885'>
            IF ( ( ( landmask(i,j) .LT. 0.5 ) .AND. ( ivgtyp(i,j) .NE. iswater .OR. isltyp(i,j) .NE. 14 ) ) .OR. &amp;<a name='886'>
                 ( ( landmask(i,j) .GT. 0.5 ) .AND. ( ivgtyp(i,j) .EQ. iswater .OR. isltyp(i,j) .EQ. 14 ) ) ) THEN<a name='887'>
               IF ( tslb(i,1,j) .GT. 1. ) THEN<a name='888'>
oops1=oops1+1<a name='889'>
                  ivgtyp(i,j) = 5<a name='890'>
                  isltyp(i,j) = 8<a name='891'>
                  landmask(i,j) = 1<a name='892'>
                  xland(i,j) = 1<a name='893'>
               ELSE IF ( sst(i,j) .GT. 1. ) THEN<a name='894'>
oops2=oops2+1<a name='895'>
                  ivgtyp(i,j) = iswater<a name='896'>
                  isltyp(i,j) = 14<a name='897'>
                  landmask(i,j) = 0<a name='898'>
                  xland(i,j) = 2<a name='899'>
               ELSE<a name='900'>
                  print *,'the landmask and soil/veg cats do not match'<a name='901'>
                  print *,'i,j=',i,j<a name='902'>
                  print *,'landmask=',landmask(i,j)<a name='903'>
                  print *,'ivgtyp=',ivgtyp(i,j)<a name='904'>
                  print *,'isltyp=',isltyp(i,j)<a name='905'>
                  print *,'iswater=', iswater<a name='906'>
                  print *,'tslb=',tslb(i,:,j)<a name='907'>
                  print *,'sst=',sst(i,j)<a name='908'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/main/nup_em.F.html#CHECK_CONSISTENCY2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_415"> ( 'mismatch_landmask_ivgtyp' )<a name='909'>
               END IF<a name='910'>
            END IF<a name='911'>
         END DO<a name='912'>
      END DO<a name='913'>
if (oops1.gt.0) then<a name='914'>
print *,'points artificially set to land : ',oops1<a name='915'>
endif<a name='916'>
if(oops2.gt.0) then<a name='917'>
print *,'points artificially set to water: ',oops2<a name='918'>
endif<a name='919'>
<a name='920'>
END SUBROUTINE check_consistency2<a name='921'>
</pre></body></html>