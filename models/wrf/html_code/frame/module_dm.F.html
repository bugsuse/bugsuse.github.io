<HTML> <BODY BGCOLOR=#eeddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2'></font>
<font color=#447700>!!                  W A R N I N G<a name='3'></font>
<font color=#447700>!!<a name='4'></font>
<font color=#447700>!!  This is a temporary version of module_dm.F<a name='5'></font>
<font color=#447700>!!  It has been compied from somewhere else<a name='6'></font>
<font color=#447700>!!  (If not DM_PARALLEL then this is module_dm_stubs.F;<a name='7'></font>
<font color=#447700>!!  otherwise, it is from one of the external package<a name='8'></font>
<font color=#447700>!!  directories.)<a name='9'></font>
<font color=#447700>!!<a name='10'></font>
<font color=#447700>!!                B E   A D V I S E D<a name='11'></font>
<font color=#447700>!!<a name='12'></font>
<font color=#447700>!!  Changes to this file are liable to be LOST.<a name='13'></font>
<font color=#447700>!!<a name='14'></font>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='15'></font>
<font color=#447700>! sed -e "s/grid%mu/gridmu/g" -e "s/grid%Mu/gridMu/g" module_dm.F | cpp -DDM_PARALLEL=1 -DHYBRID_COORD=1 -DEM_CORE=1 | sed -e "s/gridmu/grid%mu/g" -e "s/gridMu/grid%Mu/g" &gt; module_dm.next<a name='16'></font>
#if ( HYBRID_COORD==1 )<a name='17'>
#  define gridmu_2(...) (ngrid%c1h(k)*XXPC2HXX(__VA_ARGS__))<a name='18'>
#  define XXPC2HXX(...) grid%mu_2(__VA_ARGS__)<a name='19'>
<a name='20'>
#  define gridmub(...) (ngrid%c1h(k)*XXPCBHXX(__VA_ARGS__)+ngrid%c2h(k))<a name='21'>
#  define XXPCBHXX(...) grid%mub(__VA_ARGS__)<a name='22'>
<a name='23'>
#  define gridMu_2(...) (ngrid%c1f(k)*XXPC2FXX(__VA_ARGS__))<a name='24'>
#  define XXPC2FXX(...) grid%Mu_2(__VA_ARGS__)<a name='25'>
<a name='26'>
#  define gridMub(...) (ngrid%c1f(k)*XXPCBFXX(__VA_ARGS__)+ngrid%c2f(k))<a name='27'>
#  define XXPCBFXX(...) grid%Mub(__VA_ARGS__)<a name='28'>
#endif<a name='29'>
<a name='30'>
#if NMM_CORE==1<a name='31'>
#define copy_fcnm UpNear<a name='32'>
#define copy_fcn UpCopy<a name='33'>
#define interp_fcn DownCopy<a name='34'>
#define copy_fcni UpINear<a name='35'>
#endif<a name='36'>
<a name='37'>
#define NEST_FULL_INFLUENCE(A,B) A=B<a name='38'>
<A NAME='MODULE_DM'><A href='../../html_code/frame/module_dm.F.html#MODULE_DM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='39'>
<font color=#993300>MODULE </font><font color=#cc0000>module_dm</font> <A href='../../call_to/MODULE_DM.html' TARGET='index'>202</A><a name='40'>
<a name='41'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_7"><a name='42'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_19"><a name='43'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_23"><a name='44'>
<font color=#447700>!   USE module_comm_dm<a name='45'></font>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='46'></font>
   USE <A href='../../html_code/frame/module_cpl.F.html#MODULE_CPL'>module_cpl</A><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CPL_2">, ONLY : coupler_on, cpl_init<a name='47'>
#endif<a name='48'>
<a name='49'>
   IMPLICIT NONE<a name='50'>
#ifndef STUBMPI<a name='51'>
   INCLUDE 'mpif.h'<a name='52'>
#else<a name='53'>
   INTEGER, PARAMETER :: MPI_UNDEFINED = -1<a name='54'>
#endif<a name='55'>
<a name='56'>
#if ( NMM_CORE == 1 ) || ( WRF_CHEM == 1 ) <a name='57'>
   INTEGER, PARAMETER :: max_halo_width = 6<a name='58'>
#else<a name='59'>
   INTEGER, PARAMETER :: max_halo_width = 6 <font color=#447700>! 5<a name='60'></font>
#endif<a name='61'>
<a name='62'>
   INTEGER :: ips_save, ipe_save, jps_save, jpe_save, itrace<a name='63'>
   INTEGER :: lats_to_mic, minx, miny<a name='64'>
<a name='65'>
   INTEGER :: communicator_stack_cursor = 0<a name='66'>
   INTEGER :: current_id  = 1<a name='67'>
   INTEGER, DIMENSION(max_domains) ::  ntasks_stack, ntasks_y_stack          &amp;<a name='68'>
                                     , ntasks_x_stack, mytask_stack          &amp;<a name='69'>
                                     , mytask_x_stack, mytask_y_stack        &amp;<a name='70'>
                                     , id_stack                            <a name='71'>
   INTEGER, DIMENSION(max_domains) ::  ntasks_store, ntasks_y_store          &amp;<a name='72'>
                                     , ntasks_x_store, mytask_store          &amp;<a name='73'>
                                     , mytask_x_store, mytask_y_store      <a name='74'>
   INTEGER ntasks, ntasks_y, ntasks_x, mytask, mytask_x, mytask_y<a name='75'>
<a name='76'>
   INTEGER, DIMENSION(max_domains) :: local_communicator_stack, local_communicator_periodic_stack &amp;<a name='77'>
                                     ,local_iocommunicator_stack                                  &amp;<a name='78'>
                                     ,local_communicator_x_stack, local_communicator_y_stack<a name='79'>
   INTEGER, DIMENSION(max_domains) :: local_communicator_store, local_communicator_periodic_store &amp;<a name='80'>
                                     ,local_iocommunicator_store                                  &amp;<a name='81'>
                                     ,local_communicator_x_store, local_communicator_y_store<a name='82'>
<a name='83'>
   INTEGER :: mpi_comm_allcompute         = MPI_UNDEFINED<a name='84'>
   INTEGER :: local_communicator          = MPI_UNDEFINED<a name='85'>
   INTEGER :: local_communicator_periodic = MPI_UNDEFINED<a name='86'>
   INTEGER :: local_iocommunicator        = MPI_UNDEFINED<a name='87'>
   INTEGER :: local_communicator_x        = MPI_UNDEFINED<a name='88'>
   INTEGER :: local_communicator_y        = MPI_UNDEFINED <font color=#447700>! subcommunicators for rows and cols of mesh<a name='89'></font>
   INTEGER :: local_quilt_comm            = MPI_UNDEFINED <font color=#447700>! added 20151212 jm<a name='90'></font>
   LOGICAL :: dm_debug_flag = .FALSE.<a name='91'>
<font color=#447700>! for parallel nesting, 201408, jm<a name='92'></font>
   INTEGER intercomm_to_mom( max_domains ), intercomm_to_kid( max_nests, max_domains )<a name='93'>
   INTEGER mpi_comm_to_mom( max_domains ), mpi_comm_to_kid( max_nests, max_domains )<a name='94'>
   INTEGER which_kid(max_domains), nkids(max_domains)<a name='95'>
   INTEGER nest_task_offsets(max_domains)<a name='96'>
   LOGICAL intercomm_active( max_domains )<a name='97'>
   LOGICAL domain_active_this_task( max_domains )<a name='98'>
<font color=#447700>! see comments below (search for "Communicator definition")<a name='99'></font>
   INTEGER tasks_per_split<a name='100'>
   INTEGER comm_start(max_domains)   <font color=#447700>! set in dm_task_split<a name='101'></font>
<font color=#447700>!   INTEGER comm_pes  (max_domains)   ! either this may be set in dm_task_split<a name='102'></font>
<font color=#447700>!   INTEGER comm_pes_x(max_domains)   ! or these may be set in dm_task_split<a name='103'></font>
<font color=#447700>!   INTEGER comm_pes_y(max_domains)   ! "    "   may be set in dm_task_split<a name='104'></font>
<font color=#447700>!   INTEGER comm_domain(max_domains)  ! set in dm_task_split<a name='105'></font>
   INTEGER nest_pes_x(max_domains)   <font color=#447700>! set in dm_task_split<a name='106'></font>
   INTEGER nest_pes_y(max_domains)   <font color=#447700>! set in dm_task_split<a name='107'></font>
   INTEGER comms_i_am_in (max_domains)  <font color=#447700>! list of local communicators this task is a member of<a name='108'></font>
   INTEGER loc_comm(max_domains)<a name='109'>
   LOGICAL poll_servers<a name='110'>
   INTEGER nio_tasks_per_group(max_domains), nio_groups, num_io_tasks<a name='111'>
   NAMELIST /dm_task_split/ tasks_per_split, comm_start, nest_pes_x, nest_pes_y<a name='112'>
   NAMELIST /namelist_quilt/ nio_tasks_per_group, nio_groups, poll_servers<a name='113'>
<a name='114'>
<a name='115'>
#if (DA_CORE == 1)<a name='116'>
   integer :: c_ipsy, c_ipey, c_kpsy, c_kpey, c_kpsx, c_kpex, c_ipex, c_ipsx, c_jpex, c_jpsx, c_jpey, c_jpsy <a name='117'>
   integer :: c_imsy, c_imey, c_kmsy, c_kmey, c_kmsx, c_kmex, c_imex, c_imsx, c_jmex, c_jmsx, c_jmey, c_jmsy <a name='118'>
   integer :: k <a name='119'>
#endif<a name='120'>
<a name='121'>
<A NAME='WRF_DM_MAXVAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='122'>
   <font color=#993300>INTERFACE </font><font color=#cc0000>wrf_dm_maxval</font> <A href='../../call_to/WRF_DM_MAXVAL.html' TARGET='index'>12</A><a name='123'>
#if ( defined(PROMOTE_FLOAT) || ( RWORDSIZE == DWORDSIZE ) )<a name='124'>
     MODULE PROCEDURE <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_REAL'>wrf_dm_maxval_real</A><A NAME="WRF_DM_MAXVAL_REAL_8"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_INTEGER'>wrf_dm_maxval_integer</A><A NAME="WRF_DM_MAXVAL_INTEGER_5"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='125'>
#else<a name='126'>
     MODULE PROCEDURE <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_REAL'>wrf_dm_maxval_real</A><A NAME="WRF_DM_MAXVAL_REAL_9"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_INTEGER'>wrf_dm_maxval_integer</A><A NAME="WRF_DM_MAXVAL_INTEGER_6"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_DOUBLEPRECISION'>wrf_dm_maxval_doubleprecision</A><A NAME="WRF_DM_MAXVAL_DOUBLEPRECISION_1"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='127'>
#endif<a name='128'>
   END INTERFACE<a name='129'>
<a name='130'>
<A NAME='WRF_DM_MINVAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='131'>
   <font color=#993300>INTERFACE </font><font color=#cc0000>wrf_dm_minval</font>                       <font color=#447700>! gopal's doing <A href='../../call_to/WRF_DM_MINVAL.html' TARGET='index'>4</A><a name='132'></font>
#if ( defined(PROMOTE_FLOAT) || ( RWORDSIZE == DWORDSIZE ) )<a name='133'>
     MODULE PROCEDURE <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_REAL'>wrf_dm_minval_real</A><A NAME="WRF_DM_MINVAL_REAL_9"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_INTEGER'>wrf_dm_minval_integer</A><A NAME="WRF_DM_MINVAL_INTEGER_1"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='134'>
#else<a name='135'>
     MODULE PROCEDURE <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_REAL'>wrf_dm_minval_real</A><A NAME="WRF_DM_MINVAL_REAL_10"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_INTEGER'>wrf_dm_minval_integer</A><A NAME="WRF_DM_MINVAL_INTEGER_2"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_DOUBLEPRECISION'>wrf_dm_minval_doubleprecision</A><A NAME="WRF_DM_MINVAL_DOUBLEPRECISION_1"><A href='../../html_code/frame/module_dm.F.html#module_dm.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='136'>
#endif<a name='137'>
   END INTERFACE<a name='138'>
<a name='139'>
CONTAINS<a name='140'>
<a name='141'>
<A NAME='MPASPECT'><A href='../../html_code/frame/module_dm.F.html#MPASPECT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='142'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>MPASPECT</font>( P, MINM, MINN, PROCMIN_M, PROCMIN_N ) <A href='../../call_to/MPASPECT.html' TARGET='index'>1</A>,<A href='../../call_from/MPASPECT.html' TARGET='index'>7</A><a name='143'>
      IMPLICIT NONE<a name='144'>
      INTEGER P, M, N, MINI, MINM, MINN, PROCMIN_M, PROCMIN_N<a name='145'>
      MINI = 2*P<a name='146'>
      MINM = 1<a name='147'>
      MINN = P<a name='148'>
      DO M = 1, P<a name='149'>
        IF ( MOD( P, M ) .EQ. 0 ) THEN<a name='150'>
          N = P / M<a name='151'>
          IF ( ABS(M-N) .LT. MINI                &amp;<a name='152'>
               .AND. M .GE. PROCMIN_M            &amp;<a name='153'>
               .AND. N .GE. PROCMIN_N            &amp;<a name='154'>
             ) THEN<a name='155'>
            MINI = ABS(M-N)<a name='156'>
            MINM = M<a name='157'>
            MINN = N<a name='158'>
          END IF<a name='159'>
        END IF<a name='160'>
      END DO<a name='161'>
      IF ( MINM .LT. PROCMIN_M .OR. MINN .LT. PROCMIN_N ) THEN<a name='162'>
        WRITE( wrf_err_message , * )'MPASPECT: UNABLE TO GENERATE PROCESSOR MESH.  STOPPING.'<a name='163'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#MPASPECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_297"> ( TRIM ( wrf_err_message ) )<a name='164'>
        WRITE( wrf_err_message , * )' PROCMIN_M ', PROCMIN_M<a name='165'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#MPASPECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_298"> ( TRIM ( wrf_err_message ) )<a name='166'>
        WRITE( wrf_err_message , * )' PROCMIN_N ', PROCMIN_N<a name='167'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#MPASPECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_299"> ( TRIM ( wrf_err_message ) )<a name='168'>
        WRITE( wrf_err_message , * )' P         ', P<a name='169'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#MPASPECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_300"> ( TRIM ( wrf_err_message ) )<a name='170'>
        WRITE( wrf_err_message , * )' MINM      ', MINM<a name='171'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#MPASPECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_301"> ( TRIM ( wrf_err_message ) )<a name='172'>
        WRITE( wrf_err_message , * )' MINN      ', MINN<a name='173'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#MPASPECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_302"> ( TRIM ( wrf_err_message ) )<a name='174'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#MPASPECT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_174"> ( 'module_dm: mpaspect' )<a name='175'>
      END IF<a name='176'>
   RETURN<a name='177'>
   END SUBROUTINE MPASPECT<a name='178'>
<a name='179'>
<A NAME='COMPUTE_MESH'><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MESH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='180'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>compute_mesh</font>( ntasks , ntasks_x, ntasks_y ) <A href='../../call_to/COMPUTE_MESH.html' TARGET='index'>4</A>,<A href='../../call_from/COMPUTE_MESH.html' TARGET='index'>3</A><a name='181'>
     IMPLICIT NONE<a name='182'>
     INTEGER, INTENT(IN)  :: ntasks<a name='183'>
     INTEGER, INTENT(OUT) :: ntasks_x, ntasks_y<a name='184'>
     INTEGER lats_to_mic<a name='185'>
     CALL nl_get_nproc_x ( 1, ntasks_x )<a name='186'>
     CALL nl_get_nproc_y ( 1, ntasks_y )<a name='187'>
#ifndef NMM_CORE<a name='188'>
     CALL nl_get_lats_to_mic ( 1, lats_to_mic )<a name='189'>
#endif<a name='190'>
<font color=#447700>! check if user has specified in the namelist<a name='191'></font>
     IF ( ntasks_x .GT. 0 .OR. ntasks_y .GT. 0 ) THEN<a name='192'>
       <font color=#447700>! if only ntasks_x is specified then make it 1-d decomp in i<a name='193'></font>
       IF      ( ntasks_x .GT. 0 .AND. ntasks_y .EQ. -1 ) THEN<a name='194'>
         ntasks_y = ntasks / ntasks_x<a name='195'>
       <font color=#447700>! if only ntasks_y is specified then make it 1-d decomp in j<a name='196'></font>
       ELSE IF ( ntasks_x .EQ. -1 .AND. ntasks_y .GT. 0 ) THEN<a name='197'>
         ntasks_x = ntasks / ntasks_y<a name='198'>
       END IF<a name='199'>
       <font color=#447700>! make sure user knows what they're doing<a name='200'></font>
       IF ( ntasks_x * ntasks_y .NE. ntasks ) THEN<a name='201'>
         WRITE( wrf_err_message , * )'WRF_DM_INITIALIZE (RSL_LITE): nproc_x * nproc_y in namelist ne ',ntasks<a name='202'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MESH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_175"> ( wrf_err_message )<a name='203'>
       END IF<a name='204'>
#ifndef NMM_CORE<a name='205'>
     ELSE IF ( lats_to_mic .GT. 0 ) THEN<a name='206'>
       ntasks_x = ntasks / 2<a name='207'>
       ntasks_y = 2<a name='208'>
       IF ( ntasks_x * ntasks_y .NE. ntasks ) THEN<a name='209'>
         WRITE( wrf_err_message , * )&amp;<a name='210'>
           'WRF_DM_INITIALIZE (lats_to_mic &gt; 0) nproc_x (',ntasks_x,')* nproc_y (',ntasks_y,&amp;<a name='211'>
           ') in namelist ne ',ntasks<a name='212'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MESH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_176"> ( wrf_err_message )<a name='213'>
       END IF<a name='214'>
#endif<a name='215'>
     ELSE<a name='216'>
       <font color=#447700>! When neither is specified, work out mesh with MPASPECT<a name='217'></font>
       <font color=#447700>! Pass nproc_ln and nproc_nt so that number of procs in<a name='218'></font>
       <font color=#447700>! i-dim (nproc_ln) is equal or lesser.<a name='219'></font>
       CALL <A href='../../html_code/frame/module_dm.F.html#MPASPECT'>mpaspect</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MESH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MPASPECT_1"> ( ntasks, ntasks_x, ntasks_y, 1, 1 )<a name='220'>
     END IF<a name='221'>
     ntasks_store(1) = ntasks<a name='222'>
     ntasks_x_store(1) = ntasks_x<a name='223'>
     ntasks_y_store(1) = ntasks_y<a name='224'>
   END SUBROUTINE compute_mesh<a name='225'>
<a name='226'>
<A NAME='WRF_DM_INITIALIZE'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_INITIALIZE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='227'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_initialize</font> <A href='../../call_to/WRF_DM_INITIALIZE.html' TARGET='index'>9</A>,<A href='../../call_from/WRF_DM_INITIALIZE.html' TARGET='index'>3</A><a name='228'>
      IMPLICIT NONE<a name='229'>
#ifndef STUBMPI<a name='230'>
      INTEGER :: local_comm_per, local_comm_x, local_comm_y, local_comm2, new_local_comm, group, newgroup, p, p1, ierr,itmp<a name='231'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: ranks<a name='232'>
      INTEGER comdup<a name='233'>
      INTEGER, DIMENSION(2) :: dims, coords<a name='234'>
      LOGICAL, DIMENSION(2) :: isperiodic<a name='235'>
      LOGICAL :: reorder_mesh<a name='236'>
<a name='237'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#INSTATE_COMMUNICATORS_FOR_DOMAIN'>instate_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_INITIALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INSTATE_COMMUNICATORS_FOR_DOMAIN_1">(1)<a name='238'>
<a name='239'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_INITIALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_9"> ( new_local_comm )<a name='240'>
      dims(1) = nest_pes_y(1)  <font color=#447700>! rows<a name='241'></font>
      dims(2) = nest_pes_x(1)  <font color=#447700>! columns<a name='242'></font>
      isperiodic(1) = .true.<a name='243'>
      isperiodic(2) = .true.<a name='244'>
      CALL mpi_cart_create( new_local_comm, 2, dims, isperiodic, .false., local_comm_per, ierr )<a name='245'>
      local_communicator_periodic_store(1) = local_comm_per<a name='246'>
<font color=#447700>! set all the domains' periodic communicators to this one &lt;- kludge, 20151223, splitting domains won't work for period bc's<a name='247'></font>
      local_communicator_periodic_store = local_comm_per<a name='248'>
      local_communicator_periodic = local_comm_per<a name='249'>
<a name='250'>
#else<a name='251'>
      ntasks = 1<a name='252'>
      ntasks_x = 1<a name='253'>
      ntasks_y = 1<a name='254'>
      mytask = 0<a name='255'>
      mytask_x = 0<a name='256'>
      mytask_y = 0<a name='257'>
      nest_pes_x = 1<a name='258'>
      nest_pes_y = 1<a name='259'>
      intercomm_active = .TRUE.<a name='260'>
      domain_active_this_task = .TRUE.<a name='261'>
#endif<a name='262'>
      CALL nl_set_nproc_x ( 1, ntasks_x )<a name='263'>
      CALL nl_set_nproc_y ( 1, ntasks_y )<a name='264'>
      WRITE( wrf_err_message , * )'Ntasks in X ',ntasks_x,', ntasks in Y ',ntasks_y<a name='265'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_INITIALIZE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_303">( wrf_err_message )<a name='266'>
      RETURN<a name='267'>
   END SUBROUTINE wrf_dm_initialize<a name='268'>
<a name='269'>
<A NAME='GET_DM_MAX_HALO_WIDTH'><A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='270'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_dm_max_halo_width</font>( id, width ) <A href='../../call_to/GET_DM_MAX_HALO_WIDTH.html' TARGET='index'>11</A><a name='271'>
     IMPLICIT NONE<a name='272'>
     INTEGER, INTENT(IN) :: id<a name='273'>
     INTEGER, INTENT(OUT) :: width<a name='274'>
     IF ( id .EQ. 1 ) THEN   <font color=#447700>! this is coarse domain<a name='275'></font>
       width = max_halo_width<a name='276'>
     ELSE<a name='277'>
       width = max_halo_width + 3<a name='278'>
     END IF<a name='279'>
     RETURN<a name='280'>
   END SUBROUTINE get_dm_max_halo_width<a name='281'>
<a name='282'>
<A NAME='PATCH_DOMAIN_RSL_LITE'><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='283'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>patch_domain_rsl_lite</font>( id  , parent, parent_id, &amp; <A href='../../call_to/PATCH_DOMAIN_RSL_LITE.html' TARGET='index'>1</A>,<A href='../../call_from/PATCH_DOMAIN_RSL_LITE.html' TARGET='index'>31</A><a name='284'>
                                sd1 , ed1 , sp1 , ep1 , sm1 , em1 ,        &amp;<a name='285'>
                                sd2 , ed2 , sp2 , ep2 , sm2 , em2 ,        &amp;<a name='286'>
                                sd3 , ed3 , sp3 , ep3 , sm3 , em3 ,        &amp;<a name='287'>
                                      sp1x , ep1x , sm1x , em1x , &amp;<a name='288'>
                                      sp2x , ep2x , sm2x , em2x , &amp;<a name='289'>
                                      sp3x , ep3x , sm3x , em3x , &amp;<a name='290'>
                                      sp1y , ep1y , sm1y , em1y , &amp;<a name='291'>
                                      sp2y , ep2y , sm2y , em2y , &amp;<a name='292'>
                                      sp3y , ep3y , sm3y , em3y , &amp;<a name='293'>
                                bdx , bdy )<a name='294'>
<a name='295'>
#if ( ( defined(SGIALTIX) || defined(FUJITSU_FX10) || defined(KEEP_INT_AROUND) ) &amp;&amp; (<font color=#447700>! defined(MOVE_NESTS) ) )<a name='296'></font>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_104">, ONLY : domain, head_grid, find_grid_by_id, alloc_space_field<a name='297'>
#else<a name='298'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_105">, ONLY : domain, head_grid, find_grid_by_id<a name='299'>
#endif<a name='300'>
<a name='301'>
      IMPLICIT NONE<a name='302'>
      INTEGER, INTENT(IN)   :: sd1 , ed1 , sd2 , ed2 , sd3 , ed3 , bdx , bdy<a name='303'>
      INTEGER, INTENT(OUT)  :: sp1 , ep1 , sp2 , ep2 , sp3 , ep3 , &amp;<a name='304'>
                               sm1 , em1 , sm2 , em2 , sm3 , em3<a name='305'>
      INTEGER, INTENT(OUT)  :: sp1x , ep1x , sp2x , ep2x , sp3x , ep3x , &amp;<a name='306'>
                               sm1x , em1x , sm2x , em2x , sm3x , em3x<a name='307'>
      INTEGER, INTENT(OUT)  :: sp1y , ep1y , sp2y , ep2y , sp3y , ep3y , &amp;<a name='308'>
                               sm1y , em1y , sm2y , em2y , sm3y , em3y<a name='309'>
      INTEGER, INTENT(IN)   :: id, parent_id<a name='310'>
      TYPE(domain),POINTER  :: parent<a name='311'>
<a name='312'>
<font color=#447700>! Local variables<a name='313'></font>
      INTEGER               :: ids, ide, jds, jde, kds, kde<a name='314'>
      INTEGER               :: ims, ime, jms, jme, kms, kme<a name='315'>
      INTEGER               :: ips, ipe, jps, jpe, kps, kpe<a name='316'>
      INTEGER               :: imsx, imex, jmsx, jmex, kmsx, kmex<a name='317'>
      INTEGER               :: ipsx, ipex, jpsx, jpex, kpsx, kpex<a name='318'>
      INTEGER               :: imsy, imey, jmsy, jmey, kmsy, kmey<a name='319'>
      INTEGER               :: ipsy, ipey, jpsy, jpey, kpsy, kpey<a name='320'>
<a name='321'>
      INTEGER               :: c_sd1 , c_ed1 , c_sd2 , c_ed2 , c_sd3 , c_ed3<a name='322'>
      INTEGER               :: c_sp1 , c_ep1 , c_sp2 , c_ep2 , c_sp3 , c_ep3 , &amp;<a name='323'>
                               c_sm1 , c_em1 , c_sm2 , c_em2 , c_sm3 , c_em3<a name='324'>
      INTEGER               :: c_sp1x , c_ep1x , c_sp2x , c_ep2x , c_sp3x , c_ep3x , &amp;<a name='325'>
                               c_sm1x , c_em1x , c_sm2x , c_em2x , c_sm3x , c_em3x<a name='326'>
      INTEGER               :: c_sp1y , c_ep1y , c_sp2y , c_ep2y , c_sp3y , c_ep3y , &amp;<a name='327'>
                               c_sm1y , c_em1y , c_sm2y , c_em2y , c_sm3y , c_em3y<a name='328'>
<a name='329'>
      INTEGER               :: c_ids, c_ide, c_jds, c_jde, c_kds, c_kde<a name='330'>
      INTEGER               :: c_ims, c_ime, c_jms, c_jme, c_kms, c_kme<a name='331'>
      INTEGER               :: c_ips, c_ipe, c_jps, c_jpe, c_kps, c_kpe<a name='332'>
<a name='333'>
      INTEGER               :: idim , jdim , kdim , rem , a, b<a name='334'>
      INTEGER               :: i, j, ni, nj, Px, Py, P<a name='335'>
<a name='336'>
      INTEGER               :: parent_grid_ratio, i_parent_start, j_parent_start<a name='337'>
      INTEGER               :: shw<a name='338'>
      INTEGER               :: idim_cd, jdim_cd, ierr<a name='339'>
      INTEGER               :: max_dom<a name='340'>
<a name='341'>
#if (DA_CORE == 1)<a name='342'>
      INTEGER               :: e_we, e_sn <a name='343'>
#endif<a name='344'>
<a name='345'>
      TYPE(domain), POINTER :: intermediate_grid<a name='346'>
      TYPE(domain), POINTER  :: nest_grid<a name='347'>
      CHARACTER*256   :: mess<a name='348'>
<a name='349'>
      INTEGER parent_max_halo_width<a name='350'>
      INTEGER thisdomain_max_halo_width<a name='351'>
      INTEGER lats_to_mic<a name='352'>
<a name='353'>
     lats_to_mic=0<a name='354'>
#ifndef NMM_CORE<a name='355'>
     CALL nl_get_lats_to_mic( 1, lats_to_mic )<a name='356'>
#endif<a name='357'>
      IF ( lats_to_mic .GT. 0 ) THEN<a name='358'>
        minx = -99  <font color=#447700>! code to task_for_point to do split decomposition over MIC and host<a name='359'></font>
        miny = lats_to_mic  <font color=#447700>! number of latitudes that should be assigned to MIC<a name='360'></font>
      ELSE<a name='361'>
        minx = 1   <font color=#447700>! normal<a name='362'></font>
        miny = 1   <font color=#447700>! normal<a name='363'></font>
      END IF<a name='364'>
<a name='365'>
<a name='366'>
<a name='367'>
      SELECT CASE ( model_data_order )<a name='368'>
         <font color=#447700>! need to finish other cases<a name='369'></font>
         CASE ( DATA_ORDER_ZXY )<a name='370'>
            ids = sd2 ; ide = ed2 <a name='371'>
            jds = sd3 ; jde = ed3 <a name='372'>
            kds = sd1 ; kde = ed1 <a name='373'>
         CASE ( DATA_ORDER_XYZ )<a name='374'>
            ids = sd1 ; ide = ed1 <a name='375'>
            jds = sd2 ; jde = ed2 <a name='376'>
            kds = sd3 ; kde = ed3 <a name='377'>
         CASE ( DATA_ORDER_XZY )<a name='378'>
            ids = sd1 ; ide = ed1 <a name='379'>
            jds = sd3 ; jde = ed3 <a name='380'>
            kds = sd2 ; kde = ed2 <a name='381'>
         CASE ( DATA_ORDER_YXZ)<a name='382'>
            ids = sd2 ; ide = ed2 <a name='383'>
            jds = sd1 ; jde = ed1 <a name='384'>
            kds = sd3 ; kde = ed3 <a name='385'>
      END SELECT<a name='386'>
<a name='387'>
      CALL nl_get_max_dom( 1 , max_dom )<a name='388'>
<a name='389'>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_1">( id , thisdomain_max_halo_width )<a name='390'>
      IF ( id .GT. 1 ) THEN<a name='391'>
        CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_2">( parent%id , parent_max_halo_width )<a name='392'>
      END IF<a name='393'>
<a name='394'>
      CALL <A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE'>compute_memory_dims_rsl_lite</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_MEMORY_DIMS_RSL_LITE_1"> ( id, thisdomain_max_halo_width, 0 , bdx, bdy,   &amp;<a name='395'>
                   ids,  ide,  jds,  jde,  kds,  kde, &amp;<a name='396'>
                   ims,  ime,  jms,  jme,  kms,  kme, &amp;<a name='397'>
                   imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='398'>
                   imsy, imey, jmsy, jmey, kmsy, kmey, &amp;<a name='399'>
                   ips,  ipe,  jps,  jpe,  kps,  kpe, &amp;<a name='400'>
                   ipsx, ipex, jpsx, jpex, kpsx, kpex, &amp;<a name='401'>
                   ipsy, ipey, jpsy, jpey, kpsy, kpey )<a name='402'>
<a name='403'>
     <font color=#447700>! ensure that the every parent domain point has a full set of nested points under it<a name='404'></font>
     <font color=#447700>! even at the borders. Do this by making sure the number of nest points is a multiple of<a name='405'></font>
     <font color=#447700>! the nesting ratio. Note that this is important mostly to the intermediate domain, which<a name='406'></font>
     <font color=#447700>! is the subject of the scatter gather comms with the parent<a name='407'></font>
<a name='408'>
      IF ( id .GT. 1 ) THEN<a name='409'>
         CALL nl_get_parent_grid_ratio( id, parent_grid_ratio )<a name='410'>
         if ( mod(ime,parent_grid_ratio) .NE. 0 ) ime = ime + parent_grid_ratio - mod(ime,parent_grid_ratio)<a name='411'>
         if ( mod(jme,parent_grid_ratio) .NE. 0 ) jme = jme + parent_grid_ratio - mod(jme,parent_grid_ratio)<a name='412'>
      END IF<a name='413'>
<a name='414'>
      SELECT CASE ( model_data_order )<a name='415'>
         CASE ( DATA_ORDER_ZXY )<a name='416'>
            sp2 = ips ; ep2 = ipe ; sm2 = ims ; em2 = ime<a name='417'>
            sp3 = jps ; ep3 = jpe ; sm3 = jms ; em3 = jme<a name='418'>
            sp1 = kps ; ep1 = kpe ; sm1 = kms ; em1 = kme<a name='419'>
            sp2x = ipsx ; ep2x = ipex ; sm2x = imsx ; em2x = imex<a name='420'>
            sp3x = jpsx ; ep3x = jpex ; sm3x = jmsx ; em3x = jmex<a name='421'>
            sp1x = kpsx ; ep1x = kpex ; sm1x = kmsx ; em1x = kmex<a name='422'>
            sp2y = ipsy ; ep2y = ipey ; sm2y = imsy ; em2y = imey<a name='423'>
            sp3y = jpsy ; ep3y = jpey ; sm3y = jmsy ; em3y = jmey<a name='424'>
            sp1y = kpsy ; ep1y = kpey ; sm1y = kmsy ; em1y = kmey<a name='425'>
         CASE ( DATA_ORDER_ZYX )<a name='426'>
            sp3 = ips ; ep3 = ipe ; sm3 = ims ; em3 = ime<a name='427'>
            sp2 = jps ; ep2 = jpe ; sm2 = jms ; em2 = jme<a name='428'>
            sp1 = kps ; ep1 = kpe ; sm1 = kms ; em1 = kme<a name='429'>
            sp3x = ipsx ; ep3x = ipex ; sm3x = imsx ; em3x = imex<a name='430'>
            sp2x = jpsx ; ep2x = jpex ; sm2x = jmsx ; em2x = jmex<a name='431'>
            sp1x = kpsx ; ep1x = kpex ; sm1x = kmsx ; em1x = kmex<a name='432'>
            sp3y = ipsy ; ep3y = ipey ; sm3y = imsy ; em3y = imey<a name='433'>
            sp2y = jpsy ; ep2y = jpey ; sm2y = jmsy ; em2y = jmey<a name='434'>
            sp1y = kpsy ; ep1y = kpey ; sm1y = kmsy ; em1y = kmey<a name='435'>
         CASE ( DATA_ORDER_XYZ )<a name='436'>
            sp1 = ips ; ep1 = ipe ; sm1 = ims ; em1 = ime<a name='437'>
            sp2 = jps ; ep2 = jpe ; sm2 = jms ; em2 = jme<a name='438'>
            sp3 = kps ; ep3 = kpe ; sm3 = kms ; em3 = kme<a name='439'>
            sp1x = ipsx ; ep1x = ipex ; sm1x = imsx ; em1x = imex<a name='440'>
            sp2x = jpsx ; ep2x = jpex ; sm2x = jmsx ; em2x = jmex<a name='441'>
            sp3x = kpsx ; ep3x = kpex ; sm3x = kmsx ; em3x = kmex<a name='442'>
            sp1y = ipsy ; ep1y = ipey ; sm1y = imsy ; em1y = imey<a name='443'>
            sp2y = jpsy ; ep2y = jpey ; sm2y = jmsy ; em2y = jmey<a name='444'>
            sp3y = kpsy ; ep3y = kpey ; sm3y = kmsy ; em3y = kmey<a name='445'>
         CASE ( DATA_ORDER_YXZ)<a name='446'>
            sp2 = ips ; ep2 = ipe ; sm2 = ims ; em2 = ime<a name='447'>
            sp1 = jps ; ep1 = jpe ; sm1 = jms ; em1 = jme<a name='448'>
            sp3 = kps ; ep3 = kpe ; sm3 = kms ; em3 = kme<a name='449'>
            sp2x = ipsx ; ep2x = ipex ; sm2x = imsx ; em2x = imex<a name='450'>
            sp1x = jpsx ; ep1x = jpex ; sm1x = jmsx ; em1x = jmex<a name='451'>
            sp3x = kpsx ; ep3x = kpex ; sm3x = kmsx ; em3x = kmex<a name='452'>
            sp2y = ipsy ; ep2y = ipey ; sm2y = imsy ; em2y = imey<a name='453'>
            sp1y = jpsy ; ep1y = jpey ; sm1y = jmsy ; em1y = jmey<a name='454'>
            sp3y = kpsy ; ep3y = kpey ; sm3y = kmsy ; em3y = kmey<a name='455'>
         CASE ( DATA_ORDER_XZY )<a name='456'>
            sp1 = ips ; ep1 = ipe ; sm1 = ims ; em1 = ime<a name='457'>
            sp3 = jps ; ep3 = jpe ; sm3 = jms ; em3 = jme<a name='458'>
            sp2 = kps ; ep2 = kpe ; sm2 = kms ; em2 = kme<a name='459'>
            sp1x = ipsx ; ep1x = ipex ; sm1x = imsx ; em1x = imex<a name='460'>
            sp3x = jpsx ; ep3x = jpex ; sm3x = jmsx ; em3x = jmex<a name='461'>
            sp2x = kpsx ; ep2x = kpex ; sm2x = kmsx ; em2x = kmex<a name='462'>
            sp1y = ipsy ; ep1y = ipey ; sm1y = imsy ; em1y = imey<a name='463'>
            sp3y = jpsy ; ep3y = jpey ; sm3y = jmsy ; em3y = jmey<a name='464'>
            sp2y = kpsy ; ep2y = kpey ; sm2y = kmsy ; em2y = kmey<a name='465'>
         CASE ( DATA_ORDER_YZX )<a name='466'>
            sp3 = ips ; ep3 = ipe ; sm3 = ims ; em3 = ime<a name='467'>
            sp1 = jps ; ep1 = jpe ; sm1 = jms ; em1 = jme<a name='468'>
            sp2 = kps ; ep2 = kpe ; sm2 = kms ; em2 = kme<a name='469'>
            sp3x = ipsx ; ep3x = ipex ; sm3x = imsx ; em3x = imex<a name='470'>
            sp1x = jpsx ; ep1x = jpex ; sm1x = jmsx ; em1x = jmex<a name='471'>
            sp2x = kpsx ; ep2x = kpex ; sm2x = kmsx ; em2x = kmex<a name='472'>
            sp3y = ipsy ; ep3y = ipey ; sm3y = imsy ; em3y = imey<a name='473'>
            sp1y = jpsy ; ep1y = jpey ; sm1y = jmsy ; em1y = jmey<a name='474'>
            sp2y = kpsy ; ep2y = kpey ; sm2y = kmsy ; em2y = kmey<a name='475'>
      END SELECT<a name='476'>
<a name='477'>
      IF ( id.EQ.1 ) THEN<a name='478'>
         WRITE(wrf_err_message,*)'*************************************'<a name='479'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_304">( TRIM(wrf_err_message) )<a name='480'>
         WRITE(wrf_err_message,*)'Parent domain'<a name='481'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_305">( TRIM(wrf_err_message) )<a name='482'>
         WRITE(wrf_err_message,*)'ids,ide,jds,jde ',ids,ide,jds,jde<a name='483'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_306">( TRIM(wrf_err_message) )<a name='484'>
         WRITE(wrf_err_message,*)'ims,ime,jms,jme ',ims,ime,jms,jme<a name='485'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_307">( TRIM(wrf_err_message) )<a name='486'>
         WRITE(wrf_err_message,*)'ips,ipe,jps,jpe ',ips,ipe,jps,jpe<a name='487'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_308">( TRIM(wrf_err_message) )<a name='488'>
         WRITE(wrf_err_message,*)'*************************************'<a name='489'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_309">( TRIM(wrf_err_message) )<a name='490'>
      END IF<a name='491'>
<a name='492'>
      IF ( id .GT. 1 ) THEN<a name='493'>
<a name='494'>
         CALL nl_get_shw( id, shw )<a name='495'>
         CALL nl_get_i_parent_start( id , i_parent_start )<a name='496'>
         CALL nl_get_j_parent_start( id , j_parent_start )<a name='497'>
         CALL nl_get_parent_grid_ratio( id, parent_grid_ratio )<a name='498'>
<a name='499'>
         SELECT CASE ( model_data_order )<a name='500'>
            CASE ( DATA_ORDER_ZXY )<a name='501'>
               idim = ed2-sd2+1<a name='502'>
               jdim = ed3-sd3+1<a name='503'>
               kdim = ed1-sd1+1<a name='504'>
               c_kds = sd1                ; c_kde = ed1<a name='505'>
            CASE ( DATA_ORDER_ZYX )<a name='506'>
               idim = ed3-sd3+1<a name='507'>
               jdim = ed2-sd2+1<a name='508'>
               kdim = ed1-sd1+1<a name='509'>
               c_kds = sd1                ; c_kde = ed1<a name='510'>
            CASE ( DATA_ORDER_XYZ )<a name='511'>
               idim = ed1-sd1+1<a name='512'>
               jdim = ed2-sd2+1<a name='513'>
               kdim = ed3-sd3+1<a name='514'>
               c_kds = sd3                ; c_kde = ed3<a name='515'>
            CASE ( DATA_ORDER_YXZ)<a name='516'>
               idim = ed2-sd2+1<a name='517'>
               jdim = ed1-sd1+1<a name='518'>
               kdim = ed3-sd3+1<a name='519'>
               c_kds = sd3                ; c_kde = ed3<a name='520'>
            CASE ( DATA_ORDER_XZY )<a name='521'>
               idim = ed1-sd1+1<a name='522'>
               jdim = ed3-sd3+1<a name='523'>
               kdim = ed2-sd2+1<a name='524'>
               c_kds = sd2                ; c_kde = ed2<a name='525'>
            CASE ( DATA_ORDER_YZX )<a name='526'>
               idim = ed3-sd3+1<a name='527'>
               jdim = ed1-sd1+1<a name='528'>
               kdim = ed2-sd2+1<a name='529'>
               c_kds = sd2                ; c_kde = ed2<a name='530'>
         END SELECT<a name='531'>
<a name='532'>
         idim_cd = idim / parent_grid_ratio + 1 + 2*shw + 1<a name='533'>
         jdim_cd = jdim / parent_grid_ratio + 1 + 2*shw + 1<a name='534'>
<a name='535'>
         c_ids = i_parent_start-shw ; c_ide = c_ids + idim_cd - 1<a name='536'>
         c_jds = j_parent_start-shw ; c_jde = c_jds + jdim_cd - 1<a name='537'>
<a name='538'>
#if (DA_CORE == 1)<a name='539'>
          call nl_get_e_we( id -1, e_we )<a name='540'>
          call nl_get_e_sn( id -1, e_sn )<a name='541'>
<a name='542'>
         if ( c_ids .le. 0   ) c_ids = 1<a name='543'>
         if ( c_ide .gt. e_we) c_ide = e_we<a name='544'>
         if ( c_jds .le. 0   ) c_jds = 1<a name='545'>
         if ( c_jde .gt. e_sn) c_jde = e_sn<a name='546'>
#endif<a name='547'>
         <font color=#447700>! we want the intermediate domain to be decomposed the<a name='548'></font>
         <font color=#447700>! the same as the underlying nest. So try this:<a name='549'></font>
<a name='550'>
         c_ips = -1<a name='551'>
         nj = ( c_jds - j_parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='552'>
         ierr = 0 <a name='553'>
         DO i = c_ids, c_ide<a name='554'>
            ni = ( i - i_parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='555'>
<font color=#447700>!jm            CALL task_for_point ( ni, nj, ids, ide, jds, jde, ntasks_x, ntasks_y, Px, Py, &amp;<a name='556'></font>
            CALL task_for_point ( ni, nj, ids, ide, jds, jde, nest_pes_x(id), nest_pes_y(id),Px,Py, &amp;<a name='557'>
                                  minx, miny,  ierr )<a name='558'>
            IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_177">('error code returned by task_for_point in module_dm.F (a)')<a name='559'>
            IF ( Px .EQ. mytask_x ) THEN<a name='560'>
               c_ipe = i<a name='561'>
               IF ( c_ips .EQ. -1 ) c_ips = i<a name='562'>
            END IF<a name='563'>
         END DO<a name='564'>
         IF ( ierr .NE. 0 ) THEN<a name='565'>
            CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_1">(__FILE__,__LINE__)<a name='566'>
         END IF<a name='567'>
         IF (c_ips .EQ. -1 ) THEN<a name='568'>
            c_ipe = -1<a name='569'>
            c_ips = 0<a name='570'>
         END IF<a name='571'>
<a name='572'>
         c_jps = -1<a name='573'>
         ni = ( c_ids - i_parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='574'>
         ierr = 0 <a name='575'>
         DO j = c_jds, c_jde<a name='576'>
            nj = ( j - j_parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='577'>
<font color=#447700>!            CALL task_for_point ( ni, nj, ids, ide, jds, jde, ntasks_x, ntasks_y, Px, Py, &amp;<a name='578'></font>
            CALL task_for_point ( ni, nj, ids, ide, jds, jde, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='579'>
                                  minx, miny, ierr )<a name='580'>
            IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_178">('error code returned by task_for_point in module_dm.F (b)')<a name='581'>
<a name='582'>
<a name='583'>
            IF ( Py .EQ. mytask_y ) THEN<a name='584'>
               c_jpe = j<a name='585'>
               IF ( c_jps .EQ. -1 ) c_jps = j<a name='586'>
            END IF<a name='587'>
         END DO<a name='588'>
         IF ( ierr .NE. 0 ) THEN<a name='589'>
            CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_2">(__FILE__,__LINE__)<a name='590'>
         END IF<a name='591'>
         IF (c_jps .EQ. -1 ) THEN<a name='592'>
            c_jpe = -1<a name='593'>
            c_jps = 0<a name='594'>
         END IF<a name='595'>
<a name='596'>
#if (DA_CORE == 1)<a name='597'>
         IF (c_ipe .EQ. -1 .or. c_jpe .EQ. -1) THEN<a name='598'>
            c_ipe = -1<a name='599'>
            c_ips = 0<a name='600'>
            c_jpe = -1<a name='601'>
            c_jps = 0<a name='602'>
         END IF<a name='603'>
<a name='604'>
<a name='605'>
          c_kpsx = -1<a name='606'>
          nj = ( c_jds - j_parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='607'>
          ierr = 0<a name='608'>
          DO k = c_kds, c_kde<a name='609'>
<font color=#447700>!             CALL task_for_point ( k, nj, kds, kde, jds, jde, ntasks_x, ntasks_y, Px, Py, &amp;<a name='610'></font>
             CALL task_for_point ( k, nj, kds, kde, jds, jde, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='611'>
                                   1, 1, ierr )<a name='612'>
             IF ( Px .EQ. mytask_x ) THEN<a name='613'>
                c_kpex = k<a name='614'>
                IF ( c_kpsx .EQ. -1 ) c_kpsx = k<a name='615'>
             END IF<a name='616'>
          END DO<a name='617'>
          IF ( ierr .NE. 0 ) THEN<a name='618'>
             CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_3">(__FILE__,__LINE__)<a name='619'>
          END IF<a name='620'>
          IF (c_kpsx .EQ. -1 ) THEN<a name='621'>
             c_kpex = -1<a name='622'>
             c_kpsx = 0<a name='623'>
          END IF<a name='624'>
<a name='625'>
          c_jpsx = -1<a name='626'>
          k = c_kds ;<a name='627'>
          ierr = 0<a name='628'>
          DO j = c_jds, c_jde<a name='629'>
             nj = ( j - j_parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='630'>
<font color=#447700>!             CALL task_for_point ( k, nj, kds, kde, jds, jde, ntasks_x, ntasks_y, Px, Py, &amp;<a name='631'></font>
             CALL task_for_point ( k, nj, kds, kde, jds, jde, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='632'>
                                   1, 1, ierr )<a name='633'>
             IF ( Py .EQ. mytask_y ) THEN<a name='634'>
                c_jpex = j<a name='635'>
                IF ( c_jpsx .EQ. -1 ) c_jpsx = j<a name='636'>
             END IF<a name='637'>
          END DO<a name='638'>
          IF ( ierr .NE. 0 ) THEN<a name='639'>
             CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_4">(__FILE__,__LINE__)<a name='640'>
          END IF<a name='641'>
          IF (c_jpsx .EQ. -1 ) THEN<a name='642'>
             c_jpex = -1<a name='643'>
             c_jpsx = 0<a name='644'>
          END IF<a name='645'>
<a name='646'>
          IF (c_ipex .EQ. -1 .or. c_jpex .EQ. -1) THEN<a name='647'>
             c_ipex = -1<a name='648'>
             c_ipsx = 0<a name='649'>
             c_jpex = -1<a name='650'>
             c_jpsx = 0<a name='651'>
          END IF<a name='652'>
<a name='653'>
          c_kpsy = c_kpsx   <font color=#447700>! same as above<a name='654'></font>
          c_kpey = c_kpex   <font color=#447700>! same as above<a name='655'></font>
<a name='656'>
          c_ipsy = -1<a name='657'>
          k = c_kds ;<a name='658'>
          ierr = 0<a name='659'>
          DO i = c_ids, c_ide<a name='660'>
             ni = ( i - i_parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='661'>
<font color=#447700>!             CALL task_for_point ( ni, k, ids, ide, kds, kde, ntasks_y, ntasks_x, Py, Px, &amp;<a name='662'></font>
             CALL task_for_point ( ni, k, ids, ide, kds, kde, nest_pes_y(id), nest_pes_x(id), Py, Px, &amp;<a name='663'>
                                   1, 1, ierr ) <font color=#447700>! x and y for proc mesh reversed<a name='664'></font>
             IF ( Py .EQ. mytask_y ) THEN<a name='665'>
                c_ipey = i<a name='666'>
                IF ( c_ipsy .EQ. -1 ) c_ipsy = i<a name='667'>
             END IF<a name='668'>
          END DO<a name='669'>
          IF ( ierr .NE. 0 ) THEN<a name='670'>
             CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_5">(__FILE__,__LINE__)<a name='671'>
          END IF<a name='672'>
          IF (c_ipsy .EQ. -1 ) THEN<a name='673'>
             c_ipey = -1<a name='674'>
             c_ipsy = 0<a name='675'>
          END IF<a name='676'>
#endif<a name='677'>
<a name='678'>
<a name='679'>
         IF ( c_ips &lt;= c_ipe ) THEN<a name='680'>
<font color=#447700>! extend the patch dimensions out shw along edges of domain<a name='681'></font>
           IF ( mytask_x .EQ. 0 ) THEN<a name='682'>
             c_ips = c_ips - shw<a name='683'>
#if (DA_CORE == 1)<a name='684'>
             c_ipsy = c_ipsy - shw  <a name='685'>
#endif<a name='686'>
           END IF<a name='687'>
<font color=#447700>!           IF ( mytask_x .EQ. ntasks_x-1 ) THEN<a name='688'></font>
           IF ( mytask_x .EQ. nest_pes_x(id)-1 ) THEN<a name='689'>
             c_ipe = c_ipe + shw<a name='690'>
#if (DA_CORE == 1)<a name='691'>
             c_ipey = c_ipey + shw  <a name='692'>
#endif<a name='693'>
           END IF<a name='694'>
           c_ims = max( c_ips - max(shw,thisdomain_max_halo_width), c_ids - bdx ) - 1<a name='695'>
           c_ime = min( c_ipe + max(shw,thisdomain_max_halo_width), c_ide + bdx ) + 1<a name='696'>
         ELSE<a name='697'>
           c_ims = 0<a name='698'>
           c_ime = 0<a name='699'>
         END IF<a name='700'>
<a name='701'>
<a name='702'>
<font color=#447700>! handle j dims<a name='703'></font>
         IF ( c_jps &lt;= c_jpe ) THEN<a name='704'>
<font color=#447700>! extend the patch dimensions out shw along edges of domain<a name='705'></font>
           IF ( mytask_y .EQ. 0 ) THEN<a name='706'>
              c_jps = c_jps - shw<a name='707'>
#if (DA_CORE == 1)<a name='708'>
              c_jpsx = c_jpsx - shw  <a name='709'>
#endif<a name='710'>
           END IF<a name='711'>
<font color=#447700>!           IF ( mytask_y .EQ. ntasks_y-1 ) THEN<a name='712'></font>
           IF ( mytask_y .EQ. nest_pes_y(id)-1 ) THEN<a name='713'>
              c_jpe = c_jpe + shw<a name='714'>
#if (DA_CORE == 1)<a name='715'>
              c_jpex = c_jpex + shw  <a name='716'>
#endif<a name='717'>
           END IF<a name='718'>
           c_jms = max( c_jps - max(shw,thisdomain_max_halo_width), c_jds - bdx ) - 1<a name='719'>
           c_jme = min( c_jpe + max(shw,thisdomain_max_halo_width), c_jde + bdx ) + 1<a name='720'>
<font color=#447700>! handle k dims<a name='721'></font>
         ELSE<a name='722'>
           c_jms = 0<a name='723'>
           c_jme = 0<a name='724'>
         END IF<a name='725'>
         c_kps = 1<a name='726'>
         c_kpe = c_kde<a name='727'>
         c_kms = 1<a name='728'>
         c_kme = c_kde<a name='729'>
<a name='730'>
<font color=#447700>! Default initializations<a name='731'></font>
         c_sm1x = 1 ; c_em1x = 1 ; c_sm2x = 1 ; c_em2x = 1 ; c_sm3x = 1 ; c_em3x = 1<a name='732'>
         c_sm1y = 1 ; c_em1y = 1 ; c_sm2y = 1 ; c_em2y = 1 ; c_sm3y = 1 ; c_em3y = 1<a name='733'>
<a name='734'>
#if (DA_CORE == 1)<a name='735'>
         c_kmsx = c_kpsx <a name='736'>
         c_kmex = c_kpex <a name='737'>
         c_kmsy = c_kpsy <a name='738'>
         c_kmey = c_kpey <a name='739'>
<a name='740'>
         IF ( c_kpsx .EQ. 0 .AND. c_kpex .EQ. -1 ) THEN  <a name='741'>
            c_kmsx = 0<a name='742'>
            c_kmex = 0<a name='743'>
         END IF<a name='744'>
         IF ( c_kpsy .EQ. 0 .AND. c_kpey .EQ. -1 ) THEN<a name='745'>
            c_kmsy = 0<a name='746'>
            c_kmey = 0<a name='747'>
         END IF<a name='748'>
         c_imsx = c_ids<a name='749'>
         c_imex = c_ide<a name='750'>
         c_ipsx = c_imsx<a name='751'>
         c_ipex = c_imex<a name='752'>
<a name='753'>
         IF ( c_ipsy .EQ. 0 .AND. c_ipey .EQ. -1 ) THEN<a name='754'>
            c_imsy = 0<a name='755'>
            c_imey = 0<a name='756'>
         ELSE<a name='757'>
            c_imsy = c_ipsy<a name='758'>
            c_imey = c_ipey<a name='759'>
         END IF<a name='760'>
<a name='761'>
         c_jmsx = c_jpsx<a name='762'>
         c_jmex = c_jpex<a name='763'>
         c_jmsy = c_jds<a name='764'>
         c_jmey = c_jde<a name='765'>
<a name='766'>
         IF ( c_jpsx .EQ. 0 .AND. c_jpex .EQ. -1 ) THEN<a name='767'>
            c_jmsx = 0<a name='768'>
            c_jmex = 0<a name='769'>
         ELSE<a name='770'>
            c_jpsy = c_jmsy<a name='771'>
            c_jpey = c_jmey<a name='772'>
         END IF<a name='773'>
<a name='774'>
         c_sm1x = c_imsx<a name='775'>
         c_em1x = c_imex<a name='776'>
         c_sm2x = c_jmsx<a name='777'>
         c_em2x = c_jmex<a name='778'>
         c_sm3x = c_kmsx<a name='779'>
         c_em3x = c_kmex<a name='780'>
<a name='781'>
         c_sm1y = c_imsy<a name='782'>
         c_em1y = c_imey<a name='783'>
         c_sm2y = c_jmsy<a name='784'>
         c_em2y = c_jmey<a name='785'>
         c_sm3y = c_kmsy<a name='786'>
         c_em3y = c_kmey<a name='787'>
<a name='788'>
         c_sp1x = c_ipsx<a name='789'>
         c_ep1x = c_ipex<a name='790'>
         c_sp2x = c_jpsx<a name='791'>
         c_ep2x = c_jpex<a name='792'>
         c_sp3x = c_kpsx<a name='793'>
         c_ep3x = c_kpex<a name='794'>
<a name='795'>
         c_sp1y = c_ipsy<a name='796'>
         c_ep1y = c_ipey<a name='797'>
         c_sp2y = c_jpsy<a name='798'>
         c_ep2y = c_jpey<a name='799'>
         c_sp3y = c_kpsy<a name='800'>
         c_ep3y = c_kpey<a name='801'>
#endif<a name='802'>
<a name='803'>
         WRITE(wrf_err_message,*)'*************************************'<a name='804'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_310">( TRIM(wrf_err_message) )<a name='805'>
         WRITE(wrf_err_message,*)'Nesting domain'<a name='806'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_311">( TRIM(wrf_err_message) )<a name='807'>
         WRITE(wrf_err_message,*)'ids,ide,jds,jde ',ids,ide,jds,jde<a name='808'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_312">( TRIM(wrf_err_message) )<a name='809'>
         WRITE(wrf_err_message,*)'ims,ime,jms,jme ',ims,ime,jms,jme<a name='810'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_313">( TRIM(wrf_err_message) )<a name='811'>
         WRITE(wrf_err_message,*)'ips,ipe,jps,jpe ',ips,ipe,jps,jpe<a name='812'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_314">( TRIM(wrf_err_message) )<a name='813'>
         WRITE(wrf_err_message,*)'INTERMEDIATE domain'<a name='814'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_315">( TRIM(wrf_err_message) )<a name='815'>
         WRITE(wrf_err_message,*)'ids,ide,jds,jde ',c_ids,c_ide,c_jds,c_jde<a name='816'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_316">( TRIM(wrf_err_message) )<a name='817'>
         WRITE(wrf_err_message,*)'ims,ime,jms,jme ',c_ims,c_ime,c_jms,c_jme<a name='818'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_317">( TRIM(wrf_err_message) )<a name='819'>
         WRITE(wrf_err_message,*)'ips,ipe,jps,jpe ',c_ips,c_ipe,c_jps,c_jpe<a name='820'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_318">( TRIM(wrf_err_message) )<a name='821'>
         WRITE(wrf_err_message,*)'*************************************'<a name='822'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_319">( TRIM(wrf_err_message) )<a name='823'>
<a name='824'>
         SELECT CASE ( model_data_order )<a name='825'>
            CASE ( DATA_ORDER_ZXY )<a name='826'>
               c_sd2 = c_ids ; c_ed2 = c_ide ; c_sp2 = c_ips ; c_ep2 = c_ipe ; c_sm2 = c_ims ; c_em2 = c_ime<a name='827'>
               c_sd3 = c_jds ; c_ed3 = c_jde ; c_sp3 = c_jps ; c_ep3 = c_jpe ; c_sm3 = c_jms ; c_em3 = c_jme<a name='828'>
               c_sd1 = c_kds ; c_ed1 = c_kde ; c_sp1 = c_kps ; c_ep1 = c_kpe ; c_sm1 = c_kms ; c_em1 = c_kme<a name='829'>
            CASE ( DATA_ORDER_ZYX )<a name='830'>
               c_sd3 = c_ids ; c_ed3 = c_ide ; c_sp3 = c_ips ; c_ep3 = c_ipe ; c_sm3 = c_ims ; c_em3 = c_ime<a name='831'>
               c_sd2 = c_jds ; c_ed2 = c_jde ; c_sp2 = c_jps ; c_ep2 = c_jpe ; c_sm2 = c_jms ; c_em2 = c_jme<a name='832'>
               c_sd1 = c_kds ; c_ed1 = c_kde ; c_sp1 = c_kps ; c_ep1 = c_kpe ; c_sm1 = c_kms ; c_em1 = c_kme<a name='833'>
            CASE ( DATA_ORDER_XYZ )<a name='834'>
               c_sd1 = c_ids ; c_ed1 = c_ide ; c_sp1 = c_ips ; c_ep1 = c_ipe ; c_sm1 = c_ims ; c_em1 = c_ime<a name='835'>
               c_sd2 = c_jds ; c_ed2 = c_jde ; c_sp2 = c_jps ; c_ep2 = c_jpe ; c_sm2 = c_jms ; c_em2 = c_jme<a name='836'>
               c_sd3 = c_kds ; c_ed3 = c_kde ; c_sp3 = c_kps ; c_ep3 = c_kpe ; c_sm3 = c_kms ; c_em3 = c_kme<a name='837'>
            CASE ( DATA_ORDER_YXZ)<a name='838'>
               c_sd2 = c_ids ; c_ed2 = c_ide ; c_sp2 = c_ips ; c_ep2 = c_ipe ; c_sm2 = c_ims ; c_em2 = c_ime<a name='839'>
               c_sd1 = c_jds ; c_ed1 = c_jde ; c_sp1 = c_jps ; c_ep1 = c_jpe ; c_sm1 = c_jms ; c_em1 = c_jme<a name='840'>
               c_sd3 = c_kds ; c_ed3 = c_kde ; c_sp3 = c_kps ; c_ep3 = c_kpe ; c_sm3 = c_kms ; c_em3 = c_kme<a name='841'>
            CASE ( DATA_ORDER_XZY )<a name='842'>
               c_sd1 = c_ids ; c_ed1 = c_ide ; c_sp1 = c_ips ; c_ep1 = c_ipe ; c_sm1 = c_ims ; c_em1 = c_ime<a name='843'>
               c_sd3 = c_jds ; c_ed3 = c_jde ; c_sp3 = c_jps ; c_ep3 = c_jpe ; c_sm3 = c_jms ; c_em3 = c_jme<a name='844'>
               c_sd2 = c_kds ; c_ed2 = c_kde ; c_sp2 = c_kps ; c_ep2 = c_kpe ; c_sm2 = c_kms ; c_em2 = c_kme<a name='845'>
            CASE ( DATA_ORDER_YZX )<a name='846'>
               c_sd3 = c_ids ; c_ed3 = c_ide ; c_sp3 = c_ips ; c_ep3 = c_ipe ; c_sm3 = c_ims ; c_em3 = c_ime<a name='847'>
               c_sd1 = c_jds ; c_ed1 = c_jde ; c_sp1 = c_jps ; c_ep1 = c_jpe ; c_sm1 = c_jms ; c_em1 = c_jme<a name='848'>
               c_sd2 = c_kds ; c_ed2 = c_kde ; c_sp2 = c_kps ; c_ep2 = c_kpe ; c_sm2 = c_kms ; c_em2 = c_kme<a name='849'>
         END SELECT<a name='850'>
<a name='851'>
         ALLOCATE ( intermediate_grid )<a name='852'>
         ALLOCATE ( intermediate_grid%parents( max_parents ) )<a name='853'>
         ALLOCATE ( intermediate_grid%nests( max_nests ) )<a name='854'>
         intermediate_grid%allocated=.false.<a name='855'>
         NULLIFY( intermediate_grid%sibling )<a name='856'>
         DO i = 1, max_nests<a name='857'>
            NULLIFY( intermediate_grid%nests(i)%ptr )<a name='858'>
         END DO<a name='859'>
         NULLIFY  (intermediate_grid%next)<a name='860'>
         NULLIFY  (intermediate_grid%same_level)<a name='861'>
         NULLIFY  (intermediate_grid%i_start)<a name='862'>
         NULLIFY  (intermediate_grid%j_start)<a name='863'>
         NULLIFY  (intermediate_grid%i_end)<a name='864'>
         NULLIFY  (intermediate_grid%j_end)<a name='865'>
         intermediate_grid%id = id   <font color=#447700>! these must be the same. Other parts of code depend on it (see gen_comms.c)<a name='866'></font>
         intermediate_grid%num_nests = 0<a name='867'>
         intermediate_grid%num_siblings = 0<a name='868'>
         intermediate_grid%num_parents = 1<a name='869'>
         intermediate_grid%max_tiles   = 0<a name='870'>
         intermediate_grid%num_tiles_spec   = 0<a name='871'>
#if ( EM_CORE == 1 &amp;&amp; DA_CORE <font color=#447700>!= 1 )<a name='872'></font>
         intermediate_grid%active_this_task = .true.<a name='873'>
#endif<a name='874'>
         CALL <A href='../../html_code/frame/module_domain.F.html#FIND_GRID_BY_ID'>find_grid_by_id</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_GRID_BY_ID_1"> ( id, head_grid, nest_grid )<a name='875'>
<a name='876'>
         nest_grid%intermediate_grid =&gt; intermediate_grid  <font color=#447700>! nest grid now has a pointer to this baby<a name='877'></font>
         intermediate_grid%parents(1)%ptr =&gt; nest_grid     <font color=#447700>! the intermediate grid considers nest its parent<a name='878'></font>
         intermediate_grid%num_parents = 1<a name='879'>
<a name='880'>
         intermediate_grid%is_intermediate = .TRUE.<a name='881'>
         SELECT CASE ( model_data_order )<a name='882'>
            CASE ( DATA_ORDER_ZXY )<a name='883'>
               intermediate_grid%nids = nest_grid%sd32 ; intermediate_grid%njds = nest_grid%sd33<a name='884'>
               intermediate_grid%nide = nest_grid%ed32 ; intermediate_grid%njde = nest_grid%sd33<a name='885'>
            CASE ( DATA_ORDER_ZYX )<a name='886'>
               intermediate_grid%nids = nest_grid%sd33 ; intermediate_grid%njds = nest_grid%sd32<a name='887'>
               intermediate_grid%nide = nest_grid%ed33 ; intermediate_grid%njde = nest_grid%sd32<a name='888'>
            CASE ( DATA_ORDER_XYZ )<a name='889'>
               intermediate_grid%nids = nest_grid%sd31 ; intermediate_grid%njds = nest_grid%sd32<a name='890'>
               intermediate_grid%nide = nest_grid%ed31 ; intermediate_grid%njde = nest_grid%sd32<a name='891'>
            CASE ( DATA_ORDER_YXZ)<a name='892'>
               intermediate_grid%nids = nest_grid%sd32 ; intermediate_grid%njds = nest_grid%sd31<a name='893'>
               intermediate_grid%nide = nest_grid%ed32 ; intermediate_grid%njde = nest_grid%sd31<a name='894'>
            CASE ( DATA_ORDER_XZY )<a name='895'>
               intermediate_grid%nids = nest_grid%sd31 ; intermediate_grid%njds = nest_grid%sd33<a name='896'>
               intermediate_grid%nide = nest_grid%ed31 ; intermediate_grid%njde = nest_grid%sd33<a name='897'>
            CASE ( DATA_ORDER_YZX )<a name='898'>
               intermediate_grid%nids = nest_grid%sd33 ; intermediate_grid%njds = nest_grid%sd31<a name='899'>
               intermediate_grid%nide = nest_grid%ed33 ; intermediate_grid%njde = nest_grid%sd31<a name='900'>
         END SELECT<a name='901'>
         intermediate_grid%nids = ids<a name='902'>
         intermediate_grid%nide = ide<a name='903'>
         intermediate_grid%njds = jds<a name='904'>
         intermediate_grid%njde = jde<a name='905'>
<a name='906'>
         intermediate_grid%sm31x                           = c_sm1x<a name='907'>
         intermediate_grid%em31x                           = c_em1x<a name='908'>
         intermediate_grid%sm32x                           = c_sm2x<a name='909'>
         intermediate_grid%em32x                           = c_em2x<a name='910'>
         intermediate_grid%sm33x                           = c_sm3x<a name='911'>
         intermediate_grid%em33x                           = c_em3x<a name='912'>
         intermediate_grid%sm31y                           = c_sm1y<a name='913'>
         intermediate_grid%em31y                           = c_em1y<a name='914'>
         intermediate_grid%sm32y                           = c_sm2y<a name='915'>
         intermediate_grid%em32y                           = c_em2y<a name='916'>
         intermediate_grid%sm33y                           = c_sm3y<a name='917'>
         intermediate_grid%em33y                           = c_em3y<a name='918'>
<a name='919'>
#if (DA_CORE == 1)<a name='920'>
         intermediate_grid%sp31x                           = c_sp1x<a name='921'>
         intermediate_grid%ep31x                           = c_ep1x<a name='922'>
         intermediate_grid%sp32x                           = c_sp2x<a name='923'>
         intermediate_grid%ep32x                           = c_ep2x<a name='924'>
         intermediate_grid%sp33x                           = c_sp3x<a name='925'>
         intermediate_grid%ep33x                           = c_ep3x<a name='926'>
         intermediate_grid%sp31y                           = c_sp1y<a name='927'>
         intermediate_grid%ep31y                           = c_ep1y<a name='928'>
         intermediate_grid%sp32y                           = c_sp2y<a name='929'>
         intermediate_grid%ep32y                           = c_ep2y<a name='930'>
         intermediate_grid%sp33y                           = c_sp3y<a name='931'>
         intermediate_grid%ep33y                           = c_ep3y<a name='932'>
#endif<a name='933'>
<a name='934'>
#if ( ( defined(SGIALTIX) || defined(FUJITSU_FX10) || defined(KEEP_INT_AROUND) ) &amp;&amp; (<font color=#447700>! defined(MOVE_NESTS) ) )<a name='935'></font>
         <font color=#447700>! allocate space for the intermediate domain<a name='936'></font>
<font color=#447700>!         CALL alloc_space_field ( intermediate_grid, intermediate_grid%id , 1, 2 , .TRUE., intercomm_active( intermediate_grid%id ), &amp;   ! use same id as nest<a name='937'></font>
         CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_SPACE_FIELD'>alloc_space_field</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_SPACE_FIELD_1"> ( intermediate_grid, intermediate_grid%id , 1, 2 , .TRUE., nest_grid%active_this_task, &amp;   <font color=#447700>! use same id as nest<a name='938'></font>
                               c_sd1, c_ed1, c_sd2, c_ed2, c_sd3, c_ed3,       &amp;<a name='939'>
                               c_sm1,  c_em1,  c_sm2,  c_em2,  c_sm3,  c_em3,  &amp;<a name='940'>
                               c_sp1,  c_ep1,  c_sp2,  c_ep2,  c_sp3,  c_ep3,  &amp;<a name='941'>
                               c_sm1x, c_em1x, c_sm2x, c_em2x, c_sm3x, c_em3x, &amp;<a name='942'>
                               c_sm1y, c_em1y, c_sm2y, c_em2y, c_sm3y, c_em3y, &amp;<a name='943'>
                               c_sm1x, c_em1x, c_sm2x, c_em2x, c_sm3x, c_em3x, &amp;   <font color=#447700>! x-xpose<a name='944'></font>
                               c_sm1y, c_em1y, c_sm2y, c_em2y, c_sm3y, c_em3y  )   <font color=#447700>! y-xpose<a name='945'></font>
#endif<a name='946'>
         intermediate_grid%sd31                            =   c_sd1<a name='947'>
         intermediate_grid%ed31                            =   c_ed1<a name='948'>
         intermediate_grid%sp31                            = c_sp1<a name='949'>
         intermediate_grid%ep31                            = c_ep1<a name='950'>
         intermediate_grid%sm31                            = c_sm1<a name='951'>
         intermediate_grid%em31                            = c_em1<a name='952'>
         intermediate_grid%sd32                            =   c_sd2<a name='953'>
         intermediate_grid%ed32                            =   c_ed2<a name='954'>
         intermediate_grid%sp32                            = c_sp2<a name='955'>
         intermediate_grid%ep32                            = c_ep2<a name='956'>
         intermediate_grid%sm32                            = c_sm2<a name='957'>
         intermediate_grid%em32                            = c_em2<a name='958'>
         intermediate_grid%sd33                            =   c_sd3<a name='959'>
         intermediate_grid%ed33                            =   c_ed3<a name='960'>
         intermediate_grid%sp33                            = c_sp3<a name='961'>
         intermediate_grid%ep33                            = c_ep3<a name='962'>
         intermediate_grid%sm33                            = c_sm3<a name='963'>
         intermediate_grid%em33                            = c_em3<a name='964'>
<a name='965'>
         CALL <A href='../../html_code/share/mediation_wrfmain.F.html#MED_ADD_CONFIG_INFO_TO_GRID'>med_add_config_info_to_grid</A><A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_ADD_CONFIG_INFO_TO_GRID_1"> ( intermediate_grid )<a name='966'>
<a name='967'>
         intermediate_grid%dx = parent%dx<a name='968'>
         intermediate_grid%dy = parent%dy<a name='969'>
         intermediate_grid%dt = parent%dt<a name='970'>
      END IF<a name='971'>
<a name='972'>
      RETURN<a name='973'>
  END SUBROUTINE patch_domain_rsl_lite<a name='974'>
<a name='975'>
<A NAME='COMPUTE_MEMORY_DIMS_RSL_LITE'><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='976'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>compute_memory_dims_rsl_lite</font>  (      &amp; <A href='../../call_to/COMPUTE_MEMORY_DIMS_RSL_LITE.html' TARGET='index'>1</A>,<A href='../../call_from/COMPUTE_MEMORY_DIMS_RSL_LITE.html' TARGET='index'>12</A><a name='977'>
                   id , maxhalowidth ,            &amp;<a name='978'>
                   shw , bdx,  bdy ,              &amp;<a name='979'>
                   ids,  ide,  jds,  jde,  kds,  kde, &amp;<a name='980'>
                   ims,  ime,  jms,  jme,  kms,  kme, &amp;<a name='981'>
                   imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='982'>
                   imsy, imey, jmsy, jmey, kmsy, kmey, &amp;<a name='983'>
                   ips,  ipe,  jps,  jpe,  kps,  kpe, &amp;<a name='984'>
                   ipsx, ipex, jpsx, jpex, kpsx, kpex, &amp;<a name='985'>
                   ipsy, ipey, jpsy, jpey, kpsy, kpey )<a name='986'>
<a name='987'>
    IMPLICIT NONE<a name='988'>
    INTEGER, INTENT(IN)               ::  id , maxhalowidth<a name='989'>
    INTEGER, INTENT(IN)               ::  shw, bdx, bdy<a name='990'>
    INTEGER, INTENT(IN)     ::  ids, ide, jds, jde, kds, kde<a name='991'>
    INTEGER, INTENT(OUT)    ::  ims, ime, jms, jme, kms, kme<a name='992'>
    INTEGER, INTENT(OUT)    ::  imsx, imex, jmsx, jmex, kmsx, kmex<a name='993'>
    INTEGER, INTENT(OUT)    ::  imsy, imey, jmsy, jmey, kmsy, kmey<a name='994'>
    INTEGER, INTENT(OUT)    ::  ips, ipe, jps, jpe, kps, kpe<a name='995'>
    INTEGER, INTENT(OUT)    ::  ipsx, ipex, jpsx, jpex, kpsx, kpex<a name='996'>
    INTEGER, INTENT(OUT)    ::  ipsy, ipey, jpsy, jpey, kpsy, kpey<a name='997'>
<a name='998'>
    INTEGER Px, Py, P, i, j, k, ierr<a name='999'>
<a name='1000'>
#if ( <font color=#447700>! NMM_CORE == 1 )<a name='1001'></font>
<a name='1002'>
<font color=#447700>! xy decomposition<a name='1003'></font>
<a name='1004'>
    ips = -1<a name='1005'>
    j = jds<a name='1006'>
    ierr = 0<a name='1007'>
    DO i = ids, ide<a name='1008'>
<font color=#447700>!       CALL task_for_point ( i, j, ids, ide, jds, jde, ntasks_x, ntasks_y, Px, Py, &amp;<a name='1009'></font>
       CALL task_for_point ( i, j, ids, ide, jds, jde, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='1010'>
                             minx, miny, ierr )<a name='1011'>
       IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_179">('error code returned by task_for_point in module_dm.F (c)')<a name='1012'>
       IF ( Px .EQ. mytask_x ) THEN<a name='1013'>
          ipe = i<a name='1014'>
          IF ( ips .EQ. -1 ) ips = i<a name='1015'>
       END IF<a name='1016'>
    END DO<a name='1017'>
    IF ( ierr .NE. 0 ) THEN<a name='1018'>
       CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_6">(__FILE__,__LINE__)<a name='1019'>
    END IF<a name='1020'>
    <font color=#447700>! handle setting the memory dimensions where there are no X elements assigned to this proc<a name='1021'></font>
    IF (ips .EQ. -1 ) THEN<a name='1022'>
       ipe = -1<a name='1023'>
       ips = 0<a name='1024'>
    END IF<a name='1025'>
<a name='1026'>
    jps = -1<a name='1027'>
    i = ids<a name='1028'>
    ierr = 0<a name='1029'>
    DO j = jds, jde<a name='1030'>
<font color=#447700>!       CALL task_for_point ( i, j, ids, ide, jds, jde, ntasks_x, ntasks_y, Px, Py, &amp;<a name='1031'></font>
       CALL task_for_point ( i, j, ids, ide, jds, jde, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='1032'>
                             minx, miny, ierr )<a name='1033'>
       IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_180">('error code returned by task_for_point in module_dm.F (d)')<a name='1034'>
       IF ( Py .EQ. mytask_y ) THEN<a name='1035'>
          jpe = j<a name='1036'>
          IF ( jps .EQ. -1 ) jps = j<a name='1037'>
       END IF<a name='1038'>
    END DO<a name='1039'>
    IF ( ierr .NE. 0 ) THEN<a name='1040'>
       CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_7">(__FILE__,__LINE__)<a name='1041'>
    END IF<a name='1042'>
    <font color=#447700>! handle setting the memory dimensions where there are no Y elements assigned to this proc<a name='1043'></font>
    IF (jps .EQ. -1 ) THEN<a name='1044'>
       jpe = -1<a name='1045'>
       jps = 0<a name='1046'>
    END IF<a name='1047'>
<a name='1048'>
<font color=#447700>!begin: wig; 12-Mar-2008<a name='1049'></font>
<font color=#447700>! This appears redundant with the conditionals above, but we get cases with only<a name='1050'></font>
<font color=#447700>! one of the directions being set to "missing" when turning off extra processors.<a name='1051'></font>
<font color=#447700>! This may break the handling of setting only one of nproc_x or nproc_y via the namelist.<a name='1052'></font>
    IF (ipe .EQ. -1 .or. jpe .EQ. -1) THEN<a name='1053'>
       ipe = -1<a name='1054'>
       ips = 0<a name='1055'>
       jpe = -1<a name='1056'>
       jps = 0<a name='1057'>
    END IF<a name='1058'>
<font color=#447700>!end: wig; 12-Mar-2008<a name='1059'></font>
<a name='1060'>
<font color=#447700>! <a name='1061'></font>
<font color=#447700>! description of transpose decomposition strategy for RSL LITE. 20061231jm<a name='1062'></font>
<font color=#447700>!<a name='1063'></font>
<font color=#447700>! Here is the tranpose scheme that is implemented for RSL_LITE. Upper-case<a name='1064'></font>
<font color=#447700>! XY corresponds to the dimension of the processor mesh, lower-case xyz<a name='1065'></font>
<font color=#447700>! corresponds to grid dimension.<a name='1066'></font>
<font color=#447700>! <a name='1067'></font>
<font color=#447700>!      xy        zy        zx<a name='1068'></font>
<font color=#447700>! <a name='1069'></font>
<font color=#447700>!     XxYy &lt;--&gt; XzYy &lt;--&gt; XzYx &lt;- note x decomposed over Y procs<a name='1070'></font>
<font color=#447700>!       ^                  ^<a name='1071'></font>
<font color=#447700>!       |                  |<a name='1072'></font>
<font color=#447700>!       +------------------+  &lt;- this edge is costly; see below<a name='1073'></font>
<font color=#447700>! <a name='1074'></font>
<font color=#447700>! The aim is to avoid all-to-all communication over whole<a name='1075'></font>
<font color=#447700>! communicator. Instead, when possible, use a transpose scheme that requires<a name='1076'></font>
<font color=#447700>! all-to-all within dimensional communicators; that is, communicators<a name='1077'></font>
<font color=#447700>! defined for the processes in a rank or column of the processor mesh. Note,<a name='1078'></font>
<font color=#447700>! however, it is not possible to create a ring of transposes between<a name='1079'></font>
<font color=#447700>! xy-yz-xz decompositions without at least one of the edges in the ring<a name='1080'></font>
<font color=#447700>! being fully all-to-all (in other words, one of the tranpose edges must<a name='1081'></font>
<font color=#447700>! rotate and not just transpose a plane of the model grid within the<a name='1082'></font>
<font color=#447700>! processor mesh). The issue is then, where should we put this costly edge<a name='1083'></font>
<font color=#447700>! in the tranpose scheme we chose? To avoid being completely arbitrary, <a name='1084'></font>
<font color=#447700>! we chose a scheme most natural for models that use parallel spectral<a name='1085'></font>
<font color=#447700>! transforms, where the costly edge is the one that goes from the xz to<a name='1086'></font>
<font color=#447700>! the xy decomposition.  (May be implemented as just a two step transpose<a name='1087'></font>
<font color=#447700>! back through yz).<a name='1088'></font>
<font color=#447700>!<a name='1089'></font>
<font color=#447700>! Additional notational convention, below. The 'x' or 'y' appended to the<a name='1090'></font>
<font color=#447700>! dimension start or end variable refers to which grid dimension is all<a name='1091'></font>
<font color=#447700>! on-processor in the given decomposition. That is ipsx and ipex are the<a name='1092'></font>
<font color=#447700>! start and end for the i-dimension in the zy decomposition where x is<a name='1093'></font>
<font color=#447700>! on-processor. ('z' is assumed for xy decomposition and not appended to<a name='1094'></font>
<font color=#447700>! the ips, ipe, etc. variable names).<a name='1095'></font>
<font color=#447700>! <a name='1096'></font>
<a name='1097'>
<font color=#447700>! XzYy decomposition<a name='1098'></font>
<a name='1099'>
    kpsx = -1<a name='1100'>
    j = jds ;<a name='1101'>
    ierr = 0<a name='1102'>
    DO k = kds, kde<a name='1103'>
<font color=#447700>!       CALL task_for_point ( k, j, kds, kde, jds, jde, ntasks_x, ntasks_y, Px, Py, &amp;<a name='1104'></font>
       CALL task_for_point ( k, j, kds, kde, jds, jde, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='1105'>
                             minx, miny, ierr )<a name='1106'>
       IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_181">('error code returned by task_for_point in module_dm.F (e)')<a name='1107'>
       IF ( Px .EQ. mytask_x ) THEN<a name='1108'>
          kpex = k<a name='1109'>
          IF ( kpsx .EQ. -1 ) kpsx = k<a name='1110'>
       END IF<a name='1111'>
    END DO<a name='1112'>
    IF ( ierr .NE. 0 ) THEN<a name='1113'>
       CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_8">(__FILE__,__LINE__)<a name='1114'>
    END IF <a name='1115'>
    <a name='1116'>
<font color=#447700>! handle case where no levels are assigned to this process<a name='1117'></font>
<font color=#447700>! no iterations.  Do same for I and J. Need to handle memory alloc below.<a name='1118'></font>
    IF (kpsx .EQ. -1 ) THEN<a name='1119'>
       kpex = -1<a name='1120'>
       kpsx = 0<a name='1121'>
    END IF<a name='1122'>
<a name='1123'>
    jpsx = -1<a name='1124'>
    k = kds ;<a name='1125'>
    ierr = 0<a name='1126'>
    DO j = jds, jde<a name='1127'>
<font color=#447700>!       CALL task_for_point ( k, j, kds, kde, jds, jde, ntasks_x, ntasks_y, Px, Py, &amp;<a name='1128'></font>
       CALL task_for_point ( k, j, kds, kde, jds, jde, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='1129'>
                             minx, miny, ierr )<a name='1130'>
       IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_182">('error code returned by task_for_point in module_dm.F (f)')<a name='1131'>
       IF ( Py .EQ. mytask_y ) THEN<a name='1132'>
          jpex = j<a name='1133'>
          IF ( jpsx .EQ. -1 ) jpsx = j<a name='1134'>
       END IF<a name='1135'>
    END DO<a name='1136'>
    IF ( ierr .NE. 0 ) THEN<a name='1137'>
       CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_9">(__FILE__,__LINE__)<a name='1138'>
    END IF <a name='1139'>
    IF (jpsx .EQ. -1 ) THEN<a name='1140'>
       jpex = -1<a name='1141'>
       jpsx = 0<a name='1142'>
    END IF<a name='1143'>
<a name='1144'>
<font color=#447700>!begin: wig; 12-Mar-2008<a name='1145'></font>
<font color=#447700>! This appears redundant with the conditionals above, but we get cases with only<a name='1146'></font>
<font color=#447700>! one of the directions being set to "missing" when turning off extra processors.<a name='1147'></font>
<font color=#447700>! This may break the handling of setting only one of nproc_x or nproc_y via the namelist.<a name='1148'></font>
    IF (jpex .EQ. -1) THEN<a name='1149'>
       ipex = -1<a name='1150'>
       ipsx = 0<a name='1151'>
       jpex = -1<a name='1152'>
       jpsx = 0<a name='1153'>
    END IF<a name='1154'>
<font color=#447700>!end: wig; 12-Mar-2008<a name='1155'></font>
<a name='1156'>
<font color=#447700>! XzYx decomposition  (note, x grid dim is decomposed over Y processor dim)<a name='1157'></font>
<a name='1158'>
    kpsy = kpsx   <font color=#447700>! same as above<a name='1159'></font>
    kpey = kpex   <font color=#447700>! same as above<a name='1160'></font>
<a name='1161'>
    ipsy = -1<a name='1162'>
    k = kds ;<a name='1163'>
    ierr = 0<a name='1164'>
    DO i = ids, ide<a name='1165'>
<font color=#447700>!       CALL task_for_point ( i, k, ids, ide, kds, kde, ntasks_y, ntasks_x, Py, Px, &amp;<a name='1166'></font>
       CALL task_for_point ( i, k, ids, ide, kds, kde, nest_pes_y(id), nest_pes_x(id), Py, Px, &amp;<a name='1167'>
                             miny, minx, ierr )<a name='1168'>
       IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_183">('error code returned by task_for_point in module_dm.F (g)')<a name='1169'>
       IF ( Py .EQ. mytask_y ) THEN<a name='1170'>
          ipey = i<a name='1171'>
          IF ( ipsy .EQ. -1 ) ipsy = i<a name='1172'>
       END IF<a name='1173'>
    END DO<a name='1174'>
    IF ( ierr .NE. 0 ) THEN<a name='1175'>
       CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_10">(__FILE__,__LINE__)<a name='1176'>
    END IF <a name='1177'>
    IF (ipsy .EQ. -1 ) THEN<a name='1178'>
       ipey = -1<a name='1179'>
       ipsy = 0<a name='1180'>
    END IF<a name='1181'>
<a name='1182'>
<a name='1183'>
#else<a name='1184'>
<a name='1185'>
<font color=#447700>! In case of NMM CORE, the domain only ever runs from ids..ide-1 and jds..jde-1 so<a name='1186'></font>
<font color=#447700>! adjust decomposition to reflect.  20051020 JM<a name='1187'></font>
    ips = -1<a name='1188'>
    j = jds<a name='1189'>
    ierr = 0<a name='1190'>
    DO i = ids, ide-1<a name='1191'>
<font color=#447700>!jm       CALL task_for_point ( i, j, ids, ide-1, jds, jde-1, ntasks_x, ntasks_y, Px, Py, &amp;<a name='1192'></font>
       CALL task_for_point ( i, j, ids, ide-1, jds, jde-1, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='1193'>
                             minx, miny, ierr )<a name='1194'>
       IF ( Px .EQ. mytask_x ) THEN<a name='1195'>
          ipe = i<a name='1196'>
<font color=#447700>!          IF ( Px .EQ. ntasks_x-1 ) ipe = ipe + 1<a name='1197'></font>
          IF ( Px .EQ. nest_pes_x(id)-1 ) ipe = ipe + 1<a name='1198'>
          IF ( ips .EQ. -1 ) ips = i<a name='1199'>
       END IF<a name='1200'>
    END DO<a name='1201'>
    IF ( ierr .NE. 0 ) THEN<a name='1202'>
       CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_11">(__FILE__,__LINE__)<a name='1203'>
    END IF <a name='1204'>
    jps = -1<a name='1205'>
    i = ids ;<a name='1206'>
    ierr = 0<a name='1207'>
    DO j = jds, jde-1<a name='1208'>
<font color=#447700>!jm       CALL task_for_point ( i, j, ids, ide-1, jds, jde-1, ntasks_x, ntasks_y, Px, Py, &amp;<a name='1209'></font>
       CALL task_for_point ( i, j, ids, ide-1, jds, jde-1, nest_pes_x(id), nest_pes_y(id), Px, Py, &amp;<a name='1210'>
                             minx, miny, ierr )<a name='1211'>
       IF ( Py .EQ. mytask_y ) THEN<a name='1212'>
          jpe = j<a name='1213'>
<font color=#447700>!          IF ( Py .EQ. ntasks_y-1 ) jpe = jpe + 1<a name='1214'></font>
          IF ( Py .EQ. nest_pes_y(id)-1 ) jpe = jpe + 1<a name='1215'>
          IF ( jps .EQ. -1 ) jps = j<a name='1216'>
       END IF<a name='1217'>
    END DO<a name='1218'>
    IF ( ierr .NE. 0 ) THEN<a name='1219'>
       CALL <A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE'>tfp_message</A><A href='../../html_code/frame/module_dm.F.html#COMPUTE_MEMORY_DIMS_RSL_LITE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TFP_MESSAGE_12">(__FILE__,__LINE__)<a name='1220'>
    END IF <a name='1221'>
#endif<a name='1222'>
<a name='1223'>
<font color=#447700>! extend the patch dimensions out shw along edges of domain<a name='1224'></font>
    IF ( ips &lt; ipe .and. jps &lt; jpe ) THEN           <font color=#447700>!wig; 11-Mar-2008<a name='1225'></font>
       IF ( mytask_x .EQ. 0 ) THEN<a name='1226'>
          ips = ips - shw<a name='1227'>
          ipsy = ipsy - shw<a name='1228'>
       END IF<a name='1229'>
<font color=#447700>!       IF ( mytask_x .EQ. ntasks_x-1 ) THEN<a name='1230'></font>
       IF ( mytask_x .EQ. nest_pes_x(id)-1 ) THEN<a name='1231'>
          ipe = ipe + shw<a name='1232'>
          ipey = ipey + shw<a name='1233'>
       END IF<a name='1234'>
       IF ( mytask_y .EQ. 0 ) THEN<a name='1235'>
          jps = jps - shw<a name='1236'>
          jpsx = jpsx - shw<a name='1237'>
       END IF<a name='1238'>
<font color=#447700>!       IF ( mytask_y .EQ. ntasks_y-1 ) THEN<a name='1239'></font>
       IF ( mytask_y .EQ. nest_pes_y(id)-1 ) THEN<a name='1240'>
          jpe = jpe + shw<a name='1241'>
          jpex = jpex + shw<a name='1242'>
       END IF<a name='1243'>
    END IF                                           <font color=#447700>!wig; 11-Mar-2008<a name='1244'></font>
<a name='1245'>
    kps = 1<a name='1246'>
    kpe = kde-kds+1<a name='1247'>
<a name='1248'>
    kms = 1<a name='1249'>
    kme = kpe<a name='1250'>
    kmsx = kpsx<a name='1251'>
    kmex = kpex<a name='1252'>
    kmsy = kpsy<a name='1253'>
    kmey = kpey<a name='1254'>
<a name='1255'>
    <font color=#447700>! handle setting the memory dimensions where there are no levels assigned to this proc<a name='1256'></font>
    IF ( kpsx .EQ. 0 .AND. kpex .EQ. -1 ) THEN<a name='1257'>
      kmsx = 0<a name='1258'>
      kmex = 0<a name='1259'>
    END IF<a name='1260'>
    IF ( kpsy .EQ. 0 .AND. kpey .EQ. -1 ) THEN<a name='1261'>
      kmsy = 0<a name='1262'>
      kmey = 0<a name='1263'>
    END IF<a name='1264'>
<a name='1265'>
    IF ( (jps .EQ. 0 .AND. jpe .EQ. -1) .OR. (ips .EQ. 0 .AND. ipe .EQ. -1) ) THEN<a name='1266'>
      ims = 0<a name='1267'>
      ime = 0<a name='1268'>
    ELSE<a name='1269'>
      ims = max( ips - max(shw,maxhalowidth), ids - bdx ) - 1<a name='1270'>
      ime = min( ipe + max(shw,maxhalowidth), ide + bdx ) + 1<a name='1271'>
#ifdef INTEL_ALIGN64<a name='1272'>
<font color=#447700>! align on 64 byte boundaries if -align array64byte<a name='1273'></font>
      ims = ips-CHUNK<a name='1274'>
      ime = ime + (CHUNK-mod(ime-ims+1,CHUNK))<a name='1275'>
#endif<a name='1276'>
    END IF<a name='1277'>
    imsx = ids<a name='1278'>
    imex = ide<a name='1279'>
    ipsx = imsx<a name='1280'>
    ipex = imex<a name='1281'>
    <font color=#447700>! handle setting the memory dimensions where there are no Y elements assigned to this proc<a name='1282'></font>
    IF ( ipsy .EQ. 0 .AND. ipey .EQ. -1 ) THEN<a name='1283'>
      imsy = 0<a name='1284'>
      imey = 0<a name='1285'>
    ELSE<a name='1286'>
      imsy = ipsy<a name='1287'>
      imey = ipey<a name='1288'>
    END IF<a name='1289'>
<a name='1290'>
    IF ( (jps .EQ. 0 .AND. jpe .EQ. -1) .OR. (ips .EQ. 0 .AND. ipe .EQ. -1) ) THEN<a name='1291'>
      jms = 0<a name='1292'>
      jme = 0<a name='1293'>
    ELSE<a name='1294'>
      jms = max( jps - max(shw,maxhalowidth), jds - bdy ) - 1<a name='1295'>
      jme = min( jpe + max(shw,maxhalowidth), jde + bdy ) + 1<a name='1296'>
    END IF<a name='1297'>
    jmsx = jpsx<a name='1298'>
    jmex = jpex<a name='1299'>
    jmsy = jds<a name='1300'>
    jmey = jde<a name='1301'>
    <font color=#447700>! handle setting the memory dimensions where there are no X elements assigned to this proc<a name='1302'></font>
    IF ( jpsx .EQ. 0 .AND. jpex .EQ. -1 ) THEN<a name='1303'>
      jmsx = 0<a name='1304'>
      jmex = 0<a name='1305'>
      jpsy = 0<a name='1306'>
      jpey = -1<a name='1307'>
    ELSE<a name='1308'>
      jpsy = jmsy<a name='1309'>
      jpey = jmey<a name='1310'>
    END IF<a name='1311'>
<a name='1312'>
  END SUBROUTINE compute_memory_dims_rsl_lite<a name='1313'>
<a name='1314'>
<font color=#447700>! internal, used below for switching the argument to MPI calls<a name='1315'></font>
<font color=#447700>! if reals are being autopromoted to doubles in the build of WRF<a name='1316'></font>
<A NAME='GETREALMPITYPE'><A href='../../html_code/frame/module_dm.F.html#GETREALMPITYPE' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1317'>
   INTEGER <font color=#993300>function </font><font color=#cc0000>getrealmpitype</font>(),<A href='../../call_from/GETREALMPITYPE.html' TARGET='index'>1</A><a name='1318'>
#ifndef STUBMPI<a name='1319'>
      IMPLICIT NONE<a name='1320'>
      INTEGER rtypesize, dtypesize, ierr<a name='1321'>
      CALL mpi_type_size ( MPI_REAL, rtypesize, ierr )<a name='1322'>
      CALL mpi_type_size ( MPI_DOUBLE_PRECISION, dtypesize, ierr )<a name='1323'>
      IF ( RWORDSIZE .EQ. rtypesize ) THEN<a name='1324'>
        getrealmpitype = MPI_REAL<a name='1325'>
      ELSE IF ( RWORDSIZE .EQ. dtypesize ) THEN<a name='1326'>
        getrealmpitype = MPI_DOUBLE_PRECISION<a name='1327'>
      ELSE<a name='1328'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#GETREALMPITYPE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_184"> ( 'RWORDSIZE or DWORDSIZE does not match any MPI type' )<a name='1329'>
      END IF<a name='1330'>
#else<a name='1331'>
<font color=#447700>! required dummy initialization for function that is never called<a name='1332'></font>
      getrealmpitype = 1<a name='1333'>
#endif<a name='1334'>
      RETURN<a name='1335'>
   END FUNCTION getrealmpitype<a name='1336'>
<a name='1337'>
<A NAME='WRF_DM_MAX_INT'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAX_INT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1338'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_max_int</font> ( inval ) <A href='../../call_to/WRF_DM_MAX_INT.html' TARGET='index'>1</A><a name='1339'>
      IMPLICIT NONE<a name='1340'>
#ifndef STUBMPI<a name='1341'>
      INCLUDE 'mpif.h'<a name='1342'>
      INTEGER, intent(in) :: inval<a name='1343'>
      INTEGER :: ierr, retval<a name='1344'>
      CALL mpi_allreduce ( inval, retval , 1, MPI_INT, MPI_MAX, local_communicator, ierr )<a name='1345'>
      wrf_dm_max_int = retval<a name='1346'>
#else<a name='1347'>
      INTEGER, intent(in) :: inval<a name='1348'>
      wrf_dm_max_int = inval<a name='1349'>
#endif<a name='1350'>
   END FUNCTION wrf_dm_max_int<a name='1351'>
<a name='1352'>
<A NAME='WRF_DM_MAX_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAX_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1353'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_max_real</font> ( inval ) <A href='../../call_to/WRF_DM_MAX_REAL.html' TARGET='index'>13</A>,<A href='../../call_from/WRF_DM_MAX_REAL.html' TARGET='index'>1</A><a name='1354'>
      IMPLICIT NONE<a name='1355'>
#ifndef STUBMPI<a name='1356'>
      REAL inval, retval<a name='1357'>
      INTEGER comm,ierr<a name='1358'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_10">(comm)<a name='1359'>
      CALL mpi_allreduce ( inval, retval , 1, getrealmpitype(), MPI_MAX, comm, ierr )<a name='1360'>
      wrf_dm_max_real = retval<a name='1361'>
#else<a name='1362'>
      REAL inval<a name='1363'>
      wrf_dm_max_real = inval<a name='1364'>
#endif<a name='1365'>
   END FUNCTION wrf_dm_max_real<a name='1366'>
<a name='1367'>
<A NAME='WRF_DM_MIN_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MIN_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1368'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_min_real</font> ( inval ) <A href='../../call_to/WRF_DM_MIN_REAL.html' TARGET='index'>16</A>,<A href='../../call_from/WRF_DM_MIN_REAL.html' TARGET='index'>1</A><a name='1369'>
      IMPLICIT NONE<a name='1370'>
#ifndef STUBMPI<a name='1371'>
      REAL inval, retval<a name='1372'>
      INTEGER comm,ierr<a name='1373'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_11">(comm)<a name='1374'>
      CALL mpi_allreduce ( inval, retval , 1, getrealmpitype(), MPI_MIN, comm, ierr )<a name='1375'>
      wrf_dm_min_real = retval<a name='1376'>
#else<a name='1377'>
      REAL inval<a name='1378'>
      wrf_dm_min_real = inval<a name='1379'>
#endif<a name='1380'>
   END FUNCTION wrf_dm_min_real<a name='1381'>
<a name='1382'>
<A NAME='WRF_DM_MIN_REALS'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MIN_REALS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1383'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_min_reals</font> ( inval, retval, n ) <A href='../../call_to/WRF_DM_MIN_REALS.html' TARGET='index'>45</A>,<A href='../../call_from/WRF_DM_MIN_REALS.html' TARGET='index'>1</A><a name='1384'>
      IMPLICIT NONE<a name='1385'>
      INTEGER n<a name='1386'>
      REAL inval(*)<a name='1387'>
      REAL retval(*)<a name='1388'>
#ifndef STUBMPI<a name='1389'>
      INTEGER comm,ierr<a name='1390'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REALS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_12">(comm)<a name='1391'>
      CALL mpi_allreduce ( inval, retval , n, getrealmpitype(), MPI_MIN, comm, ierr )<a name='1392'>
#else<a name='1393'>
      retval(1:n) = inval(1:n)<a name='1394'>
#endif<a name='1395'>
   END SUBROUTINE wrf_dm_min_reals<a name='1396'>
<a name='1397'>
<A NAME='WRF_DM_SUM_REAL8'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_SUM_REAL8' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1398'>
   <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_sum_real8</font> ( inval ) <A href='../../call_to/WRF_DM_SUM_REAL8.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_DM_SUM_REAL8.html' TARGET='index'>1</A><a name='1399'>
     <font color=#447700>! Forced eight byte real sum needed for calculating an accurate<a name='1400'></font>
     <font color=#447700>! mean motion in HWRF moduel_tracker.<a name='1401'></font>
      IMPLICIT NONE<a name='1402'>
#ifndef STUBMPI<a name='1403'>
      REAL*8 inval, retval, wrf_dm_sum_real8<a name='1404'>
      INTEGER comm,ierr<a name='1405'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_SUM_REAL8' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_13">(comm)<a name='1406'>
      CALL mpi_allreduce ( inval, retval , 1, MPI_REAL8, MPI_SUM, comm, ierr )<a name='1407'>
      wrf_dm_sum_real8 = retval<a name='1408'>
#else<a name='1409'>
      REAL*8 wrf_dm_sum_real8,inval<a name='1410'>
      wrf_dm_sum_real8 = inval<a name='1411'>
#endif<a name='1412'>
   END FUNCTION wrf_dm_sum_real8<a name='1413'>
<a name='1414'>
<A NAME='WRF_DM_SUM_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_SUM_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1415'>
   REAL <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_sum_real</font> ( inval ) <A href='../../call_to/WRF_DM_SUM_REAL.html' TARGET='index'>11</A>,<A href='../../call_from/WRF_DM_SUM_REAL.html' TARGET='index'>1</A><a name='1416'>
      IMPLICIT NONE<a name='1417'>
#ifndef STUBMPI<a name='1418'>
      REAL inval, retval<a name='1419'>
      INTEGER comm,ierr<a name='1420'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_14">(comm)<a name='1421'>
      CALL mpi_allreduce ( inval, retval , 1, getrealmpitype(), MPI_SUM, comm, ierr )<a name='1422'>
      wrf_dm_sum_real = retval<a name='1423'>
#else<a name='1424'>
      REAL inval<a name='1425'>
      wrf_dm_sum_real = inval<a name='1426'>
#endif<a name='1427'>
   END FUNCTION wrf_dm_sum_real<a name='1428'>
<a name='1429'>
<A NAME='WRF_DM_SUM_REALS'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_SUM_REALS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1430'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_sum_reals</font> (inval, retval) <A href='../../call_to/WRF_DM_SUM_REALS.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_DM_SUM_REALS.html' TARGET='index'>1</A><a name='1431'>
      IMPLICIT NONE<a name='1432'>
      REAL, INTENT(IN)  :: inval(:)<a name='1433'>
      REAL, INTENT(OUT) :: retval(:)<a name='1434'>
#ifndef STUBMPI<a name='1435'>
      INTEGER comm,ierr<a name='1436'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_REALS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_15">(comm)<a name='1437'>
      CALL mpi_allreduce ( inval, retval, SIZE(inval), getrealmpitype(), MPI_SUM, comm, ierr )<a name='1438'>
#else<a name='1439'>
      retval = inval<a name='1440'>
#endif<a name='1441'>
   END SUBROUTINE wrf_dm_sum_reals<a name='1442'>
<a name='1443'>
<A NAME='WRF_DM_SUM_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_SUM_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1444'>
   INTEGER <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_sum_integer</font> ( inval ) <A href='../../call_to/WRF_DM_SUM_INTEGER.html' TARGET='index'>3</A>,<A href='../../call_from/WRF_DM_SUM_INTEGER.html' TARGET='index'>1</A><a name='1445'>
      IMPLICIT NONE<a name='1446'>
#ifndef STUBMPI<a name='1447'>
      INTEGER inval, retval<a name='1448'>
      INTEGER comm,ierr<a name='1449'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_16">(comm)<a name='1450'>
      CALL mpi_allreduce ( inval, retval , 1, MPI_INTEGER, MPI_SUM, comm, ierr )<a name='1451'>
      wrf_dm_sum_integer = retval<a name='1452'>
#else<a name='1453'>
      INTEGER inval<a name='1454'>
      wrf_dm_sum_integer = inval<a name='1455'>
#endif<a name='1456'>
   END FUNCTION wrf_dm_sum_integer<a name='1457'>
<a name='1458'>
<A NAME='WRF_DM_SUM_INTEGERS'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_SUM_INTEGERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1459'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_sum_integers</font> (inval, retval) <A href='../../call_to/WRF_DM_SUM_INTEGERS.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_DM_SUM_INTEGERS.html' TARGET='index'>1</A><a name='1460'>
      IMPLICIT NONE<a name='1461'>
      INTEGER, INTENT(IN)  :: inval(:)<a name='1462'>
      INTEGER, INTENT(OUT) :: retval(:)<a name='1463'>
#ifndef STUBMPI<a name='1464'>
      INTEGER comm,ierr<a name='1465'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_SUM_INTEGERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_17">(comm)<a name='1466'>
      CALL mpi_allreduce ( inval, retval, SIZE(inval), MPI_INTEGER, MPI_SUM, comm, ierr )<a name='1467'>
#else<a name='1468'>
      retval = inval<a name='1469'>
#endif<a name='1470'>
   END SUBROUTINE wrf_dm_sum_integers<a name='1471'>
<a name='1472'>
#if ( HWRF == 1 )<a name='1473'>
<A NAME='WRF_DM_MINLOC_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINLOC_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1474'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_minloc_real</font> ( val, lat, lon, z, idex, jdex ) <A href='../../call_to/WRF_DM_MINLOC_REAL.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_MINLOC_REAL.html' TARGET='index'>1</A><a name='1475'>
#ifndef STUBMPI<a name='1476'>
      use mpi<a name='1477'>
      IMPLICIT NONE<a name='1478'>
      REAL val, lat, lon, z<a name='1479'>
      INTEGER idex, jdex, ierr, mrank, comm<a name='1480'>
      REAL inreduce(2), outreduce(2), bcast(5)<a name='1481'>
<a name='1482'>
      inreduce=(/ val, real(mytask) /)<a name='1483'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINLOC_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_18">(comm)<a name='1484'>
      call MPI_Allreduce(inreduce,outreduce,1,MPI_2REAL,MPI_MINLOC,&amp;<a name='1485'>
           comm,ierr)<a name='1486'>
      val=outreduce(1)<a name='1487'>
      mrank=outreduce(2)<a name='1488'>
      bcast=(/ lat,lon,z,real(idex),real(jdex) /)<a name='1489'>
      call MPI_Bcast(bcast,5,MPI_REAL,mrank,comm,ierr)<a name='1490'>
      lat=bcast(1)<a name='1491'>
      lon=bcast(2)<a name='1492'>
      z=bcast(3)<a name='1493'>
      idex=bcast(4)<a name='1494'>
      jdex=bcast(5)<a name='1495'>
#else<a name='1496'>
      IMPLICIT NONE<a name='1497'>
      REAL val,lat,lon,z<a name='1498'>
      INTEGER idex, jdex<a name='1499'>
#endif<a name='1500'>
   END SUBROUTINE wrf_dm_minloc_real<a name='1501'>
<A NAME='WRF_DM_MAXLOC_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXLOC_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1502'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_maxloc_real</font> ( val, lat, lon, z, idex, jdex ) <A href='../../call_to/WRF_DM_MAXLOC_REAL.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_MAXLOC_REAL.html' TARGET='index'>1</A><a name='1503'>
#ifndef STUBMPI<a name='1504'>
      use mpi<a name='1505'>
      IMPLICIT NONE<a name='1506'>
      REAL val, lat, lon, z<a name='1507'>
      INTEGER idex, jdex, ierr, mrank, comm<a name='1508'>
      REAL inreduce(2), outreduce(2), bcast(5)<a name='1509'>
<a name='1510'>
      inreduce=(/ val, real(mytask) /)<a name='1511'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXLOC_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_19">(comm)<a name='1512'>
      call MPI_Allreduce(inreduce,outreduce,1,MPI_2REAL,MPI_MAXLOC,&amp;<a name='1513'>
           comm,ierr)<a name='1514'>
      val=outreduce(1)<a name='1515'>
      mrank=outreduce(2)<a name='1516'>
      bcast=(/ lat,lon,z,real(idex),real(jdex) /)<a name='1517'>
      call MPI_Bcast(bcast,5,MPI_REAL,mrank,comm,ierr)<a name='1518'>
      lat=bcast(1)<a name='1519'>
      lon=bcast(2)<a name='1520'>
      z=bcast(3)<a name='1521'>
      idex=bcast(4)<a name='1522'>
      jdex=bcast(5)<a name='1523'>
#else<a name='1524'>
      IMPLICIT NONE<a name='1525'>
      REAL val,lat,lon,z<a name='1526'>
      INTEGER idex, jdex<a name='1527'>
#endif<a name='1528'>
   END SUBROUTINE wrf_dm_maxloc_real<a name='1529'>
#endif<a name='1530'>
<a name='1531'>
<A NAME='WRF_DM_BXOR_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BXOR_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1532'>
   INTEGER <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_bxor_integer</font> ( inval ),<A href='../../call_from/WRF_DM_BXOR_INTEGER.html' TARGET='index'>1</A><a name='1533'>
      IMPLICIT NONE<a name='1534'>
#ifndef STUBMPI<a name='1535'>
      INTEGER inval, retval<a name='1536'>
      INTEGER comm, ierr<a name='1537'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BXOR_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_20">(comm)<a name='1538'>
      CALL mpi_allreduce ( inval, retval , 1, MPI_INTEGER, MPI_BXOR, comm, ierr )<a name='1539'>
      wrf_dm_bxor_integer = retval<a name='1540'>
#else<a name='1541'>
      INTEGER inval<a name='1542'>
      wrf_dm_bxor_integer = inval<a name='1543'>
#endif<a name='1544'>
   END FUNCTION wrf_dm_bxor_integer<a name='1545'>
<a name='1546'>
<a name='1547'>
<A NAME='WRF_DM_LOR_LOGICAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_LOR_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1548'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_lor_logical</font> ( inval ),<A href='../../call_from/WRF_DM_LOR_LOGICAL.html' TARGET='index'>1</A><a name='1549'>
      IMPLICIT NONE<a name='1550'>
#ifndef STUBMPI<a name='1551'>
      LOGICAL inval, retval<a name='1552'>
      INTEGER comm, ierr<a name='1553'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_LOR_LOGICAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_21">(comm)<a name='1554'>
      CALL mpi_allreduce ( inval, retval , 1, MPI_LOGICAL, MPI_LOR, comm, ierr )<a name='1555'>
      wrf_dm_lor_logical = retval<a name='1556'>
#else<a name='1557'>
      LOGICAL inval<a name='1558'>
      wrf_dm_lor_logical = inval<a name='1559'>
#endif<a name='1560'>
   END FUNCTION wrf_dm_lor_logical<a name='1561'>
<a name='1562'>
<a name='1563'>
<A NAME='WRF_DM_LAND_LOGICAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_LAND_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1564'>
LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_land_logical</font> ( inval ),<A href='../../call_from/WRF_DM_LAND_LOGICAL.html' TARGET='index'>1</A><a name='1565'>
      IMPLICIT NONE<a name='1566'>
#ifndef STUBMPI<a name='1567'>
      LOGICAL inval, retval<a name='1568'>
      INTEGER comm, ierr<a name='1569'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_LAND_LOGICAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_22">(comm)<a name='1570'>
      CALL mpi_allreduce ( inval, retval , 1, MPI_LOGICAL, MPI_LAND, comm, ierr )<a name='1571'>
      wrf_dm_land_logical = retval<a name='1572'>
#else<a name='1573'>
      LOGICAL inval<a name='1574'>
      wrf_dm_land_logical = inval<a name='1575'>
#endif<a name='1576'>
   END FUNCTION wrf_dm_land_logical<a name='1577'>
<a name='1578'>
<a name='1579'>
<A NAME='WRF_DM_MAXVAL_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1580'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_maxval_real</font> ( val, idex, jdex ) <A href='../../call_to/WRF_DM_MAXVAL_REAL.html' TARGET='index'>9</A>,<A href='../../call_from/WRF_DM_MAXVAL_REAL.html' TARGET='index'>1</A><a name='1581'>
# ifndef STUBMPI<a name='1582'>
      use mpi<a name='1583'>
      IMPLICIT NONE<a name='1584'>
      REAL val<a name='1585'>
      INTEGER :: idex, jdex, i, comm<a name='1586'>
      INTEGER :: bcast(2),mrank<a name='1587'>
      REAL :: inreduce(2),outreduce(2)<a name='1588'>
<a name='1589'>
      inreduce=(/ val, real(mytask) /)<a name='1590'>
      bcast=(/ idex,jdex /)<a name='1591'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_23">(comm)<a name='1592'>
      call MPI_Allreduce(inreduce,outreduce,1,MPI_2REAL,&amp;<a name='1593'>
                         MPI_MAXLOC,comm,i)<a name='1594'>
      mrank=outreduce(2)<a name='1595'>
      val=outreduce(1)<a name='1596'>
      call MPI_Bcast(bcast,2,MPI_REAL,mrank,comm,i)<a name='1597'>
      idex=bcast(1)<a name='1598'>
      jdex=bcast(2)<a name='1599'>
# else<a name='1600'>
      IMPLICIT NONE<a name='1601'>
      REAL val<a name='1602'>
      INTEGER idex, jdex, ierr<a name='1603'>
# endif<a name='1604'>
    END SUBROUTINE wrf_dm_maxval_real<a name='1605'>
<a name='1606'>
<A NAME='WRF_DM_MINVAL_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1607'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_minval_real</font> ( val, idex, jdex ) <A href='../../call_to/WRF_DM_MINVAL_REAL.html' TARGET='index'>10</A>,<A href='../../call_from/WRF_DM_MINVAL_REAL.html' TARGET='index'>1</A><a name='1608'>
# ifndef STUBMPI<a name='1609'>
      use mpi<a name='1610'>
      IMPLICIT NONE<a name='1611'>
      REAL val<a name='1612'>
      INTEGER :: idex, jdex, i, comm<a name='1613'>
      INTEGER :: bcast(2),mrank<a name='1614'>
      REAL :: inreduce(2),outreduce(2)<a name='1615'>
<a name='1616'>
      inreduce=(/ val, real(mytask) /)<a name='1617'>
      bcast=(/ idex,jdex /)<a name='1618'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_24">(comm)<a name='1619'>
      call MPI_Allreduce(inreduce,outreduce,1,MPI_2REAL,&amp;<a name='1620'>
                         MPI_MINLOC,comm,i)<a name='1621'>
      mrank=outreduce(2)<a name='1622'>
      val=outreduce(1)<a name='1623'>
      call MPI_Bcast(bcast,2,MPI_REAL,mrank,comm,i)<a name='1624'>
      idex=bcast(1)<a name='1625'>
      jdex=bcast(2)<a name='1626'>
# else<a name='1627'>
      IMPLICIT NONE<a name='1628'>
      REAL val<a name='1629'>
      INTEGER idex, jdex<a name='1630'>
# endif<a name='1631'>
    END SUBROUTINE wrf_dm_minval_real<a name='1632'>
<a name='1633'>
#ifndef PROMOTE_FLOAT<a name='1634'>
<A NAME='WRF_DM_MAXVAL_DOUBLEPRECISION'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_DOUBLEPRECISION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1635'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_maxval_doubleprecision</font> ( val, idex, jdex ) <A href='../../call_to/WRF_DM_MAXVAL_DOUBLEPRECISION.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_MAXVAL_DOUBLEPRECISION.html' TARGET='index'>1</A><a name='1636'>
# ifndef STUBMPI<a name='1637'>
      use mpi<a name='1638'>
      IMPLICIT NONE<a name='1639'>
      DOUBLE PRECISION val<a name='1640'>
      INTEGER :: idex, jdex, i, comm<a name='1641'>
      INTEGER :: bcast(2),mrank<a name='1642'>
      DOUBLE PRECISION :: inreduce(2),outreduce(2)<a name='1643'>
<a name='1644'>
      inreduce=(/ val, dble(mytask) /)<a name='1645'>
      bcast=(/ idex,jdex /)<a name='1646'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_DOUBLEPRECISION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_25">(comm)<a name='1647'>
      call MPI_Allreduce(inreduce,outreduce,1,MPI_2DOUBLE_PRECISION,&amp;<a name='1648'>
                         MPI_MAXLOC,comm,i)<a name='1649'>
      mrank=outreduce(2)<a name='1650'>
      val=outreduce(1)<a name='1651'>
      call MPI_Bcast(bcast,2,MPI_DOUBLE_PRECISION,mrank,comm,i)<a name='1652'>
      idex=bcast(1)<a name='1653'>
      jdex=bcast(2)<a name='1654'>
# else<a name='1655'>
      IMPLICIT NONE<a name='1656'>
      DOUBLE PRECISION val<a name='1657'>
      INTEGER idex, jdex, ierr<a name='1658'>
# endif<a name='1659'>
   END SUBROUTINE wrf_dm_maxval_doubleprecision<a name='1660'>
<a name='1661'>
<A NAME='WRF_DM_MINVAL_DOUBLEPRECISION'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_DOUBLEPRECISION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1662'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_minval_doubleprecision</font> ( val, idex, jdex ) <A href='../../call_to/WRF_DM_MINVAL_DOUBLEPRECISION.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_MINVAL_DOUBLEPRECISION.html' TARGET='index'>1</A><a name='1663'>
# ifndef STUBMPI<a name='1664'>
      use mpi<a name='1665'>
      IMPLICIT NONE<a name='1666'>
      DOUBLE PRECISION val<a name='1667'>
      INTEGER :: idex, jdex, i, comm<a name='1668'>
      INTEGER :: bcast(2),mrank<a name='1669'>
      DOUBLE PRECISION :: inreduce(2),outreduce(2)<a name='1670'>
<a name='1671'>
      inreduce=(/ val, dble(mytask) /)<a name='1672'>
      bcast=(/ idex,jdex /)<a name='1673'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_DOUBLEPRECISION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_26">(comm)<a name='1674'>
      call MPI_Allreduce(inreduce,outreduce,1,MPI_2DOUBLE_PRECISION,&amp;<a name='1675'>
                         MPI_MINLOC,comm,i)<a name='1676'>
      mrank=outreduce(2)<a name='1677'>
      val=outreduce(1)<a name='1678'>
      call MPI_Bcast(bcast,2,MPI_DOUBLE_PRECISION,mrank,comm,i)<a name='1679'>
      idex=bcast(1)<a name='1680'>
      jdex=bcast(2)<a name='1681'>
# else<a name='1682'>
      IMPLICIT NONE<a name='1683'>
      DOUBLE PRECISION val<a name='1684'>
      INTEGER idex, jdex, ierr<a name='1685'>
# endif<a name='1686'>
   END SUBROUTINE wrf_dm_minval_doubleprecision<a name='1687'>
#endif<a name='1688'>
<a name='1689'>
<A NAME='WRF_DM_MAXVAL_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1690'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_maxval_integer</font> ( val, idex, jdex ) <A href='../../call_to/WRF_DM_MAXVAL_INTEGER.html' TARGET='index'>6</A>,<A href='../../call_from/WRF_DM_MAXVAL_INTEGER.html' TARGET='index'>1</A><a name='1691'>
# ifndef STUBMPI<a name='1692'>
      use mpi<a name='1693'>
      IMPLICIT NONE<a name='1694'>
      INTEGER val<a name='1695'>
      INTEGER :: idex, jdex, i, comm<a name='1696'>
      INTEGER :: bcast(2),mrank<a name='1697'>
      INTEGER :: inreduce(2),outreduce(2)<a name='1698'>
<a name='1699'>
      inreduce=(/ val, mytask /)<a name='1700'>
      bcast=(/ idex,jdex /)<a name='1701'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXVAL_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_27">(comm)<a name='1702'>
      call MPI_Allreduce(inreduce,outreduce,1,MPI_2INTEGER,&amp;<a name='1703'>
                         MPI_MAXLOC,comm,i)<a name='1704'>
      mrank=outreduce(2)<a name='1705'>
      val=outreduce(1)<a name='1706'>
      call MPI_Bcast(bcast,2,MPI_INTEGER,mrank,comm,i)<a name='1707'>
      idex=bcast(1)<a name='1708'>
      jdex=bcast(2)<a name='1709'>
# else<a name='1710'>
      IMPLICIT NONE<a name='1711'>
      INTEGER val<a name='1712'>
      INTEGER idex, jdex, ierr<a name='1713'>
# endif<a name='1714'>
    END SUBROUTINE wrf_dm_maxval_integer<a name='1715'>
<a name='1716'>
<A NAME='WRF_DM_MINVAL_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1717'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_minval_integer</font> ( val, idex, jdex ) <A href='../../call_to/WRF_DM_MINVAL_INTEGER.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_DM_MINVAL_INTEGER.html' TARGET='index'>1</A><a name='1718'>
# ifndef STUBMPI<a name='1719'>
      use mpi<a name='1720'>
      IMPLICIT NONE<a name='1721'>
      INTEGER val<a name='1722'>
      INTEGER :: idex, jdex, i, comm<a name='1723'>
      INTEGER :: bcast(2),mrank<a name='1724'>
      INTEGER :: inreduce(2),outreduce(2)<a name='1725'>
<a name='1726'>
      inreduce=(/ val, mytask /)<a name='1727'>
      bcast=(/ idex,jdex /)<a name='1728'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINVAL_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_28">(comm)<a name='1729'>
      call MPI_Allreduce(inreduce,outreduce,1,MPI_2INTEGER,&amp;<a name='1730'>
                         MPI_MINLOC,comm,i)<a name='1731'>
      mrank=outreduce(2)<a name='1732'>
      val=outreduce(1)<a name='1733'>
      call MPI_Bcast(bcast,2,MPI_INTEGER,mrank,comm,i)<a name='1734'>
      idex=bcast(1)<a name='1735'>
      jdex=bcast(2)<a name='1736'>
# else<a name='1737'>
      IMPLICIT NONE<a name='1738'>
      INTEGER val<a name='1739'>
      INTEGER idex, jdex, ierr<a name='1740'>
# endif<a name='1741'>
    END SUBROUTINE wrf_dm_minval_integer<a name='1742'>
<a name='1743'>
<A NAME='HWRF_COUPLER_INIT'><A href='../../html_code/frame/module_dm.F.html#HWRF_COUPLER_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1744'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>hwrf_coupler_init</font> <A href='../../call_to/HWRF_COUPLER_INIT.html' TARGET='index'>1</A>,<A href='../../call_from/HWRF_COUPLER_INIT.html' TARGET='index'>3</A><a name='1745'>
#if ( HWRF == 1 )<a name='1746'>
# ifndef STUBMPI<a name='1747'>
      IMPLICIT NONE<a name='1748'>
      LOGICAL mpi_inited<a name='1749'>
      INTEGER mpi_comm_here,ierr<a name='1750'>
      CALL MPI_INITIALIZED( mpi_inited, ierr )<a name='1751'>
      IF ( .NOT. mpi_inited ) THEN<a name='1752'>
        IF ( coupler_on ) THEN<a name='1753'>
           CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_INIT'>cpl_init</A><A href='../../html_code/frame/module_dm_stubs.F.html#HWRF_COUPLER_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_INIT_1">( mpi_comm_here )<a name='1754'>
        ELSE<a name='1755'>
           CALL mpi_init ( ierr )<a name='1756'>
           mpi_comm_here = MPI_COMM_WORLD<a name='1757'>
        END IF<a name='1758'>
        CALL atm_cmp_start( mpi_comm_here )<a name='1759'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#HWRF_COUPLER_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_1">( mpi_comm_here )<a name='1760'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_TERMIO_DUP'>wrf_termio_dup</A><A href='../../html_code/frame/module_dm_stubs.F.html#HWRF_COUPLER_INIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_TERMIO_DUP_1">( mpi_comm_here )<a name='1761'>
      END IF<a name='1762'>
      RETURN<a name='1763'>
# endif<a name='1764'>
#endif<a name='1765'>
   END SUBROUTINE hwrf_coupler_init<a name='1766'>
<a name='1767'>
<A NAME='SPLIT_COMMUNICATOR'><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1768'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>split_communicator</font> <A href='../../call_to/SPLIT_COMMUNICATOR.html' TARGET='index'>2</A>,<A href='../../call_from/SPLIT_COMMUNICATOR.html' TARGET='index'>25</A><a name='1769'>
#ifndef STUBMPI<a name='1770'>
      IMPLICIT NONE<a name='1771'>
      LOGICAL mpi_inited<a name='1772'>
<font color=#447700>!      INTEGER mpi_comm_here, mpi_comm_local, comdup, comdup2, origmytask,  mytask, ntasks, ierr, io_status<a name='1773'></font>
      INTEGER mpi_comm_here, mpi_comm_local, comdup, comdup2, origmytask,  ierr, io_status<a name='1774'>
      INTEGER mpi_comm_me_and_mom<a name='1775'>
      INTEGER coords(3)<a name='1776'>
      INTEGER mytask_local,ntasks_local,num_compute_tasks<a name='1777'>
#  if defined(_OPENMP) &amp;&amp; defined(MPI2_THREAD_SUPPORT)<a name='1778'>
      INTEGER thread_support_provided, thread_support_requested<a name='1779'>
#  endif<a name='1780'>
      INTEGER i, j, k, x, y, n_x, n_y<a name='1781'>
      INTEGER iii<a name='1782'>
      INTEGER, ALLOCATABLE :: icolor(:),icolor2(:),idomain(:)<a name='1783'>
      INTEGER comm_id<a name='1784'>
<font color=#447700>! <a name='1785'></font>
<font color=#447700>! Communicator definition                       Domains<a name='1786'></font>
<font color=#447700>!                                                       <a name='1787'></font>
<font color=#447700>!  6 pe Example Comm   PEs                        (1)<a name='1788'></font>
<font color=#447700>!        COMM_WORLD  0 1 2 3 4 5                  / \<a name='1789'></font>
<font color=#447700>!               1    0 1 2 3 4 5                (2) (3)<a name='1790'></font>
<font color=#447700>!               2    0 1                         |<a name='1791'></font>
<font color=#447700>!               3        0 1 2 3                (4)<a name='1792'></font>
<font color=#447700>!               4    0 1<a name='1793'></font>
<font color=#447700>!<a name='1794'></font>
<font color=#447700>!    Notes: 1. No requirement that any communicator be all tasks<a name='1795'></font>
<font color=#447700>!           2. A task may be a member of an arbitrary number <a name='1796'></font>
<font color=#447700>!              of local communicators (But you may not want to do this)<a name='1797'></font>
<font color=#447700>!<a name='1798'></font>
<font color=#447700>!<a name='1799'></font>
<font color=#447700>!  Namelist Split Settings (for 3 comms, 4 domains)<a name='1800'></font>
<font color=#447700>!  Revised namelist semantics -- no need for binding nests to separately defined communicators<a name='1801'></font>
<font color=#447700>!<a name='1802'></font>
<font color=#447700>!   (domain_id)     1    2    3    4<a name='1803'></font>
<font color=#447700>!   parent_id       -    1    1    2<a name='1804'></font>
<font color=#447700>!   comm_start      0    0    2    0<a name='1805'></font>
<font color=#447700>!   nest_pes_x      2    1    2    1<a name='1806'></font>
<font color=#447700>!   nest_pes_y      3    2    2    2<a name='1807'></font>
<font color=#447700>!   <a name='1808'></font>
<font color=#447700>!! superceded<a name='1809'></font>
<font color=#447700>!!  Namelist Split Settings (for 3 comms, 4 domains)<a name='1810'></font>
<font color=#447700>!!   (comm_id)       1    2    3    ...<a name='1811'></font>
<font color=#447700>!!   comm_start      0    0    2<a name='1812'></font>
<font color=#447700>!!   comm_pes_x      2    1    2<a name='1813'></font>
<font color=#447700>!!   comm_pes_y      3    2    2<a name='1814'></font>
<font color=#447700>!!<a name='1815'></font>
<font color=#447700>!!  Domain definitions<a name='1816'></font>
<font color=#447700>!!   (domain_id)     1    2    3    4<a name='1817'></font>
<font color=#447700>!!   parent_id       -    1    1    2<a name='1818'></font>
<font color=#447700>!!   comm_domain     1    2    3    2<a name='1819'></font>
<font color=#447700>!! * nest_pes_x      2    1    2    1<a name='1820'></font>
<font color=#447700>!! * nest_pes_y      3    2    2    2<a name='1821'></font>
<font color=#447700>!!<a name='1822'></font>
<font color=#447700>!!   [* nest_pes_x is comm_pes_x(comm_domain(domain_id))]<a name='1823'></font>
<font color=#447700>!<a name='1824'></font>
<a name='1825'>
      INTEGER dims(3)<a name='1826'>
<font color=#447700>! for parallel nesting, 201408, jm<a name='1827'></font>
      INTEGER :: id<a name='1828'>
      INTEGER :: intercomm <a name='1829'>
      INTEGER :: domain_id,par_id,nest_id,kid_id<a name='1830'>
      INTEGER :: mytask_me_and_mom, ntasks_me_and_mom, remote_leader<a name='1831'>
      LOGICAL :: inthisone<a name='1832'>
      LOGICAL :: mytask_is_nest, mytask_is_par,isperiodic(3)<a name='1833'>
<font color=#447700>! for new quilting<a name='1834'></font>
      LOGICAL :: quilting_is_turned_off<a name='1835'>
<a name='1836'>
<font color=#447700>!!!!! needed to sneak-peek the registry to get parent_id <a name='1837'></font>
<font color=#447700>! define as temporaries<a name='1838'></font>
#include "<A href='../../html_code/include/namelist_defines.inc.html'>namelist_defines.inc</A>"<A NAME="namelist_defines.inc_1"><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1839'>
<a name='1840'>
<font color=#447700>! Statements that specify the namelists<a name='1841'></font>
#include "<A href='../../html_code/include/namelist_statements.inc.html'>namelist_statements.inc</A>"<A NAME="namelist_statements.inc_2"><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1842'>
<a name='1843'>
      CALL MPI_INITIALIZED( mpi_inited, ierr )<a name='1844'>
      IF ( .NOT. mpi_inited ) THEN<a name='1845'>
#  if defined(_OPENMP) &amp;&amp; defined(MPI2_THREAD_SUPPORT)<a name='1846'>
        thread_support_requested = MPI_THREAD_FUNNELED<a name='1847'>
        CALL mpi_init_thread ( thread_support_requested, thread_support_provided, ierr )<a name='1848'>
        IF ( thread_support_provided .lt. thread_support_requested ) THEN<a name='1849'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_185">( "failed to initialize MPI thread support")<a name='1850'>
        END IF<a name='1851'>
        mpi_comm_here = MPI_COMM_WORLD<a name='1852'>
#  else<a name='1853'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='1854'></font>
        IF ( coupler_on ) THEN<a name='1855'>
           CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_INIT'>cpl_init</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_INIT_2">( mpi_comm_here )<a name='1856'>
        ELSE<a name='1857'>
#endif<a name='1858'>
           CALL mpi_init ( ierr )<a name='1859'>
           mpi_comm_here = MPI_COMM_WORLD<a name='1860'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='1861'></font>
        END IF<a name='1862'>
#endif<a name='1863'>
#  endif<a name='1864'>
#if ( HWRF == 1 )<a name='1865'>
<font color=#447700>!!!!! jm 20150807 note that for HWRF, this will not be called here because of the call to hwrf_coupler_init (defined above) in init_modules<a name='1866'></font>
<font color=#447700>!!!!        CALL atm_cmp_start( mpi_comm_here )   ! atmospheric side of HWRF coupler will split MPI_COMM_WORLD and return communicator as argument<a name='1867'></font>
#endif<a name='1868'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_2">( mpi_comm_here )<a name='1869'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_TERMIO_DUP'>wrf_termio_dup</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_TERMIO_DUP_2">( mpi_comm_here )<a name='1870'>
      END IF<a name='1871'>
<font color=#447700>! this should have been reset by init_module_wrf_quilt to be just the compute tasks<a name='1872'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_29">( mpi_comm_here )<a name='1873'>
<a name='1874'>
      CALL MPI_Comm_rank ( mpi_comm_here, mytask_local, ierr ) ;<a name='1875'>
      CALL MPI_Comm_size ( mpi_comm_here, ntasks_local, ierr ) ;<a name='1876'>
      mpi_comm_allcompute = mpi_comm_here<a name='1877'>
<a name='1878'>
      IF ( mytask_local .EQ. 0 ) THEN<a name='1879'>
        max_dom = 1<a name='1880'>
        OPEN ( unit=27, file="namelist.input", form="formatted", status="old" )<a name='1881'>
        READ ( UNIT = 27 , NML = domains , IOSTAT=io_status )<a name='1882'>
        REWIND(27)<a name='1883'>
        nio_groups = 1<a name='1884'>
        nio_tasks_per_group  = 0<a name='1885'>
        poll_servers = .false.<a name='1886'>
        READ ( 27 , NML = namelist_quilt, IOSTAT=io_status )<a name='1887'>
        CLOSE(27)<a name='1888'>
      END IF<a name='1889'>
      CALL mpi_bcast( nio_tasks_per_group  , max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1890'>
      CALL mpi_bcast( nio_groups , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1891'>
      CALL mpi_bcast( max_dom, 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1892'>
      CALL mpi_bcast( parent_id, max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1893'>
#if ( HWRF == 1 )<a name='1894'>
<font color=#447700>! check to make sure that if nio_tasks_per_group is non-zero for any domain it has to be non-zero for all of them<a name='1895'></font>
      i = MAXVAL(nio_tasks_per_group(1:max_dom))<a name='1896'>
      IF ( i .GT. 0 .AND. nio_groups .GT. 0 ) THEN<a name='1897'>
        DO id = 1, max_dom<a name='1898'>
          IF ( nio_tasks_per_group(id) .LE. 0 ) THEN<a name='1899'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_186">( &amp;<a name='1900'>
'If nio_tasks_per_group in namelist.input is non-zero for any domain, every active domain must have a non-zero value in nio_tasks_per_group')<a name='1901'>
          END IF<a name='1902'>
        END DO<a name='1903'>
      END IF<a name='1904'>
<a name='1905'>
      num_io_tasks = 0<a name='1906'>
      DO id = 1, max_dom<a name='1907'>
        num_io_tasks = num_io_tasks + nio_tasks_per_group(id)*nio_groups<a name='1908'>
      END DO<a name='1909'>
#else<a name='1910'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#QUILTING_DISABLED'>quilting_disabled</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QUILTING_DISABLED_1">( quilting_is_turned_off )<a name='1911'>
      IF ( quilting_is_turned_off ) THEN<a name='1912'>
        num_io_tasks = 0<a name='1913'>
        nio_tasks_per_group  = 0<a name='1914'>
        nio_groups = 1<a name='1915'>
      ELSE<a name='1916'>
        num_io_tasks = nio_tasks_per_group(1)*nio_groups<a name='1917'>
      END IF<a name='1918'>
#endif<a name='1919'>
      CALL nl_set_max_dom(1,max_dom)  <font color=#447700>! quilting wants to see this too<a name='1920'></font>
<a name='1921'>
      IF ( mytask_local .EQ. 0 ) THEN<a name='1922'>
        OPEN ( unit=27, file="namelist.input", form="formatted", status="old" )<a name='1923'>
<font color=#447700>! get a sneak peek an nproc_x and nproc_y<a name='1924'></font>
        nproc_x = -1<a name='1925'>
        nproc_y = -1<a name='1926'>
        READ ( 27 , NML = domains, IOSTAT=io_status )<a name='1927'>
        CLOSE ( 27 )<a name='1928'>
        OPEN ( unit=27, file="namelist.input", form="formatted", status="old" )<a name='1929'>
        tasks_per_split = ntasks_local<a name='1930'>
<font color=#447700>! we need to sneak-peek the parent_id namelist setting, ,which is in the "domains" section<a name='1931'></font>
<font color=#447700>! of the namelist.  That namelist is registry generated, so the registry-generated information<a name='1932'></font>
<font color=#447700>! is #included above.<a name='1933'></font>
        nest_pes_x = 0    <font color=#447700>! dimensions of communicator in X and y<a name='1934'></font>
        nest_pes_y = 0<a name='1935'>
        IF ( nproc_x .EQ. -1 .OR. nproc_y .EQ. -1 ) THEN<a name='1936'>
#if ( HWRF == 1 )<a name='1937'>
          CALL <A href='../../html_code/frame/module_dm.F.html#COMPUTE_MESH'>compute_mesh</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_MESH_1">( ntasks_local, n_x, n_y )<a name='1938'>
#else<a name='1939'>
          CALL <A href='../../html_code/frame/module_dm.F.html#COMPUTE_MESH'>compute_mesh</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_MESH_2">( ntasks_local-num_io_tasks, n_x, n_y )<a name='1940'>
#endif<a name='1941'>
        ELSE<a name='1942'>
          n_x = nproc_x<a name='1943'>
          n_y = nproc_y<a name='1944'>
        END IF <a name='1945'>
        comm_start = 0   <font color=#447700>! make it so everyone will use same communicator if the dm_task_split namelist is not specified or is empty<a name='1946'></font>
        nest_pes_x(1:max_dom) = n_x<a name='1947'>
        nest_pes_y(1:max_dom) = n_y<a name='1948'>
        READ ( 27 , NML = dm_task_split, IOSTAT=io_status )<a name='1949'>
        CLOSE ( 27 )<a name='1950'>
      END IF<a name='1951'>
      CALL mpi_bcast( io_status, 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1952'>
      IF ( io_status .NE. 0 ) THEN<a name='1953'>
<font color=#447700>! or if  dm_task_split was read but was emptly, do nothing: dm_task_split not specified, everyone uses same communicator (see above)<a name='1954'></font>
      END IF<a name='1955'>
      CALL mpi_bcast( tasks_per_split, 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1956'>
      CALL mpi_bcast( nproc_x, 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1957'>
      CALL mpi_bcast( nproc_y, 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1958'>
      CALL mpi_bcast( comm_start, max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1959'>
      CALL mpi_bcast( nest_pes_x, max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1960'>
      CALL mpi_bcast( nest_pes_y, max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='1961'>
<a name='1962'>
      nkids = 1<a name='1963'>
      which_kid = 0<a name='1964'>
      DO i = 2, max_dom<a name='1965'>
        IF ( 1 .le. parent_id(i) .AND. parent_id(i) .LE. max_domains ) THEN<a name='1966'>
          which_kid(i) = nkids(parent_id(i))<a name='1967'>
          nkids(parent_id(i)) = nkids(parent_id(i)) + 1<a name='1968'>
        ELSE<a name='1969'>
          WRITE(wrf_err_message,*)'invalid parent id for domain ',i<a name='1970'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_187">(TRIM(wrf_err_message))<a name='1971'>
        END IF <a name='1972'>
      END DO<a name='1973'>
<a name='1974'>
      num_compute_tasks = -99<a name='1975'>
      DO nest_id = 1,max_dom<a name='1976'>
        IF ( nest_id .EQ. 1 ) THEN<a name='1977'>
          nest_task_offsets(nest_id) = comm_start(nest_id)<a name='1978'>
        ELSE<a name='1979'>
          IF ( comm_start(nest_id) .LT. comm_start(parent_id(nest_id)) ) THEN<a name='1980'>
            WRITE(wrf_err_message,&amp;<a name='1981'>
        "('nest domain ',i3,'comm_start (',i3,') lt parent ',i3,' comm_start (',i3,')')") &amp;<a name='1982'>
                   nest_id,comm_start,parent_id(nest_id),comm_start(parent_id(nest_id))<a name='1983'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_188">(TRIM(wrf_err_message))<a name='1984'>
          ELSE IF ( comm_start(nest_id) .LT. &amp;<a name='1985'>
                    comm_start(parent_id(nest_id)) &amp;<a name='1986'>
                   +nest_pes_x(parent_id(nest_id))*nest_pes_y(parent_id(nest_id))) THEN<a name='1987'>
            nest_task_offsets(nest_id) = comm_start(nest_id)-comm_start(parent_id(nest_id))<a name='1988'>
          ELSE<a name='1989'>
            nest_task_offsets(nest_id) = nest_pes_x(parent_id(nest_id))*nest_pes_y(parent_id(nest_id))<a name='1990'>
          END IF<a name='1991'>
        END IF<a name='1992'>
        IF ((comm_start(nest_id)+nest_pes_x(nest_id)*nest_pes_y(nest_id)) .GT. num_compute_tasks ) THEN<a name='1993'>
          num_compute_tasks = (comm_start(nest_id)+nest_pes_x(nest_id)*nest_pes_y(nest_id))<a name='1994'>
        END IF<a name='1995'>
      END DO<a name='1996'>
<a name='1997'>
      IF ( .TRUE. ) THEN<a name='1998'>
<font color=#447700>!jm Additional code here to set up communicator for this domain and tables<a name='1999'></font>
<font color=#447700>!jm mapping individual domain task IDs to the original local communicator<a name='2000'></font>
<font color=#447700>!jm that is unsplit over nest domains.  from now on what we are calling<a name='2001'></font>
<font color=#447700>!jm local_communicator will be the communicator that is used by the local<a name='2002'></font>
<font color=#447700>!jm nests. The communicator that spans all the nests will be renamed to<a name='2003'></font>
<font color=#447700>!jm intercomm_communicator.  <a name='2004'></font>
<font color=#447700>!jm Design note: exploring the idea of using MPI intercommunicators.  They <a name='2005'></font>
<font color=#447700>!jm only work in pairs so we'd have a lot of intercommunicators to set up <a name='2006'></font>
<font color=#447700>!jm and keep around. We'd also have to have additional communicator arguments <a name='2007'></font>
<font color=#447700>!jm to all the nesting routines in and around the RSL nesting parts.<a name='2008'></font>
        CALL MPI_Comm_rank ( mpi_comm_here, mytask_local, ierr ) ;<a name='2009'>
        CALL MPI_Comm_rank ( mpi_comm_here, origmytask, ierr ) ;<a name='2010'>
        CALL mpi_comm_size ( mpi_comm_here, ntasks_local, ierr ) ;<a name='2011'>
        ALLOCATE( icolor(ntasks_local) )<a name='2012'>
        ALLOCATE( icolor2(ntasks_local) )<a name='2013'>
        ALLOCATE( idomain(ntasks_local) )<a name='2014'>
        k = 0<a name='2015'>
<font color=#447700>! split off the separate local communicators<a name='2016'></font>
<a name='2017'>
<font color=#447700>! construct list of local communicators my task is in<a name='2018'></font>
        comms_i_am_in = MPI_UNDEFINED<a name='2019'>
        DO i = 1, max_dom<a name='2020'>
          inthisone = .FALSE.<a name='2021'>
          icolor = 0<a name='2022'>
          DO j = comm_start(i), comm_start(i)+nest_pes_x(i)*nest_pes_y(i)-1<a name='2023'>
            IF ( j+1 .GT. ntasks_local ) THEN<a name='2024'>
              WRITE(wrf_err_message,*)"check comm_start, nest_pes_x, nest_pes_y settings in namelist for comm ",i<a name='2025'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_189">(wrf_err_message)<a name='2026'>
            END IF<a name='2027'>
            icolor(j+1) = 1<a name='2028'>
          END DO<a name='2029'>
          IF ( icolor(mytask_local+1) .EQ. 1 ) inthisone = .TRUE.<a name='2030'>
          CALL MPI_Comm_dup(mpi_comm_here,comdup,ierr)<a name='2031'>
          CALL MPI_Comm_split(comdup,icolor(mytask_local+1),mytask_local,mpi_comm_local,ierr)<a name='2032'>
          IF ( inthisone ) THEN<a name='2033'>
            dims(1) = nest_pes_y(i) <font color=#447700>! rows<a name='2034'></font>
            dims(2) = nest_pes_x(i)  <font color=#447700>! columns<a name='2035'></font>
            isperiodic(1) = .false.<a name='2036'>
            isperiodic(2) = .false.<a name='2037'>
            CALL mpi_cart_create( mpi_comm_local, 2, dims, isperiodic, .false., comms_i_am_in(i), ierr )<a name='2038'>
          END IF<a name='2039'>
        END DO<a name='2040'>
<a name='2041'>
<font color=#447700>! assign domains to communicators<a name='2042'></font>
        local_communicator = MPI_UNDEFINED<a name='2043'>
#if ( HWRF <font color=#447700>!= 1 )<a name='2044'></font>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_QUILT_COMM'>wrf_set_dm_quilt_comm</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_QUILT_COMM_1">( mpi_comm_here )   <font color=#447700>! used by module_io_quilt_old.F<a name='2045'></font>
#endif<a name='2046'>
        DO i = 1, max_dom<a name='2047'>
          local_communicator_store(i) = comms_i_am_in(i)<a name='2048'>
          domain_active_this_task(i) = ( local_communicator_store(i) .NE. MPI_UNDEFINED )<a name='2049'>
          IF ( local_communicator_store(i) .NE. MPI_UNDEFINED ) THEN<a name='2050'>
             CALL MPI_Comm_size( local_communicator_store(i), ntasks_store(i), ierr )<a name='2051'>
             CALL MPI_Comm_rank( local_communicator_store(i), mytask_store(i), ierr )<a name='2052'>
             CALL mpi_cart_coords( local_communicator_store(i), mytask_store(i), 2, coords, ierr )<a name='2053'>
             IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_190">('MPI_cart_coords fails ')<a name='2054'>
             mytask_y_store(i) = coords(1)   <font color=#447700>! col task (1)<a name='2055'></font>
             mytask_x_store(i) = coords(2)   <font color=#447700>! col task (x)<a name='2056'></font>
             CALL MPI_Comm_dup( local_communicator_store(i), comdup2, ierr )<a name='2057'>
             IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_191">('MPI_Comm_dup fails ')<a name='2058'>
<a name='2059'>
             CALL MPI_Comm_split(comdup2,mytask_y_store(i),mytask_store(i),local_communicator_x_store(i),ierr)<a name='2060'>
             IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_192">('MPI_Comm_split fails for y ')<a name='2061'>
<a name='2062'>
             CALL MPI_Comm_split(comdup2,mytask_x_store(i),mytask_store(i),local_communicator_y_store(i),ierr)<a name='2063'>
             IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_193">('MPI_Comm_split fails for x ')<a name='2064'>
<a name='2065'>
             CALL MPI_Comm_size( local_communicator_x_store(i), ntasks_x_store(i), ierr )<a name='2066'>
             CALL MPI_Comm_rank( local_communicator_x_store(i), mytask_x_store(i), ierr )<a name='2067'>
             CALL MPI_Comm_size( local_communicator_y_store(i), ntasks_y_store(i), ierr )<a name='2068'>
             CALL MPI_Comm_rank( local_communicator_y_store(i), mytask_y_store(i), ierr )<a name='2069'>
          END IF<a name='2070'>
        END DO<a name='2071'>
<a name='2072'>
        intercomm_active  = .FALSE.<a name='2073'>
        <font color=#447700>! iterate over parent-nest pairs<a name='2074'></font>
        <font color=#447700>! split off a new communicator from the big one that includes the tasks from the parent and nest communicators<a name='2075'></font>
        <font color=#447700>! starting with the parent tasks followed by the nest tasks<a name='2076'></font>
        <font color=#447700>! if a task is in both (ie. the communicators overlap) set the offset at the start of the first nest task<a name='2077'></font>
        <font color=#447700>! in this way, we will handle cases where the parent and nest are decomposed over the same set of tasks<a name='2078'></font>
        <font color=#447700>! (in that case, the offset would be the first task of the parent-nest communicator and that communicator)<a name='2079'></font>
<a name='2080'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='2081'></font>
        ntasks_local = num_compute_tasks<a name='2082'>
        DO nest_id = 2, max_dom<a name='2083'>
           par_id  = parent_id(nest_id)<a name='2084'>
           icolor2 = 0<a name='2085'>
           DO j = 1,ntasks_local <font color=#447700>!iterate over all the tasks in the "big" communicator<a name='2086'></font>
             IF ( local_communicator_store( par_id ) .NE. MPI_UNDEFINED .OR. local_communicator_store( nest_id ) .NE. MPI_UNDEFINED ) icolor2(j)=1<a name='2087'>
           END DO<a name='2088'>
        <font color=#447700>! set mpi_comm_me_and_mom to be a communicator that has my parents tasks and mine<a name='2089'></font>
           icolor2 = 0<a name='2090'>
           mytask_is_nest = .FALSE.<a name='2091'>
           mytask_is_par = .FALSE.<a name='2092'>
           DO j = 1,ntasks_local<a name='2093'>
<a name='2094'>
             IF ( comm_start(nest_id) .LE. j-1 .AND. j-1 .LT. comm_start(nest_id) + nest_pes_x(nest_id)*nest_pes_y(nest_id) )  THEN<a name='2095'>
               icolor2(j)=1<a name='2096'>
               if ( j-1 .EQ. mytask_local ) mytask_is_nest=.TRUE.<a name='2097'>
             END IF<a name='2098'>
             IF ( comm_start(par_id ) .LE. j-1 .AND. j-1 .LT. comm_start(par_id ) + nest_pes_x(par_id )*nest_pes_y(par_id ) )  THEN<a name='2099'>
               icolor2(j)=1<a name='2100'>
               if ( j-1 .EQ. mytask_local ) mytask_is_par=.TRUE.<a name='2101'>
             END IF<a name='2102'>
           END DO<a name='2103'>
<a name='2104'>
           i = icolor2(mytask_local+1)<a name='2105'>
           CALL MPI_Comm_dup(mpi_comm_here,comdup,ierr)<a name='2106'>
           CALL MPI_Comm_split(comdup,i,origmytask,mpi_comm_me_and_mom,ierr)<a name='2107'>
<a name='2108'>
           IF ( mytask_is_nest  ) THEN<a name='2109'>
              intercomm_active(nest_id)  = .TRUE.<a name='2110'>
              mpi_comm_to_mom(nest_id)   =  mpi_comm_me_and_mom<a name='2111'>
           END IF<a name='2112'>
           IF ( mytask_is_par ) THEN<a name='2113'>
              intercomm_active(par_id)              = .TRUE.<a name='2114'>
              mpi_comm_to_kid(which_kid(nest_id),par_id)  =  mpi_comm_me_and_mom<a name='2115'>
           END IF<a name='2116'>
        END DO<a name='2117'>
        DEALLOCATE( icolor )<a name='2118'>
        DEALLOCATE( icolor2 )<a name='2119'>
        DEALLOCATE( idomain )<a name='2120'>
<a name='2121'>
      ELSE IF ( ( tasks_per_split .LE. ntasks_local .AND. tasks_per_split .LE. 0 ) ) THEN<a name='2122'>
        domain_active_this_task(1) = .TRUE.<a name='2123'>
        IF ( mod( ntasks_local, tasks_per_split ) .NE. 0 ) THEN<a name='2124'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_320">( 'WARNING: tasks_per_split does not evenly divide ntasks. Some tasks will be wasted.' )<a name='2125'>
        END IF<a name='2126'>
<a name='2127'>
        ALLOCATE( icolor(ntasks_local) )<a name='2128'>
        j = 0<a name='2129'>
        DO WHILE ( j .LT. ntasks_local / tasks_per_split ) <a name='2130'>
          DO i = 1, tasks_per_split<a name='2131'>
            icolor( i + j * tasks_per_split ) = j <a name='2132'>
          END DO<a name='2133'>
          j = j + 1<a name='2134'>
        END DO<a name='2135'>
<a name='2136'>
        CALL MPI_Comm_dup(mpi_comm_here,comdup,ierr)<a name='2137'>
        CALL MPI_Comm_split(comdup,icolor(mytask_local+1),mytask_local,mpi_comm_local,ierr)<a name='2138'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_3">( mpi_comm_local )<a name='2139'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#STORE_COMMUNICATORS_FOR_DOMAIN'>store_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_COMMUNICATORS_FOR_DOMAIN_1">(1)<a name='2140'>
        DEALLOCATE( icolor )<a name='2141'>
      ELSE<a name='2142'>
        domain_active_this_task(1) = .TRUE.<a name='2143'>
        mpi_comm_local = mpi_comm_here<a name='2144'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_4">( mpi_comm_local )<a name='2145'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#STORE_COMMUNICATORS_FOR_DOMAIN'>store_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_COMMUNICATORS_FOR_DOMAIN_2">(1)<a name='2146'>
      END IF<a name='2147'>
<a name='2148'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#INSTATE_COMMUNICATORS_FOR_DOMAIN'>instate_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INSTATE_COMMUNICATORS_FOR_DOMAIN_2">(1)<a name='2149'>
<a name='2150'>
#else<a name='2151'>
<font color=#447700>! for serial (non-MPI) builds<a name='2152'></font>
      IMPLICIT NONE<a name='2153'>
#  if defined(_OPENMP) &amp;&amp; defined(MPI2_THREAD_SUPPORT)<a name='2154'>
      INTEGER thread_support_provided, thread_support_requested<a name='2155'>
#  endif<a name='2156'>
      INTEGER i, j, k, x, y, n_x, n_y<a name='2157'>
      INTEGER iii<a name='2158'>
      INTEGER dims(3)<a name='2159'>
<font color=#447700>! for parallel nesting, 201408, jm<a name='2160'></font>
      INTEGER :: id<a name='2161'>
      INTEGER :: io_status<a name='2162'>
      INTEGER :: domain_id,par_id,nest_id,kid_id<a name='2163'>
<a name='2164'>
<font color=#447700>!!!!! needed to sneak-peek the registry to get parent_id <a name='2165'></font>
<font color=#447700>! define as temporaries<a name='2166'></font>
#include "<A href='../../html_code/include/namelist_defines.inc.html'>namelist_defines.inc</A>"<A NAME="namelist_defines.inc_3"><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2167'>
<a name='2168'>
<font color=#447700>! Statements that specify the namelists<a name='2169'></font>
#include "<A href='../../html_code/include/namelist_statements.inc.html'>namelist_statements.inc</A>"<A NAME="namelist_statements.inc_4"><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2170'>
<a name='2171'>
      max_dom = 1<a name='2172'>
      OPEN ( unit=27, file="namelist.input", form="formatted", status="old" )<a name='2173'>
      READ ( UNIT = 27 , NML = domains , IOSTAT=io_status )<a name='2174'>
      CLOSE(27)<a name='2175'>
<a name='2176'>
      nkids = 1<a name='2177'>
      which_kid = 0<a name='2178'>
      DO i = 2, max_dom<a name='2179'>
        IF ( 1 .le. parent_id(i) .AND. parent_id(i) .LE. max_domains ) THEN<a name='2180'>
          which_kid(i) = nkids(parent_id(i))<a name='2181'>
          nkids(parent_id(i)) = nkids(parent_id(i)) + 1<a name='2182'>
        ELSE<a name='2183'>
          WRITE(wrf_err_message,*)'invalid parent id for domain ',i<a name='2184'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_194">(TRIM(wrf_err_message))<a name='2185'>
        END IF<a name='2186'>
      END DO<a name='2187'>
<a name='2188'>
      intercomm_active = .TRUE.<a name='2189'>
      domain_active_this_task = .TRUE.<a name='2190'>
      ntasks_stack = 1<a name='2191'>
      ntasks_y_stack = 1<a name='2192'>
      ntasks_x_stack = 1<a name='2193'>
      mytask_stack = 0<a name='2194'>
      mytask_x_stack = 0<a name='2195'>
      mytask_y_stack = 0<a name='2196'>
      ntasks_store = 1<a name='2197'>
      ntasks_y_store = 1<a name='2198'>
      ntasks_x_store = 1<a name='2199'>
      mytask_store = 0<a name='2200'>
      mytask_x_store = 0<a name='2201'>
      mytask_y_store = 0<a name='2202'>
      ntasks = 1<a name='2203'>
      ntasks_y = 1<a name='2204'>
      ntasks_x = 1<a name='2205'>
      mytask = 0<a name='2206'>
      mytask_x = 0<a name='2207'>
      mytask_y = 0<a name='2208'>
      nest_pes_x = 1<a name='2209'>
      nest_pes_y = 1<a name='2210'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#INSTATE_COMMUNICATORS_FOR_DOMAIN'>instate_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#SPLIT_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INSTATE_COMMUNICATORS_FOR_DOMAIN_3">(1)<a name='2211'>
#endif<a name='2212'>
   END SUBROUTINE split_communicator<a name='2213'>
<a name='2214'>
<A NAME='INIT_MODULE_DM'><A href='../../html_code/frame/module_dm.F.html#INIT_MODULE_DM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2215'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_dm</font> <A href='../../call_to/INIT_MODULE_DM.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_MODULE_DM.html' TARGET='index'>2</A><a name='2216'>
#ifndef STUBMPI<a name='2217'>
      IMPLICIT NONE<a name='2218'>
      INTEGER mpi_comm_local, mpi_comm_here, ierr, mytask, nproc<a name='2219'>
      LOGICAL mpi_inited<a name='2220'>
      CALL mpi_initialized( mpi_inited, ierr )<a name='2221'>
      IF ( .NOT. mpi_inited ) THEN<a name='2222'>
        <font color=#447700>! If MPI has not been initialized then initialize it and<a name='2223'></font>
        <font color=#447700>! make comm_world the communicator<a name='2224'></font>
        <font color=#447700>! Otherwise, something else (e.g. split_communicator) has already<a name='2225'></font>
        <font color=#447700>! initialized MPI, so just grab the communicator that<a name='2226'></font>
        <font color=#447700>! should already be stored and use that.<a name='2227'></font>
        CALL mpi_init ( ierr )<a name='2228'>
        mpi_comm_here = MPI_COMM_WORLD<a name='2229'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#INIT_MODULE_DM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_5"> ( mpi_comm_here )<a name='2230'>
      END IF<a name='2231'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#INIT_MODULE_DM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_30">( mpi_comm_local )<a name='2232'>
#endif<a name='2233'>
   END SUBROUTINE init_module_dm<a name='2234'>
<a name='2235'>
<font color=#447700>! stub<a name='2236'></font>
<A NAME='WRF_DM_MOVE_NEST'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MOVE_NEST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2237'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_move_nest</font> ( parent, nest, dx, dy ) <A href='../../call_to/WRF_DM_MOVE_NEST.html' TARGET='index'>3</A>,<A href='../../call_from/WRF_DM_MOVE_NEST.html' TARGET='index'>2</A><a name='2238'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MOVE_NEST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_106">, ONLY : domain<a name='2239'>
      IMPLICIT NONE<a name='2240'>
      TYPE (domain), INTENT(INOUT) :: parent, nest<a name='2241'>
      INTEGER, INTENT(IN)          :: dx,dy<a name='2242'>
      RETURN<a name='2243'>
   END SUBROUTINE wrf_dm_move_nest<a name='2244'>
<a name='2245'>
<font color=#447700>!------------------------------------------------------------------------------<a name='2246'></font>
<A NAME='GET_FULL_OBS_VECTOR'><A href='../../html_code/frame/module_dm.F.html#GET_FULL_OBS_VECTOR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2247'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_full_obs_vector</font>( nsta, nerrf, niobf,          &amp; <A href='../../call_to/GET_FULL_OBS_VECTOR.html' TARGET='index'>1</A>,<A href='../../call_from/GET_FULL_OBS_VECTOR.html' TARGET='index'>1</A><a name='2248'>
                                   mp_local_uobmask,            &amp;<a name='2249'>
                                   mp_local_vobmask,            &amp;<a name='2250'>
                                   mp_local_cobmask, errf )<a name='2251'>
      <a name='2252'>
<font color=#447700>!------------------------------------------------------------------------------<a name='2253'></font>
<font color=#447700>!  PURPOSE: Do MPI allgatherv operation across processors to get the<a name='2254'></font>
<font color=#447700>!           errors at each observation point on all processors. <a name='2255'></font>
<font color=#447700>!       <a name='2256'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='2257'></font>
        <a name='2258'>
    INTEGER, INTENT(IN)   :: nsta                <font color=#447700>! Observation index.<a name='2259'></font>
    INTEGER, INTENT(IN)   :: nerrf               <font color=#447700>! Number of error fields.<a name='2260'></font>
    INTEGER, INTENT(IN)   :: niobf               <font color=#447700>! Number of observations.<a name='2261'></font>
    LOGICAL, INTENT(IN)   :: MP_LOCAL_UOBMASK(NIOBF)<a name='2262'>
    LOGICAL, INTENT(IN)   :: MP_LOCAL_VOBMASK(NIOBF)<a name='2263'>
    LOGICAL, INTENT(IN)   :: MP_LOCAL_COBMASK(NIOBF)<a name='2264'>
    REAL, INTENT(INOUT)   :: errf(nerrf, niobf)<a name='2265'>
<a name='2266'>
#ifndef STUBMPI<a name='2267'>
        <a name='2268'>
<font color=#447700>! Local declarations<a name='2269'></font>
    integer i, n, nlocal_dot, nlocal_crs<a name='2270'>
    REAL UVT_BUFFER(NIOBF)    <font color=#447700>! Buffer for holding U, V, or T<a name='2271'></font>
    REAL QRK_BUFFER(NIOBF)    <font color=#447700>! Buffer for holding Q or RKO<a name='2272'></font>
    REAL SFP_BUFFER(NIOBF)    <font color=#447700>! Buffer for holding Surface pressure<a name='2273'></font>
    REAL PBL_BUFFER(NIOBF)    <font color=#447700>! Buffer for holding (real) KPBL index<a name='2274'></font>
    REAL QATOB_BUFFER(NIOBF)  <font color=#447700>! Buffer for holding QV at the ob location<a name='2275'></font>
    INTEGER N_BUFFER(NIOBF)<a name='2276'>
    REAL FULL_BUFFER(NIOBF)<a name='2277'>
    INTEGER IFULL_BUFFER(NIOBF)<a name='2278'>
    INTEGER IDISPLACEMENT(1024)   <font color=#447700>! HARD CODED MAX NUMBER OF PROCESSORS<a name='2279'></font>
    INTEGER ICOUNT(1024)          <font color=#447700>! HARD CODED MAX NUMBER OF PROCESSORS<a name='2280'></font>
<a name='2281'>
    INTEGER :: MPI_COMM_COMP      <font color=#447700>! MPI group communicator<a name='2282'></font>
    INTEGER :: NPROCS             <font color=#447700>! Number of processors<a name='2283'></font>
    INTEGER :: IERR               <font color=#447700>! Error code from MPI routines<a name='2284'></font>
<a name='2285'>
<font color=#447700>! Get communicator for MPI operations.<a name='2286'></font>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>WRF_GET_DM_COMMUNICATOR</A><A href='../../html_code/frame/module_dm.F.html#GET_FULL_OBS_VECTOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_31">(MPI_COMM_COMP)<a name='2287'>
<a name='2288'>
<font color=#447700>! Get rank of monitor processor and broadcast to others.<a name='2289'></font>
    CALL MPI_COMM_SIZE( MPI_COMM_COMP, NPROCS, IERR )<a name='2290'>
<a name='2291'>
<font color=#447700>! DO THE U FIELD<a name='2292'></font>
   NLOCAL_DOT = 0<a name='2293'>
   DO N = 1, NSTA<a name='2294'>
     IF ( MP_LOCAL_UOBMASK(N) ) THEN      <font color=#447700>! USE U-POINT MASK<a name='2295'></font>
       NLOCAL_DOT = NLOCAL_DOT + 1<a name='2296'>
       UVT_BUFFER(NLOCAL_DOT) = ERRF(1,N)        <font color=#447700>! U WIND COMPONENT<a name='2297'></font>
       SFP_BUFFER(NLOCAL_DOT) = ERRF(7,N)        <font color=#447700>! SURFACE PRESSURE<a name='2298'></font>
       QRK_BUFFER(NLOCAL_DOT) = ERRF(9,N)        <font color=#447700>! RKO<a name='2299'></font>
       N_BUFFER(NLOCAL_DOT) = N<a name='2300'>
     END IF<a name='2301'>
   END DO<a name='2302'>
   CALL MPI_ALLGATHER(NLOCAL_DOT,1,MPI_INTEGER, &amp;<a name='2303'>
                      ICOUNT,1,MPI_INTEGER,     &amp;<a name='2304'>
                      MPI_COMM_COMP,IERR)<a name='2305'>
   I = 1<a name='2306'>
<a name='2307'>
   IDISPLACEMENT(1) = 0<a name='2308'>
   DO I = 2, NPROCS<a name='2309'>
     IDISPLACEMENT(I) = IDISPLACEMENT(I-1) + ICOUNT(I-1)<a name='2310'>
   END DO<a name='2311'>
   CALL MPI_ALLGATHERV( N_BUFFER, NLOCAL_DOT, MPI_INTEGER,    &amp;<a name='2312'>
                        IFULL_BUFFER, ICOUNT, IDISPLACEMENT,  &amp;<a name='2313'>
                        MPI_INTEGER, MPI_COMM_COMP, IERR)<a name='2314'>
<font color=#447700>! U<a name='2315'></font>
   CALL MPI_ALLGATHERV( UVT_BUFFER, NLOCAL_DOT, MPI_REAL,     &amp;<a name='2316'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2317'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2318'>
   DO N = 1, NSTA<a name='2319'>
     ERRF(1,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2320'>
   END DO<a name='2321'>
<font color=#447700>! SURF PRESS AT U-POINTS<a name='2322'></font>
   CALL MPI_ALLGATHERV( SFP_BUFFER, NLOCAL_DOT, MPI_REAL,     &amp;<a name='2323'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2324'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2325'>
   DO N = 1, NSTA<a name='2326'>
     ERRF(7,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2327'>
   END DO<a name='2328'>
<font color=#447700>! RKO<a name='2329'></font>
   CALL MPI_ALLGATHERV( QRK_BUFFER, NLOCAL_DOT, MPI_REAL,     &amp;<a name='2330'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2331'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2332'>
   DO N = 1, NSTA<a name='2333'>
     ERRF(9,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2334'>
   END DO<a name='2335'>
<a name='2336'>
<font color=#447700>! DO THE V FIELD<a name='2337'></font>
   NLOCAL_DOT = 0<a name='2338'>
   DO N = 1, NSTA<a name='2339'>
     IF ( MP_LOCAL_VOBMASK(N) ) THEN         <font color=#447700>! USE V-POINT MASK<a name='2340'></font>
       NLOCAL_DOT = NLOCAL_DOT + 1<a name='2341'>
       UVT_BUFFER(NLOCAL_DOT) = ERRF(2,N)    <font color=#447700>! V WIND COMPONENT<a name='2342'></font>
       SFP_BUFFER(NLOCAL_DOT) = ERRF(8,N)    <font color=#447700>! SURFACE PRESSURE<a name='2343'></font>
       N_BUFFER(NLOCAL_DOT) = N<a name='2344'>
     END IF<a name='2345'>
   END DO<a name='2346'>
   CALL MPI_ALLGATHER(NLOCAL_DOT,1,MPI_INTEGER, &amp;<a name='2347'>
                      ICOUNT,1,MPI_INTEGER,     &amp;<a name='2348'>
                      MPI_COMM_COMP,IERR)<a name='2349'>
   I = 1<a name='2350'>
<a name='2351'>
   IDISPLACEMENT(1) = 0<a name='2352'>
   DO I = 2, NPROCS<a name='2353'>
     IDISPLACEMENT(I) = IDISPLACEMENT(I-1) + ICOUNT(I-1)<a name='2354'>
   END DO<a name='2355'>
   CALL MPI_ALLGATHERV( N_BUFFER, NLOCAL_DOT, MPI_INTEGER,    &amp;<a name='2356'>
                        IFULL_BUFFER, ICOUNT, IDISPLACEMENT,  &amp;<a name='2357'>
                        MPI_INTEGER, MPI_COMM_COMP, IERR)<a name='2358'>
<font color=#447700>! V<a name='2359'></font>
   CALL MPI_ALLGATHERV( UVT_BUFFER, NLOCAL_DOT, MPI_REAL,     &amp;<a name='2360'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2361'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2362'>
   DO N = 1, NSTA<a name='2363'>
     ERRF(2,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2364'>
   END DO<a name='2365'>
<font color=#447700>! SURF PRESS AT V-POINTS<a name='2366'></font>
   CALL MPI_ALLGATHERV( SFP_BUFFER, NLOCAL_DOT, MPI_REAL,     &amp;<a name='2367'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2368'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2369'>
   DO N = 1, NSTA<a name='2370'>
     ERRF(8,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2371'>
   END DO<a name='2372'>
<a name='2373'>
<font color=#447700>! DO THE CROSS FIELDS, T AND Q<a name='2374'></font>
   NLOCAL_CRS = 0<a name='2375'>
   DO N = 1, NSTA<a name='2376'>
     IF ( MP_LOCAL_COBMASK(N) ) THEN       <font color=#447700>! USE MASS-POINT MASK<a name='2377'></font>
       NLOCAL_CRS = NLOCAL_CRS + 1<a name='2378'>
       UVT_BUFFER(NLOCAL_CRS) = ERRF(3,N)     <font color=#447700>! TEMPERATURE<a name='2379'></font>
       QRK_BUFFER(NLOCAL_CRS) = ERRF(4,N)     <font color=#447700>! MOISTURE<a name='2380'></font>
       PBL_BUFFER(NLOCAL_CRS) = ERRF(5,N)     <font color=#447700>! KPBL<a name='2381'></font>
       SFP_BUFFER(NLOCAL_CRS) = ERRF(6,N)     <font color=#447700>! SURFACE PRESSURE<a name='2382'></font>
       QATOB_BUFFER(NLOCAL_CRS) = ERRF(10,N)     <font color=#447700>! Model Mixing ratio itself (NOT ERROR)<a name='2383'></font>
       N_BUFFER(NLOCAL_CRS) = N<a name='2384'>
     END IF<a name='2385'>
   END DO<a name='2386'>
   CALL MPI_ALLGATHER(NLOCAL_CRS,1,MPI_INTEGER, &amp;<a name='2387'>
                      ICOUNT,1,MPI_INTEGER,     &amp;<a name='2388'>
                      MPI_COMM_COMP,IERR)<a name='2389'>
   IDISPLACEMENT(1) = 0<a name='2390'>
   DO I = 2, NPROCS<a name='2391'>
     IDISPLACEMENT(I) = IDISPLACEMENT(I-1) + ICOUNT(I-1)<a name='2392'>
   END DO<a name='2393'>
   CALL MPI_ALLGATHERV( N_BUFFER, NLOCAL_CRS, MPI_INTEGER,    &amp;<a name='2394'>
                        IFULL_BUFFER, ICOUNT, IDISPLACEMENT,  &amp;<a name='2395'>
                        MPI_INTEGER, MPI_COMM_COMP, IERR)<a name='2396'>
<font color=#447700>! T<a name='2397'></font>
   CALL MPI_ALLGATHERV( UVT_BUFFER, NLOCAL_CRS, MPI_REAL,     &amp;<a name='2398'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2399'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2400'>
<a name='2401'>
   DO N = 1, NSTA<a name='2402'>
     ERRF(3,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2403'>
   END DO<a name='2404'>
<font color=#447700>! Q<a name='2405'></font>
   CALL MPI_ALLGATHERV( QRK_BUFFER, NLOCAL_CRS, MPI_REAL,     &amp;<a name='2406'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2407'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2408'>
   DO N = 1, NSTA<a name='2409'>
     ERRF(4,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2410'>
   END DO<a name='2411'>
<font color=#447700>! KPBL<a name='2412'></font>
   CALL MPI_ALLGATHERV( PBL_BUFFER, NLOCAL_CRS, MPI_REAL,     &amp;<a name='2413'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2414'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2415'>
   DO N = 1, NSTA<a name='2416'>
     ERRF(5,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2417'>
   END DO<a name='2418'>
<font color=#447700>! SURF PRESS AT MASS POINTS<a name='2419'></font>
   CALL MPI_ALLGATHERV( SFP_BUFFER, NLOCAL_CRS, MPI_REAL,     &amp;<a name='2420'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2421'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2422'>
   DO N = 1, NSTA<a name='2423'>
     ERRF(6,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2424'>
   END DO<a name='2425'>
<a name='2426'>
<font color=#447700>! Water vapor mixing ratio at the mass points (NOT THE ERROR)<a name='2427'></font>
   CALL MPI_ALLGATHERV( QATOB_BUFFER, NLOCAL_CRS, MPI_REAL,     &amp;<a name='2428'>
                        FULL_BUFFER, ICOUNT, IDISPLACEMENT,   &amp;<a name='2429'>
                        MPI_REAL, MPI_COMM_COMP, IERR)<a name='2430'>
   DO N = 1, NSTA<a name='2431'>
     ERRF(10,IFULL_BUFFER(N)) = FULL_BUFFER(N)<a name='2432'>
   END DO<a name='2433'>
<a name='2434'>
#endif<a name='2435'>
   END SUBROUTINE get_full_obs_vector<a name='2436'>
<a name='2437'>
<a name='2438'>
<a name='2439'>
<A NAME='WRF_DM_MAXTILE_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MAXTILE_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2440'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_maxtile_real</font> ( val , tile) <A href='../../call_to/WRF_DM_MAXTILE_REAL.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_DM_MAXTILE_REAL.html' TARGET='index'>1</A><a name='2441'>
      IMPLICIT NONE<a name='2442'>
      REAL val, val_all( ntasks )<a name='2443'>
      INTEGER tile<a name='2444'>
      INTEGER ierr<a name='2445'>
<a name='2446'>
<font color=#447700>! &lt;DESCRIPTION&gt;<a name='2447'></font>
<font color=#447700>! Collective operation. Each processor calls passing a local value and its index; on return<a name='2448'></font>
<font color=#447700>! all processors are passed back the maximum of all values passed and its tile number.<a name='2449'></font>
<font color=#447700>!<a name='2450'></font>
<font color=#447700>! &lt;/DESCRIPTION&gt;<a name='2451'></font>
      INTEGER i, comm<a name='2452'>
#ifndef STUBMPI<a name='2453'>
<a name='2454'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXTILE_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_32"> ( comm )<a name='2455'>
      CALL mpi_allgather ( val, 1, getrealmpitype(), val_all , 1, getrealmpitype(), comm, ierr )<a name='2456'>
      val = val_all(1)<a name='2457'>
      tile = 1<a name='2458'>
      DO i = 2, ntasks<a name='2459'>
        IF ( val_all(i) .GT. val ) THEN<a name='2460'>
           tile = i<a name='2461'>
           val = val_all(i)<a name='2462'>
        END IF<a name='2463'>
      END DO<a name='2464'>
#endif<a name='2465'>
   END SUBROUTINE wrf_dm_maxtile_real<a name='2466'>
<a name='2467'>
<a name='2468'>
<A NAME='WRF_DM_MINTILE_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINTILE_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2469'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_mintile_real</font> ( val , tile),<A href='../../call_from/WRF_DM_MINTILE_REAL.html' TARGET='index'>1</A><a name='2470'>
      IMPLICIT NONE<a name='2471'>
      REAL val, val_all( ntasks )<a name='2472'>
      INTEGER tile<a name='2473'>
      INTEGER ierr<a name='2474'>
<a name='2475'>
<font color=#447700>! &lt;DESCRIPTION&gt;<a name='2476'></font>
<font color=#447700>! Collective operation. Each processor calls passing a local value and its index; on return<a name='2477'></font>
<font color=#447700>! all processors are passed back the minimum of all values passed and its tile number.<a name='2478'></font>
<font color=#447700>!<a name='2479'></font>
<font color=#447700>! &lt;/DESCRIPTION&gt;<a name='2480'></font>
      INTEGER i, comm<a name='2481'>
#ifndef STUBMPI<a name='2482'>
<a name='2483'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINTILE_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_33"> ( comm )<a name='2484'>
      CALL mpi_allgather ( val, 1, getrealmpitype(), val_all , 1, getrealmpitype(), comm, ierr )<a name='2485'>
      val = val_all(1)<a name='2486'>
      tile = 1<a name='2487'>
      DO i = 2, ntasks<a name='2488'>
        IF ( val_all(i) .LT. val ) THEN<a name='2489'>
           tile = i<a name='2490'>
           val = val_all(i)<a name='2491'>
        END IF<a name='2492'>
      END DO<a name='2493'>
#endif<a name='2494'>
   END SUBROUTINE wrf_dm_mintile_real<a name='2495'>
<a name='2496'>
<a name='2497'>
<A NAME='WRF_DM_MINTILE_DOUBLE'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MINTILE_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2498'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_mintile_double</font> ( val , tile) <A href='../../call_to/WRF_DM_MINTILE_DOUBLE.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_MINTILE_DOUBLE.html' TARGET='index'>1</A><a name='2499'>
      IMPLICIT NONE<a name='2500'>
      DOUBLE PRECISION val, val_all( ntasks )<a name='2501'>
      INTEGER tile<a name='2502'>
      INTEGER ierr<a name='2503'>
<a name='2504'>
<font color=#447700>! &lt;DESCRIPTION&gt;<a name='2505'></font>
<font color=#447700>! Collective operation. Each processor calls passing a local value and its index; on return<a name='2506'></font>
<font color=#447700>! all processors are passed back the minimum of all values passed and its tile number.<a name='2507'></font>
<font color=#447700>!<a name='2508'></font>
<font color=#447700>! &lt;/DESCRIPTION&gt;<a name='2509'></font>
      INTEGER i, comm<a name='2510'>
#ifndef STUBMPI<a name='2511'>
<a name='2512'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MINTILE_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_34"> ( comm )<a name='2513'>
      CALL mpi_allgather ( val, 1, MPI_DOUBLE_PRECISION, val_all , 1, MPI_DOUBLE_PRECISION, comm, ierr )<a name='2514'>
      val = val_all(1)<a name='2515'>
      tile = 1<a name='2516'>
      DO i = 2, ntasks<a name='2517'>
        IF ( val_all(i) .LT. val ) THEN<a name='2518'>
           tile = i<a name='2519'>
           val = val_all(i)<a name='2520'>
        END IF<a name='2521'>
      END DO<a name='2522'>
#endif<a name='2523'>
   END SUBROUTINE wrf_dm_mintile_double<a name='2524'>
<a name='2525'>
<a name='2526'>
<A NAME='WRF_DM_TILE_VAL_INT'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_TILE_VAL_INT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2527'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_tile_val_int</font> ( val , tile) <A href='../../call_to/WRF_DM_TILE_VAL_INT.html' TARGET='index'>3</A>,<A href='../../call_from/WRF_DM_TILE_VAL_INT.html' TARGET='index'>1</A><a name='2528'>
      IMPLICIT NONE<a name='2529'>
      INTEGER val, val_all( ntasks )<a name='2530'>
      INTEGER tile<a name='2531'>
      INTEGER ierr<a name='2532'>
<a name='2533'>
<font color=#447700>! &lt;DESCRIPTION&gt;<a name='2534'></font>
<font color=#447700>! Collective operation. Get value from input tile.<a name='2535'></font>
<font color=#447700>!<a name='2536'></font>
<font color=#447700>! &lt;/DESCRIPTION&gt;<a name='2537'></font>
      INTEGER i, comm<a name='2538'>
#ifndef STUBMPI<a name='2539'>
<a name='2540'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_TILE_VAL_INT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_35"> ( comm )<a name='2541'>
      CALL mpi_allgather ( val, 1, MPI_INTEGER, val_all , 1, MPI_INTEGER, comm, ierr )<a name='2542'>
      val = val_all(tile)<a name='2543'>
#endif<a name='2544'>
   END SUBROUTINE wrf_dm_tile_val_int<a name='2545'>
<a name='2546'>
<A NAME='WRF_GET_HOSTNAME'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_HOSTNAME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2547'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_hostname</font>  ( str )<a name='2548'>
      CHARACTER*(*) str<a name='2549'>
      CHARACTER tmp(512)<a name='2550'>
      INTEGER i , n, cs<a name='2551'>
      CALL rsl_lite_get_hostname( tmp, 512, n, cs )<a name='2552'>
      DO i = 1, n <a name='2553'>
        str(i:i) = tmp(i)<a name='2554'>
      END DO<a name='2555'>
      RETURN<a name='2556'>
   END SUBROUTINE wrf_get_hostname <a name='2557'>
<a name='2558'>
<A NAME='WRF_GET_HOSTID'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_HOSTID' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2559'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_hostid</font>  ( hostid ) <A href='../../call_to/WRF_GET_HOSTID.html' TARGET='index'>2</A><a name='2560'>
      INTEGER hostid<a name='2561'>
      CHARACTER tmp(512)<a name='2562'>
      INTEGER i, sz, n, cs<a name='2563'>
      CALL rsl_lite_get_hostname( tmp, 512, n, cs )<a name='2564'>
      hostid = cs<a name='2565'>
      RETURN<a name='2566'>
   END SUBROUTINE wrf_get_hostid<a name='2567'>
<a name='2568'>
END MODULE module_dm<a name='2569'>
<a name='2570'>
<a name='2571'>
<A NAME='PUSH_COMMUNICATORS_FOR_DOMAIN'><A href='../../html_code/frame/module_dm.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2572'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>push_communicators_for_domain</font>( id ) <A href='../../call_to/PUSH_COMMUNICATORS_FOR_DOMAIN.html' TARGET='index'>36</A>,<A href='../../call_from/PUSH_COMMUNICATORS_FOR_DOMAIN.html' TARGET='index'>3</A><a name='2573'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_67"><a name='2574'>
      INTEGER, INTENT(IN) :: id   <font color=#447700>! if specified also does an instate for grid id<a name='2575'></font>
      IF ( communicator_stack_cursor .GE. max_domains ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_195">("push_communicators_for_domain would excede stacksize") <a name='2576'>
      communicator_stack_cursor = communicator_stack_cursor + 1<a name='2577'>
<a name='2578'>
      id_stack(communicator_stack_cursor) = current_id<a name='2579'>
      local_communicator_stack( communicator_stack_cursor )    =    local_communicator<a name='2580'>
      local_communicator_periodic_stack( communicator_stack_cursor )  =    local_communicator_periodic<a name='2581'>
      local_iocommunicator_stack( communicator_stack_cursor )  =    local_iocommunicator<a name='2582'>
      local_communicator_x_stack( communicator_stack_cursor )  =    local_communicator_x<a name='2583'>
      local_communicator_y_stack( communicator_stack_cursor )  =    local_communicator_y<a name='2584'>
      ntasks_stack( communicator_stack_cursor )        =    ntasks<a name='2585'>
      ntasks_y_stack( communicator_stack_cursor )      =    ntasks_y<a name='2586'>
      ntasks_x_stack( communicator_stack_cursor )      =    ntasks_x<a name='2587'>
      mytask_stack( communicator_stack_cursor )        =    mytask<a name='2588'>
      mytask_x_stack( communicator_stack_cursor )       =    mytask_x<a name='2589'>
      mytask_y_stack( communicator_stack_cursor )       =    mytask_y<a name='2590'>
<a name='2591'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#INSTATE_COMMUNICATORS_FOR_DOMAIN'>instate_communicators_for_domain</A><A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INSTATE_COMMUNICATORS_FOR_DOMAIN_4">( id )<a name='2592'>
   END SUBROUTINE push_communicators_for_domain<a name='2593'>
<A NAME='POP_COMMUNICATORS_FOR_DOMAIN'><A href='../../html_code/frame/module_dm.F.html#POP_COMMUNICATORS_FOR_DOMAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2594'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>pop_communicators_for_domain</font> <A href='../../call_to/POP_COMMUNICATORS_FOR_DOMAIN.html' TARGET='index'>36</A>,<A href='../../call_from/POP_COMMUNICATORS_FOR_DOMAIN.html' TARGET='index'>2</A><a name='2595'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_68"><a name='2596'>
      IMPLICIT NONE<a name='2597'>
      IF ( communicator_stack_cursor .LT. 1 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_196">("pop_communicators_for_domain on empty stack") <a name='2598'>
      current_id = id_stack(communicator_stack_cursor)<a name='2599'>
      local_communicator = local_communicator_stack( communicator_stack_cursor )<a name='2600'>
      local_communicator_periodic = local_communicator_periodic_stack( communicator_stack_cursor )<a name='2601'>
      local_iocommunicator = local_iocommunicator_stack( communicator_stack_cursor )<a name='2602'>
      local_communicator_x = local_communicator_x_stack( communicator_stack_cursor )<a name='2603'>
      local_communicator_y = local_communicator_y_stack( communicator_stack_cursor )<a name='2604'>
      ntasks = ntasks_stack( communicator_stack_cursor )<a name='2605'>
      ntasks_y = ntasks_y_stack( communicator_stack_cursor )<a name='2606'>
      ntasks_x = ntasks_x_stack( communicator_stack_cursor )<a name='2607'>
      mytask = mytask_stack( communicator_stack_cursor )<a name='2608'>
      mytask_x = mytask_x_stack( communicator_stack_cursor )<a name='2609'>
      mytask_y = mytask_y_stack( communicator_stack_cursor )<a name='2610'>
      communicator_stack_cursor = communicator_stack_cursor - 1<a name='2611'>
   END SUBROUTINE pop_communicators_for_domain<a name='2612'>
<A NAME='INSTATE_COMMUNICATORS_FOR_DOMAIN'><A href='../../html_code/frame/module_dm.F.html#INSTATE_COMMUNICATORS_FOR_DOMAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2613'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>instate_communicators_for_domain</font>( id ) <A href='../../call_to/INSTATE_COMMUNICATORS_FOR_DOMAIN.html' TARGET='index'>4</A>,<A href='../../call_from/INSTATE_COMMUNICATORS_FOR_DOMAIN.html' TARGET='index'>1</A><a name='2614'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#INSTATE_COMMUNICATORS_FOR_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_69"><a name='2615'>
      IMPLICIT NONE<a name='2616'>
      INTEGER, INTENT(IN) :: id<a name='2617'>
      INTEGER ierr<a name='2618'>
      current_id = id <a name='2619'>
      local_communicator          = local_communicator_store( id )<a name='2620'>
      local_communicator_periodic = local_communicator_periodic_store( id )<a name='2621'>
      local_iocommunicator        = local_iocommunicator_store( id )<a name='2622'>
      local_communicator_x        = local_communicator_x_store( id )<a name='2623'>
      local_communicator_y        = local_communicator_y_store( id )<a name='2624'>
      ntasks         = ntasks_store( id )<a name='2625'>
      mytask         = mytask_store( id )<a name='2626'>
      ntasks_x       = ntasks_x_store( id )<a name='2627'>
      ntasks_y       = ntasks_y_store( id )<a name='2628'>
      mytask_x       = mytask_x_store( id )<a name='2629'>
      mytask_y       = mytask_y_store( id )<a name='2630'>
   END SUBROUTINE instate_communicators_for_domain<a name='2631'>
<A NAME='STORE_COMMUNICATORS_FOR_DOMAIN'><A href='../../html_code/frame/module_dm.F.html#STORE_COMMUNICATORS_FOR_DOMAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2632'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>store_communicators_for_domain</font>( id ) <A href='../../call_to/STORE_COMMUNICATORS_FOR_DOMAIN.html' TARGET='index'>2</A>,<A href='../../call_from/STORE_COMMUNICATORS_FOR_DOMAIN.html' TARGET='index'>1</A><a name='2633'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#STORE_COMMUNICATORS_FOR_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_70"><a name='2634'>
      IMPLICIT NONE<a name='2635'>
      INTEGER, INTENT(IN) :: id<a name='2636'>
      local_communicator_store( id )    =    local_communicator<a name='2637'>
      local_communicator_periodic_store( id )  =    local_communicator_periodic<a name='2638'>
      local_iocommunicator_store( id )  =    local_iocommunicator<a name='2639'>
      local_communicator_x_store( id )  =    local_communicator_x<a name='2640'>
      local_communicator_y_store( id )  =    local_communicator_y<a name='2641'>
      ntasks_store( id )        =    ntasks<a name='2642'>
      ntasks_x_store( id )      =    ntasks_x<a name='2643'>
      ntasks_y_store( id )      =    ntasks_y<a name='2644'>
      mytask_store( id )        =    mytask<a name='2645'>
      mytask_x_store( id )      =    mytask_x<a name='2646'>
      mytask_y_store( id )      =    mytask_y<a name='2647'>
   END SUBROUTINE store_communicators_for_domain<a name='2648'>
<a name='2649'>
<font color=#447700>!=========================================================================<a name='2650'></font>
<font color=#447700>! wrf_dm_patch_domain has to be outside the module because it is called<a name='2651'></font>
<font color=#447700>! by a routine in module_domain but depends on module domain<a name='2652'></font>
<a name='2653'>
<A NAME='WRF_DM_PATCH_DOMAIN'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_PATCH_DOMAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2654'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_patch_domain</font> ( id  , domdesc , parent_id , parent_domdesc , &amp; <A href='../../call_to/WRF_DM_PATCH_DOMAIN.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_PATCH_DOMAIN.html' TARGET='index'>6</A><a name='2655'>
                          sd1 , ed1 , sp1 , ep1 , sm1 , em1 , &amp;<a name='2656'>
                          sd2 , ed2 , sp2 , ep2 , sm2 , em2 , &amp;<a name='2657'>
                          sd3 , ed3 , sp3 , ep3 , sm3 , em3 , &amp;<a name='2658'>
                                      sp1x , ep1x , sm1x , em1x , &amp;<a name='2659'>
                                      sp2x , ep2x , sm2x , em2x , &amp;<a name='2660'>
                                      sp3x , ep3x , sm3x , em3x , &amp;<a name='2661'>
                                      sp1y , ep1y , sm1y , em1y , &amp;<a name='2662'>
                                      sp2y , ep2y , sm2y , em2y , &amp;<a name='2663'>
                                      sp3y , ep3y , sm3y , em3y , &amp;<a name='2664'>
                          bdx , bdy )<a name='2665'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_PATCH_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_107">, ONLY : domain, head_grid, find_grid_by_id<a name='2666'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_PATCH_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_71">, ONLY : patch_domain_rsl_lite  <font color=#447700>!, push_communicators_for_domain, pop_communicators_for_domain<a name='2667'></font>
   IMPLICIT NONE<a name='2668'>
<a name='2669'>
   INTEGER, INTENT(IN)   :: sd1 , ed1 , sd2 , ed2 , sd3 , ed3 , bdx , bdy<a name='2670'>
   INTEGER, INTENT(OUT)  :: sp1 , ep1 , sp2 , ep2 , sp3 , ep3 , &amp;<a name='2671'>
                            sm1 , em1 , sm2 , em2 , sm3 , em3<a name='2672'>
   INTEGER               :: sp1x , ep1x , sp2x , ep2x , sp3x , ep3x , &amp;<a name='2673'>
                            sm1x , em1x , sm2x , em2x , sm3x , em3x<a name='2674'>
   INTEGER               :: sp1y , ep1y , sp2y , ep2y , sp3y , ep3y , &amp;<a name='2675'>
                            sm1y , em1y , sm2y , em2y , sm3y , em3y<a name='2676'>
   INTEGER, INTENT(INOUT):: id  , domdesc , parent_id , parent_domdesc<a name='2677'>
<a name='2678'>
   TYPE(domain), POINTER :: parent<a name='2679'>
   TYPE(domain), POINTER :: grid_ptr<a name='2680'>
<a name='2681'>
   <font color=#447700>! this is necessary because we cannot pass parent directly into <a name='2682'></font>
   <font color=#447700>! wrf_dm_patch_domain because creating the correct interface definitions<a name='2683'></font>
   <font color=#447700>! would generate a circular USE reference between module_domain and module_dm<a name='2684'></font>
   <font color=#447700>! see comment this date in module_domain for more information. JM 20020416<a name='2685'></font>
<a name='2686'>
   NULLIFY( parent )<a name='2687'>
   grid_ptr =&gt; head_grid<a name='2688'>
   CALL <A href='../../html_code/frame/module_domain.F.html#FIND_GRID_BY_ID'>find_grid_by_id</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_PATCH_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIND_GRID_BY_ID_2">( parent_id , grid_ptr , parent )<a name='2689'>
<a name='2690'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_PATCH_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_2">(id)<a name='2691'>
<a name='2692'>
   CALL <A href='../../html_code/frame/module_dm.F.html#PATCH_DOMAIN_RSL_LITE'>patch_domain_rsl_lite</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_PATCH_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PATCH_DOMAIN_RSL_LITE_1"> ( id  , parent, parent_id , &amp;<a name='2693'>
                           sd1 , ed1 , sp1 , ep1 , sm1 , em1 , &amp; <a name='2694'>
                           sd2 , ed2 , sp2 , ep2 , sm2 , em2 , &amp;<a name='2695'>
                           sd3 , ed3 , sp3 , ep3 , sm3 , em3 , &amp;<a name='2696'>
                                      sp1x , ep1x , sm1x , em1x , &amp;<a name='2697'>
                                      sp2x , ep2x , sm2x , em2x , &amp;<a name='2698'>
                                      sp3x , ep3x , sm3x , em3x , &amp;<a name='2699'>
                                      sp1y , ep1y , sm1y , em1y , &amp;<a name='2700'>
                                      sp2y , ep2y , sm2y , em2y , &amp;<a name='2701'>
                                      sp3y , ep3y , sm3y , em3y , &amp;<a name='2702'>
                           bdx , bdy )<a name='2703'>
<a name='2704'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_PATCH_DOMAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_2"><a name='2705'>
<a name='2706'>
   RETURN<a name='2707'>
END SUBROUTINE wrf_dm_patch_domain<a name='2708'>
<a name='2709'>
<A NAME='WRF_TERMIO_DUP'><A href='../../html_code/frame/module_dm.F.html#WRF_TERMIO_DUP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2710'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_termio_dup</font>( comm ) <A href='../../call_to/WRF_TERMIO_DUP.html' TARGET='index'>3</A><a name='2711'>
  IMPLICIT NONE<a name='2712'>
  INTEGER, INTENT(IN) :: comm<a name='2713'>
  INTEGER mytask, ntasks<a name='2714'>
#ifndef STUBMPI<a name='2715'>
  INTEGER ierr<a name='2716'>
  INCLUDE 'mpif.h'<a name='2717'>
  CALL mpi_comm_size(comm, ntasks, ierr )<a name='2718'>
  CALL mpi_comm_rank(comm, mytask, ierr )<a name='2719'>
  write(0,*)'starting wrf task ',mytask,' of ',ntasks<a name='2720'>
  CALL rsl_error_dup1( mytask )<a name='2721'>
#else<a name='2722'>
  mytask = 0<a name='2723'>
  ntasks = 1<a name='2724'>
#endif<a name='2725'>
END SUBROUTINE wrf_termio_dup<a name='2726'>
<a name='2727'>
<A NAME='WRF_GET_MYPROC'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_MYPROC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2728'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_myproc</font>( myproc ) <A href='../../call_to/WRF_GET_MYPROC.html' TARGET='index'>37</A>,<A href='../../call_from/WRF_GET_MYPROC.html' TARGET='index'>1</A><a name='2729'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_72"> , ONLY : mytask<a name='2730'>
  IMPLICIT NONE<a name='2731'>
  INTEGER myproc<a name='2732'>
  myproc = mytask<a name='2733'>
  RETURN<a name='2734'>
END SUBROUTINE wrf_get_myproc<a name='2735'>
<a name='2736'>
<A NAME='WRF_GET_NPROC'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_NPROC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2737'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_nproc</font>( nproc ) <A href='../../call_to/WRF_GET_NPROC.html' TARGET='index'>21</A>,<A href='../../call_from/WRF_GET_NPROC.html' TARGET='index'>1</A><a name='2738'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_73"> , ONLY : ntasks<a name='2739'>
  IMPLICIT NONE<a name='2740'>
  INTEGER nproc<a name='2741'>
  nproc = ntasks<a name='2742'>
  RETURN<a name='2743'>
END SUBROUTINE wrf_get_nproc<a name='2744'>
<a name='2745'>
<A NAME='WRF_GET_NPROCX'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_NPROCX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2746'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_nprocx</font>( nprocx ) <A href='../../call_to/WRF_GET_NPROCX.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_GET_NPROCX.html' TARGET='index'>1</A><a name='2747'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROCX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_74"> , ONLY : ntasks_x<a name='2748'>
  IMPLICIT NONE<a name='2749'>
  INTEGER nprocx<a name='2750'>
  nprocx = ntasks_x<a name='2751'>
  RETURN<a name='2752'>
END SUBROUTINE wrf_get_nprocx<a name='2753'>
<a name='2754'>
<A NAME='WRF_GET_NPROCY'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_NPROCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2755'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_nprocy</font>( nprocy ) <A href='../../call_to/WRF_GET_NPROCY.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_GET_NPROCY.html' TARGET='index'>1</A><a name='2756'>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_75"> , ONLY : ntasks_y<a name='2757'>
  IMPLICIT NONE<a name='2758'>
  INTEGER nprocy<a name='2759'>
  nprocy = ntasks_y<a name='2760'>
  RETURN<a name='2761'>
END SUBROUTINE wrf_get_nprocy<a name='2762'>
<a name='2763'>
<A NAME='WRF_DM_BCAST_BYTES'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_BYTES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2764'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_bcast_bytes</font> ( buf , size ) <A href='../../call_to/WRF_DM_BCAST_BYTES.html' TARGET='index'>382</A>,<A href='../../call_from/WRF_DM_BCAST_BYTES.html' TARGET='index'>1</A><a name='2765'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_76"> , ONLY : local_communicator<a name='2766'>
   IMPLICIT NONE<a name='2767'>
#ifndef STUBMPI<a name='2768'>
   INCLUDE 'mpif.h'<a name='2769'>
#endif<a name='2770'>
   INTEGER size<a name='2771'>
#ifndef NEC<a name='2772'>
   INTEGER*1 BUF(size)<a name='2773'>
#else<a name='2774'>
   CHARACTER*1 BUF(size)<a name='2775'>
#endif<a name='2776'>
#ifndef STUBMPI<a name='2777'>
   CALL BYTE_BCAST ( buf , size, local_communicator )<a name='2778'>
#endif<a name='2779'>
   RETURN<a name='2780'>
END SUBROUTINE wrf_dm_bcast_bytes<a name='2781'>
<a name='2782'>
<A NAME='WRF_DM_BCAST_STRING'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_STRING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2783'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_bcast_string</font>( BUF, N1 ) <A href='../../call_to/WRF_DM_BCAST_STRING.html' TARGET='index'>20</A>,<A href='../../call_from/WRF_DM_BCAST_STRING.html' TARGET='index'>2</A><a name='2784'>
   IMPLICIT NONE<a name='2785'>
   INTEGER n1<a name='2786'>
<font color=#447700>! &lt;DESCRIPTION&gt;<a name='2787'></font>
<font color=#447700>! Collective operation. Given a string and a size in characters on task zero, broadcast and return that buffer on all tasks.<a name='2788'></font>
<font color=#447700>!<a name='2789'></font>
<font color=#447700>! &lt;/DESCRIPTION&gt;<a name='2790'></font>
   CHARACTER*(*) buf<a name='2791'>
#ifndef STUBMPI<a name='2792'>
   INTEGER ibuf(256),i,n<a name='2793'>
   CHARACTER*256 tstr<a name='2794'>
   n = n1<a name='2795'>
   <font color=#447700>! Root task is required to have the correct value of N1, other tasks <a name='2796'></font>
   <font color=#447700>! might not have the correct value.  <a name='2797'></font>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_1">( n , 1 )<a name='2798'>
   IF (n .GT. 256) n = 256<a name='2799'>
   IF (n .GT. 0 ) then<a name='2800'>
     DO i = 1, n<a name='2801'>
       ibuf(I) = ichar(buf(I:I))<a name='2802'>
     END DO<a name='2803'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER'>wrf_dm_bcast_integer</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_STRING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_INTEGER_2">( ibuf, n )<a name='2804'>
     buf = ''<a name='2805'>
     DO i = 1, n<a name='2806'>
       buf(i:i) = char(ibuf(i))<a name='2807'>
     END DO<a name='2808'>
   END IF<a name='2809'>
#endif<a name='2810'>
   RETURN<a name='2811'>
END SUBROUTINE wrf_dm_bcast_string<a name='2812'>
<a name='2813'>
<A NAME='WRF_DM_BCAST_STRING_COMM'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_STRING_COMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2814'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_bcast_string_comm</font>( BUF, N1, COMM ) <A href='../../call_to/WRF_DM_BCAST_STRING_COMM.html' TARGET='index'>1</A><a name='2815'>
   IMPLICIT NONE<a name='2816'>
   INTEGER n1<a name='2817'>
   INTEGER COMM<a name='2818'>
<font color=#447700>! &lt;DESCRIPTION&gt;<a name='2819'></font>
<font color=#447700>! Collective operation. Given a string and a size in characters on task zero, broadcast and return that buffer on all tasks.<a name='2820'></font>
<font color=#447700>!<a name='2821'></font>
<font color=#447700>! &lt;/DESCRIPTION&gt;<a name='2822'></font>
   CHARACTER*(*) buf<a name='2823'>
#ifndef STUBMPI<a name='2824'>
   INTEGER ibuf(256),i,n<a name='2825'>
   CHARACTER*256 tstr<a name='2826'>
   n = n1<a name='2827'>
   <font color=#447700>! Root task is required to have the correct value of N1, other tasks<a name='2828'></font>
   <font color=#447700>! might not have the correct value.<a name='2829'></font>
   CALL BYTE_BCAST( n, IWORDSIZE, COMM )<a name='2830'>
   IF (n .GT. 256) n = 256<a name='2831'>
   IF (n .GT. 0 ) then<a name='2832'>
     DO i = 1, n<a name='2833'>
       ibuf(I) = ichar(buf(I:I))<a name='2834'>
     END DO<a name='2835'>
     CALL BYTE_BCAST( ibuf, N*IWORDSIZE, COMM )<a name='2836'>
     buf = ''<a name='2837'>
     DO i = 1, n<a name='2838'>
       buf(i:i) = char(ibuf(i))<a name='2839'>
     END DO<a name='2840'>
   END IF<a name='2841'>
#endif<a name='2842'>
   RETURN<a name='2843'>
END SUBROUTINE wrf_dm_bcast_string_comm<a name='2844'>
<a name='2845'>
<A NAME='WRF_DM_BCAST_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2846'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_bcast_integer</font>( BUF, N1 ) <A href='../../call_to/WRF_DM_BCAST_INTEGER.html' TARGET='index'>73</A>,<A href='../../call_from/WRF_DM_BCAST_INTEGER.html' TARGET='index'>1</A><a name='2847'>
   IMPLICIT NONE<a name='2848'>
   INTEGER n1<a name='2849'>
   INTEGER  buf(*)<a name='2850'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_5"> ( BUF , N1 * IWORDSIZE )<a name='2851'>
   RETURN<a name='2852'>
END SUBROUTINE wrf_dm_bcast_integer<a name='2853'>
<a name='2854'>
<A NAME='WRF_DM_BCAST_DOUBLE'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2855'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_bcast_double</font>( BUF, N1 ) <A href='../../call_to/WRF_DM_BCAST_DOUBLE.html' TARGET='index'>24</A>,<A href='../../call_from/WRF_DM_BCAST_DOUBLE.html' TARGET='index'>1</A><a name='2856'>
   IMPLICIT NONE<a name='2857'>
   INTEGER n1<a name='2858'>
<font color=#447700>! this next declaration is REAL, not DOUBLE PRECISION because it will be autopromoted<a name='2859'></font>
<font color=#447700>! to double precision by the compiler when WRF is compiled for 8 byte reals. Only reason<a name='2860'></font>
<font color=#447700>! for having this separate routine is so we pass the correct MPI type to mpi_scatterv<a name='2861'></font>
<font color=#447700>! since we were not indexing the globbuf and Field arrays it does not matter<a name='2862'></font>
   REAL  buf(*)<a name='2863'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_6"> ( BUF , N1 * DWORDSIZE )<a name='2864'>
   RETURN<a name='2865'>
END SUBROUTINE wrf_dm_bcast_double<a name='2866'>
<a name='2867'>
<A NAME='WRF_DM_BCAST_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2868'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_bcast_real</font>( BUF, N1 ) <A href='../../call_to/WRF_DM_BCAST_REAL.html' TARGET='index'>159</A>,<A href='../../call_from/WRF_DM_BCAST_REAL.html' TARGET='index'>1</A><a name='2869'>
   IMPLICIT NONE<a name='2870'>
   INTEGER n1<a name='2871'>
   REAL  buf(*)<a name='2872'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_7"> ( BUF , N1 * RWORDSIZE )<a name='2873'>
   RETURN<a name='2874'>
END SUBROUTINE wrf_dm_bcast_real<a name='2875'>
<a name='2876'>
<A NAME='WRF_DM_BCAST_LOGICAL'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_BCAST_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2877'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_bcast_logical</font>( BUF, N1 ) <A href='../../call_to/WRF_DM_BCAST_LOGICAL.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_BCAST_LOGICAL.html' TARGET='index'>1</A><a name='2878'>
   IMPLICIT NONE<a name='2879'>
   INTEGER n1<a name='2880'>
   LOGICAL  buf(*)<a name='2881'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_BYTES'>wrf_dm_bcast_bytes</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_LOGICAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_BYTES_8"> ( BUF , N1 * LWORDSIZE )<a name='2882'>
   RETURN<a name='2883'>
END SUBROUTINE wrf_dm_bcast_logical<a name='2884'>
<a name='2885'>
<A NAME='WRITE_68'><A href='../../html_code/frame/module_dm.F.html#WRITE_68' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2886'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>write_68</font>( grid, v , s , &amp;,<A href='../../call_from/WRITE_68.html' TARGET='index'>3</A><a name='2887'>
                   ids, ide, jds, jde, kds, kde, &amp;<a name='2888'>
                   ims, ime, jms, jme, kms, kme, &amp;<a name='2889'>
                   its, ite, jts, jte, kts, kte )<a name='2890'>
  USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#WRITE_68' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_108">, ONLY : domain<a name='2891'>
  IMPLICIT NONE<a name='2892'>
  TYPE(domain) , INTENT (INOUT) :: grid <a name='2893'>
  CHARACTER *(*) s<a name='2894'>
  INTEGER ids, ide, jds, jde, kds, kde, &amp;<a name='2895'>
          ims, ime, jms, jme, kms, kme, &amp;<a name='2896'>
          its, ite, jts, jte, kts, kte<a name='2897'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ) :: v<a name='2898'>
<a name='2899'>
  INTEGER i,j,k,ierr<a name='2900'>
<a name='2901'>
  logical, external :: wrf_dm_on_monitor<a name='2902'>
  real globbuf( ids:ide, kds:kde, jds:jde )<a name='2903'>
  character*3 ord, stag<a name='2904'>
<a name='2905'>
  if ( kds == kde ) then<a name='2906'>
    ord = 'xy'<a name='2907'>
    stag = 'xy'<a name='2908'>
  CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/frame/module_dm.F.html#WRITE_68' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_7"> ( v, globbuf, grid%domdesc, stag, ord, &amp;<a name='2909'>
                     ids, ide, jds, jde, kds, kde, &amp;<a name='2910'>
                     ims, ime, jms, jme, kms, kme, &amp;<a name='2911'>
                     its, ite, jts, jte, kts, kte )<a name='2912'>
  else<a name='2913'>
<a name='2914'>
    stag = 'xyz' <a name='2915'>
    ord = 'xzy'<a name='2916'>
  CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/frame/module_dm.F.html#WRITE_68' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_8"> ( v, globbuf, grid%domdesc, stag, ord, &amp;<a name='2917'>
                     ids, ide, kds, kde, jds, jde, &amp;<a name='2918'>
                     ims, ime, kms, kme, jms, jme, &amp;<a name='2919'>
                     its, ite, kts, kte, jts, jte )<a name='2920'>
  endif<a name='2921'>
<a name='2922'>
<a name='2923'>
  if ( wrf_dm_on_monitor() ) THEN<a name='2924'>
    WRITE(68,*) ide-ids+1, jde-jds+1 , s<a name='2925'>
    DO j = jds, jde<a name='2926'>
    DO i = ids, ide<a name='2927'>
       WRITE(68,*) globbuf(i,1,j)<a name='2928'>
    END DO<a name='2929'>
    END DO<a name='2930'>
  endif<a name='2931'>
<a name='2932'>
  RETURN<a name='2933'>
END<a name='2934'>
<a name='2935'>
<A NAME='WRF_ABORT'><A href='../../html_code/frame/module_dm.F.html#WRF_ABORT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2936'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_abort</font> <A href='../../call_to/WRF_ABORT.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_ABORT.html' TARGET='index'>2</A><a name='2937'>
<a name='2938'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='2939'></font>
      USE <A href='../../html_code/frame/module_cpl.F.html#MODULE_CPL'>module_cpl</A><A href='../../html_code/io_netcdf/vort.F90.html#WRF_ABORT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CPL_3">, ONLY : coupler_on, cpl_abort<a name='2940'>
#endif<a name='2941'>
<a name='2942'>
      IMPLICIT NONE<a name='2943'>
#ifndef STUBMPI<a name='2944'>
      INCLUDE 'mpif.h'<a name='2945'>
      INTEGER ierr<a name='2946'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='2947'></font>
      IF ( coupler_on ) THEN<a name='2948'>
         CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_ABORT'>cpl_abort</A><A href='../../html_code/io_netcdf/vort.F90.html#WRF_ABORT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_ABORT_4">( 'wrf_abort', 'look for abort message in rsl* files' )<a name='2949'>
      ELSE<a name='2950'>
#endif<a name='2951'>
         CALL mpi_abort(MPI_COMM_WORLD,1,ierr)<a name='2952'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='2953'></font>
      END IF<a name='2954'>
#endif<a name='2955'>
#else<a name='2956'>
      STOP<a name='2957'>
#endif<a name='2958'>
   END SUBROUTINE wrf_abort<a name='2959'>
<a name='2960'>
<A NAME='WRF_DM_SHUTDOWN'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_SHUTDOWN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2961'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_shutdown</font> <A href='../../call_to/WRF_DM_SHUTDOWN.html' TARGET='index'>3</A><a name='2962'>
      IMPLICIT NONE<a name='2963'>
#ifndef STUBMPI<a name='2964'>
      INTEGER ierr<a name='2965'>
      CALL MPI_FINALIZE( ierr )<a name='2966'>
#endif<a name='2967'>
      RETURN<a name='2968'>
   END SUBROUTINE wrf_dm_shutdown<a name='2969'>
<a name='2970'>
<A NAME='WRF_DM_ON_MONITOR'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_ON_MONITOR' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2971'>
   LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_on_monitor</font>() <A href='../../call_to/WRF_DM_ON_MONITOR.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_DM_ON_MONITOR.html' TARGET='index'>1</A><a name='2972'>
      IMPLICIT NONE<a name='2973'>
#ifndef STUBMPI<a name='2974'>
      INCLUDE 'mpif.h'<a name='2975'>
      INTEGER tsk, ierr, mpi_comm_local<a name='2976'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/io_netcdf/diffwrf.F90.html#WRF_DM_ON_MONITOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_36">( mpi_comm_local )<a name='2977'>
      IF ( mpi_comm_local .NE. MPI_UNDEFINED ) THEN<a name='2978'>
        CALL mpi_comm_rank ( mpi_comm_local, tsk , ierr )<a name='2979'>
        wrf_dm_on_monitor = tsk .EQ. 0<a name='2980'>
      ELSE<a name='2981'>
        wrf_dm_on_monitor = .FALSE.<a name='2982'>
      END IF<a name='2983'>
#else<a name='2984'>
      wrf_dm_on_monitor = .TRUE.<a name='2985'>
#endif<a name='2986'>
      RETURN<a name='2987'>
   END FUNCTION wrf_dm_on_monitor<a name='2988'>
<a name='2989'>
<A NAME='RSL_COMM_ITER_INIT'><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2990'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rsl_comm_iter_init</font>(shw,ps,pe)<a name='2991'>
      INTEGER shw, ps, pe<a name='2992'>
      INTEGER iter, plus_send_start, plus_recv_start, &amp;<a name='2993'>
                    minus_send_start, minus_recv_start <a name='2994'>
      COMMON /rcii/ iter, plus_send_start, plus_recv_start, &amp;<a name='2995'>
                          minus_send_start, minus_recv_start<a name='2996'>
      iter = 0 <a name='2997'>
      minus_send_start = ps<a name='2998'>
      minus_recv_start = ps-1<a name='2999'>
      plus_send_start = pe<a name='3000'>
      plus_recv_start = pe+1<a name='3001'>
   END SUBROUTINE rsl_comm_iter_init<a name='3002'>
<a name='3003'>
<A NAME='RSL_COMM_ITER'><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3004'>
   LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>rsl_comm_iter</font> ( id , is_intermediate,                     &amp;,<A href='../../call_from/RSL_COMM_ITER.html' TARGET='index'>17</A><a name='3005'>
                                    shw ,  xy , ds, de_in, ps, pe, nds,nde, &amp; <a name='3006'>
                                    sendbeg_m, sendw_m, sendbeg_p, sendw_p,   &amp;<a name='3007'>
                                    recvbeg_m, recvw_m, recvbeg_p, recvw_p    )<a name='3008'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_77">, ONLY : ntasks_x, ntasks_y, mytask_x, mytask_y, minx, miny, &amp;<a name='3009'>
                            nest_pes_x, nest_pes_y<a name='3010'>
      IMPLICIT NONE<a name='3011'>
      INTEGER, INTENT(IN)  :: id,shw,xy,ds,de_in,ps,pe,nds,nde<a name='3012'>
      LOGICAL, INTENT(IN)  :: is_intermediate  <font color=#447700>! treated differently, coarse but with same decomp as nest<a name='3013'></font>
      INTEGER, INTENT(OUT) :: sendbeg_m, sendw_m, sendbeg_p, sendw_p<a name='3014'>
      INTEGER, INTENT(OUT) :: recvbeg_m, recvw_m, recvbeg_p, recvw_p<a name='3015'>
      INTEGER k, kn, ni, nj, de, Px, Py, nt, ntx, nty, me, lb, ub, ierr <a name='3016'>
      INTEGER dum<a name='3017'>
      LOGICAL went<a name='3018'>
      INTEGER iter, plus_send_start, plus_recv_start, &amp;<a name='3019'>
                    minus_send_start, minus_recv_start <a name='3020'>
      INTEGER parent_grid_ratio, parent_start<a name='3021'>
      COMMON /rcii/ iter, plus_send_start, plus_recv_start, &amp;<a name='3022'>
                          minus_send_start, minus_recv_start<a name='3023'>
<a name='3024'>
#if (NMM_CORE == 1 )<a name='3025'>
<font color=#447700>! In case of NMM CORE, the domain only ever runs from ids..ide-1 and jds..jde-1 so<a name='3026'></font>
<font color=#447700>! adjust decomposition to reflect.  20081206 JM<a name='3027'></font>
      de = de_in - 1<a name='3028'>
#else<a name='3029'>
      de = de_in<a name='3030'>
#endif<a name='3031'>
      ntx = nest_pes_x(id)<a name='3032'>
      nty = nest_pes_y(id)<a name='3033'>
      IF ( xy .EQ. 1 ) THEN  <font color=#447700>! X/I axis<a name='3034'></font>
        nt = ntasks_x<a name='3035'>
        me = mytask_x<a name='3036'>
        dum = 2 * nty  <font color=#447700>! dummy dimension length for tfp to decompose without getting div 0<a name='3037'></font>
        IF ( is_intermediate ) THEN<a name='3038'>
           CALL nl_get_i_parent_start(id,parent_start)<a name='3039'>
           CALL nl_get_parent_grid_ratio(id,parent_grid_ratio)<a name='3040'>
        END IF<a name='3041'>
      ELSE<a name='3042'>
        nt = ntasks_y<a name='3043'>
        me = mytask_y<a name='3044'>
        dum = 2 * ntx  <font color=#447700>! dummy dimension length for tfp to decompose without getting div 0<a name='3045'></font>
        IF ( is_intermediate ) THEN<a name='3046'>
           CALL nl_get_j_parent_start(id,parent_start)<a name='3047'>
           CALL nl_get_parent_grid_ratio(id,parent_grid_ratio)<a name='3048'>
        END IF<a name='3049'>
      END IF<a name='3050'>
      iter = iter + 1<a name='3051'>
<a name='3052'>
#if (DA_CORE == 0)<a name='3053'>
      went = .FALSE.<a name='3054'>
      <font color=#447700>! send to minus <a name='3055'></font>
      sendw_m = 0 <a name='3056'>
      sendbeg_m = 1<a name='3057'>
      IF ( me .GT. 0 ) THEN<a name='3058'>
        lb = minus_send_start<a name='3059'>
        sendbeg_m = lb-ps+1<a name='3060'>
        DO k = lb,ps+shw-1<a name='3061'>
          went = .TRUE.<a name='3062'>
          IF ( xy .eq. 1 ) THEN<a name='3063'>
            IF ( is_intermediate ) THEN<a name='3064'>
              kn =  ( k - parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='3065'>
              CALL task_for_point (kn,1,nds,nde,1,dum,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3066'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_197">('error code returned by task_for_point in module_dm.F (h)')<a name='3067'>
            ELSE<a name='3068'>
              CALL task_for_point (k,1,ds,de,1,dum,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3069'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_198">('error code returned by task_for_point in module_dm.F (i)')<a name='3070'>
            END IF<a name='3071'>
            IF ( Px .NE. me+(iter-1) ) THEN<a name='3072'>
              exit<a name='3073'>
            END IF<a name='3074'>
          ELSE<a name='3075'>
            IF ( is_intermediate ) THEN<a name='3076'>
              kn =  ( k - parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='3077'>
              CALL task_for_point (1,kn,1,dum,nds,nde,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3078'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_199">('error code returned by task_for_point in module_dm.F (h)')<a name='3079'>
            ELSE<a name='3080'>
              CALL task_for_point (1,k,1,dum,ds,de,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3081'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_200">('error code returned by task_for_point in module_dm.F (i)')<a name='3082'>
            END IF<a name='3083'>
            IF ( Py .NE. me+(iter-1) ) THEN<a name='3084'>
              exit<a name='3085'>
            END IF<a name='3086'>
          END IF<a name='3087'>
          minus_send_start = minus_send_start+1<a name='3088'>
          sendw_m = sendw_m + 1<a name='3089'>
        END DO<a name='3090'>
      END IF<a name='3091'>
      <font color=#447700>! recv from minus <a name='3092'></font>
      recvw_m = 0 <a name='3093'>
      recvbeg_m = 1<a name='3094'>
      IF ( me .GT. 0 ) THEN<a name='3095'>
        ub = minus_recv_start<a name='3096'>
        recvbeg_m = ps - ub<a name='3097'>
        DO k = minus_recv_start,ps-shw,-1<a name='3098'>
          went = .TRUE.<a name='3099'>
          IF ( xy .eq. 1 ) THEN<a name='3100'>
          IF ( is_intermediate ) THEN<a name='3101'>
            kn =  ( k - parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='3102'>
              CALL task_for_point (kn,1,nds,nde,1,dum,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3103'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_201">('error code returned by task_for_point in module_dm.F (j)')<a name='3104'>
          ELSE<a name='3105'>
              CALL task_for_point (k,1,ds,de,1,dum,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3106'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_202">('error code returned by task_for_point in module_dm.F (k)')<a name='3107'>
          END IF<a name='3108'>
          IF ( Px .NE. me-iter ) THEN<a name='3109'>
            exit<a name='3110'>
          END IF<a name='3111'>
          ELSE<a name='3112'>
            IF ( is_intermediate ) THEN<a name='3113'>
              kn =  ( k - parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='3114'>
              CALL task_for_point (1,kn,1,dum,nds,nde,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3115'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_203">('error code returned by task_for_point in module_dm.F (j)')<a name='3116'>
            ELSE<a name='3117'>
              CALL task_for_point (1,k,1,dum,ds,de,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3118'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_204">('error code returned by task_for_point in module_dm.F (k)')<a name='3119'>
            END IF<a name='3120'>
            IF ( Py .NE. me-iter ) THEN<a name='3121'>
              exit<a name='3122'>
            END IF<a name='3123'>
          END IF<a name='3124'>
          minus_recv_start = minus_recv_start-1<a name='3125'>
          recvw_m = recvw_m + 1<a name='3126'>
        END DO<a name='3127'>
      END IF<a name='3128'>
<a name='3129'>
      <font color=#447700>! send to plus<a name='3130'></font>
      sendw_p = 0 <a name='3131'>
      sendbeg_p = 1<a name='3132'>
      IF ( ( xy .eq. 1 .and. me .LT. ntx-1 ) .OR. ( xy .eq. 0 .and. me .LT. nty-1 ) ) THEN<a name='3133'>
        ub = plus_send_start<a name='3134'>
        sendbeg_p = pe - ub + 1 <a name='3135'>
        DO k = ub,pe-shw+1,-1<a name='3136'>
          went = .TRUE.<a name='3137'>
          IF ( xy .eq. 1 ) THEN<a name='3138'>
          IF ( is_intermediate ) THEN<a name='3139'>
            kn =  ( k - parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='3140'>
              CALL task_for_point (kn,1,nds,nde,1,dum,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3141'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_205">('error code returned by task_for_point in module_dm.F (l)')<a name='3142'>
          ELSE<a name='3143'>
              CALL task_for_point (k,1,ds,de,1,dum,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3144'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_206">('error code returned by task_for_point in module_dm.F (m)')<a name='3145'>
          END IF<a name='3146'>
          IF ( Px .NE. me-(iter-1) ) THEN<a name='3147'>
            exit<a name='3148'>
          END IF<a name='3149'>
          ELSE<a name='3150'>
            IF ( is_intermediate ) THEN<a name='3151'>
              kn =  ( k - parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='3152'>
              CALL task_for_point (1,kn,1,dum,nds,nde,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3153'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_207">('error code returned by task_for_point in module_dm.F (l)')<a name='3154'>
            ELSE<a name='3155'>
              CALL task_for_point (1,k,1,dum,ds,de,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3156'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_208">('error code returned by task_for_point in module_dm.F (m)')<a name='3157'>
            END IF<a name='3158'>
            IF ( Py .NE. me-(iter-1) ) THEN<a name='3159'>
              exit<a name='3160'>
            END IF<a name='3161'>
          END IF<a name='3162'>
          plus_send_start = plus_send_start - 1<a name='3163'>
          sendw_p = sendw_p + 1<a name='3164'>
        END DO<a name='3165'>
      END IF<a name='3166'>
      <font color=#447700>! recv from plus<a name='3167'></font>
      recvw_p = 0 <a name='3168'>
      recvbeg_p = 1<a name='3169'>
      IF ( ( xy .eq. 1 .and. me .LT. ntx-1 ) .OR. ( xy .eq. 0 .and. me .LT. nty-1 ) ) THEN<a name='3170'>
        lb = plus_recv_start<a name='3171'>
        recvbeg_p = lb - pe<a name='3172'>
        DO k = lb,pe+shw<a name='3173'>
          went = .TRUE.<a name='3174'>
          IF ( xy .eq. 1 ) THEN<a name='3175'>
          IF ( is_intermediate ) THEN<a name='3176'>
            kn =  ( k - parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='3177'>
              CALL task_for_point (kn,1,nds,nde,1,dum,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3178'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_209">('error code returned by task_for_point in module_dm.F (n)')<a name='3179'>
          ELSE<a name='3180'>
<a name='3181'>
              CALL task_for_point (k,1,ds,de,1,dum,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3182'></font>
<a name='3183'>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_210">('error code returned by task_for_point in module_dm.F (o)')<a name='3184'>
          END IF<a name='3185'>
          IF ( Px .NE. me+iter ) THEN<a name='3186'>
            exit<a name='3187'>
          END IF<a name='3188'>
          ELSE<a name='3189'>
            IF ( is_intermediate ) THEN<a name='3190'>
              kn =  ( k - parent_start ) * parent_grid_ratio + 1 + 1 ;<a name='3191'>
              CALL task_for_point (1,kn,1,dum,nds,nde,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3192'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_211">('error code returned by task_for_point in module_dm.F (n)')<a name='3193'>
            ELSE<a name='3194'>
              CALL task_for_point (1,k,1,dum,ds,de,ntx,nty,Px,Py,minx,miny,ierr) <font color=#447700>! modified to treat x and y separately<a name='3195'></font>
              IF ( ierr .NE. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#RSL_COMM_ITER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_212">('error code returned by task_for_point in module_dm.F (o)')<a name='3196'>
            END IF<a name='3197'>
            IF ( Py .NE. me+iter ) THEN<a name='3198'>
              exit<a name='3199'>
            END IF<a name='3200'>
          END IF<a name='3201'>
          plus_recv_start = plus_recv_start + 1<a name='3202'>
          recvw_p = recvw_p + 1<a name='3203'>
        END DO<a name='3204'>
      END IF<a name='3205'>
#else<a name='3206'>
      if ( iter .eq. 1 ) then<a name='3207'>
        went = .true.<a name='3208'>
      else <a name='3209'>
        went = .false.<a name='3210'>
      endif<a name='3211'>
      sendw_m = 0 ; sendw_p = 0 ; recvw_m = 0 ; recvw_p = 0 <a name='3212'>
      sendbeg_m = 1 ; if ( me .GT. 0 ) sendw_m = shw ; <a name='3213'>
      sendbeg_p = 1 ; if ( me .LT. nt-1 ) sendw_p = shw <a name='3214'>
      recvbeg_m = 1 ; if ( me .GT. 0 ) recvw_m = shw ; <a name='3215'>
      recvbeg_p = 1 ; if ( me .LT. nt-1 ) recvw_p = shw ;<a name='3216'>
<a name='3217'>
      <font color=#447700>! write(0,*)'shw  ', shw , ' xy ',xy<a name='3218'></font>
      <font color=#447700>! write(0,*)' ds, de, ps, pe, nds,nde ',ds, de, ps, pe, nds,nde<a name='3219'></font>
      <font color=#447700>! write(0,*)'sendbeg_m, sendw_m, sendbeg_p, sendw_p, recvbeg_m, recvw_m, recvbeg_p, recvw_p '<a name='3220'></font>
      <font color=#447700>! write(0,*)sendbeg_m, sendw_m, sendbeg_p, sendw_p, recvbeg_m, recvw_m, recvbeg_p, recvw_p<a name='3221'></font>
#endif<a name='3222'>
      <font color=#447700>!if ( went ) then<a name='3223'></font>
      <font color=#447700>!  write(0,*)'shw  ', shw , ' xy ',xy,' plus_send_start ',plus_send_start,' minus_send_start ', minus_send_start<a name='3224'></font>
      <font color=#447700>!  write(0,*)' ds, de, ps, pe, nds,nde ',ds, de, ps, pe, nds,nde<a name='3225'></font>
      <font color=#447700>!  write(0,*)'sendbeg_m, sendw_m, sendbeg_p, sendw_p, recvbeg_m, recvw_m, recvbeg_p, recvw_p '<a name='3226'></font>
      <font color=#447700>!  write(0,*)sendbeg_m, sendw_m, sendbeg_p, sendw_p, recvbeg_m, recvw_m, recvbeg_p, recvw_p<a name='3227'></font>
      <font color=#447700>!endif<a name='3228'></font>
      rsl_comm_iter = went<a name='3229'>
   END FUNCTION rsl_comm_iter<a name='3230'>
<a name='3231'>
<A NAME='WRF_DM_MONITOR_RANK'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_MONITOR_RANK' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3232'>
   INTEGER <font color=#993300>FUNCTION </font><font color=#cc0000>wrf_dm_monitor_rank</font>() <A href='../../call_to/WRF_DM_MONITOR_RANK.html' TARGET='index'>2</A><a name='3233'>
      IMPLICIT NONE<a name='3234'>
      wrf_dm_monitor_rank = 0<a name='3235'>
      RETURN<a name='3236'>
   END FUNCTION wrf_dm_monitor_rank<a name='3237'>
<a name='3238'>
<font color=#447700>! return the global communicator if id &lt;= 0<a name='3239'></font>
<A NAME='WRF_GET_DM_COMMUNICATOR_FOR_ID'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_COMMUNICATOR_FOR_ID' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3240'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_dm_communicator_for_id</font> ( id, communicator ) <A href='../../call_to/WRF_GET_DM_COMMUNICATOR_FOR_ID.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_GET_DM_COMMUNICATOR_FOR_ID.html' TARGET='index'>1</A><a name='3241'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_COMMUNICATOR_FOR_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_78"> , ONLY : local_communicator_store, mpi_comm_allcompute<a name='3242'>
      IMPLICIT NONE<a name='3243'>
      INTEGER , INTENT(IN) :: id<a name='3244'>
      INTEGER , INTENT(OUT) :: communicator<a name='3245'>
      IF ( id .le. 0 ) THEN<a name='3246'>
        communicator = mpi_comm_allcompute<a name='3247'>
      ELSE<a name='3248'>
        communicator = local_communicator_store(id)<a name='3249'>
      END IF<a name='3250'>
      RETURN<a name='3251'>
   END SUBROUTINE wrf_get_dm_communicator_for_id<a name='3252'>
<a name='3253'>
<A NAME='WRF_GET_DM_COMMUNICATOR'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_COMMUNICATOR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3254'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_dm_communicator</font> ( communicator ) <A href='../../call_to/WRF_GET_DM_COMMUNICATOR.html' TARGET='index'>51</A>,<A href='../../call_from/WRF_GET_DM_COMMUNICATOR.html' TARGET='index'>1</A><a name='3255'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_79"> , ONLY : local_communicator<a name='3256'>
      IMPLICIT NONE<a name='3257'>
      INTEGER , INTENT(OUT) :: communicator<a name='3258'>
      communicator = local_communicator<a name='3259'>
      RETURN<a name='3260'>
   END SUBROUTINE wrf_get_dm_communicator<a name='3261'>
<a name='3262'>
<A NAME='WRF_GET_DM_COMMUNICATOR_X'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_COMMUNICATOR_X' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3263'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_dm_communicator_x</font> ( communicator ),<A href='../../call_from/WRF_GET_DM_COMMUNICATOR_X.html' TARGET='index'>1</A><a name='3264'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_COMMUNICATOR_X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_80"> , ONLY : local_communicator_x<a name='3265'>
      IMPLICIT NONE<a name='3266'>
      INTEGER , INTENT(OUT) :: communicator<a name='3267'>
      communicator = local_communicator_x<a name='3268'>
      RETURN<a name='3269'>
   END SUBROUTINE wrf_get_dm_communicator_x<a name='3270'>
<a name='3271'>
<A NAME='WRF_GET_DM_COMMUNICATOR_Y'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_COMMUNICATOR_Y' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3272'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_dm_communicator_y</font> ( communicator ),<A href='../../call_from/WRF_GET_DM_COMMUNICATOR_Y.html' TARGET='index'>1</A><a name='3273'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_COMMUNICATOR_Y' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_81"> , ONLY : local_communicator_y<a name='3274'>
      IMPLICIT NONE<a name='3275'>
      INTEGER , INTENT(OUT) :: communicator<a name='3276'>
      communicator = local_communicator_y<a name='3277'>
      RETURN<a name='3278'>
   END SUBROUTINE wrf_get_dm_communicator_y<a name='3279'>
<a name='3280'>
<A NAME='WRF_GET_DM_IOCOMMUNICATOR'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_IOCOMMUNICATOR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3281'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_dm_iocommunicator</font> ( iocommunicator ),<A href='../../call_from/WRF_GET_DM_IOCOMMUNICATOR.html' TARGET='index'>1</A><a name='3282'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_IOCOMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_82"> , ONLY : local_iocommunicator<a name='3283'>
      IMPLICIT NONE<a name='3284'>
      INTEGER , INTENT(OUT) :: iocommunicator<a name='3285'>
      iocommunicator = local_iocommunicator<a name='3286'>
      RETURN<a name='3287'>
   END SUBROUTINE wrf_get_dm_iocommunicator<a name='3288'>
<a name='3289'>
<A NAME='WRF_SET_DM_COMMUNICATOR'><A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3290'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_set_dm_communicator</font> ( communicator ) <A href='../../call_to/WRF_SET_DM_COMMUNICATOR.html' TARGET='index'>13</A>,<A href='../../call_from/WRF_SET_DM_COMMUNICATOR.html' TARGET='index'>1</A><a name='3291'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_83"> , ONLY : local_communicator<a name='3292'>
      IMPLICIT NONE<a name='3293'>
      INTEGER , INTENT(IN) :: communicator<a name='3294'>
      local_communicator = communicator<a name='3295'>
      RETURN<a name='3296'>
   END SUBROUTINE wrf_set_dm_communicator<a name='3297'>
<a name='3298'>
<A NAME='WRF_SET_DM_IOCOMMUNICATOR'><A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_IOCOMMUNICATOR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3299'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_set_dm_iocommunicator</font> ( iocommunicator ),<A href='../../call_from/WRF_SET_DM_IOCOMMUNICATOR.html' TARGET='index'>1</A><a name='3300'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_IOCOMMUNICATOR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_84"> , ONLY : local_iocommunicator<a name='3301'>
      IMPLICIT NONE<a name='3302'>
      INTEGER , INTENT(IN) :: iocommunicator<a name='3303'>
      local_iocommunicator = iocommunicator<a name='3304'>
      RETURN<a name='3305'>
   END SUBROUTINE wrf_set_dm_iocommunicator<a name='3306'>
<a name='3307'>
<A NAME='WRF_GET_DM_NTASKS_X'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_NTASKS_X' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3308'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_dm_ntasks_x</font> ( retval ),<A href='../../call_from/WRF_GET_DM_NTASKS_X.html' TARGET='index'>1</A><a name='3309'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_NTASKS_X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_85"> , ONLY : ntasks_x<a name='3310'>
      IMPLICIT NONE<a name='3311'>
      INTEGER , INTENT(OUT) :: retval<a name='3312'>
      retval = ntasks_x<a name='3313'>
      RETURN<a name='3314'>
   END SUBROUTINE wrf_get_dm_ntasks_x<a name='3315'>
<a name='3316'>
<A NAME='WRF_GET_DM_NTASKS_Y'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_NTASKS_Y' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3317'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_dm_ntasks_y</font> ( retval ),<A href='../../call_from/WRF_GET_DM_NTASKS_Y.html' TARGET='index'>1</A><a name='3318'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_NTASKS_Y' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_86"> , ONLY : ntasks_y<a name='3319'>
      IMPLICIT NONE<a name='3320'>
      INTEGER , INTENT(OUT) :: retval<a name='3321'>
      retval = ntasks_y<a name='3322'>
      RETURN<a name='3323'>
   END SUBROUTINE wrf_get_dm_ntasks_y<a name='3324'>
<a name='3325'>
<font color=#447700>! added 20151212<a name='3326'></font>
<A NAME='WRF_SET_DM_QUILT_COMM'><A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_QUILT_COMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3327'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_set_dm_quilt_comm</font> ( communicator ) <A href='../../call_to/WRF_SET_DM_QUILT_COMM.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_SET_DM_QUILT_COMM.html' TARGET='index'>1</A><a name='3328'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_QUILT_COMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_87"> , ONLY : local_quilt_comm<a name='3329'>
      IMPLICIT NONE<a name='3330'>
      INTEGER , INTENT(IN) :: communicator<a name='3331'>
      local_quilt_comm = communicator<a name='3332'>
      RETURN<a name='3333'>
   END SUBROUTINE wrf_set_dm_quilt_comm<a name='3334'>
<a name='3335'>
<A NAME='WRF_GET_DM_QUILT_COMM'><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_QUILT_COMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3336'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_get_dm_quilt_comm</font> ( communicator ) <A href='../../call_to/WRF_GET_DM_QUILT_COMM.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_GET_DM_QUILT_COMM.html' TARGET='index'>1</A><a name='3337'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_QUILT_COMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_88"> , ONLY : local_quilt_comm<a name='3338'>
      IMPLICIT NONE<a name='3339'>
      INTEGER , INTENT(OUT) :: communicator<a name='3340'>
      communicator = local_quilt_comm<a name='3341'>
      RETURN<a name='3342'>
   END SUBROUTINE wrf_get_dm_quilt_comm<a name='3343'>
<a name='3344'>
<a name='3345'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!! PATCH TO GLOBAL !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3346'></font>
<a name='3347'>
<A NAME='WRF_PATCH_TO_GLOBAL_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3348'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_patch_to_global_real</font> (buf,globbuf,domdesc,stagger,ordering,&amp; <A href='../../call_to/WRF_PATCH_TO_GLOBAL_REAL.html' TARGET='index'>19</A>,<A href='../../call_from/WRF_PATCH_TO_GLOBAL_REAL.html' TARGET='index'>1</A><a name='3349'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3350'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3351'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3352'>
       IMPLICIT NONE<a name='3353'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3354'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3355'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3356'>
       CHARACTER *(*) stagger,ordering<a name='3357'>
       INTEGER fid,domdesc<a name='3358'>
       REAL globbuf(*)<a name='3359'>
       REAL buf(*)<a name='3360'>
<a name='3361'>
       CALL <A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC'>wrf_patch_to_global_generic</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_GENERIC_1"> (buf,globbuf,domdesc,stagger,ordering,RWORDSIZE,&amp;<a name='3362'>
                                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3363'>
                                         MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3364'>
                                         PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3365'>
<a name='3366'>
       RETURN<a name='3367'>
   END SUBROUTINE wrf_patch_to_global_real <a name='3368'>
<a name='3369'>
<A NAME='WRF_PATCH_TO_GLOBAL_DOUBLE'><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3370'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_patch_to_global_double</font> (buf,globbuf,domdesc,stagger,ordering,&amp; <A href='../../call_to/WRF_PATCH_TO_GLOBAL_DOUBLE.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_PATCH_TO_GLOBAL_DOUBLE.html' TARGET='index'>1</A><a name='3371'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3372'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3373'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3374'>
       IMPLICIT NONE<a name='3375'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3376'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3377'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3378'>
       CHARACTER *(*) stagger,ordering<a name='3379'>
       INTEGER fid,domdesc<a name='3380'>
<font color=#447700>! this next declaration is REAL, not DOUBLE PRECISION because it will be autopromoted<a name='3381'></font>
<font color=#447700>! to double precision by the compiler when WRF is compiled for 8 byte reals. Only reason<a name='3382'></font>
<font color=#447700>! for having this separate routine is so we pass the correct MPI type to mpi_scatterv<a name='3383'></font>
<font color=#447700>! since we were not indexing the globbuf and Field arrays it does not matter<a name='3384'></font>
       REAL globbuf(*)<a name='3385'>
       REAL buf(*)<a name='3386'>
<a name='3387'>
       CALL <A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC'>wrf_patch_to_global_generic</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_GENERIC_2"> (buf,globbuf,domdesc,stagger,ordering,DWORDSIZE,&amp;<a name='3388'>
                                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3389'>
                                         MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3390'>
                                         PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3391'>
<a name='3392'>
       RETURN<a name='3393'>
   END SUBROUTINE wrf_patch_to_global_double<a name='3394'>
<a name='3395'>
<a name='3396'>
<A NAME='WRF_PATCH_TO_GLOBAL_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3397'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_patch_to_global_integer</font> (buf,globbuf,domdesc,stagger,ordering,&amp; <A href='../../call_to/WRF_PATCH_TO_GLOBAL_INTEGER.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_PATCH_TO_GLOBAL_INTEGER.html' TARGET='index'>1</A><a name='3398'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3399'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3400'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3401'>
       IMPLICIT NONE<a name='3402'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3403'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3404'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3405'>
       CHARACTER *(*) stagger,ordering<a name='3406'>
       INTEGER fid,domdesc<a name='3407'>
       INTEGER globbuf(*)<a name='3408'>
       INTEGER buf(*)<a name='3409'>
<a name='3410'>
       CALL <A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC'>wrf_patch_to_global_generic</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_GENERIC_3"> (buf,globbuf,domdesc,stagger,ordering,IWORDSIZE,&amp;<a name='3411'>
                                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3412'>
                                         MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3413'>
                                         PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3414'>
<a name='3415'>
       RETURN<a name='3416'>
   END SUBROUTINE wrf_patch_to_global_integer <a name='3417'>
<a name='3418'>
<a name='3419'>
<A NAME='WRF_PATCH_TO_GLOBAL_LOGICAL'><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3420'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_patch_to_global_logical</font> (buf,globbuf,domdesc,stagger,ordering,&amp; <A href='../../call_to/WRF_PATCH_TO_GLOBAL_LOGICAL.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_PATCH_TO_GLOBAL_LOGICAL.html' TARGET='index'>1</A><a name='3421'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3422'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3423'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3424'>
       IMPLICIT NONE<a name='3425'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3426'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3427'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3428'>
       CHARACTER *(*) stagger,ordering<a name='3429'>
       INTEGER fid,domdesc<a name='3430'>
       LOGICAL globbuf(*)<a name='3431'>
       LOGICAL buf(*)<a name='3432'>
<a name='3433'>
       CALL <A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC'>wrf_patch_to_global_generic</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_LOGICAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_GENERIC_4"> (buf,globbuf,domdesc,stagger,ordering,LWORDSIZE,&amp;<a name='3434'>
                                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3435'>
                                         MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3436'>
                                         PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3437'>
<a name='3438'>
       RETURN<a name='3439'>
   END SUBROUTINE wrf_patch_to_global_logical<a name='3440'>
<a name='3441'>
#ifdef DEREF_KLUDGE<a name='3442'>
#  define FRSTELEM (1)<a name='3443'>
#else<a name='3444'>
#  define FRSTELEM<a name='3445'>
#endif<a name='3446'>
<a name='3447'>
<A NAME='WRF_PATCH_TO_GLOBAL_GENERIC'><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3448'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_patch_to_global_generic</font> (buf,globbuf,domdesc,stagger,ordering,typesize,&amp; <A href='../../call_to/WRF_PATCH_TO_GLOBAL_GENERIC.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_PATCH_TO_GLOBAL_GENERIC.html' TARGET='index'>15</A><a name='3449'>
                                       DS1a,DE1a,DS2a,DE2a,DS3a,DE3a,&amp;<a name='3450'>
                                       MS1a,ME1a,MS2a,ME2a,MS3a,ME3a,&amp;<a name='3451'>
                                       PS1a,PE1a,PS2a,PE2a,PS3a,PE3a )<a name='3452'>
       USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_24"><a name='3453'>
       USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_19"><a name='3454'>
       USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_20">, ONLY : wrf_at_debug_level<a name='3455'>
       USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_89">, ONLY : local_communicator, ntasks<a name='3456'>
<a name='3457'>
       IMPLICIT NONE<a name='3458'>
       INTEGER                         DS1a,DE1a,DS2a,DE2a,DS3a,DE3a,&amp;<a name='3459'>
                                       MS1a,ME1a,MS2a,ME2a,MS3a,ME3a,&amp;<a name='3460'>
                                       PS1a,PE1a,PS2a,PE2a,PS3a,PE3A <a name='3461'>
       CHARACTER *(*) stagger,ordering<a name='3462'>
       INTEGER domdesc,typesize,ierr<a name='3463'>
       REAL globbuf(*)<a name='3464'>
       REAL buf(*)<a name='3465'>
#ifndef STUBMPI<a name='3466'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3467'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3468'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3469'>
       INTEGER                         ids,ide,jds,jde,kds,kde,&amp;<a name='3470'>
                                       ims,ime,jms,jme,kms,kme,&amp;<a name='3471'>
                                       ips,ipe,jps,jpe,kps,kpe<a name='3472'>
       LOGICAL, EXTERNAL :: wrf_dm_on_monitor, has_char<a name='3473'>
<a name='3474'>
       INTEGER i, j, k,  ndim<a name='3475'>
       INTEGER  Patch(3,2), Gpatch(3,2,ntasks)<a name='3476'>
    <font color=#447700>! allocated further down, after the D indices are potentially recalculated for staggering<a name='3477'></font>
       REAL, ALLOCATABLE :: tmpbuf( : )<a name='3478'>
       REAL locbuf( (PE1a-PS1a+1)*(PE2a-PS2a+1)*(PE3a-PS3a+1)/RWORDSIZE*typesize+32 )<a name='3479'>
<a name='3480'>
       DS1 = DS1a ; DE1 = DE1a ; DS2=DS2a ; DE2 = DE2a ; DS3 = DS3a ; DE3 = DE3a<a name='3481'>
       MS1 = MS1a ; ME1 = ME1a ; MS2=MS2a ; ME2 = ME2a ; MS3 = MS3a ; ME3 = ME3a<a name='3482'>
       PS1 = PS1a ; PE1 = PE1a ; PS2=PS2a ; PE2 = PE2a ; PS3 = PS3a ; PE3 = PE3a<a name='3483'>
<a name='3484'>
       SELECT CASE ( TRIM(ordering) )<a name='3485'>
         CASE ( 'xy', 'yx' )<a name='3486'>
           ndim = 2<a name='3487'>
         CASE DEFAULT<a name='3488'>
           ndim = 3   <font color=#447700>! where appropriate<a name='3489'></font>
       END SELECT<a name='3490'>
<a name='3491'>
       SELECT CASE ( TRIM(ordering) )<a name='3492'>
         CASE ( 'xyz','xy' )<a name='3493'>
            <font color=#447700>! the non-staggered variables come in at one-less than<a name='3494'></font>
            <font color=#447700>! domain dimensions, but code wants full domain spec, so<a name='3495'></font>
            <font color=#447700>! adjust if not staggered<a name='3496'></font>
           IF ( .NOT. has_char( stagger, 'x' ) ) DE1 = DE1+1<a name='3497'>
           IF ( .NOT. has_char( stagger, 'y' ) ) DE2 = DE2+1<a name='3498'>
           IF ( ndim .EQ. 3 .AND. .NOT. has_char( stagger, 'z' ) ) DE3 = DE3+1<a name='3499'>
         CASE ( 'yxz','yx' )<a name='3500'>
           IF ( .NOT. has_char( stagger, 'x' ) ) DE2 = DE2+1<a name='3501'>
           IF ( .NOT. has_char( stagger, 'y' ) ) DE1 = DE1+1<a name='3502'>
           IF ( ndim .EQ. 3 .AND. .NOT. has_char( stagger, 'z' ) ) DE3 = DE3+1<a name='3503'>
         CASE ( 'zxy' )<a name='3504'>
           IF ( .NOT. has_char( stagger, 'x' ) ) DE2 = DE2+1<a name='3505'>
           IF ( .NOT. has_char( stagger, 'y' ) ) DE3 = DE3+1<a name='3506'>
           IF ( ndim .EQ. 3 .AND. .NOT. has_char( stagger, 'z' ) ) DE1 = DE1+1<a name='3507'>
         CASE ( 'xzy' )<a name='3508'>
           IF ( .NOT. has_char( stagger, 'x' ) ) DE1 = DE1+1<a name='3509'>
           IF ( .NOT. has_char( stagger, 'y' ) ) DE3 = DE3+1<a name='3510'>
           IF ( ndim .EQ. 3 .AND. .NOT. has_char( stagger, 'z' ) ) DE2 = DE2+1<a name='3511'>
         CASE DEFAULT<a name='3512'>
       END SELECT<a name='3513'>
<a name='3514'>
     <font color=#447700>! moved to here to be after the potential recalculations of D dims<a name='3515'></font>
       IF ( wrf_dm_on_monitor() ) THEN<a name='3516'>
         ALLOCATE ( tmpbuf ( (DE1-DS1+1)*(DE2-DS2+1)*(DE3-DS3+1)/RWORDSIZE*typesize+32 ), STAT=ierr )<a name='3517'>
       ELSE<a name='3518'>
         ALLOCATE ( tmpbuf ( 1 ), STAT=ierr )<a name='3519'>
       END IF<a name='3520'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_213"> ('allocating tmpbuf in wrf_patch_to_global_generic')<a name='3521'>
 <a name='3522'>
       Patch(1,1) = ps1 ; Patch(1,2) = pe1    <font color=#447700>! use patch dims<a name='3523'></font>
       Patch(2,1) = ps2 ; Patch(2,2) = pe2<a name='3524'>
       Patch(3,1) = ps3 ; Patch(3,2) = pe3<a name='3525'>
<a name='3526'>
       IF      ( typesize .EQ. RWORDSIZE ) THEN<a name='3527'>
         CALL <A href='../../html_code/frame/module_dm.F.html#JUST_PATCH_R'>just_patch_r</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JUST_PATCH_R_1"> ( buf , locbuf , size(locbuf)*RWORDSIZE/typesize, &amp;<a name='3528'>
                                   PS1, PE1, PS2, PE2, PS3, PE3 , &amp;<a name='3529'>
                                   MS1, ME1, MS2, ME2, MS3, ME3   )<a name='3530'>
       ELSE IF ( typesize .EQ. IWORDSIZE ) THEN<a name='3531'>
         CALL <A href='../../html_code/frame/module_dm.F.html#JUST_PATCH_I'>just_patch_i</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JUST_PATCH_I_1"> ( buf , locbuf , size(locbuf)*RWORDSIZE/typesize, &amp;<a name='3532'>
                                   PS1, PE1, PS2, PE2, PS3, PE3 , &amp;<a name='3533'>
                                   MS1, ME1, MS2, ME2, MS3, ME3   )<a name='3534'>
       ELSE IF ( typesize .EQ. DWORDSIZE ) THEN<a name='3535'>
         CALL <A href='../../html_code/frame/module_dm.F.html#JUST_PATCH_D'>just_patch_d</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JUST_PATCH_D_1"> ( buf , locbuf , size(locbuf)*RWORDSIZE/typesize, &amp;<a name='3536'>
                                   PS1, PE1, PS2, PE2, PS3, PE3 , &amp;<a name='3537'>
                                   MS1, ME1, MS2, ME2, MS3, ME3   )<a name='3538'>
       ELSE IF ( typesize .EQ. LWORDSIZE ) THEN<a name='3539'>
         CALL <A href='../../html_code/frame/module_dm.F.html#JUST_PATCH_L'>just_patch_l</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="JUST_PATCH_L_1"> ( buf , locbuf , size(locbuf)*RWORDSIZE/typesize, &amp;<a name='3540'>
                                   PS1, PE1, PS2, PE2, PS3, PE3 , &amp;<a name='3541'>
                                   MS1, ME1, MS2, ME2, MS3, ME3   )<a name='3542'>
       END IF<a name='3543'>
<a name='3544'>
<font color=#447700>! defined in external/io_quilt<a name='3545'></font>
       CALL collect_on_comm0 (  local_communicator , IWORDSIZE ,  &amp;<a name='3546'>
                                Patch , 6 ,                       &amp;<a name='3547'>
                                GPatch , 6*ntasks                 )<a name='3548'>
<a name='3549'>
       CALL collect_on_comm0 (  local_communicator , typesize ,  &amp;<a name='3550'>
                                locbuf , (pe1-ps1+1)*(pe2-ps2+1)*(pe3-ps3+1),   &amp;<a name='3551'>
                                tmpbuf FRSTELEM , (de1-ds1+1)*(de2-ds2+1)*(de3-ds3+1) )<a name='3552'>
<a name='3553'>
       ndim = len(TRIM(ordering))<a name='3554'>
<a name='3555'>
       IF ( wrf_at_debug_level(500) ) THEN<a name='3556'>
         CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_4"><a name='3557'>
       END IF<a name='3558'>
<a name='3559'>
       IF ( ndim .GE. 2 .AND. wrf_dm_on_monitor() ) THEN<a name='3560'>
<a name='3561'>
         IF      ( typesize .EQ. RWORDSIZE ) THEN<a name='3562'>
           CALL <A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_R'>patch_2_outbuf_r</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PATCH_2_OUTBUF_R_1"> ( tmpbuf FRSTELEM , globbuf ,             &amp;<a name='3563'>
                                   DS1, DE1, DS2, DE2, DS3, DE3 , &amp;<a name='3564'>
                                   GPATCH                         )<a name='3565'>
         ELSE IF ( typesize .EQ. IWORDSIZE ) THEN<a name='3566'>
           CALL <A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_I'>patch_2_outbuf_i</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PATCH_2_OUTBUF_I_1"> ( tmpbuf FRSTELEM , globbuf ,             &amp;<a name='3567'>
                                   DS1, DE1, DS2, DE2, DS3, DE3 , &amp;<a name='3568'>
                                   GPATCH                         )<a name='3569'>
         ELSE IF ( typesize .EQ. DWORDSIZE ) THEN<a name='3570'>
           CALL <A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_D'>patch_2_outbuf_d</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PATCH_2_OUTBUF_D_1"> ( tmpbuf FRSTELEM , globbuf ,             &amp;<a name='3571'>
                                   DS1, DE1, DS2, DE2, DS3, DE3 , &amp;<a name='3572'>
                                   GPATCH                         )<a name='3573'>
         ELSE IF ( typesize .EQ. LWORDSIZE ) THEN<a name='3574'>
           CALL <A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_L'>patch_2_outbuf_l</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PATCH_2_OUTBUF_L_1"> ( tmpbuf FRSTELEM , globbuf ,             &amp;<a name='3575'>
                                   DS1, DE1, DS2, DE2, DS3, DE3 , &amp;<a name='3576'>
                                   GPATCH                         )<a name='3577'>
         END IF<a name='3578'>
<a name='3579'>
       END IF<a name='3580'>
<a name='3581'>
       IF ( wrf_at_debug_level(500) ) THEN<a name='3582'>
         CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/frame/module_dm.F.html#WRF_PATCH_TO_GLOBAL_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_4">('wrf_patch_to_global_generic')<a name='3583'>
       END IF<a name='3584'>
       DEALLOCATE( tmpbuf )<a name='3585'>
#endif<a name='3586'>
       RETURN<a name='3587'>
    END SUBROUTINE wrf_patch_to_global_generic<a name='3588'>
<a name='3589'>
<A NAME='JUST_PATCH_I'><A href='../../html_code/frame/module_dm.F.html#JUST_PATCH_I' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3590'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>just_patch_i</font> ( inbuf , outbuf, noutbuf,     &amp; <A href='../../call_to/JUST_PATCH_I.html' TARGET='index'>1</A><a name='3591'>
                               PS1,PE1,PS2,PE2,PS3,PE3,  &amp;<a name='3592'>
                               MS1,ME1,MS2,ME2,MS3,ME3   )<a name='3593'>
    IMPLICIT NONE<a name='3594'>
    INTEGER                         , INTENT(IN)  :: noutbuf<a name='3595'>
    INTEGER    , DIMENSION(noutbuf) , INTENT(OUT) :: outbuf<a name='3596'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='3597'>
    INTEGER   PS1,PE1,PS2,PE2,PS3,PE3<a name='3598'>
    INTEGER    , DIMENSION( MS1:ME1,MS2:ME2,MS3:ME3 ) , INTENT(IN) :: inbuf<a name='3599'>
<font color=#447700>! Local<a name='3600'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='3601'>
    icurs = 1<a name='3602'>
      DO k = PS3, PE3<a name='3603'>
        DO j = PS2, PE2<a name='3604'>
          DO i = PS1, PE1<a name='3605'>
            outbuf( icurs )  = inbuf( i, j, k )<a name='3606'>
            icurs = icurs + 1<a name='3607'>
          END DO<a name='3608'>
        END DO<a name='3609'>
      END DO<a name='3610'>
    RETURN<a name='3611'>
  END SUBROUTINE just_patch_i<a name='3612'>
<a name='3613'>
<A NAME='JUST_PATCH_R'><A href='../../html_code/frame/module_dm.F.html#JUST_PATCH_R' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3614'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>just_patch_r</font> ( inbuf , outbuf, noutbuf,     &amp; <A href='../../call_to/JUST_PATCH_R.html' TARGET='index'>1</A><a name='3615'>
                               PS1,PE1,PS2,PE2,PS3,PE3,  &amp;<a name='3616'>
                               MS1,ME1,MS2,ME2,MS3,ME3   )<a name='3617'>
    IMPLICIT NONE<a name='3618'>
    INTEGER                      , INTENT(IN)  :: noutbuf<a name='3619'>
    REAL    , DIMENSION(noutbuf) , INTENT(OUT) :: outbuf<a name='3620'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='3621'>
    INTEGER   PS1,PE1,PS2,PE2,PS3,PE3<a name='3622'>
    REAL    , DIMENSION( MS1:ME1,MS2:ME2,MS3:ME3 ) , INTENT(in) :: inbuf<a name='3623'>
<font color=#447700>! Local<a name='3624'></font>
    INTEGER               :: i,j,k   ,  icurs<a name='3625'>
    icurs = 1<a name='3626'>
      DO k = PS3, PE3<a name='3627'>
        DO j = PS2, PE2 <a name='3628'>
          DO i = PS1, PE1<a name='3629'>
            outbuf( icurs )  = inbuf( i, j, k )<a name='3630'>
            icurs = icurs + 1<a name='3631'>
          END DO<a name='3632'>
        END DO<a name='3633'>
      END DO<a name='3634'>
    RETURN<a name='3635'>
  END SUBROUTINE just_patch_r<a name='3636'>
<a name='3637'>
<A NAME='JUST_PATCH_D'><A href='../../html_code/frame/module_dm.F.html#JUST_PATCH_D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3638'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>just_patch_d</font> ( inbuf , outbuf, noutbuf,     &amp; <A href='../../call_to/JUST_PATCH_D.html' TARGET='index'>1</A><a name='3639'>
                               PS1,PE1,PS2,PE2,PS3,PE3,  &amp;<a name='3640'>
                               MS1,ME1,MS2,ME2,MS3,ME3   )<a name='3641'>
    IMPLICIT NONE<a name='3642'>
    INTEGER                                  , INTENT(IN)  :: noutbuf<a name='3643'>
    DOUBLE PRECISION    , DIMENSION(noutbuf) , INTENT(OUT) :: outbuf<a name='3644'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='3645'>
    INTEGER   PS1,PE1,PS2,PE2,PS3,PE3<a name='3646'>
    DOUBLE PRECISION    , DIMENSION( MS1:ME1,MS2:ME2,MS3:ME3 ) , INTENT(in) :: inbuf<a name='3647'>
<font color=#447700>! Local<a name='3648'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='3649'>
    icurs = 1<a name='3650'>
      DO k = PS3, PE3<a name='3651'>
        DO j = PS2, PE2 <a name='3652'>
          DO i = PS1, PE1<a name='3653'>
            outbuf( icurs )  = inbuf( i, j, k )<a name='3654'>
            icurs = icurs + 1<a name='3655'>
          END DO<a name='3656'>
        END DO<a name='3657'>
      END DO<a name='3658'>
    RETURN<a name='3659'>
  END SUBROUTINE just_patch_d<a name='3660'>
<a name='3661'>
<A NAME='JUST_PATCH_L'><A href='../../html_code/frame/module_dm.F.html#JUST_PATCH_L' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3662'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>just_patch_l</font> ( inbuf , outbuf, noutbuf,     &amp; <A href='../../call_to/JUST_PATCH_L.html' TARGET='index'>1</A><a name='3663'>
                               PS1,PE1,PS2,PE2,PS3,PE3,  &amp;<a name='3664'>
                               MS1,ME1,MS2,ME2,MS3,ME3   )<a name='3665'>
    IMPLICIT NONE<a name='3666'>
    INTEGER                         , INTENT(IN)  :: noutbuf<a name='3667'>
    LOGICAL    , DIMENSION(noutbuf) , INTENT(OUT) :: outbuf<a name='3668'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='3669'>
    INTEGER   PS1,PE1,PS2,PE2,PS3,PE3<a name='3670'>
    LOGICAL    , DIMENSION( MS1:ME1,MS2:ME2,MS3:ME3 ) , INTENT(in) :: inbuf<a name='3671'>
<font color=#447700>! Local<a name='3672'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='3673'>
    icurs = 1<a name='3674'>
      DO k = PS3, PE3<a name='3675'>
        DO j = PS2, PE2 <a name='3676'>
          DO i = PS1, PE1<a name='3677'>
            outbuf( icurs )  = inbuf( i, j, k )<a name='3678'>
            icurs = icurs + 1<a name='3679'>
          END DO<a name='3680'>
        END DO<a name='3681'>
      END DO<a name='3682'>
    RETURN<a name='3683'>
  END SUBROUTINE just_patch_l<a name='3684'>
<a name='3685'>
<a name='3686'>
<A NAME='PATCH_2_OUTBUF_R'><A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_R' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3687'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>patch_2_outbuf_r</font>( inbuf, outbuf,            &amp; <A href='../../call_to/PATCH_2_OUTBUF_R.html' TARGET='index'>1</A>,<A href='../../call_from/PATCH_2_OUTBUF_R.html' TARGET='index'>1</A><a name='3688'>
                               DS1,DE1,DS2,DE2,DS3,DE3,  &amp;<a name='3689'>
                               GPATCH ) <a name='3690'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_R' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_90">, ONLY : ntasks<a name='3691'>
    IMPLICIT NONE<a name='3692'>
    REAL    , DIMENSION(*) , INTENT(IN) :: inbuf<a name='3693'>
    INTEGER   DS1,DE1,DS2,DE2,DS3,DE3,GPATCH(3,2,ntasks)<a name='3694'>
    REAL    , DIMENSION( DS1:DE1,DS2:DE2,DS3:DE3 ) , INTENT(out) :: outbuf<a name='3695'>
<font color=#447700>! Local<a name='3696'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='3697'>
    icurs = 1<a name='3698'>
    DO n = 1, ntasks<a name='3699'>
      DO k = GPATCH( 3,1,n ), GPATCH( 3,2,n )<a name='3700'>
        DO j = GPATCH( 2,1,n ), GPATCH( 2,2,n )<a name='3701'>
          DO i = GPATCH( 1,1,n ), GPATCH( 1,2,n )<a name='3702'>
            outbuf( i, j, k ) = inbuf( icurs )<a name='3703'>
            icurs = icurs + 1<a name='3704'>
          END DO<a name='3705'>
        END DO<a name='3706'>
      END DO<a name='3707'>
    END DO<a name='3708'>
<a name='3709'>
    RETURN<a name='3710'>
  END SUBROUTINE patch_2_outbuf_r<a name='3711'>
<a name='3712'>
<A NAME='PATCH_2_OUTBUF_I'><A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_I' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3713'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>patch_2_outbuf_i</font>( inbuf, outbuf,         &amp; <A href='../../call_to/PATCH_2_OUTBUF_I.html' TARGET='index'>1</A>,<A href='../../call_from/PATCH_2_OUTBUF_I.html' TARGET='index'>1</A><a name='3714'>
                               DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3715'>
                               GPATCH )<a name='3716'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_I' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_91">, ONLY : ntasks<a name='3717'>
    IMPLICIT NONE<a name='3718'>
    INTEGER    , DIMENSION(*) , INTENT(IN) :: inbuf<a name='3719'>
    INTEGER   DS1,DE1,DS2,DE2,DS3,DE3,GPATCH(3,2,ntasks)<a name='3720'>
    INTEGER    , DIMENSION( DS1:DE1,DS2:DE2,DS3:DE3 ) , INTENT(out) :: outbuf<a name='3721'>
<font color=#447700>! Local<a name='3722'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='3723'>
    icurs = 1<a name='3724'>
    DO n = 1, ntasks<a name='3725'>
      DO k = GPATCH( 3,1,n ), GPATCH( 3,2,n )<a name='3726'>
        DO j = GPATCH( 2,1,n ), GPATCH( 2,2,n )<a name='3727'>
          DO i = GPATCH( 1,1,n ), GPATCH( 1,2,n )<a name='3728'>
            outbuf( i, j, k ) = inbuf( icurs )<a name='3729'>
            icurs = icurs + 1<a name='3730'>
          END DO<a name='3731'>
        END DO<a name='3732'>
      END DO<a name='3733'>
    END DO<a name='3734'>
    RETURN<a name='3735'>
  END SUBROUTINE patch_2_outbuf_i<a name='3736'>
<a name='3737'>
<A NAME='PATCH_2_OUTBUF_D'><A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3738'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>patch_2_outbuf_d</font>( inbuf, outbuf,         &amp; <A href='../../call_to/PATCH_2_OUTBUF_D.html' TARGET='index'>1</A>,<A href='../../call_from/PATCH_2_OUTBUF_D.html' TARGET='index'>1</A><a name='3739'>
                               DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3740'>
                               GPATCH )<a name='3741'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_92">, ONLY : ntasks<a name='3742'>
    IMPLICIT NONE<a name='3743'>
    DOUBLE PRECISION    , DIMENSION(*) , INTENT(IN) :: inbuf<a name='3744'>
    INTEGER   DS1,DE1,DS2,DE2,DS3,DE3,GPATCH(3,2,ntasks)<a name='3745'>
    DOUBLE PRECISION    , DIMENSION( DS1:DE1,DS2:DE2,DS3:DE3 ) , INTENT(out) :: outbuf<a name='3746'>
<font color=#447700>! Local<a name='3747'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='3748'>
    icurs = 1<a name='3749'>
    DO n = 1, ntasks<a name='3750'>
      DO k = GPATCH( 3,1,n ), GPATCH( 3,2,n )<a name='3751'>
        DO j = GPATCH( 2,1,n ), GPATCH( 2,2,n )<a name='3752'>
          DO i = GPATCH( 1,1,n ), GPATCH( 1,2,n )<a name='3753'>
            outbuf( i, j, k ) = inbuf( icurs )<a name='3754'>
            icurs = icurs + 1<a name='3755'>
          END DO<a name='3756'>
        END DO<a name='3757'>
      END DO<a name='3758'>
    END DO<a name='3759'>
    RETURN<a name='3760'>
  END SUBROUTINE patch_2_outbuf_d<a name='3761'>
<a name='3762'>
<A NAME='PATCH_2_OUTBUF_L'><A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_L' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3763'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>patch_2_outbuf_l</font>( inbuf, outbuf,         &amp; <A href='../../call_to/PATCH_2_OUTBUF_L.html' TARGET='index'>1</A>,<A href='../../call_from/PATCH_2_OUTBUF_L.html' TARGET='index'>1</A><a name='3764'>
                               DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3765'>
                               GPATCH )<a name='3766'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#PATCH_2_OUTBUF_L' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_93">, ONLY : ntasks<a name='3767'>
    IMPLICIT NONE<a name='3768'>
    LOGICAL    , DIMENSION(*) , INTENT(IN) :: inbuf<a name='3769'>
    INTEGER   DS1,DE1,DS2,DE2,DS3,DE3,GPATCH(3,2,ntasks)<a name='3770'>
    LOGICAL    , DIMENSION( DS1:DE1,DS2:DE2,DS3:DE3 ) , INTENT(out) :: outbuf<a name='3771'>
<font color=#447700>! Local<a name='3772'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='3773'>
    icurs = 1<a name='3774'>
    DO n = 1, ntasks<a name='3775'>
      DO k = GPATCH( 3,1,n ), GPATCH( 3,2,n )<a name='3776'>
        DO j = GPATCH( 2,1,n ), GPATCH( 2,2,n )<a name='3777'>
          DO i = GPATCH( 1,1,n ), GPATCH( 1,2,n )<a name='3778'>
            outbuf( i, j, k ) = inbuf( icurs )<a name='3779'>
            icurs = icurs + 1<a name='3780'>
          END DO<a name='3781'>
        END DO<a name='3782'>
      END DO<a name='3783'>
    END DO<a name='3784'>
    RETURN<a name='3785'>
  END SUBROUTINE patch_2_outbuf_l<a name='3786'>
<a name='3787'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!! GLOBAL TO PATCH !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='3788'></font>
<a name='3789'>
<A NAME='WRF_GLOBAL_TO_PATCH_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3790'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_global_to_patch_real</font> (globbuf,buf,domdesc,stagger,ordering,&amp; <A href='../../call_to/WRF_GLOBAL_TO_PATCH_REAL.html' TARGET='index'>8</A>,<A href='../../call_from/WRF_GLOBAL_TO_PATCH_REAL.html' TARGET='index'>1</A><a name='3791'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3792'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3793'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3794'>
       IMPLICIT NONE<a name='3795'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3796'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3797'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3798'>
       CHARACTER *(*) stagger,ordering<a name='3799'>
       INTEGER fid,domdesc<a name='3800'>
       REAL globbuf(*)<a name='3801'>
       REAL buf(*)<a name='3802'>
<a name='3803'>
       CALL <A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC'>wrf_global_to_patch_generic</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_GENERIC_1"> (globbuf,buf,domdesc,stagger,ordering,RWORDSIZE,&amp;<a name='3804'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3805'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3806'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3807'>
       RETURN<a name='3808'>
    END SUBROUTINE wrf_global_to_patch_real<a name='3809'>
<a name='3810'>
<A NAME='WRF_GLOBAL_TO_PATCH_DOUBLE'><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3811'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_global_to_patch_double</font> (globbuf,buf,domdesc,stagger,ordering,&amp; <A href='../../call_to/WRF_GLOBAL_TO_PATCH_DOUBLE.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_GLOBAL_TO_PATCH_DOUBLE.html' TARGET='index'>1</A><a name='3812'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3813'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3814'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3815'>
       IMPLICIT NONE<a name='3816'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3817'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3818'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3819'>
       CHARACTER *(*) stagger,ordering<a name='3820'>
       INTEGER fid,domdesc<a name='3821'>
<font color=#447700>! this next declaration is REAL, not DOUBLE PRECISION because it will be autopromoted<a name='3822'></font>
<font color=#447700>! to double precision by the compiler when WRF is compiled for 8 byte reals. Only reason<a name='3823'></font>
<font color=#447700>! for having this separate routine is so we pass the correct MPI type to mpi_scatterv<a name='3824'></font>
<font color=#447700>! since we were not indexing the globbuf and Field arrays it does not matter<a name='3825'></font>
       REAL globbuf(*)<a name='3826'>
       REAL buf(*)<a name='3827'>
<a name='3828'>
       CALL <A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC'>wrf_global_to_patch_generic</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_GENERIC_2"> (globbuf,buf,domdesc,stagger,ordering,DWORDSIZE,&amp;<a name='3829'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3830'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3831'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3832'>
       RETURN<a name='3833'>
    END SUBROUTINE wrf_global_to_patch_double<a name='3834'>
<a name='3835'>
<a name='3836'>
<A NAME='WRF_GLOBAL_TO_PATCH_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3837'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_global_to_patch_integer</font> (globbuf,buf,domdesc,stagger,ordering,&amp; <A href='../../call_to/WRF_GLOBAL_TO_PATCH_INTEGER.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_GLOBAL_TO_PATCH_INTEGER.html' TARGET='index'>1</A><a name='3838'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3839'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3840'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3841'>
       IMPLICIT NONE<a name='3842'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3843'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3844'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3845'>
       CHARACTER *(*) stagger,ordering<a name='3846'>
       INTEGER fid,domdesc<a name='3847'>
       INTEGER globbuf(*)<a name='3848'>
       INTEGER buf(*)<a name='3849'>
<a name='3850'>
       CALL <A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC'>wrf_global_to_patch_generic</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_GENERIC_3"> (globbuf,buf,domdesc,stagger,ordering,IWORDSIZE,&amp;<a name='3851'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3852'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3853'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3854'>
       RETURN<a name='3855'>
    END SUBROUTINE wrf_global_to_patch_integer<a name='3856'>
<a name='3857'>
<A NAME='WRF_GLOBAL_TO_PATCH_LOGICAL'><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3858'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_global_to_patch_logical</font> (globbuf,buf,domdesc,stagger,ordering,&amp; <A href='../../call_to/WRF_GLOBAL_TO_PATCH_LOGICAL.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_GLOBAL_TO_PATCH_LOGICAL.html' TARGET='index'>1</A><a name='3859'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3860'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3861'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3862'>
       IMPLICIT NONE<a name='3863'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3864'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3865'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3866'>
       CHARACTER *(*) stagger,ordering<a name='3867'>
       INTEGER fid,domdesc<a name='3868'>
       LOGICAL globbuf(*)<a name='3869'>
       LOGICAL buf(*)<a name='3870'>
<a name='3871'>
       CALL <A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC'>wrf_global_to_patch_generic</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_LOGICAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_GENERIC_4"> (globbuf,buf,domdesc,stagger,ordering,LWORDSIZE,&amp;<a name='3872'>
                                       DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3873'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3874'>
                                       PS1,PE1,PS2,PE2,PS3,PE3 )<a name='3875'>
       RETURN<a name='3876'>
    END SUBROUTINE wrf_global_to_patch_logical<a name='3877'>
<a name='3878'>
<A NAME='WRF_GLOBAL_TO_PATCH_GENERIC'><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3879'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_global_to_patch_generic</font> (globbuf,buf,domdesc,stagger,ordering,typesize,&amp; <A href='../../call_to/WRF_GLOBAL_TO_PATCH_GENERIC.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_GLOBAL_TO_PATCH_GENERIC.html' TARGET='index'>11</A><a name='3880'>
                                       DS1a,DE1a,DS2a,DE2a,DS3a,DE3a,&amp;<a name='3881'>
                                       MS1a,ME1a,MS2a,ME2a,MS3a,ME3a,&amp;<a name='3882'>
                                       PS1a,PE1a,PS2a,PE2a,PS3a,PE3a )<a name='3883'>
       USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_94">, ONLY : local_communicator, ntasks<a name='3884'>
       USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_25"><a name='3885'>
       IMPLICIT NONE<a name='3886'>
       INTEGER                         DS1a,DE1a,DS2a,DE2a,DS3a,DE3a,&amp;<a name='3887'>
                                       MS1a,ME1a,MS2a,ME2a,MS3a,ME3a,&amp;<a name='3888'>
                                       PS1a,PE1a,PS2a,PE2a,PS3a,PE3A <a name='3889'>
       CHARACTER *(*) stagger,ordering<a name='3890'>
       INTEGER domdesc,typesize,ierr<a name='3891'>
       REAL globbuf(*)<a name='3892'>
       REAL buf(*)<a name='3893'>
#ifndef STUBMPI<a name='3894'>
       INTEGER                         DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='3895'>
                                       MS1,ME1,MS2,ME2,MS3,ME3,&amp;<a name='3896'>
                                       PS1,PE1,PS2,PE2,PS3,PE3<a name='3897'>
       LOGICAL, EXTERNAL :: wrf_dm_on_monitor, has_char<a name='3898'>
<a name='3899'>
       INTEGER i,j,k,ord,ord2d,ndim<a name='3900'>
       INTEGER  Patch(3,2), Gpatch(3,2,ntasks)<a name='3901'>
       REAL, ALLOCATABLE :: tmpbuf( : )<a name='3902'>
       REAL locbuf( (PE1a-PS1a+1)*(PE2a-PS2a+1)*(PE3a-PS3a+1)/RWORDSIZE*typesize+32 )<a name='3903'>
<a name='3904'>
       DS1 = DS1a ; DE1 = DE1a ; DS2=DS2a ; DE2 = DE2a ; DS3 = DS3a ; DE3 = DE3a<a name='3905'>
       MS1 = MS1a ; ME1 = ME1a ; MS2=MS2a ; ME2 = ME2a ; MS3 = MS3a ; ME3 = ME3a<a name='3906'>
       PS1 = PS1a ; PE1 = PE1a ; PS2=PS2a ; PE2 = PE2a ; PS3 = PS3a ; PE3 = PE3a<a name='3907'>
<a name='3908'>
       SELECT CASE ( TRIM(ordering) )<a name='3909'>
         CASE ( 'xy', 'yx' )<a name='3910'>
           ndim = 2<a name='3911'>
         CASE DEFAULT<a name='3912'>
           ndim = 3   <font color=#447700>! where appropriate<a name='3913'></font>
       END SELECT<a name='3914'>
<a name='3915'>
       SELECT CASE ( TRIM(ordering) )<a name='3916'>
         CASE ( 'xyz','xy' )<a name='3917'>
            <font color=#447700>! the non-staggered variables come in at one-less than<a name='3918'></font>
            <font color=#447700>! domain dimensions, but code wants full domain spec, so<a name='3919'></font>
            <font color=#447700>! adjust if not staggered<a name='3920'></font>
           IF ( .NOT. has_char( stagger, 'x' ) ) DE1 = DE1+1<a name='3921'>
           IF ( .NOT. has_char( stagger, 'y' ) ) DE2 = DE2+1<a name='3922'>
           IF ( ndim .EQ. 3 .AND. .NOT. has_char( stagger, 'z' ) ) DE3 = DE3+1<a name='3923'>
         CASE ( 'yxz','yx' )<a name='3924'>
           IF ( .NOT. has_char( stagger, 'x' ) ) DE2 = DE2+1<a name='3925'>
           IF ( .NOT. has_char( stagger, 'y' ) ) DE1 = DE1+1<a name='3926'>
           IF ( ndim .EQ. 3 .AND. .NOT. has_char( stagger, 'z' ) ) DE3 = DE3+1<a name='3927'>
         CASE ( 'zxy' )<a name='3928'>
           IF ( .NOT. has_char( stagger, 'x' ) ) DE2 = DE2+1<a name='3929'>
           IF ( .NOT. has_char( stagger, 'y' ) ) DE3 = DE3+1<a name='3930'>
           IF ( ndim .EQ. 3 .AND. .NOT. has_char( stagger, 'z' ) ) DE1 = DE1+1<a name='3931'>
         CASE ( 'xzy' )<a name='3932'>
           IF ( .NOT. has_char( stagger, 'x' ) ) DE1 = DE1+1<a name='3933'>
           IF ( .NOT. has_char( stagger, 'y' ) ) DE3 = DE3+1<a name='3934'>
           IF ( ndim .EQ. 3 .AND. .NOT. has_char( stagger, 'z' ) ) DE2 = DE2+1<a name='3935'>
         CASE DEFAULT<a name='3936'>
       END SELECT<a name='3937'>
<a name='3938'>
     <font color=#447700>! moved to here to be after the potential recalculations of D dims<a name='3939'></font>
       IF ( wrf_dm_on_monitor() ) THEN<a name='3940'>
         ALLOCATE ( tmpbuf ( (DE1-DS1+1)*(DE2-DS2+1)*(DE3-DS3+1)/RWORDSIZE*typesize+32 ), STAT=ierr )<a name='3941'>
       ELSE<a name='3942'>
         ALLOCATE ( tmpbuf ( 1 ), STAT=ierr )<a name='3943'>
       END IF<a name='3944'>
       IF ( ierr .ne. 0 ) CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_214"> ('allocating tmpbuf in wrf_global_to_patch_generic')<a name='3945'>
<a name='3946'>
       Patch(1,1) = ps1 ; Patch(1,2) = pe1    <font color=#447700>! use patch dims<a name='3947'></font>
       Patch(2,1) = ps2 ; Patch(2,2) = pe2<a name='3948'>
       Patch(3,1) = ps3 ; Patch(3,2) = pe3<a name='3949'>
<a name='3950'>
<font color=#447700>! defined in external/io_quilt<a name='3951'></font>
       CALL collect_on_comm0 (  local_communicator , IWORDSIZE ,  &amp;<a name='3952'>
                                Patch , 6 ,                       &amp;<a name='3953'>
                                GPatch , 6*ntasks                 )<a name='3954'>
       ndim = len(TRIM(ordering))<a name='3955'>
<a name='3956'>
       IF ( wrf_dm_on_monitor() .AND. ndim .GE. 2 ) THEN<a name='3957'>
         IF      ( typesize .EQ. RWORDSIZE ) THEN<a name='3958'>
           CALL <A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_R'>outbuf_2_patch_r</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTBUF_2_PATCH_R_1"> ( globbuf , tmpbuf FRSTELEM ,    &amp;<a name='3959'>
                                   DS1, DE1, DS2, DE2, DS3, DE3 , &amp;<a name='3960'>
                                   MS1, ME1, MS2, ME2, MS3, ME3 , &amp;<a name='3961'>
                                   GPATCH                         )<a name='3962'>
         ELSE IF ( typesize .EQ. IWORDSIZE ) THEN<a name='3963'>
           CALL <A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_I'>outbuf_2_patch_i</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTBUF_2_PATCH_I_1"> ( globbuf , tmpbuf FRSTELEM ,    &amp;<a name='3964'>
                                   DS1, DE1, DS2, DE2, DS3, DE3 , &amp;<a name='3965'>
                                   GPATCH                         )<a name='3966'>
         ELSE IF ( typesize .EQ. DWORDSIZE ) THEN<a name='3967'>
           CALL <A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_D'>outbuf_2_patch_d</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTBUF_2_PATCH_D_1"> ( globbuf , tmpbuf FRSTELEM ,    &amp;<a name='3968'>
                                   DS1, DE1, DS2, DE2, DS3, DE3 , &amp;<a name='3969'>
                                   GPATCH                         )<a name='3970'>
         ELSE IF ( typesize .EQ. LWORDSIZE ) THEN<a name='3971'>
           CALL <A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_L'>outbuf_2_patch_l</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OUTBUF_2_PATCH_L_1"> ( globbuf , tmpbuf FRSTELEM ,    &amp;<a name='3972'>
                                   DS1, DE1, DS2, DE2, DS3, DE3 , &amp;<a name='3973'>
                                   GPATCH                         )<a name='3974'>
         END IF<a name='3975'>
       END IF<a name='3976'>
<a name='3977'>
       CALL dist_on_comm0 (  local_communicator , typesize ,  &amp;<a name='3978'>
                             tmpbuf FRSTELEM , (de1-ds1+1)*(de2-ds2+1)*(de3-ds3+1) , &amp;<a name='3979'>
                             locbuf    , (pe1-ps1+1)*(pe2-ps2+1)*(pe3-ps3+1) )<a name='3980'>
<a name='3981'>
       IF      ( typesize .EQ. RWORDSIZE ) THEN<a name='3982'>
         CALL <A href='../../html_code/frame/module_dm.F.html#ALL_SUB_R'>all_sub_r</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALL_SUB_R_1"> ( locbuf , buf ,             &amp;<a name='3983'>
                                   PS1, PE1, PS2, PE2, PS3, PE3 , &amp;<a name='3984'>
                                   MS1, ME1, MS2, ME2, MS3, ME3   )<a name='3985'>
<a name='3986'>
       ELSE IF ( typesize .EQ. IWORDSIZE ) THEN<a name='3987'>
         CALL <A href='../../html_code/frame/module_dm.F.html#ALL_SUB_I'>all_sub_i</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALL_SUB_I_1"> ( locbuf , buf ,             &amp;<a name='3988'>
                                   PS1, PE1, PS2, PE2, PS3, PE3 , &amp;<a name='3989'>
                                   MS1, ME1, MS2, ME2, MS3, ME3   )<a name='3990'>
       ELSE IF ( typesize .EQ. DWORDSIZE ) THEN<a name='3991'>
         CALL <A href='../../html_code/frame/module_dm.F.html#ALL_SUB_D'>all_sub_d</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALL_SUB_D_1"> ( locbuf , buf ,             &amp;<a name='3992'>
                                   PS1, PE1, PS2, PE2, PS3, PE3 , &amp;<a name='3993'>
                                   MS1, ME1, MS2, ME2, MS3, ME3   )<a name='3994'>
       ELSE IF ( typesize .EQ. LWORDSIZE ) THEN<a name='3995'>
         CALL <A href='../../html_code/frame/module_dm.F.html#ALL_SUB_L'>all_sub_l</A><A href='../../html_code/frame/module_dm.F.html#WRF_GLOBAL_TO_PATCH_GENERIC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALL_SUB_L_1"> ( locbuf , buf ,             &amp;<a name='3996'>
                                   PS1, PE1, PS2, PE2, PS3, PE3 , &amp;<a name='3997'>
                                   MS1, ME1, MS2, ME2, MS3, ME3   )<a name='3998'>
       END IF<a name='3999'>
<a name='4000'>
<a name='4001'>
       DEALLOCATE ( tmpbuf )<a name='4002'>
#endif<a name='4003'>
       RETURN<a name='4004'>
    END SUBROUTINE wrf_global_to_patch_generic<a name='4005'>
<a name='4006'>
<A NAME='ALL_SUB_I'><A href='../../html_code/frame/module_dm.F.html#ALL_SUB_I' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4007'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>all_sub_i</font> ( inbuf , outbuf,              &amp; <A href='../../call_to/ALL_SUB_I.html' TARGET='index'>1</A><a name='4008'>
                               PS1,PE1,PS2,PE2,PS3,PE3,  &amp;<a name='4009'>
                               MS1,ME1,MS2,ME2,MS3,ME3   )<a name='4010'>
    IMPLICIT NONE<a name='4011'>
    INTEGER    , DIMENSION(*) , INTENT(IN) :: inbuf<a name='4012'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='4013'>
    INTEGER   PS1,PE1,PS2,PE2,PS3,PE3<a name='4014'>
    INTEGER    , DIMENSION( MS1:ME1,MS2:ME2,MS3:ME3 ) , INTENT(OUT) :: outbuf<a name='4015'>
<font color=#447700>! Local<a name='4016'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='4017'>
    icurs = 1<a name='4018'>
      DO k = PS3, PE3<a name='4019'>
        DO j = PS2, PE2<a name='4020'>
          DO i = PS1, PE1<a name='4021'>
            outbuf( i, j, k )  = inbuf ( icurs )<a name='4022'>
            icurs = icurs + 1<a name='4023'>
          END DO<a name='4024'>
        END DO<a name='4025'>
      END DO<a name='4026'>
    RETURN<a name='4027'>
  END SUBROUTINE all_sub_i<a name='4028'>
<a name='4029'>
<A NAME='ALL_SUB_R'><A href='../../html_code/frame/module_dm.F.html#ALL_SUB_R' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4030'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>all_sub_r</font> ( inbuf , outbuf,              &amp; <A href='../../call_to/ALL_SUB_R.html' TARGET='index'>1</A><a name='4031'>
                               PS1,PE1,PS2,PE2,PS3,PE3,  &amp;<a name='4032'>
                               MS1,ME1,MS2,ME2,MS3,ME3   )<a name='4033'>
    IMPLICIT NONE<a name='4034'>
    REAL       , DIMENSION(*) , INTENT(IN) :: inbuf<a name='4035'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='4036'>
    INTEGER   PS1,PE1,PS2,PE2,PS3,PE3<a name='4037'>
    REAL       , DIMENSION( MS1:ME1,MS2:ME2,MS3:ME3 ) , INTENT(OUT) :: outbuf<a name='4038'>
<font color=#447700>! Local<a name='4039'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='4040'>
    icurs = 1<a name='4041'>
      DO k = PS3, PE3<a name='4042'>
        DO j = PS2, PE2<a name='4043'>
          DO i = PS1, PE1<a name='4044'>
            outbuf( i, j, k )  = inbuf ( icurs )<a name='4045'>
            icurs = icurs + 1<a name='4046'>
          END DO<a name='4047'>
        END DO<a name='4048'>
      END DO<a name='4049'>
<a name='4050'>
    RETURN<a name='4051'>
  END SUBROUTINE all_sub_r<a name='4052'>
<a name='4053'>
<A NAME='ALL_SUB_D'><A href='../../html_code/frame/module_dm.F.html#ALL_SUB_D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4054'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>all_sub_d</font> ( inbuf , outbuf,              &amp; <A href='../../call_to/ALL_SUB_D.html' TARGET='index'>1</A><a name='4055'>
                               PS1,PE1,PS2,PE2,PS3,PE3,  &amp;<a name='4056'>
                               MS1,ME1,MS2,ME2,MS3,ME3   )<a name='4057'>
    IMPLICIT NONE<a name='4058'>
    DOUBLE PRECISION    , DIMENSION(*) , INTENT(IN) :: inbuf<a name='4059'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='4060'>
    INTEGER   PS1,PE1,PS2,PE2,PS3,PE3<a name='4061'>
    DOUBLE PRECISION    , DIMENSION( MS1:ME1,MS2:ME2,MS3:ME3 ) , INTENT(OUT) :: outbuf<a name='4062'>
<font color=#447700>! Local<a name='4063'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='4064'>
    icurs = 1<a name='4065'>
      DO k = PS3, PE3<a name='4066'>
        DO j = PS2, PE2<a name='4067'>
          DO i = PS1, PE1<a name='4068'>
            outbuf( i, j, k )  = inbuf ( icurs )<a name='4069'>
            icurs = icurs + 1<a name='4070'>
          END DO<a name='4071'>
        END DO<a name='4072'>
      END DO<a name='4073'>
    RETURN<a name='4074'>
  END SUBROUTINE all_sub_d<a name='4075'>
<a name='4076'>
<A NAME='ALL_SUB_L'><A href='../../html_code/frame/module_dm.F.html#ALL_SUB_L' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4077'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>all_sub_l</font> ( inbuf , outbuf,              &amp; <A href='../../call_to/ALL_SUB_L.html' TARGET='index'>1</A><a name='4078'>
                               PS1,PE1,PS2,PE2,PS3,PE3,  &amp;<a name='4079'>
                               MS1,ME1,MS2,ME2,MS3,ME3   )<a name='4080'>
    IMPLICIT NONE<a name='4081'>
    LOGICAL    , DIMENSION(*) , INTENT(IN) :: inbuf<a name='4082'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='4083'>
    INTEGER   PS1,PE1,PS2,PE2,PS3,PE3<a name='4084'>
    LOGICAL    , DIMENSION( MS1:ME1,MS2:ME2,MS3:ME3 ) , INTENT(OUT) :: outbuf<a name='4085'>
<font color=#447700>! Local<a name='4086'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='4087'>
    icurs = 1<a name='4088'>
      DO k = PS3, PE3<a name='4089'>
        DO j = PS2, PE2<a name='4090'>
          DO i = PS1, PE1<a name='4091'>
            outbuf( i, j, k )  = inbuf ( icurs )<a name='4092'>
            icurs = icurs + 1<a name='4093'>
          END DO<a name='4094'>
        END DO<a name='4095'>
      END DO<a name='4096'>
    RETURN<a name='4097'>
  END SUBROUTINE all_sub_l<a name='4098'>
<a name='4099'>
<A NAME='OUTBUF_2_PATCH_R'><A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_R' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4100'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>outbuf_2_patch_r</font>( inbuf, outbuf,         &amp; <A href='../../call_to/OUTBUF_2_PATCH_R.html' TARGET='index'>1</A>,<A href='../../call_from/OUTBUF_2_PATCH_R.html' TARGET='index'>1</A><a name='4101'>
                               DS1,DE1,DS2,DE2,DS3,DE3, &amp;<a name='4102'>
                               MS1, ME1, MS2, ME2, MS3, ME3 , &amp;<a name='4103'>
                               GPATCH )<a name='4104'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_R' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_95">, ONLY : ntasks<a name='4105'>
    IMPLICIT NONE<a name='4106'>
    REAL    , DIMENSION(*) , INTENT(OUT) :: outbuf<a name='4107'>
    INTEGER   DS1,DE1,DS2,DE2,DS3,DE3,GPATCH(3,2,ntasks)<a name='4108'>
    INTEGER   MS1,ME1,MS2,ME2,MS3,ME3<a name='4109'>
    REAL    , DIMENSION( DS1:DE1,DS2:DE2,DS3:DE3 ) , INTENT(IN) :: inbuf<a name='4110'>
<font color=#447700>! Local<a name='4111'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='4112'>
<a name='4113'>
    icurs = 1<a name='4114'>
    DO n = 1, ntasks<a name='4115'>
      DO k = GPATCH( 3,1,n ), GPATCH( 3,2,n )<a name='4116'>
        DO j = GPATCH( 2,1,n ), GPATCH( 2,2,n )<a name='4117'>
          DO i = GPATCH( 1,1,n ), GPATCH( 1,2,n )<a name='4118'>
            outbuf( icurs ) = inbuf( i,j,k )<a name='4119'>
            icurs = icurs + 1<a name='4120'>
          END DO<a name='4121'>
        END DO<a name='4122'>
      END DO<a name='4123'>
    END DO<a name='4124'>
    RETURN<a name='4125'>
  END SUBROUTINE outbuf_2_patch_r<a name='4126'>
<a name='4127'>
<A NAME='OUTBUF_2_PATCH_I'><A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_I' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4128'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>outbuf_2_patch_i</font>( inbuf, outbuf,         &amp; <A href='../../call_to/OUTBUF_2_PATCH_I.html' TARGET='index'>1</A>,<A href='../../call_from/OUTBUF_2_PATCH_I.html' TARGET='index'>1</A><a name='4129'>
                               DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='4130'>
                               GPATCH )<a name='4131'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_I' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_96">, ONLY : ntasks<a name='4132'>
    IMPLICIT NONE<a name='4133'>
    INTEGER    , DIMENSION(*) , INTENT(OUT) :: outbuf<a name='4134'>
    INTEGER   DS1,DE1,DS2,DE2,DS3,DE3,GPATCH(3,2,ntasks)<a name='4135'>
    INTEGER    , DIMENSION( DS1:DE1,DS2:DE2,DS3:DE3 ) , INTENT(IN) :: inbuf<a name='4136'>
<font color=#447700>! Local<a name='4137'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='4138'>
    icurs = 1<a name='4139'>
    DO n = 1, ntasks<a name='4140'>
      DO k = GPATCH( 3,1,n ), GPATCH( 3,2,n )<a name='4141'>
        DO j = GPATCH( 2,1,n ), GPATCH( 2,2,n )<a name='4142'>
          DO i = GPATCH( 1,1,n ), GPATCH( 1,2,n )<a name='4143'>
            outbuf( icurs ) = inbuf( i,j,k )<a name='4144'>
            icurs = icurs + 1<a name='4145'>
          END DO<a name='4146'>
        END DO<a name='4147'>
      END DO<a name='4148'>
    END DO<a name='4149'>
    RETURN<a name='4150'>
  END SUBROUTINE outbuf_2_patch_i<a name='4151'>
<a name='4152'>
<A NAME='OUTBUF_2_PATCH_D'><A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4153'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>outbuf_2_patch_d</font>( inbuf, outbuf,         &amp; <A href='../../call_to/OUTBUF_2_PATCH_D.html' TARGET='index'>1</A>,<A href='../../call_from/OUTBUF_2_PATCH_D.html' TARGET='index'>1</A><a name='4154'>
                               DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='4155'>
                               GPATCH )<a name='4156'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_97">, ONLY : ntasks<a name='4157'>
    IMPLICIT NONE<a name='4158'>
    DOUBLE PRECISION    , DIMENSION(*) , INTENT(OUT) :: outbuf<a name='4159'>
    INTEGER   DS1,DE1,DS2,DE2,DS3,DE3,GPATCH(3,2,ntasks)<a name='4160'>
    DOUBLE PRECISION    , DIMENSION( DS1:DE1,DS2:DE2,DS3:DE3 ) , INTENT(IN) :: inbuf<a name='4161'>
<font color=#447700>! Local<a name='4162'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='4163'>
    icurs = 1<a name='4164'>
    DO n = 1, ntasks<a name='4165'>
      DO k = GPATCH( 3,1,n ), GPATCH( 3,2,n )<a name='4166'>
        DO j = GPATCH( 2,1,n ), GPATCH( 2,2,n )<a name='4167'>
          DO i = GPATCH( 1,1,n ), GPATCH( 1,2,n )<a name='4168'>
            outbuf( icurs ) = inbuf( i,j,k )<a name='4169'>
            icurs = icurs + 1<a name='4170'>
          END DO<a name='4171'>
        END DO<a name='4172'>
      END DO<a name='4173'>
    END DO<a name='4174'>
    RETURN<a name='4175'>
  END SUBROUTINE outbuf_2_patch_d<a name='4176'>
<a name='4177'>
<A NAME='OUTBUF_2_PATCH_L'><A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_L' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4178'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>outbuf_2_patch_l</font>( inbuf, outbuf,         &amp; <A href='../../call_to/OUTBUF_2_PATCH_L.html' TARGET='index'>1</A>,<A href='../../call_from/OUTBUF_2_PATCH_L.html' TARGET='index'>1</A><a name='4179'>
                               DS1,DE1,DS2,DE2,DS3,DE3,&amp;<a name='4180'>
                               GPATCH )<a name='4181'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#OUTBUF_2_PATCH_L' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_98">, ONLY : ntasks<a name='4182'>
    IMPLICIT NONE<a name='4183'>
    LOGICAL    , DIMENSION(*) , INTENT(OUT) :: outbuf<a name='4184'>
    INTEGER   DS1,DE1,DS2,DE2,DS3,DE3,GPATCH(3,2,ntasks)<a name='4185'>
    LOGICAL    , DIMENSION( DS1:DE1,DS2:DE2,DS3:DE3 ) , INTENT(IN) :: inbuf<a name='4186'>
<font color=#447700>! Local<a name='4187'></font>
    INTEGER               :: i,j,k,n   ,  icurs<a name='4188'>
    icurs = 1<a name='4189'>
    DO n = 1, ntasks<a name='4190'>
      DO k = GPATCH( 3,1,n ), GPATCH( 3,2,n )<a name='4191'>
        DO j = GPATCH( 2,1,n ), GPATCH( 2,2,n )<a name='4192'>
          DO i = GPATCH( 1,1,n ), GPATCH( 1,2,n )<a name='4193'>
            outbuf( icurs ) = inbuf( i,j,k )<a name='4194'>
            icurs = icurs + 1<a name='4195'>
          END DO<a name='4196'>
        END DO<a name='4197'>
      END DO<a name='4198'>
    END DO<a name='4199'>
    RETURN<a name='4200'>
  END SUBROUTINE outbuf_2_patch_l<a name='4201'>
<a name='4202'>
<a name='4203'>
<A NAME='WRF_DM_NESTEXCHANGE_INIT'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_NESTEXCHANGE_INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4204'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_nestexchange_init</font> <A href='../../call_to/WRF_DM_NESTEXCHANGE_INIT.html' TARGET='index'>7</A><a name='4205'>
      CALL rsl_lite_nesting_reset<a name='4206'>
  END SUBROUTINE wrf_dm_nestexchange_init<a name='4207'>
<a name='4208'>
<a name='4209'>
<font color=#447700>!------------------------------------------------------------------<a name='4210'></font>
<a name='4211'>
#if ( EM_CORE == 1 &amp;&amp; DA_CORE <font color=#447700>!= 1 )<a name='4212'></font>
<a name='4213'>
<font color=#447700>!------------------------------------------------------------------<a name='4214'></font>
<a name='4215'>
<A NAME='FORCE_DOMAIN_EM_PART2'><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4216'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>force_domain_em_part2</font> ( grid, ngrid, pgrid, config_flags    &amp; <A href='../../call_to/FORCE_DOMAIN_EM_PART2.html' TARGET='index'>1</A>,<A href='../../call_from/FORCE_DOMAIN_EM_PART2.html' TARGET='index'>12</A><a name='4217'>
<font color=#447700>!<a name='4218'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_5"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4219'>
<font color=#447700>!<a name='4220'></font>
                 )<a name='4221'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_44"><a name='4222'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_109">, ONLY : domain, get_ijk_from_grid<a name='4223'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_66">, ONLY : grid_config_rec_type<a name='4224'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_99">, ONLY : ntasks, ntasks_x, ntasks_y, local_communicator, mytask, &amp;<a name='4225'>
                            nest_pes_x, nest_pes_y <font color=#447700>! ,                                 &amp;<a name='4226'></font>
                            <font color=#447700>!push_communicators_for_domain,pop_communicators_for_domain<a name='4227'></font>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_1">, ONLY : halo_force_down_sub<a name='4228'>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_37"><a name='4229'>
      IMPLICIT NONE<a name='4230'>
<font color=#447700>!<a name='4231'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='4232'></font>
      TYPE(domain), POINTER :: ngrid<a name='4233'>
      TYPE(domain), POINTER :: pgrid         <font color=#447700>!KAL added for vertical nesting<a name='4234'></font>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_6"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4235'>
      INTEGER nlev, msize<a name='4236'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k,kk<a name='4237'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='4238'>
      REAL xv(2000)<a name='4239'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4240'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4241'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='4242'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='4243'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='4244'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='4245'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='4246'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='4247'>
                                ips, ipe, jps, jpe, kps, kpe<a name='4248'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7,itrace<a name='4249'>
      REAL  dummy_xs, dummy_xe, dummy_ys, dummy_ye<a name='4250'>
<a name='4251'>
      <font color=#447700>!KAL variables for vertical nesting<a name='4252'></font>
      REAL :: p_top_m  , p_surf_m , mu_m , hsca_m , pre_c ,pre_n<a name='4253'>
      REAL, DIMENSION(pgrid%s_vert:pgrid%e_vert) :: alt_w_c<a name='4254'>
      REAL, DIMENSION(pgrid%s_vert:pgrid%e_vert+1) :: alt_u_c<a name='4255'>
      REAL, DIMENSION(ngrid%s_vert:ngrid%e_vert) :: alt_w_n<a name='4256'>
      REAL, DIMENSION(ngrid%s_vert:ngrid%e_vert+1) :: alt_u_n      <a name='4257'>
      <a name='4258'>
      REAL, DIMENSION(:,:,:), ALLOCATABLE :: p, al<a name='4259'>
      REAL :: pfu, pfd, phm, temp, qvf, qvf1, qvf2    <a name='4260'>
<a name='4261'>
      <font color=#447700>!KAL change this for vertical nesting<a name='4262'></font>
      <font color=#447700>! force_domain_em_part1 packs up the interpolation onto the coarse (vertical) grid<a name='4263'></font>
      <font color=#447700>! therefore the message size is based on the coarse grid number of levels<a name='4264'></font>
      <font color=#447700>! here it is unpacked onto the intermediate grid<a name='4265'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_34"> (  pgrid ,                   &amp;<a name='4266'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4267'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4268'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='4269'>
                                <a name='4270'>
      <font color=#447700>!KAL this is the original WRF code                                <a name='4271'></font>
      <font color=#447700>!CALL get_ijk_from_grid (  grid ,                   &amp;<a name='4272'></font>
      <font color=#447700>!                          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4273'></font>
      <font color=#447700>!                          cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4274'></font>
      <font color=#447700>!                          cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='4275'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_35"> (  ngrid ,              &amp;<a name='4276'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='4277'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='4278'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='4279'>
<a name='4280'>
      nlev  = ckde - ckds + 1<a name='4281'>
<a name='4282'>
#include "<A href='../../html_code/include/nest_interpdown_unpack.inc.html'>nest_interpdown_unpack.inc</A>"<A NAME="nest_interpdown_unpack.inc_7"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4283'>
<a name='4284'>
if (ngrid%vert_refine_method .NE. 0) then<a name='4285'>
<a name='4286'>
      <font color=#447700>!KAL calculating the vertical coordinate for parent and nest grid (code from ndown)<a name='4287'></font>
      <font color=#447700>! assume that the parent and nest have the same p_top value (as in ndown) <a name='4288'></font>
      <a name='4289'>
<font color=#447700>!KAL ckde is equal to e_vert of the coarse grid. There are e_vert-1 u points.  The coarse 1D grid here is e_vert+1,<a name='4290'></font>
<font color=#447700>!    so it is the e_vert-1 points from the coarse grid, plus a surface point plus a top point.  Extrapolation coefficients<a name='4291'></font>
<font color=#447700>!    are used to get the surface and top points to fill out the pro_u_c 1D array of u values from the coarse grid.     <a name='4292'></font>
                <a name='4293'>
      hsca_m = 6.7 <font color=#447700>!KAL scale height of the atmosphere<a name='4294'></font>
      p_top_m = ngrid%p_top<a name='4295'>
      p_surf_m = 1.e5<a name='4296'>
      mu_m = p_surf_m - p_top_m<a name='4297'>
<font color=#447700>!    parent<a name='4298'></font>
      do  k = 1,ckde<a name='4299'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4300'></font>
      pre_c = mu_m * pgrid%znw(k) + p_top_m<a name='4301'>
#elif ( HYBRID_COORD==1 )<a name='4302'>
      pre_c = mu_m * pgrid%c3f(k) + p_top_m + pgrid%c4f(k)<a name='4303'>
#endif<a name='4304'>
      alt_w_c(k) =  -hsca_m * alog(pre_c/p_surf_m)<a name='4305'>
      enddo   <a name='4306'>
      do  k = 1,ckde-1<a name='4307'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4308'></font>
      pre_c = mu_m * pgrid%znu(k) + p_top_m<a name='4309'>
#elif ( HYBRID_COORD==1 )<a name='4310'>
      pre_c = mu_m * pgrid%c3h(k) + p_top_m + pgrid%c4h(k)<a name='4311'>
#endif<a name='4312'>
      alt_u_c(k+1) =  -hsca_m * alog(pre_c/p_surf_m)<a name='4313'>
      enddo<a name='4314'>
      alt_u_c(1) =  alt_w_c(1) <a name='4315'>
      alt_u_c(ckde+1) =  alt_w_c(ckde)       <a name='4316'>
<font color=#447700>!    nest<a name='4317'></font>
      do  k = 1,nkde<a name='4318'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4319'></font>
      pre_n = mu_m * ngrid%znw(k) + p_top_m<a name='4320'>
#elif ( HYBRID_COORD==1 )<a name='4321'>
      pre_n = mu_m * ngrid%c3f(k) + p_top_m + ngrid%c4f(k)<a name='4322'>
#endif<a name='4323'>
      alt_w_n(k) =  -hsca_m * alog(pre_n/p_surf_m)<a name='4324'>
      enddo<a name='4325'>
      do  k = 1,nkde-1<a name='4326'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4327'></font>
      pre_n = mu_m * ngrid%znu(k) + p_top_m<a name='4328'>
#elif ( HYBRID_COORD==1 )<a name='4329'>
      pre_n = mu_m * ngrid%c3h(k) + p_top_m + ngrid%c4h(k)<a name='4330'>
#endif<a name='4331'>
      alt_u_n(k+1) =  -hsca_m * alog(pre_n/p_surf_m)<a name='4332'>
      enddo<a name='4333'>
      alt_u_n(1) =  alt_w_n(1)<a name='4334'>
      alt_u_n(nkde+1) =  alt_w_n(nkde)<a name='4335'>
        <a name='4336'>
endif   <a name='4337'>
<a name='4338'>
      <font color=#447700>!KAL added this call for vertical nesting (return coarse grid dimensions to intended values)<a name='4339'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_36"> (  grid ,                   &amp;<a name='4340'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4341'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4342'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='4343'>
                                                      <a name='4344'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_37"> (  grid ,              &amp;<a name='4345'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='4346'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='4347'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='4348'>
<a name='4349'>
      <font color=#447700>!  Vertical refinement is turned on.<a name='4350'></font>
<a name='4351'>
      IF (ngrid%vert_refine_method .NE. 0) THEN<a name='4352'>
      <a name='4353'>
#include "<A href='../../html_code/include/nest_forcedown_interp_vert.inc.html'>nest_forcedown_interp_vert.inc</A>"<A NAME="nest_forcedown_interp_vert.inc_8"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4354'>
<a name='4355'>
         IF ( ngrid%this_is_an_ideal_run ) THEN <a name='4356'>
            IF ( SIZE( grid%t_init, 1 ) * SIZE( grid%t_init, 3 ) .GT. 1 ) THEN <a name='4357'>
               CALL <A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING'>vert_interp_vert_nesting</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INTERP_VERT_NESTING_1">( grid%t_init, &amp; <font color=#447700>!CD field<a name='4358'></font>
                                              ids, ide, kds, kde, jds, jde, &amp; <font color=#447700>!CD dims<a name='4359'></font>
                                              ims, ime, kms, kme, jms, jme, &amp; <font color=#447700>!CD dims<a name='4360'></font>
                                              ips, ipe, kps, MIN( (kde-1), kpe ), jps, jpe, &amp; <font color=#447700>!CD dims<a name='4361'></font>
                                              pgrid%s_vert, pgrid%e_vert, &amp; <font color=#447700>!vertical dimension of the parent grid<a name='4362'></font>
                                              pgrid%cf1, pgrid%cf2, pgrid%cf3, pgrid%cfn, pgrid%cfn1, &amp; <font color=#447700>!coarse grid extrapolation constants<a name='4363'></font>
                                              alt_u_c, alt_u_n ) <font color=#447700>!coordinates for parent and nest<a name='4364'></font>
            END IF  <font color=#447700>! Check t_init is a fully allocated 3d array.<a name='4365'></font>
         END IF <font color=#447700>! only for ideal runs<a name='4366'></font>
<a name='4367'>
<a name='4368'>
         <font color=#447700>!  Rebalance the grid on the intermediate grid.  The intermediate grid has the horizontal <a name='4369'></font>
         <font color=#447700>!  resolution of the parent grid, but at this point has been interpolated in the vertical <a name='4370'></font>
         <font color=#447700>!  to the resolution of the nest.  The base state (phb, pb, etc) from the parent grid is <a name='4371'></font>
         <font color=#447700>!  unpacked onto the intermediate grid every time this subroutine is called.  We need the <a name='4372'></font>
         <font color=#447700>!  base state of the nest, so it is recalculated here.  <a name='4373'></font>
<a name='4374'>
         <font color=#447700>!  Additionally, we do not need to vertically interpolate the entire intermediate grid <a name='4375'></font>
         <font color=#447700>!  above, just the points that contribute to the boundary forcing.<a name='4376'></font>
<a name='4377'>
         <font color=#447700>!  Base state potential temperature and inverse density (alpha = 1/rho) from<a name='4378'></font>
         <font color=#447700>!  the half eta levels and the base-profile surface pressure.  Compute 1/rho<a name='4379'></font>
         <font color=#447700>!  from equation of state.  The potential temperature is a perturbation from t0.<a name='4380'></font>
      <a name='4381'>
         <font color=#447700>!  Uncouple the variables moist and t_2 that are used to calculate ph_2<a name='4382'></font>
<a name='4383'>
         DO j = MAX(jds,jps),MIN(jde-1,jpe)<a name='4384'>
            DO i = MAX(ids,ips),MIN(ide-1,ipe)<a name='4385'>
               DO k=kds,kde-1<a name='4386'>
                  grid%t_2(i,k,j) = grid%t_2(i,k,j)/(grid%mub(i,j) + grid%mu_2(i,j))<a name='4387'>
                  moist(i,k,j,P_QV) = moist(i,k,j,P_QV)/(grid%mub(i,j) + grid%mu_2(i,j))<a name='4388'>
               END DO<a name='4389'>
            END DO<a name='4390'>
         END DO<a name='4391'>
    <a name='4392'>
         DO j = MAX(jds,jps),MIN(jde-1,jpe)<a name='4393'>
            DO i = MAX(ids,ips),MIN(ide-1,ipe)<a name='4394'>
<a name='4395'>
               DO k = 1, kpe-1<a name='4396'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4397'></font>
                  grid%pb(i,k,j) = ngrid%znu(k)*grid%mub(i,j)+ngrid%p_top<a name='4398'>
#elif ( HYBRID_COORD==1 )<a name='4399'>
                  grid%pb(i,k,j) = ngrid%c3h(k)*grid%mub(i,j) + ngrid%c4h(k) + ngrid%p_top<a name='4400'>
#endif<a name='4401'>
             <a name='4402'>
                  <font color=#447700>!  If this is a real run, recalc t_init.<a name='4403'></font>
   <a name='4404'>
                  IF ( .NOT. ngrid%this_is_an_ideal_run ) THEN<a name='4405'>
                     temp = MAX ( ngrid%tiso, ngrid%t00 + ngrid%tlp*LOG(grid%pb(i,k,j)/ngrid%p00) )<a name='4406'>
                     IF ( grid%pb(i,k,j) .LT. ngrid%p_strat ) THEN<a name='4407'>
                        temp = ngrid%tiso + ngrid%tlp_strat * LOG ( grid%pb(i,k,j)/ngrid%p_strat )<a name='4408'>
                     END IF<a name='4409'>
                     grid%t_init(i,k,j) = temp*(ngrid%p00/grid%pb(i,k,j))**(r_d/cp) - t0<a name='4410'>
                  END IF<a name='4411'>
                  grid%alb(i,k,j) = (r_d/p1000mb)*(grid%t_init(i,k,j)+t0)*(grid%pb(i,k,j)/p1000mb)**cvpm<a name='4412'>
               END DO<a name='4413'>
   <a name='4414'>
               <font color=#447700>!  Integrate base geopotential, starting at terrain elevation.  This assures that<a name='4415'></font>
               <font color=#447700>!  the base state is in exact hydrostatic balance with respect to the model equations.<a name='4416'></font>
               <font color=#447700>!  This field is on full levels.<a name='4417'></font>
   <a name='4418'>
               grid%phb(i,1,j) = grid%ht(i,j) * g<a name='4419'>
               IF (grid%hypsometric_opt == 1) THEN<a name='4420'>
                  DO kk = 2,kpe<a name='4421'>
                     k = kk - 1<a name='4422'>
                     grid%phb(i,kk,j) = grid%phb(i,k,j) - ngrid%dnw(k)*grid%mub(i,j)*grid%alb(i,k,j)<a name='4423'>
                  END DO<a name='4424'>
               ELSE IF (grid%hypsometric_opt == 2) THEN<a name='4425'>
                  DO k = 2,kpe<a name='4426'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4427'></font>
                     pfu = grid%mub(i,j)*ngrid%znw(k)   + ngrid%p_top<a name='4428'>
                     pfd = grid%mub(i,j)*ngrid%znw(k-1) + ngrid%p_top<a name='4429'>
                     phm = grid%mub(i,j)*ngrid%znu(k-1) + ngrid%p_top<a name='4430'>
#elif ( HYBRID_COORD==1 )<a name='4431'>
                     pfu = ngrid%c3f(k  )*grid%MUB(i,j) + ngrid%c4f(k  ) + ngrid%p_top<a name='4432'>
                     pfd = ngrid%c3f(k-1)*grid%MUB(i,j) + ngrid%c4f(k-1) + ngrid%p_top<a name='4433'>
                     phm = ngrid%c3h(k-1)*grid%MUB(i,j) + ngrid%c4h(k-1) + ngrid%p_top<a name='4434'>
#endif<a name='4435'>
                     grid%phb(i,k,j) = grid%phb(i,k-1,j) + grid%alb(i,k-1,j)*phm*LOG(pfd/pfu)<a name='4436'>
                  END DO<a name='4437'>
               ELSE<a name='4438'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_215">( 'module_dm: hypsometric_opt should be 1 or 2' )<a name='4439'>
               END IF  <font color=#447700>! which hypsometric option<a name='4440'></font>
            END DO  <font color=#447700>! i loop<a name='4441'></font>
         END DO  <font color=#447700>! j loop<a name='4442'></font>
<a name='4443'>
         <font color=#447700>!  Perturbation fields<a name='4444'></font>
<a name='4445'>
         ALLOCATE( p (ips:ipe, kps:kpe, jps:jpe) )<a name='4446'>
         ALLOCATE( al(ips:ipe, kps:kpe, jps:jpe) )<a name='4447'>
<a name='4448'>
         DO j = MAX(jds,jps),MIN(jde-1,jpe)<a name='4449'>
            DO i = MAX(ids,ips),MIN(ide-1,ipe)<a name='4450'>
<a name='4451'>
               <font color=#447700>!  Integrate the hydrostatic equation (from the RHS of the bigstep vertical momentum<a name='4452'></font>
               <font color=#447700>!  equation) down from the top to get the pressure perturbation.  First get the pressure<a name='4453'></font>
               <font color=#447700>!  perturbation, moisture, and inverse density (total and perturbation) at the top-most level.<a name='4454'></font>
      <a name='4455'>
               kk = kpe-1<a name='4456'>
               k = kk+1<a name='4457'>
      <a name='4458'>
               qvf1 = 0.5*(moist(i,kk,j,P_QV)+moist(i,kk,j,P_QV))<a name='4459'>
               qvf2 = 1./(1.+qvf1)<a name='4460'>
               qvf1 = qvf1*qvf2<a name='4461'>
      <a name='4462'>
               p(i,kk,j) = - 0.5*(grid%Mu_2(i,j)+qvf1*grid%Mub(i,j))/ngrid%rdnw(kk)/qvf2<a name='4463'>
               qvf = 1. + rvovrd*moist(i,kk,j,P_QV)<a name='4464'>
               al(i,kk,j) = (r_d/p1000mb)*(grid%t_2(i,kk,j)+t0)*qvf* &amp;<a name='4465'>
                           (((p(i,kk,j)+grid%pb(i,kk,j))/p1000mb)**cvpm) - grid%alb(i,kk,j)<a name='4466'>
      <a name='4467'>
               <font color=#447700>!  Now, integrate down the column to compute the pressure perturbation, and diagnose the two<a name='4468'></font>
               <font color=#447700>!  inverse density fields (total and perturbation).<a name='4469'></font>
      <a name='4470'>
               DO kk=kpe-2,1,-1<a name='4471'>
                  k = kk + 1<a name='4472'>
                  qvf1 = 0.5*(moist(i,kk,j,P_QV)+moist(i,kk+1,j,P_QV))<a name='4473'>
                  qvf2 = 1./(1.+qvf1)<a name='4474'>
                  qvf1 = qvf1*qvf2<a name='4475'>
                  p(i,kk,j) = p(i,kk+1,j) - (grid%Mu_2(i,j) + qvf1*grid%Mub(i,j))/qvf2/ngrid%rdn(kk+1)<a name='4476'>
                  qvf = 1. + rvovrd*moist(i,kk,j,P_QV)<a name='4477'>
                  al(i,kk,j) = (r_d/p1000mb)*(grid%t_2(i,kk,j)+t0)*qvf* &amp;<a name='4478'>
                              (((p(i,kk,j)+grid%pb(i,kk,j))/p1000mb)**cvpm) - grid%alb(i,kk,j)<a name='4479'>
               END DO<a name='4480'>
      <a name='4481'>
               <font color=#447700>!  This is the hydrostatic equation used in the model after the small timesteps.  In<a name='4482'></font>
               <font color=#447700>!  the model, grid%al (inverse density) is computed from the geopotential.<a name='4483'></font>
      <a name='4484'>
               IF (grid%hypsometric_opt == 1) THEN<a name='4485'>
                  DO kk = 2,kpe<a name='4486'>
                     k = kk - 1<a name='4487'>
                     grid%ph_2(i,kk,j) = grid%ph_2(i,kk-1,j) - &amp;<a name='4488'>
                                        ngrid%dnw(kk-1) * ( (grid%mub(i,j)+grid%mu_2(i,j))*al(i,kk-1,j) &amp;<a name='4489'>
                                        + grid%mu_2(i,j)*grid%alb(i,kk-1,j) )<a name='4490'>
                  END DO<a name='4491'>
      <a name='4492'>
               <font color=#447700>! Alternative hydrostatic eq.: dZ = -al*p*dLOG(p), where p is dry pressure.<a name='4493'></font>
               <font color=#447700>! Note that al*p approximates Rd*T and dLOG(p) does z.<a name='4494'></font>
               <font color=#447700>! Here T varies mostly linear with z, the first-order integration produces better result.<a name='4495'></font>
      <a name='4496'>
               ELSE IF (grid%hypsometric_opt == 2) THEN<a name='4497'>
      <a name='4498'>
                  grid%ph_2(i,1,j) = grid%phb(i,1,j)<a name='4499'>
                  DO k = 2,kpe<a name='4500'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4501'></font>
                     pfu = ( grid%mub(i,j)+grid%mu_2(i,j))*ngrid%znw(k)   + ngrid%p_top<a name='4502'>
                     pfd = ( grid%mub(i,j)+grid%mu_2(i,j))*ngrid%znw(k-1) + ngrid%p_top<a name='4503'>
                     phm = ( grid%mub(i,j)+grid%mu_2(i,j))*ngrid%znu(k-1) + ngrid%p_top<a name='4504'>
#elif ( HYBRID_COORD==1 )<a name='4505'>
                     pfu = ngrid%c3f(k  )*( grid%MUB(i,j)+grid%MU_2(i,j) ) + ngrid%c4f(k  ) + ngrid%p_top<a name='4506'>
                     pfd = ngrid%c3f(k-1)*( grid%MUB(i,j)+grid%MU_2(i,j) ) + ngrid%c4f(k-1) + ngrid%p_top<a name='4507'>
                     phm = ngrid%c3h(k-1)*( grid%MUB(i,j)+grid%MU_2(i,j) ) + ngrid%c4h(k-1) + ngrid%p_top<a name='4508'>
#endif<a name='4509'>
                     grid%ph_2(i,k,j) = grid%ph_2(i,k-1,j) + (grid%alb(i,k-1,j)+al(i,k-1,j))*phm*LOG(pfd/pfu)<a name='4510'>
                  END DO<a name='4511'>
      <a name='4512'>
                  DO k = 1,kpe<a name='4513'>
                     grid%ph_2(i,k,j) = grid%ph_2(i,k,j) - grid%phb(i,k,j)<a name='4514'>
                  END DO<a name='4515'>
      <a name='4516'>
               END IF<a name='4517'>
<a name='4518'>
            END DO <font color=#447700>! i loop<a name='4519'></font>
         END DO <font color=#447700>! j loop<a name='4520'></font>
<a name='4521'>
         DEALLOCATE(p)<a name='4522'>
         DEALLOCATE(al)<a name='4523'>
      <a name='4524'>
         <font color=#447700>! Couple the variables moist and t_2, and the newly calculated ph_2<a name='4525'></font>
         DO j = MAX(jds,jps),MIN(jde-1,jpe)<a name='4526'>
            DO i = MAX(ids,ips),MIN(ide-1,ipe)<a name='4527'>
               DO k=kps,kpe<a name='4528'>
               grid%ph_2(i,k,j) = grid%ph_2(i,k,j)*(grid%Mub(i,j) + grid%Mu_2(i,j))<a name='4529'>
               END DO<a name='4530'>
            END DO<a name='4531'>
         END DO<a name='4532'>
         DO j = MAX(jds,jps),MIN(jde-1,jpe)<a name='4533'>
            DO i = MAX(ids,ips),MIN(ide-1,ipe)<a name='4534'>
               DO k=kps,kpe-1<a name='4535'>
               grid%t_2(i,k,j) = grid%t_2(i,k,j)*(grid%mub(i,j) + grid%mu_2(i,j))<a name='4536'>
               moist(i,k,j,P_QV) = moist(i,k,j,P_QV)*(grid%mub(i,j) + grid%mu_2(i,j))<a name='4537'>
               END DO<a name='4538'>
            END DO<a name='4539'>
         END DO<a name='4540'>
<a name='4541'>
<a name='4542'>
      END IF<a name='4543'>
                               <a name='4544'>
<a name='4545'>
#include "<A href='../../html_code/include/HALO_FORCE_DOWN.inc.html'>HALO_FORCE_DOWN.inc</A>"<A NAME="HALO_FORCE_DOWN.inc_9"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4546'>
<a name='4547'>
      <font color=#447700>! code here to interpolate the data into the nested domain<a name='4548'></font>
#  include "<A href='../../html_code/include/nest_forcedown_interp.inc.html'>nest_forcedown_interp.inc</A>"<A NAME="nest_forcedown_interp.inc_10"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4549'>
<a name='4550'>
      RETURN<a name='4551'>
   END SUBROUTINE force_domain_em_part2<a name='4552'>
<a name='4553'>
<font color=#447700>!------------------------------------------------------------------<a name='4554'></font>
<a name='4555'>
<A NAME='INTERP_DOMAIN_EM_PART1'><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4556'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_domain_em_part1</font> ( grid, intermediate_grid, ngrid, config_flags    &amp; <A href='../../call_to/INTERP_DOMAIN_EM_PART1.html' TARGET='index'>2</A>,<A href='../../call_from/INTERP_DOMAIN_EM_PART1.html' TARGET='index'>17</A><a name='4557'>
<font color=#447700>!<a name='4558'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_11"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4559'>
<font color=#447700>!<a name='4560'></font>
                 )<a name='4561'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_45"><a name='4562'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_110">, ONLY : domain, get_ijk_from_grid<a name='4563'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_67">, ONLY : grid_config_rec_type<a name='4564'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_100">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, &amp;<a name='4565'>
                            nest_task_offsets, nest_pes_x, nest_pes_y, which_kid,   &amp;<a name='4566'>
                            intercomm_active, mpi_comm_to_kid, mpi_comm_to_mom,     &amp;<a name='4567'>
                            mytask, get_dm_max_halo_width<a name='4568'>
      USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_20"><a name='4569'>
      IMPLICIT NONE<a name='4570'>
<font color=#447700>!<a name='4571'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='4572'></font>
      TYPE(domain), POINTER :: intermediate_grid<a name='4573'>
      TYPE(domain), POINTER :: ngrid<a name='4574'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_12"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4575'>
      INTEGER nlev, msize<a name='4576'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='4577'>
      INTEGER iparstrt,jparstrt,sw<a name='4578'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='4579'>
      REAL xv(2000)<a name='4580'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4581'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4582'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='4583'>
      INTEGER       ::          iids, iide, ijds, ijde, ikds, ikde,    &amp;<a name='4584'>
                                iims, iime, ijms, ijme, ikms, ikme,    &amp;<a name='4585'>
                                iips, iipe, ijps, ijpe, ikps, ikpe<a name='4586'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='4587'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='4588'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='4589'>
<a name='4590'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='4591'>
<a name='4592'>
      INTEGER icoord, jcoord, idim_cd, jdim_cd, pgr <a name='4593'>
      INTEGER thisdomain_max_halo_width<a name='4594'>
      INTEGER local_comm, myproc, nproc<a name='4595'>
      INTEGER ioffset, ierr<a name='4596'>
<a name='4597'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_37"> ( local_comm )<a name='4598'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_11">( myproc )<a name='4599'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_4">( nproc )<a name='4600'>
<a name='4601'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_38"> (  grid ,                   &amp;<a name='4602'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4603'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4604'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='4605'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_39"> (  intermediate_grid ,              &amp;<a name='4606'>
                                iids, iide, ijds, ijde, ikds, ikde,    &amp;<a name='4607'>
                                iims, iime, ijms, ijme, ikms, ikme,    &amp;<a name='4608'>
                                iips, iipe, ijps, ijpe, ikps, ikpe    )<a name='4609'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_40"> (  ngrid ,              &amp;<a name='4610'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='4611'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='4612'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='4613'>
<a name='4614'>
      CALL nl_get_parent_grid_ratio ( ngrid%id, pgr )<a name='4615'>
      CALL nl_get_i_parent_start ( intermediate_grid%id, iparstrt )<a name='4616'>
      CALL nl_get_j_parent_start ( intermediate_grid%id, jparstrt )<a name='4617'>
      CALL nl_get_shw            ( intermediate_grid%id, sw )<a name='4618'>
      icoord =    iparstrt - sw<a name='4619'>
      jcoord =    jparstrt - sw<a name='4620'>
      idim_cd = iide - iids + 1<a name='4621'>
      jdim_cd = ijde - ijds + 1<a name='4622'>
<a name='4623'>
      nlev  = ckde - ckds + 1<a name='4624'>
<a name='4625'>
      <font color=#447700>! get max_halo_width for parent. It may be smaller if it is moad<a name='4626'></font>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_3"> ( grid%id , thisdomain_max_halo_width )<a name='4627'>
<a name='4628'>
      IF ( grid%active_this_task ) THEN<a name='4629'>
#include "<A href='../../html_code/include/nest_interpdown_pack.inc.html'>nest_interpdown_pack.inc</A>"<A NAME="nest_interpdown_pack.inc_13"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4630'>
      END IF <a name='4631'>
<a name='4632'>
      <font color=#447700>! determine which communicator and offset to use <a name='4633'></font>
      IF ( intercomm_active( grid%id ) ) THEN        <font color=#447700>! I am parent<a name='4634'></font>
        local_comm = mpi_comm_to_kid( which_kid(ngrid%id), grid%id ) <a name='4635'>
        ioffset = nest_task_offsets(ngrid%id)<a name='4636'>
      ELSE IF ( intercomm_active( ngrid%id ) ) THEN  <font color=#447700>! I am nest <a name='4637'></font>
        local_comm = mpi_comm_to_mom( ngrid%id )<a name='4638'>
        ioffset = nest_task_offsets(ngrid%id)<a name='4639'>
      END IF<a name='4640'>
<a name='4641'>
      IF ( grid%active_this_task .OR. ngrid%active_this_task ) THEN<a name='4642'>
#ifndef STUBMPI<a name='4643'>
        CALL mpi_comm_rank(local_comm,myproc,ierr)<a name='4644'>
        CALL mpi_comm_size(local_comm,nproc,ierr)<a name='4645'>
#endif<a name='4646'>
        CALL rsl_lite_bcast_msgs( myproc, nest_pes_x(grid%id)*nest_pes_y(grid%id),         &amp;<a name='4647'>
                                          nest_pes_x(ngrid%id)*nest_pes_y(ngrid%id),       &amp; <a name='4648'>
                                          ioffset, local_comm )<a name='4649'>
      END IF<a name='4650'>
<a name='4651'>
      RETURN<a name='4652'>
   END SUBROUTINE interp_domain_em_part1<a name='4653'>
<a name='4654'>
<font color=#447700>!------------------------------------------------------------------<a name='4655'></font>
<a name='4656'>
<A NAME='INTERP_DOMAIN_EM_PART2'><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4657'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_domain_em_part2</font> ( grid, ngrid, pgrid, config_flags    &amp; <A href='../../call_to/INTERP_DOMAIN_EM_PART2.html' TARGET='index'>1</A>,<A href='../../call_from/INTERP_DOMAIN_EM_PART2.html' TARGET='index'>17</A><a name='4658'>
<font color=#447700>!<a name='4659'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_14"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4660'>
<font color=#447700>!<a name='4661'></font>
                 )<a name='4662'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_46"><a name='4663'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_111">, ONLY : domain, get_ijk_from_grid<a name='4664'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_68">, ONLY : grid_config_rec_type<a name='4665'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_101">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, &amp;<a name='4666'>
                            mytask, get_dm_max_halo_width, which_kid<a name='4667'>
                            <font color=#447700>! push_communicators_for_domain,pop_communicators_for_domain<a name='4668'></font>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_2">, ONLY : halo_interp_down_sub<a name='4669'>
      IMPLICIT NONE<a name='4670'>
<font color=#447700>!<a name='4671'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='4672'></font>
      TYPE(domain), POINTER :: ngrid<a name='4673'>
      TYPE(domain), POINTER :: pgrid         <font color=#447700>!KAL added for vertical nesting<a name='4674'></font>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_15"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4675'>
      INTEGER nlev, msize<a name='4676'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='4677'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='4678'>
      REAL xv(2000)<a name='4679'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4680'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4681'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='4682'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='4683'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='4684'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='4685'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='4686'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='4687'>
                                ips, ipe, jps, jpe, kps, kpe<a name='4688'>
<a name='4689'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='4690'>
<a name='4691'>
      INTEGER myproc<a name='4692'>
      INTEGER ierr<a name='4693'>
      INTEGER thisdomain_max_halo_width<a name='4694'>
<a name='4695'>
      <font color=#447700>!KAL variables for vertical nesting<a name='4696'></font>
      REAL :: p_top_m  , p_surf_m , mu_m , hsca_m , pre_c ,pre_n<a name='4697'>
      REAL, DIMENSION(pgrid%s_vert:pgrid%e_vert) :: alt_w_c<a name='4698'>
      REAL, DIMENSION(pgrid%s_vert:pgrid%e_vert+1) :: alt_u_c<a name='4699'>
      REAL, DIMENSION(ngrid%s_vert:ngrid%e_vert) :: alt_w_n<a name='4700'>
      REAL, DIMENSION(ngrid%s_vert:ngrid%e_vert+1) :: alt_u_n <a name='4701'>
<a name='4702'>
<a name='4703'>
      <font color=#447700>!KAL change this for vertical nesting<a name='4704'></font>
      <font color=#447700>! interp_domain_em_part1 packs up the interpolation onto the coarse (vertical) grid<a name='4705'></font>
      <font color=#447700>! therefore the message size is based on the coarse grid number of levels<a name='4706'></font>
      <font color=#447700>! here it is unpacked onto the intermediate grid<a name='4707'></font>
       CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_41"> ( pgrid ,                   &amp;<a name='4708'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4709'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4710'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='4711'>
      <font color=#447700>!KAL this is the original WRF code<a name='4712'></font>
      <font color=#447700>!CALL get_ijk_from_grid (  grid ,                   &amp;<a name='4713'></font>
      <font color=#447700>!                          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4714'></font>
      <font color=#447700>!                          cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4715'></font>
      <font color=#447700>!                          cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='4716'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_42"> (  ngrid ,              &amp;<a name='4717'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='4718'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='4719'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='4720'>
<a name='4721'>
      nlev  = ckde - ckds + 1 <a name='4722'>
<a name='4723'>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_4"> ( ngrid%id , thisdomain_max_halo_width )<a name='4724'>
<a name='4725'>
#include "<A href='../../html_code/include/nest_interpdown_unpack.inc.html'>nest_interpdown_unpack.inc</A>"<A NAME="nest_interpdown_unpack.inc_16"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4726'>
<a name='4727'>
<a name='4728'>
if (ngrid%vert_refine_method .NE. 0) then<a name='4729'>
<a name='4730'>
      <font color=#447700>!KAL calculating the vertical coordinate for parent and nest grid (code from ndown)<a name='4731'></font>
      <font color=#447700>! assume that the parent and nest have the same p_top value (as in ndown) <a name='4732'></font>
      <a name='4733'>
<font color=#447700>!KAL ckde is equal to e_vert of the coarse grid. There are e_vert-1 u points.  The coarse 1D grid here is e_vert+1,<a name='4734'></font>
<font color=#447700>!    so it is the e_vert-1 points from the coarse grid, plus a surface point plus a top point.  Extrapolation coefficients<a name='4735'></font>
<font color=#447700>!    are used to get the surface and top points to fill out the pro_u_c 1D array of u values from the coarse grid.     <a name='4736'></font>
                <a name='4737'>
      hsca_m = 6.7 <font color=#447700>!KAL scale height of the atmosphere<a name='4738'></font>
      p_top_m = ngrid%p_top<a name='4739'>
      p_surf_m = 1.e5<a name='4740'>
      mu_m = p_surf_m - p_top_m<a name='4741'>
<font color=#447700>!    parent<a name='4742'></font>
      do  k = 1,ckde<a name='4743'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4744'></font>
      pre_c = mu_m * pgrid%znw(k) + p_top_m<a name='4745'>
#elif ( HYBRID_COORD==1 )<a name='4746'>
      pre_c = mu_m * pgrid%c3f(k) + p_top_m + pgrid%c4f(k)<a name='4747'>
#endif<a name='4748'>
      alt_w_c(k) =  -hsca_m * alog(pre_c/p_surf_m)<a name='4749'>
      enddo   <a name='4750'>
      do  k = 1,ckde-1<a name='4751'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4752'></font>
      pre_c = mu_m * pgrid%znu(k) + p_top_m<a name='4753'>
#elif ( HYBRID_COORD==1 )<a name='4754'>
      pre_c = mu_m * pgrid%c3h(k) + p_top_m + pgrid%c4h(k)<a name='4755'>
#endif<a name='4756'>
      alt_u_c(k+1) =  -hsca_m * alog(pre_c/p_surf_m)<a name='4757'>
      enddo<a name='4758'>
      alt_u_c(1) =  alt_w_c(1) <a name='4759'>
      alt_u_c(ckde+1) =  alt_w_c(ckde)       <a name='4760'>
<font color=#447700>!    nest<a name='4761'></font>
      do  k = 1,nkde<a name='4762'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4763'></font>
      pre_n = mu_m * ngrid%znw(k) + p_top_m<a name='4764'>
#elif ( HYBRID_COORD==1 )<a name='4765'>
      pre_n = mu_m * ngrid%c3f(k) + p_top_m + ngrid%c4f(k)<a name='4766'>
#endif<a name='4767'>
      alt_w_n(k) =  -hsca_m * alog(pre_n/p_surf_m)<a name='4768'>
      enddo<a name='4769'>
      do  k = 1,nkde-1<a name='4770'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='4771'></font>
      pre_n = mu_m * ngrid%znu(k) + p_top_m<a name='4772'>
#elif ( HYBRID_COORD==1 )<a name='4773'>
      pre_n = mu_m * ngrid%c3h(k) + p_top_m + ngrid%c4h(k)<a name='4774'>
#endif<a name='4775'>
      alt_u_n(k+1) =  -hsca_m * alog(pre_n/p_surf_m)<a name='4776'>
      enddo<a name='4777'>
      alt_u_n(1) =  alt_w_n(1)<a name='4778'>
      alt_u_n(nkde+1) =  alt_w_n(nkde)<a name='4779'>
endif   <a name='4780'>
<a name='4781'>
<a name='4782'>
<a name='4783'>
      <font color=#447700>!KAL added this call for vertical nesting (return coarse grid dimensions to intended values)<a name='4784'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_43"> (  grid ,                   &amp;<a name='4785'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4786'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4787'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='4788'>
<a name='4789'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_44"> (  grid ,              &amp;<a name='4790'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='4791'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='4792'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='4793'>
<a name='4794'>
<a name='4795'>
if (ngrid%vert_refine_method .NE. 0) then<a name='4796'>
      <a name='4797'>
<font color=#447700>!KAL added this code (the include file) for the vertical nesting<a name='4798'></font>
#include "<A href='../../html_code/include/nest_interpdown_interp_vert.inc.html'>nest_interpdown_interp_vert.inc</A>"<A NAME="nest_interpdown_interp_vert.inc_17"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4799'>
<a name='4800'>
<a name='4801'>
      <font color=#447700>!KAL finish off the 1-D variables (t_base, u_base, v_base, qv_base, and z_base) (move this out of here if alt_u_c and alt_u_n are calculated elsewhere)<a name='4802'></font>
      CALL <A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_1D'>vert_interp_vert_nesting_1d</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INTERP_VERT_NESTING_1D_1"> ( &amp;         <a name='4803'>
                                        ngrid%t_base,                                           &amp;    <font color=#447700>! CD field<a name='4804'></font>
                                        ids, ide, kds, kde, jds, jde,                           &amp;    <font color=#447700>! CD dims<a name='4805'></font>
                                        ims, ime, kms, kme, jms, jme,                           &amp;    <font color=#447700>! CD dims<a name='4806'></font>
                                        ips, ipe, kps, MIN( (kde-1), kpe ), jps, jpe,           &amp;    <font color=#447700>! CD dims<a name='4807'></font>
                                        pgrid%s_vert, pgrid%e_vert,                             &amp;    <font color=#447700>! vertical dimension of the parent grid<a name='4808'></font>
                                        pgrid%cf1, pgrid%cf2, pgrid%cf3, pgrid%cfn, pgrid%cfn1, &amp;    <font color=#447700>! coarse grid extrapolation constants <a name='4809'></font>
                                        alt_u_c, alt_u_n)                                            <font color=#447700>! coordinates for parent and nest<a name='4810'></font>
      CALL <A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_1D'>vert_interp_vert_nesting_1d</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INTERP_VERT_NESTING_1D_2"> ( &amp;         <a name='4811'>
                                        ngrid%u_base,                                           &amp;    <font color=#447700>! CD field<a name='4812'></font>
                                        ids, ide, kds, kde, jds, jde,                           &amp;    <font color=#447700>! CD dims<a name='4813'></font>
                                        ims, ime, kms, kme, jms, jme,                           &amp;    <font color=#447700>! CD dims<a name='4814'></font>
                                        ips, ipe, kps, MIN( (kde-1), kpe ), jps, jpe,           &amp;    <font color=#447700>! CD dims<a name='4815'></font>
                                        pgrid%s_vert, pgrid%e_vert,                             &amp;    <font color=#447700>! vertical dimension of the parent grid<a name='4816'></font>
                                        pgrid%cf1, pgrid%cf2, pgrid%cf3, pgrid%cfn, pgrid%cfn1, &amp;    <font color=#447700>! coarse grid extrapolation constants <a name='4817'></font>
                                        alt_u_c, alt_u_n)                                            <font color=#447700>! coordinates for parent and nest<a name='4818'></font>
      CALL <A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_1D'>vert_interp_vert_nesting_1d</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INTERP_VERT_NESTING_1D_3"> ( &amp;         <a name='4819'>
                                        ngrid%v_base,                                           &amp;    <font color=#447700>! CD field<a name='4820'></font>
                                        ids, ide, kds, kde, jds, jde,                           &amp;    <font color=#447700>! CD dims<a name='4821'></font>
                                        ims, ime, kms, kme, jms, jme,                           &amp;    <font color=#447700>! CD dims<a name='4822'></font>
                                        ips, ipe, kps, MIN( (kde-1), kpe ), jps, jpe,           &amp;    <font color=#447700>! CD dims<a name='4823'></font>
                                        pgrid%s_vert, pgrid%e_vert,                             &amp;    <font color=#447700>! vertical dimension of the parent grid<a name='4824'></font>
                                        pgrid%cf1, pgrid%cf2, pgrid%cf3, pgrid%cfn, pgrid%cfn1, &amp;    <font color=#447700>! coarse grid extrapolation constants <a name='4825'></font>
                                        alt_u_c, alt_u_n)                                            <font color=#447700>! coordinates for parent and nest<a name='4826'></font>
      CALL <A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_1D'>vert_interp_vert_nesting_1d</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INTERP_VERT_NESTING_1D_4"> ( &amp;         <a name='4827'>
                                        ngrid%qv_base,                                          &amp;    <font color=#447700>! CD field<a name='4828'></font>
                                        ids, ide, kds, kde, jds, jde,                           &amp;    <font color=#447700>! CD dims<a name='4829'></font>
                                        ims, ime, kms, kme, jms, jme,                           &amp;    <font color=#447700>! CD dims<a name='4830'></font>
                                        ips, ipe, kps, MIN( (kde-1), kpe ), jps, jpe,           &amp;    <font color=#447700>! CD dims<a name='4831'></font>
                                        pgrid%s_vert, pgrid%e_vert,                             &amp;    <font color=#447700>! vertical dimension of the parent grid<a name='4832'></font>
                                        pgrid%cf1, pgrid%cf2, pgrid%cf3, pgrid%cfn, pgrid%cfn1, &amp;    <font color=#447700>! coarse grid extrapolation constants <a name='4833'></font>
                                        alt_u_c, alt_u_n)                                            <font color=#447700>! coordinates for parent and nest<a name='4834'></font>
      CALL <A href='../../html_code/share/interp_fcn.F.html#VERT_INTERP_VERT_NESTING_1D'>vert_interp_vert_nesting_1d</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_INTERP_VERT_NESTING_1D_5"> ( &amp;         <a name='4835'>
                                        ngrid%z_base,                                           &amp;    <font color=#447700>! CD field<a name='4836'></font>
                                        ids, ide, kds, kde, jds, jde,                           &amp;    <font color=#447700>! CD dims<a name='4837'></font>
                                        ims, ime, kms, kme, jms, jme,                           &amp;    <font color=#447700>! CD dims<a name='4838'></font>
                                        ips, ipe, kps, MIN( (kde-1), kpe ), jps, jpe,           &amp;    <font color=#447700>! CD dims<a name='4839'></font>
                                        pgrid%s_vert, pgrid%e_vert,                             &amp;    <font color=#447700>! vertical dimension of the parent grid<a name='4840'></font>
                                        pgrid%cf1, pgrid%cf2, pgrid%cf3, pgrid%cfn, pgrid%cfn1, &amp;    <font color=#447700>! coarse grid extrapolation constants <a name='4841'></font>
                                        alt_u_c, alt_u_n)                                            <font color=#447700>! coordinates for parent and nest<a name='4842'></font>
<a name='4843'>
endif<a name='4844'>
        <a name='4845'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_3">( grid%id )<a name='4846'>
<a name='4847'>
#include "<A href='../../html_code/include/HALO_INTERP_DOWN.inc.html'>HALO_INTERP_DOWN.inc</A>"<A NAME="HALO_INTERP_DOWN.inc_18"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4848'>
<a name='4849'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_3"><a name='4850'>
<a name='4851'>
#  include "<A href='../../html_code/include/nest_interpdown_interp.inc.html'>nest_interpdown_interp.inc</A>"<A NAME="nest_interpdown_interp.inc_19"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4852'>
<a name='4853'>
      RETURN<a name='4854'>
   END SUBROUTINE interp_domain_em_part2<a name='4855'>
<a name='4856'>
<font color=#447700>!------------------------------------------------------------------<a name='4857'></font>
<a name='4858'>
<A NAME='INTERP_DOMAIN_EM_SMALL_PART1'><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4859'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_domain_em_small_part1</font> ( grid, intermediate_grid, ngrid, config_flags    &amp; <A href='../../call_to/INTERP_DOMAIN_EM_SMALL_PART1.html' TARGET='index'>1</A>,<A href='../../call_from/INTERP_DOMAIN_EM_SMALL_PART1.html' TARGET='index'>14</A><a name='4860'>
<font color=#447700>!<a name='4861'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_20"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4862'>
<font color=#447700>!<a name='4863'></font>
                 )<a name='4864'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_47"><a name='4865'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_112">, ONLY : domain, get_ijk_from_grid<a name='4866'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_69">, ONLY : grid_config_rec_type<a name='4867'>
      USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_24">, ONLY: halo_em_horiz_interp_sub<a name='4868'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_102">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, &amp;<a name='4869'>
                            mytask, get_dm_max_halo_width,                          &amp;<a name='4870'>
                            nest_task_offsets, mpi_comm_to_kid, mpi_comm_to_mom,    &amp;<a name='4871'>
                            which_kid, nest_pes_x, nest_pes_y, intercomm_active<a name='4872'>
      USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_21"><a name='4873'>
      IMPLICIT NONE<a name='4874'>
<font color=#447700>!<a name='4875'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='4876'></font>
      TYPE(domain), POINTER :: intermediate_grid<a name='4877'>
      TYPE(domain), POINTER :: ngrid<a name='4878'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_21"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4879'>
      INTEGER nlev, msize<a name='4880'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='4881'>
      INTEGER iparstrt,jparstrt,sw<a name='4882'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='4883'>
      REAL xv(2000)<a name='4884'>
      INTEGER       ::           ids,  ide,  jds,  jde,  kds,  kde,    &amp;<a name='4885'>
                                 ims,  ime,  jms,  jme,  kms,  kme,    &amp;<a name='4886'>
                                 ips,  ipe,  jps,  jpe,  kps,  kpe<a name='4887'>
<a name='4888'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4889'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4890'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='4891'>
      INTEGER       ::          iids, iide, ijds, ijde, ikds, ikde,    &amp;<a name='4892'>
                                iims, iime, ijms, ijme, ikms, ikme,    &amp;<a name='4893'>
                                iips, iipe, ijps, ijpe, ikps, ikpe<a name='4894'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='4895'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='4896'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='4897'>
<a name='4898'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='4899'>
<a name='4900'>
      INTEGER icoord, jcoord, idim_cd, jdim_cd, pgr <a name='4901'>
      INTEGER thisdomain_max_halo_width<a name='4902'>
      INTEGER local_comm, myproc, nproc<a name='4903'>
      INTEGER ioffset<a name='4904'>
<a name='4905'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_38"> ( local_comm )<a name='4906'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_12">( myproc )<a name='4907'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_5">( nproc )<a name='4908'>
<a name='4909'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_45"> (  grid ,                           &amp;<a name='4910'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='4911'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='4912'>
                                ips, ipe, jps, jpe, kps, kpe     )<a name='4913'>
#ifdef DM_PARALLEL<a name='4914'>
#  include "<A href='../../html_code/include/HALO_EM_HORIZ_INTERP.inc.html'>HALO_EM_HORIZ_INTERP.inc</A>"<A NAME="HALO_EM_HORIZ_INTERP.inc_22"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4915'>
#endif<a name='4916'>
<a name='4917'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_46"> (  grid ,                   &amp;<a name='4918'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='4919'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='4920'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='4921'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_47"> (  intermediate_grid ,              &amp;<a name='4922'>
                                iids, iide, ijds, ijde, ikds, ikde,    &amp;<a name='4923'>
                                iims, iime, ijms, ijme, ikms, ikme,    &amp;<a name='4924'>
                                iips, iipe, ijps, ijpe, ikps, ikpe    )<a name='4925'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_48"> (  ngrid ,              &amp;<a name='4926'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='4927'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='4928'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='4929'>
<a name='4930'>
      CALL nl_get_parent_grid_ratio ( ngrid%id, pgr )<a name='4931'>
      CALL nl_get_i_parent_start ( intermediate_grid%id, iparstrt )<a name='4932'>
      CALL nl_get_j_parent_start ( intermediate_grid%id, jparstrt )<a name='4933'>
      CALL nl_get_shw            ( intermediate_grid%id, sw )<a name='4934'>
      icoord =    iparstrt - sw<a name='4935'>
      jcoord =    jparstrt - sw<a name='4936'>
      idim_cd = iide - iids + 1<a name='4937'>
      jdim_cd = ijde - ijds + 1<a name='4938'>
<a name='4939'>
      nlev  = ckde - ckds + 1<a name='4940'>
<a name='4941'>
      <font color=#447700>! get max_halo_width for parent. It may be smaller if it is moad<a name='4942'></font>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_5"> ( grid%id , thisdomain_max_halo_width )<a name='4943'>
<a name='4944'>
      <font color=#447700>!  How many 3d arrays, so far just 3d theta-300 and geopotential perturbation,<a name='4945'></font>
      <font color=#447700>!  and the 2d topo elevation, three max press/temp/height fields, and three<a name='4946'></font>
      <font color=#447700>!  min press/temp/height fields.<a name='4947'></font>
   <a name='4948'>
      msize = ( 2 )* nlev + 7<a name='4949'>
   <a name='4950'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, calling rsl_lite_to_child')<a name='4951'></font>
      CALL rsl_lite_to_child_info( local_communicator, msize*RWORDSIZE     &amp;<a name='4952'>
                              ,cips,cipe,cjps,cjpe                         &amp;<a name='4953'>
                              ,iids,iide,ijds,ijde                         &amp;<a name='4954'>
                              ,nids,nide,njds,njde                         &amp;<a name='4955'>
                              ,pgr , sw                                    &amp;<a name='4956'>
                              ,ntasks_x,ntasks_y                           &amp;<a name='4957'>
                              ,thisdomain_max_halo_width                   &amp;<a name='4958'>
                              ,icoord,jcoord                               &amp;<a name='4959'>
                              ,idim_cd,jdim_cd                             &amp;<a name='4960'>
                              ,pig,pjg,retval )<a name='4961'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, back from rsl_lite_to_child')<a name='4962'></font>
      DO while ( retval .eq. 1 )<a name='4963'>
         IF ( SIZE(grid%ph_2) .GT. 1 ) THEN<a name='4964'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, ph_2')<a name='4965'></font>
            DO k = ckds,ckde<a name='4966'>
               xv(k)= grid%ph_2(pig,k,pjg)<a name='4967'>
            END DO<a name='4968'>
            CALL rsl_lite_to_child_msg(((ckde)-(ckds)+1)*RWORDSIZE,xv)<a name='4969'>
         END IF<a name='4970'>
   <a name='4971'>
         IF ( SIZE(grid%t_2) .GT. 1 ) THEN<a name='4972'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, t_2')<a name='4973'></font>
            DO k = ckds,(ckde-1)<a name='4974'>
               xv(k)= grid%t_2(pig,k,pjg)<a name='4975'>
            END DO<a name='4976'>
            CALL rsl_lite_to_child_msg((((ckde-1))-(ckds)+1)*RWORDSIZE,xv)<a name='4977'>
         END IF<a name='4978'>
   <a name='4979'>
         IF ( SIZE(grid%ht) .GT. 1 ) THEN<a name='4980'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, ht')<a name='4981'></font>
            xv(1)= grid%ht(pig,pjg)<a name='4982'>
            CALL rsl_lite_to_child_msg(RWORDSIZE,xv)<a name='4983'>
         END IF<a name='4984'>
   <a name='4985'>
         IF ( SIZE(grid%t_max_p) .GT. 1 ) THEN<a name='4986'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, t_max_p')<a name='4987'></font>
            xv(1)= grid%t_max_p(pig,pjg)<a name='4988'>
            CALL rsl_lite_to_child_msg(RWORDSIZE,xv)<a name='4989'>
         END IF<a name='4990'>
   <a name='4991'>
         IF ( SIZE(grid%ght_max_p) .GT. 1 ) THEN<a name='4992'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, ght_max_p')<a name='4993'></font>
            xv(1)= grid%ght_max_p(pig,pjg)<a name='4994'>
            CALL rsl_lite_to_child_msg(RWORDSIZE,xv)<a name='4995'>
         END IF<a name='4996'>
   <a name='4997'>
         IF ( SIZE(grid%max_p) .GT. 1 ) THEN<a name='4998'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, max_p')<a name='4999'></font>
            xv(1)= grid%max_p(pig,pjg)<a name='5000'>
            CALL rsl_lite_to_child_msg(RWORDSIZE,xv)<a name='5001'>
         END IF<a name='5002'>
   <a name='5003'>
         IF ( SIZE(grid%t_min_p) .GT. 1 ) THEN<a name='5004'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, t_min_p')<a name='5005'></font>
            xv(1)= grid%t_min_p(pig,pjg)<a name='5006'>
            CALL rsl_lite_to_child_msg(RWORDSIZE,xv)<a name='5007'>
         END IF<a name='5008'>
   <a name='5009'>
         IF ( SIZE(grid%ght_min_p) .GT. 1 ) THEN<a name='5010'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, ght_min_p')<a name='5011'></font>
            xv(1)= grid%ght_min_p(pig,pjg)<a name='5012'>
            CALL rsl_lite_to_child_msg(RWORDSIZE,xv)<a name='5013'>
         END IF<a name='5014'>
   <a name='5015'>
         IF ( SIZE(grid%min_p) .GT. 1 ) THEN<a name='5016'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, min_p')<a name='5017'></font>
            xv(1)= grid%min_p(pig,pjg)<a name='5018'>
            CALL rsl_lite_to_child_msg(RWORDSIZE,xv)<a name='5019'>
         END IF<a name='5020'>
   <a name='5021'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, calling rsl_lite_to_child_info')<a name='5022'></font>
         CALL rsl_lite_to_child_info( local_communicator, msize*RWORDSIZE  &amp;<a name='5023'>
                                     ,cips,cipe,cjps,cjpe                  &amp;<a name='5024'>
                                     ,iids,iide,ijds,ijde                  &amp;<a name='5025'>
                                     ,nids,nide,njds,njde                  &amp;<a name='5026'>
                                     ,pgr , sw                             &amp;<a name='5027'>
                                     ,ntasks_x,ntasks_y                    &amp;<a name='5028'>
                                     ,thisdomain_max_halo_width            &amp;<a name='5029'>
                                     ,icoord,jcoord                        &amp;<a name='5030'>
                                     ,idim_cd,jdim_cd                      &amp;<a name='5031'>
                                     ,pig,pjg,retval )<a name='5032'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, back from rsl_lite_to_child_info')<a name='5033'></font>
      END DO<a name='5034'>
<a name='5035'>
      <font color=#447700>! determine which communicator and offset to use<a name='5036'></font>
      IF ( intercomm_active( grid%id ) ) THEN        <font color=#447700>! I am parent<a name='5037'></font>
        local_comm = mpi_comm_to_kid( which_kid(ngrid%id), grid%id )<a name='5038'>
        ioffset = nest_task_offsets(ngrid%id)<a name='5039'>
      ELSE IF ( intercomm_active( ngrid%id ) ) THEN  <font color=#447700>! I am nest<a name='5040'></font>
        local_comm = mpi_comm_to_mom( ngrid%id )<a name='5041'>
        ioffset = nest_task_offsets(ngrid%id)<a name='5042'>
      END IF<a name='5043'>
<a name='5044'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, calling rsl_lite_bcast')<a name='5045'></font>
      CALL rsl_lite_bcast_msgs( myproc, nest_pes_x(grid%id)*nest_pes_y(grid%id),         &amp;<a name='5046'>
                                        nest_pes_x(ngrid%id)*nest_pes_y(ngrid%id),       &amp; <a name='5047'>
                                        ioffset, local_comm )<a name='5048'>
<font color=#447700>!call wrf_debug(0,'/external/RSL_LITE/module_dm.F, back from rsl_lite_bcast')<a name='5049'></font>
<a name='5050'>
      RETURN<a name='5051'>
   END SUBROUTINE interp_domain_em_small_part1<a name='5052'>
<a name='5053'>
<font color=#447700>!------------------------------------------------------------------<a name='5054'></font>
<a name='5055'>
<A NAME='INTERP_DOMAIN_EM_SMALL_PART2'><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5056'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_domain_em_small_part2</font> ( grid, ngrid, config_flags    &amp; <A href='../../call_to/INTERP_DOMAIN_EM_SMALL_PART2.html' TARGET='index'>1</A>,<A href='../../call_from/INTERP_DOMAIN_EM_SMALL_PART2.html' TARGET='index'>11</A><a name='5057'>
<font color=#447700>!<a name='5058'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_23"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5059'>
<font color=#447700>!<a name='5060'></font>
                 )<a name='5061'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_48"><a name='5062'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_113">, ONLY : domain, get_ijk_from_grid<a name='5063'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_70">, ONLY : grid_config_rec_type<a name='5064'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_103">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, &amp;<a name='5065'>
                            mytask, get_dm_max_halo_width<a name='5066'>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_3">, ONLY : halo_interp_down_sub<a name='5067'>
      IMPLICIT NONE<a name='5068'>
<font color=#447700>!<a name='5069'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5070'></font>
      TYPE(domain), POINTER :: ngrid<a name='5071'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_24"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5072'>
      INTEGER nlev, msize<a name='5073'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='5074'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='5075'>
      REAL xv(2000)<a name='5076'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5077'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5078'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='5079'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5080'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5081'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='5082'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='5083'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='5084'>
                                ips, ipe, jps, jpe, kps, kpe<a name='5085'>
<a name='5086'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='5087'>
<a name='5088'>
      INTEGER myproc<a name='5089'>
      INTEGER ierr<a name='5090'>
      INTEGER thisdomain_max_halo_width<a name='5091'>
<a name='5092'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_49"> (  grid ,                   &amp;<a name='5093'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5094'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5095'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='5096'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_50"> (  ngrid ,              &amp;<a name='5097'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5098'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5099'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='5100'>
<a name='5101'>
      nlev  = ckde - ckds + 1 <a name='5102'>
<a name='5103'>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_6"> ( ngrid%id , thisdomain_max_halo_width )<a name='5104'>
<a name='5105'>
      CALL rsl_lite_from_parent_info(pig,pjg,retval)<a name='5106'>
      <a name='5107'>
      DO while ( retval .eq. 1 )<a name='5108'>
      <a name='5109'>
         IF ( SIZE(grid%ph_2) .GT. 1 ) THEN<a name='5110'>
            CALL rsl_lite_from_parent_msg(((ckde)-(ckds)+1)*RWORDSIZE,xv)<a name='5111'>
            DO k = ckds,ckde<a name='5112'>
               grid%ph_2(pig,k,pjg) = xv(k)<a name='5113'>
            END DO<a name='5114'>
         END IF<a name='5115'>
   <a name='5116'>
         IF ( SIZE(grid%t_2) .GT. 1 ) THEN<a name='5117'>
            CALL rsl_lite_from_parent_msg((((ckde-1))-(ckds)+1)*RWORDSIZE,xv)<a name='5118'>
            DO k = ckds,(ckde-1)<a name='5119'>
               grid%t_2(pig,k,pjg) = xv(k)<a name='5120'>
            END DO<a name='5121'>
         END IF<a name='5122'>
   <a name='5123'>
         IF ( SIZE(grid%ht) .GT. 1 ) THEN<a name='5124'>
            CALL rsl_lite_from_parent_msg(RWORDSIZE,xv)<a name='5125'>
            grid%ht(pig,pjg) = xv(1)<a name='5126'>
         END IF<a name='5127'>
   <a name='5128'>
         IF ( SIZE(grid%t_max_p) .GT. 1 ) THEN<a name='5129'>
            CALL rsl_lite_from_parent_msg(RWORDSIZE,xv)<a name='5130'>
            grid%t_max_p(pig,pjg) = xv(1)<a name='5131'>
         END IF<a name='5132'>
   <a name='5133'>
         IF ( SIZE(grid%ght_max_p) .GT. 1 ) THEN<a name='5134'>
            CALL rsl_lite_from_parent_msg(RWORDSIZE,xv)<a name='5135'>
            grid%ght_max_p(pig,pjg) = xv(1)<a name='5136'>
         END IF<a name='5137'>
   <a name='5138'>
         IF ( SIZE(grid%max_p) .GT. 1 ) THEN<a name='5139'>
            CALL rsl_lite_from_parent_msg(RWORDSIZE,xv)<a name='5140'>
            grid%max_p(pig,pjg) = xv(1)<a name='5141'>
         END IF<a name='5142'>
   <a name='5143'>
         IF ( SIZE(grid%t_min_p) .GT. 1 ) THEN<a name='5144'>
            CALL rsl_lite_from_parent_msg(RWORDSIZE,xv)<a name='5145'>
            grid%t_min_p(pig,pjg) = xv(1)<a name='5146'>
         END IF<a name='5147'>
   <a name='5148'>
         IF ( SIZE(grid%ght_min_p) .GT. 1 ) THEN<a name='5149'>
            CALL rsl_lite_from_parent_msg(RWORDSIZE,xv)<a name='5150'>
            grid%ght_min_p(pig,pjg) = xv(1)<a name='5151'>
         END IF<a name='5152'>
   <a name='5153'>
         IF ( SIZE(grid%min_p) .GT. 1 ) THEN<a name='5154'>
            CALL rsl_lite_from_parent_msg(RWORDSIZE,xv)<a name='5155'>
            grid%min_p(pig,pjg) = xv(1)<a name='5156'>
         END IF<a name='5157'>
      <a name='5158'>
         CALL rsl_lite_from_parent_info(pig,pjg,retval)<a name='5159'>
         <a name='5160'>
      END DO<a name='5161'>
<a name='5162'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_51"> (  grid ,              &amp;<a name='5163'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='5164'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='5165'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='5166'>
<a name='5167'>
#include "<A href='../../html_code/include/HALO_INTERP_DOWN.inc.html'>HALO_INTERP_DOWN.inc</A>"<A NAME="HALO_INTERP_DOWN.inc_25"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5168'>
<a name='5169'>
      CALL <A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BL'>interp_fcn_bl</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_FCN_BL_1"> ( grid%ph_2,                                           &amp;       <a name='5170'>
                           cids, cide, ckds, ckde, cjds, cjde,                  &amp;         <a name='5171'>
                           cims, cime, ckms, ckme, cjms, cjme,                  &amp;         <a name='5172'>
                           cips, cipe, ckps, MIN( ckde, ckpe ), cjps, cjpe,     &amp;         <a name='5173'>
                           ngrid%ph_2,                                          &amp;   <a name='5174'>
                           nids, nide, nkds, nkde, njds, njde,                  &amp;         <a name='5175'>
                           nims, nime, nkms, nkme, njms, njme,                  &amp;         <a name='5176'>
                           nips, nipe, nkps, MIN( nkde, nkpe ), njps, njpe,     &amp;         <a name='5177'>
                           config_flags%shw, ngrid%imask_nostag,                &amp;         <a name='5178'>
                           .FALSE., .FALSE.,                                    &amp;         <a name='5179'>
                           ngrid%i_parent_start, ngrid%j_parent_start,          &amp;<a name='5180'>
                           ngrid%parent_grid_ratio, ngrid%parent_grid_ratio,    &amp;<a name='5181'>
                           grid%ht, ngrid%ht,                                   &amp;<a name='5182'>
                           grid%t_max_p, ngrid%t_max_p,                         &amp;<a name='5183'>
                           grid%ght_max_p, ngrid%ght_max_p,                     &amp;<a name='5184'>
                           grid%max_p, ngrid%max_p,                             &amp;<a name='5185'>
                           grid%t_min_p, ngrid%t_min_p,                         &amp;<a name='5186'>
                           grid%ght_min_p, ngrid%ght_min_p,                     &amp;<a name='5187'>
                           grid%min_p, ngrid%min_p,                             &amp;<a name='5188'>
                           ngrid%znw, ngrid%p_top                               )<a name='5189'>
      <a name='5190'>
      CALL <A href='../../html_code/share/interp_fcn.F.html#INTERP_FCN_BL'>interp_fcn_bl</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_EM_SMALL_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTERP_FCN_BL_2"> ( grid%t_2,                                            &amp;       <a name='5191'>
                           cids, cide, ckds, ckde, cjds, cjde,                  &amp;         <a name='5192'>
                           cims, cime, ckms, ckme, cjms, cjme,                  &amp;         <a name='5193'>
                           cips, cipe, ckps, MIN( (ckde-1), ckpe ), cjps, cjpe, &amp;         <a name='5194'>
                           ngrid%t_2,                                           &amp;   <a name='5195'>
                           nids, nide, nkds, nkde, njds, njde,                  &amp;         <a name='5196'>
                           nims, nime, nkms, nkme, njms, njme,                  &amp;         <a name='5197'>
                           nips, nipe, nkps, MIN( (nkde-1), nkpe ), njps, njpe, &amp;         <a name='5198'>
                           config_flags%shw, ngrid%imask_nostag,                &amp;         <a name='5199'>
                           .FALSE., .FALSE.,                                    &amp;         <a name='5200'>
                           ngrid%i_parent_start, ngrid%j_parent_start,          &amp;<a name='5201'>
                           ngrid%parent_grid_ratio, ngrid%parent_grid_ratio,    &amp; <a name='5202'>
                           grid%ht, ngrid%ht,                                   &amp;<a name='5203'>
                           grid%t_max_p, ngrid%t_max_p,                         &amp;<a name='5204'>
                           grid%ght_max_p, ngrid%ght_max_p,                     &amp;<a name='5205'>
                           grid%max_p, ngrid%max_p,                             &amp;<a name='5206'>
                           grid%t_min_p, ngrid%t_min_p,                         &amp;<a name='5207'>
                           grid%ght_min_p, ngrid%ght_min_p,                     &amp;<a name='5208'>
                           grid%min_p, ngrid%min_p,                             &amp;<a name='5209'>
                           ngrid%znu, ngrid%p_top                               )<a name='5210'>
<a name='5211'>
      RETURN<a name='5212'>
   END SUBROUTINE interp_domain_em_small_part2<a name='5213'>
<a name='5214'>
<font color=#447700>!------------------------------------------------------------------<a name='5215'></font>
<a name='5216'>
<A NAME='FEEDBACK_NEST_PREP'><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5217'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>feedback_nest_prep</font> ( grid, config_flags    &amp; <A href='../../call_to/FEEDBACK_NEST_PREP.html' TARGET='index'>1</A>,<A href='../../call_from/FEEDBACK_NEST_PREP.html' TARGET='index'>8</A><a name='5218'>
<font color=#447700>!<a name='5219'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_26"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5220'>
<font color=#447700>!<a name='5221'></font>
)<a name='5222'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_49"><a name='5223'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_114">, ONLY : domain, get_ijk_from_grid<a name='5224'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_71">, ONLY : grid_config_rec_type<a name='5225'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_104">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask <font color=#447700>!, &amp;<a name='5226'></font>
                             <font color=#447700>!push_communicators_for_domain, pop_communicators_for_domain<a name='5227'></font>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_4">, ONLY : halo_interp_up_sub<a name='5228'>
      IMPLICIT NONE<a name='5229'>
<font color=#447700>!<a name='5230'></font>
      TYPE(domain), TARGET :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5231'></font>
      TYPE (grid_config_rec_type) :: config_flags <font color=#447700>! configureation flags, has vertical dim of <a name='5232'></font>
                                                  <font color=#447700>! soil temp, moisture, etc., has vertical dim<a name='5233'></font>
                                                  <font color=#447700>! of soil categories<a name='5234'></font>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_27"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5235'>
<a name='5236'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='5237'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='5238'>
                                ips, ipe, jps, jpe, kps, kpe<a name='5239'>
<a name='5240'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='5241'>
<a name='5242'>
      INTEGER       :: idum1, idum2<a name='5243'>
<a name='5244'>
<a name='5245'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_52"> (  grid ,              &amp;<a name='5246'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='5247'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='5248'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='5249'>
<a name='5250'>
    IF ( grid%active_this_task ) THEN<a name='5251'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_4">( grid%id )<a name='5252'>
<a name='5253'>
#ifdef DM_PARALLEL<a name='5254'>
#include "<A href='../../html_code/include/HALO_INTERP_UP.inc.html'>HALO_INTERP_UP.inc</A>"<A NAME="HALO_INTERP_UP.inc_28"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5255'>
#endif<a name='5256'>
<a name='5257'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_4"><a name='5258'>
    END IF<a name='5259'>
<a name='5260'>
   END SUBROUTINE feedback_nest_prep<a name='5261'>
<a name='5262'>
<font color=#447700>!------------------------------------------------------------------<a name='5263'></font>
<a name='5264'>
<A NAME='FEEDBACK_DOMAIN_EM_PART1'><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5265'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>feedback_domain_em_part1</font> ( grid, ngrid, config_flags    &amp; <A href='../../call_to/FEEDBACK_DOMAIN_EM_PART1.html' TARGET='index'>1</A>,<A href='../../call_from/FEEDBACK_DOMAIN_EM_PART1.html' TARGET='index'>16</A><a name='5266'>
<font color=#447700>!<a name='5267'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_29"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5268'>
<font color=#447700>!<a name='5269'></font>
                 )<a name='5270'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_50"><a name='5271'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_115">, ONLY : domain, get_ijk_from_grid<a name='5272'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_72">, ONLY : grid_config_rec_type, model_config_rec, model_to_grid_config_rec<a name='5273'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_105">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='5274'>
                            ipe_save, jpe_save, ips_save, jps_save,                         &amp;<a name='5275'>
                            nest_pes_x, nest_pes_y<a name='5276'>
 <a name='5277'>
      IMPLICIT NONE<a name='5278'>
<font color=#447700>!<a name='5279'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5280'></font>
      TYPE(domain), POINTER :: ngrid<a name='5281'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_30"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5282'>
      INTEGER nlev, msize<a name='5283'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='5284'>
      TYPE(domain), POINTER :: xgrid<a name='5285'>
      TYPE (grid_config_rec_type)            :: config_flags, nconfig_flags<a name='5286'>
      REAL xv(2000)<a name='5287'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5288'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5289'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='5290'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5291'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5292'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='5293'>
<a name='5294'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='5295'>
<a name='5296'>
      INTEGER local_comm, myproc, nproc, idum1, idum2<a name='5297'>
      INTEGER thisdomain_max_halo_width<a name='5298'>
<a name='5299'>
<font color=#447700>!cyl: add variables for trajectory<a name='5300'></font>
      integer tjk<a name='5301'>
<a name='5302'>
      INTERFACE<a name='5303'>
          SUBROUTINE feedback_nest_prep ( grid, config_flags    &amp;<a name='5304'>
<font color=#447700>!<a name='5305'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_31"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5306'>
<font color=#447700>!<a name='5307'></font>
)<a name='5308'>
             USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_51"><a name='5309'>
             USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_116">, ONLY : domain<a name='5310'>
             USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_73">, ONLY : grid_config_rec_type<a name='5311'>
<font color=#447700>!<a name='5312'></font>
             TYPE (grid_config_rec_type)            :: config_flags<a name='5313'>
             TYPE(domain), TARGET                   :: grid<a name='5314'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_32"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5315'>
          END SUBROUTINE feedback_nest_prep<a name='5316'>
      END INTERFACE<a name='5317'>
<font color=#447700>!<a name='5318'></font>
<a name='5319'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_39"> ( local_comm )<a name='5320'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_13">( myproc )<a name='5321'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_6">( nproc )<a name='5322'>
<a name='5323'>
<font color=#447700>!<a name='5324'></font>
<font color=#447700>! intermediate grid<a name='5325'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_53"> (  grid ,                                 &amp;<a name='5326'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5327'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5328'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='5329'>
<font color=#447700>! nest grid<a name='5330'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_54"> (  ngrid ,                                &amp;<a name='5331'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5332'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5333'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='5334'>
<a name='5335'>
      nlev  = ckde - ckds + 1<a name='5336'>
<a name='5337'>
      ips_save = ngrid%i_parent_start   <font color=#447700>! used in feedback_domain_em_part2 below<a name='5338'></font>
      jps_save = ngrid%j_parent_start<a name='5339'>
      ipe_save = ngrid%i_parent_start + (nide-nids+1) / ngrid%parent_grid_ratio - 1<a name='5340'>
      jpe_save = ngrid%j_parent_start + (njde-njds+1) / ngrid%parent_grid_ratio - 1<a name='5341'>
<a name='5342'>
<font color=#447700>! feedback_nest_prep invokes a halo exchange on the ngrid. It is done this way<a name='5343'></font>
<font color=#447700>! in a separate routine because the HALOs need the data to be dereference from the<a name='5344'></font>
<font color=#447700>! grid data structure and, in this routine, the dereferenced fields are related to<a name='5345'></font>
<font color=#447700>! the intermediate domain, not the nest itself. Save the current grid pointer to intermediate<a name='5346'></font>
<font color=#447700>! domain, switch grid to point to ngrid, invoke feedback_nest_prep,  then restore grid<a name='5347'></font>
<font color=#447700>! to point to intermediate domain.<a name='5348'></font>
<a name='5349'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_13"> ( ngrid%id , model_config_rec , nconfig_flags )<a name='5350'>
      CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_3"> ( ngrid%id , idum1 , idum2 )<a name='5351'>
      xgrid =&gt; grid<a name='5352'>
      grid =&gt; ngrid<a name='5353'>
<a name='5354'>
      CALL <A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP'>feedback_nest_prep</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FEEDBACK_NEST_PREP_1"> ( grid, nconfig_flags    &amp;<a name='5355'>
<font color=#447700>!<a name='5356'></font>
#include "<A href='../../html_code/include/actual_new_args.inc.html'>actual_new_args.inc</A>"<A NAME="actual_new_args.inc_33"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5357'>
<font color=#447700>!<a name='5358'></font>
)<a name='5359'>
<a name='5360'>
<font color=#447700>! put things back so grid is intermediate grid<a name='5361'></font>
<a name='5362'>
      grid =&gt; xgrid<a name='5363'>
      CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_4"> ( grid%id , idum1 , idum2 )<a name='5364'>
<a name='5365'>
<font color=#447700>! "interp" (basically copy) ngrid onto intermediate grid<a name='5366'></font>
<a name='5367'>
#include "<A href='../../html_code/include/nest_feedbackup_interp.inc.html'>nest_feedbackup_interp.inc</A>"<A NAME="nest_feedbackup_interp.inc_34"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5368'>
<a name='5369'>
      RETURN<a name='5370'>
   END SUBROUTINE feedback_domain_em_part1<a name='5371'>
<a name='5372'>
<font color=#447700>!------------------------------------------------------------------<a name='5373'></font>
<a name='5374'>
<A NAME='FEEDBACK_DOMAIN_EM_PART2'><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5375'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>feedback_domain_em_part2</font> ( grid, intermediate_grid, ngrid , config_flags    &amp; <A href='../../call_to/FEEDBACK_DOMAIN_EM_PART2.html' TARGET='index'>1</A>,<A href='../../call_from/FEEDBACK_DOMAIN_EM_PART2.html' TARGET='index'>17</A><a name='5376'>
<font color=#447700>!<a name='5377'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_35"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5378'>
<font color=#447700>!<a name='5379'></font>
                 )<a name='5380'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_52"><a name='5381'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_117">, ONLY : domain, domain_clock_get, get_ijk_from_grid<a name='5382'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_74">, ONLY : grid_config_rec_type, model_config_rec<a name='5383'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_106">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='5384'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width,  &amp;<a name='5385'>
                            nest_pes_x, nest_pes_y,                                         &amp;<a name='5386'>
                            intercomm_active, nest_task_offsets,                    &amp;<a name='5387'>
                            mpi_comm_to_mom, mpi_comm_to_kid, which_kid <font color=#447700>!,            &amp;<a name='5388'></font>
                             <font color=#447700>!push_communicators_for_domain, pop_communicators_for_domain<a name='5389'></font>
<a name='5390'>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_5">, ONLY : halo_interp_up_sub<a name='5391'>
      USE module_utility<a name='5392'>
      IMPLICIT NONE<a name='5393'>
<a name='5394'>
<font color=#447700>!<a name='5395'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5396'></font>
      TYPE(domain), POINTER :: intermediate_grid<a name='5397'>
      TYPE(domain), POINTER :: ngrid<a name='5398'>
      TYPE(domain), POINTER :: parent_grid<a name='5399'>
<a name='5400'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_36"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5401'>
      INTEGER nlev, msize<a name='5402'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='5403'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='5404'>
      REAL xv(2000)<a name='5405'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5406'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5407'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='5408'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5409'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5410'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='5411'>
      INTEGER       ::          xids, xide, xjds, xjde, xkds, xkde,    &amp;<a name='5412'>
                                xims, xime, xjms, xjme, xkms, xkme,    &amp;<a name='5413'>
                                xips, xipe, xjps, xjpe, xkps, xkpe<a name='5414'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='5415'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='5416'>
                                ips, ipe, jps, jpe, kps, kpe<a name='5417'>
<a name='5418'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='5419'>
<a name='5420'>
      INTEGER icoord, jcoord, idim_cd, jdim_cd<a name='5421'>
      INTEGER local_comm, myproc, nproc, ioffset<a name='5422'>
      INTEGER iparstrt, jparstrt, sw, thisdomain_max_halo_width<a name='5423'>
      REAL    nest_influence<a name='5424'>
<a name='5425'>
      character*256 :: timestr<a name='5426'>
      integer ierr<a name='5427'>
<a name='5428'>
      LOGICAL, EXTERNAL  :: cd_feedback_mask<a name='5429'>
<a name='5430'>
<font color=#447700>!cyl: add variables for trajectory<a name='5431'></font>
      integer tjk<a name='5432'>
<a name='5433'>
<font color=#447700>! On entry to this routine, <a name='5434'></font>
<font color=#447700>!  "grid" refers to the parent domain<a name='5435'></font>
<font color=#447700>!  "intermediate_grid" refers to local copy of parent domain that overlies this patch of nest<a name='5436'></font>
<font color=#447700>!  "ngrid" refers to the nest, which is only needed for smoothing on the parent because <a name='5437'></font>
<font color=#447700>!          the nest feedback data has already been transferred during em_nest_feedbackup_interp<a name='5438'></font>
<font color=#447700>!          in part1, above.<a name='5439'></font>
<font color=#447700>! The way these settings c and n dimensions are set, below, looks backwards but from the point <a name='5440'></font>
<font color=#447700>! of view of the RSL routine rsl_lite_to_parent_info(), call to which is included by <a name='5441'></font>
<font color=#447700>! em_nest_feedbackup_pack, the "n" domain represents the parent domain and the "c" domain<a name='5442'></font>
<font color=#447700>! represents the intermediate domain. The backwards lookingness should be fixed in the gen_comms.c<a name='5443'></font>
<font color=#447700>! registry routine that accompanies RSL_LITE but, just as it's sometimes easier to put up a road<a name='5444'></font>
<font color=#447700>! sign that says "DIP" than fix the dip,  at this point it was easier just to write this comment. JM<a name='5445'></font>
<font color=#447700>!<a name='5446'></font>
      nest_influence = 1.<a name='5447'>
<a name='5448'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_11">( grid, current_timestr=timestr )<a name='5449'>
<a name='5450'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_55"> (  intermediate_grid ,                   &amp;<a name='5451'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5452'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5453'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='5454'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_56"> (  grid ,              &amp;<a name='5455'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5456'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5457'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='5458'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_57"> (  ngrid ,              &amp;<a name='5459'>
                                xids, xide, xjds, xjde, xkds, xkde,    &amp;<a name='5460'>
                                xims, xime, xjms, xjme, xkms, xkme,    &amp;<a name='5461'>
                                xips, xipe, xjps, xjpe, xkps, xkpe    )<a name='5462'>
<a name='5463'>
      ips_save = ngrid%i_parent_start   <font color=#447700>! used in feedback_domain_em_part2 below<a name='5464'></font>
      jps_save = ngrid%j_parent_start<a name='5465'>
      ipe_save = ngrid%i_parent_start + (xide-xids+1) / ngrid%parent_grid_ratio - 1<a name='5466'>
      jpe_save = ngrid%j_parent_start + (xjde-xjds+1) / ngrid%parent_grid_ratio - 1<a name='5467'>
<a name='5468'>
<a name='5469'>
<a name='5470'>
<a name='5471'>
IF ( ngrid%active_this_task ) THEN<a name='5472'>
<font color=#447700>!cyl add this for trajectory<a name='5473'></font>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_5">( ngrid%id )<a name='5474'>
<a name='5475'>
    do tjk = 1,config_flags%num_traj<a name='5476'>
     if (ngrid%traj_long(tjk) .eq. -9999.0) then<a name='5477'>
<font color=#447700>!       print*,'n=-9999',tjk<a name='5478'></font>
        ngrid%traj_long(tjk)=grid%traj_long(tjk)<a name='5479'>
        ngrid%traj_k(tjk)=grid%traj_k(tjk)<a name='5480'>
     else<a name='5481'>
<font color=#447700>!       print*,'p!=-9999',tjk<a name='5482'></font>
        grid%traj_long(tjk)=ngrid%traj_long(tjk)<a name='5483'>
        grid%traj_k(tjk)=ngrid%traj_k(tjk)<a name='5484'>
     endif<a name='5485'>
     if (ngrid%traj_lat(tjk) .eq. -9999.0) then<a name='5486'>
         ngrid%traj_lat(tjk)=grid%traj_lat(tjk)<a name='5487'>
         ngrid%traj_k(tjk)=grid%traj_k(tjk)<a name='5488'>
     else<a name='5489'>
         grid%traj_lat(tjk)=ngrid%traj_lat(tjk)<a name='5490'>
         grid%traj_k(tjk)=ngrid%traj_k(tjk)<a name='5491'>
     endif<a name='5492'>
    enddo<a name='5493'>
<font color=#447700>!endcyl<a name='5494'></font>
<a name='5495'>
      CALL nl_get_i_parent_start ( intermediate_grid%id, iparstrt )<a name='5496'>
      CALL nl_get_j_parent_start ( intermediate_grid%id, jparstrt )<a name='5497'>
      CALL nl_get_shw            ( intermediate_grid%id, sw )<a name='5498'>
      icoord =    iparstrt - sw<a name='5499'>
      jcoord =    jparstrt - sw<a name='5500'>
      idim_cd = cide - cids + 1<a name='5501'>
      jdim_cd = cjde - cjds + 1<a name='5502'>
<a name='5503'>
      nlev  = ckde - ckds + 1<a name='5504'>
<a name='5505'>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_7"> ( grid%id , thisdomain_max_halo_width )<a name='5506'>
<a name='5507'>
      parent_grid =&gt; grid<a name='5508'>
      grid =&gt; ngrid<a name='5509'>
#include "<A href='../../html_code/include/nest_feedbackup_pack.inc.html'>nest_feedbackup_pack.inc</A>"<A NAME="nest_feedbackup_pack.inc_37"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5510'>
      grid =&gt; parent_grid<a name='5511'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_5"><a name='5512'>
<a name='5513'>
END IF<a name='5514'>
<a name='5515'>
<font color=#447700>!      CALL wrf_get_dm_communicator ( local_comm )<a name='5516'></font>
<font color=#447700>!      CALL wrf_get_myproc( myproc )<a name='5517'></font>
<font color=#447700>!      CALL wrf_get_nproc( nproc )<a name='5518'></font>
<a name='5519'>
      <font color=#447700>! determine which communicator and offset to use<a name='5520'></font>
      IF ( intercomm_active( grid%id ) ) THEN        <font color=#447700>! I am parent<a name='5521'></font>
        local_comm = mpi_comm_to_kid( which_kid(ngrid%id), grid%id )<a name='5522'>
        ioffset = nest_task_offsets(ngrid%id)<a name='5523'>
      ELSE IF ( intercomm_active( ngrid%id ) ) THEN  <font color=#447700>! I am nest<a name='5524'></font>
        local_comm = mpi_comm_to_mom( ngrid%id )<a name='5525'>
        ioffset = nest_task_offsets(ngrid%id)<a name='5526'>
      END IF<a name='5527'>
<a name='5528'>
      IF ( grid%active_this_task .OR. ngrid%active_this_task ) THEN<a name='5529'>
#ifndef STUBMPI<a name='5530'>
        CALL mpi_comm_rank(local_comm,myproc,ierr)<a name='5531'>
        CALL mpi_comm_size(local_comm,nproc,ierr)<a name='5532'>
#endif<a name='5533'>
<font color=#447700>!call tracebackqq()<a name='5534'></font>
        CALL rsl_lite_merge_msgs( myproc, nest_pes_x(grid%id)*nest_pes_y(grid%id),         &amp;<a name='5535'>
                                          nest_pes_x(ngrid%id)*nest_pes_y(ngrid%id),       &amp; <a name='5536'>
                                          ioffset, local_comm )<a name='5537'>
      END IF<a name='5538'>
<a name='5539'>
IF ( grid%active_this_task ) THEN<a name='5540'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_6">( grid%id )<a name='5541'>
<a name='5542'>
<a name='5543'>
#define NEST_INFLUENCE(A,B) A = B<a name='5544'>
#include "<A href='../../html_code/include/nest_feedbackup_unpack.inc.html'>nest_feedbackup_unpack.inc</A>"<A NAME="nest_feedbackup_unpack.inc_38"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5545'>
<a name='5546'>
      <font color=#447700>! smooth coarse grid<a name='5547'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_58"> (  ngrid,                           &amp;<a name='5548'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5549'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5550'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='5551'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_59"> (  grid ,              &amp;<a name='5552'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='5553'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='5554'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='5555'>
<a name='5556'>
#include "<A href='../../html_code/include/HALO_INTERP_UP.inc.html'>HALO_INTERP_UP.inc</A>"<A NAME="HALO_INTERP_UP.inc_39"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5557'>
<a name='5558'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_60"> (  grid ,                   &amp;<a name='5559'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5560'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5561'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='5562'>
<a name='5563'>
#include "<A href='../../html_code/include/nest_feedbackup_smooth.inc.html'>nest_feedbackup_smooth.inc</A>"<A NAME="nest_feedbackup_smooth.inc_40"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5564'>
<a name='5565'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_EM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_6"><a name='5566'>
END IF<a name='5567'>
<a name='5568'>
      RETURN<a name='5569'>
   END SUBROUTINE feedback_domain_em_part2<a name='5570'>
#endif<a name='5571'>
<a name='5572'>
#if ( NMM_CORE == 1 &amp;&amp; NMM_NEST == 1 )<a name='5573'>
<font color=#447700>!==============================================================================<a name='5574'></font>
<font color=#447700>! NMM nesting infrastructure extended from EM core. This is gopal's doing.<a name='5575'></font>
<font color=#447700>!==============================================================================<a name='5576'></font>
<a name='5577'>
<A NAME='BEFORE_INTERP_HALOS_NMM'><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5578'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>before_interp_halos_nmm</font>(grid,config_flags &amp; <A href='../../call_to/BEFORE_INTERP_HALOS_NMM.html' TARGET='index'>1</A>,<A href='../../call_from/BEFORE_INTERP_HALOS_NMM.html' TARGET='index'>8</A><a name='5579'>
<font color=#447700>!<a name='5580'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_41"><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5581'>
<font color=#447700>!<a name='5582'></font>
      )<a name='5583'>
     <font color=#447700>! This is called before interp_domain_nmm_part1 to do<a name='5584'></font>
     <font color=#447700>! pre-interpolation halo communication on the nest.<a name='5585'></font>
     <font color=#447700>! Author: Sam Trahan, February 2011<a name='5586'></font>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_53"><a name='5587'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_118">, ONLY : domain, get_ijk_from_grid<a name='5588'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_75">, ONLY : grid_config_rec_type<a name='5589'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_107">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='5590'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width,  &amp;<a name='5591'>
                            nest_pes_x, nest_pes_y <font color=#447700>!,                                         &amp;<a name='5592'></font>
                             <font color=#447700>!push_communicators_for_domain, pop_communicators_for_domain<a name='5593'></font>
      USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_25">, ONLY : HALO_NMM_WEIGHTS_sub<a name='5594'>
<a name='5595'>
      IMPLICIT NONE<a name='5596'>
<font color=#447700>!<a name='5597'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5598'></font>
      TYPE (grid_config_rec_type)            :: config_flags<a name='5599'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_42"><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5600'>
     INTEGER :: IDS,IDE,JDS,JDE,KDS,KDE, &amp;<a name='5601'>
                IMS,IME,JMS,JME,KMS,KME, &amp;<a name='5602'>
                IPS,IPE,JPS,JPE,KPS,KPE<a name='5603'>
<a name='5604'>
<font color=#447700>!#ifdef DEREF_KLUDGE<a name='5605'></font>
<font color=#447700>!!  see http://www.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='5606'></font>
<font color=#447700>!   INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='5607'></font>
<font color=#447700>!   INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='5608'></font>
<font color=#447700>!   INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='5609'></font>
<font color=#447700>!#endif<a name='5610'></font>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_43"><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5611'>
<a name='5612'>
<font color=#447700>!#define COPY_IN<a name='5613'></font>
<a name='5614'>
     <font color=#447700>! FIXME: Don't initialize these to -1; it is a waste.<a name='5615'></font>
     <font color=#447700>! Initialization is only for debugging purposes.<a name='5616'></font>
      IDS=-1; IDE=-1; JDS=-1; JDE=-1; KDS=-1; KDE=-1<a name='5617'>
      IMS=-1; IME=-1; JMS=-1; JME=-1; KMS=-1; KME=-1<a name='5618'>
      IPS=-1; IPE=-1; JPS=-1; JPE=-1; KPS=-1; KPE=-1<a name='5619'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>GET_IJK_FROM_GRID</A><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_61">(GRID                                       &amp;<a name='5620'>
     &amp;                      ,IDS,IDE,JDS,JDE,KDS,KDE                    &amp;<a name='5621'>
     &amp;                      ,IMS,IME,JMS,JME,KMS,KME                    &amp;<a name='5622'>
     &amp;                      ,IPS,IPE,JPS,JPE,KPS,KPE )<a name='5623'>
<a name='5624'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_7">(grid%id)<a name='5625'>
#include "<A href='../../html_code/include/HALO_NMM_WEIGHTS.inc.html'>HALO_NMM_WEIGHTS.inc</A>"<A NAME="HALO_NMM_WEIGHTS.inc_44"><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5626'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#BEFORE_INTERP_HALOS_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_7"><a name='5627'>
<a name='5628'>
   END SUBROUTINE before_interp_halos_nmm<a name='5629'>
<a name='5630'>
<A NAME='INTERP_DOMAIN_NMM_PART1'><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5631'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_domain_nmm_part1</font> ( grid, intermediate_grid, ngrid, config_flags    &amp; <A href='../../call_to/INTERP_DOMAIN_NMM_PART1.html' TARGET='index'>1</A>,<A href='../../call_from/INTERP_DOMAIN_NMM_PART1.html' TARGET='index'>13</A><a name='5632'>
<font color=#447700>!<a name='5633'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_45"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5634'>
<font color=#447700>!<a name='5635'></font>
                 )<a name='5636'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_54"><a name='5637'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_119">, ONLY : domain, get_ijk_from_grid<a name='5638'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_76">, ONLY : grid_config_rec_type<a name='5639'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_108">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='5640'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width,  &amp;<a name='5641'>
                            nest_pes_x, nest_pes_y<a name='5642'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_109">, ONLY : ntasks, ntasks_x, ntasks_y, local_communicator, mytask, &amp;<a name='5643'>
                            nest_pes_x, nest_pes_y,                                 &amp;<a name='5644'>
                            intercomm_active, nest_task_offsets,                    &amp;<a name='5645'>
                            mpi_comm_to_mom, mpi_comm_to_kid, which_kid <font color=#447700>!,            &amp;<a name='5646'></font>
                             <font color=#447700>!push_communicators_for_domain,pop_communicators_for_domain<a name='5647'></font>
<a name='5648'>
      USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_22"><a name='5649'>
      IMPLICIT NONE<a name='5650'>
<font color=#447700>!<a name='5651'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5652'></font>
      TYPE(domain), POINTER :: intermediate_grid<a name='5653'>
      TYPE(domain), POINTER :: ngrid<a name='5654'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_46"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5655'>
      INTEGER nlev, msize<a name='5656'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='5657'>
      INTEGER iparstrt,jparstrt,sw<a name='5658'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='5659'>
      REAL xv(2000)<a name='5660'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5661'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5662'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='5663'>
      INTEGER       ::          iids, iide, ijds, ijde, ikds, ikde,    &amp;<a name='5664'>
                                iims, iime, ijms, ijme, ikms, ikme,    &amp;<a name='5665'>
                                iips, iipe, ijps, ijpe, ikps, ikpe<a name='5666'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5667'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5668'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='5669'>
<a name='5670'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='5671'>
      LOGICAL feedback_flag, feedback_flag_v<a name='5672'>
      INTEGER icoord, jcoord, idim_cd, jdim_cd, pgr<a name='5673'>
      INTEGER local_comm, ioffset, myproc, nproc, ierr<a name='5674'>
      INTEGER thisdomain_max_halo_width<a name='5675'>
<a name='5676'>
      LOGICAL interp_mp<a name='5677'>
      interp_mp=grid%interp_mp .or. ngrid%interp_mp<a name='5678'>
<a name='5679'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_40"> ( local_comm )<a name='5680'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_14">( myproc )<a name='5681'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_7">( nproc )<a name='5682'>
<a name='5683'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_62"> (  grid ,                   &amp;<a name='5684'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5685'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5686'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='5687'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_63"> (  intermediate_grid ,              &amp;<a name='5688'>
                                iids, iide, ijds, ijde, ikds, ikde,    &amp;<a name='5689'>
                                iims, iime, ijms, ijme, ikms, ikme,    &amp;<a name='5690'>
                                iips, iipe, ijps, ijpe, ikps, ikpe    )<a name='5691'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_64"> (  ngrid ,              &amp;<a name='5692'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5693'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5694'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='5695'>
<a name='5696'>
      CALL nl_get_parent_grid_ratio ( ngrid%id, pgr )<a name='5697'>
      CALL nl_get_i_parent_start ( intermediate_grid%id, iparstrt )<a name='5698'>
      CALL nl_get_j_parent_start ( intermediate_grid%id, jparstrt )<a name='5699'>
      CALL nl_get_shw            ( intermediate_grid%id, sw )<a name='5700'>
      icoord =    iparstrt - sw<a name='5701'>
      jcoord =    jparstrt - sw<a name='5702'>
      idim_cd = iide - iids + 1<a name='5703'>
      jdim_cd = ijde - ijds + 1<a name='5704'>
<a name='5705'>
      nlev  = ckde - ckds + 1<a name='5706'>
<a name='5707'>
      <font color=#447700>! get max_halo_width for parent. It may be smaller if it is moad<a name='5708'></font>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_8"> ( ngrid%id , thisdomain_max_halo_width )<a name='5709'>
<a name='5710'>
      IF ( grid%active_this_task ) THEN<a name='5711'>
#include "<A href='../../html_code/include/nest_interpdown_pack.inc.html'>nest_interpdown_pack.inc</A>"<A NAME="nest_interpdown_pack.inc_47"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5712'>
      END IF<a name='5713'>
<a name='5714'>
      <font color=#447700>! determine which communicator and offset to use<a name='5715'></font>
      IF ( intercomm_active( grid%id ) ) THEN        <font color=#447700>! I am parent<a name='5716'></font>
        local_comm = mpi_comm_to_kid( which_kid(ngrid%id), grid%id )<a name='5717'>
        ioffset = nest_task_offsets(ngrid%id)<a name='5718'>
      ELSE IF ( intercomm_active( ngrid%id ) ) THEN  <font color=#447700>! I am nest<a name='5719'></font>
        local_comm = mpi_comm_to_mom( ngrid%id )<a name='5720'>
        ioffset = nest_task_offsets(ngrid%id)<a name='5721'>
      END IF<a name='5722'>
<a name='5723'>
      IF ( grid%active_this_task .OR. ngrid%active_this_task ) THEN<a name='5724'>
#ifndef STUBMPI<a name='5725'>
        CALL mpi_comm_rank(local_comm,myproc,ierr)<a name='5726'>
        CALL mpi_comm_size(local_comm,nproc,ierr)<a name='5727'>
#endif<a name='5728'>
<font color=#447700>!CALL tracebackqq()<a name='5729'></font>
        CALL rsl_lite_bcast_msgs( myproc, nest_pes_x(grid%id)*nest_pes_y(grid%id),         &amp;<a name='5730'>
                                        nest_pes_x(ngrid%id)*nest_pes_y(ngrid%id),       &amp; <a name='5731'>
                                        ioffset, local_comm )<a name='5732'>
      END IF<a name='5733'>
<a name='5734'>
      RETURN<a name='5735'>
   END SUBROUTINE interp_domain_nmm_part1<a name='5736'>
<a name='5737'>
<font color=#447700>!------------------------------------------------------------------<a name='5738'></font>
<a name='5739'>
<A NAME='INTERP_DOMAIN_NMM_PART2'><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5740'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>interp_domain_nmm_part2</font> ( grid, ngrid, config_flags    &amp; <A href='../../call_to/INTERP_DOMAIN_NMM_PART2.html' TARGET='index'>1</A>,<A href='../../call_from/INTERP_DOMAIN_NMM_PART2.html' TARGET='index'>12</A><a name='5741'>
<font color=#447700>!<a name='5742'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_48"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5743'>
<font color=#447700>!<a name='5744'></font>
                 )<a name='5745'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_55"><a name='5746'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_120">, ONLY : domain, get_ijk_from_grid<a name='5747'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_77">, ONLY : grid_config_rec_type<a name='5748'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_110">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='5749'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width ,  &amp;<a name='5750'>
                            nest_task_offsets<a name='5751'>
                             <font color=#447700>!push_communicators_for_domain,pop_communicators_for_domain,     &amp;<a name='5752'></font>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_6">, ONLY : halo_interp_down_sub<a name='5753'>
      IMPLICIT NONE<a name='5754'>
<font color=#447700>!<a name='5755'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5756'></font>
      TYPE(domain), POINTER :: ngrid<a name='5757'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_49"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5758'>
      INTEGER nlev, msize<a name='5759'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='5760'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='5761'>
      REAL xv(2000)<a name='5762'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5763'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5764'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='5765'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5766'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5767'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='5768'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='5769'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='5770'>
                                ips, ipe, jps, jpe, kps, kpe<a name='5771'>
<a name='5772'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='5773'>
      LOGICAL feedback_flag, feedback_flag_v<a name='5774'>
      INTEGER myproc<a name='5775'>
      INTEGER ierr<a name='5776'>
<a name='5777'>
      integer, parameter :: EConst=0, ECopy=1, EExtrap=2 <font color=#447700>! MUST match module_interp_nmm<a name='5778'></font>
      LOGICAL interp_mp<a name='5779'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_50"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5780'>
<a name='5781'>
<font color=#447700>! interp_mp is set unconditionally in alloc_and_configure_domain (module_domain.F), <a name='5782'></font>
<font color=#447700>! regardless of active_this_task<a name='5783'></font>
      interp_mp=grid%interp_mp .or. ngrid%interp_mp<a name='5784'>
<a name='5785'>
      IF ( ngrid%active_this_task ) THEN<a name='5786'>
<a name='5787'>
        CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_65"> (  grid ,                   &amp;<a name='5788'>
                                  cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5789'>
                                  cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5790'>
                                  cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='5791'>
        CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_66"> (  ngrid ,              &amp;<a name='5792'>
                                  nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5793'>
                                  nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5794'>
                                  nips, nipe, njps, njpe, nkps, nkpe    )<a name='5795'>
<a name='5796'>
<a name='5797'>
        nlev  = ckde - ckds + 1 <a name='5798'>
<a name='5799'>
#include "<A href='../../html_code/include/nest_interpdown_unpack.inc.html'>nest_interpdown_unpack.inc</A>"<A NAME="nest_interpdown_unpack.inc_51"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5800'>
<a name='5801'>
        CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_67"> (  grid ,              &amp;<a name='5802'>
                                  ids, ide, jds, jde, kds, kde,    &amp;<a name='5803'>
                                  ims, ime, jms, jme, kms, kme,    &amp;<a name='5804'>
                                  ips, ipe, jps, jpe, kps, kpe    )<a name='5805'>
<a name='5806'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_8">( grid%id )<a name='5807'>
#include "<A href='../../html_code/include/HALO_INTERP_DOWN.inc.html'>HALO_INTERP_DOWN.inc</A>"<A NAME="HALO_INTERP_DOWN.inc_52"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5808'>
<a name='5809'>
      <font color=#447700>! Generate interpolation information and interpolate Q, T and<a name='5810'></font>
      <font color=#447700>! possibly PD while we're at it:<a name='5811'></font>
<a name='5812'>
<font color=#447700>! Grid is set to ngrid%intermediate_grid in the call from med_interp_domain<a name='5813'></font>
<font color=#447700>! (share/mediation_interp_domain.F) so if one is active_this_task, so is the other<a name='5814'></font>
        call <A href='../../html_code/share/module_interp_store.F.html#STORE_INTERP_INFO'>store_interp_info</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_INTERP_INFO_1">(ngrid,grid)<a name='5815'>
        call <A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2N_FULLDOM'>ext_c2n_fulldom</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_C2N_FULLDOM_1">(ngrid%IIH,ngrid%JJH,ngrid%HBWGT1, &amp;<a name='5816'>
             ngrid%HBWGT2,ngrid%HBWGT3,ngrid%HBWGT4,         &amp;<a name='5817'>
             ngrid%deta1,ngrid%deta2,ngrid%eta1,             &amp;<a name='5818'>
             ngrid%eta2,ngrid%pt,ngrid%pdtop,                &amp;<a name='5819'>
             grid%pint,grid%t,grid%pd,grid%q,       &amp;<a name='5820'>
             cims, cime, cjms, cjme, ckms, ckme,             &amp;<a name='5821'>
             ngrid%pint,ngrid%t,ngrid%pd,ngrid%q,&amp;<a name='5822'>
             ngrid%iinfo,ngrid%winfo,ngrid%imask_nostag, &amp;<a name='5823'>
             nids, nide, njds, njde, nkds, nkde,             &amp;<a name='5824'>
             nims, nime, njms, njme, nkms, nkme,             &amp;<a name='5825'>
             nips, nipe, njps, njpe, nkps, nkpe)<a name='5826'>
<a name='5827'>
#include "<A href='../../html_code/include/nest_interpdown_interp.inc.html'>nest_interpdown_interp.inc</A>"<A NAME="nest_interpdown_interp.inc_53"><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5828'>
<a name='5829'>
<a name='5830'>
        CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#INTERP_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_8"><a name='5831'>
<a name='5832'>
      END IF<a name='5833'>
<a name='5834'>
      RETURN<a name='5835'>
   END SUBROUTINE interp_domain_nmm_part2<a name='5836'>
<a name='5837'>
<font color=#447700>!------------------------------------------------------------------<a name='5838'></font>
<a name='5839'>
<A NAME='FORCE_DOMAIN_NMM_PART1'><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5840'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>force_domain_nmm_part1</font> ( grid, intermediate_grid, ngrid, config_flags    &amp; <A href='../../call_to/FORCE_DOMAIN_NMM_PART1.html' TARGET='index'>1</A>,<A href='../../call_from/FORCE_DOMAIN_NMM_PART1.html' TARGET='index'>12</A><a name='5841'>
<font color=#447700>!<a name='5842'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_54"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5843'>
<font color=#447700>!<a name='5844'></font>
                 )<a name='5845'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_56"><a name='5846'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_121">, ONLY : domain, get_ijk_from_grid<a name='5847'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_78">, ONLY : grid_config_rec_type<a name='5848'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_111">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='5849'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width,  &amp;<a name='5850'>
                            nest_pes_x, nest_pes_y,                                 &amp;<a name='5851'>
                            intercomm_active, nest_task_offsets,                    &amp;<a name='5852'>
                            mpi_comm_to_mom, mpi_comm_to_kid, which_kid <font color=#447700>!,            &amp;<a name='5853'></font>
                            <font color=#447700>!push_communicators_for_domain,pop_communicators_for_domain<a name='5854'></font>
<a name='5855'>
      USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_23"><a name='5856'>
      IMPLICIT NONE<a name='5857'>
<font color=#447700>!<a name='5858'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5859'></font>
      TYPE(domain), POINTER :: intermediate_grid<a name='5860'>
      TYPE(domain), POINTER :: ngrid<a name='5861'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_55"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5862'>
      INTEGER nlev, msize<a name='5863'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='5864'>
      INTEGER iparstrt,jparstrt,sw<a name='5865'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='5866'>
      REAL xv(2000)<a name='5867'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5868'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5869'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='5870'>
      INTEGER       ::          iids, iide, ijds, ijde, ikds, ikde,    &amp;<a name='5871'>
                                iims, iime, ijms, ijme, ikms, ikme,    &amp;<a name='5872'>
                                iips, iipe, ijps, ijpe, ikps, ikpe<a name='5873'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5874'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5875'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='5876'>
<a name='5877'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='5878'>
      LOGICAL feedback_flag, feedback_flag_v<a name='5879'>
      INTEGER icoord, jcoord, idim_cd, jdim_cd, pgr<a name='5880'>
      INTEGER local_comm, ioffset, myproc, nproc, ierr<a name='5881'>
      INTEGER thisdomain_max_halo_width<a name='5882'>
      LOGICAL interp_mp<a name='5883'>
<a name='5884'>
      interp_mp=grid%interp_mp .or. ngrid%interp_mp<a name='5885'>
<a name='5886'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_41"> ( local_comm )<a name='5887'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_15">( myproc )<a name='5888'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_8">( nproc )<a name='5889'>
<a name='5890'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_68"> (  grid ,                   &amp;<a name='5891'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5892'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5893'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='5894'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_69"> (  intermediate_grid ,              &amp;<a name='5895'>
                                iids, iide, ijds, ijde, ikds, ikde,    &amp;<a name='5896'>
                                iims, iime, ijms, ijme, ikms, ikme,    &amp;<a name='5897'>
                                iips, iipe, ijps, ijpe, ikps, ikpe    )<a name='5898'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_70"> (  ngrid ,              &amp;<a name='5899'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5900'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5901'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='5902'>
<a name='5903'>
      CALL nl_get_parent_grid_ratio ( ngrid%id, pgr )<a name='5904'>
      CALL nl_get_i_parent_start ( intermediate_grid%id, iparstrt )<a name='5905'>
      CALL nl_get_j_parent_start ( intermediate_grid%id, jparstrt )<a name='5906'>
      CALL nl_get_shw            ( intermediate_grid%id, sw )<a name='5907'>
      icoord =    iparstrt - sw<a name='5908'>
      jcoord =    jparstrt - sw<a name='5909'>
      idim_cd = iide - iids + 1<a name='5910'>
      jdim_cd = ijde - ijds + 1<a name='5911'>
<a name='5912'>
      nlev  = ckde - ckds + 1<a name='5913'>
<a name='5914'>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_9"> ( ngrid%id , thisdomain_max_halo_width )<a name='5915'>
<a name='5916'>
      IF ( grid%active_this_task ) THEN<a name='5917'>
#include "<A href='../../html_code/include/nest_forcedown_pack.inc.html'>nest_forcedown_pack.inc</A>"<A NAME="nest_forcedown_pack.inc_56"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5918'>
      END IF<a name='5919'>
<a name='5920'>
      <font color=#447700>! determine which communicator and offset to use<a name='5921'></font>
      IF ( intercomm_active( grid%id ) ) THEN        <font color=#447700>! I am parent<a name='5922'></font>
        local_comm = mpi_comm_to_kid( which_kid(ngrid%id), grid%id )<a name='5923'>
        ioffset = nest_task_offsets(ngrid%id)<a name='5924'>
      ELSE IF ( intercomm_active( ngrid%id ) ) THEN  <font color=#447700>! I am nest<a name='5925'></font>
        local_comm = mpi_comm_to_mom( ngrid%id )<a name='5926'>
        ioffset = nest_task_offsets(ngrid%id)<a name='5927'>
      END IF<a name='5928'>
<a name='5929'>
      IF ( grid%active_this_task .OR. ngrid%active_this_task ) THEN<a name='5930'>
#ifndef STUBMPI<a name='5931'>
        CALL mpi_comm_rank(local_comm,myproc,ierr)<a name='5932'>
        CALL mpi_comm_size(local_comm,nproc,ierr)<a name='5933'>
#endif<a name='5934'>
        CALL rsl_lite_bcast_msgs( myproc, nest_pes_x(grid%id)*nest_pes_y(grid%id),         &amp;<a name='5935'>
                                        nest_pes_x(ngrid%id)*nest_pes_y(ngrid%id),       &amp; <a name='5936'>
                                        ioffset, local_comm )<a name='5937'>
      END IF<a name='5938'>
<a name='5939'>
      RETURN<a name='5940'>
      END SUBROUTINE force_domain_nmm_part1<a name='5941'>
<a name='5942'>
<font color=#447700>!==============================================================================================<a name='5943'></font>
<a name='5944'>
<A NAME='FORCE_DOMAIN_NMM_PART2'><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5945'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>force_domain_nmm_part2</font> ( grid, ngrid, config_flags    &amp; <A href='../../call_to/FORCE_DOMAIN_NMM_PART2.html' TARGET='index'>1</A>,<A href='../../call_from/FORCE_DOMAIN_NMM_PART2.html' TARGET='index'>20</A><a name='5946'>
<font color=#447700>!<a name='5947'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_57"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5948'>
<font color=#447700>!<a name='5949'></font>
                 )<a name='5950'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_57"><a name='5951'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_122">, ONLY : domain, get_ijk_from_grid<a name='5952'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_79">, ONLY : grid_config_rec_type<a name='5953'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_112">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='5954'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width,  &amp;<a name='5955'>
                            nest_pes_x, nest_pes_y <font color=#447700>!,                                         &amp;<a name='5956'></font>
                             <font color=#447700>!push_communicators_for_domain,pop_communicators_for_domain<a name='5957'></font>
<a name='5958'>
#if (NMM_NEST == 1)<a name='5959'>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_7">, ONLY : halo_force_down_sub<a name='5960'>
      use <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_26">, only: HALO_NMM_INTERP_INFO_sub<a name='5961'>
# if ( HWRF == 1 )<a name='5962'>
      use <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_27">, only: HALO_NMM_FORCE_DOWN_SST_sub<a name='5963'>
# endif<a name='5964'>
#endif<a name='5965'>
      IMPLICIT NONE<a name='5966'>
<font color=#447700>!<a name='5967'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='5968'></font>
      TYPE(domain), POINTER :: ngrid,cgrid<a name='5969'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_58"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5970'>
      INTEGER nlev, msize<a name='5971'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='5972'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='5973'>
      REAL xv(2000)<a name='5974'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5975'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5976'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='5977'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='5978'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='5979'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='5980'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='5981'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='5982'>
                                ips, ipe, jps, jpe, kps, kpe<a name='5983'>
<a name='5984'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='5985'>
      REAL  dummy_xs, dummy_xe, dummy_ys, dummy_ye<a name='5986'>
      LOGICAL feedback_flag, feedback_flag_v<a name='5987'>
<a name='5988'>
      LOGICAL interp_mp<a name='5989'>
      integer, parameter :: EConst=0, ECopy=1, EExtrap=2 <font color=#447700>! MUST match module_interp_nmm<a name='5990'></font>
<a name='5991'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_59"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5992'>
      interp_mp=grid%interp_mp .or. ngrid%interp_mp<a name='5993'>
<a name='5994'>
IF ( ngrid%active_this_task ) THEN<a name='5995'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_71"> (  grid ,                   &amp;<a name='5996'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='5997'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='5998'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='5999'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_72"> (  ngrid ,              &amp;<a name='6000'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='6001'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='6002'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='6003'>
<a name='6004'>
<font color=#447700>!jm as far as I can tell, grid is ngrid%intermediate_domain, so they <a name='6005'></font>
<font color=#447700>!jm should both have the same id, both be active_this_task (if one is)<a name='6006'></font>
<font color=#447700>!jm and use the same communicator.  But just to be safe, some extra<a name='6007'></font>
<font color=#447700>!jm pushes and pops of domain communicators littered here.<a name='6008'></font>
<a name='6009'>
      cgrid=&gt;grid<a name='6010'>
      nlev  = ckde - ckds + 1<a name='6011'>
<a name='6012'>
#include "<A href='../../html_code/include/nest_forcedown_unpack.inc.html'>nest_forcedown_unpack.inc</A>"<A NAME="nest_forcedown_unpack.inc_60"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6013'>
<a name='6014'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_73"> (  grid ,              &amp;<a name='6015'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='6016'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6017'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='6018'>
<a name='6019'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_9">( grid%id )<a name='6020'>
<a name='6021'>
#if ( HWRF == 1 )<a name='6022'>
        IF(ngrid%force_sst(1) == 1) then<a name='6023'>
# include "<A href='../../html_code/include/HALO_NMM_FORCE_DOWN_SST.inc.html'>HALO_NMM_FORCE_DOWN_SST.inc</A>"<A NAME="HALO_NMM_FORCE_DOWN_SST.inc_61"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6024'>
        END IF<a name='6025'>
#endif<a name='6026'>
<a name='6027'>
#include "<A href='../../html_code/include/HALO_FORCE_DOWN.inc.html'>HALO_FORCE_DOWN.inc</A>"<A NAME="HALO_FORCE_DOWN.inc_62"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6028'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_9"><a name='6029'>
<a name='6030'>
      call <A href='../../html_code/share/module_interp_store.F.html#STORE_INTERP_INFO'>store_interp_info</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_INTERP_INFO_2">(ngrid,grid)<a name='6031'>
<a name='6032'>
<a name='6033'>
      call <A href='../../html_code/share/module_interp_nmm.F.html#EXT_C2B_FULLDOM'>ext_c2b_fulldom</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_C2B_FULLDOM_1">(ngrid%IIH,ngrid%JJH,ngrid%HBWGT1, &amp;<a name='6034'>
           ngrid%HBWGT2,ngrid%HBWGT3,ngrid%HBWGT4,         &amp;<a name='6035'>
           ngrid%deta1,ngrid%deta2,ngrid%eta1,             &amp;<a name='6036'>
           ngrid%eta2,ngrid%pt,ngrid%pdtop,                &amp;<a name='6037'>
           grid%pint,grid%t,grid%pd,grid%q,                &amp;<a name='6038'>
           cims, cime, cjms, cjme, ckms, ckme,             &amp;<a name='6039'>
           nids, nide, njds, njde, nkds, nkde,             &amp;<a name='6040'>
           nims, nime, njms, njme, nkms, nkme,             &amp;<a name='6041'>
           nips, nipe, njps, njpe, nkps, nkpe,             &amp;<a name='6042'>
           ngrid%iinfo_bxs, ngrid%iinfo_bxe,               &amp;<a name='6043'>
           ngrid%iinfo_bys, ngrid%iinfo_bye,               &amp;<a name='6044'>
           ngrid%winfo_bxs, ngrid%winfo_bxe,               &amp;<a name='6045'>
           ngrid%winfo_bys, ngrid%winfo_bye,               &amp;<a name='6046'>
           ngrid%pd_bxs, ngrid%pd_bxe,             &amp;<a name='6047'>
           ngrid%pd_bys, ngrid%pd_bye,             &amp;<a name='6048'>
           ngrid%t_bxs, ngrid%t_bxe,               &amp;<a name='6049'>
           ngrid%t_bys, ngrid%t_bye,               &amp;<a name='6050'>
           ngrid%q_bxs, ngrid%q_bxe,               &amp;<a name='6051'>
           ngrid%q_bys, ngrid%q_bye)<a name='6052'>
<a name='6053'>
      <font color=#447700>! Need a halo for interpolation information due to how V grid<a name='6054'></font>
      <font color=#447700>! interpolation works:<a name='6055'></font>
      grid=&gt;ngrid<a name='6056'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_74"> (  grid ,              &amp;<a name='6057'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='6058'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6059'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='6060'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_10">( grid%id )<a name='6061'>
#include "<A href='../../html_code/include/HALO_NMM_INTERP_INFO.inc.html'>HALO_NMM_INTERP_INFO.inc</A>"<A NAME="HALO_NMM_INTERP_INFO.inc_63"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6062'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_10"><a name='6063'>
<a name='6064'>
      grid=&gt;cgrid<a name='6065'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_75"> (  grid ,              &amp;<a name='6066'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='6067'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6068'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='6069'>
<a name='6070'>
<a name='6071'>
      <font color=#447700>! code here to interpolate the data into the nested domain<a name='6072'></font>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_11">( grid%id )<a name='6073'>
#include "<A href='../../html_code/include/nest_forcedown_interp.inc.html'>nest_forcedown_interp.inc</A>"<A NAME="nest_forcedown_interp.inc_64"><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6074'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_11"><a name='6075'>
<a name='6076'>
END IF<a name='6077'>
<a name='6078'>
      RETURN<a name='6079'>
   END SUBROUTINE force_domain_nmm_part2<a name='6080'>
<a name='6081'>
<font color=#447700>!================================================================================<a name='6082'></font>
<font color=#447700>!<a name='6083'></font>
<font color=#447700>! This routine exists only to call a halo on a domain (the nest)<a name='6084'></font>
<font color=#447700>! gets called from feedback_domain_em_part1, below.  This is needed<a name='6085'></font>
<font color=#447700>! because the halo code expects the fields being exchanged to have<a name='6086'></font>
<font color=#447700>! been dereferenced from the grid data structure, but in feedback_domain_em_part1<a name='6087'></font>
<font color=#447700>! the grid data structure points to the coarse domain, not the nest.<a name='6088'></font>
<font color=#447700>! And we want the halo exchange on the nest, so that the code in<a name='6089'></font>
<font color=#447700>! em_nest_feedbackup_interp.inc will work correctly on multi-p. JM 20040308<a name='6090'></font>
<font color=#447700>!<a name='6091'></font>
<a name='6092'>
<A NAME='FEEDBACK_NEST_PREP_NMM'><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6093'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>feedback_nest_prep_nmm</font> ( grid, config_flags    &amp; <A href='../../call_to/FEEDBACK_NEST_PREP_NMM.html' TARGET='index'>1</A>,<A href='../../call_from/FEEDBACK_NEST_PREP_NMM.html' TARGET='index'>9</A><a name='6094'>
<font color=#447700>!<a name='6095'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_65"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6096'>
<font color=#447700>!<a name='6097'></font>
)<a name='6098'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_58"><a name='6099'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_123">, ONLY : domain, get_ijk_from_grid<a name='6100'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_80">, ONLY : grid_config_rec_type<a name='6101'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_113">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='6102'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width,  &amp;<a name='6103'>
                            nest_pes_x, nest_pes_y<a name='6104'>
                            <font color=#447700>!push_communicators_for_domain, pop_communicators_for_domain,    &amp;<a name='6105'></font>
      USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_28">, ONLY : HALO_NMM_WEIGHTS_sub<a name='6106'>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_8">, ONLY : HALO_INTERP_UP_sub<a name='6107'>
<a name='6108'>
      IMPLICIT NONE<a name='6109'>
<font color=#447700>!<a name='6110'></font>
      TYPE(domain), TARGET :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='6111'></font>
      TYPE (grid_config_rec_type) :: config_flags <font color=#447700>! configureation flags, has vertical dim of<a name='6112'></font>
                                                  <font color=#447700>! soil temp, moisture, etc., has vertical dim<a name='6113'></font>
                                                  <font color=#447700>! of soil categories<a name='6114'></font>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_66"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6115'>
<a name='6116'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='6117'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6118'>
                                ips, ipe, jps, jpe, kps, kpe<a name='6119'>
<a name='6120'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='6121'>
<a name='6122'>
      INTEGER       :: idum1, idum2<a name='6123'>
      LOGICAL :: interp_mp<a name='6124'>
      interp_mp=.true.<a name='6125'>
<a name='6126'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_67"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6127'>
<a name='6128'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_76"> (  grid ,              &amp;<a name='6129'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='6130'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6131'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='6132'>
    IF ( grid%active_this_task ) THEN<a name='6133'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_12">( grid%id )<a name='6134'>
#ifdef DM_PARALLEL<a name='6135'>
#include "<A href='../../html_code/include/HALO_INTERP_UP.inc.html'>HALO_INTERP_UP.inc</A>"<A NAME="HALO_INTERP_UP.inc_68"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6136'>
#include "<A href='../../html_code/include/HALO_NMM_WEIGHTS.inc.html'>HALO_NMM_WEIGHTS.inc</A>"<A NAME="HALO_NMM_WEIGHTS.inc_69"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6137'>
#endif<a name='6138'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_12"><a name='6139'>
    END IF<a name='6140'>
<a name='6141'>
   END SUBROUTINE feedback_nest_prep_nmm<a name='6142'>
<a name='6143'>
<font color=#447700>!------------------------------------------------------------------<a name='6144'></font>
<a name='6145'>
<a name='6146'>
<font color=#447700>!==============================================================================================<a name='6147'></font>
<a name='6148'>
<A NAME='FORCE_INTERMEDIATE_NMM'><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6149'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>force_intermediate_nmm</font> ( grid, ngrid, config_flags    &amp;,<A href='../../call_from/FORCE_INTERMEDIATE_NMM.html' TARGET='index'>8</A><a name='6150'>
<font color=#447700>!<a name='6151'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_70"><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6152'>
<font color=#447700>!<a name='6153'></font>
                 )<a name='6154'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_59"><a name='6155'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_124">, ONLY : domain, get_ijk_from_grid<a name='6156'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_81">, ONLY : grid_config_rec_type<a name='6157'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_114">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='6158'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width<a name='6159'>
#if ( NMM_NEST == 1 )<a name='6160'>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_9">, ONLY : halo_force_down_sub<a name='6161'>
#endif<a name='6162'>
      IMPLICIT NONE<a name='6163'>
<font color=#447700>!<a name='6164'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='6165'></font>
      TYPE(domain), POINTER :: cgrid<a name='6166'>
      TYPE(domain), POINTER :: ngrid<a name='6167'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_71"><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6168'>
      INTEGER nlev, msize<a name='6169'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='6170'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='6171'>
      REAL xv(2000)<a name='6172'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='6173'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='6174'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='6175'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='6176'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='6177'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='6178'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='6179'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6180'>
                                ips, ipe, jps, jpe, kps, kpe<a name='6181'>
<a name='6182'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='6183'>
      REAL  dummy_xs, dummy_xe, dummy_ys, dummy_ye<a name='6184'>
      LOGICAL feedback_flag, feedback_flag_v<a name='6185'>
<a name='6186'>
integer myproc<a name='6187'>
      LOGICAL interp_mp<a name='6188'>
<a name='6189'>
<font color=#447700>!#ifdef DEREF_KLUDGE<a name='6190'></font>
<font color=#447700>!!  see http://www.mmm.ucar.edu/wrf/WG2/topics/deref_kludge.htm<a name='6191'></font>
<font color=#447700>!   INTEGER     :: sm31 , em31 , sm32 , em32 , sm33 , em33<a name='6192'></font>
<font color=#447700>!   INTEGER     :: sm31x, em31x, sm32x, em32x, sm33x, em33x<a name='6193'></font>
<font color=#447700>!   INTEGER     :: sm31y, em31y, sm32y, em32y, sm33y, em33y<a name='6194'></font>
<font color=#447700>!#endif<a name='6195'></font>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_72"><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6196'>
<a name='6197'>
      interp_mp=grid%interp_mp .or. ngrid%interp_mp<a name='6198'>
<a name='6199'>
<font color=#447700>!#define COPY_IN<a name='6200'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_77"> (  grid ,                   &amp;<a name='6201'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='6202'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='6203'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='6204'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_78"> (  ngrid ,              &amp;<a name='6205'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='6206'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='6207'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='6208'>
<a name='6209'>
      cgrid=&gt;grid<a name='6210'>
      nlev  = ckde - ckds + 1 <a name='6211'>
<a name='6212'>
#include "<A href='../../html_code/include/nest_interpdown_unpack.inc.html'>nest_interpdown_unpack.inc</A>"<A NAME="nest_interpdown_unpack.inc_73"><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6213'>
<a name='6214'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_79"> (  grid ,              &amp;<a name='6215'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='6216'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6217'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='6218'>
<a name='6219'>
#include "<A href='../../html_code/include/HALO_FORCE_DOWN.inc.html'>HALO_FORCE_DOWN.inc</A>"<A NAME="HALO_FORCE_DOWN.inc_74"><A href='../../html_code/frame/module_dm.F.html#FORCE_INTERMEDIATE_NMM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6220'>
<a name='6221'>
      RETURN<a name='6222'>
    END SUBROUTINE force_intermediate_nmm<a name='6223'>
<a name='6224'>
<font color=#447700>! ----------------------------------------------------------------------<a name='6225'></font>
<a name='6226'>
<A NAME='FEEDBACK_DOMAIN_NMM_PART1'><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6227'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>feedback_domain_nmm_part1</font> ( grid, ngrid, config_flags    &amp; <A href='../../call_to/FEEDBACK_DOMAIN_NMM_PART1.html' TARGET='index'>1</A>,<A href='../../call_from/FEEDBACK_DOMAIN_NMM_PART1.html' TARGET='index'>18</A><a name='6228'>
<font color=#447700>!<a name='6229'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_75"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6230'>
<font color=#447700>!<a name='6231'></font>
                 )<a name='6232'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_60"><a name='6233'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_125">, ONLY : domain, get_ijk_from_grid<a name='6234'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_82">, ONLY : grid_config_rec_type, model_config_rec, model_to_grid_config_rec<a name='6235'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_115">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask, &amp;<a name='6236'>
                            ipe_save, jpe_save, ips_save, jps_save, get_dm_max_halo_width,  &amp;<a name='6237'>
                            nest_pes_x, nest_pes_y<a name='6238'>
      IMPLICIT NONE<a name='6239'>
<font color=#447700>!<a name='6240'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='6241'></font>
      TYPE(domain), POINTER :: ngrid<a name='6242'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_76"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6243'>
      INTEGER nlev, msize, i_parent_start, j_parent_start<a name='6244'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='6245'>
      TYPE(domain), POINTER :: xgrid<a name='6246'>
      TYPE (grid_config_rec_type)            :: config_flags, nconfig_flags<a name='6247'>
      REAL xv(2000)<a name='6248'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='6249'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='6250'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='6251'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='6252'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='6253'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='6254'>
<a name='6255'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='6256'>
<a name='6257'>
      INTEGER local_comm, myproc, nproc, idum1, idum2<a name='6258'>
<a name='6259'>
      integer, parameter :: EConst=0, ECopy=1, EExtrap=2 <font color=#447700>! MUST match module_interp_nmm<a name='6260'></font>
<a name='6261'>
      LOGICAL interp_mp<a name='6262'>
<a name='6263'>
      INTERFACE<a name='6264'>
          SUBROUTINE feedback_nest_prep_nmm ( grid, config_flags    &amp;<a name='6265'>
<font color=#447700>!<a name='6266'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_77"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6267'>
<font color=#447700>!<a name='6268'></font>
)<a name='6269'>
             USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_61"><a name='6270'>
             USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_126">, ONLY : domain<a name='6271'>
             USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_83">, ONLY : grid_config_rec_type<a name='6272'>
<font color=#447700>!<a name='6273'></font>
             TYPE (grid_config_rec_type)            :: config_flags<a name='6274'>
             TYPE(domain), TARGET                   :: grid<a name='6275'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_78"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6276'>
          END SUBROUTINE feedback_nest_prep_nmm<a name='6277'>
      END INTERFACE<a name='6278'>
<font color=#447700>!<a name='6279'></font>
<a name='6280'>
      interp_mp=grid%interp_mp .or. ngrid%interp_mp<a name='6281'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_42"> ( local_comm )<a name='6282'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_16">( myproc )<a name='6283'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_9">( nproc )<a name='6284'>
<a name='6285'>
<a name='6286'>
<font color=#447700>!<a name='6287'></font>
<font color=#447700>! intermediate grid<a name='6288'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_80"> (  grid ,                   &amp;<a name='6289'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='6290'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='6291'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='6292'>
<font color=#447700>! nest grid<a name='6293'></font>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_81"> (  ngrid ,                  &amp;<a name='6294'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='6295'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='6296'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='6297'>
<a name='6298'>
      nlev  = ckde - ckds + 1<a name='6299'>
<a name='6300'>
      ips_save = ngrid%i_parent_start  <font color=#447700>! +1 not used in ipe_save &amp; jpe_save<a name='6301'></font>
      jps_save = ngrid%j_parent_start  <font color=#447700>!  because of one extra namelist point<a name='6302'></font>
      ipe_save = ngrid%i_parent_start + (nide-nids) / ngrid%parent_grid_ratio - 1<a name='6303'>
      jpe_save = ngrid%j_parent_start + (njde-njds) / ngrid%parent_grid_ratio - 1<a name='6304'>
<a name='6305'>
<font color=#447700>! feedback_nest_prep invokes a halo exchange on the ngrid. It is done this way<a name='6306'></font>
<font color=#447700>! in a separate routine because the HALOs need the data to be dereference from the<a name='6307'></font>
<font color=#447700>! grid data structure and, in this routine, the dereferenced fields are related to<a name='6308'></font>
<font color=#447700>! the intermediate domain, not the nest itself. Save the current grid pointer to intermediate<a name='6309'></font>
<font color=#447700>! domain, switch grid to point to ngrid, invoke feedback_nest_prep,  then restore grid<a name='6310'></font>
<font color=#447700>! to point to intermediate domain.<a name='6311'></font>
<a name='6312'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_14"> ( ngrid%id , model_config_rec , nconfig_flags )<a name='6313'>
      CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_5"> ( ngrid%id , idum1 , idum2 )<a name='6314'>
      xgrid =&gt; grid<a name='6315'>
      grid =&gt; ngrid<a name='6316'>
#include "<A href='../../html_code/include/deref_kludge.h.html'>deref_kludge.h</A>"<A NAME="deref_kludge.h_79"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6317'>
      CALL <A href='../../html_code/frame/module_dm.F.html#FEEDBACK_NEST_PREP_NMM'>feedback_nest_prep_nmm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FEEDBACK_NEST_PREP_NMM_1"> ( grid, config_flags    &amp;<a name='6318'>
<font color=#447700>!<a name='6319'></font>
#include "<A href='../../html_code/include/actual_new_args.inc.html'>actual_new_args.inc</A>"<A NAME="actual_new_args.inc_80"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6320'>
<font color=#447700>!<a name='6321'></font>
)<a name='6322'>
<a name='6323'>
<font color=#447700>! put things back so grid is intermediate grid<a name='6324'></font>
<a name='6325'>
      grid =&gt; xgrid<a name='6326'>
      CALL <A href='../../html_code/frame/module_configure.F.html#SET_SCALAR_INDICES_FROM_CONFIG'>set_scalar_indices_from_config</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SCALAR_INDICES_FROM_CONFIG_6"> ( grid%id , idum1 , idum2 )<a name='6327'>
<a name='6328'>
<font color=#447700>! "interp" (basically copy) ngrid onto intermediate grid<a name='6329'></font>
<a name='6330'>
      <font color=#447700>! Generate interpolation information and interpolate Q, T and<a name='6331'></font>
      <font color=#447700>! possibly PD while we're at it:<a name='6332'></font>
 <a name='6333'>
      call <A href='../../html_code/share/module_interp_store.F.html#STORE_INTERP_INFO'>store_interp_info</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_INTERP_INFO_3">(ngrid,grid)<a name='6334'>
      call <A href='../../html_code/share/module_interp_nmm.F.html#EXT_N2C_FULLDOM'>ext_n2c_fulldom</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_N2C_FULLDOM_1">(&amp;<a name='6335'>
           ngrid%deta1,ngrid%deta2,ngrid%eta1,             &amp;<a name='6336'>
           ngrid%eta2,ngrid%pt,ngrid%pdtop,                &amp;<a name='6337'>
           grid%pint,grid%t,grid%pd,grid%q,                &amp;<a name='6338'>
           cids, cide, cjds, cjde, ckds, ckde,             &amp;<a name='6339'>
           cims, cime, cjms, cjme, ckms, ckme,             &amp;<a name='6340'>
           cips, cipe, cjps, cjpe, ckps, ckpe,             &amp;<a name='6341'>
           ngrid%pint,ngrid%t,                             &amp;<a name='6342'>
           ngrid%pd,ngrid%q,                               &amp;<a name='6343'>
           ngrid%i_parent_start, ngrid%j_parent_start,     &amp;<a name='6344'>
           grid%iinfo,grid%winfo,                          &amp;<a name='6345'>
           nids, nide, njds, njde, nkds, nkde,             &amp;<a name='6346'>
           nims, nime, njms, njme, nkms, nkme,             &amp;<a name='6347'>
           nips, nipe, njps, njpe, nkps, nkpe)<a name='6348'>
<a name='6349'>
<a name='6350'>
      <font color=#447700>! "interp" ngrid onto intermediate grid<a name='6351'></font>
#include "<A href='../../html_code/include/nest_feedbackup_interp.inc.html'>nest_feedbackup_interp.inc</A>"<A NAME="nest_feedbackup_interp.inc_81"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6352'>
<a name='6353'>
      RETURN<a name='6354'>
   END SUBROUTINE feedback_domain_nmm_part1<a name='6355'>
<a name='6356'>
<font color=#447700>!------------------------------------------------------------------<a name='6357'></font>
<a name='6358'>
<A NAME='FEEDBACK_DOMAIN_NMM_PART2'><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6359'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>feedback_domain_nmm_part2</font> ( grid, intermediate_grid, ngrid , config_flags    &amp; <A href='../../call_to/FEEDBACK_DOMAIN_NMM_PART2.html' TARGET='index'>1</A>,<A href='../../call_from/FEEDBACK_DOMAIN_NMM_PART2.html' TARGET='index'>17</A><a name='6360'>
<font color=#447700>!<a name='6361'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_82"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6362'>
<font color=#447700>!<a name='6363'></font>
                 )<a name='6364'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_62"><a name='6365'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_127">, ONLY : domain, domain_clock_get, get_ijk_from_grid<a name='6366'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_84">, ONLY : grid_config_rec_type<a name='6367'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_116">, ONLY : get_dm_max_halo_width, ips_save, ipe_save,              &amp;<a name='6368'>
                            jps_save, jpe_save, ntasks, mytask, ntasks_x, ntasks_y, &amp;<a name='6369'>
                            local_communicator, itrace,                             &amp;<a name='6370'>
                            nest_pes_x, nest_pes_y,                                 &amp;<a name='6371'>
                            intercomm_active, nest_task_offsets,                    &amp;<a name='6372'>
                            mpi_comm_to_mom, mpi_comm_to_kid, which_kid <font color=#447700>!  ,            &amp;<a name='6373'></font>
                            <font color=#447700>! push_communicators_for_domain, pop_communicators_for_domain<a name='6374'></font>
<a name='6375'>
      USE <A href='../../html_code/frame/module_comm_nesting_dm.F.html#MODULE_COMM_NESTING_DM'>module_comm_nesting_dm</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_NESTING_DM_10">, ONLY : halo_interp_up_sub<a name='6376'>
      USE module_utility<a name='6377'>
      IMPLICIT NONE<a name='6378'>
<a name='6379'>
<font color=#447700>!<a name='6380'></font>
      TYPE(domain), POINTER :: grid          <font color=#447700>! name of the grid being dereferenced (must be "grid")<a name='6381'></font>
      TYPE(domain), POINTER :: intermediate_grid<a name='6382'>
      TYPE(domain), POINTER :: ngrid<a name='6383'>
      TYPE(domain), POINTER :: parent_grid<a name='6384'>
<a name='6385'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_83"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6386'>
      INTEGER nlev, msize<a name='6387'>
      INTEGER i,j,pig,pjg,cm,cn,nig,njg,retval,k<a name='6388'>
      TYPE (grid_config_rec_type)            :: config_flags<a name='6389'>
      REAL xv(2000)<a name='6390'>
      INTEGER       ::          cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='6391'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='6392'>
                                cips, cipe, cjps, cjpe, ckps, ckpe<a name='6393'>
      INTEGER       ::          nids, nide, njds, njde, nkds, nkde,    &amp;<a name='6394'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='6395'>
                                nips, nipe, njps, njpe, nkps, nkpe<a name='6396'>
      INTEGER       ::          xids, xide, xjds, xjde, xkds, xkde,    &amp;<a name='6397'>
                                xims, xime, xjms, xjme, xkms, xkme,    &amp;<a name='6398'>
                                xips, xipe, xjps, xjpe, xkps, xkpe<a name='6399'>
      INTEGER       ::          ids, ide, jds, jde, kds, kde,    &amp;<a name='6400'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6401'>
                                ips, ipe, jps, jpe, kps, kpe<a name='6402'>
<a name='6403'>
      INTEGER idim1,idim2,idim3,idim4,idim5,idim6,idim7<a name='6404'>
<a name='6405'>
      INTEGER icoord, jcoord, idim_cd, jdim_cd<a name='6406'>
      INTEGER local_comm, myproc, nproc<a name='6407'>
      INTEGER iparstrt, jparstrt, sw<a name='6408'>
      INTEGER thisdomain_max_halo_width<a name='6409'>
<a name='6410'>
      character*256 :: timestr<a name='6411'>
      integer ioffset, ierr<a name='6412'>
<a name='6413'>
      REAL    nest_influence<a name='6414'>
      LOGICAL feedback_flag, feedback_flag_v<a name='6415'>
      LOGICAL, EXTERNAL  :: cd_feedback_mask<a name='6416'>
      LOGICAL, EXTERNAL  :: cd_feedback_mask_v<a name='6417'>
<a name='6418'>
      LOGICAL interp_mp<a name='6419'>
<a name='6420'>
<font color=#447700>! On entry to this routine,<a name='6421'></font>
<font color=#447700>!  "grid" refers to the parent domain<a name='6422'></font>
<font color=#447700>!  "intermediate_grid" refers to local copy of parent domain that overlies this patch of nest<a name='6423'></font>
<font color=#447700>!  "ngrid" refers to the nest, which is only needed for smoothing on the parent because<a name='6424'></font>
<font color=#447700>!          the nest feedback data has already been transferred during em_nest_feedbackup_interp<a name='6425'></font>
<font color=#447700>!          in part1, above.<a name='6426'></font>
<font color=#447700>! The way these settings c and n dimensions are set, below, looks backwards but from the point<a name='6427'></font>
<font color=#447700>! of view of the RSL routine rsl_lite_to_parent_info(), call to which is included by<a name='6428'></font>
<font color=#447700>! em_nest_feedbackup_pack, the "n" domain represents the parent domain and the "c" domain<a name='6429'></font>
<font color=#447700>! represents the intermediate domain. The backwards lookingness should be fixed in the gen_comms.c<a name='6430'></font>
<font color=#447700>! registry routine that accompanies RSL_LITE but, just as it's sometimes easier to put up a road<a name='6431'></font>
<font color=#447700>! sign that says "DIP" than fix the dip,  at this point it was easier just to write this comment. JM<a name='6432'></font>
<font color=#447700>!<a name='6433'></font>
<a name='6434'>
      interp_mp=grid%interp_mp .or. ngrid%interp_mp<a name='6435'>
      nest_influence = 0.5<a name='6436'>
#define NEST_INFLUENCE(A,B) A = nest_influence*(B) + (1.0-nest_influence)*(A)<a name='6437'>
<a name='6438'>
<a name='6439'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_12">( grid, current_timestr=timestr )<a name='6440'>
<a name='6441'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_82"> (  intermediate_grid ,                   &amp;<a name='6442'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='6443'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='6444'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='6445'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_83"> (  grid ,              &amp;<a name='6446'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='6447'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='6448'>
                                nips, nipe, njps, njpe, nkps, nkpe    )<a name='6449'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_84"> (  ngrid ,              &amp;<a name='6450'>
                                xids, xide, xjds, xjde, xkds, xkde,    &amp;<a name='6451'>
                                xims, xime, xjms, xjme, xkms, xkme,    &amp;<a name='6452'>
                                xips, xipe, xjps, xjpe, xkps, xkpe    )<a name='6453'>
<a name='6454'>
      ips_save = ngrid%i_parent_start<a name='6455'>
      jps_save = ngrid%j_parent_start<a name='6456'>
      ipe_save = ngrid%i_parent_start + (xide-xids) / ngrid%parent_grid_ratio - 1<a name='6457'>
      jpe_save = ngrid%j_parent_start + (xjde-xjds) / ngrid%parent_grid_ratio - 1<a name='6458'>
<a name='6459'>
<a name='6460'>
      nide = nide - 1   <font color=#447700>!dusan<a name='6461'></font>
      njde = njde - 1   <font color=#447700>!dusan<a name='6462'></font>
<a name='6463'>
IF ( ngrid%active_this_task ) THEN<a name='6464'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_13">( ngrid%id )<a name='6465'>
      CALL nl_get_i_parent_start ( intermediate_grid%id, iparstrt )<a name='6466'>
      CALL nl_get_j_parent_start ( intermediate_grid%id, jparstrt )<a name='6467'>
      CALL nl_get_shw            ( intermediate_grid%id, sw )<a name='6468'>
      icoord =    iparstrt  - sw<a name='6469'>
      jcoord =    jparstrt  - sw<a name='6470'>
      idim_cd = cide - cids + 1<a name='6471'>
      jdim_cd = cjde - cjds + 1<a name='6472'>
<a name='6473'>
      nlev  = ckde - ckds + 1<a name='6474'>
<a name='6475'>
      CALL <A href='../../html_code/frame/module_dm.F.html#GET_DM_MAX_HALO_WIDTH'>get_dm_max_halo_width</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_DM_MAX_HALO_WIDTH_10"> ( ngrid%id , thisdomain_max_halo_width )<a name='6476'>
      parent_grid =&gt; grid<a name='6477'>
      grid =&gt; ngrid<a name='6478'>
#include "<A href='../../html_code/include/nest_feedbackup_pack.inc.html'>nest_feedbackup_pack.inc</A>"<A NAME="nest_feedbackup_pack.inc_84"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6479'>
      grid =&gt; parent_grid<a name='6480'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_13"><a name='6481'>
END IF<a name='6482'>
<a name='6483'>
<font color=#447700>!      CALL wrf_get_dm_communicator ( local_comm )<a name='6484'></font>
<font color=#447700>!      CALL wrf_get_myproc( myproc )<a name='6485'></font>
<font color=#447700>!      CALL wrf_get_nproc( nproc )<a name='6486'></font>
<a name='6487'>
      <font color=#447700>! determine which communicator and offset to use<a name='6488'></font>
      IF ( intercomm_active( grid%id ) ) THEN        <font color=#447700>! I am parent<a name='6489'></font>
        local_comm = mpi_comm_to_kid( which_kid(ngrid%id), grid%id )<a name='6490'>
        ioffset = nest_task_offsets(ngrid%id)<a name='6491'>
      ELSE IF ( intercomm_active( ngrid%id ) ) THEN  <font color=#447700>! I am nest<a name='6492'></font>
        local_comm = mpi_comm_to_mom( ngrid%id )<a name='6493'>
        ioffset = nest_task_offsets(ngrid%id)<a name='6494'>
      END IF<a name='6495'>
<a name='6496'>
      IF ( grid%active_this_task .OR. ngrid%active_this_task ) THEN<a name='6497'>
#ifndef STUBMPI<a name='6498'>
        CALL mpi_comm_rank(local_comm,myproc,ierr)<a name='6499'>
        CALL mpi_comm_size(local_comm,nproc,ierr)<a name='6500'>
#endif<a name='6501'>
        CALL rsl_lite_merge_msgs( myproc, nest_pes_x(grid%id)*nest_pes_y(grid%id),         &amp;<a name='6502'>
                                          nest_pes_x(ngrid%id)*nest_pes_y(ngrid%id),       &amp;<a name='6503'>
                                          ioffset, local_comm )<a name='6504'>
      END IF<a name='6505'>
<a name='6506'>
IF ( grid%active_this_task ) THEN<a name='6507'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_14">( grid%id )<a name='6508'>
<a name='6509'>
#include "<A href='../../html_code/include/nest_feedbackup_unpack.inc.html'>nest_feedbackup_unpack.inc</A>"<A NAME="nest_feedbackup_unpack.inc_85"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6510'>
<a name='6511'>
<a name='6512'>
      <font color=#447700>! smooth coarse grid<a name='6513'></font>
<a name='6514'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_85"> (  ngrid,                                 &amp;<a name='6515'>
                                nids, nide, njds, njde, nkds, nkde,    &amp;<a name='6516'>
                                nims, nime, njms, njme, nkms, nkme,    &amp;<a name='6517'>
                                nips, nipe, njps, njpe, nkps, nkpe     )<a name='6518'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_86"> (  grid ,              &amp;<a name='6519'>
                                ids, ide, jds, jde, kds, kde,    &amp;<a name='6520'>
                                ims, ime, jms, jme, kms, kme,    &amp;<a name='6521'>
                                ips, ipe, jps, jpe, kps, kpe    )<a name='6522'>
<a name='6523'>
     before_smooth_halo: if(config_flags%smooth_option/=0) then<a name='6524'>
#include "<A href='../../html_code/include/HALO_INTERP_UP.inc.html'>HALO_INTERP_UP.inc</A>"<A NAME="HALO_INTERP_UP.inc_86"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6525'>
     endif before_smooth_halo<a name='6526'>
<a name='6527'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_87"> (  grid ,                   &amp;<a name='6528'>
                                cids, cide, cjds, cjde, ckds, ckde,    &amp;<a name='6529'>
                                cims, cime, cjms, cjme, ckms, ckme,    &amp;<a name='6530'>
                                cips, cipe, cjps, cjpe, ckps, ckpe    )<a name='6531'>
<a name='6532'>
     smoother: if(config_flags%smooth_option/=0) then<a name='6533'>
#include "<A href='../../html_code/include/nest_feedbackup_smooth.inc.html'>nest_feedbackup_smooth.inc</A>"<A NAME="nest_feedbackup_smooth.inc_87"><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='6534'>
     endif smoother<a name='6535'>
<a name='6536'>
    CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_dm.F.html#FEEDBACK_DOMAIN_NMM_PART2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_14"><a name='6537'>
END IF<a name='6538'>
<a name='6539'>
<a name='6540'>
      RETURN<a name='6541'>
   END SUBROUTINE feedback_domain_nmm_part2<a name='6542'>
<a name='6543'>
<font color=#447700>!=================================================================================<a name='6544'></font>
<font color=#447700>!   End of gopal's doing<a name='6545'></font>
<font color=#447700>!=================================================================================<a name='6546'></font>
#endif<a name='6547'>
<a name='6548'>
<font color=#447700>!------------------------------------------------------------------<a name='6549'></font>
<a name='6550'>
<A NAME='WRF_GATHERV_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_GATHERV_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6551'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_gatherv_real</font> (Field, field_ofst,            &amp; <A href='../../call_to/WRF_GATHERV_REAL.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_GATHERV_REAL.html' TARGET='index'>1</A><a name='6552'>
                                my_count ,                    &amp;    <font color=#447700>! sendcount<a name='6553'></font>
                                globbuf, glob_ofst ,          &amp;    <font color=#447700>! recvbuf<a name='6554'></font>
                                counts                      , &amp;    <font color=#447700>! recvcounts<a name='6555'></font>
                                displs                      , &amp;    <font color=#447700>! displs<a name='6556'></font>
                                root                        , &amp;    <font color=#447700>! root<a name='6557'></font>
                                communicator                , &amp;    <font color=#447700>! communicator<a name='6558'></font>
                                ierr )<a name='6559'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_GATHERV_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_117">, ONLY : getrealmpitype<a name='6560'>
   IMPLICIT NONE<a name='6561'>
   INTEGER field_ofst, glob_ofst<a name='6562'>
   INTEGER my_count, communicator, root, ierr<a name='6563'>
   INTEGER , DIMENSION(*) :: counts, displs<a name='6564'>
   REAL, DIMENSION(*) :: Field, globbuf<a name='6565'>
#ifndef STUBMPI<a name='6566'>
   INCLUDE 'mpif.h'<a name='6567'>
<a name='6568'>
           CALL mpi_gatherv( Field( field_ofst ),      &amp;    <font color=#447700>! sendbuf<a name='6569'></font>
                            my_count ,                       &amp;    <font color=#447700>! sendcount<a name='6570'></font>
                            getrealmpitype() ,               &amp;    <font color=#447700>! sendtype<a name='6571'></font>
                            globbuf( glob_ofst ) ,                 &amp;    <font color=#447700>! recvbuf<a name='6572'></font>
                            counts                         , &amp;    <font color=#447700>! recvcounts<a name='6573'></font>
                            displs                         , &amp;    <font color=#447700>! displs<a name='6574'></font>
                            getrealmpitype()               , &amp;    <font color=#447700>! recvtype<a name='6575'></font>
                            root                           , &amp;    <font color=#447700>! root<a name='6576'></font>
                            communicator                   , &amp;    <font color=#447700>! communicator<a name='6577'></font>
                            ierr )<a name='6578'>
#endif<a name='6579'>
<a name='6580'>
   END SUBROUTINE wrf_gatherv_real<a name='6581'>
<a name='6582'>
<A NAME='WRF_GATHERV_DOUBLE'><A href='../../html_code/frame/module_dm.F.html#WRF_GATHERV_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6583'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_gatherv_double</font> (Field, field_ofst,            &amp; <A href='../../call_to/WRF_GATHERV_DOUBLE.html' TARGET='index'>4</A><a name='6584'>
                                my_count ,                    &amp;    <font color=#447700>! sendcount<a name='6585'></font>
                                globbuf, glob_ofst ,          &amp;    <font color=#447700>! recvbuf<a name='6586'></font>
                                counts                      , &amp;    <font color=#447700>! recvcounts<a name='6587'></font>
                                displs                      , &amp;    <font color=#447700>! displs<a name='6588'></font>
                                root                        , &amp;    <font color=#447700>! root<a name='6589'></font>
                                communicator                , &amp;    <font color=#447700>! communicator<a name='6590'></font>
                                ierr )<a name='6591'>
<font color=#447700>!   USE module_dm<a name='6592'></font>
   IMPLICIT NONE<a name='6593'>
   INTEGER field_ofst, glob_ofst<a name='6594'>
   INTEGER my_count, communicator, root, ierr<a name='6595'>
   INTEGER , DIMENSION(*) :: counts, displs<a name='6596'>
<font color=#447700>! this next declaration is REAL, not DOUBLE PRECISION because it will be autopromoted<a name='6597'></font>
<font color=#447700>! to double precision by the compiler when WRF is compiled for 8 byte reals. Only reason<a name='6598'></font>
<font color=#447700>! for having this separate routine is so we pass the correct MPI type to mpi_scatterv<a name='6599'></font>
<font color=#447700>! if we were not indexing the globbuf and Field arrays it would not even matter<a name='6600'></font>
   REAL, DIMENSION(*) :: Field, globbuf<a name='6601'>
#ifndef STUBMPI<a name='6602'>
   INCLUDE 'mpif.h'<a name='6603'>
<a name='6604'>
           CALL mpi_gatherv( Field( field_ofst ),      &amp;    <font color=#447700>! sendbuf<a name='6605'></font>
                            my_count ,                       &amp;    <font color=#447700>! sendcount<a name='6606'></font>
                            MPI_DOUBLE_PRECISION         ,               &amp;    <font color=#447700>! sendtype<a name='6607'></font>
                            globbuf( glob_ofst ) ,                 &amp;    <font color=#447700>! recvbuf<a name='6608'></font>
                            counts                         , &amp;    <font color=#447700>! recvcounts<a name='6609'></font>
                            displs                         , &amp;    <font color=#447700>! displs<a name='6610'></font>
                            MPI_DOUBLE_PRECISION                       , &amp;    <font color=#447700>! recvtype<a name='6611'></font>
                            root                           , &amp;    <font color=#447700>! root<a name='6612'></font>
                            communicator                   , &amp;    <font color=#447700>! communicator<a name='6613'></font>
                            ierr )<a name='6614'>
#endif<a name='6615'>
<a name='6616'>
   END SUBROUTINE wrf_gatherv_double<a name='6617'>
<a name='6618'>
<A NAME='WRF_GATHERV_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_GATHERV_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6619'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_gatherv_integer</font> (Field, field_ofst,            &amp; <A href='../../call_to/WRF_GATHERV_INTEGER.html' TARGET='index'>4</A><a name='6620'>
                                my_count ,                    &amp;    <font color=#447700>! sendcount<a name='6621'></font>
                                globbuf, glob_ofst ,          &amp;    <font color=#447700>! recvbuf<a name='6622'></font>
                                counts                      , &amp;    <font color=#447700>! recvcounts<a name='6623'></font>
                                displs                      , &amp;    <font color=#447700>! displs<a name='6624'></font>
                                root                        , &amp;    <font color=#447700>! root<a name='6625'></font>
                                communicator                , &amp;    <font color=#447700>! communicator<a name='6626'></font>
                                ierr )<a name='6627'>
   IMPLICIT NONE<a name='6628'>
   INTEGER field_ofst, glob_ofst<a name='6629'>
   INTEGER my_count, communicator, root, ierr<a name='6630'>
   INTEGER , DIMENSION(*) :: counts, displs<a name='6631'>
   INTEGER, DIMENSION(*) :: Field, globbuf<a name='6632'>
#ifndef STUBMPI<a name='6633'>
   INCLUDE 'mpif.h'<a name='6634'>
<a name='6635'>
           CALL mpi_gatherv( Field( field_ofst ),      &amp;    <font color=#447700>! sendbuf<a name='6636'></font>
                            my_count ,                       &amp;    <font color=#447700>! sendcount<a name='6637'></font>
                            MPI_INTEGER         ,               &amp;    <font color=#447700>! sendtype<a name='6638'></font>
                            globbuf( glob_ofst ) ,                 &amp;    <font color=#447700>! recvbuf<a name='6639'></font>
                            counts                         , &amp;    <font color=#447700>! recvcounts<a name='6640'></font>
                            displs                         , &amp;    <font color=#447700>! displs<a name='6641'></font>
                            MPI_INTEGER                       , &amp;    <font color=#447700>! recvtype<a name='6642'></font>
                            root                           , &amp;    <font color=#447700>! root<a name='6643'></font>
                            communicator                   , &amp;    <font color=#447700>! communicator<a name='6644'></font>
                            ierr )<a name='6645'>
#endif<a name='6646'>
<a name='6647'>
   END SUBROUTINE wrf_gatherv_integer<a name='6648'>
<a name='6649'>
<font color=#447700>!new stuff 20070124<a name='6650'></font>
<A NAME='WRF_SCATTERV_REAL'><A href='../../html_code/frame/module_dm.F.html#WRF_SCATTERV_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6651'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_scatterv_real</font> (                             &amp; <A href='../../call_to/WRF_SCATTERV_REAL.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_SCATTERV_REAL.html' TARGET='index'>1</A><a name='6652'>
                                globbuf, glob_ofst ,          &amp;    <font color=#447700>! recvbuf<a name='6653'></font>
                                counts                      , &amp;    <font color=#447700>! recvcounts<a name='6654'></font>
                                Field, field_ofst,            &amp;<a name='6655'>
                                my_count ,                    &amp;    <font color=#447700>! sendcount<a name='6656'></font>
                                displs                      , &amp;    <font color=#447700>! displs<a name='6657'></font>
                                root                        , &amp;    <font color=#447700>! root<a name='6658'></font>
                                communicator                , &amp;    <font color=#447700>! communicator<a name='6659'></font>
                                ierr )<a name='6660'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#WRF_SCATTERV_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_118">, ONLY : getrealmpitype<a name='6661'>
   IMPLICIT NONE<a name='6662'>
   INTEGER field_ofst, glob_ofst<a name='6663'>
   INTEGER my_count, communicator, root, ierr<a name='6664'>
   INTEGER , DIMENSION(*) :: counts, displs<a name='6665'>
   REAL, DIMENSION(*) :: Field, globbuf<a name='6666'>
#ifndef STUBMPI<a name='6667'>
   INCLUDE 'mpif.h'<a name='6668'>
<a name='6669'>
           CALL mpi_scatterv(                                &amp;<a name='6670'>
                            globbuf( glob_ofst ) ,           &amp;    <font color=#447700>! recvbuf<a name='6671'></font>
                            counts                         , &amp;    <font color=#447700>! recvcounts<a name='6672'></font>
                            displs                         , &amp;    <font color=#447700>! displs<a name='6673'></font>
                            getrealmpitype()               , &amp;    <font color=#447700>! recvtype<a name='6674'></font>
                            Field( field_ofst ),             &amp;    <font color=#447700>! sendbuf<a name='6675'></font>
                            my_count ,                       &amp;    <font color=#447700>! sendcount<a name='6676'></font>
                            getrealmpitype() ,               &amp;    <font color=#447700>! sendtype<a name='6677'></font>
                            root                           , &amp;    <font color=#447700>! root<a name='6678'></font>
                            communicator                   , &amp;    <font color=#447700>! communicator<a name='6679'></font>
                            ierr )<a name='6680'>
#endif<a name='6681'>
<a name='6682'>
   END SUBROUTINE wrf_scatterv_real<a name='6683'>
<a name='6684'>
<A NAME='WRF_SCATTERV_DOUBLE'><A href='../../html_code/frame/module_dm.F.html#WRF_SCATTERV_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6685'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_scatterv_double</font> (                           &amp; <A href='../../call_to/WRF_SCATTERV_DOUBLE.html' TARGET='index'>2</A><a name='6686'>
                                globbuf, glob_ofst ,          &amp;    <font color=#447700>! recvbuf<a name='6687'></font>
                                counts                      , &amp;    <font color=#447700>! recvcounts<a name='6688'></font>
                                Field, field_ofst,            &amp;<a name='6689'>
                                my_count ,                    &amp;    <font color=#447700>! sendcount<a name='6690'></font>
                                displs                      , &amp;    <font color=#447700>! displs<a name='6691'></font>
                                root                        , &amp;    <font color=#447700>! root<a name='6692'></font>
                                communicator                , &amp;    <font color=#447700>! communicator<a name='6693'></font>
                                ierr )<a name='6694'>
   IMPLICIT NONE<a name='6695'>
   INTEGER field_ofst, glob_ofst<a name='6696'>
   INTEGER my_count, communicator, root, ierr<a name='6697'>
   INTEGER , DIMENSION(*) :: counts, displs<a name='6698'>
   REAL, DIMENSION(*) :: Field, globbuf<a name='6699'>
#ifndef STUBMPI<a name='6700'>
   INCLUDE 'mpif.h'<a name='6701'>
<font color=#447700>! this next declaration is REAL, not DOUBLE PRECISION because it will be autopromoted<a name='6702'></font>
<font color=#447700>! to double precision by the compiler when WRF is compiled for 8 byte reals. Only reason<a name='6703'></font>
<font color=#447700>! for having this separate routine is so we pass the correct MPI type to mpi_scatterv<a name='6704'></font>
<font color=#447700>! if we were not indexing the globbuf and Field arrays it would not even matter<a name='6705'></font>
<a name='6706'>
           CALL mpi_scatterv(                                &amp;<a name='6707'>
                            globbuf( glob_ofst ) ,           &amp;    <font color=#447700>! recvbuf<a name='6708'></font>
                            counts                         , &amp;    <font color=#447700>! recvcounts<a name='6709'></font>
                            displs                         , &amp;    <font color=#447700>! displs<a name='6710'></font>
                            MPI_DOUBLE_PRECISION           , &amp;    <font color=#447700>! recvtype<a name='6711'></font>
                            Field( field_ofst ),             &amp;    <font color=#447700>! sendbuf<a name='6712'></font>
                            my_count ,                       &amp;    <font color=#447700>! sendcount<a name='6713'></font>
                            MPI_DOUBLE_PRECISION         ,   &amp;    <font color=#447700>! sendtype<a name='6714'></font>
                            root                           , &amp;    <font color=#447700>! root<a name='6715'></font>
                            communicator                   , &amp;    <font color=#447700>! communicator<a name='6716'></font>
                            ierr )<a name='6717'>
#endif<a name='6718'>
<a name='6719'>
   END SUBROUTINE wrf_scatterv_double<a name='6720'>
<a name='6721'>
<A NAME='WRF_SCATTERV_INTEGER'><A href='../../html_code/frame/module_dm.F.html#WRF_SCATTERV_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6722'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_scatterv_integer</font> (                          &amp; <A href='../../call_to/WRF_SCATTERV_INTEGER.html' TARGET='index'>2</A><a name='6723'>
                                globbuf, glob_ofst ,          &amp;    <font color=#447700>! recvbuf<a name='6724'></font>
                                counts                      , &amp;    <font color=#447700>! recvcounts<a name='6725'></font>
                                Field, field_ofst,            &amp;<a name='6726'>
                                my_count ,                    &amp;    <font color=#447700>! sendcount<a name='6727'></font>
                                displs                      , &amp;    <font color=#447700>! displs<a name='6728'></font>
                                root                        , &amp;    <font color=#447700>! root<a name='6729'></font>
                                communicator                , &amp;    <font color=#447700>! communicator<a name='6730'></font>
                                ierr )<a name='6731'>
   IMPLICIT NONE<a name='6732'>
   INTEGER field_ofst, glob_ofst<a name='6733'>
   INTEGER my_count, communicator, root, ierr<a name='6734'>
   INTEGER , DIMENSION(*) :: counts, displs<a name='6735'>
   INTEGER, DIMENSION(*) :: Field, globbuf<a name='6736'>
#ifndef STUBMPI<a name='6737'>
   INCLUDE 'mpif.h'<a name='6738'>
<a name='6739'>
           CALL mpi_scatterv(                                &amp;<a name='6740'>
                            globbuf( glob_ofst ) ,           &amp;    <font color=#447700>! recvbuf<a name='6741'></font>
                            counts                         , &amp;    <font color=#447700>! recvcounts<a name='6742'></font>
                            displs                         , &amp;    <font color=#447700>! displs<a name='6743'></font>
                            MPI_INTEGER                    , &amp;    <font color=#447700>! recvtype<a name='6744'></font>
                            Field( field_ofst ),             &amp;    <font color=#447700>! sendbuf<a name='6745'></font>
                            my_count ,                       &amp;    <font color=#447700>! sendcount<a name='6746'></font>
                            MPI_INTEGER         ,            &amp;    <font color=#447700>! sendtype<a name='6747'></font>
                            root                           , &amp;    <font color=#447700>! root<a name='6748'></font>
                            communicator                   , &amp;    <font color=#447700>! communicator<a name='6749'></font>
                            ierr )<a name='6750'>
#endif<a name='6751'>
<a name='6752'>
   END SUBROUTINE wrf_scatterv_integer<a name='6753'>
<font color=#447700>! end new stuff 20070124<a name='6754'></font>
<a name='6755'>
<A NAME='WRF_DM_GATHERV'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6756'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_gatherv</font> ( v, elemsize , km_s, km_e, wordsz ) <A href='../../call_to/WRF_DM_GATHERV.html' TARGET='index'>18</A>,<A href='../../call_from/WRF_DM_GATHERV.html' TARGET='index'>2</A><a name='6757'>
      IMPLICIT NONE<a name='6758'>
      INTEGER  elemsize, km_s, km_e, wordsz<a name='6759'>
      REAL v(*)<a name='6760'>
      IF ( wordsz .EQ. DWORDSIZE ) THEN<a name='6761'>
         CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_DOUBLE'>wrf_dm_gatherv_double</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_DOUBLE_1">(v, elemsize , km_s, km_e)<a name='6762'>
      ELSE<a name='6763'>
         CALL <A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_SINGLE'>wrf_dm_gatherv_single</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_GATHERV_SINGLE_1">(v, elemsize , km_s, km_e)<a name='6764'>
      END IF<a name='6765'>
     END SUBROUTINE wrf_dm_gatherv<a name='6766'>
<a name='6767'>
<A NAME='WRF_DM_GATHERV_DOUBLE'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6768'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_gatherv_double</font> ( v, elemsize , km_s, km_e ) <A href='../../call_to/WRF_DM_GATHERV_DOUBLE.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_GATHERV_DOUBLE.html' TARGET='index'>3</A><a name='6769'>
      IMPLICIT NONE<a name='6770'>
      INTEGER  elemsize, km_s, km_e<a name='6771'>
      REAL*8 v(0:*)<a name='6772'>
#ifndef STUBMPI<a name='6773'>
# ifndef USE_MPI_IN_PLACE<a name='6774'>
      REAL*8 v_local((km_e-km_s+1)*elemsize)<a name='6775'>
# endif<a name='6776'>
      INTEGER, DIMENSION(:), ALLOCATABLE :: recvcounts, displs<a name='6777'>
      INTEGER send_type, myproc, nproc, local_comm, ierr, i<a name='6778'>
   INCLUDE 'mpif.h'<a name='6779'>
      send_type = MPI_DOUBLE_PRECISION<a name='6780'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_43"> ( local_comm )<a name='6781'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_10">( nproc )<a name='6782'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_17">( myproc )<a name='6783'>
      ALLOCATE( recvcounts(nproc), displs(nproc) )<a name='6784'>
      i = (km_e-km_s+1)*elemsize<a name='6785'>
      CALL mpi_allgather( i,1,MPI_INTEGER,recvcounts,1,MPI_INTEGER,local_comm,ierr) ;<a name='6786'>
      i = (km_s)*elemsize<a name='6787'>
      CALL mpi_allgather( i,1,MPI_INTEGER,displs,1,MPI_INTEGER,local_comm,ierr) ;<a name='6788'>
#  ifdef USE_MPI_IN_PLACE<a name='6789'>
      CALL mpi_allgatherv( MPI_IN_PLACE,                                  &amp;<a name='6790'>
#  else<a name='6791'>
      DO i = 1,elemsize*(km_e-km_s+1)<a name='6792'>
        v_local(i) = v(i+elemsize*km_s-1)<a name='6793'>
      END DO<a name='6794'>
      CALL mpi_allgatherv( v_local,                                       &amp;<a name='6795'>
#  endif<a name='6796'>
                           (km_e-km_s+1)*elemsize,                        &amp;<a name='6797'>
                           send_type,                                     &amp;<a name='6798'>
                           v,                                             &amp;<a name='6799'>
                           recvcounts,                                    &amp;<a name='6800'>
                           displs,                                        &amp;<a name='6801'>
                           send_type,                                     &amp;<a name='6802'>
                           local_comm,                                    &amp;<a name='6803'>
                           ierr )<a name='6804'>
      DEALLOCATE(recvcounts)<a name='6805'>
      DEALLOCATE(displs)<a name='6806'>
#endif<a name='6807'>
      return<a name='6808'>
     END SUBROUTINE wrf_dm_gatherv_double<a name='6809'>
<a name='6810'>
<A NAME='WRF_DM_GATHERV_SINGLE'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_SINGLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6811'>
     <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_gatherv_single</font> ( v, elemsize , km_s, km_e ) <A href='../../call_to/WRF_DM_GATHERV_SINGLE.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_GATHERV_SINGLE.html' TARGET='index'>3</A><a name='6812'>
      IMPLICIT NONE<a name='6813'>
      INTEGER  elemsize, km_s, km_e<a name='6814'>
      REAL*4 v(0:*)<a name='6815'>
#ifndef STUBMPI<a name='6816'>
# ifndef USE_MPI_IN_PLACE<a name='6817'>
      REAL*4 v_local((km_e-km_s+1)*elemsize)<a name='6818'>
# endif<a name='6819'>
      INTEGER, DIMENSION(:), ALLOCATABLE :: recvcounts, displs<a name='6820'>
      INTEGER send_type, myproc, nproc, local_comm, ierr, i<a name='6821'>
   INCLUDE 'mpif.h'<a name='6822'>
      send_type = MPI_REAL<a name='6823'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_SINGLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_44"> ( local_comm )<a name='6824'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_SINGLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_11">( nproc )<a name='6825'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_GATHERV_SINGLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_18">( myproc )<a name='6826'>
      ALLOCATE( recvcounts(nproc), displs(nproc) )<a name='6827'>
      i = (km_e-km_s+1)*elemsize<a name='6828'>
      CALL mpi_allgather( i,1,MPI_INTEGER,recvcounts,1,MPI_INTEGER,local_comm,ierr) ;<a name='6829'>
      i = (km_s)*elemsize<a name='6830'>
      CALL mpi_allgather( i,1,MPI_INTEGER,displs,1,MPI_INTEGER,local_comm,ierr) ;<a name='6831'>
#  ifdef USE_MPI_IN_PLACE<a name='6832'>
      CALL mpi_allgatherv( MPI_IN_PLACE,                                  &amp;<a name='6833'>
#  else<a name='6834'>
      DO i = 1,elemsize*(km_e-km_s+1)<a name='6835'>
        v_local(i) = v(i+elemsize*km_s-1)<a name='6836'>
      END DO<a name='6837'>
      CALL mpi_allgatherv( v_local,                                       &amp;<a name='6838'>
#  endif<a name='6839'>
                           (km_e-km_s+1)*elemsize,                        &amp;<a name='6840'>
                           send_type,                                     &amp;<a name='6841'>
                           v,                                             &amp;<a name='6842'>
                           recvcounts,                                    &amp;<a name='6843'>
                           displs,                                        &amp;<a name='6844'>
                           send_type,                                     &amp;<a name='6845'>
                           local_comm,                                    &amp;<a name='6846'>
                           ierr )<a name='6847'>
      DEALLOCATE(recvcounts)<a name='6848'>
      DEALLOCATE(displs)<a name='6849'>
#endif<a name='6850'>
      return<a name='6851'>
     END SUBROUTINE wrf_dm_gatherv_single<a name='6852'>
<a name='6853'>
<A NAME='WRF_DM_DECOMP1D'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_DECOMP1D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6854'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_decomp1d</font>( nt, km_s, km_e ) <A href='../../call_to/WRF_DM_DECOMP1D.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_DM_DECOMP1D.html' TARGET='index'>2</A><a name='6855'>
       IMPLICIT NONE<a name='6856'>
       INTEGER, INTENT(IN)  :: nt<a name='6857'>
       INTEGER, INTENT(OUT) :: km_s, km_e<a name='6858'>
     <font color=#447700>! local<a name='6859'></font>
       INTEGER nn, nnp,  na, nb<a name='6860'>
       INTEGER myproc, nproc<a name='6861'>
<a name='6862'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_DECOMP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_19">(myproc)<a name='6863'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_NPROC'>wrf_get_nproc</A><A href='../../html_code/frame/module_dm.F.html#WRF_DM_DECOMP1D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_NPROC_12">(nproc)<a name='6864'>
       nn = nt / nproc           <font color=#447700>! min number done by this task<a name='6865'></font>
       nnp = nn<a name='6866'>
       if ( myproc .lt. mod( nt, nproc ) )   nnp = nnp + 1 <font color=#447700>! distribute remainder<a name='6867'></font>
<a name='6868'>
       na = min( myproc, mod(nt,nproc) ) <font color=#447700>! Number of blocks with remainder that precede this one<a name='6869'></font>
       nb = max( 0, myproc - na )        <font color=#447700>! number of blocks without a remainder that precede this one<a name='6870'></font>
       km_s = na * ( nn+1) + nb * nn     <font color=#447700>! starting iteration for this task<a name='6871'></font>
       km_e = km_s + nnp - 1             <font color=#447700>! ending iteration for this task<a name='6872'></font>
      END SUBROUTINE wrf_dm_decomp1d<a name='6873'>
<a name='6874'>
<a name='6875'>
<A NAME='WRF_DM_DEFINE_COMMS'><A href='../../html_code/frame/module_dm.F.html#WRF_DM_DEFINE_COMMS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6876'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_dm_define_comms</font> ( grid ) <A href='../../call_to/WRF_DM_DEFINE_COMMS.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_DM_DEFINE_COMMS.html' TARGET='index'>2</A><a name='6877'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_DEFINE_COMMS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_128">, ONLY : domain<a name='6878'>
   IMPLICIT NONE<a name='6879'>
   TYPE(domain) , INTENT (INOUT) :: grid<a name='6880'>
   RETURN<a name='6881'>
END SUBROUTINE wrf_dm_define_comms<a name='6882'>
<a name='6883'>
<A NAME='TFP_MESSAGE'><A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6884'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>tfp_message</font>( fname, lno ) <A href='../../call_to/TFP_MESSAGE.html' TARGET='index'>12</A>,<A href='../../call_from/TFP_MESSAGE.html' TARGET='index'>2</A><a name='6885'>
   CHARACTER*(*) fname<a name='6886'>
   INTEGER lno<a name='6887'>
   CHARACTER*1024 mess<a name='6888'>
#ifndef STUBMPI<a name='6889'>
   WRITE(mess,*)'tfp_message: ',trim(fname),lno<a name='6890'>
   CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_321">(mess)<a name='6891'>
# ifdef ALLOW_OVERDECOMP<a name='6892'>
     CALL task_for_point_message  <font color=#447700>! defined in RSL_LITE/task_for_point.c<a name='6893'></font>
# else<a name='6894'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_dm.F.html#TFP_MESSAGE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_216">(mess)<a name='6895'>
# endif<a name='6896'>
#endif <a name='6897'>
END SUBROUTINE tfp_message<a name='6898'>
<a name='6899'>
<A NAME='SET_DM_DEBUG'><A href='../../html_code/frame/module_dm.F.html#SET_DM_DEBUG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6900'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_dm_debug</font> ,<A href='../../call_from/SET_DM_DEBUG.html' TARGET='index'>1</A><a name='6901'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#SET_DM_DEBUG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_119">, ONLY : dm_debug_flag<a name='6902'>
    IMPLICIT NONE<a name='6903'>
    dm_debug_flag = .TRUE.<a name='6904'>
   END SUBROUTINE set_dm_debug<a name='6905'>
<A NAME='RESET_DM_DEBUG'><A href='../../html_code/frame/module_dm.F.html#RESET_DM_DEBUG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6906'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>reset_dm_debug</font> ,<A href='../../call_from/RESET_DM_DEBUG.html' TARGET='index'>1</A><a name='6907'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#RESET_DM_DEBUG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_120">, ONLY : dm_debug_flag<a name='6908'>
    IMPLICIT NONE<a name='6909'>
    dm_debug_flag = .FALSE.<a name='6910'>
   END SUBROUTINE reset_dm_debug<a name='6911'>
<A NAME='GET_DM_DEBUG'><A href='../../html_code/frame/module_dm.F.html#GET_DM_DEBUG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6912'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>get_dm_debug</font> ( arg ),<A href='../../call_from/GET_DM_DEBUG.html' TARGET='index'>1</A><a name='6913'>
    USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_dm.F.html#GET_DM_DEBUG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_121">, ONLY : dm_debug_flag<a name='6914'>
    IMPLICIT NONE<a name='6915'>
    LOGICAL arg<a name='6916'>
    arg = dm_debug_flag<a name='6917'>
   END SUBROUTINE get_dm_debug<a name='6918'>
<a name='6919'>
</pre></body></html>