<HTML> <BODY BGCOLOR=#eeddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:TILING<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_TILES'><A href='../../html_code/frame/module_tiles.F.html#MODULE_TILES' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_tiles</font> <A href='../../call_to/MODULE_TILES.html' TARGET='index'>9</A><a name='6'>
<a name='7'>
  USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_tiles.F.html#module_tiles.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_111"><a name='8'>
<a name='9'>
<A NAME='SET_TILES'><A href='../../html_code/frame/module_tiles.F.html#SET_TILES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10'>
  <font color=#993300>INTERFACE </font><font color=#cc0000>set_tiles</font> <A href='../../call_to/SET_TILES.html' TARGET='index'>9</A><a name='11'>
    MODULE PROCEDURE <A href='../../html_code/frame/module_tiles.F.html#SET_TILES1'>set_tiles1</A><A NAME="SET_TILES1_1"><A href='../../html_code/frame/module_tiles.F.html#module_tiles.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_tiles.F.html#SET_TILES2'>set_tiles2</A><A NAME="SET_TILES2_1"><A href='../../html_code/frame/module_tiles.F.html#module_tiles.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_tiles.F.html#SET_TILES3'>set_tiles3</A><A NAME="SET_TILES3_1"><A href='../../html_code/frame/module_tiles.F.html#module_tiles.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a>, <A href='../../html_code/frame/module_tiles.F.html#SET_TILES_ONCE'>set_tiles_once</A><A NAME="SET_TILES_ONCE_1"><A href='../../html_code/frame/module_tiles.F.html#module_tiles.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='12'>
  END INTERFACE<a name='13'>
<a name='14'>
CONTAINS<a name='15'>
<a name='16'>
<font color=#447700>! CPP macro for error checking<a name='17'></font>
#define ERROR_TEST(A,O,B) IF( A O B )THEN;WRITE(mess,'(3A4)')'A','O','B';CALL WRF_ERROR_FATAL(mess);ENDIF<a name='18'>
#ifndef MIN_TILE_SIZE<a name='19'>
# define MIN_TILE_SIZE 1<a name='20'>
#endif<a name='21'>
<a name='22'>
<font color=#447700>! this version is used to compute only on a boundary of some width<a name='23'></font>
<font color=#447700>! The ids, ide, jds, and jde arguments specify the edge of the boundary (a way of<a name='24'></font>
<font color=#447700>! accounting for staggering, and the bdyw gives the number of cells<a name='25'></font>
<font color=#447700>! (idea: if bdyw is negative, have it do the reverse and specify the <a name='26'></font>
<font color=#447700>! interior, less the boundary.<a name='27'></font>
<a name='28'>
<A NAME='SET_TILES1'><A href='../../html_code/frame/module_tiles.F.html#SET_TILES1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='29'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_tiles1</font> ( grid , ids , ide , jds , jde , bdyw ) <A href='../../call_to/SET_TILES1.html' TARGET='index'>1</A>,<A href='../../call_from/SET_TILES1.html' TARGET='index'>4</A><a name='30'>
<a name='31'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_164">, ONLY : domain<a name='32'>
     USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_43"><a name='33'>
     USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_11"><a name='34'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES1' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_24"><a name='35'>
<a name='36'>
     IMPLICIT NONE<a name='37'>
  <a name='38'>
     <font color=#447700>!  Input data.<a name='39'></font>
  <a name='40'>
     TYPE(domain)                   , INTENT(INOUT)  :: grid<a name='41'>
     INTEGER                        , INTENT(IN)     :: ids , ide , jds , jde , bdyw<a name='42'>
<a name='43'>
     <font color=#447700>!  Local data<a name='44'></font>
<a name='45'>
     INTEGER                                :: spx, epx, spy, epy, t, tt, ts, te<a name='46'>
     INTEGER                                :: smx, emx, smy, emy<a name='47'>
     INTEGER                                :: ntiles , num_tiles<a name='48'>
<a name='49'>
     CHARACTER*80              :: mess<a name='50'>
<a name='51'>
     data_ordering : SELECT CASE ( model_data_order )<a name='52'>
       CASE  ( DATA_ORDER_XYZ )<a name='53'>
         spx = grid%sp31 ; epx = grid%ep31 ; spy = grid%sp32 ; epy = grid%ep32<a name='54'>
       CASE  ( DATA_ORDER_YXZ )<a name='55'>
         spx = grid%sp32 ; epx = grid%ep32 ; spy = grid%sp31 ; epy = grid%ep31<a name='56'>
       CASE  ( DATA_ORDER_ZXY )<a name='57'>
         spx = grid%sp32 ; epx = grid%ep32 ; spy = grid%sp33 ; epy = grid%ep33<a name='58'>
       CASE  ( DATA_ORDER_ZYX )<a name='59'>
         spx = grid%sp33 ; epx = grid%ep33 ; spy = grid%sp32 ; epy = grid%ep32<a name='60'>
       CASE  ( DATA_ORDER_XZY )<a name='61'>
         spx = grid%sp31 ; epx = grid%ep31 ; spy = grid%sp33 ; epy = grid%ep33<a name='62'>
       CASE  ( DATA_ORDER_YZX )<a name='63'>
         spx = grid%sp33 ; epx = grid%ep33 ; spy = grid%sp31 ; epy = grid%ep31<a name='64'>
     END SELECT data_ordering<a name='65'>
<a name='66'>
     num_tiles = 4<a name='67'>
<a name='68'>
     IF ( num_tiles &gt; grid%max_tiles ) THEN<a name='69'>
       IF ( ASSOCIATED(grid%i_start) ) THEN ; DEALLOCATE( grid%i_start ) ; NULLIFY( grid%i_start ) ; ENDIF<a name='70'>
       IF ( ASSOCIATED(grid%i_end) )   THEN ; DEALLOCATE( grid%i_end   ) ; NULLIFY( grid%i_end   ) ; ENDIF<a name='71'>
       IF ( ASSOCIATED(grid%j_start) ) THEN ; DEALLOCATE( grid%j_start ) ; NULLIFY( grid%j_start ) ; ENDIF<a name='72'>
       IF ( ASSOCIATED(grid%j_end) )   THEN ; DEALLOCATE( grid%j_end   ) ; NULLIFY( grid%j_end   ) ; ENDIF<a name='73'>
       ALLOCATE(grid%i_start(num_tiles))<a name='74'>
       ALLOCATE(grid%i_end(num_tiles))<a name='75'>
       ALLOCATE(grid%j_start(num_tiles))<a name='76'>
       ALLOCATE(grid%j_end(num_tiles))<a name='77'>
       grid%max_tiles = num_tiles<a name='78'>
     ENDIF<a name='79'>
<a name='80'>
<font color=#447700>! XS boundary<a name='81'></font>
     IF      ( ids .ge. spx .and. ids .le. epx ) THEN<a name='82'>
        grid%i_start(1) = ids<a name='83'>
        grid%i_end(1)   = min( ids+bdyw-1 , epx )<a name='84'>
        grid%j_start(1) = max( spy , jds )<a name='85'>
        grid%j_end(1)   = min( epy , jde )<a name='86'>
     ELSEIF  ( (ids+bdyw-1) .ge. spx .and. (ids+bdyw-1) .le. epx ) THEN<a name='87'>
        grid%i_start(1) = max( ids , spx )<a name='88'>
        grid%i_end(1)   = ids+bdyw-1<a name='89'>
        grid%j_start(1) = max( spy , jds )<a name='90'>
        grid%j_end(1)   = min( epy , jde )<a name='91'>
     ELSE<a name='92'>
        grid%i_start(1) = 1<a name='93'>
        grid%i_end(1)   = -1<a name='94'>
        grid%j_start(1) = 1<a name='95'>
        grid%j_end(1)   = -1<a name='96'>
     ENDIF<a name='97'>
<a name='98'>
<font color=#447700>! XE boundary<a name='99'></font>
     IF      ( ide .ge. spx .and. ide .le. epx ) THEN<a name='100'>
        grid%i_start(2) = max( ide-bdyw+1 , spx )<a name='101'>
        grid%i_end(2)   = ide<a name='102'>
        grid%j_start(2) = max( spy , jds )<a name='103'>
        grid%j_end(2)   = min( epy , jde )<a name='104'>
     ELSEIF  ( (ide-bdyw+1) .ge. spx .and. (ide-bdyw+1) .le. epx ) THEN<a name='105'>
        grid%i_start(2) = ide-bdyw+1<a name='106'>
        grid%i_end(2)   = min( ide , epx )<a name='107'>
        grid%j_start(2) = max( spy , jds )<a name='108'>
        grid%j_end(2)   = min( epy , jde )<a name='109'>
     ELSE<a name='110'>
        grid%i_start(2) = 1<a name='111'>
        grid%i_end(2)   = -1<a name='112'>
        grid%j_start(2) = 1<a name='113'>
        grid%j_end(2)   = -1<a name='114'>
     ENDIF<a name='115'>
<a name='116'>
<font color=#447700>! YS boundary (note that the corners may already be done by XS and XE)<a name='117'></font>
     IF      ( jds .ge. spy .and. jds .le. epy ) THEN<a name='118'>
        grid%j_start(3) = jds<a name='119'>
        grid%j_end(3)   = min( jds+bdyw-1 , epy )<a name='120'>
        grid%i_start(3) = max( spx , ids+bdyw )<a name='121'>
        grid%i_end(3)   = min( epx , ide-bdyw )<a name='122'>
     ELSEIF  ( (jds+bdyw-1) .ge. spy .and. (jds+bdyw-1) .le. epy ) THEN<a name='123'>
        grid%j_start(3) = max( jds , spy )<a name='124'>
        grid%j_end(3)   = jds+bdyw-1<a name='125'>
        grid%i_start(3) = max( spx , ids+bdyw )<a name='126'>
        grid%i_end(3)   = min( epx , ide-bdyw )<a name='127'>
     ELSE<a name='128'>
        grid%j_start(3) = 1<a name='129'>
        grid%j_end(3)   = -1<a name='130'>
        grid%i_start(3) = 1<a name='131'>
        grid%i_end(3)   = -1<a name='132'>
     ENDIF<a name='133'>
<a name='134'>
<font color=#447700>! YE boundary (note that the corners may already be done by XS and XE)<a name='135'></font>
     IF      ( jde .ge. spy .and. jde .le. epy ) THEN<a name='136'>
        grid%j_start(4) = max( jde-bdyw+1 , spy )<a name='137'>
        grid%j_end(4)   = jde<a name='138'>
        grid%i_start(4) = max( spx , ids+bdyw )<a name='139'>
        grid%i_end(4)   = min( epx , ide-bdyw )<a name='140'>
     ELSEIF  ( (jde-bdyw+1) .ge. spy .and. (jde-bdyw+1) .le. epy ) THEN<a name='141'>
        grid%j_start(4) = jde-bdyw+1<a name='142'>
        grid%j_end(4)   = min( jde , epy )<a name='143'>
        grid%i_start(4) = max( spx , ids+bdyw )<a name='144'>
        grid%i_end(4)   = min( epx , ide-bdyw )<a name='145'>
     ELSE<a name='146'>
        grid%j_start(4) = 1<a name='147'>
        grid%j_end(4)   = -1<a name='148'>
        grid%i_start(4) = 1<a name='149'>
        grid%i_end(4)   = -1<a name='150'>
     ENDIF<a name='151'>
<a name='152'>
     grid%num_tiles = num_tiles<a name='153'>
<a name='154'>
     RETURN<a name='155'>
  END SUBROUTINE set_tiles1<a name='156'>
<a name='157'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='158'></font>
<font color=#447700>! this version callset set_tiles2 but only if the zone hasn't been cached already<a name='159'></font>
<font color=#447700>! Up to MAX_TILING_ZONES allowed<a name='160'></font>
<font color=#447700>! <a name='161'></font>
<A NAME='SET_TILES_ONCE'><A href='../../html_code/frame/module_tiles.F.html#SET_TILES_ONCE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='162'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_tiles_once</font> ( zone, grid , ids , ide , jds , jde , ips , ipe , jps , jpe ) <A href='../../call_to/SET_TILES_ONCE.html' TARGET='index'>1</A>,<A href='../../call_from/SET_TILES_ONCE.html' TARGET='index'>3</A><a name='163'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES_ONCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_165">, ONLY : domain, MAX_TILING_ZONES<a name='164'>
     IMPLICIT NONE<a name='165'>
     TYPE(domain)                   , INTENT(INOUT)  :: grid<a name='166'>
     INTEGER                        , INTENT(IN)     :: zone<a name='167'>
     INTEGER                        , INTENT(IN)     :: ids , ide , jds , jde<a name='168'>
     INTEGER                        , INTENT(IN)     :: ips , ipe , jps , jpe<a name='169'>
       <font color=#447700>! Local<a name='170'></font>
     INTEGER num_tiles, num_tiles_x, num_tiles_y<a name='171'>
     IF ( zone .LT. 1 .OR. zone .GT. MAX_TILING_ZONES ) THEN<a name='172'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES_ONCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_381">('set_tiles_once: zone out of range, increase MAX_TILE_ZONES in module_domain_type')<a name='173'>
     ENDIF<a name='174'>
     IF ( .NOT. grid%tiling_latch(zone) ) THEN<a name='175'>
       grid%tiling_latch(zone) = .TRUE.<a name='176'>
       CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES2'>set_tiles2</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES_ONCE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES2_2"> ( grid, ids, ide, jds, jde, ips, ipe, jps, jpe )<a name='177'>
       num_tiles   = grid%num_tiles<a name='178'>
       num_tiles_x = grid%num_tiles_x<a name='179'>
       num_tiles_y = grid%num_tiles_y<a name='180'>
       ALLOCATE(grid%tile_zones(zone)%i_start(num_tiles))<a name='181'>
       ALLOCATE(grid%tile_zones(zone)%i_end(num_tiles))<a name='182'>
       ALLOCATE(grid%tile_zones(zone)%j_start(num_tiles))<a name='183'>
       ALLOCATE(grid%tile_zones(zone)%j_end(num_tiles))<a name='184'>
       grid%tile_zones(zone)%i_start = grid%i_start <a name='185'>
       grid%tile_zones(zone)%i_end   = grid%i_end <a name='186'>
       grid%tile_zones(zone)%j_start = grid%j_start <a name='187'>
       grid%tile_zones(zone)%j_end   = grid%j_end <a name='188'>
       grid%tile_zones(zone)%num_tiles = num_tiles<a name='189'>
       grid%tile_zones(zone)%num_tiles_x = num_tiles_x<a name='190'>
       grid%tile_zones(zone)%num_tiles_y = num_tiles_y<a name='191'>
     ELSE<a name='192'>
       grid%i_start = grid%tile_zones(zone)%i_start<a name='193'>
       grid%i_end   = grid%tile_zones(zone)%i_end<a name='194'>
       grid%j_start = grid%tile_zones(zone)%j_start<a name='195'>
       grid%j_end   = grid%tile_zones(zone)%j_end<a name='196'>
       grid%num_tiles = grid%tile_zones(zone)%num_tiles<a name='197'>
       grid%num_tiles_x = grid%tile_zones(zone)%num_tiles_x<a name='198'>
       grid%num_tiles_y = grid%tile_zones(zone)%num_tiles_y<a name='199'>
     ENDIF<a name='200'>
  END SUBROUTINE set_tiles_once<a name='201'>
 <a name='202'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='203'></font>
<font color=#447700>! this version is used to limit the domain or compute onto halos<a name='204'></font>
<A NAME='SET_TILES2'><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='205'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_tiles2</font> ( grid , ids , ide , jds , jde , ips , ipe , jps , jpe ) <A href='../../call_to/SET_TILES2.html' TARGET='index'>2</A>,<A href='../../call_from/SET_TILES2.html' TARGET='index'>16</A><a name='206'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_166">, ONLY : domain<a name='207'>
     USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_44"><a name='208'>
     USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_12"><a name='209'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_25"><a name='210'>
<a name='211'>
     IMPLICIT NONE<a name='212'>
  <a name='213'>
     <font color=#447700>!  Input data.<a name='214'></font>
  <a name='215'>
     TYPE(domain)                   , INTENT(INOUT)  :: grid<a name='216'>
     INTEGER                        , INTENT(IN)     :: ids , ide , jds , jde<a name='217'>
     INTEGER                        , INTENT(IN)     :: ips , ipe , jps , jpe<a name='218'>
<a name='219'>
     <font color=#447700>!  Output data.<a name='220'></font>
<a name='221'>
     <font color=#447700>!  Local data.<a name='222'></font>
  <a name='223'>
     INTEGER                                :: num_tiles_x, num_tiles_y, num_tiles_inc,num_tiles<a name='224'>
     INTEGER                                :: tile_strategy,tile_strategy_spec<a name='225'>
     INTEGER                                :: tile_sz_x, tile_sz_y<a name='226'>
     INTEGER                                :: spx, epx, spy, epy, t, tt, ts, te<a name='227'>
     INTEGER                                :: smx, emx, smy, emy<a name='228'>
     INTEGER                                :: ntiles<a name='229'>
     INTEGER                                :: one<a name='230'>
     INTEGER                                :: nt<a name='231'>
#ifdef _OPENMP<a name='232'>
     INTEGER , EXTERNAL        :: omp_get_max_threads<a name='233'>
#endif<a name='234'>
     CHARACTER*255              :: mess<a name='235'>
     CHARACTER*255              :: envval<a name='236'>
     INTEGER                   :: tnum_tiles, istat<a name='237'>
     LOGICAL                   :: verbose <font color=#447700>! whether to output tile info messages<a name='238'></font>
<a name='239'>
     data_ordering : SELECT CASE ( model_data_order )<a name='240'>
       CASE  ( DATA_ORDER_XYZ )<a name='241'>
         spx = grid%sp31 ; epx = grid%ep31 ; spy = grid%sp32 ; epy = grid%ep32<a name='242'>
         smx = grid%sm31 ; emx = grid%em31 ; smy = grid%sm32 ; emy = grid%em32<a name='243'>
       CASE  ( DATA_ORDER_YXZ )<a name='244'>
         spx = grid%sp32 ; epx = grid%ep32 ; spy = grid%sp31 ; epy = grid%ep31<a name='245'>
         smx = grid%sm32 ; emx = grid%em32 ; smy = grid%sm31 ; emy = grid%em31<a name='246'>
       CASE  ( DATA_ORDER_ZXY )<a name='247'>
         spx = grid%sp32 ; epx = grid%ep32 ; spy = grid%sp33 ; epy = grid%ep33<a name='248'>
         smx = grid%sm32 ; emx = grid%em32 ; smy = grid%sm33 ; emy = grid%em33<a name='249'>
       CASE  ( DATA_ORDER_ZYX )<a name='250'>
         spx = grid%sp33 ; epx = grid%ep33 ; spy = grid%sp32 ; epy = grid%ep32<a name='251'>
         smx = grid%sm33 ; emx = grid%em33 ; smy = grid%sm32 ; emy = grid%em32<a name='252'>
       CASE  ( DATA_ORDER_XZY )<a name='253'>
         spx = grid%sp31 ; epx = grid%ep31 ; spy = grid%sp33 ; epy = grid%ep33<a name='254'>
         smx = grid%sm31 ; emx = grid%em31 ; smy = grid%sm33 ; emy = grid%em33<a name='255'>
       CASE  ( DATA_ORDER_YZX )<a name='256'>
         spx = grid%sp33 ; epx = grid%ep33 ; spy = grid%sp31 ; epy = grid%ep31<a name='257'>
         smx = grid%sm33 ; emx = grid%em33 ; smy = grid%sm31 ; emy = grid%em31<a name='258'>
     END SELECT data_ordering<a name='259'>
<a name='260'>
     ERROR_TEST(ips,&lt;,smx)<a name='261'>
     ERROR_TEST(ipe,&gt;,emx)<a name='262'>
     ERROR_TEST(jps,&lt;,smy)<a name='263'>
     ERROR_TEST(jpe,&gt;,emy)<a name='264'>
<a name='265'>
     <font color=#447700>! Here's how the number of tiles is arrived at:<a name='266'></font>
     <font color=#447700>!<a name='267'></font>
     <font color=#447700>!          if tile sizes are specified use those otherwise<a name='268'></font>
     <font color=#447700>!          if num_tiles is specified use that otherwise<a name='269'></font>
     <font color=#447700>!          if omp provides a value use that otherwise<a name='270'></font>
     <font color=#447700>!          use 1.<a name='271'></font>
     <font color=#447700>!<a name='272'></font>
<a name='273'>
     verbose = .false.<a name='274'>
     IF ( grid%num_tiles_spec .EQ. 0 ) THEN<a name='275'>
       verbose = .true.<a name='276'>
       CALL nl_get_numtiles( 1, num_tiles )<a name='277'>
       IF ( num_tiles .EQ. 1 ) THEN<a name='278'>
#ifdef _OPENMP<a name='279'>
         num_tiles = omp_get_max_threads()<a name='280'>
         WRITE(mess,'("WRF NUMBER OF TILES FROM OMP_GET_MAX_THREADS = ",I3)')num_tiles<a name='281'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_376"> ( mess )<a name='282'>
#else<a name='283'>
         num_tiles = 1<a name='284'>
#endif<a name='285'>
         CALL get_environment_variable("WRF_NUM_TILES",envval, status=istat)<a name='286'>
         IF ( envval .NE. "" .and. istat .eq. 0) THEN<a name='287'>
           READ (envval,*) tnum_tiles<a name='288'>
           IF ( tnum_tiles .GT. 0 ) THEN<a name='289'>
             num_tiles=tnum_tiles<a name='290'>
             WRITE(mess,'("WRF NUMBER OF TILES FROM ENV WRF_NUM_TILES = ",I3)')num_tiles<a name='291'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_377"> ( mess )<a name='292'>
           ENDIF<a name='293'>
         ENDIF<a name='294'>
       ENDIF<a name='295'>
<font color=#447700>! override num_tiles setting (however gotten) if tile sizes are specified<a name='296'></font>
       CALL nl_get_tile_sz_x( 1, tile_sz_x )<a name='297'>
       CALL nl_get_tile_sz_y( 1, tile_sz_y )<a name='298'>
       CALL nl_get_tile_strategy( 1, tile_strategy_spec )<a name='299'>
       CALL nl_get_numtiles_inc( 1, num_tiles_inc )<a name='300'>
       CALL nl_get_numtiles_x( 1, num_tiles_x )<a name='301'>
       CALL nl_get_numtiles_y( 1, num_tiles_y )<a name='302'>
       IF ( num_tiles_x .EQ. 0 ) THEN<a name='303'>
         CALL get_environment_variable ("WRF_NUM_TILES_X",envval, status=istat)<a name='304'>
         IF ( envval .NE. "" .and. istat .eq. 0) THEN<a name='305'>
           READ (envval,*) tnum_tiles<a name='306'>
           IF ( tnum_tiles .GT. 0 ) THEN<a name='307'>
             num_tiles_x=tnum_tiles<a name='308'>
             WRITE(mess,'("WRF NUMBER OF TILES X FROM ENV WRF_NUM_TILES_X = ",I3)')num_tiles_x<a name='309'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_378"> ( mess )<a name='310'>
           ENDIF<a name='311'>
         ENDIF<a name='312'>
       ENDIF<a name='313'>
<a name='314'>
       IF ( num_tiles_y .EQ. 0 ) THEN<a name='315'>
         CALL get_environment_variable ("WRF_NUM_TILES_Y",envval, status=istat)<a name='316'>
         IF ( envval .NE. "" .and. istat .eq. 0) THEN<a name='317'>
           READ (envval,*) tnum_tiles<a name='318'>
           IF ( tnum_tiles .GT. 0 ) THEN<a name='319'>
             num_tiles_y=tnum_tiles<a name='320'>
             WRITE(mess,'("WRF NUMBER OF TILES Y FROM ENV WRF_NUM_TILES_Y = ",I3)')num_tiles_y<a name='321'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_379"> ( mess )<a name='322'>
           ENDIF<a name='323'>
         ENDIF<a name='324'>
       ENDIF<a name='325'>
<a name='326'>
       IF ( num_tiles_inc .EQ. 0 ) THEN<a name='327'>
         CALL get_environment_variable ("WRF_NUM_TILES_INC",envval, status=istat)<a name='328'>
         IF ( envval .NE. "" .and. istat .eq. 0) THEN<a name='329'>
           READ (envval,*) tnum_tiles<a name='330'>
           IF ( tnum_tiles .GT. 0 ) THEN<a name='331'>
             num_tiles_inc=tnum_tiles<a name='332'>
             WRITE(mess,'("WRF NUMBER OF TILES INCREMENT FROM ENV WRF_NUM_TILES_INC = ",I3)')num_tiles_inc<a name='333'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_380"> ( mess )<a name='334'>
           ENDIF<a name='335'>
         ENDIF<a name='336'>
       ENDIF<a name='337'>
       num_tiles_inc=max( num_tiles_inc , 1)<a name='338'>
       IF ( tile_strategy_spec == TILE_NONE) then <a name='339'>
          tile_strategy=TILE_Y<a name='340'>
          WRITE(mess,*)'Tile Strategy is not specified. Assuming 1D-Y'<a name='341'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_381"> ( mess )<a name='342'>
          IF ( num_tiles &gt; (epy-spy+1)/MIN_TILE_SIZE .and. num_tiles_x == 0 .and. num_tiles_y == 0) THEN <font color=#447700>! number of tiles is too high. Trying to adjust<a name='343'></font>
            num_tiles_x=1<a name='344'>
            num_tiles_y=(epy-spy+1)/MIN_TILE_SIZE<a name='345'>
            DO WHILE (num_tiles_x*num_tiles_inc*num_tiles_y &lt; num_tiles)<a name='346'>
               num_tiles_x=num_tiles_x+1<a name='347'>
            END DO<a name='348'>
          num_tiles_x=num_tiles_x*num_tiles_inc<a name='349'>
          WRITE(mess,'("Total number of tiles is too big for 1D-Y tiling. Going 2D. New tiling is ",I3,"x",I3)') &amp;<a name='350'>
                        num_tiles_x,num_tiles_y<a name='351'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_382"> ( mess )<a name='352'>
          tile_strategy=TILE_XY<a name='353'>
         ENDIF<a name='354'>
       ELSE<a name='355'>
          tile_strategy = tile_strategy_spec<a name='356'>
       ENDIF<a name='357'>
<a name='358'>
       IF ( tile_sz_x &gt;= 1 .and. tile_sz_y &gt;= 1 ) THEN<a name='359'>
        <font color=#447700>! figure number of whole tiles and add 1 for any partials in each dim<a name='360'></font>
          num_tiles_x = (epx-spx+1) / tile_sz_x<a name='361'>
          if ( tile_sz_x*num_tiles_x &lt; epx-spx+1 ) num_tiles_x = num_tiles_x + 1<a name='362'>
          num_tiles_y = (epy-spy+1) / tile_sz_y<a name='363'>
          if ( tile_sz_y*num_tiles_y &lt; epy-spy+1 ) num_tiles_y = num_tiles_y + 1<a name='364'>
          num_tiles = num_tiles_x * num_tiles_y<a name='365'>
       ELSE<a name='366'>
         IF ( num_tiles_x &gt;= 1 .or. num_tiles_y &gt;= 1 ) THEN<a name='367'>
        <font color=#447700>! adjust num_tiles_? if several ones are omited<a name='368'></font>
           IF ( num_tiles_x &gt;= 1 .and. num_tiles_y &gt;= 1 ) THEN<a name='369'>
              <font color=#447700>!adjust num_tiles<a name='370'></font>
               num_tiles=num_tiles_x*num_tiles_y;<a name='371'>
           ELSE IF ( num_tiles_x &gt;= 1 ) THEN<a name='372'>
               num_tiles_y=num_tiles/num_tiles_x;<a name='373'>
           ELSE <font color=#447700>! IF ( num_tiles_y &gt;= 1 )  THEN<a name='374'></font>
               num_tiles_x=num_tiles/num_tiles_y;<a name='375'>
           ENDIF<a name='376'>
         ELSE<a name='377'>
           IF      ( tile_strategy == TILE_X ) THEN<a name='378'>
             num_tiles_x = num_tiles<a name='379'>
             num_tiles_y = 1<a name='380'>
           ELSE IF ( tile_strategy == TILE_Y ) THEN<a name='381'>
             num_tiles_x = 1<a name='382'>
             num_tiles_y = num_tiles<a name='383'>
           ELSE <font color=#447700>! ( tile_strategy == TILE_XY ) THEN<a name='384'></font>
             one = 1<a name='385'>
             call <A href='../../html_code/frame/module_machine.F.html#LEAST_ASPECT'>least_aspect</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LEAST_ASPECT_1">( num_tiles, one, one, num_tiles_y, num_tiles_x )<a name='386'>
           ENDIF<a name='387'>
         ENDIF<a name='388'>
       ENDIF<a name='389'>
<font color=#447700>!      sanity check <a name='390'></font>
       num_tiles=max( num_tiles , 1)<a name='391'>
       num_tiles_x=max( num_tiles_x , 1)<a name='392'>
       num_tiles_y=max( num_tiles_y , 1)<a name='393'>
       grid%num_tiles_spec = num_tiles<a name='394'>
       grid%num_tiles_x = num_tiles_x<a name='395'>
       grid%num_tiles_y = num_tiles_y<a name='396'>
     ENDIF<a name='397'>
<a name='398'>
     num_tiles   = grid%num_tiles_spec<a name='399'>
     num_tiles_x = grid%num_tiles_x<a name='400'>
     num_tiles_y = grid%num_tiles_y<a name='401'>
<a name='402'>
     IF ( num_tiles &gt; grid%max_tiles ) THEN<a name='403'>
       IF ( ASSOCIATED(grid%i_start) ) THEN ; DEALLOCATE( grid%i_start ) ; NULLIFY( grid%i_start ) ; ENDIF<a name='404'>
       IF ( ASSOCIATED(grid%i_end) )   THEN ; DEALLOCATE( grid%i_end   ) ; NULLIFY( grid%i_end   ) ; ENDIF<a name='405'>
       IF ( ASSOCIATED(grid%j_start) ) THEN ; DEALLOCATE( grid%j_start ) ; NULLIFY( grid%j_start ) ; ENDIF<a name='406'>
       IF ( ASSOCIATED(grid%j_end) )   THEN ; DEALLOCATE( grid%j_end   ) ; NULLIFY( grid%j_end   ) ; ENDIF<a name='407'>
       ALLOCATE(grid%i_start(num_tiles))<a name='408'>
       ALLOCATE(grid%i_end(num_tiles))<a name='409'>
       ALLOCATE(grid%j_start(num_tiles))<a name='410'>
       ALLOCATE(grid%j_end(num_tiles))<a name='411'>
       grid%max_tiles = num_tiles<a name='412'>
     ENDIF<a name='413'>
<a name='414'>
     nt = 1<a name='415'>
     DO t = 0, num_tiles-1<a name='416'>
<a name='417'>
       <font color=#447700>! do y<a name='418'></font>
        ntiles = t / num_tiles_x<a name='419'>
        CALL <A href='../../html_code/frame/module_machine.F.html#REGION_BOUNDS'>region_bounds</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REGION_BOUNDS_1">( spy, epy,                                  &amp;<a name='420'>
                            num_tiles_y, ntiles,                       &amp;<a name='421'>
                            ts, te )<a name='422'>
        <font color=#447700>! first y (major dimension)<a name='423'></font>
        IF ( ts .LE. te ) THEN  <font color=#447700>! converse happens if number of tiles &gt; number of points in dim<a name='424'></font>
<font color=#447700>!!!<a name='425'></font>
<font color=#447700>! This bit allows the user to specify execution out onto the halo region<a name='426'></font>
<font color=#447700>! in the call to set_tiles. If the low patch boundary specified by the arguments<a name='427'></font>
<font color=#447700>! is less than what the model already knows to be the patch boundary and if<a name='428'></font>
<font color=#447700>! the user hasn't erred by specifying something that would fall off memory<a name='429'></font>
<font color=#447700>! (safety tests are higher up in this routine, outside the IF) then adjust<a name='430'></font>
<font color=#447700>! the tile boundary of the low edge tiles accordingly. Likewise for high edges.<a name='431'></font>
          IF ( jps .lt. spy .and. ts .eq. spy ) ts = jps ;<a name='432'>
          IF ( jpe .gt. epy .and. te .eq. epy ) te = jpe ;<a name='433'>
<font color=#447700>!<a name='434'></font>
          grid%j_start(nt) = max ( ts , jds )<a name='435'>
          grid%j_end(nt)   = min ( te , jde )<a name='436'>
<a name='437'>
          <font color=#447700>! now x<a name='438'></font>
          ntiles = mod(t,num_tiles_x)<a name='439'>
          CALL <A href='../../html_code/frame/module_machine.F.html#REGION_BOUNDS'>region_bounds</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REGION_BOUNDS_2">( spx, epx,                                  &amp;<a name='440'>
                              num_tiles_x, ntiles,                       &amp;<a name='441'>
                              ts, te )<a name='442'>
          IF ( ts .LE. te ) THEN  <font color=#447700>! converse happens if number of tiles &gt; number of points in dim<a name='443'></font>
            IF ( ips .lt. spx .and. ts .eq. spx ) ts = ips ;<a name='444'>
            IF ( ipe .gt. epx .and. te .eq. epx ) te = ipe ;<a name='445'>
<font color=#447700>!!!<a name='446'></font>
            grid%i_start(nt) = max ( ts , ids )<a name='447'>
            grid%i_end(nt)   = min ( te , ide )<a name='448'>
            IF ( verbose ) THEN<a name='449'>
              WRITE(mess,'("WRF TILE ",I3," IS ",I6," IE ",I6," JS ",I6," JE ",I6)') &amp;<a name='450'>
                        nt,grid%i_start(nt),grid%i_end(nt),grid%j_start(nt),grid%j_end(nt)<a name='451'>
              CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_383"> ( mess )<a name='452'>
            ENDIF<a name='453'>
            nt = nt + 1<a name='454'>
          ENDIF<a name='455'>
        ENDIF<a name='456'>
     END DO<a name='457'>
     num_tiles = nt-1<a name='458'>
     IF ( verbose ) THEN<a name='459'>
       WRITE(mess,'("WRF NUMBER OF TILES = ",I3)')num_tiles<a name='460'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>WRF_MESSAGE</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES2' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_384"> ( mess )<a name='461'>
     ENDIF<a name='462'>
     grid%num_tiles = num_tiles<a name='463'>
<a name='464'>
     RETURN<a name='465'>
  END SUBROUTINE set_tiles2<a name='466'>
<a name='467'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<a name='468'></font>
<font color=#447700>! this version sets the tiles based on a passed in integer mask<a name='469'></font>
<font color=#447700>! the assumption here is that the mask is relatively straigthforward<a name='470'></font>
<font color=#447700>! and coverable with 2 or three rectangles. No weird stuff...<a name='471'></font>
<a name='472'>
<A NAME='SET_TILES3'><A href='../../html_code/frame/module_tiles.F.html#SET_TILES3' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='473'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_tiles3</font> ( grid , imask, ims, ime, jms, jme, ips, ipe, jps, jpe ) <A href='../../call_to/SET_TILES3.html' TARGET='index'>1</A>,<A href='../../call_from/SET_TILES3.html' TARGET='index'>7</A><a name='474'>
     USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_167">, ONLY : domain<a name='475'>
     USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_45"><a name='476'>
     USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_13"><a name='477'>
     USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_26"><a name='478'>
<a name='479'>
     IMPLICIT NONE<a name='480'>
  <a name='481'>
     <font color=#447700>!  Input data.<a name='482'></font>
  <a name='483'>
     TYPE(domain)                   , INTENT(INOUT)  :: grid<a name='484'>
     INTEGER                        , INTENT(IN)     :: ims , ime , jms , jme<a name='485'>
     INTEGER                        , INTENT(IN)     :: ips , ipe , jps , jpe<a name='486'>
     INTEGER, DIMENSION(ims:ime,jms:jme), INTENT(IN) :: imask<a name='487'>
     INTEGER                :: num_tiles<a name='488'>
     INTEGER, DIMENSION(50) :: i_start, i_end, j_start, j_end<a name='489'>
<a name='490'>
     <font color=#447700>!  Output data.<a name='491'></font>
<a name='492'>
     <font color=#447700>!  Local data.<a name='493'></font>
     INTEGER nt<a name='494'>
     CHARACTER*80              :: mess<a name='495'>
<a name='496'>
     CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES_MASKED'>set_tiles_masked</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_MASKED_1"> ( imask, ims, ime, jms, jme, ips, ipe, jps, jpe, &amp;<a name='497'>
                             num_tiles, i_start, i_end, j_start, j_end )<a name='498'>
<a name='499'>
     IF ( num_tiles &gt; grid%max_tiles ) THEN<a name='500'>
       IF ( ASSOCIATED(grid%i_start) ) THEN ; DEALLOCATE( grid%i_start ) ; NULLIFY( grid%i_start ) ; ENDIF<a name='501'>
       IF ( ASSOCIATED(grid%i_end) )   THEN ; DEALLOCATE( grid%i_end   ) ; NULLIFY( grid%i_end   ) ; ENDIF<a name='502'>
       IF ( ASSOCIATED(grid%j_start) ) THEN ; DEALLOCATE( grid%j_start ) ; NULLIFY( grid%j_start ) ; ENDIF<a name='503'>
       IF ( ASSOCIATED(grid%j_end) )   THEN ; DEALLOCATE( grid%j_end   ) ; NULLIFY( grid%j_end   ) ; ENDIF<a name='504'>
       ALLOCATE(grid%i_start(num_tiles))<a name='505'>
       ALLOCATE(grid%i_end(num_tiles))<a name='506'>
       ALLOCATE(grid%j_start(num_tiles))<a name='507'>
       ALLOCATE(grid%j_end(num_tiles))<a name='508'>
       grid%max_tiles = num_tiles<a name='509'>
     ENDIF<a name='510'>
     grid%num_tiles = num_tiles<a name='511'>
     grid%i_start(1:num_tiles) = i_start(1:num_tiles)<a name='512'>
     grid%i_end(1:num_tiles)   = i_end(1:num_tiles)<a name='513'>
     grid%j_start(1:num_tiles) = j_start(1:num_tiles)<a name='514'>
     grid%j_end(1:num_tiles)   = j_end(1:num_tiles)<a name='515'>
     DO nt = 1, num_tiles<a name='516'>
        WRITE(mess,'("WRF TILE ",I3," IS ",I6," IE ",I6," JS ",I6," JE ",I6)') &amp;<a name='517'>
                      nt,grid%i_start(nt),grid%i_end(nt),grid%j_start(nt),grid%j_end(nt)<a name='518'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_301"> ( 1, mess )<a name='519'>
     ENDDO<a name='520'>
     WRITE(mess,'("set_tiles3: NUMBER OF TILES = ",I3)')num_tiles<a name='521'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_tiles.F.html#SET_TILES3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_302"> ( 1, mess )<a name='522'>
<a name='523'>
     RETURN<a name='524'>
  END SUBROUTINE set_tiles3<a name='525'>
<a name='526'>
<A NAME='SET_TILES_MASKED'><A href='../../html_code/frame/module_tiles.F.html#SET_TILES_MASKED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='527'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_tiles_masked</font> ( imask, ims, ime, jms, jme, ips, ipe, jps, jpe, &amp; <A href='../../call_to/SET_TILES_MASKED.html' TARGET='index'>1</A><a name='528'>
                                num_tiles, istarts, iends, jstarts, jends )<a name='529'>
<a name='530'>
      IMPLICIT NONE<a name='531'>
<a name='532'>
      <font color=#447700>!  Arguments<a name='533'></font>
<a name='534'>
      INTEGER                        , INTENT(IN)     :: ims , ime , jms , jme<a name='535'>
      INTEGER, DIMENSION(ims:ime,jms:jme), INTENT(IN) :: imask<a name='536'>
      INTEGER                        , INTENT(IN)     :: ips , ipe , jps , jpe<a name='537'>
      INTEGER                        , INTENT(OUT)    :: num_tiles<a name='538'>
      INTEGER, DIMENSION(*)          , INTENT(OUT)    :: istarts, iends<a name='539'>
      INTEGER, DIMENSION(*)          , INTENT(OUT)    :: jstarts, jends<a name='540'>
<a name='541'>
      <font color=#447700>!  Output data.<a name='542'></font>
<a name='543'>
      <font color=#447700>!  Local data.<a name='544'></font>
      CHARACTER*80              :: mess<a name='545'>
      INTEGER :: i, j, ir, jr<a name='546'>
      INTEGER :: imaskcopy(ips:ipe,jps:jpe)    <font color=#447700>! copy of imask to write on<a name='547'></font>
<a name='548'>
      imaskcopy = imask(ips:ipe,jps:jpe)<a name='549'>
      num_tiles = 0<a name='550'>
      <font color=#447700>! simple multi-pass scheme, optimize later...<a name='551'></font>
      DO WHILE (ANY(imaskcopy == 1))<a name='552'>
        DO j = jps,jpe<a name='553'>
          DO i = ips,ipe<a name='554'>
            <font color=#447700>! find first "1" and build a rectangle from it<a name='555'></font>
            IF ( imaskcopy(i,j) == 1 ) THEN<a name='556'>
              num_tiles = num_tiles + 1<a name='557'>
              istarts(num_tiles) = i<a name='558'>
              iends(num_tiles)   = i<a name='559'>
              jstarts(num_tiles) = j<a name='560'>
              jends(num_tiles)   = j<a name='561'>
              <font color=#447700>! don't check this point again<a name='562'></font>
              imaskcopy(i,j) = 0<a name='563'>
              <font color=#447700>! find length of first row<a name='564'></font>
              DO ir = istarts(num_tiles)+1,ipe<a name='565'>
                IF ( imaskcopy(ir,j) == 1 ) THEN<a name='566'>
                  iends(num_tiles) = ir<a name='567'>
                  <font color=#447700>! don't check this point again<a name='568'></font>
                  imaskcopy(ir,j) = 0<a name='569'>
                ELSE<a name='570'>
                  EXIT<a name='571'>
                ENDIF<a name='572'>
              ENDDO<a name='573'>
              <font color=#447700>! find number of rows<a name='574'></font>
              DO jr = jstarts(num_tiles)+1,jpe<a name='575'>
                IF (ALL(imaskcopy(istarts(num_tiles):iends(num_tiles),jr) == 1)) THEN<a name='576'>
                  jends(num_tiles) = jr<a name='577'>
                  <font color=#447700>! don't check these points again<a name='578'></font>
                  imaskcopy(istarts(num_tiles):iends(num_tiles),jr) = 0<a name='579'>
                ELSE<a name='580'>
                  EXIT<a name='581'>
                ENDIF<a name='582'>
              ENDDO<a name='583'>
            ENDIF   <font color=#447700>! if ( imaskcopy(i,j) == 1 )<a name='584'></font>
          ENDDO<a name='585'>
        ENDDO<a name='586'>
      ENDDO<a name='587'>
      RETURN<a name='588'>
  END SUBROUTINE set_tiles_masked<a name='589'>
<a name='590'>
  <a name='591'>
<A NAME='INIT_MODULE_TILES'><A href='../../html_code/frame/module_tiles.F.html#INIT_MODULE_TILES' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='592'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_tiles</font> <A href='../../call_to/INIT_MODULE_TILES.html' TARGET='index'>2</A><a name='593'>
  END SUBROUTINE init_module_tiles<a name='594'>
<a name='595'>
END MODULE module_tiles<a name='596'>
<a name='597'>
</pre></body></html>