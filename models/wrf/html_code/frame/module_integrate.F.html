<HTML> <BODY BGCOLOR=#eeddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:INTEGRATION<a name='2'></font>
<font color=#447700>!<a name='3'></font>
<a name='4'>
<A NAME='MODULE_INTEGRATE'><A href='../../html_code/frame/module_integrate.F.html#MODULE_INTEGRATE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='5'>
<font color=#993300>MODULE </font><font color=#cc0000>module_integrate</font> <A href='../../call_to/MODULE_INTEGRATE.html' TARGET='index'>3</A><a name='6'>
<a name='7'>
CONTAINS<a name='8'>
<a name='9'>
<A NAME='INTEGRATE'><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10'>
RECURSIVE <font color=#993300>SUBROUTINE </font><font color=#cc0000>integrate</font> ( grid ) <A href='../../call_to/INTEGRATE.html' TARGET='index'>2</A>,<A href='../../call_from/INTEGRATE.html' TARGET='index'>84</A><a name='11'>
<a name='12'>
<a name='13'>
<a name='14'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_138"><a name='15'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_31"><a name='16'>
   USE <A href='../../html_code/frame/module_nesting.F.html#MODULE_NESTING'>module_nesting</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_NESTING_2"><a name='17'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_86"><a name='18'>
   USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_24"><a name='19'>
   USE module_utility<a name='20'>
   USE <A href='../../html_code/frame/module_cpl.F.html#MODULE_CPL'>module_cpl</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CPL_4">, ONLY : coupler_on, cpl_snd, cpl_defdomain<a name='21'>
#ifdef DM_PARALLEL<a name='22'>
<font color=#447700>! better if this did not need to be used here. Problem is that the definition of <a name='23'></font>
<font color=#447700>! domain_active_this_task comes from module_dm, and the routine it's being passed to (alloc_and_configure_domain)<a name='24'></font>
<font color=#447700>! is defined in module_domain, which uses module_dm.  If that weren't the case, we could have the<a name='25'></font>
<font color=#447700>! alloc_and_configure_domain routine get this form the module_dm module itself, but as it stands there<a name='26'></font>
<font color=#447700>! would be a circular use association.  jm 20140828<a name='27'></font>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_122">, ONLY:  domain_active_this_task <font color=#447700>!, push_communicators_for_domain, pop_communicators_for_domain<a name='28'></font>
#endif<a name='29'>
<a name='30'>
   IMPLICIT NONE<a name='31'>
<a name='32'>
   <font color=#447700>!  Input data.<a name='33'></font>
<a name='34'>
   TYPE(domain) , POINTER :: grid<a name='35'>
<a name='36'>
<font color=#447700>! module_integrate:integrate<a name='37'></font>
<font color=#447700>! &lt;DESCRIPTION&gt; <a name='38'></font>
<font color=#447700>! This is a driver-level routine that controls the integration of a<a name='39'></font>
<font color=#447700>! domain and subdomains rooted at the domain. <a name='40'></font>
<font color=#447700>! <a name='41'></font>
<font color=#447700>! The integrate routine takes a domain pointed to by the argument<a name='42'></font>
<font color=#447700>! &lt;em&gt;grid&lt;/em&gt; and advances the domain and its associated nests from the<a name='43'></font>
<font color=#447700>! grid's current time, stored within grid%domain_clock, to a given time<a name='44'></font>
<font color=#447700>! forward in the simulation, stored as grid%stop_subtime. The<a name='45'></font>
<font color=#447700>! stop_subtime value is arbitrary and does not have to be the same as<a name='46'></font>
<font color=#447700>! time that the domain finished integrating.  The simulation stop time<a name='47'></font>
<font color=#447700>! for the grid is known to the grid's clock (grid%domain_clock) and that<a name='48'></font>
<font color=#447700>! is checked with a call to domain_clockisstoptime prior to beginning the<a name='49'></font>
<font color=#447700>! loop over time period that is specified by the<a name='50'></font>
<font color=#447700>! current time/stop_subtime interval.<a name='51'></font>
<font color=#447700>! <a name='52'></font>
<font color=#447700>! The clock, the simulation stop time for the domain, and other timing<a name='53'></font>
<font color=#447700>! aspects for the grid are set up in the routine<a name='54'></font>
<font color=#447700>! (&lt;a href="setup_timekeeping.html"&gt;setup_timekeeping&lt;/a&gt;) at the time<a name='55'></font>
<font color=#447700>! that the domain is initialized.<a name='56'></font>
<font color=#447700>! The lower-level time library and the type declarations for the times<a name='57'></font>
<font color=#447700>! and time intervals used are defined either in <a name='58'></font>
<font color=#447700>! external/esmf_time_f90/module_utility.F90 or in <a name='59'></font>
<font color=#447700>! external/io_esmf/module_utility.F90 depending on a build-time decision to <a name='60'></font>
<font color=#447700>! incorporate either the embedded ESMF subset implementation contained in <a name='61'></font>
<font color=#447700>! external/esmf_time_f90 or to use a site-specific installation of the ESMF <a name='62'></font>
<font color=#447700>! library.  This decision is made during the configuration step of the WRF <a name='63'></font>
<font color=#447700>! build process.  Note that arithmetic and comparison is performed on these <a name='64'></font>
<font color=#447700>! data types using F90 operator overloading, also defined in that library.<a name='65'></font>
<font color=#447700>! <a name='66'></font>
<font color=#447700>! This routine is the lowest level of the WRF Driver Layer and for the most<a name='67'></font>
<font color=#447700>! part the WRF routines that are called from here are in the topmost level<a name='68'></font>
<font color=#447700>! of the Mediation Layer.  Mediation layer routines typically are not <a name='69'></font>
<font color=#447700>! defined in modules. Therefore, the routines that this routine calls<a name='70'></font>
<font color=#447700>! have explicit interfaces specified in an interface block in this routine.<a name='71'></font>
<font color=#447700>!<a name='72'></font>
<font color=#447700>! As part of the Driver Layer, this routine is intended to be non model-specific<a name='73'></font>
<font color=#447700>! and so a minimum of WRF-specific logic is coded at this level. Rather, there<a name='74'></font>
<font color=#447700>! are a number of calls to mediation layer routines that contain this logic, some<a name='75'></font>
<font color=#447700>! of which are merely stubs in WRF Mediation Layer that sits below this routine<a name='76'></font>
<font color=#447700>! in the call tree.  The routines that integrate calls in WRF are defined in<a name='77'></font>
<font color=#447700>! share/mediation_integrate.F.<a name='78'></font>
<font color=#447700>! <a name='79'></font>
<font color=#447700>! Flow of control<a name='80'></font>
<font color=#447700>! <a name='81'></font>
<font color=#447700>! 1. Check to see that the domain is not finished <a name='82'></font>
<font color=#447700>! by testing the value returned by domain_clockisstoptime for the<a name='83'></font>
<font color=#447700>! domain.<a name='84'></font>
<font color=#447700>! <a name='85'></font>
<font color=#447700>! 2. &lt;a href=model_to_grid_config_rec.html&gt;Model_to_grid_config_rec&lt;/a&gt; is called to load the local config_flags<a name='86'></font>
<font color=#447700>! structure with the configuration information for the grid stored<a name='87'></font>
<font color=#447700>! in model_config_rec and indexed by the grid's unique integer id. These<a name='88'></font>
<font color=#447700>! structures are defined in frame/module_configure.F.<a name='89'></font>
<font color=#447700>! <a name='90'></font>
<font color=#447700>! 3. The current time of the domain is retrieved from the domain's clock<a name='91'></font>
<font color=#447700>! using domain_get_current_time.  <a name='92'></font>
<font color=#447700>! <a name='93'></font>
<font color=#447700>! 4. Iterate forward while the current time is less than the stop subtime.<a name='94'></font>
<font color=#447700>! <a name='95'></font>
<font color=#447700>! 4.a. Start timing for this iteration (only on node zero in distributed-memory runs)<a name='96'></font>
<font color=#447700>! <a name='97'></font>
<font color=#447700>! 4.b. Call &lt;a href=med_setup_step.html&gt;med_setup_step&lt;/a&gt; to allow the mediation layer to <a name='98'></font>
<font color=#447700>! do anything that's needed to call the solver for this domain.  In WRF this means setting<a name='99'></font>
<font color=#447700>! the indices into the 4D tracer arrays for the domain.<a name='100'></font>
<font color=#447700>! <a name='101'></font>
<font color=#447700>! 4.c. Check for any nests that need to be started up at this time.  This is done <a name='102'></font>
<font color=#447700>! calling the logical function &lt;a href=nests_to_open.html&gt;nests_to_open&lt;/a&gt; (defined in <a name='103'></font>
<font color=#447700>! frame/module_nesting.F) which returns true and the index into the current domain's list<a name='104'></font>
<font color=#447700>! of children to use for the nest when one needs to be started.<a name='105'></font>
<font color=#447700>! <a name='106'></font>
<font color=#447700>! 4.c.1  Call &lt;a href=alloc_and_configure_domain.html&gt;alloc_and_configure_domain&lt;/a&gt; to allocate<a name='107'></font>
<font color=#447700>! the new nest and link it as a child of this grid.<a name='108'></font>
<font color=#447700>! <a name='109'></font>
<font color=#447700>! 4.c.2  Call &lt;a href=setup_Timekeeping.html&gt;setup_Timekeeping&lt;/a&gt; for the nest.<a name='110'></font>
<font color=#447700>! <a name='111'></font>
<font color=#447700>! 4.c.3  Initialize the nest's arrays by calling &lt;a href=med_nest_initial.html&gt;med_nest_initial&lt;/a&gt;. This will<a name='112'></font>
<font color=#447700>! either interpolate data from this grid onto the nest, read it in from a file, or both. In a restart run, this<a name='113'></font>
<font color=#447700>! is also where the nest reads in its restart file.<a name='114'></font>
<font color=#447700>! <a name='115'></font>
<font color=#447700>! 4.d  If a nest was opened above, check for and resolve overlaps (this is not implemented in WRF 2.0, which<a name='116'></font>
<font color=#447700>! supports multiple nests on the same level but does not support overlapping).<a name='117'></font>
<font color=#447700>! <a name='118'></font>
<font color=#447700>! 4.e  Give the mediation layer an opportunity to do something before the solver is called by<a name='119'></font>
<font color=#447700>! calling &lt;a href=med_before_solve_io.html&gt;med_before_solve_io&lt;/a&gt;. In WRF this is the point at which history and<a name='120'></font>
<font color=#447700>! restart data is output.<a name='121'></font>
<font color=#447700>! <a name='122'></font>
<font color=#447700>! 4.f  Call &lt;a href=solve_interface.html&gt;solve_interface&lt;/a&gt; which calls the solver that advance the domain <a name='123'></font>
<font color=#447700>! one time step, then advance the domain's clock by calling domain_clockadvance.  <a name='124'></font>
<font color=#447700>! The enclosing WHILE loop around this section is for handling other domains <a name='125'></font>
<font color=#447700>! with which this domain may overlap.  It is not active in WRF 2.0 and only <a name='126'></font>
<font color=#447700>! executes one trip.  <a name='127'></font>
<font color=#447700>! <a name='128'></font>
<font color=#447700>! 4.g Call med_calc_model_time and med_after_solve_io, which are stubs in WRF.<a name='129'></font>
<font color=#447700>! <a name='130'></font>
<font color=#447700>! 4.h Iterate over the children of this domain (&lt;tt&gt;DO kid = 1, max_nests&lt;/tt&gt;) and check each child pointer to see<a name='131'></font>
<font color=#447700>! if it is associated (and therefore, active).<a name='132'></font>
<font color=#447700>! <a name='133'></font>
<font color=#447700>! 4.h.1  Force the nested domain boundaries from this domain by calling &lt;a href=med_nest_force.html&gt;med_nest_force&lt;/a&gt;.<a name='134'></font>
<font color=#447700>! <a name='135'></font>
<font color=#447700>! 4.h.2  Setup the time period over which the nest is to run. Sine the current grid has been advanced one time step<a name='136'></font>
<font color=#447700>! and the nest has not, the start for the nest is this grid's current time minus one time step.  The nest's stop_subtime<a name='137'></font>
<font color=#447700>! is the current time, bringing the nest up the same time level as this grid, its parent.<a name='138'></font>
<font color=#447700>! <a name='139'></font>
<font color=#447700>! 4.h.3  Recursively call this routine, integrate, to advance the nest's time.  Since it is recursive, this will<a name='140'></font>
<font color=#447700>! also advance all the domains who are nests of this nest and so on.  In other words, when this call returns, all<a name='141'></font>
<font color=#447700>! the domains rooted at the nest will be at the current time.<a name='142'></font>
<font color=#447700>! <a name='143'></font>
<font color=#447700>! 4.h.4  Feedback data from the nested domain back onto this domain by calling &lt;a href=med_nest_feedback.html&gt;med_nest_feedback&lt;/a&gt;.<a name='144'></font>
<font color=#447700>! <a name='145'></font>
<font color=#447700>! 4.i  Write the time to compute this grid and its subtree. This marks the end of the loop begun at step 4, above.<a name='146'></font>
<font color=#447700>! <a name='147'></font>
<font color=#447700>! 5. Give the mediation layer an opportunity to do I/O at the end of the sequence of steps that brought the<a name='148'></font>
<font color=#447700>! grid up to stop_subtime with a call to &lt;a href=med_last_solve_io.html&gt;med_last_solve_io&lt;/a&gt;.  In WRF, this <a name='149'></font>
<font color=#447700>! is used to generate the final history and/or restart output when the domain reaches the end of it's integration.<a name='150'></font>
<font color=#447700>! There is logic here to make sure this occurs correctly on a nest, since the nest may finish before its parent.<a name='151'></font>
<font color=#447700>! &lt;/DESCRIPTION&gt;<a name='152'></font>
<a name='153'>
   <font color=#447700>!  Local data.<a name='154'></font>
<a name='155'>
   CHARACTER*32                           :: outname, rstname<a name='156'>
   TYPE(domain) , POINTER                 :: grid_ptr , new_nest<a name='157'>
   TYPE(domain)                           :: intermediate_grid<a name='158'>
   INTEGER                                :: step<a name='159'>
   INTEGER                                :: nestid , kid<a name='160'>
   LOGICAL                                :: a_nest_was_opened<a name='161'>
   INTEGER                                :: fid , rid<a name='162'>
   LOGICAL                                :: lbc_opened<a name='163'>
   REAL                                   :: time, btime, bfrq<a name='164'>
   CHARACTER*256                          :: message, message2,message3<a name='165'>
   TYPE (grid_config_rec_type)            :: config_flags<a name='166'>
   LOGICAL , EXTERNAL                     :: wrf_dm_on_monitor<a name='167'>
   INTEGER                                :: idum1 , idum2 , ierr , open_status<a name='168'>
   LOGICAL                                :: should_do_last_io<a name='169'>
   LOGICAL                                :: may_have_moved<a name='170'>
<a name='171'>
<a name='172'>
   <font color=#447700>! interface<a name='173'></font>
   INTERFACE<a name='174'>
       <font color=#447700>! mediation-supplied solver<a name='175'></font>
     SUBROUTINE solve_interface ( grid )<a name='176'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_139"><a name='177'>
       TYPE (domain) grid<a name='178'>
     END SUBROUTINE solve_interface<a name='179'>
       <font color=#447700>! mediation-supplied routine to allow driver to pass time information<a name='180'></font>
       <font color=#447700>! down to mediation/model layer<a name='181'></font>
     SUBROUTINE med_calc_model_time ( grid , config_flags )<a name='182'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_140"><a name='183'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_87"><a name='184'>
       TYPE (domain) grid<a name='185'>
       TYPE (grid_config_rec_type) config_flags<a name='186'>
     END SUBROUTINE med_calc_model_time<a name='187'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='188'></font>
       <font color=#447700>! perform I/O before the call to the solve routine<a name='189'></font>
     SUBROUTINE med_before_solve_io ( grid , config_flags )<a name='190'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_141"><a name='191'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_88"><a name='192'>
       TYPE (domain) grid<a name='193'>
       TYPE (grid_config_rec_type) config_flags<a name='194'>
     END SUBROUTINE med_before_solve_io<a name='195'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='196'></font>
       <font color=#447700>! perform I/O after the call to the solve routine<a name='197'></font>
     SUBROUTINE med_after_solve_io ( grid , config_flags )<a name='198'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_142"><a name='199'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_89"><a name='200'>
       TYPE (domain) grid<a name='201'>
       TYPE (grid_config_rec_type) config_flags<a name='202'>
     END SUBROUTINE med_after_solve_io<a name='203'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='204'></font>
       <font color=#447700>! perform I/O to initialize a new nest<a name='205'></font>
     SUBROUTINE med_pre_nest_initial ( parent , newid , config_flags )<a name='206'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_143"><a name='207'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_90"><a name='208'>
       TYPE (domain), POINTER ::  parent<a name='209'>
       INTEGER, INTENT(IN)    ::  newid<a name='210'>
       TYPE (grid_config_rec_type) config_flags<a name='211'>
     END SUBROUTINE med_pre_nest_initial<a name='212'>
     SUBROUTINE med_nest_initial ( parent , grid , config_flags )<a name='213'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_144"><a name='214'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_91"><a name='215'>
       TYPE (domain), POINTER ::  grid , parent<a name='216'>
       TYPE (grid_config_rec_type) config_flags<a name='217'>
     END SUBROUTINE med_nest_initial<a name='218'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='219'></font>
       <font color=#447700>! provide parent-&gt;nest forcing<a name='220'></font>
     SUBROUTINE med_nest_force ( parent , grid )<a name='221'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_145"><a name='222'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_92"><a name='223'>
       TYPE (domain), POINTER ::  grid, parent<a name='224'>
     END SUBROUTINE med_nest_force<a name='225'>
<a name='226'>
#ifdef MOVE_NESTS<a name='227'>
     SUBROUTINE med_nest_move ( parent , grid )<a name='228'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_146"><a name='229'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_93"><a name='230'>
       TYPE (domain), POINTER ::  grid , parent<a name='231'>
     END SUBROUTINE med_nest_move<a name='232'>
     SUBROUTINE reconcile_nest_positions_over_tasks ( grid )<a name='233'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_147"><a name='234'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_94"><a name='235'>
       TYPE (domain), POINTER ::  grid<a name='236'>
     END SUBROUTINE reconcile_nest_positions_over_tasks<a name='237'>
#endif<a name='238'>
<a name='239'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='240'></font>
       <font color=#447700>! provide parent-&gt;nest feedback<a name='241'></font>
     SUBROUTINE med_nest_feedback ( parent , grid , config_flags )<a name='242'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_148"><a name='243'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_95"><a name='244'>
       TYPE (domain), POINTER ::  grid , parent<a name='245'>
       TYPE (grid_config_rec_type) config_flags<a name='246'>
     END SUBROUTINE med_nest_feedback<a name='247'>
<a name='248'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='249'></font>
       <font color=#447700>! perform I/O prior to the close of this call to integrate<a name='250'></font>
     SUBROUTINE med_last_solve_io ( grid , config_flags )<a name='251'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_149"><a name='252'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_96"><a name='253'>
       TYPE (domain) grid<a name='254'>
       TYPE (grid_config_rec_type) config_flags<a name='255'>
     END SUBROUTINE med_last_solve_io<a name='256'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to <a name='257'></font>
       <font color=#447700>! perform setup before iteration over steps in this call to integrate<a name='258'></font>
     SUBROUTINE med_setup_step ( grid , config_flags )<a name='259'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_150"><a name='260'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_97"><a name='261'>
       TYPE (domain) grid<a name='262'>
       TYPE (grid_config_rec_type) config_flags<a name='263'>
     END SUBROUTINE med_setup_step<a name='264'>
       <font color=#447700>! mediation-supplied routine that gives mediation layer opportunity to<a name='265'></font>
       <font color=#447700>! perform setup before iteration over steps in this call to integrate<a name='266'></font>
     SUBROUTINE med_endup_step ( grid , config_flags )<a name='267'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_151"><a name='268'>
       USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_98"><a name='269'>
       TYPE (domain) grid<a name='270'>
       TYPE (grid_config_rec_type) config_flags<a name='271'>
     END SUBROUTINE med_endup_step<a name='272'>
       <font color=#447700>! mediation-supplied routine that intializes the nest from the grid<a name='273'></font>
       <font color=#447700>! by interpolation<a name='274'></font>
<a name='275'>
     SUBROUTINE Setup_Timekeeping( grid )<a name='276'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_152"><a name='277'>
       TYPE(domain), POINTER :: grid<a name='278'>
     END SUBROUTINE<a name='279'>
<a name='280'>
     SUBROUTINE dfi_accumulate( grid )<a name='281'>
       USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_153"><a name='282'>
       TYPE(domain), POINTER :: grid<a name='283'>
     END SUBROUTINE<a name='284'>
<a name='285'>
   END INTERFACE<a name='286'>
<a name='287'>
   <font color=#447700>! This allows us to reference the current grid from anywhere beneath <a name='288'></font>
   <font color=#447700>! this point for debugging purposes.  <a name='289'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_1">( grid )<a name='290'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#PUSH_COMMUNICATORS_FOR_DOMAIN'>push_communicators_for_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PUSH_COMMUNICATORS_FOR_DOMAIN_15">( grid%id )<a name='291'>
<a name='292'>
   IF ( .NOT. domain_clockisstoptime( grid ) ) THEN<a name='293'>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_15"> ( grid%id , model_config_rec , config_flags )<a name='294'>
      IF ( config_flags%grid_allowed ) THEN<a name='295'>
         CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCKPRINT'>domain_clockprint</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCKPRINT_4"> ( 150, grid, 'DEBUG:  top of integrate(),' )<a name='296'>
         DO WHILE ( .NOT. domain_clockisstopsubtime(grid) )<a name='297'>
            IF ( wrf_dm_on_monitor() ) THEN<a name='298'>
IF ( grid%active_this_task ) THEN<a name='299'>
               CALL <A href='../../html_code/frame/module_timing.F.html#START_TIMING'>start_timing</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="START_TIMING_5"><a name='300'>
END IF<a name='301'>
            END IF<a name='302'>
            CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_SETUP_STEP'>med_setup_step</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_SETUP_STEP_1"> ( grid , config_flags )<a name='303'>
            a_nest_was_opened = .false.<a name='304'>
            <font color=#447700>! for each nest whose time has come...<a name='305'></font>
            DO WHILE ( nests_to_open( grid , nestid , kid ) )<a name='306'>
               <font color=#447700>! nestid is index into model_config_rec (module_configure) of the grid<a name='307'></font>
               <font color=#447700>! to be opened; kid is index into an open slot in grid's list of children<a name='308'></font>
               a_nest_was_opened = .true.<a name='309'>
               CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_PRE_NEST_INITIAL'>med_pre_nest_initial</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_PRE_NEST_INITIAL_1"> ( grid , nestid , config_flags )<a name='310'>
               CALL <A href='../../html_code/frame/module_domain.F.html#ALLOC_AND_CONFIGURE_DOMAIN'>alloc_and_configure_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALLOC_AND_CONFIGURE_DOMAIN_1"> ( domain_id  = nestid ,   &amp;<a name='311'>
<font color=#447700>! better if this were not ifdef'd here, try moving into module_dm? see comment above. jm 20140828<a name='312'></font>
#ifdef DM_PARALLEL<a name='313'>
                                           active_this_task = domain_active_this_task( nestid ), &amp;<a name='314'>
#endif<a name='315'>
                                                 grid       = new_nest , &amp;<a name='316'>
                                                 parent     = grid ,     &amp;<a name='317'>
                                                 kid        = kid        )<a name='318'>
               CALL <A href='../../html_code/share/set_timekeeping.F.html#SETUP_TIMEKEEPING'>Setup_Timekeeping</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_TIMEKEEPING_1"> (new_nest)<a name='319'>
               CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_INITIAL'>med_nest_initial</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_INITIAL_1"> ( grid , new_nest , config_flags )<a name='320'>
IF ( grid%active_this_task ) THEN<a name='321'>
               IF ( grid%dfi_stage == DFI_STARTFWD ) THEN<a name='322'>
                  CALL <A href='../../html_code/share/dfi.F.html#WRF_DFI_STARTFWD_INIT'>wrf_dfi_startfwd_init</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DFI_STARTFWD_INIT_1">(new_nest)<a name='323'>
               ENDIF<a name='324'>
               IF (coupler_on) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_DEFDOMAIN'>cpl_defdomain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_DEFDOMAIN_1">( new_nest ) <a name='325'>
ENDIF <font color=#447700>! active_this_task<a name='326'></font>
            END DO<a name='327'>
            IF ( a_nest_was_opened ) THEN<a name='328'>
               CALL <A href='../../html_code/frame/module_nesting.F.html#SET_OVERLAPS'>set_overlaps</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_OVERLAPS_1"> ( grid )   <font color=#447700>! find overlapping and set pointers<a name='329'></font>
            END IF<a name='330'>
<a name='331'>
IF ( grid%active_this_task ) THEN<a name='332'>
            <font color=#447700>! Accumulation calculation for DFI<a name='333'></font>
              CALL <A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE'>dfi_accumulate</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_ACCUMULATE_1"> ( grid )<a name='334'>
<a name='335'>
              CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_BEFORE_SOLVE_IO'>med_before_solve_io</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_BEFORE_SOLVE_IO_1"> ( grid , config_flags )<a name='336'>
ENDIF <font color=#447700>! active_this_task<a name='337'></font>
<a name='338'>
            grid_ptr =&gt; grid<a name='339'>
            DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='340'>
#if ( NMM_CORE == 1 )<a name='341'>
                  grid_ptr%mvnest = .FALSE.<a name='342'>
#endif<a name='343'>
IF ( grid_ptr%active_this_task ) THEN<a name='344'>
                  CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_2">( grid_ptr )<a name='345'>
                  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_238">( 100 , 'module_integrate: calling solve interface ' )<a name='346'>
<a name='347'>
                  CALL <A href='../../html_code/share/solve_interface.F.html#SOLVE_INTERFACE'>solve_interface</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOLVE_INTERFACE_1"> ( grid_ptr ) <a name='348'>
<a name='349'>
ENDIF<a name='350'>
               CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCKADVANCE'>domain_clockadvance</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCKADVANCE_1"> ( grid_ptr )<a name='351'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_239">( 100 , 'module_integrate: back from solve interface ' )<a name='352'>
               <font color=#447700>! print lots of time-related information for testing<a name='353'></font>
               <font color=#447700>! switch this on with namelist variable self_test_domain<a name='354'></font>
               CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_TIME_TEST'>domain_time_test</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_TIME_TEST_1">( grid_ptr, 'domain_clockadvance' )<a name='355'>
               grid_ptr =&gt; grid_ptr%sibling<a name='356'>
            END DO<a name='357'>
            CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_3">( grid )<a name='358'>
            CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_CALC_MODEL_TIME'>med_calc_model_time</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_CALC_MODEL_TIME_1"> ( grid , config_flags )<a name='359'>
IF ( grid%active_this_task ) THEN<a name='360'>
              CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_AFTER_SOLVE_IO'>med_after_solve_io</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_AFTER_SOLVE_IO_1"> ( grid , config_flags )<a name='361'>
ENDIF<a name='362'>
<a name='363'>
            grid_ptr =&gt; grid<a name='364'>
            DO WHILE ( ASSOCIATED( grid_ptr ) )<a name='365'>
               DO kid = 1, max_nests<a name='366'>
                 IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='367'>
                   CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_4">( grid_ptr%nests(kid)%ptr )<a name='368'>
                   <font color=#447700>! Recursive -- advance nests from previous time level to this time level.<a name='369'></font>
                   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_240">( 100 , 'module_integrate: calling med_nest_force ' )<a name='370'>
                   CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FORCE'>med_nest_force</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_FORCE_1"> ( grid_ptr , grid_ptr%nests(kid)%ptr )<a name='371'>
                   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_241">( 100 , 'module_integrate: back from med_nest_force ' )<a name='372'>
                   grid_ptr%nests(kid)%ptr%start_subtime = &amp;<a name='373'>
                     domain_get_current_time(grid) - domain_get_time_step(grid)<a name='374'>
                   grid_ptr%nests(kid)%ptr%stop_subtime = &amp;<a name='375'>
                     domain_get_current_time(grid)<a name='376'>
                 ENDIF<a name='377'>
               ENDDO<a name='378'>
<a name='379'>
               DO kid = 1, max_nests<a name='380'>
                 IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='381'>
                   CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_5">( grid_ptr%nests(kid)%ptr )<a name='382'>
                   WRITE(message,*)grid%id,' module_integrate: recursive call to integrate '<a name='383'>
                   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_242">( 100 , message )<a name='384'>
                      CALL <A href='../../html_code/frame/module_integrate.F.html#INTEGRATE'>integrate</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INTEGRATE_1"> ( grid_ptr%nests(kid)%ptr ) <a name='385'>
                   WRITE(message,*)grid%id,' module_integrate: back from recursive call to integrate '<a name='386'>
                   CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_243">( 100 , message )<a name='387'>
                 ENDIF<a name='388'>
               ENDDO<a name='389'>
               may_have_moved = .FALSE.<a name='390'>
               DO kid = 1, max_nests<a name='391'>
                 IF ( ASSOCIATED( grid_ptr%nests(kid)%ptr ) ) THEN<a name='392'>
                   CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_6">( grid_ptr%nests(kid)%ptr )<a name='393'>
                   IF ( .NOT. ( domain_clockisstoptime(head_grid              ) .OR. &amp;<a name='394'>
                                domain_clockisstoptime(grid                   ) .OR. &amp;<a name='395'>
                                domain_clockisstoptime(grid_ptr%nests(kid)%ptr) ) )  THEN<a name='396'>
                     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_244">( 100 , 'module_integrate: calling med_nest_feedback ' )<a name='397'>
                     CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK'>med_nest_feedback</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_FEEDBACK_1"> ( grid_ptr , grid_ptr%nests(kid)%ptr , config_flags )<a name='398'>
                     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_245">( 100 , 'module_integrate: back from med_nest_feedback ' )<a name='399'>
                   END IF<a name='400'>
#ifdef MOVE_NESTS<a name='401'>
                   IF ( .NOT. domain_clockisstoptime( head_grid ) ) THEN<a name='402'>
                     CALL <A href='../../html_code/share/mediation_nest_move.F.html#MED_NEST_MOVE'>med_nest_move</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_MOVE_1"> ( grid_ptr , grid_ptr%nests(kid)%ptr )<a name='403'>
                     may_have_moved = .TRUE.<a name='404'>
                   ENDIF<a name='405'>
#endif<a name='406'>
                 END IF<a name='407'>
               END DO<a name='408'>
#ifdef MOVE_NESTS<a name='409'>
               IF ( may_have_moved ) THEN<a name='410'>
                 CALL <A href='../../html_code/share/mediation_nest_move.F.html#RECONCILE_NEST_POSITIONS_OVER_TASKS'>reconcile_nest_positions_over_tasks</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RECONCILE_NEST_POSITIONS_OVER_TASKS_1">( grid_ptr )<a name='411'>
                 CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_16"> ( grid_ptr%id , model_config_rec , config_flags )<a name='412'>
               ENDIF<a name='413'>
#endif<a name='414'>
               IF (coupler_on) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_SND'>cpl_snd</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_SND_1">( grid_ptr ) <a name='415'>
               grid_ptr =&gt; grid_ptr%sibling<a name='416'>
            END DO<a name='417'>
            CALL <A href='../../html_code/frame/module_domain.F.html#SET_CURRENT_GRID_PTR'>set_current_grid_ptr</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_CURRENT_GRID_PTR_7">( grid )<a name='418'>
            <font color=#447700>!  Report on the timing for a single time step.<a name='419'></font>
            IF ( wrf_dm_on_monitor() ) THEN<a name='420'>
IF ( grid%active_this_task ) THEN<a name='421'>
               CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_32"> ( grid, current_timestr=message2 )<a name='422'>
#if (EM_CORE == 1)<a name='423'>
               if (config_flags%use_adaptive_time_step) then<a name='424'>
                  WRITE ( message , FMT = '("main (dt=",F6.2,"): time ",A," on domain ",I3)' ) grid%dt, TRIM(message2), grid%id<a name='425'>
               else<a name='426'>
                  WRITE ( message , FMT = '("main: time ",A," on domain ",I3)' ) TRIM(message2), grid%id<a name='427'>
               endif<a name='428'>
#else<a name='429'>
                  WRITE ( message , FMT = '("main: time ",A," on domain ",I3)' ) TRIM(message2), grid%id<a name='430'>
#endif<a name='431'>
               CALL <A href='../../html_code/frame/module_timing.F.html#END_TIMING'>end_timing</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="END_TIMING_5"> ( TRIM(message) )<a name='432'>
ENDIF <font color=#447700>! active_this_task<a name='433'></font>
            ENDIF<a name='434'>
            CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_ENDUP_STEP'>med_endup_step</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_ENDUP_STEP_1"> ( grid , config_flags )<a name='435'>
         END DO<a name='436'>
<a name='437'>
IF ( grid%active_this_task ) THEN<a name='438'>
         <font color=#447700>! Accumulation calculation for DFI<a name='439'></font>
         CALL <A href='../../html_code/share/dfi.F.html#DFI_ACCUMULATE'>dfi_accumulate</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DFI_ACCUMULATE_2"> ( grid )<a name='440'>
ENDIF <font color=#447700>! active_this_task<a name='441'></font>
<a name='442'>
<a name='443'>
         <font color=#447700>! Avoid double writes on nests if this is not really the last time;<a name='444'></font>
         <font color=#447700>! Do check for write if the parent domain is ending.<a name='445'></font>
         IF ( grid%id .EQ. 1 ) THEN               <font color=#447700>! head_grid<a name='446'></font>
            IF ( grid%active_this_task ) CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO'>med_last_solve_io</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_LAST_SOLVE_IO_1"> ( grid , config_flags )<a name='447'>
         ELSE<a name='448'>
<font color=#447700>! zip up the tree and see if any ancestor is at its stop time<a name='449'></font>
            should_do_last_io = <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCKISSTOPTIME'>domain_clockisstoptime</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCKISSTOPTIME_1">( head_grid )<a name='450'>
            grid_ptr =&gt; grid <a name='451'>
            DO WHILE ( grid_ptr%id .NE. 1 )<a name='452'>
               IF ( domain_clockisstoptime( grid_ptr ) ) THEN<a name='453'>
                  should_do_last_io = .TRUE. <a name='454'>
               END IF<a name='455'>
               grid_ptr =&gt; grid_ptr%parents(1)%ptr<a name='456'>
            ENDDO<a name='457'>
            IF ( should_do_last_io ) THEN <a name='458'>
               grid_ptr =&gt; grid <a name='459'>
               CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_NEST_FEEDBACK'>med_nest_feedback</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_NEST_FEEDBACK_2"> ( grid_ptr%parents(1)%ptr, grid , config_flags )<a name='460'>
               IF ( grid%active_this_task ) CALL <A href='../../html_code/share/mediation_integrate.F.html#MED_LAST_SOLVE_IO'>med_last_solve_io</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MED_LAST_SOLVE_IO_2"> ( grid , config_flags )<a name='461'>
            ENDIF<a name='462'>
         ENDIF<a name='463'>
      ENDIF<a name='464'>
   END IF<a name='465'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#POP_COMMUNICATORS_FOR_DOMAIN'>pop_communicators_for_domain</A><A href='../../html_code/frame/module_integrate.F.html#INTEGRATE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POP_COMMUNICATORS_FOR_DOMAIN_15"><a name='466'>
   <a name='467'>
END SUBROUTINE integrate<a name='468'>
<a name='469'>
END MODULE module_integrate<a name='470'>
<a name='471'>
</pre></body></html>