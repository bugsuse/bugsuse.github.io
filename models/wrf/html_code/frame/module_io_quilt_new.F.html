<HTML> <BODY BGCOLOR=#eeddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:IO<a name='2'></font>
<font color=#447700>!<a name='3'></font>
#define DEBUG_LVL 50<a name='4'>
#define mpi_x_comm_size(i,j,k)  Mpi_Comm_Size ( i,j,k )<a name='5'>
<a name='6'>
<font color=#447700>! Workaround for bug in the IBM MPI implementation.  Look near the<a name='7'></font>
<font color=#447700>! bottom of this file for an explanation.<a name='8'></font>
#ifdef IBM_REDUCE_BUG_WORKAROUND<a name='9'>
#define mpi_x_reduce(sb,rb,c,dt,op,r,com,ierr) reduce_add_integer(sb,rb,c,r,com)<a name='10'>
#else<a name='11'>
#define mpi_x_reduce(sb,rb,c,dt,op,r,com,ierr) MPI_Reduce(sb,rb,c,dt,op,r,com,ierr)<a name='12'>
#endif<a name='13'>
<a name='14'>
<A NAME='MODULE_WRF_QUILT'><A href='../../html_code/frame/module_io_quilt_new.F.html#MODULE_WRF_QUILT' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='15'>
<font color=#993300>MODULE </font><font color=#cc0000>module_wrf_quilt</font> <A href='../../call_to/MODULE_WRF_QUILT.html' TARGET='index'>44</A><a name='16'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='17'></font>
<font color=#447700>!&lt;PRE&gt;<a name='18'></font>
<font color=#447700>! This module contains WRF-specific I/O quilt routines called by both <a name='19'></font>
<font color=#447700>! client (compute) and server (I/O quilt) tasks.  I/O quilt servers are <a name='20'></font>
<font color=#447700>! a run-time optimization that allow I/O operations, executed on the I/O <a name='21'></font>
<font color=#447700>! quilt server tasks, to be overlapped with useful computation, executed on <a name='22'></font>
<font color=#447700>! the compute tasks.  Since I/O operations are often quite slow compared to <a name='23'></font>
<font color=#447700>! computation, this performance optimization can increase parallel <a name='24'></font>
<font color=#447700>! efficiency.  <a name='25'></font>
<font color=#447700>!<a name='26'></font>
<font color=#447700>! Currently, one group of I/O servers can be specified at run-time.  Namelist <a name='27'></font>
<font color=#447700>! variable "nio_tasks_per_group" is used to specify the number of I/O server <a name='28'></font>
<font color=#447700>! tasks in this group.  In most cases, parallel efficiency is optimized when <a name='29'></font>
<font color=#447700>! the minimum number of I/O server tasks are used.  If memory needed to cache <a name='30'></font>
<font color=#447700>! I/O operations fits on a single processor, then set nio_tasks_per_group=1.  <a name='31'></font>
<font color=#447700>! If not, increase the number of I/O server tasks until I/O operations fit in <a name='32'></font>
<font color=#447700>! memory.  In the future, multiple groups of I/O server tasks will be <a name='33'></font>
<font color=#447700>! supported.  The number of groups will be specified by namelist variable <a name='34'></font>
<font color=#447700>! "nio_groups".  For now, nio_groups must be set to 1.  Currently, I/O servers <a name='35'></font>
<font color=#447700>! only support overlap of output operations with computation.  Also, only I/O <a name='36'></font>
<font color=#447700>! packages that do no support native parallel I/O may be used with I/O server <a name='37'></font>
<font color=#447700>! tasks.  This excludes PHDF5 and MCEL.  <a name='38'></font>
<font color=#447700>!<a name='39'></font>
<font color=#447700>! In this module, the I/O quilt server tasks call package-dependent <a name='40'></font>
<font color=#447700>! WRF-specific I/O interfaces to perform I/O operations requested by the <a name='41'></font>
<font color=#447700>! client (compute) tasks.  All of these calls occur inside subroutine <a name='42'></font>
<font color=#447700>! quilt().  <a name='43'></font>
<font color=#447700>! <a name='44'></font>
<font color=#447700>! The client (compute) tasks call package-independent WRF-specific "quilt I/O" <a name='45'></font>
<font color=#447700>! interfaces that send requests to the I/O quilt servers.  All of these calls <a name='46'></font>
<font color=#447700>! are made from module_io.F.  <a name='47'></font>
<font color=#447700>!<a name='48'></font>
<font color=#447700>! These routines have the same names and (roughly) the same arguments as those <a name='49'></font>
<font color=#447700>! specified in the WRF I/O API except that:<a name='50'></font>
<font color=#447700>! - "Quilt I/O" routines defined in this file and called by routines in <a name='51'></font>
<font color=#447700>!   module_io.F have the "wrf_quilt_" prefix.<a name='52'></font>
<font color=#447700>! - Package-dependent routines called from routines in this file are defined <a name='53'></font>
<font color=#447700>!   in the external I/O packages and have the "ext_" prefix.<a name='54'></font>
<font color=#447700>!<a name='55'></font>
<font color=#447700>! Both client (compute) and server tasks call routine init_module_wrf_quilt() <a name='56'></font>
<font color=#447700>! which then calls setup_quilt_servers() determine which tasks are compute <a name='57'></font>
<font color=#447700>! tasks and which are server tasks.  Before the end of init_module_wrf_quilt() <a name='58'></font>
<font color=#447700>! server tasks call routine quilt() and remain there for the rest of the model <a name='59'></font>
<font color=#447700>! run.  Compute tasks return from init_module_wrf_quilt() to perform model <a name='60'></font>
<font color=#447700>! computations.  <a name='61'></font>
<font color=#447700>!<a name='62'></font>
<font color=#447700>! See http://www.mmm.ucar.edu/wrf/WG2/software_2.0/IOAPI.doc for the latest<a name='63'></font>
<font color=#447700>! version of the WRF I/O API.  This document includes detailed descriptions<a name='64'></font>
<font color=#447700>! of subroutines and their arguments that are not duplicated here.<a name='65'></font>
<font color=#447700>!&lt;/PRE&gt;<a name='66'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='67'></font>
  USE <A href='../../html_code/frame/module_internal_header_util.F.html#MODULE_INTERNAL_HEADER_UTIL'>module_internal_header_util</A><A href='../../html_code/frame/module_io_quilt_new.F.html#module_io_quilt_new.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERNAL_HEADER_UTIL_2"><a name='68'>
  USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_io_quilt_new.F.html#module_io_quilt_new.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_26"><a name='69'>
  USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_io_quilt_new.F.html#module_io_quilt_new.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_38"> <font color=#447700>!, ONLY  : max_domains<a name='70'></font>
  USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_io_quilt_new.F.html#module_io_quilt_new.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_126">, ONLY : current_id<a name='71'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='72'></font>
  USE <A href='../../html_code/frame/module_cpl.F.html#MODULE_CPL'>module_cpl</A><A href='../../html_code/frame/module_io_quilt_new.F.html#module_io_quilt_new.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CPL_5">, ONLY : coupler_on, cpl_set_dm_communicator, cpl_finalize<a name='73'>
#endif<a name='74'>
<a name='75'>
  INTEGER, PARAMETER :: int_num_handles = 99<a name='76'>
  INTEGER, PARAMETER :: max_servers = int_num_handles+1  <font color=#447700>! why +1?<a name='77'></font>
  LOGICAL, DIMENSION(0:int_num_handles) :: okay_to_write, int_handle_in_use, okay_to_commit<a name='78'>
  INTEGER, DIMENSION(0:int_num_handles) :: int_num_bytes_to_write, io_form<a name='79'>
  INTEGER, DIMENSION(0:int_num_handles) :: which_grid_is_handle<a name='80'>
  INTEGER, DIMENSION(0:int_num_handles) :: prev_server_for_handle<a name='81'>
  REAL, POINTER,SAVE :: int_local_output_buffer(:)<a name='82'>
  INTEGER,      SAVE :: int_local_output_cursor<a name='83'>
  LOGICAL          :: quilting_enabled<a name='84'>
  LOGICAL          :: disable_quilt = .FALSE.<a name='85'>
  INTEGER          :: server_for_handle(int_num_handles,max_domains)<a name='86'>
  INTEGER          :: reduced(2), reduced_dummy(2)<a name='87'>
  LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='88'>
<a name='89'>
  INTEGER :: mpi_comm_avail(max_domains),availrank(max_domains)<a name='90'>
  LOGICAL :: in_avail=.false., poll_servers=.false.<a name='91'>
<a name='92'>
  INTEGER, ALLOCATABLE :: role_for_task(:)<a name='93'>
  INTEGER nio_groups<a name='94'>
#ifdef DM_PARALLEL<a name='95'>
  INTEGER :: mpi_comm_local, mpi_comm_local_io_server_tmp<a name='96'>
  LOGICAL :: compute_group_master(max_servers,max_domains)<a name='97'>
  INTEGER :: mpi_comm_io_groups(max_servers,max_domains)<a name='98'>
  INTEGER :: nio_tasks_per_group(max_domains)<a name='99'>
  INTEGER :: ntasks<a name='100'>
  INTEGER :: mytask<a name='101'>
<a name='102'>
  INTEGER, PARAMETER           :: onebyte = 1<a name='103'>
  INTEGER comm_io_servers, iserver, hdrbufsize, obufsize<a name='104'>
  INTEGER, DIMENSION(4096)     :: hdrbuf<a name='105'>
  INTEGER, DIMENSION(int_num_handles)     :: handle<a name='106'>
#endif<a name='107'>
<a name='108'>
#ifdef IBM_REDUCE_BUG_WORKAROUND<a name='109'>
<font color=#447700>! Workaround for bug in the IBM MPI implementation.  Look near the<a name='110'></font>
<font color=#447700>! bottom of this file for an explanation.<a name='111'></font>
<A NAME='REDUCE_ADD_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#REDUCE_ADD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='112'>
  <font color=#993300>interface </font><font color=#cc0000>reduce_add_integer</font><a name='113'>
     module procedure <A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR'>reduce_add_int_arr</A><A NAME="REDUCE_ADD_INT_ARR_1"><A href='../../html_code/frame/module_io_quilt_new.F.html#module_io_quilt_new.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='114'>
     module procedure <A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL'>reduce_add_int_scl</A><A NAME="REDUCE_ADD_INT_SCL_1"><A href='../../html_code/frame/module_io_quilt_new.F.html#module_io_quilt_new.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='115'>
  end interface<a name='116'>
#endif<a name='117'>
<a name='118'>
  CONTAINS<a name='119'>
<a name='120'>
#if  defined(DM_PARALLEL)  &amp;&amp;  <font color=#447700>!defined( STUBMPI )<a name='121'></font>
<A NAME='GET_SERVER_ID'><A href='../../html_code/frame/module_io_quilt_new.F.html#GET_SERVER_ID' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='122'>
    INTEGER <font color=#993300>FUNCTION </font><font color=#cc0000>get_server_id</font> ( dhandle ),<A href='../../call_from/GET_SERVER_ID.html' TARGET='index'>5</A><a name='123'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='124'></font>
<font color=#447700>! Logic in the client side to know which io server<a name='125'></font>
<font color=#447700>! group to send to. If the unit corresponds to a file that's<a name='126'></font>
<font color=#447700>! already been opened, then we have no choice but to send the<a name='127'></font>
<font color=#447700>! data to that group again, regardless of whether there are<a name='128'></font>
<font color=#447700>! other server-groups. If it's a new file, we can chose a new<a name='129'></font>
<font color=#447700>! server group. I.e. opening a file locks it onto a server<a name='130'></font>
<font color=#447700>! group. Closing the file unlocks it.<a name='131'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='132'></font>
      IMPLICIT NONE<a name='133'>
      INTEGER, INTENT(IN) :: dhandle<a name='134'>
<font color=#447700>! local<a name='135'></font>
      INTEGER :: id<a name='136'>
      <a name='137'>
      IF ( dhandle .GE. 1 .AND. dhandle .LE. int_num_handles ) THEN<a name='138'>
        id = which_grid_is_handle(dhandle)<a name='139'>
        IF ( id .LT. 1 .OR. id .GT. max_domains ) THEN<a name='140'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_SERVER_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_263">("module_io_quilt: get_server_id, bad grid id stored with handle")<a name='141'>
        ENDIF<a name='142'>
        IF ( server_for_handle ( dhandle, id ) .GE. 1 ) THEN<a name='143'>
          get_server_id = server_for_handle ( dhandle, id )<a name='144'>
        ELSE<a name='145'>
           IF(poll_servers) THEN<a name='146'>
              <font color=#447700>! Poll server group masters to find an inactive I/O server group:<a name='147'></font>
              call <A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER'>wrf_quilt_find_server</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_SERVER_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_QUILT_FIND_SERVER_1">(server_for_handle(dhandle, id))<a name='148'>
           ELSE<a name='149'>
              <font color=#447700>! Server polling is disabled, so cycle through servers:<a name='150'></font>
              prev_server_for_handle(id) = mod ( prev_server_for_handle(id) + 1 , nio_groups )<a name='151'>
              server_for_handle( dhandle, id ) = prev_server_for_handle(id)+1<a name='152'>
           ENDIF<a name='153'>
           get_server_id=server_for_handle(dhandle, id)<a name='154'>
        ENDIF<a name='155'>
      ELSE<a name='156'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_SERVER_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_337">('module_io_quilt: get_server_id bad dhandle' )<a name='157'>
      ENDIF<a name='158'>
    END FUNCTION get_server_id<a name='159'>
#endif<a name='160'>
<a name='161'>
<A NAME='SET_SERVER_ID'><A href='../../html_code/frame/module_io_quilt_new.F.html#SET_SERVER_ID' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='162'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_server_id</font> ( dhandle, value ) <A href='../../call_to/SET_SERVER_ID.html' TARGET='index'>2</A>,<A href='../../call_from/SET_SERVER_ID.html' TARGET='index'>3</A><a name='163'>
       IMPLICIT NONE<a name='164'>
       INTEGER, INTENT(IN) :: dhandle, value<a name='165'>
       INTEGER id<a name='166'>
       IF ( dhandle .GE. 1 .AND. dhandle .LE. int_num_handles ) THEN<a name='167'>
         id = which_grid_is_handle(dhandle)<a name='168'>
         IF ( id .GE. 1 .AND. ID .LE. max_domains ) THEN<a name='169'>
           server_for_handle(dhandle,id) = value<a name='170'>
         ELSE<a name='171'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SET_SERVER_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_338">('module_io_quilt: set_server_id bad grid id stored with handle' )<a name='172'>
         ENDIF<a name='173'>
       ELSE<a name='174'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SET_SERVER_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_339">('module_io_quilt: set_server_id bad dhandle' )<a name='175'>
       ENDIF<a name='176'>
    END SUBROUTINE set_server_id<a name='177'>
<a name='178'>
<A NAME='GET_POLL_SERVERS'><A href='../../html_code/frame/module_io_quilt_new.F.html#GET_POLL_SERVERS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='179'>
    LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>get_poll_servers</font>() <a name='180'>
      implicit none<a name='181'>
      get_poll_servers=poll_servers<a name='182'>
    end FUNCTION get_poll_servers<a name='183'>
<a name='184'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='185'></font>
<A NAME='INT_GET_FRESH_HANDLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#INT_GET_FRESH_HANDLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='186'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>int_get_fresh_handle</font>( retval ) <A href='../../call_to/INT_GET_FRESH_HANDLE.html' TARGET='index'>4</A>,<A href='../../call_from/INT_GET_FRESH_HANDLE.html' TARGET='index'>2</A><a name='187'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='188'></font>
<font color=#447700>! Find an unused "client file handle" and return it in retval.<a name='189'></font>
<font color=#447700>! The "client file handle" is used to remember how a file was opened<a name='190'></font>
<font color=#447700>! so clients do not need to ask the I/O quilt servers for this information.<a name='191'></font>
<font color=#447700>! It is also used as a file identifier in communications with the I/O<a name='192'></font>
<font color=#447700>! server task.<a name='193'></font>
<font color=#447700>!<a name='194'></font>
<font color=#447700>! Note that client tasks know nothing about package-specific handles.<a name='195'></font>
<font color=#447700>! Only the I/O quilt servers know about them.<a name='196'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='197'></font>
      INTEGER, INTENT(OUT) :: retval<a name='198'>
      INTEGER i<a name='199'>
      retval = -1<a name='200'>
      DO i = 1, int_num_handles<a name='201'>
        IF ( .NOT. int_handle_in_use(i) )  THEN<a name='202'>
          retval = i<a name='203'>
          GOTO 33<a name='204'>
        ENDIF<a name='205'>
      ENDDO<a name='206'>
33    CONTINUE<a name='207'>
      IF ( retval &lt; 0 )  THEN<a name='208'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INT_GET_FRESH_HANDLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_264">("frame/module_io_quilt.F: int_get_fresh_handle() can not")<a name='209'>
      ENDIF<a name='210'>
      int_handle_in_use(i) = .TRUE.<a name='211'>
      NULLIFY ( int_local_output_buffer )<a name='212'>
    END SUBROUTINE int_get_fresh_handle<a name='213'>
<a name='214'>
<A NAME='SETUP_QUILT_SERVERS'><A href='../../html_code/frame/module_io_quilt_new.F.html#SETUP_QUILT_SERVERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='215'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>setup_quilt_servers</font> ( id, nio_tasks_per_group, &amp; <A href='../../call_to/SETUP_QUILT_SERVERS.html' TARGET='index'>2</A>,<A href='../../call_from/SETUP_QUILT_SERVERS.html' TARGET='index'>39</A><a name='216'>
                                     role_for_task,           &amp;<a name='217'>
                                     num_io_tasks,            &amp;<a name='218'>
                                     ncompute_tasks,          &amp;<a name='219'>
                                     mytask,                  &amp;<a name='220'>
                                     ntasks,                  &amp;<a name='221'>
                                     n_groups_arg,            &amp;<a name='222'>
                                     mpi_comm_wrld,           &amp;<a name='223'>
                                     mpi_comm_local,          &amp;<a name='224'>
                                     mpi_comm_io_groups,      &amp;<a name='225'>
                                     compute_node   )<a name='226'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='227'></font>
<font color=#447700>! Both client (compute) and server tasks call this routine to <a name='228'></font>
<font color=#447700>! determine which tasks are compute tasks and which are I/O server tasks.  <a name='229'></font>
<font color=#447700>!<a name='230'></font>
<font color=#447700>! Module variables MPI_COMM_LOCAL and MPI_COMM_IO_GROUPS(:) are set up to <a name='231'></font>
<font color=#447700>! contain MPI communicators as follows:  <a name='232'></font>
<font color=#447700>!<a name='233'></font>
<font color=#447700>! MPI_COMM_LOCAL is the Communicator for the local groups of tasks. For the <a name='234'></font>
<font color=#447700>! compute tasks it is the group of compute tasks; for a server group it the <a name='235'></font>
<font color=#447700>! communicator of tasks in the server group.<a name='236'></font>
<font color=#447700>!<a name='237'></font>
<font color=#447700>! Elements of MPI_COMM_IO_GROUPS are communicators that each contain one or <a name='238'></font>
<font color=#447700>! more compute tasks and a single I/O server assigned to those compute tasks.  <a name='239'></font>
<font color=#447700>! The I/O server tasks is always the last task in these communicators.  <a name='240'></font>
<font color=#447700>! On a compute task, which has a single associate in each of the server <a name='241'></font>
<font color=#447700>! groups, MPI_COMM_IO_GROUPS is treated as an array; each element corresponds <a name='242'></font>
<font color=#447700>! to a different server group. <a name='243'></font>
<font color=#447700>! On a server task only the first element of MPI_COMM_IO_GROUPS is used <a name='244'></font>
<font color=#447700>! because each server task is part of only one io_group.  <a name='245'></font>
<font color=#447700>!<a name='246'></font>
<font color=#447700>! I/O server tasks in each I/O server group are divided among compute tasks as <a name='247'></font>
<font color=#447700>! evenly as possible.  <a name='248'></font>
<font color=#447700>!<a name='249'></font>
<font color=#447700>! When multiple I/O server groups are used, each must have the same number of <a name='250'></font>
<font color=#447700>! tasks.  When the total number of extra I/O tasks does not divide evenly by <a name='251'></font>
<font color=#447700>! the number of io server groups requested, the remainder tasks are not used <a name='252'></font>
<font color=#447700>! (wasted).  <a name='253'></font>
<font color=#447700>!<a name='254'></font>
<font color=#447700>! For example, communicator membership for 18 tasks with nio_groups=2 and <a name='255'></font>
<font color=#447700>! nio_tasks_per_group=3 is shown below:  <a name='256'></font>
<font color=#447700>!<a name='257'></font>
<font color=#447700>!&lt;PRE&gt;<a name='258'></font>
<font color=#447700>! Membership for MPI_COMM_LOCAL communicators:<a name='259'></font>
<font color=#447700>!   COMPUTE TASKS:          0   1   2   3   4   5   6   7   8   9  10  11<a name='260'></font>
<font color=#447700>!   1ST I/O SERVER GROUP:  12  13  14<a name='261'></font>
<font color=#447700>!   2ND I/O SERVER GROUP:  15  16  17<a name='262'></font>
<font color=#447700>!<a name='263'></font>
<font color=#447700>! Membership for MPI_COMM_IO_GROUPS(1):  <a name='264'></font>
<font color=#447700>!   COMPUTE TASKS 0, 3, 6, 9:   0   3   6   9  12<a name='265'></font>
<font color=#447700>!   COMPUTE TASKS 1, 4, 7,10:   1   4   7  10  13<a name='266'></font>
<font color=#447700>!   COMPUTE TASKS 2, 5, 8,11:   2   5   8  11  14<a name='267'></font>
<font color=#447700>!   I/O SERVER TASK       12:   0   3   6   9  12<a name='268'></font>
<font color=#447700>!   I/O SERVER TASK       13:   1   4   7  10  13<a name='269'></font>
<font color=#447700>!   I/O SERVER TASK       14:   2   5   8  11  14<a name='270'></font>
<font color=#447700>!   I/O SERVER TASK       15:   0   3   6   9  15<a name='271'></font>
<font color=#447700>!   I/O SERVER TASK       16:   1   4   7  10  16<a name='272'></font>
<font color=#447700>!   I/O SERVER TASK       17:   2   5   8  11  17<a name='273'></font>
<font color=#447700>!<a name='274'></font>
<font color=#447700>! Membership for MPI_COMM_IO_GROUPS(2):  <a name='275'></font>
<font color=#447700>!   COMPUTE TASKS 0, 3, 6, 9:   0   3   6   9  15<a name='276'></font>
<font color=#447700>!   COMPUTE TASKS 1, 4, 7,10:   1   4   7  10  16<a name='277'></font>
<font color=#447700>!   COMPUTE TASKS 2, 5, 8,11:   2   5   8  11  17<a name='278'></font>
<font color=#447700>!   I/O SERVER TASK       12:  ** not used **<a name='279'></font>
<font color=#447700>!   I/O SERVER TASK       13:  ** not used **<a name='280'></font>
<font color=#447700>!   I/O SERVER TASK       14:  ** not used **<a name='281'></font>
<font color=#447700>!   I/O SERVER TASK       15:  ** not used **<a name='282'></font>
<font color=#447700>!   I/O SERVER TASK       16:  ** not used **<a name='283'></font>
<font color=#447700>!   I/O SERVER TASK       17:  ** not used **<a name='284'></font>
<font color=#447700>!&lt;/PRE&gt;<a name='285'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='286'></font>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_106"><a name='287'>
#ifdef DM_PARALLEL<a name='288'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_127">, ONLY : compute_mesh,nest_pes_x,nest_pes_y,domain_active_this_task,&amp;<a name='289'>
                            tasks_per_split,comm_start,dm_task_split<a name='290'>
#endif<a name='291'>
      IMPLICIT NONE<a name='292'>
      INCLUDE 'mpif.h'<a name='293'>
      INTEGER,                      INTENT(IN)  :: id, nio_tasks_per_group(:), mytask, ntasks, &amp;<a name='294'>
                                                   n_groups_arg, mpi_comm_wrld<a name='295'>
      INTEGER,  INTENT(IN)                      :: role_for_task(:)<a name='296'>
      INTEGER,  INTENT(IN)                      :: ncompute_tasks, num_io_tasks<a name='297'>
      INTEGER,  INTENT(OUT)                     :: mpi_comm_local<a name='298'>
      INTEGER, DIMENSION(100,max_domains),      INTENT(OUT) :: mpi_comm_io_groups<a name='299'>
      LOGICAL, INTENT(OUT)   :: compute_node<a name='300'>
<font color=#447700>! Local<a name='301'></font>
      INTEGER                     :: i, j, ii, comdup, ierr, niotasks, n_groups, iisize, itask, nio<a name='302'>
      INTEGER, DIMENSION(ntasks)  :: icolor<a name='303'>
      CHARACTER*128 mess<a name='304'>
      INTEGER :: io_form_setting<a name='305'>
      INTEGER :: me<a name='306'>
      INTEGER :: k, m, nprocx, nprocy, found, found_io<a name='307'>
      LOGICAL :: reorder_mesh<a name='308'>
      CHARACTER*256 message<a name='309'>
<a name='310'>
#if 0<a name='311'>
<font color=#447700>! with the changes to quilting and the movement of some init calls around<a name='312'></font>
<font color=#447700>! this no longer works because the namelist hasn't been read and distributed yet.<a name='313'></font>
<font color=#447700>! need to move this somewhere where it will work again, maybe into check-a-mundo?<a name='314'></font>
<font color=#447700>!<a name='315'></font>
<font color=#447700>!check the namelist and make sure there are no output forms specified<a name='316'></font>
<font color=#447700>!that cannot be quilted<a name='317'></font>
      CALL nl_get_io_form_history(1,   io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_1">( 'history', io_form_setting )<a name='318'>
      CALL nl_get_io_form_restart(1,   io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_2">( 'restart', io_form_setting )<a name='319'>
      CALL nl_get_io_form_auxhist1(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_3">( 'auxhist1', io_form_setting )<a name='320'>
      CALL nl_get_io_form_auxhist2(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_4">( 'auxhist2', io_form_setting )<a name='321'>
      CALL nl_get_io_form_auxhist3(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_5">( 'auxhist3', io_form_setting )<a name='322'>
      CALL nl_get_io_form_auxhist4(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_6">( 'auxhist4', io_form_setting )<a name='323'>
      CALL nl_get_io_form_auxhist5(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_7">( 'auxhist5', io_form_setting )<a name='324'>
      CALL nl_get_io_form_auxhist6(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_8">( 'auxhist6', io_form_setting )<a name='325'>
      CALL nl_get_io_form_auxhist7(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_9">( 'auxhist7', io_form_setting )<a name='326'>
      CALL nl_get_io_form_auxhist8(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_10">( 'auxhist8', io_form_setting )<a name='327'>
      CALL nl_get_io_form_auxhist9(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_11">( 'auxhist9', io_form_setting )<a name='328'>
      CALL nl_get_io_form_auxhist10(1, io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_12">( 'auxhist10', io_form_setting )<a name='329'>
      CALL nl_get_io_form_auxhist11(1, io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_13">( 'auxhist11', io_form_setting )<a name='330'>
#endif<a name='331'>
<a name='332'>
      n_groups = n_groups_arg<a name='333'>
      IF ( n_groups .LT. 1 ) n_groups = 1<a name='334'>
<a name='335'>
<font color=#447700>!      compute_node = .TRUE.<a name='336'></font>
<a name='337'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='338'></font>
<font color=#447700>! nio is number of io tasks per group.  If there arent enough tasks to satisfy<a name='339'></font>
<font color=#447700>! the requirement that there be at least as many compute tasks as io tasks in<a name='340'></font>
<font color=#447700>! each group, then just print a warning and dump out of quilting<a name='341'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='342'></font>
<a name='343'>
      nio = nio_tasks_per_group(id)<a name='344'>
      IF ( nio .LT. 0 ) THEN<a name='345'>
        nio = 0<a name='346'>
      ENDIF<a name='347'>
      IF ( nio .EQ. 0 ) THEN<a name='348'>
        quilting_enabled = .FALSE.<a name='349'>
        compute_node = .TRUE.<a name='350'>
        mpi_comm_local = mpi_comm_wrld<a name='351'>
        mpi_comm_io_groups(:,id) = mpi_comm_wrld<a name='352'>
        RETURN<a name='353'>
      ENDIF<a name='354'>
      found = comm_start(id)<a name='355'>
      found_io = -99<a name='356'>
      DO i=1,ntasks<a name='357'>
         IF ( role_for_task(i) .EQ. id ) THEN<a name='358'>
           found_io = i-1         <font color=#447700>! found_io is the first io task for this domain, used below<a name='359'></font>
           exit<a name='360'>
         ENDIF<a name='361'>
      ENDDO<a name='362'>
      IF ( found_io .eq. -99 ) THEN<a name='363'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_265">('setup_quilt_servers: found_io not found, should not happen (but there it is)')<a name='364'>
      ENDIF<a name='365'>
<a name='366'>
      quilting_enabled = .TRUE.<a name='367'>
<a name='368'>
      icolor = -99  <font color=#447700>! not an I/O task<a name='369'></font>
      ii = 0<a name='370'>
      DO i = 1, ntasks<a name='371'>
        IF ( role_for_task( i ) .EQ. id ) THEN<a name='372'>
          icolor(i) = ii / nio<a name='373'>
          ii = ii + 1<a name='374'>
        ENDIF<a name='375'>
      ENDDO<a name='376'>
      CALL MPI_Comm_dup(mpi_comm_wrld,comdup,ierr)<a name='377'>
      CALL MPI_Comm_split(comdup,icolor(mytask+1),mytask,mpi_comm_local,ierr)<a name='378'>
      IF ( icolor(mytask+1) .NE. -99 ) THEN<a name='379'>
          mpi_comm_local_io_server_tmp = mpi_comm_local<a name='380'>
      ENDIF<a name='381'>
<a name='382'>
<font color=#447700>! At this point, mpi_comm_local will be the local communicator for the server group associated with this domain<a name='383'></font>
<font color=#447700>!   the mpi_comm_local on the other tasks is a throwaway<a name='384'></font>
<a name='385'>
<font color=#447700>! Now construct the communicators for the io_groups<a name='386'></font>
      nprocx = nest_pes_x(id)<a name='387'>
      nprocy = nest_pes_y(id)<a name='388'>
<a name='389'>
      IF ( nio .GT. nprocy*nprocx ) THEN<a name='390'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_266">( 'more io tasks than compute tasks specified' ) <a name='391'>
      ENDIF<a name='392'>
  <a name='393'>
      m = mod(nprocy*nprocx,nio)  <font color=#447700>! divide up remainder, 1 row per, until gone<a name='394'></font>
      ii = 0<a name='395'>
      j = 1<a name='396'>
      do while ( j .le. nprocx*nprocy )<a name='397'>
        do i = 0, (nprocx*nprocy)/nio+min(m,1)-1<a name='398'>
           icolor(j+comm_start(id)) = ii<a name='399'>
           j = j + 1<a name='400'>
        enddo<a name='401'>
        ii = ii + 1<a name='402'>
        m = max(m-1,0)<a name='403'>
      enddo<a name='404'>
<a name='405'>
<font color=#447700>! ... and add the io servers as the last task in each group<a name='406'></font>
      DO j = 1, n_groups<a name='407'>
        DO i = found_io+1,ntasks<a name='408'>
          icolor(i) = -99<a name='409'>
        ENDDO<a name='410'>
        ii = 0<a name='411'>
        DO i = found_io+(j-1)*nio+1,found_io+j*nio<a name='412'>
          icolor(i) = ii<a name='413'>
          ii = ii+1<a name='414'>
        ENDDO<a name='415'>
        CALL MPI_Comm_dup(mpi_comm_wrld,comdup,ierr)<a name='416'>
        CALL MPI_Comm_split(comdup,icolor(mytask+1),mytask, &amp;<a name='417'>
                            mpi_comm_io_groups(j,id),ierr)<a name='418'>
      ENDDO<a name='419'>
<a name='420'>
#ifdef PNETCDF_QUILT<a name='421'>
      if(poll_servers) then<a name='422'>
         poll_servers=.false.<a name='423'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_340">('Warning: server polling does not work with pnetcdf_quilt.  Disabled poll_servers.')<a name='424'>
      else<a name='425'>
#endif<a name='426'>
         if(n_groups==1) then<a name='427'>
            poll_servers=.false.<a name='428'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_341">('Server polling is useless with one io group.  Disabled poll_servers.')<a name='429'>
         endif<a name='430'>
#ifdef PNETCDF_QUILT<a name='431'>
      endif<a name='432'>
#endif<a name='433'>
<a name='434'>
<a name='435'>
      if(poll_servers) then<a name='436'>
         <font color=#447700>! If server polling is enabled, we need to create mpi_comm_avail, <a name='437'></font>
         <font color=#447700>! which contains the monitor process, and the I/O server master process<a name='438'></font>
         <font color=#447700>! for each I/O server group.  This will be used in the routines<a name='439'></font>
         <font color=#447700>! wrf_quilt_find_server and wrf_quilt_server_ready to find inactive<a name='440'></font>
         <font color=#447700>! I/O servers for new data handles in get_server_id.<a name='441'></font>
<a name='442'>
         <font color=#447700>! The "in_avail" is set to true iff I am in the mpi_comm_avail.<a name='443'></font>
<a name='444'>
         call mpi_comm_rank(mpi_comm_wrld,me,ierr)<a name='445'>
<a name='446'>
         icolor=-99<a name='447'>
         in_avail=.false.<a name='448'>
<a name='449'>
         IF ( found .eq. me ) THEN  <font color=#447700>! found is the first task id for this domain, used below too<a name='450'></font>
           in_avail=.true.<a name='451'>
         ENDIF<a name='452'>
         icolor(1)=1<a name='453'>
<a name='454'>
         nio = nio_tasks_per_group(id)<a name='455'>
         do j=1,n_groups<a name='456'>
            i=ncompute_tasks+j*nio-1<a name='457'>
            if(me+1==i) then<a name='458'>
               in_avail=.true. <font color=#447700>! I/O server masters are in mpi_comm_avail<a name='459'></font>
            endif<a name='460'>
            icolor(i)=1<a name='461'>
         enddo<a name='462'>
<a name='463'>
         CALL MPI_Comm_dup(mpi_comm_wrld,comdup,ierr)<a name='464'>
         CALL MPI_Comm_split(comdup,icolor(me+1),me, &amp;<a name='465'>
                             mpi_comm_avail(id),ierr)<a name='466'>
<a name='467'>
         availrank=MPI_UNDEFINED<a name='468'>
         IF(in_avail) THEN<a name='469'>
            call mpi_comm_rank(mpi_comm_avail(id),availrank(id),ierr)<a name='470'>
         ENDIF<a name='471'>
         IF ( role_for_task(me+1) .GT. 1000 ) THEN   <font color=#447700>! one of the server tasks<a name='472'></font>
            mpi_comm_avail(1) = mpi_comm_avail(id)<a name='473'>
            availrank(1) = availrank(id)<a name='474'>
         ENDIF<a name='475'>
<a name='476'>
      endif<a name='477'>
<a name='478'>
<font color=#447700>!jm      compute_group_master = .FALSE.<a name='479'></font>
<font color=#447700>!jm      compute_node         = .FALSE.<a name='480'></font>
<a name='481'>
      DO j = 1, n_groups<a name='482'>
<a name='483'>
        IF ((found .LE. mytask .AND. mytask .LT.  found +ncompute_tasks ).OR. &amp;    <font color=#447700>! I am a compute task<a name='484'></font>
             (found_io+(j-1)*nio .LE. mytask .AND. mytask .LT. found_io+j*nio) &amp;    <font color=#447700>! I am the I/O server for this group<a name='485'></font>
            ) THEN<a name='486'>
<a name='487'>
         CALL MPI_Comm_Size( mpi_comm_io_groups(j,id) , iisize, ierr )<a name='488'>
         <font color=#447700>! Get the rank of this compute task in the compute+io <a name='489'></font>
         <font color=#447700>! communicator to which it belongs<a name='490'></font>
         CALL MPI_Comm_Rank( mpi_comm_io_groups(j,id) , me , ierr )<a name='491'>
<a name='492'>
         <font color=#447700>! If I am an I/O server for this group then make that group's<a name='493'></font>
         <font color=#447700>! communicator the first element in the mpi_comm_io_groups array <a name='494'></font>
         <font color=#447700>! (I will ignore all of the other elements).<a name='495'></font>
<a name='496'>
         IF ( (found .LE. mytask .AND. mytask .LT.  ncompute_tasks ) ) THEN<a name='497'>
            compute_node = .TRUE.<a name='498'>
            <font color=#447700>! If I am a compute task, check whether I am the member of my <a name='499'></font>
            <font color=#447700>! group that will communicate things that should be sent just <a name='500'></font>
            <font color=#447700>! once (e.g. commands) to the IO server of my group.<a name='501'></font>
            compute_group_master(j,id) = (me .EQ. 0)<a name='502'>
         ELSE<a name='503'>
           IF (found_io+(j-1)*nio .LE. mytask .AND. mytask .LT. found_io+j*nio) THEN<a name='504'>
             mpi_comm_io_groups(1,1) = mpi_comm_io_groups(j,id)<a name='505'>
           ENDIF<a name='506'>
         ENDIF<a name='507'>
        ENDIF<a name='508'>
<a name='509'>
      ENDDO<a name='510'>
<a name='511'>
    END SUBROUTINE setup_quilt_servers<a name='512'>
<a name='513'>
<A NAME='SOKAY'><A href='../../html_code/frame/module_io_quilt_new.F.html#SOKAY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='514'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>sokay</font> ( stream, io_form ) <A href='../../call_to/SOKAY.html' TARGET='index'>26</A>,<A href='../../call_from/SOKAY.html' TARGET='index'>4</A><a name='515'>
    USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_89"><a name='516'>
    CHARACTER*(*) stream<a name='517'>
    CHARACTER*256 mess<a name='518'>
    INTEGER io_form<a name='519'>
<a name='520'>
    SELECT CASE (io_form)<a name='521'>
#ifdef NETCDF<a name='522'>
      CASE ( IO_NETCDF   )<a name='523'>
         RETURN<a name='524'>
#endif<a name='525'>
#ifdef INTIO<a name='526'>
      CASE ( IO_INTIO   )<a name='527'>
         RETURN<a name='528'>
#endif<a name='529'>
#ifdef YYY<a name='530'>
      CASE ( IO_YYY )<a name='531'>
         RETURN<a name='532'>
#endif<a name='533'>
#ifdef GRIB1<a name='534'>
      CASE ( IO_GRIB1 )<a name='535'>
         RETURN<a name='536'>
#endif<a name='537'>
#ifdef GRIB2<a name='538'>
      CASE ( IO_GRIB2 )<a name='539'>
         RETURN<a name='540'>
#endif<a name='541'>
      CASE (0)<a name='542'>
         RETURN<a name='543'>
      CASE DEFAULT<a name='544'>
         WRITE(mess,*)' An output format has been specified that is incompatible with quilting: io_form: ',io_form,' ',TRIM(stream)<a name='545'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_267">(mess)<a name='546'>
    END SELECT<a name='547'>
    END SUBROUTINE sokay<a name='548'>
<a name='549'>
<A NAME='QUILT'><A href='../../html_code/frame/module_io_quilt_new.F.html#QUILT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='550'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>quilt</font> <A href='../../call_to/QUILT.html' TARGET='index'>2</A>,<A href='../../call_from/QUILT.html' TARGET='index'>186</A><a name='551'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='552'></font>
<font color=#447700>! I/O server tasks call this routine and remain in it for the rest of the <a name='553'></font>
<font color=#447700>! model run.  I/O servers receive I/O requests from compute tasks and <a name='554'></font>
<font color=#447700>! perform requested I/O operations by calling package-dependent WRF-specific <a name='555'></font>
<font color=#447700>! I/O interfaces.  Requests are sent in the form of "data headers".  Each <a name='556'></font>
<font color=#447700>! request has a unique "header" message associated with it.  For requests that <a name='557'></font>
<font color=#447700>! contain large amounts of data, the data is appended to the header.  See <a name='558'></font>
<font color=#447700>! file module_internal_header_util.F for detailed descriptions of all <a name='559'></font>
<font color=#447700>! headers.  <a name='560'></font>
<font color=#447700>!<a name='561'></font>
<font color=#447700>! We wish to be able to link to different packages depending on whether<a name='562'></font>
<font color=#447700>! the I/O is restart, initial, history, or boundary.<a name='563'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='564'></font>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_90"><a name='565'>
      USE <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#MODULE_QUILT_OUTBUF_OPS'>module_quilt_outbuf_ops</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_QUILT_OUTBUF_OPS_1"><a name='566'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_107">, only : grid_config_rec_type, model_config_rec, model_to_grid_config_rec<a name='567'>
      IMPLICIT NONE<a name='568'>
      INCLUDE 'mpif.h'<a name='569'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_1"><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='570'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_2"><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='571'>
      TYPE (grid_config_rec_type)  :: config_flags<a name='572'>
      INTEGER itag, ninbuf, ntasks_io_group, ntasks_local_group, mytask_local, ierr<a name='573'>
      INTEGER istat<a name='574'>
      INTEGER mytask_io_group<a name='575'>
      INTEGER   :: nout_set = 0<a name='576'>
      INTEGER   :: obufsize, bigbufsize, chunksize, sz<a name='577'>
      REAL, DIMENSION(1)      :: dummy<a name='578'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: obuf, bigbuf<a name='579'>
      REAL,    ALLOCATABLE, DIMENSION(:) :: RDATA<a name='580'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: IDATA<a name='581'>
      CHARACTER (LEN=512) :: CDATA<a name='582'>
      CHARACTER (LEN=80) :: fname<a name='583'>
      INTEGER icurs, hdrbufsize, itypesize, ftypesize, rtypesize, Status, fstat, io_form_arg<a name='584'>
      INTEGER :: DataHandle, FieldType, Comm, IOComm, DomainDesc, code, Count<a name='585'>
      INTEGER, DIMENSION(3) :: DomainStart , DomainEnd , MemoryStart , MemoryEnd , PatchStart , PatchEnd<a name='586'>
      INTEGER :: dummybuf(1)<a name='587'>
      INTEGER :: num_noops, num_commit_messages, num_field_training_msgs, hdr_tag<a name='588'>
      CHARACTER (len=256) :: DateStr , Element, VarName, MemoryOrder , Stagger , DimNames(3), FileName, SysDepInfo, mess<a name='589'>
      INTEGER, EXTERNAL :: use_package<a name='590'>
      LOGICAL           :: stored_write_record, retval<a name='591'>
      INTEGER iii, jjj, vid, dom_id<a name='592'>
      LOGICAL           :: call_server_ready<a name='593'>
<a name='594'>
logical okay_to_w<a name='595'>
character*120 sysline<a name='596'>
<a name='597'>
      dom_id = 1 <font color=#447700>! always a valid assumption for domain id for this netcdf setting<a name='598'></font>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_17"> ( dom_id , model_config_rec , config_flags )<a name='599'>
<a name='600'>
<font color=#447700>! If we've been built with PNETCDF_QUILT defined then we use parallel I/O<a name='601'></font>
<font color=#447700>! within the group of I/O servers rather than gathering the data onto the<a name='602'></font>
<font color=#447700>! root I/O server. Unfortunately, this approach means that we can no-longer<a name='603'></font>
<font color=#447700>! select different I/O layers for use with quilting at run time. ARPDBG.<a name='604'></font>
<font color=#447700>! This code is sufficiently different that it is kept in the separate <a name='605'></font>
<font color=#447700>! quilt_pnc() routine.<a name='606'></font>
#ifdef PNETCDF_QUILT<a name='607'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC'>quilt_pnc</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QUILT_PNC_1">()<a name='608'>
      RETURN<a name='609'>
#endif<a name='610'>
<a name='611'>
<font color=#447700>! Call ext_pkg_ioinit() routines to initialize I/O packages.  <a name='612'></font>
      SysDepInfo = " "<a name='613'>
#ifdef NETCDF<a name='614'>
      if ( config_flags%use_netcdf_classic ) SysDepInfo="use_netcdf_classic"<a name='615'>
      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOINIT'>ext_ncd_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOINIT_2">( SysDepInfo, ierr )<a name='616'>
      SysDepInfo = " "<a name='617'>
#endif<a name='618'>
#ifdef INTIO<a name='619'>
      CALL ext_int_ioinit( SysDepInfo, ierr )<a name='620'>
#endif<a name='621'>
#ifdef XXX<a name='622'>
      CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOINIT'>ext_xxx_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOINIT_2">( SysDepInfo, ierr)<a name='623'>
#endif<a name='624'>
#ifdef YYY<a name='625'>
      CALL ext_yyy_ioinit( SysDepInfo, ierr)<a name='626'>
#endif<a name='627'>
#ifdef ZZZ<a name='628'>
      CALL ext_zzz_ioinit( SysDepInfo, ierr)<a name='629'>
#endif<a name='630'>
#ifdef GRIB1<a name='631'>
      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOINIT'>ext_gr1_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOINIT_2">( SysDepInfo, ierr)<a name='632'>
#endif<a name='633'>
#ifdef GRIB2<a name='634'>
      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOINIT'>ext_gr2_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOINIT_2">( SysDepInfo, ierr)<a name='635'>
#endif<a name='636'>
<a name='637'>
      call_server_ready = .true. <font color=#447700>! = true when the server is ready for a new file<a name='638'></font>
<a name='639'>
      okay_to_commit = .false.<a name='640'>
      stored_write_record = .false.<a name='641'>
      ninbuf = 0<a name='642'>
      <font color=#447700>! get info. about the I/O server group that this I/O server task<a name='643'></font>
      <font color=#447700>! belongs to<a name='644'></font>
      <font color=#447700>! Last task in this I/O server group is the I/O server "root"<a name='645'></font>
      <font color=#447700>! The I/O server "root" actually writes data to disk<a name='646'></font>
      <font color=#447700>! TBH:  WARNING:  This is also implicit in the call to collect_on_comm().<a name='647'></font>
      CALL mpi_x_comm_size( mpi_comm_io_groups(1,1), ntasks_io_group,    ierr )<a name='648'>
      CALL MPI_COMM_RANK( mpi_comm_io_groups(1,1), mytask_io_group,    ierr )<a name='649'>
      CALL mpi_x_comm_size( mpi_comm_local,        ntasks_local_group, ierr )<a name='650'>
      CALL MPI_COMM_RANK( mpi_comm_local,        mytask_local,       ierr )<a name='651'>
<a name='652'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='653'>
      IF ( itypesize &lt;= 0 ) THEN<a name='654'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_268">("external/RSL/module_dm.F: quilt: type size &lt;= 0 invalid")<a name='655'>
      ENDIF<a name='656'>
<a name='657'>
<font color=#447700>! Work out whether this i/o server processor has one fewer associated compute proc than<a name='658'></font>
<font color=#447700>! the most any processor has. Can happen when number of i/o tasks does not evenly divide<a name='659'></font>
<font color=#447700>! the number of compute tasks. This is needed to keep the i/o tasks sychronized on the<a name='660'></font>
<font color=#447700>! same message when they start commmunicating to stitch together an output.<a name='661'></font>
<font color=#447700>!<a name='662'></font>
<a name='663'>
<font color=#447700>! infinite loop until shutdown message received<a name='664'></font>
<font color=#447700>! This is the main request-handling loop.  I/O quilt servers stay in this loop <a name='665'></font>
<font color=#447700>! until the model run ends.  <a name='666'></font>
      okay_to_w = .FALSE.<a name='667'>
<a name='668'>
      DO WHILE (.TRUE.)  <font color=#447700>! {<a name='669'></font>
<a name='670'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='671'></font>
<font color=#447700>! Each I/O server receives requests from its compute tasks.  Each request<a name='672'></font>
<font color=#447700>! is contained in a data header (see module_internal_header_util.F for<a name='673'></font>
<font color=#447700>! detailed descriptions of data headers).<a name='674'></font>
<font color=#447700>! Each request is sent in two phases.  First, sizes of all messages that <a name='675'></font>
<font color=#447700>! will be sent from the compute tasks to this I/O server are summed on the <a name='676'></font>
<font color=#447700>! I/O server via MPI_reduce().  The I/O server then allocates buffer "obuf" <a name='677'></font>
<font color=#447700>! and receives concatenated messages from the compute tasks in it via the <a name='678'></font>
<font color=#447700>! call to collect_on_comm().  Note that "sizes" are generally expressed in <a name='679'></font>
<font color=#447700>! *bytes* in this code so conversion to "count" (number of Fortran words) is <a name='680'></font>
<font color=#447700>! required for Fortran indexing and MPI calls.  <a name='681'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='682'></font>
<a name='683'>
         if(poll_servers .and. call_server_ready) then<a name='684'>
            call_server_ready=.false.<a name='685'>
            <font color=#447700>! Send a message to the monitor telling it we're ready<a name='686'></font>
            <font color=#447700>! for a new data handle.<a name='687'></font>
            call <A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY'>wrf_quilt_server_ready</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_QUILT_SERVER_READY_1">()<a name='688'>
         endif<a name='689'>
<a name='690'>
        <font color=#447700>! wait for info from compute tasks in the I/O group that we're ready to rock<a name='691'></font>
        <font color=#447700>! obufsize will contain number of *bytes*<a name='692'></font>
<font color=#447700>!CALL start_timing()<a name='693'></font>
        <font color=#447700>! first element of reduced is obufsize, second is DataHandle <a name='694'></font>
        <font color=#447700>! if needed (currently needed only for ioclose).<a name='695'></font>
        reduced_dummy = 0<a name='696'>
<a name='697'>
<font color=#447700>!write(0,*)'before mpi_x_reduce on quilt server '<a name='698'></font>
        CALL mpi_x_reduce( reduced_dummy, reduced, 2, MPI_INTEGER, MPI_SUM, mytask_io_group, mpi_comm_io_groups(1,1), ierr )<a name='699'>
        obufsize = reduced(1)<a name='700'>
<font color=#447700>!CALL end_timing("MPI_Reduce at top of forever loop") <a name='701'></font>
<font color=#447700>!JMDEBUGwrite(0,*)'obufsize = ',obufsize<a name='702'></font>
<font color=#447700>! Negative obufsize will trigger I/O server exit.  <a name='703'></font>
<font color=#447700>!write(0,*)'after mpi_x_reduce on quilt server ',obufsize<a name='704'></font>
        IF ( obufsize .LT. 0 ) THEN<a name='705'>
          IF ( obufsize .EQ. -100 ) THEN         <font color=#447700>! magic number<a name='706'></font>
#ifdef NETCDF<a name='707'>
            CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOEXIT'>ext_ncd_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOEXIT_2">( Status )<a name='708'>
#endif<a name='709'>
#ifdef INTIO<a name='710'>
            CALL ext_int_ioexit( Status )<a name='711'>
#endif<a name='712'>
#ifdef XXX<a name='713'>
            CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOEXIT'>ext_xxx_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOEXIT_2">( Status )<a name='714'>
#endif<a name='715'>
#ifdef YYY<a name='716'>
            CALL ext_yyy_ioexit( Status )<a name='717'>
#endif<a name='718'>
#ifdef ZZZ<a name='719'>
            CALL ext_zzz_ioexit( Status )<a name='720'>
#endif<a name='721'>
#ifdef GRIB1<a name='722'>
            CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOEXIT'>ext_gr1_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOEXIT_2">( Status )<a name='723'>
#endif<a name='724'>
#ifdef GRIB2<a name='725'>
            CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOEXIT'>ext_gr2_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOEXIT_2">( Status )<a name='726'>
#endif<a name='727'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_342"> ( 'I/O QUILT SERVERS DONE' )<a name='728'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='729'></font>
            IF (coupler_on) THEN <a name='730'>
               CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_FINALIZE'>cpl_finalize</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_FINALIZE_1">() <a name='731'>
            ELSE<a name='732'>
#endif<a name='733'>
               CALL mpi_finalize(ierr)<a name='734'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='735'></font>
            END IF<a name='736'>
#endif<a name='737'>
            STOP<a name='738'>
          ELSE<a name='739'>
            WRITE(mess,*)'Possible 32-bit overflow on output server. Try larger nio_tasks_per_group in namelist.'<a name='740'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_269">(mess)<a name='741'>
          ENDIF<a name='742'>
        ENDIF<a name='743'>
<a name='744'>
<font color=#447700>!        CALL start_timing()<a name='745'></font>
<font color=#447700>! Obufsize of zero signals a close<a name='746'></font>
<a name='747'>
<font color=#447700>! Allocate buffer obuf to be big enough for the data the compute tasks<a name='748'></font>
<font color=#447700>! will send.  Note: obuf is size in *bytes* so we need to pare this <a name='749'></font>
<font color=#447700>! down, since the buffer is INTEGER.  <a name='750'></font>
        IF ( obufsize .GT. 0 ) THEN<a name='751'>
          ALLOCATE( obuf( (obufsize+1)/itypesize ) )<a name='752'>
<a name='753'>
<font color=#447700>! let's roll; get the data from the compute procs and put in obuf<a name='754'></font>
          CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_1">(__FILE__,__LINE__, mpi_comm_io_groups(1,1),        &amp;<a name='755'>
                                onebyte,                      &amp;<a name='756'>
                                dummy, 0,                     &amp;<a name='757'>
                                obuf, obufsize )<a name='758'>
<font color=#447700>!          CALL end_timing( "quilt on server: collecting data from compute procs" )<a name='759'></font>
        ELSE<a name='760'>
          <font color=#447700>! Necessarily, the compute processes send the ioclose signal,<a name='761'></font>
          <font color=#447700>! if there is one, after the iosync, which means they <a name='762'></font>
          <font color=#447700>! will stall on the ioclose message waiting for the quilt <a name='763'></font>
          <font color=#447700>! processes if we handle the way other messages are collected,<a name='764'></font>
          <font color=#447700>! using collect_on_comm.  This avoids this, but we need<a name='765'></font>
          <font color=#447700>! a special signal (obufsize zero) and the DataHandle<a name='766'></font>
          <font color=#447700>! to be closed. That handle is send as the second<a name='767'></font>
          <font color=#447700>! word of the io_close message received by the MPI_Reduce above.<a name='768'></font>
          <font color=#447700>! Then a header representing the ioclose message is constructed<a name='769'></font>
          <font color=#447700>! here and handled below as if it were received from the <a name='770'></font>
          <font color=#447700>! compute processes. The clients (compute processes) must be<a name='771'></font>
          <font color=#447700>! careful to send this correctly (one compule process sends the actual<a name='772'></font>
          <font color=#447700>! handle and everone else sends a zero, so the result sums to <a name='773'></font>
          <font color=#447700>! the value of the handle).<a name='774'></font>
          <font color=#447700>!<a name='775'></font>
          ALLOCATE( obuf( 4096 ) )<a name='776'>
          <font color=#447700>! DataHandle is provided as second element of reduced<a name='777'></font>
          CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_1">( obuf, obufsize, itypesize, &amp;<a name='778'>
                                      reduced(2) , int_ioclose )<a name='779'>
<a name='780'>
          if(poll_servers) then <a name='781'>
             <font color=#447700>! Once we're done closing, we need to tell the master<a name='782'></font>
             <font color=#447700>! process that we're ready for more data.<a name='783'></font>
             call_server_ready=.true.<a name='784'>
          endif<a name='785'>
        ENDIF<a name='786'>
<a name='787'>
<font color=#447700>!write(0,*)'calling init_store_piece_of_field'<a name='788'></font>
<font color=#447700>! Now all messages received from the compute clients are stored in <a name='789'></font>
<font color=#447700>! obuf.  Scan through obuf and extract headers and field data and store in <a name='790'></font>
<font color=#447700>! internal buffers.  The scan is done twice, first to determine sizes of <a name='791'></font>
<font color=#447700>! internal buffers required for storage of headers and fields and second to <a name='792'></font>
<font color=#447700>! actually store the headers and fields.  This bit of code does not do the <a name='793'></font>
<font color=#447700>! "quilting" (assembly of patches into full domains).  For each field, it <a name='794'></font>
<font color=#447700>! simply concatenates all received patches for the field into a separate <a name='795'></font>
<font color=#447700>! internal buffer (i.e. one buffer per field).  Quilting is done later by <a name='796'></font>
<font color=#447700>! routine store_patch_in_outbuf().  <a name='797'></font>
        CALL init_store_piece_of_field<a name='798'>
        CALL mpi_type_size ( MPI_INTEGER , itypesize , ierr )<a name='799'>
<font color=#447700>!write(0,*)'mpi_type_size returns ', itypesize<a name='800'></font>
<font color=#447700>! Scan obuf the first time to calculate the size of the buffer required for <a name='801'></font>
<font color=#447700>! each field.  Calls to add_to_bufsize_for_field() accumulate sizes.  <a name='802'></font>
        vid = 0<a name='803'>
        icurs = itypesize<a name='804'>
        num_noops = 0 <a name='805'>
        num_commit_messages = 0 <a name='806'>
        num_field_training_msgs = 0 <a name='807'>
        DO WHILE ( icurs .lt. obufsize ) <font color=#447700>! {<a name='808'></font>
          hdr_tag = <A href='../../html_code/frame/module_internal_header_util.F.html#GET_HDR_TAG'>get_hdr_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HDR_TAG_1">( obuf ( icurs / itypesize ) )<a name='809'>
          SELECT CASE ( hdr_tag )<a name='810'>
            CASE ( int_field )<a name='811'>
              CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_2"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='812'>
                                                DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='813'>
                                                DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='814'>
                                                DomainStart , DomainEnd ,                                    &amp;<a name='815'>
                                                MemoryStart , MemoryEnd ,                                    &amp;<a name='816'>
                                                PatchStart , PatchEnd )<a name='817'>
              chunksize = (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='818'>
                          (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='819'>
<a name='820'>
              IF ( DomainDesc .EQ. 333933 ) THEN  <font color=#447700>! Training write, only one per group of tasks<a name='821'></font>
                 IF ( num_field_training_msgs .EQ. 0 ) THEN<a name='822'>
                   call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_1">( VarName, hdrbufsize )<a name='823'>
<font color=#447700>!write(0,*) 'X-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='824'></font>
                 ENDIF<a name='825'>
                 num_field_training_msgs = num_field_training_msgs + 1<a name='826'>
              ELSE<a name='827'>
                 call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_2">( VarName, hdrbufsize )<a name='828'>
<font color=#447700>!write(0,*) 'X-2a', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='829'></font>
              ENDIF<a name='830'>
              icurs = icurs + hdrbufsize<a name='831'>
<a name='832'>
<font color=#447700>!write(0,*) 'X-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='833'></font>
<a name='834'>
              <font color=#447700>! If this is a real write (i.e. not a training write), accumulate<a name='835'></font>
              <font color=#447700>! buffersize for this field.<a name='836'></font>
              IF ( DomainDesc .NE. 333933 ) THEN   <font color=#447700>! magic number<a name='837'></font>
<font color=#447700>!write(0,*) 'X-1a', chunksize, TRIM(VarName)<a name='838'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_3">( VarName, chunksize )<a name='839'>
                icurs = icurs + chunksize<a name='840'>
              ENDIF<a name='841'>
            CASE ( int_open_for_write_commit )  <font color=#447700>! only one per group of tasks<a name='842'></font>
              hdrbufsize = obuf(icurs/itypesize)<a name='843'>
              IF (num_commit_messages.EQ.0) THEN<a name='844'>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_4">( 'COMMIT', hdrbufsize )<a name='845'>
              ENDIF<a name='846'>
              num_commit_messages = num_commit_messages + 1<a name='847'>
              icurs = icurs + hdrbufsize<a name='848'>
            CASE DEFAULT<a name='849'>
              hdrbufsize = obuf(icurs/itypesize)<a name='850'>
<a name='851'>
<font color=#447700>! This logic and the logic in the loop below is used to determine whether<a name='852'></font>
<font color=#447700>! to send a noop records sent by the compute processes to allow to go<a name='853'></font>
<font color=#447700>! through. The purpose is to make sure that the communications between this<a name='854'></font>
<font color=#447700>! server and the other servers in this quilt group stay synchronized in<a name='855'></font>
<font color=#447700>! the collection loop below, even when the servers are serving different<a name='856'></font>
<font color=#447700>! numbers of clients. Here are some conditions:<a name='857'></font>
<font color=#447700>! <a name='858'></font>
<font color=#447700>!   1. The number of compute clients served will not differ by more than 1<a name='859'></font>
<font color=#447700>!   2. The servers with +1 number of compute clients begin with task 0<a name='860'></font>
<font color=#447700>!      of mpi_comm_local, the commicator shared by this group of servers<a name='861'></font>
<font color=#447700>! <a name='862'></font>
<font color=#447700>!   3. For each collective field or metadata output from the compute tasks,<a name='863'></font>
<font color=#447700>!      there will be one record sent to the associated i/o server task. The<a name='864'></font>
<font color=#447700>!      i/o server task collects these records and stores them contiguously<a name='865'></font>
<font color=#447700>!      in a buffer (obuf) using collect_on_comm above.  Thus, obuf on this<a name='866'></font>
<font color=#447700>!      server task will contain one record from each associated compute<a name='867'></font>
<font color=#447700>!      task, in order.<a name='868'></font>
<font color=#447700>! <a name='869'></font>
<font color=#447700>!   4. In the case of replicated output from the compute tasks<a name='870'></font>
<font color=#447700>!      (e.g. put_dom_ti records and control records like<a name='871'></font>
<font color=#447700>!      open_for_write_commit type records), compute task 0 is the only<a name='872'></font>
<font color=#447700>!      one that sends the record. The other compute tasks send noop<a name='873'></font>
<font color=#447700>!      records. Thus, obuf on server task zero will contain the output<a name='874'></font>
<font color=#447700>!      record from task 0 followed by noop records from the rest of the<a name='875'></font>
<font color=#447700>!      compute tasks associated with task 0.  Obuf on the other server<a name='876'></font>
<font color=#447700>!      tasks will contain nothing but noop records.<a name='877'></font>
<font color=#447700>! <a name='878'></font>
<font color=#447700>!   5. The logic below will not allow any noop records from server task 0.<a name='879'></font>
<font color=#447700>!      It allows only one noop record from each of the other server tasks<a name='880'></font>
<font color=#447700>!      in the i/o group.  This way, for replicated output, when the records<a name='881'></font>
<font color=#447700>!      are collected on one server task below, using collect_on_comm on<a name='882'></font>
<font color=#447700>!      mpi_comm_local, each task will provide exactly one record for each<a name='883'></font>
<font color=#447700>!      call to collect_on_comm: 1 bona fide output record from server task<a name='884'></font>
<font color=#447700>!      0 and noops from the rest.<a name='885'></font>
<a name='886'>
              IF ((hdr_tag.EQ.int_noop.AND.mytask_local.NE.0.AND.num_noops.LE.0)  &amp;<a name='887'>
                  .OR.hdr_tag.NE.int_noop) THEN<a name='888'>
                write(VarName,'(I5.5)')vid <a name='889'>
<font color=#447700>!write(0,*) 'X-2', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='890'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_5">( VarName, hdrbufsize )<a name='891'>
                vid = vid+1<a name='892'>
              ENDIF<a name='893'>
              IF ( hdr_tag .EQ. int_noop ) num_noops = num_noops + 1<a name='894'>
              icurs = icurs + hdrbufsize<a name='895'>
          END SELECT<a name='896'>
        ENDDO <font color=#447700>! }<a name='897'></font>
<font color=#447700>! Store the headers and field data in internal buffers.  The first call to <a name='898'></font>
<font color=#447700>! store_piece_of_field() allocates internal buffers using sizes computed by <a name='899'></font>
<font color=#447700>! calls to add_to_bufsize_for_field().  <a name='900'></font>
        vid = 0<a name='901'>
        icurs = itypesize<a name='902'>
        num_noops = 0 <a name='903'>
        num_commit_messages = 0 <a name='904'>
        num_field_training_msgs = 0 <a name='905'>
        DO WHILE ( icurs .lt. obufsize ) <font color=#447700>!{<a name='906'></font>
<font color=#447700>!write(0,*) 'A icurs ', icurs, ' obufsize ', obufsize<a name='907'></font>
          hdr_tag = <A href='../../html_code/frame/module_internal_header_util.F.html#GET_HDR_TAG'>get_hdr_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HDR_TAG_2">( obuf ( icurs / itypesize ) )<a name='908'>
          SELECT CASE ( hdr_tag )<a name='909'>
            CASE ( int_field )<a name='910'>
              CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_3"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='911'>
                                                DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='912'>
                                                DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='913'>
                                                DomainStart , DomainEnd ,                                    &amp;<a name='914'>
                                                MemoryStart , MemoryEnd ,                                    &amp;<a name='915'>
                                                PatchStart , PatchEnd )<a name='916'>
              chunksize = (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='917'>
                          (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='918'>
<a name='919'>
              IF ( DomainDesc .EQ. 333933 ) THEN  <font color=#447700>! Training write, only one per group of tasks<a name='920'></font>
                 IF ( num_field_training_msgs .EQ. 0 ) THEN<a name='921'>
                   call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_1">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='922'>
<font color=#447700>!write(0,*) 'A-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='923'></font>
                 ENDIF<a name='924'>
                 num_field_training_msgs = num_field_training_msgs + 1<a name='925'>
              ELSE<a name='926'>
                 call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_2">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='927'>
<font color=#447700>!write(0,*) 'A-2a', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='928'></font>
              ENDIF<a name='929'>
              icurs = icurs + hdrbufsize<a name='930'>
              <font color=#447700>! If this is a real write (i.e. not a training write), store<a name='931'></font>
              <font color=#447700>! this piece of this field.<a name='932'></font>
              IF ( DomainDesc .NE. 333933 ) THEN   <font color=#447700>! magic number<a name='933'></font>
<font color=#447700>!write(0,*) 'A-1a', chunksize, TRIM(VarName),PatchStart(1:3),PatchEnd(1:3)<a name='934'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_3">( obuf(icurs/itypesize), VarName, chunksize )<a name='935'>
                icurs = icurs + chunksize<a name='936'>
              ENDIF<a name='937'>
            CASE ( int_open_for_write_commit )  <font color=#447700>! only one per group of tasks<a name='938'></font>
              hdrbufsize = obuf(icurs/itypesize)<a name='939'>
              IF (num_commit_messages.EQ.0) THEN<a name='940'>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_4">( obuf(icurs/itypesize), 'COMMIT', hdrbufsize )<a name='941'>
              ENDIF<a name='942'>
              num_commit_messages = num_commit_messages + 1<a name='943'>
              icurs = icurs + hdrbufsize<a name='944'>
            CASE DEFAULT<a name='945'>
              hdrbufsize = obuf(icurs/itypesize)<a name='946'>
              IF ((hdr_tag.EQ.int_noop.AND.mytask_local.NE.0.AND.num_noops.LE.0)  &amp;<a name='947'>
                  .OR.hdr_tag.NE.int_noop) THEN<a name='948'>
                write(VarName,'(I5.5)')vid <a name='949'>
<font color=#447700>!write(0,*) 'A-2b', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='950'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_5">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='951'>
                vid = vid+1<a name='952'>
              ENDIF<a name='953'>
              IF ( hdr_tag .EQ. int_noop ) num_noops = num_noops + 1<a name='954'>
              icurs = icurs + hdrbufsize<a name='955'>
          END SELECT<a name='956'>
        ENDDO <font color=#447700>!}<a name='957'></font>
<a name='958'>
<font color=#447700>! Now, for each field, retrieve headers and patches (data) from the internal <a name='959'></font>
<font color=#447700>! buffers and collect them all on the I/O quilt server "root" task.<a name='960'></font>
        CALL init_retrieve_pieces_of_field<a name='961'>
<font color=#447700>! Retrieve header and all patches for the first field from the internal <a name='962'></font>
<font color=#447700>! buffers.  <a name='963'></font>
        CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#RETRIEVE_PIECES_OF_FIELD'>retrieve_pieces_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_PIECES_OF_FIELD_1"> ( obuf , VarName, obufsize, sz, retval )<a name='964'>
<font color=#447700>! Sum sizes of all headers and patches (data) for this field from all I/O <a name='965'></font>
<font color=#447700>! servers in this I/O server group onto the I/O server "root".<a name='966'></font>
        CALL mpi_x_reduce( sz, bigbufsize, 1, MPI_INTEGER, MPI_SUM, ntasks_local_group-1, mpi_comm_local, ierr )<a name='967'>
<font color=#447700>!write(0,*)'seed: sz ',sz,' bigbufsize ',bigbufsize,' VarName ', TRIM(VarName),' retval ',retval<a name='968'></font>
<a name='969'>
<font color=#447700>! Loop until there are no more fields to retrieve from the internal buffers.<a name='970'></font>
        DO WHILE ( retval ) <font color=#447700>!{<a name='971'></font>
#if 0<a name='972'>
#else<a name='973'>
<a name='974'>
<font color=#447700>! I/O server "root" allocates space to collect headers and fields from all<a name='975'></font>
<font color=#447700>! other servers in this I/O server group.<a name='976'></font>
          IF ( mytask_local .EQ. ntasks_local_group-1 ) THEN<a name='977'>
            ALLOCATE( bigbuf( (bigbufsize+1)/itypesize ) )<a name='978'>
         else<a name='979'>
            ALLOCATE( bigbuf(1) )<a name='980'>
          ENDIF<a name='981'>
<a name='982'>
<font color=#447700>! Collect buffers and fields from all I/O servers in this I/O server group<a name='983'></font>
<font color=#447700>! onto the I/O server "root"<a name='984'></font>
          CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG2'>collect_on_comm_debug2</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG2_1">(__FILE__,__LINE__,Trim(VarName),        &amp;<a name='985'>
                                get_hdr_tag(obuf),sz,get_hdr_rec_size(obuf),  &amp;<a name='986'>
                                mpi_comm_local,                               &amp;<a name='987'>
                                onebyte,                                      &amp;<a name='988'>
                                obuf, sz,                                     &amp;<a name='989'>
                                bigbuf, bigbufsize )<a name='990'>
<font color=#447700>! The I/O server "root" now handles collected requests from all compute <a name='991'></font>
<font color=#447700>! tasks served by this I/O server group (i.e. all compute tasks).  <a name='992'></font>
          IF ( mytask_local .EQ. ntasks_local_group-1 ) THEN<a name='993'>
<font color=#447700>!jjj = 4<a name='994'></font>
<font color=#447700>!do iii = 1, ntasks_local_group<a name='995'></font>
<font color=#447700>!  write(0,*)'i,j,tag,size ', iii, jjj, get_hdr_tag(bigbuf(jjj/4)),get_hdr_rec_size(bigbuf(jjj/4))<a name='996'></font>
<font color=#447700>!  jjj = jjj + get_hdr_rec_size(bigbuf(jjj/4))<a name='997'></font>
<font color=#447700>!enddo<a name='998'></font>
<a name='999'>
            icurs = itypesize  <font color=#447700>! icurs is a byte counter, but buffer is integer<a name='1000'></font>
<a name='1001'>
            stored_write_record = .false.<a name='1002'>
<a name='1003'>
<font color=#447700>! The I/O server "root" loops over the collected requests.  <a name='1004'></font>
            DO WHILE ( icurs .lt. bigbufsize ) <font color=#447700>!{<a name='1005'></font>
              CALL mpi_type_size ( MPI_INTEGER , itypesize , ierr )<a name='1006'>
<a name='1007'>
<font color=#447700>!write(0,*)'B tag,size ',icurs,get_hdr_tag( bigbuf(icurs/itypesize) ),get_hdr_rec_size( bigbuf(icurs/itypesize) )<a name='1008'></font>
<font color=#447700>! The I/O server "root" gets the request out of the next header and<a name='1009'></font>
<font color=#447700>! handles it by, in most cases, calling the appropriate external I/O package<a name='1010'></font>
<font color=#447700>! interface.<a name='1011'></font>
              SELECT CASE ( get_hdr_tag( bigbuf(icurs/itypesize) ) )<a name='1012'>
<font color=#447700>! The I/O server "root" handles the "noop" (do nothing) request.  This is <a name='1013'></font>
<font color=#447700>! actually quite easy.  "Noop" requests exist to help avoid race conditions.  <a name='1014'></font>
<font color=#447700>! In some cases, only one compute task will everything about a request so <a name='1015'></font>
<font color=#447700>! other compute tasks send "noop" requests.  <a name='1016'></font>
                CASE ( int_noop )<a name='1017'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_NOOP_HEADER'>int_get_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_NOOP_HEADER_1">( bigbuf(icurs/itypesize), hdrbufsize, itypesize )<a name='1018'>
                  icurs = icurs + hdrbufsize<a name='1019'>
<a name='1020'>
<font color=#447700>! The I/O server "root" handles the "put_dom_td_real" request.<a name='1021'></font>
                CASE ( int_dom_td_real )<a name='1022'>
                  CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='1023'>
                  ALLOCATE( RData( bigbuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1024'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TD_HEADER'>int_get_td_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TD_HEADER_1">( bigbuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1025'>
                                          DataHandle, DateStr, Element, RData, Count, code )<a name='1026'>
                  icurs = icurs + hdrbufsize<a name='1027'>
<a name='1028'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1029'>
#ifdef NETCDF<a name='1030'>
                    CASE ( IO_NETCDF   )<a name='1031'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TD_REAL'>ext_ncd_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TD_REAL_1">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1032'>
#endif<a name='1033'>
#ifdef INTIO<a name='1034'>
                    CASE ( IO_INTIO   )<a name='1035'>
                      CALL ext_int_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1036'>
#endif<a name='1037'>
#ifdef YYY<a name='1038'>
                 CASE ( IO_YYY )<a name='1039'>
                    CALL ext_yyy_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1040'>
#endif<a name='1041'>
#ifdef GRIB1<a name='1042'>
                 CASE ( IO_GRIB1 )<a name='1043'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TD_REAL'>ext_gr1_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TD_REAL_1">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1044'>
#endif<a name='1045'>
#ifdef GRIB2<a name='1046'>
                 CASE ( IO_GRIB2 )<a name='1047'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TD_REAL'>ext_gr2_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TD_REAL_1">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1048'>
#endif<a name='1049'>
                     CASE DEFAULT<a name='1050'>
                      Status = 0<a name='1051'>
                  END SELECT<a name='1052'>
<a name='1053'>
                  DEALLOCATE( RData )<a name='1054'>
<font color=#447700>! The I/O server "root" handles the "put_dom_ti_real" request.<a name='1055'></font>
                CASE ( int_dom_ti_real )<a name='1056'>
                  CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='1057'>
                  ALLOCATE( RData( bigbuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1058'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER'>int_get_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_1">( bigbuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1059'>
                                          DataHandle, Element, RData, Count, code )<a name='1060'>
<font color=#447700>!write(0,*)' int_dom_ti_real ',trim(element),count<a name='1061'></font>
                  icurs = icurs + hdrbufsize<a name='1062'>
<a name='1063'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1064'>
#ifdef NETCDF<a name='1065'>
                    CASE ( IO_NETCDF   )<a name='1066'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_REAL'>ext_ncd_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_REAL_1">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1067'>
<font color=#447700>!write(0,*)'ext_ncd_put_dom_ti_real ',handle(DataHandle),TRIM(Element),RData,Status<a name='1068'></font>
#endif<a name='1069'>
#ifdef INTIO<a name='1070'>
                    CASE ( IO_INTIO   )<a name='1071'>
                      CALL ext_int_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1072'>
#endif<a name='1073'>
#ifdef YYY<a name='1074'>
                 CASE ( IO_YYY )<a name='1075'>
                    CALL ext_yyy_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1076'>
#endif<a name='1077'>
#ifdef GRIB1<a name='1078'>
                 CASE ( IO_GRIB1 )<a name='1079'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_REAL'>ext_gr1_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_REAL_1">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1080'>
#endif<a name='1081'>
#ifdef GRIB2<a name='1082'>
                 CASE ( IO_GRIB2 )<a name='1083'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_REAL'>ext_gr2_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_REAL_1">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1084'>
#endif<a name='1085'>
                    CASE DEFAULT<a name='1086'>
                      Status = 0<a name='1087'>
                  END SELECT<a name='1088'>
<a name='1089'>
                  DEALLOCATE( RData )<a name='1090'>
<a name='1091'>
<font color=#447700>! The I/O server "root" handles the "put_dom_td_integer" request.<a name='1092'></font>
                CASE ( int_dom_td_integer )<a name='1093'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='1094'>
                  ALLOCATE( IData( bigbuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1095'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TD_HEADER'>int_get_td_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TD_HEADER_2">( bigbuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1096'>
                                          DataHandle, DateStr, Element, IData, Count, code )<a name='1097'>
<font color=#447700>!write(0,*)' int_dom_td_integer ',trim(element)<a name='1098'></font>
                  icurs = icurs + hdrbufsize<a name='1099'>
<a name='1100'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1101'>
#ifdef NETCDF<a name='1102'>
                    CASE ( IO_NETCDF   )<a name='1103'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TD_INTEGER'>ext_ncd_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TD_INTEGER_1">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1104'>
#endif<a name='1105'>
#ifdef INTIO<a name='1106'>
                    CASE ( IO_INTIO   )<a name='1107'>
                      CALL ext_int_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1108'>
#endif<a name='1109'>
#ifdef YYY<a name='1110'>
                 CASE ( IO_YYY )<a name='1111'>
                    CALL ext_yyy_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1112'>
#endif<a name='1113'>
#ifdef GRIB1<a name='1114'>
                 CASE ( IO_GRIB1 )<a name='1115'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TD_INTEGER'>ext_gr1_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TD_INTEGER_1">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1116'>
#endif<a name='1117'>
#ifdef GRIB2<a name='1118'>
                 CASE ( IO_GRIB2 )<a name='1119'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TD_INTEGER'>ext_gr2_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TD_INTEGER_1">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1120'>
#endif<a name='1121'>
                    CASE DEFAULT<a name='1122'>
                      Status = 0<a name='1123'>
                  END SELECT<a name='1124'>
<a name='1125'>
                  DEALLOCATE( IData )<a name='1126'>
<a name='1127'>
<font color=#447700>! The I/O server "root" handles the "put_dom_ti_integer" request.<a name='1128'></font>
                CASE ( int_dom_ti_integer )<a name='1129'>
<a name='1130'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='1131'>
                  ALLOCATE( IData( bigbuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1132'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER'>int_get_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_2">( bigbuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1133'>
                                          DataHandle, Element, IData, Count, code )<a name='1134'>
<font color=#447700>!write(0,*)' int_dom_ti_integer ',trim(element)<a name='1135'></font>
                  icurs = icurs + hdrbufsize<a name='1136'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1137'>
#ifdef NETCDF<a name='1138'>
                    CASE ( IO_NETCDF   )<a name='1139'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_INTEGER'>ext_ncd_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_INTEGER_1">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1140'>
<font color=#447700>!!write(0,*)'ext_ncd_put_dom_ti_integer ',handle(DataHandle),TRIM(Element),IData,Status<a name='1141'></font>
#endif<a name='1142'>
#ifdef INTIO<a name='1143'>
                    CASE ( IO_INTIO   )<a name='1144'>
                      CALL ext_int_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1145'>
#endif<a name='1146'>
#ifdef YYY<a name='1147'>
                 CASE ( IO_YYY )<a name='1148'>
                    CALL ext_yyy_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1149'>
#endif<a name='1150'>
#ifdef GRIB1<a name='1151'>
                 CASE ( IO_GRIB1 )<a name='1152'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_INTEGER'>ext_gr1_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_INTEGER_1">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1153'>
#endif<a name='1154'>
#ifdef GRIB2<a name='1155'>
                 CASE ( IO_GRIB2 )<a name='1156'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_INTEGER'>ext_gr2_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_INTEGER_1">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1157'>
#endif<a name='1158'>
<a name='1159'>
                    CASE DEFAULT<a name='1160'>
                      Status = 0<a name='1161'>
                  END SELECT<a name='1162'>
<a name='1163'>
                  DEALLOCATE( IData)<a name='1164'>
 <a name='1165'>
<font color=#447700>! The I/O server "root" handles the "set_time" request.<a name='1166'></font>
                CASE ( int_set_time )<a name='1167'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_2">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1168'>
                                               DataHandle, Element, VarName, CData, code )<a name='1169'>
<font color=#447700>!write(0,*)' int_set_time ',trim(element)<a name='1170'></font>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1171'>
#ifdef INTIO<a name='1172'>
                    CASE ( IO_INTIO   )<a name='1173'>
                      CALL ext_int_set_time ( handle(DataHandle), TRIM(CData), Status)<a name='1174'>
#endif<a name='1175'>
                    CASE DEFAULT<a name='1176'>
                      Status = 0<a name='1177'>
                  END SELECT<a name='1178'>
<a name='1179'>
                  icurs = icurs + hdrbufsize<a name='1180'>
<a name='1181'>
<font color=#447700>! The I/O server "root" handles the "put_dom_ti_char" request.<a name='1182'></font>
                CASE ( int_dom_ti_char )<a name='1183'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_3">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1184'>
                                               DataHandle, Element, VarName, CData, code )<a name='1185'>
<font color=#447700>!write(0,*)' after int_get_ti_header_char ',trim(VarName),trim(element)<a name='1186'></font>
<a name='1187'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1188'>
#ifdef NETCDF<a name='1189'>
                    CASE ( IO_NETCDF   )<a name='1190'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_CHAR'>ext_ncd_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_CHAR_1"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1191'>
#endif<a name='1192'>
#ifdef INTIO<a name='1193'>
                    CASE ( IO_INTIO   )<a name='1194'>
                      CALL ext_int_put_dom_ti_char ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1195'>
#endif<a name='1196'>
#ifdef YYY<a name='1197'>
                 CASE ( IO_YYY )<a name='1198'>
                    CALL ext_yyy_put_dom_ti_char ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1199'>
#endif<a name='1200'>
#ifdef GRIB1<a name='1201'>
                 CASE ( IO_GRIB1 )<a name='1202'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_CHAR'>ext_gr1_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_CHAR_1"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1203'>
#endif<a name='1204'>
#ifdef GRIB2<a name='1205'>
                 CASE ( IO_GRIB2 )<a name='1206'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_CHAR'>ext_gr2_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_CHAR_1"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1207'>
#endif<a name='1208'>
                    CASE DEFAULT<a name='1209'>
                      Status = 0<a name='1210'>
                  END SELECT<a name='1211'>
<a name='1212'>
                  icurs = icurs + hdrbufsize<a name='1213'>
<a name='1214'>
<font color=#447700>! The I/O server "root" handles the "put_var_ti_char" request.<a name='1215'></font>
                CASE ( int_var_ti_char )<a name='1216'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_4">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1217'>
                                               DataHandle, Element, VarName, CData, code )<a name='1218'>
<font color=#447700>!write(0,*)' int_var_ti_char ',trim(varname),trim(element)<a name='1219'></font>
<a name='1220'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1221'>
#ifdef NETCDF<a name='1222'>
                    CASE ( IO_NETCDF   )<a name='1223'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_VAR_TI_CHAR'>ext_ncd_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_VAR_TI_CHAR_1"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1224'>
#endif<a name='1225'>
#ifdef INTIO<a name='1226'>
                    CASE ( IO_INTIO   )<a name='1227'>
                      CALL ext_int_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1228'>
#endif<a name='1229'>
#ifdef YYY<a name='1230'>
                 CASE ( IO_YYY )<a name='1231'>
                    CALL ext_yyy_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1232'>
#endif<a name='1233'>
#ifdef GRIB1<a name='1234'>
                 CASE ( IO_GRIB1 )<a name='1235'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_VAR_TI_CHAR'>ext_gr1_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_VAR_TI_CHAR_1"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1236'>
#endif<a name='1237'>
#ifdef GRIB2<a name='1238'>
                 CASE ( IO_GRIB2 )<a name='1239'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_VAR_TI_CHAR'>ext_gr2_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_VAR_TI_CHAR_1"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1240'>
#endif<a name='1241'>
                    CASE DEFAULT<a name='1242'>
                      Status = 0<a name='1243'>
                  END SELECT<a name='1244'>
<a name='1245'>
                  icurs = icurs + hdrbufsize<a name='1246'>
<a name='1247'>
                CASE ( int_ioexit )<a name='1248'>
<font color=#447700>! ioexit is now handled by sending negative message length to server<a name='1249'></font>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_270">( &amp;<a name='1250'>
                         "quilt: should have handled int_ioexit already")<a name='1251'>
<font color=#447700>! The I/O server "root" handles the "ioclose" request.<a name='1252'></font>
                CASE ( int_ioclose )<a name='1253'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_1">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1254'>
                                              DataHandle , code )<a name='1255'>
                  icurs = icurs + hdrbufsize<a name='1256'>
<a name='1257'>
                  IF ( DataHandle .GE. 1 ) THEN<a name='1258'>
<font color=#447700>!JMDEBUGwrite(0,*)'closing DataHandle ',DataHandle,' io_form ',io_form(DataHandle)<a name='1259'></font>
<a name='1260'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1261'>
#ifdef NETCDF<a name='1262'>
                    CASE ( IO_NETCDF   )<a name='1263'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_INQUIRE_FILENAME'>ext_ncd_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_INQUIRE_FILENAME_2">( handle(DataHandle), fname, fstat, Status )<a name='1264'>
                      IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1265'>
                        CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOCLOSE'>ext_ncd_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOCLOSE_3">(handle(DataHandle),Status)<a name='1266'>
                      ENDIF<a name='1267'>
#endif<a name='1268'>
#ifdef PNETCDF<a name='1269'>
                    CASE ( IO_PNETCDF   )<a name='1270'>
                      CALL ext_pnc_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1271'>
                      IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1272'>
                        CALL ext_pnc_ioclose(handle(DataHandle),Status)<a name='1273'>
                      ENDIF<a name='1274'>
#endif<a name='1275'>
#ifdef INTIO<a name='1276'>
                    CASE ( IO_INTIO   )<a name='1277'>
                      CALL ext_int_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1278'>
                      IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1279'>
                        CALL ext_int_ioclose(handle(DataHandle),Status)<a name='1280'>
                      ENDIF<a name='1281'>
#endif<a name='1282'>
#ifdef YYY<a name='1283'>
                 CASE ( IO_YYY )<a name='1284'>
                    CALL ext_yyy_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1285'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1286'>
                      CALL ext_yyy_ioclose(handle(DataHandle),Status)<a name='1287'>
                    ENDIF<a name='1288'>
#endif<a name='1289'>
#ifdef GRIB1<a name='1290'>
                 CASE ( IO_GRIB1 )<a name='1291'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_INQUIRE_FILENAME'>ext_gr1_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_INQUIRE_FILENAME_2">( handle(DataHandle), fname, fstat, Status )<a name='1292'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1293'>
                      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOCLOSE'>ext_gr1_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOCLOSE_2">(handle(DataHandle),Status)<a name='1294'>
                    ENDIF<a name='1295'>
#endif<a name='1296'>
#ifdef GRIB2<a name='1297'>
                 CASE ( IO_GRIB2 )<a name='1298'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_INQUIRE_FILENAME'>ext_gr2_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_INQUIRE_FILENAME_2">( handle(DataHandle), fname, fstat, Status )<a name='1299'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1300'>
                      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOCLOSE'>ext_gr2_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOCLOSE_2">(handle(DataHandle),Status)<a name='1301'>
                    ENDIF<a name='1302'>
#endif<a name='1303'>
                    CASE DEFAULT<a name='1304'>
                      Status = 0<a name='1305'>
                  END SELECT<a name='1306'>
                  ENDIF<a name='1307'>
<a name='1308'>
<font color=#447700>! If desired, outputs a ready flag after quilting subroutine closes the data handle for history (wrfout) file.<a name='1309'></font>
<a name='1310'>
                  IF (fname(1:6) .EQ. 'wrfout' .AND. config_flags%output_ready_flag ) THEN<a name='1311'>
                    OPEN (unit=99,file='wrfoutReady' // fname(7:30), status='unknown', access='sequential')<a name='1312'>
                    CLOSE (99)<a name='1313'>
                  ENDIF<a name='1314'>
<a name='1315'>
<font color=#447700>! The I/O server "root" handles the "open_for_write_begin" request.<a name='1316'></font>
                CASE ( int_open_for_write_begin )<a name='1317'>
<a name='1318'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_OFWB_HEADER'>int_get_ofwb_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_OFWB_HEADER_1">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1319'>
                                            FileName,SysDepInfo,io_form_arg,DataHandle )<a name='1320'>
<a name='1321'>
<font color=#447700>!write(0,*)' int_open_for_write_begin itypesize ',itypesize,' itypesize ',itypesize<a name='1322'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin icurs ', icurs, hdrbufsize<a name='1323'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin FileName ',TRIM(FileName) , ' DataHandle ', DataHandle<a name='1324'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin SysDepInfo ',TRIM(SysDepInfo) <a name='1325'></font>
                  icurs = icurs + hdrbufsize<a name='1326'>
<font color=#447700>!write(0,*)' int_open_for_write_begin new icurs,tag,size ', icurs, get_hdr_tag( bigbuf(icurs/itypesize) ),get_hdr_rec_size( bigbuf(icurs/itypesize) )<a name='1327'></font>
                <a name='1328'>
                  io_form(DataHandle) = io_form_arg<a name='1329'>
<font color=#447700>!write(0,*)'io_form(DataHandle) ',io_form(DataHandle)<a name='1330'></font>
<a name='1331'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1332'>
#ifdef NETCDF<a name='1333'>
                    CASE ( IO_NETCDF   )<a name='1334'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_OPEN_FOR_WRITE_BEGIN'>ext_ncd_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_OPEN_FOR_WRITE_BEGIN_3">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1335'>
<font color=#447700>!write(0,*)'ext_ncd_open_for_write_begin ',Trim(FileName),DataHandle,handle(DataHandle),Status<a name='1336'></font>
#endif<a name='1337'>
#ifdef INTIO<a name='1338'>
                    CASE ( IO_INTIO   )<a name='1339'>
                      CALL ext_int_open_for_write_begin(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1340'>
#endif<a name='1341'>
#ifdef YYY<a name='1342'>
                    CASE ( IO_YYY )<a name='1343'>
                       CALL ext_yyy_open_for_write_begin(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1344'>
#endif<a name='1345'>
#ifdef GRIB1<a name='1346'>
                    CASE ( IO_GRIB1 )<a name='1347'>
                       CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_OPEN_FOR_WRITE_BEGIN'>ext_gr1_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_OPEN_FOR_WRITE_BEGIN_2">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1348'>
#endif<a name='1349'>
#ifdef GRIB2<a name='1350'>
                    CASE ( IO_GRIB2 )<a name='1351'>
                       CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_OPEN_FOR_WRITE_BEGIN'>ext_gr2_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_OPEN_FOR_WRITE_BEGIN_2">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1352'>
#endif<a name='1353'>
                    CASE DEFAULT<a name='1354'>
                      Status = 0<a name='1355'>
                  END SELECT<a name='1356'>
                <a name='1357'>
                  okay_to_write(DataHandle) = .false.<a name='1358'>
<a name='1359'>
<font color=#447700>! The I/O server "root" handles the "open_for_write_commit" request.<a name='1360'></font>
<font color=#447700>! In this case, the "okay_to_commit" is simply set to .true. so "write_field"<a name='1361'></font>
<font color=#447700>! requests will initiate writes to disk.  Actual commit will be done after<a name='1362'></font>
<font color=#447700>! all requests in this batch have been handled.<a name='1363'></font>
                CASE ( int_open_for_write_commit )<a name='1364'>
<a name='1365'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_2">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1366'>
                                              DataHandle , code )<a name='1367'>
                  icurs = icurs + hdrbufsize<a name='1368'>
                  okay_to_commit(DataHandle) = .true.<a name='1369'>
<a name='1370'>
<font color=#447700>! The I/O server "root" handles the "write_field" (int_field) request.<a name='1371'></font>
<font color=#447700>! If okay_to_write(DataHandle) is .true. then the patch in the<a name='1372'></font>
<font color=#447700>! header (bigbuf) is written to a globally-sized internal output buffer via<a name='1373'></font>
<font color=#447700>! the call to store_patch_in_outbuf().  Note that this is where the actual<a name='1374'></font>
<font color=#447700>! "quilting" (reassembly of patches onto a full-size domain) is done.  If<a name='1375'></font>
<font color=#447700>! okay_to_write(DataHandle) is .false. then external I/O package interfaces<a name='1376'></font>
<font color=#447700>! are called to write metadata for I/O formats that support native metadata.<a name='1377'></font>
<font color=#447700>!<a name='1378'></font>
<font color=#447700>! NOTE that the I/O server "root" will only see write_field (int_field)<a name='1379'></font>
<font color=#447700>! requests AFTER an "iosync" request.<a name='1380'></font>
                CASE ( int_field )<a name='1381'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='1382'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_4"> ( bigbuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='1383'>
                                                    DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='1384'>
                                                    DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='1385'>
                                                    DomainStart , DomainEnd ,                                    &amp;<a name='1386'>
                                                    MemoryStart , MemoryEnd ,                                    &amp;<a name='1387'>
                                                    PatchStart , PatchEnd )<a name='1388'>
<font color=#447700>!write(0,*)' int_field ',TRIM(VarName),DataHandle,okay_to_write(DataHandle)<a name='1389'></font>
                  icurs = icurs + hdrbufsize<a name='1390'>
<a name='1391'>
                  IF ( okay_to_write(DataHandle) ) THEN<a name='1392'>
<a name='1393'>
<font color=#447700>!                    WRITE(0,*)'&gt;&gt;&gt; ',TRIM(DateStr), ' ', TRIM(VarName), ' ', TRIM(MemoryOrder), ' ', &amp;<a name='1394'></font>
<font color=#447700>!                        (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)*(PatchEnd(3)-PatchStart(3)+1)<a name='1395'></font>
<a name='1396'>
                    IF ( FieldType .EQ. WRF_FLOAT .OR. FieldType .EQ. WRF_DOUBLE)  THEN<a name='1397'>
                      <font color=#447700>! Note that the WRF_DOUBLE branch of this IF statement must come first since <a name='1398'></font>
                      <font color=#447700>! WRF_FLOAT is set equal to WRF_DOUBLE during autopromotion builds.  <a name='1399'></font>
                      IF ( FieldType .EQ. WRF_DOUBLE)  THEN<a name='1400'>
<font color=#447700>! this branch has not been tested TBH: 20050406<a name='1401'></font>
                        CALL mpi_type_size( MPI_DOUBLE_PRECISION, ftypesize, ierr )<a name='1402'>
                      ELSE<a name='1403'>
                        CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='1404'>
                      ENDIF<a name='1405'>
                      stored_write_record = .true.<a name='1406'>
                      CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PATCH_IN_OUTBUF'>store_patch_in_outbuf</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PATCH_IN_OUTBUF_1"> ( bigbuf(icurs/itypesize), dummybuf, TRIM(DateStr), TRIM(VarName) , &amp;<a name='1407'>
                                                   FieldType, TRIM(MemoryOrder), TRIM(Stagger), DimNames, &amp;<a name='1408'>
                                                   DomainStart , DomainEnd , &amp;<a name='1409'>
                                                   MemoryStart , MemoryEnd , &amp;<a name='1410'>
                                                   PatchStart , PatchEnd )<a name='1411'>
<a name='1412'>
                    ELSE IF ( FieldType .EQ. WRF_INTEGER ) THEN<a name='1413'>
                      CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='1414'>
                      stored_write_record = .true.<a name='1415'>
                      CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PATCH_IN_OUTBUF'>store_patch_in_outbuf</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PATCH_IN_OUTBUF_2"> ( dummybuf, bigbuf(icurs/itypesize), TRIM(DateStr), TRIM(VarName) , &amp;<a name='1416'>
                                                   FieldType, TRIM(MemoryOrder), TRIM(Stagger), DimNames, &amp;<a name='1417'>
                                                   DomainStart , DomainEnd , &amp;<a name='1418'>
                                                   MemoryStart , MemoryEnd , &amp;<a name='1419'>
                                                   PatchStart , PatchEnd )<a name='1420'>
                    ELSE IF ( FieldType .EQ. WRF_LOGICAL ) THEN<a name='1421'>
                      ftypesize = LWORDSIZE<a name='1422'>
                    ENDIF<a name='1423'>
                    icurs = icurs + (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='1424'>
                                    (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='1425'>
                  ELSE<a name='1426'>
                    SELECT CASE (use_package(io_form(DataHandle)))<a name='1427'>
#ifdef NETCDF<a name='1428'>
                      CASE ( IO_NETCDF   )<a name='1429'>
                        CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_WRITE_FIELD'>ext_ncd_write_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_WRITE_FIELD_1"> ( handle(DataHandle) , TRIM(DateStr) ,         &amp;<a name='1430'>
                                   TRIM(VarName) , dummy , FieldType , Comm , IOComm,           &amp;<a name='1431'>
                                   DomainDesc , TRIM(MemoryOrder) , TRIM(Stagger) , DimNames ,  &amp;<a name='1432'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='1433'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='1434'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='1435'>
                                   Status )<a name='1436'>
#endif<a name='1437'>
                      CASE DEFAULT<a name='1438'>
                        Status = 0<a name='1439'>
                    END SELECT<a name='1440'>
                  ENDIF<a name='1441'>
                CASE ( int_iosync )<a name='1442'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_3">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1443'>
                                            DataHandle , code )<a name='1444'>
                  icurs = icurs + hdrbufsize<a name='1445'>
                CASE DEFAULT<a name='1446'>
                  WRITE(mess,*)' quilt: int_field: bad tag: ',get_hdr_tag( bigbuf(icurs/itypesize) ),' icurs ',icurs/itypesize<a name='1447'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_271">( mess )<a name='1448'>
              END SELECT<a name='1449'>
<a name='1450'>
            ENDDO <font color=#447700>!}<a name='1451'></font>
<font color=#447700>! Now, the I/O server "root" has finshed handling all commands from the latest<a name='1452'></font>
<font color=#447700>! call to retrieve_pieces_of_field().<a name='1453'></font>
<a name='1454'>
            IF (stored_write_record) THEN<a name='1455'>
<font color=#447700>! If any fields have been stored in a globally-sized internal output buffer<a name='1456'></font>
<font color=#447700>! (via a call to store_patch_in_outbuf()) then call write_outbuf() to write<a name='1457'></font>
<font color=#447700>! them to disk now.<a name='1458'></font>
<font color=#447700>! NOTE that the I/O server "root" will only have called<a name='1459'></font>
<font color=#447700>! store_patch_in_outbuf() when handling write_field (int_field)<a name='1460'></font>
<font color=#447700>! commands which only arrive AFTER an "iosync" command.<a name='1461'></font>
<font color=#447700>!              CALL start_timing<a name='1462'></font>
              CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#WRITE_OUTBUF'>write_outbuf</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_OUTBUF_1"> ( handle(DataHandle), use_package(io_form(DataHandle))) <a name='1463'>
<font color=#447700>!              CALL end_timing( "quilt: call to write_outbuf" ) <a name='1464'></font>
            ENDIF<a name='1465'>
<a name='1466'>
<font color=#447700>! If one or more "open_for_write_commit" commands were encountered from the<a name='1467'></font>
<font color=#447700>! latest call to retrieve_pieces_of_field() then call the package-specific<a name='1468'></font>
<font color=#447700>! routine to do the commit.<a name='1469'></font>
            IF (okay_to_commit(DataHandle)) THEN<a name='1470'>
<a name='1471'>
              SELECT CASE (use_package(io_form(DataHandle)))<a name='1472'>
#ifdef NETCDF<a name='1473'>
                CASE ( IO_NETCDF   )<a name='1474'>
                  CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_INQUIRE_FILENAME'>ext_ncd_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_INQUIRE_FILENAME_3">( handle(DataHandle), fname, fstat, Status )<a name='1475'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1476'>
                    CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_OPEN_FOR_WRITE_COMMIT'>ext_ncd_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_OPEN_FOR_WRITE_COMMIT_2">(handle(DataHandle),Status)<a name='1477'>
                    okay_to_write(DataHandle) = .true.<a name='1478'>
                  ENDIF<a name='1479'>
#endif<a name='1480'>
#ifdef INTIO<a name='1481'>
                CASE ( IO_INTIO   )<a name='1482'>
                  CALL ext_int_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1483'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1484'>
                    CALL ext_int_open_for_write_commit(handle(DataHandle),Status)<a name='1485'>
                    okay_to_write(DataHandle) = .true.<a name='1486'>
                  ENDIF<a name='1487'>
#endif<a name='1488'>
#ifdef YYY<a name='1489'>
                 CASE ( IO_YYY )<a name='1490'>
                    CALL ext_yyy_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1491'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1492'>
                       CALL ext_yyy_open_for_write_commit(handle(DataHandle),Status)<a name='1493'>
                       okay_to_write(DataHandle) = .true.<a name='1494'>
                    ENDIF<a name='1495'>
#endif<a name='1496'>
#ifdef GRIB1<a name='1497'>
                 CASE ( IO_GRIB1 )<a name='1498'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_INQUIRE_FILENAME'>ext_gr1_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_INQUIRE_FILENAME_3">( handle(DataHandle), fname, fstat, Status )<a name='1499'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1500'>
                       CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_OPEN_FOR_WRITE_COMMIT'>ext_gr1_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_OPEN_FOR_WRITE_COMMIT_2">(handle(DataHandle),Status)<a name='1501'>
                       okay_to_write(DataHandle) = .true.<a name='1502'>
                    ENDIF<a name='1503'>
#endif<a name='1504'>
#ifdef GRIB2<a name='1505'>
                 CASE ( IO_GRIB2 )<a name='1506'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_INQUIRE_FILENAME'>ext_gr2_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_INQUIRE_FILENAME_3">( handle(DataHandle), fname, fstat, Status )<a name='1507'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1508'>
                       CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_OPEN_FOR_WRITE_COMMIT'>ext_gr2_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_OPEN_FOR_WRITE_COMMIT_2">(handle(DataHandle),Status)<a name='1509'>
                       okay_to_write(DataHandle) = .true.<a name='1510'>
                    ENDIF<a name='1511'>
#endif<a name='1512'>
<a name='1513'>
                CASE DEFAULT<a name='1514'>
                  Status = 0<a name='1515'>
              END SELECT<a name='1516'>
<a name='1517'>
            okay_to_commit(DataHandle) = .false.<a name='1518'>
          ENDIF<a name='1519'>
          DEALLOCATE( bigbuf )<a name='1520'>
        ENDIF<a name='1521'>
#endif<a name='1522'>
        if(allocated(bigbuf)) deallocate(bigbuf)<a name='1523'>
<font color=#447700>! Retrieve header and all patches for the next field from the internal <a name='1524'></font>
<font color=#447700>! buffers.  <a name='1525'></font>
        CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#RETRIEVE_PIECES_OF_FIELD'>retrieve_pieces_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_PIECES_OF_FIELD_2"> ( obuf , VarName, obufsize, sz, retval )<a name='1526'>
<font color=#447700>! Sum sizes of all headers and patches (data) for this field from all I/O <a name='1527'></font>
<font color=#447700>! servers in this I/O server group onto the I/O server "root".<a name='1528'></font>
        CALL mpi_x_reduce( sz, bigbufsize, 1, MPI_INTEGER,MPI_SUM, ntasks_local_group-1,mpi_comm_local, ierr )<a name='1529'>
<font color=#447700>! Then, return to the top of the loop to collect headers and data from all <a name='1530'></font>
<font color=#447700>! I/O servers in this I/O server group onto the I/O server "root" and handle <a name='1531'></font>
<font color=#447700>! the next batch of commands.  <a name='1532'></font>
      END DO <font color=#447700>!}<a name='1533'></font>
<a name='1534'>
      DEALLOCATE( obuf )<a name='1535'>
<a name='1536'>
      <font color=#447700>! flush output files if needed<a name='1537'></font>
      IF (stored_write_record) THEN<a name='1538'>
<font color=#447700>!         CALL start_timing()<a name='1539'></font>
        SELECT CASE ( use_package(io_form) )<a name='1540'>
#ifdef NETCDF<a name='1541'>
          CASE ( IO_NETCDF   )<a name='1542'>
            CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOSYNC'>ext_ncd_iosync</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOSYNC_2">( handle(DataHandle), Status )<a name='1543'>
#endif<a name='1544'>
#ifdef XXX<a name='1545'>
          CASE ( IO_XXX   )<a name='1546'>
            CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOSYNC'>ext_xxx_iosync</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOSYNC_2">( handle(DataHandle), Status )<a name='1547'>
#endif<a name='1548'>
#ifdef YYY<a name='1549'>
          CASE ( IO_YYY   )<a name='1550'>
            CALL ext_yyy_iosync( handle(DataHandle), Status )<a name='1551'>
#endif<a name='1552'>
#ifdef ZZZ<a name='1553'>
          CASE ( IO_ZZZ   )<a name='1554'>
            CALL ext_zzz_iosync( handle(DataHandle), Status )<a name='1555'>
#endif<a name='1556'>
#ifdef GRIB1<a name='1557'>
          CASE ( IO_GRIB1   )<a name='1558'>
            CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOSYNC'>ext_gr1_iosync</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOSYNC_2">( handle(DataHandle), Status )<a name='1559'>
#endif<a name='1560'>
#ifdef GRIB2<a name='1561'>
          CASE ( IO_GRIB2   )<a name='1562'>
            CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOSYNC'>ext_gr2_iosync</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOSYNC_2">( handle(DataHandle), Status )<a name='1563'>
#endif<a name='1564'>
#ifdef INTIO<a name='1565'>
          CASE ( IO_INTIO   )<a name='1566'>
            CALL ext_int_iosync( handle(DataHandle), Status )<a name='1567'>
#endif<a name='1568'>
          CASE DEFAULT<a name='1569'>
            Status = 0<a name='1570'>
        END SELECT<a name='1571'>
<font color=#447700>!CALL end_timing( "quilt: flush" )<a name='1572'></font>
      ENDIF<a name='1573'>
<a name='1574'>
      END DO <font color=#447700>! }<a name='1575'></font>
<a name='1576'>
    END SUBROUTINE quilt<a name='1577'>
<a name='1578'>
<A NAME='QUILT_PNC'><A href='../../html_code/frame/module_io_quilt_new.F.html#QUILT_PNC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1579'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>quilt_pnc</font> <A href='../../call_to/QUILT_PNC.html' TARGET='index'>2</A>,<A href='../../call_from/QUILT_PNC.html' TARGET='index'>167</A><a name='1580'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1581'></font>
<font color=#447700>! Same as quilt() routine except that _all_ of the IO servers that call it<a name='1582'></font>
<font color=#447700>! actually write data to disk using pNetCDF. This version is only used when <a name='1583'></font>
<font color=#447700>! the  code is compiled with PNETCDF_QUILT defined.<a name='1584'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1585'></font>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_91"><a name='1586'>
      USE <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#MODULE_QUILT_OUTBUF_OPS'>module_quilt_outbuf_ops</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_QUILT_OUTBUF_OPS_2"><a name='1587'>
      IMPLICIT NONE<a name='1588'>
      INCLUDE 'mpif.h'<a name='1589'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_3"><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1590'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_4"><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1591'>
      INTEGER itag, ninbuf, ntasks_io_group, ntasks_local_group, mytask_local, ierr<a name='1592'>
      INTEGER istat<a name='1593'>
      INTEGER mytask_io_group<a name='1594'>
      INTEGER   :: nout_set = 0<a name='1595'>
      INTEGER   :: obufsize, bigbufsize, chunksize, sz<a name='1596'>
      REAL,                 DIMENSION(1) :: dummy<a name='1597'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: obuf, bigbuf<a name='1598'>
      REAL,    ALLOCATABLE, DIMENSION(:) :: RDATA<a name='1599'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: IDATA<a name='1600'>
      CHARACTER (LEN=512) :: CDATA<a name='1601'>
      CHARACTER (LEN=80) :: fname<a name='1602'>
      INTEGER icurs, hdrbufsize, itypesize, ftypesize, rtypesize, Status, fstat, io_form_arg<a name='1603'>
      INTEGER :: DataHandle, FieldType, Comm, IOComm, DomainDesc, code, Count<a name='1604'>
      INTEGER, DIMENSION(3) :: DomainStart , DomainEnd , MemoryStart , MemoryEnd , PatchStart , PatchEnd<a name='1605'>
      INTEGER :: dummybuf(1)<a name='1606'>
      INTEGER :: num_noops, num_commit_messages, num_field_training_msgs, hdr_tag<a name='1607'>
      CHARACTER (len=256) :: DateStr , Element, VarName, MemoryOrder , Stagger , DimNames(3), FileName, SysDepInfo, mess<a name='1608'>
      INTEGER, EXTERNAL :: use_package<a name='1609'>
      LOGICAL           :: stored_write_record, retval, written_record<a name='1610'>
      INTEGER iii, jjj, vid<a name='1611'>
<a name='1612'>
<font color=#447700>!      logical okay_to_w<a name='1613'></font>
<font color=#447700>!      character*120 sysline<a name='1614'></font>
<a name='1615'>
<font color=#447700>! Call ext_pkg_ioinit() routines to initialize I/O packages.  <a name='1616'></font>
      SysDepInfo = " "<a name='1617'>
#ifdef NETCDF<a name='1618'>
      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOINIT'>ext_ncd_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOINIT_3">( SysDepInfo, ierr)<a name='1619'>
#endif<a name='1620'>
#ifdef PNETCDF_QUILT<a name='1621'>
      CALL ext_pnc_ioinit( SysDepInfo, ierr)<a name='1622'>
#endif<a name='1623'>
#ifdef INTIO<a name='1624'>
      CALL ext_int_ioinit( SysDepInfo, ierr )<a name='1625'>
#endif<a name='1626'>
#ifdef XXX<a name='1627'>
      CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOINIT'>ext_xxx_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOINIT_3">( SysDepInfo, ierr)<a name='1628'>
#endif<a name='1629'>
#ifdef YYY<a name='1630'>
      CALL ext_yyy_ioinit( SysDepInfo, ierr)<a name='1631'>
#endif<a name='1632'>
#ifdef ZZZ<a name='1633'>
      CALL ext_zzz_ioinit( SysDepInfo, ierr)<a name='1634'>
#endif<a name='1635'>
#ifdef GRIB1<a name='1636'>
      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOINIT'>ext_gr1_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOINIT_3">( SysDepInfo, ierr)<a name='1637'>
#endif<a name='1638'>
#ifdef GRIB2<a name='1639'>
      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOINIT'>ext_gr2_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOINIT_3">( SysDepInfo, ierr)<a name='1640'>
#endif<a name='1641'>
<a name='1642'>
      okay_to_commit = .false.<a name='1643'>
      stored_write_record = .false.<a name='1644'>
      ninbuf = 0<a name='1645'>
      <font color=#447700>! get info. about the I/O server group that this I/O server task<a name='1646'></font>
      <font color=#447700>! belongs to<a name='1647'></font>
      CALL mpi_x_comm_size( mpi_comm_io_groups(1,1), ntasks_io_group,    ierr )<a name='1648'>
      CALL MPI_COMM_RANK( mpi_comm_io_groups(1,1), mytask_io_group,    ierr )<a name='1649'>
      CALL mpi_x_comm_size( mpi_comm_local,        ntasks_local_group, ierr )<a name='1650'>
      CALL MPI_COMM_RANK( mpi_comm_local,        mytask_local,       ierr )<a name='1651'>
<a name='1652'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='1653'>
      IF ( itypesize &lt;= 0 ) THEN<a name='1654'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_272">("external/RSL/module_dm.F: quilt: type size &lt;= 0 invalid")<a name='1655'>
      ENDIF<a name='1656'>
<a name='1657'>
<font color=#447700>! Work out whether this i/o server processor has one fewer associated compute proc than<a name='1658'></font>
<font color=#447700>! the most any processor has. Can happen when number of i/o tasks does not evenly divide<a name='1659'></font>
<font color=#447700>! the number of compute tasks. This is needed to keep the i/o tasks sychronized on the<a name='1660'></font>
<font color=#447700>! same message when they start commmunicating to stitch together an output.<a name='1661'></font>
<font color=#447700>!<a name='1662'></font>
<a name='1663'>
<font color=#447700>! infinite loop until shutdown message received<a name='1664'></font>
<font color=#447700>! This is the main request-handling loop.  I/O quilt servers stay in this loop <a name='1665'></font>
<font color=#447700>! until the model run ends.  <a name='1666'></font>
<font color=#447700>!okay_to_w = .false.<a name='1667'></font>
      DO WHILE (.TRUE.)  <font color=#447700>! {<a name='1668'></font>
<a name='1669'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1670'></font>
<font color=#447700>! Each I/O server receives requests from its compute tasks.  Each request<a name='1671'></font>
<font color=#447700>! is contained in a data header (see module_internal_header_util.F for<a name='1672'></font>
<font color=#447700>! detailed descriptions of data headers).<a name='1673'></font>
<font color=#447700>! Each request is sent in two phases.  First, sizes of all messages that <a name='1674'></font>
<font color=#447700>! will be sent from the compute tasks to this I/O server are summed on the <a name='1675'></font>
<font color=#447700>! I/O server via MPI_reduce().  The I/O server then allocates buffer "obuf" <a name='1676'></font>
<font color=#447700>! and receives concatenated messages from the compute tasks in it via the <a name='1677'></font>
<font color=#447700>! call to collect_on_comm().  Note that "sizes" are generally expressed in <a name='1678'></font>
<font color=#447700>! *bytes* in this code so conversion to "count" (number of Fortran words) is <a name='1679'></font>
<font color=#447700>! required for Fortran indexing and MPI calls.  <a name='1680'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1681'></font>
        <font color=#447700>! wait for info from compute tasks in the I/O group that we're ready to rock<a name='1682'></font>
        <font color=#447700>! obufsize will contain number of *bytes*<a name='1683'></font>
<font color=#447700>!CALL start_timing<a name='1684'></font>
        <font color=#447700>! first element of reduced is obufsize, second is DataHandle <a name='1685'></font>
        <font color=#447700>! if needed (currently needed only for ioclose).<a name='1686'></font>
        reduced_dummy = 0<a name='1687'>
        CALL mpi_x_reduce( reduced_dummy, reduced, 2, MPI_INTEGER, MPI_SUM, mytask_io_group, mpi_comm_io_groups(1,1), ierr )<a name='1688'>
        obufsize = reduced(1)<a name='1689'>
<font color=#447700>!CALL end_timing("MPI_Reduce at top of forever loop") <a name='1690'></font>
<font color=#447700>!JMDEBUGwrite(0,*)'obufsize = ',obufsize<a name='1691'></font>
<font color=#447700>! Negative obufsize will trigger I/O server exit.  <a name='1692'></font>
        IF ( obufsize .LT. 0 ) THEN<a name='1693'>
          IF ( obufsize .EQ. -100 ) THEN         <font color=#447700>! magic number<a name='1694'></font>
#ifdef NETCDF<a name='1695'>
            CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOEXIT'>ext_ncd_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOEXIT_3">( Status )<a name='1696'>
#endif<a name='1697'>
#ifdef PNETCDF_QUILT<a name='1698'>
            CALL ext_pnc_ioexit( Status )<a name='1699'>
#endif<a name='1700'>
#ifdef INTIO<a name='1701'>
            CALL ext_int_ioexit( Status )<a name='1702'>
#endif<a name='1703'>
#ifdef XXX<a name='1704'>
            CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOEXIT'>ext_xxx_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOEXIT_3">( Status )<a name='1705'>
#endif<a name='1706'>
#ifdef YYY<a name='1707'>
            CALL ext_yyy_ioexit( Status )<a name='1708'>
#endif<a name='1709'>
#ifdef ZZZ<a name='1710'>
            CALL ext_zzz_ioexit( Status )<a name='1711'>
#endif<a name='1712'>
#ifdef GRIB1<a name='1713'>
            CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOEXIT'>ext_gr1_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOEXIT_3">( Status )<a name='1714'>
#endif<a name='1715'>
#ifdef GRIB2<a name='1716'>
            CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOEXIT'>ext_gr2_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOEXIT_3">( Status )<a name='1717'>
#endif<a name='1718'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_343"> ( 'I/O QUILT SERVERS DONE' )<a name='1719'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='1720'></font>
            IF (coupler_on) THEN<a name='1721'>
               CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_FINALIZE'>cpl_finalize</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_FINALIZE_2">()<a name='1722'>
            ELSE<a name='1723'>
#endif<a name='1724'>
               CALL mpi_finalize(ierr)<a name='1725'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='1726'></font>
            END IF<a name='1727'>
#endif<a name='1728'>
            STOP<a name='1729'>
          ELSE<a name='1730'>
            WRITE(mess,*)'Possible 32-bit overflow on output server. Try larger nio_tasks_per_group in namelist.'<a name='1731'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_273">(mess)<a name='1732'>
          ENDIF<a name='1733'>
        ENDIF<a name='1734'>
<a name='1735'>
<font color=#447700>!        CALL start_timing<a name='1736'></font>
<font color=#447700>! Obufsize of zero signals a close<a name='1737'></font>
<a name='1738'>
<font color=#447700>! Allocate buffer obuf to be big enough for the data the compute tasks<a name='1739'></font>
<font color=#447700>! will send.  Note: obuf is size in *bytes* so we need to pare this <a name='1740'></font>
<font color=#447700>! down, since the buffer is INTEGER.  <a name='1741'></font>
        IF ( obufsize .GT. 0 ) THEN<a name='1742'>
          ALLOCATE( obuf( (obufsize+1)/itypesize ) )<a name='1743'>
<a name='1744'>
<font color=#447700>! let's roll; get the data from the compute procs and put in obuf<a name='1745'></font>
          CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_2">(__FILE__,__LINE__, mpi_comm_io_groups(1,1),        &amp;<a name='1746'>
                                onebyte,                      &amp;<a name='1747'>
                                dummy, 0,                     &amp;<a name='1748'>
                                obuf, obufsize )<a name='1749'>
<font color=#447700>!          CALL end_timing( "quilt on server: collecting data from compute procs" )<a name='1750'></font>
        ELSE<a name='1751'>
          <font color=#447700>! Necessarily, the compute processes send the ioclose signal,<a name='1752'></font>
          <font color=#447700>! if there is one, after the iosync, which means they <a name='1753'></font>
          <font color=#447700>! will stall on the ioclose message waiting for the quilt <a name='1754'></font>
          <font color=#447700>! processes if we handle the way other messages are collected,<a name='1755'></font>
          <font color=#447700>! using collect_on_comm.  This avoids this, but we need<a name='1756'></font>
          <font color=#447700>! a special signal (obufsize zero) and the DataHandle<a name='1757'></font>
          <font color=#447700>! to be closed. That handle is send as the second<a name='1758'></font>
          <font color=#447700>! word of the io_close message received by the MPI_Reduce above.<a name='1759'></font>
          <font color=#447700>! Then a header representing the ioclose message is constructed<a name='1760'></font>
          <font color=#447700>! here and handled below as if it were received from the <a name='1761'></font>
          <font color=#447700>! compute processes. The clients (compute processes) must be<a name='1762'></font>
          <font color=#447700>! careful to send this correctly (one compule process sends the actual<a name='1763'></font>
          <font color=#447700>! handle and everone else sends a zero, so the result sums to <a name='1764'></font>
          <font color=#447700>! the value of the handle).<a name='1765'></font>
          <font color=#447700>!<a name='1766'></font>
          ALLOCATE( obuf( 4096 ) )<a name='1767'>
          <font color=#447700>! DataHandle is provided as second element of reduced<a name='1768'></font>
          CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_2">( obuf, obufsize, itypesize, &amp;<a name='1769'>
                                      reduced(2) , int_ioclose )<a name='1770'>
        ENDIF<a name='1771'>
<a name='1772'>
<font color=#447700>!write(0,*)'calling init_store_piece_of_field'<a name='1773'></font>
<font color=#447700>! Now all messages received from the compute clients are stored in <a name='1774'></font>
<font color=#447700>! obuf.  Scan through obuf and extract headers and field data and store in <a name='1775'></font>
<font color=#447700>! internal buffers.  The scan is done twice, first to determine sizes of <a name='1776'></font>
<font color=#447700>! internal buffers required for storage of headers and fields and second to <a name='1777'></font>
<font color=#447700>! actually store the headers and fields.  This bit of code does not do any <a name='1778'></font>
<font color=#447700>! "quilting" (assembly of patches into full domains).  For each field, it <a name='1779'></font>
<font color=#447700>! simply writes all received patches for the field to disk.<a name='1780'></font>
<font color=#447700>! ARPDBG we can vastly reduce the number of writes to disk by stitching<a name='1781'></font>
<font color=#447700>! any contiguous patches together first. Has implications for synchronisation<a name='1782'></font>
<font color=#447700>! of pNetCDF calls though.<a name='1783'></font>
        CALL init_store_piece_of_field<a name='1784'>
        CALL mpi_type_size ( MPI_INTEGER , itypesize , ierr )<a name='1785'>
<font color=#447700>!write(0,*)'mpi_type_size returns ', itypesize<a name='1786'></font>
<font color=#447700>! Scan obuf the first time to calculate the size of the buffer required for <a name='1787'></font>
<font color=#447700>! each field.  Calls to add_to_bufsize_for_field() accumulate sizes.  <a name='1788'></font>
        vid = 0<a name='1789'>
        icurs = itypesize<a name='1790'>
        num_noops = 0 <a name='1791'>
        num_commit_messages = 0 <a name='1792'>
        num_field_training_msgs = 0 <a name='1793'>
        DO WHILE ( icurs .lt. obufsize ) <font color=#447700>! {<a name='1794'></font>
          hdr_tag = <A href='../../html_code/frame/module_internal_header_util.F.html#GET_HDR_TAG'>get_hdr_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HDR_TAG_3">( obuf ( icurs / itypesize ) )<a name='1795'>
          SELECT CASE ( hdr_tag )<a name='1796'>
            CASE ( int_field )<a name='1797'>
              CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_5"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='1798'>
                                                DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='1799'>
                                                DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='1800'>
                                                DomainStart , DomainEnd ,                                    &amp;<a name='1801'>
                                                MemoryStart , MemoryEnd ,                                    &amp;<a name='1802'>
                                                PatchStart , PatchEnd )<a name='1803'>
              chunksize = (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='1804'>
                          (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='1805'>
<a name='1806'>
              IF ( DomainDesc .EQ. 333933 ) THEN  <font color=#447700>! Training write, only one per group of tasks<a name='1807'></font>
                 IF ( num_field_training_msgs .EQ. 0 ) THEN<a name='1808'>
                   call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_6">( VarName, hdrbufsize )<a name='1809'>
<font color=#447700>!write(0,*) 'X-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1810'></font>
                 ENDIF<a name='1811'>
                 num_field_training_msgs = num_field_training_msgs + 1<a name='1812'>
              ELSE<a name='1813'>
                 call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_7">( VarName, hdrbufsize )<a name='1814'>
<font color=#447700>!write(0,*) 'X-2a', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1815'></font>
              ENDIF<a name='1816'>
              icurs = icurs + hdrbufsize<a name='1817'>
<a name='1818'>
<font color=#447700>!write(0,*) 'X-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1819'></font>
<a name='1820'>
              <font color=#447700>! If this is a real write (i.e. not a training write), accumulate<a name='1821'></font>
              <font color=#447700>! buffersize for this field.<a name='1822'></font>
              IF ( DomainDesc .NE. 333933 ) THEN   <font color=#447700>! magic number<a name='1823'></font>
<font color=#447700>!write(0,*) 'X-1a', chunksize, TRIM(VarName)<a name='1824'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_8">( VarName, chunksize )<a name='1825'>
                icurs = icurs + chunksize<a name='1826'>
              ENDIF<a name='1827'>
            CASE ( int_open_for_write_commit )  <font color=#447700>! only one per group of tasks<a name='1828'></font>
              hdrbufsize = obuf(icurs/itypesize)<a name='1829'>
              IF (num_commit_messages.EQ.0) THEN<a name='1830'>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_9">( 'COMMIT', hdrbufsize )<a name='1831'>
              ENDIF<a name='1832'>
              num_commit_messages = num_commit_messages + 1<a name='1833'>
              icurs = icurs + hdrbufsize<a name='1834'>
            CASE DEFAULT<a name='1835'>
              hdrbufsize = obuf(icurs/itypesize)<a name='1836'>
<a name='1837'>
<font color=#447700>! This logic and the logic in the loop below is used to determine whether<a name='1838'></font>
<font color=#447700>! to send a noop records sent by the compute processes to allow to go<a name='1839'></font>
<font color=#447700>! through. The purpose is to make sure that the communications between this<a name='1840'></font>
<font color=#447700>! server and the other servers in this quilt group stay synchronized in<a name='1841'></font>
<font color=#447700>! the collection loop below, even when the servers are serving different<a name='1842'></font>
<font color=#447700>! numbers of clients. Here are some conditions:<a name='1843'></font>
<font color=#447700>! <a name='1844'></font>
<font color=#447700>!   1. The number of compute clients served will not differ by more than 1<a name='1845'></font>
<font color=#447700>!   2. The servers with +1 number of compute clients begin with task 0<a name='1846'></font>
<font color=#447700>!      of mpi_comm_local, the commicator shared by this group of servers<a name='1847'></font>
<font color=#447700>! <a name='1848'></font>
<font color=#447700>!   3. For each collective field or metadata output from the compute tasks,<a name='1849'></font>
<font color=#447700>!      there will be one record sent to the associated i/o server task. The<a name='1850'></font>
<font color=#447700>!      i/o server task collects these records and stores them contiguously<a name='1851'></font>
<font color=#447700>!      in a buffer (obuf) using collect_on_comm above.  Thus, obuf on this<a name='1852'></font>
<font color=#447700>!      server task will contain one record from each associated compute<a name='1853'></font>
<font color=#447700>!      task, in order.<a name='1854'></font>
<font color=#447700>! ! <a name='1855'></font>
<font color=#447700>!   4. In the case of replicated output from the compute tasks<a name='1856'></font>
<font color=#447700>!      (e.g. put_dom_ti records and control records like<a name='1857'></font>
<font color=#447700>!      open_for_write_commit type records), only compute tasks for which <a name='1858'></font>
<font color=#447700>!      (compute_group_master == .TRUE) send the record. The other compute <a name='1859'></font>
<font color=#447700>!      tasks send noop records. This is done so that each server task <a name='1860'></font>
<font color=#447700>!      receives exactly one record plus noops from the other compute tasks. <a name='1861'></font>
<font color=#447700>! <a name='1862'></font>
<font color=#447700>!   5. Logic below does not allow any noop records through since each IO <a name='1863'></font>
<font color=#447700>!      server task now receives a valid record (from the 'compute-group master'<a name='1864'></font>
<font color=#447700>!      when doing replicated output<a name='1865'></font>
              IF (hdr_tag.NE.int_noop) THEN<a name='1866'>
                write(VarName,'(I5.5)')vid <a name='1867'>
<font color=#447700>!write(0,*) 'X-2', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1868'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_10">( VarName, hdrbufsize )<a name='1869'>
                vid = vid+1<a name='1870'>
              ENDIF<a name='1871'>
              IF ( hdr_tag .EQ. int_noop ) num_noops = num_noops + 1<a name='1872'>
              icurs = icurs + hdrbufsize<a name='1873'>
<a name='1874'>
          END SELECT<a name='1875'>
        ENDDO <font color=#447700>! }<a name='1876'></font>
<font color=#447700>! Store the headers and field data in internal buffers.  The first call to <a name='1877'></font>
<font color=#447700>! store_piece_of_field() allocates internal buffers using sizes computed by <a name='1878'></font>
<font color=#447700>! calls to add_to_bufsize_for_field().  <a name='1879'></font>
        vid = 0<a name='1880'>
        icurs = itypesize<a name='1881'>
        num_noops = 0 <a name='1882'>
        num_commit_messages = 0 <a name='1883'>
        num_field_training_msgs = 0 <a name='1884'>
        DO WHILE ( icurs .lt. obufsize ) <font color=#447700>!{<a name='1885'></font>
<font color=#447700>!write(0,*) 'A icurs ', icurs, ' obufsize ', obufsize<a name='1886'></font>
          hdr_tag = <A href='../../html_code/frame/module_internal_header_util.F.html#GET_HDR_TAG'>get_hdr_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HDR_TAG_4">( obuf ( icurs / itypesize ) )<a name='1887'>
          SELECT CASE ( hdr_tag )<a name='1888'>
            CASE ( int_field )<a name='1889'>
              CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_6"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='1890'>
                                                DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='1891'>
                                                DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='1892'>
                                                DomainStart , DomainEnd ,                                    &amp;<a name='1893'>
                                                MemoryStart , MemoryEnd ,                                    &amp;<a name='1894'>
                                                PatchStart , PatchEnd )<a name='1895'>
              chunksize = (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='1896'>
                          (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='1897'>
<a name='1898'>
              IF ( DomainDesc .EQ. 333933 ) THEN  <font color=#447700>! Training write, only one per group of tasks<a name='1899'></font>
                 IF ( num_field_training_msgs .EQ. 0 ) THEN<a name='1900'>
                   call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_6">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='1901'>
<font color=#447700>!write(0,*) 'A-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1902'></font>
                 ENDIF<a name='1903'>
                 num_field_training_msgs = num_field_training_msgs + 1<a name='1904'>
              ELSE<a name='1905'>
                 call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_7">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='1906'>
<font color=#447700>!write(0,*) 'A-2a', icurs, hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1907'></font>
              ENDIF<a name='1908'>
              icurs = icurs + hdrbufsize<a name='1909'>
              <font color=#447700>! If this is a real write (i.e. not a training write), store<a name='1910'></font>
              <font color=#447700>! this piece of this field.<a name='1911'></font>
              IF ( DomainDesc .NE. 333933 ) THEN   <font color=#447700>! magic number<a name='1912'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_8">( obuf(icurs/itypesize), VarName, chunksize )<a name='1913'>
                icurs = icurs + chunksize<a name='1914'>
<font color=#447700>!write(0,*) 'A-1a',TRIM(VarName),' icurs ',icurs,PatchStart(1:3),PatchEnd(1:3)<a name='1915'></font>
              ENDIF<a name='1916'>
            CASE ( int_open_for_write_commit )  <font color=#447700>! only one per group of tasks<a name='1917'></font>
              hdrbufsize = obuf(icurs/itypesize)<a name='1918'>
              IF (num_commit_messages.EQ.0) THEN<a name='1919'>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_9">( obuf(icurs/itypesize), 'COMMIT', hdrbufsize )<a name='1920'>
              ENDIF<a name='1921'>
              num_commit_messages = num_commit_messages + 1<a name='1922'>
              icurs = icurs + hdrbufsize<a name='1923'>
            CASE DEFAULT<a name='1924'>
              hdrbufsize = obuf(icurs/itypesize)<a name='1925'>
              IF (hdr_tag.NE.int_noop) THEN<a name='1926'>
<a name='1927'>
                write(VarName,'(I5.5)')vid <a name='1928'>
<font color=#447700>!write(0,*) 'A-2b', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1929'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_10">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='1930'>
                vid = vid+1<a name='1931'>
              ENDIF<a name='1932'>
              IF ( hdr_tag .EQ. int_noop ) num_noops = num_noops + 1<a name='1933'>
              icurs = icurs + hdrbufsize<a name='1934'>
          END SELECT<a name='1935'>
       ENDDO <font color=#447700>!} while(icurs &lt; obufsize)<a name='1936'></font>
<a name='1937'>
<font color=#447700>! Now, for each field, retrieve headers and patches (data) from the internal <a name='1938'></font>
<font color=#447700>! buffers<a name='1939'></font>
       CALL init_retrieve_pieces_of_field<a name='1940'>
<font color=#447700>! Retrieve header and all patches for the first field from the internal <a name='1941'></font>
<font color=#447700>! buffers.  <a name='1942'></font>
       CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#RETRIEVE_PIECES_OF_FIELD'>retrieve_pieces_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_PIECES_OF_FIELD_3"> ( obuf , VarName, obufsize, sz, retval )<a name='1943'>
       written_record = .false.<a name='1944'>
<a name='1945'>
<font color=#447700>! Loop until there are no more fields to retrieve from the internal buffers.<a name='1946'></font>
       DO WHILE ( retval ) <font color=#447700>!{<a name='1947'></font>
<a name='1948'>
<font color=#447700>! This I/O server now handles the collected requests from the compute <a name='1949'></font>
<font color=#447700>! tasks it serves<a name='1950'></font>
<a name='1951'>
            icurs = itypesize  <font color=#447700>! icurs is a byte counter, but buffer is integer<a name='1952'></font>
<a name='1953'>
            stored_write_record = .false.<a name='1954'>
<a name='1955'>
<font color=#447700>! ALL I/O servers in this group loop over the collected requests they have<a name='1956'></font>
<font color=#447700>! received.<a name='1957'></font>
            DO WHILE ( icurs .lt. sz)<font color=#447700>! bigbufsize ) !{<a name='1958'></font>
<a name='1959'>
<font color=#447700>! The I/O server gets the request out of the next header and<a name='1960'></font>
<font color=#447700>! handles it by, in most cases, calling the appropriate external I/O package<a name='1961'></font>
<font color=#447700>! interface.<a name='1962'></font>
              SELECT CASE ( get_hdr_tag( obuf(icurs/itypesize) ) )<a name='1963'>
<font color=#447700>! The I/O server handles the "noop" (do nothing) request.  This is <a name='1964'></font>
<font color=#447700>! actually quite easy.  "Noop" requests exist to help avoid race conditions.  <a name='1965'></font>
                CASE ( int_noop )<a name='1966'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_NOOP_HEADER'>int_get_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_NOOP_HEADER_2">( obuf(icurs/itypesize), &amp;<a name='1967'>
                                            hdrbufsize, itypesize )<a name='1968'>
                  icurs = icurs + hdrbufsize<a name='1969'>
<a name='1970'>
<font color=#447700>! The I/O server "root" handles the "put_dom_td_real" request.<a name='1971'></font>
                CASE ( int_dom_td_real )<a name='1972'>
                  CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='1973'>
                  ALLOCATE( RData( obuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1974'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TD_HEADER'>int_get_td_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TD_HEADER_3">( obuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1975'>
                                          DataHandle, DateStr, Element, RData, Count, code )<a name='1976'>
                  icurs = icurs + hdrbufsize<a name='1977'>
<a name='1978'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1979'>
#ifdef PNETCDF_QUILT<a name='1980'>
                    CASE (IO_PNETCDF  )<a name='1981'>
                      CALL ext_pnc_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1982'>
#endif<a name='1983'>
#ifdef NETCDF<a name='1984'>
                    CASE ( IO_NETCDF   )<a name='1985'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TD_REAL'>ext_ncd_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TD_REAL_2">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1986'>
#endif<a name='1987'>
#ifdef INTIO<a name='1988'>
                    CASE ( IO_INTIO   )<a name='1989'>
                      CALL ext_int_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1990'>
#endif<a name='1991'>
#ifdef YYY<a name='1992'>
                 CASE ( IO_YYY )<a name='1993'>
                    CALL ext_yyy_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1994'>
#endif<a name='1995'>
#ifdef GRIB1<a name='1996'>
                 CASE ( IO_GRIB1 )<a name='1997'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TD_REAL'>ext_gr1_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TD_REAL_2">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1998'>
#endif<a name='1999'>
#ifdef GRIB2<a name='2000'>
                 CASE ( IO_GRIB2 )<a name='2001'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TD_REAL'>ext_gr2_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TD_REAL_2">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='2002'>
#endif<a name='2003'>
                     CASE DEFAULT<a name='2004'>
                      Status = 0<a name='2005'>
                  END SELECT<a name='2006'>
<a name='2007'>
                  DEALLOCATE( RData )<a name='2008'>
<font color=#447700>! Every I/O server handles the "put_dom_ti_real" request.<a name='2009'></font>
                CASE ( int_dom_ti_real )<a name='2010'>
<a name='2011'>
                  CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='2012'>
                  ALLOCATE( RData( obuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='2013'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER'>int_get_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_3">( obuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='2014'>
                                          DataHandle, Element, RData, Count, code )<a name='2015'>
                  icurs = icurs + hdrbufsize<a name='2016'>
<a name='2017'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2018'>
#ifdef PNETCDF_QUILT<a name='2019'>
                    CASE (IO_PNETCDF  )<a name='2020'>
                      CALL ext_pnc_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2021'>
#endif<a name='2022'>
#ifdef NETCDF<a name='2023'>
                    CASE ( IO_NETCDF   )<a name='2024'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_REAL'>ext_ncd_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_REAL_2">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2025'>
#endif<a name='2026'>
#ifdef INTIO<a name='2027'>
                    CASE ( IO_INTIO   )<a name='2028'>
                      CALL ext_int_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2029'>
#endif<a name='2030'>
#ifdef YYY<a name='2031'>
                 CASE ( IO_YYY )<a name='2032'>
                    CALL ext_yyy_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2033'>
#endif<a name='2034'>
#ifdef GRIB1<a name='2035'>
                 CASE ( IO_GRIB1 )<a name='2036'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_REAL'>ext_gr1_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_REAL_2">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2037'>
#endif<a name='2038'>
#ifdef GRIB2<a name='2039'>
                 CASE ( IO_GRIB2 )<a name='2040'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_REAL'>ext_gr2_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_REAL_2">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2041'>
#endif<a name='2042'>
                    CASE DEFAULT<a name='2043'>
                      Status = 0<a name='2044'>
                  END SELECT<a name='2045'>
<a name='2046'>
                  DEALLOCATE( RData )<a name='2047'>
<a name='2048'>
<font color=#447700>! Every I/O server handles the "put_dom_td_integer" request.<a name='2049'></font>
                CASE ( int_dom_td_integer )<a name='2050'>
<a name='2051'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='2052'>
                  ALLOCATE( IData( obuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='2053'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TD_HEADER'>int_get_td_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TD_HEADER_4">( obuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='2054'>
                                          DataHandle, DateStr, Element, IData, Count, code )<a name='2055'>
                  icurs = icurs + hdrbufsize<a name='2056'>
<a name='2057'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2058'>
#ifdef PNETCDF_QUILT<a name='2059'>
                  CASE (IO_PNETCDF  )<a name='2060'>
                      CALL ext_pnc_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2061'>
#endif<a name='2062'>
#ifdef NETCDF<a name='2063'>
                   CASE ( IO_NETCDF   )<a name='2064'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TD_INTEGER'>ext_ncd_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TD_INTEGER_2">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2065'>
#endif<a name='2066'>
#ifdef INTIO<a name='2067'>
                   CASE ( IO_INTIO   )<a name='2068'>
                      CALL ext_int_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2069'>
#endif<a name='2070'>
#ifdef YYY<a name='2071'>
                   CASE ( IO_YYY )<a name='2072'>
                      CALL ext_yyy_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2073'>
#endif<a name='2074'>
#ifdef GRIB1<a name='2075'>
                   CASE ( IO_GRIB1 )<a name='2076'>
                      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TD_INTEGER'>ext_gr1_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TD_INTEGER_2">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2077'>
#endif<a name='2078'>
#ifdef GRIB2<a name='2079'>
                   CASE ( IO_GRIB2 )<a name='2080'>
                      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TD_INTEGER'>ext_gr2_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TD_INTEGER_2">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2081'>
#endif<a name='2082'>
                   CASE DEFAULT<a name='2083'>
                      Status = 0<a name='2084'>
                   END SELECT<a name='2085'>
<a name='2086'>
                   DEALLOCATE( IData )<a name='2087'>
<a name='2088'>
<font color=#447700>! Every I/O server handles the "put_dom_ti_integer" request.<a name='2089'></font>
                CASE ( int_dom_ti_integer )<a name='2090'>
<a name='2091'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='2092'>
                  ALLOCATE( IData( obuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='2093'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER'>int_get_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_4">( obuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='2094'>
                                          DataHandle, Element, IData, Count, code )<a name='2095'>
                  icurs = icurs + hdrbufsize<a name='2096'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2097'>
#ifdef PNETCDF_QUILT<a name='2098'>
                    CASE (IO_PNETCDF  )<a name='2099'>
                      CALL ext_pnc_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2100'>
#endif<a name='2101'>
#ifdef NETCDF<a name='2102'>
                    CASE ( IO_NETCDF   )<a name='2103'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_INTEGER'>ext_ncd_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_INTEGER_2">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2104'>
#endif<a name='2105'>
#ifdef INTIO<a name='2106'>
                    CASE ( IO_INTIO   )<a name='2107'>
                      CALL ext_int_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2108'>
#endif<a name='2109'>
#ifdef YYY<a name='2110'>
                 CASE ( IO_YYY )<a name='2111'>
                    CALL ext_yyy_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2112'>
#endif<a name='2113'>
#ifdef GRIB1<a name='2114'>
                 CASE ( IO_GRIB1 )<a name='2115'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_INTEGER'>ext_gr1_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_INTEGER_2">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2116'>
#endif<a name='2117'>
#ifdef GRIB2<a name='2118'>
                 CASE ( IO_GRIB2 )<a name='2119'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_INTEGER'>ext_gr2_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_INTEGER_2">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2120'>
#endif<a name='2121'>
<a name='2122'>
                    CASE DEFAULT<a name='2123'>
                      Status = 0<a name='2124'>
                  END SELECT<a name='2125'>
<a name='2126'>
                  DEALLOCATE( IData)<a name='2127'>
 <a name='2128'>
<font color=#447700>! Every I/O server  handles the "set_time" request.<a name='2129'></font>
                CASE ( int_set_time )<a name='2130'>
<a name='2131'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_5">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2132'>
                                               DataHandle, Element, VarName, CData, code )<a name='2133'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2134'>
#ifdef INTIO<a name='2135'>
                    CASE ( IO_INTIO   )<a name='2136'>
                      CALL ext_int_set_time ( handle(DataHandle), TRIM(CData), Status)<a name='2137'>
#endif<a name='2138'>
                    CASE DEFAULT<a name='2139'>
                      Status = 0<a name='2140'>
                  END SELECT<a name='2141'>
<a name='2142'>
                  icurs = icurs + hdrbufsize<a name='2143'>
<a name='2144'>
<font color=#447700>! Every I/O server handles the "put_dom_ti_char" request.<a name='2145'></font>
                CASE ( int_dom_ti_char )<a name='2146'>
<a name='2147'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_6">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2148'>
                                               DataHandle, Element, VarName, CData, code )<a name='2149'>
<a name='2150'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2151'>
#ifdef PNETCDF_QUILT<a name='2152'>
                    CASE (IO_PNETCDF  )<a name='2153'>
                      CALL ext_pnc_put_dom_ti_char ( handle(DataHandle), TRIM(Element), Trim(CData), Status)<a name='2154'>
#endif<a name='2155'>
#ifdef NETCDF<a name='2156'>
                    CASE ( IO_NETCDF   )<a name='2157'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_CHAR'>ext_ncd_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_CHAR_2"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2158'>
#endif<a name='2159'>
#ifdef INTIO<a name='2160'>
                    CASE ( IO_INTIO   )<a name='2161'>
                      CALL ext_int_put_dom_ti_char ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2162'>
#endif<a name='2163'>
#ifdef YYY<a name='2164'>
                   CASE ( IO_YYY )<a name='2165'>
                      CALL ext_yyy_put_dom_ti_char ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2166'>
#endif<a name='2167'>
#ifdef GRIB1<a name='2168'>
                   CASE ( IO_GRIB1 )<a name='2169'>
                      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_CHAR'>ext_gr1_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_CHAR_2"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2170'>
#endif<a name='2171'>
#ifdef GRIB2<a name='2172'>
                   CASE ( IO_GRIB2 )<a name='2173'>
                      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_CHAR'>ext_gr2_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_CHAR_2"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2174'>
#endif<a name='2175'>
                   CASE DEFAULT<a name='2176'>
                      Status = 0<a name='2177'>
                   END SELECT<a name='2178'>
<a name='2179'>
                  icurs = icurs + hdrbufsize<a name='2180'>
<a name='2181'>
<font color=#447700>! Every I/O server handles the "put_var_ti_char" request.<a name='2182'></font>
                CASE ( int_var_ti_char )<a name='2183'>
<a name='2184'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_7">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2185'>
                                               DataHandle, Element, VarName, CData, code )<a name='2186'>
<a name='2187'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2188'>
#ifdef PNETCDF_QUILT<a name='2189'>
                    CASE (IO_PNETCDF  )<a name='2190'>
                      CALL ext_pnc_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status )<a name='2191'>
#endif<a name='2192'>
#ifdef NETCDF<a name='2193'>
                    CASE ( IO_NETCDF   )<a name='2194'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_VAR_TI_CHAR'>ext_ncd_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_VAR_TI_CHAR_2"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2195'>
#endif<a name='2196'>
#ifdef INTIO<a name='2197'>
                    CASE ( IO_INTIO   )<a name='2198'>
                      CALL ext_int_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2199'>
#endif<a name='2200'>
#ifdef YYY<a name='2201'>
                   CASE ( IO_YYY )<a name='2202'>
                      CALL ext_yyy_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2203'>
#endif<a name='2204'>
#ifdef GRIB1<a name='2205'>
                   CASE ( IO_GRIB1 )<a name='2206'>
                      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_VAR_TI_CHAR'>ext_gr1_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_VAR_TI_CHAR_2"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2207'>
#endif<a name='2208'>
#ifdef GRIB2<a name='2209'>
                   CASE ( IO_GRIB2 )<a name='2210'>
                      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_VAR_TI_CHAR'>ext_gr2_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_VAR_TI_CHAR_2"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2211'>
#endif<a name='2212'>
                   CASE DEFAULT<a name='2213'>
                      Status = 0<a name='2214'>
                   END SELECT<a name='2215'>
<a name='2216'>
                  icurs = icurs + hdrbufsize<a name='2217'>
<a name='2218'>
                CASE ( int_ioexit )<a name='2219'>
<font color=#447700>! ioexit is now handled by sending negative message length to server<a name='2220'></font>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_274">( &amp;<a name='2221'>
                         "quilt: should have handled int_ioexit already")<a name='2222'>
<font color=#447700>! Every I/O server handles the "ioclose" request.<a name='2223'></font>
                CASE ( int_ioclose )<a name='2224'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_4">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2225'>
                                              DataHandle , code )<a name='2226'>
                  icurs = icurs + hdrbufsize<a name='2227'>
<a name='2228'>
                  IF ( DataHandle .GE. 1 ) THEN<a name='2229'>
<a name='2230'>
                     SELECT CASE (use_package(io_form(DataHandle)))<a name='2231'>
#ifdef PNETCDF_QUILT<a name='2232'>
                    CASE ( IO_PNETCDF   )<a name='2233'>
                      CALL ext_pnc_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2234'>
                      IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2235'>
                        CALL ext_pnc_ioclose(handle(DataHandle),Status)<a name='2236'>
                      ENDIF<a name='2237'>
#endif<a name='2238'>
#ifdef NETCDF<a name='2239'>
                     CASE ( IO_NETCDF   )<a name='2240'>
                        CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_INQUIRE_FILENAME'>ext_ncd_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_INQUIRE_FILENAME_4">( handle(DataHandle), fname, fstat, Status )<a name='2241'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2242'>
                           CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOCLOSE'>ext_ncd_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOCLOSE_4">(handle(DataHandle),Status)<a name='2243'>
                        ENDIF<a name='2244'>
#endif<a name='2245'>
#ifdef INTIO<a name='2246'>
                     CASE ( IO_INTIO   )<a name='2247'>
                        CALL ext_int_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2248'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2249'>
                           CALL ext_int_ioclose(handle(DataHandle),Status)<a name='2250'>
                        ENDIF<a name='2251'>
#endif<a name='2252'>
#ifdef YYY<a name='2253'>
                     CASE ( IO_YYY )<a name='2254'>
                        CALL ext_yyy_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2255'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2256'>
                           CALL ext_yyy_ioclose(handle(DataHandle),Status)<a name='2257'>
                        ENDIF<a name='2258'>
#endif<a name='2259'>
#ifdef GRIB1<a name='2260'>
                     CASE ( IO_GRIB1 )<a name='2261'>
                        CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_INQUIRE_FILENAME'>ext_gr1_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_INQUIRE_FILENAME_4">( handle(DataHandle), fname, fstat, Status )<a name='2262'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2263'>
                           CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOCLOSE'>ext_gr1_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOCLOSE_3">(handle(DataHandle),Status)<a name='2264'>
                        ENDIF<a name='2265'>
#endif<a name='2266'>
#ifdef GRIB2<a name='2267'>
                     CASE ( IO_GRIB2 )<a name='2268'>
                        CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_INQUIRE_FILENAME'>ext_gr2_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_INQUIRE_FILENAME_4">( handle(DataHandle), fname, fstat, Status )<a name='2269'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2270'>
                           CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOCLOSE'>ext_gr2_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOCLOSE_3">(handle(DataHandle),Status)<a name='2271'>
                        ENDIF<a name='2272'>
#endif<a name='2273'>
                     CASE DEFAULT<a name='2274'>
                        Status = 0<a name='2275'>
                     END SELECT<a name='2276'>
                  ENDIF<a name='2277'>
<a name='2278'>
<font color=#447700>! Every I/O server handles the "open_for_write_begin" request.<a name='2279'></font>
                CASE ( int_open_for_write_begin )<a name='2280'>
<a name='2281'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_OFWB_HEADER'>int_get_ofwb_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_OFWB_HEADER_2">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2282'>
                                            FileName,SysDepInfo,io_form_arg,DataHandle )<a name='2283'>
<a name='2284'>
<font color=#447700>!write(0,*)' int_open_for_write_begin itypesize ',itypesize,' itypesize ',itypesize<a name='2285'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin icurs ', icurs, hdrbufsize<a name='2286'></font>
<font color=#447700>!JMDEBUGwrite(0,*)' int_open_for_write_begin FileName ',TRIM(FileName) , ' DataHandle ', DataHandle<a name='2287'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin SysDepInfo ',TRIM(SysDepInfo) <a name='2288'></font>
                  icurs = icurs + hdrbufsize<a name='2289'>
<font color=#447700>!write(0,*)' int_open_for_write_begin new icurs,tag,size ', icurs, get_hdr_tag( bigbuf(icurs/itypesize) ),get_hdr_rec_size( bigbuf(icurs/itypesize) )<a name='2290'></font>
                <a name='2291'>
                  io_form(DataHandle) = io_form_arg<a name='2292'>
<a name='2293'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2294'>
#ifdef PNETCDF_QUILT<a name='2295'>
                    CASE (IO_PNETCDF  )<a name='2296'>
                      CALL ext_pnc_open_for_write_begin(FileName,mpi_comm_local,mpi_comm_local,SysDepInfo,handle(DataHandle),Status )<a name='2297'>
#endif<a name='2298'>
#ifdef NETCDF<a name='2299'>
                    CASE ( IO_NETCDF   )<a name='2300'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_OPEN_FOR_WRITE_BEGIN'>ext_ncd_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_OPEN_FOR_WRITE_BEGIN_4">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2301'>
<font color=#447700>!write(0,*)'ext_ncd_open_for_write_begin ',Trim(FileName),DataHandle,handle(DataHandle),Status<a name='2302'></font>
#endif<a name='2303'>
#ifdef INTIO<a name='2304'>
                    CASE ( IO_INTIO   )<a name='2305'>
                      CALL ext_int_open_for_write_begin(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2306'>
#endif<a name='2307'>
#ifdef YYY<a name='2308'>
                    CASE ( IO_YYY )<a name='2309'>
                       CALL ext_yyy_open_for_write_begin(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2310'>
#endif<a name='2311'>
#ifdef GRIB1<a name='2312'>
                    CASE ( IO_GRIB1 )<a name='2313'>
                       CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_OPEN_FOR_WRITE_BEGIN'>ext_gr1_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_OPEN_FOR_WRITE_BEGIN_3">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2314'>
#endif<a name='2315'>
#ifdef GRIB2<a name='2316'>
                    CASE ( IO_GRIB2 )<a name='2317'>
                       CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_OPEN_FOR_WRITE_BEGIN'>ext_gr2_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_OPEN_FOR_WRITE_BEGIN_3">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2318'>
#endif<a name='2319'>
                    CASE DEFAULT<a name='2320'>
                      Status = 0<a name='2321'>
                  END SELECT<a name='2322'>
                <a name='2323'>
                  okay_to_write(DataHandle) = .false.<a name='2324'>
<a name='2325'>
<font color=#447700>! Every I/O server handles the "open_for_write_commit" request.<a name='2326'></font>
<font color=#447700>! In this case, the "okay_to_commit" is simply set to .true. so "write_field"<a name='2327'></font>
<font color=#447700>! (int_field) requests will initiate writes to disk.  Actual commit will be done after<a name='2328'></font>
<font color=#447700>! all requests in this batch have been handled.<a name='2329'></font>
                CASE ( int_open_for_write_commit )<a name='2330'>
<a name='2331'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_5">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2332'>
                                              DataHandle , code )<a name='2333'>
                  icurs = icurs + hdrbufsize<a name='2334'>
                  okay_to_commit(DataHandle) = .true.<a name='2335'>
<a name='2336'>
<font color=#447700>! Every I/O server handles the "write_field" (int_field) request.<a name='2337'></font>
<font color=#447700>! If okay_to_write(DataHandle) is .true. then the patch in the<a name='2338'></font>
<font color=#447700>! header (bigbuf) is written to disk using pNetCDF.  Note that this is where the actual<a name='2339'></font>
<font color=#447700>! "quilting" (reassembly of patches onto a full-size domain) is done.  If<a name='2340'></font>
<font color=#447700>! okay_to_write(DataHandle) is .false. then external I/O package interfaces<a name='2341'></font>
<font color=#447700>! are called to write metadata for I/O formats that support native metadata.<a name='2342'></font>
<font color=#447700>!<a name='2343'></font>
<font color=#447700>! NOTE that the I/O servers will only see write_field (int_field)<a name='2344'></font>
<font color=#447700>! requests AFTER an "iosync" request.<a name='2345'></font>
                CASE ( int_field )<a name='2346'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='2347'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_7"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='2348'>
                                                    DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='2349'>
                                                    DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='2350'>
                                                    DomainStart , DomainEnd ,                                    &amp;<a name='2351'>
                                                    MemoryStart , MemoryEnd ,                                    &amp;<a name='2352'>
                                                    PatchStart , PatchEnd )<a name='2353'>
<font color=#447700>!write(0,*)' int_field ',TRIM(VarName),DataHandle,okay_to_write(DataHandle)<a name='2354'></font>
                  icurs = icurs + hdrbufsize<a name='2355'>
<a name='2356'>
                  IF ( okay_to_write(DataHandle) ) THEN<a name='2357'>
<a name='2358'>
<font color=#447700>!!$                    WRITE(0,FMT="('&gt;&gt;&gt; ',(A),1x,(A),1x,A2,I6,1x,3('[',I3,',',I3,'] '))") &amp;<a name='2359'></font>
<font color=#447700>!!$                          TRIM(DateStr), TRIM(VarName), TRIM(MemoryOrder), &amp;<a name='2360'></font>
<font color=#447700>!!$                        (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)*(PatchEnd(3)-PatchStart(3)+1), &amp;<a name='2361'></font>
<font color=#447700>!!$PatchStart(1),PatchEnd(1),PatchStart(2),PatchEnd(2),PatchStart(3),PatchEnd(3)<a name='2362'></font>
<font color=#447700>!!$                    WRITE(0,FMT="('&gt;&gt;&gt; ',(A),1x,(A),1x,I6,1x,3('[',I3,',',I3,'] '))") &amp;<a name='2363'></font>
<font color=#447700>!!$                          TRIM(DateStr), TRIM(VarName),  DomainDesc, &amp;<a name='2364'></font>
<font color=#447700>!!$                          DomainStart(1),DomainEnd(1),DomainStart(2),DomainEnd(2),DomainStart(3),DomainEnd(3)<a name='2365'></font>
<a name='2366'>
                    IF ( FieldType .EQ. WRF_FLOAT .OR. FieldType .EQ. WRF_DOUBLE)  THEN<a name='2367'>
                      <font color=#447700>! Note that the WRF_DOUBLE branch of this IF statement must come first since <a name='2368'></font>
                      <font color=#447700>! WRF_FLOAT is set equal to WRF_DOUBLE during autopromotion builds.  <a name='2369'></font>
                      IF ( FieldType .EQ. WRF_DOUBLE)  THEN<a name='2370'>
<font color=#447700>! this branch has not been tested TBH: 20050406<a name='2371'></font>
                        CALL mpi_type_size( MPI_DOUBLE_PRECISION, ftypesize, ierr )<a name='2372'>
                      ELSE<a name='2373'>
                        CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='2374'>
                      ENDIF<a name='2375'>
<a name='2376'>
#ifdef PNETCDF_QUILT<a name='2377'>
<font color=#447700>!                      WRITE(mess,FMT="('&gt;&gt;&gt; ',(A),1x,(A),1x,I6,1x,3('[',I3,',',I3,'] '))") &amp;<a name='2378'></font>
<font color=#447700>!                          TRIM(DateStr), TRIM(VarName),  DomainDesc, &amp;<a name='2379'></font>
<font color=#447700>!                          DomainStart(1),DomainEnd(1), &amp;<a name='2380'></font>
<font color=#447700>!                          DomainStart(2),DomainEnd(2),DomainStart(3),DomainEnd(3)<a name='2381'></font>
<font color=#447700>!                      CALL wrf_message(mess)<a name='2382'></font>
<a name='2383'>
                      CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PATCH_IN_OUTBUF_PNC'>store_patch_in_outbuf_pnc</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PATCH_IN_OUTBUF_PNC_1">(obuf(icurs/itypesize), &amp;<a name='2384'>
                                                     dummybuf, TRIM(DateStr), &amp;<a name='2385'>
                                                     TRIM(VarName) , &amp;<a name='2386'>
                                                     FieldType,      &amp;<a name='2387'>
                                                     TRIM(MemoryOrder), &amp;<a name='2388'>
                                                     TRIM(Stagger), &amp;<a name='2389'>
                                                     DimNames, &amp;<a name='2390'>
                                                     DomainStart , DomainEnd ,&amp;<a name='2391'>
                                                     MemoryStart , MemoryEnd ,&amp;<a name='2392'>
                                                     PatchStart , PatchEnd, &amp;<a name='2393'>
                                                     ntasks_io_group-1 )<a name='2394'>
                      stored_write_record = .true.<a name='2395'>
<a name='2396'>
<font color=#447700>!!$                      IF(VarName .eq. "PSFC")THEN<a name='2397'></font>
<font color=#447700>!!$                         CALL dump_real_array_c(obuf(icurs/itypesize), DomainStart,&amp;<a name='2398'></font>
<font color=#447700>!!$                                                DomainEnd, PatchStart, PatchEnd,   &amp;<a name='2399'></font>
<font color=#447700>!!$                                                mytask_local, DomainDesc)<a name='2400'></font>
<font color=#447700>!!$                      ENDIF<a name='2401'></font>
<a name='2402'>
#endif<a name='2403'>
                    ELSE IF ( FieldType .EQ. WRF_INTEGER ) THEN<a name='2404'>
                      CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='2405'>
#ifdef PNETCDF_QUILT<a name='2406'>
                      CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PATCH_IN_OUTBUF_PNC'>store_patch_in_outbuf_pnc</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PATCH_IN_OUTBUF_PNC_2"> ( dummybuf,             &amp; <a name='2407'>
                                                   obuf(icurs/itypesize) ,   &amp;<a name='2408'>
                                                   TRIM(DateStr) ,           &amp;<a name='2409'>
                                                   TRIM(VarName) ,           &amp;<a name='2410'>
                                                   FieldType,                &amp;<a name='2411'>
                                                   TRIM(MemoryOrder) ,       &amp;<a name='2412'>
                                                   TRIM(Stagger), DimNames,  &amp;<a name='2413'>
                                                   DomainStart , DomainEnd , &amp;<a name='2414'>
                                                   MemoryStart , MemoryEnd , &amp;<a name='2415'>
                                                   PatchStart , PatchEnd   , &amp;<a name='2416'>
                                                   ntasks_io_group-1 )<a name='2417'>
                      stored_write_record = .true.<a name='2418'>
#endif<a name='2419'>
                    ELSE IF ( FieldType .EQ. WRF_LOGICAL ) THEN<a name='2420'>
                      ftypesize = LWORDSIZE<a name='2421'>
                    ENDIF<a name='2422'>
<a name='2423'>
                    icurs = icurs + (PatchEnd(1)-PatchStart(1)+1)* &amp;<a name='2424'>
                                    (PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='2425'>
                                    (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='2426'>
<a name='2427'>
                  ELSE <font color=#447700>! Write metadata only (or do 'training'?)<a name='2428'></font>
<a name='2429'>
                    SELECT CASE (use_package(io_form(DataHandle)))<a name='2430'>
<a name='2431'>
#ifdef PNETCDF_QUILT<a name='2432'>
                      CASE ( IO_PNETCDF )<a name='2433'>
                        CALL ext_pnc_write_field ( handle(DataHandle) , TRIM(DateStr),        &amp;<a name='2434'>
                                   TRIM(VarName) , dummy , FieldType , mpi_comm_local , mpi_comm_local,         &amp;<a name='2435'>
                                   DomainDesc , TRIM(MemoryOrder) , TRIM(Stagger), DimNames , &amp;<a name='2436'>
                                   DomainStart , DomainEnd ,                                  &amp;<a name='2437'>
                                   MemoryStart , MemoryEnd ,                                  &amp;<a name='2438'>
                                   PatchStart ,  PatchEnd,                                  &amp;<a name='2439'>
                                   Status )<a name='2440'>
#endif<a name='2441'>
#ifdef NETCDF<a name='2442'>
                      CASE ( IO_NETCDF   )<a name='2443'>
                        CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_WRITE_FIELD'>ext_ncd_write_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_WRITE_FIELD_2"> ( handle(DataHandle) , TRIM(DateStr) ,         &amp;<a name='2444'>
                                   TRIM(VarName) , dummy , FieldType , Comm , IOComm,           &amp;<a name='2445'>
                                   DomainDesc , TRIM(MemoryOrder) , TRIM(Stagger) , DimNames ,  &amp;<a name='2446'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='2447'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='2448'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='2449'>
                                   Status )<a name='2450'>
#endif<a name='2451'>
                      CASE DEFAULT<a name='2452'>
                        Status = 0<a name='2453'>
                    END SELECT<a name='2454'>
                  ENDIF<a name='2455'>
                CASE ( int_iosync )<a name='2456'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_6">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2457'>
                                            DataHandle , code )<a name='2458'>
                  icurs = icurs + hdrbufsize<a name='2459'>
                CASE DEFAULT<a name='2460'>
                  WRITE(mess,*)__LINE__,' quilt: io_sync: bad tag: ',                            &amp;<a name='2461'>
                               get_hdr_tag( obuf(icurs/itypesize) ),' icurs ',&amp;<a name='2462'>
                               icurs/itypesize<a name='2463'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_275">( mess )<a name='2464'>
              END SELECT<a name='2465'>
<a name='2466'>
            ENDDO <font color=#447700>!}<a name='2467'></font>
<font color=#447700>! Now, we have finshed handling all commands from the latest<a name='2468'></font>
<font color=#447700>! call to retrieve_pieces_of_field().<a name='2469'></font>
<a name='2470'>
            IF (stored_write_record) THEN<a name='2471'>
<font color=#447700>! If any field patches have been stored in internal output buffers<a name='2472'></font>
<font color=#447700>! (via a call to store_patch_in_outbuf_pnc()) then call write_outbuf_pnc() <a name='2473'></font>
<font color=#447700>! to write them to disk now.<a name='2474'></font>
<font color=#447700>! NOTE that the I/O server will only have called<a name='2475'></font>
<font color=#447700>! store_patch_in_outbuf() when handling write_field (int_field)<a name='2476'></font>
<font color=#447700>! commands which only arrive AFTER an "iosync" command.<a name='2477'></font>
<font color=#447700>!              CALL start_timing<a name='2478'></font>
#ifdef PNETCDF_QUILT<a name='2479'>
              CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#WRITE_OUTBUF_PNC'>write_outbuf_pnc</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_OUTBUF_PNC_1">( handle(DataHandle), &amp;<a name='2480'>
                                     use_package(io_form(DataHandle)), &amp;<a name='2481'>
                                     mpi_comm_local, mytask_local,     &amp;<a name='2482'>
                                     ntasks_local_group) <a name='2483'>
#endif<a name='2484'>
<font color=#447700>!              CALL end_timing( "quilt_pnc: call to write_outbuf_pnc" ) <a name='2485'></font>
              stored_write_record = .false.<a name='2486'>
              written_record = .true.<a name='2487'>
            ENDIF<a name='2488'>
<a name='2489'>
<font color=#447700>! If one or more "open_for_write_commit" commands were encountered from the<a name='2490'></font>
<font color=#447700>! latest call to retrieve_pieces_of_field() then call the package-specific<a name='2491'></font>
<font color=#447700>! routine to do the commit.<a name='2492'></font>
            IF (okay_to_commit(DataHandle)) THEN<a name='2493'>
<a name='2494'>
              SELECT CASE (use_package(io_form(DataHandle)))<a name='2495'>
#ifdef PNETCDF_QUILT<a name='2496'>
                CASE ( IO_PNETCDF   )<a name='2497'>
                  CALL ext_pnc_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2498'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2499'>
                    CALL ext_pnc_open_for_write_commit(handle(DataHandle),Status)<a name='2500'>
                    okay_to_write(DataHandle) = .true.<a name='2501'>
                  ENDIF<a name='2502'>
#endif<a name='2503'>
#ifdef NETCDF<a name='2504'>
                CASE ( IO_NETCDF   )<a name='2505'>
                  CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_INQUIRE_FILENAME'>ext_ncd_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_INQUIRE_FILENAME_5">( handle(DataHandle), fname, fstat, Status )<a name='2506'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2507'>
                    CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_OPEN_FOR_WRITE_COMMIT'>ext_ncd_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_OPEN_FOR_WRITE_COMMIT_3">(handle(DataHandle),Status)<a name='2508'>
                    okay_to_write(DataHandle) = .true.<a name='2509'>
                  ENDIF<a name='2510'>
#endif<a name='2511'>
#ifdef INTIO<a name='2512'>
                CASE ( IO_INTIO   )<a name='2513'>
                  CALL ext_int_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2514'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2515'>
                    CALL ext_int_open_for_write_commit(handle(DataHandle),Status)<a name='2516'>
                    okay_to_write(DataHandle) = .true.<a name='2517'>
                  ENDIF<a name='2518'>
#endif<a name='2519'>
#ifdef YYY<a name='2520'>
                 CASE ( IO_YYY )<a name='2521'>
                    CALL ext_yyy_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2522'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2523'>
                       CALL ext_yyy_open_for_write_commit(handle(DataHandle),Status)<a name='2524'>
                       okay_to_write(DataHandle) = .true.<a name='2525'>
                    ENDIF<a name='2526'>
#endif<a name='2527'>
#ifdef GRIB1<a name='2528'>
                 CASE ( IO_GRIB1 )<a name='2529'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_INQUIRE_FILENAME'>ext_gr1_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_INQUIRE_FILENAME_5">( handle(DataHandle), fname, fstat, Status )<a name='2530'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2531'>
                       CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_OPEN_FOR_WRITE_COMMIT'>ext_gr1_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_OPEN_FOR_WRITE_COMMIT_3">(handle(DataHandle),Status)<a name='2532'>
                       okay_to_write(DataHandle) = .true.<a name='2533'>
                    ENDIF<a name='2534'>
#endif<a name='2535'>
#ifdef GRIB2<a name='2536'>
                 CASE ( IO_GRIB2 )<a name='2537'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_INQUIRE_FILENAME'>ext_gr2_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_INQUIRE_FILENAME_5">( handle(DataHandle), fname, fstat, Status )<a name='2538'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2539'>
                       CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_OPEN_FOR_WRITE_COMMIT'>ext_gr2_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_OPEN_FOR_WRITE_COMMIT_3">(handle(DataHandle),Status)<a name='2540'>
                       okay_to_write(DataHandle) = .true.<a name='2541'>
                    ENDIF<a name='2542'>
#endif<a name='2543'>
<a name='2544'>
                CASE DEFAULT<a name='2545'>
                  Status = 0<a name='2546'>
              END SELECT<a name='2547'>
<a name='2548'>
            okay_to_commit(DataHandle) = .false.<a name='2549'>
          ENDIF<a name='2550'>
<font color=#447700>!!endif<a name='2551'></font>
<a name='2552'>
<font color=#447700>! Retrieve header and all patches for the next field from the internal <a name='2553'></font>
<font color=#447700>! buffers.  <a name='2554'></font>
        CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#RETRIEVE_PIECES_OF_FIELD'>retrieve_pieces_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_PIECES_OF_FIELD_4"> ( obuf , VarName, obufsize, sz, retval )<a name='2555'>
      END DO <font color=#447700>!}<a name='2556'></font>
<a name='2557'>
      DEALLOCATE( obuf )<a name='2558'>
<a name='2559'>
      <font color=#447700>! flush output files if needed<a name='2560'></font>
      IF (written_record) THEN<a name='2561'>
<font color=#447700>!CALL start_timing<a name='2562'></font>
        SELECT CASE ( use_package(io_form) )<a name='2563'>
#ifdef PNETCDF_QUILT<a name='2564'>
          CASE ( IO_PNETCDF   )<a name='2565'>
            CALL ext_pnc_iosync( handle(DataHandle), Status )<a name='2566'>
#endif<a name='2567'>
          CASE DEFAULT<a name='2568'>
            Status = 0<a name='2569'>
        END SELECT<a name='2570'>
        written_record = .false.<a name='2571'>
<font color=#447700>!CALL end_timing( "quilt_pnc: flush" )<a name='2572'></font>
      ENDIF<a name='2573'>
<a name='2574'>
      END DO <font color=#447700>! }<a name='2575'></font>
<a name='2576'>
    END SUBROUTINE quilt_pnc<a name='2577'>
<a name='2578'>
<font color=#447700>! end of #endif of DM_PARALLEL<a name='2579'></font>
#endif<a name='2580'>
<a name='2581'>
<A NAME='INIT_MODULE_WRF_QUILT'><A href='../../html_code/frame/module_io_quilt_new.F.html#INIT_MODULE_WRF_QUILT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2582'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_wrf_quilt</font> <A href='../../call_to/INIT_MODULE_WRF_QUILT.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_MODULE_WRF_QUILT.html' TARGET='index'>35</A><a name='2583'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_22">, only: init_module_wrf_error<a name='2584'>
      USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_39"><a name='2585'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_128">, ONLY : compute_mesh,nest_pes_x, nest_pes_y, domain_active_this_task<a name='2586'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2587'></font>
<font color=#447700>! Both client (compute) and server tasks call this routine to initialize the <a name='2588'></font>
<font color=#447700>! module.  Routine setup_quilt_servers() is called from this routine to <a name='2589'></font>
<font color=#447700>! determine which tasks are compute tasks and which are server tasks.  Server <a name='2590'></font>
<font color=#447700>! tasks then call routine quilt() and remain there for the rest of the model <a name='2591'></font>
<font color=#447700>! run.  Compute tasks return from init_module_wrf_quilt() to perform model <a name='2592'></font>
<font color=#447700>! computations.  <a name='2593'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2594'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='2595'></font>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_129">, ONLY : compute_mesh,nest_pes_x,nest_pes_y,domain_active_this_task,&amp;<a name='2596'>
                            tasks_per_split,comm_start,dm_task_split<a name='2597'>
      IMPLICIT NONE<a name='2598'>
      INCLUDE 'mpif.h'<a name='2599'>
      INTEGER i,j<a name='2600'>
      NAMELIST /namelist_quilt/ nio_tasks_per_group, nio_groups, poll_servers<a name='2601'>
      INTEGER ntasks, mytask, ierr, io_status, id, itask<a name='2602'>
#  if defined(_OPENMP) &amp;&amp; defined(MPI2_THREAD_SUPPORT)<a name='2603'>
      INTEGER thread_support_provided, thread_support_requested<a name='2604'>
#endif<a name='2605'>
      INTEGER num_io_tasks, ncompute_tasks<a name='2606'>
      INTEGER n_x, n_y<a name='2607'>
      INTEGER mpi_comm_here, temp_poll, comdup<a name='2608'>
      INTEGER, ALLOCATABLE ::  icolor(:)<a name='2609'>
      LOGICAL mpi_inited<a name='2610'>
      LOGICAL compute_node<a name='2611'>
      LOGICAL esmf_coupling<a name='2612'>
      CHARACTER*256 message<a name='2613'>
<a name='2614'>
<font color=#447700>!!!!! needed to sneak-peek the namelist to get parent_id<a name='2615'></font>
<font color=#447700>! define as temporaries<a name='2616'></font>
#include "<A href='../../html_code/include/namelist_defines.inc.html'>namelist_defines.inc</A>"<A NAME="namelist_defines.inc_5"><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2617'>
<a name='2618'>
<font color=#447700>! Statements that specify the namelists<a name='2619'></font>
#include "<A href='../../html_code/include/namelist_statements.inc.html'>namelist_statements.inc</A>"<A NAME="namelist_statements.inc_6"><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2620'>
<a name='2621'>
<font color=#447700>!TODO:  Change this to run-time switch<a name='2622'></font>
#ifdef ESMFIO<a name='2623'>
      esmf_coupling = .TRUE.<a name='2624'>
#else<a name='2625'>
      esmf_coupling = .FALSE.<a name='2626'>
#endif<a name='2627'>
      quilting_enabled = .FALSE.<a name='2628'>
      IF ( disable_quilt ) RETURN<a name='2629'>
<a name='2630'>
      DO i = 1,int_num_handles<a name='2631'>
        okay_to_write(i) = .FALSE.<a name='2632'>
        int_handle_in_use(i) = .FALSE.<a name='2633'>
        which_grid_is_handle(i) = -1<a name='2634'>
        prev_server_for_handle(i) = -1<a name='2635'>
        int_num_bytes_to_write(i) = 0<a name='2636'>
      ENDDO<a name='2637'>
      DO j = 1, max_domains<a name='2638'>
        DO i = 1,int_num_handles<a name='2639'>
          server_for_handle(i,j) = 0 <a name='2640'>
        ENDDO<a name='2641'>
      ENDDO<a name='2642'>
<a name='2643'>
      CALL MPI_INITIALIZED( mpi_inited, ierr )<a name='2644'>
      IF ( .NOT. mpi_inited ) THEN<a name='2645'>
#  if defined(_OPENMP) &amp;&amp; defined(MPI2_THREAD_SUPPORT)<a name='2646'>
        thread_support_requested = MPI_THREAD_FUNNELED<a name='2647'>
        CALL mpi_init_thread ( thread_support_requested, thread_support_provided, ierr )<a name='2648'>
        IF ( thread_support_provided .lt. thread_support_requested ) THEN<a name='2649'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_276">( "failed to initialize MPI thread support")<a name='2650'>
        ENDIF<a name='2651'>
#  else<a name='2652'>
        CALL mpi_init ( ierr )<a name='2653'>
#  endif<a name='2654'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_6">( MPI_COMM_WORLD )<a name='2655'>
        CALL <A href='../../html_code/frame/module_dm.F.html#WRF_TERMIO_DUP'>wrf_termio_dup</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_TERMIO_DUP_3">(MPI_COMM_WORLD)<a name='2656'>
      ENDIF<a name='2657'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_DM_COMMUNICATOR'>wrf_get_dm_communicator</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_COMMUNICATOR_47">( mpi_comm_here )   <font color=#447700>! get global communicator<a name='2658'></font>
<a name='2659'>
      CALL MPI_Comm_rank ( mpi_comm_here, mytask, ierr ) ;<a name='2660'>
      CALL MPI_Comm_size ( mpi_comm_here, ntasks, ierr ) ;<a name='2661'>
<a name='2662'>
      IF ( mytask .EQ. 0 ) THEN<a name='2663'>
        OPEN ( unit=27, file="namelist.input", form="formatted", status="old" )<a name='2664'>
        tasks_per_split = ntasks<a name='2665'>
<font color=#447700>!        comm_domain = -1   ! by default, domain is always on communicator 1<a name='2666'></font>
<font color=#447700>!        comm_domain(1) = 1   ! by default, domain is always on communicator 1<a name='2667'></font>
        READ ( UNIT = 27 , NML = domains , IOSTAT=io_status )<a name='2668'>
        REWIND(27)<a name='2669'>
        nio_groups = 1<a name='2670'>
        nio_tasks_per_group  = 0<a name='2671'>
        poll_servers = .false.<a name='2672'>
        READ ( 27 , NML = namelist_quilt, IOSTAT=io_status )<a name='2673'>
        IF (io_status .NE. 0) THEN<a name='2674'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_277">( "ERROR reading namelist namelist_quilt" )<a name='2675'>
        ENDIF<a name='2676'>
        REWIND(27)<a name='2677'>
        nproc_x = -1<a name='2678'>
        nproc_y = -1<a name='2679'>
        READ ( UNIT = 27 , NML = domains , IOSTAT=io_status )<a name='2680'>
        IF (io_status .NE. 0) THEN<a name='2681'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_278">( "ERROR reading namelist domains" )<a name='2682'>
        ENDIF<a name='2683'>
        CLOSE ( 27 )<a name='2684'>
        IF ( esmf_coupling ) THEN<a name='2685'>
          IF ( any ( nio_tasks_per_group &gt; 0 ) ) THEN<a name='2686'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_279">("frame/module_io_quilt.F: cannot use "// &amp;<a name='2687'>
                                 "ESMF coupling with quilt tasks") ;<a name='2688'>
          ENDIF<a name='2689'>
        ENDIF<a name='2690'>
        if(poll_servers) then<a name='2691'>
           temp_poll=1<a name='2692'>
        else<a name='2693'>
           temp_poll=0<a name='2694'>
        endif<a name='2695'>
      ENDIF<a name='2696'>
      CALL mpi_bcast( parent_id, max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2697'>
      CALL mpi_bcast( max_dom, 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2698'>
      CALL nl_set_max_dom(1,max_dom)<a name='2699'>
      CALL mpi_bcast( nio_tasks_per_group  , max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2700'>
      CALL mpi_bcast( nio_groups , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2701'>
      CALL mpi_bcast( temp_poll , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2702'>
      CALL mpi_bcast( nproc_x , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2703'>
      CALL mpi_bcast( nproc_y , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2704'>
<a name='2705'>
<font color=#447700>! check to make sure that if nio_tasks_per_group is non-zero for any domain it has to be non-zero for all of them<a name='2706'></font>
      i = MAXVAL(nio_tasks_per_group(1:max_dom))<a name='2707'>
      IF ( i .GT. 0 .AND. nio_groups .GT. 0 ) THEN<a name='2708'>
        DO id = 1, max_dom<a name='2709'>
          IF ( nio_tasks_per_group(id) .LE. 0 ) THEN<a name='2710'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_280">( &amp;<a name='2711'>
'If nio_tasks_per_group in namelist.input is non-zero for any domain, every active domain must have a non-zero value in nio_tasks_per_group')<a name='2712'>
          ENDIF<a name='2713'>
        ENDDO<a name='2714'>
      ENDIF<a name='2715'>
<a name='2716'>
      num_io_tasks = 0<a name='2717'>
      DO id = 1, max_dom<a name='2718'>
        num_io_tasks = num_io_tasks + nio_tasks_per_group(id)*nio_groups<a name='2719'>
      ENDDO<a name='2720'>
      IF ( ntasks-num_io_tasks .LE. 0 ) THEN<a name='2721'>
        WRITE(message,*)'Initing quilting: not enough compute tasks left over after allocating ',num_io_tasks,' i/o servers'<a name='2722'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_281">( TRIM(message) )<a name='2723'>
      ENDIF<a name='2724'>
      IF ( mytask .EQ. 0 ) THEN<a name='2725'>
        OPEN ( unit=27, file="namelist.input", form="formatted", status="old" )<a name='2726'>
        comm_start = -1   <font color=#447700>! use this to find how many communicators have actually been defined<a name='2727'></font>
        nest_pes_x = 0    <font color=#447700>! dimensions of communicator in X and y<a name='2728'></font>
        nest_pes_y = 0<a name='2729'>
        IF ( nproc_x .NE. -1 .AND. nproc_y .NE. -1 ) THEN<a name='2730'>
         n_x=nproc_x<a name='2731'>
         n_y=nproc_y<a name='2732'>
        ELSE<a name='2733'>
         CALL <A href='../../html_code/frame/module_dm.F.html#COMPUTE_MESH'>compute_mesh</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_MESH_3">( ntasks-num_io_tasks, n_x, n_y )<a name='2734'>
        ENDIF<a name='2735'>
        comm_start = 0   <font color=#447700>! make it so everyone will use same communicator if the dm_task_split namelist is not specified or is empty<a name='2736'></font>
        nest_pes_x(1:max_dom) = n_x<a name='2737'>
        nest_pes_y(1:max_dom) = n_y<a name='2738'>
        READ ( 27 , NML = dm_task_split, IOSTAT=io_status )<a name='2739'>
<font color=#447700>! we need to sneak-peek the parent_id namelist setting, ,which is in the "domains" section<a name='2740'></font>
<font color=#447700>! of the namelist.  That namelist is registry generated, so the registry-generated information<a name='2741'></font>
<font color=#447700>! is #included above.<a name='2742'></font>
        CLOSE ( 27 )<a name='2743'>
      ENDIF<a name='2744'>
<font color=#447700>!debug write(0,*)'before mpi_bcast'<a name='2745'></font>
      CALL mpi_bcast( io_status, 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2746'>
<font color=#447700>!debug write(0,*)'after mpi_bcast',io_status<a name='2747'></font>
      IF ( io_status .NE. 0 ) THEN<a name='2748'>
      ENDIF<a name='2749'>
      CALL mpi_bcast( tasks_per_split, 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2750'>
      CALL mpi_bcast( comm_start, max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2751'>
      CALL mpi_bcast( nest_pes_x, max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2752'>
      CALL mpi_bcast( nest_pes_y, max_domains , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2753'>
<a name='2754'>
      CALL MPI_Comm_rank ( mpi_comm_here, mytask, ierr ) ;<a name='2755'>
      CALL mpi_x_comm_size( mpi_comm_here, ntasks, ierr ) ;<a name='2756'>
<a name='2757'>
<a name='2758'>
<font color=#447700>!!!!! end of needed to sneak-peek the namelist<a name='2759'></font>
<a name='2760'>
<font color=#447700>! set up the arrays associating quilt tasks to domains and check to make sure it will work<a name='2761'></font>
<font color=#447700>! role_for_task( maxprocs ) = 0 if compute, otherwise id of grid for which's it's a server<a name='2762'></font>
      ALLOCATE(role_for_task(ntasks))<a name='2763'>
      <font color=#447700>! count up the number of I/O tasks needed, each domain has its own set<a name='2764'></font>
      ncompute_tasks = 0<a name='2765'>
      DO id = 1, max_dom<a name='2766'>
         IF ( ncompute_tasks &lt; comm_start(id)+nest_pes_x(id)*nest_pes_y(id) ) THEN<a name='2767'>
              ncompute_tasks = comm_start(id)+nest_pes_x(id)*nest_pes_y(id)<a name='2768'>
         ENDIF<a name='2769'>
      ENDDO<a name='2770'>
      num_io_tasks = 0<a name='2771'>
      DO id = 1, max_dom<a name='2772'>
        num_io_tasks = num_io_tasks + nio_tasks_per_group(id)*nio_groups<a name='2773'>
      ENDDO<a name='2774'>
<font color=#447700>!jm      IF ( ncompute_tasks + num_io_tasks .NE. ntasks ) THEN<a name='2775'></font>
<font color=#447700>!jm        WRITE(message,"('ncompute_tasks(',i9,')+num_io_tasks(',i9,') .NE. ntasks(',i9,')')")ncompute_tasks,num_io_tasks,ntasks<a name='2776'></font>
      IF ( ncompute_tasks + num_io_tasks .GT. ntasks ) THEN<a name='2777'>
        WRITE(message,"('ncompute_tasks(',i9,')+num_io_tasks(',i9,') .GT. ntasks(',i9,')')")ncompute_tasks,num_io_tasks,ntasks<a name='2778'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_282">(TRIM(message))<a name='2779'>
      ENDIF<a name='2780'>
      DO itask = 1, ncompute_tasks<a name='2781'>
        role_for_task(itask) = 0<a name='2782'>
      ENDDO<a name='2783'>
      itask = ncompute_tasks + 1<a name='2784'>
      DO id = 1, max_dom<a name='2785'>
        DO i = 1, nio_tasks_per_group(id)*nio_groups<a name='2786'>
          role_for_task(itask) = id  <font color=#447700>! mark as a server<a name='2787'></font>
          itask = itask + 1<a name='2788'>
        ENDDO<a name='2789'>
      ENDDO<a name='2790'>
      ntasks = itask - 1<a name='2791'>
<font color=#447700>! end set up of role_for_task array<a name='2792'></font>
<a name='2793'>
      poll_servers = (temp_poll == 1)<a name='2794'>
<a name='2795'>
      compute_group_master = .FALSE.<a name='2796'>
      compute_node         = .FALSE.<a name='2797'>
<a name='2798'>
DO id = 1, max_dom<a name='2799'>
<a name='2800'>
<font color=#447700>! when this returns,  mpi_comm_local will be set for server tasks <a name='2801'></font>
<font color=#447700>!                     and compute tasks but these may be reset by split communicator<a name='2802'></font>
<font color=#447700>!                     mpi_comm_io_groups will be set for the grid id<a name='2803'></font>
<font color=#447700>!                     ntasks will be the number of tasks described in role_for_task<a name='2804'></font>
<font color=#447700>!                     mpi_comm_here will be passed in as all the tasks described in role_for_task<a name='2805'></font>
<a name='2806'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS'>setup_quilt_servers</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_QUILT_SERVERS_1">( id, nio_tasks_per_group,  &amp;<a name='2807'>
                                role_for_task,            &amp;  <font color=#447700>! this is the "color" array used to split coms<a name='2808'></font>
                                num_io_tasks,             &amp;<a name='2809'>
                                ncompute_tasks,           &amp;<a name='2810'>
                                mytask,                   &amp;<a name='2811'>
                                ntasks,                   &amp;<a name='2812'>
                                nio_groups,               &amp;<a name='2813'>
                                mpi_comm_here,            &amp;<a name='2814'>
                                mpi_comm_local,           &amp;  <font color=#447700>! only important on i/o servers<a name='2815'></font>
                                mpi_comm_io_groups,       &amp;<a name='2816'>
                                compute_node      )<a name='2817'>
<a name='2818'>
ENDDO<a name='2819'>
<a name='2820'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#INIT_MODULE_WRF_ERROR'>init_module_wrf_error</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULE_WRF_ERROR_1">(on_io_server=.true.)<a name='2821'>
<a name='2822'>
      CALL MPI_Comm_dup( mpi_comm_here, comdup, ierr )<a name='2823'>
      <font color=#447700>! throw away the I/O server tasks; mpi_comm_local will now be only all the compute tasks for all domains<a name='2824'></font>
      CALL MPI_Comm_split(comdup,role_for_task(mytask+1),mytask,mpi_comm_local, ierr )<a name='2825'>
<a name='2826'>
<a name='2827'>
      CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_7">( mpi_comm_local ) <font color=#447700>! split_communicators will see this <a name='2828'></font>
<font color=#447700>! compute node should be true for any compute node and false for every server node<a name='2829'></font>
      IF ( compute_node ) THEN<a name='2830'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='2831'></font>
          IF (coupler_on) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_SET_DM_COMMUNICATOR'>cpl_set_dm_communicator</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_SET_DM_COMMUNICATOR_1">( mpi_comm_local )<a name='2832'>
#endif<a name='2833'>
#if ( HWRF == 1 )<a name='2834'>
          call ATM_SET_COMM(mpi_comm_local)<a name='2835'>
#endif<a name='2836'>
       ELSE<a name='2837'>
#if ( HWRF == 1 )<a name='2838'>
          call ATM_LEAVE_COUPLING()<a name='2839'>
#endif<a name='2840'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='2841'></font>
          IF (coupler_on) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_SET_DM_COMMUNICATOR'>cpl_set_dm_communicator</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_SET_DM_COMMUNICATOR_2">( MPI_COMM_NULL )<a name='2842'>
#endif<a name='2843'>
          mpi_comm_local = mpi_comm_local_io_server_tmp  <a name='2844'>
          CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT'>quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QUILT_1">    <font color=#447700>! will not return on io server tasks<a name='2845'></font>
       ENDIF<a name='2846'>
#endif<a name='2847'>
<a name='2848'>
      RETURN<a name='2849'>
    END SUBROUTINE init_module_wrf_quilt<a name='2850'>
<a name='2851'>
<a name='2852'>
#ifdef IBM_REDUCE_BUG_WORKAROUND<a name='2853'>
<a name='2854'>
    <font color=#447700>! These three subroutines re-implement MPI_Reduce on MPI_INTEGER<a name='2855'></font>
    <font color=#447700>! with OP=MPI_ADD.<a name='2856'></font>
<a name='2857'>
    <font color=#447700>! This is a workaround for a bug in the IBM MPI implementation.<a name='2858'></font>
    <font color=#447700>! Some MPI processes will get stuck in MPI_Reduce and not<a name='2859'></font>
    <font color=#447700>! return until the PREVIOUS I/O server group finishes writing.<a name='2860'></font>
<a name='2861'>
    <font color=#447700>! This workaround replaces the MPI_Reduce call with many <a name='2862'></font>
    <font color=#447700>! MPI_Send and MPI_Recv calls that perform the sum on the<a name='2863'></font>
    <font color=#447700>! root of the communicator.<a name='2864'></font>
<a name='2865'>
    <font color=#447700>! There are two reduce routines: one for a sum of scalars<a name='2866'></font>
    <font color=#447700>! and one for a sum of arrays.  The get_reduce_tag generates<a name='2867'></font>
    <font color=#447700>! MPI tags for the communication.<a name='2868'></font>
<a name='2869'>
<A NAME='GET_REDUCE_TAG'><A href='../../html_code/frame/module_io_quilt_new.F.html#GET_REDUCE_TAG' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2870'>
  integer <font color=#993300>function </font><font color=#cc0000>get_reduce_tag</font>(root,comm) <A href='../../call_to/GET_REDUCE_TAG.html' TARGET='index'>4</A>,<A href='../../call_from/GET_REDUCE_TAG.html' TARGET='index'>12</A><a name='2871'>
    implicit none<a name='2872'>
    include 'mpif.h'<a name='2873'>
    integer, intent(in) :: comm,root<a name='2874'>
    integer :: i,j, tag, here<a name='2875'>
    integer :: ierr,me,size<a name='2876'>
<a name='2877'>
    integer, pointer :: nexttags(:)<a name='2878'>
    integer, target :: dummy(1)<a name='2879'>
    character(255) :: message<a name='2880'>
    integer(kind=4) :: comm4,hashed<a name='2881'>
<a name='2882'>
    integer, parameter :: hashsize = 113 <font color=#447700>! should be prime, &gt;max_servers+1<a name='2883'></font>
    integer, parameter :: tagloop = 100000 <font color=#447700>! number of tags reserved per communicator<a name='2884'></font>
    integer, parameter :: origin = 1031102 <font color=#447700>! lowest tag number we'll use<a name='2885'></font>
    integer, save :: nexttag=origin <font color=#447700>! next tag to use for a new communicator<a name='2886'></font>
    integer, save :: comms(hashsize)=-1, firsttag(hashsize)=0, curtag(hashsize)=0<a name='2887'>
<a name='2888'>
    <font color=#447700>! If integers are not four bytes, this implementation will still<a name='2889'></font>
    <font color=#447700>! work, but it may be inefficient (O(N) lookup instead of O(1)).<a name='2890'></font>
    <font color=#447700>! To fix that, an eight byte hash function would be needed, but<a name='2891'></font>
    <font color=#447700>! integers are four bytes in WRF, so that is not a problem right<a name='2892'></font>
    <font color=#447700>! now.<a name='2893'></font>
<a name='2894'>
    comm4=comm<a name='2895'>
    call int_hash(comm4,hashed)<a name='2896'>
    hashed=mod(abs(hashed),hashsize)+1<a name='2897'>
    if(hashed&lt;0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_283">('hashed&lt;0')<a name='2898'>
<a name='2899'>
    do i=0,hashsize-1<a name='2900'>
       j=1+mod(i+hashed-1,hashsize)<a name='2901'>
<a name='2902'>
       if(firsttag(j)/=0 .and. comms(j)==comm) then<a name='2903'>
          <font color=#447700>! Found the communicator<a name='2904'></font>
          if(curtag(j)-firsttag(j) &gt;= tagloop) then<a name='2905'>
             <font color=#447700>! Hit the max tag number so we need to reset.<a name='2906'></font>
             <font color=#447700>! To make sure &gt;tagloop reduces don't happen <a name='2907'></font>
             <font color=#447700>! before someone finishes an old reduce, we <a name='2908'></font>
             <font color=#447700>! have an MPI_Barrier here.<a name='2909'></font>
             <font color=#447700>!call wrf_message('Hit tagloop limit so calling mpi_barrier in get_reduce_tag...')<a name='2910'></font>
             call mpi_barrier(comm,ierr)<a name='2911'>
             if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_284">('cannot call mpi_barrier')<a name='2912'>
             <font color=#447700>!call wrf_message('  ...back from mpi_barrier in get_reduce_tag.')<a name='2913'></font>
<a name='2914'>
             curtag(j)=firsttag(j)<a name='2915'>
          endif<a name='2916'>
<a name='2917'>
          tag=curtag(j)<a name='2918'>
          curtag(j)=tag+1<a name='2919'>
          get_reduce_tag=tag<a name='2920'>
          return<a name='2921'>
       endif<a name='2922'>
    enddo<a name='2923'>
<a name='2924'>
<a name='2925'>
    <font color=#447700>! ==================== HANDLE NEW COMMUNICATORS ====================<a name='2926'></font>
<a name='2927'>
    <font color=#447700>!write(message,'("Found a new communicator ",I0," in get_reduce_tag, so making a tag range for it")') comm<a name='2928'></font>
<a name='2929'>
    <font color=#447700>! If we get here, the communicator is new to us, so we need<a name='2930'></font>
    <font color=#447700>! to add it to the hash and give it a new tag.  <a name='2931'></font>
<a name='2932'>
    <font color=#447700>! First, figure out where we'll put the tag in the hashtable<a name='2933'></font>
    here=-1<a name='2934'>
    do i=0,hashsize-1<a name='2935'>
       j=1+mod(i+hashed-1,hashsize)<a name='2936'>
<a name='2937'>
       if(firsttag(j)==0) then<a name='2938'>
          here=j<a name='2939'>
          exit<a name='2940'>
       endif<a name='2941'>
    enddo<a name='2942'>
    if(here==-1) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_285">('no room in hashtable; increase hashsize in get_reduce_tag (should be &gt;max_servers+1)')<a name='2943'>
<a name='2944'>
    <font color=#447700>! Now, find out the new tag's number.  To do this, we need to<a name='2945'></font>
    <font color=#447700>! get the next tag number that is not used by any ranks.<a name='2946'></font>
<a name='2947'>
    call mpi_comm_rank(comm,me,ierr)<a name='2948'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_286">('cannot call mpi_comm_rank')<a name='2949'>
<a name='2950'>
    call mpi_comm_size(comm,size,ierr)<a name='2951'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_287">('cannot call mpi_comm_size')<a name='2952'>
<a name='2953'>
    if(me==root) then<a name='2954'>
       allocate(nexttags(size))<a name='2955'>
    else<a name='2956'>
       nexttags=&gt;dummy<a name='2957'>
    endif<a name='2958'>
<a name='2959'>
    call mpi_gather(nexttag,1,MPI_INTEGER,nexttags,1,MPI_INTEGER,root,comm,ierr)<a name='2960'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_288">('cannot call mpi_gather')<a name='2961'>
<a name='2962'>
    if(me==root) then<a name='2963'>
       nexttag=max(nexttag,maxval(nexttags))<a name='2964'>
       deallocate(nexttags)<a name='2965'>
    endif<a name='2966'>
    call mpi_bcast(nexttag,1,MPI_INTEGER,root,comm,ierr)<a name='2967'>
<a name='2968'>
    comms(here)=comm<a name='2969'>
    firsttag(here)=nexttag<a name='2970'>
    curtag(here)=nexttag<a name='2971'>
    get_reduce_tag=nexttag<a name='2972'>
<a name='2973'>
    <font color=#447700>!write(message,'("Stored comm ",I0," with tag ",I0,"=",I0," in hash element ",I0)') &amp;<a name='2974'></font>
    <font color=#447700>!     comms(here),firsttag(here),curtag(here),here<a name='2975'></font>
    <font color=#447700>!call wrf_message(message)<a name='2976'></font>
<a name='2977'>
    nexttag=nexttag+tagloop<a name='2978'>
<a name='2979'>
  end function get_reduce_tag<a name='2980'>
<A NAME='REDUCE_ADD_INT_SCL'><A href='../../html_code/frame/module_io_quilt_new.F.html#REDUCE_ADD_INT_SCL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2981'>
  <font color=#993300>subroutine </font><font color=#cc0000>reduce_add_int_scl</font>(send,recv,count,root,comm) <A href='../../call_to/REDUCE_ADD_INT_SCL.html' TARGET='index'>2</A>,<A href='../../call_from/REDUCE_ADD_INT_SCL.html' TARGET='index'>14</A><a name='2982'>
    implicit none<a name='2983'>
    include 'mpif.h'<a name='2984'>
    integer, intent(in) :: count,root,comm<a name='2985'>
    integer, intent(inout) :: recv<a name='2986'>
    integer, intent(in) :: send<a name='2987'>
    integer :: me, size, ierr, you, temp, tag<a name='2988'>
    character*255 :: message<a name='2989'>
    if(root&lt;0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_289">('root is less than 0')<a name='2990'>
<a name='2991'>
    tag=<A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG'>get_reduce_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_REDUCE_TAG_1">(root,comm)<a name='2992'>
<a name='2993'>
    <font color=#447700>!write(message,'("Send/recv to tag ",I0)') tag<a name='2994'></font>
    <font color=#447700>!call wrf_message(message)<a name='2995'></font>
<a name='2996'>
    call mpi_comm_rank(comm,me,ierr)<a name='2997'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_290">('cannot call mpi_comm_rank')<a name='2998'>
<a name='2999'>
    call mpi_comm_size(comm,size,ierr)<a name='3000'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_291">('cannot call mpi_comm_size')<a name='3001'>
<a name='3002'>
    if(root&gt;=size) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_292">('root is beyond highest communicator rank')<a name='3003'>
<a name='3004'>
    if(me==root) then<a name='3005'>
       recv=send<a name='3006'>
       do you=0,size-2<a name='3007'>
          call mpi_recv(temp,1,MPI_INTEGER,MPI_ANY_SOURCE,tag,comm,MPI_STATUS_IGNORE,ierr)<a name='3008'>
          if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_293">('error calling mpi_recv')<a name='3009'>
          recv=recv+temp<a name='3010'>
       enddo<a name='3011'>
    else<a name='3012'>
       call mpi_send(send,1,MPI_INTEGER,root,tag,comm,ierr)<a name='3013'>
       if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_294">('error calling mpi_send')<a name='3014'>
    endif<a name='3015'>
  end subroutine reduce_add_int_scl<a name='3016'>
<A NAME='REDUCE_ADD_INT_ARR'><A href='../../html_code/frame/module_io_quilt_new.F.html#REDUCE_ADD_INT_ARR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3017'>
  <font color=#993300>subroutine </font><font color=#cc0000>reduce_add_int_arr</font>(sendbuf,recvbuf,count,root,comm) <A href='../../call_to/REDUCE_ADD_INT_ARR.html' TARGET='index'>2</A>,<A href='../../call_from/REDUCE_ADD_INT_ARR.html' TARGET='index'>14</A><a name='3018'>
    implicit none<a name='3019'>
    include 'mpif.h'<a name='3020'>
    integer, intent(in) :: count,root,comm<a name='3021'>
    integer, intent(in) :: sendbuf(count)<a name='3022'>
    integer, intent(inout) :: recvbuf(count)<a name='3023'>
    integer :: me, size, ierr, you, tempbuf(count), tag<a name='3024'>
    character*255 :: message<a name='3025'>
<a name='3026'>
    if(root&lt;0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_295">('root is less than 0')<a name='3027'>
<a name='3028'>
    tag=<A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG'>get_reduce_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_REDUCE_TAG_2">(root,comm)<a name='3029'>
<a name='3030'>
    <font color=#447700>!write(message,'("Send/recv to tag ",I0)') tag<a name='3031'></font>
    <font color=#447700>!call wrf_message(message)<a name='3032'></font>
<a name='3033'>
    call mpi_comm_rank(comm,me,ierr)<a name='3034'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_296">('cannot call mpi_comm_rank')<a name='3035'>
<a name='3036'>
    call mpi_comm_size(comm,size,ierr)<a name='3037'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_297">('cannot call mpi_comm_size')<a name='3038'>
<a name='3039'>
    if(root&gt;=size) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_298">('root is beyond highest communicator rank')<a name='3040'>
<a name='3041'>
    if(me==root) then<a name='3042'>
       recvbuf=sendbuf<a name='3043'>
       do you=0,size-2<a name='3044'>
          call mpi_recv(tempbuf,count,MPI_INTEGER,MPI_ANY_SOURCE,tag,comm,MPI_STATUS_IGNORE,ierr)<a name='3045'>
          if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_299">('error calling mpi_recv')<a name='3046'>
          recvbuf=recvbuf+tempbuf<a name='3047'>
       enddo<a name='3048'>
    else<a name='3049'>
       call mpi_send(sendbuf,count,MPI_INTEGER,root,tag,comm,ierr)<a name='3050'>
       if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_300">('error calling mpi_send')<a name='3051'>
    endif<a name='3052'>
  end subroutine reduce_add_int_arr<a name='3053'>
#endif<a name='3054'>
<a name='3055'>
<a name='3056'>
END MODULE module_wrf_quilt<a name='3057'>
<a name='3058'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3059'></font>
<font color=#447700>! Remaining routines in this file are defined outside of the module<a name='3060'></font>
<font color=#447700>! either to defeat arg/param type checking or to avoid an explicit use<a name='3061'></font>
<font color=#447700>! dependence.<a name='3062'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3063'></font>
<a name='3064'>
<A NAME='DISABLE_QUILTING'><A href='../../html_code/frame/module_io_quilt_new.F.html#DISABLE_QUILTING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3065'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>disable_quilting</font> <A href='../../call_to/DISABLE_QUILTING.html' TARGET='index'>7</A>,<A href='../../call_from/DISABLE_QUILTING.html' TARGET='index'>5</A><a name='3066'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3067'></font>
<font color=#447700>! Call this in programs that you never want to be quilting (e.g. real)<a name='3068'></font>
<font color=#447700>! Must call before call to init_module_wrf_quilt().  <a name='3069'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3070'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_1"><a name='3071'>
  disable_quilt = .TRUE.<a name='3072'>
  RETURN<a name='3073'>
END SUBROUTINE disable_quilting<a name='3074'>
<a name='3075'>
<A NAME='USE_OUTPUT_SERVERS_FOR'><A href='../../html_code/frame/module_io_quilt_new.F.html#USE_OUTPUT_SERVERS_FOR' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3076'>
LOGICAL <font color=#993300>FUNCTION  </font><font color=#cc0000>use_output_servers_for</font>(ioform)<a name='3077'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3078'></font>
<font color=#447700>! Returns .TRUE. if I/O quilt servers are in-use for write operations<a name='3079'></font>
<font color=#447700>! AND the output servers can handle the given I/O form.  If the I/O<a name='3080'></font>
<font color=#447700>! form is 0, then the io form is not considered and the result is the<a name='3081'></font>
<font color=#447700>! same as calling use_output_servers.<a name='3082'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3083'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3084'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_2"><a name='3085'>
  integer, intent(in) :: ioform<a name='3086'>
  use_output_servers_for = quilting_enabled<a name='3087'>
  use_output_servers_for = ( use_output_servers_for .and. ioform&lt;100 )<a name='3088'>
  RETURN<a name='3089'>
END FUNCTION use_output_servers_for<a name='3090'>
<a name='3091'>
<A NAME='USE_OUTPUT_SERVERS'><A href='../../html_code/frame/module_io_quilt_new.F.html#USE_OUTPUT_SERVERS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3092'>
LOGICAL <font color=#993300>FUNCTION  </font><font color=#cc0000>use_output_servers</font>()<a name='3093'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3094'></font>
<font color=#447700>! Returns .TRUE. if I/O quilt servers are in-use for write operations.<a name='3095'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3096'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3097'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_3"><a name='3098'>
  use_output_servers = quilting_enabled<a name='3099'>
  RETURN<a name='3100'>
END FUNCTION use_output_servers<a name='3101'>
<a name='3102'>
<A NAME='USE_INPUT_SERVERS'><A href='../../html_code/frame/module_io_quilt_new.F.html#USE_INPUT_SERVERS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='3103'>
LOGICAL <font color=#993300>FUNCTION  </font><font color=#cc0000>use_input_servers</font>()<a name='3104'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3105'></font>
<font color=#447700>! Returns .TRUE. if I/O quilt servers are in-use for read operations.<a name='3106'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3107'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3108'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_4"><a name='3109'>
  use_input_servers = .FALSE.<a name='3110'>
  RETURN<a name='3111'>
END FUNCTION use_input_servers<a name='3112'>
<a name='3113'>
<A NAME='WRF_QUILT_OPEN_FOR_WRITE_BEGIN'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3114'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_open_for_write_begin</font>( FileName , gridid, Comm_compute, Comm_io, SysDepInfo, &amp; <A href='../../call_to/WRF_QUILT_OPEN_FOR_WRITE_BEGIN.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_QUILT_OPEN_FOR_WRITE_BEGIN.html' TARGET='index'>20</A><a name='3115'>
                                     DataHandle , io_form_arg, Status )<a name='3116'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3117'></font>
<font color=#447700>! Instruct the I/O quilt servers to begin data definition ("training") phase<a name='3118'></font>
<font color=#447700>! for writing to WRF dataset FileName.  io_form_arg indicates file format.<a name='3119'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3120'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3121'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3122'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_5"><a name='3123'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_92">, ONLY: IO_PNETCDF<a name='3124'>
  IMPLICIT NONE<a name='3125'>
  INCLUDE 'mpif.h'<a name='3126'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_7"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3127'>
  CHARACTER *(*), INTENT(IN)  :: FileName<a name='3128'>
  INTEGER ,       INTENT(IN)  :: gridid<a name='3129'>
  INTEGER ,       INTENT(IN)  :: Comm_compute , Comm_io<a name='3130'>
  CHARACTER *(*), INTENT(IN)  :: SysDepInfo<a name='3131'>
  INTEGER ,       INTENT(OUT) :: DataHandle<a name='3132'>
  INTEGER ,       INTENT(IN)  :: io_form_arg<a name='3133'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3134'>
<font color=#447700>! Local<a name='3135'></font>
  CHARACTER*132   :: locFileName, locSysDepInfo<a name='3136'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group<a name='3137'>
  REAL dummy<a name='3138'>
  INTEGER, EXTERNAL :: use_package<a name='3139'>
<a name='3140'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_265"> ( DEBUG_LVL, 'in wrf_quilt_open_for_write_begin' ) <a name='3141'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#INT_GET_FRESH_HANDLE'>int_get_fresh_handle</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_FRESH_HANDLE_3">(i)<a name='3142'>
  okay_to_write(i) = .false.<a name='3143'>
  DataHandle = i<a name='3144'>
<a name='3145'>
  locFileName = FileName<a name='3146'>
  locSysDepInfo = SysDepInfo<a name='3147'>
<a name='3148'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3149'>
<a name='3150'>
  SELECT CASE(use_package(io_form_arg))<a name='3151'>
<a name='3152'>
#ifdef PNETCDF_QUILT<a name='3153'>
  CASE(IO_PNETCDF)<a name='3154'>
     IF(compute_group_master(1,current_id)) THEN<a name='3155'>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_OFWB_HEADER'>int_gen_ofwb_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_OFWB_HEADER_1">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3156'>
                                  locFileName,locSysDepInfo,io_form_arg,&amp;<a name='3157'>
                                  DataHandle )<a name='3158'>
     ELSE<a name='3159'>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_1">( hdrbuf, hdrbufsize, itypesize )<a name='3160'>
     END IF<a name='3161'>
#endif<a name='3162'>
  CASE DEFAULT<a name='3163'>
<a name='3164'>
     IF ( wrf_dm_on_monitor() ) THEN<a name='3165'>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_OFWB_HEADER'>int_gen_ofwb_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_OFWB_HEADER_2">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3166'>
                                  locFileName,locSysDepInfo,io_form_arg,DataHandle )<a name='3167'>
     ELSE<a name='3168'>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_2">( hdrbuf, hdrbufsize, itypesize )<a name='3169'>
     ENDIF<a name='3170'>
<a name='3171'>
  END SELECT<a name='3172'>
<a name='3173'>
  which_grid_is_handle(DataHandle) = gridid<a name='3174'>
  iserver = get_server_id ( DataHandle )<a name='3175'>
<font color=#447700>!write(0,*)'wrf_quilt_open_for_write_begin DataHandle = ', DataHandle<a name='3176'></font>
<font color=#447700>!write(0,*)'wrf_quilt_open_for_write_begin filename = ', Trim(filename)<a name='3177'></font>
<font color=#447700>!write(0,*)'wrf_quilt_open_for_write_begin sysdepinfo = ', Trim(sysdepinfo)<a name='3178'></font>
<font color=#447700>!write(0,*)'wrf_quilt_open_for_write_begin iserver = ', iserver<a name='3179'></font>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_1">( comm_io_group , iserver )<a name='3180'>
<font color=#447700>!write(0,*)'wrf_quilt_open_for_write_begin comm_io_group  = ', comm_io_group <a name='3181'></font>
<a name='3182'>
  CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3183'>
<font color=#447700>!write(0,*)'mpi_x_comm_size tasks_in_group ',tasks_in_group, ierr<a name='3184'></font>
<a name='3185'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3186'></font>
  <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3187'></font>
  reduced = 0<a name='3188'>
  reduced(1) = hdrbufsize <a name='3189'>
#ifdef PNETCDF_QUILT<a name='3190'>
  IF ( compute_group_master(1,current_id) ) reduced(2) = i<a name='3191'>
#else<a name='3192'>
  IF ( wrf_dm_on_monitor() )  reduced(2) = i <a name='3193'>
#endif<a name='3194'>
<font color=#447700>!write(0,*)'calling mpi_x_reduce in wrf_quilt_open_for_write_begin '<a name='3195'></font>
  CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3196'>
<font color=#447700>!!JMTIMING   CALL end_timing("MPI_Reduce in wrf_quilt_open_for_write_begin")<a name='3197'></font>
<a name='3198'>
  <font color=#447700>! send data to the i/o processor<a name='3199'></font>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_3">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3200'>
                        onebyte,                       &amp;<a name='3201'>
                        hdrbuf, hdrbufsize , &amp;<a name='3202'>
                        dummy, 0 )<a name='3203'>
<a name='3204'>
  Status = 0<a name='3205'>
<a name='3206'>
<a name='3207'>
#endif<a name='3208'>
  RETURN  <a name='3209'>
END SUBROUTINE wrf_quilt_open_for_write_begin<a name='3210'>
<a name='3211'>
<A NAME='WRF_QUILT_OPEN_FOR_WRITE_COMMIT'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3212'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_open_for_write_commit</font>( DataHandle , Status ) <A href='../../call_to/WRF_QUILT_OPEN_FOR_WRITE_COMMIT.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_OPEN_FOR_WRITE_COMMIT.html' TARGET='index'>16</A><a name='3213'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3214'></font>
<font color=#447700>! Instruct the I/O quilt servers to switch an internal flag to enable output<a name='3215'></font>
<font color=#447700>! for the dataset referenced by DataHandle.  The call to<a name='3216'></font>
<font color=#447700>! wrf_quilt_open_for_write_commit() must be paired with a call to<a name='3217'></font>
<font color=#447700>! wrf_quilt_open_for_write_begin().<a name='3218'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3219'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3220'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3221'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_6"><a name='3222'>
  IMPLICIT NONE<a name='3223'>
  INCLUDE 'mpif.h'<a name='3224'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_8"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3225'>
  INTEGER ,       INTENT(IN ) :: DataHandle<a name='3226'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3227'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group<a name='3228'>
  REAL dummy<a name='3229'>
<a name='3230'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_266"> ( DEBUG_LVL, 'in wrf_quilt_open_for_write_commit' ) <a name='3231'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3232'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3233'>
      okay_to_write( DataHandle ) = .true.<a name='3234'>
    ENDIF<a name='3235'>
  ENDIF<a name='3236'>
<a name='3237'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3238'>
<a name='3239'>
#ifdef PNETCDF_QUILT<a name='3240'>
<font color=#447700>!ARP Only want one command to be received by each IO server when using<a name='3241'></font>
<font color=#447700>!ARP parallel IO<a name='3242'></font>
  IF(compute_group_master(1,current_id)) THEN<a name='3243'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_3">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3244'>
                                 DataHandle, int_open_for_write_commit )<a name='3245'>
  ELSE<a name='3246'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_3">( hdrbuf, hdrbufsize, itypesize )<a name='3247'>
  END IF<a name='3248'>
#else<a name='3249'>
<a name='3250'>
  IF ( wrf_dm_on_monitor() ) THEN<a name='3251'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_4">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3252'>
                                 DataHandle, int_open_for_write_commit )<a name='3253'>
  ELSE<a name='3254'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_4">( hdrbuf, hdrbufsize, itypesize )<a name='3255'>
  ENDIF<a name='3256'>
#endif<a name='3257'>
<a name='3258'>
  iserver = get_server_id ( DataHandle )<a name='3259'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_2">( comm_io_group , iserver )<a name='3260'>
<a name='3261'>
  CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3262'>
<a name='3263'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3264'></font>
  <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3265'></font>
  reduced = 0<a name='3266'>
  reduced(1) = hdrbufsize <a name='3267'>
#ifdef PNETCDF_QUILT<a name='3268'>
  IF ( compute_group_master(1,current_id) ) reduced(2) = DataHandle<a name='3269'>
#else<a name='3270'>
  IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3271'>
#endif<a name='3272'>
  CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3273'>
<font color=#447700>!!JMTIMING   CALL end_timing("MPI_Reduce in wrf_quilt_open_for_write_commit")<a name='3274'></font>
<a name='3275'>
  <font color=#447700>! send data to the i/o processor<a name='3276'></font>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_4">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3277'>
                        onebyte,                       &amp;<a name='3278'>
                        hdrbuf, hdrbufsize , &amp;<a name='3279'>
                        dummy, 0 )<a name='3280'>
<a name='3281'>
  Status = 0<a name='3282'>
<a name='3283'>
#endif<a name='3284'>
  RETURN  <a name='3285'>
END SUBROUTINE wrf_quilt_open_for_write_commit<a name='3286'>
<a name='3287'>
<A NAME='WRF_QUILT_OPEN_FOR_READ'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_OPEN_FOR_READ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3288'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_open_for_read</font> ( FileName , Comm_compute, Comm_io, SysDepInfo, &amp;,<A href='../../call_from/WRF_QUILT_OPEN_FOR_READ.html' TARGET='index'>4</A><a name='3289'>
                               DataHandle , Status )<a name='3290'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3291'></font>
<font color=#447700>! Instruct the I/O quilt servers to open WRF dataset FileName for reading.<a name='3292'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3293'></font>
<font color=#447700>! This is not yet supported.<a name='3294'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3295'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3296'></font>
  IMPLICIT NONE<a name='3297'>
  CHARACTER *(*), INTENT(IN)  :: FileName<a name='3298'>
  INTEGER ,       INTENT(IN)  :: Comm_compute , Comm_io<a name='3299'>
  CHARACTER *(*), INTENT(IN)  :: SysDepInfo<a name='3300'>
  INTEGER ,       INTENT(OUT) :: DataHandle<a name='3301'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3302'>
<a name='3303'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_READ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_267"> ( DEBUG_LVL, 'in wrf_quilt_open_for_read' ) <a name='3304'>
  DataHandle = -1<a name='3305'>
  Status = -1<a name='3306'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_READ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_301"> ( "frame/module_io_quilt.F: wrf_quilt_open_for_read not yet supported" )<a name='3307'>
#endif<a name='3308'>
  RETURN  <a name='3309'>
END SUBROUTINE wrf_quilt_open_for_read<a name='3310'>
<a name='3311'>
<A NAME='WRF_QUILT_INQUIRE_OPENED'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_INQUIRE_OPENED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3312'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_inquire_opened</font> ( DataHandle, FileName , FileStatus, Status ) <A href='../../call_to/WRF_QUILT_INQUIRE_OPENED.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_INQUIRE_OPENED.html' TARGET='index'>4</A><a name='3313'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3314'></font>
<font color=#447700>! Inquire if the dataset referenced by DataHandle is open.<a name='3315'></font>
<font color=#447700>! Does not require communication with I/O servers.<a name='3316'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3317'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3318'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3319'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_OPENED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_7"><a name='3320'>
  IMPLICIT NONE<a name='3321'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_9"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_OPENED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3322'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3323'>
  CHARACTER *(*), INTENT(IN)  :: FileName<a name='3324'>
  INTEGER ,       INTENT(OUT) :: FileStatus<a name='3325'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3326'>
<a name='3327'>
  Status = 0<a name='3328'>
<a name='3329'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_OPENED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_268"> ( DEBUG_LVL, 'in wrf_quilt_inquire_opened' ) <a name='3330'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3331'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3332'>
      IF ( okay_to_write( DataHandle ) ) THEN<a name='3333'>
        FileStatus = WRF_FILE_OPENED_FOR_WRITE<a name='3334'>
      ENDIF<a name='3335'>
    ENDIF<a name='3336'>
  ENDIF<a name='3337'>
  Status = 0<a name='3338'>
  <a name='3339'>
#endif<a name='3340'>
  RETURN<a name='3341'>
END SUBROUTINE wrf_quilt_inquire_opened<a name='3342'>
<a name='3343'>
<A NAME='WRF_QUILT_INQUIRE_FILENAME'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_INQUIRE_FILENAME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3344'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_inquire_filename</font> ( DataHandle, FileName , FileStatus, Status ) <A href='../../call_to/WRF_QUILT_INQUIRE_FILENAME.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_INQUIRE_FILENAME.html' TARGET='index'>4</A><a name='3345'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3346'></font>
<font color=#447700>! Return the Filename and FileStatus associated with DataHandle.<a name='3347'></font>
<font color=#447700>! Does not require communication with I/O servers.<a name='3348'></font>
<font color=#447700>!<a name='3349'></font>
<font color=#447700>! Note that the current implementation does not actually return FileName.<a name='3350'></font>
<font color=#447700>! Currenlty, WRF does not use this returned value.  Fixing this would simply<a name='3351'></font>
<font color=#447700>! require saving the file names on the client tasks in an array similar to<a name='3352'></font>
<font color=#447700>! okay_to_write().<a name='3353'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3354'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3355'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3356'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_FILENAME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_8"><a name='3357'>
  IMPLICIT NONE<a name='3358'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_10"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_FILENAME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3359'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3360'>
  CHARACTER *(*), INTENT(OUT) :: FileName<a name='3361'>
  INTEGER ,       INTENT(OUT) :: FileStatus<a name='3362'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3363'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_FILENAME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_269"> ( DEBUG_LVL, 'in wrf_quilt_inquire_filename' ) <a name='3364'>
  Status = 0<a name='3365'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3366'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3367'>
      IF ( okay_to_write( DataHandle ) ) THEN<a name='3368'>
        FileStatus = WRF_FILE_OPENED_FOR_WRITE<a name='3369'>
      ELSE<a name='3370'>
        FileStatus = WRF_FILE_OPENED_NOT_COMMITTED<a name='3371'>
      ENDIF<a name='3372'>
    ELSE<a name='3373'>
        FileStatus = WRF_FILE_NOT_OPENED<a name='3374'>
    ENDIF<a name='3375'>
    Status = 0<a name='3376'>
    FileName = "bogusfornow"<a name='3377'>
  ELSE<a name='3378'>
    Status = -1<a name='3379'>
  ENDIF<a name='3380'>
#endif<a name='3381'>
  RETURN<a name='3382'>
END SUBROUTINE wrf_quilt_inquire_filename<a name='3383'>
<a name='3384'>
<A NAME='WRF_QUILT_IOSYNC'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_IOSYNC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3385'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_iosync</font> ( DataHandle, Status ) <A href='../../call_to/WRF_QUILT_IOSYNC.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_IOSYNC.html' TARGET='index'>12</A><a name='3386'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3387'></font>
<font color=#447700>! Instruct the I/O quilt servers to synchronize the disk copy of a dataset<a name='3388'></font>
<font color=#447700>! with memory buffers.<a name='3389'></font>
<font color=#447700>!<a name='3390'></font>
<font color=#447700>! After the "iosync" header (request) is sent to the I/O quilt server,<a name='3391'></font>
<font color=#447700>! the compute tasks will then send the entire contents (headers and data) of<a name='3392'></font>
<font color=#447700>! int_local_output_buffer to their I/O quilt server.  This communication is<a name='3393'></font>
<font color=#447700>! done in subroutine send_to_io_quilt_servers().  After the I/O quilt servers<a name='3394'></font>
<font color=#447700>! receive this data, they will write all accumulated fields to disk.<a name='3395'></font>
<font color=#447700>!<a name='3396'></font>
<font color=#447700>! Significant time may be required for the I/O quilt servers to organize<a name='3397'></font>
<font color=#447700>! fields and write them to disk.  Therefore, the "iosync" request should be<a name='3398'></font>
<font color=#447700>! sent only when the compute tasks are ready to run for a while without<a name='3399'></font>
<font color=#447700>! needing to communicate with the servers.  Otherwise, the compute tasks<a name='3400'></font>
<font color=#447700>! will end up waiting for the servers to finish writing to disk, thus wasting<a name='3401'></font>
<font color=#447700>! any performance benefits of having servers at all.<a name='3402'></font>
<font color=#447700>!<a name='3403'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3404'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3405'></font>
#if  defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined (STUBMPI) <a name='3406'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_9"><a name='3407'>
  IMPLICIT NONE<a name='3408'>
  include "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_11"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3409'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3410'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3411'>
<a name='3412'>
  INTEGER locsize , itypesize<a name='3413'>
  INTEGER ierr, tasks_in_group, comm_io_group, dummy, i, rank<a name='3414'>
<a name='3415'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_270"> ( DEBUG_LVL, 'in wrf_quilt_iosync' ) <a name='3416'>
<a name='3417'>
<font color=#447700>!  CALL start_timing<a name='3418'></font>
  IF ( associated ( int_local_output_buffer ) ) THEN<a name='3419'>
<a name='3420'>
    iserver = get_server_id ( DataHandle )<a name='3421'>
    CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_3">( comm_io_group , iserver )<a name='3422'>
<a name='3423'>
    CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3424'>
<a name='3425'>
    locsize = int_num_bytes_to_write(DataHandle)<a name='3426'>
<a name='3427'>
<font color=#447700>!    CALL start_timing<a name='3428'></font>
    <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3429'></font>
    reduced = 0<a name='3430'>
    reduced(1) = locsize <a name='3431'>
#ifdef PNETCDF_QUILT<a name='3432'>
<font color=#447700>! ARP Only want one command per IOServer if doing parallel IO<a name='3433'></font>
    IF ( compute_group_master(1,current_id) ) reduced(2) = DataHandle<a name='3434'>
#else<a name='3435'>
    IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3436'>
#endif<a name='3437'>
    CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3438'>
<font color=#447700>!    CALL end_timing("MPI_Reduce in wrf_quilt_iosync")<a name='3439'></font>
<a name='3440'>
    <font color=#447700>! send data to the i/o processor<a name='3441'></font>
#ifdef DEREF_KLUDGE<a name='3442'>
    CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_5">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3443'>
                          onebyte,                       &amp;<a name='3444'>
                          int_local_output_buffer(1), locsize , &amp;<a name='3445'>
                          dummy, 0 )<a name='3446'>
#else<a name='3447'>
    CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_6">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3448'>
                          onebyte,                       &amp;<a name='3449'>
                          int_local_output_buffer, locsize , &amp;<a name='3450'>
                          dummy, 0 )<a name='3451'>
#endif<a name='3452'>
<a name='3453'>
    int_local_output_cursor = 1<a name='3454'>
<font color=#447700>!    int_num_bytes_to_write(DataHandle) = 0<a name='3455'></font>
    DEALLOCATE ( int_local_output_buffer )<a name='3456'>
    NULLIFY ( int_local_output_buffer )<a name='3457'>
  ELSE<a name='3458'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_344"> ("frame/module_io_quilt.F: wrf_quilt_iosync: no buffer allocated")<a name='3459'>
  ENDIF<a name='3460'>
<font color=#447700>!  CALL end_timing("wrf_quilt_iosync")<a name='3461'></font>
  Status = 0<a name='3462'>
#endif<a name='3463'>
  RETURN<a name='3464'>
END SUBROUTINE wrf_quilt_iosync<a name='3465'>
<a name='3466'>
<A NAME='WRF_QUILT_IOCLOSE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_IOCLOSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3467'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_ioclose</font> ( DataHandle, Status ) <A href='../../call_to/WRF_QUILT_IOCLOSE.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_IOCLOSE.html' TARGET='index'>20</A><a name='3468'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3469'></font>
<font color=#447700>! Instruct the I/O quilt servers to close the dataset referenced by<a name='3470'></font>
<font color=#447700>! DataHandle.<a name='3471'></font>
<font color=#447700>! This routine also clears the client file handle and, if needed, deallocates<a name='3472'></font>
<font color=#447700>! int_local_output_buffer.<a name='3473'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3474'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3475'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined( STUBMPI) <a name='3476'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_10"><a name='3477'>
  USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_27"><a name='3478'>
  IMPLICIT NONE<a name='3479'>
  INCLUDE 'mpif.h'<a name='3480'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_12"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3481'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3482'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3483'>
  INTEGER i, itypesize, tasks_in_group, comm_io_group, ierr<a name='3484'>
  REAL dummy<a name='3485'>
<a name='3486'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3487'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_271"> ( DEBUG_LVL, 'in wrf_quilt_ioclose' ) <a name='3488'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3489'>
<a name='3490'>
<font color=#447700>! If we're using pnetcdf then each IO server will need to receive the <a name='3491'></font>
<font color=#447700>! handle just once as there is<a name='3492'></font>
<font color=#447700>! no longer a reduce over the IO servers to get it.<a name='3493'></font>
#ifdef PNETCDF_QUILT<a name='3494'>
  IF ( compute_group_master(1,current_id) )THEN<a name='3495'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_5">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3496'>
                                 DataHandle, int_ioclose )<a name='3497'>
  ELSE<a name='3498'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_5">( hdrbuf, hdrbufsize, itypesize )<a name='3499'>
  ENDIF<a name='3500'>
#else<a name='3501'>
  IF ( wrf_dm_on_monitor() ) THEN<a name='3502'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_6">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3503'>
                                 DataHandle , int_ioclose )<a name='3504'>
  ELSE<a name='3505'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_6">( hdrbuf, hdrbufsize, itypesize )<a name='3506'>
  ENDIF<a name='3507'>
#endif<a name='3508'>
<a name='3509'>
  iserver = get_server_id ( DataHandle )<a name='3510'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_4">( comm_io_group , iserver )<a name='3511'>
<a name='3512'>
  CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3513'>
<a name='3514'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3515'></font>
  <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3516'></font>
  reduced = 0<a name='3517'>
#ifdef PNETCDF_QUILT<a name='3518'>
<font color=#447700>! If we're using pnetcdf then each IO server will need the handle as there is<a name='3519'></font>
<font color=#447700>! no longer a reduce over the IO servers to get it.<a name='3520'></font>
  IF ( compute_group_master(1,current_id) ) reduced(2) = DataHandle<a name='3521'>
#else<a name='3522'>
  IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3523'>
#endif<a name='3524'>
  CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3525'>
<font color=#447700>!!JMTIMING   CALL end_timing("MPI_Reduce in ioclose")<a name='3526'></font>
<a name='3527'>
#if 0<a name='3528'>
  <font color=#447700>! send data to the i/o processor<a name='3529'></font>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3530'></font>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_7">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3531'>
                        onebyte,                       &amp;<a name='3532'>
                        hdrbuf, hdrbufsize , &amp;<a name='3533'>
                        dummy, 0 )<a name='3534'>
<font color=#447700>!!JMTIMING   CALL end_timing("collect_on_comm in io_close")<a name='3535'></font>
#endif<a name='3536'>
<a name='3537'>
  int_handle_in_use(DataHandle) = .false.<a name='3538'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#SET_SERVER_ID'>set_server_id</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SERVER_ID_1">( DataHandle, 0 ) <a name='3539'>
  okay_to_write(DataHandle) = .false.<a name='3540'>
  okay_to_commit(DataHandle) = .false.<a name='3541'>
  int_local_output_cursor = 1<a name='3542'>
  int_num_bytes_to_write(DataHandle) = 0<a name='3543'>
  IF ( associated ( int_local_output_buffer ) ) THEN<a name='3544'>
    DEALLOCATE ( int_local_output_buffer )<a name='3545'>
    NULLIFY ( int_local_output_buffer )<a name='3546'>
  ENDIF<a name='3547'>
<a name='3548'>
  Status = 0<a name='3549'>
<font color=#447700>!!JMTIMING   CALL end_timing( "wrf_quilt_ioclose" )<a name='3550'></font>
<a name='3551'>
#endif<a name='3552'>
  RETURN<a name='3553'>
END SUBROUTINE wrf_quilt_ioclose<a name='3554'>
<a name='3555'>
<A NAME='WRF_QUILT_IOEXIT'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_IOEXIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3556'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_ioexit</font>( Status ) <A href='../../call_to/WRF_QUILT_IOEXIT.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_IOEXIT.html' TARGET='index'>16</A><a name='3557'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3558'></font>
<font color=#447700>! Instruct the I/O quilt servers to shut down the WRF I/O system.<a name='3559'></font>
<font color=#447700>! Do not call any wrf_quilt_*() routines after this routine has been called.<a name='3560'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3561'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3562'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined (STUBMPI ) <a name='3563'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_11"><a name='3564'>
  IMPLICIT NONE<a name='3565'>
  INCLUDE 'mpif.h'<a name='3566'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_13"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3567'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3568'>
  INTEGER                     :: DataHandle, actual_iserver<a name='3569'>
  INTEGER i, itypesize, tasks_in_group, comm_io_group, me, ierr <a name='3570'>
  REAL dummy<a name='3571'>
<a name='3572'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_272"> ( DEBUG_LVL, 'in wrf_quilt_ioexit' ) <a name='3573'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3574'>
<a name='3575'>
<font color=#447700>!ARPDBG - potential bug. Have no access to what type of IO is being used for<a name='3576'></font>
<font color=#447700>! this data so if PNETCDF_QUILT is defined then we assume that's what's being used.<a name='3577'></font>
#ifdef PNETCDF_QUILT<a name='3578'>
<font color=#447700>!ARP Send the ioexit message just once to each IOServer when using parallel IO<a name='3579'></font>
  IF( compute_group_master(1,current_id) ) THEN<a name='3580'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_7">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3581'>
                                 DataHandle, int_ioexit )<a name='3582'>
  ELSE<a name='3583'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_7">( hdrbuf, hdrbufsize, itypesize )<a name='3584'>
  END IF<a name='3585'>
#else<a name='3586'>
<a name='3587'>
  IF ( wrf_dm_on_monitor() ) THEN<a name='3588'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_8">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3589'>
                                 DataHandle , int_ioexit )  <font color=#447700>! Handle is dummy<a name='3590'></font>
  ELSE<a name='3591'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_8">( hdrbuf, hdrbufsize, itypesize )<a name='3592'>
  ENDIF<a name='3593'>
#endif<a name='3594'>
<a name='3595'>
  DO iserver = 1, nio_groups<a name='3596'>
    if(poll_servers) then<a name='3597'>
       <font color=#447700>! We're using server polling mode, so we must call<a name='3598'></font>
       <font color=#447700>! *_find_server to receive the mpi_ssend sent by the servers,<a name='3599'></font>
       <font color=#447700>! otherwise WRF will hang at the mpi_x_reduce below.<a name='3600'></font>
<a name='3601'>
       call <A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER'>wrf_quilt_find_server</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_QUILT_FIND_SERVER_2">(actual_iserver)<a name='3602'>
<a name='3603'>
       <font color=#447700>! The actual_iserver is now set to the next available I/O server.<a name='3604'></font>
       <font color=#447700>! That may not be the same as iserver, but that's okay as long<a name='3605'></font>
       <font color=#447700>! as we run through this loop exactly nio_groups times.<a name='3606'></font>
    else<a name='3607'>
       <font color=#447700>! Not using server polling, so just access servers in numeric order.<a name='3608'></font>
       actual_iserver=iserver<a name='3609'>
    endif<a name='3610'>
<a name='3611'>
    CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_5">( comm_io_group , actual_iserver )<a name='3612'>
<a name='3613'>
    CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3614'>
    CALL mpi_comm_rank( comm_io_group , me , ierr )<a name='3615'>
<a name='3616'>
<font color=#447700>! BY SENDING A NEGATIVE SIZE WE GET THE SERVERS TO SHUT DOWN<a name='3617'></font>
    hdrbufsize = -100 <a name='3618'>
    reduced = 0<a name='3619'>
    IF ( me .eq. 0 ) reduced(1) = hdrbufsize <a name='3620'>
    CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3621'>
<a name='3622'>
  ENDDO<a name='3623'>
  Status = 0<a name='3624'>
<a name='3625'>
#endif<a name='3626'>
  RETURN  <a name='3627'>
END SUBROUTINE wrf_quilt_ioexit<a name='3628'>
<a name='3629'>
<A NAME='WRF_QUILT_GET_NEXT_TIME'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_NEXT_TIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3630'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_next_time</font> ( DataHandle, DateStr, Status ) <A href='../../call_to/WRF_QUILT_GET_NEXT_TIME.html' TARGET='index'>1</A><a name='3631'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3632'></font>
<font color=#447700>! Instruct the I/O quilt servers to return the next time stamp.<a name='3633'></font>
<font color=#447700>! This is not yet supported.<a name='3634'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3635'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3636'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined (STUBMPI) <a name='3637'></font>
  IMPLICIT NONE<a name='3638'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3639'>
  CHARACTER*(*)               :: DateStr<a name='3640'>
  INTEGER                     :: Status<a name='3641'>
#endif<a name='3642'>
  RETURN<a name='3643'>
END SUBROUTINE wrf_quilt_get_next_time<a name='3644'>
<a name='3645'>
<A NAME='WRF_QUILT_GET_PREVIOUS_TIME'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_PREVIOUS_TIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3646'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_previous_time</font> ( DataHandle, DateStr, Status ) <A href='../../call_to/WRF_QUILT_GET_PREVIOUS_TIME.html' TARGET='index'>1</A><a name='3647'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3648'></font>
<font color=#447700>! Instruct the I/O quilt servers to return the previous time stamp.<a name='3649'></font>
<font color=#447700>! This is not yet supported.<a name='3650'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3651'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3652'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined (STUBMPI)<a name='3653'></font>
  IMPLICIT NONE<a name='3654'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3655'>
  CHARACTER*(*)               :: DateStr<a name='3656'>
  INTEGER                     :: Status<a name='3657'>
#endif<a name='3658'>
  RETURN<a name='3659'>
END SUBROUTINE wrf_quilt_get_previous_time<a name='3660'>
<a name='3661'>
<A NAME='WRF_QUILT_SET_TIME'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_SET_TIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3662'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_set_time</font> ( DataHandle, Data,  Status ) <A href='../../call_to/WRF_QUILT_SET_TIME.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_SET_TIME.html' TARGET='index'>18</A><a name='3663'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3664'></font>
<font color=#447700>! Instruct the I/O quilt servers to set the time stamp in the dataset<a name='3665'></font>
<font color=#447700>! referenced by DataHandle.<a name='3666'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3667'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3668'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3669'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_12"><a name='3670'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_93">, ONLY: IO_PNETCDF<a name='3671'>
  IMPLICIT NONE<a name='3672'>
  INCLUDE 'mpif.h'<a name='3673'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_14"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3674'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3675'>
  CHARACTER*(*) , INTENT(IN)  :: Data<a name='3676'>
  INTEGER                     :: Status<a name='3677'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group<a name='3678'>
  REAL dummy<a name='3679'>
  INTEGER                 :: Count<a name='3680'>
  INTEGER, EXTERNAL       :: use_package<a name='3681'>
<font color=#447700>!<a name='3682'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_273"> ( DEBUG_LVL, 'in wrf_quilt_set_time' )<a name='3683'>
<a name='3684'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3685'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3686'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3687'>
      Count = 0   <font color=#447700>! there is no count for character strings<a name='3688'></font>
<a name='3689'>
<font color=#447700>!ARPDBG - potential bug. Have no access to what type of IO is being used for<a name='3690'></font>
<font color=#447700>! this data so if PNETCDF_QUILT is defined then we assume that's what's being used.<a name='3691'></font>
#ifdef PNETCDF_QUILT<a name='3692'>
      IF(compute_group_master(1,current_id) )THEN<a name='3693'>
<font color=#447700>! Only want to send one time header to each IO server as <a name='3694'></font>
<font color=#447700>! can't tell that's what they are on the IO servers themselves - therefore use<a name='3695'></font>
<font color=#447700>! the compute_group_master process.<a name='3696'></font>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_1">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3697'>
                                      DataHandle, "TIMESTAMP", "", Data, int_set_time )<a name='3698'>
      ELSE<a name='3699'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_9">( hdrbuf, hdrbufsize, itypesize )<a name='3700'>
      END IF<a name='3701'>
#else<a name='3702'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='3703'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_2">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3704'>
                                      DataHandle, "TIMESTAMP", "", Data, int_set_time )<a name='3705'>
      ELSE<a name='3706'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_10">( hdrbuf, hdrbufsize, itypesize )<a name='3707'>
      ENDIF<a name='3708'>
#endif<a name='3709'>
<a name='3710'>
      iserver = get_server_id ( DataHandle )<a name='3711'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_6">( comm_io_group , iserver )<a name='3712'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3713'>
<a name='3714'>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3715'></font>
      reduced = 0<a name='3716'>
      reduced(1) = hdrbufsize <a name='3717'>
#ifdef PNETCDF_QUILT<a name='3718'>
      IF ( compute_group_master(1,current_id) ) reduced(2) = DataHandle<a name='3719'>
#else<a name='3720'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3721'>
#endif<a name='3722'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3723'>
      <font color=#447700>! send data to the i/o processor<a name='3724'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_8">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3725'>
                            onebyte,                       &amp;<a name='3726'>
                            hdrbuf, hdrbufsize , &amp;<a name='3727'>
                            dummy, 0 )<a name='3728'>
    ENDIF<a name='3729'>
  ENDIF<a name='3730'>
<a name='3731'>
#endif<a name='3732'>
RETURN<a name='3733'>
END SUBROUTINE wrf_quilt_set_time<a name='3734'>
<a name='3735'>
<A NAME='WRF_QUILT_GET_NEXT_VAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_NEXT_VAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3736'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_next_var</font> ( DataHandle, VarName, Status ) <A href='../../call_to/WRF_QUILT_GET_NEXT_VAR.html' TARGET='index'>1</A><a name='3737'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3738'></font>
<font color=#447700>! When reading, instruct the I/O quilt servers to return the name of the next<a name='3739'></font>
<font color=#447700>! variable in the current time frame.<a name='3740'></font>
<font color=#447700>! This is not yet supported.<a name='3741'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3742'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3743'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3744'></font>
  IMPLICIT NONE<a name='3745'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3746'>
  CHARACTER*(*)               :: VarName<a name='3747'>
  INTEGER                     :: Status<a name='3748'>
#endif<a name='3749'>
  RETURN<a name='3750'>
END SUBROUTINE wrf_quilt_get_next_var<a name='3751'>
<a name='3752'>
<A NAME='WRF_QUILT_GET_DOM_TI_REAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TI_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3753'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_real</font> ( DataHandle,Element,   Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TI_REAL.html' TARGET='index'>2</A><a name='3754'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3755'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='3756'></font>
<font color=#447700>! independent domain metadata named "Element"<a name='3757'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='3758'></font>
<font color=#447700>! Metadata of type real are<a name='3759'></font>
<font color=#447700>! stored in array Data.<a name='3760'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='3761'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3762'></font>
<a name='3763'>
<font color=#447700>! This is not yet supported.<a name='3764'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3765'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3766'></font>
  IMPLICIT NONE<a name='3767'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3768'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3769'>
  REAL,            INTENT(IN) :: Data(*)<a name='3770'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3771'>
  INTEGER                     :: Outcount<a name='3772'>
  INTEGER                     :: Status<a name='3773'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_345">('wrf_quilt_get_dom_ti_real not supported yet')<a name='3774'>
#endif<a name='3775'>
RETURN<a name='3776'>
END SUBROUTINE wrf_quilt_get_dom_ti_real <a name='3777'>
<a name='3778'>
<A NAME='WRF_QUILT_PUT_DOM_TI_REAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3779'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_real</font> ( DataHandle,Element,   Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_REAL.html' TARGET='index'>16</A><a name='3780'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3781'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='3782'></font>
<font color=#447700>! domain metadata named "Element"<a name='3783'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='3784'></font>
<font color=#447700>! Metadata of type real are<a name='3785'></font>
<font color=#447700>! copied from array Data.<a name='3786'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3787'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3788'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3789'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_13"><a name='3790'>
  IMPLICIT NONE<a name='3791'>
  INCLUDE 'mpif.h'<a name='3792'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_15"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3793'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3794'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3795'>
  REAL ,          INTENT(IN)  :: Data(*)<a name='3796'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3797'>
  INTEGER                     :: Status<a name='3798'>
<font color=#447700>!Local<a name='3799'></font>
  CHARACTER*132   :: locElement<a name='3800'>
  INTEGER i, typesize, itypesize, tasks_in_group, ierr, comm_io_group<a name='3801'>
  REAL dummy<a name='3802'>
<font color=#447700>!<a name='3803'></font>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3804'></font>
<font color=#447700>!write(0,*)__FILE__,__LINE__,trim(element),count<a name='3805'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_274"> ( DEBUG_LVL, 'in wrf_quilt_put_dom_ti_real' ) <a name='3806'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3807'>
  locElement = Element<a name='3808'>
<a name='3809'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3810'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3811'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3812'>
      CALL MPI_TYPE_SIZE( MPI_REAL, typesize, ierr )<a name='3813'>
<a name='3814'>
#ifdef PNETCDF_QUILT<a name='3815'>
      IF ( compute_group_master(1,current_id) ) THEN<a name='3816'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER'>int_gen_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_1">( hdrbuf, hdrbufsize, itypesize, typesize, &amp;<a name='3817'>
                                 DataHandle, locElement, Data, Count, int_dom_ti_real )<a name='3818'>
      ELSE<a name='3819'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_11">( hdrbuf, hdrbufsize, itypesize )<a name='3820'>
      ENDIF<a name='3821'>
#else<a name='3822'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='3823'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER'>int_gen_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_2">( hdrbuf, hdrbufsize, itypesize, typesize, &amp;<a name='3824'>
                                 DataHandle, locElement, Data, Count, int_dom_ti_real )<a name='3825'>
      ELSE<a name='3826'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_12">( hdrbuf, hdrbufsize, itypesize )<a name='3827'>
      ENDIF<a name='3828'>
#endif<a name='3829'>
<a name='3830'>
      iserver = get_server_id ( DataHandle )<a name='3831'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_7">( comm_io_group , iserver )<a name='3832'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3833'>
<a name='3834'>
<font color=#447700>!!JMTIMING      CALL start_timing<a name='3835'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3836'></font>
      reduced = 0<a name='3837'>
      reduced(1) = hdrbufsize <a name='3838'>
#ifdef PNETCDF_QUILT<a name='3839'>
      IF( compute_group_master(1,current_id) )  reduced(2) = DataHandle<a name='3840'>
#else<a name='3841'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3842'>
#endif<a name='3843'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3844'>
<font color=#447700>!!JMTIMING       CALL end_timing("MPI_Reduce in wrf_quilt_put_dom_ti_real")<a name='3845'></font>
      <font color=#447700>! send data to the i/o processor<a name='3846'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_9">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3847'>
                            onebyte,                       &amp;<a name='3848'>
                            hdrbuf, hdrbufsize , &amp;<a name='3849'>
                            dummy, 0 )<a name='3850'>
    ENDIF<a name='3851'>
  ENDIF<a name='3852'>
<a name='3853'>
  Status = 0<a name='3854'>
<font color=#447700>!!JMTIMING   CALL end_timing("wrf_quilt_put_dom_ti_real")<a name='3855'></font>
#endif<a name='3856'>
RETURN<a name='3857'>
END SUBROUTINE wrf_quilt_put_dom_ti_real <a name='3858'>
<a name='3859'>
<A NAME='WRF_QUILT_GET_DOM_TI_DOUBLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TI_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3860'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_double</font> ( DataHandle,Element,   Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TI_DOUBLE.html' TARGET='index'>2</A><a name='3861'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3862'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='3863'></font>
<font color=#447700>! independent domain metadata named "Element"<a name='3864'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='3865'></font>
<font color=#447700>! Metadata of type double are<a name='3866'></font>
<font color=#447700>! stored in array Data.<a name='3867'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='3868'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3869'></font>
<font color=#447700>!<a name='3870'></font>
<font color=#447700>! This is not yet supported.<a name='3871'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3872'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3873'></font>
  IMPLICIT NONE<a name='3874'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3875'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3876'>
  real*8                      :: Data(*)<a name='3877'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3878'>
  INTEGER                     :: OutCount<a name='3879'>
  INTEGER                     :: Status<a name='3880'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_302">('wrf_quilt_get_dom_ti_double not supported yet')<a name='3881'>
#endif<a name='3882'>
RETURN<a name='3883'>
END SUBROUTINE wrf_quilt_get_dom_ti_double <a name='3884'>
<a name='3885'>
<A NAME='WRF_QUILT_PUT_DOM_TI_DOUBLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TI_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3886'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_double</font> ( DataHandle,Element,   Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_DOUBLE.html' TARGET='index'>2</A><a name='3887'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3888'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='3889'></font>
<font color=#447700>! domain metadata named "Element"<a name='3890'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='3891'></font>
<font color=#447700>! Metadata of type double are<a name='3892'></font>
<font color=#447700>! copied from array Data.<a name='3893'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3894'></font>
<font color=#447700>!<a name='3895'></font>
<font color=#447700>! This is not yet supported.<a name='3896'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3897'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3898'></font>
  IMPLICIT NONE<a name='3899'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3900'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3901'>
  REAL*8 ,        INTENT(IN)  :: Data(*)<a name='3902'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3903'>
  INTEGER                     :: Status<a name='3904'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_303">('wrf_quilt_put_dom_ti_double not supported yet')<a name='3905'>
#endif<a name='3906'>
RETURN<a name='3907'>
END SUBROUTINE wrf_quilt_put_dom_ti_double <a name='3908'>
<a name='3909'>
<A NAME='WRF_QUILT_GET_DOM_TI_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TI_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3910'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_integer</font> ( DataHandle,Element,   Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TI_INTEGER.html' TARGET='index'>2</A><a name='3911'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3912'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='3913'></font>
<font color=#447700>! independent domain metadata named "Element"<a name='3914'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='3915'></font>
<font color=#447700>! Metadata of type integer are<a name='3916'></font>
<font color=#447700>! stored in array Data.<a name='3917'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='3918'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3919'></font>
<font color=#447700>!<a name='3920'></font>
<font color=#447700>! This is not yet supported.<a name='3921'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3922'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3923'></font>
  IMPLICIT NONE<a name='3924'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3925'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3926'>
  integer                     :: Data(*)<a name='3927'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3928'>
  INTEGER                      :: OutCount<a name='3929'>
  INTEGER                     :: Status<a name='3930'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_346">('wrf_quilt_get_dom_ti_integer not supported yet')<a name='3931'>
#endif<a name='3932'>
RETURN<a name='3933'>
END SUBROUTINE wrf_quilt_get_dom_ti_integer <a name='3934'>
<a name='3935'>
<A NAME='WRF_QUILT_PUT_DOM_TI_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3936'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_integer</font> ( DataHandle,Element,   Data, Count,  Status ) <A href='../../call_to/WRF_QUILT_PUT_DOM_TI_INTEGER.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_INTEGER.html' TARGET='index'>20</A><a name='3937'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3938'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='3939'></font>
<font color=#447700>! domain metadata named "Element"<a name='3940'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='3941'></font>
<font color=#447700>! Metadata of type integer are<a name='3942'></font>
<font color=#447700>! copied from array Data.<a name='3943'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3944'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3945'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3946'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_14"><a name='3947'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_94">, ONLY: IO_PNETCDF<a name='3948'>
  IMPLICIT NONE<a name='3949'>
  INCLUDE 'mpif.h'<a name='3950'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_16"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3951'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3952'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3953'>
  INTEGER ,       INTENT(IN)  :: Data(*)<a name='3954'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3955'>
  INTEGER                     :: Status<a name='3956'>
<font color=#447700>! Local<a name='3957'></font>
  CHARACTER*132   :: locElement<a name='3958'>
  INTEGER i, typesize, itypesize, tasks_in_group, ierr, comm_io_group<a name='3959'>
  REAL dummy<a name='3960'>
  INTEGER, EXTERNAL :: use_package<a name='3961'>
<font color=#447700>!<a name='3962'></font>
<a name='3963'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3964'></font>
  locElement = Element<a name='3965'>
<a name='3966'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_275"> ( DEBUG_LVL, 'in wrf_quilt_put_dom_ti_integer' ) <a name='3967'>
<font color=#447700>!write(0,*)__FILE__,__LINE__,trim(element),count<a name='3968'></font>
<a name='3969'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3970'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3971'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3972'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, typesize, ierr )<a name='3973'>
<a name='3974'>
<font color=#447700>!ARPDBG - potential bug. Have no access to what type of IO is being used for<a name='3975'></font>
<font color=#447700>! this data so if PNETCDF_QUILT is defined then we assume that's what's being used.<a name='3976'></font>
#ifdef PNETCDF_QUILT<a name='3977'>
      IF ( compute_group_master(1,current_id) )THEN<a name='3978'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER'>int_gen_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_3">( hdrbuf, hdrbufsize, itypesize, typesize, &amp;<a name='3979'>
                                 DataHandle, locElement, Data, Count,     &amp;<a name='3980'>
                                 int_dom_ti_integer )<a name='3981'>
      ELSE<a name='3982'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_13">( hdrbuf, hdrbufsize, itypesize )<a name='3983'>
      ENDIF<a name='3984'>
#else<a name='3985'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='3986'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER'>int_gen_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_4">( hdrbuf, hdrbufsize, itypesize, typesize, &amp;<a name='3987'>
                                 DataHandle, locElement, Data, Count,     &amp;<a name='3988'>
                                 int_dom_ti_integer )<a name='3989'>
      ELSE<a name='3990'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_14">( hdrbuf, hdrbufsize, itypesize )<a name='3991'>
      ENDIF<a name='3992'>
#endif<a name='3993'>
<a name='3994'>
      iserver = get_server_id ( DataHandle )<a name='3995'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_8">( comm_io_group , iserver )<a name='3996'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3997'>
<a name='3998'>
<font color=#447700>!!JMTIMING      CALL start_timing<a name='3999'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='4000'></font>
      reduced = 0<a name='4001'>
      reduced(1) = hdrbufsize <a name='4002'>
#ifdef PNETCDF_QUILT<a name='4003'>
      IF ( compute_group_master(1,current_id) ) reduced(2) = DataHandle<a name='4004'>
#else<a name='4005'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='4006'>
#endif<a name='4007'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='4008'>
<a name='4009'>
<font color=#447700>!!JMTIMING       CALL end_timing("MPI_Reduce in wrf_quilt_put_dom_ti_integer")<a name='4010'></font>
      <font color=#447700>! send data to the i/o processor<a name='4011'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_10">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='4012'>
                            onebyte,                       &amp;<a name='4013'>
                            hdrbuf, hdrbufsize , &amp;<a name='4014'>
                            dummy, 0 )<a name='4015'>
    ENDIF<a name='4016'>
  ENDIF<a name='4017'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_276"> ( DEBUG_LVL, 'returning from wrf_quilt_put_dom_ti_integer' ) <a name='4018'>
<font color=#447700>!!JMTIMING   CALL end_timing("wrf_quilt_put_dom_ti_integer" )<a name='4019'></font>
<a name='4020'>
#endif<a name='4021'>
RETURN<a name='4022'>
END SUBROUTINE wrf_quilt_put_dom_ti_integer <a name='4023'>
<a name='4024'>
<A NAME='WRF_QUILT_GET_DOM_TI_LOGICAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TI_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4025'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_logical</font> ( DataHandle,Element,   Data, Count, Outcount, Status )<a name='4026'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4027'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4028'></font>
<font color=#447700>! independent domain metadata named "Element"<a name='4029'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4030'></font>
<font color=#447700>! Metadata of type logical are<a name='4031'></font>
<font color=#447700>! stored in array Data.<a name='4032'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4033'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4034'></font>
<font color=#447700>!<a name='4035'></font>
<font color=#447700>! This is not yet supported.<a name='4036'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4037'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4038'></font>
  IMPLICIT NONE<a name='4039'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4040'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4041'>
  logical                     :: Data(*)<a name='4042'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4043'>
  INTEGER                      :: OutCount<a name='4044'>
  INTEGER                     :: Status<a name='4045'>
<font color=#447700>!  CALL wrf_message('wrf_quilt_get_dom_ti_logical not supported yet')<a name='4046'></font>
#endif<a name='4047'>
RETURN<a name='4048'>
END SUBROUTINE wrf_quilt_get_dom_ti_logical <a name='4049'>
<a name='4050'>
<A NAME='WRF_QUILT_PUT_DOM_TI_LOGICAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TI_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4051'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_logical</font> ( DataHandle,Element,   Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_LOGICAL.html' TARGET='index'>2</A><a name='4052'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4053'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4054'></font>
<font color=#447700>! domain metadata named "Element"<a name='4055'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4056'></font>
<font color=#447700>! Metadata of type logical are<a name='4057'></font>
<font color=#447700>! copied from array Data.<a name='4058'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4059'></font>
<font color=#447700>!<a name='4060'></font>
<font color=#447700>! This is not yet supported.<a name='4061'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4062'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4063'></font>
  IMPLICIT NONE<a name='4064'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4065'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4066'>
  logical ,            INTENT(IN) :: Data(*)<a name='4067'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4068'>
  INTEGER                     :: Status<a name='4069'>
<font color=#447700>! Local<a name='4070'></font>
  INTEGER i<a name='4071'>
  INTEGER one_or_zero(Count)<a name='4072'>
<a name='4073'>
  DO i = 1, Count<a name='4074'>
    IF ( Data(i) ) THEN<a name='4075'>
      one_or_zero(i) = 1<a name='4076'>
    ELSE<a name='4077'>
      one_or_zero(i) = 0<a name='4078'>
    ENDIF<a name='4079'>
  ENDDO<a name='4080'>
<a name='4081'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER'>wrf_quilt_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_LOGICAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_QUILT_PUT_DOM_TI_INTEGER_1"> ( DataHandle,Element,   one_or_zero, Count,  Status )<a name='4082'>
#endif<a name='4083'>
RETURN<a name='4084'>
END SUBROUTINE wrf_quilt_put_dom_ti_logical <a name='4085'>
<a name='4086'>
<A NAME='WRF_QUILT_GET_DOM_TI_CHAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TI_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4087'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_char</font> ( DataHandle,Element,   Data,  Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TI_CHAR.html' TARGET='index'>2</A><a name='4088'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4089'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read time independent<a name='4090'></font>
<font color=#447700>! domain metadata named "Element"<a name='4091'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4092'></font>
<font color=#447700>! Metadata of type char are<a name='4093'></font>
<font color=#447700>! stored in string Data.<a name='4094'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4095'></font>
<font color=#447700>!<a name='4096'></font>
<font color=#447700>! This is not yet supported.<a name='4097'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4098'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4099'></font>
  IMPLICIT NONE<a name='4100'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4101'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4102'>
  CHARACTER*(*)               :: Data<a name='4103'>
  INTEGER                     :: Status<a name='4104'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_347">('wrf_quilt_get_dom_ti_char not supported yet')<a name='4105'>
#endif<a name='4106'>
RETURN<a name='4107'>
END SUBROUTINE wrf_quilt_get_dom_ti_char <a name='4108'>
<a name='4109'>
<A NAME='WRF_QUILT_PUT_DOM_TI_CHAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4110'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_char</font> ( DataHandle, Element,  Data,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_CHAR.html' TARGET='index'>16</A><a name='4111'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4112'></font>
<font color=#447700>! Instruct the I/O quilt servers to write time independent<a name='4113'></font>
<font color=#447700>! domain metadata named "Element"<a name='4114'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4115'></font>
<font color=#447700>! Metadata of type char are<a name='4116'></font>
<font color=#447700>! copied from string Data.<a name='4117'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4118'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4119'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4120'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_15"><a name='4121'>
  IMPLICIT NONE<a name='4122'>
  INCLUDE 'mpif.h'<a name='4123'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_17"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4124'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4125'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4126'>
  CHARACTER*(*) , INTENT(IN)  :: Data<a name='4127'>
  INTEGER                     :: Status<a name='4128'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group, me<a name='4129'>
  REAL dummy<a name='4130'>
<font color=#447700>!<a name='4131'></font>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='4132'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_277"> ( DEBUG_LVL, 'in wrf_quilt_put_dom_ti_char' ) <a name='4133'>
<font color=#447700>!write(0,*)__FILE__,__LINE__,trim(element)<a name='4134'></font>
<a name='4135'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='4136'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='4137'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='4138'>
<a name='4139'>
<font color=#447700>!ARPDBG - potential bug. Have no access to what type of IO is being used for<a name='4140'></font>
<font color=#447700>! this data so if PNETCDF_QUILT is defined then we assume that's what's being used.<a name='4141'></font>
#ifdef PNETCDF_QUILT<a name='4142'>
      IF(compute_group_master(1,current_id))THEN<a name='4143'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_3">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='4144'>
                                      DataHandle, Element, "", Data, &amp;<a name='4145'>
                                      int_dom_ti_char )<a name='4146'>
      ELSE<a name='4147'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_15">( hdrbuf, hdrbufsize, itypesize )<a name='4148'>
      END IF<a name='4149'>
#else<a name='4150'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='4151'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_4">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='4152'>
                                      DataHandle, Element, "", Data, int_dom_ti_char )<a name='4153'>
      ELSE<a name='4154'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_16">( hdrbuf, hdrbufsize, itypesize )<a name='4155'>
      ENDIF<a name='4156'>
#endif<a name='4157'>
<a name='4158'>
      iserver = get_server_id ( DataHandle )<a name='4159'>
<font color=#447700>!  write(0,*)'wrf_quilt_put_dom_ti_char ',iserver<a name='4160'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_9">( comm_io_group , iserver )<a name='4161'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='4162'>
      <font color=#447700>! send the size of my local buffer to the i/o task (obufsize doesnt mean anything here)<a name='4163'></font>
<font color=#447700>!!JMTIMING!  CALL start_timing<a name='4164'></font>
<font color=#447700>!write(0,*)'calling MPI_Barrier'<a name='4165'></font>
<font color=#447700>!  CALL MPI_Barrier( mpi_comm_local, ierr )<a name='4166'></font>
<font color=#447700>!write(0,*)'back from MPI_Barrier'<a name='4167'></font>
<font color=#447700>!!JMTIMING!   CALL end_timing("MPI_Barrier in wrf_quilt_put_dom_ti_char")<a name='4168'></font>
<a name='4169'>
<font color=#447700>!!JMTIMING      CALL start_timing<a name='4170'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='4171'></font>
      reduced_dummy = 0 <a name='4172'>
      reduced = 0<a name='4173'>
      reduced(1) = hdrbufsize <a name='4174'>
#ifdef PNETCDF_QUILT<a name='4175'>
      IF(compute_group_master(1,current_id))    reduced(2) = DataHandle<a name='4176'>
#else<a name='4177'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='4178'>
#endif<a name='4179'>
<font color=#447700>!call mpi_comm_rank( comm_io_group , me, ierr )<a name='4180'></font>
<a name='4181'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='4182'>
<a name='4183'>
<font color=#447700>!!JMTIMING       CALL end_timing("MPI_Reduce in wrf_quilt_put_dom_ti_char")<a name='4184'></font>
      <font color=#447700>! send data to the i/o processor<a name='4185'></font>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='4186'></font>
<a name='4187'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_11">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='4188'>
                            onebyte,                       &amp;<a name='4189'>
                            hdrbuf, hdrbufsize , &amp;<a name='4190'>
                            dummy, 0 )<a name='4191'>
<font color=#447700>!!JMTIMING   CALL end_timing("collect_on_comm in wrf_quilt_put_dom_ti_char")<a name='4192'></font>
    ENDIF<a name='4193'>
  ENDIF<a name='4194'>
<font color=#447700>!!JMTIMING   CALL end_timing("wrf_quilt_put_dom_ti_char")<a name='4195'></font>
<a name='4196'>
#endif<a name='4197'>
RETURN<a name='4198'>
END SUBROUTINE wrf_quilt_put_dom_ti_char <a name='4199'>
<a name='4200'>
<A NAME='WRF_QUILT_GET_DOM_TD_REAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TD_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4201'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_real</font> ( DataHandle,Element, DateStr,  Data, Count, Outcount, Status )<a name='4202'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4203'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4204'></font>
<font color=#447700>! dependent domain metadata named "Element" valid at time DateStr<a name='4205'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4206'></font>
<font color=#447700>! Metadata of type real are<a name='4207'></font>
<font color=#447700>! stored in array Data.<a name='4208'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4209'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4210'></font>
<font color=#447700>!<a name='4211'></font>
<font color=#447700>! This is not yet supported.<a name='4212'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4213'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4214'></font>
  IMPLICIT NONE<a name='4215'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4216'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4217'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4218'>
  real                        :: Data(*)<a name='4219'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4220'>
  INTEGER                     :: OutCount<a name='4221'>
  INTEGER                     :: Status<a name='4222'>
#endif<a name='4223'>
RETURN<a name='4224'>
END SUBROUTINE wrf_quilt_get_dom_td_real <a name='4225'>
<a name='4226'>
<A NAME='WRF_QUILT_PUT_DOM_TD_REAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TD_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4227'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_real</font> ( DataHandle,Element, DateStr,  Data, Count,  Status )<a name='4228'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4229'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4230'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4231'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4232'></font>
<font color=#447700>! Metadata of type real are<a name='4233'></font>
<font color=#447700>! copied from array Data.<a name='4234'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4235'></font>
<font color=#447700>!<a name='4236'></font>
<font color=#447700>! This is not yet supported.<a name='4237'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4238'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4239'></font>
  IMPLICIT NONE<a name='4240'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4241'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4242'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4243'>
  real ,            INTENT(IN) :: Data(*)<a name='4244'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4245'>
  INTEGER                     :: Status<a name='4246'>
#endif<a name='4247'>
RETURN<a name='4248'>
END SUBROUTINE wrf_quilt_put_dom_td_real <a name='4249'>
<a name='4250'>
<A NAME='WRF_QUILT_GET_DOM_TD_DOUBLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TD_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4251'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_double</font> ( DataHandle,Element, DateStr,  Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TD_DOUBLE.html' TARGET='index'>2</A><a name='4252'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4253'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4254'></font>
<font color=#447700>! dependent domain metadata named "Element" valid at time DateStr<a name='4255'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4256'></font>
<font color=#447700>! Metadata of type double are<a name='4257'></font>
<font color=#447700>! stored in array Data.<a name='4258'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4259'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4260'></font>
<font color=#447700>!<a name='4261'></font>
<font color=#447700>! This is not yet supported.<a name='4262'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4263'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4264'></font>
  IMPLICIT NONE<a name='4265'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4266'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4267'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4268'>
  real*8                          :: Data(*)<a name='4269'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4270'>
  INTEGER                      :: OutCount<a name='4271'>
  INTEGER                     :: Status<a name='4272'>
#endif<a name='4273'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TD_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_304">('wrf_quilt_get_dom_td_double not supported yet')<a name='4274'>
RETURN<a name='4275'>
END SUBROUTINE wrf_quilt_get_dom_td_double <a name='4276'>
<a name='4277'>
<A NAME='WRF_QUILT_PUT_DOM_TD_DOUBLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TD_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4278'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_double</font> ( DataHandle,Element, DateStr,  Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TD_DOUBLE.html' TARGET='index'>2</A><a name='4279'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4280'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4281'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4282'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4283'></font>
<font color=#447700>! Metadata of type double are<a name='4284'></font>
<font color=#447700>! copied from array Data.<a name='4285'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4286'></font>
<font color=#447700>!<a name='4287'></font>
<font color=#447700>! This is not yet supported.<a name='4288'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4289'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4290'></font>
  IMPLICIT NONE<a name='4291'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4292'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4293'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4294'>
  real*8 ,            INTENT(IN) :: Data(*)<a name='4295'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4296'>
  INTEGER                     :: Status<a name='4297'>
#endif<a name='4298'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TD_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_305">('wrf_quilt_put_dom_td_double not supported yet')<a name='4299'>
RETURN<a name='4300'>
END SUBROUTINE wrf_quilt_put_dom_td_double <a name='4301'>
<a name='4302'>
<A NAME='WRF_QUILT_GET_DOM_TD_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4303'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_integer</font> ( DataHandle,Element, DateStr,  Data, Count, Outcount, Status )<a name='4304'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4305'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4306'></font>
<font color=#447700>! dependent domain metadata named "Element" valid at time DateStr<a name='4307'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4308'></font>
<font color=#447700>! Metadata of type integer are<a name='4309'></font>
<font color=#447700>! stored in array Data.<a name='4310'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4311'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4312'></font>
<font color=#447700>!<a name='4313'></font>
<font color=#447700>! This is not yet supported.<a name='4314'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4315'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4316'></font>
  IMPLICIT NONE<a name='4317'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4318'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4319'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4320'>
  integer                          :: Data(*)<a name='4321'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4322'>
  INTEGER                      :: OutCount<a name='4323'>
  INTEGER                     :: Status<a name='4324'>
#endif<a name='4325'>
RETURN<a name='4326'>
END SUBROUTINE wrf_quilt_get_dom_td_integer <a name='4327'>
<a name='4328'>
<A NAME='WRF_QUILT_PUT_DOM_TD_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4329'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_integer</font> ( DataHandle,Element, DateStr,  Data, Count,  Status )<a name='4330'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4331'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4332'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4333'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4334'></font>
<font color=#447700>! Metadata of type integer are<a name='4335'></font>
<font color=#447700>! copied from array Data.<a name='4336'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4337'></font>
<font color=#447700>!<a name='4338'></font>
<font color=#447700>! This is not yet supported.<a name='4339'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4340'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4341'></font>
  IMPLICIT NONE<a name='4342'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4343'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4344'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4345'>
  integer ,            INTENT(IN) :: Data(*)<a name='4346'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4347'>
  INTEGER                     :: Status<a name='4348'>
#endif<a name='4349'>
RETURN<a name='4350'>
END SUBROUTINE wrf_quilt_put_dom_td_integer <a name='4351'>
<a name='4352'>
<A NAME='WRF_QUILT_GET_DOM_TD_LOGICAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TD_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4353'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_logical</font> ( DataHandle,Element, DateStr,  Data, Count, Outcount, Status )<a name='4354'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4355'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4356'></font>
<font color=#447700>! dependent domain metadata named "Element" valid at time DateStr<a name='4357'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4358'></font>
<font color=#447700>! Metadata of type logical are<a name='4359'></font>
<font color=#447700>! stored in array Data.<a name='4360'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4361'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4362'></font>
<font color=#447700>!<a name='4363'></font>
<font color=#447700>! This is not yet supported.<a name='4364'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4365'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4366'></font>
  IMPLICIT NONE<a name='4367'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4368'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4369'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4370'>
  logical                          :: Data(*)<a name='4371'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4372'>
  INTEGER                      :: OutCount<a name='4373'>
  INTEGER                     :: Status<a name='4374'>
#endif<a name='4375'>
RETURN<a name='4376'>
END SUBROUTINE wrf_quilt_get_dom_td_logical <a name='4377'>
<a name='4378'>
<A NAME='WRF_QUILT_PUT_DOM_TD_LOGICAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TD_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4379'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_logical</font> ( DataHandle,Element, DateStr,  Data, Count,  Status )<a name='4380'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4381'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4382'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4383'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4384'></font>
<font color=#447700>! Metadata of type logical are<a name='4385'></font>
<font color=#447700>! copied from array Data.<a name='4386'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4387'></font>
<font color=#447700>!<a name='4388'></font>
<font color=#447700>! This is not yet supported.<a name='4389'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4390'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4391'></font>
  IMPLICIT NONE<a name='4392'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4393'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4394'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4395'>
  logical ,            INTENT(IN) :: Data(*)<a name='4396'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4397'>
  INTEGER                     :: Status<a name='4398'>
#endif<a name='4399'>
RETURN<a name='4400'>
END SUBROUTINE wrf_quilt_put_dom_td_logical <a name='4401'>
<a name='4402'>
<A NAME='WRF_QUILT_GET_DOM_TD_CHAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_DOM_TD_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4403'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_char</font> ( DataHandle,Element, DateStr,  Data,  Status )<a name='4404'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4405'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read time dependent<a name='4406'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4407'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4408'></font>
<font color=#447700>! Metadata of type char are<a name='4409'></font>
<font color=#447700>! stored in string Data.<a name='4410'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4411'></font>
<font color=#447700>!<a name='4412'></font>
<font color=#447700>! This is not yet supported.<a name='4413'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4414'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4415'></font>
  IMPLICIT NONE<a name='4416'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4417'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4418'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4419'>
  CHARACTER*(*)               :: Data<a name='4420'>
  INTEGER                     :: Status<a name='4421'>
#endif<a name='4422'>
RETURN<a name='4423'>
END SUBROUTINE wrf_quilt_get_dom_td_char <a name='4424'>
<a name='4425'>
<A NAME='WRF_QUILT_PUT_DOM_TD_CHAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_DOM_TD_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4426'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_char</font> ( DataHandle,Element, DateStr,  Data,  Status )<a name='4427'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4428'></font>
<font color=#447700>! Instruct $he I/O quilt servers to write time dependent<a name='4429'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4430'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4431'></font>
<font color=#447700>! Metadata of type char are<a name='4432'></font>
<font color=#447700>! copied from string Data.<a name='4433'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4434'></font>
<font color=#447700>!<a name='4435'></font>
<font color=#447700>! This is not yet supported.<a name='4436'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4437'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4438'></font>
  IMPLICIT NONE<a name='4439'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4440'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4441'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4442'>
  CHARACTER*(*) , INTENT(IN) :: Data<a name='4443'>
  INTEGER                          :: Status<a name='4444'>
#endif<a name='4445'>
RETURN<a name='4446'>
END SUBROUTINE wrf_quilt_put_dom_td_char <a name='4447'>
<a name='4448'>
<A NAME='WRF_QUILT_GET_VAR_TI_REAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TI_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4449'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_real</font> ( DataHandle,Element,  Varname, Data, Count, Outcount, Status )<a name='4450'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4451'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4452'></font>
<font color=#447700>! independent attribute "Element" of variable "Varname"<a name='4453'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4454'></font>
<font color=#447700>! Attribute of type real is<a name='4455'></font>
<font color=#447700>! stored in array Data.<a name='4456'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4457'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4458'></font>
<font color=#447700>!<a name='4459'></font>
<font color=#447700>! This is not yet supported.<a name='4460'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4461'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4462'></font>
  IMPLICIT NONE<a name='4463'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4464'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4465'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4466'>
  real                          :: Data(*)<a name='4467'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4468'>
  INTEGER                     :: OutCount<a name='4469'>
  INTEGER                     :: Status<a name='4470'>
#endif<a name='4471'>
RETURN<a name='4472'>
END SUBROUTINE wrf_quilt_get_var_ti_real <a name='4473'>
<a name='4474'>
<A NAME='WRF_QUILT_PUT_VAR_TI_REAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TI_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4475'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_real</font> ( DataHandle,Element,  Varname, Data, Count,  Status )<a name='4476'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4477'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4478'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4479'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4480'></font>
<font color=#447700>! Attribute of type real is<a name='4481'></font>
<font color=#447700>! copied from array Data.<a name='4482'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4483'></font>
<font color=#447700>!<a name='4484'></font>
<font color=#447700>! This is not yet supported.<a name='4485'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4486'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4487'></font>
  IMPLICIT NONE<a name='4488'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4489'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4490'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4491'>
  real ,            INTENT(IN) :: Data(*)<a name='4492'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4493'>
  INTEGER                     :: Status<a name='4494'>
#endif<a name='4495'>
RETURN<a name='4496'>
END SUBROUTINE wrf_quilt_put_var_ti_real <a name='4497'>
<a name='4498'>
<A NAME='WRF_QUILT_GET_VAR_TI_DOUBLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TI_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4499'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_double</font> ( DataHandle,Element,  Varname, Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_VAR_TI_DOUBLE.html' TARGET='index'>2</A><a name='4500'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4501'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4502'></font>
<font color=#447700>! independent attribute "Element" of variable "Varname"<a name='4503'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4504'></font>
<font color=#447700>! Attribute of type double is<a name='4505'></font>
<font color=#447700>! stored in array Data.<a name='4506'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4507'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4508'></font>
<font color=#447700>!<a name='4509'></font>
<font color=#447700>! This is not yet supported.<a name='4510'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4511'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4512'></font>
  IMPLICIT NONE<a name='4513'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4514'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4515'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4516'>
  real*8                      :: Data(*)<a name='4517'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4518'>
  INTEGER                     :: OutCount<a name='4519'>
  INTEGER                     :: Status<a name='4520'>
#endif<a name='4521'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TI_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_306">('wrf_quilt_get_var_ti_double not supported yet')<a name='4522'>
RETURN<a name='4523'>
END SUBROUTINE wrf_quilt_get_var_ti_double <a name='4524'>
<a name='4525'>
<A NAME='WRF_QUILT_PUT_VAR_TI_DOUBLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TI_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4526'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_double</font> ( DataHandle,Element,  Varname, Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_VAR_TI_DOUBLE.html' TARGET='index'>2</A><a name='4527'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4528'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4529'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4530'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4531'></font>
<font color=#447700>! Attribute of type double is<a name='4532'></font>
<font color=#447700>! copied from array Data.<a name='4533'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4534'></font>
<font color=#447700>!<a name='4535'></font>
<font color=#447700>! This is not yet supported.<a name='4536'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4537'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4538'></font>
  IMPLICIT NONE<a name='4539'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4540'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4541'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4542'>
  real*8 ,        INTENT(IN) :: Data(*)<a name='4543'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4544'>
  INTEGER                     :: Status<a name='4545'>
#endif<a name='4546'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_307">('wrf_quilt_put_var_ti_double not supported yet')<a name='4547'>
RETURN<a name='4548'>
END SUBROUTINE wrf_quilt_put_var_ti_double <a name='4549'>
<a name='4550'>
<A NAME='WRF_QUILT_GET_VAR_TI_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TI_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4551'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_integer</font> ( DataHandle,Element,  Varname, Data, Count, Outcount, Status )<a name='4552'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4553'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4554'></font>
<font color=#447700>! independent attribute "Element" of variable "Varname"<a name='4555'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4556'></font>
<font color=#447700>! Attribute of type integer is<a name='4557'></font>
<font color=#447700>! stored in array Data.<a name='4558'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4559'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4560'></font>
<font color=#447700>!<a name='4561'></font>
<font color=#447700>! This is not yet supported.<a name='4562'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4563'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4564'></font>
  IMPLICIT NONE<a name='4565'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4566'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4567'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4568'>
  integer                     :: Data(*)<a name='4569'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4570'>
  INTEGER                     :: OutCount<a name='4571'>
  INTEGER                     :: Status<a name='4572'>
#endif<a name='4573'>
RETURN<a name='4574'>
END SUBROUTINE wrf_quilt_get_var_ti_integer <a name='4575'>
<a name='4576'>
<A NAME='WRF_QUILT_PUT_VAR_TI_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TI_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4577'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_integer</font> ( DataHandle,Element,  Varname, Data, Count,  Status )<a name='4578'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4579'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4580'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4581'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4582'></font>
<font color=#447700>! Attribute of type integer is<a name='4583'></font>
<font color=#447700>! copied from array Data.<a name='4584'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4585'></font>
<font color=#447700>!<a name='4586'></font>
<font color=#447700>! This is not yet supported.<a name='4587'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4588'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4589'></font>
  IMPLICIT NONE<a name='4590'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4591'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4592'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4593'>
  integer ,            INTENT(IN) :: Data(*)<a name='4594'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4595'>
  INTEGER                     :: Status<a name='4596'>
#endif<a name='4597'>
RETURN<a name='4598'>
END SUBROUTINE wrf_quilt_put_var_ti_integer <a name='4599'>
<a name='4600'>
<A NAME='WRF_QUILT_GET_VAR_TI_LOGICAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TI_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4601'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_logical</font> ( DataHandle,Element,  Varname, Data, Count, Outcount, Status )<a name='4602'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4603'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4604'></font>
<font color=#447700>! independent attribute "Element" of variable "Varname"<a name='4605'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4606'></font>
<font color=#447700>! Attribute of type logical is<a name='4607'></font>
<font color=#447700>! stored in array Data.<a name='4608'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4609'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4610'></font>
<font color=#447700>!<a name='4611'></font>
<font color=#447700>! This is not yet supported.<a name='4612'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4613'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4614'></font>
  IMPLICIT NONE<a name='4615'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4616'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4617'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4618'>
  logical                     :: Data(*)<a name='4619'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4620'>
  INTEGER                     :: OutCount<a name='4621'>
  INTEGER                     :: Status<a name='4622'>
#endif<a name='4623'>
RETURN<a name='4624'>
END SUBROUTINE wrf_quilt_get_var_ti_logical <a name='4625'>
<a name='4626'>
<A NAME='WRF_QUILT_PUT_VAR_TI_LOGICAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TI_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4627'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_logical</font> ( DataHandle,Element,  Varname, Data, Count,  Status )<a name='4628'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4629'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4630'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4631'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4632'></font>
<font color=#447700>! Attribute of type logical is<a name='4633'></font>
<font color=#447700>! copied from array Data.<a name='4634'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4635'></font>
<font color=#447700>!<a name='4636'></font>
<font color=#447700>! This is not yet supported.<a name='4637'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4638'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4639'></font>
  IMPLICIT NONE<a name='4640'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4641'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4642'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4643'>
  logical ,            INTENT(IN) :: Data(*)<a name='4644'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4645'>
  INTEGER                     :: Status<a name='4646'>
#endif<a name='4647'>
RETURN<a name='4648'>
END SUBROUTINE wrf_quilt_put_var_ti_logical <a name='4649'>
<a name='4650'>
<A NAME='WRF_QUILT_GET_VAR_TI_CHAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TI_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4651'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_char</font> ( DataHandle,Element,  Varname, Data,  Status )<a name='4652'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4653'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read time independent<a name='4654'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4655'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4656'></font>
<font color=#447700>! Attribute of type char is<a name='4657'></font>
<font color=#447700>! stored in string Data.<a name='4658'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4659'></font>
<font color=#447700>!<a name='4660'></font>
<font color=#447700>! This is not yet supported.<a name='4661'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4662'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4663'></font>
  IMPLICIT NONE<a name='4664'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4665'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4666'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4667'>
  CHARACTER*(*)               :: Data<a name='4668'>
  INTEGER                     :: Status<a name='4669'>
#endif<a name='4670'>
RETURN<a name='4671'>
END SUBROUTINE wrf_quilt_get_var_ti_char <a name='4672'>
<a name='4673'>
<A NAME='WRF_QUILT_PUT_VAR_TI_CHAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4674'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_char</font> ( DataHandle,Element,  Varname, Data,  Status ),<A href='../../call_from/WRF_QUILT_PUT_VAR_TI_CHAR.html' TARGET='index'>16</A><a name='4675'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4676'></font>
<font color=#447700>! Instruct the I/O quilt servers to write time independent<a name='4677'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4678'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4679'></font>
<font color=#447700>! Attribute of type char is<a name='4680'></font>
<font color=#447700>! copied from string Data.<a name='4681'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4682'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4683'></font>
<a name='4684'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4685'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_16"><a name='4686'>
  IMPLICIT NONE<a name='4687'>
  INCLUDE 'mpif.h'<a name='4688'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_18"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4689'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4690'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4691'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4692'>
  CHARACTER*(*) , INTENT(IN)  :: Data<a name='4693'>
  INTEGER                     :: Status<a name='4694'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group<a name='4695'>
  REAL dummy<a name='4696'>
<font color=#447700>!<a name='4697'></font>
<a name='4698'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='4699'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_278"> ( DEBUG_LVL, 'in wrf_quilt_put_var_ti_char' ) <a name='4700'>
<font color=#447700>!write(0,*)__FILE__,__LINE__,trim(varname),trim(element)<a name='4701'></font>
<a name='4702'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='4703'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='4704'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='4705'>
<a name='4706'>
#ifdef PNETCDF_QUILT<a name='4707'>
      IF ( compute_group_master(1,current_id) ) THEN<a name='4708'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_5">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='4709'>
                                      DataHandle, TRIM(Element),     &amp;<a name='4710'>
                                      TRIM(VarName), TRIM(Data), int_var_ti_char )<a name='4711'>
      ELSE<a name='4712'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_17">( hdrbuf, hdrbufsize, itypesize )<a name='4713'>
      ENDIF<a name='4714'>
#else<a name='4715'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='4716'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_6">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='4717'>
                                      DataHandle, TRIM(Element),     &amp;<a name='4718'>
                                      TRIM(VarName), TRIM(Data), int_var_ti_char )<a name='4719'>
      ELSE<a name='4720'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_18">( hdrbuf, hdrbufsize, itypesize )<a name='4721'>
      ENDIF<a name='4722'>
#endif<a name='4723'>
<a name='4724'>
      iserver = get_server_id ( DataHandle )<a name='4725'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_10">( comm_io_group , iserver )<a name='4726'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='4727'>
<a name='4728'>
<font color=#447700>!!JMTIMING      CALL start_timing<a name='4729'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='4730'></font>
      reduced = 0<a name='4731'>
      reduced(1) = hdrbufsize <a name='4732'>
#ifdef PNETCDF_QUILT<a name='4733'>
      IF ( compute_group_master(1,current_id) ) reduced(2) = DataHandle<a name='4734'>
#else<a name='4735'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='4736'>
#endif<a name='4737'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='4738'>
<font color=#447700>!!JMTIMING       CALL end_timing("MPI_Reduce in wrf_quilt_put_var_ti_char")<a name='4739'></font>
      <font color=#447700>! send data to the i/o processor<a name='4740'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_12">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='4741'>
                            onebyte,                       &amp;<a name='4742'>
                            hdrbuf, hdrbufsize , &amp;<a name='4743'>
                            dummy, 0 )<a name='4744'>
    ENDIF<a name='4745'>
  ENDIF<a name='4746'>
<font color=#447700>!!JMTIMING   CALL end_timing("wrf_quilt_put_dom_ti_char" )<a name='4747'></font>
<a name='4748'>
#endif<a name='4749'>
RETURN<a name='4750'>
END SUBROUTINE wrf_quilt_put_var_ti_char <a name='4751'>
<a name='4752'>
<A NAME='WRF_QUILT_GET_VAR_TD_REAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TD_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4753'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_real</font> ( DataHandle,Element,  DateStr,Varname, Data, Count, Outcount, Status )<a name='4754'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4755'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4756'></font>
<font color=#447700>! dependent attribute "Element" of variable "Varname" valid at time DateStr<a name='4757'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4758'></font>
<font color=#447700>! Attribute of type real is<a name='4759'></font>
<font color=#447700>! stored in array Data.<a name='4760'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4761'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4762'></font>
<font color=#447700>!<a name='4763'></font>
<font color=#447700>! This is not yet supported.<a name='4764'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4765'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4766'></font>
  IMPLICIT NONE<a name='4767'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4768'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4769'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4770'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4771'>
  real                        :: Data(*)<a name='4772'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4773'>
  INTEGER                     :: OutCount<a name='4774'>
  INTEGER                     :: Status<a name='4775'>
#endif<a name='4776'>
RETURN<a name='4777'>
END SUBROUTINE wrf_quilt_get_var_td_real <a name='4778'>
<a name='4779'>
<A NAME='WRF_QUILT_PUT_VAR_TD_REAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TD_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4780'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_real</font> ( DataHandle,Element,  DateStr,Varname, Data, Count,  Status )<a name='4781'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4782'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4783'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4784'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4785'></font>
<font color=#447700>! Attribute of type real is<a name='4786'></font>
<font color=#447700>! copied from array Data.<a name='4787'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4788'></font>
<font color=#447700>!<a name='4789'></font>
<font color=#447700>! This is not yet supported.<a name='4790'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4791'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4792'></font>
  IMPLICIT NONE<a name='4793'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4794'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4795'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4796'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4797'>
  real ,            INTENT(IN) :: Data(*)<a name='4798'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4799'>
  INTEGER                     :: Status<a name='4800'>
#endif<a name='4801'>
RETURN<a name='4802'>
END SUBROUTINE wrf_quilt_put_var_td_real <a name='4803'>
<a name='4804'>
<A NAME='WRF_QUILT_GET_VAR_TD_DOUBLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TD_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4805'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_double</font> ( DataHandle,Element,  DateStr,Varname, Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_VAR_TD_DOUBLE.html' TARGET='index'>2</A><a name='4806'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4807'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4808'></font>
<font color=#447700>! dependent attribute "Element" of variable "Varname" valid at time DateStr<a name='4809'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4810'></font>
<font color=#447700>! Attribute of type double is<a name='4811'></font>
<font color=#447700>! stored in array Data.<a name='4812'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4813'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4814'></font>
<font color=#447700>!<a name='4815'></font>
<font color=#447700>! This is not yet supported.<a name='4816'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4817'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4818'></font>
  IMPLICIT NONE<a name='4819'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4820'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4821'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4822'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4823'>
  real*8                      :: Data(*)<a name='4824'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4825'>
  INTEGER                     :: OutCount<a name='4826'>
  INTEGER                     :: Status<a name='4827'>
#endif<a name='4828'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TD_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_308">('wrf_quilt_get_var_td_double not supported yet')<a name='4829'>
RETURN<a name='4830'>
END SUBROUTINE wrf_quilt_get_var_td_double <a name='4831'>
<a name='4832'>
<A NAME='WRF_QUILT_PUT_VAR_TD_DOUBLE'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TD_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4833'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_double</font> ( DataHandle,Element,  DateStr,Varname, Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_VAR_TD_DOUBLE.html' TARGET='index'>2</A><a name='4834'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4835'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4836'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4837'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4838'></font>
<font color=#447700>! Attribute of type double is<a name='4839'></font>
<font color=#447700>! copied from array Data.<a name='4840'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4841'></font>
<font color=#447700>!<a name='4842'></font>
<font color=#447700>! This is not yet supported.<a name='4843'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4844'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4845'></font>
  IMPLICIT NONE<a name='4846'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4847'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4848'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4849'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4850'>
  real*8 ,            INTENT(IN) :: Data(*)<a name='4851'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4852'>
  INTEGER                     :: Status<a name='4853'>
#endif<a name='4854'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TD_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_309">('wrf_quilt_put_var_td_double not supported yet')<a name='4855'>
RETURN<a name='4856'>
END SUBROUTINE wrf_quilt_put_var_td_double <a name='4857'>
<a name='4858'>
<A NAME='WRF_QUILT_GET_VAR_TD_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4859'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_integer</font> ( DataHandle,Element,  DateStr,Varname, Data, Count, Outcount,Status)<a name='4860'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4861'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4862'></font>
<font color=#447700>! dependent attribute "Element" of variable "Varname" valid at time DateStr<a name='4863'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4864'></font>
<font color=#447700>! Attribute of type integer is<a name='4865'></font>
<font color=#447700>! stored in array Data.<a name='4866'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4867'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4868'></font>
<font color=#447700>!<a name='4869'></font>
<font color=#447700>! This is not yet supported.<a name='4870'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4871'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4872'></font>
  IMPLICIT NONE<a name='4873'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4874'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4875'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4876'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4877'>
  integer                     :: Data(*)<a name='4878'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4879'>
  INTEGER                     :: OutCount<a name='4880'>
  INTEGER                     :: Status<a name='4881'>
#endif<a name='4882'>
RETURN<a name='4883'>
END SUBROUTINE wrf_quilt_get_var_td_integer <a name='4884'>
<a name='4885'>
<A NAME='WRF_QUILT_PUT_VAR_TD_INTEGER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4886'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_integer</font> ( DataHandle,Element,  DateStr,Varname, Data, Count,  Status )<a name='4887'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4888'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4889'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4890'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4891'></font>
<font color=#447700>! Attribute of type integer is<a name='4892'></font>
<font color=#447700>! copied from array Data.<a name='4893'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4894'></font>
<font color=#447700>!<a name='4895'></font>
<font color=#447700>! This is not yet supported.<a name='4896'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4897'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4898'></font>
  IMPLICIT NONE<a name='4899'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4900'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4901'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4902'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4903'>
  integer ,       INTENT(IN)  :: Data(*)<a name='4904'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4905'>
  INTEGER                     :: Status<a name='4906'>
#endif<a name='4907'>
RETURN<a name='4908'>
END SUBROUTINE wrf_quilt_put_var_td_integer <a name='4909'>
<a name='4910'>
<A NAME='WRF_QUILT_GET_VAR_TD_LOGICAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TD_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4911'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_logical</font> ( DataHandle,Element,  DateStr,Varname, Data, Count, Outcount, Status )<a name='4912'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4913'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4914'></font>
<font color=#447700>! dependent attribute "Element" of variable "Varname" valid at time DateStr<a name='4915'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4916'></font>
<font color=#447700>! Attribute of type logical is<a name='4917'></font>
<font color=#447700>! stored in array Data.<a name='4918'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4919'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4920'></font>
<font color=#447700>!<a name='4921'></font>
<font color=#447700>! This is not yet supported.<a name='4922'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4923'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4924'></font>
  IMPLICIT NONE<a name='4925'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4926'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4927'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4928'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4929'>
  logical                          :: Data(*)<a name='4930'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4931'>
  INTEGER                      :: OutCount<a name='4932'>
  INTEGER                     :: Status<a name='4933'>
#endif<a name='4934'>
RETURN<a name='4935'>
END SUBROUTINE wrf_quilt_get_var_td_logical <a name='4936'>
<a name='4937'>
<A NAME='WRF_QUILT_PUT_VAR_TD_LOGICAL'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TD_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4938'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_logical</font> ( DataHandle,Element,  DateStr,Varname, Data, Count,  Status )<a name='4939'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4940'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4941'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4942'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4943'></font>
<font color=#447700>! Attribute of type logical is<a name='4944'></font>
<font color=#447700>! copied from array Data.<a name='4945'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4946'></font>
<font color=#447700>!<a name='4947'></font>
<font color=#447700>! This is not yet supported.<a name='4948'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4949'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4950'></font>
  IMPLICIT NONE<a name='4951'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4952'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4953'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4954'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4955'>
  logical ,            INTENT(IN) :: Data(*)<a name='4956'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4957'>
  INTEGER                     :: Status<a name='4958'>
#endif<a name='4959'>
RETURN<a name='4960'>
END SUBROUTINE wrf_quilt_put_var_td_logical <a name='4961'>
<a name='4962'>
<A NAME='WRF_QUILT_GET_VAR_TD_CHAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_TD_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4963'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_char</font> ( DataHandle,Element,  DateStr,Varname, Data,  Status )<a name='4964'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4965'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read time dependent<a name='4966'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4967'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4968'></font>
<font color=#447700>! Attribute of type char is<a name='4969'></font>
<font color=#447700>! stored in string Data.<a name='4970'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4971'></font>
<font color=#447700>!<a name='4972'></font>
<font color=#447700>! This is not yet supported.<a name='4973'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4974'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4975'></font>
  IMPLICIT NONE<a name='4976'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4977'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4978'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4979'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4980'>
  CHARACTER*(*)               :: Data<a name='4981'>
  INTEGER                     :: Status<a name='4982'>
#endif<a name='4983'>
RETURN<a name='4984'>
END SUBROUTINE wrf_quilt_get_var_td_char <a name='4985'>
<a name='4986'>
<A NAME='WRF_QUILT_PUT_VAR_TD_CHAR'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_PUT_VAR_TD_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4987'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_char</font> ( DataHandle,Element,  DateStr,Varname, Data,  Status )<a name='4988'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4989'></font>
<font color=#447700>! Instruct the I/O quilt servers to write time dependent<a name='4990'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4991'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4992'></font>
<font color=#447700>! Attribute of type char is<a name='4993'></font>
<font color=#447700>! copied from string Data.<a name='4994'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4995'></font>
<font color=#447700>!<a name='4996'></font>
<font color=#447700>! This is not yet supported.<a name='4997'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4998'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4999'></font>
  IMPLICIT NONE<a name='5000'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='5001'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='5002'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='5003'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='5004'>
  CHARACTER*(*) , INTENT(IN) :: Data<a name='5005'>
  INTEGER                    :: Status<a name='5006'>
#endif<a name='5007'>
RETURN<a name='5008'>
END SUBROUTINE wrf_quilt_put_var_td_char <a name='5009'>
<a name='5010'>
<A NAME='WRF_QUILT_READ_FIELD'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_READ_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5011'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_read_field</font> ( DataHandle , DateStr , VarName , Field , FieldType , Comm , IOComm, &amp;<a name='5012'>
                            DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='5013'>
                            DomainStart , DomainEnd ,                                    &amp;<a name='5014'>
                            MemoryStart , MemoryEnd ,                                    &amp;<a name='5015'>
                            PatchStart , PatchEnd ,                                      &amp;<a name='5016'>
                            Status )<a name='5017'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5018'></font>
<font color=#447700>! Instruct the I/O quilt servers to read the variable named VarName from the<a name='5019'></font>
<font color=#447700>! dataset pointed to by DataHandle.<a name='5020'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='5021'></font>
<font color=#447700>!<a name='5022'></font>
<font color=#447700>! This is not yet supported.<a name='5023'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5024'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5025'></font>
  IMPLICIT NONE<a name='5026'>
  INTEGER ,       INTENT(IN)    :: DataHandle <a name='5027'>
  CHARACTER*(*) , INTENT(INOUT) :: DateStr<a name='5028'>
  CHARACTER*(*) , INTENT(INOUT) :: VarName<a name='5029'>
  INTEGER ,       INTENT(INOUT) :: Field(*)<a name='5030'>
  integer                       ,intent(in)    :: FieldType<a name='5031'>
  integer                       ,intent(inout) :: Comm<a name='5032'>
  integer                       ,intent(inout) :: IOComm<a name='5033'>
  integer                       ,intent(in)    :: DomainDesc<a name='5034'>
  character*(*)                 ,intent(in)    :: MemoryOrder<a name='5035'>
  character*(*)                 ,intent(in)    :: Stagger<a name='5036'>
  character*(*) , dimension (*) ,intent(in)    :: DimNames<a name='5037'>
  integer ,dimension(*)         ,intent(in)    :: DomainStart, DomainEnd<a name='5038'>
  integer ,dimension(*)         ,intent(in)    :: MemoryStart, MemoryEnd<a name='5039'>
  integer ,dimension(*)         ,intent(in)    :: PatchStart,  PatchEnd<a name='5040'>
  integer                       ,intent(out)   :: Status<a name='5041'>
  Status = 0<a name='5042'>
#endif<a name='5043'>
RETURN<a name='5044'>
END SUBROUTINE wrf_quilt_read_field<a name='5045'>
<a name='5046'>
<A NAME='WRF_QUILT_WRITE_FIELD'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_WRITE_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5047'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_write_field</font> ( DataHandle , DateStr , VarName , Field , FieldType , Comm , IOComm,  &amp; <A href='../../call_to/WRF_QUILT_WRITE_FIELD.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_WRITE_FIELD.html' TARGET='index'>22</A><a name='5048'>
                             DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='5049'>
                             DomainStart , DomainEnd ,                                    &amp;<a name='5050'>
                             MemoryStart , MemoryEnd ,                                    &amp;<a name='5051'>
                             PatchStart , PatchEnd ,                                      &amp;<a name='5052'>
                             Status )<a name='5053'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5054'></font>
<font color=#447700>! Prepare instructions for the I/O quilt servers to write the variable named<a name='5055'></font>
<font color=#447700>! VarName to the dataset pointed to by DataHandle.<a name='5056'></font>
<font color=#447700>!<a name='5057'></font>
<font color=#447700>! During a "training" write this routine accumulates number and sizes of<a name='5058'></font>
<font color=#447700>! messages that will be sent to the I/O server associated with this compute<a name='5059'></font>
<font color=#447700>! (client) task.<a name='5060'></font>
<font color=#447700>!<a name='5061'></font>
<font color=#447700>! During a "real" write, this routine begins by allocating<a name='5062'></font>
<font color=#447700>! int_local_output_buffer if it has not already been allocated.  Sizes<a name='5063'></font>
<font color=#447700>! accumulated during "training" are used to determine how big<a name='5064'></font>
<font color=#447700>! int_local_output_buffer must be.  This routine then stores "int_field"<a name='5065'></font>
<font color=#447700>! headers and associated field data in int_local_output_buffer.  The contents<a name='5066'></font>
<font color=#447700>! of int_local_output_buffer are actually sent to the I/O quilt server in<a name='5067'></font>
<font color=#447700>! routine wrf_quilt_iosync().  This scheme allows output of multiple variables<a name='5068'></font>
<font color=#447700>! to be aggregated into a single "iosync" operation.<a name='5069'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='5070'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5071'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5072'></font>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_95"><a name='5073'>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_17"><a name='5074'>
  IMPLICIT NONE<a name='5075'>
  INCLUDE 'mpif.h'<a name='5076'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_19"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='5077'>
  INTEGER ,       INTENT(IN)    :: DataHandle <a name='5078'>
  CHARACTER*(*) , INTENT(IN)    :: DateStr<a name='5079'>
  CHARACTER*(*) , INTENT(IN)    :: VarName<a name='5080'>
<font color=#447700>!  INTEGER ,       INTENT(IN)    :: Field(*)<a name='5081'></font>
  integer                       ,intent(in)    :: FieldType<a name='5082'>
  integer                       ,intent(inout) :: Comm<a name='5083'>
  integer                       ,intent(inout) :: IOComm<a name='5084'>
  integer                       ,intent(in)    :: DomainDesc<a name='5085'>
  character*(*)                 ,intent(in)    :: MemoryOrder<a name='5086'>
  character*(*)                 ,intent(in)    :: Stagger<a name='5087'>
  character*(*) , dimension (*) ,intent(in)    :: DimNames<a name='5088'>
  integer ,dimension(*)         ,intent(in)    :: DomainStart, DomainEnd<a name='5089'>
  integer ,dimension(*)         ,intent(in)    :: MemoryStart, MemoryEnd<a name='5090'>
  integer ,dimension(*)         ,intent(in)    :: PatchStart,  PatchEnd<a name='5091'>
  integer                       ,intent(out)   :: Status<a name='5092'>
<a name='5093'>
  integer ii,jj,kk,myrank<a name='5094'>
<a name='5095'>
  REAL, DIMENSION( MemoryStart(1):MemoryEnd(1), &amp;<a name='5096'>
                   MemoryStart(2):MemoryEnd(2), &amp;<a name='5097'>
                   MemoryStart(3):MemoryEnd(3) ) :: Field<a name='5098'>
  INTEGER locsize , typesize, itypesize<a name='5099'>
  INTEGER ierr, tasks_in_group, comm_io_group, dummy, i<a name='5100'>
  INTEGER, EXTERNAL :: use_package<a name='5101'>
<a name='5102'>
<font color=#447700>!!ARPTIMING  CALL start_timing<a name='5103'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_279"> ( DEBUG_LVL, 'in wrf_quilt_write_field' ) <a name='5104'>
<a name='5105'>
  IF ( .NOT. (DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles) ) THEN<a name='5106'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_310">("frame/module_io_quilt.F: wrf_quilt_write_field: invalid data handle" )<a name='5107'>
  ENDIF<a name='5108'>
  IF ( .NOT. int_handle_in_use( DataHandle ) ) THEN<a name='5109'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_311">("frame/module_io_quilt.F: wrf_quilt_write_field: DataHandle not opened" )<a name='5110'>
  ENDIF<a name='5111'>
<a name='5112'>
  locsize = (PatchEnd(1)-PatchStart(1)+1)* &amp;<a name='5113'>
            (PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='5114'>
            (PatchEnd(3)-PatchStart(3)+1)<a name='5115'>
<a name='5116'>
  CALL mpi_type_size( MPI_INTEGER, itypesize, ierr )<a name='5117'>
  <font color=#447700>! Note that the WRF_DOUBLE branch of this IF statement must come first since <a name='5118'></font>
  <font color=#447700>! WRF_FLOAT is set equal to WRF_DOUBLE during autopromotion builds.  <a name='5119'></font>
  IF ( FieldType .EQ. WRF_DOUBLE ) THEN<a name='5120'>
    CALL mpi_type_size( MPI_DOUBLE_PRECISION, typesize, ierr )<a name='5121'>
  ELSE IF ( FieldType .EQ. WRF_FLOAT ) THEN<a name='5122'>
    CALL mpi_type_size( MPI_REAL, typesize, ierr )<a name='5123'>
  ELSE IF ( FieldType .EQ. WRF_INTEGER ) THEN<a name='5124'>
    CALL mpi_type_size( MPI_INTEGER, typesize, ierr )<a name='5125'>
  ELSE IF ( FieldType .EQ. WRF_LOGICAL ) THEN<a name='5126'>
    CALL mpi_type_size( MPI_LOGICAL, typesize, ierr )<a name='5127'>
  ENDIF<a name='5128'>
<a name='5129'>
  IF ( .NOT. okay_to_write( DataHandle ) ) THEN<a name='5130'>
<a name='5131'>
      <font color=#447700>! This is a "training" write.<a name='5132'></font>
      <font color=#447700>! it is not okay to actually write; what we do here is just "bookkeep": count up<a name='5133'></font>
      <font color=#447700>! the number and size of messages that we will output to io server associated with<a name='5134'></font>
      <font color=#447700>! this task<a name='5135'></font>
<a name='5136'>
      CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_WRITE_FIELD_HEADER'>int_gen_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_WRITE_FIELD_HEADER_1"> ( hdrbuf, hdrbufsize, itypesize, typesize,           &amp;<a name='5137'>
                               DataHandle , DateStr , VarName , Field , FieldType , Comm , IOComm,  &amp;<a name='5138'>
                               333933         , MemoryOrder , Stagger , DimNames ,              &amp;   <font color=#447700>! 333933 means training; magic number<a name='5139'></font>
                               DomainStart , DomainEnd ,                                    &amp;<a name='5140'>
                               MemoryStart , MemoryEnd ,                                    &amp;<a name='5141'>
                               PatchStart , PatchEnd )<a name='5142'>
<a name='5143'>
      int_num_bytes_to_write(DataHandle) = int_num_bytes_to_write(DataHandle) + locsize * typesize + hdrbufsize<a name='5144'>
<a name='5145'>
      <font color=#447700>! Send the hdr for the write in case the interface is calling the I/O API in "learn" mode<a name='5146'></font>
<a name='5147'>
      iserver = get_server_id ( DataHandle )<a name='5148'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_11">( comm_io_group , iserver )<a name='5149'>
      <font color=#447700>! send the size of my local buffer to the i/o task (obufsize doesnt mean anything here)<a name='5150'></font>
<a name='5151'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='5152'>
<a name='5153'>
#if 0<a name='5154'>
      IF ( .NOT. wrf_dm_on_monitor() ) THEN     <font color=#447700>! only one task in compute grid sends this message; send noops on others<a name='5155'></font>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_19">( hdrbuf, hdrbufsize, itypesize )<a name='5156'>
      ENDIF<a name='5157'>
#endif<a name='5158'>
<a name='5159'>
<a name='5160'>
<font color=#447700>!!ARPTIMING      CALL start_timing<a name='5161'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='5162'></font>
      reduced = 0<a name='5163'>
      reduced(1) = hdrbufsize <a name='5164'>
#ifdef PNETCDF_QUILT<a name='5165'>
      IF ( compute_group_master(1,current_id) ) reduced(2) = DataHandle<a name='5166'>
#else<a name='5167'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='5168'>
#endif<a name='5169'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='5170'>
<font color=#447700>!!ARPTIMING      CALL end_timing("MPI_Reduce in wrf_quilt_write_field dryrun")<a name='5171'></font>
      <font color=#447700>! send data to the i/o processor<a name='5172'></font>
<a name='5173'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_13">(__FILE__,__LINE__, comm_io_group,                   &amp;<a name='5174'>
                            onebyte,                          &amp;<a name='5175'>
                            hdrbuf, hdrbufsize ,                 &amp;<a name='5176'>
                            dummy, 0 )<a name='5177'>
<a name='5178'>
  ELSE<a name='5179'>
<a name='5180'>
    IF ( .NOT. associated( int_local_output_buffer ) ) THEN<a name='5181'>
      ALLOCATE ( int_local_output_buffer( (int_num_bytes_to_write( DataHandle )+1)/itypesize ), Stat=ierr )<a name='5182'>
      IF(ierr /= 0)THEN<a name='5183'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_312">("frame/module_io_quilt.F: wrf_quilt_write_field: allocate of int_local_output_buffer failed" )<a name='5184'>
      END IF<a name='5185'>
      int_local_output_cursor = 1<a name='5186'>
    ENDIF<a name='5187'>
      iserver = get_server_id ( DataHandle )<a name='5188'>
<a name='5189'>
    <font color=#447700>! This is NOT a "training" write.  It is OK to write now.<a name='5190'></font>
    CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_WRITE_FIELD_HEADER'>int_gen_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_WRITE_FIELD_HEADER_2"> ( hdrbuf, hdrbufsize, itypesize, typesize,           &amp;<a name='5191'>
                             DataHandle , DateStr , VarName , Field , FieldType , Comm , IOComm,  &amp;<a name='5192'>
                             0          , MemoryOrder , Stagger , DimNames ,              &amp;   <font color=#447700>! non-333933 means okay to write; magic number<a name='5193'></font>
                             DomainStart , DomainEnd ,                                    &amp;<a name='5194'>
                             MemoryStart , MemoryEnd ,                                    &amp;<a name='5195'>
                             PatchStart , PatchEnd )<a name='5196'>
<a name='5197'>
    <font color=#447700>! Pack header into int_local_output_buffer.  It will be sent to the <a name='5198'></font>
    <font color=#447700>! I/O servers during the next "iosync" operation.  <a name='5199'></font>
#ifdef DEREF_KLUDGE<a name='5200'>
    CALL int_pack_data ( hdrbuf , hdrbufsize , int_local_output_buffer(1), int_local_output_cursor )<a name='5201'>
#else<a name='5202'>
    CALL int_pack_data ( hdrbuf , hdrbufsize , int_local_output_buffer, int_local_output_cursor )<a name='5203'>
#endif<a name='5204'>
<a name='5205'>
    <font color=#447700>! Pack field data into int_local_output_buffer.  It will be sent to the <a name='5206'></font>
    <font color=#447700>! I/O servers during the next "iosync" operation.  <a name='5207'></font>
#ifdef DEREF_KLUDGE<a name='5208'>
    CALL int_pack_data ( Field(PatchStart(1):PatchEnd(1),PatchStart(2):PatchEnd(2),PatchStart(3):PatchEnd(3) ), &amp;<a name='5209'>
                                  locsize * typesize , int_local_output_buffer(1), int_local_output_cursor )<a name='5210'>
#else<a name='5211'>
    CALL int_pack_data ( Field(PatchStart(1):PatchEnd(1),PatchStart(2):PatchEnd(2),PatchStart(3):PatchEnd(3) ), &amp;<a name='5212'>
                                  locsize * typesize , int_local_output_buffer, int_local_output_cursor )<a name='5213'>
#endif<a name='5214'>
<a name='5215'>
  ENDIF<a name='5216'>
  Status = 0<a name='5217'>
<font color=#447700>!!ARPTIMING  CALL end_timing("wrf_quilt_write_field")<a name='5218'></font>
<a name='5219'>
#endif<a name='5220'>
  RETURN<a name='5221'>
END SUBROUTINE wrf_quilt_write_field<a name='5222'>
<a name='5223'>
<A NAME='WRF_QUILT_GET_VAR_INFO'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_GET_VAR_INFO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5224'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_info</font> ( DataHandle , VarName , NDim , MemoryOrder , Stagger , &amp; <A href='../../call_to/WRF_QUILT_GET_VAR_INFO.html' TARGET='index'>1</A><a name='5225'>
                              DomainStart , DomainEnd , Status )<a name='5226'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5227'></font>
<font color=#447700>! This routine applies only to a dataset that is open for read.  It instructs<a name='5228'></font>
<font color=#447700>! the I/O quilt servers to return information about variable VarName.<a name='5229'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='5230'></font>
<font color=#447700>!<a name='5231'></font>
<font color=#447700>! This is not yet supported.<a name='5232'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5233'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5234'></font>
  IMPLICIT NONE<a name='5235'>
  integer               ,intent(in)     :: DataHandle<a name='5236'>
  character*(*)         ,intent(in)     :: VarName<a name='5237'>
  integer                               :: NDim<a name='5238'>
  character*(*)                         :: MemoryOrder<a name='5239'>
  character*(*)                         :: Stagger<a name='5240'>
  integer ,dimension(*)                 :: DomainStart, DomainEnd<a name='5241'>
  integer                               :: Status<a name='5242'>
#endif<a name='5243'>
RETURN<a name='5244'>
END SUBROUTINE wrf_quilt_get_var_info<a name='5245'>
<a name='5246'>
<A NAME='WRF_QUILT_FIND_SERVER'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_FIND_SERVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5247'>
<font color=#993300>subroutine </font><font color=#cc0000>wrf_quilt_find_server</font>(iserver) <A href='../../call_to/WRF_QUILT_FIND_SERVER.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_QUILT_FIND_SERVER.html' TARGET='index'>10</A><a name='5248'>
<a name='5249'>
  <font color=#447700>! This routine is called by the compute processes when they need an<a name='5250'></font>
  <font color=#447700>! I/O server to write out a new file.  Upon return, this routine will<a name='5251'></font>
  <font color=#447700>! set iserver to the next available I/O server group.  <a name='5252'></font>
<a name='5253'>
  <font color=#447700>! A mpi_recv to all of mpi_comm_avail is used to implement this, and<a name='5254'></font>
  <font color=#447700>! that recv will not return until an I/O server group calls<a name='5255'></font>
  <font color=#447700>! wrf_quilt_server_ready to signal that it is ready for a new file.<a name='5256'></font>
<a name='5257'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5258'></font>
  use <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_18">, only : in_avail, mpi_comm_avail, mpi_comm_local<a name='5259'>
<a name='5260'>
  implicit none<a name='5261'>
  INCLUDE 'mpif.h'<a name='5262'>
  integer, intent(inout) :: iserver<a name='5263'>
  integer :: ierr<a name='5264'>
  character(255) :: message<a name='5265'>
<a name='5266'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_348">('Polling I/O servers...')<a name='5267'>
<a name='5268'>
  if(in_avail) then<a name='5269'>
     call mpi_recv(iserver,1,MPI_INTEGER,MPI_ANY_SOURCE,0,mpi_comm_avail,MPI_STATUS_IGNORE,ierr)<a name='5270'>
     if(ierr/=0) then<a name='5271'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_313">('mpi_recv failed in wrf_quilt_find_server')<a name='5272'>
     endif<a name='5273'>
  endif<a name='5274'>
<a name='5275'>
  call mpi_bcast(iserver,1,MPI_INTEGER,0,mpi_comm_local,ierr)<a name='5276'>
  if(ierr/=0) then<a name='5277'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_314">('mpi_bcast failed in wrf_quilt_find_server')<a name='5278'>
  endif<a name='5279'>
<a name='5280'>
  write(message,'("I/O server ",I0," is ready for operations.")') iserver<a name='5281'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_349">(message)<a name='5282'>
<a name='5283'>
#endif<a name='5284'>
<a name='5285'>
end subroutine wrf_quilt_find_server<a name='5286'>
<A NAME='WRF_QUILT_SERVER_READY'><A href='../../html_code/frame/module_io_quilt_new.F.html#WRF_QUILT_SERVER_READY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5287'>
<font color=#993300>subroutine </font><font color=#cc0000>wrf_quilt_server_ready</font>() <A href='../../call_to/WRF_QUILT_SERVER_READY.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_QUILT_SERVER_READY.html' TARGET='index'>14</A><a name='5288'>
<a name='5289'>
  <font color=#447700>! This routine is called by the I/O server group's master process once the<a name='5290'></font>
  <font color=#447700>! I/O server group is done writing its current file, and is waiting for<a name='5291'></font>
  <font color=#447700>! a new one.  This information is passed to the monitor process by a <a name='5292'></font>
  <font color=#447700>! blocking send from the I/O server master process to the monitor.  <a name='5293'></font>
<a name='5294'>
  <font color=#447700>! All processes in an I/O group must call this routine, and this routine<a name='5295'></font>
  <font color=#447700>! will not return (in any process) until the monitor process signals <a name='5296'></font>
  <font color=#447700>! that it wants the I/O server group to write a file.  That signal is<a name='5297'></font>
  <font color=#447700>! sent in a call to wrf_quilt_find_server on the compute processes.<a name='5298'></font>
<a name='5299'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5300'></font>
  use <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_19">, only : mpi_comm_local, in_avail, availrank, mpi_comm_avail<a name='5301'>
<a name='5302'>
  implicit none<a name='5303'>
  INCLUDE 'mpif.h'<a name='5304'>
  integer :: ierr<a name='5305'>
  character*255 :: message<a name='5306'>
<a name='5307'>
  write(message,*) 'Entering wrf_quilt_server_ready.'<a name='5308'>
  call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_280">(1,message)<a name='5309'>
<a name='5310'>
  call mpi_barrier(mpi_comm_local,ierr)<a name='5311'>
  if(ierr/=0) then<a name='5312'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_315">('mpi_barrier failed in wrf_quilt_server_ready')<a name='5313'>
  endif<a name='5314'>
<a name='5315'>
  if(in_avail) then<a name='5316'>
     write(message,'("mpi_ssend ioserver=",I0," in wrf_quilt_server_ready")') availrank<a name='5317'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_281">(1,message)<a name='5318'>
     call mpi_ssend(availrank,1,MPI_INTEGER,0,0,mpi_comm_avail,ierr)<a name='5319'>
     if(ierr/=0) then<a name='5320'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_316">('mpi_ssend failed in wrf_quilt_server_ready')<a name='5321'>
     endif<a name='5322'>
  endif<a name='5323'>
<a name='5324'>
  call mpi_barrier(mpi_comm_local,ierr)<a name='5325'>
  if(ierr/=0) then<a name='5326'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_317">('mpi_barrier failed in wrf_quilt_server_ready')<a name='5327'>
  endif<a name='5328'>
<a name='5329'>
  write(message,*) 'Leaving wrf_quilt_server_ready.'<a name='5330'>
  call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_282">(1,message)<a name='5331'>
#endif<a name='5332'>
<a name='5333'>
end subroutine wrf_quilt_server_ready<a name='5334'>
<a name='5335'>
<A NAME='GET_MPI_COMM_IO_GROUPS'><A href='../../html_code/frame/module_io_quilt_new.F.html#GET_MPI_COMM_IO_GROUPS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5336'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>get_mpi_comm_io_groups</font>( retval, isrvr ) <A href='../../call_to/GET_MPI_COMM_IO_GROUPS.html' TARGET='index'>22</A>,<A href='../../call_from/GET_MPI_COMM_IO_GROUPS.html' TARGET='index'>3</A><a name='5337'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5338'></font>
<font color=#447700>! This routine returns the compute+io communicator to which this<a name='5339'></font>
<font color=#447700>! compute task belongs for I/O server group "isrvr".<a name='5340'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='5341'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5342'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5343'></font>
      USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_20"><a name='5344'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_130">, ONLY : current_id  <a name='5345'>
      IMPLICIT NONE<a name='5346'>
      INTEGER, INTENT(IN ) :: isrvr<a name='5347'>
      INTEGER, INTENT(OUT) :: retval<a name='5348'>
      retval = mpi_comm_io_groups(isrvr,current_id)<a name='5349'>
#endif<a name='5350'>
      RETURN<a name='5351'>
END SUBROUTINE get_mpi_comm_io_groups<a name='5352'>
<a name='5353'>
<A NAME='GET_NIO_TASKS_IN_GROUP'><A href='../../html_code/frame/module_io_quilt_new.F.html#GET_NIO_TASKS_IN_GROUP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5354'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>get_nio_tasks_in_group</font>( id, retval ) <A href='../../call_to/GET_NIO_TASKS_IN_GROUP.html' TARGET='index'>1</A>,<A href='../../call_from/GET_NIO_TASKS_IN_GROUP.html' TARGET='index'>2</A><a name='5355'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5356'></font>
<font color=#447700>! This routine returns the number of I/O server tasks in each <a name='5357'></font>
<font color=#447700>! I/O server group.  It can be called by both clients and <a name='5358'></font>
<font color=#447700>! servers.  <a name='5359'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5360'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5361'></font>
      USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_NIO_TASKS_IN_GROUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_21"><a name='5362'>
      IMPLICIT NONE<a name='5363'>
      INTEGER, INTENT(IN) :: id<a name='5364'>
      INTEGER, INTENT(OUT) :: retval<a name='5365'>
      retval = nio_tasks_per_group(id)<a name='5366'>
#endif<a name='5367'>
      RETURN<a name='5368'>
END SUBROUTINE get_nio_tasks_in_group<a name='5369'>
<a name='5370'>
<A NAME='COLLECT_ON_COMM_DEBUG'><A href='../../html_code/frame/module_io_quilt_new.F.html#COLLECT_ON_COMM_DEBUG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5371'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>collect_on_comm_debug</font>(file,line, comm_io_group,   &amp; <A href='../../call_to/COLLECT_ON_COMM_DEBUG.html' TARGET='index'>26</A><a name='5372'>
                        sze,                                 &amp;<a name='5373'>
                        hdrbuf, hdrbufsize ,                 &amp;<a name='5374'>
                        outbuf, outbufsize                   )<a name='5375'>
  IMPLICIT NONE<a name='5376'>
  CHARACTER*(*) file<a name='5377'>
  INTEGER line<a name='5378'>
  INTEGER comm_io_group<a name='5379'>
  INTEGER sze<a name='5380'>
  INTEGER hdrbuf(*), outbuf(*)<a name='5381'>
  INTEGER hdrbufsize, outbufsize <a name='5382'>
<a name='5383'>
  <font color=#447700>!write(0,*)'collect_on_comm_debug ',trim(file),line,sze,hdrbufsize,outbufsize<a name='5384'></font>
  CALL collect_on_comm( comm_io_group,                       &amp;<a name='5385'>
                        sze,                                 &amp;<a name='5386'>
                        hdrbuf, hdrbufsize ,                 &amp;<a name='5387'>
                        outbuf, outbufsize                   )<a name='5388'>
  <font color=#447700>!write(0,*)trim(file),line,'returning'<a name='5389'></font>
  RETURN<a name='5390'>
END<a name='5391'>
<a name='5392'>
<a name='5393'>
<A NAME='COLLECT_ON_COMM_DEBUG2'><A href='../../html_code/frame/module_io_quilt_new.F.html#COLLECT_ON_COMM_DEBUG2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5394'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>collect_on_comm_debug2</font>(file,line,var,tag,sz,hdr_rec_size, &amp; <A href='../../call_to/COLLECT_ON_COMM_DEBUG2.html' TARGET='index'>2</A><a name='5395'>
                        comm_io_group,                       &amp;<a name='5396'>
                        sze,                                 &amp;<a name='5397'>
                        hdrbuf, hdrbufsize ,                 &amp;<a name='5398'>
                        outbuf, outbufsize                   )<a name='5399'>
  IMPLICIT NONE<a name='5400'>
  CHARACTER*(*) file,var<a name='5401'>
  INTEGER line,tag,sz,hdr_rec_size<a name='5402'>
  INTEGER comm_io_group<a name='5403'>
  INTEGER sze<a name='5404'>
  INTEGER hdrbuf(*), outbuf(*)<a name='5405'>
  INTEGER hdrbufsize, outbufsize<a name='5406'>
<a name='5407'>
<font color=#447700>!  write(0,*)'collect_on_comm_debug2 ',trim(file),line,trim(var),tag,sz,hdr_rec_size,sze,hdrbufsize,outbufsize<a name='5408'></font>
  CALL collect_on_comm( comm_io_group,                       &amp;<a name='5409'>
                        sze,                                 &amp;<a name='5410'>
                        hdrbuf, hdrbufsize ,                 &amp;<a name='5411'>
                        outbuf, outbufsize                   )<a name='5412'>
<font color=#447700>!  write(0,*)'collect_on_comm_debug2 ',trim(file),line,'returning for ',trim(var)<a name='5413'></font>
  RETURN<a name='5414'>
END<a name='5415'>
</pre></body></html>