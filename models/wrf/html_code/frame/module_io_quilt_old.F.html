<HTML> <BODY BGCOLOR=#eeddee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:DRIVER_LAYER:IO<a name='2'></font>
<font color=#447700>!<a name='3'></font>
#define DEBUG_LVL 50<a name='4'>
<font color=#447700>!#define mpi_x_comm_size(i,j,k)  Mpi_Comm_Size ( i,j,k ) ; write(0,*) __LINE__<a name='5'></font>
#define mpi_x_comm_size(i,j,k)  Mpi_Comm_Size ( i,j,k )<a name='6'>
<a name='7'>
<font color=#447700>! Workaround for bug in the IBM MPI implementation.  Look near the<a name='8'></font>
<font color=#447700>! bottom of this file for an explanation.<a name='9'></font>
#ifdef IBM_REDUCE_BUG_WORKAROUND<a name='10'>
#define mpi_x_reduce(sb,rb,c,dt,op,r,com,ierr) reduce_add_integer(sb,rb,c,r,com)<a name='11'>
#else<a name='12'>
#define mpi_x_reduce(sb,rb,c,dt,op,r,com,ierr) MPI_Reduce(sb,rb,c,dt,op,r,com,ierr)<a name='13'>
<font color=#447700>!#define mpi_x_reduce(sb,rb,c,dt,op,r,com,ierr) MPI_Reduce(sb,rb,c,dt,op,r,com,ierr) ; write(0,*)__LINE__<a name='14'></font>
#endif<a name='15'>
<a name='16'>
<A NAME='MODULE_WRF_QUILT'><A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='17'>
<font color=#993300>MODULE </font><font color=#cc0000>module_wrf_quilt</font> <A href='../../call_to/MODULE_WRF_QUILT.html' TARGET='index'>44</A><a name='18'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='19'></font>
<font color=#447700>!&lt;PRE&gt;<a name='20'></font>
<font color=#447700>! This module contains WRF-specific I/O quilt routines called by both <a name='21'></font>
<font color=#447700>! client (compute) and server (I/O quilt) tasks.  I/O quilt servers are <a name='22'></font>
<font color=#447700>! a run-time optimization that allow I/O operations, executed on the I/O <a name='23'></font>
<font color=#447700>! quilt server tasks, to be overlapped with useful computation, executed on <a name='24'></font>
<font color=#447700>! the compute tasks.  Since I/O operations are often quite slow compared to <a name='25'></font>
<font color=#447700>! computation, this performance optimization can increase parallel <a name='26'></font>
<font color=#447700>! efficiency.  <a name='27'></font>
<font color=#447700>!<a name='28'></font>
<font color=#447700>! Currently, one group of I/O servers can be specified at run-time.  Namelist <a name='29'></font>
<font color=#447700>! variable "nio_tasks_per_group" is used to specify the number of I/O server <a name='30'></font>
<font color=#447700>! tasks in this group.  In most cases, parallel efficiency is optimized when <a name='31'></font>
<font color=#447700>! the minimum number of I/O server tasks are used.  If memory needed to cache <a name='32'></font>
<font color=#447700>! I/O operations fits on a single processor, then set nio_tasks_per_group=1.  <a name='33'></font>
<font color=#447700>! If not, increase the number of I/O server tasks until I/O operations fit in <a name='34'></font>
<font color=#447700>! memory.  In the future, multiple groups of I/O server tasks will be <a name='35'></font>
<font color=#447700>! supported.  The number of groups will be specified by namelist variable <a name='36'></font>
<font color=#447700>! "nio_groups".  For now, nio_groups must be set to 1.  Currently, I/O servers <a name='37'></font>
<font color=#447700>! only support overlap of output operations with computation.  Also, only I/O <a name='38'></font>
<font color=#447700>! packages that do no support native parallel I/O may be used with I/O server <a name='39'></font>
<font color=#447700>! tasks.  This excludes PHDF5 and MCEL.  <a name='40'></font>
<font color=#447700>!<a name='41'></font>
<font color=#447700>! In this module, the I/O quilt server tasks call package-dependent <a name='42'></font>
<font color=#447700>! WRF-specific I/O interfaces to perform I/O operations requested by the <a name='43'></font>
<font color=#447700>! client (compute) tasks.  All of these calls occur inside subroutine <a name='44'></font>
<font color=#447700>! quilt().  <a name='45'></font>
<font color=#447700>! <a name='46'></font>
<font color=#447700>! The client (compute) tasks call package-independent WRF-specific "quilt I/O" <a name='47'></font>
<font color=#447700>! interfaces that send requests to the I/O quilt servers.  All of these calls <a name='48'></font>
<font color=#447700>! are made from module_io.F.  <a name='49'></font>
<font color=#447700>!<a name='50'></font>
<font color=#447700>! These routines have the same names and (roughly) the same arguments as those <a name='51'></font>
<font color=#447700>! specified in the WRF I/O API except that:<a name='52'></font>
<font color=#447700>! - "Quilt I/O" routines defined in this file and called by routines in <a name='53'></font>
<font color=#447700>!   module_io.F have the "wrf_quilt_" prefix.<a name='54'></font>
<font color=#447700>! - Package-dependent routines called from routines in this file are defined <a name='55'></font>
<font color=#447700>!   in the external I/O packages and have the "ext_" prefix.<a name='56'></font>
<font color=#447700>!<a name='57'></font>
<font color=#447700>! Both client (compute) and server tasks call routine init_module_wrf_quilt() <a name='58'></font>
<font color=#447700>! which then calls setup_quilt_servers() determine which tasks are compute <a name='59'></font>
<font color=#447700>! tasks and which are server tasks.  Before the end of init_module_wrf_quilt() <a name='60'></font>
<font color=#447700>! server tasks call routine quilt() and remain there for the rest of the model <a name='61'></font>
<font color=#447700>! run.  Compute tasks return from init_module_wrf_quilt() to perform model <a name='62'></font>
<font color=#447700>! computations.  <a name='63'></font>
<font color=#447700>!<a name='64'></font>
<font color=#447700>! See http://www.mmm.ucar.edu/wrf/WG2/software_2.0/IOAPI.doc for the latest<a name='65'></font>
<font color=#447700>! version of the WRF I/O API.  This document includes detailed descriptions<a name='66'></font>
<font color=#447700>! of subroutines and their arguments that are not duplicated here.<a name='67'></font>
<font color=#447700>!&lt;/PRE&gt;<a name='68'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='69'></font>
  USE <A href='../../html_code/frame/module_internal_header_util.F.html#MODULE_INTERNAL_HEADER_UTIL'>module_internal_header_util</A><A href='../../html_code/frame/module_io_quilt_old.F.html#module_io_quilt_old.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_INTERNAL_HEADER_UTIL_3"><a name='70'>
  USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_io_quilt_old.F.html#module_io_quilt_old.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_28"><a name='71'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='72'></font>
  USE <A href='../../html_code/frame/module_cpl.F.html#MODULE_CPL'>module_cpl</A><A href='../../html_code/frame/module_io_quilt_old.F.html#module_io_quilt_old.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CPL_6">, ONLY : coupler_on, cpl_set_dm_communicator, cpl_finalize<a name='73'>
#endif<a name='74'>
<a name='75'>
  INTEGER, PARAMETER :: int_num_handles = 99<a name='76'>
  INTEGER, PARAMETER :: max_servers = int_num_handles+1  <font color=#447700>! why +1?<a name='77'></font>
  LOGICAL, DIMENSION(0:int_num_handles) :: okay_to_write, int_handle_in_use, okay_to_commit<a name='78'>
  INTEGER, DIMENSION(0:int_num_handles) :: int_num_bytes_to_write, io_form<a name='79'>
  REAL, POINTER,SAVE :: int_local_output_buffer(:)<a name='80'>
  INTEGER,      SAVE :: int_local_output_cursor<a name='81'>
  LOGICAL          :: quilting_enabled<a name='82'>
  LOGICAL          :: disable_quilt = .FALSE.<a name='83'>
  INTEGER          :: prev_server_for_handle = -1<a name='84'>
  INTEGER          :: server_for_handle(int_num_handles)<a name='85'>
  INTEGER          :: reduced(2), reduced_dummy(2)<a name='86'>
  LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='87'>
<a name='88'>
  INTEGER :: mpi_comm_avail,availrank<a name='89'>
  LOGICAL :: in_avail=.false., poll_servers=.false.<a name='90'>
<a name='91'>
  INTEGER nio_groups<a name='92'>
#ifdef DM_PARALLEL<a name='93'>
  INTEGER :: mpi_comm_local<a name='94'>
  LOGICAL :: compute_node<a name='95'>
  LOGICAL :: compute_group_master(max_servers)<a name='96'>
  INTEGER :: mpi_comm_io_groups(max_servers)<a name='97'>
  INTEGER :: nio_tasks_in_group<a name='98'>
  INTEGER :: nio_tasks_per_group<a name='99'>
  INTEGER :: ncompute_tasks<a name='100'>
  INTEGER :: ntasks<a name='101'>
  INTEGER :: mytask<a name='102'>
<a name='103'>
  INTEGER, PARAMETER           :: onebyte = 1<a name='104'>
  INTEGER comm_io_servers, iserver, hdrbufsize, obufsize<a name='105'>
  INTEGER, DIMENSION(4096)     :: hdrbuf<a name='106'>
  INTEGER, DIMENSION(int_num_handles)     :: handle<a name='107'>
#endif<a name='108'>
<a name='109'>
#ifdef IBM_REDUCE_BUG_WORKAROUND<a name='110'>
<font color=#447700>! Workaround for bug in the IBM MPI implementation.  Look near the<a name='111'></font>
<font color=#447700>! bottom of this file for an explanation.<a name='112'></font>
<A NAME='REDUCE_ADD_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='113'>
  <font color=#993300>interface </font><font color=#cc0000>reduce_add_integer</font><a name='114'>
     module procedure <A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR'>reduce_add_int_arr</A><A NAME="REDUCE_ADD_INT_ARR_2"><A href='../../html_code/frame/module_io_quilt_old.F.html#module_io_quilt_old.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='115'>
     module procedure <A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL'>reduce_add_int_scl</A><A NAME="REDUCE_ADD_INT_SCL_2"><A href='../../html_code/frame/module_io_quilt_old.F.html#module_io_quilt_old.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='116'>
  end interface<a name='117'>
#endif<a name='118'>
<a name='119'>
  CONTAINS<a name='120'>
<a name='121'>
#if  defined(DM_PARALLEL)  &amp;&amp;  <font color=#447700>!defined( STUBMPI )<a name='122'></font>
<A NAME='GET_SERVER_ID'><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_SERVER_ID' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='123'>
    INTEGER <font color=#993300>FUNCTION </font><font color=#cc0000>get_server_id</font> ( dhandle ),<A href='../../call_from/GET_SERVER_ID.html' TARGET='index'>5</A><a name='124'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='125'></font>
<font color=#447700>! Logic in the client side to know which io server<a name='126'></font>
<font color=#447700>! group to send to. If the unit corresponds to a file that's<a name='127'></font>
<font color=#447700>! already been opened, then we have no choice but to send the<a name='128'></font>
<font color=#447700>! data to that group again, regardless of whether there are<a name='129'></font>
<font color=#447700>! other server-groups. If it's a new file, we can chose a new<a name='130'></font>
<font color=#447700>! server group. I.e. opening a file locks it onto a server<a name='131'></font>
<font color=#447700>! group. Closing the file unlocks it.<a name='132'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='133'></font>
      IMPLICIT NONE<a name='134'>
      INTEGER, INTENT(IN) :: dhandle<a name='135'>
      IF ( dhandle .GE. 1 .AND. dhandle .LE. int_num_handles ) THEN<a name='136'>
        IF ( server_for_handle ( dhandle ) .GE. 1 ) THEN<a name='137'>
          get_server_id = server_for_handle ( dhandle )<a name='138'>
        ELSE<a name='139'>
           IF(poll_servers) THEN<a name='140'>
              <font color=#447700>! Poll server group masters to find an inactive I/O server group:<a name='141'></font>
              call <A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER'>wrf_quilt_find_server</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_SERVER_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_QUILT_FIND_SERVER_3">(server_for_handle(dhandle))<a name='142'>
           ELSE<a name='143'>
              <font color=#447700>! Server polling is disabled, so cycle through servers:<a name='144'></font>
              prev_server_for_handle = mod ( prev_server_for_handle + 1 , nio_groups )<a name='145'>
              server_for_handle( dhandle ) = prev_server_for_handle+1<a name='146'>
           ENDIF<a name='147'>
           get_server_id=server_for_handle(dhandle)<a name='148'>
        ENDIF<a name='149'>
      ELSE<a name='150'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_SERVER_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_350">('module_io_quilt: get_server_id bad dhandle' )<a name='151'>
      ENDIF<a name='152'>
    END FUNCTION get_server_id<a name='153'>
#endif<a name='154'>
<a name='155'>
<A NAME='SET_SERVER_ID'><A href='../../html_code/frame/module_io_quilt_old.F.html#SET_SERVER_ID' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='156'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>set_server_id</font> ( dhandle, value ) <A href='../../call_to/SET_SERVER_ID.html' TARGET='index'>2</A>,<A href='../../call_from/SET_SERVER_ID.html' TARGET='index'>3</A><a name='157'>
       IMPLICIT NONE<a name='158'>
       INTEGER, INTENT(IN) :: dhandle, value<a name='159'>
       IF ( dhandle .GE. 1 .AND. dhandle .LE. int_num_handles ) THEN<a name='160'>
         server_for_handle(dhandle) = value<a name='161'>
       ELSE<a name='162'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SET_SERVER_ID' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_351">('module_io_quilt: set_server_id bad dhandle' )<a name='163'>
       ENDIF<a name='164'>
    END SUBROUTINE set_server_id<a name='165'>
<a name='166'>
<A NAME='GET_POLL_SERVERS'><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_POLL_SERVERS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='167'>
    LOGICAL <font color=#993300>FUNCTION </font><font color=#cc0000>get_poll_servers</font>() <a name='168'>
      implicit none<a name='169'>
      get_poll_servers=poll_servers<a name='170'>
    end FUNCTION get_poll_servers<a name='171'>
<a name='172'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='173'></font>
<A NAME='INT_GET_FRESH_HANDLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#INT_GET_FRESH_HANDLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='174'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>int_get_fresh_handle</font>( retval ) <A href='../../call_to/INT_GET_FRESH_HANDLE.html' TARGET='index'>4</A>,<A href='../../call_from/INT_GET_FRESH_HANDLE.html' TARGET='index'>2</A><a name='175'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='176'></font>
<font color=#447700>! Find an unused "client file handle" and return it in retval.<a name='177'></font>
<font color=#447700>! The "client file handle" is used to remember how a file was opened<a name='178'></font>
<font color=#447700>! so clients do not need to ask the I/O quilt servers for this information.<a name='179'></font>
<font color=#447700>! It is also used as a file identifier in communications with the I/O<a name='180'></font>
<font color=#447700>! server task.<a name='181'></font>
<font color=#447700>!<a name='182'></font>
<font color=#447700>! Note that client tasks know nothing about package-specific handles.<a name='183'></font>
<font color=#447700>! Only the I/O quilt servers know about them.<a name='184'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='185'></font>
      INTEGER i, retval<a name='186'>
      retval = -1<a name='187'>
      DO i = 1, int_num_handles<a name='188'>
        IF ( .NOT. int_handle_in_use(i) )  THEN<a name='189'>
          retval = i<a name='190'>
          GOTO 33<a name='191'>
        ENDIF<a name='192'>
      ENDDO<a name='193'>
33    CONTINUE<a name='194'>
      IF ( retval &lt; 0 )  THEN<a name='195'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INT_GET_FRESH_HANDLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_318">("frame/module_io_quilt.F: int_get_fresh_handle() can not")<a name='196'>
      ENDIF<a name='197'>
      int_handle_in_use(i) = .TRUE.<a name='198'>
      NULLIFY ( int_local_output_buffer )<a name='199'>
    END SUBROUTINE int_get_fresh_handle<a name='200'>
<a name='201'>
<A NAME='SETUP_QUILT_SERVERS'><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='202'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>setup_quilt_servers</font> ( nio_tasks_per_group,     &amp; <A href='../../call_to/SETUP_QUILT_SERVERS.html' TARGET='index'>2</A>,<A href='../../call_from/SETUP_QUILT_SERVERS.html' TARGET='index'>39</A><a name='203'>
                                     mytask,                  &amp;<a name='204'>
                                     ntasks,                  &amp;<a name='205'>
                                     nproc_x,                 &amp;<a name='206'>
                                     nproc_y,                 &amp;<a name='207'>
                                     n_groups_arg,            &amp;<a name='208'>
                                     nio,                     &amp;<a name='209'>
                                     mpi_comm_wrld,           &amp;<a name='210'>
                                     mpi_comm_local,          &amp;<a name='211'>
                                     mpi_comm_io_groups)<a name='212'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='213'></font>
<font color=#447700>! Both client (compute) and server tasks call this routine to <a name='214'></font>
<font color=#447700>! determine which tasks are compute tasks and which are I/O server tasks.  <a name='215'></font>
<font color=#447700>!<a name='216'></font>
<font color=#447700>! Module variables MPI_COMM_LOCAL and MPI_COMM_IO_GROUPS(:) are set up to <a name='217'></font>
<font color=#447700>! contain MPI communicators as follows:  <a name='218'></font>
<font color=#447700>!<a name='219'></font>
<font color=#447700>! MPI_COMM_LOCAL is the Communicator for the local groups of tasks. For the <a name='220'></font>
<font color=#447700>! compute tasks it is the group of compute tasks; for a server group it the <a name='221'></font>
<font color=#447700>! communicator of tasks in the server group.<a name='222'></font>
<font color=#447700>!<a name='223'></font>
<font color=#447700>! Elements of MPI_COMM_IO_GROUPS are communicators that each contain one or <a name='224'></font>
<font color=#447700>! more compute tasks and a single I/O server assigned to those compute tasks.  <a name='225'></font>
<font color=#447700>! The I/O server tasks is always the last task in these communicators.  <a name='226'></font>
<font color=#447700>! On a compute task, which has a single associate in each of the server <a name='227'></font>
<font color=#447700>! groups, MPI_COMM_IO_GROUPS is treated as an array; each element corresponds <a name='228'></font>
<font color=#447700>! to a different server group. <a name='229'></font>
<font color=#447700>! On a server task only the first element of MPI_COMM_IO_GROUPS is used <a name='230'></font>
<font color=#447700>! because each server task is part of only one io_group.  <a name='231'></font>
<font color=#447700>!<a name='232'></font>
<font color=#447700>! I/O server tasks in each I/O server group are divided among compute tasks as <a name='233'></font>
<font color=#447700>! evenly as possible.  <a name='234'></font>
<font color=#447700>!<a name='235'></font>
<font color=#447700>! When multiple I/O server groups are used, each must have the same number of <a name='236'></font>
<font color=#447700>! tasks.  When the total number of extra I/O tasks does not divide evenly by <a name='237'></font>
<font color=#447700>! the number of io server groups requested, the remainder tasks are not used <a name='238'></font>
<font color=#447700>! (wasted).  <a name='239'></font>
<font color=#447700>!<a name='240'></font>
<font color=#447700>! For example, communicator membership for 18 tasks with nio_groups=2 and <a name='241'></font>
<font color=#447700>! nio_tasks_per_group=3 is shown below:  <a name='242'></font>
<font color=#447700>!<a name='243'></font>
<font color=#447700>!&lt;PRE&gt;<a name='244'></font>
<font color=#447700>! Membership for MPI_COMM_LOCAL communicators:<a name='245'></font>
<font color=#447700>!   COMPUTE TASKS:          0   1   2   3   4   5   6   7   8   9  10  11<a name='246'></font>
<font color=#447700>!   1ST I/O SERVER GROUP:  12  13  14<a name='247'></font>
<font color=#447700>!   2ND I/O SERVER GROUP:  15  16  17<a name='248'></font>
<font color=#447700>!<a name='249'></font>
<font color=#447700>! Membership for MPI_COMM_IO_GROUPS(1):  <a name='250'></font>
<font color=#447700>!   COMPUTE TASKS 0, 3, 6, 9:   0   3   6   9  12<a name='251'></font>
<font color=#447700>!   COMPUTE TASKS 1, 4, 7,10:   1   4   7  10  13<a name='252'></font>
<font color=#447700>!   COMPUTE TASKS 2, 5, 8,11:   2   5   8  11  14<a name='253'></font>
<font color=#447700>!   I/O SERVER TASK       12:   0   3   6   9  12<a name='254'></font>
<font color=#447700>!   I/O SERVER TASK       13:   1   4   7  10  13<a name='255'></font>
<font color=#447700>!   I/O SERVER TASK       14:   2   5   8  11  14<a name='256'></font>
<font color=#447700>!   I/O SERVER TASK       15:   0   3   6   9  15<a name='257'></font>
<font color=#447700>!   I/O SERVER TASK       16:   1   4   7  10  16<a name='258'></font>
<font color=#447700>!   I/O SERVER TASK       17:   2   5   8  11  17<a name='259'></font>
<font color=#447700>!<a name='260'></font>
<font color=#447700>! Membership for MPI_COMM_IO_GROUPS(2):  <a name='261'></font>
<font color=#447700>!   COMPUTE TASKS 0, 3, 6, 9:   0   3   6   9  15<a name='262'></font>
<font color=#447700>!   COMPUTE TASKS 1, 4, 7,10:   1   4   7  10  16<a name='263'></font>
<font color=#447700>!   COMPUTE TASKS 2, 5, 8,11:   2   5   8  11  17<a name='264'></font>
<font color=#447700>!   I/O SERVER TASK       12:  ** not used **<a name='265'></font>
<font color=#447700>!   I/O SERVER TASK       13:  ** not used **<a name='266'></font>
<font color=#447700>!   I/O SERVER TASK       14:  ** not used **<a name='267'></font>
<font color=#447700>!   I/O SERVER TASK       15:  ** not used **<a name='268'></font>
<font color=#447700>!   I/O SERVER TASK       16:  ** not used **<a name='269'></font>
<font color=#447700>!   I/O SERVER TASK       17:  ** not used **<a name='270'></font>
<font color=#447700>!&lt;/PRE&gt;<a name='271'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='272'></font>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_108"><a name='273'>
#ifdef DM_PARALLEL<a name='274'>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_131">, ONLY : compute_mesh<a name='275'>
#endif<a name='276'>
      IMPLICIT NONE<a name='277'>
      INCLUDE 'mpif.h'<a name='278'>
      INTEGER,                      INTENT(IN)  :: nio_tasks_per_group, mytask, ntasks, &amp;<a name='279'>
                                                   n_groups_arg, mpi_comm_wrld<a name='280'>
      INTEGER,                      INTENT(IN)  :: nproc_x, nproc_y<a name='281'>
      INTEGER,  INTENT(OUT)                     :: mpi_comm_local, nio<a name='282'>
      INTEGER, DIMENSION(100),      INTENT(OUT) :: mpi_comm_io_groups<a name='283'>
<font color=#447700>! Local<a name='284'></font>
      INTEGER                     :: i, j, ii, comdup, ierr, niotasks, n_groups, iisize<a name='285'>
      INTEGER, DIMENSION(ntasks)  :: icolor<a name='286'>
      CHARACTER*128 mess<a name='287'>
      INTEGER :: io_form_setting<a name='288'>
      INTEGER :: me<a name='289'>
      INTEGER :: k, m, nprocx, nprocy<a name='290'>
      LOGICAL :: reorder_mesh<a name='291'>
<a name='292'>
<font color=#447700>!check the namelist and make sure there are no output forms specified<a name='293'></font>
<font color=#447700>!that cannot be quilted<a name='294'></font>
      CALL nl_get_io_form_history(1,   io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_14">( 'history', io_form_setting )<a name='295'>
      CALL nl_get_io_form_restart(1,   io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_15">( 'restart', io_form_setting )<a name='296'>
      CALL nl_get_io_form_auxhist1(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_16">( 'auxhist1', io_form_setting )<a name='297'>
      CALL nl_get_io_form_auxhist2(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_17">( 'auxhist2', io_form_setting )<a name='298'>
      CALL nl_get_io_form_auxhist3(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_18">( 'auxhist3', io_form_setting )<a name='299'>
      CALL nl_get_io_form_auxhist4(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_19">( 'auxhist4', io_form_setting )<a name='300'>
      CALL nl_get_io_form_auxhist5(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_20">( 'auxhist5', io_form_setting )<a name='301'>
      CALL nl_get_io_form_auxhist6(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_21">( 'auxhist6', io_form_setting )<a name='302'>
      CALL nl_get_io_form_auxhist7(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_22">( 'auxhist7', io_form_setting )<a name='303'>
      CALL nl_get_io_form_auxhist8(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_23">( 'auxhist8', io_form_setting )<a name='304'>
      CALL nl_get_io_form_auxhist9(1,  io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_24">( 'auxhist9', io_form_setting )<a name='305'>
      CALL nl_get_io_form_auxhist10(1, io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_25">( 'auxhist10', io_form_setting )<a name='306'>
      CALL nl_get_io_form_auxhist11(1, io_form_setting) ; call <A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY'>sokay</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOKAY_26">( 'auxhist11', io_form_setting )<a name='307'>
<a name='308'>
      n_groups = n_groups_arg<a name='309'>
      IF ( n_groups .LT. 1 ) n_groups = 1<a name='310'>
<a name='311'>
      compute_node = .TRUE.<a name='312'>
<a name='313'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='314'></font>
<font color=#447700>! nio is number of io tasks per group.  If there arent enough tasks to satisfy<a name='315'></font>
<font color=#447700>! the requirement that there be at least as many compute tasks as io tasks in<a name='316'></font>
<font color=#447700>! each group, then just print a warning and dump out of quilting<a name='317'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='318'></font>
<a name='319'>
      nio = nio_tasks_per_group<a name='320'>
      ncompute_tasks = ntasks - (nio * n_groups)<a name='321'>
      IF ( ncompute_tasks .LT. nio ) THEN <a name='322'>
        WRITE(mess,'("Not enough tasks to have ",I3," groups of ",I3," I/O tasks. No quilting.")')n_groups,nio<a name='323'>
        nio            = 0<a name='324'>
        ncompute_tasks = ntasks<a name='325'>
      ELSE                                   <a name='326'>
        WRITE(mess,'("Quilting with ",I3," groups of ",I3," I/O tasks.")')n_groups,nio<a name='327'>
      ENDIF                                   <a name='328'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_352">(mess)<a name='329'>
<a name='330'>
      IF ( nio .LT. 0 ) THEN<a name='331'>
        nio = 0<a name='332'>
      ENDIF<a name='333'>
      IF ( nio .EQ. 0 ) THEN<a name='334'>
        quilting_enabled = .FALSE.<a name='335'>
        mpi_comm_local = mpi_comm_wrld<a name='336'>
        mpi_comm_io_groups = mpi_comm_wrld<a name='337'>
        RETURN<a name='338'>
      ENDIF<a name='339'>
      quilting_enabled = .TRUE.<a name='340'>
<a name='341'>
<font color=#447700>! First construct the local communicators<a name='342'></font>
<font color=#447700>! prepare to split the communicator by designating compute-only tasks<a name='343'></font>
      DO i = 1, ncompute_tasks<a name='344'>
        icolor(i) = 0<a name='345'>
      ENDDO<a name='346'>
      ii = 1<a name='347'>
<font color=#447700>! and designating the groups of i/o tasks<a name='348'></font>
      DO i = ncompute_tasks+1, ntasks, nio<a name='349'>
        DO j = i, i+nio-1<a name='350'>
          icolor(j) = ii<a name='351'>
        ENDDO<a name='352'>
        ii = ii+1<a name='353'>
      ENDDO<a name='354'>
      CALL MPI_Comm_dup(mpi_comm_wrld,comdup,ierr)<a name='355'>
      CALL MPI_Comm_split(comdup,icolor(mytask+1),mytask,mpi_comm_local,ierr)<a name='356'>
<a name='357'>
<font color=#447700>! Now construct the communicators for the io_groups<a name='358'></font>
      CALL nl_get_reorder_mesh(1,reorder_mesh)<a name='359'>
      IF ( reorder_mesh ) THEN<a name='360'>
        reorder_mesh = .FALSE.<a name='361'>
        CALL nl_set_reorder_mesh(1,reorder_mesh)<a name='362'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_353">('Warning: reorder_mesh does not work with quilting. Disabled reorder_mesh.')<a name='363'>
      ENDIF<a name='364'>
      <font color=#447700>! assign the compute tasks to the i/o tasks in full rows<a name='365'></font>
      IF ( nproc_x .NE. -1 .AND. nproc_y .NE. -1 ) THEN<a name='366'>
       nprocx=nproc_x<a name='367'>
       nprocy=nproc_y<a name='368'>
      ELSE<a name='369'>
       CALL <A href='../../html_code/frame/module_dm.F.html#COMPUTE_MESH'>compute_mesh</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_MESH_4">( ncompute_tasks, nprocx, nprocy )<a name='370'>
      ENDIF<a name='371'>
<a name='372'>
      nio = min(nio,nprocy)<a name='373'>
      m = mod(nprocy,nio)  <font color=#447700>! divide up remainder, 1 row per, until gone<a name='374'></font>
      ii = 1<a name='375'>
      DO j = 1, nio, 1<a name='376'>
         DO k = 1,nprocy/nio+min(m,1)<a name='377'>
           DO i = 1, nprocx<a name='378'>
             icolor(ii) = j - 1<a name='379'>
             ii = ii + 1<a name='380'>
           ENDDO<a name='381'>
         ENDDO<a name='382'>
         m = max(m-1,0)<a name='383'>
      ENDDO<a name='384'>
<a name='385'>
<font color=#447700>! ... and add the io servers as the last task in each group<a name='386'></font>
      DO j = 1, n_groups<a name='387'>
        <font color=#447700>! TBH:  each I/O group will contain only one I/O server<a name='388'></font>
        DO i = ncompute_tasks+1,ntasks<a name='389'>
          icolor(i) = MPI_UNDEFINED<a name='390'>
        ENDDO<a name='391'>
        ii = 0<a name='392'>
        DO i = ncompute_tasks+(j-1)*nio+1,ncompute_tasks+j*nio<a name='393'>
          icolor(i) = ii<a name='394'>
          ii = ii+1<a name='395'>
        ENDDO<a name='396'>
        CALL MPI_Comm_dup(mpi_comm_wrld,comdup,ierr)<a name='397'>
        CALL MPI_Comm_split(comdup,icolor(mytask+1),mytask, &amp;<a name='398'>
                            mpi_comm_io_groups(j),ierr)<a name='399'>
      ENDDO<a name='400'>
<a name='401'>
#ifdef PNETCDF_QUILT<a name='402'>
      if(poll_servers) then<a name='403'>
         poll_servers=.false.<a name='404'>
         call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_354">('Warning: server polling does not work with pnetcdf_quilt.  Disabled poll_servers.')<a name='405'>
      else<a name='406'>
#endif<a name='407'>
         if(nio_groups==1) then<a name='408'>
            poll_servers=.false.<a name='409'>
            call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_355">('Server polling is does not work with one io group.  Disabled poll_servers.')<a name='410'>
         endif<a name='411'>
#ifdef PNETCDF_QUILT<a name='412'>
      endif<a name='413'>
#endif<a name='414'>
<a name='415'>
      if(poll_servers) then<a name='416'>
         <font color=#447700>! If server polling is enabled, we need to create mpi_comm_avail, <a name='417'></font>
         <font color=#447700>! which contains the monitor process, and the I/O server master process<a name='418'></font>
         <font color=#447700>! for each I/O server group.  This will be used in the routines<a name='419'></font>
         <font color=#447700>! wrf_quilt_find_server and wrf_quilt_server_ready to find inactive<a name='420'></font>
         <font color=#447700>! I/O servers for new data handles in get_server_id.<a name='421'></font>
<a name='422'>
         <font color=#447700>! The "in_avail" is set to true iff I am in the mpi_comm_avail.<a name='423'></font>
<a name='424'>
         call mpi_comm_rank(mpi_comm_wrld,me,ierr)<a name='425'>
<a name='426'>
         icolor=MPI_UNDEFINED<a name='427'>
         in_avail=.false.<a name='428'>
<a name='429'>
         if(wrf_dm_on_monitor()) then<a name='430'>
            in_avail=.true. <font color=#447700>! monitor process is in mpi_comm_avail<a name='431'></font>
         endif<a name='432'>
         icolor(1)=1<a name='433'>
<a name='434'>
         do j=1,n_groups<a name='435'>
            i=ncompute_tasks+j*nio-1<a name='436'>
            if(me+1==i) then<a name='437'>
               in_avail=.true. <font color=#447700>! I/O server masters are in mpi_comm_avail<a name='438'></font>
            endif<a name='439'>
            icolor(i)=1<a name='440'>
         enddo<a name='441'>
<a name='442'>
         CALL MPI_Comm_dup(mpi_comm_wrld,comdup,ierr)<a name='443'>
         CALL MPI_Comm_split(comdup,icolor(me+1),me, &amp;<a name='444'>
                             mpi_comm_avail,ierr)<a name='445'>
<a name='446'>
         availrank=MPI_UNDEFINED<a name='447'>
         if(in_avail) then<a name='448'>
            call mpi_comm_rank(mpi_comm_avail,availrank,ierr)<a name='449'>
         endif<a name='450'>
<a name='451'>
      endif<a name='452'>
<a name='453'>
      compute_group_master = .FALSE.<a name='454'>
      compute_node         = .FALSE.<a name='455'>
<a name='456'>
      DO j = 1, n_groups<a name='457'>
<a name='458'>
         IF ( mytask .LT. ncompute_tasks .OR.                                                  &amp;    <font color=#447700>! I am a compute task<a name='459'></font>
              (ncompute_tasks+(j-1)*nio .LE. mytask .AND. mytask .LT. ncompute_tasks+j*nio) &amp;    <font color=#447700>! I am the I/O server for this group<a name='460'></font>
            ) THEN<a name='461'>
<a name='462'>
         CALL MPI_Comm_Size( mpi_comm_io_groups(j) , iisize, ierr )<a name='463'>
         <font color=#447700>! Get the rank of this compute task in the compute+io <a name='464'></font>
         <font color=#447700>! communicator to which it belongs<a name='465'></font>
         CALL MPI_Comm_Rank( mpi_comm_io_groups(j) , me , ierr )<a name='466'>
<a name='467'>
         <font color=#447700>! If I am an I/O server for this group then make that group's<a name='468'></font>
         <font color=#447700>! communicator the first element in the mpi_comm_io_groups array <a name='469'></font>
         <font color=#447700>! (I will ignore all of the other elements).<a name='470'></font>
         IF (ncompute_tasks+(j-1)*nio .LE. mytask .AND. mytask .LT. ncompute_tasks+j*nio) THEN<a name='471'>
            mpi_comm_io_groups(1) = mpi_comm_io_groups(j)<a name='472'>
         ELSE<a name='473'>
            compute_node = .TRUE.<a name='474'>
            <font color=#447700>! If I am a compute task, check whether I am the member of my <a name='475'></font>
            <font color=#447700>! group that will communicate things that should be sent just <a name='476'></font>
            <font color=#447700>! once (e.g. commands) to the IO server of my group.<a name='477'></font>
            compute_group_master(j) = (me .EQ. 0)<a name='478'>
<a name='479'>
<font color=#447700>!            IF( compute_group_master(j) ) WRITE(*,*) mytask,': ARPDBG : I will talk to IO server in group ',j<a name='480'></font>
         ENDIF<a name='481'>
         ENDIF<a name='482'>
      ENDDO<a name='483'>
<a name='484'>
    END SUBROUTINE setup_quilt_servers<a name='485'>
<a name='486'>
<A NAME='SOKAY'><A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='487'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>sokay</font> ( stream, io_form ) <A href='../../call_to/SOKAY.html' TARGET='index'>26</A>,<A href='../../call_from/SOKAY.html' TARGET='index'>4</A><a name='488'>
    USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_96"><a name='489'>
    CHARACTER*(*) stream<a name='490'>
    CHARACTER*256 mess<a name='491'>
    INTEGER io_form<a name='492'>
<a name='493'>
    SELECT CASE (io_form)<a name='494'>
#ifdef NETCDF<a name='495'>
      CASE ( IO_NETCDF   )<a name='496'>
         RETURN<a name='497'>
#endif<a name='498'>
#ifdef INTIO<a name='499'>
      CASE ( IO_INTIO   )<a name='500'>
         RETURN<a name='501'>
#endif<a name='502'>
#ifdef YYY<a name='503'>
      CASE ( IO_YYY )<a name='504'>
         RETURN<a name='505'>
#endif<a name='506'>
#ifdef GRIB1<a name='507'>
      CASE ( IO_GRIB1 )<a name='508'>
         RETURN<a name='509'>
#endif<a name='510'>
#ifdef GRIB2<a name='511'>
      CASE ( IO_GRIB2 )<a name='512'>
         RETURN<a name='513'>
#endif<a name='514'>
      CASE (0)<a name='515'>
         RETURN<a name='516'>
      CASE DEFAULT<a name='517'>
         WRITE(mess,*)' An output format has been specified that is incompatible with quilting: io_form: ',io_form,' ',TRIM(stream)<a name='518'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#SOKAY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_319">(mess)<a name='519'>
    END SELECT<a name='520'>
    END SUBROUTINE sokay<a name='521'>
<a name='522'>
<A NAME='QUILT'><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='523'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>quilt</font> <A href='../../call_to/QUILT.html' TARGET='index'>2</A>,<A href='../../call_from/QUILT.html' TARGET='index'>186</A><a name='524'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='525'></font>
<font color=#447700>! I/O server tasks call this routine and remain in it for the rest of the <a name='526'></font>
<font color=#447700>! model run.  I/O servers receive I/O requests from compute tasks and <a name='527'></font>
<font color=#447700>! perform requested I/O operations by calling package-dependent WRF-specific <a name='528'></font>
<font color=#447700>! I/O interfaces.  Requests are sent in the form of "data headers".  Each <a name='529'></font>
<font color=#447700>! request has a unique "header" message associated with it.  For requests that <a name='530'></font>
<font color=#447700>! contain large amounts of data, the data is appended to the header.  See <a name='531'></font>
<font color=#447700>! file module_internal_header_util.F for detailed descriptions of all <a name='532'></font>
<font color=#447700>! headers.  <a name='533'></font>
<font color=#447700>!<a name='534'></font>
<font color=#447700>! We wish to be able to link to different packages depending on whether<a name='535'></font>
<font color=#447700>! the I/O is restart, initial, history, or boundary.<a name='536'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='537'></font>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_97"><a name='538'>
      USE <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#MODULE_QUILT_OUTBUF_OPS'>module_quilt_outbuf_ops</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_QUILT_OUTBUF_OPS_3"><a name='539'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_109">, only : grid_config_rec_type, model_config_rec, model_to_grid_config_rec<a name='540'>
      IMPLICIT NONE<a name='541'>
      INCLUDE 'mpif.h'<a name='542'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_1"><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='543'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_2"><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='544'>
      TYPE (grid_config_rec_type)  :: config_flags<a name='545'>
      INTEGER itag, ninbuf, ntasks_io_group, ntasks_local_group, mytask_local, ierr<a name='546'>
      INTEGER istat<a name='547'>
      INTEGER mytask_io_group<a name='548'>
      INTEGER   :: nout_set = 0<a name='549'>
      INTEGER   :: obufsize, bigbufsize, chunksize, sz<a name='550'>
      REAL, DIMENSION(1)      :: dummy<a name='551'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: obuf, bigbuf<a name='552'>
      REAL,    ALLOCATABLE, DIMENSION(:) :: RDATA<a name='553'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: IDATA<a name='554'>
      CHARACTER (LEN=512) :: CDATA<a name='555'>
      CHARACTER (LEN=80) :: fname<a name='556'>
      INTEGER icurs, hdrbufsize, itypesize, ftypesize, rtypesize, Status, fstat, io_form_arg<a name='557'>
      INTEGER :: DataHandle, FieldType, Comm, IOComm, DomainDesc, code, Count<a name='558'>
      INTEGER, DIMENSION(3) :: DomainStart , DomainEnd , MemoryStart , MemoryEnd , PatchStart , PatchEnd<a name='559'>
      INTEGER :: dummybuf(1)<a name='560'>
      INTEGER :: num_noops, num_commit_messages, num_field_training_msgs, hdr_tag<a name='561'>
      CHARACTER (len=256) :: DateStr , Element, VarName, MemoryOrder , Stagger , DimNames(3), FileName, SysDepInfo, mess<a name='562'>
      INTEGER, EXTERNAL :: use_package<a name='563'>
      LOGICAL           :: stored_write_record, retval<a name='564'>
      INTEGER iii, jjj, vid, CC, DD, dom_id<a name='565'>
      LOGICAL           :: call_server_ready<a name='566'>
<a name='567'>
logical okay_to_w<a name='568'>
character*120 sysline<a name='569'>
<a name='570'>
      dom_id = 1 <font color=#447700>! always a valid assumption for domain id for this netcdf setting<a name='571'></font>
      CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_18"> ( dom_id , model_config_rec , config_flags )<a name='572'>
<a name='573'>
<font color=#447700>! If we've been built with PNETCDF_QUILT defined then we use parallel I/O<a name='574'></font>
<font color=#447700>! within the group of I/O servers rather than gathering the data onto the<a name='575'></font>
<font color=#447700>! root I/O server. Unfortunately, this approach means that we can no-longer<a name='576'></font>
<font color=#447700>! select different I/O layers for use with quilting at run time. ARPDBG.<a name='577'></font>
<font color=#447700>! This code is sufficiently different that it is kept in the separate <a name='578'></font>
<font color=#447700>! quilt_pnc() routine.<a name='579'></font>
#ifdef PNETCDF_QUILT<a name='580'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC'>quilt_pnc</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QUILT_PNC_2">()<a name='581'>
      RETURN<a name='582'>
#endif<a name='583'>
<a name='584'>
<font color=#447700>! Call ext_pkg_ioinit() routines to initialize I/O packages.  <a name='585'></font>
      SysDepInfo = " "<a name='586'>
#ifdef NETCDF<a name='587'>
      if ( config_flags%use_netcdf_classic ) SysDepInfo="use_netcdf_classic"<a name='588'>
      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOINIT'>ext_ncd_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOINIT_4">( SysDepInfo, ierr )<a name='589'>
      SysDepInfo = " "<a name='590'>
#endif<a name='591'>
#ifdef INTIO<a name='592'>
      CALL ext_int_ioinit( SysDepInfo, ierr )<a name='593'>
#endif<a name='594'>
#ifdef XXX<a name='595'>
      CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOINIT'>ext_xxx_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOINIT_4">( SysDepInfo, ierr)<a name='596'>
#endif<a name='597'>
#ifdef YYY<a name='598'>
      CALL ext_yyy_ioinit( SysDepInfo, ierr)<a name='599'>
#endif<a name='600'>
#ifdef ZZZ<a name='601'>
      CALL ext_zzz_ioinit( SysDepInfo, ierr)<a name='602'>
#endif<a name='603'>
#ifdef GRIB1<a name='604'>
      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOINIT'>ext_gr1_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOINIT_4">( SysDepInfo, ierr)<a name='605'>
#endif<a name='606'>
#ifdef GRIB2<a name='607'>
      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOINIT'>ext_gr2_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOINIT_4">( SysDepInfo, ierr)<a name='608'>
#endif<a name='609'>
<a name='610'>
      call_server_ready = .true. <font color=#447700>! = true when the server is ready for a new file<a name='611'></font>
<a name='612'>
      okay_to_commit = .false.<a name='613'>
      stored_write_record = .false.<a name='614'>
      ninbuf = 0<a name='615'>
      <font color=#447700>! get info. about the I/O server group that this I/O server task<a name='616'></font>
      <font color=#447700>! belongs to<a name='617'></font>
      <font color=#447700>! Last task in this I/O server group is the I/O server "root"<a name='618'></font>
      <font color=#447700>! The I/O server "root" actually writes data to disk<a name='619'></font>
      <font color=#447700>! TBH:  WARNING:  This is also implicit in the call to collect_on_comm().<a name='620'></font>
      CALL mpi_x_comm_size( mpi_comm_io_groups(1), ntasks_io_group,    ierr )<a name='621'>
      CALL MPI_COMM_RANK( mpi_comm_io_groups(1), mytask_io_group,    ierr )<a name='622'>
      CALL mpi_x_comm_size( mpi_comm_local,        ntasks_local_group, ierr )<a name='623'>
      CALL MPI_COMM_RANK( mpi_comm_local,        mytask_local,       ierr )<a name='624'>
<a name='625'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='626'>
      IF ( itypesize &lt;= 0 ) THEN<a name='627'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_320">("external/RSL/module_dm.F: quilt: type size &lt;= 0 invalid")<a name='628'>
      ENDIF<a name='629'>
<a name='630'>
<font color=#447700>! Work out whether this i/o server processor has one fewer associated compute proc than<a name='631'></font>
<font color=#447700>! the most any processor has. Can happen when number of i/o tasks does not evenly divide<a name='632'></font>
<font color=#447700>! the number of compute tasks. This is needed to keep the i/o tasks sychronized on the<a name='633'></font>
<font color=#447700>! same message when they start commmunicating to stitch together an output.<a name='634'></font>
<font color=#447700>!<a name='635'></font>
<font color=#447700>! Compute processes associated with this task:<a name='636'></font>
       CC = ntasks_io_group - 1<a name='637'>
<font color=#447700>! Number of compute tasks per I/O task (less remainder)<a name='638'></font>
       DD = ncompute_tasks / ntasks_local_group<a name='639'>
<font color=#447700>!<a name='640'></font>
<font color=#447700>! If CC-DD is 1 on servrs with the maximum number of compute clients, <a name='641'></font>
<font color=#447700>!             0 on servrs with one less than maximum<a name='642'></font>
<a name='643'>
<a name='644'>
<font color=#447700>! infinite loop until shutdown message received<a name='645'></font>
<font color=#447700>! This is the main request-handling loop.  I/O quilt servers stay in this loop <a name='646'></font>
<font color=#447700>! until the model run ends.  <a name='647'></font>
okay_to_w = .false.<a name='648'>
      DO WHILE (.TRUE.)  <font color=#447700>! {<a name='649'></font>
<a name='650'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='651'></font>
<font color=#447700>! Each I/O server receives requests from its compute tasks.  Each request<a name='652'></font>
<font color=#447700>! is contained in a data header (see module_internal_header_util.F for<a name='653'></font>
<font color=#447700>! detailed descriptions of data headers).<a name='654'></font>
<font color=#447700>! Each request is sent in two phases.  First, sizes of all messages that <a name='655'></font>
<font color=#447700>! will be sent from the compute tasks to this I/O server are summed on the <a name='656'></font>
<font color=#447700>! I/O server via MPI_reduce().  The I/O server then allocates buffer "obuf" <a name='657'></font>
<font color=#447700>! and receives concatenated messages from the compute tasks in it via the <a name='658'></font>
<font color=#447700>! call to collect_on_comm().  Note that "sizes" are generally expressed in <a name='659'></font>
<font color=#447700>! *bytes* in this code so conversion to "count" (number of Fortran words) is <a name='660'></font>
<font color=#447700>! required for Fortran indexing and MPI calls.  <a name='661'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='662'></font>
<a name='663'>
         if(poll_servers .and. call_server_ready) then<a name='664'>
            call_server_ready=.false.<a name='665'>
            <font color=#447700>! Send a message to the monitor telling it we're ready<a name='666'></font>
            <font color=#447700>! for a new data handle.<a name='667'></font>
            call <A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY'>wrf_quilt_server_ready</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_QUILT_SERVER_READY_2">()<a name='668'>
         endif<a name='669'>
<a name='670'>
        <font color=#447700>! wait for info from compute tasks in the I/O group that we're ready to rock<a name='671'></font>
        <font color=#447700>! obufsize will contain number of *bytes*<a name='672'></font>
<font color=#447700>!CALL start_timing()<a name='673'></font>
        <font color=#447700>! first element of reduced is obufsize, second is DataHandle <a name='674'></font>
        <font color=#447700>! if needed (currently needed only for ioclose).<a name='675'></font>
        reduced_dummy = 0<a name='676'>
        CALL mpi_x_reduce( reduced_dummy, reduced, 2, MPI_INTEGER, MPI_SUM, mytask_io_group, mpi_comm_io_groups(1), ierr )<a name='677'>
        obufsize = reduced(1)<a name='678'>
<font color=#447700>!CALL end_timing("MPI_Reduce at top of forever loop") <a name='679'></font>
<font color=#447700>!JMDEBUGwrite(0,*)'obufsize = ',obufsize<a name='680'></font>
<font color=#447700>! Negative obufsize will trigger I/O server exit.  <a name='681'></font>
        IF ( obufsize .LT. 0 ) THEN<a name='682'>
          IF ( obufsize .EQ. -100 ) THEN         <font color=#447700>! magic number<a name='683'></font>
#ifdef NETCDF<a name='684'>
            CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOEXIT'>ext_ncd_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOEXIT_4">( Status )<a name='685'>
#endif<a name='686'>
#ifdef INTIO<a name='687'>
            CALL ext_int_ioexit( Status )<a name='688'>
#endif<a name='689'>
#ifdef XXX<a name='690'>
            CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOEXIT'>ext_xxx_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOEXIT_4">( Status )<a name='691'>
#endif<a name='692'>
#ifdef YYY<a name='693'>
            CALL ext_yyy_ioexit( Status )<a name='694'>
#endif<a name='695'>
#ifdef ZZZ<a name='696'>
            CALL ext_zzz_ioexit( Status )<a name='697'>
#endif<a name='698'>
#ifdef GRIB1<a name='699'>
            CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOEXIT'>ext_gr1_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOEXIT_4">( Status )<a name='700'>
#endif<a name='701'>
#ifdef GRIB2<a name='702'>
            CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOEXIT'>ext_gr2_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOEXIT_4">( Status )<a name='703'>
#endif<a name='704'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_356"> ( 'I/O QUILT SERVERS DONE' )<a name='705'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='706'></font>
            IF (coupler_on) THEN <a name='707'>
               CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_FINALIZE'>cpl_finalize</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_FINALIZE_3">() <a name='708'>
            ELSE<a name='709'>
#endif<a name='710'>
               CALL mpi_finalize(ierr)<a name='711'>
#if ( DA_CORE <font color=#447700>!= 1 )<a name='712'></font>
            END IF<a name='713'>
#endif<a name='714'>
            STOP<a name='715'>
          ELSE<a name='716'>
            WRITE(mess,*)'Possible 32-bit overflow on output server. Try larger nio_tasks_per_group in namelist.'<a name='717'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_321">(mess)<a name='718'>
          ENDIF<a name='719'>
        ENDIF<a name='720'>
<a name='721'>
<font color=#447700>!        CALL start_timing()<a name='722'></font>
<font color=#447700>! Obufsize of zero signals a close<a name='723'></font>
<a name='724'>
<font color=#447700>! Allocate buffer obuf to be big enough for the data the compute tasks<a name='725'></font>
<font color=#447700>! will send.  Note: obuf is size in *bytes* so we need to pare this <a name='726'></font>
<font color=#447700>! down, since the buffer is INTEGER.  <a name='727'></font>
        IF ( obufsize .GT. 0 ) THEN<a name='728'>
          ALLOCATE( obuf( (obufsize+1)/itypesize ) )<a name='729'>
<a name='730'>
<font color=#447700>! let's roll; get the data from the compute procs and put in obuf<a name='731'></font>
          CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_14">(__FILE__,__LINE__, mpi_comm_io_groups(1),        &amp;<a name='732'>
                                onebyte,                      &amp;<a name='733'>
                                dummy, 0,                     &amp;<a name='734'>
                                obuf, obufsize )<a name='735'>
<font color=#447700>!          CALL end_timing( "quilt on server: collecting data from compute procs" )<a name='736'></font>
        ELSE<a name='737'>
          <font color=#447700>! Necessarily, the compute processes send the ioclose signal,<a name='738'></font>
          <font color=#447700>! if there is one, after the iosync, which means they <a name='739'></font>
          <font color=#447700>! will stall on the ioclose message waiting for the quilt <a name='740'></font>
          <font color=#447700>! processes if we handle the way other messages are collected,<a name='741'></font>
          <font color=#447700>! using collect_on_comm.  This avoids this, but we need<a name='742'></font>
          <font color=#447700>! a special signal (obufsize zero) and the DataHandle<a name='743'></font>
          <font color=#447700>! to be closed. That handle is send as the second<a name='744'></font>
          <font color=#447700>! word of the io_close message received by the MPI_Reduce above.<a name='745'></font>
          <font color=#447700>! Then a header representing the ioclose message is constructed<a name='746'></font>
          <font color=#447700>! here and handled below as if it were received from the <a name='747'></font>
          <font color=#447700>! compute processes. The clients (compute processes) must be<a name='748'></font>
          <font color=#447700>! careful to send this correctly (one compule process sends the actual<a name='749'></font>
          <font color=#447700>! handle and everone else sends a zero, so the result sums to <a name='750'></font>
          <font color=#447700>! the value of the handle).<a name='751'></font>
          <font color=#447700>!<a name='752'></font>
          ALLOCATE( obuf( 4096 ) )<a name='753'>
          <font color=#447700>! DataHandle is provided as second element of reduced<a name='754'></font>
          CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_9">( obuf, obufsize, itypesize, &amp;<a name='755'>
                                      reduced(2) , int_ioclose )<a name='756'>
<a name='757'>
          if(poll_servers) then <a name='758'>
             <font color=#447700>! Once we're done closing, we need to tell the master<a name='759'></font>
             <font color=#447700>! process that we're ready for more data.<a name='760'></font>
             call_server_ready=.true.<a name='761'>
          endif<a name='762'>
        ENDIF<a name='763'>
<a name='764'>
<font color=#447700>!write(0,*)'calling init_store_piece_of_field'<a name='765'></font>
<font color=#447700>! Now all messages received from the compute clients are stored in <a name='766'></font>
<font color=#447700>! obuf.  Scan through obuf and extract headers and field data and store in <a name='767'></font>
<font color=#447700>! internal buffers.  The scan is done twice, first to determine sizes of <a name='768'></font>
<font color=#447700>! internal buffers required for storage of headers and fields and second to <a name='769'></font>
<font color=#447700>! actually store the headers and fields.  This bit of code does not do the <a name='770'></font>
<font color=#447700>! "quilting" (assembly of patches into full domains).  For each field, it <a name='771'></font>
<font color=#447700>! simply concatenates all received patches for the field into a separate <a name='772'></font>
<font color=#447700>! internal buffer (i.e. one buffer per field).  Quilting is done later by <a name='773'></font>
<font color=#447700>! routine store_patch_in_outbuf().  <a name='774'></font>
        CALL init_store_piece_of_field<a name='775'>
        CALL mpi_type_size ( MPI_INTEGER , itypesize , ierr )<a name='776'>
<font color=#447700>!write(0,*)'mpi_type_size returns ', itypesize<a name='777'></font>
<font color=#447700>! Scan obuf the first time to calculate the size of the buffer required for <a name='778'></font>
<font color=#447700>! each field.  Calls to add_to_bufsize_for_field() accumulate sizes.  <a name='779'></font>
        vid = 0<a name='780'>
        icurs = itypesize<a name='781'>
        num_noops = 0 <a name='782'>
        num_commit_messages = 0 <a name='783'>
        num_field_training_msgs = 0 <a name='784'>
        DO WHILE ( icurs .lt. obufsize ) <font color=#447700>! {<a name='785'></font>
          hdr_tag = <A href='../../html_code/frame/module_internal_header_util.F.html#GET_HDR_TAG'>get_hdr_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HDR_TAG_5">( obuf ( icurs / itypesize ) )<a name='786'>
          SELECT CASE ( hdr_tag )<a name='787'>
            CASE ( int_field )<a name='788'>
              CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_8"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='789'>
                                                DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='790'>
                                                DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='791'>
                                                DomainStart , DomainEnd ,                                    &amp;<a name='792'>
                                                MemoryStart , MemoryEnd ,                                    &amp;<a name='793'>
                                                PatchStart , PatchEnd )<a name='794'>
              chunksize = (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='795'>
                          (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='796'>
<a name='797'>
              IF ( DomainDesc .EQ. 333933 ) THEN  <font color=#447700>! Training write, only one per group of tasks<a name='798'></font>
                 IF ( num_field_training_msgs .EQ. 0 ) THEN<a name='799'>
                   call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_11">( VarName, hdrbufsize )<a name='800'>
<font color=#447700>!write(0,*) 'X-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='801'></font>
                 ENDIF<a name='802'>
                 num_field_training_msgs = num_field_training_msgs + 1<a name='803'>
              ELSE<a name='804'>
                 call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_12">( VarName, hdrbufsize )<a name='805'>
<font color=#447700>!write(0,*) 'X-2a', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='806'></font>
              ENDIF<a name='807'>
              icurs = icurs + hdrbufsize<a name='808'>
<a name='809'>
<font color=#447700>!write(0,*) 'X-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='810'></font>
<a name='811'>
              <font color=#447700>! If this is a real write (i.e. not a training write), accumulate<a name='812'></font>
              <font color=#447700>! buffersize for this field.<a name='813'></font>
              IF ( DomainDesc .NE. 333933 ) THEN   <font color=#447700>! magic number<a name='814'></font>
<font color=#447700>!write(0,*) 'X-1a', chunksize, TRIM(VarName)<a name='815'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_13">( VarName, chunksize )<a name='816'>
                icurs = icurs + chunksize<a name='817'>
              ENDIF<a name='818'>
            CASE ( int_open_for_write_commit )  <font color=#447700>! only one per group of tasks<a name='819'></font>
              hdrbufsize = obuf(icurs/itypesize)<a name='820'>
              IF (num_commit_messages.EQ.0) THEN<a name='821'>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_14">( 'COMMIT', hdrbufsize )<a name='822'>
              ENDIF<a name='823'>
              num_commit_messages = num_commit_messages + 1<a name='824'>
              icurs = icurs + hdrbufsize<a name='825'>
            CASE DEFAULT<a name='826'>
              hdrbufsize = obuf(icurs/itypesize)<a name='827'>
<a name='828'>
<font color=#447700>! This logic and the logic in the loop below is used to determine whether<a name='829'></font>
<font color=#447700>! to send a noop records sent by the compute processes to allow to go<a name='830'></font>
<font color=#447700>! through. The purpose is to make sure that the communications between this<a name='831'></font>
<font color=#447700>! server and the other servers in this quilt group stay synchronized in<a name='832'></font>
<font color=#447700>! the collection loop below, even when the servers are serving different<a name='833'></font>
<font color=#447700>! numbers of clients. Here are some conditions:<a name='834'></font>
<font color=#447700>! <a name='835'></font>
<font color=#447700>!   1. The number of compute clients served will not differ by more than 1<a name='836'></font>
<font color=#447700>!   2. The servers with +1 number of compute clients begin with task 0<a name='837'></font>
<font color=#447700>!      of mpi_comm_local, the commicator shared by this group of servers<a name='838'></font>
<font color=#447700>! <a name='839'></font>
<font color=#447700>!   3. For each collective field or metadata output from the compute tasks,<a name='840'></font>
<font color=#447700>!      there will be one record sent to the associated i/o server task. The<a name='841'></font>
<font color=#447700>!      i/o server task collects these records and stores them contiguously<a name='842'></font>
<font color=#447700>!      in a buffer (obuf) using collect_on_comm above.  Thus, obuf on this<a name='843'></font>
<font color=#447700>!      server task will contain one record from each associated compute<a name='844'></font>
<font color=#447700>!      task, in order.<a name='845'></font>
<font color=#447700>! <a name='846'></font>
<font color=#447700>!   4. In the case of replicated output from the compute tasks<a name='847'></font>
<font color=#447700>!      (e.g. put_dom_ti records and control records like<a name='848'></font>
<font color=#447700>!      open_for_write_commit type records), compute task 0 is the only<a name='849'></font>
<font color=#447700>!      one that sends the record. The other compute tasks send noop<a name='850'></font>
<font color=#447700>!      records. Thus, obuf on server task zero will contain the output<a name='851'></font>
<font color=#447700>!      record from task 0 followed by noop records from the rest of the<a name='852'></font>
<font color=#447700>!      compute tasks associated with task 0.  Obuf on the other server<a name='853'></font>
<font color=#447700>!      tasks will contain nothing but noop records.<a name='854'></font>
<font color=#447700>! <a name='855'></font>
<font color=#447700>!   5. The logic below will not allow any noop records from server task 0.<a name='856'></font>
<font color=#447700>!      It allows only one noop record from each of the other server tasks<a name='857'></font>
<font color=#447700>!      in the i/o group.  This way, for replicated output, when the records<a name='858'></font>
<font color=#447700>!      are collected on one server task below, using collect_on_comm on<a name='859'></font>
<font color=#447700>!      mpi_comm_local, each task will provide exactly one record for each<a name='860'></font>
<font color=#447700>!      call to collect_on_comm: 1 bona fide output record from server task<a name='861'></font>
<font color=#447700>!      0 and noops from the rest.<a name='862'></font>
<a name='863'>
              IF ((hdr_tag.EQ.int_noop.AND.mytask_local.NE.0.AND.num_noops.LE.0)  &amp;<a name='864'>
                  .OR.hdr_tag.NE.int_noop) THEN<a name='865'>
                write(VarName,'(I5.5)')vid <a name='866'>
<font color=#447700>!write(0,*) 'X-2', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='867'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_15">( VarName, hdrbufsize )<a name='868'>
                vid = vid+1<a name='869'>
              ENDIF<a name='870'>
              IF ( hdr_tag .EQ. int_noop ) num_noops = num_noops + 1<a name='871'>
              icurs = icurs + hdrbufsize<a name='872'>
          END SELECT<a name='873'>
        ENDDO <font color=#447700>! }<a name='874'></font>
<font color=#447700>! Store the headers and field data in internal buffers.  The first call to <a name='875'></font>
<font color=#447700>! store_piece_of_field() allocates internal buffers using sizes computed by <a name='876'></font>
<font color=#447700>! calls to add_to_bufsize_for_field().  <a name='877'></font>
        vid = 0<a name='878'>
        icurs = itypesize<a name='879'>
        num_noops = 0 <a name='880'>
        num_commit_messages = 0 <a name='881'>
        num_field_training_msgs = 0 <a name='882'>
        DO WHILE ( icurs .lt. obufsize ) <font color=#447700>!{<a name='883'></font>
<font color=#447700>!write(0,*) 'A icurs ', icurs, ' obufsize ', obufsize<a name='884'></font>
          hdr_tag = <A href='../../html_code/frame/module_internal_header_util.F.html#GET_HDR_TAG'>get_hdr_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HDR_TAG_6">( obuf ( icurs / itypesize ) )<a name='885'>
          SELECT CASE ( hdr_tag )<a name='886'>
            CASE ( int_field )<a name='887'>
              CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_9"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='888'>
                                                DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='889'>
                                                DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='890'>
                                                DomainStart , DomainEnd ,                                    &amp;<a name='891'>
                                                MemoryStart , MemoryEnd ,                                    &amp;<a name='892'>
                                                PatchStart , PatchEnd )<a name='893'>
              chunksize = (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='894'>
                          (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='895'>
<a name='896'>
              IF ( DomainDesc .EQ. 333933 ) THEN  <font color=#447700>! Training write, only one per group of tasks<a name='897'></font>
                 IF ( num_field_training_msgs .EQ. 0 ) THEN<a name='898'>
                   call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_11">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='899'>
<font color=#447700>!write(0,*) 'A-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='900'></font>
                 ENDIF<a name='901'>
                 num_field_training_msgs = num_field_training_msgs + 1<a name='902'>
              ELSE<a name='903'>
                 call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_12">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='904'>
<font color=#447700>!write(0,*) 'A-2a', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='905'></font>
              ENDIF<a name='906'>
              icurs = icurs + hdrbufsize<a name='907'>
              <font color=#447700>! If this is a real write (i.e. not a training write), store<a name='908'></font>
              <font color=#447700>! this piece of this field.<a name='909'></font>
              IF ( DomainDesc .NE. 333933 ) THEN   <font color=#447700>! magic number<a name='910'></font>
<font color=#447700>!write(0,*) 'A-1a', chunksize, TRIM(VarName),PatchStart(1:3),PatchEnd(1:3)<a name='911'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_13">( obuf(icurs/itypesize), VarName, chunksize )<a name='912'>
                icurs = icurs + chunksize<a name='913'>
              ENDIF<a name='914'>
            CASE ( int_open_for_write_commit )  <font color=#447700>! only one per group of tasks<a name='915'></font>
              hdrbufsize = obuf(icurs/itypesize)<a name='916'>
              IF (num_commit_messages.EQ.0) THEN<a name='917'>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_14">( obuf(icurs/itypesize), 'COMMIT', hdrbufsize )<a name='918'>
              ENDIF<a name='919'>
              num_commit_messages = num_commit_messages + 1<a name='920'>
              icurs = icurs + hdrbufsize<a name='921'>
            CASE DEFAULT<a name='922'>
              hdrbufsize = obuf(icurs/itypesize)<a name='923'>
              IF ((hdr_tag.EQ.int_noop.AND.mytask_local.NE.0.AND.num_noops.LE.0)  &amp;<a name='924'>
                  .OR.hdr_tag.NE.int_noop) THEN<a name='925'>
                write(VarName,'(I5.5)')vid <a name='926'>
<font color=#447700>!write(0,*) 'A-2b', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='927'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_15">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='928'>
                vid = vid+1<a name='929'>
              ENDIF<a name='930'>
              IF ( hdr_tag .EQ. int_noop ) num_noops = num_noops + 1<a name='931'>
              icurs = icurs + hdrbufsize<a name='932'>
          END SELECT<a name='933'>
        ENDDO <font color=#447700>!}<a name='934'></font>
<a name='935'>
<font color=#447700>! Now, for each field, retrieve headers and patches (data) from the internal <a name='936'></font>
<font color=#447700>! buffers and collect them all on the I/O quilt server "root" task.<a name='937'></font>
        CALL init_retrieve_pieces_of_field<a name='938'>
<font color=#447700>! Retrieve header and all patches for the first field from the internal <a name='939'></font>
<font color=#447700>! buffers.  <a name='940'></font>
        CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#RETRIEVE_PIECES_OF_FIELD'>retrieve_pieces_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_PIECES_OF_FIELD_5"> ( obuf , VarName, obufsize, sz, retval )<a name='941'>
<font color=#447700>! Sum sizes of all headers and patches (data) for this field from all I/O <a name='942'></font>
<font color=#447700>! servers in this I/O server group onto the I/O server "root".<a name='943'></font>
        CALL mpi_x_reduce( sz, bigbufsize, 1, MPI_INTEGER, MPI_SUM, ntasks_local_group-1, mpi_comm_local, ierr )<a name='944'>
<font color=#447700>!write(0,*)'seed: sz ',sz,' bigbufsize ',bigbufsize,' VarName ', TRIM(VarName),' retval ',retval<a name='945'></font>
<a name='946'>
<font color=#447700>! Loop until there are no more fields to retrieve from the internal buffers.<a name='947'></font>
        DO WHILE ( retval ) <font color=#447700>!{<a name='948'></font>
#if 0<a name='949'>
#else<a name='950'>
<a name='951'>
<font color=#447700>! I/O server "root" allocates space to collect headers and fields from all<a name='952'></font>
<font color=#447700>! other servers in this I/O server group.<a name='953'></font>
          IF ( mytask_local .EQ. ntasks_local_group-1 ) THEN<a name='954'>
            ALLOCATE( bigbuf( (bigbufsize+1)/itypesize ) )<a name='955'>
         else<a name='956'>
            ALLOCATE( bigbuf(1) )<a name='957'>
          ENDIF<a name='958'>
<a name='959'>
<font color=#447700>! Collect buffers and fields from all I/O servers in this I/O server group<a name='960'></font>
<font color=#447700>! onto the I/O server "root"<a name='961'></font>
          CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG2'>collect_on_comm_debug2</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG2_2">(__FILE__,__LINE__,Trim(VarName),        &amp;<a name='962'>
                                get_hdr_tag(obuf),sz,get_hdr_rec_size(obuf),  &amp;<a name='963'>
                                mpi_comm_local,                               &amp;<a name='964'>
                                onebyte,                                      &amp;<a name='965'>
                                obuf, sz,                                     &amp;<a name='966'>
                                bigbuf, bigbufsize )<a name='967'>
<font color=#447700>! The I/O server "root" now handles collected requests from all compute <a name='968'></font>
<font color=#447700>! tasks served by this I/O server group (i.e. all compute tasks).  <a name='969'></font>
          IF ( mytask_local .EQ. ntasks_local_group-1 ) THEN<a name='970'>
<font color=#447700>!jjj = 4<a name='971'></font>
<font color=#447700>!do iii = 1, ntasks_local_group<a name='972'></font>
<font color=#447700>!  write(0,*)'i,j,tag,size ', iii, jjj, get_hdr_tag(bigbuf(jjj/4)),get_hdr_rec_size(bigbuf(jjj/4))<a name='973'></font>
<font color=#447700>!  jjj = jjj + get_hdr_rec_size(bigbuf(jjj/4))<a name='974'></font>
<font color=#447700>!enddo<a name='975'></font>
<a name='976'>
            icurs = itypesize  <font color=#447700>! icurs is a byte counter, but buffer is integer<a name='977'></font>
<a name='978'>
            stored_write_record = .false.<a name='979'>
<a name='980'>
<font color=#447700>! The I/O server "root" loops over the collected requests.  <a name='981'></font>
            DO WHILE ( icurs .lt. bigbufsize ) <font color=#447700>!{<a name='982'></font>
              CALL mpi_type_size ( MPI_INTEGER , itypesize , ierr )<a name='983'>
<a name='984'>
<font color=#447700>!write(0,*)'B tag,size ',icurs,get_hdr_tag( bigbuf(icurs/itypesize) ),get_hdr_rec_size( bigbuf(icurs/itypesize) )<a name='985'></font>
<font color=#447700>! The I/O server "root" gets the request out of the next header and<a name='986'></font>
<font color=#447700>! handles it by, in most cases, calling the appropriate external I/O package<a name='987'></font>
<font color=#447700>! interface.<a name='988'></font>
              SELECT CASE ( get_hdr_tag( bigbuf(icurs/itypesize) ) )<a name='989'>
<font color=#447700>! The I/O server "root" handles the "noop" (do nothing) request.  This is <a name='990'></font>
<font color=#447700>! actually quite easy.  "Noop" requests exist to help avoid race conditions.  <a name='991'></font>
<font color=#447700>! In some cases, only one compute task will everything about a request so <a name='992'></font>
<font color=#447700>! other compute tasks send "noop" requests.  <a name='993'></font>
                CASE ( int_noop )<a name='994'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_NOOP_HEADER'>int_get_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_NOOP_HEADER_3">( bigbuf(icurs/itypesize), hdrbufsize, itypesize )<a name='995'>
                  icurs = icurs + hdrbufsize<a name='996'>
<a name='997'>
<font color=#447700>! The I/O server "root" handles the "put_dom_td_real" request.<a name='998'></font>
                CASE ( int_dom_td_real )<a name='999'>
                  CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='1000'>
                  ALLOCATE( RData( bigbuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1001'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TD_HEADER'>int_get_td_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TD_HEADER_5">( bigbuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1002'>
                                          DataHandle, DateStr, Element, RData, Count, code )<a name='1003'>
                  icurs = icurs + hdrbufsize<a name='1004'>
<a name='1005'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1006'>
#ifdef NETCDF<a name='1007'>
                    CASE ( IO_NETCDF   )<a name='1008'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TD_REAL'>ext_ncd_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TD_REAL_3">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1009'>
#endif<a name='1010'>
#ifdef INTIO<a name='1011'>
                    CASE ( IO_INTIO   )<a name='1012'>
                      CALL ext_int_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1013'>
#endif<a name='1014'>
#ifdef YYY<a name='1015'>
                 CASE ( IO_YYY )<a name='1016'>
                    CALL ext_yyy_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1017'>
#endif<a name='1018'>
#ifdef GRIB1<a name='1019'>
                 CASE ( IO_GRIB1 )<a name='1020'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TD_REAL'>ext_gr1_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TD_REAL_3">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1021'>
#endif<a name='1022'>
#ifdef GRIB2<a name='1023'>
                 CASE ( IO_GRIB2 )<a name='1024'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TD_REAL'>ext_gr2_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TD_REAL_3">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1025'>
#endif<a name='1026'>
                     CASE DEFAULT<a name='1027'>
                      Status = 0<a name='1028'>
                  END SELECT<a name='1029'>
<a name='1030'>
                  DEALLOCATE( RData )<a name='1031'>
<font color=#447700>! The I/O server "root" handles the "put_dom_ti_real" request.<a name='1032'></font>
                CASE ( int_dom_ti_real )<a name='1033'>
<font color=#447700>!write(0,*)' int_dom_ti_real '<a name='1034'></font>
                  CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='1035'>
                  ALLOCATE( RData( bigbuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1036'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER'>int_get_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_5">( bigbuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1037'>
                                          DataHandle, Element, RData, Count, code )<a name='1038'>
                  icurs = icurs + hdrbufsize<a name='1039'>
<a name='1040'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1041'>
#ifdef NETCDF<a name='1042'>
                    CASE ( IO_NETCDF   )<a name='1043'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_REAL'>ext_ncd_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_REAL_3">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1044'>
<font color=#447700>!write(0,*)'ext_ncd_put_dom_ti_real ',handle(DataHandle),TRIM(Element),RData,Status<a name='1045'></font>
#endif<a name='1046'>
#ifdef INTIO<a name='1047'>
                    CASE ( IO_INTIO   )<a name='1048'>
                      CALL ext_int_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1049'>
#endif<a name='1050'>
#ifdef YYY<a name='1051'>
                 CASE ( IO_YYY )<a name='1052'>
                    CALL ext_yyy_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1053'>
#endif<a name='1054'>
#ifdef GRIB1<a name='1055'>
                 CASE ( IO_GRIB1 )<a name='1056'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_REAL'>ext_gr1_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_REAL_3">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1057'>
#endif<a name='1058'>
#ifdef GRIB2<a name='1059'>
                 CASE ( IO_GRIB2 )<a name='1060'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_REAL'>ext_gr2_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_REAL_3">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='1061'>
#endif<a name='1062'>
                    CASE DEFAULT<a name='1063'>
                      Status = 0<a name='1064'>
                  END SELECT<a name='1065'>
<a name='1066'>
                  DEALLOCATE( RData )<a name='1067'>
<a name='1068'>
<font color=#447700>! The I/O server "root" handles the "put_dom_td_integer" request.<a name='1069'></font>
                CASE ( int_dom_td_integer )<a name='1070'>
<font color=#447700>!write(0,*)' int_dom_td_integer '<a name='1071'></font>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='1072'>
                  ALLOCATE( IData( bigbuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1073'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TD_HEADER'>int_get_td_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TD_HEADER_6">( bigbuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1074'>
                                          DataHandle, DateStr, Element, IData, Count, code )<a name='1075'>
                  icurs = icurs + hdrbufsize<a name='1076'>
<a name='1077'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1078'>
#ifdef NETCDF<a name='1079'>
                    CASE ( IO_NETCDF   )<a name='1080'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TD_INTEGER'>ext_ncd_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TD_INTEGER_3">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1081'>
#endif<a name='1082'>
#ifdef INTIO<a name='1083'>
                    CASE ( IO_INTIO   )<a name='1084'>
                      CALL ext_int_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1085'>
#endif<a name='1086'>
#ifdef YYY<a name='1087'>
                 CASE ( IO_YYY )<a name='1088'>
                    CALL ext_yyy_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1089'>
#endif<a name='1090'>
#ifdef GRIB1<a name='1091'>
                 CASE ( IO_GRIB1 )<a name='1092'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TD_INTEGER'>ext_gr1_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TD_INTEGER_3">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1093'>
#endif<a name='1094'>
#ifdef GRIB2<a name='1095'>
                 CASE ( IO_GRIB2 )<a name='1096'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TD_INTEGER'>ext_gr2_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TD_INTEGER_3">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='1097'>
#endif<a name='1098'>
                    CASE DEFAULT<a name='1099'>
                      Status = 0<a name='1100'>
                  END SELECT<a name='1101'>
<a name='1102'>
                  DEALLOCATE( IData )<a name='1103'>
<a name='1104'>
<font color=#447700>! The I/O server "root" handles the "put_dom_ti_integer" request.<a name='1105'></font>
                CASE ( int_dom_ti_integer )<a name='1106'>
<font color=#447700>!write(0,*)' int_dom_ti_integer '<a name='1107'></font>
<a name='1108'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='1109'>
                  ALLOCATE( IData( bigbuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1110'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER'>int_get_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_6">( bigbuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1111'>
                                          DataHandle, Element, IData, Count, code )<a name='1112'>
                  icurs = icurs + hdrbufsize<a name='1113'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1114'>
#ifdef NETCDF<a name='1115'>
                    CASE ( IO_NETCDF   )<a name='1116'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_INTEGER'>ext_ncd_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_INTEGER_3">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1117'>
<font color=#447700>!write(0,*)'ext_ncd_put_dom_ti_integer ',handle(DataHandle),TRIM(Element),IData,Status<a name='1118'></font>
#endif<a name='1119'>
#ifdef INTIO<a name='1120'>
                    CASE ( IO_INTIO   )<a name='1121'>
                      CALL ext_int_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1122'>
#endif<a name='1123'>
#ifdef YYY<a name='1124'>
                 CASE ( IO_YYY )<a name='1125'>
                    CALL ext_yyy_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1126'>
#endif<a name='1127'>
#ifdef GRIB1<a name='1128'>
                 CASE ( IO_GRIB1 )<a name='1129'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_INTEGER'>ext_gr1_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_INTEGER_3">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1130'>
#endif<a name='1131'>
#ifdef GRIB2<a name='1132'>
                 CASE ( IO_GRIB2 )<a name='1133'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_INTEGER'>ext_gr2_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_INTEGER_3">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='1134'>
#endif<a name='1135'>
<a name='1136'>
                    CASE DEFAULT<a name='1137'>
                      Status = 0<a name='1138'>
                  END SELECT<a name='1139'>
<a name='1140'>
                  DEALLOCATE( IData)<a name='1141'>
 <a name='1142'>
<font color=#447700>! The I/O server "root" handles the "set_time" request.<a name='1143'></font>
                CASE ( int_set_time )<a name='1144'>
<font color=#447700>!write(0,*)' int_set_time '<a name='1145'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_8">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1146'>
                                               DataHandle, Element, VarName, CData, code )<a name='1147'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1148'>
#ifdef INTIO<a name='1149'>
                    CASE ( IO_INTIO   )<a name='1150'>
                      CALL ext_int_set_time ( handle(DataHandle), TRIM(CData), Status)<a name='1151'>
#endif<a name='1152'>
                    CASE DEFAULT<a name='1153'>
                      Status = 0<a name='1154'>
                  END SELECT<a name='1155'>
<a name='1156'>
                  icurs = icurs + hdrbufsize<a name='1157'>
<a name='1158'>
<font color=#447700>! The I/O server "root" handles the "put_dom_ti_char" request.<a name='1159'></font>
                CASE ( int_dom_ti_char )<a name='1160'>
<font color=#447700>!write(0,*)' before int_get_ti_header_char '<a name='1161'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_9">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1162'>
                                               DataHandle, Element, VarName, CData, code )<a name='1163'>
<font color=#447700>!write(0,*)' after int_get_ti_header_char ',VarName<a name='1164'></font>
<a name='1165'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1166'>
#ifdef NETCDF<a name='1167'>
                    CASE ( IO_NETCDF   )<a name='1168'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_CHAR'>ext_ncd_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_CHAR_3"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1169'>
#endif<a name='1170'>
#ifdef INTIO<a name='1171'>
                    CASE ( IO_INTIO   )<a name='1172'>
                      CALL ext_int_put_dom_ti_char ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1173'>
#endif<a name='1174'>
#ifdef YYY<a name='1175'>
                 CASE ( IO_YYY )<a name='1176'>
                    CALL ext_yyy_put_dom_ti_char ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1177'>
#endif<a name='1178'>
#ifdef GRIB1<a name='1179'>
                 CASE ( IO_GRIB1 )<a name='1180'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_CHAR'>ext_gr1_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_CHAR_3"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1181'>
#endif<a name='1182'>
#ifdef GRIB2<a name='1183'>
                 CASE ( IO_GRIB2 )<a name='1184'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_CHAR'>ext_gr2_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_CHAR_3"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='1185'>
#endif<a name='1186'>
                    CASE DEFAULT<a name='1187'>
                      Status = 0<a name='1188'>
                  END SELECT<a name='1189'>
<a name='1190'>
                  icurs = icurs + hdrbufsize<a name='1191'>
<a name='1192'>
<font color=#447700>! The I/O server "root" handles the "put_var_ti_char" request.<a name='1193'></font>
                CASE ( int_var_ti_char )<a name='1194'>
<font color=#447700>!write(0,*)' int_var_ti_char '<a name='1195'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_10">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1196'>
                                               DataHandle, Element, VarName, CData, code )<a name='1197'>
<a name='1198'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1199'>
#ifdef NETCDF<a name='1200'>
                    CASE ( IO_NETCDF   )<a name='1201'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_VAR_TI_CHAR'>ext_ncd_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_VAR_TI_CHAR_3"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1202'>
#endif<a name='1203'>
#ifdef INTIO<a name='1204'>
                    CASE ( IO_INTIO   )<a name='1205'>
                      CALL ext_int_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1206'>
#endif<a name='1207'>
#ifdef YYY<a name='1208'>
                 CASE ( IO_YYY )<a name='1209'>
                    CALL ext_yyy_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1210'>
#endif<a name='1211'>
#ifdef GRIB1<a name='1212'>
                 CASE ( IO_GRIB1 )<a name='1213'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_VAR_TI_CHAR'>ext_gr1_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_VAR_TI_CHAR_3"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1214'>
#endif<a name='1215'>
#ifdef GRIB2<a name='1216'>
                 CASE ( IO_GRIB2 )<a name='1217'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_VAR_TI_CHAR'>ext_gr2_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_VAR_TI_CHAR_3"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='1218'>
#endif<a name='1219'>
                    CASE DEFAULT<a name='1220'>
                      Status = 0<a name='1221'>
                  END SELECT<a name='1222'>
<a name='1223'>
                  icurs = icurs + hdrbufsize<a name='1224'>
<a name='1225'>
                CASE ( int_ioexit )<a name='1226'>
<font color=#447700>! ioexit is now handled by sending negative message length to server<a name='1227'></font>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_322">( &amp;<a name='1228'>
                         "quilt: should have handled int_ioexit already")<a name='1229'>
<font color=#447700>! The I/O server "root" handles the "ioclose" request.<a name='1230'></font>
                CASE ( int_ioclose )<a name='1231'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_7">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1232'>
                                              DataHandle , code )<a name='1233'>
                  icurs = icurs + hdrbufsize<a name='1234'>
<a name='1235'>
                  IF ( DataHandle .GE. 1 ) THEN<a name='1236'>
<a name='1237'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1238'>
#ifdef NETCDF<a name='1239'>
                    CASE ( IO_NETCDF   )<a name='1240'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_INQUIRE_FILENAME'>ext_ncd_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_INQUIRE_FILENAME_6">( handle(DataHandle), fname, fstat, Status )<a name='1241'>
                      IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1242'>
                        CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOCLOSE'>ext_ncd_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOCLOSE_5">(handle(DataHandle),Status)<a name='1243'>
                      ENDIF<a name='1244'>
#endif<a name='1245'>
#ifdef PNETCDF<a name='1246'>
                    CASE ( IO_PNETCDF   )<a name='1247'>
                      CALL ext_pnc_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1248'>
                      IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1249'>
                        CALL ext_pnc_ioclose(handle(DataHandle),Status)<a name='1250'>
                      ENDIF<a name='1251'>
#endif<a name='1252'>
#ifdef INTIO<a name='1253'>
                    CASE ( IO_INTIO   )<a name='1254'>
                      CALL ext_int_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1255'>
                      IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1256'>
                        CALL ext_int_ioclose(handle(DataHandle),Status)<a name='1257'>
                      ENDIF<a name='1258'>
#endif<a name='1259'>
#ifdef YYY<a name='1260'>
                 CASE ( IO_YYY )<a name='1261'>
                    CALL ext_yyy_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1262'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1263'>
                      CALL ext_yyy_ioclose(handle(DataHandle),Status)<a name='1264'>
                    ENDIF<a name='1265'>
#endif<a name='1266'>
#ifdef GRIB1<a name='1267'>
                 CASE ( IO_GRIB1 )<a name='1268'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_INQUIRE_FILENAME'>ext_gr1_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_INQUIRE_FILENAME_6">( handle(DataHandle), fname, fstat, Status )<a name='1269'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1270'>
                      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOCLOSE'>ext_gr1_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOCLOSE_4">(handle(DataHandle),Status)<a name='1271'>
                    ENDIF<a name='1272'>
#endif<a name='1273'>
#ifdef GRIB2<a name='1274'>
                 CASE ( IO_GRIB2 )<a name='1275'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_INQUIRE_FILENAME'>ext_gr2_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_INQUIRE_FILENAME_6">( handle(DataHandle), fname, fstat, Status )<a name='1276'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1277'>
                      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOCLOSE'>ext_gr2_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOCLOSE_4">(handle(DataHandle),Status)<a name='1278'>
                    ENDIF<a name='1279'>
#endif<a name='1280'>
                    CASE DEFAULT<a name='1281'>
                      Status = 0<a name='1282'>
                  END SELECT<a name='1283'>
                  ENDIF<a name='1284'>
<a name='1285'>
<font color=#447700>! If desired, outputs a ready flag after quilting subroutine closes the data handle for history (wrfout) file.<a name='1286'></font>
<a name='1287'>
                  IF (fname(1:6) .EQ. 'wrfout' .AND. config_flags%output_ready_flag ) THEN<a name='1288'>
                    OPEN (unit=99,file='wrfoutReady' // fname(7:30), status='unknown', access='sequential')<a name='1289'>
                    CLOSE (99)<a name='1290'>
                  ENDIF<a name='1291'>
<a name='1292'>
<font color=#447700>! The I/O server "root" handles the "open_for_write_begin" request.<a name='1293'></font>
                CASE ( int_open_for_write_begin )<a name='1294'>
<a name='1295'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_OFWB_HEADER'>int_get_ofwb_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_OFWB_HEADER_3">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1296'>
                                            FileName,SysDepInfo,io_form_arg,DataHandle )<a name='1297'>
<a name='1298'>
<font color=#447700>!write(0,*)' int_open_for_write_begin itypesize ',itypesize,' itypesize ',itypesize<a name='1299'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin icurs ', icurs, hdrbufsize<a name='1300'></font>
<font color=#447700>!JMDEBUGwrite(0,*)' int_open_for_write_begin FileName ',TRIM(FileName) , ' DataHandle ', DataHandle<a name='1301'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin SysDepInfo ',TRIM(SysDepInfo) <a name='1302'></font>
                  icurs = icurs + hdrbufsize<a name='1303'>
<font color=#447700>!write(0,*)' int_open_for_write_begin new icurs,tag,size ', icurs, get_hdr_tag( bigbuf(icurs/itypesize) ),get_hdr_rec_size( bigbuf(icurs/itypesize) )<a name='1304'></font>
                <a name='1305'>
                  io_form(DataHandle) = io_form_arg<a name='1306'>
<a name='1307'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1308'>
#ifdef NETCDF<a name='1309'>
                    CASE ( IO_NETCDF   )<a name='1310'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_OPEN_FOR_WRITE_BEGIN'>ext_ncd_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_OPEN_FOR_WRITE_BEGIN_5">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1311'>
<font color=#447700>!write(0,*)'ext_ncd_open_for_write_begin ',Trim(FileName),DataHandle,handle(DataHandle),Status<a name='1312'></font>
#endif<a name='1313'>
#ifdef INTIO<a name='1314'>
                    CASE ( IO_INTIO   )<a name='1315'>
                      CALL ext_int_open_for_write_begin(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1316'>
#endif<a name='1317'>
#ifdef YYY<a name='1318'>
                    CASE ( IO_YYY )<a name='1319'>
                       CALL ext_yyy_open_for_write_begin(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1320'>
#endif<a name='1321'>
#ifdef GRIB1<a name='1322'>
                    CASE ( IO_GRIB1 )<a name='1323'>
                       CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_OPEN_FOR_WRITE_BEGIN'>ext_gr1_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_OPEN_FOR_WRITE_BEGIN_4">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1324'>
#endif<a name='1325'>
#ifdef GRIB2<a name='1326'>
                    CASE ( IO_GRIB2 )<a name='1327'>
                       CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_OPEN_FOR_WRITE_BEGIN'>ext_gr2_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_OPEN_FOR_WRITE_BEGIN_4">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='1328'>
#endif<a name='1329'>
                    CASE DEFAULT<a name='1330'>
                      Status = 0<a name='1331'>
                  END SELECT<a name='1332'>
                <a name='1333'>
                  okay_to_write(DataHandle) = .false.<a name='1334'>
<a name='1335'>
<font color=#447700>! The I/O server "root" handles the "open_for_write_commit" request.<a name='1336'></font>
<font color=#447700>! In this case, the "okay_to_commit" is simply set to .true. so "write_field"<a name='1337'></font>
<font color=#447700>! requests will initiate writes to disk.  Actual commit will be done after<a name='1338'></font>
<font color=#447700>! all requests in this batch have been handled.<a name='1339'></font>
                CASE ( int_open_for_write_commit )<a name='1340'>
<a name='1341'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_8">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1342'>
                                              DataHandle , code )<a name='1343'>
                  icurs = icurs + hdrbufsize<a name='1344'>
                  okay_to_commit(DataHandle) = .true.<a name='1345'>
<a name='1346'>
<font color=#447700>! The I/O server "root" handles the "write_field" (int_field) request.<a name='1347'></font>
<font color=#447700>! If okay_to_write(DataHandle) is .true. then the patch in the<a name='1348'></font>
<font color=#447700>! header (bigbuf) is written to a globally-sized internal output buffer via<a name='1349'></font>
<font color=#447700>! the call to store_patch_in_outbuf().  Note that this is where the actual<a name='1350'></font>
<font color=#447700>! "quilting" (reassembly of patches onto a full-size domain) is done.  If<a name='1351'></font>
<font color=#447700>! okay_to_write(DataHandle) is .false. then external I/O package interfaces<a name='1352'></font>
<font color=#447700>! are called to write metadata for I/O formats that support native metadata.<a name='1353'></font>
<font color=#447700>!<a name='1354'></font>
<font color=#447700>! NOTE that the I/O server "root" will only see write_field (int_field)<a name='1355'></font>
<font color=#447700>! requests AFTER an "iosync" request.<a name='1356'></font>
                CASE ( int_field )<a name='1357'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='1358'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_10"> ( bigbuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='1359'>
                                                    DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='1360'>
                                                    DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='1361'>
                                                    DomainStart , DomainEnd ,                                    &amp;<a name='1362'>
                                                    MemoryStart , MemoryEnd ,                                    &amp;<a name='1363'>
                                                    PatchStart , PatchEnd )<a name='1364'>
<font color=#447700>!write(0,*)' int_field ',TRIM(VarName),DataHandle,okay_to_write(DataHandle)<a name='1365'></font>
                  icurs = icurs + hdrbufsize<a name='1366'>
<a name='1367'>
                  IF ( okay_to_write(DataHandle) ) THEN<a name='1368'>
<a name='1369'>
<font color=#447700>!                    WRITE(0,*)'&gt;&gt;&gt; ',TRIM(DateStr), ' ', TRIM(VarName), ' ', TRIM(MemoryOrder), ' ', &amp;<a name='1370'></font>
<font color=#447700>!                        (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)*(PatchEnd(3)-PatchStart(3)+1)<a name='1371'></font>
<a name='1372'>
                    IF ( FieldType .EQ. WRF_FLOAT .OR. FieldType .EQ. WRF_DOUBLE)  THEN<a name='1373'>
                      <font color=#447700>! Note that the WRF_DOUBLE branch of this IF statement must come first since <a name='1374'></font>
                      <font color=#447700>! WRF_FLOAT is set equal to WRF_DOUBLE during autopromotion builds.  <a name='1375'></font>
                      IF ( FieldType .EQ. WRF_DOUBLE)  THEN<a name='1376'>
<font color=#447700>! this branch has not been tested TBH: 20050406<a name='1377'></font>
                        CALL mpi_type_size( MPI_DOUBLE_PRECISION, ftypesize, ierr )<a name='1378'>
                      ELSE<a name='1379'>
                        CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='1380'>
                      ENDIF<a name='1381'>
                      stored_write_record = .true.<a name='1382'>
                      CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PATCH_IN_OUTBUF'>store_patch_in_outbuf</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PATCH_IN_OUTBUF_3"> ( bigbuf(icurs/itypesize), dummybuf, TRIM(DateStr), TRIM(VarName) , &amp;<a name='1383'>
                                                   FieldType, TRIM(MemoryOrder), TRIM(Stagger), DimNames, &amp;<a name='1384'>
                                                   DomainStart , DomainEnd , &amp;<a name='1385'>
                                                   MemoryStart , MemoryEnd , &amp;<a name='1386'>
                                                   PatchStart , PatchEnd )<a name='1387'>
<a name='1388'>
                    ELSE IF ( FieldType .EQ. WRF_INTEGER ) THEN<a name='1389'>
                      CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='1390'>
                      stored_write_record = .true.<a name='1391'>
                      CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PATCH_IN_OUTBUF'>store_patch_in_outbuf</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PATCH_IN_OUTBUF_4"> ( dummybuf, bigbuf(icurs/itypesize), TRIM(DateStr), TRIM(VarName) , &amp;<a name='1392'>
                                                   FieldType, TRIM(MemoryOrder), TRIM(Stagger), DimNames, &amp;<a name='1393'>
                                                   DomainStart , DomainEnd , &amp;<a name='1394'>
                                                   MemoryStart , MemoryEnd , &amp;<a name='1395'>
                                                   PatchStart , PatchEnd )<a name='1396'>
                    ELSE IF ( FieldType .EQ. WRF_LOGICAL ) THEN<a name='1397'>
                      ftypesize = LWORDSIZE<a name='1398'>
                    ENDIF<a name='1399'>
                    icurs = icurs + (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='1400'>
                                    (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='1401'>
                  ELSE<a name='1402'>
                    SELECT CASE (use_package(io_form(DataHandle)))<a name='1403'>
#ifdef NETCDF<a name='1404'>
                      CASE ( IO_NETCDF   )<a name='1405'>
                        CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_WRITE_FIELD'>ext_ncd_write_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_WRITE_FIELD_3"> ( handle(DataHandle) , TRIM(DateStr) ,         &amp;<a name='1406'>
                                   TRIM(VarName) , dummy , FieldType , Comm , IOComm,           &amp;<a name='1407'>
                                   DomainDesc , TRIM(MemoryOrder) , TRIM(Stagger) , DimNames ,  &amp;<a name='1408'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='1409'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='1410'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='1411'>
                                   Status )<a name='1412'>
#endif<a name='1413'>
#if 0<a name='1414'>
<font color=#447700>! since this is training and the grib output doesn't need training, disable this branch.<a name='1415'></font>
#ifdef YYY<a name='1416'>
                 CASE ( IO_YYY )<a name='1417'>
                      CALL ext_YYY_write_field ( handle(DataHandle) , TRIM(DateStr) ,         &amp;<a name='1418'>
                                 TRIM(VarName) , dummy , FieldType , Comm , IOComm,           &amp;<a name='1419'>
                                 DomainDesc , TRIM(MemoryOrder) , TRIM(Stagger) , DimNames ,  &amp;<a name='1420'>
                                 DomainStart , DomainEnd ,                                    &amp;<a name='1421'>
                                 DomainStart , DomainEnd ,                                    &amp;<a name='1422'>
                                 DomainStart , DomainEnd ,                                    &amp;<a name='1423'>
                                 Status )<a name='1424'>
#endif<a name='1425'>
#endif<a name='1426'>
                      CASE DEFAULT<a name='1427'>
                        Status = 0<a name='1428'>
                    END SELECT<a name='1429'>
                  ENDIF<a name='1430'>
                CASE ( int_iosync )<a name='1431'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_9">( bigbuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='1432'>
                                            DataHandle , code )<a name='1433'>
                  icurs = icurs + hdrbufsize<a name='1434'>
                CASE DEFAULT<a name='1435'>
                  WRITE(mess,*)'quilt: bad tag: ',get_hdr_tag( bigbuf(icurs/itypesize) ),' icurs ',icurs/itypesize<a name='1436'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_323">( mess )<a name='1437'>
              END SELECT<a name='1438'>
<a name='1439'>
            ENDDO <font color=#447700>!}<a name='1440'></font>
<font color=#447700>! Now, the I/O server "root" has finshed handling all commands from the latest<a name='1441'></font>
<font color=#447700>! call to retrieve_pieces_of_field().<a name='1442'></font>
<a name='1443'>
            IF (stored_write_record) THEN<a name='1444'>
<font color=#447700>! If any fields have been stored in a globally-sized internal output buffer<a name='1445'></font>
<font color=#447700>! (via a call to store_patch_in_outbuf()) then call write_outbuf() to write<a name='1446'></font>
<font color=#447700>! them to disk now.<a name='1447'></font>
<font color=#447700>! NOTE that the I/O server "root" will only have called<a name='1448'></font>
<font color=#447700>! store_patch_in_outbuf() when handling write_field (int_field)<a name='1449'></font>
<font color=#447700>! commands which only arrive AFTER an "iosync" command.<a name='1450'></font>
<font color=#447700>!              CALL start_timing<a name='1451'></font>
              CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#WRITE_OUTBUF'>write_outbuf</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_OUTBUF_2"> ( handle(DataHandle), use_package(io_form(DataHandle))) <a name='1452'>
<font color=#447700>!              CALL end_timing( "quilt: call to write_outbuf" ) <a name='1453'></font>
            ENDIF<a name='1454'>
<a name='1455'>
<font color=#447700>! If one or more "open_for_write_commit" commands were encountered from the<a name='1456'></font>
<font color=#447700>! latest call to retrieve_pieces_of_field() then call the package-specific<a name='1457'></font>
<font color=#447700>! routine to do the commit.<a name='1458'></font>
            IF (okay_to_commit(DataHandle)) THEN<a name='1459'>
<a name='1460'>
              SELECT CASE (use_package(io_form(DataHandle)))<a name='1461'>
#ifdef NETCDF<a name='1462'>
                CASE ( IO_NETCDF   )<a name='1463'>
                  CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_INQUIRE_FILENAME'>ext_ncd_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_INQUIRE_FILENAME_7">( handle(DataHandle), fname, fstat, Status )<a name='1464'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1465'>
                    CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_OPEN_FOR_WRITE_COMMIT'>ext_ncd_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_OPEN_FOR_WRITE_COMMIT_4">(handle(DataHandle),Status)<a name='1466'>
                    okay_to_write(DataHandle) = .true.<a name='1467'>
                  ENDIF<a name='1468'>
#endif<a name='1469'>
#ifdef INTIO<a name='1470'>
                CASE ( IO_INTIO   )<a name='1471'>
                  CALL ext_int_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1472'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1473'>
                    CALL ext_int_open_for_write_commit(handle(DataHandle),Status)<a name='1474'>
                    okay_to_write(DataHandle) = .true.<a name='1475'>
                  ENDIF<a name='1476'>
#endif<a name='1477'>
#ifdef YYY<a name='1478'>
                 CASE ( IO_YYY )<a name='1479'>
                    CALL ext_yyy_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='1480'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1481'>
                       CALL ext_yyy_open_for_write_commit(handle(DataHandle),Status)<a name='1482'>
                       okay_to_write(DataHandle) = .true.<a name='1483'>
                    ENDIF<a name='1484'>
#endif<a name='1485'>
#ifdef GRIB1<a name='1486'>
                 CASE ( IO_GRIB1 )<a name='1487'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_INQUIRE_FILENAME'>ext_gr1_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_INQUIRE_FILENAME_7">( handle(DataHandle), fname, fstat, Status )<a name='1488'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1489'>
                       CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_OPEN_FOR_WRITE_COMMIT'>ext_gr1_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_OPEN_FOR_WRITE_COMMIT_4">(handle(DataHandle),Status)<a name='1490'>
                       okay_to_write(DataHandle) = .true.<a name='1491'>
                    ENDIF<a name='1492'>
#endif<a name='1493'>
#ifdef GRIB2<a name='1494'>
                 CASE ( IO_GRIB2 )<a name='1495'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_INQUIRE_FILENAME'>ext_gr2_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_INQUIRE_FILENAME_7">( handle(DataHandle), fname, fstat, Status )<a name='1496'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='1497'>
                       CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_OPEN_FOR_WRITE_COMMIT'>ext_gr2_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_OPEN_FOR_WRITE_COMMIT_4">(handle(DataHandle),Status)<a name='1498'>
                       okay_to_write(DataHandle) = .true.<a name='1499'>
                    ENDIF<a name='1500'>
#endif<a name='1501'>
<a name='1502'>
                CASE DEFAULT<a name='1503'>
                  Status = 0<a name='1504'>
              END SELECT<a name='1505'>
<a name='1506'>
            okay_to_commit(DataHandle) = .false.<a name='1507'>
          ENDIF<a name='1508'>
          DEALLOCATE( bigbuf )<a name='1509'>
        ENDIF<a name='1510'>
#endif<a name='1511'>
        if(allocated(bigbuf)) deallocate(bigbuf)<a name='1512'>
<font color=#447700>! Retrieve header and all patches for the next field from the internal <a name='1513'></font>
<font color=#447700>! buffers.  <a name='1514'></font>
        CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#RETRIEVE_PIECES_OF_FIELD'>retrieve_pieces_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_PIECES_OF_FIELD_6"> ( obuf , VarName, obufsize, sz, retval )<a name='1515'>
<font color=#447700>! Sum sizes of all headers and patches (data) for this field from all I/O <a name='1516'></font>
<font color=#447700>! servers in this I/O server group onto the I/O server "root".<a name='1517'></font>
        CALL mpi_x_reduce( sz, bigbufsize, 1, MPI_INTEGER,MPI_SUM, ntasks_local_group-1,mpi_comm_local, ierr )<a name='1518'>
<font color=#447700>! Then, return to the top of the loop to collect headers and data from all <a name='1519'></font>
<font color=#447700>! I/O servers in this I/O server group onto the I/O server "root" and handle <a name='1520'></font>
<font color=#447700>! the next batch of commands.  <a name='1521'></font>
      END DO <font color=#447700>!}<a name='1522'></font>
<a name='1523'>
      DEALLOCATE( obuf )<a name='1524'>
<a name='1525'>
      <font color=#447700>! flush output files if needed<a name='1526'></font>
      IF (stored_write_record) THEN<a name='1527'>
<font color=#447700>!         CALL start_timing()<a name='1528'></font>
        SELECT CASE ( use_package(io_form) )<a name='1529'>
#ifdef NETCDF<a name='1530'>
          CASE ( IO_NETCDF   )<a name='1531'>
            CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOSYNC'>ext_ncd_iosync</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOSYNC_3">( handle(DataHandle), Status )<a name='1532'>
#endif<a name='1533'>
#ifdef XXX<a name='1534'>
          CASE ( IO_XXX   )<a name='1535'>
            CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOSYNC'>ext_xxx_iosync</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOSYNC_3">( handle(DataHandle), Status )<a name='1536'>
#endif<a name='1537'>
#ifdef YYY<a name='1538'>
          CASE ( IO_YYY   )<a name='1539'>
            CALL ext_yyy_iosync( handle(DataHandle), Status )<a name='1540'>
#endif<a name='1541'>
#ifdef ZZZ<a name='1542'>
          CASE ( IO_ZZZ   )<a name='1543'>
            CALL ext_zzz_iosync( handle(DataHandle), Status )<a name='1544'>
#endif<a name='1545'>
#ifdef GRIB1<a name='1546'>
          CASE ( IO_GRIB1   )<a name='1547'>
            CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOSYNC'>ext_gr1_iosync</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOSYNC_3">( handle(DataHandle), Status )<a name='1548'>
#endif<a name='1549'>
#ifdef GRIB2<a name='1550'>
          CASE ( IO_GRIB2   )<a name='1551'>
            CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOSYNC'>ext_gr2_iosync</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOSYNC_3">( handle(DataHandle), Status )<a name='1552'>
#endif<a name='1553'>
#ifdef INTIO<a name='1554'>
          CASE ( IO_INTIO   )<a name='1555'>
            CALL ext_int_iosync( handle(DataHandle), Status )<a name='1556'>
#endif<a name='1557'>
          CASE DEFAULT<a name='1558'>
            Status = 0<a name='1559'>
        END SELECT<a name='1560'>
<font color=#447700>!CALL end_timing( "quilt: flush" )<a name='1561'></font>
      ENDIF<a name='1562'>
<a name='1563'>
      END DO <font color=#447700>! }<a name='1564'></font>
<a name='1565'>
    END SUBROUTINE quilt<a name='1566'>
<a name='1567'>
<A NAME='QUILT_PNC'><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1568'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>quilt_pnc</font> <A href='../../call_to/QUILT_PNC.html' TARGET='index'>2</A>,<A href='../../call_from/QUILT_PNC.html' TARGET='index'>167</A><a name='1569'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1570'></font>
<font color=#447700>! Same as quilt() routine except that _all_ of the IO servers that call it<a name='1571'></font>
<font color=#447700>! actually write data to disk using pNetCDF. This version is only used when <a name='1572'></font>
<font color=#447700>! the  code is compiled with PNETCDF_QUILT defined.<a name='1573'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1574'></font>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_98"><a name='1575'>
      USE <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#MODULE_QUILT_OUTBUF_OPS'>module_quilt_outbuf_ops</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_QUILT_OUTBUF_OPS_4"><a name='1576'>
      IMPLICIT NONE<a name='1577'>
      INCLUDE 'mpif.h'<a name='1578'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_3"><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1579'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_4"><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1580'>
      INTEGER itag, ninbuf, ntasks_io_group, ntasks_local_group, mytask_local, ierr<a name='1581'>
      INTEGER istat<a name='1582'>
      INTEGER mytask_io_group<a name='1583'>
      INTEGER   :: nout_set = 0<a name='1584'>
      INTEGER   :: obufsize, bigbufsize, chunksize, sz<a name='1585'>
      REAL,                 DIMENSION(1) :: dummy<a name='1586'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: obuf, bigbuf<a name='1587'>
      REAL,    ALLOCATABLE, DIMENSION(:) :: RDATA<a name='1588'>
      INTEGER, ALLOCATABLE, DIMENSION(:) :: IDATA<a name='1589'>
      CHARACTER (LEN=512) :: CDATA<a name='1590'>
      CHARACTER (LEN=80) :: fname<a name='1591'>
      INTEGER icurs, hdrbufsize, itypesize, ftypesize, rtypesize, Status, fstat, io_form_arg<a name='1592'>
      INTEGER :: DataHandle, FieldType, Comm, IOComm, DomainDesc, code, Count<a name='1593'>
      INTEGER, DIMENSION(3) :: DomainStart , DomainEnd , MemoryStart , MemoryEnd , PatchStart , PatchEnd<a name='1594'>
      INTEGER :: dummybuf(1)<a name='1595'>
      INTEGER :: num_noops, num_commit_messages, num_field_training_msgs, hdr_tag<a name='1596'>
      CHARACTER (len=256) :: DateStr , Element, VarName, MemoryOrder , Stagger , DimNames(3), FileName, SysDepInfo, mess<a name='1597'>
      INTEGER, EXTERNAL :: use_package<a name='1598'>
      LOGICAL           :: stored_write_record, retval, written_record<a name='1599'>
      INTEGER iii, jjj, vid, CC, DD<a name='1600'>
<a name='1601'>
<font color=#447700>!      logical okay_to_w<a name='1602'></font>
<font color=#447700>!      character*120 sysline<a name='1603'></font>
<a name='1604'>
<font color=#447700>! Call ext_pkg_ioinit() routines to initialize I/O packages.  <a name='1605'></font>
      SysDepInfo = " "<a name='1606'>
#ifdef NETCDF<a name='1607'>
      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOINIT'>ext_ncd_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOINIT_5">( SysDepInfo, ierr)<a name='1608'>
#endif<a name='1609'>
#ifdef PNETCDF_QUILT<a name='1610'>
      CALL ext_pnc_ioinit( SysDepInfo, ierr)<a name='1611'>
#endif<a name='1612'>
#ifdef INTIO<a name='1613'>
      CALL ext_int_ioinit( SysDepInfo, ierr )<a name='1614'>
#endif<a name='1615'>
#ifdef XXX<a name='1616'>
      CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOINIT'>ext_xxx_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOINIT_5">( SysDepInfo, ierr)<a name='1617'>
#endif<a name='1618'>
#ifdef YYY<a name='1619'>
      CALL ext_yyy_ioinit( SysDepInfo, ierr)<a name='1620'>
#endif<a name='1621'>
#ifdef ZZZ<a name='1622'>
      CALL ext_zzz_ioinit( SysDepInfo, ierr)<a name='1623'>
#endif<a name='1624'>
#ifdef GRIB1<a name='1625'>
      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOINIT'>ext_gr1_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOINIT_5">( SysDepInfo, ierr)<a name='1626'>
#endif<a name='1627'>
#ifdef GRIB2<a name='1628'>
      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOINIT'>ext_gr2_ioinit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOINIT_5">( SysDepInfo, ierr)<a name='1629'>
#endif<a name='1630'>
<a name='1631'>
      okay_to_commit = .false.<a name='1632'>
      stored_write_record = .false.<a name='1633'>
      ninbuf = 0<a name='1634'>
      <font color=#447700>! get info. about the I/O server group that this I/O server task<a name='1635'></font>
      <font color=#447700>! belongs to<a name='1636'></font>
      CALL mpi_x_comm_size( mpi_comm_io_groups(1), ntasks_io_group,    ierr )<a name='1637'>
      CALL MPI_COMM_RANK( mpi_comm_io_groups(1), mytask_io_group,    ierr )<a name='1638'>
      CALL mpi_x_comm_size( mpi_comm_local,        ntasks_local_group, ierr )<a name='1639'>
      CALL MPI_COMM_RANK( mpi_comm_local,        mytask_local,       ierr )<a name='1640'>
<a name='1641'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='1642'>
      IF ( itypesize &lt;= 0 ) THEN<a name='1643'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_324">("external/RSL/module_dm.F: quilt: type size &lt;= 0 invalid")<a name='1644'>
      ENDIF<a name='1645'>
<a name='1646'>
<font color=#447700>! Work out whether this i/o server processor has one fewer associated compute proc than<a name='1647'></font>
<font color=#447700>! the most any processor has. Can happen when number of i/o tasks does not evenly divide<a name='1648'></font>
<font color=#447700>! the number of compute tasks. This is needed to keep the i/o tasks sychronized on the<a name='1649'></font>
<font color=#447700>! same message when they start commmunicating to stitch together an output.<a name='1650'></font>
<font color=#447700>!<a name='1651'></font>
<font color=#447700>! Compute processes associated with this task:<a name='1652'></font>
       CC = ntasks_io_group - 1<a name='1653'>
<font color=#447700>! Number of compute tasks per I/O task (less remainder)<a name='1654'></font>
       DD = ncompute_tasks / ntasks_local_group<a name='1655'>
<font color=#447700>!<a name='1656'></font>
<font color=#447700>! If CC-DD is 1 on servrs with the maximum number of compute clients, <a name='1657'></font>
<font color=#447700>!             0 on servrs with one less than maximum<a name='1658'></font>
<a name='1659'>
<a name='1660'>
<font color=#447700>! infinite loop until shutdown message received<a name='1661'></font>
<font color=#447700>! This is the main request-handling loop.  I/O quilt servers stay in this loop <a name='1662'></font>
<font color=#447700>! until the model run ends.  <a name='1663'></font>
<font color=#447700>!okay_to_w = .false.<a name='1664'></font>
      DO WHILE (.TRUE.)  <font color=#447700>! {<a name='1665'></font>
<a name='1666'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1667'></font>
<font color=#447700>! Each I/O server receives requests from its compute tasks.  Each request<a name='1668'></font>
<font color=#447700>! is contained in a data header (see module_internal_header_util.F for<a name='1669'></font>
<font color=#447700>! detailed descriptions of data headers).<a name='1670'></font>
<font color=#447700>! Each request is sent in two phases.  First, sizes of all messages that <a name='1671'></font>
<font color=#447700>! will be sent from the compute tasks to this I/O server are summed on the <a name='1672'></font>
<font color=#447700>! I/O server via MPI_reduce().  The I/O server then allocates buffer "obuf" <a name='1673'></font>
<font color=#447700>! and receives concatenated messages from the compute tasks in it via the <a name='1674'></font>
<font color=#447700>! call to collect_on_comm().  Note that "sizes" are generally expressed in <a name='1675'></font>
<font color=#447700>! *bytes* in this code so conversion to "count" (number of Fortran words) is <a name='1676'></font>
<font color=#447700>! required for Fortran indexing and MPI calls.  <a name='1677'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1678'></font>
        <font color=#447700>! wait for info from compute tasks in the I/O group that we're ready to rock<a name='1679'></font>
        <font color=#447700>! obufsize will contain number of *bytes*<a name='1680'></font>
<font color=#447700>!CALL start_timing<a name='1681'></font>
        <font color=#447700>! first element of reduced is obufsize, second is DataHandle <a name='1682'></font>
        <font color=#447700>! if needed (currently needed only for ioclose).<a name='1683'></font>
        reduced_dummy = 0<a name='1684'>
        CALL mpi_x_reduce( reduced_dummy, reduced, 2, MPI_INTEGER, MPI_SUM, mytask_io_group, mpi_comm_io_groups(1), ierr )<a name='1685'>
        obufsize = reduced(1)<a name='1686'>
<font color=#447700>!CALL end_timing("MPI_Reduce at top of forever loop") <a name='1687'></font>
<font color=#447700>!JMDEBUGwrite(0,*)'obufsize = ',obufsize<a name='1688'></font>
<font color=#447700>! Negative obufsize will trigger I/O server exit.  <a name='1689'></font>
        IF ( obufsize .LT. 0 ) THEN<a name='1690'>
          IF ( obufsize .EQ. -100 ) THEN         <font color=#447700>! magic number<a name='1691'></font>
#ifdef NETCDF<a name='1692'>
            CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOEXIT'>ext_ncd_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOEXIT_5">( Status )<a name='1693'>
#endif<a name='1694'>
#ifdef PNETCDF_QUILT<a name='1695'>
            CALL ext_pnc_ioexit( Status )<a name='1696'>
#endif<a name='1697'>
#ifdef INTIO<a name='1698'>
            CALL ext_int_ioexit( Status )<a name='1699'>
#endif<a name='1700'>
#ifdef XXX<a name='1701'>
            CALL <A href='../../html_code/frame/xxx_template_ioapi.F.html#EXT_XXX_IOEXIT'>ext_xxx_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_XXX_IOEXIT_5">( Status )<a name='1702'>
#endif<a name='1703'>
#ifdef YYY<a name='1704'>
            CALL ext_yyy_ioexit( Status )<a name='1705'>
#endif<a name='1706'>
#ifdef ZZZ<a name='1707'>
            CALL ext_zzz_ioexit( Status )<a name='1708'>
#endif<a name='1709'>
#ifdef GRIB1<a name='1710'>
            CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOEXIT'>ext_gr1_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOEXIT_5">( Status )<a name='1711'>
#endif<a name='1712'>
#ifdef GRIB2<a name='1713'>
            CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOEXIT'>ext_gr2_ioexit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOEXIT_5">( Status )<a name='1714'>
#endif<a name='1715'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_357"> ( 'I/O QUILT SERVERS DONE' )<a name='1716'>
            CALL mpi_finalize(ierr)<a name='1717'>
            STOP<a name='1718'>
          ELSE<a name='1719'>
            WRITE(mess,*)'Possible 32-bit overflow on output server. Try larger nio_tasks_per_group in namelist.'<a name='1720'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_325">(mess)<a name='1721'>
          ENDIF<a name='1722'>
        ENDIF<a name='1723'>
<a name='1724'>
<font color=#447700>!        CALL start_timing<a name='1725'></font>
<font color=#447700>! Obufsize of zero signals a close<a name='1726'></font>
<a name='1727'>
<font color=#447700>! Allocate buffer obuf to be big enough for the data the compute tasks<a name='1728'></font>
<font color=#447700>! will send.  Note: obuf is size in *bytes* so we need to pare this <a name='1729'></font>
<font color=#447700>! down, since the buffer is INTEGER.  <a name='1730'></font>
        IF ( obufsize .GT. 0 ) THEN<a name='1731'>
          ALLOCATE( obuf( (obufsize+1)/itypesize ) )<a name='1732'>
<a name='1733'>
<font color=#447700>! let's roll; get the data from the compute procs and put in obuf<a name='1734'></font>
          CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_15">(__FILE__,__LINE__, mpi_comm_io_groups(1),        &amp;<a name='1735'>
                                onebyte,                      &amp;<a name='1736'>
                                dummy, 0,                     &amp;<a name='1737'>
                                obuf, obufsize )<a name='1738'>
<font color=#447700>!          CALL end_timing( "quilt on server: collecting data from compute procs" )<a name='1739'></font>
        ELSE<a name='1740'>
          <font color=#447700>! Necessarily, the compute processes send the ioclose signal,<a name='1741'></font>
          <font color=#447700>! if there is one, after the iosync, which means they <a name='1742'></font>
          <font color=#447700>! will stall on the ioclose message waiting for the quilt <a name='1743'></font>
          <font color=#447700>! processes if we handle the way other messages are collected,<a name='1744'></font>
          <font color=#447700>! using collect_on_comm.  This avoids this, but we need<a name='1745'></font>
          <font color=#447700>! a special signal (obufsize zero) and the DataHandle<a name='1746'></font>
          <font color=#447700>! to be closed. That handle is send as the second<a name='1747'></font>
          <font color=#447700>! word of the io_close message received by the MPI_Reduce above.<a name='1748'></font>
          <font color=#447700>! Then a header representing the ioclose message is constructed<a name='1749'></font>
          <font color=#447700>! here and handled below as if it were received from the <a name='1750'></font>
          <font color=#447700>! compute processes. The clients (compute processes) must be<a name='1751'></font>
          <font color=#447700>! careful to send this correctly (one compule process sends the actual<a name='1752'></font>
          <font color=#447700>! handle and everone else sends a zero, so the result sums to <a name='1753'></font>
          <font color=#447700>! the value of the handle).<a name='1754'></font>
          <font color=#447700>!<a name='1755'></font>
          ALLOCATE( obuf( 4096 ) )<a name='1756'>
          <font color=#447700>! DataHandle is provided as second element of reduced<a name='1757'></font>
          CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_10">( obuf, obufsize, itypesize, &amp;<a name='1758'>
                                      reduced(2) , int_ioclose )<a name='1759'>
        ENDIF<a name='1760'>
<a name='1761'>
<font color=#447700>!write(0,*)'calling init_store_piece_of_field'<a name='1762'></font>
<font color=#447700>! Now all messages received from the compute clients are stored in <a name='1763'></font>
<font color=#447700>! obuf.  Scan through obuf and extract headers and field data and store in <a name='1764'></font>
<font color=#447700>! internal buffers.  The scan is done twice, first to determine sizes of <a name='1765'></font>
<font color=#447700>! internal buffers required for storage of headers and fields and second to <a name='1766'></font>
<font color=#447700>! actually store the headers and fields.  This bit of code does not do any <a name='1767'></font>
<font color=#447700>! "quilting" (assembly of patches into full domains).  For each field, it <a name='1768'></font>
<font color=#447700>! simply writes all received patches for the field to disk.<a name='1769'></font>
<font color=#447700>! ARPDBG we can vastly reduce the number of writes to disk by stitching<a name='1770'></font>
<font color=#447700>! any contiguous patches together first. Has implications for synchronisation<a name='1771'></font>
<font color=#447700>! of pNetCDF calls though.<a name='1772'></font>
        CALL init_store_piece_of_field<a name='1773'>
        CALL mpi_type_size ( MPI_INTEGER , itypesize , ierr )<a name='1774'>
<font color=#447700>!write(0,*)'mpi_type_size returns ', itypesize<a name='1775'></font>
<font color=#447700>! Scan obuf the first time to calculate the size of the buffer required for <a name='1776'></font>
<font color=#447700>! each field.  Calls to add_to_bufsize_for_field() accumulate sizes.  <a name='1777'></font>
        vid = 0<a name='1778'>
        icurs = itypesize<a name='1779'>
        num_noops = 0 <a name='1780'>
        num_commit_messages = 0 <a name='1781'>
        num_field_training_msgs = 0 <a name='1782'>
        DO WHILE ( icurs .lt. obufsize ) <font color=#447700>! {<a name='1783'></font>
          hdr_tag = <A href='../../html_code/frame/module_internal_header_util.F.html#GET_HDR_TAG'>get_hdr_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HDR_TAG_7">( obuf ( icurs / itypesize ) )<a name='1784'>
          SELECT CASE ( hdr_tag )<a name='1785'>
            CASE ( int_field )<a name='1786'>
              CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_11"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='1787'>
                                                DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='1788'>
                                                DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='1789'>
                                                DomainStart , DomainEnd ,                                    &amp;<a name='1790'>
                                                MemoryStart , MemoryEnd ,                                    &amp;<a name='1791'>
                                                PatchStart , PatchEnd )<a name='1792'>
              chunksize = (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='1793'>
                          (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='1794'>
<a name='1795'>
              IF ( DomainDesc .EQ. 333933 ) THEN  <font color=#447700>! Training write, only one per group of tasks<a name='1796'></font>
                 IF ( num_field_training_msgs .EQ. 0 ) THEN<a name='1797'>
                   call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_16">( VarName, hdrbufsize )<a name='1798'>
<font color=#447700>!write(0,*) 'X-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1799'></font>
                 ENDIF<a name='1800'>
                 num_field_training_msgs = num_field_training_msgs + 1<a name='1801'>
              ELSE<a name='1802'>
                 call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_17">( VarName, hdrbufsize )<a name='1803'>
<font color=#447700>!write(0,*) 'X-2a', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1804'></font>
              ENDIF<a name='1805'>
              icurs = icurs + hdrbufsize<a name='1806'>
<a name='1807'>
<font color=#447700>!write(0,*) 'X-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1808'></font>
<a name='1809'>
              <font color=#447700>! If this is a real write (i.e. not a training write), accumulate<a name='1810'></font>
              <font color=#447700>! buffersize for this field.<a name='1811'></font>
              IF ( DomainDesc .NE. 333933 ) THEN   <font color=#447700>! magic number<a name='1812'></font>
<font color=#447700>!write(0,*) 'X-1a', chunksize, TRIM(VarName)<a name='1813'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_18">( VarName, chunksize )<a name='1814'>
                icurs = icurs + chunksize<a name='1815'>
              ENDIF<a name='1816'>
            CASE ( int_open_for_write_commit )  <font color=#447700>! only one per group of tasks<a name='1817'></font>
              hdrbufsize = obuf(icurs/itypesize)<a name='1818'>
              IF (num_commit_messages.EQ.0) THEN<a name='1819'>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_19">( 'COMMIT', hdrbufsize )<a name='1820'>
              ENDIF<a name='1821'>
              num_commit_messages = num_commit_messages + 1<a name='1822'>
              icurs = icurs + hdrbufsize<a name='1823'>
            CASE DEFAULT<a name='1824'>
              hdrbufsize = obuf(icurs/itypesize)<a name='1825'>
<a name='1826'>
<font color=#447700>! This logic and the logic in the loop below is used to determine whether<a name='1827'></font>
<font color=#447700>! to send a noop records sent by the compute processes to allow to go<a name='1828'></font>
<font color=#447700>! through. The purpose is to make sure that the communications between this<a name='1829'></font>
<font color=#447700>! server and the other servers in this quilt group stay synchronized in<a name='1830'></font>
<font color=#447700>! the collection loop below, even when the servers are serving different<a name='1831'></font>
<font color=#447700>! numbers of clients. Here are some conditions:<a name='1832'></font>
<font color=#447700>! <a name='1833'></font>
<font color=#447700>!   1. The number of compute clients served will not differ by more than 1<a name='1834'></font>
<font color=#447700>!   2. The servers with +1 number of compute clients begin with task 0<a name='1835'></font>
<font color=#447700>!      of mpi_comm_local, the commicator shared by this group of servers<a name='1836'></font>
<font color=#447700>! <a name='1837'></font>
<font color=#447700>!   3. For each collective field or metadata output from the compute tasks,<a name='1838'></font>
<font color=#447700>!      there will be one record sent to the associated i/o server task. The<a name='1839'></font>
<font color=#447700>!      i/o server task collects these records and stores them contiguously<a name='1840'></font>
<font color=#447700>!      in a buffer (obuf) using collect_on_comm above.  Thus, obuf on this<a name='1841'></font>
<font color=#447700>!      server task will contain one record from each associated compute<a name='1842'></font>
<font color=#447700>!      task, in order.<a name='1843'></font>
<font color=#447700>! ! <a name='1844'></font>
<font color=#447700>!   4. In the case of replicated output from the compute tasks<a name='1845'></font>
<font color=#447700>!      (e.g. put_dom_ti records and control records like<a name='1846'></font>
<font color=#447700>!      open_for_write_commit type records), only compute tasks for which <a name='1847'></font>
<font color=#447700>!      (compute_group_master == .TRUE) send the record. The other compute <a name='1848'></font>
<font color=#447700>!      tasks send noop records. This is done so that each server task <a name='1849'></font>
<font color=#447700>!      receives exactly one record plus noops from the other compute tasks. <a name='1850'></font>
<font color=#447700>! <a name='1851'></font>
<font color=#447700>!   5. Logic below does not allow any noop records through since each IO <a name='1852'></font>
<font color=#447700>!      server task now receives a valid record (from the 'compute-group master'<a name='1853'></font>
<font color=#447700>!      when doing replicated output<a name='1854'></font>
              IF (hdr_tag.NE.int_noop) THEN<a name='1855'>
                write(VarName,'(I5.5)')vid <a name='1856'>
<font color=#447700>!write(0,*) 'X-2', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1857'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#ADD_TO_BUFSIZE_FOR_FIELD'>add_to_bufsize_for_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADD_TO_BUFSIZE_FOR_FIELD_20">( VarName, hdrbufsize )<a name='1858'>
                vid = vid+1<a name='1859'>
              ENDIF<a name='1860'>
              IF ( hdr_tag .EQ. int_noop ) num_noops = num_noops + 1<a name='1861'>
              icurs = icurs + hdrbufsize<a name='1862'>
<a name='1863'>
          END SELECT<a name='1864'>
        ENDDO <font color=#447700>! }<a name='1865'></font>
<font color=#447700>! Store the headers and field data in internal buffers.  The first call to <a name='1866'></font>
<font color=#447700>! store_piece_of_field() allocates internal buffers using sizes computed by <a name='1867'></font>
<font color=#447700>! calls to add_to_bufsize_for_field().  <a name='1868'></font>
        vid = 0<a name='1869'>
        icurs = itypesize<a name='1870'>
        num_noops = 0 <a name='1871'>
        num_commit_messages = 0 <a name='1872'>
        num_field_training_msgs = 0 <a name='1873'>
        DO WHILE ( icurs .lt. obufsize ) <font color=#447700>!{<a name='1874'></font>
<font color=#447700>!write(0,*) 'A icurs ', icurs, ' obufsize ', obufsize<a name='1875'></font>
          hdr_tag = <A href='../../html_code/frame/module_internal_header_util.F.html#GET_HDR_TAG'>get_hdr_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_HDR_TAG_8">( obuf ( icurs / itypesize ) )<a name='1876'>
          SELECT CASE ( hdr_tag )<a name='1877'>
            CASE ( int_field )<a name='1878'>
              CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_12"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='1879'>
                                                DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='1880'>
                                                DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='1881'>
                                                DomainStart , DomainEnd ,                                    &amp;<a name='1882'>
                                                MemoryStart , MemoryEnd ,                                    &amp;<a name='1883'>
                                                PatchStart , PatchEnd )<a name='1884'>
              chunksize = (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='1885'>
                          (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='1886'>
<a name='1887'>
              IF ( DomainDesc .EQ. 333933 ) THEN  <font color=#447700>! Training write, only one per group of tasks<a name='1888'></font>
                 IF ( num_field_training_msgs .EQ. 0 ) THEN<a name='1889'>
                   call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_16">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='1890'>
<font color=#447700>!write(0,*) 'A-1', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1891'></font>
                 ENDIF<a name='1892'>
                 num_field_training_msgs = num_field_training_msgs + 1<a name='1893'>
              ELSE<a name='1894'>
                 call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_17">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='1895'>
<font color=#447700>!write(0,*) 'A-2a', icurs, hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1896'></font>
              ENDIF<a name='1897'>
              icurs = icurs + hdrbufsize<a name='1898'>
              <font color=#447700>! If this is a real write (i.e. not a training write), store<a name='1899'></font>
              <font color=#447700>! this piece of this field.<a name='1900'></font>
              IF ( DomainDesc .NE. 333933 ) THEN   <font color=#447700>! magic number<a name='1901'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_18">( obuf(icurs/itypesize), VarName, chunksize )<a name='1902'>
                icurs = icurs + chunksize<a name='1903'>
<font color=#447700>!write(0,*) 'A-1a',TRIM(VarName),' icurs ',icurs,PatchStart(1:3),PatchEnd(1:3)<a name='1904'></font>
              ENDIF<a name='1905'>
            CASE ( int_open_for_write_commit )  <font color=#447700>! only one per group of tasks<a name='1906'></font>
              hdrbufsize = obuf(icurs/itypesize)<a name='1907'>
              IF (num_commit_messages.EQ.0) THEN<a name='1908'>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_19">( obuf(icurs/itypesize), 'COMMIT', hdrbufsize )<a name='1909'>
              ENDIF<a name='1910'>
              num_commit_messages = num_commit_messages + 1<a name='1911'>
              icurs = icurs + hdrbufsize<a name='1912'>
            CASE DEFAULT<a name='1913'>
              hdrbufsize = obuf(icurs/itypesize)<a name='1914'>
              IF (hdr_tag.NE.int_noop) THEN<a name='1915'>
<a name='1916'>
                write(VarName,'(I5.5)')vid <a name='1917'>
<font color=#447700>!write(0,*) 'A-2b', hdrbufsize, get_hdr_tag( obuf ( icurs / itypesize ) ) , get_hdr_rec_size( obuf ( icurs / itypesize ) ), TRIM(VarName)<a name='1918'></font>
                call <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PIECE_OF_FIELD'>store_piece_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PIECE_OF_FIELD_20">( obuf(icurs/itypesize), VarName, hdrbufsize )<a name='1919'>
                vid = vid+1<a name='1920'>
              ENDIF<a name='1921'>
              IF ( hdr_tag .EQ. int_noop ) num_noops = num_noops + 1<a name='1922'>
              icurs = icurs + hdrbufsize<a name='1923'>
          END SELECT<a name='1924'>
       ENDDO <font color=#447700>!} while(icurs &lt; obufsize)<a name='1925'></font>
<a name='1926'>
<font color=#447700>! Now, for each field, retrieve headers and patches (data) from the internal <a name='1927'></font>
<font color=#447700>! buffers<a name='1928'></font>
       CALL init_retrieve_pieces_of_field<a name='1929'>
<font color=#447700>! Retrieve header and all patches for the first field from the internal <a name='1930'></font>
<font color=#447700>! buffers.  <a name='1931'></font>
       CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#RETRIEVE_PIECES_OF_FIELD'>retrieve_pieces_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_PIECES_OF_FIELD_7"> ( obuf , VarName, obufsize, sz, retval )<a name='1932'>
       written_record = .false.<a name='1933'>
<a name='1934'>
<font color=#447700>! Loop until there are no more fields to retrieve from the internal buffers.<a name='1935'></font>
       DO WHILE ( retval ) <font color=#447700>!{<a name='1936'></font>
<a name='1937'>
<font color=#447700>! This I/O server now handles the collected requests from the compute <a name='1938'></font>
<font color=#447700>! tasks it serves<a name='1939'></font>
<a name='1940'>
            icurs = itypesize  <font color=#447700>! icurs is a byte counter, but buffer is integer<a name='1941'></font>
<a name='1942'>
            stored_write_record = .false.<a name='1943'>
<a name='1944'>
<font color=#447700>! ALL I/O servers in this group loop over the collected requests they have<a name='1945'></font>
<font color=#447700>! received.<a name='1946'></font>
            DO WHILE ( icurs .lt. sz)<font color=#447700>! bigbufsize ) !{<a name='1947'></font>
<a name='1948'>
<font color=#447700>! The I/O server gets the request out of the next header and<a name='1949'></font>
<font color=#447700>! handles it by, in most cases, calling the appropriate external I/O package<a name='1950'></font>
<font color=#447700>! interface.<a name='1951'></font>
<font color=#447700>!write(0,*)__FILE__,__LINE__,'get_hdr_tag ',icurs,sz,get_hdr_tag( obuf(icurs/itypesize) )<a name='1952'></font>
              SELECT CASE ( get_hdr_tag( obuf(icurs/itypesize) ) )<a name='1953'>
<font color=#447700>! The I/O server handles the "noop" (do nothing) request.  This is <a name='1954'></font>
<font color=#447700>! actually quite easy.  "Noop" requests exist to help avoid race conditions.  <a name='1955'></font>
                CASE ( int_noop )<a name='1956'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_NOOP_HEADER'>int_get_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_NOOP_HEADER_4">( obuf(icurs/itypesize), &amp;<a name='1957'>
                                            hdrbufsize, itypesize )<a name='1958'>
                  icurs = icurs + hdrbufsize<a name='1959'>
<a name='1960'>
<font color=#447700>! The I/O server "root" handles the "put_dom_td_real" request.<a name='1961'></font>
                CASE ( int_dom_td_real )<a name='1962'>
                  CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='1963'>
                  ALLOCATE( RData( obuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='1964'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TD_HEADER'>int_get_td_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TD_HEADER_7">( obuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='1965'>
                                          DataHandle, DateStr, Element, RData, Count, code )<a name='1966'>
                  icurs = icurs + hdrbufsize<a name='1967'>
<a name='1968'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='1969'>
#ifdef PNETCDF_QUILT<a name='1970'>
                    CASE (IO_PNETCDF  )<a name='1971'>
                      CALL ext_pnc_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1972'>
#endif<a name='1973'>
#ifdef NETCDF<a name='1974'>
                    CASE ( IO_NETCDF   )<a name='1975'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TD_REAL'>ext_ncd_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TD_REAL_4">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1976'>
#endif<a name='1977'>
#ifdef INTIO<a name='1978'>
                    CASE ( IO_INTIO   )<a name='1979'>
                      CALL ext_int_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1980'>
#endif<a name='1981'>
#ifdef YYY<a name='1982'>
                 CASE ( IO_YYY )<a name='1983'>
                    CALL ext_yyy_put_dom_td_real( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1984'>
#endif<a name='1985'>
#ifdef GRIB1<a name='1986'>
                 CASE ( IO_GRIB1 )<a name='1987'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TD_REAL'>ext_gr1_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TD_REAL_4">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1988'>
#endif<a name='1989'>
#ifdef GRIB2<a name='1990'>
                 CASE ( IO_GRIB2 )<a name='1991'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TD_REAL'>ext_gr2_put_dom_td_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TD_REAL_4">( handle(DataHandle),TRIM(Element),TRIM(DateStr),RData, Count, Status )<a name='1992'>
#endif<a name='1993'>
                     CASE DEFAULT<a name='1994'>
                      Status = 0<a name='1995'>
                  END SELECT<a name='1996'>
<a name='1997'>
                  DEALLOCATE( RData )<a name='1998'>
<font color=#447700>! Every I/O server handles the "put_dom_ti_real" request.<a name='1999'></font>
                CASE ( int_dom_ti_real )<a name='2000'>
<a name='2001'>
                  CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='2002'>
                  ALLOCATE( RData( obuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='2003'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER'>int_get_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_7">( obuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='2004'>
                                          DataHandle, Element, RData, Count, code )<a name='2005'>
                  icurs = icurs + hdrbufsize<a name='2006'>
<a name='2007'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2008'>
#ifdef PNETCDF_QUILT<a name='2009'>
                    CASE (IO_PNETCDF  )<a name='2010'>
                      CALL ext_pnc_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2011'>
#endif<a name='2012'>
#ifdef NETCDF<a name='2013'>
                    CASE ( IO_NETCDF   )<a name='2014'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_REAL'>ext_ncd_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_REAL_4">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2015'>
#endif<a name='2016'>
#ifdef INTIO<a name='2017'>
                    CASE ( IO_INTIO   )<a name='2018'>
                      CALL ext_int_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2019'>
#endif<a name='2020'>
#ifdef YYY<a name='2021'>
                 CASE ( IO_YYY )<a name='2022'>
                    CALL ext_yyy_put_dom_ti_real( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2023'>
#endif<a name='2024'>
#ifdef GRIB1<a name='2025'>
                 CASE ( IO_GRIB1 )<a name='2026'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_REAL'>ext_gr1_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_REAL_4">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2027'>
#endif<a name='2028'>
#ifdef GRIB2<a name='2029'>
                 CASE ( IO_GRIB2 )<a name='2030'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_REAL'>ext_gr2_put_dom_ti_real</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_REAL_4">( handle(DataHandle),TRIM(Element), RData, Count, Status )<a name='2031'>
#endif<a name='2032'>
                    CASE DEFAULT<a name='2033'>
                      Status = 0<a name='2034'>
                  END SELECT<a name='2035'>
<a name='2036'>
                  DEALLOCATE( RData )<a name='2037'>
<a name='2038'>
<font color=#447700>! Every I/O server handles the "put_dom_td_integer" request.<a name='2039'></font>
                CASE ( int_dom_td_integer )<a name='2040'>
<a name='2041'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='2042'>
                  ALLOCATE( IData( obuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='2043'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TD_HEADER'>int_get_td_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TD_HEADER_8">( obuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='2044'>
                                          DataHandle, DateStr, Element, IData, Count, code )<a name='2045'>
                  icurs = icurs + hdrbufsize<a name='2046'>
<a name='2047'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2048'>
#ifdef PNETCDF_QUILT<a name='2049'>
                  CASE (IO_PNETCDF  )<a name='2050'>
                      CALL ext_pnc_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2051'>
#endif<a name='2052'>
#ifdef NETCDF<a name='2053'>
                   CASE ( IO_NETCDF   )<a name='2054'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TD_INTEGER'>ext_ncd_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TD_INTEGER_4">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2055'>
#endif<a name='2056'>
#ifdef INTIO<a name='2057'>
                   CASE ( IO_INTIO   )<a name='2058'>
                      CALL ext_int_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2059'>
#endif<a name='2060'>
#ifdef YYY<a name='2061'>
                   CASE ( IO_YYY )<a name='2062'>
                      CALL ext_yyy_put_dom_td_integer( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2063'>
#endif<a name='2064'>
#ifdef GRIB1<a name='2065'>
                   CASE ( IO_GRIB1 )<a name='2066'>
                      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TD_INTEGER'>ext_gr1_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TD_INTEGER_4">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2067'>
#endif<a name='2068'>
#ifdef GRIB2<a name='2069'>
                   CASE ( IO_GRIB2 )<a name='2070'>
                      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TD_INTEGER'>ext_gr2_put_dom_td_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TD_INTEGER_4">( handle(DataHandle),TRIM(Element), Trim(DateStr), IData, Count, Status )<a name='2071'>
#endif<a name='2072'>
                   CASE DEFAULT<a name='2073'>
                      Status = 0<a name='2074'>
                   END SELECT<a name='2075'>
<a name='2076'>
                   DEALLOCATE( IData )<a name='2077'>
<a name='2078'>
<font color=#447700>! Every I/O server handles the "put_dom_ti_integer" request.<a name='2079'></font>
                CASE ( int_dom_ti_integer )<a name='2080'>
<a name='2081'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='2082'>
                  ALLOCATE( IData( obuf(icurs/itypesize + 4 ) ) )      <font color=#447700>! 5 is the count of data items for this record ; defined in collect_on_comm.c<a name='2083'></font>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER'>int_get_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_8">( obuf(icurs/itypesize:), hdrbufsize, itypesize, ftypesize, &amp;<a name='2084'>
                                          DataHandle, Element, IData, Count, code )<a name='2085'>
                  icurs = icurs + hdrbufsize<a name='2086'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2087'>
#ifdef PNETCDF_QUILT<a name='2088'>
                    CASE (IO_PNETCDF  )<a name='2089'>
                      CALL ext_pnc_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2090'>
#endif<a name='2091'>
#ifdef NETCDF<a name='2092'>
                    CASE ( IO_NETCDF   )<a name='2093'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_INTEGER'>ext_ncd_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_INTEGER_4">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2094'>
#endif<a name='2095'>
#ifdef INTIO<a name='2096'>
                    CASE ( IO_INTIO   )<a name='2097'>
                      CALL ext_int_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2098'>
#endif<a name='2099'>
#ifdef YYY<a name='2100'>
                 CASE ( IO_YYY )<a name='2101'>
                    CALL ext_yyy_put_dom_ti_integer( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2102'>
#endif<a name='2103'>
#ifdef GRIB1<a name='2104'>
                 CASE ( IO_GRIB1 )<a name='2105'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_INTEGER'>ext_gr1_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_INTEGER_4">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2106'>
#endif<a name='2107'>
#ifdef GRIB2<a name='2108'>
                 CASE ( IO_GRIB2 )<a name='2109'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_INTEGER'>ext_gr2_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_INTEGER_4">( handle(DataHandle),TRIM(Element), IData, Count, Status )<a name='2110'>
#endif<a name='2111'>
<a name='2112'>
                    CASE DEFAULT<a name='2113'>
                      Status = 0<a name='2114'>
                  END SELECT<a name='2115'>
<a name='2116'>
                  DEALLOCATE( IData)<a name='2117'>
 <a name='2118'>
<font color=#447700>! Every I/O server  handles the "set_time" request.<a name='2119'></font>
                CASE ( int_set_time )<a name='2120'>
<a name='2121'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_11">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2122'>
                                               DataHandle, Element, VarName, CData, code )<a name='2123'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2124'>
#ifdef INTIO<a name='2125'>
                    CASE ( IO_INTIO   )<a name='2126'>
                      CALL ext_int_set_time ( handle(DataHandle), TRIM(CData), Status)<a name='2127'>
#endif<a name='2128'>
                    CASE DEFAULT<a name='2129'>
                      Status = 0<a name='2130'>
                  END SELECT<a name='2131'>
<a name='2132'>
                  icurs = icurs + hdrbufsize<a name='2133'>
<a name='2134'>
<font color=#447700>! Every I/O server handles the "put_dom_ti_char" request.<a name='2135'></font>
                CASE ( int_dom_ti_char )<a name='2136'>
<a name='2137'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_12">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2138'>
                                               DataHandle, Element, VarName, CData, code )<a name='2139'>
<a name='2140'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2141'>
#ifdef PNETCDF_QUILT<a name='2142'>
                    CASE (IO_PNETCDF  )<a name='2143'>
                      CALL ext_pnc_put_dom_ti_char ( handle(DataHandle), TRIM(Element), Trim(CData), Status)<a name='2144'>
#endif<a name='2145'>
#ifdef NETCDF<a name='2146'>
                    CASE ( IO_NETCDF   )<a name='2147'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_DOM_TI_CHAR'>ext_ncd_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_DOM_TI_CHAR_4"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2148'>
#endif<a name='2149'>
#ifdef INTIO<a name='2150'>
                    CASE ( IO_INTIO   )<a name='2151'>
                      CALL ext_int_put_dom_ti_char ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2152'>
#endif<a name='2153'>
#ifdef YYY<a name='2154'>
                   CASE ( IO_YYY )<a name='2155'>
                      CALL ext_yyy_put_dom_ti_char ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2156'>
#endif<a name='2157'>
#ifdef GRIB1<a name='2158'>
                   CASE ( IO_GRIB1 )<a name='2159'>
                      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_DOM_TI_CHAR'>ext_gr1_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_DOM_TI_CHAR_4"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2160'>
#endif<a name='2161'>
#ifdef GRIB2<a name='2162'>
                   CASE ( IO_GRIB2 )<a name='2163'>
                      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_DOM_TI_CHAR'>ext_gr2_put_dom_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_DOM_TI_CHAR_4"> ( handle(DataHandle), TRIM(Element), TRIM(CData), Status)<a name='2164'>
#endif<a name='2165'>
                   CASE DEFAULT<a name='2166'>
                      Status = 0<a name='2167'>
                   END SELECT<a name='2168'>
<a name='2169'>
                  icurs = icurs + hdrbufsize<a name='2170'>
<a name='2171'>
<font color=#447700>! Every I/O server handles the "put_var_ti_char" request.<a name='2172'></font>
                CASE ( int_var_ti_char )<a name='2173'>
<a name='2174'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_TI_HEADER_CHAR'>int_get_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_TI_HEADER_CHAR_13">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2175'>
                                               DataHandle, Element, VarName, CData, code )<a name='2176'>
<a name='2177'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2178'>
#ifdef PNETCDF_QUILT<a name='2179'>
                    CASE (IO_PNETCDF  )<a name='2180'>
                      CALL ext_pnc_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status )<a name='2181'>
#endif<a name='2182'>
#ifdef NETCDF<a name='2183'>
                    CASE ( IO_NETCDF   )<a name='2184'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_PUT_VAR_TI_CHAR'>ext_ncd_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_PUT_VAR_TI_CHAR_4"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2185'>
#endif<a name='2186'>
#ifdef INTIO<a name='2187'>
                    CASE ( IO_INTIO   )<a name='2188'>
                      CALL ext_int_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2189'>
#endif<a name='2190'>
#ifdef YYY<a name='2191'>
                   CASE ( IO_YYY )<a name='2192'>
                      CALL ext_yyy_put_var_ti_char ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2193'>
#endif<a name='2194'>
#ifdef GRIB1<a name='2195'>
                   CASE ( IO_GRIB1 )<a name='2196'>
                      CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_PUT_VAR_TI_CHAR'>ext_gr1_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_PUT_VAR_TI_CHAR_4"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2197'>
#endif<a name='2198'>
#ifdef GRIB2<a name='2199'>
                   CASE ( IO_GRIB2 )<a name='2200'>
                      CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_PUT_VAR_TI_CHAR'>ext_gr2_put_var_ti_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_PUT_VAR_TI_CHAR_4"> ( handle(DataHandle), TRIM(Element), TRIM(VarName), TRIM(CData), Status)<a name='2201'>
#endif<a name='2202'>
                   CASE DEFAULT<a name='2203'>
                      Status = 0<a name='2204'>
                   END SELECT<a name='2205'>
<a name='2206'>
                  icurs = icurs + hdrbufsize<a name='2207'>
<a name='2208'>
                CASE ( int_ioexit )<a name='2209'>
<font color=#447700>! ioexit is now handled by sending negative message length to server<a name='2210'></font>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_326">( &amp;<a name='2211'>
                         "quilt: should have handled int_ioexit already")<a name='2212'>
<font color=#447700>! Every I/O server handles the "ioclose" request.<a name='2213'></font>
                CASE ( int_ioclose )<a name='2214'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_10">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2215'>
                                              DataHandle , code )<a name='2216'>
                  icurs = icurs + hdrbufsize<a name='2217'>
<a name='2218'>
                  IF ( DataHandle .GE. 1 ) THEN<a name='2219'>
<a name='2220'>
                     SELECT CASE (use_package(io_form(DataHandle)))<a name='2221'>
#ifdef PNETCDF_QUILT<a name='2222'>
                    CASE ( IO_PNETCDF   )<a name='2223'>
                      CALL ext_pnc_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2224'>
                      IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2225'>
                        CALL ext_pnc_ioclose(handle(DataHandle),Status)<a name='2226'>
                      ENDIF<a name='2227'>
#endif<a name='2228'>
#ifdef NETCDF<a name='2229'>
                     CASE ( IO_NETCDF   )<a name='2230'>
                        CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_INQUIRE_FILENAME'>ext_ncd_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_INQUIRE_FILENAME_8">( handle(DataHandle), fname, fstat, Status )<a name='2231'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2232'>
                           CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_IOCLOSE'>ext_ncd_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_IOCLOSE_6">(handle(DataHandle),Status)<a name='2233'>
                        ENDIF<a name='2234'>
#endif<a name='2235'>
#ifdef INTIO<a name='2236'>
                     CASE ( IO_INTIO   )<a name='2237'>
                        CALL ext_int_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2238'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2239'>
                           CALL ext_int_ioclose(handle(DataHandle),Status)<a name='2240'>
                        ENDIF<a name='2241'>
#endif<a name='2242'>
#ifdef YYY<a name='2243'>
                     CASE ( IO_YYY )<a name='2244'>
                        CALL ext_yyy_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2245'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2246'>
                           CALL ext_yyy_ioclose(handle(DataHandle),Status)<a name='2247'>
                        ENDIF<a name='2248'>
#endif<a name='2249'>
#ifdef GRIB1<a name='2250'>
                     CASE ( IO_GRIB1 )<a name='2251'>
                        CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_INQUIRE_FILENAME'>ext_gr1_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_INQUIRE_FILENAME_8">( handle(DataHandle), fname, fstat, Status )<a name='2252'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2253'>
                           CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_IOCLOSE'>ext_gr1_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_IOCLOSE_5">(handle(DataHandle),Status)<a name='2254'>
                        ENDIF<a name='2255'>
#endif<a name='2256'>
#ifdef GRIB2<a name='2257'>
                     CASE ( IO_GRIB2 )<a name='2258'>
                        CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_INQUIRE_FILENAME'>ext_gr2_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_INQUIRE_FILENAME_8">( handle(DataHandle), fname, fstat, Status )<a name='2259'>
                        IF ( fstat .EQ. WRF_FILE_OPENED_FOR_WRITE .OR. fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2260'>
                           CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_IOCLOSE'>ext_gr2_ioclose</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_IOCLOSE_5">(handle(DataHandle),Status)<a name='2261'>
                        ENDIF<a name='2262'>
#endif<a name='2263'>
                     CASE DEFAULT<a name='2264'>
                        Status = 0<a name='2265'>
                     END SELECT<a name='2266'>
                  ENDIF<a name='2267'>
<a name='2268'>
<font color=#447700>! Every I/O server handles the "open_for_write_begin" request.<a name='2269'></font>
                CASE ( int_open_for_write_begin )<a name='2270'>
<a name='2271'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_OFWB_HEADER'>int_get_ofwb_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_OFWB_HEADER_4">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2272'>
                                            FileName,SysDepInfo,io_form_arg,DataHandle )<a name='2273'>
<a name='2274'>
<font color=#447700>!write(0,*)' int_open_for_write_begin itypesize ',itypesize,' itypesize ',itypesize<a name='2275'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin icurs ', icurs, hdrbufsize<a name='2276'></font>
<font color=#447700>!JMDEBUGwrite(0,*)' int_open_for_write_begin FileName ',TRIM(FileName) , ' DataHandle ', DataHandle<a name='2277'></font>
<font color=#447700>!write(0,*)' int_open_for_write_begin SysDepInfo ',TRIM(SysDepInfo) <a name='2278'></font>
                  icurs = icurs + hdrbufsize<a name='2279'>
<font color=#447700>!write(0,*)' int_open_for_write_begin new icurs,tag,size ', icurs, get_hdr_tag( bigbuf(icurs/itypesize) ),get_hdr_rec_size( bigbuf(icurs/itypesize) )<a name='2280'></font>
                <a name='2281'>
                  io_form(DataHandle) = io_form_arg<a name='2282'>
<a name='2283'>
                  SELECT CASE (use_package(io_form(DataHandle)))<a name='2284'>
#ifdef PNETCDF_QUILT<a name='2285'>
                    CASE (IO_PNETCDF  )<a name='2286'>
                      CALL ext_pnc_open_for_write_begin(FileName,mpi_comm_local,mpi_comm_local,SysDepInfo,handle(DataHandle),Status )<a name='2287'>
#endif<a name='2288'>
#ifdef NETCDF<a name='2289'>
                    CASE ( IO_NETCDF   )<a name='2290'>
                      CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_OPEN_FOR_WRITE_BEGIN'>ext_ncd_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_OPEN_FOR_WRITE_BEGIN_6">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2291'>
<font color=#447700>!write(0,*)'ext_ncd_open_for_write_begin ',Trim(FileName),DataHandle,handle(DataHandle),Status<a name='2292'></font>
#endif<a name='2293'>
#ifdef INTIO<a name='2294'>
                    CASE ( IO_INTIO   )<a name='2295'>
                      CALL ext_int_open_for_write_begin(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2296'>
#endif<a name='2297'>
#ifdef YYY<a name='2298'>
                    CASE ( IO_YYY )<a name='2299'>
                       CALL ext_yyy_open_for_write_begin(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2300'>
#endif<a name='2301'>
#ifdef GRIB1<a name='2302'>
                    CASE ( IO_GRIB1 )<a name='2303'>
                       CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_OPEN_FOR_WRITE_BEGIN'>ext_gr1_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_OPEN_FOR_WRITE_BEGIN_5">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2304'>
#endif<a name='2305'>
#ifdef GRIB2<a name='2306'>
                    CASE ( IO_GRIB2 )<a name='2307'>
                       CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_OPEN_FOR_WRITE_BEGIN'>ext_gr2_open_for_write_begin</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_OPEN_FOR_WRITE_BEGIN_5">(FileName,Comm,IOComm,SysDepInfo,handle(DataHandle),Status)<a name='2308'>
#endif<a name='2309'>
                    CASE DEFAULT<a name='2310'>
                      Status = 0<a name='2311'>
                  END SELECT<a name='2312'>
                <a name='2313'>
                  okay_to_write(DataHandle) = .false.<a name='2314'>
<a name='2315'>
<font color=#447700>! Every I/O server handles the "open_for_write_commit" request.<a name='2316'></font>
<font color=#447700>! In this case, the "okay_to_commit" is simply set to .true. so "write_field"<a name='2317'></font>
<font color=#447700>! (int_field) requests will initiate writes to disk.  Actual commit will be done after<a name='2318'></font>
<font color=#447700>! all requests in this batch have been handled.<a name='2319'></font>
                CASE ( int_open_for_write_commit )<a name='2320'>
<a name='2321'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_11">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2322'>
                                              DataHandle , code )<a name='2323'>
                  icurs = icurs + hdrbufsize<a name='2324'>
                  okay_to_commit(DataHandle) = .true.<a name='2325'>
<a name='2326'>
<font color=#447700>! Every I/O server handles the "write_field" (int_field) request.<a name='2327'></font>
<font color=#447700>! If okay_to_write(DataHandle) is .true. then the patch in the<a name='2328'></font>
<font color=#447700>! header (bigbuf) is written to disk using pNetCDF.  Note that this is where the actual<a name='2329'></font>
<font color=#447700>! "quilting" (reassembly of patches onto a full-size domain) is done.  If<a name='2330'></font>
<font color=#447700>! okay_to_write(DataHandle) is .false. then external I/O package interfaces<a name='2331'></font>
<font color=#447700>! are called to write metadata for I/O formats that support native metadata.<a name='2332'></font>
<font color=#447700>!<a name='2333'></font>
<font color=#447700>! NOTE that the I/O servers will only see write_field (int_field)<a name='2334'></font>
<font color=#447700>! requests AFTER an "iosync" request.<a name='2335'></font>
                CASE ( int_field )<a name='2336'>
                  CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='2337'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_WRITE_FIELD_HEADER'>int_get_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_WRITE_FIELD_HEADER_13"> ( obuf(icurs/itypesize), hdrbufsize, itypesize, ftypesize,  &amp;<a name='2338'>
                                                    DataHandle , DateStr , VarName , Dummy , FieldType , Comm , IOComm, &amp;<a name='2339'>
                                                    DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='2340'>
                                                    DomainStart , DomainEnd ,                                    &amp;<a name='2341'>
                                                    MemoryStart , MemoryEnd ,                                    &amp;<a name='2342'>
                                                    PatchStart , PatchEnd )<a name='2343'>
<font color=#447700>!write(0,*)' int_field ',TRIM(VarName),DataHandle,okay_to_write(DataHandle)<a name='2344'></font>
                  icurs = icurs + hdrbufsize<a name='2345'>
<a name='2346'>
                  IF ( okay_to_write(DataHandle) ) THEN<a name='2347'>
<a name='2348'>
<font color=#447700>!!$                    WRITE(0,FMT="('&gt;&gt;&gt; ',(A),1x,(A),1x,A2,I6,1x,3('[',I3,',',I3,'] '))") &amp;<a name='2349'></font>
<font color=#447700>!!$                          TRIM(DateStr), TRIM(VarName), TRIM(MemoryOrder), &amp;<a name='2350'></font>
<font color=#447700>!!$                        (PatchEnd(1)-PatchStart(1)+1)*(PatchEnd(2)-PatchStart(2)+1)*(PatchEnd(3)-PatchStart(3)+1), &amp;<a name='2351'></font>
<font color=#447700>!!$PatchStart(1),PatchEnd(1),PatchStart(2),PatchEnd(2),PatchStart(3),PatchEnd(3)<a name='2352'></font>
<font color=#447700>!!$                    WRITE(0,FMT="('&gt;&gt;&gt; ',(A),1x,(A),1x,I6,1x,3('[',I3,',',I3,'] '))") &amp;<a name='2353'></font>
<font color=#447700>!!$                          TRIM(DateStr), TRIM(VarName),  DomainDesc, &amp;<a name='2354'></font>
<font color=#447700>!!$                          DomainStart(1),DomainEnd(1),DomainStart(2),DomainEnd(2),DomainStart(3),DomainEnd(3)<a name='2355'></font>
<a name='2356'>
                    IF ( FieldType .EQ. WRF_FLOAT .OR. FieldType .EQ. WRF_DOUBLE)  THEN<a name='2357'>
                      <font color=#447700>! Note that the WRF_DOUBLE branch of this IF statement must come first since <a name='2358'></font>
                      <font color=#447700>! WRF_FLOAT is set equal to WRF_DOUBLE during autopromotion builds.  <a name='2359'></font>
                      IF ( FieldType .EQ. WRF_DOUBLE)  THEN<a name='2360'>
<font color=#447700>! this branch has not been tested TBH: 20050406<a name='2361'></font>
                        CALL mpi_type_size( MPI_DOUBLE_PRECISION, ftypesize, ierr )<a name='2362'>
                      ELSE<a name='2363'>
                        CALL mpi_type_size( MPI_REAL, ftypesize, ierr )<a name='2364'>
                      ENDIF<a name='2365'>
<a name='2366'>
#ifdef PNETCDF_QUILT<a name='2367'>
<font color=#447700>!                      WRITE(mess,FMT="('&gt;&gt;&gt; ',(A),1x,(A),1x,I6,1x,3('[',I3,',',I3,'] '))") &amp;<a name='2368'></font>
<font color=#447700>!                          TRIM(DateStr), TRIM(VarName),  DomainDesc, &amp;<a name='2369'></font>
<font color=#447700>!                          DomainStart(1),DomainEnd(1), &amp;<a name='2370'></font>
<font color=#447700>!                          DomainStart(2),DomainEnd(2),DomainStart(3),DomainEnd(3)<a name='2371'></font>
<font color=#447700>!                      CALL wrf_message(mess)<a name='2372'></font>
<a name='2373'>
                      CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PATCH_IN_OUTBUF_PNC'>store_patch_in_outbuf_pnc</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PATCH_IN_OUTBUF_PNC_3">(obuf(icurs/itypesize), &amp;<a name='2374'>
                                                     dummybuf, TRIM(DateStr), &amp;<a name='2375'>
                                                     TRIM(VarName) , &amp;<a name='2376'>
                                                     FieldType,      &amp;<a name='2377'>
                                                     TRIM(MemoryOrder), &amp;<a name='2378'>
                                                     TRIM(Stagger), &amp;<a name='2379'>
                                                     DimNames, &amp;<a name='2380'>
                                                     DomainStart , DomainEnd ,&amp;<a name='2381'>
                                                     MemoryStart , MemoryEnd ,&amp;<a name='2382'>
                                                     PatchStart , PatchEnd, &amp;<a name='2383'>
                                                     ntasks_io_group-1 )<a name='2384'>
                      stored_write_record = .true.<a name='2385'>
<a name='2386'>
<font color=#447700>!!$                      IF(VarName .eq. "PSFC")THEN<a name='2387'></font>
<font color=#447700>!!$                         CALL dump_real_array_c(obuf(icurs/itypesize), DomainStart,&amp;<a name='2388'></font>
<font color=#447700>!!$                                                DomainEnd, PatchStart, PatchEnd,   &amp;<a name='2389'></font>
<font color=#447700>!!$                                                mytask_local, DomainDesc)<a name='2390'></font>
<font color=#447700>!!$                      ENDIF<a name='2391'></font>
<a name='2392'>
#endif<a name='2393'>
                    ELSE IF ( FieldType .EQ. WRF_INTEGER ) THEN<a name='2394'>
                      CALL mpi_type_size( MPI_INTEGER, ftypesize, ierr )<a name='2395'>
#ifdef PNETCDF_QUILT<a name='2396'>
                      CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#STORE_PATCH_IN_OUTBUF_PNC'>store_patch_in_outbuf_pnc</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STORE_PATCH_IN_OUTBUF_PNC_4"> ( dummybuf,             &amp; <a name='2397'>
                                                   obuf(icurs/itypesize) ,   &amp;<a name='2398'>
                                                   TRIM(DateStr) ,           &amp;<a name='2399'>
                                                   TRIM(VarName) ,           &amp;<a name='2400'>
                                                   FieldType,                &amp;<a name='2401'>
                                                   TRIM(MemoryOrder) ,       &amp;<a name='2402'>
                                                   TRIM(Stagger), DimNames,  &amp;<a name='2403'>
                                                   DomainStart , DomainEnd , &amp;<a name='2404'>
                                                   MemoryStart , MemoryEnd , &amp;<a name='2405'>
                                                   PatchStart , PatchEnd   , &amp;<a name='2406'>
                                                   ntasks_io_group-1 )<a name='2407'>
                      stored_write_record = .true.<a name='2408'>
#endif<a name='2409'>
                    ELSE IF ( FieldType .EQ. WRF_LOGICAL ) THEN<a name='2410'>
                      ftypesize = LWORDSIZE<a name='2411'>
                    ENDIF<a name='2412'>
<a name='2413'>
                    icurs = icurs + (PatchEnd(1)-PatchStart(1)+1)* &amp;<a name='2414'>
                                    (PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='2415'>
                                    (PatchEnd(3)-PatchStart(3)+1)*ftypesize<a name='2416'>
<a name='2417'>
                  ELSE <font color=#447700>! Write metadata only (or do 'training'?)<a name='2418'></font>
<a name='2419'>
                    SELECT CASE (use_package(io_form(DataHandle)))<a name='2420'>
<a name='2421'>
#ifdef PNETCDF_QUILT<a name='2422'>
                      CASE ( IO_PNETCDF )<a name='2423'>
                        CALL ext_pnc_write_field ( handle(DataHandle) , TRIM(DateStr),        &amp;<a name='2424'>
                                   TRIM(VarName) , dummy , FieldType , mpi_comm_local , mpi_comm_local,         &amp;<a name='2425'>
                                   DomainDesc , TRIM(MemoryOrder) , TRIM(Stagger), DimNames , &amp;<a name='2426'>
                                   DomainStart , DomainEnd ,                                  &amp;<a name='2427'>
                                   MemoryStart , MemoryEnd ,                                  &amp;<a name='2428'>
                                   PatchStart ,  PatchEnd,                                  &amp;<a name='2429'>
                                   Status )<a name='2430'>
#endif<a name='2431'>
#ifdef NETCDF<a name='2432'>
                      CASE ( IO_NETCDF   )<a name='2433'>
                        CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_WRITE_FIELD'>ext_ncd_write_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_WRITE_FIELD_4"> ( handle(DataHandle) , TRIM(DateStr) ,         &amp;<a name='2434'>
                                   TRIM(VarName) , dummy , FieldType , Comm , IOComm,           &amp;<a name='2435'>
                                   DomainDesc , TRIM(MemoryOrder) , TRIM(Stagger) , DimNames ,  &amp;<a name='2436'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='2437'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='2438'>
                                   DomainStart , DomainEnd ,                                    &amp;<a name='2439'>
                                   Status )<a name='2440'>
#endif<a name='2441'>
#if 0<a name='2442'>
<font color=#447700>! since this is training and the grib output doesn't need training, disable this branch.<a name='2443'></font>
#ifdef YYY<a name='2444'>
                 CASE ( IO_YYY )<a name='2445'>
                      CALL ext_YYY_write_field ( handle(DataHandle) , TRIM(DateStr) ,         &amp;<a name='2446'>
                                 TRIM(VarName) , dummy , FieldType , Comm , IOComm,           &amp;<a name='2447'>
                                 DomainDesc , TRIM(MemoryOrder) , TRIM(Stagger) , DimNames ,  &amp;<a name='2448'>
                                 DomainStart , DomainEnd ,                                    &amp;<a name='2449'>
                                 DomainStart , DomainEnd ,                                    &amp;<a name='2450'>
                                 DomainStart , DomainEnd ,                                    &amp;<a name='2451'>
                                 Status )<a name='2452'>
#endif<a name='2453'>
#endif<a name='2454'>
                      CASE DEFAULT<a name='2455'>
                        Status = 0<a name='2456'>
                    END SELECT<a name='2457'>
                  ENDIF<a name='2458'>
                CASE ( int_iosync )<a name='2459'>
                  CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GET_HANDLE_HEADER'>int_get_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_HANDLE_HEADER_12">( obuf(icurs/itypesize), hdrbufsize, itypesize, &amp;<a name='2460'>
                                            DataHandle , code )<a name='2461'>
                  icurs = icurs + hdrbufsize<a name='2462'>
                CASE DEFAULT<a name='2463'>
                  WRITE(mess,*)'quilt: bad tag: ',                            &amp;<a name='2464'>
                               get_hdr_tag( obuf(icurs/itypesize) ),' icurs ',&amp;<a name='2465'>
                               icurs/itypesize<a name='2466'>
                  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_327">( mess )<a name='2467'>
              END SELECT<a name='2468'>
<a name='2469'>
            ENDDO <font color=#447700>!}<a name='2470'></font>
<font color=#447700>! Now, we have finshed handling all commands from the latest<a name='2471'></font>
<font color=#447700>! call to retrieve_pieces_of_field().<a name='2472'></font>
<a name='2473'>
            IF (stored_write_record) THEN<a name='2474'>
<font color=#447700>! If any field patches have been stored in internal output buffers<a name='2475'></font>
<font color=#447700>! (via a call to store_patch_in_outbuf_pnc()) then call write_outbuf_pnc() <a name='2476'></font>
<font color=#447700>! to write them to disk now.<a name='2477'></font>
<font color=#447700>! NOTE that the I/O server will only have called<a name='2478'></font>
<font color=#447700>! store_patch_in_outbuf() when handling write_field (int_field)<a name='2479'></font>
<font color=#447700>! commands which only arrive AFTER an "iosync" command.<a name='2480'></font>
<font color=#447700>!              CALL start_timing<a name='2481'></font>
#ifdef PNETCDF_QUILT<a name='2482'>
              CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#WRITE_OUTBUF_PNC'>write_outbuf_pnc</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRITE_OUTBUF_PNC_2">( handle(DataHandle), &amp;<a name='2483'>
                                     use_package(io_form(DataHandle)), &amp;<a name='2484'>
                                     mpi_comm_local, mytask_local,     &amp;<a name='2485'>
                                     ntasks_local_group) <a name='2486'>
#endif<a name='2487'>
<font color=#447700>!              CALL end_timing( "quilt_pnc: call to write_outbuf_pnc" ) <a name='2488'></font>
              stored_write_record = .false.<a name='2489'>
              written_record = .true.<a name='2490'>
            ENDIF<a name='2491'>
<a name='2492'>
<font color=#447700>! If one or more "open_for_write_commit" commands were encountered from the<a name='2493'></font>
<font color=#447700>! latest call to retrieve_pieces_of_field() then call the package-specific<a name='2494'></font>
<font color=#447700>! routine to do the commit.<a name='2495'></font>
            IF (okay_to_commit(DataHandle)) THEN<a name='2496'>
<a name='2497'>
              SELECT CASE (use_package(io_form(DataHandle)))<a name='2498'>
#ifdef PNETCDF_QUILT<a name='2499'>
                CASE ( IO_PNETCDF   )<a name='2500'>
                  CALL ext_pnc_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2501'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2502'>
                    CALL ext_pnc_open_for_write_commit(handle(DataHandle),Status)<a name='2503'>
                    okay_to_write(DataHandle) = .true.<a name='2504'>
                  ENDIF<a name='2505'>
#endif<a name='2506'>
#ifdef NETCDF<a name='2507'>
                CASE ( IO_NETCDF   )<a name='2508'>
                  CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_INQUIRE_FILENAME'>ext_ncd_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_INQUIRE_FILENAME_9">( handle(DataHandle), fname, fstat, Status )<a name='2509'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2510'>
                    CALL <A href='../../html_code/io_netcdf/wrf_io.F90.html#EXT_NCD_OPEN_FOR_WRITE_COMMIT'>ext_ncd_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_NCD_OPEN_FOR_WRITE_COMMIT_5">(handle(DataHandle),Status)<a name='2511'>
                    okay_to_write(DataHandle) = .true.<a name='2512'>
                  ENDIF<a name='2513'>
#endif<a name='2514'>
#ifdef INTIO<a name='2515'>
                CASE ( IO_INTIO   )<a name='2516'>
                  CALL ext_int_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2517'>
                  IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2518'>
                    CALL ext_int_open_for_write_commit(handle(DataHandle),Status)<a name='2519'>
                    okay_to_write(DataHandle) = .true.<a name='2520'>
                  ENDIF<a name='2521'>
#endif<a name='2522'>
#ifdef YYY<a name='2523'>
                 CASE ( IO_YYY )<a name='2524'>
                    CALL ext_yyy_inquire_filename( handle(DataHandle), fname, fstat, Status )<a name='2525'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2526'>
                       CALL ext_yyy_open_for_write_commit(handle(DataHandle),Status)<a name='2527'>
                       okay_to_write(DataHandle) = .true.<a name='2528'>
                    ENDIF<a name='2529'>
#endif<a name='2530'>
#ifdef GRIB1<a name='2531'>
                 CASE ( IO_GRIB1 )<a name='2532'>
                    CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_INQUIRE_FILENAME'>ext_gr1_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_INQUIRE_FILENAME_9">( handle(DataHandle), fname, fstat, Status )<a name='2533'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2534'>
                       CALL <A href='../../html_code/io_grib1/io_grib1.F.html#EXT_GR1_OPEN_FOR_WRITE_COMMIT'>ext_gr1_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR1_OPEN_FOR_WRITE_COMMIT_5">(handle(DataHandle),Status)<a name='2535'>
                       okay_to_write(DataHandle) = .true.<a name='2536'>
                    ENDIF<a name='2537'>
#endif<a name='2538'>
#ifdef GRIB2<a name='2539'>
                 CASE ( IO_GRIB2 )<a name='2540'>
                    CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_INQUIRE_FILENAME'>ext_gr2_inquire_filename</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_INQUIRE_FILENAME_9">( handle(DataHandle), fname, fstat, Status )<a name='2541'>
                    IF ( fstat .EQ. WRF_FILE_OPENED_NOT_COMMITTED ) THEN<a name='2542'>
                       CALL <A href='../../html_code/io_grib2/io_grib2.F.html#EXT_GR2_OPEN_FOR_WRITE_COMMIT'>ext_gr2_open_for_write_commit</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EXT_GR2_OPEN_FOR_WRITE_COMMIT_5">(handle(DataHandle),Status)<a name='2543'>
                       okay_to_write(DataHandle) = .true.<a name='2544'>
                    ENDIF<a name='2545'>
#endif<a name='2546'>
<a name='2547'>
                CASE DEFAULT<a name='2548'>
                  Status = 0<a name='2549'>
              END SELECT<a name='2550'>
<a name='2551'>
            okay_to_commit(DataHandle) = .false.<a name='2552'>
          ENDIF<a name='2553'>
<font color=#447700>!!endif<a name='2554'></font>
<a name='2555'>
<font color=#447700>! Retrieve header and all patches for the next field from the internal <a name='2556'></font>
<font color=#447700>! buffers.  <a name='2557'></font>
        CALL <A href='../../html_code/frame/module_quilt_outbuf_ops.F.html#RETRIEVE_PIECES_OF_FIELD'>retrieve_pieces_of_field</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT_PNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RETRIEVE_PIECES_OF_FIELD_8"> ( obuf , VarName, obufsize, sz, retval )<a name='2558'>
      END DO <font color=#447700>!}<a name='2559'></font>
<a name='2560'>
      DEALLOCATE( obuf )<a name='2561'>
<a name='2562'>
      <font color=#447700>! flush output files if needed<a name='2563'></font>
      IF (written_record) THEN<a name='2564'>
<font color=#447700>!CALL start_timing<a name='2565'></font>
        SELECT CASE ( use_package(io_form) )<a name='2566'>
#ifdef PNETCDF_QUILT<a name='2567'>
          CASE ( IO_PNETCDF   )<a name='2568'>
            CALL ext_pnc_iosync( handle(DataHandle), Status )<a name='2569'>
#endif<a name='2570'>
          CASE DEFAULT<a name='2571'>
            Status = 0<a name='2572'>
        END SELECT<a name='2573'>
        written_record = .false.<a name='2574'>
<font color=#447700>!CALL end_timing( "quilt_pnc: flush" )<a name='2575'></font>
      ENDIF<a name='2576'>
<a name='2577'>
      END DO <font color=#447700>! }<a name='2578'></font>
<a name='2579'>
    END SUBROUTINE quilt_pnc<a name='2580'>
<a name='2581'>
<font color=#447700>! end of #endif of DM_PARALLEL<a name='2582'></font>
#endif<a name='2583'>
<a name='2584'>
<A NAME='INIT_MODULE_WRF_QUILT'><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2585'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_wrf_quilt</font> <A href='../../call_to/INIT_MODULE_WRF_QUILT.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_MODULE_WRF_QUILT.html' TARGET='index'>35</A><a name='2586'>
      USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_23">, only: init_module_wrf_error<a name='2587'>
      USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_40"><a name='2588'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='2589'></font>
      USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_132">, only: mpi_comm_allcompute<a name='2590'>
#endif<a name='2591'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2592'></font>
<font color=#447700>! Both client (compute) and server tasks call this routine to initialize the <a name='2593'></font>
<font color=#447700>! module.  Routine setup_quilt_servers() is called from this routine to <a name='2594'></font>
<font color=#447700>! determine which tasks are compute tasks and which are server tasks.  Server <a name='2595'></font>
<font color=#447700>! tasks then call routine quilt() and remain there for the rest of the model <a name='2596'></font>
<font color=#447700>! run.  Compute tasks return from init_module_wrf_quilt() to perform model <a name='2597'></font>
<font color=#447700>! computations.  <a name='2598'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2599'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='2600'></font>
      IMPLICIT NONE<a name='2601'>
      INCLUDE 'mpif.h'<a name='2602'>
      INTEGER i<a name='2603'>
      NAMELIST /namelist_quilt/ nio_tasks_per_group, nio_groups, poll_servers<a name='2604'>
      INTEGER ntasks, mytask, ierr, io_status<a name='2605'>
#  if defined(_OPENMP) &amp;&amp; defined(MPI2_THREAD_SUPPORT)<a name='2606'>
      INTEGER thread_support_provided, thread_support_requested<a name='2607'>
#  endif<a name='2608'>
      INTEGER mpi_comm_here, temp_poll<a name='2609'>
      LOGICAL mpi_inited<a name='2610'>
      LOGICAL esmf_coupling<a name='2611'>
<a name='2612'>
<font color=#447700>!!!!! needed to sneak-peek the namelist to get parent_id<a name='2613'></font>
<font color=#447700>! define as temporaries<a name='2614'></font>
# include "<A href='../../html_code/include/namelist_defines.inc.html'>namelist_defines.inc</A>"<A NAME="namelist_defines.inc_5"><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2615'>
<a name='2616'>
<font color=#447700>! Statements that specify the namelists<a name='2617'></font>
# include "<A href='../../html_code/include/namelist_statements.inc.html'>namelist_statements.inc</A>"<A NAME="namelist_statements.inc_6"><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2618'>
<font color=#447700>!TODO:  Change this to run-time switch<a name='2619'></font>
#  ifdef ESMFIO<a name='2620'>
      esmf_coupling = .TRUE.<a name='2621'>
#  else<a name='2622'>
      esmf_coupling = .FALSE.<a name='2623'>
#  endif<a name='2624'>
<a name='2625'>
      quilting_enabled = .FALSE.<a name='2626'>
      IF ( disable_quilt ) RETURN<a name='2627'>
<a name='2628'>
      DO i = 1,int_num_handles<a name='2629'>
        okay_to_write(i) = .FALSE.<a name='2630'>
        int_handle_in_use(i) = .FALSE.<a name='2631'>
        server_for_handle(i) = 0 <a name='2632'>
        int_num_bytes_to_write(i) = 0<a name='2633'>
      ENDDO<a name='2634'>
<a name='2635'>
      CALL MPI_INITIALIZED( mpi_inited, ierr )<a name='2636'>
      IF ( .NOT. mpi_inited ) THEN<a name='2637'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>WRF_ERROR_FATAL</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_328">( "module_io_quilt_old.F : MPI not init'd" )<a name='2638'>
      ENDIF<a name='2639'>
      CALL <A href='../../html_code/frame/module_dm.F.html#WRF_GET_DM_QUILT_COMM'>wrf_get_dm_quilt_comm</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_DM_QUILT_COMM_1">( mpi_comm_here )   <font color=#447700>! jm 20151212<a name='2640'></font>
<a name='2641'>
      CALL MPI_Comm_rank( mpi_comm_here, mytask, ierr ) ;<a name='2642'>
      CALL mpi_x_comm_size( mpi_comm_here, ntasks, ierr ) ;<a name='2643'>
<a name='2644'>
      IF ( mytask .EQ. 0 ) THEN<a name='2645'>
        OPEN ( unit=27, file="namelist.input", form="formatted", status="old" )<a name='2646'>
        nio_groups = 1<a name='2647'>
        nio_tasks_per_group  = 0<a name='2648'>
        poll_servers = .false.<a name='2649'>
        READ ( 27 , NML = namelist_quilt, IOSTAT=io_status )<a name='2650'>
        IF (io_status .NE. 0) THEN<a name='2651'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_329">( "ERROR reading namelist namelist_quilt" )<a name='2652'>
        ENDIF<a name='2653'>
        REWIND(27)<a name='2654'>
        nproc_x = -1<a name='2655'>
        nproc_y = -1<a name='2656'>
        READ ( UNIT = 27 , NML = domains , IOSTAT=io_status )<a name='2657'>
        IF (io_status .NE. 0) THEN<a name='2658'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_330">( "ERROR reading namelist domains" )<a name='2659'>
        ENDIF<a name='2660'>
        CLOSE ( 27 )<a name='2661'>
        IF ( esmf_coupling ) THEN<a name='2662'>
          IF ( nio_tasks_per_group &gt; 0 ) THEN<a name='2663'>
            CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_331">("frame/module_io_quilt.F: cannot use "// &amp;<a name='2664'>
                                 "ESMF coupling with quilt tasks") ;<a name='2665'>
          ENDIF<a name='2666'>
        ENDIF<a name='2667'>
        if(poll_servers) then<a name='2668'>
           temp_poll=1<a name='2669'>
        else<a name='2670'>
           temp_poll=0<a name='2671'>
        endif<a name='2672'>
      ENDIF<a name='2673'>
<a name='2674'>
      CALL mpi_bcast( nio_tasks_per_group  , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2675'>
      CALL mpi_bcast( nio_groups , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2676'>
      CALL mpi_bcast( temp_poll , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2677'>
      CALL mpi_bcast( nproc_x , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2678'>
      CALL mpi_bcast( nproc_y , 1 , MPI_INTEGER , 0 , mpi_comm_here, ierr )<a name='2679'>
<a name='2680'>
      poll_servers = (temp_poll == 1)<a name='2681'>
<a name='2682'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#SETUP_QUILT_SERVERS'>setup_quilt_servers</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SETUP_QUILT_SERVERS_2">( nio_tasks_per_group,            &amp;<a name='2683'>
                                mytask,               &amp;<a name='2684'>
                                ntasks,               &amp;<a name='2685'>
                                nproc_x,              &amp;<a name='2686'>
                                nproc_y,              &amp;<a name='2687'>
                                nio_groups,           &amp;<a name='2688'>
                                nio_tasks_in_group,   &amp;<a name='2689'>
                                mpi_comm_here,        &amp;<a name='2690'>
                                mpi_comm_local,       &amp;<a name='2691'>
                                mpi_comm_io_groups)<a name='2692'>
<a name='2693'>
      call <A href='../../html_code/frame/module_wrf_error.F.html#INIT_MODULE_WRF_ERROR'>init_module_wrf_error</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_MODULE_WRF_ERROR_2">(on_io_server=.true.)<a name='2694'>
<a name='2695'>
       <font color=#447700>! provide the communicator for the integration tasks to RSL<a name='2696'></font>
       IF ( compute_node ) THEN<a name='2697'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='2698'></font>
          mpi_comm_allcompute = mpi_comm_local<a name='2699'>
#endif<a name='2700'>
          CALL <A href='../../html_code/frame/module_dm.F.html#WRF_SET_DM_COMMUNICATOR'>wrf_set_dm_communicator</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_SET_DM_COMMUNICATOR_8">( mpi_comm_local )<a name='2701'>
#  if ( DA_CORE <font color=#447700>!= 1 )<a name='2702'></font>
          IF (coupler_on) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_SET_DM_COMMUNICATOR'>cpl_set_dm_communicator</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_SET_DM_COMMUNICATOR_3">( mpi_comm_local )<a name='2703'>
#  endif<a name='2704'>
       ELSE<a name='2705'>
#  if ( DA_CORE <font color=#447700>!= 1 )<a name='2706'></font>
          IF (coupler_on) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_SET_DM_COMMUNICATOR'>cpl_set_dm_communicator</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_SET_DM_COMMUNICATOR_4">( MPI_COMM_NULL )<a name='2707'>
#  endif<a name='2708'>
          CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#QUILT'>quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#INIT_MODULE_WRF_QUILT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QUILT_2">    <font color=#447700>! will not return on io server tasks<a name='2709'></font>
       ENDIF<a name='2710'>
#endif<a name='2711'>
      RETURN<a name='2712'>
    END SUBROUTINE init_module_wrf_quilt<a name='2713'>
<a name='2714'>
<a name='2715'>
#ifdef IBM_REDUCE_BUG_WORKAROUND<a name='2716'>
<a name='2717'>
    <font color=#447700>! These three subroutines re-implement MPI_Reduce on MPI_INTEGER<a name='2718'></font>
    <font color=#447700>! with OP=MPI_ADD.<a name='2719'></font>
<a name='2720'>
    <font color=#447700>! This is a workaround for a bug in the IBM MPI implementation.<a name='2721'></font>
    <font color=#447700>! Some MPI processes will get stuck in MPI_Reduce and not<a name='2722'></font>
    <font color=#447700>! return until the PREVIOUS I/O server group finishes writing.<a name='2723'></font>
<a name='2724'>
    <font color=#447700>! This workaround replaces the MPI_Reduce call with many <a name='2725'></font>
    <font color=#447700>! MPI_Send and MPI_Recv calls that perform the sum on the<a name='2726'></font>
    <font color=#447700>! root of the communicator.<a name='2727'></font>
<a name='2728'>
    <font color=#447700>! There are two reduce routines: one for a sum of scalars<a name='2729'></font>
    <font color=#447700>! and one for a sum of arrays.  The get_reduce_tag generates<a name='2730'></font>
    <font color=#447700>! MPI tags for the communication.<a name='2731'></font>
<a name='2732'>
<A NAME='GET_REDUCE_TAG'><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2733'>
  integer <font color=#993300>function </font><font color=#cc0000>get_reduce_tag</font>(root,comm) <A href='../../call_to/GET_REDUCE_TAG.html' TARGET='index'>4</A>,<A href='../../call_from/GET_REDUCE_TAG.html' TARGET='index'>12</A><a name='2734'>
    implicit none<a name='2735'>
    include 'mpif.h'<a name='2736'>
    integer, intent(in) :: comm,root<a name='2737'>
    integer :: i,j, tag, here<a name='2738'>
    integer :: ierr,me,size<a name='2739'>
<a name='2740'>
    integer, pointer :: nexttags(:)<a name='2741'>
    integer, target :: dummy(1)<a name='2742'>
    character(255) :: message<a name='2743'>
    integer(kind=4) :: comm4,hashed<a name='2744'>
<a name='2745'>
    integer, parameter :: hashsize = 113 <font color=#447700>! should be prime, &gt;max_servers+1<a name='2746'></font>
    integer, parameter :: tagloop = 100000 <font color=#447700>! number of tags reserved per communicator<a name='2747'></font>
    integer, parameter :: origin = 1031102 <font color=#447700>! lowest tag number we'll use<a name='2748'></font>
    integer, save :: nexttag=origin <font color=#447700>! next tag to use for a new communicator<a name='2749'></font>
    integer, save :: comms(hashsize)=-1, firsttag(hashsize)=0, curtag(hashsize)=0<a name='2750'>
<a name='2751'>
    <font color=#447700>! If integers are not four bytes, this implementation will still<a name='2752'></font>
    <font color=#447700>! work, but it may be inefficient (O(N) lookup instead of O(1)).<a name='2753'></font>
    <font color=#447700>! To fix that, an eight byte hash function would be needed, but<a name='2754'></font>
    <font color=#447700>! integers are four bytes in WRF, so that is not a problem right<a name='2755'></font>
    <font color=#447700>! now.<a name='2756'></font>
<a name='2757'>
    comm4=comm<a name='2758'>
    call int_hash(comm4,hashed)<a name='2759'>
    hashed=mod(abs(hashed),hashsize)+1<a name='2760'>
    if(hashed&lt;0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_332">('hashed&lt;0')<a name='2761'>
<a name='2762'>
    do i=0,hashsize-1<a name='2763'>
       j=1+mod(i+hashed-1,hashsize)<a name='2764'>
<a name='2765'>
       if(firsttag(j)/=0 .and. comms(j)==comm) then<a name='2766'>
          <font color=#447700>! Found the communicator<a name='2767'></font>
          if(curtag(j)-firsttag(j) &gt;= tagloop) then<a name='2768'>
             <font color=#447700>! Hit the max tag number so we need to reset.<a name='2769'></font>
             <font color=#447700>! To make sure &gt;tagloop reduces don't happen <a name='2770'></font>
             <font color=#447700>! before someone finishes an old reduce, we <a name='2771'></font>
             <font color=#447700>! have an MPI_Barrier here.<a name='2772'></font>
             <font color=#447700>!call wrf_message('Hit tagloop limit so calling mpi_barrier in get_reduce_tag...')<a name='2773'></font>
             call mpi_barrier(comm,ierr)<a name='2774'>
             if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_333">('cannot call mpi_barrier')<a name='2775'>
             <font color=#447700>!call wrf_message('  ...back from mpi_barrier in get_reduce_tag.')<a name='2776'></font>
<a name='2777'>
             curtag(j)=firsttag(j)<a name='2778'>
          endif<a name='2779'>
<a name='2780'>
          tag=curtag(j)<a name='2781'>
          curtag(j)=tag+1<a name='2782'>
          get_reduce_tag=tag<a name='2783'>
          return<a name='2784'>
       endif<a name='2785'>
    enddo<a name='2786'>
<a name='2787'>
<a name='2788'>
    <font color=#447700>! ==================== HANDLE NEW COMMUNICATORS ====================<a name='2789'></font>
<a name='2790'>
    <font color=#447700>!write(message,'("Found a new communicator ",I0," in get_reduce_tag, so making a tag range for it")') comm<a name='2791'></font>
<a name='2792'>
    <font color=#447700>! If we get here, the communicator is new to us, so we need<a name='2793'></font>
    <font color=#447700>! to add it to the hash and give it a new tag.  <a name='2794'></font>
<a name='2795'>
    <font color=#447700>! First, figure out where we'll put the tag in the hashtable<a name='2796'></font>
    here=-1<a name='2797'>
    do i=0,hashsize-1<a name='2798'>
       j=1+mod(i+hashed-1,hashsize)<a name='2799'>
<a name='2800'>
       if(firsttag(j)==0) then<a name='2801'>
          here=j<a name='2802'>
          exit<a name='2803'>
       endif<a name='2804'>
    enddo<a name='2805'>
    if(here==-1) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_334">('no room in hashtable; increase hashsize in get_reduce_tag (should be &gt;max_servers+1)')<a name='2806'>
<a name='2807'>
    <font color=#447700>! Now, find out the new tag's number.  To do this, we need to<a name='2808'></font>
    <font color=#447700>! get the next tag number that is not used by any ranks.<a name='2809'></font>
<a name='2810'>
    call mpi_comm_rank(comm,me,ierr)<a name='2811'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_335">('cannot call mpi_comm_rank')<a name='2812'>
<a name='2813'>
    call mpi_comm_size(comm,size,ierr)<a name='2814'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_336">('cannot call mpi_comm_size')<a name='2815'>
<a name='2816'>
    if(me==root) then<a name='2817'>
       allocate(nexttags(size))<a name='2818'>
    else<a name='2819'>
       nexttags=&gt;dummy<a name='2820'>
    endif<a name='2821'>
<a name='2822'>
    call mpi_gather(nexttag,1,MPI_INTEGER,nexttags,1,MPI_INTEGER,root,comm,ierr)<a name='2823'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_337">('cannot call mpi_gather')<a name='2824'>
<a name='2825'>
    if(me==root) then<a name='2826'>
       nexttag=max(nexttag,maxval(nexttags))<a name='2827'>
       deallocate(nexttags)<a name='2828'>
    endif<a name='2829'>
    call mpi_bcast(nexttag,1,MPI_INTEGER,root,comm,ierr)<a name='2830'>
<a name='2831'>
    comms(here)=comm<a name='2832'>
    firsttag(here)=nexttag<a name='2833'>
    curtag(here)=nexttag<a name='2834'>
    get_reduce_tag=nexttag<a name='2835'>
<a name='2836'>
    <font color=#447700>!write(message,'("Stored comm ",I0," with tag ",I0,"=",I0," in hash element ",I0)') &amp;<a name='2837'></font>
    <font color=#447700>!     comms(here),firsttag(here),curtag(here),here<a name='2838'></font>
    <font color=#447700>!call wrf_message(message)<a name='2839'></font>
<a name='2840'>
    nexttag=nexttag+tagloop<a name='2841'>
<a name='2842'>
  end function get_reduce_tag<a name='2843'>
<A NAME='REDUCE_ADD_INT_SCL'><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2844'>
  <font color=#993300>subroutine </font><font color=#cc0000>reduce_add_int_scl</font>(send,recv,count,root,comm) <A href='../../call_to/REDUCE_ADD_INT_SCL.html' TARGET='index'>2</A>,<A href='../../call_from/REDUCE_ADD_INT_SCL.html' TARGET='index'>14</A><a name='2845'>
    implicit none<a name='2846'>
    include 'mpif.h'<a name='2847'>
    integer, intent(in) :: count,root,comm<a name='2848'>
    integer, intent(inout) :: recv<a name='2849'>
    integer, intent(in) :: send<a name='2850'>
    integer :: me, size, ierr, you, temp, tag<a name='2851'>
    character*255 :: message<a name='2852'>
    if(root&lt;0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_338">('root is less than 0')<a name='2853'>
<a name='2854'>
    tag=<A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG'>get_reduce_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_REDUCE_TAG_3">(root,comm)<a name='2855'>
<a name='2856'>
    <font color=#447700>!write(message,'("Send/recv to tag ",I0)') tag<a name='2857'></font>
    <font color=#447700>!call wrf_message(message)<a name='2858'></font>
<a name='2859'>
    call mpi_comm_rank(comm,me,ierr)<a name='2860'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_339">('cannot call mpi_comm_rank')<a name='2861'>
<a name='2862'>
    call mpi_comm_size(comm,size,ierr)<a name='2863'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_340">('cannot call mpi_comm_size')<a name='2864'>
<a name='2865'>
    if(root&gt;=size) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_341">('root is beyond highest communicator rank')<a name='2866'>
<a name='2867'>
    if(me==root) then<a name='2868'>
       recv=send<a name='2869'>
       do you=0,size-2<a name='2870'>
          call mpi_recv(temp,1,MPI_INTEGER,MPI_ANY_SOURCE,tag,comm,MPI_STATUS_IGNORE,ierr)<a name='2871'>
          if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_342">('error calling mpi_recv')<a name='2872'>
          recv=recv+temp<a name='2873'>
       enddo<a name='2874'>
    else<a name='2875'>
       call mpi_send(send,1,MPI_INTEGER,root,tag,comm,ierr)<a name='2876'>
       if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_SCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_343">('error calling mpi_send')<a name='2877'>
    endif<a name='2878'>
  end subroutine reduce_add_int_scl<a name='2879'>
<A NAME='REDUCE_ADD_INT_ARR'><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2880'>
  <font color=#993300>subroutine </font><font color=#cc0000>reduce_add_int_arr</font>(sendbuf,recvbuf,count,root,comm) <A href='../../call_to/REDUCE_ADD_INT_ARR.html' TARGET='index'>2</A>,<A href='../../call_from/REDUCE_ADD_INT_ARR.html' TARGET='index'>14</A><a name='2881'>
    implicit none<a name='2882'>
    include 'mpif.h'<a name='2883'>
    integer, intent(in) :: count,root,comm<a name='2884'>
    integer, intent(in) :: sendbuf(count)<a name='2885'>
    integer, intent(inout) :: recvbuf(count)<a name='2886'>
    integer :: me, size, ierr, you, tempbuf(count), tag<a name='2887'>
    character*255 :: message<a name='2888'>
<a name='2889'>
    if(root&lt;0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_344">('root is less than 0')<a name='2890'>
<a name='2891'>
    tag=<A href='../../html_code/frame/module_io_quilt_old.F.html#GET_REDUCE_TAG'>get_reduce_tag</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_REDUCE_TAG_4">(root,comm)<a name='2892'>
<a name='2893'>
    <font color=#447700>!write(message,'("Send/recv to tag ",I0)') tag<a name='2894'></font>
    <font color=#447700>!call wrf_message(message)<a name='2895'></font>
<a name='2896'>
    call mpi_comm_rank(comm,me,ierr)<a name='2897'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_345">('cannot call mpi_comm_rank')<a name='2898'>
<a name='2899'>
    call mpi_comm_size(comm,size,ierr)<a name='2900'>
    if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_346">('cannot call mpi_comm_size')<a name='2901'>
<a name='2902'>
    if(root&gt;=size) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_347">('root is beyond highest communicator rank')<a name='2903'>
<a name='2904'>
    if(me==root) then<a name='2905'>
       recvbuf=sendbuf<a name='2906'>
       do you=0,size-2<a name='2907'>
          call mpi_recv(tempbuf,count,MPI_INTEGER,MPI_ANY_SOURCE,tag,comm,MPI_STATUS_IGNORE,ierr)<a name='2908'>
          if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_348">('error calling mpi_recv')<a name='2909'>
          recvbuf=recvbuf+tempbuf<a name='2910'>
       enddo<a name='2911'>
    else<a name='2912'>
       call mpi_send(sendbuf,count,MPI_INTEGER,root,tag,comm,ierr)<a name='2913'>
       if(ierr/=0) call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#REDUCE_ADD_INT_ARR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_349">('error calling mpi_send')<a name='2914'>
    endif<a name='2915'>
  end subroutine reduce_add_int_arr<a name='2916'>
#endif<a name='2917'>
<a name='2918'>
<a name='2919'>
END MODULE module_wrf_quilt<a name='2920'>
<a name='2921'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2922'></font>
<font color=#447700>! Remaining routines in this file are defined outside of the module<a name='2923'></font>
<font color=#447700>! either to defeat arg/param type checking or to avoid an explicit use<a name='2924'></font>
<font color=#447700>! dependence.<a name='2925'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2926'></font>
<a name='2927'>
<A NAME='DISABLE_QUILTING'><A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2928'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>disable_quilting</font> <A href='../../call_to/DISABLE_QUILTING.html' TARGET='index'>7</A>,<A href='../../call_from/DISABLE_QUILTING.html' TARGET='index'>5</A><a name='2929'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2930'></font>
<font color=#447700>! Call this in programs that you never want to be quilting (e.g. real)<a name='2931'></font>
<font color=#447700>! Must call before call to init_module_wrf_quilt().  <a name='2932'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2933'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#DISABLE_QUILTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_22"><a name='2934'>
  disable_quilt = .TRUE.<a name='2935'>
  RETURN<a name='2936'>
END SUBROUTINE disable_quilting<a name='2937'>
<a name='2938'>
<A NAME='QUILTING_DISABLED'><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILTING_DISABLED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2939'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>quilting_disabled</font>( reslt ) <A href='../../call_to/QUILTING_DISABLED.html' TARGET='index'>1</A>,<A href='../../call_from/QUILTING_DISABLED.html' TARGET='index'>4</A><a name='2940'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2941'></font>
<font color=#447700>! Call this in programs that you never want to be quilting (e.g. real)<a name='2942'></font>
<font color=#447700>! Must call before call to init_module_wrf_quilt().  <a name='2943'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2944'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILTING_DISABLED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_23"><a name='2945'>
  LOGICAL, INTENT(OUT) :: reslt<a name='2946'>
  reslt = disable_quilt<a name='2947'>
write(0,*)__FILE__,__LINE__,disable_quilt<a name='2948'>
  RETURN<a name='2949'>
END SUBROUTINE quilting_disabled<a name='2950'>
<a name='2951'>
<A NAME='USE_OUTPUT_SERVERS_FOR'><A href='../../html_code/frame/module_io_quilt_old.F.html#USE_OUTPUT_SERVERS_FOR' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2952'>
LOGICAL <font color=#993300>FUNCTION  </font><font color=#cc0000>use_output_servers_for</font>(ioform)<a name='2953'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2954'></font>
<font color=#447700>! Returns .TRUE. if I/O quilt servers are in-use for write operations<a name='2955'></font>
<font color=#447700>! AND the output servers can handle the given I/O form.  If the I/O<a name='2956'></font>
<font color=#447700>! form is 0, then the io form is not considered and the result is the<a name='2957'></font>
<font color=#447700>! same as calling use_output_servers.<a name='2958'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='2959'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2960'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILTING_DISABLED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_24"><a name='2961'>
  integer, intent(in) :: ioform<a name='2962'>
  use_output_servers_for = quilting_enabled<a name='2963'>
  use_output_servers_for = ( use_output_servers_for .and. ioform&lt;100 )<a name='2964'>
  RETURN<a name='2965'>
END FUNCTION use_output_servers_for<a name='2966'>
<a name='2967'>
<A NAME='USE_OUTPUT_SERVERS'><A href='../../html_code/frame/module_io_quilt_old.F.html#USE_OUTPUT_SERVERS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2968'>
LOGICAL <font color=#993300>FUNCTION  </font><font color=#cc0000>use_output_servers</font>()<a name='2969'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2970'></font>
<font color=#447700>! Returns .TRUE. if I/O quilt servers are in-use for write operations.<a name='2971'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='2972'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2973'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILTING_DISABLED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_25"><a name='2974'>
  use_output_servers = quilting_enabled<a name='2975'>
  RETURN<a name='2976'>
END FUNCTION use_output_servers<a name='2977'>
<a name='2978'>
<A NAME='USE_INPUT_SERVERS'><A href='../../html_code/frame/module_io_quilt_old.F.html#USE_INPUT_SERVERS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='2979'>
LOGICAL <font color=#993300>FUNCTION  </font><font color=#cc0000>use_input_servers</font>()<a name='2980'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2981'></font>
<font color=#447700>! Returns .TRUE. if I/O quilt servers are in-use for read operations.<a name='2982'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='2983'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2984'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#QUILTING_DISABLED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_26"><a name='2985'>
  use_input_servers = .FALSE.<a name='2986'>
  RETURN<a name='2987'>
END FUNCTION use_input_servers<a name='2988'>
<a name='2989'>
<A NAME='WRF_QUILT_OPEN_FOR_WRITE_BEGIN'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2990'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_open_for_write_begin</font>( FileName , gridid, Comm_compute, Comm_io, SysDepInfo, &amp; <A href='../../call_to/WRF_QUILT_OPEN_FOR_WRITE_BEGIN.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_QUILT_OPEN_FOR_WRITE_BEGIN.html' TARGET='index'>20</A><a name='2991'>
                                     DataHandle , io_form_arg, Status )<a name='2992'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2993'></font>
<font color=#447700>! Instruct the I/O quilt servers to begin data definition ("training") phase<a name='2994'></font>
<font color=#447700>! for writing to WRF dataset FileName.  io_form_arg indicates file format.<a name='2995'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='2996'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2997'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='2998'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_27"><a name='2999'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_99">, ONLY: IO_PNETCDF<a name='3000'>
  IMPLICIT NONE<a name='3001'>
  INCLUDE 'mpif.h'<a name='3002'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_7"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3003'>
  CHARACTER *(*), INTENT(IN)  :: FileName<a name='3004'>
  INTEGER ,       INTENT(IN)  :: gridid<a name='3005'>
  INTEGER ,       INTENT(IN)  :: Comm_compute , Comm_io<a name='3006'>
  CHARACTER *(*), INTENT(IN)  :: SysDepInfo<a name='3007'>
  INTEGER ,       INTENT(OUT) :: DataHandle<a name='3008'>
  INTEGER ,       INTENT(IN)  :: io_form_arg<a name='3009'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3010'>
<font color=#447700>! Local<a name='3011'></font>
  CHARACTER*132   :: locFileName, locSysDepInfo<a name='3012'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group<a name='3013'>
  REAL dummy<a name='3014'>
  INTEGER, EXTERNAL :: use_package<a name='3015'>
<a name='3016'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_283"> ( DEBUG_LVL, 'in wrf_quilt_open_for_write_begin' ) <a name='3017'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#INT_GET_FRESH_HANDLE'>int_get_fresh_handle</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GET_FRESH_HANDLE_4">(i)<a name='3018'>
  okay_to_write(i) = .false.<a name='3019'>
  DataHandle = i<a name='3020'>
<a name='3021'>
  locFileName = FileName<a name='3022'>
  locSysDepInfo = SysDepInfo<a name='3023'>
<a name='3024'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3025'>
<a name='3026'>
  SELECT CASE(use_package(io_form_arg))<a name='3027'>
<a name='3028'>
#ifdef PNETCDF_QUILT<a name='3029'>
  CASE(IO_PNETCDF)<a name='3030'>
     IF(compute_group_master(1)) THEN<a name='3031'>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_OFWB_HEADER'>int_gen_ofwb_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_OFWB_HEADER_3">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3032'>
                                  locFileName,locSysDepInfo,io_form_arg,&amp;<a name='3033'>
                                  DataHandle )<a name='3034'>
     ELSE<a name='3035'>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_20">( hdrbuf, hdrbufsize, itypesize )<a name='3036'>
     END IF<a name='3037'>
#endif<a name='3038'>
  CASE DEFAULT<a name='3039'>
<a name='3040'>
     IF ( wrf_dm_on_monitor() ) THEN<a name='3041'>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_OFWB_HEADER'>int_gen_ofwb_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_OFWB_HEADER_4">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3042'>
                                  locFileName,locSysDepInfo,io_form_arg,DataHandle )<a name='3043'>
     ELSE<a name='3044'>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_21">( hdrbuf, hdrbufsize, itypesize )<a name='3045'>
     ENDIF<a name='3046'>
<a name='3047'>
  END SELECT<a name='3048'>
<a name='3049'>
  iserver = get_server_id ( DataHandle )<a name='3050'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_12">( comm_io_group , iserver )<a name='3051'>
<a name='3052'>
  CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3053'>
<a name='3054'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3055'></font>
  <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3056'></font>
  reduced = 0<a name='3057'>
  reduced(1) = hdrbufsize <a name='3058'>
#ifdef PNETCDF_QUILT<a name='3059'>
  IF ( compute_group_master(1) ) reduced(2) = i<a name='3060'>
#else<a name='3061'>
  IF ( wrf_dm_on_monitor() )  reduced(2) = i <a name='3062'>
#endif<a name='3063'>
  CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3064'>
<font color=#447700>!!JMTIMING   CALL end_timing("MPI_Reduce in wrf_quilt_open_for_write_begin")<a name='3065'></font>
<a name='3066'>
  <font color=#447700>! send data to the i/o processor<a name='3067'></font>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_BEGIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_16">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3068'>
                        onebyte,                       &amp;<a name='3069'>
                        hdrbuf, hdrbufsize , &amp;<a name='3070'>
                        dummy, 0 )<a name='3071'>
<a name='3072'>
  Status = 0<a name='3073'>
<a name='3074'>
<a name='3075'>
#endif<a name='3076'>
  RETURN  <a name='3077'>
END SUBROUTINE wrf_quilt_open_for_write_begin<a name='3078'>
<a name='3079'>
<A NAME='WRF_QUILT_OPEN_FOR_WRITE_COMMIT'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3080'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_open_for_write_commit</font>( DataHandle , Status ) <A href='../../call_to/WRF_QUILT_OPEN_FOR_WRITE_COMMIT.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_OPEN_FOR_WRITE_COMMIT.html' TARGET='index'>16</A><a name='3081'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3082'></font>
<font color=#447700>! Instruct the I/O quilt servers to switch an internal flag to enable output<a name='3083'></font>
<font color=#447700>! for the dataset referenced by DataHandle.  The call to<a name='3084'></font>
<font color=#447700>! wrf_quilt_open_for_write_commit() must be paired with a call to<a name='3085'></font>
<font color=#447700>! wrf_quilt_open_for_write_begin().<a name='3086'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3087'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3088'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3089'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_28"><a name='3090'>
  IMPLICIT NONE<a name='3091'>
  INCLUDE 'mpif.h'<a name='3092'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_8"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3093'>
  INTEGER ,       INTENT(IN ) :: DataHandle<a name='3094'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3095'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group<a name='3096'>
  REAL dummy<a name='3097'>
<a name='3098'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_284"> ( DEBUG_LVL, 'in wrf_quilt_open_for_write_commit' ) <a name='3099'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3100'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3101'>
      okay_to_write( DataHandle ) = .true.<a name='3102'>
    ENDIF<a name='3103'>
  ENDIF<a name='3104'>
<a name='3105'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3106'>
<a name='3107'>
#ifdef PNETCDF_QUILT<a name='3108'>
<font color=#447700>!ARP Only want one command to be received by each IO server when using<a name='3109'></font>
<font color=#447700>!ARP parallel IO<a name='3110'></font>
  IF(compute_group_master(1)) THEN<a name='3111'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_11">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3112'>
                                 DataHandle, int_open_for_write_commit )<a name='3113'>
  ELSE<a name='3114'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_22">( hdrbuf, hdrbufsize, itypesize )<a name='3115'>
  END IF<a name='3116'>
#else<a name='3117'>
<a name='3118'>
  IF ( wrf_dm_on_monitor() ) THEN<a name='3119'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_12">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3120'>
                                 DataHandle, int_open_for_write_commit )<a name='3121'>
  ELSE<a name='3122'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_23">( hdrbuf, hdrbufsize, itypesize )<a name='3123'>
  ENDIF<a name='3124'>
#endif<a name='3125'>
<a name='3126'>
  iserver = get_server_id ( DataHandle )<a name='3127'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_13">( comm_io_group , iserver )<a name='3128'>
<a name='3129'>
  CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3130'>
<a name='3131'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3132'></font>
  <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3133'></font>
  reduced = 0<a name='3134'>
  reduced(1) = hdrbufsize <a name='3135'>
#ifdef PNETCDF_QUILT<a name='3136'>
  IF ( compute_group_master(1) ) reduced(2) = DataHandle<a name='3137'>
#else<a name='3138'>
  IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3139'>
#endif<a name='3140'>
  CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3141'>
<font color=#447700>!!JMTIMING   CALL end_timing("MPI_Reduce in wrf_quilt_open_for_write_commit")<a name='3142'></font>
<a name='3143'>
  <font color=#447700>! send data to the i/o processor<a name='3144'></font>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_WRITE_COMMIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_17">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3145'>
                        onebyte,                       &amp;<a name='3146'>
                        hdrbuf, hdrbufsize , &amp;<a name='3147'>
                        dummy, 0 )<a name='3148'>
<a name='3149'>
  Status = 0<a name='3150'>
<a name='3151'>
#endif<a name='3152'>
  RETURN  <a name='3153'>
END SUBROUTINE wrf_quilt_open_for_write_commit<a name='3154'>
<a name='3155'>
<A NAME='WRF_QUILT_OPEN_FOR_READ'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_READ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3156'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_open_for_read</font> ( FileName , Comm_compute, Comm_io, SysDepInfo, &amp;,<A href='../../call_from/WRF_QUILT_OPEN_FOR_READ.html' TARGET='index'>4</A><a name='3157'>
                               DataHandle , Status )<a name='3158'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3159'></font>
<font color=#447700>! Instruct the I/O quilt servers to open WRF dataset FileName for reading.<a name='3160'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3161'></font>
<font color=#447700>! This is not yet supported.<a name='3162'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3163'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3164'></font>
  IMPLICIT NONE<a name='3165'>
  CHARACTER *(*), INTENT(IN)  :: FileName<a name='3166'>
  INTEGER ,       INTENT(IN)  :: Comm_compute , Comm_io<a name='3167'>
  CHARACTER *(*), INTENT(IN)  :: SysDepInfo<a name='3168'>
  INTEGER ,       INTENT(OUT) :: DataHandle<a name='3169'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3170'>
<a name='3171'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_READ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_285"> ( DEBUG_LVL, 'in wrf_quilt_open_for_read' ) <a name='3172'>
  DataHandle = -1<a name='3173'>
  Status = -1<a name='3174'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_OPEN_FOR_READ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_350"> ( "frame/module_io_quilt.F: wrf_quilt_open_for_read not yet supported" )<a name='3175'>
#endif<a name='3176'>
  RETURN  <a name='3177'>
END SUBROUTINE wrf_quilt_open_for_read<a name='3178'>
<a name='3179'>
<A NAME='WRF_QUILT_INQUIRE_OPENED'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_OPENED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3180'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_inquire_opened</font> ( DataHandle, FileName , FileStatus, Status ) <A href='../../call_to/WRF_QUILT_INQUIRE_OPENED.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_INQUIRE_OPENED.html' TARGET='index'>4</A><a name='3181'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3182'></font>
<font color=#447700>! Inquire if the dataset referenced by DataHandle is open.<a name='3183'></font>
<font color=#447700>! Does not require communication with I/O servers.<a name='3184'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3185'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3186'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3187'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_OPENED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_29"><a name='3188'>
  IMPLICIT NONE<a name='3189'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_9"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_OPENED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3190'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3191'>
  CHARACTER *(*), INTENT(IN)  :: FileName<a name='3192'>
  INTEGER ,       INTENT(OUT) :: FileStatus<a name='3193'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3194'>
<a name='3195'>
  Status = 0<a name='3196'>
<a name='3197'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_OPENED' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_286"> ( DEBUG_LVL, 'in wrf_quilt_inquire_opened' ) <a name='3198'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3199'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3200'>
      IF ( okay_to_write( DataHandle ) ) THEN<a name='3201'>
        FileStatus = WRF_FILE_OPENED_FOR_WRITE<a name='3202'>
      ENDIF<a name='3203'>
    ENDIF<a name='3204'>
  ENDIF<a name='3205'>
  Status = 0<a name='3206'>
  <a name='3207'>
#endif<a name='3208'>
  RETURN<a name='3209'>
END SUBROUTINE wrf_quilt_inquire_opened<a name='3210'>
<a name='3211'>
<A NAME='WRF_QUILT_INQUIRE_FILENAME'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_FILENAME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3212'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_inquire_filename</font> ( DataHandle, FileName , FileStatus, Status ) <A href='../../call_to/WRF_QUILT_INQUIRE_FILENAME.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_INQUIRE_FILENAME.html' TARGET='index'>4</A><a name='3213'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3214'></font>
<font color=#447700>! Return the Filename and FileStatus associated with DataHandle.<a name='3215'></font>
<font color=#447700>! Does not require communication with I/O servers.<a name='3216'></font>
<font color=#447700>!<a name='3217'></font>
<font color=#447700>! Note that the current implementation does not actually return FileName.<a name='3218'></font>
<font color=#447700>! Currenlty, WRF does not use this returned value.  Fixing this would simply<a name='3219'></font>
<font color=#447700>! require saving the file names on the client tasks in an array similar to<a name='3220'></font>
<font color=#447700>! okay_to_write().<a name='3221'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3222'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3223'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3224'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_FILENAME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_30"><a name='3225'>
  IMPLICIT NONE<a name='3226'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_10"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_FILENAME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3227'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3228'>
  CHARACTER *(*), INTENT(OUT) :: FileName<a name='3229'>
  INTEGER ,       INTENT(OUT) :: FileStatus<a name='3230'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3231'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_INQUIRE_FILENAME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_287"> ( DEBUG_LVL, 'in wrf_quilt_inquire_filename' ) <a name='3232'>
  Status = 0<a name='3233'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3234'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3235'>
      IF ( okay_to_write( DataHandle ) ) THEN<a name='3236'>
        FileStatus = WRF_FILE_OPENED_FOR_WRITE<a name='3237'>
      ELSE<a name='3238'>
        FileStatus = WRF_FILE_OPENED_NOT_COMMITTED<a name='3239'>
      ENDIF<a name='3240'>
    ELSE<a name='3241'>
        FileStatus = WRF_FILE_NOT_OPENED<a name='3242'>
    ENDIF<a name='3243'>
    Status = 0<a name='3244'>
    FileName = "bogusfornow"<a name='3245'>
  ELSE<a name='3246'>
    Status = -1<a name='3247'>
  ENDIF<a name='3248'>
#endif<a name='3249'>
  RETURN<a name='3250'>
END SUBROUTINE wrf_quilt_inquire_filename<a name='3251'>
<a name='3252'>
<A NAME='WRF_QUILT_IOSYNC'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3253'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_iosync</font> ( DataHandle, Status ) <A href='../../call_to/WRF_QUILT_IOSYNC.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_IOSYNC.html' TARGET='index'>12</A><a name='3254'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3255'></font>
<font color=#447700>! Instruct the I/O quilt servers to synchronize the disk copy of a dataset<a name='3256'></font>
<font color=#447700>! with memory buffers.<a name='3257'></font>
<font color=#447700>!<a name='3258'></font>
<font color=#447700>! After the "iosync" header (request) is sent to the I/O quilt server,<a name='3259'></font>
<font color=#447700>! the compute tasks will then send the entire contents (headers and data) of<a name='3260'></font>
<font color=#447700>! int_local_output_buffer to their I/O quilt server.  This communication is<a name='3261'></font>
<font color=#447700>! done in subroutine send_to_io_quilt_servers().  After the I/O quilt servers<a name='3262'></font>
<font color=#447700>! receive this data, they will write all accumulated fields to disk.<a name='3263'></font>
<font color=#447700>!<a name='3264'></font>
<font color=#447700>! Significant time may be required for the I/O quilt servers to organize<a name='3265'></font>
<font color=#447700>! fields and write them to disk.  Therefore, the "iosync" request should be<a name='3266'></font>
<font color=#447700>! sent only when the compute tasks are ready to run for a while without<a name='3267'></font>
<font color=#447700>! needing to communicate with the servers.  Otherwise, the compute tasks<a name='3268'></font>
<font color=#447700>! will end up waiting for the servers to finish writing to disk, thus wasting<a name='3269'></font>
<font color=#447700>! any performance benefits of having servers at all.<a name='3270'></font>
<font color=#447700>!<a name='3271'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3272'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3273'></font>
#if  defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined (STUBMPI) <a name='3274'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_31"><a name='3275'>
  IMPLICIT NONE<a name='3276'>
  include "<A href='../../html_code/include/mpif.h.html'>mpif.h</A>"<A NAME="mpif.h_11"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3277'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3278'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3279'>
<a name='3280'>
  INTEGER locsize , itypesize<a name='3281'>
  INTEGER ierr, tasks_in_group, comm_io_group, dummy, i<a name='3282'>
<a name='3283'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_288"> ( DEBUG_LVL, 'in wrf_quilt_iosync' ) <a name='3284'>
<a name='3285'>
<font color=#447700>!  CALL start_timing<a name='3286'></font>
  IF ( associated ( int_local_output_buffer ) ) THEN<a name='3287'>
<a name='3288'>
    iserver = get_server_id ( DataHandle )<a name='3289'>
    CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_14">( comm_io_group , iserver )<a name='3290'>
<a name='3291'>
    CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3292'>
<a name='3293'>
    locsize = int_num_bytes_to_write(DataHandle)<a name='3294'>
<a name='3295'>
<font color=#447700>!    CALL start_timing<a name='3296'></font>
    <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3297'></font>
    reduced = 0<a name='3298'>
    reduced(1) = locsize <a name='3299'>
#ifdef PNETCDF_QUILT<a name='3300'>
<font color=#447700>! ARP Only want one command per IOServer if doing parallel IO<a name='3301'></font>
    IF ( compute_group_master(1) ) reduced(2) = DataHandle<a name='3302'>
#else<a name='3303'>
    IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3304'>
#endif<a name='3305'>
    CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3306'>
<font color=#447700>!    CALL end_timing("MPI_Reduce in wrf_quilt_iosync")<a name='3307'></font>
<a name='3308'>
    <font color=#447700>! send data to the i/o processor<a name='3309'></font>
#ifdef DEREF_KLUDGE<a name='3310'>
    CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_18">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3311'>
                          onebyte,                       &amp;<a name='3312'>
                          int_local_output_buffer(1), locsize , &amp;<a name='3313'>
                          dummy, 0 )<a name='3314'>
#else<a name='3315'>
    CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_19">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3316'>
                          onebyte,                       &amp;<a name='3317'>
                          int_local_output_buffer, locsize , &amp;<a name='3318'>
                          dummy, 0 )<a name='3319'>
#endif<a name='3320'>
<a name='3321'>
<a name='3322'>
    int_local_output_cursor = 1<a name='3323'>
<font color=#447700>!    int_num_bytes_to_write(DataHandle) = 0<a name='3324'></font>
    DEALLOCATE ( int_local_output_buffer )<a name='3325'>
    NULLIFY ( int_local_output_buffer )<a name='3326'>
  ELSE<a name='3327'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOSYNC' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_358"> ("frame/module_io_quilt.F: wrf_quilt_iosync: no buffer allocated")<a name='3328'>
  ENDIF<a name='3329'>
<font color=#447700>!  CALL end_timing("wrf_quilt_iosync")<a name='3330'></font>
  Status = 0<a name='3331'>
#endif<a name='3332'>
  RETURN<a name='3333'>
END SUBROUTINE wrf_quilt_iosync<a name='3334'>
<a name='3335'>
<A NAME='WRF_QUILT_IOCLOSE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3336'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_ioclose</font> ( DataHandle, Status ) <A href='../../call_to/WRF_QUILT_IOCLOSE.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_IOCLOSE.html' TARGET='index'>20</A><a name='3337'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3338'></font>
<font color=#447700>! Instruct the I/O quilt servers to close the dataset referenced by<a name='3339'></font>
<font color=#447700>! DataHandle.<a name='3340'></font>
<font color=#447700>! This routine also clears the client file handle and, if needed, deallocates<a name='3341'></font>
<font color=#447700>! int_local_output_buffer.<a name='3342'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3343'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3344'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined( STUBMPI) <a name='3345'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_32"><a name='3346'>
  USE <A href='../../html_code/frame/module_timing.F.html#MODULE_TIMING'>module_timing</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TIMING_29"><a name='3347'>
  IMPLICIT NONE<a name='3348'>
  INCLUDE 'mpif.h'<a name='3349'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_12"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3350'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3351'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3352'>
  INTEGER i, itypesize, tasks_in_group, comm_io_group, ierr<a name='3353'>
  REAL dummy<a name='3354'>
<a name='3355'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3356'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_289"> ( DEBUG_LVL, 'in wrf_quilt_ioclose' ) <a name='3357'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3358'>
<a name='3359'>
<font color=#447700>! If we're using pnetcdf then each IO server will need to receive the <a name='3360'></font>
<font color=#447700>! handle just once as there is<a name='3361'></font>
<font color=#447700>! no longer a reduce over the IO servers to get it.<a name='3362'></font>
#ifdef PNETCDF_QUILT<a name='3363'>
  IF ( compute_group_master(1) )THEN<a name='3364'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_13">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3365'>
                                 DataHandle, int_ioclose )<a name='3366'>
  ELSE<a name='3367'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_24">( hdrbuf, hdrbufsize, itypesize )<a name='3368'>
  ENDIF<a name='3369'>
#else<a name='3370'>
  IF ( wrf_dm_on_monitor() ) THEN<a name='3371'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_14">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3372'>
                                 DataHandle , int_ioclose )<a name='3373'>
  ELSE<a name='3374'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_25">( hdrbuf, hdrbufsize, itypesize )<a name='3375'>
  ENDIF<a name='3376'>
#endif<a name='3377'>
<a name='3378'>
  iserver = get_server_id ( DataHandle )<a name='3379'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_15">( comm_io_group , iserver )<a name='3380'>
<a name='3381'>
  CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3382'>
<a name='3383'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3384'></font>
  <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3385'></font>
  reduced = 0<a name='3386'>
#ifdef PNETCDF_QUILT<a name='3387'>
<font color=#447700>! If we're using pnetcdf then each IO server will need the handle as there is<a name='3388'></font>
<font color=#447700>! no longer a reduce over the IO servers to get it.<a name='3389'></font>
  IF ( compute_group_master(1) ) reduced(2) = DataHandle<a name='3390'>
#else<a name='3391'>
  IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3392'>
#endif<a name='3393'>
  CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3394'>
<font color=#447700>!!JMTIMING   CALL end_timing("MPI_Reduce in ioclose")<a name='3395'></font>
<a name='3396'>
#if 0<a name='3397'>
  <font color=#447700>! send data to the i/o processor<a name='3398'></font>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3399'></font>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_20">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3400'>
                        onebyte,                       &amp;<a name='3401'>
                        hdrbuf, hdrbufsize , &amp;<a name='3402'>
                        dummy, 0 )<a name='3403'>
<font color=#447700>!!JMTIMING   CALL end_timing("collect_on_comm in io_close")<a name='3404'></font>
#endif<a name='3405'>
<a name='3406'>
  int_handle_in_use(DataHandle) = .false.<a name='3407'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#SET_SERVER_ID'>set_server_id</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOCLOSE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_SERVER_ID_2">( DataHandle, 0 ) <a name='3408'>
  okay_to_write(DataHandle) = .false.<a name='3409'>
  okay_to_commit(DataHandle) = .false.<a name='3410'>
  int_local_output_cursor = 1<a name='3411'>
  int_num_bytes_to_write(DataHandle) = 0<a name='3412'>
  IF ( associated ( int_local_output_buffer ) ) THEN<a name='3413'>
    DEALLOCATE ( int_local_output_buffer )<a name='3414'>
    NULLIFY ( int_local_output_buffer )<a name='3415'>
  ENDIF<a name='3416'>
<a name='3417'>
  Status = 0<a name='3418'>
<font color=#447700>!!JMTIMING   CALL end_timing( "wrf_quilt_ioclose" )<a name='3419'></font>
<a name='3420'>
#endif<a name='3421'>
  RETURN<a name='3422'>
END SUBROUTINE wrf_quilt_ioclose<a name='3423'>
<a name='3424'>
<A NAME='WRF_QUILT_IOEXIT'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3425'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_ioexit</font>( Status ) <A href='../../call_to/WRF_QUILT_IOEXIT.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_IOEXIT.html' TARGET='index'>16</A><a name='3426'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3427'></font>
<font color=#447700>! Instruct the I/O quilt servers to shut down the WRF I/O system.<a name='3428'></font>
<font color=#447700>! Do not call any wrf_quilt_*() routines after this routine has been called.<a name='3429'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3430'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3431'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined (STUBMPI ) <a name='3432'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_33"><a name='3433'>
  IMPLICIT NONE<a name='3434'>
  INCLUDE 'mpif.h'<a name='3435'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_13"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3436'>
  INTEGER ,       INTENT(OUT) :: Status<a name='3437'>
  INTEGER                     :: DataHandle, actual_iserver<a name='3438'>
  INTEGER i, itypesize, tasks_in_group, comm_io_group, me, ierr <a name='3439'>
  REAL dummy<a name='3440'>
<a name='3441'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_290"> ( DEBUG_LVL, 'in wrf_quilt_ioexit' ) <a name='3442'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3443'>
<a name='3444'>
<font color=#447700>!ARPDBG - potential bug. Have no access to what type of IO is being used for<a name='3445'></font>
<font color=#447700>! this data so if PNETCDF_QUILT is defined then we assume that's what's being used.<a name='3446'></font>
#ifdef PNETCDF_QUILT<a name='3447'>
<font color=#447700>!ARP Send the ioexit message just once to each IOServer when using parallel IO<a name='3448'></font>
  IF( compute_group_master(1) ) THEN<a name='3449'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_15">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3450'>
                                 DataHandle, int_ioexit )<a name='3451'>
  ELSE<a name='3452'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_26">( hdrbuf, hdrbufsize, itypesize )<a name='3453'>
  END IF<a name='3454'>
#else<a name='3455'>
<a name='3456'>
  IF ( wrf_dm_on_monitor() ) THEN<a name='3457'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_HANDLE_HEADER'>int_gen_handle_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_HANDLE_HEADER_16">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3458'>
                                 DataHandle , int_ioexit )  <font color=#447700>! Handle is dummy<a name='3459'></font>
  ELSE<a name='3460'>
     CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_27">( hdrbuf, hdrbufsize, itypesize )<a name='3461'>
  ENDIF<a name='3462'>
#endif<a name='3463'>
<a name='3464'>
  DO iserver = 1, nio_groups<a name='3465'>
    if(poll_servers) then<a name='3466'>
       <font color=#447700>! We're using server polling mode, so we must call<a name='3467'></font>
       <font color=#447700>! *_find_server to receive the mpi_ssend sent by the servers,<a name='3468'></font>
       <font color=#447700>! otherwise WRF will hang at the mpi_x_reduce below.<a name='3469'></font>
<a name='3470'>
       call <A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER'>wrf_quilt_find_server</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_QUILT_FIND_SERVER_4">(actual_iserver)<a name='3471'>
<a name='3472'>
       <font color=#447700>! The actual_iserver is now set to the next available I/O server.<a name='3473'></font>
       <font color=#447700>! That may not be the same as iserver, but that's okay as long<a name='3474'></font>
       <font color=#447700>! as we run through this loop exactly nio_groups times.<a name='3475'></font>
    else<a name='3476'>
       <font color=#447700>! Not using server polling, so just access servers in numeric order.<a name='3477'></font>
       actual_iserver=iserver<a name='3478'>
    endif<a name='3479'>
    CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_IOEXIT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_16">( comm_io_group , actual_iserver )<a name='3480'>
<a name='3481'>
    CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3482'>
    CALL mpi_comm_rank( comm_io_group , me , ierr )<a name='3483'>
<a name='3484'>
<font color=#447700>! BY SENDING A NEGATIVE SIZE WE GET THE SERVERS TO SHUT DOWN<a name='3485'></font>
    hdrbufsize = -100 <a name='3486'>
    reduced = 0<a name='3487'>
    IF ( me .eq. 0 ) reduced(1) = hdrbufsize <a name='3488'>
    CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3489'>
<a name='3490'>
  ENDDO<a name='3491'>
  Status = 0<a name='3492'>
<a name='3493'>
#endif<a name='3494'>
  RETURN  <a name='3495'>
END SUBROUTINE wrf_quilt_ioexit<a name='3496'>
<a name='3497'>
<A NAME='WRF_QUILT_GET_NEXT_TIME'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_NEXT_TIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3498'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_next_time</font> ( DataHandle, DateStr, Status ) <A href='../../call_to/WRF_QUILT_GET_NEXT_TIME.html' TARGET='index'>1</A><a name='3499'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3500'></font>
<font color=#447700>! Instruct the I/O quilt servers to return the next time stamp.<a name='3501'></font>
<font color=#447700>! This is not yet supported.<a name='3502'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3503'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3504'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined (STUBMPI) <a name='3505'></font>
  IMPLICIT NONE<a name='3506'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3507'>
  CHARACTER*(*)               :: DateStr<a name='3508'>
  INTEGER                     :: Status<a name='3509'>
#endif<a name='3510'>
  RETURN<a name='3511'>
END SUBROUTINE wrf_quilt_get_next_time<a name='3512'>
<a name='3513'>
<A NAME='WRF_QUILT_GET_PREVIOUS_TIME'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_PREVIOUS_TIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3514'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_previous_time</font> ( DataHandle, DateStr, Status ) <A href='../../call_to/WRF_QUILT_GET_PREVIOUS_TIME.html' TARGET='index'>1</A><a name='3515'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3516'></font>
<font color=#447700>! Instruct the I/O quilt servers to return the previous time stamp.<a name='3517'></font>
<font color=#447700>! This is not yet supported.<a name='3518'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3519'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3520'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>! defined (STUBMPI)<a name='3521'></font>
  IMPLICIT NONE<a name='3522'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3523'>
  CHARACTER*(*)               :: DateStr<a name='3524'>
  INTEGER                     :: Status<a name='3525'>
#endif<a name='3526'>
  RETURN<a name='3527'>
END SUBROUTINE wrf_quilt_get_previous_time<a name='3528'>
<a name='3529'>
<A NAME='WRF_QUILT_SET_TIME'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3530'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_set_time</font> ( DataHandle, Data,  Status ) <A href='../../call_to/WRF_QUILT_SET_TIME.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_SET_TIME.html' TARGET='index'>18</A><a name='3531'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3532'></font>
<font color=#447700>! Instruct the I/O quilt servers to set the time stamp in the dataset<a name='3533'></font>
<font color=#447700>! referenced by DataHandle.<a name='3534'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3535'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3536'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3537'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_34"><a name='3538'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_100">, ONLY: IO_PNETCDF<a name='3539'>
  IMPLICIT NONE<a name='3540'>
  INCLUDE 'mpif.h'<a name='3541'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_14"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3542'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3543'>
  CHARACTER*(*) , INTENT(IN)  :: Data<a name='3544'>
  INTEGER                     :: Status<a name='3545'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group<a name='3546'>
  REAL dummy<a name='3547'>
  INTEGER                 :: Count<a name='3548'>
  INTEGER, EXTERNAL       :: use_package<a name='3549'>
<font color=#447700>!<a name='3550'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_291"> ( DEBUG_LVL, 'in wrf_quilt_set_time' )<a name='3551'>
<a name='3552'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3553'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3554'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3555'>
      Count = 0   <font color=#447700>! there is no count for character strings<a name='3556'></font>
<a name='3557'>
<font color=#447700>!ARPDBG - potential bug. Have no access to what type of IO is being used for<a name='3558'></font>
<font color=#447700>! this data so if PNETCDF_QUILT is defined then we assume that's what's being used.<a name='3559'></font>
#ifdef PNETCDF_QUILT<a name='3560'>
      IF(compute_group_master(1) )THEN<a name='3561'>
<font color=#447700>! Only want to send one time header to each IO server as <a name='3562'></font>
<font color=#447700>! can't tell that's what they are on the IO servers themselves - therefore use<a name='3563'></font>
<font color=#447700>! the compute_group_master process.<a name='3564'></font>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_7">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3565'>
                                      DataHandle, "TIMESTAMP", "", Data, int_set_time )<a name='3566'>
      ELSE<a name='3567'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_28">( hdrbuf, hdrbufsize, itypesize )<a name='3568'>
      END IF<a name='3569'>
#else<a name='3570'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='3571'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_8">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='3572'>
                                      DataHandle, "TIMESTAMP", "", Data, int_set_time )<a name='3573'>
      ELSE<a name='3574'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_29">( hdrbuf, hdrbufsize, itypesize )<a name='3575'>
      ENDIF<a name='3576'>
#endif<a name='3577'>
<a name='3578'>
      iserver = get_server_id ( DataHandle )<a name='3579'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_17">( comm_io_group , iserver )<a name='3580'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3581'>
<a name='3582'>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3583'></font>
      reduced = 0<a name='3584'>
      reduced(1) = hdrbufsize <a name='3585'>
#ifdef PNETCDF_QUILT<a name='3586'>
      IF ( compute_group_master(1) ) reduced(2) = DataHandle<a name='3587'>
#else<a name='3588'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3589'>
#endif<a name='3590'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3591'>
      <font color=#447700>! send data to the i/o processor<a name='3592'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SET_TIME' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_21">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3593'>
                            onebyte,                       &amp;<a name='3594'>
                            hdrbuf, hdrbufsize , &amp;<a name='3595'>
                            dummy, 0 )<a name='3596'>
    ENDIF<a name='3597'>
  ENDIF<a name='3598'>
<a name='3599'>
#endif<a name='3600'>
RETURN<a name='3601'>
END SUBROUTINE wrf_quilt_set_time<a name='3602'>
<a name='3603'>
<A NAME='WRF_QUILT_GET_NEXT_VAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_NEXT_VAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3604'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_next_var</font> ( DataHandle, VarName, Status ) <A href='../../call_to/WRF_QUILT_GET_NEXT_VAR.html' TARGET='index'>1</A><a name='3605'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3606'></font>
<font color=#447700>! When reading, instruct the I/O quilt servers to return the name of the next<a name='3607'></font>
<font color=#447700>! variable in the current time frame.<a name='3608'></font>
<font color=#447700>! This is not yet supported.<a name='3609'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3610'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3611'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3612'></font>
  IMPLICIT NONE<a name='3613'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3614'>
  CHARACTER*(*)               :: VarName<a name='3615'>
  INTEGER                     :: Status<a name='3616'>
#endif<a name='3617'>
  RETURN<a name='3618'>
END SUBROUTINE wrf_quilt_get_next_var<a name='3619'>
<a name='3620'>
<A NAME='WRF_QUILT_GET_DOM_TI_REAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3621'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_real</font> ( DataHandle,Element,   Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TI_REAL.html' TARGET='index'>2</A><a name='3622'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3623'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='3624'></font>
<font color=#447700>! independent domain metadata named "Element"<a name='3625'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='3626'></font>
<font color=#447700>! Metadata of type real are<a name='3627'></font>
<font color=#447700>! stored in array Data.<a name='3628'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='3629'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3630'></font>
<a name='3631'>
<font color=#447700>! This is not yet supported.<a name='3632'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3633'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3634'></font>
  IMPLICIT NONE<a name='3635'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3636'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3637'>
  REAL,            INTENT(IN) :: Data(*)<a name='3638'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3639'>
  INTEGER                     :: Outcount<a name='3640'>
  INTEGER                     :: Status<a name='3641'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_359">('wrf_quilt_get_dom_ti_real not supported yet')<a name='3642'>
#endif<a name='3643'>
RETURN<a name='3644'>
END SUBROUTINE wrf_quilt_get_dom_ti_real <a name='3645'>
<a name='3646'>
<A NAME='WRF_QUILT_PUT_DOM_TI_REAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3647'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_real</font> ( DataHandle,Element,   Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_REAL.html' TARGET='index'>16</A><a name='3648'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3649'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='3650'></font>
<font color=#447700>! domain metadata named "Element"<a name='3651'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='3652'></font>
<font color=#447700>! Metadata of type real are<a name='3653'></font>
<font color=#447700>! copied from array Data.<a name='3654'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3655'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3656'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3657'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_35"><a name='3658'>
  IMPLICIT NONE<a name='3659'>
  INCLUDE 'mpif.h'<a name='3660'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_15"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3661'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3662'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3663'>
  REAL ,          INTENT(IN)  :: Data(*)<a name='3664'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3665'>
  INTEGER                     :: Status<a name='3666'>
<font color=#447700>!Local<a name='3667'></font>
  CHARACTER*132   :: locElement<a name='3668'>
  INTEGER i, typesize, itypesize, tasks_in_group, ierr, comm_io_group<a name='3669'>
  REAL dummy<a name='3670'>
<font color=#447700>!<a name='3671'></font>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3672'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_292"> ( DEBUG_LVL, 'in wrf_quilt_put_dom_ti_real' ) <a name='3673'>
  CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3674'>
  locElement = Element<a name='3675'>
<a name='3676'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3677'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3678'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3679'>
      CALL MPI_TYPE_SIZE( MPI_REAL, typesize, ierr )<a name='3680'>
<a name='3681'>
#ifdef PNETCDF_QUILT<a name='3682'>
      IF ( compute_group_master(1) ) THEN<a name='3683'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER'>int_gen_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_5">( hdrbuf, hdrbufsize, itypesize, typesize, &amp;<a name='3684'>
                                 DataHandle, locElement, Data, Count, int_dom_ti_real )<a name='3685'>
      ELSE<a name='3686'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_30">( hdrbuf, hdrbufsize, itypesize )<a name='3687'>
      ENDIF<a name='3688'>
#else<a name='3689'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='3690'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER'>int_gen_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_6">( hdrbuf, hdrbufsize, itypesize, typesize, &amp;<a name='3691'>
                                 DataHandle, locElement, Data, Count, int_dom_ti_real )<a name='3692'>
      ELSE<a name='3693'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_31">( hdrbuf, hdrbufsize, itypesize )<a name='3694'>
      ENDIF<a name='3695'>
#endif<a name='3696'>
<a name='3697'>
      iserver = get_server_id ( DataHandle )<a name='3698'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_18">( comm_io_group , iserver )<a name='3699'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3700'>
<a name='3701'>
<font color=#447700>!!JMTIMING      CALL start_timing<a name='3702'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3703'></font>
      reduced = 0<a name='3704'>
      reduced(1) = hdrbufsize <a name='3705'>
#ifdef PNETCDF_QUILT<a name='3706'>
      IF( compute_group_master(1) )  reduced(2) = DataHandle<a name='3707'>
#else<a name='3708'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3709'>
#endif<a name='3710'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3711'>
<font color=#447700>!!JMTIMING       CALL end_timing("MPI_Reduce in wrf_quilt_put_dom_ti_real")<a name='3712'></font>
      <font color=#447700>! send data to the i/o processor<a name='3713'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_REAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_22">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3714'>
                            onebyte,                       &amp;<a name='3715'>
                            hdrbuf, hdrbufsize , &amp;<a name='3716'>
                            dummy, 0 )<a name='3717'>
    ENDIF<a name='3718'>
  ENDIF<a name='3719'>
<a name='3720'>
  Status = 0<a name='3721'>
<font color=#447700>!!JMTIMING   CALL end_timing("wrf_quilt_put_dom_ti_real")<a name='3722'></font>
#endif<a name='3723'>
RETURN<a name='3724'>
END SUBROUTINE wrf_quilt_put_dom_ti_real <a name='3725'>
<a name='3726'>
<A NAME='WRF_QUILT_GET_DOM_TI_DOUBLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3727'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_double</font> ( DataHandle,Element,   Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TI_DOUBLE.html' TARGET='index'>2</A><a name='3728'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3729'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='3730'></font>
<font color=#447700>! independent domain metadata named "Element"<a name='3731'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='3732'></font>
<font color=#447700>! Metadata of type double are<a name='3733'></font>
<font color=#447700>! stored in array Data.<a name='3734'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='3735'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3736'></font>
<font color=#447700>!<a name='3737'></font>
<font color=#447700>! This is not yet supported.<a name='3738'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3739'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3740'></font>
  IMPLICIT NONE<a name='3741'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3742'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3743'>
  real*8                      :: Data(*)<a name='3744'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3745'>
  INTEGER                     :: OutCount<a name='3746'>
  INTEGER                     :: Status<a name='3747'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_351">('wrf_quilt_get_dom_ti_double not supported yet')<a name='3748'>
#endif<a name='3749'>
RETURN<a name='3750'>
END SUBROUTINE wrf_quilt_get_dom_ti_double <a name='3751'>
<a name='3752'>
<A NAME='WRF_QUILT_PUT_DOM_TI_DOUBLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3753'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_double</font> ( DataHandle,Element,   Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_DOUBLE.html' TARGET='index'>2</A><a name='3754'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3755'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='3756'></font>
<font color=#447700>! domain metadata named "Element"<a name='3757'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='3758'></font>
<font color=#447700>! Metadata of type double are<a name='3759'></font>
<font color=#447700>! copied from array Data.<a name='3760'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3761'></font>
<font color=#447700>!<a name='3762'></font>
<font color=#447700>! This is not yet supported.<a name='3763'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3764'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3765'></font>
  IMPLICIT NONE<a name='3766'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3767'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3768'>
  REAL*8 ,        INTENT(IN)  :: Data(*)<a name='3769'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3770'>
  INTEGER                     :: Status<a name='3771'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_352">('wrf_quilt_put_dom_ti_double not supported yet')<a name='3772'>
#endif<a name='3773'>
RETURN<a name='3774'>
END SUBROUTINE wrf_quilt_put_dom_ti_double <a name='3775'>
<a name='3776'>
<A NAME='WRF_QUILT_GET_DOM_TI_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3777'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_integer</font> ( DataHandle,Element,   Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TI_INTEGER.html' TARGET='index'>2</A><a name='3778'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3779'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='3780'></font>
<font color=#447700>! independent domain metadata named "Element"<a name='3781'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='3782'></font>
<font color=#447700>! Metadata of type integer are<a name='3783'></font>
<font color=#447700>! stored in array Data.<a name='3784'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='3785'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3786'></font>
<font color=#447700>!<a name='3787'></font>
<font color=#447700>! This is not yet supported.<a name='3788'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3789'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3790'></font>
  IMPLICIT NONE<a name='3791'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3792'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3793'>
  integer                     :: Data(*)<a name='3794'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3795'>
  INTEGER                      :: OutCount<a name='3796'>
  INTEGER                     :: Status<a name='3797'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_360">('wrf_quilt_get_dom_ti_integer not supported yet')<a name='3798'>
#endif<a name='3799'>
RETURN<a name='3800'>
END SUBROUTINE wrf_quilt_get_dom_ti_integer <a name='3801'>
<a name='3802'>
<A NAME='WRF_QUILT_PUT_DOM_TI_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3803'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_integer</font> ( DataHandle,Element,   Data, Count,  Status ) <A href='../../call_to/WRF_QUILT_PUT_DOM_TI_INTEGER.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_INTEGER.html' TARGET='index'>20</A><a name='3804'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3805'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='3806'></font>
<font color=#447700>! domain metadata named "Element"<a name='3807'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='3808'></font>
<font color=#447700>! Metadata of type integer are<a name='3809'></font>
<font color=#447700>! copied from array Data.<a name='3810'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3811'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3812'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3813'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_36"><a name='3814'>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_101">, ONLY: IO_PNETCDF<a name='3815'>
  IMPLICIT NONE<a name='3816'>
  INCLUDE 'mpif.h'<a name='3817'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_16"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3818'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3819'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3820'>
  INTEGER ,       INTENT(IN)  :: Data(*)<a name='3821'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3822'>
  INTEGER                     :: Status<a name='3823'>
<font color=#447700>! Local<a name='3824'></font>
  CHARACTER*132   :: locElement<a name='3825'>
  INTEGER i, typesize, itypesize, tasks_in_group, ierr, comm_io_group<a name='3826'>
  REAL dummy<a name='3827'>
  INTEGER, EXTERNAL :: use_package<a name='3828'>
<font color=#447700>!<a name='3829'></font>
<a name='3830'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3831'></font>
  locElement = Element<a name='3832'>
<a name='3833'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_293"> ( DEBUG_LVL, 'in wrf_quilt_put_dom_ti_integer' ) <a name='3834'>
<a name='3835'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='3836'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='3837'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='3838'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, typesize, ierr )<a name='3839'>
<a name='3840'>
<font color=#447700>!ARPDBG - potential bug. Have no access to what type of IO is being used for<a name='3841'></font>
<font color=#447700>! this data so if PNETCDF_QUILT is defined then we assume that's what's being used.<a name='3842'></font>
#ifdef PNETCDF_QUILT<a name='3843'>
      IF ( compute_group_master(1) )THEN<a name='3844'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER'>int_gen_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_7">( hdrbuf, hdrbufsize, itypesize, typesize, &amp;<a name='3845'>
                                 DataHandle, locElement, Data, Count,     &amp;<a name='3846'>
                                 int_dom_ti_integer )<a name='3847'>
      ELSE<a name='3848'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_32">( hdrbuf, hdrbufsize, itypesize )<a name='3849'>
      ENDIF<a name='3850'>
#else<a name='3851'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='3852'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER'>int_gen_ti_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_8">( hdrbuf, hdrbufsize, itypesize, typesize, &amp;<a name='3853'>
                                 DataHandle, locElement, Data, Count,     &amp;<a name='3854'>
                                 int_dom_ti_integer )<a name='3855'>
      ELSE<a name='3856'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_33">( hdrbuf, hdrbufsize, itypesize )<a name='3857'>
      ENDIF<a name='3858'>
#endif<a name='3859'>
<a name='3860'>
      iserver = get_server_id ( DataHandle )<a name='3861'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_19">( comm_io_group , iserver )<a name='3862'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='3863'>
<a name='3864'>
<font color=#447700>!!JMTIMING      CALL start_timing<a name='3865'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='3866'></font>
      reduced = 0<a name='3867'>
      reduced(1) = hdrbufsize <a name='3868'>
#ifdef PNETCDF_QUILT<a name='3869'>
      IF ( compute_group_master(1) ) reduced(2) = DataHandle<a name='3870'>
#else<a name='3871'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='3872'>
#endif<a name='3873'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='3874'>
<a name='3875'>
<font color=#447700>!!JMTIMING       CALL end_timing("MPI_Reduce in wrf_quilt_put_dom_ti_integer")<a name='3876'></font>
      <font color=#447700>! send data to the i/o processor<a name='3877'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_23">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='3878'>
                            onebyte,                       &amp;<a name='3879'>
                            hdrbuf, hdrbufsize , &amp;<a name='3880'>
                            dummy, 0 )<a name='3881'>
    ENDIF<a name='3882'>
  ENDIF<a name='3883'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_294"> ( DEBUG_LVL, 'returning from wrf_quilt_put_dom_ti_integer' ) <a name='3884'>
<font color=#447700>!!JMTIMING   CALL end_timing("wrf_quilt_put_dom_ti_integer" )<a name='3885'></font>
<a name='3886'>
#endif<a name='3887'>
RETURN<a name='3888'>
END SUBROUTINE wrf_quilt_put_dom_ti_integer <a name='3889'>
<a name='3890'>
<A NAME='WRF_QUILT_GET_DOM_TI_LOGICAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3891'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_logical</font> ( DataHandle,Element,   Data, Count, Outcount, Status )<a name='3892'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3893'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='3894'></font>
<font color=#447700>! independent domain metadata named "Element"<a name='3895'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='3896'></font>
<font color=#447700>! Metadata of type logical are<a name='3897'></font>
<font color=#447700>! stored in array Data.<a name='3898'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='3899'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3900'></font>
<font color=#447700>!<a name='3901'></font>
<font color=#447700>! This is not yet supported.<a name='3902'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3903'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3904'></font>
  IMPLICIT NONE<a name='3905'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3906'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3907'>
  logical                     :: Data(*)<a name='3908'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3909'>
  INTEGER                      :: OutCount<a name='3910'>
  INTEGER                     :: Status<a name='3911'>
<font color=#447700>!  CALL wrf_message('wrf_quilt_get_dom_ti_logical not supported yet')<a name='3912'></font>
#endif<a name='3913'>
RETURN<a name='3914'>
END SUBROUTINE wrf_quilt_get_dom_ti_logical <a name='3915'>
<a name='3916'>
<A NAME='WRF_QUILT_PUT_DOM_TI_LOGICAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3917'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_logical</font> ( DataHandle,Element,   Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_LOGICAL.html' TARGET='index'>2</A><a name='3918'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3919'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='3920'></font>
<font color=#447700>! domain metadata named "Element"<a name='3921'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='3922'></font>
<font color=#447700>! Metadata of type logical are<a name='3923'></font>
<font color=#447700>! copied from array Data.<a name='3924'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3925'></font>
<font color=#447700>!<a name='3926'></font>
<font color=#447700>! This is not yet supported.<a name='3927'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3928'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3929'></font>
  IMPLICIT NONE<a name='3930'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3931'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3932'>
  logical ,            INTENT(IN) :: Data(*)<a name='3933'>
  INTEGER ,       INTENT(IN)  :: Count<a name='3934'>
  INTEGER                     :: Status<a name='3935'>
<font color=#447700>! Local<a name='3936'></font>
  INTEGER i<a name='3937'>
  INTEGER one_or_zero(Count)<a name='3938'>
<a name='3939'>
  DO i = 1, Count<a name='3940'>
    IF ( Data(i) ) THEN<a name='3941'>
      one_or_zero(i) = 1<a name='3942'>
    ELSE<a name='3943'>
      one_or_zero(i) = 0<a name='3944'>
    ENDIF<a name='3945'>
  ENDDO<a name='3946'>
<a name='3947'>
  CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_INTEGER'>wrf_quilt_put_dom_ti_integer</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_LOGICAL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_QUILT_PUT_DOM_TI_INTEGER_2"> ( DataHandle,Element,   one_or_zero, Count,  Status )<a name='3948'>
#endif<a name='3949'>
RETURN<a name='3950'>
END SUBROUTINE wrf_quilt_put_dom_ti_logical <a name='3951'>
<a name='3952'>
<A NAME='WRF_QUILT_GET_DOM_TI_CHAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3953'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_ti_char</font> ( DataHandle,Element,   Data,  Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TI_CHAR.html' TARGET='index'>2</A><a name='3954'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3955'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read time independent<a name='3956'></font>
<font color=#447700>! domain metadata named "Element"<a name='3957'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='3958'></font>
<font color=#447700>! Metadata of type char are<a name='3959'></font>
<font color=#447700>! stored in string Data.<a name='3960'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3961'></font>
<font color=#447700>!<a name='3962'></font>
<font color=#447700>! This is not yet supported.<a name='3963'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3964'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3965'></font>
  IMPLICIT NONE<a name='3966'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3967'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3968'>
  CHARACTER*(*)               :: Data<a name='3969'>
  INTEGER                     :: Status<a name='3970'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_361">('wrf_quilt_get_dom_ti_char not supported yet')<a name='3971'>
#endif<a name='3972'>
RETURN<a name='3973'>
END SUBROUTINE wrf_quilt_get_dom_ti_char <a name='3974'>
<a name='3975'>
<A NAME='WRF_QUILT_PUT_DOM_TI_CHAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3976'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_ti_char</font> ( DataHandle, Element,  Data,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TI_CHAR.html' TARGET='index'>16</A><a name='3977'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3978'></font>
<font color=#447700>! Instruct the I/O quilt servers to write time independent<a name='3979'></font>
<font color=#447700>! domain metadata named "Element"<a name='3980'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='3981'></font>
<font color=#447700>! Metadata of type char are<a name='3982'></font>
<font color=#447700>! copied from string Data.<a name='3983'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='3984'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3985'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='3986'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_37"><a name='3987'>
  IMPLICIT NONE<a name='3988'>
  INCLUDE 'mpif.h'<a name='3989'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_17"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3990'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='3991'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='3992'>
  CHARACTER*(*) , INTENT(IN)  :: Data<a name='3993'>
  INTEGER                     :: Status<a name='3994'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group, me<a name='3995'>
  REAL dummy<a name='3996'>
<font color=#447700>!<a name='3997'></font>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='3998'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_295"> ( DEBUG_LVL, 'in wrf_quilt_put_dom_ti_char' ) <a name='3999'>
<a name='4000'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='4001'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='4002'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='4003'>
<a name='4004'>
<font color=#447700>!ARPDBG - potential bug. Have no access to what type of IO is being used for<a name='4005'></font>
<font color=#447700>! this data so if PNETCDF_QUILT is defined then we assume that's what's being used.<a name='4006'></font>
#ifdef PNETCDF_QUILT<a name='4007'>
      IF(compute_group_master(1))THEN<a name='4008'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_9">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='4009'>
                                      DataHandle, Element, "", Data, &amp;<a name='4010'>
                                      int_dom_ti_char )<a name='4011'>
      ELSE<a name='4012'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_34">( hdrbuf, hdrbufsize, itypesize )<a name='4013'>
      END IF<a name='4014'>
#else<a name='4015'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='4016'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_10">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='4017'>
                                      DataHandle, Element, "", Data, int_dom_ti_char )<a name='4018'>
      ELSE<a name='4019'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_35">( hdrbuf, hdrbufsize, itypesize )<a name='4020'>
      ENDIF<a name='4021'>
#endif<a name='4022'>
<a name='4023'>
      iserver = get_server_id ( DataHandle )<a name='4024'>
<font color=#447700>!  write(0,*)'wrf_quilt_put_dom_ti_char ',iserver<a name='4025'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_20">( comm_io_group , iserver )<a name='4026'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='4027'>
      <font color=#447700>! send the size of my local buffer to the i/o task (obufsize doesnt mean anything here)<a name='4028'></font>
<font color=#447700>!!JMTIMING!  CALL start_timing<a name='4029'></font>
<font color=#447700>!write(0,*)'calling MPI_Barrier'<a name='4030'></font>
<font color=#447700>!  CALL MPI_Barrier( mpi_comm_local, ierr )<a name='4031'></font>
<font color=#447700>!write(0,*)'back from MPI_Barrier'<a name='4032'></font>
<font color=#447700>!!JMTIMING!   CALL end_timing("MPI_Barrier in wrf_quilt_put_dom_ti_char")<a name='4033'></font>
<a name='4034'>
<font color=#447700>!!JMTIMING      CALL start_timing<a name='4035'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='4036'></font>
      reduced_dummy = 0 <a name='4037'>
      reduced = 0<a name='4038'>
      reduced(1) = hdrbufsize <a name='4039'>
#ifdef PNETCDF_QUILT<a name='4040'>
      IF(compute_group_master(1))    reduced(2) = DataHandle<a name='4041'>
#else<a name='4042'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='4043'>
#endif<a name='4044'>
<font color=#447700>!call mpi_comm_rank( comm_io_group , me, ierr )<a name='4045'></font>
<a name='4046'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='4047'>
<a name='4048'>
<font color=#447700>!!JMTIMING       CALL end_timing("MPI_Reduce in wrf_quilt_put_dom_ti_char")<a name='4049'></font>
      <font color=#447700>! send data to the i/o processor<a name='4050'></font>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='4051'></font>
<a name='4052'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_24">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='4053'>
                            onebyte,                       &amp;<a name='4054'>
                            hdrbuf, hdrbufsize , &amp;<a name='4055'>
                            dummy, 0 )<a name='4056'>
<font color=#447700>!!JMTIMING   CALL end_timing("collect_on_comm in wrf_quilt_put_dom_ti_char")<a name='4057'></font>
    ENDIF<a name='4058'>
  ENDIF<a name='4059'>
<font color=#447700>!!JMTIMING   CALL end_timing("wrf_quilt_put_dom_ti_char")<a name='4060'></font>
<a name='4061'>
#endif<a name='4062'>
RETURN<a name='4063'>
END SUBROUTINE wrf_quilt_put_dom_ti_char <a name='4064'>
<a name='4065'>
<A NAME='WRF_QUILT_GET_DOM_TD_REAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TD_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4066'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_real</font> ( DataHandle,Element, DateStr,  Data, Count, Outcount, Status )<a name='4067'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4068'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4069'></font>
<font color=#447700>! dependent domain metadata named "Element" valid at time DateStr<a name='4070'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4071'></font>
<font color=#447700>! Metadata of type real are<a name='4072'></font>
<font color=#447700>! stored in array Data.<a name='4073'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4074'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4075'></font>
<font color=#447700>!<a name='4076'></font>
<font color=#447700>! This is not yet supported.<a name='4077'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4078'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4079'></font>
  IMPLICIT NONE<a name='4080'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4081'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4082'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4083'>
  real                        :: Data(*)<a name='4084'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4085'>
  INTEGER                     :: OutCount<a name='4086'>
  INTEGER                     :: Status<a name='4087'>
#endif<a name='4088'>
RETURN<a name='4089'>
END SUBROUTINE wrf_quilt_get_dom_td_real <a name='4090'>
<a name='4091'>
<A NAME='WRF_QUILT_PUT_DOM_TD_REAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TD_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4092'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_real</font> ( DataHandle,Element, DateStr,  Data, Count,  Status )<a name='4093'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4094'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4095'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4096'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4097'></font>
<font color=#447700>! Metadata of type real are<a name='4098'></font>
<font color=#447700>! copied from array Data.<a name='4099'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4100'></font>
<font color=#447700>!<a name='4101'></font>
<font color=#447700>! This is not yet supported.<a name='4102'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4103'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4104'></font>
  IMPLICIT NONE<a name='4105'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4106'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4107'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4108'>
  real ,            INTENT(IN) :: Data(*)<a name='4109'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4110'>
  INTEGER                     :: Status<a name='4111'>
#endif<a name='4112'>
RETURN<a name='4113'>
END SUBROUTINE wrf_quilt_put_dom_td_real <a name='4114'>
<a name='4115'>
<A NAME='WRF_QUILT_GET_DOM_TD_DOUBLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TD_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4116'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_double</font> ( DataHandle,Element, DateStr,  Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_DOM_TD_DOUBLE.html' TARGET='index'>2</A><a name='4117'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4118'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4119'></font>
<font color=#447700>! dependent domain metadata named "Element" valid at time DateStr<a name='4120'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4121'></font>
<font color=#447700>! Metadata of type double are<a name='4122'></font>
<font color=#447700>! stored in array Data.<a name='4123'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4124'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4125'></font>
<font color=#447700>!<a name='4126'></font>
<font color=#447700>! This is not yet supported.<a name='4127'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4128'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4129'></font>
  IMPLICIT NONE<a name='4130'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4131'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4132'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4133'>
  real*8                          :: Data(*)<a name='4134'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4135'>
  INTEGER                      :: OutCount<a name='4136'>
  INTEGER                     :: Status<a name='4137'>
#endif<a name='4138'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TD_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_353">('wrf_quilt_get_dom_td_double not supported yet')<a name='4139'>
RETURN<a name='4140'>
END SUBROUTINE wrf_quilt_get_dom_td_double <a name='4141'>
<a name='4142'>
<A NAME='WRF_QUILT_PUT_DOM_TD_DOUBLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TD_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4143'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_double</font> ( DataHandle,Element, DateStr,  Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_DOM_TD_DOUBLE.html' TARGET='index'>2</A><a name='4144'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4145'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4146'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4147'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4148'></font>
<font color=#447700>! Metadata of type double are<a name='4149'></font>
<font color=#447700>! copied from array Data.<a name='4150'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4151'></font>
<font color=#447700>!<a name='4152'></font>
<font color=#447700>! This is not yet supported.<a name='4153'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4154'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4155'></font>
  IMPLICIT NONE<a name='4156'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4157'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4158'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4159'>
  real*8 ,            INTENT(IN) :: Data(*)<a name='4160'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4161'>
  INTEGER                     :: Status<a name='4162'>
#endif<a name='4163'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TD_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_354">('wrf_quilt_put_dom_td_double not supported yet')<a name='4164'>
RETURN<a name='4165'>
END SUBROUTINE wrf_quilt_put_dom_td_double <a name='4166'>
<a name='4167'>
<A NAME='WRF_QUILT_GET_DOM_TD_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4168'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_integer</font> ( DataHandle,Element, DateStr,  Data, Count, Outcount, Status )<a name='4169'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4170'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4171'></font>
<font color=#447700>! dependent domain metadata named "Element" valid at time DateStr<a name='4172'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4173'></font>
<font color=#447700>! Metadata of type integer are<a name='4174'></font>
<font color=#447700>! stored in array Data.<a name='4175'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4176'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4177'></font>
<font color=#447700>!<a name='4178'></font>
<font color=#447700>! This is not yet supported.<a name='4179'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4180'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4181'></font>
  IMPLICIT NONE<a name='4182'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4183'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4184'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4185'>
  integer                          :: Data(*)<a name='4186'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4187'>
  INTEGER                      :: OutCount<a name='4188'>
  INTEGER                     :: Status<a name='4189'>
#endif<a name='4190'>
RETURN<a name='4191'>
END SUBROUTINE wrf_quilt_get_dom_td_integer <a name='4192'>
<a name='4193'>
<A NAME='WRF_QUILT_PUT_DOM_TD_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4194'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_integer</font> ( DataHandle,Element, DateStr,  Data, Count,  Status )<a name='4195'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4196'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4197'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4198'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4199'></font>
<font color=#447700>! Metadata of type integer are<a name='4200'></font>
<font color=#447700>! copied from array Data.<a name='4201'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4202'></font>
<font color=#447700>!<a name='4203'></font>
<font color=#447700>! This is not yet supported.<a name='4204'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4205'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4206'></font>
  IMPLICIT NONE<a name='4207'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4208'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4209'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4210'>
  integer ,            INTENT(IN) :: Data(*)<a name='4211'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4212'>
  INTEGER                     :: Status<a name='4213'>
#endif<a name='4214'>
RETURN<a name='4215'>
END SUBROUTINE wrf_quilt_put_dom_td_integer <a name='4216'>
<a name='4217'>
<A NAME='WRF_QUILT_GET_DOM_TD_LOGICAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TD_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4218'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_logical</font> ( DataHandle,Element, DateStr,  Data, Count, Outcount, Status )<a name='4219'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4220'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4221'></font>
<font color=#447700>! dependent domain metadata named "Element" valid at time DateStr<a name='4222'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4223'></font>
<font color=#447700>! Metadata of type logical are<a name='4224'></font>
<font color=#447700>! stored in array Data.<a name='4225'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4226'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4227'></font>
<font color=#447700>!<a name='4228'></font>
<font color=#447700>! This is not yet supported.<a name='4229'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4230'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4231'></font>
  IMPLICIT NONE<a name='4232'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4233'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4234'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4235'>
  logical                          :: Data(*)<a name='4236'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4237'>
  INTEGER                      :: OutCount<a name='4238'>
  INTEGER                     :: Status<a name='4239'>
#endif<a name='4240'>
RETURN<a name='4241'>
END SUBROUTINE wrf_quilt_get_dom_td_logical <a name='4242'>
<a name='4243'>
<A NAME='WRF_QUILT_PUT_DOM_TD_LOGICAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TD_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4244'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_logical</font> ( DataHandle,Element, DateStr,  Data, Count,  Status )<a name='4245'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4246'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4247'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4248'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4249'></font>
<font color=#447700>! Metadata of type logical are<a name='4250'></font>
<font color=#447700>! copied from array Data.<a name='4251'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4252'></font>
<font color=#447700>!<a name='4253'></font>
<font color=#447700>! This is not yet supported.<a name='4254'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4255'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4256'></font>
  IMPLICIT NONE<a name='4257'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4258'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4259'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4260'>
  logical ,            INTENT(IN) :: Data(*)<a name='4261'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4262'>
  INTEGER                     :: Status<a name='4263'>
#endif<a name='4264'>
RETURN<a name='4265'>
END SUBROUTINE wrf_quilt_put_dom_td_logical <a name='4266'>
<a name='4267'>
<A NAME='WRF_QUILT_GET_DOM_TD_CHAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_DOM_TD_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4268'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_dom_td_char</font> ( DataHandle,Element, DateStr,  Data,  Status )<a name='4269'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4270'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read time dependent<a name='4271'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4272'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4273'></font>
<font color=#447700>! Metadata of type char are<a name='4274'></font>
<font color=#447700>! stored in string Data.<a name='4275'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4276'></font>
<font color=#447700>!<a name='4277'></font>
<font color=#447700>! This is not yet supported.<a name='4278'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4279'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4280'></font>
  IMPLICIT NONE<a name='4281'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4282'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4283'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4284'>
  CHARACTER*(*)               :: Data<a name='4285'>
  INTEGER                     :: Status<a name='4286'>
#endif<a name='4287'>
RETURN<a name='4288'>
END SUBROUTINE wrf_quilt_get_dom_td_char <a name='4289'>
<a name='4290'>
<A NAME='WRF_QUILT_PUT_DOM_TD_CHAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_DOM_TD_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4291'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_dom_td_char</font> ( DataHandle,Element, DateStr,  Data,  Status )<a name='4292'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4293'></font>
<font color=#447700>! Instruct $he I/O quilt servers to write time dependent<a name='4294'></font>
<font color=#447700>! domain metadata named "Element" valid at time DateStr<a name='4295'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4296'></font>
<font color=#447700>! Metadata of type char are<a name='4297'></font>
<font color=#447700>! copied from string Data.<a name='4298'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4299'></font>
<font color=#447700>!<a name='4300'></font>
<font color=#447700>! This is not yet supported.<a name='4301'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4302'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4303'></font>
  IMPLICIT NONE<a name='4304'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4305'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4306'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4307'>
  CHARACTER*(*) , INTENT(IN) :: Data<a name='4308'>
  INTEGER                          :: Status<a name='4309'>
#endif<a name='4310'>
RETURN<a name='4311'>
END SUBROUTINE wrf_quilt_put_dom_td_char <a name='4312'>
<a name='4313'>
<A NAME='WRF_QUILT_GET_VAR_TI_REAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TI_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4314'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_real</font> ( DataHandle,Element,  Varname, Data, Count, Outcount, Status )<a name='4315'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4316'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4317'></font>
<font color=#447700>! independent attribute "Element" of variable "Varname"<a name='4318'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4319'></font>
<font color=#447700>! Attribute of type real is<a name='4320'></font>
<font color=#447700>! stored in array Data.<a name='4321'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4322'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4323'></font>
<font color=#447700>!<a name='4324'></font>
<font color=#447700>! This is not yet supported.<a name='4325'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4326'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4327'></font>
  IMPLICIT NONE<a name='4328'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4329'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4330'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4331'>
  real                          :: Data(*)<a name='4332'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4333'>
  INTEGER                     :: OutCount<a name='4334'>
  INTEGER                     :: Status<a name='4335'>
#endif<a name='4336'>
RETURN<a name='4337'>
END SUBROUTINE wrf_quilt_get_var_ti_real <a name='4338'>
<a name='4339'>
<A NAME='WRF_QUILT_PUT_VAR_TI_REAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4340'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_real</font> ( DataHandle,Element,  Varname, Data, Count,  Status )<a name='4341'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4342'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4343'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4344'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4345'></font>
<font color=#447700>! Attribute of type real is<a name='4346'></font>
<font color=#447700>! copied from array Data.<a name='4347'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4348'></font>
<font color=#447700>!<a name='4349'></font>
<font color=#447700>! This is not yet supported.<a name='4350'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4351'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4352'></font>
  IMPLICIT NONE<a name='4353'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4354'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4355'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4356'>
  real ,            INTENT(IN) :: Data(*)<a name='4357'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4358'>
  INTEGER                     :: Status<a name='4359'>
#endif<a name='4360'>
RETURN<a name='4361'>
END SUBROUTINE wrf_quilt_put_var_ti_real <a name='4362'>
<a name='4363'>
<A NAME='WRF_QUILT_GET_VAR_TI_DOUBLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TI_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4364'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_double</font> ( DataHandle,Element,  Varname, Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_VAR_TI_DOUBLE.html' TARGET='index'>2</A><a name='4365'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4366'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4367'></font>
<font color=#447700>! independent attribute "Element" of variable "Varname"<a name='4368'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4369'></font>
<font color=#447700>! Attribute of type double is<a name='4370'></font>
<font color=#447700>! stored in array Data.<a name='4371'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4372'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4373'></font>
<font color=#447700>!<a name='4374'></font>
<font color=#447700>! This is not yet supported.<a name='4375'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4376'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4377'></font>
  IMPLICIT NONE<a name='4378'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4379'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4380'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4381'>
  real*8                      :: Data(*)<a name='4382'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4383'>
  INTEGER                     :: OutCount<a name='4384'>
  INTEGER                     :: Status<a name='4385'>
#endif<a name='4386'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TI_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_355">('wrf_quilt_get_var_ti_double not supported yet')<a name='4387'>
RETURN<a name='4388'>
END SUBROUTINE wrf_quilt_get_var_ti_double <a name='4389'>
<a name='4390'>
<A NAME='WRF_QUILT_PUT_VAR_TI_DOUBLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4391'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_double</font> ( DataHandle,Element,  Varname, Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_VAR_TI_DOUBLE.html' TARGET='index'>2</A><a name='4392'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4393'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4394'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4395'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4396'></font>
<font color=#447700>! Attribute of type double is<a name='4397'></font>
<font color=#447700>! copied from array Data.<a name='4398'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4399'></font>
<font color=#447700>!<a name='4400'></font>
<font color=#447700>! This is not yet supported.<a name='4401'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4402'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4403'></font>
  IMPLICIT NONE<a name='4404'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4405'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4406'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4407'>
  real*8 ,        INTENT(IN) :: Data(*)<a name='4408'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4409'>
  INTEGER                     :: Status<a name='4410'>
#endif<a name='4411'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_356">('wrf_quilt_put_var_ti_double not supported yet')<a name='4412'>
RETURN<a name='4413'>
END SUBROUTINE wrf_quilt_put_var_ti_double <a name='4414'>
<a name='4415'>
<A NAME='WRF_QUILT_GET_VAR_TI_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TI_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4416'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_integer</font> ( DataHandle,Element,  Varname, Data, Count, Outcount, Status )<a name='4417'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4418'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4419'></font>
<font color=#447700>! independent attribute "Element" of variable "Varname"<a name='4420'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4421'></font>
<font color=#447700>! Attribute of type integer is<a name='4422'></font>
<font color=#447700>! stored in array Data.<a name='4423'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4424'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4425'></font>
<font color=#447700>!<a name='4426'></font>
<font color=#447700>! This is not yet supported.<a name='4427'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4428'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4429'></font>
  IMPLICIT NONE<a name='4430'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4431'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4432'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4433'>
  integer                     :: Data(*)<a name='4434'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4435'>
  INTEGER                     :: OutCount<a name='4436'>
  INTEGER                     :: Status<a name='4437'>
#endif<a name='4438'>
RETURN<a name='4439'>
END SUBROUTINE wrf_quilt_get_var_ti_integer <a name='4440'>
<a name='4441'>
<A NAME='WRF_QUILT_PUT_VAR_TI_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4442'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_integer</font> ( DataHandle,Element,  Varname, Data, Count,  Status )<a name='4443'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4444'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4445'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4446'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4447'></font>
<font color=#447700>! Attribute of type integer is<a name='4448'></font>
<font color=#447700>! copied from array Data.<a name='4449'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4450'></font>
<font color=#447700>!<a name='4451'></font>
<font color=#447700>! This is not yet supported.<a name='4452'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4453'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4454'></font>
  IMPLICIT NONE<a name='4455'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4456'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4457'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4458'>
  integer ,            INTENT(IN) :: Data(*)<a name='4459'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4460'>
  INTEGER                     :: Status<a name='4461'>
#endif<a name='4462'>
RETURN<a name='4463'>
END SUBROUTINE wrf_quilt_put_var_ti_integer <a name='4464'>
<a name='4465'>
<A NAME='WRF_QUILT_GET_VAR_TI_LOGICAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TI_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4466'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_logical</font> ( DataHandle,Element,  Varname, Data, Count, Outcount, Status )<a name='4467'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4468'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4469'></font>
<font color=#447700>! independent attribute "Element" of variable "Varname"<a name='4470'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4471'></font>
<font color=#447700>! Attribute of type logical is<a name='4472'></font>
<font color=#447700>! stored in array Data.<a name='4473'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4474'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4475'></font>
<font color=#447700>!<a name='4476'></font>
<font color=#447700>! This is not yet supported.<a name='4477'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4478'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4479'></font>
  IMPLICIT NONE<a name='4480'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4481'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4482'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4483'>
  logical                     :: Data(*)<a name='4484'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4485'>
  INTEGER                     :: OutCount<a name='4486'>
  INTEGER                     :: Status<a name='4487'>
#endif<a name='4488'>
RETURN<a name='4489'>
END SUBROUTINE wrf_quilt_get_var_ti_logical <a name='4490'>
<a name='4491'>
<A NAME='WRF_QUILT_PUT_VAR_TI_LOGICAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4492'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_logical</font> ( DataHandle,Element,  Varname, Data, Count,  Status )<a name='4493'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4494'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time independent<a name='4495'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4496'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4497'></font>
<font color=#447700>! Attribute of type logical is<a name='4498'></font>
<font color=#447700>! copied from array Data.<a name='4499'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4500'></font>
<font color=#447700>!<a name='4501'></font>
<font color=#447700>! This is not yet supported.<a name='4502'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4503'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4504'></font>
  IMPLICIT NONE<a name='4505'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4506'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4507'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4508'>
  logical ,            INTENT(IN) :: Data(*)<a name='4509'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4510'>
  INTEGER                     :: Status<a name='4511'>
#endif<a name='4512'>
RETURN<a name='4513'>
END SUBROUTINE wrf_quilt_put_var_ti_logical <a name='4514'>
<a name='4515'>
<A NAME='WRF_QUILT_GET_VAR_TI_CHAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TI_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4516'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_ti_char</font> ( DataHandle,Element,  Varname, Data,  Status )<a name='4517'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4518'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read time independent<a name='4519'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4520'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4521'></font>
<font color=#447700>! Attribute of type char is<a name='4522'></font>
<font color=#447700>! stored in string Data.<a name='4523'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4524'></font>
<font color=#447700>!<a name='4525'></font>
<font color=#447700>! This is not yet supported.<a name='4526'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4527'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4528'></font>
  IMPLICIT NONE<a name='4529'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4530'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4531'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4532'>
  CHARACTER*(*)               :: Data<a name='4533'>
  INTEGER                     :: Status<a name='4534'>
#endif<a name='4535'>
RETURN<a name='4536'>
END SUBROUTINE wrf_quilt_get_var_ti_char <a name='4537'>
<a name='4538'>
<A NAME='WRF_QUILT_PUT_VAR_TI_CHAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4539'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_ti_char</font> ( DataHandle,Element,  Varname, Data,  Status ),<A href='../../call_from/WRF_QUILT_PUT_VAR_TI_CHAR.html' TARGET='index'>16</A><a name='4540'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4541'></font>
<font color=#447700>! Instruct the I/O quilt servers to write time independent<a name='4542'></font>
<font color=#447700>! attribute "Element" of variable "Varname"<a name='4543'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4544'></font>
<font color=#447700>! Attribute of type char is<a name='4545'></font>
<font color=#447700>! copied from string Data.<a name='4546'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4547'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4548'></font>
<a name='4549'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4550'></font>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_38"><a name='4551'>
  IMPLICIT NONE<a name='4552'>
  INCLUDE 'mpif.h'<a name='4553'>
#include "<A href='../../html_code/include/intio_tags.h.html'>intio_tags.h</A>"<A NAME="intio_tags.h_18"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4554'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4555'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4556'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4557'>
  CHARACTER*(*) , INTENT(IN)  :: Data<a name='4558'>
  INTEGER                     :: Status<a name='4559'>
  INTEGER i, itypesize, tasks_in_group, ierr, comm_io_group<a name='4560'>
  REAL dummy<a name='4561'>
<font color=#447700>!<a name='4562'></font>
<a name='4563'>
<font color=#447700>!!JMTIMING  CALL start_timing<a name='4564'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_296"> ( DEBUG_LVL, 'in wrf_quilt_put_var_ti_char' ) <a name='4565'>
<a name='4566'>
  IF ( DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles ) THEN<a name='4567'>
    IF ( int_handle_in_use( DataHandle ) ) THEN<a name='4568'>
      CALL MPI_TYPE_SIZE( MPI_INTEGER, itypesize, ierr )<a name='4569'>
<a name='4570'>
#ifdef PNETCDF_QUILT<a name='4571'>
      IF ( compute_group_master(1) ) THEN<a name='4572'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_11">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='4573'>
                                      DataHandle, TRIM(Element),     &amp;<a name='4574'>
                                      TRIM(VarName), TRIM(Data), int_var_ti_char )<a name='4575'>
      ELSE<a name='4576'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_36">( hdrbuf, hdrbufsize, itypesize )<a name='4577'>
      ENDIF<a name='4578'>
#else<a name='4579'>
      IF ( wrf_dm_on_monitor() ) THEN<a name='4580'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_TI_HEADER_CHAR'>int_gen_ti_header_char</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_TI_HEADER_CHAR_12">( hdrbuf, hdrbufsize, itypesize, &amp;<a name='4581'>
                                      DataHandle, TRIM(Element),     &amp;<a name='4582'>
                                      TRIM(VarName), TRIM(Data), int_var_ti_char )<a name='4583'>
      ELSE<a name='4584'>
         CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_37">( hdrbuf, hdrbufsize, itypesize )<a name='4585'>
      ENDIF<a name='4586'>
#endif<a name='4587'>
<a name='4588'>
      iserver = get_server_id ( DataHandle )<a name='4589'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_21">( comm_io_group , iserver )<a name='4590'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='4591'>
<a name='4592'>
<font color=#447700>!!JMTIMING      CALL start_timing<a name='4593'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='4594'></font>
      reduced = 0<a name='4595'>
      reduced(1) = hdrbufsize <a name='4596'>
#ifdef PNETCDF_QUILT<a name='4597'>
      IF ( compute_group_master(1) ) reduced(2) = DataHandle<a name='4598'>
#else<a name='4599'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='4600'>
#endif<a name='4601'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='4602'>
<font color=#447700>!!JMTIMING       CALL end_timing("MPI_Reduce in wrf_quilt_put_var_ti_char")<a name='4603'></font>
      <font color=#447700>! send data to the i/o processor<a name='4604'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TI_CHAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_25">(__FILE__,__LINE__, comm_io_group,            &amp;<a name='4605'>
                            onebyte,                       &amp;<a name='4606'>
                            hdrbuf, hdrbufsize , &amp;<a name='4607'>
                            dummy, 0 )<a name='4608'>
    ENDIF<a name='4609'>
  ENDIF<a name='4610'>
<font color=#447700>!!JMTIMING   CALL end_timing("wrf_quilt_put_dom_ti_char" )<a name='4611'></font>
<a name='4612'>
#endif<a name='4613'>
RETURN<a name='4614'>
END SUBROUTINE wrf_quilt_put_var_ti_char <a name='4615'>
<a name='4616'>
<A NAME='WRF_QUILT_GET_VAR_TD_REAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TD_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4617'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_real</font> ( DataHandle,Element,  DateStr,Varname, Data, Count, Outcount, Status )<a name='4618'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4619'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4620'></font>
<font color=#447700>! dependent attribute "Element" of variable "Varname" valid at time DateStr<a name='4621'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4622'></font>
<font color=#447700>! Attribute of type real is<a name='4623'></font>
<font color=#447700>! stored in array Data.<a name='4624'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4625'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4626'></font>
<font color=#447700>!<a name='4627'></font>
<font color=#447700>! This is not yet supported.<a name='4628'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4629'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4630'></font>
  IMPLICIT NONE<a name='4631'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4632'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4633'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4634'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4635'>
  real                        :: Data(*)<a name='4636'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4637'>
  INTEGER                     :: OutCount<a name='4638'>
  INTEGER                     :: Status<a name='4639'>
#endif<a name='4640'>
RETURN<a name='4641'>
END SUBROUTINE wrf_quilt_get_var_td_real <a name='4642'>
<a name='4643'>
<A NAME='WRF_QUILT_PUT_VAR_TD_REAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TD_REAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4644'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_real</font> ( DataHandle,Element,  DateStr,Varname, Data, Count,  Status )<a name='4645'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4646'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4647'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4648'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4649'></font>
<font color=#447700>! Attribute of type real is<a name='4650'></font>
<font color=#447700>! copied from array Data.<a name='4651'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4652'></font>
<font color=#447700>!<a name='4653'></font>
<font color=#447700>! This is not yet supported.<a name='4654'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4655'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4656'></font>
  IMPLICIT NONE<a name='4657'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4658'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4659'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4660'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4661'>
  real ,            INTENT(IN) :: Data(*)<a name='4662'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4663'>
  INTEGER                     :: Status<a name='4664'>
#endif<a name='4665'>
RETURN<a name='4666'>
END SUBROUTINE wrf_quilt_put_var_td_real <a name='4667'>
<a name='4668'>
<A NAME='WRF_QUILT_GET_VAR_TD_DOUBLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TD_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4669'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_double</font> ( DataHandle,Element,  DateStr,Varname, Data, Count, Outcount, Status ),<A href='../../call_from/WRF_QUILT_GET_VAR_TD_DOUBLE.html' TARGET='index'>2</A><a name='4670'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4671'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4672'></font>
<font color=#447700>! dependent attribute "Element" of variable "Varname" valid at time DateStr<a name='4673'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4674'></font>
<font color=#447700>! Attribute of type double is<a name='4675'></font>
<font color=#447700>! stored in array Data.<a name='4676'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4677'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4678'></font>
<font color=#447700>!<a name='4679'></font>
<font color=#447700>! This is not yet supported.<a name='4680'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4681'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4682'></font>
  IMPLICIT NONE<a name='4683'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4684'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4685'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4686'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4687'>
  real*8                      :: Data(*)<a name='4688'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4689'>
  INTEGER                     :: OutCount<a name='4690'>
  INTEGER                     :: Status<a name='4691'>
#endif<a name='4692'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TD_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_357">('wrf_quilt_get_var_td_double not supported yet')<a name='4693'>
RETURN<a name='4694'>
END SUBROUTINE wrf_quilt_get_var_td_double <a name='4695'>
<a name='4696'>
<A NAME='WRF_QUILT_PUT_VAR_TD_DOUBLE'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TD_DOUBLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4697'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_double</font> ( DataHandle,Element,  DateStr,Varname, Data, Count,  Status ),<A href='../../call_from/WRF_QUILT_PUT_VAR_TD_DOUBLE.html' TARGET='index'>2</A><a name='4698'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4699'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4700'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4701'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4702'></font>
<font color=#447700>! Attribute of type double is<a name='4703'></font>
<font color=#447700>! copied from array Data.<a name='4704'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4705'></font>
<font color=#447700>!<a name='4706'></font>
<font color=#447700>! This is not yet supported.<a name='4707'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4708'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4709'></font>
  IMPLICIT NONE<a name='4710'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4711'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4712'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4713'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4714'>
  real*8 ,            INTENT(IN) :: Data(*)<a name='4715'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4716'>
  INTEGER                     :: Status<a name='4717'>
#endif<a name='4718'>
  CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TD_DOUBLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_358">('wrf_quilt_put_var_td_double not supported yet')<a name='4719'>
RETURN<a name='4720'>
END SUBROUTINE wrf_quilt_put_var_td_double <a name='4721'>
<a name='4722'>
<A NAME='WRF_QUILT_GET_VAR_TD_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4723'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_integer</font> ( DataHandle,Element,  DateStr,Varname, Data, Count, Outcount,Status)<a name='4724'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4725'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4726'></font>
<font color=#447700>! dependent attribute "Element" of variable "Varname" valid at time DateStr<a name='4727'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4728'></font>
<font color=#447700>! Attribute of type integer is<a name='4729'></font>
<font color=#447700>! stored in array Data.<a name='4730'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4731'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4732'></font>
<font color=#447700>!<a name='4733'></font>
<font color=#447700>! This is not yet supported.<a name='4734'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4735'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4736'></font>
  IMPLICIT NONE<a name='4737'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4738'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4739'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4740'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4741'>
  integer                     :: Data(*)<a name='4742'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4743'>
  INTEGER                     :: OutCount<a name='4744'>
  INTEGER                     :: Status<a name='4745'>
#endif<a name='4746'>
RETURN<a name='4747'>
END SUBROUTINE wrf_quilt_get_var_td_integer <a name='4748'>
<a name='4749'>
<A NAME='WRF_QUILT_PUT_VAR_TD_INTEGER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TD_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4750'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_integer</font> ( DataHandle,Element,  DateStr,Varname, Data, Count,  Status )<a name='4751'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4752'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4753'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4754'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4755'></font>
<font color=#447700>! Attribute of type integer is<a name='4756'></font>
<font color=#447700>! copied from array Data.<a name='4757'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4758'></font>
<font color=#447700>!<a name='4759'></font>
<font color=#447700>! This is not yet supported.<a name='4760'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4761'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4762'></font>
  IMPLICIT NONE<a name='4763'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4764'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4765'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4766'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4767'>
  integer ,       INTENT(IN)  :: Data(*)<a name='4768'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4769'>
  INTEGER                     :: Status<a name='4770'>
#endif<a name='4771'>
RETURN<a name='4772'>
END SUBROUTINE wrf_quilt_put_var_td_integer <a name='4773'>
<a name='4774'>
<A NAME='WRF_QUILT_GET_VAR_TD_LOGICAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TD_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4775'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_logical</font> ( DataHandle,Element,  DateStr,Varname, Data, Count, Outcount, Status )<a name='4776'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4777'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read Count words of time<a name='4778'></font>
<font color=#447700>! dependent attribute "Element" of variable "Varname" valid at time DateStr<a name='4779'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4780'></font>
<font color=#447700>! Attribute of type logical is<a name='4781'></font>
<font color=#447700>! stored in array Data.<a name='4782'></font>
<font color=#447700>! Actual number of words read is returned in OutCount.<a name='4783'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4784'></font>
<font color=#447700>!<a name='4785'></font>
<font color=#447700>! This is not yet supported.<a name='4786'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4787'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4788'></font>
  IMPLICIT NONE<a name='4789'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4790'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4791'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4792'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4793'>
  logical                          :: Data(*)<a name='4794'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4795'>
  INTEGER                      :: OutCount<a name='4796'>
  INTEGER                     :: Status<a name='4797'>
#endif<a name='4798'>
RETURN<a name='4799'>
END SUBROUTINE wrf_quilt_get_var_td_logical <a name='4800'>
<a name='4801'>
<A NAME='WRF_QUILT_PUT_VAR_TD_LOGICAL'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TD_LOGICAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4802'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_logical</font> ( DataHandle,Element,  DateStr,Varname, Data, Count,  Status )<a name='4803'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4804'></font>
<font color=#447700>! Instruct the I/O quilt servers to write Count words of time dependent<a name='4805'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4806'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4807'></font>
<font color=#447700>! Attribute of type logical is<a name='4808'></font>
<font color=#447700>! copied from array Data.<a name='4809'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4810'></font>
<font color=#447700>!<a name='4811'></font>
<font color=#447700>! This is not yet supported.<a name='4812'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4813'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4814'></font>
  IMPLICIT NONE<a name='4815'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4816'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4817'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4818'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4819'>
  logical ,            INTENT(IN) :: Data(*)<a name='4820'>
  INTEGER ,       INTENT(IN)  :: Count<a name='4821'>
  INTEGER                     :: Status<a name='4822'>
#endif<a name='4823'>
RETURN<a name='4824'>
END SUBROUTINE wrf_quilt_put_var_td_logical <a name='4825'>
<a name='4826'>
<A NAME='WRF_QUILT_GET_VAR_TD_CHAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_TD_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4827'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_td_char</font> ( DataHandle,Element,  DateStr,Varname, Data,  Status )<a name='4828'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4829'></font>
<font color=#447700>! Instruct the I/O quilt servers to attempt to read time dependent<a name='4830'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4831'></font>
<font color=#447700>! from the open dataset described by DataHandle.<a name='4832'></font>
<font color=#447700>! Attribute of type char is<a name='4833'></font>
<font color=#447700>! stored in string Data.<a name='4834'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4835'></font>
<font color=#447700>!<a name='4836'></font>
<font color=#447700>! This is not yet supported.<a name='4837'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4838'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4839'></font>
  IMPLICIT NONE<a name='4840'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4841'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4842'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4843'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4844'>
  CHARACTER*(*)               :: Data<a name='4845'>
  INTEGER                     :: Status<a name='4846'>
#endif<a name='4847'>
RETURN<a name='4848'>
END SUBROUTINE wrf_quilt_get_var_td_char <a name='4849'>
<a name='4850'>
<A NAME='WRF_QUILT_PUT_VAR_TD_CHAR'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_PUT_VAR_TD_CHAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4851'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_put_var_td_char</font> ( DataHandle,Element,  DateStr,Varname, Data,  Status )<a name='4852'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4853'></font>
<font color=#447700>! Instruct the I/O quilt servers to write time dependent<a name='4854'></font>
<font color=#447700>! attribute "Element" of variable "Varname" valid at time DateStr<a name='4855'></font>
<font color=#447700>! to the open dataset described by DataHandle.<a name='4856'></font>
<font color=#447700>! Attribute of type char is<a name='4857'></font>
<font color=#447700>! copied from string Data.<a name='4858'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4859'></font>
<font color=#447700>!<a name='4860'></font>
<font color=#447700>! This is not yet supported.<a name='4861'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4862'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4863'></font>
  IMPLICIT NONE<a name='4864'>
  INTEGER ,       INTENT(IN)  :: DataHandle<a name='4865'>
  CHARACTER*(*) , INTENT(IN)  :: Element<a name='4866'>
  CHARACTER*(*) , INTENT(IN)  :: DateStr<a name='4867'>
  CHARACTER*(*) , INTENT(IN)  :: VarName <a name='4868'>
  CHARACTER*(*) , INTENT(IN) :: Data<a name='4869'>
  INTEGER                    :: Status<a name='4870'>
#endif<a name='4871'>
RETURN<a name='4872'>
END SUBROUTINE wrf_quilt_put_var_td_char <a name='4873'>
<a name='4874'>
<A NAME='WRF_QUILT_READ_FIELD'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_READ_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4875'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_read_field</font> ( DataHandle , DateStr , VarName , Field , FieldType , Comm , IOComm, &amp;<a name='4876'>
                            DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='4877'>
                            DomainStart , DomainEnd ,                                    &amp;<a name='4878'>
                            MemoryStart , MemoryEnd ,                                    &amp;<a name='4879'>
                            PatchStart , PatchEnd ,                                      &amp;<a name='4880'>
                            Status )<a name='4881'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4882'></font>
<font color=#447700>! Instruct the I/O quilt servers to read the variable named VarName from the<a name='4883'></font>
<font color=#447700>! dataset pointed to by DataHandle.<a name='4884'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4885'></font>
<font color=#447700>!<a name='4886'></font>
<font color=#447700>! This is not yet supported.<a name='4887'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4888'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4889'></font>
  IMPLICIT NONE<a name='4890'>
  INTEGER ,       INTENT(IN)    :: DataHandle <a name='4891'>
  CHARACTER*(*) , INTENT(INOUT) :: DateStr<a name='4892'>
  CHARACTER*(*) , INTENT(INOUT) :: VarName<a name='4893'>
  INTEGER ,       INTENT(INOUT) :: Field(*)<a name='4894'>
  integer                       ,intent(in)    :: FieldType<a name='4895'>
  integer                       ,intent(inout) :: Comm<a name='4896'>
  integer                       ,intent(inout) :: IOComm<a name='4897'>
  integer                       ,intent(in)    :: DomainDesc<a name='4898'>
  character*(*)                 ,intent(in)    :: MemoryOrder<a name='4899'>
  character*(*)                 ,intent(in)    :: Stagger<a name='4900'>
  character*(*) , dimension (*) ,intent(in)    :: DimNames<a name='4901'>
  integer ,dimension(*)         ,intent(in)    :: DomainStart, DomainEnd<a name='4902'>
  integer ,dimension(*)         ,intent(in)    :: MemoryStart, MemoryEnd<a name='4903'>
  integer ,dimension(*)         ,intent(in)    :: PatchStart,  PatchEnd<a name='4904'>
  integer                       ,intent(out)   :: Status<a name='4905'>
  Status = 0<a name='4906'>
#endif<a name='4907'>
RETURN<a name='4908'>
END SUBROUTINE wrf_quilt_read_field<a name='4909'>
<a name='4910'>
<A NAME='WRF_QUILT_WRITE_FIELD'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4911'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_write_field</font> ( DataHandle , DateStr , VarName , Field , FieldType , Comm , IOComm,  &amp; <A href='../../call_to/WRF_QUILT_WRITE_FIELD.html' TARGET='index'>1</A>,<A href='../../call_from/WRF_QUILT_WRITE_FIELD.html' TARGET='index'>22</A><a name='4912'>
                             DomainDesc , MemoryOrder , Stagger , DimNames ,              &amp;<a name='4913'>
                             DomainStart , DomainEnd ,                                    &amp;<a name='4914'>
                             MemoryStart , MemoryEnd ,                                    &amp;<a name='4915'>
                             PatchStart , PatchEnd ,                                      &amp;<a name='4916'>
                             Status )<a name='4917'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4918'></font>
<font color=#447700>! Prepare instructions for the I/O quilt servers to write the variable named<a name='4919'></font>
<font color=#447700>! VarName to the dataset pointed to by DataHandle.<a name='4920'></font>
<font color=#447700>!<a name='4921'></font>
<font color=#447700>! During a "training" write this routine accumulates number and sizes of<a name='4922'></font>
<font color=#447700>! messages that will be sent to the I/O server associated with this compute<a name='4923'></font>
<font color=#447700>! (client) task.<a name='4924'></font>
<font color=#447700>!<a name='4925'></font>
<font color=#447700>! During a "real" write, this routine begins by allocating<a name='4926'></font>
<font color=#447700>! int_local_output_buffer if it has not already been allocated.  Sizes<a name='4927'></font>
<font color=#447700>! accumulated during "training" are used to determine how big<a name='4928'></font>
<font color=#447700>! int_local_output_buffer must be.  This routine then stores "int_field"<a name='4929'></font>
<font color=#447700>! headers and associated field data in int_local_output_buffer.  The contents<a name='4930'></font>
<font color=#447700>! of int_local_output_buffer are actually sent to the I/O quilt server in<a name='4931'></font>
<font color=#447700>! routine wrf_quilt_iosync().  This scheme allows output of multiple variables<a name='4932'></font>
<font color=#447700>! to be aggregated into a single "iosync" operation.<a name='4933'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='4934'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4935'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='4936'></font>
  USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_102"><a name='4937'>
  USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_39"><a name='4938'>
  IMPLICIT NONE<a name='4939'>
  INCLUDE 'mpif.h'<a name='4940'>
#include "<A href='../../html_code/include/wrf_io_flags.h.html'>wrf_io_flags.h</A>"<A NAME="wrf_io_flags.h_19"><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4941'>
  INTEGER ,       INTENT(IN)    :: DataHandle <a name='4942'>
  CHARACTER*(*) , INTENT(IN)    :: DateStr<a name='4943'>
  CHARACTER*(*) , INTENT(IN)    :: VarName<a name='4944'>
<font color=#447700>!  INTEGER ,       INTENT(IN)    :: Field(*)<a name='4945'></font>
  integer                       ,intent(in)    :: FieldType<a name='4946'>
  integer                       ,intent(inout) :: Comm<a name='4947'>
  integer                       ,intent(inout) :: IOComm<a name='4948'>
  integer                       ,intent(in)    :: DomainDesc<a name='4949'>
  character*(*)                 ,intent(in)    :: MemoryOrder<a name='4950'>
  character*(*)                 ,intent(in)    :: Stagger<a name='4951'>
  character*(*) , dimension (*) ,intent(in)    :: DimNames<a name='4952'>
  integer ,dimension(*)         ,intent(in)    :: DomainStart, DomainEnd<a name='4953'>
  integer ,dimension(*)         ,intent(in)    :: MemoryStart, MemoryEnd<a name='4954'>
  integer ,dimension(*)         ,intent(in)    :: PatchStart,  PatchEnd<a name='4955'>
  integer                       ,intent(out)   :: Status<a name='4956'>
<a name='4957'>
  integer ii,jj,kk,myrank<a name='4958'>
<a name='4959'>
  REAL, DIMENSION( MemoryStart(1):MemoryEnd(1), &amp;<a name='4960'>
                   MemoryStart(2):MemoryEnd(2), &amp;<a name='4961'>
                   MemoryStart(3):MemoryEnd(3) ) :: Field<a name='4962'>
  INTEGER locsize , typesize, itypesize<a name='4963'>
  INTEGER ierr, tasks_in_group, comm_io_group, dummy, i<a name='4964'>
  INTEGER, EXTERNAL :: use_package<a name='4965'>
<a name='4966'>
<font color=#447700>!!ARPTIMING  CALL start_timing<a name='4967'></font>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_297"> ( DEBUG_LVL, 'in wrf_quilt_write_field' ) <a name='4968'>
<a name='4969'>
  IF ( .NOT. (DataHandle .GE. 1 .AND. DataHandle .LE. int_num_handles) ) THEN<a name='4970'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_359">("frame/module_io_quilt.F: wrf_quilt_write_field: invalid data handle" )<a name='4971'>
  ENDIF<a name='4972'>
  IF ( .NOT. int_handle_in_use( DataHandle ) ) THEN<a name='4973'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_360">("frame/module_io_quilt.F: wrf_quilt_write_field: DataHandle not opened" )<a name='4974'>
  ENDIF<a name='4975'>
<a name='4976'>
  locsize = (PatchEnd(1)-PatchStart(1)+1)* &amp;<a name='4977'>
            (PatchEnd(2)-PatchStart(2)+1)* &amp;<a name='4978'>
            (PatchEnd(3)-PatchStart(3)+1)<a name='4979'>
<a name='4980'>
  CALL mpi_type_size( MPI_INTEGER, itypesize, ierr )<a name='4981'>
  <font color=#447700>! Note that the WRF_DOUBLE branch of this IF statement must come first since <a name='4982'></font>
  <font color=#447700>! WRF_FLOAT is set equal to WRF_DOUBLE during autopromotion builds.  <a name='4983'></font>
  IF ( FieldType .EQ. WRF_DOUBLE ) THEN<a name='4984'>
    CALL mpi_type_size( MPI_DOUBLE_PRECISION, typesize, ierr )<a name='4985'>
  ELSE IF ( FieldType .EQ. WRF_FLOAT ) THEN<a name='4986'>
    CALL mpi_type_size( MPI_REAL, typesize, ierr )<a name='4987'>
  ELSE IF ( FieldType .EQ. WRF_INTEGER ) THEN<a name='4988'>
    CALL mpi_type_size( MPI_INTEGER, typesize, ierr )<a name='4989'>
  ELSE IF ( FieldType .EQ. WRF_LOGICAL ) THEN<a name='4990'>
    CALL mpi_type_size( MPI_LOGICAL, typesize, ierr )<a name='4991'>
  ENDIF<a name='4992'>
<a name='4993'>
  IF ( .NOT. okay_to_write( DataHandle ) ) THEN<a name='4994'>
<a name='4995'>
      <font color=#447700>! This is a "training" write.<a name='4996'></font>
      <font color=#447700>! it is not okay to actually write; what we do here is just "bookkeep": count up<a name='4997'></font>
      <font color=#447700>! the number and size of messages that we will output to io server associated with<a name='4998'></font>
      <font color=#447700>! this task<a name='4999'></font>
<a name='5000'>
      CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_WRITE_FIELD_HEADER'>int_gen_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_WRITE_FIELD_HEADER_3"> ( hdrbuf, hdrbufsize, itypesize, typesize,           &amp;<a name='5001'>
                               DataHandle , DateStr , VarName , Field , FieldType , Comm , IOComm,  &amp;<a name='5002'>
                               333933         , MemoryOrder , Stagger , DimNames ,              &amp;   <font color=#447700>! 333933 means training; magic number<a name='5003'></font>
                               DomainStart , DomainEnd ,                                    &amp;<a name='5004'>
                               MemoryStart , MemoryEnd ,                                    &amp;<a name='5005'>
                               PatchStart , PatchEnd )<a name='5006'>
<a name='5007'>
      int_num_bytes_to_write(DataHandle) = int_num_bytes_to_write(DataHandle) + locsize * typesize + hdrbufsize<a name='5008'>
<a name='5009'>
      <font color=#447700>! Send the hdr for the write in case the interface is calling the I/O API in "learn" mode<a name='5010'></font>
<a name='5011'>
      iserver = get_server_id ( DataHandle )<a name='5012'>
<font color=#447700>!JMDEBUGwrite(0,*)'wrf_quilt_write_field (dryrun) ',iserver<a name='5013'></font>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS'>get_mpi_comm_io_groups</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_MPI_COMM_IO_GROUPS_22">( comm_io_group , iserver )<a name='5014'>
      <font color=#447700>! send the size of my local buffer to the i/o task (obufsize doesnt mean anything here)<a name='5015'></font>
<a name='5016'>
      CALL mpi_x_comm_size( comm_io_group , tasks_in_group , ierr )<a name='5017'>
<a name='5018'>
#if 0<a name='5019'>
      IF ( .NOT. wrf_dm_on_monitor() ) THEN     <font color=#447700>! only one task in compute grid sends this message; send noops on others<a name='5020'></font>
        CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_NOOP_HEADER'>int_gen_noop_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_NOOP_HEADER_38">( hdrbuf, hdrbufsize, itypesize )<a name='5021'>
      ENDIF<a name='5022'>
#endif<a name='5023'>
<a name='5024'>
<a name='5025'>
<font color=#447700>!!ARPTIMING      CALL start_timing<a name='5026'></font>
      <font color=#447700>! send the size of my local buffer to the i/o task (reduced_dummy doesnt mean anything on client side)<a name='5027'></font>
      reduced = 0<a name='5028'>
      reduced(1) = hdrbufsize <a name='5029'>
#ifdef PNETCDF_QUILT<a name='5030'>
      IF ( compute_group_master(1) ) reduced(2) = DataHandle<a name='5031'>
#else<a name='5032'>
      IF ( wrf_dm_on_monitor() )  reduced(2) = DataHandle<a name='5033'>
#endif<a name='5034'>
      CALL mpi_x_reduce( reduced, reduced_dummy, 2, MPI_INTEGER, MPI_SUM, tasks_in_group-1, comm_io_group, ierr )<a name='5035'>
<font color=#447700>!!ARPTIMING      CALL end_timing("MPI_Reduce in wrf_quilt_write_field dryrun")<a name='5036'></font>
      <font color=#447700>! send data to the i/o processor<a name='5037'></font>
<a name='5038'>
      CALL <A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG'>collect_on_comm_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLLECT_ON_COMM_DEBUG_26">(__FILE__,__LINE__, comm_io_group,                   &amp;<a name='5039'>
                            onebyte,                          &amp;<a name='5040'>
                            hdrbuf, hdrbufsize ,                 &amp;<a name='5041'>
                            dummy, 0 )<a name='5042'>
<a name='5043'>
  ELSE<a name='5044'>
<a name='5045'>
    IF ( .NOT. associated( int_local_output_buffer ) ) THEN<a name='5046'>
      ALLOCATE ( int_local_output_buffer( (int_num_bytes_to_write( DataHandle )+1)/itypesize ), Stat=ierr )<a name='5047'>
      IF(ierr /= 0)THEN<a name='5048'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_361">("frame/module_io_quilt.F: wrf_quilt_write_field: allocate of int_local_output_buffer failed" )<a name='5049'>
      END IF<a name='5050'>
      int_local_output_cursor = 1<a name='5051'>
    ENDIF<a name='5052'>
      iserver = get_server_id ( DataHandle )<a name='5053'>
<font color=#447700>!JMDEBUGwrite(0,*)'wrf_quilt_write_field (writing) ',iserver<a name='5054'></font>
<a name='5055'>
    <font color=#447700>! This is NOT a "training" write.  It is OK to write now.<a name='5056'></font>
    CALL <A href='../../html_code/frame/module_internal_header_util.F.html#INT_GEN_WRITE_FIELD_HEADER'>int_gen_write_field_header</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_WRITE_FIELD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INT_GEN_WRITE_FIELD_HEADER_4"> ( hdrbuf, hdrbufsize, itypesize, typesize,           &amp;<a name='5057'>
                             DataHandle , DateStr , VarName , Field , FieldType , Comm , IOComm,  &amp;<a name='5058'>
                             0          , MemoryOrder , Stagger , DimNames ,              &amp;   <font color=#447700>! non-333933 means okay to write; magic number<a name='5059'></font>
                             DomainStart , DomainEnd ,                                    &amp;<a name='5060'>
                             MemoryStart , MemoryEnd ,                                    &amp;<a name='5061'>
                             PatchStart , PatchEnd )<a name='5062'>
<a name='5063'>
    <font color=#447700>! Pack header into int_local_output_buffer.  It will be sent to the <a name='5064'></font>
    <font color=#447700>! I/O servers during the next "iosync" operation.  <a name='5065'></font>
#ifdef DEREF_KLUDGE<a name='5066'>
    CALL int_pack_data ( hdrbuf , hdrbufsize , int_local_output_buffer(1), int_local_output_cursor )<a name='5067'>
#else<a name='5068'>
    CALL int_pack_data ( hdrbuf , hdrbufsize , int_local_output_buffer, int_local_output_cursor )<a name='5069'>
#endif<a name='5070'>
<a name='5071'>
    <font color=#447700>! Pack field data into int_local_output_buffer.  It will be sent to the <a name='5072'></font>
    <font color=#447700>! I/O servers during the next "iosync" operation.  <a name='5073'></font>
#ifdef DEREF_KLUDGE<a name='5074'>
    CALL int_pack_data ( Field(PatchStart(1):PatchEnd(1),PatchStart(2):PatchEnd(2),PatchStart(3):PatchEnd(3) ), &amp;<a name='5075'>
                                  locsize * typesize , int_local_output_buffer(1), int_local_output_cursor )<a name='5076'>
#else<a name='5077'>
    CALL int_pack_data ( Field(PatchStart(1):PatchEnd(1),PatchStart(2):PatchEnd(2),PatchStart(3):PatchEnd(3) ), &amp;<a name='5078'>
                                  locsize * typesize , int_local_output_buffer, int_local_output_cursor )<a name='5079'>
#endif<a name='5080'>
<a name='5081'>
  ENDIF<a name='5082'>
  Status = 0<a name='5083'>
<font color=#447700>!!ARPTIMING  CALL end_timing("wrf_quilt_write_field")<a name='5084'></font>
<a name='5085'>
#endif<a name='5086'>
  RETURN<a name='5087'>
END SUBROUTINE wrf_quilt_write_field<a name='5088'>
<a name='5089'>
<A NAME='WRF_QUILT_GET_VAR_INFO'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_GET_VAR_INFO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5090'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_quilt_get_var_info</font> ( DataHandle , VarName , NDim , MemoryOrder , Stagger , &amp; <A href='../../call_to/WRF_QUILT_GET_VAR_INFO.html' TARGET='index'>1</A><a name='5091'>
                              DomainStart , DomainEnd , Status )<a name='5092'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5093'></font>
<font color=#447700>! This routine applies only to a dataset that is open for read.  It instructs<a name='5094'></font>
<font color=#447700>! the I/O quilt servers to return information about variable VarName.<a name='5095'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='5096'></font>
<font color=#447700>!<a name='5097'></font>
<font color=#447700>! This is not yet supported.<a name='5098'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5099'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5100'></font>
  IMPLICIT NONE<a name='5101'>
  integer               ,intent(in)     :: DataHandle<a name='5102'>
  character*(*)         ,intent(in)     :: VarName<a name='5103'>
  integer                               :: NDim<a name='5104'>
  character*(*)                         :: MemoryOrder<a name='5105'>
  character*(*)                         :: Stagger<a name='5106'>
  integer ,dimension(*)                 :: DomainStart, DomainEnd<a name='5107'>
  integer                               :: Status<a name='5108'>
#endif<a name='5109'>
RETURN<a name='5110'>
END SUBROUTINE wrf_quilt_get_var_info<a name='5111'>
<a name='5112'>
<A NAME='WRF_QUILT_FIND_SERVER'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5113'>
<font color=#993300>subroutine </font><font color=#cc0000>wrf_quilt_find_server</font>(iserver) <A href='../../call_to/WRF_QUILT_FIND_SERVER.html' TARGET='index'>4</A>,<A href='../../call_from/WRF_QUILT_FIND_SERVER.html' TARGET='index'>10</A><a name='5114'>
<a name='5115'>
  <font color=#447700>! This routine is called by the compute processes when they need an<a name='5116'></font>
  <font color=#447700>! I/O server to write out a new file.  Upon return, this routine will<a name='5117'></font>
  <font color=#447700>! set iserver to the next available I/O server group.  <a name='5118'></font>
<a name='5119'>
  <font color=#447700>! A mpi_recv to all of mpi_comm_avail is used to implement this, and<a name='5120'></font>
  <font color=#447700>! that recv will not return until an I/O server group calls<a name='5121'></font>
  <font color=#447700>! wrf_quilt_server_ready to signal that it is ready for a new file.<a name='5122'></font>
<a name='5123'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5124'></font>
  use <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_40">, only : in_avail, mpi_comm_avail, mpi_comm_local<a name='5125'>
<a name='5126'>
  implicit none<a name='5127'>
  INCLUDE 'mpif.h'<a name='5128'>
  integer, intent(inout) :: iserver<a name='5129'>
  integer :: ierr<a name='5130'>
  character(255) :: message<a name='5131'>
<a name='5132'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_362">('Polling I/O servers...')<a name='5133'>
<a name='5134'>
  if(in_avail) then<a name='5135'>
     call mpi_recv(iserver,1,MPI_INTEGER,MPI_ANY_SOURCE,0,mpi_comm_avail,MPI_STATUS_IGNORE,ierr)<a name='5136'>
     if(ierr/=0) then<a name='5137'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_362">('mpi_recv failed in wrf_quilt_find_server')<a name='5138'>
     endif<a name='5139'>
  endif<a name='5140'>
<a name='5141'>
  call mpi_bcast(iserver,1,MPI_INTEGER,0,mpi_comm_local,ierr)<a name='5142'>
  if(ierr/=0) then<a name='5143'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_363">('mpi_bcast failed in wrf_quilt_find_server')<a name='5144'>
  endif<a name='5145'>
<a name='5146'>
  write(message,'("I/O server ",I0," is ready for operations.")') iserver<a name='5147'>
  call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_FIND_SERVER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_363">(message)<a name='5148'>
<a name='5149'>
#endif<a name='5150'>
<a name='5151'>
end subroutine wrf_quilt_find_server<a name='5152'>
<A NAME='WRF_QUILT_SERVER_READY'><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5153'>
<font color=#993300>subroutine </font><font color=#cc0000>wrf_quilt_server_ready</font>() <A href='../../call_to/WRF_QUILT_SERVER_READY.html' TARGET='index'>2</A>,<A href='../../call_from/WRF_QUILT_SERVER_READY.html' TARGET='index'>14</A><a name='5154'>
<a name='5155'>
  <font color=#447700>! This routine is called by the I/O server group's master process once the<a name='5156'></font>
  <font color=#447700>! I/O server group is done writing its current file, and is waiting for<a name='5157'></font>
  <font color=#447700>! a new one.  This information is passed to the monitor process by a <a name='5158'></font>
  <font color=#447700>! blocking send from the I/O server master process to the monitor.  <a name='5159'></font>
<a name='5160'>
  <font color=#447700>! All processes in an I/O group must call this routine, and this routine<a name='5161'></font>
  <font color=#447700>! will not return (in any process) until the monitor process signals <a name='5162'></font>
  <font color=#447700>! that it wants the I/O server group to write a file.  That signal is<a name='5163'></font>
  <font color=#447700>! sent in a call to wrf_quilt_find_server on the compute processes.<a name='5164'></font>
<a name='5165'>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5166'></font>
  use <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_41">, only : mpi_comm_local, in_avail, availrank, mpi_comm_avail<a name='5167'>
<a name='5168'>
  implicit none<a name='5169'>
  INCLUDE 'mpif.h'<a name='5170'>
  integer :: ierr<a name='5171'>
  character*255 :: message<a name='5172'>
<a name='5173'>
  write(message,*) 'Entering wrf_quilt_server_ready.'<a name='5174'>
  call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_298">(1,message)<a name='5175'>
<a name='5176'>
  call mpi_barrier(mpi_comm_local,ierr)<a name='5177'>
  if(ierr/=0) then<a name='5178'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_364">('mpi_barrier failed in wrf_quilt_server_ready')<a name='5179'>
  endif<a name='5180'>
<a name='5181'>
  if(in_avail) then<a name='5182'>
     write(message,'("mpi_ssend ioserver=",I0," in wrf_quilt_server_ready")') availrank<a name='5183'>
     call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_299">(1,message)<a name='5184'>
     call mpi_ssend(availrank,1,MPI_INTEGER,0,0,mpi_comm_avail,ierr)<a name='5185'>
     if(ierr/=0) then<a name='5186'>
        call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_365">('mpi_ssend failed in wrf_quilt_server_ready')<a name='5187'>
     endif<a name='5188'>
  endif<a name='5189'>
<a name='5190'>
  call mpi_barrier(mpi_comm_local,ierr)<a name='5191'>
  if(ierr/=0) then<a name='5192'>
     call <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_366">('mpi_barrier failed in wrf_quilt_server_ready')<a name='5193'>
  endif<a name='5194'>
<a name='5195'>
  write(message,*) 'Leaving wrf_quilt_server_ready.'<a name='5196'>
  call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/frame/module_io_quilt_old.F.html#WRF_QUILT_SERVER_READY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_300">(1,message)<a name='5197'>
#endif<a name='5198'>
<a name='5199'>
end subroutine wrf_quilt_server_ready<a name='5200'>
<a name='5201'>
<A NAME='GET_MPI_COMM_IO_GROUPS'><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5202'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>get_mpi_comm_io_groups</font>( retval, isrvr ) <A href='../../call_to/GET_MPI_COMM_IO_GROUPS.html' TARGET='index'>22</A>,<A href='../../call_from/GET_MPI_COMM_IO_GROUPS.html' TARGET='index'>3</A><a name='5203'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5204'></font>
<font color=#447700>! This routine returns the compute+io communicator to which this<a name='5205'></font>
<font color=#447700>! compute task belongs for I/O server group "isrvr".<a name='5206'></font>
<font color=#447700>! This routine is called only by client (compute) tasks.  <a name='5207'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5208'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5209'></font>
      USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_MPI_COMM_IO_GROUPS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_42"><a name='5210'>
      IMPLICIT NONE<a name='5211'>
      INTEGER, INTENT(IN ) :: isrvr<a name='5212'>
      INTEGER, INTENT(OUT) :: retval<a name='5213'>
      retval = mpi_comm_io_groups(isrvr)<a name='5214'>
#endif<a name='5215'>
      RETURN<a name='5216'>
END SUBROUTINE get_mpi_comm_io_groups<a name='5217'>
<a name='5218'>
<A NAME='GET_NIO_TASKS_IN_GROUP'><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_NIO_TASKS_IN_GROUP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5219'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>get_nio_tasks_in_group</font>( id, retval ) <A href='../../call_to/GET_NIO_TASKS_IN_GROUP.html' TARGET='index'>1</A>,<A href='../../call_from/GET_NIO_TASKS_IN_GROUP.html' TARGET='index'>2</A><a name='5220'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5221'></font>
<font color=#447700>! This routine returns the number of I/O server tasks in each <a name='5222'></font>
<font color=#447700>! I/O server group.  It can be called by both clients and <a name='5223'></font>
<font color=#447700>! servers.  <a name='5224'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5225'></font>
#if defined( DM_PARALLEL ) &amp;&amp; <font color=#447700>!defined( STUBMPI )<a name='5226'></font>
      USE <A href='../../html_code/frame/module_io_quilt_old.F.html#MODULE_WRF_QUILT'>module_wrf_quilt</A><A href='../../html_code/frame/module_io_quilt_old.F.html#GET_NIO_TASKS_IN_GROUP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_QUILT_43"><a name='5227'>
      IMPLICIT NONE<a name='5228'>
      INTEGER, INTENT(IN)  :: id<a name='5229'>
      INTEGER, INTENT(OUT) :: retval<a name='5230'>
      retval = nio_tasks_in_group<a name='5231'>
#endif<a name='5232'>
      RETURN<a name='5233'>
END SUBROUTINE get_nio_tasks_in_group<a name='5234'>
<a name='5235'>
<A NAME='COLLECT_ON_COMM_DEBUG'><A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5236'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>collect_on_comm_debug</font>(file,line, comm_io_group,   &amp; <A href='../../call_to/COLLECT_ON_COMM_DEBUG.html' TARGET='index'>26</A><a name='5237'>
                        sze,                                 &amp;<a name='5238'>
                        hdrbuf, hdrbufsize ,                 &amp;<a name='5239'>
                        outbuf, outbufsize                   )<a name='5240'>
  IMPLICIT NONE<a name='5241'>
  CHARACTER*(*) file<a name='5242'>
  INTEGER line<a name='5243'>
  INTEGER comm_io_group<a name='5244'>
  INTEGER sze<a name='5245'>
  INTEGER hdrbuf(*), outbuf(*)<a name='5246'>
  INTEGER hdrbufsize, outbufsize <a name='5247'>
<a name='5248'>
  CALL collect_on_comm( comm_io_group,                       &amp;<a name='5249'>
                        sze,                                 &amp;<a name='5250'>
                        hdrbuf, hdrbufsize ,                 &amp;<a name='5251'>
                        outbuf, outbufsize                   )<a name='5252'>
  RETURN<a name='5253'>
END<a name='5254'>
<a name='5255'>
<a name='5256'>
<A NAME='COLLECT_ON_COMM_DEBUG2'><A href='../../html_code/frame/module_io_quilt_old.F.html#COLLECT_ON_COMM_DEBUG2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5257'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>collect_on_comm_debug2</font>(file,line,var,tag,sz,hdr_rec_size, &amp; <A href='../../call_to/COLLECT_ON_COMM_DEBUG2.html' TARGET='index'>2</A><a name='5258'>
                        comm_io_group,                       &amp;<a name='5259'>
                        sze,                                 &amp;<a name='5260'>
                        hdrbuf, hdrbufsize ,                 &amp;<a name='5261'>
                        outbuf, outbufsize                   )<a name='5262'>
  IMPLICIT NONE<a name='5263'>
  CHARACTER*(*) file,var<a name='5264'>
  INTEGER line,tag,sz,hdr_rec_size<a name='5265'>
  INTEGER comm_io_group<a name='5266'>
  INTEGER sze<a name='5267'>
  INTEGER hdrbuf(*), outbuf(*)<a name='5268'>
  INTEGER hdrbufsize, outbufsize<a name='5269'>
<a name='5270'>
  CALL collect_on_comm( comm_io_group,                       &amp;<a name='5271'>
                        sze,                                 &amp;<a name='5272'>
                        hdrbuf, hdrbufsize ,                 &amp;<a name='5273'>
                        outbuf, outbufsize                   )<a name='5274'>
  RETURN<a name='5275'>
END<a name='5276'>
</pre></body></html>