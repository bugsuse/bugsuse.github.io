<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>! careful adding any HYBRID_COORD stuff in here, adjust_tempqv has<a name='2'></font>
<font color=#447700>! c3 and c4 to compute pressure with two reference pressures<a name='3'></font>
<a name='4'>
<A NAME='INIT_DOMAIN_CONSTANTS_EM'><A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_CONSTANTS_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>init_domain_constants_em</font> ( parent , nest ) <A href='../../call_to/INIT_DOMAIN_CONSTANTS_EM.html' TARGET='index'>2</A>,<A href='../../call_from/INIT_DOMAIN_CONSTANTS_EM.html' TARGET='index'>1</A><a name='6'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_CONSTANTS_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_18">, ONLY : domain<a name='7'>
   IMPLICIT NONE<a name='8'>
   TYPE(domain)  :: parent , nest<a name='9'>
<a name='10'>
   INTEGER iswater, islake, isice, isurban, isoilwater, map_proj, julyr, julday<a name='11'>
   REAL    truelat1 , truelat2 , gmt , moad_cen_lat , stand_lon, pole_lat, pole_lon<a name='12'>
   CHARACTER (LEN=256) :: char_junk<a name='13'>
<a name='14'>
<font color=#447700>! single-value constants<a name='15'></font>
<a name='16'>
   nest%p_top   = parent%p_top<a name='17'>
   nest%save_topo_from_real   = parent%save_topo_from_real<a name='18'>
   nest%cfn     = parent%cfn<a name='19'>
   nest%cfn1    = parent%cfn1<a name='20'>
   nest%rdx     = 1./nest%dx<a name='21'>
   nest%rdy     = 1./nest%dy<a name='22'>
<font color=#447700>!  nest%dts     = nest%dt/float(nest%time_step_sound)<a name='23'></font>
   nest%dtseps  = parent%dtseps  <font color=#447700>! used in height model only?<a name='24'></font>
   nest%resm    = parent%resm    <font color=#447700>! used in height model only?<a name='25'></font>
   nest%zetatop = parent%zetatop <font color=#447700>! used in height model only?<a name='26'></font>
   nest%cf1     = parent%cf1<a name='27'>
   nest%cf2     = parent%cf2<a name='28'>
   nest%cf3     = parent%cf3<a name='29'>
   nest%gmt     = parent%gmt<a name='30'>
   nest%julyr   = parent%julyr<a name='31'>
   nest%julday  = parent%julday<a name='32'>
   nest%iswater = parent%iswater<a name='33'>
   nest%isice   = parent%isice<a name='34'>
   nest%isurban = parent%isurban<a name='35'>
   nest%islake  = parent%islake<a name='36'>
   nest%isoilwater = parent%isoilwater<a name='37'>
   nest%mminlu  = trim(parent%mminlu)<a name='38'>
   nest%tiso    = parent%tiso<a name='39'>
   nest%tlp     = parent%tlp<a name='40'>
   nest%p00     = parent%p00<a name='41'>
   nest%t00     = parent%t00<a name='42'>
   nest%tlp_strat= parent%tlp_strat<a name='43'>
   nest%p_strat = parent%p_strat<a name='44'>
<font color=#447700>!cyl: variables for trajectory /float<a name='45'></font>
   nest%traj_k = parent%traj_k<a name='46'>
   nest%traj_long = parent%traj_long<a name='47'>
   nest%traj_lat = parent%traj_lat<a name='48'>
   nest%this_is_an_ideal_run = parent%this_is_an_ideal_run<a name='49'>
   nest%lake_depth_flag = parent%lake_depth_flag<a name='50'>
<a name='51'>
   CALL nl_get_mminlu ( 1, char_junk )<a name='52'>
   CALL nl_get_iswater( 1, iswater )<a name='53'>
   CALL nl_get_islake ( 1, islake )<a name='54'>
   CALL nl_get_isice  ( 1, isice )<a name='55'>
   CALL nl_get_isurban( 1, isurban )<a name='56'>
   CALL nl_get_isoilwater(1, isoilwater )<a name='57'>
   CALL nl_get_truelat1 ( 1 , truelat1 )<a name='58'>
   CALL nl_get_truelat2 ( 1 , truelat2 )<a name='59'>
   CALL nl_get_moad_cen_lat ( 1 , moad_cen_lat )<a name='60'>
   CALL nl_get_stand_lon ( 1 , stand_lon )<a name='61'>
   CALL nl_get_pole_lat ( 1 , pole_lat )<a name='62'>
   CALL nl_get_pole_lon ( 1 , pole_lon )<a name='63'>
   CALL nl_get_map_proj ( 1 , map_proj )<a name='64'>
   CALL nl_get_gmt ( 1 , gmt)<a name='65'>
   CALL nl_get_julyr ( 1 , julyr)<a name='66'>
   CALL nl_get_julday ( 1 , julday)<a name='67'>
   IF ( nest%id .NE. 1 ) THEN<a name='68'>
     CALL nl_set_gmt (nest%id, gmt)<a name='69'>
     CALL nl_set_julyr (nest%id, julyr)<a name='70'>
     CALL nl_set_julday (nest%id, julday)<a name='71'>
     CALL nl_set_iswater ( nest%id, iswater )<a name='72'>
     CALL nl_set_islake  ( nest%id, islake )<a name='73'>
     CALL nl_set_isice   ( nest%id, isice )<a name='74'>
     CALL nl_set_isurban ( nest%id, isurban )<a name='75'>
     CALL nl_set_isoilwater ( nest%id, isoilwater )<a name='76'>
     CALL nl_set_mminlu ( nest%id, char_junk )<a name='77'>
     CALL nl_set_truelat1 ( nest%id , truelat1 )<a name='78'>
     CALL nl_set_truelat2 ( nest%id , truelat2 )<a name='79'>
     CALL nl_set_moad_cen_lat ( nest%id , moad_cen_lat )<a name='80'>
     CALL nl_set_stand_lon ( nest%id , stand_lon )<a name='81'>
     CALL nl_set_pole_lat ( nest%id , pole_lat )<a name='82'>
     CALL nl_set_pole_lon ( nest%id , pole_lon )<a name='83'>
     CALL nl_set_map_proj ( nest%id , map_proj )<a name='84'>
   END IF<a name='85'>
   nest%gmt     = gmt<a name='86'>
   nest%julday  = julday<a name='87'>
   nest%julyr   = julyr<a name='88'>
   nest%iswater = iswater<a name='89'>
   nest%islake  = islake<a name='90'>
   nest%isice   = isice<a name='91'>
   nest%isoilwater = isoilwater<a name='92'>
   nest%mminlu  = trim(char_junk)<a name='93'>
   nest%truelat1= truelat1<a name='94'>
   nest%truelat2= truelat2<a name='95'>
   nest%moad_cen_lat= moad_cen_lat<a name='96'>
   nest%stand_lon= stand_lon<a name='97'>
   nest%pole_lat= pole_lat<a name='98'>
   nest%pole_lon= pole_lon<a name='99'>
   nest%map_proj= map_proj<a name='100'>
<a name='101'>
   nest%step_number  = parent%step_number<a name='102'>
<a name='103'>
<font color=#447700>! 1D constants (Z)<a name='104'></font>
<a name='105'>
<font color=#447700>!DAVE - maybe test if vert_nest instead<a name='106'></font>
<font color=#447700>!  IF  ( parent%e_vert .EQ. nest%e_vert ) THEN<a name='107'></font>
      nest%fnm(1:parent%e_vert)       = parent%fnm(1:parent%e_vert)<a name='108'>
      nest%fnp(1:parent%e_vert)       = parent%fnp(1:parent%e_vert)<a name='109'>
      nest%rdnw(1:parent%e_vert)      = parent%rdnw(1:parent%e_vert)<a name='110'>
      nest%rdn(1:parent%e_vert)       = parent%rdn(1:parent%e_vert)<a name='111'>
      nest%dnw(1:parent%e_vert)       = parent%dnw(1:parent%e_vert)<a name='112'>
      nest%dn(1:parent%e_vert)        = parent%dn(1:parent%e_vert)<a name='113'>
      nest%znu(1:parent%e_vert)       = parent%znu(1:parent%e_vert)<a name='114'>
      nest%znw(1:parent%e_vert)       = parent%znw(1:parent%e_vert)<a name='115'>
      nest%t_base(1:parent%e_vert)    = parent%t_base(1:parent%e_vert)<a name='116'>
      nest%u_base(1:parent%e_vert)    = parent%u_base(1:parent%e_vert)<a name='117'>
      nest%v_base(1:parent%e_vert)    = parent%v_base(1:parent%e_vert)<a name='118'>
      nest%qv_base(1:parent%e_vert)   = parent%qv_base(1:parent%e_vert)<a name='119'>
      nest%z_base(1:parent%e_vert)    = parent%z_base(1:parent%e_vert)<a name='120'>
      nest%c1h(1:parent%e_vert)       = parent%c1h(1:parent%e_vert)<a name='121'>
      nest%c2h(1:parent%e_vert)       = parent%c2h(1:parent%e_vert)<a name='122'>
      nest%c3h(1:parent%e_vert)       = parent%c3h(1:parent%e_vert)<a name='123'>
      nest%c4h(1:parent%e_vert)       = parent%c4h(1:parent%e_vert)<a name='124'>
      nest%c1f(1:parent%e_vert)       = parent%c1f(1:parent%e_vert)<a name='125'>
      nest%c2f(1:parent%e_vert)       = parent%c2f(1:parent%e_vert)<a name='126'>
      nest%c3f(1:parent%e_vert)       = parent%c3f(1:parent%e_vert)<a name='127'>
      nest%c4f(1:parent%e_vert)       = parent%c4f(1:parent%e_vert)<a name='128'>
<font color=#447700>!  END IF<a name='129'></font>
<a name='130'>
   nest%dzs       = parent%dzs<a name='131'>
   nest%zs        = parent%zs<a name='132'>
<a name='133'>
END SUBROUTINE init_domain_constants_em<a name='134'>
<a name='135'>
<a name='136'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='137'></font>
<a name='138'>
<A NAME='INIT_DOMAIN_VERT_NESTING'><A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_VERT_NESTING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='139'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>init_domain_vert_nesting</font> ( parent, nest, use_baseparam_fr_nml ) <A href='../../call_to/INIT_DOMAIN_VERT_NESTING.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_DOMAIN_VERT_NESTING.html' TARGET='index'>5</A><a name='140'>
<a name='141'>
<font color=#447700>!KAL this is a driver to initialize the vertical coordinates for the nest when vertical nesting is used<a name='142'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_VERT_NESTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_19"><a name='143'>
   IMPLICIT NONE<a name='144'>
   TYPE(domain), POINTER                      :: parent, nest<a name='145'>
   LOGICAL                                    :: use_baseparam_fr_nml<a name='146'>
   <font color=#447700>!local<a name='147'></font>
   REAL, DIMENSION(parent%e_vert)             :: znw_c<a name='148'>
<a name='149'>
   INTERFACE<a name='150'>
<a name='151'>
      SUBROUTINE vert_cor_vertical_nesting_integer(nest,znw_c,k_dim_c)<a name='152'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_VERT_NESTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_20"><a name='153'>
         TYPE(domain), POINTER :: nest<a name='154'>
         integer , intent(in) :: k_dim_c<a name='155'>
         real , dimension(k_dim_c), INTENT(IN) :: znw_c<a name='156'>
      END SUBROUTINE vert_cor_vertical_nesting_integer<a name='157'>
<a name='158'>
      SUBROUTINE vert_cor_vertical_nesting_arbitrary(nest,znw_c,kde_c,use_baseparam_fr_nml)<a name='159'>
          USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_VERT_NESTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_21"><a name='160'>
          TYPE(domain), POINTER :: nest<a name='161'>
          INTEGER, INTENT(IN   ) :: kde_c<a name='162'>
          REAL, DIMENSION(kde_c), INTENT(IN   ) :: znw_c<a name='163'>
          LOGICAL, INTENT(IN   ) :: use_baseparam_fr_nml<a name='164'>
      END SUBROUTINE vert_cor_vertical_nesting_arbitrary<a name='165'>
      <a name='166'>
   END INTERFACE<a name='167'>
<a name='168'>
   <a name='169'>
   <font color=#447700>! save the coarse grid values here<a name='170'></font>
   <a name='171'>
   znw_c = nest%znw(1:parent%e_vert)<a name='172'>
   <a name='173'>
   <font color=#447700>! calculate the nest (fine) grid values here<a name='174'></font>
   <font color=#447700>! one of these calls goes to integer refinement in the vertical direction, and one goes to arbitrary refinement.  Eventually the call to integer refinement will be obsolete. <a name='175'></font>
   if (nest%vert_refine_method .EQ. 1) then  <font color=#447700>!if you are in this subroutine there is vertical nesting- (i.e. nest%e_vert /= parent%e_vert to enter this subroutine)<a name='176'></font>
      CALL <A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_INTEGER'>vert_cor_vertical_nesting_integer</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_VERT_NESTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_COR_VERTICAL_NESTING_INTEGER_1">(nest,znw_c,parent%e_vert)<a name='177'>
   elseif (nest%vert_refine_method .EQ. 2) then<a name='178'>
      CALL <A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY'>vert_cor_vertical_nesting_arbitrary</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INIT_DOMAIN_VERT_NESTING' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERT_COR_VERTICAL_NESTING_ARBITRARY_1">(nest,znw_c,parent%e_vert,use_baseparam_fr_nml)<a name='179'>
   endif<a name='180'>
<a name='181'>
END SUBROUTINE init_domain_vert_nesting<a name='182'>
<a name='183'>
<font color=#447700>!-----------------------------------------------------------------------------------------<a name='184'></font>
<a name='185'>
<a name='186'>
<font color=#447700>!this is a direct copy of a subroutine that is in ndown, but I couldn't link to the subroutine in ndown because it is compiled after this file<a name='187'></font>
<font color=#447700>!so a dependecy on ndown will not work. Additionally, ndown is not compiled for ideal cases. The variable is named parent in ndown, but it is actually operating on the nest. It has been renamed to nest here.<a name='188'></font>
<A NAME='VERT_COR_VERTICAL_NESTING_INTEGER'><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_INTEGER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='189'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>vert_cor_vertical_nesting_integer</font>(nest,znw_c,k_dim_c) <A href='../../call_to/VERT_COR_VERTICAL_NESTING_INTEGER.html' TARGET='index'>1</A>,<A href='../../call_from/VERT_COR_VERTICAL_NESTING_INTEGER.html' TARGET='index'>1</A><a name='190'>
         USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_INTEGER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_22"><a name='191'>
   IMPLICIT NONE<a name='192'>
         TYPE(domain), POINTER :: nest<a name='193'>
         integer , intent(in) :: k_dim_c<a name='194'>
         real , dimension(k_dim_c), INTENT(IN) :: znw_c<a name='195'>
<a name='196'>
       integer :: kde_c , kde_n ,n_refine,ii,kkk,k<a name='197'>
       real :: dznw_m,cof1,cof2<a name='198'>
<font color=#447700>!KAL this subroutine recalculates the vertical coordinates for the nest when vertical nesting is used.  This routine is copied from ndown and allows integer refinement only.<a name='199'></font>
<a name='200'>
<font color=#447700>!KAL znw is eta values on full w levels<a name='201'></font>
<font color=#447700>!KAL everything else is set from znw<a name='202'></font>
<font color=#447700>!KAL dnw is delta eta on w levels<a name='203'></font>
<font color=#447700>!KAL rdn is inverse delta eta on w levels<a name='204'></font>
<font color=#447700>!KAL fnp <a name='205'></font>
<a name='206'>
        kde_c = k_dim_c<a name='207'>
        kde_n = nest%e_vert<a name='208'>
<font color=#447700>!        n_refine = nest%vert_refine_fact<a name='209'></font>
        n_refine = (kde_n-1)/(kde_c-1)<a name='210'>
	<a name='211'>
         kkk = 0<a name='212'>
         do k = 1 , kde_c-1<a name='213'>
         dznw_m = znw_c(k+1) - znw_c(k)<a name='214'>
         do ii = 1,n_refine<a name='215'>
         kkk = kkk + 1<a name='216'>
         nest%znw(kkk) = znw_c(k) + float(ii-1)/float(n_refine)*dznw_m<a name='217'>
         enddo<a name='218'>
         enddo<a name='219'>
         nest%znw(kde_n) = znw_c(kde_c)<a name='220'>
         nest%znw(1) = znw_c(1)<a name='221'>
<a name='222'>
      DO k=1, kde_n-1<a name='223'>
         nest%dnw(k) = nest%znw(k+1) - nest%znw(k)<a name='224'>
         nest%rdnw(k) = 1./nest%dnw(k)<a name='225'>
         nest%znu(k) = 0.5*(nest%znw(k+1)+nest%znw(k))<a name='226'>
      END DO<a name='227'>
<a name='228'>
      DO k=2, kde_n-1<a name='229'>
         nest%dn(k) = 0.5*(nest%dnw(k)+nest%dnw(k-1))<a name='230'>
         nest%rdn(k) = 1./nest%dn(k)<a name='231'>
         nest%fnp(k) = .5* nest%dnw(k  )/nest%dn(k)<a name='232'>
         nest%fnm(k) = .5* nest%dnw(k-1)/nest%dn(k)<a name='233'>
      END DO<a name='234'>
<a name='235'>
  cof1 = (2.*nest%dn(2)+nest%dn(3))/(nest%dn(2)+nest%dn(3))*nest%dnw(1)/nest%dn(2)<a name='236'>
  cof2 =     nest%dn(2)        /(nest%dn(2)+nest%dn(3))*nest%dnw(1)/nest%dn(3)<a name='237'>
<a name='238'>
      nest%cf1  = nest%fnp(2) + cof1<a name='239'>
      nest%cf2  = nest%fnm(2) - cof1 - cof2<a name='240'>
      nest%cf3  = cof2<a name='241'>
<a name='242'>
      nest%cfn  = (.5*nest%dnw(kde_n-1)+nest%dn(kde_n-1))/nest%dn(kde_n-1)<a name='243'>
      nest%cfn1 = -.5*nest%dnw(kde_n-1)/nest%dn(kde_n-1)<a name='244'>
      <a name='245'>
      <font color=#447700>! the variables dzs and zs are kept from the parent domain.  These are the depths and thickness of the soil layers, which are not included in vertical nesting.<a name='246'></font>
<a name='247'>
      END SUBROUTINE vert_cor_vertical_nesting_integer<a name='248'>
<a name='249'>
<font color=#447700>!-----------------------------------------------------------------------------------------<a name='250'></font>
<a name='251'>
<A NAME='VERT_COR_VERTICAL_NESTING_ARBITRARY'><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='252'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vert_cor_vertical_nesting_arbitrary</font>(nest,znw_c,kde_c,use_baseparam_fr_nml) <A href='../../call_to/VERT_COR_VERTICAL_NESTING_ARBITRARY.html' TARGET='index'>1</A>,<A href='../../call_from/VERT_COR_VERTICAL_NESTING_ARBITRARY.html' TARGET='index'>10</A><a name='253'>
    USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_23"><a name='254'>
    USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_13"><a name='255'>
    IMPLICIT NONE<a name='256'>
    TYPE(domain), POINTER :: nest<a name='257'>
    INTEGER, INTENT(IN   ) :: kde_c<a name='258'>
    REAL, DIMENSION(kde_c), INTENT(IN   ) :: znw_c<a name='259'>
    LOGICAL, INTENT(IN   ) :: use_baseparam_fr_nml<a name='260'>
    INTEGER :: k, kde_n, ks, id<a name='261'>
    REAL :: cof1, cof2<a name='262'>
    REAL :: max_dz = 1000<a name='263'>
    REAL :: p00, t00, a, tiso, a_strat, p_strat<a name='264'>
    INTEGER :: ids, ide, jds, jde, kds, kde, &amp;<a name='265'>
               ims, ime, jms, jme, kms, kme, &amp;<a name='266'>
               its, ite, jts, jte, kts, kte<a name='267'>
    REAL, DIMENSION(max_eta) :: eta_levels<a name='268'>
<a name='269'>
    IF ( use_baseparam_fr_nml ) then<a name='270'>
      CALL nl_get_base_pres        ( 1 , p00        )<a name='271'>
      CALL nl_get_base_temp        ( 1 , t00        )<a name='272'>
      CALL nl_get_base_lapse       ( 1 , a          )<a name='273'>
      CALL nl_get_iso_temp         ( 1 , tiso       )<a name='274'>
      CALL nl_get_base_lapse_strat ( 1 , a_strat    )<a name='275'>
      CALL nl_get_base_pres_strat  ( 1 , p_strat    )<a name='276'>
      IF ((t00 .LT. 100.0) .OR. (p00 .LT. 10000.0)) THEN<a name='277'>
        WRITE(wrf_err_message,*) '--- ERROR: bad base state for T00 or P00 in namelist.input file'<a name='278'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_40">(TRIM(wrf_err_message))<a name='279'>
      END IF<a name='280'>
    ELSE<a name='281'>
      p00     = nest%p00<a name='282'>
      t00     = nest%t00<a name='283'>
      a       = nest%tlp<a name='284'>
      tiso    = nest%tiso<a name='285'>
      a_strat = nest%tlp_strat<a name='286'>
      p_strat = nest%p_strat<a name='287'>
      IF ((t00 .LT. 100.0) .OR. (p00 .LT. 10000.0)) THEN<a name='288'>
        WRITE(wrf_err_message,*) '--- ERROR: did not find base state parameters in nest. Add use_baseparam_fr_nml = .true. in &amp;dynamics and rerun'<a name='289'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_41">(TRIM(wrf_err_message))<a name='290'>
      ENDIF<a name='291'>
    ENDIF<a name='292'>
<a name='293'>
    kde_n = nest%e_vert<a name='294'>
<a name='295'>
    <font color=#447700>!DJW Added code for specifying multiple domains' eta_levels<a name='296'></font>
    IF (nest%id .NE. 1) THEN<a name='297'>
      id = 1<a name='298'>
      ks = 1<a name='299'>
      DO WHILE (nest%id .GT. id)<a name='300'>
        id = id+1<a name='301'>
        ks = ks+model_config_rec%e_vert(id-1)<a name='302'>
      ENDDO<a name='303'>
    ENDIF<a name='304'>
    IF ((nest%this_is_an_ideal_run) .AND. (model_config_rec%eta_levels(1) .EQ. -1.0)) THEN<a name='305'>
      <font color=#447700>!DJW If we're running an ideal case and do not have levels set in the<a name='306'></font>
      <font color=#447700>!namelist then we set znw using constant spacing in eta<a name='307'></font>
      DO k=1,kde_n<a name='308'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_21">(0, "nest_init_utils: eta_levels are not specified in the namelist, setting levels with constant spacing in eta.")<a name='309'>
        nest%znw(k) = 1.0-(k-1)/FLOAT((kde_n-1))<a name='310'>
      ENDDO<a name='311'>
    ELSEIF (.NOT.(nest%this_is_an_ideal_run) .AND. (model_config_rec%eta_levels(1) .EQ. -1.0)) THEN<a name='312'>
      write(*,'(A,I2,A)') "--- WARNING: eta_levels are not specified in the namelist for grid_id=",nest%grid_id,", using WRF's default levels."<a name='313'>
      CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_6">( nest, &amp;<a name='314'>
                              ids, ide, jds, jde, kds, kde, &amp;<a name='315'>
                              ims, ime, jms, jme, kms, kme, &amp;<a name='316'>
                              its, ite, jts, jte, kts, kte )<a name='317'>
      write(*,'(A,F10.3)') "--- USING: nest%p_top   = ",nest%p_top<a name='318'>
      write(*,'(A,F10.3)') "--- USING: g            = ",g<a name='319'>
      write(*,'(A,F10.3)') "--- USING: cvpm         = ",cvpm<a name='320'>
      write(*,'(A,F10.3)') "--- USING: r_d          = ",r_d<a name='321'>
      write(*,'(A,F10.3)') "--- USING: cp           = ",cp<a name='322'>
      write(*,'(A,F10.3)') "--- USING: p1000mb      = ",p1000mb<a name='323'>
      write(*,'(A,F10.3)') "--- USING: t0           = ",t0<a name='324'>
      write(*,'(A,F10.3)') "--- USING: p00          = ",p00<a name='325'>
      write(*,'(A,F10.3)') "--- USING: t00          = ",t00<a name='326'>
      write(*,'(A,F10.3)') "--- USING: a            = ",a<a name='327'>
      write(*,'(A,F10.3)') "--- USING: tiso         = ",tiso<a name='328'>
      write(*,'(A,F10.3)') "--- USING: a_strat      = ",a_strat<a name='329'>
      write(*,'(A,F10.3)') "--- USING: p_strat      = ",p_strat<a name='330'>
      CALL <A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA'>compute_eta</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMPUTE_ETA_1"> ( nest%znw, &amp;<a name='331'>
                         eta_levels, max_eta, max_dz, &amp;<a name='332'>
                         nest%p_top, g, p00, cvpm, a, r_d, cp, &amp;<a name='333'>
                         t00, p1000mb, t0, tiso, p_strat, a_strat, &amp;<a name='334'>
                         ids, ide, jds, jde, kds, kde, &amp;<a name='335'>
                         ims, ime, jms, jme, kms, kme, &amp;<a name='336'>
                         its, ite, jts, jte, kts, kte )<a name='337'>
    ELSE<a name='338'>
      <font color=#447700>!DJW If we're in here then we are suppose to read in eta_levels<a name='339'></font>
      <font color=#447700>!from the namelist. We do so and then check to make sure they make sense<a name='340'></font>
    DO k=1,kde_n<a name='341'>
      nest%znw(k) = model_config_rec%eta_levels(ks+k-1)<a name='342'>
        write(*,'(A,I3,A,F6.3)') "nest%znw(",k,") = ",nest%znw(k)<a name='343'>
    ENDDO<a name='344'>
    <font color=#447700>!Check the value of the first and last eta level for our domain,<a name='345'></font>
    <font color=#447700>!then check that the vector of eta levels is only decreasing<a name='346'></font>
    IF (nest%znw(1) .NE. 1.0) THEN<a name='347'>
        write(wrf_err_message,'(A,I2,A)') "--- ERROR: first eta_level for grid_id=",nest%grid_id," is not 1.0. Check namelist."<a name='348'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_42">( wrf_err_message )<a name='349'>
    ENDIF<a name='350'>
      write(*,'(A,F10.3)') "--- USING: g            = ",g<a name='351'>
      write(*,'(A,F10.3)') "--- USING: cvpm         = ",cvpm<a name='352'>
      write(*,'(A,F10.3)') "--- USING: r_d          = ",r_d<a name='353'>
      write(*,'(A,F10.3)') "--- USING: cp           = ",cp<a name='354'>
      write(*,'(A,F10.3)') "--- USING: p1000mb      = ",p1000mb<a name='355'>
      write(*,'(A,F10.3)') "--- USING: t0           = ",t0<a name='356'>
    IF (nest%znw(kde_n) .NE. 0.0) THEN<a name='357'>
        write(wrf_err_message,'(A,I2,A)') "--- ERROR: last eta_level for grid_id=",nest%grid_id," is not 0.0. Check namelist."<a name='358'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_43">( wrf_err_message )<a name='359'>
    ENDIF<a name='360'>
    DO k=2,kde_n<a name='361'>
      IF (nest%znw(k) .GT. nest%znw(k-1)) THEN<a name='362'>
          write(wrf_err_message,'(A,I2,A)') "--- ERROR: eta_level for grid_id=",nest%grid_id," are not monotonically decreasing. Check namelist."<a name='363'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#VERT_COR_VERTICAL_NESTING_ARBITRARY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_44">( wrf_err_message )<a name='364'>
      ENDIF<a name='365'>
    ENDDO<a name='366'>
    ENDIF<a name='367'>
    <font color=#447700>!DJW End of added code for specifying eta_levels<a name='368'></font>
<a name='369'>
    DO k=1,kde_n-1<a name='370'>
      nest%dnw(k) = nest%znw(k+1)-nest%znw(k)<a name='371'>
      nest%rdnw(k) = 1./nest%dnw(k)<a name='372'>
      nest%znu(k) = 0.5*(nest%znw(k+1)+nest%znw(k))<a name='373'>
    ENDDO<a name='374'>
    nest%znu(kde_n) = 0.0<a name='375'>
<a name='376'>
    DO k=2,kde_n-1<a name='377'>
      nest%dn(k) = 0.5*(nest%dnw(k)+nest%dnw(k-1))<a name='378'>
      nest%rdn(k) = 1./nest%dn(k)<a name='379'>
      nest%fnp(k) = .5* nest%dnw(k  )/nest%dn(k)<a name='380'>
      nest%fnm(k) = .5* nest%dnw(k-1)/nest%dn(k)<a name='381'>
    ENDDO<a name='382'>
<a name='383'>
    cof1 = (2.*nest%dn(2)+nest%dn(3))/(nest%dn(2)+nest%dn(3))*nest%dnw(1)/nest%dn(2)<a name='384'>
    cof2 =     nest%dn(2)            /(nest%dn(2)+nest%dn(3))*nest%dnw(1)/nest%dn(3)<a name='385'>
<a name='386'>
    nest%cf1  = nest%fnp(2) + cof1<a name='387'>
    nest%cf2  = nest%fnm(2) - cof1 - cof2<a name='388'>
    nest%cf3  = cof2<a name='389'>
    nest%cfn  = (.5*nest%dnw(kde_n-1)+nest%dn(kde_n-1))/nest%dn(kde_n-1)<a name='390'>
    nest%cfn1 = -.5*nest%dnw(kde_n-1)/nest%dn(kde_n-1)<a name='391'>
<a name='392'>
END SUBROUTINE vert_cor_vertical_nesting_arbitrary<a name='393'>
<a name='394'>
<A NAME='COMPUTE_ETA'><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='395'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>compute_eta</font> ( znw , &amp; <A href='../../call_to/COMPUTE_ETA.html' TARGET='index'>1</A>,<A href='../../call_from/COMPUTE_ETA.html' TARGET='index'>10</A><a name='396'>
                         eta_levels , max_eta , max_dz ,        &amp;<a name='397'>
                         p_top_def , g_def , p00_def ,          &amp;<a name='398'>
                         cvpm_def , a_def , r_d_def , cp_def ,  &amp;<a name='399'>
                         t00_def , p1000mb_def , t0_def ,       &amp;<a name='400'>
                         tiso_def , p_strat_def , a_strat_def , &amp;<a name='401'>
                         ids , ide , jds , jde , kds , kde ,    &amp;<a name='402'>
                         ims , ime , jms , jme , kms , kme ,    &amp;<a name='403'>
                         its , ite , jts , jte , kts , kte )<a name='404'>
<a name='405'>
      <font color=#447700>!  Compute eta levels, either using given values from the namelist (hardly<a name='406'></font>
      <font color=#447700>!  a computation, yep, I know), or assuming a constant dz above the PBL,<a name='407'></font>
      <font color=#447700>!  knowing p_top and the number of eta levels.<a name='408'></font>
<a name='409'>
      IMPLICIT NONE<a name='410'>
<a name='411'>
      INTEGER , INTENT(IN)        :: ids , ide , jds , jde , kds , kde , &amp;<a name='412'>
                                     ims , ime , jms , jme , kms , kme , &amp;<a name='413'>
                                     its , ite , jts , jte , kts , kte<a name='414'>
      REAL , INTENT(IN)           :: max_dz<a name='415'>
      REAL , INTENT(IN)           :: p_top_def , g_def , p00_def , cvpm_def , &amp;<a name='416'>
                                     a_def , r_d_def , cp_def , t00_def ,     &amp;<a name='417'>
                                     p1000mb_def , t0_def , tiso_def ,        &amp;<a name='418'>
                                     p_strat_def , a_strat_def<a name='419'>
      INTEGER , INTENT(IN)        :: max_eta<a name='420'>
      REAL , DIMENSION (max_eta)  :: eta_levels<a name='421'>
<a name='422'>
      REAL , DIMENSION (kts:kte) , INTENT(OUT) :: znw<a name='423'>
<a name='424'>
      <font color=#447700>!  Local vars<a name='425'></font>
<a name='426'>
      INTEGER :: k , kk<a name='427'>
      REAL(KIND=8) :: mub , t_init , p_surf , pb, ztop, ztop_pbl , dz , temp<a name='428'>
      REAL(KIND=8) , DIMENSION(kts:kte) :: dnw<a name='429'>
      REAL(KIND=8) :: p_top , g , p00 , cvpm , &amp;<a name='430'>
                      a , r_d , cp , t00 ,     &amp;<a name='431'>
                      p1000mb , t0 , tiso ,        &amp;<a name='432'>
                      p_strat , a_strat<a name='433'>
<a name='434'>
      INTEGER , PARAMETER :: prac_levels = 59<a name='435'>
      INTEGER :: loop , loop1<a name='436'>
      REAL(KIND=8) , DIMENSION(prac_levels) :: znw_prac , znu_prac , dnw_prac<a name='437'>
      REAL(KIND=8) , DIMENSION(MAX(prac_levels,kde)) :: alb , phb<a name='438'>
      REAL(KIND=8) :: alb_max, t_init_max, pb_max, phb_max<a name='439'>
<a name='440'>
      CHARACTER(LEN=256) :: message<a name='441'>
<a name='442'>
      <font color=#447700>!  Compute top of the atmosphere with some silly levels.  We just want to<a name='443'></font>
      <font color=#447700>!  integrate to get a reasonable value for ztop.  We use the planned<a name='444'></font>
      <font color=#447700>!  PBL-esque<a name='445'></font>
      <font color=#447700>!  levels, and then just coarse resolution above that.  We know p_top,<a name='446'></font>
      <font color=#447700>!  and we<a name='447'></font>
      <font color=#447700>!  have the base state vars.<a name='448'></font>
<a name='449'>
      p_top   = p_top_def<a name='450'>
      g       = g_def<a name='451'>
      p00     = p00_def<a name='452'>
      cvpm    = cvpm_def<a name='453'>
      a       = a_def<a name='454'>
      r_d     = r_d_def<a name='455'>
      cp      = cp_def<a name='456'>
      t00     = t00_def<a name='457'>
      p1000mb = p1000mb_def<a name='458'>
      t0      = t0_def<a name='459'>
      tiso    = tiso_def<a name='460'>
      p_strat = p_strat_def<a name='461'>
      a_strat = a_strat_def<a name='462'>
<a name='463'>
      p_surf = p00<a name='464'>
<a name='465'>
      znw_prac = (/ 1.0000_8 , 0.9930_8 , 0.9830_8 , 0.9700_8 , 0.9540_8 , 0.9340_8 , 0.9090_8 , 0.8800_8 , &amp;<a name='466'>
                    0.8500_8 , 0.8000_8 , 0.7500_8 , 0.7000_8 , 0.6500_8 , 0.6000_8 , 0.5500_8 , 0.5000_8 , &amp;<a name='467'>
                    0.4500_8 , 0.4000_8 , 0.3500_8 , 0.3000_8 , 0.2500_8 , 0.2000_8 , 0.1500_8 , 0.1000_8 , &amp;<a name='468'>
                    0.0800_8 , 0.0600_8 , 0.0400_8 , 0.0200_8 , &amp;<a name='469'>
                    0.0150_8 , 0.0100_8 , 0.0090_8 , 0.0080_8 , 0.0070_8 , 0.0060_8 , 0.0050_8 , 0.0040_8 , &amp;<a name='470'>
                    0.0035_8 , 0.0030_8 , &amp;<a name='471'>
                    0.0028_8 , 0.0026_8 , 0.0024_8 , 0.0022_8 , 0.0020_8 , &amp;<a name='472'>
                    0.0018_8 , 0.0016_8 , 0.0014_8 , 0.0012_8 , 0.0010_8 , &amp;<a name='473'>
                    0.0009_8 , 0.0008_8 , 0.0007_8 , 0.0006_8 , 0.0005_8 , 0.0004_8 , 0.0003_8 , &amp;<a name='474'>
                    0.0002_8 , 0.0001_8 , 0.00005_8, 0.0000_8 /)<a name='475'>
<a name='476'>
      DO k = 1 , prac_levels - 1<a name='477'>
        znu_prac(k) = ( znw_prac(k) + znw_prac(k+1) ) * 0.5_8<a name='478'>
        dnw_prac(k) = znw_prac(k+1) - znw_prac(k)<a name='479'>
      END DO<a name='480'>
<a name='481'>
      DO k = 1, prac_levels-1<a name='482'>
        pb = znu_prac(k)*(p_surf - p_top) + p_top<a name='483'>
        temp = MAX ( tiso, t00 + A*LOG(pb/p00) )<a name='484'>
        IF ( pb .LT. p_strat ) THEN<a name='485'>
          temp = tiso + A_strat*LOG(pb/p_strat)<a name='486'>
        END IF<a name='487'>
        t_init = temp*(p00/pb)**(r_d/cp) - t0<a name='488'>
        alb(k) = (r_d/p1000mb)*(t_init+t0)*(pb/p1000mb)**cvpm<a name='489'>
      END DO<a name='490'>
<a name='491'>
      <font color=#447700>!  Base state mu is defined as base state surface pressure minus p_top<a name='492'></font>
<a name='493'>
      mub = p_surf - p_top<a name='494'>
<a name='495'>
      <font color=#447700>!  Integrate base geopotential, starting at terrain elevation.<a name='496'></font>
<a name='497'>
      phb(1) = 0._8<a name='498'>
      DO k  = 2,prac_levels<a name='499'>
        phb(k) = phb(k-1) - dnw_prac(k-1)*mub*alb(k-1)<a name='500'>
      END DO<a name='501'>
<a name='502'>
      <font color=#447700>!  So, now we know the model top in meters.  Get the average depth above the PBL<a name='503'></font>
      <font color=#447700>!  of each of the remaining levels.  We are going for a constant delta z thickness.<a name='504'></font>
<a name='505'>
      ztop     = phb(prac_levels) / g<a name='506'>
      ztop_pbl = phb(8          ) / g<a name='507'>
      dz = ( ztop - ztop_pbl ) / REAL ( kde - 8 )<a name='508'>
<a name='509'>
      IF ( dz .GE. max_dz ) THEN<a name='510'>
        WRITE (message,FMT='("With a requested ",F7.1," Pa model top, the model lid will be about ",F7.1," m.")') p_top, ztop<a name='511'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_42"> ( message )<a name='512'>
        WRITE (message,FMT='("With ",I3," levels above the PBL, the level thickness will be about ",F6.1," m.")') kde-8, dz<a name='513'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_43"> ( message )<a name='514'>
        WRITE (message,FMT='("Thicknesses greater than ",F7.1," m are not recommended.")') max_dz<a name='515'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_44"> ( message )<a name='516'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_45"> ( 'Add more levels to namelist.input for e_vert' )<a name='517'>
      END IF<a name='518'>
<a name='519'>
      <font color=#447700>!  Standard levels near the surface so no one gets in trouble.<a name='520'></font>
<a name='521'>
      DO k = 1 , 8<a name='522'>
        eta_levels(k) = znw_prac(k)<a name='523'>
      END DO<a name='524'>
<a name='525'>
      <font color=#447700>!  Using d phb(k)/ d eta(k) = -mub * alb(k), eqn 2.9<a name='526'></font>
      <font color=#447700>!  Skamarock et al, NCAR TN 468.  Use full levels, so<a name='527'></font>
      <font color=#447700>!  use twice the thickness.<a name='528'></font>
<a name='529'>
      DO k = 8, kte-1-2<a name='530'>
<a name='531'>
        find_prac : DO kk = 1 , prac_levels<a name='532'>
          IF (znw_prac(kk) .LT. eta_levels(k) ) THEN<a name='533'>
            EXIT find_prac<a name='534'>
          END IF<a name='535'>
        end do find_prac<a name='536'>
<a name='537'>
        pb = 0.5*(eta_levels(k)+znw_prac(kk)) * (p_surf - p_top) + p_top<a name='538'>
<a name='539'>
        temp = MAX ( tiso, t00 + A*LOG(pb/p00) )<a name='540'>
        IF ( pb .LT. p_strat ) THEN<a name='541'>
          temp = tiso + A_strat * LOG ( pb/p_strat )<a name='542'>
        END IF<a name='543'>
<font color=#447700>!       temp =             t00 + A*LOG(pb/p00)<a name='544'></font>
        t_init = temp*(p00/pb)**(r_d/cp) - t0<a name='545'>
        alb(k) = (r_d/p1000mb)*(t_init+t0)*(pb/p1000mb)**cvpm<a name='546'>
        eta_levels(k+1) = eta_levels(k) - dz*g / ( mub*alb(k) )<a name='547'>
        pb = 0.5*(eta_levels(k)+eta_levels(k+1)) * (p_surf - p_top) + p_top<a name='548'>
<a name='549'>
        temp = MAX ( tiso, t00 + A*LOG(pb/p00) )<a name='550'>
        IF ( pb .LT. p_strat ) THEN<a name='551'>
          temp = tiso + A_strat * LOG ( pb/p_strat )<a name='552'>
        END IF<a name='553'>
<font color=#447700>!       temp =             t00 + A*LOG(pb/p00)<a name='554'></font>
        t_init = temp*(p00/pb)**(r_d/cp) - t0<a name='555'>
        alb(k) = (r_d/p1000mb)*(t_init+t0)*(pb/p1000mb)**cvpm<a name='556'>
        eta_levels(k+1) = eta_levels(k) - dz*g / ( mub*alb(k) )<a name='557'>
        pb = 0.5*(eta_levels(k)+eta_levels(k+1)) * (p_surf - p_top) + p_top<a name='558'>
<a name='559'>
        phb(k+1) = phb(k) - (eta_levels(k+1)-eta_levels(k)) * mub*alb(k)<a name='560'>
      END DO<a name='561'>
<a name='562'>
      alb_max = alb(kte-1-2)<a name='563'>
      t_init_max = t_init<a name='564'>
      pb_max = pb<a name='565'>
      phb_max = phb(kte-1)<a name='566'>
<a name='567'>
      DO k = 1 , kte-1-2<a name='568'>
        znw(k) = eta_levels(k)<a name='569'>
      END DO<a name='570'>
      znw(kte-2) = 0.000<a name='571'>
<a name='572'>
      <font color=#447700>!  There is some iteration.  We want the top level, ztop, to be<a name='573'></font>
      <font color=#447700>!  consistent with the delta z, and we want the half level values<a name='574'></font>
      <font color=#447700>!  to be consistent with the eta levels.  The inner loop to 10 gets<a name='575'></font>
      <font color=#447700>!  the eta levels very accurately, but has a residual at the top, due<a name='576'></font>
      <font color=#447700>!  to dz changing.  We reset dz five times, and then things seem OK.<a name='577'></font>
<a name='578'>
      DO loop1 = 1 , 5<a name='579'>
        DO loop = 1 , 10<a name='580'>
          DO k = 8, kte-1-2-1<a name='581'>
            pb = (znw(k)+znw(k+1))*0.5 * (p_surf - p_top) + p_top<a name='582'>
            temp = MAX ( tiso, t00 + A*LOG(pb/p00) )<a name='583'>
            IF ( pb .LT. p_strat ) THEN<a name='584'>
              temp = tiso + A_strat * LOG ( pb/p_strat )<a name='585'>
            END IF<a name='586'>
            t_init = temp*(p00/pb)**(r_d/cp) - t0<a name='587'>
            alb(k) = (r_d/p1000mb)*(t_init+t0)*(pb/p1000mb)**cvpm<a name='588'>
            znw(k+1) = znw(k) - dz*g / ( mub*alb(k) )<a name='589'>
          END DO<a name='590'>
          pb = pb_max<a name='591'>
          t_init = t_init_max<a name='592'>
          alb(kte-1-2) = alb_max<a name='593'>
          znw(kte-2) = znw(kte-1-2) - dz*g / ( mub*alb(kte-1-2) )<a name='594'>
          IF ( ( loop1 .EQ. 5 ) .AND. ( loop .EQ. 10 ) ) THEN<a name='595'>
            print *,'Converged znw(kte) should be about 0.0 = ',znw(kte-2)<a name='596'>
          END IF<a name='597'>
          znw(kte-2) = 0.000<a name='598'>
        END DO<a name='599'>
<a name='600'>
        <font color=#447700>!  Here is where we check the eta levels values we just computed.<a name='601'></font>
<a name='602'>
        DO k = 1, kde-1-2<a name='603'>
          pb = (znw(k)+znw(k+1))*0.5 * (p_surf - p_top) + p_top<a name='604'>
          temp = MAX ( tiso, t00 + A*LOG(pb/p00) )<a name='605'>
          IF ( pb .LT. p_strat ) THEN<a name='606'>
            temp = tiso + A_strat * LOG ( pb/p_strat )<a name='607'>
          END IF<a name='608'>
          t_init = temp*(p00/pb)**(r_d/cp) - t0<a name='609'>
          alb(k) = (r_d/p1000mb)*(t_init+t0)*(pb/p1000mb)**cvpm<a name='610'>
        END DO<a name='611'>
<a name='612'>
        phb(1) = 0.<a name='613'>
        DO k  = 2,kde-2<a name='614'>
          phb(k) = phb(k-1) - (znw(k)-znw(k-1)) * mub*alb(k-1)<a name='615'>
        END DO<a name='616'>
<a name='617'>
        <font color=#447700>!  Reset the model top and the dz, and iterate.<a name='618'></font>
<a name='619'>
        ztop = phb(kde-2)/g<a name='620'>
        ztop_pbl = phb(8)/g<a name='621'>
        dz = ( ztop - ztop_pbl ) / REAL ( (kde-2) - 8 )<a name='622'>
      END DO<a name='623'>
<a name='624'>
      IF ( dz .GT. max_dz ) THEN<a name='625'>
        print *,'z (m)            = ',phb(1)/g<a name='626'>
        do k = 2 ,kte-2<a name='627'>
          print *,'z (m) and dz (m) = ',phb(k)/g,(phb(k)-phb(k-1))/g<a name='628'>
        end do<a name='629'>
        print *,'dz (m) above fixed eta levels = ',dz<a name='630'>
        print *,'namelist max_dz (m) = ',max_dz<a name='631'>
        print *,'namelist p_top (Pa) = ',p_top<a name='632'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_22"> ( 0, 'You need one of three things:' )<a name='633'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_23"> ( 0, '1) More eta levels to reduce the dz: e_vert' )<a name='634'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_24"> ( 0, '2) A lower p_top so your total height is reduced: p_top_requested')<a name='635'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_25"> ( 0, '3) Increase the maximum allowable eta thickness: max_dz')<a name='636'>
        CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_26"> ( 0, 'All are namelist options')<a name='637'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#COMPUTE_ETA' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_46"> ( 'dz above fixed eta levels is too large')<a name='638'>
      END IF<a name='639'>
<a name='640'>
      <font color=#447700>!  Add those 2 levels back into the middle, just above the 8 levels<a name='641'></font>
      <font color=#447700>!  that semi define a boundary layer.  After we open up the levels,<a name='642'></font>
      <font color=#447700>!  then we just linearly interpolate in znw.  So now levels 1-8 are<a name='643'></font>
      <font color=#447700>!  specified as the fixed boundary layer levels given in this routine.<a name='644'></font>
      <font color=#447700>!  The top levels, 12 through kte are those computed.  The middle<a name='645'></font>
      <font color=#447700>!  levels 9, 10, and 11 are equi-spaced in znw, and are each 1/2 the<a name='646'></font>
      <font color=#447700>!  the znw thickness of levels 11 through 12.<a name='647'></font>
<a name='648'>
      DO k = kte-2 , 9 , -1<a name='649'>
        znw(k+2) = znw(k)<a name='650'>
      END DO<a name='651'>
<a name='652'>
      znw( 9) = 0.75 * znw( 8) + 0.25 * znw(12)<a name='653'>
      znw(10) = 0.50 * znw( 8) + 0.50 * znw(12)<a name='654'>
      znw(11) = 0.25 * znw( 8) + 0.75 * znw(12)<a name='655'>
<a name='656'>
      DO k = 8, kte-1<a name='657'>
        pb = (znw(k)+znw(k+1))*0.5 * (p_surf - p_top) + p_top<a name='658'>
        temp = MAX ( tiso, t00 + A*LOG(pb/p00) )<a name='659'>
        IF ( pb .LT. p_strat ) THEN<a name='660'>
          temp = tiso + A_strat * LOG ( pb/p_strat )<a name='661'>
        END IF<a name='662'>
        t_init = temp*(p00/pb)**(r_d/cp) - t0<a name='663'>
        alb(k) = (r_d/p1000mb)*(t_init+t0)*(pb/p1000mb)**cvpm<a name='664'>
        phb(k) = phb(k-1) - (znw(k)-znw(k-1)) * mub*alb(k-1)<a name='665'>
      END DO<a name='666'>
      phb(kte) = phb(kte-1) - (znw(kte)-znw(kte-1)) * mub*alb(kte-1)<a name='667'>
<a name='668'>
      k=1<a name='669'>
      WRITE (*,FMT='("Full level index = ",I4,"     Height = ",F7.1," m")') k,phb(1)/g<a name='670'>
      do k = 2 ,kte<a name='671'>
        WRITE (*,FMT='("Full level index = ",I4,"     Height = ",F7.1," m      Thickness = ",F6.1," m")') k,phb(k)/g,(phb(k)-phb(k-1))/g<a name='672'>
      end do<a name='673'>
<a name='674'>
END SUBROUTINE compute_eta<a name='675'>
<a name='676'>
<font color=#447700>!-----------------------------------------------------------------------------------------<a name='677'></font>
<a name='678'>
<A NAME='BLEND_TERRAIN'><A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='679'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>blend_terrain</font> ( ter_interpolated , ter_input , &amp; <A href='../../call_to/BLEND_TERRAIN.html' TARGET='index'>7</A>,<A href='../../call_from/BLEND_TERRAIN.html' TARGET='index'>1</A><a name='680'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='681'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='682'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='683'>
<a name='684'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#BLEND_TERRAIN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_16"><a name='685'>
   IMPLICIT NONE<a name='686'>
<a name='687'>
   INTEGER , INTENT(IN)                       :: ids , ide , jds , jde , kds , kde , &amp;<a name='688'>
                                                 ims , ime , jms , jme , kms , kme , &amp;<a name='689'>
                                                 ips , ipe , jps , jpe , kps , kpe<a name='690'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(IN)    :: ter_interpolated<a name='691'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(INOUT) :: ter_input<a name='692'>
<a name='693'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) :: ter_temp<a name='694'>
   INTEGER :: i , j , k , spec_bdy_width<a name='695'>
   REAL    :: r_blend_zones<a name='696'>
   INTEGER blend_cell, blend_width<a name='697'>
<a name='698'>
   <font color=#447700>!  The fine grid elevation comes from the horizontally interpolated<a name='699'></font>
   <font color=#447700>!  parent elevation for the first spec_bdy_width row/columns, so we need<a name='700'></font>
   <font color=#447700>!  to get that value.  We blend the coarse and fine in the next blend_width<a name='701'></font>
   <font color=#447700>!  rows and columns.  After that, in the interior, it is 100% fine grid.<a name='702'></font>
<a name='703'>
   CALL nl_get_spec_bdy_width ( 1, spec_bdy_width)<a name='704'>
   CALL nl_get_blend_width ( 1, blend_width)<a name='705'>
<a name='706'>
   <font color=#447700>!  Initialize temp values to the nest ter elevation.  This fills in the values<a name='707'></font>
   <font color=#447700>!  that will not be modified below.<a name='708'></font>
<a name='709'>
   DO j = jps , MIN(jpe, jde-1)<a name='710'>
      DO k = kps , kpe<a name='711'>
         DO i = ips , MIN(ipe, ide-1)<a name='712'>
            ter_temp(i,k,j) = ter_input(i,k,j)<a name='713'>
         END DO<a name='714'>
      END DO<a name='715'>
   END DO<a name='716'>
<a name='717'>
   <font color=#447700>!  To avoid some tricky indexing, we fill in the values inside out.  This allows<a name='718'></font>
   <font color=#447700>!  us to overwrite incorrect assignments.  There are replicated assignments, and<a name='719'></font>
   <font color=#447700>!  there is much unnecessary "IF test inside of a loop" stuff.  For a large<a name='720'></font>
   <font color=#447700>!  domain, this is only a patch; for a small domain, this is not a biggy.<a name='721'></font>
<a name='722'>
   r_blend_zones = 1./(blend_width+1)<a name='723'>
   DO j = jps , MIN(jpe, jde-1)<a name='724'>
      DO k = kps , kpe<a name='725'>
         DO i = ips , MIN(ipe, ide-1)<a name='726'>
            DO blend_cell = blend_width,1,-1<a name='727'>
               IF   ( ( i .EQ.       spec_bdy_width + blend_cell ) .OR.  ( j .EQ.       spec_bdy_width + blend_cell ) .OR. &amp;<a name='728'>
                      ( i .EQ. ide - spec_bdy_width - blend_cell ) .OR.  ( j .EQ. jde - spec_bdy_width - blend_cell ) ) THEN<a name='729'>
                  ter_temp(i,k,j) = ( (blend_cell)*ter_input(i,k,j) + (blend_width+1-blend_cell)*ter_interpolated(i,k,j) ) &amp;<a name='730'>
                                    * r_blend_zones<a name='731'>
               END IF<a name='732'>
            ENDDO<a name='733'>
            IF      ( ( i .LE.       spec_bdy_width     ) .OR.  ( j .LE.       spec_bdy_width     ) .OR. &amp;<a name='734'>
                      ( i .GE. ide - spec_bdy_width     ) .OR.  ( j .GE. jde - spec_bdy_width     ) ) THEN<a name='735'>
               ter_temp(i,k,j) =      ter_interpolated(i,k,j)<a name='736'>
            END IF<a name='737'>
         END DO<a name='738'>
      END DO<a name='739'>
   END DO<a name='740'>
<a name='741'>
   <font color=#447700>!  Set nest elevation with temp values.  All values not overwritten in the above<a name='742'></font>
   <font color=#447700>!  loops have been previously set in the initial assignment.<a name='743'></font>
<a name='744'>
   DO j = jps , MIN(jpe, jde-1)<a name='745'>
      DO k = kps , kpe<a name='746'>
         DO i = ips , MIN(ipe, ide-1)<a name='747'>
            ter_input(i,k,j) = ter_temp(i,k,j)<a name='748'>
         END DO<a name='749'>
      END DO<a name='750'>
   END DO<a name='751'>
<a name='752'>
END SUBROUTINE blend_terrain<a name='753'>
<a name='754'>
<A NAME='COPY_3D_FIELD'><A href='../../html_code/dyn_em/nest_init_utils.F.html#COPY_3D_FIELD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='755'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>copy_3d_field</font> ( ter_interpolated , ter_input , &amp; <A href='../../call_to/COPY_3D_FIELD.html' TARGET='index'>9</A><a name='756'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='757'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='758'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='759'>
<a name='760'>
   IMPLICIT NONE<a name='761'>
<a name='762'>
   INTEGER , INTENT(IN)                       :: ids , ide , jds , jde , kds , kde , &amp;<a name='763'>
                                                 ims , ime , jms , jme , kms , kme , &amp;<a name='764'>
                                                 ips , ipe , jps , jpe , kps , kpe<a name='765'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(OUT) :: ter_interpolated<a name='766'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(IN)  :: ter_input<a name='767'>
<a name='768'>
   INTEGER :: i , j , k<a name='769'>
<a name='770'>
   DO j = jps , MIN(jpe, jde-1)<a name='771'>
      DO k = kps , kpe<a name='772'>
         DO i = ips , MIN(ipe, ide-1)<a name='773'>
            ter_interpolated(i,k,j) = ter_input(i,k,j)<a name='774'>
         END DO<a name='775'>
      END DO<a name='776'>
   END DO<a name='777'>
<a name='778'>
END SUBROUTINE copy_3d_field<a name='779'>
<a name='780'>
<A NAME='ADJUST_TEMPQV'><A href='../../html_code/dyn_em/nest_init_utils.F.html#ADJUST_TEMPQV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='781'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>adjust_tempqv</font> ( mub, save_mub, c3, c4, znw, p_top, &amp; <A href='../../call_to/ADJUST_TEMPQV.html' TARGET='index'>1</A>,<A href='../../call_from/ADJUST_TEMPQV.html' TARGET='index'>1</A><a name='782'>
                           th, pp, qv,  &amp;<a name='783'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='784'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='785'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='786'>
<a name='787'>
   <font color=#447700>!USE module_configure<a name='788'></font>
   <font color=#447700>!USE module_domain<a name='789'></font>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#ADJUST_TEMPQV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_14"><a name='790'>
<a name='791'>
   <font color=#447700>!USE module_bc<a name='792'></font>
   <font color=#447700>!USE module_io_domain<a name='793'></font>
   <font color=#447700>!USE module_state_description<a name='794'></font>
   <font color=#447700>!USE module_timing<a name='795'></font>
   <font color=#447700>!USE module_soil_pre<a name='796'></font>
   IMPLICIT NONE<a name='797'>
<a name='798'>
   INTEGER , INTENT(IN)                       :: ids , ide , jds , jde , kds , kde , &amp;<a name='799'>
                                                 ims , ime , jms , jme , kms , kme , &amp;<a name='800'>
                                                 ips , ipe , jps , jpe , kps , kpe<a name='801'>
   REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN)    :: mub, save_mub<a name='802'>
   REAL , DIMENSION(kms:kme) , INTENT(IN)    :: znw<a name='803'>
   REAL , DIMENSION(kms:kme) , INTENT(IN)    :: c3, c4<a name='804'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(INOUT) :: th, pp, qv<a name='805'>
<a name='806'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) :: p_old, p_new, rh<a name='807'>
   REAL :: es,dth,tc,e,dth1<a name='808'>
   INTEGER :: i , j , k<a name='809'>
<a name='810'>
   real p_top<a name='811'>
<a name='812'>
<a name='813'>
<font color=#447700>! p_old = full pressure before terrain blending; also compute initial RH<a name='814'></font>
<font color=#447700>! which is going to be conserved during terrain blending<a name='815'></font>
   DO j = jps , MIN(jpe, jde-1)<a name='816'>
      DO k = kps , kpe-1<a name='817'>
         DO i = ips , MIN(ipe, ide-1)<a name='818'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='819'></font>
            p_old(i,k,j) = 0.5*(znw(k+1)+znw(k))*save_mub(i,j) + p_top + pp(i,k,j)<a name='820'>
#elif ( HYBRID_COORD==1 )<a name='821'>
            p_old(i,k,j) = c4(k) +         c3(k)*save_mub(i,j) + p_top + pp(i,k,j)<a name='822'>
#endif<a name='823'>
            tc = (th(i,k,j)+300.)*(p_old(i,k,j)/1.e5)**(2./7.) - 273.15<a name='824'>
            es = 610.78*exp(17.0809*tc/(234.175+tc))<a name='825'>
            e = qv(i,k,j)*p_old(i,k,j)/(0.622+qv(i,k,j))<a name='826'>
            rh(i,k,j) = e/es<a name='827'>
         END DO<a name='828'>
      END DO<a name='829'>
   END DO<a name='830'>
<a name='831'>
<font color=#447700>! p_new = full pressure after terrain blending; also compute temperature correction and convert RH back to QV<a name='832'></font>
   DO j = jps , MIN(jpe, jde-1)<a name='833'>
      DO k = kps , kpe-1<a name='834'>
         DO i = ips , MIN(ipe, ide-1)<a name='835'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='836'></font>
            p_new(i,k,j) = 0.5*(znw(k+1)+znw(k))*mub(i,j) + p_top + pp(i,k,j)<a name='837'>
#elif ( HYBRID_COORD==1 )<a name='838'>
            p_new(i,k,j) = c4(k) +         c3(k)*mub(i,j) + p_top + pp(i,k,j)<a name='839'>
#endif<a name='840'>
<font color=#447700>! 2*(g/cp-6.5e-3)*R_dry/g = -191.86e-3<a name='841'></font>
            dth1 = -191.86e-3*(th(i,k,j)+300.)/(p_new(i,k,j)+p_old(i,k,j))*(p_new(i,k,j)-p_old(i,k,j))<a name='842'>
            dth = -191.86e-3*(th(i,k,j)+0.5*dth1+300.)/(p_new(i,k,j)+p_old(i,k,j))*(p_new(i,k,j)-p_old(i,k,j))<a name='843'>
            th(i,k,j) = th(i,k,j)+dth<a name='844'>
            tc = (th(i,k,j)+300.)*(p_new(i,k,j)/1.e5)**(2./7.) - 273.15<a name='845'>
            es = 610.78*exp(17.0809*tc/(234.175+tc))<a name='846'>
            e = rh(i,k,j)*es<a name='847'>
            qv(i,k,j) = 0.622*e/(p_new(i,k,j)-e)<a name='848'>
         END DO<a name='849'>
      END DO<a name='850'>
   END DO<a name='851'>
<a name='852'>
<a name='853'>
END SUBROUTINE adjust_tempqv<a name='854'>
<a name='855'>
<A NAME='INPUT_TERRAIN_RSMAS'><A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='856'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>input_terrain_rsmas</font> ( grid ,                        &amp; <A href='../../call_to/INPUT_TERRAIN_RSMAS.html' TARGET='index'>2</A>,<A href='../../call_from/INPUT_TERRAIN_RSMAS.html' TARGET='index'>7</A><a name='857'>
                           ids , ide , jds , jde , kds , kde , &amp;<a name='858'>
                           ims , ime , jms , jme , kms , kme , &amp;<a name='859'>
                           ips , ipe , jps , jpe , kps , kpe )<a name='860'>
<a name='861'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_24">, ONLY : domain<a name='862'>
   IMPLICIT NONE<a name='863'>
   TYPE ( domain ) :: grid<a name='864'>
<a name='865'>
   INTEGER , INTENT(IN)                       :: ids , ide , jds , jde , kds , kde , &amp;<a name='866'>
                                                 ims , ime , jms , jme , kms , kme , &amp;<a name='867'>
                                                 ips , ipe , jps , jpe , kps , kpe<a name='868'>
<a name='869'>
   LOGICAL, EXTERNAL ::  wrf_dm_on_monitor<a name='870'>
<a name='871'>
   INTEGER :: i , j , k , myproc<a name='872'>
   INTEGER, DIMENSION(256) :: ipath  <font color=#447700>! array for integer coded ascii for passing path down to get_terrain<a name='873'></font>
   CHARACTER*256 :: message, message2<a name='874'>
   CHARACTER*256 :: rsmas_data_path<a name='875'>
<a name='876'>
#if DM_PARALLEL<a name='877'>
<font color=#447700>! Local globally sized arrays<a name='878'></font>
   REAL , DIMENSION(ids:ide,jds:jde) :: ht_g, xlat_g, xlon_g<a name='879'>
#endif<a name='880'>
<a name='881'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_2"> ( myproc )<a name='882'>
<a name='883'>
#if 0<a name='884'>
CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_3"> ( grid, current_timestr=message2 )<a name='885'>
WRITE ( message , FMT = '(A," HT before ",I3)' ) TRIM(message2), grid%id<a name='886'>
write(30+myproc,*)ipe-ips+1,jpe-jps+1,trim(message)<a name='887'>
do j = jps,jpe<a name='888'>
do i = ips,ipe<a name='889'>
write(30+myproc,*)grid%ht(i,j)<a name='890'>
enddo<a name='891'>
enddo<a name='892'>
#endif<a name='893'>
<a name='894'>
   CALL nl_get_rsmas_data_path(1,rsmas_data_path)<a name='895'>
   do i = 1, LEN(TRIM(rsmas_data_path))<a name='896'>
      ipath(i) = ICHAR(rsmas_data_path(i:i))<a name='897'>
   enddo<a name='898'>
<a name='899'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='900'></font>
<a name='901'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_1"> ( grid%xlat , xlat_g , grid%domdesc, ' ' , 'xy' ,       &amp;<a name='902'>
                                   ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='903'>
                                   ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='904'>
                                   ips, ipe   , jps , jpe   , 1 , 1   )<a name='905'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_2"> ( grid%xlong , xlon_g , grid%domdesc, ' ' , 'xy' ,       &amp;<a name='906'>
                                   ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='907'>
                                   ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='908'>
                                   ips, ipe   , jps , jpe   , 1 , 1   )<a name='909'>
<a name='910'>
   IF ( wrf_dm_on_monitor() ) THEN<a name='911'>
     CALL get_terrain ( grid%dx/1000., xlat_g(ids:ide,jds:jde), xlon_g(ids:ide,jds:jde), ht_g(ids:ide,jds:jde), &amp;<a name='912'>
                        ide-ids+1,jde-jds+1,ide-ids+1,jde-jds+1, ipath, LEN(TRIM(rsmas_data_path)) )<a name='913'>
     WHERE ( ht_g(ids:ide,jds:jde) &lt; -1000. ) ht_g(ids:ide,jds:jde) = 0.<a name='914'>
   ENDIF<a name='915'>
<a name='916'>
   CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GLOBAL_TO_PATCH_REAL'>wrf_global_to_patch_real</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GLOBAL_TO_PATCH_REAL_1"> ( ht_g , grid%ht , grid%domdesc, ' ' , 'xy' ,         &amp;<a name='917'>
                                   ids, ide-1 , jds , jde-1 , 1 , 1 , &amp;<a name='918'>
                                   ims, ime   , jms , jme   , 1 , 1 , &amp;<a name='919'>
                                   ips, ipe   , jps , jpe   , 1 , 1   )<a name='920'>
#else<a name='921'>
<a name='922'>
   CALL get_terrain ( grid%dx/1000., grid%xlat(ids:ide,jds:jde), grid%xlong(ids:ide,jds:jde), grid%ht(ids:ide,jds:jde), &amp;<a name='923'>
                       ide-ids+1,jde-jds+1,ide-ids+1,jde-jds+1, ipath, LEN(TRIM(rsmas_data_path)) )<a name='924'>
   WHERE ( grid%ht(ids:ide,jds:jde) &lt; -1000. ) grid%ht(ids:ide,jds:jde) = 0.<a name='925'>
<a name='926'>
#endif<a name='927'>
<a name='928'>
#if 0<a name='929'>
CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#INPUT_TERRAIN_RSMAS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_4"> ( grid, current_timestr=message2 )<a name='930'>
WRITE ( message , FMT = '(A," HT after ",I3)' ) TRIM(message2), grid%id<a name='931'>
write(30+myproc,*)ipe-ips+1,jpe-jps+1,trim(message)<a name='932'>
do j = jps,jpe<a name='933'>
do i = ips,ipe<a name='934'>
write(30+myproc,*)grid%ht(i,j)<a name='935'>
enddo<a name='936'>
enddo<a name='937'>
#endif<a name='938'>
<a name='939'>
END SUBROUTINE input_terrain_rsmas<a name='940'>
<a name='941'>
<A NAME='UPDATE_AFTER_FEEDBACK_EM'><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='942'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>update_after_feedback_em</font> ( grid  &amp; <A href='../../call_to/UPDATE_AFTER_FEEDBACK_EM.html' TARGET='index'>1</A>,<A href='../../call_from/UPDATE_AFTER_FEEDBACK_EM.html' TARGET='index'>14</A><a name='943'>
<font color=#447700>!<a name='944'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_1"><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='945'>
<font color=#447700>!<a name='946'></font>
                 )<a name='947'>
<font color=#447700>!<a name='948'></font>
<font color=#447700>! perform core specific updates, exchanges after<a name='949'></font>
<font color=#447700>! model feedback  (called from med_feedback_domain) -John<a name='950'></font>
<font color=#447700>!<a name='951'></font>
<a name='952'>
<font color=#447700>! Driver layer modules<a name='953'></font>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_25">, ONLY : domain, get_ijk_from_grid<a name='954'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_17"><a name='955'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_4"><a name='956'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_3"><a name='957'>
   USE <A href='../../html_code/frame/module_tiles.F.html#MODULE_TILES'>module_tiles</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TILES_3"><a name='958'>
#ifdef DM_PARALLEL<a name='959'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_14">, ONLY : ntasks, ntasks_x, ntasks_y, itrace, local_communicator, mytask<a name='960'>
   USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_7">, ONLY : HALO_EM_FEEDBACK_sub<a name='961'>
#else<a name='962'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_15"><a name='963'>
#endif<a name='964'>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_9"><a name='965'>
<font color=#447700>! Mediation layer modules<a name='966'></font>
<font color=#447700>! Registry generated module<a name='967'></font>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_12"><a name='968'>
<a name='969'>
   IMPLICIT NONE<a name='970'>
<a name='971'>
   <font color=#447700>!  Subroutine interface block.<a name='972'></font>
<a name='973'>
   TYPE(domain) , TARGET         :: grid<a name='974'>
<a name='975'>
   <font color=#447700>!  Definitions of dummy arguments<a name='976'></font>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_2"><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='977'>
<a name='978'>
   INTEGER                         :: ids , ide , jds , jde , kds , kde , &amp;<a name='979'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='980'>
                                      ips , ipe , jps , jpe , kps , kpe<a name='981'>
<a name='982'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_27">( 500, "entering update_after_feedback_em" )<a name='983'>
<a name='984'>
<font color=#447700>!  Obtain dimension information stored in the grid data structure.<a name='985'></font>
  CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_7"> (  grid ,                   &amp;<a name='986'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='987'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='988'>
                            ips, ipe, jps, jpe, kps, kpe    )<a name='989'>
<a name='990'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_28">( 500, "before HALO_EM_FEEDBACK.inc in update_after_feedback_em" )<a name='991'>
#ifdef DM_PARALLEL<a name='992'>
#include "<A href='../../html_code/include/HALO_EM_FEEDBACK.inc.html'>HALO_EM_FEEDBACK.inc</A>"<A NAME="HALO_EM_FEEDBACK.inc_3"><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='993'>
#endif<a name='994'>
  CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/nest_init_utils.F.html#UPDATE_AFTER_FEEDBACK_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_29">( 500, "leaving update_after_feedback_em" )<a name='995'>
<a name='996'>
END SUBROUTINE update_after_feedback_em<a name='997'>
<a name='998'>
</pre></body></html>