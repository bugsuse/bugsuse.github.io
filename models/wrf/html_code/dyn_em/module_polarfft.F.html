<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( HYBRID_COORD==1 ) <a name='2'>
#  define mub(...) (c1(k)*XXPCBXX(__VA_ARGS__)+c2(k))<a name='3'>
#  define XXPCBXX(...) mub(__VA_ARGS__)<a name='4'>
<a name='5'>
#  define mu(...)  (c1(k)*XXPCXX(__VA_ARGS__))<a name='6'>
#  define XXPCXX(...) mu(__VA_ARGS__)<a name='7'>
#endif<a name='8'>
<a name='9'>
<A NAME='MODULE_POLARFFT'><A href='../../html_code/dyn_em/module_polarfft.F.html#MODULE_POLARFFT' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='10'>
<font color=#993300>MODULE </font><font color=#cc0000>module_polarfft</font> <A href='../../call_to/MODULE_POLARFFT.html' TARGET='index'>1</A><a name='11'>
<a name='12'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_polarfft.F.html#module_polarfft.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_10"><a name='13'>
  USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/dyn_em/module_polarfft.F.html#module_polarfft.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_6"><a name='14'>
  CHARACTER (LEN=256) , PRIVATE :: a_message<a name='15'>
<a name='16'>
CONTAINS<a name='17'>
<a name='18'>
<A NAME='COUPLE_SCALARS_FOR_FILTER'><A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='19'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>couple_scalars_for_filter</font> ( field    &amp; <A href='../../call_to/COUPLE_SCALARS_FOR_FILTER.html' TARGET='index'>8</A><a name='20'>
                 ,mu,mub,c1,c2                  &amp;<a name='21'>
                 ,ids,ide,jds,jde,kds,kde       &amp;<a name='22'>
                 ,ims,ime,jms,jme,kms,kme       &amp;<a name='23'>
                 ,ips,ipe,jps,jpe,kps,kpe       )<a name='24'>
   IMPLICIT NONE<a name='25'>
   INTEGER, INTENT(IN) :: ids,ide,jds,jde,kds,kde       &amp;<a name='26'>
                         ,ims,ime,jms,jme,kms,kme       &amp;<a name='27'>
                         ,ips,ipe,jps,jpe,kps,kpe<a name='28'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(INOUT) :: field<a name='29'>
   REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: mu,mub<a name='30'>
   REAL , DIMENSION(kms:kme) , INTENT(IN) :: c1,c2<a name='31'>
<a name='32'>
   INTEGER :: i , j , k<a name='33'>
<a name='34'>
   DO j = jps, MIN(jpe,jde-1)<a name='35'>
   DO k = kps, kpe-1<a name='36'>
   DO i = ips, MIN(ipe,ide-1)<a name='37'>
      field(i,k,j)=field(i,k,j)*(mu(i,j)+mub(i,j))<a name='38'>
   END DO<a name='39'>
   END DO<a name='40'>
   END DO<a name='41'>
<a name='42'>
END SUBROUTINE couple_scalars_for_filter<a name='43'>
<a name='44'>
<A NAME='UNCOUPLE_SCALARS_FOR_FILTER'><A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='45'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>uncouple_scalars_for_filter</font> ( field    &amp; <A href='../../call_to/UNCOUPLE_SCALARS_FOR_FILTER.html' TARGET='index'>8</A><a name='46'>
                 ,mu,mub,c1,c2                  &amp;<a name='47'>
                 ,ids,ide,jds,jde,kds,kde       &amp;<a name='48'>
                 ,ims,ime,jms,jme,kms,kme       &amp;<a name='49'>
                 ,ips,ipe,jps,jpe,kps,kpe       )<a name='50'>
   IMPLICIT NONE<a name='51'>
   INTEGER, INTENT(IN) :: ids,ide,jds,jde,kds,kde       &amp;<a name='52'>
                         ,ims,ime,jms,jme,kms,kme       &amp;<a name='53'>
                         ,ips,ipe,jps,jpe,kps,kpe<a name='54'>
   REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(INOUT) :: field<a name='55'>
   REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: mu,mub<a name='56'>
   REAL , DIMENSION(kms:kme) , INTENT(IN) :: c1,c2<a name='57'>
<a name='58'>
   INTEGER :: i , j , k<a name='59'>
<a name='60'>
   DO j = jps, MIN(jpe,jde-1)<a name='61'>
   DO k = kps, kpe-1<a name='62'>
   DO i = ips, MIN(ipe,ide-1)<a name='63'>
      field(i,k,j)=field(i,k,j)/(mu(i,j)+mub(i,j))<a name='64'>
   END DO<a name='65'>
   END DO<a name='66'>
   END DO<a name='67'>
<a name='68'>
END SUBROUTINE uncouple_scalars_for_filter<a name='69'>
<a name='70'>
<A NAME='PXFT'><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='71'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>pxft</font> ( grid                          &amp; <A href='../../call_to/PXFT.html' TARGET='index'>12</A>,<A href='../../call_from/PXFT.html' TARGET='index'>43</A><a name='72'>
                 ,lineno       &amp;<a name='73'>
                 ,flag_uv,flag_rurv             &amp;<a name='74'>
                 ,flag_wph,flag_ww              &amp;<a name='75'>
                 ,flag_t                        &amp;<a name='76'>
                 ,flag_mu,flag_mut              &amp;<a name='77'>
                 ,flag_moist                    &amp;<a name='78'>
                 ,flag_chem                     &amp;<a name='79'>
                 ,flag_tracer                   &amp;<a name='80'>
                 ,flag_scalar                   &amp;<a name='81'>
                 ,fft_filter_lat, dclat         &amp;<a name='82'>
                 ,actual_distance_average       &amp;<a name='83'>
                 ,pos_def                       &amp;<a name='84'>
                 ,swap_pole_with_next_j         &amp;<a name='85'>
                 ,moist,chem,tracer,scalar      &amp;<a name='86'>
                 ,ids,ide,jds,jde,kds,kde       &amp;<a name='87'>
                 ,ims,ime,jms,jme,kms,kme       &amp;<a name='88'>
                 ,ips,ipe,jps,jpe,kps,kpe       &amp;<a name='89'>
                 ,imsx,imex,jmsx,jmex,kmsx,kmex &amp;<a name='90'>
                 ,ipsx,ipex,jpsx,jpex,kpsx,kpex )<a name='91'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_10"><a name='92'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_13">, ONLY : domain<a name='93'>
#ifdef DM_PARALLEL<a name='94'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_9">, ONLY : local_communicator, mytask, ntasks, ntasks_x, ntasks_y &amp;<a name='95'>
                       , local_communicator_periodic, itrace                    &amp;<a name='96'>
                       , local_communicator_x <a name='97'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_3"><a name='98'>
#if 0<a name='99'>
   USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_5">, ONLY : &amp;<a name='100'>
                 XPOSE_POLAR_FILTER_V_z2x_sub           &amp;<a name='101'>
                ,XPOSE_POLAR_FILTER_V_x2z_sub           &amp;<a name='102'>
                ,XPOSE_POLAR_FILTER_U_z2x_sub           &amp;<a name='103'>
                ,XPOSE_POLAR_FILTER_U_x2z_sub           &amp;<a name='104'>
                ,XPOSE_POLAR_FILTER_T_z2x_sub           &amp;<a name='105'>
                ,XPOSE_POLAR_FILTER_T_x2z_sub           &amp;<a name='106'>
                ,XPOSE_POLAR_FILTER_W_z2x_sub           &amp;<a name='107'>
                ,XPOSE_POLAR_FILTER_W_x2z_sub           &amp;<a name='108'>
                ,XPOSE_POLAR_FILTER_PH_z2x_sub          &amp;<a name='109'>
                ,XPOSE_POLAR_FILTER_PH_x2z_sub          &amp;<a name='110'>
                ,XPOSE_POLAR_FILTER_WW_z2x_sub          &amp;<a name='111'>
                ,XPOSE_POLAR_FILTER_WW_x2z_sub          &amp;<a name='112'>
                ,XPOSE_POLAR_FILTER_RV_z2x_sub          &amp;<a name='113'>
                ,XPOSE_POLAR_FILTER_RV_x2z_sub          &amp;<a name='114'>
                ,XPOSE_POLAR_FILTER_RU_z2x_sub          &amp;<a name='115'>
                ,XPOSE_POLAR_FILTER_RU_x2z_sub          &amp;<a name='116'>
                ,XPOSE_POLAR_FILTER_MOIST_z2x_sub       &amp;<a name='117'>
                ,XPOSE_POLAR_FILTER_MOIST_x2z_sub       &amp;<a name='118'>
                ,XPOSE_POLAR_FILTER_CHEM_z2x_sub        &amp;<a name='119'>
                ,XPOSE_POLAR_FILTER_MOIST_x2z_sub       &amp;<a name='120'>
                ,XPOSE_POLAR_FILTER_TRACER_z2x_sub      &amp;<a name='121'>
                ,XPOSE_POLAR_FILTER_TRACER_x2z_sub      &amp;<a name='122'>
                ,XPOSE_POLAR_FILTER_SCALAR_z2x_sub      &amp;<a name='123'>
                ,XPOSE_POLAR_FILTER_SCALAR_x2z_sub<a name='124'>
#endif<a name='125'>
#else<a name='126'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_10"><a name='127'>
#endif<a name='128'>
   IMPLICIT NONE<a name='129'>
   <font color=#447700>!  Input data.<a name='130'></font>
   TYPE(domain) , TARGET          :: grid<a name='131'>
integer, intent(in) :: lineno<a name='132'>
integer myproc, i, j, k<a name='133'>
   LOGICAL, INTENT(IN) :: actual_distance_average<a name='134'>
   LOGICAL, INTENT(IN) :: pos_def<a name='135'>
   LOGICAL, INTENT(IN) :: swap_pole_with_next_j<a name='136'>
   INTEGER, INTENT(IN) :: ids,ide,jds,jde,kds,kde       &amp;<a name='137'>
                         ,ims,ime,jms,jme,kms,kme       &amp;<a name='138'>
                         ,ips,ipe,jps,jpe,kps,kpe       &amp;<a name='139'>
                         ,imsx,imex,jmsx,jmex,kmsx,kmex &amp;<a name='140'>
                         ,ipsx,ipex,jpsx,jpex,kpsx,kpex<a name='141'>
   REAL  , INTENT(IN) :: fft_filter_lat<a name='142'>
   REAL,    INTENT(IN) :: dclat<a name='143'>
   INTEGER, INTENT(IN) :: flag_uv                       &amp;<a name='144'>
                         ,flag_rurv                     &amp;<a name='145'>
                         ,flag_ww                       &amp;<a name='146'>
                         ,flag_t,flag_wph               &amp;<a name='147'>
                         ,flag_mu,flag_mut              &amp;<a name='148'>
                         ,flag_moist                    &amp;<a name='149'>
                         ,flag_chem                     &amp;<a name='150'>
                         ,flag_tracer                   &amp;<a name='151'>
                         ,flag_scalar<a name='152'>
    REAL, DIMENSION(ims:ime,kms:kme,jms:jme,*) , INTENT(INOUT) :: moist, chem, scalar,tracer<a name='153'>
<a name='154'>
   <font color=#447700>! Local<a name='155'></font>
   LOGICAL piggyback_mu, piggyback_mut<a name='156'>
   INTEGER ij, k_end<a name='157'>
<a name='158'>
#ifdef DM_PARALLEL<a name='159'>
#else<a name='160'>
   INTEGER itrace<a name='161'>
#endif<a name='162'>
<a name='163'>
<a name='164'>
   piggyback_mu  = flag_mu .EQ. 1<a name='165'>
   piggyback_mut = flag_mut .EQ. 1<a name='166'>
<a name='167'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='168'></font>
<font color=#447700>!<a name='169'></font>
<font color=#447700>! The idea is that this parallel transpose fft routine can be<a name='170'></font>
<font color=#447700>! called at various points in the solver (solve_em) and it will filter<a name='171'></font>
<font color=#447700>! the correct fields based on the flag arguments.  There are two 2d<a name='172'></font>
<font color=#447700>! fields mu_2 and mut  that may need to be filtered too. Since a two-d<a name='173'></font>
<font color=#447700>! parallel transpose would be inefficient and because the fields that are<a name='174'></font>
<font color=#447700>! not staggered in z have an extra layer anyway, these can be<a name='175'></font>
<font color=#447700>! piggybacked.  This is handled using latches to makes sure that *somebody*<a name='176'></font>
<font color=#447700>! carries one or both of these on their back through the filtering and then<a name='177'></font>
<font color=#447700>! copies them back afterwards. IMPORTANT NOTE: for simplicity, this routine<a name='178'></font>
<font color=#447700>! is not completely general.  It makes the following assumptions:<a name='179'></font>
<font color=#447700>! <a name='180'></font>
<font color=#447700>! 1) If both flag_mu and flag_mut are specified then flag_uv is also specified<a name='181'></font>
<font color=#447700>! <a name='182'></font>
<font color=#447700>! 2) If flag_uv is not specified, then only flag_mu and not flag_mut can be<a name='183'></font>
<font color=#447700>! <a name='184'></font>
<font color=#447700>! 3) If flag_mu is specified than either flag_uv or flag_t must be<a name='185'></font>
<font color=#447700>!<a name='186'></font>
<font color=#447700>! This is designed to keep the clutter to a minimum in solve_em. <a name='187'></font>
<font color=#447700>! This is not intended to be a general abstraction of the polar filtering<a name='188'></font>
<font color=#447700>! calls in in WRF solvers or if the solve_em algorithms change.<a name='189'></font>
<font color=#447700>! If the needs of the calling solver change, this logic may have to be<a name='190'></font>
<font color=#447700>! rewritten.<a name='191'></font>
<font color=#447700>!<a name='192'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='193'></font>
<font color=#447700>!write(0,*)__FILE__,__LINE__,' short circuit '<a name='194'></font>
<font color=#447700>!return<a name='195'></font>
<a name='196'>
<font color=#447700>!write(0,*)'pxft called from ',lineno<a name='197'></font>
call <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_GET_MYPROC'>wrf_get_myproc</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_GET_MYPROC_1">(myproc)<a name='198'>
<font color=#447700>!write(20+myproc,*)ipex-ipsx+1,jpex-jpsx+1,' clat_xxx '<a name='199'></font>
<font color=#447700>!do j = jpsx, jpex<a name='200'></font>
<font color=#447700>!do i = ipsx, ipex<a name='201'></font>
<font color=#447700>!write(20+myproc,*)grid%clat_xxx(i,j)<a name='202'></font>
<font color=#447700>!enddo<a name='203'></font>
<font color=#447700>!enddo<a name='204'></font>
<a name='205'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='206'></font>
<font color=#447700>! U &amp; V<a name='207'></font>
   IF ( flag_uv .EQ. 1 ) THEN<a name='208'>
     IF ( piggyback_mu ) THEN<a name='209'>
       grid%u_2(ips:ipe,kde,jps:jpe) = grid%mu_2(ips:ipe,jps:jpe) <a name='210'>
     ENDIF<a name='211'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='212'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_V_z2x.inc.html'>XPOSE_POLAR_FILTER_V_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_V_z2x.inc_1"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='213'>
<a name='214'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_1">( grid%v_xxx, grid%clat_xxx, .false.,     &amp;<a name='215'>
                                fft_filter_lat, dclat,                 &amp;<a name='216'>
                                ids, ide, jds, jde, kds, kde-1,         &amp;<a name='217'>
                                imsx, imex, jmsx, jmex, kmsx, kmex,     &amp;<a name='218'>
                                ipsx, ipex, jpsx, jpex, kpsx, MIN(kde-1,kpex ) )<a name='219'>
<a name='220'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_V_x2z.inc.html'>XPOSE_POLAR_FILTER_V_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_V_x2z.inc_2"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='221'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_U_z2x.inc.html'>XPOSE_POLAR_FILTER_U_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_U_z2x.inc_3"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='222'>
     k_end = MIN(kde-1,kpex)<a name='223'>
     IF ( piggyback_mu ) k_end = MIN(kde,kpex)<a name='224'>
<a name='225'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_2">( grid%u_xxx, grid%clat_xxx, piggyback_mu,     &amp;<a name='226'>
                                fft_filter_lat, 0.,                &amp;<a name='227'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='228'>
                                imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='229'>
                                ipsx, ipex, jpsx, jpex, kpsx, k_end )<a name='230'>
<a name='231'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_U_x2z.inc.html'>XPOSE_POLAR_FILTER_U_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_U_x2z.inc_4"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='232'>
#else<a name='233'>
<a name='234'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_3">( grid%v_2, grid%clat, .false.,     &amp;<a name='235'>
                                fft_filter_lat, dclat,             &amp;<a name='236'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='237'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='238'>
                                ips, ipe, jps, jpe, kps, MIN(kde-1,kpe) )<a name='239'>
<a name='240'>
     k_end = MIN(kde-1,kpe)<a name='241'>
     IF ( piggyback_mu ) k_end = MIN(kde,kpe)<a name='242'>
<a name='243'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_4">( grid%u_2, grid%clat, piggyback_mu,     &amp;<a name='244'>
                                fft_filter_lat, 0.,                &amp;<a name='245'>
                                ids, ide, jds, jde, kds, kde-1,     &amp;<a name='246'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='247'>
                                ips, ipe, jps, jpe, kps, k_end )<a name='248'>
<a name='249'>
#endif<a name='250'>
<a name='251'>
     IF ( piggyback_mu ) THEN<a name='252'>
       grid%mu_2(ips:ipe,jps:jpe) = grid%u_2(ips:ipe,kde,jps:jpe)<a name='253'>
       piggyback_mu = .FALSE.<a name='254'>
     ENDIF<a name='255'>
   ENDIF<a name='256'>
<a name='257'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='258'></font>
<font color=#447700>! T<a name='259'></font>
   IF ( flag_t .EQ. 1 ) THEN<a name='260'>
     IF ( piggyback_mu ) THEN<a name='261'>
       grid%t_2(ips:ipe,kde,jps:jpe) = grid%mu_2(ips:ipe,jps:jpe)<a name='262'>
     ENDIF<a name='263'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='264'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_T_z2x.inc.html'>XPOSE_POLAR_FILTER_T_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_T_z2x.inc_5"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='265'>
     k_end = MIN(kde-1,kpex)<a name='266'>
     IF ( piggyback_mu ) k_end = MIN(kde,kpex)<a name='267'>
<a name='268'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_5">( grid%t_xxx, grid%clat_xxx,piggyback_mu,     &amp;<a name='269'>
                                fft_filter_lat, 0.,                &amp;<a name='270'>
                                ids, ide, jds, jde, kds, kde-1,     &amp;<a name='271'>
                                imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='272'>
                                ipsx, ipex, jpsx, jpex, kpsx, k_end )<a name='273'>
<a name='274'>
     IF ( actual_distance_average ) THEN<a name='275'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_1"> ( grid%t_xxx , grid%clat_xxx , grid%mf_xxx , &amp;<a name='276'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='277'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='278'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='279'>
                             imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='280'>
                             ipsx, ipex, jpsx, jpex, kpsx, kpex )<a name='281'>
     END IF<a name='282'>
<a name='283'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_T_x2z.inc.html'>XPOSE_POLAR_FILTER_T_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_T_x2z.inc_6"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='284'>
#else<a name='285'>
     k_end = MIN(kde-1,kpe)<a name='286'>
     IF ( piggyback_mu ) k_end = MIN(kde,kpe)<a name='287'>
<a name='288'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_6">( grid%t_2, grid%clat, piggyback_mu,     &amp;<a name='289'>
                                fft_filter_lat, 0.,                &amp;<a name='290'>
                                ids, ide, jds, jde, kds, kde-1,     &amp;<a name='291'>
                                ims, ime, jms, jme, kms, kme,       &amp;<a name='292'>
                                ips, ipe, jps, jpe, kps, k_end )<a name='293'>
<a name='294'>
     IF ( actual_distance_average ) THEN<a name='295'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_2"> ( grid%t_2 , grid%clat , grid%msft , &amp;<a name='296'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='297'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='298'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='299'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='300'>
                             ips, ipe, jps, jpe, kps, k_end )<a name='301'>
     END IF<a name='302'>
<a name='303'>
#endif<a name='304'>
     IF ( piggyback_mu ) THEN<a name='305'>
       grid%mu_2(ips:ipe,jps:jpe) = grid%t_2(ips:ipe,kde,jps:jpe)<a name='306'>
       piggyback_mu = .FALSE.<a name='307'>
     ENDIF<a name='308'>
   ENDIF<a name='309'>
<a name='310'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='311'></font>
<font color=#447700>! W and PH<a name='312'></font>
   IF ( flag_wph .EQ. 1 ) THEN<a name='313'>
      <font color=#447700>! W AND PH USE ALL LEVELS SO NEVER PIGGYBACK, MU IS OUT OF LUCK HERE<a name='314'></font>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='315'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_W_z2x.inc.html'>XPOSE_POLAR_FILTER_W_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_W_z2x.inc_7"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='316'>
      CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_7">( grid%w_xxx, grid%clat_xxx, .false.,     &amp;<a name='317'>
                                 fft_filter_lat, 0.,                &amp;<a name='318'>
                                 ids, ide, jds, jde, kds, kde,       &amp;<a name='319'>
                                 imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='320'>
                                 ipsx, ipex, jpsx, jpex, kpsx, kpex )<a name='321'>
<a name='322'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_W_x2z.inc.html'>XPOSE_POLAR_FILTER_W_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_W_x2z.inc_8"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='323'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_PH_z2x.inc.html'>XPOSE_POLAR_FILTER_PH_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_PH_z2x.inc_9"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='324'>
<a name='325'>
      CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_8">( grid%ph_xxx, grid%clat_xxx, .false.,     &amp;<a name='326'>
                                 fft_filter_lat, 0.,                &amp;<a name='327'>
                                 ids, ide, jds, jde, kds, kde,       &amp;<a name='328'>
                                 imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='329'>
                                 ipsx, ipex, jpsx, jpex, kpsx, kpex )<a name='330'>
<a name='331'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_PH_x2z.inc.html'>XPOSE_POLAR_FILTER_PH_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_PH_x2z.inc_10"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='332'>
#else<a name='333'>
<a name='334'>
      CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_9">( grid%w_2, grid%clat,  .false.,     &amp;<a name='335'>
                                 fft_filter_lat, 0.,                &amp;<a name='336'>
                                 ids, ide, jds, jde, kds, kde,       &amp;<a name='337'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='338'>
                                 ips, ipe, jps, jpe, kps, kpe )<a name='339'>
<a name='340'>
      CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_10">( grid%ph_2, grid%clat, .false.,     &amp;<a name='341'>
                                 fft_filter_lat, 0.,                &amp;<a name='342'>
                                 ids, ide, jds, jde, kds, kde,       &amp;<a name='343'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='344'>
                                 ips, ipe, jps, jpe, kps, kpe )<a name='345'>
#endif<a name='346'>
   ENDIF<a name='347'>
<a name='348'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='349'></font>
<font color=#447700>! WW<a name='350'></font>
   IF ( flag_ww .EQ. 1 ) THEN<a name='351'>
      <font color=#447700>! WW USES ALL LEVELS SO NEVER PIGGYBACK, MU IS OUT OF LUCK HERE<a name='352'></font>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='353'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_WW_z2x.inc.html'>XPOSE_POLAR_FILTER_WW_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_WW_z2x.inc_11"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='354'>
      CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_11">( grid%ww_xxx, grid%clat_xxx, .false.,     &amp;<a name='355'>
                                 fft_filter_lat, 0.,                &amp;<a name='356'>
                                 ids, ide, jds, jde, kds, kde,       &amp;<a name='357'>
                                 imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='358'>
                                 ipsx, ipex, jpsx, jpex, kpsx, kpex )<a name='359'>
<a name='360'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_WW_x2z.inc.html'>XPOSE_POLAR_FILTER_WW_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_WW_x2z.inc_12"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='361'>
#else<a name='362'>
      CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_12">( grid%ww_m, grid%clat, .false.,     &amp;<a name='363'>
                                 fft_filter_lat, 0.,                &amp;<a name='364'>
                                 ids, ide, jds, jde, kds, kde,       &amp;<a name='365'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='366'>
                                 ips, ipe, jps, jpe, kps, kpe )<a name='367'>
#endif<a name='368'>
   ENDIF<a name='369'>
<a name='370'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='371'></font>
<font color=#447700>! RU AND RV<a name='372'></font>
   IF ( flag_rurv .EQ. 1 ) THEN<a name='373'>
     IF ( piggyback_mut ) THEN<a name='374'>
       grid%ru_m(ips:ipe,kde,jps:jpe) = grid%mut(ips:ipe,jps:jpe)<a name='375'>
     ENDIF<a name='376'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='377'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_RV_z2x.inc.html'>XPOSE_POLAR_FILTER_RV_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_RV_z2x.inc_13"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='378'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_13">( grid%rv_xxx, grid%clat_xxx, .false.,     &amp;<a name='379'>
                                fft_filter_lat, dclat,             &amp;<a name='380'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='381'>
                                imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='382'>
                                ipsx, ipex, jpsx, jpex, kpsx, MIN(kpex,kde-1) )<a name='383'>
<a name='384'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_RV_x2z.inc.html'>XPOSE_POLAR_FILTER_RV_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_RV_x2z.inc_14"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='385'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_RU_z2x.inc.html'>XPOSE_POLAR_FILTER_RU_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_RU_z2x.inc_15"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='386'>
     k_end = MIN(kde-1,kpex)<a name='387'>
     IF ( piggyback_mut ) k_end = MIN(kde,kpex)<a name='388'>
<a name='389'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_14">( grid%ru_xxx, grid%clat_xxx, piggyback_mut,     &amp;<a name='390'>
                                fft_filter_lat, 0.,                &amp;<a name='391'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='392'>
                                imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='393'>
                                ipsx, ipex, jpsx, jpex, kpsx, k_end )<a name='394'>
#include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_RU_x2z.inc.html'>XPOSE_POLAR_FILTER_RU_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_RU_x2z.inc_16"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='395'>
#else<a name='396'>
<a name='397'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_15">( grid%rv_m, grid%clat, .false.,     &amp;<a name='398'>
                                fft_filter_lat, dclat,             &amp;<a name='399'>
                                ids, ide, jds, jde, kds, kde,       &amp;<a name='400'>
                                ims, ime, jms, jme, kms, kme, &amp;<a name='401'>
                                ips, ipe, jps, jpe, kps, MIN(kde-1,kpe) )<a name='402'>
<a name='403'>
     k_end = MIN(kde-1,kpe)<a name='404'>
     IF ( piggyback_mut ) k_end = MIN(kde,kpe)<a name='405'>
<a name='406'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_16">( grid%ru_m, grid%clat, piggyback_mut,     &amp;<a name='407'>
                                fft_filter_lat, 0.,                &amp;<a name='408'>
                                ids, ide, jds, jde, kds, kde-1,       &amp;<a name='409'>
                                ims, ime, jms, jme, kms, kme, &amp;<a name='410'>
                                ips, ipe, jps, jpe, kps, k_end )<a name='411'>
#endif<a name='412'>
     IF ( piggyback_mut ) THEN<a name='413'>
       grid%mut(ips:ipe,jps:jpe) = grid%ru_m(ips:ipe,kde,jps:jpe)<a name='414'>
       piggyback_mut = .FALSE.<a name='415'>
     ENDIF<a name='416'>
   ENDIF<a name='417'>
<a name='418'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='419'></font>
<font color=#447700>! MOIST<a name='420'></font>
   IF ( flag_moist .GE. PARAM_FIRST_SCALAR ) THEN<a name='421'>
     itrace = flag_moist<a name='422'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='423'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_MOIST_z2x.inc.html'>XPOSE_POLAR_FILTER_MOIST_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_MOIST_z2x.inc_17"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='424'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_17">( grid%fourd_xxx, grid%clat_xxx, .false. ,     &amp;<a name='425'>
                           fft_filter_lat, 0.,                &amp;<a name='426'>
                           ids, ide, jds, jde, kds, kde,       &amp;<a name='427'>
                           imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='428'>
                           ipsx, ipex, jpsx, jpex, kpsx, MIN(kpex,kde-1) )<a name='429'>
<a name='430'>
     IF ( actual_distance_average ) THEN<a name='431'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_3"> ( grid%fourd_xxx , grid%clat_xxx , grid%mf_xxx , &amp;<a name='432'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='433'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='434'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='435'>
                             imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='436'>
                             ipsx, ipex, jpsx, jpex, kpsx, kpex )<a name='437'>
     END IF<a name='438'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_MOIST_x2z.inc.html'>XPOSE_POLAR_FILTER_MOIST_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_MOIST_x2z.inc_18"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='439'>
#else<a name='440'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_18">( moist(ims,kms,jms,itrace), grid%clat, .false.,     &amp;<a name='441'>
                           fft_filter_lat, 0.,                &amp;<a name='442'>
                           ids, ide, jds, jde, kds, kde,       &amp;<a name='443'>
                           ims, ime, jms, jme, kms, kme, &amp;<a name='444'>
                           ips, ipe, jps, jpe, kps, MIN(kpe,kde-1) )<a name='445'>
<a name='446'>
     IF ( actual_distance_average ) THEN<a name='447'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_4"> ( moist(ims,kms,jms,itrace) , grid%clat , grid%msft , &amp;<a name='448'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='449'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='450'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='451'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='452'>
                             ips, ipe, jps, jpe, kps, MIN(kpe,kde-1) )<a name='453'>
     END IF<a name='454'>
#endif<a name='455'>
   ENDIF<a name='456'>
<a name='457'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='458'></font>
<font color=#447700>! CHEM<a name='459'></font>
   IF ( flag_chem .GE. PARAM_FIRST_SCALAR ) THEN<a name='460'>
     itrace = flag_chem<a name='461'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='462'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_CHEM_z2x.inc.html'>XPOSE_POLAR_FILTER_CHEM_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_CHEM_z2x.inc_19"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='463'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_19">( grid%fourd_xxx, grid%clat_xxx, .false. ,     &amp;<a name='464'>
                           fft_filter_lat, 0.,                &amp;<a name='465'>
                           ids, ide, jds, jde, kds, kde,       &amp;<a name='466'>
                           imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='467'>
                           ipsx, ipex, jpsx, jpex, kpsx, MIN(kpex,kde-1) )<a name='468'>
<a name='469'>
     IF ( actual_distance_average ) THEN<a name='470'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_5"> ( grid%fourd_xxx , grid%clat_xxx , grid%mf_xxx , &amp;<a name='471'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='472'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='473'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='474'>
                             imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='475'>
                             ipsx, ipex, jpsx, jpex, kpsx, kpex )<a name='476'>
     END IF<a name='477'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_CHEM_x2z.inc.html'>XPOSE_POLAR_FILTER_CHEM_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_CHEM_x2z.inc_20"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='478'>
#else<a name='479'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_20">( chem(ims,kms,jms,itrace), grid%clat, .false. ,     &amp;<a name='480'>
                           fft_filter_lat, 0.,                &amp;<a name='481'>
                           ids, ide, jds, jde, kds, kde,       &amp;<a name='482'>
                           ims, ime, jms, jme, kms, kme, &amp;<a name='483'>
                           ips, ipe, jps, jpe, kps, MIN(kpe,kde-1) )<a name='484'>
<a name='485'>
     IF ( actual_distance_average ) THEN<a name='486'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_6"> ( chem(ims,kms,jms,itrace) , grid%clat , grid%msft , &amp;<a name='487'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='488'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='489'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='490'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='491'>
                             ips, ipe, jps, jpe, kps, MIN(kpe,kde-1) )<a name='492'>
     END IF<a name='493'>
#endif<a name='494'>
   ENDIF<a name='495'>
<a name='496'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='497'></font>
<font color=#447700>! TRACER<a name='498'></font>
   IF ( flag_tracer .GE. PARAM_FIRST_SCALAR ) THEN<a name='499'>
     itrace = flag_tracer<a name='500'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='501'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_TRACER_z2x.inc.html'>XPOSE_POLAR_FILTER_TRACER_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_TRACER_z2x.inc_21"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='502'>
<a name='503'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_21">( grid%fourd_xxx, grid%clat_xxx, .false. ,     &amp;<a name='504'>
                           fft_filter_lat, 0.,                &amp;<a name='505'>
                           ids, ide, jds, jde, kds, kde,       &amp;<a name='506'>
                           imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='507'>
                           ipsx, ipex, jpsx, jpex, kpsx, MIN(kpex,kde-1) )<a name='508'>
<a name='509'>
     IF ( actual_distance_average ) THEN<a name='510'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_7"> ( grid%fourd_xxx , grid%clat_xxx , grid%mf_xxx , &amp;<a name='511'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='512'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='513'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='514'>
                             imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='515'>
                             ipsx, ipex, jpsx, jpex, kpsx, kpex )<a name='516'>
     END IF<a name='517'>
<a name='518'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_TRACER_x2z.inc.html'>XPOSE_POLAR_FILTER_TRACER_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_TRACER_x2z.inc_22"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='519'>
#else<a name='520'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_22">( tracer(ims,kms,jms,itrace), grid%clat, .false. ,     &amp;<a name='521'>
                           fft_filter_lat, 0.,                &amp;<a name='522'>
                           ids, ide, jds, jde, kds, kde,       &amp;<a name='523'>
                           ims, ime, jms, jme, kms, kme, &amp;<a name='524'>
                           ips, ipe, jps, jpe, kps, MIN(kpe,kde-1) )<a name='525'>
<a name='526'>
     IF ( actual_distance_average ) THEN<a name='527'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_8"> ( tracer(ims,kms,jms,itrace) , grid%clat , grid%msft , &amp;<a name='528'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='529'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='530'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='531'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='532'>
                             ips, ipe, jps, jpe, kps, MIN(kpe,kde-1) )<a name='533'>
     END IF<a name='534'>
#endif<a name='535'>
   ENDIF<a name='536'>
<a name='537'>
<font color=#447700>!!!!!!!!!!!!!!!!!!!!!!!<a name='538'></font>
<font color=#447700>! SCALAR<a name='539'></font>
   IF ( flag_scalar .GE. PARAM_FIRST_SCALAR ) THEN<a name='540'>
     itrace = flag_scalar<a name='541'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='542'></font>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_SCALAR_z2x.inc.html'>XPOSE_POLAR_FILTER_SCALAR_z2x.inc</A>"<A NAME="XPOSE_POLAR_FILTER_SCALAR_z2x.inc_23"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='543'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_23">( grid%fourd_xxx , grid%clat_xxx, .false. ,     &amp;<a name='544'>
                           fft_filter_lat, 0.,                &amp;<a name='545'>
                           ids, ide, jds, jde, kds, kde,       &amp;<a name='546'>
                           imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='547'>
                           ipsx, ipex, jpsx, jpex, kpsx, MIN(kpex,kde-1) )<a name='548'>
<a name='549'>
     IF ( actual_distance_average ) THEN<a name='550'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_9"> ( grid%fourd_xxx , grid%clat_xxx , grid%mf_xxx , &amp;<a name='551'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='552'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='553'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='554'>
                             imsx, imex, jmsx, jmex, kmsx, kmex, &amp;<a name='555'>
                             ipsx, ipex, jpsx, jpex, kpsx, kpex )<a name='556'>
     END IF<a name='557'>
# include "<A href='../../html_code/include/XPOSE_POLAR_FILTER_SCALAR_x2z.inc.html'>XPOSE_POLAR_FILTER_SCALAR_x2z.inc</A>"<A NAME="XPOSE_POLAR_FILTER_SCALAR_x2z.inc_24"><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='558'>
#else<a name='559'>
     CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D'>polar_filter_3d</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_3D_24">( scalar(ims,kms,jms,itrace) , grid%clat, .false. ,     &amp;<a name='560'>
                           fft_filter_lat, 0.,                &amp;<a name='561'>
                           ids, ide, jds, jde, kds, kde,       &amp;<a name='562'>
                           ims, ime, jms, jme, kms, kme, &amp;<a name='563'>
                           ips, ipe, jps, jpe, kps, MIN(kpe,kde-1) )<a name='564'>
<a name='565'>
     IF ( actual_distance_average ) THEN<a name='566'>
        CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER'>filter_tracer</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FILTER_TRACER_10"> ( scalar(ims,kms,jms,itrace) , grid%clat , grid%msft , &amp;<a name='567'>
                             grid%fft_filter_lat , grid%mf_fft , &amp;<a name='568'>
                             pos_def, swap_pole_with_next_j , &amp;<a name='569'>
                             ids, ide, jds, jde, kds, kde , &amp; <a name='570'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='571'>
                             ips, ipe, jps, jpe, kps, MIN(kpe,kde-1) )<a name='572'>
     END IF<a name='573'>
#endif<a name='574'>
   ENDIF<a name='575'>
<a name='576'>
   IF ( flag_mu .EQ. 1 .AND. piggyback_mu ) THEN<a name='577'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_29">("mu needed to get piggybacked on a transpose and did not")<a name='578'>
   ENDIF<a name='579'>
   IF ( flag_mut .EQ. 1 .AND. piggyback_mut ) THEN<a name='580'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_30">("mut needed to get piggybacked on a transpose and did not")<a name='581'>
   ENDIF<a name='582'>
<a name='583'>
<font color=#447700>!write(0,*)'pxft back to ',lineno<a name='584'></font>
   RETURN<a name='585'>
END SUBROUTINE pxft<a name='586'>
<a name='587'>
<A NAME='POLAR_FILTER_3D'><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='588'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>polar_filter_3d</font>( f, xlat, piggyback, fft_filter_lat, dvlat, &amp; <A href='../../call_to/POLAR_FILTER_3D.html' TARGET='index'>24</A>,<A href='../../call_from/POLAR_FILTER_3D.html' TARGET='index'>5</A><a name='589'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='590'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='591'>
                            its, ite, jts, jte, kts, kte     )<a name='592'>
<a name='593'>
  IMPLICIT NONE<a name='594'>
<a name='595'>
  INTEGER ,       INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='596'>
                                   ims, ime, jms, jme, kms, kme, &amp;<a name='597'>
                                   its, ite, jts, jte, kts, kte<a name='598'>
  REAL   ,       INTENT(IN   ) :: fft_filter_lat<a name='599'>
<a name='600'>
  REAL , DIMENSION( ims:ime , kms:kme, jms:jme ) , INTENT(INOUT) ::  f<a name='601'>
  REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN) ::  xlat<a name='602'>
  REAL , INTENT(IN) ::  dvlat<a name='603'>
  LOGICAL , INTENT(IN) :: piggyback<a name='604'>
<a name='605'>
  REAL , DIMENSION(1:ide-ids,1:kte-kts+1) :: sheet<a name='606'>
  REAL , DIMENSION(1:kte-kts+1) :: sheet_total<a name='607'>
  REAL :: lat, avg, rnboxw<a name='608'>
  INTEGER :: ig, jg, i, j, j_end, nx, ny, nmax, kw<a name='609'>
  INTEGER :: k, nboxw, nbox2, istart, iend, overlap<a name='610'>
  INTEGER, DIMENSION(6) :: wavenumber = (/ 1, 3, 7, 10, 13, 16 /)<a name='611'>
<a name='612'>
  INTEGER :: fftflag<a name='613'>
<a name='614'>
  <font color=#447700>! Variables will stay in domain form since this routine is meaningless<a name='615'></font>
  <font color=#447700>! unless tile extent is the same as domain extent in E/W direction, i.e.,<a name='616'></font>
  <font color=#447700>! the processor has access to all grid points in E/W direction.<a name='617'></font>
  <font color=#447700>! There may be other ways of doing FFTs, but we have not learned them yet...<a name='618'></font>
<a name='619'>
  <font color=#447700>! Check to make sure we have full access to all E/W points<a name='620'></font>
  IF ((its /= ids) .OR. (ite /= ide)) THEN<a name='621'>
     WRITE ( wrf_err_message , * ) 'module_polarfft: 3d: (its /= ids) or (ite /= ide)',its,ids,ite,ide<a name='622'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_31"> ( TRIM( wrf_err_message ) )<a name='623'>
  END IF<a name='624'>
<a name='625'>
  fftflag= 1  <font color=#447700>! call double-precision fft<a name='626'></font>
<font color=#447700>! fftflag= 0  ! call single-precision fft<a name='627'></font>
<a name='628'>
  nx = ide-ids <font color=#447700>! "U" stagger variables will be repeated by periodic BCs<a name='629'></font>
  ny = kte-kts+1 <font color=#447700>! we can filter extra level for variables that are non-Z-staggered<a name='630'></font>
  lat = 0.<a name='631'>
  j_end = MIN(jte, jde-1)<a name='632'>
  IF (dvlat /= 0. .and. j_end == jde-1) j_end = jde<a name='633'>
  DO j = jts, j_end<a name='634'>
     <font color=#447700>! jg is the J index in the global (domain) span of the array.<a name='635'></font>
     jg = j-jds+1<a name='636'>
<a name='637'>
     <font color=#447700>! determine whether or not to filter the data<a name='638'></font>
<a name='639'>
     if(xlat(ids,j).gt.0.) then<a name='640'>
        lat = xlat(ids,j)-dvlat<a name='641'>
     else<a name='642'>
        lat = xlat(ids,j)+dvlat<a name='643'>
     endif<a name='644'>
<a name='645'>
     IF (abs(lat) &gt;= fft_filter_lat) THEN<a name='646'>
<a name='647'>
        DO k=kts,kte<a name='648'>
        DO i=ids,ide-1<a name='649'>
           sheet(i-ids+1,k-kts+1) = <A href='../../html_code/phys/module_mp_full_sbm.F.html#F'>f</A><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="F_1">(i,k,j)<a name='650'>
        END DO<a name='651'>
        END DO<a name='652'>
<a name='653'>
        call <A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_FFT_2D_NCAR'>polar_filter_fft_2d_ncar</A><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLAR_FILTER_FFT_2D_NCAR_1">(nx,ny,sheet,lat,fft_filter_lat,piggyback,fftflag)<a name='654'>
<a name='655'>
        DO k=kts,kte<a name='656'>
           DO i=ids,ide-1<a name='657'>
              f(i,k,j) = sheet(i-ids+1,k-kts+1)<a name='658'>
           END DO<a name='659'>
           <font color=#447700>! setting up ims-ime with x periodicity:<a name='660'></font>
           <font color=#447700>! enforce periodicity as in set_physical_bc3d<a name='661'></font>
<a name='662'>
           DO i=1,ids-ims<a name='663'>
              f(ids-i,k,j)=<A href='../../html_code/phys/module_mp_full_sbm.F.html#F'>f</A><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="F_2">(ide-i,k,j)<a name='664'>
           END DO<a name='665'>
           DO i=1,ime-ide+1<a name='666'>
              f(ide+i-1,k,j)=<A href='../../html_code/phys/module_mp_full_sbm.F.html#F'>f</A><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_3D' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="F_3">(ids+i-1,k,j)<a name='667'>
           END DO<a name='668'>
        END DO<a name='669'>
<a name='670'>
     END IF<a name='671'>
  END DO <font color=#447700>! outer j (latitude) loop<a name='672'></font>
<a name='673'>
END SUBROUTINE polar_filter_3d<a name='674'>
<a name='675'>
<font color=#447700>!------------------------------------------------------------------------------<a name='676'></font>
<a name='677'>
<A NAME='POLAR_FILTER_FFT_2D_NCAR'><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_FFT_2D_NCAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='678'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>polar_filter_fft_2d_ncar</font>(nx,ny,fin,lat,filter_latitude,piggyback,fftflag) <A href='../../call_to/POLAR_FILTER_FFT_2D_NCAR.html' TARGET='index'>1</A>,<A href='../../call_from/POLAR_FILTER_FFT_2D_NCAR.html' TARGET='index'>3</A><a name='679'>
  IMPLICIT NONE<a name='680'>
  INTEGER , INTENT(IN) :: nx, ny<a name='681'>
  REAL , DIMENSION(nx,ny), INTENT(INOUT) :: fin<a name='682'>
  REAL , INTENT(IN) :: lat, filter_latitude<a name='683'>
  LOGICAL, INTENT(IN) :: piggyback<a name='684'>
<a name='685'>
  REAL :: pi, rcosref, freq, c, cf<a name='686'>
<a name='687'>
  INTEGER :: k, fftflag<a name='688'>
  REAL, DIMENSION(NX,NY) :: work<a name='689'>
  REAL, DIMENSION(NX+15) :: wsave<a name='690'>
  REAL(KIND=8), DIMENSION(NX,NY) :: fin8, work8 <a name='691'>
  REAL(KIND=8), DIMENSION(NX+15) :: wsave8<a name='692'>
<a name='693'>
  INTEGER :: i, j<a name='694'>
  REAL, dimension(nx,ny) :: fp<a name='695'>
<a name='696'>
  INTEGER :: lensave, ier, nh, n1<a name='697'>
  INTEGER :: lot, jump, n, inc, lenr, lensav, lenwrk<a name='698'>
<a name='699'>
  REAL, PARAMETER :: alpha = 0.0<a name='700'>
  REAL :: factor_k<a name='701'>
<a name='702'>
  INTEGER :: ntop<a name='703'>
<a name='704'>
  pi = ACOS(-1.)<a name='705'>
  rcosref = 1./COS(filter_latitude*pi/180.)<a name='706'>
<a name='707'>
<font color=#447700>!  we are following the naming convention of the fftpack5 routines<a name='708'></font>
<a name='709'>
  n = nx<a name='710'>
  lot = ny<a name='711'>
  lensav = n+15<a name='712'>
  inc = 1<a name='713'>
  lenr = nx*ny<a name='714'>
  jump = nx<a name='715'>
  lenwrk = lenr<a name='716'>
  ntop = ny<a name='717'>
  IF(piggyback) ntop = ny-1<a name='718'>
<a name='719'>
<font color=#447700>!  forward transform<a name='720'></font>
<font color=#447700>!  initialize coefficients, place in wsave <a name='721'></font>
<font color=#447700>!   (should place this in init and save wsave at program start)<a name='722'></font>
<a name='723'>
  if(fftflag.eq.0) then<a name='724'>
     call rfftmi(n,wsave,lensav,ier)<a name='725'>
  else<a name='726'>
     call dfft1i(n,wsave8,lensav,ier)<a name='727'>
  endif<a name='728'>
<a name='729'>
  IF(ier /= 0) THEN<a name='730'>
    write(a_message,*) ' error in rfftmi ',ier<a name='731'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_FFT_2D_NCAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_6"> ( a_message ) <a name='732'>
  END IF<a name='733'>
<a name='734'>
<font color=#447700>!  do the forward transform<a name='735'></font>
<a name='736'>
  if(fftflag.eq.0) then<a name='737'>
     call rfftmf(lot, jump, n, inc, fin, lenr, wsave, lensav, work, lenwrk, ier)<a name='738'>
  else <a name='739'>
     fin8 = fin<a name='740'>
     do k=1,ny <a name='741'>
        call dfft1f(n, inc, fin8(1,k), lenr, wsave8, lensav, work8, lenwrk, ier)<a name='742'>
     enddo <a name='743'>
  endif<a name='744'>
<a name='745'>
  IF(ier /= 0) THEN<a name='746'>
    write(a_message,*) ' error in rfftmf ',ier<a name='747'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_FFT_2D_NCAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_7"> ( a_message ) <a name='748'>
  END IF<a name='749'>
<a name='750'>
  if(MOD(n,2) == 0) then<a name='751'>
    nh = n/2 - 1<a name='752'>
  else<a name='753'>
    nh = (n-1)/2<a name='754'>
  end if<a name='755'>
<a name='756'>
  DO j=1,ny<a name='757'>
   fp(1,j) = 1.<a name='758'>
  ENDDO<a name='759'>
<a name='760'>
  DO i=2,nh+1<a name='761'>
    freq=REAL(i-1)/REAL(n)<a name='762'>
    c = (rcosref*COS(lat*pi/180.)/SIN(freq*pi))**2<a name='763'>
<a name='764'>
<font color=#447700>!    c = MAX(0.,MIN(1.,c))<a name='765'></font>
    do j=1,ntop<a name='766'>
      factor_k = (1.-alpha)+alpha*min(1.,float(ntop - j)/10.)<a name='767'>
      cf = c*factor_k*factor_k<a name='768'>
      cf = MAX(0.,MIN(1.,cf))<a name='769'>
      fp(2*(i-1),j) = cf<a name='770'>
      fp(2*(i-1)+1,j) = cf<a name='771'>
    enddo<a name='772'>
    if(piggyback) then<a name='773'>
      cf = MAX(0.,MIN(1.,c))<a name='774'>
      fp(2*(i-1),ny) = cf<a name='775'>
      fp(2*(i-1)+1,ny) = cf<a name='776'>
    endif<a name='777'>
  END DO<a name='778'>
<a name='779'>
  IF(MOD(n,2) == 0) THEN<a name='780'>
    c = (rcosref*COS(lat*pi/180.))**2<a name='781'>
<font color=#447700>!    c = MAX(0.,MIN(1.,c))<a name='782'></font>
    do j=1,ntop<a name='783'>
      factor_k = (1.-alpha)+alpha*min(1.,float(ntop - j)/10.)<a name='784'>
      cf = c*factor_k*factor_k<a name='785'>
      cf = MAX(0.,MIN(1.,cf))<a name='786'>
      fp(n,j) = cf<a name='787'>
    enddo<a name='788'>
    if(piggyback) then<a name='789'>
      cf = MAX(0.,MIN(1.,c))<a name='790'>
      fp(n,ny) = cf<a name='791'>
    endif<a name='792'>
  END IF<a name='793'>
<a name='794'>
  if(fftflag.eq.0) then<a name='795'>
     do j=1,ny<a name='796'>
       do i=1,nx<a name='797'>
          fin(i,j) = fp(i,j)*fin(i,j)<a name='798'>
       enddo<a name='799'>
     enddo<a name='800'>
  else<a name='801'>
     do j=1,ny<a name='802'>
       do i=1,nx<a name='803'>
          fin8(i,j) = fp(i,j)*fin8(i,j)<a name='804'>
       enddo<a name='805'>
     enddo<a name='806'>
  endif<a name='807'>
<a name='808'>
<font color=#447700>!  do the backward transform<a name='809'></font>
<a name='810'>
  if(fftflag.eq.0) then<a name='811'>
     call rfftmb(lot, jump, n, inc, fin, lenr, wsave, lensav, work, lenwrk, ier)<a name='812'>
  else<a name='813'>
     do k=1,ny <a name='814'>
        call dfft1b(n, inc, fin8(1,k), lenr, wsave8, lensav, work8, lenwrk, ier)<a name='815'>
     enddo<a name='816'>
     fin= fin8     <a name='817'>
  endif<a name='818'>
<a name='819'>
  IF(ier /= 0) THEN<a name='820'>
    write(a_message,*) ' error in rfftmb ',ier<a name='821'>
    CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/module_polarfft.F.html#POLAR_FILTER_FFT_2D_NCAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_8"> ( a_message ) <a name='822'>
  END IF<a name='823'>
<a name='824'>
END SUBROUTINE polar_filter_fft_2d_ncar<a name='825'>
<a name='826'>
<font color=#447700>!---------------------------------------------------------------------<a name='827'></font>
<a name='828'>
<A NAME='FILTER_TRACER'><A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='829'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>filter_tracer</font> ( tr3d_in , xlat , msftx , &amp; <A href='../../call_to/FILTER_TRACER.html' TARGET='index'>10</A>,<A href='../../call_from/FILTER_TRACER.html' TARGET='index'>1</A><a name='830'>
                              fft_filter_lat , mf_fft , &amp;<a name='831'>
                              pos_def , swap_pole_with_next_j , &amp;<a name='832'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='833'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='834'>
                              its , ite , jts , jte , kts , kte )<a name='835'>
<a name='836'>
      IMPLICIT NONE<a name='837'>
<a name='838'>
      INTEGER , INTENT(IN) ::  ids , ide , jds , jde , kds , kde , &amp;<a name='839'>
                               ims , ime , jms , jme , kms , kme , &amp;<a name='840'>
                               its , ite , jts , jte , kts , kte<a name='841'>
<a name='842'>
      REAL , INTENT(IN) :: fft_filter_lat , mf_fft<a name='843'>
      REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(INOUT) :: tr3d_in<a name='844'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: xlat , msftx<a name='845'>
      LOGICAL , INTENT(IN) :: pos_def , swap_pole_with_next_j<a name='846'>
<a name='847'>
<a name='848'>
      <font color=#447700>!  Local vars<a name='849'></font>
<a name='850'>
      INTEGER :: i , j , j_lat_pos , j_lat_neg , k<a name='851'>
      INTEGER :: i_kicker , ik , i1, i2, i3, i4<a name='852'>
      INTEGER :: i_left , i_right , ii , count<a name='853'>
      REAL :: length_scale , sum<a name='854'>
      REAL , DIMENSION(its:ite,jts:jte) :: tr_in, tr_out<a name='855'>
      CHARACTER (LEN=256) :: message<a name='856'>
<a name='857'>
      <font color=#447700>!  The filtering is a simple average on a latitude loop.  Possibly a LONG list of<a name='858'></font>
      <font color=#447700>!  numbers.  We assume that ALL of the 2d arrays have been transposed so that<a name='859'></font>
      <font color=#447700>!  each patch has the entire domain size of the i-dimension available.<a name='860'></font>
<a name='861'>
      IF ( ( its .NE. ids ) .OR. ( ite .NE. ide ) ) THEN<a name='862'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_32"> ( 'filtering assumes all values on X' )<a name='863'>
      END IF<a name='864'>
<a name='865'>
      <font color=#447700>!  Starting at the south pole, we find where the<a name='866'></font>
      <font color=#447700>!  grid distance is big enough, then go back a point.  Continuing to the<a name='867'></font>
      <font color=#447700>!  north pole, we find the first small grid distance.  These are the<a name='868'></font>
      <font color=#447700>!  computational latitude loops and the associated computational poles.<a name='869'></font>
<a name='870'>
      j_lat_neg = 0<a name='871'>
      j_lat_pos = jde + 1<a name='872'>
      loop_neg : DO j = MIN(jde-1,jte) , jts , -1<a name='873'>
         IF ( xlat(its,j) .LT. 0.0 ) THEN<a name='874'>
            IF ( ABS(xlat(its,j)) .GE. fft_filter_lat ) THEN<a name='875'>
               j_lat_neg = j <a name='876'>
               EXIT loop_neg<a name='877'>
            END IF<a name='878'>
         END IF<a name='879'>
      END DO loop_neg<a name='880'>
<a name='881'>
      loop_pos : DO j = jts , MIN(jde-1,jte)<a name='882'>
         IF ( xlat(its,j) .GT. 0.0 ) THEN<a name='883'>
            IF ( xlat(its,j) .GE. fft_filter_lat ) THEN<a name='884'>
               j_lat_pos = j<a name='885'>
               EXIT loop_pos<a name='886'>
            END IF<a name='887'>
         END IF<a name='888'>
      END DO loop_pos<a name='889'>
<a name='890'>
      <font color=#447700>!  Initialize the starting values for the averages.<a name='891'></font>
<a name='892'>
      DO k = kts, kte<a name='893'>
         DO j = jts , MIN(jde-1,jte)<a name='894'>
            DO i = its , MIN(ide-1,ite)<a name='895'>
               tr_in(i,j) = tr3d_in(i,k,j)<a name='896'>
               tr_out(i,j) = tr_in(i,j)<a name='897'>
            END DO<a name='898'>
         END DO<a name='899'>
<a name='900'>
         <font color=#447700>!  Filter the fields at the negative lats.<a name='901'></font>
   <a name='902'>
         DO j = MIN(j_lat_neg,jte) , jts , -1<a name='903'>
<font color=#447700>!           i_kicker = MIN( MAX ( NINT(msftx(its,j)/2) , 1 ) , (ide - ids) / 2 )<a name='904'></font>
            i_kicker = MIN( MAX ( NINT(msftx(its,j)/mf_fft/2) , 1 ) , (ide - ids) / 2 )<a name='905'>
<font color=#447700>!           WRITE (message,FMT='(a,i4,a,i4,f6.2,1x,f6.1,f6.1)') 'SOUTH j = ' , j, ', kicker = ',i_kicker,xlat(its,j),msftx(its,j),mf_fft<a name='906'></font>
<font color=#447700>!           CALL wrf_debug ( 0 , TRIM(message) )<a name='907'></font>
            DO i = its , MIN(ide-1,ite)<a name='908'>
               sum = 0.<a name='909'>
               count = 0<a name='910'>
               DO ik = 1 , i_kicker/2<a name='911'>
                  ii = i-ik<a name='912'>
                  IF ( ii .GE. ids ) THEN<a name='913'>
                     i_left = ii<a name='914'>
                  ELSE<a name='915'>
                     i_left = ( ii - ids ) + (ide-1)+1<a name='916'>
                  END IF<a name='917'>
                  ii = i+ik<a name='918'>
                  IF ( ii .LE. ide-1 ) THEN<a name='919'>
                     i_right = ii<a name='920'>
                  ELSE<a name='921'>
                     i_right = ( ii - (ide-1) ) + its-1<a name='922'>
                  END IF<a name='923'>
                  sum = sum + tr_in(i_left,j) + tr_in(i_right,j)<a name='924'>
                  count = count + 1<a name='925'>
               END DO<a name='926'>
               tr_out(i,j) = ( tr_in(i,j) + sum ) / REAL ( 2 * count + 1 )<a name='927'>
            END DO<a name='928'>
         END DO<a name='929'>
   <a name='930'>
         <font color=#447700>!  Filter the fields at the positive lats.<a name='931'></font>
   <a name='932'>
         DO j = MAX(j_lat_pos,jts) , MIN(jde-1,jte)<a name='933'>
<font color=#447700>!           i_kicker = MIN( MAX ( NINT(msftx(its,j)/2) , 1 ) , (ide - ids) / 2 )<a name='934'></font>
            i_kicker = MIN( MAX ( NINT(msftx(its,j)/mf_fft/2) , 1 ) , (ide - ids) / 2 )<a name='935'>
<font color=#447700>!           WRITE (message,FMT='(a,i4,a,i4,f6.2,1x,f6.1,f6.1)') 'NORTH j = ' , j, ', kicker = ',i_kicker,xlat(its,j),msftx(its,j),mf_fft<a name='936'></font>
<font color=#447700>!           CALL wrf_debug ( 0 , TRIM(message) )<a name='937'></font>
            DO i = its , MIN(ide-1,ite)<a name='938'>
               count = 0<a name='939'>
               sum = 0.<a name='940'>
               DO ik = 1 , i_kicker/2<a name='941'>
                  ii = i-ik<a name='942'>
                  IF ( ii .GE. ids ) THEN<a name='943'>
                     i_left = ii<a name='944'>
                  ELSE<a name='945'>
                     i_left = ( ii - ids ) + (ide-1)+1<a name='946'>
                  END IF<a name='947'>
                  ii = i+ik<a name='948'>
                  IF ( ii .LE. ide-1 ) THEN<a name='949'>
                     i_right = ii<a name='950'>
                  ELSE<a name='951'>
                     i_right = ( ii - (ide-1) ) + its-1<a name='952'>
                  END IF<a name='953'>
                  sum = sum + tr_in(i_left,j) + tr_in(i_right,j)<a name='954'>
                  count = count + 1<a name='955'>
               END DO<a name='956'>
               tr_out(i,j) = ( tr_in(i,j) + sum ) / REAL ( 2 * count + 1 )<a name='957'>
            END DO<a name='958'>
         END DO<a name='959'>
   <a name='960'>
         <font color=#447700>!  Set output values for whole patch.<a name='961'></font>
   <a name='962'>
         DO j = jts , MIN(jde-1,jte)<a name='963'>
            DO i = its , MIN(ide-1,ite)<a name='964'>
               tr3d_in(i,k,j) = tr_out(i,j)<a name='965'>
            END DO<a name='966'>
         END DO<a name='967'>
   <a name='968'>
         <font color=#447700>!  Positive definite on scalars?<a name='969'></font>
   <a name='970'>
         IF ( pos_def ) THEN<a name='971'>
            DO j = jts , MIN(jde-1,jte)<a name='972'>
               DO i = its , MIN(ide-1,ite)<a name='973'>
                  tr3d_in(i,k,j) = MAX( tr3d_in(i,k,j) , 0. )<a name='974'>
               END DO<a name='975'>
            END DO<a name='976'>
         END IF<a name='977'>
   <a name='978'>
         <font color=#447700>!  Remove values at j=1 and j=jde-1 locations, set them to the rows just next to them.<a name='979'></font>
   <a name='980'>
         IF ( swap_pole_with_next_j ) THEN<a name='981'>
            IF  ( jts .EQ. jds ) THEN<a name='982'>
               DO i = its , MIN(ide-1,ite)<a name='983'>
                  tr3d_in(i,k,jts) = tr3d_in(i,k,jts+1)<a name='984'>
               END DO<a name='985'>
            END IF<a name='986'>
   <a name='987'>
            IF  ( jte .EQ. jde ) THEN<a name='988'>
               DO i = its , MIN(ide-1,ite)<a name='989'>
                  tr3d_in(i,k,jte-1) = tr3d_in(i,k,jte-2)<a name='990'>
               END DO<a name='991'>
            END IF<a name='992'>
         END IF<a name='993'>
<a name='994'>
      END DO <font color=#447700>! k-loop<a name='995'></font>
<a name='996'>
   END SUBROUTINE filter_tracer<a name='997'>
<a name='998'>
<font color=#447700>!---------------------------------------------------------------------<a name='999'></font>
<a name='1000'>
<A NAME='FILTER_TRACER_OLD'><A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER_OLD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1001'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>filter_tracer_old</font> ( tr3d_in , xlat , msftx , fft_filter_lat , &amp;,<A href='../../call_from/FILTER_TRACER_OLD.html' TARGET='index'>1</A><a name='1002'>
                              ids , ide , jds , jde , kds , kde , &amp;<a name='1003'>
                              ims , ime , jms , jme , kms , kme , &amp;<a name='1004'>
                              its , ite , jts , jte , kts , kte )<a name='1005'>
<a name='1006'>
      IMPLICIT NONE<a name='1007'>
<a name='1008'>
      INTEGER , INTENT(IN) ::  ids , ide , jds , jde , kds , kde , &amp;<a name='1009'>
                               ims , ime , jms , jme , kms , kme , &amp;<a name='1010'>
                               its , ite , jts , jte , kts , kte<a name='1011'>
<a name='1012'>
      REAL , INTENT(IN) :: fft_filter_lat<a name='1013'>
      REAL , DIMENSION(ims:ime,kms:kme,jms:jme) , INTENT(INOUT) :: tr3d_in<a name='1014'>
      REAL , DIMENSION(ims:ime,jms:jme) , INTENT(IN) :: xlat , msftx<a name='1015'>
<a name='1016'>
<a name='1017'>
      <font color=#447700>!  Local vars<a name='1018'></font>
<a name='1019'>
      INTEGER :: i , j , j_lat_pos , j_lat_neg , k<a name='1020'>
      INTEGER :: i_kicker , ik , i1, i2, i3, i4<a name='1021'>
      REAL :: length_scale , sum<a name='1022'>
      REAL , DIMENSION(its:ite,jts:jte) :: tr_in, tr_out<a name='1023'>
<a name='1024'>
      <font color=#447700>!  The filtering is a simple average on a latitude loop.  Possibly a LONG list of<a name='1025'></font>
      <font color=#447700>!  numbers.  We assume that ALL of the 2d arrays have been transposed so that<a name='1026'></font>
      <font color=#447700>!  each patch has the entire domain size of the i-dim local.<a name='1027'></font>
<a name='1028'>
      IF ( ( its .NE. ids ) .OR. ( ite .NE. ide ) ) THEN<a name='1029'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_polarfft.F.html#FILTER_TRACER_OLD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_33"> ( 'filtering assumes all values on X' )<a name='1030'>
      END IF<a name='1031'>
<a name='1032'>
      <font color=#447700>!  Starting at the south pole, we find where the<a name='1033'></font>
      <font color=#447700>!  grid distance is big enough, then go back a point.  Continuing to the<a name='1034'></font>
      <font color=#447700>!  north pole, we find the first small grid distance.  These are the<a name='1035'></font>
      <font color=#447700>!  computational latitude loops and the associated computational poles.<a name='1036'></font>
<a name='1037'>
      j_lat_neg = 0<a name='1038'>
      j_lat_pos = jde + 1<a name='1039'>
      loop_neg : DO j = jts , MIN(jde-1,jte)<a name='1040'>
         IF ( xlat(its,j) .LT. 0.0 ) THEN<a name='1041'>
            IF ( ABS(xlat(its,j)) .LT. fft_filter_lat ) THEN<a name='1042'>
               j_lat_neg = j - 1<a name='1043'>
               EXIT loop_neg<a name='1044'>
            END IF<a name='1045'>
         END IF<a name='1046'>
      END DO loop_neg<a name='1047'>
<a name='1048'>
      loop_pos : DO j = jts , MIN(jde-1,jte)<a name='1049'>
         IF ( xlat(its,j) .GT. 0.0 ) THEN<a name='1050'>
            IF ( xlat(its,j) .GE. fft_filter_lat ) THEN<a name='1051'>
               j_lat_pos = j<a name='1052'>
               EXIT loop_pos<a name='1053'>
            END IF<a name='1054'>
         END IF<a name='1055'>
      END DO loop_pos<a name='1056'>
<a name='1057'>
      <font color=#447700>!  Set output values to initial input topo values for whole patch.<a name='1058'></font>
<a name='1059'>
      DO k = kts, kte<a name='1060'>
         DO j = jts , MIN(jde-1,jte)<a name='1061'>
            DO i = its , MIN(ide-1,ite)<a name='1062'>
               tr_in(i,j) = tr3d_in(i,k,j)<a name='1063'>
               tr_out(i,j) = tr_in(i,j)<a name='1064'>
            END DO<a name='1065'>
         END DO<a name='1066'>
<a name='1067'>
         <font color=#447700>!  Filter the topo at the negative lats.<a name='1068'></font>
   <a name='1069'>
         DO j = j_lat_neg , jts , -1<a name='1070'>
            i_kicker = MIN( MAX ( NINT(msftx(its,j)) , 1 ) , (ide - ids) / 2 )<a name='1071'>
<font color=#447700>!           print *,'j = ' , j, ', kicker = ',i_kicker<a name='1072'></font>
            DO i = its , MIN(ide-1,ite)<a name='1073'>
               IF      ( ( i - i_kicker .GE. its ) .AND. ( i + i_kicker .LE. ide-1 ) ) THEN<a name='1074'>
                  sum = 0.0<a name='1075'>
                  DO ik = 1 , i_kicker<a name='1076'>
                     sum = sum + tr_in(i+ik,j) + tr_in(i-ik,j)<a name='1077'>
                  END DO<a name='1078'>
                  tr_out(i,j) = ( tr_in(i,j) + sum ) / REAL ( 2 * i_kicker + 1 )<a name='1079'>
               ELSE IF ( ( i - i_kicker .LT. its ) .AND. ( i + i_kicker .LE. ide-1 ) ) THEN<a name='1080'>
                  sum = 0.0<a name='1081'>
                  DO ik = 1 , i_kicker<a name='1082'>
                     sum = sum + tr_in(i+ik,j)<a name='1083'>
                  END DO<a name='1084'>
                  i1 = i - i_kicker + ide -1<a name='1085'>
                  i2 = ide-1<a name='1086'>
                  i3 = ids<a name='1087'>
                  i4 = i-1<a name='1088'>
                  DO ik = i1 , i2<a name='1089'>
                     sum = sum + tr_in(ik,j)<a name='1090'>
                  END DO<a name='1091'>
                  DO ik = i3 , i4<a name='1092'>
                     sum = sum + tr_in(ik,j)<a name='1093'>
                  END DO<a name='1094'>
                  tr_out(i,j) = ( tr_in(i,j) + sum ) / REAL ( 2 * i_kicker + 1 )<a name='1095'>
               ELSE IF ( ( i - i_kicker .GE. its ) .AND. ( i + i_kicker .GT. ide-1 ) ) THEN<a name='1096'>
                  sum = 0.0<a name='1097'>
                  DO ik = 1 , i_kicker<a name='1098'>
                     sum = sum + tr_in(i-ik,j)<a name='1099'>
                  END DO<a name='1100'>
                  i1 = i+1<a name='1101'>
                  i2 = ide-1<a name='1102'>
                  i3 = ids<a name='1103'>
                  i4 = ids + ( i_kicker+i ) - ide<a name='1104'>
                  DO ik = i1 , i2<a name='1105'>
                     sum = sum + tr_in(ik,j)<a name='1106'>
                  END DO<a name='1107'>
                  DO ik = i3 , i4<a name='1108'>
                     sum = sum + tr_in(ik,j)<a name='1109'>
                  END DO<a name='1110'>
                  tr_out(i,j) = ( tr_in(i,j) + sum ) / REAL ( 2 * i_kicker + 1 )<a name='1111'>
               END IF<a name='1112'>
            END DO<a name='1113'>
         END DO<a name='1114'>
   <a name='1115'>
         <font color=#447700>!  Filter the topo at the positive lats.<a name='1116'></font>
   <a name='1117'>
         DO j = j_lat_pos , MIN(jde-1,jte)<a name='1118'>
            i_kicker = MIN( MAX ( NINT(msftx(its,j)) , 1 ) , (ide - ids) / 2 )<a name='1119'>
<font color=#447700>!           print *,'j = ' , j, ', kicker = ',i_kicker<a name='1120'></font>
            DO i = its , MIN(ide-1,ite)<a name='1121'>
               IF      ( ( i - i_kicker .GE. its ) .AND. ( i + i_kicker .LE. ide-1 ) ) THEN<a name='1122'>
                  sum = 0.0<a name='1123'>
                  DO ik = 1 , i_kicker<a name='1124'>
                     sum = sum + tr_in(i+ik,j) + tr_in(i-ik,j)<a name='1125'>
                  END DO<a name='1126'>
                  tr_out(i,j) = ( tr_in(i,j) + sum ) / REAL ( 2 * i_kicker + 1 )<a name='1127'>
               ELSE IF ( ( i - i_kicker .LT. its ) .AND. ( i + i_kicker .LE. ide-1 ) ) THEN<a name='1128'>
                  sum = 0.0<a name='1129'>
                  DO ik = 1 , i_kicker<a name='1130'>
                     sum = sum + tr_in(i+ik,j)<a name='1131'>
                  END DO<a name='1132'>
                  i1 = i - i_kicker + ide -1<a name='1133'>
                  i2 = ide-1<a name='1134'>
                  i3 = ids<a name='1135'>
                  i4 = i-1<a name='1136'>
                  DO ik = i1 , i2<a name='1137'>
                     sum = sum + tr_in(ik,j)<a name='1138'>
                  END DO<a name='1139'>
                  DO ik = i3 , i4<a name='1140'>
                     sum = sum + tr_in(ik,j)<a name='1141'>
                  END DO<a name='1142'>
                  tr_out(i,j) = ( tr_in(i,j) + sum ) / REAL ( 2 * i_kicker + 1 )<a name='1143'>
               ELSE IF ( ( i - i_kicker .GE. its ) .AND. ( i + i_kicker .GT. ide-1 ) ) THEN<a name='1144'>
                  sum = 0.0<a name='1145'>
                  DO ik = 1 , i_kicker<a name='1146'>
                     sum = sum + tr_in(i-ik,j)<a name='1147'>
                  END DO<a name='1148'>
                  i1 = i+1<a name='1149'>
                  i2 = ide-1<a name='1150'>
                  i3 = ids<a name='1151'>
                  i4 = ids + ( i_kicker+i ) - ide<a name='1152'>
                  DO ik = i1 , i2<a name='1153'>
                     sum = sum + tr_in(ik,j)<a name='1154'>
                  END DO<a name='1155'>
                  DO ik = i3 , i4<a name='1156'>
                     sum = sum + tr_in(ik,j)<a name='1157'>
                  END DO<a name='1158'>
                  tr_out(i,j) = ( tr_in(i,j) + sum ) / REAL ( 2 * i_kicker + 1 )<a name='1159'>
               END IF<a name='1160'>
            END DO<a name='1161'>
         END DO<a name='1162'>
   <a name='1163'>
         <font color=#447700>!  Set output values to initial input topo values for whole patch.<a name='1164'></font>
   <a name='1165'>
         DO j = jts , MIN(jde-1,jte)<a name='1166'>
            DO i = its , MIN(ide-1,ite)<a name='1167'>
               tr3d_in(i,k,j) = tr_out(i,j)<a name='1168'>
            END DO<a name='1169'>
         END DO<a name='1170'>
      END DO <font color=#447700>! k-loop<a name='1171'></font>
<a name='1172'>
   END SUBROUTINE filter_tracer_old<a name='1173'>
<a name='1174'>
<font color=#447700>!---------------------------------------------------------------------<a name='1175'></font>
END MODULE module_polarfft<a name='1176'>
<a name='1177'>
</pre></body></html>