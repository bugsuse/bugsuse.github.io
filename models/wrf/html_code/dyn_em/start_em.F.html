<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>! sed -e "s/grid%mu/gridmu/g" -e "s/grid%Mu/gridMu/g" start_em.F | cpp -DHYBRID_COORD | sed -e "s/gridmu/grid%mu/g" -e "s/gridMu/grid%Mu/g" &gt;&gt; start_em.next<a name='2'></font>
#if ( HYBRID_COORD==1 )<a name='3'>
#  define gridmu_1(...) (grid%c1h(k)*XXPC1HXX(__VA_ARGS__))<a name='4'>
#  define XXPC1HXX(...) grid%mu_1(__VA_ARGS__)<a name='5'>
<a name='6'>
#  define gridmu_2(...) (grid%c1h(k)*XXPC2HXX(__VA_ARGS__))<a name='7'>
#  define XXPC2HXX(...) grid%mu_2(__VA_ARGS__)<a name='8'>
<a name='9'>
#  define gridmub(...) (grid%c1h(k)*XXPCBHXX(__VA_ARGS__)+grid%c2h(k))<a name='10'>
#  define XXPCBHXX(...) grid%mub(__VA_ARGS__)<a name='11'>
<a name='12'>
#  define gridMu_2(...) (grid%c1f(k)*XXPC2FXX(__VA_ARGS__))<a name='13'>
#  define XXPC2FXX(...) grid%Mu_2(__VA_ARGS__)<a name='14'>
<a name='15'>
#  define gridMub(...) (grid%c1f(k)*XXPCBFXX(__VA_ARGS__)+grid%c2f(k))<a name='16'>
#  define XXPCBFXX(...) grid%Mub(__VA_ARGS__)<a name='17'>
#endif<a name='18'>
<a name='19'>
<font color=#447700>!-------------------------------------------------------------------<a name='20'></font>
<a name='21'>
<A NAME='START_DOMAIN_EM'><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='22'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>start_domain_em</font> ( grid, allowed_to_read &amp; <A href='../../call_to/START_DOMAIN_EM.html' TARGET='index'>1</A>,<A href='../../call_from/START_DOMAIN_EM.html' TARGET='index'>109</A><a name='23'>
<font color=#447700>! Actual arguments generated from Registry<a name='24'></font>
# include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_1"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='25'>
<font color=#447700>!<a name='26'></font>
)<a name='27'>
<a name='28'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_30">, ONLY : domain, wrfu_timeinterval, get_ijk_from_grid, &amp;<a name='29'>
        domain_setgmtetc<a name='30'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_17"><a name='31'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_6"><a name='32'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_8"><a name='33'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_16"><a name='34'>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_11">, ONLY : boundary_condition_check, set_physical_bc2d, set_physical_bc3d, bdyzone<a name='35'>
   USE <A href='../../html_code/dyn_em/module_bc_em.F.html#MODULE_BC_EM'>module_bc_em</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_EM_3">, ONLY: lbc_fcx_gcx, set_w_surface<a name='36'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_21">, ONLY : model_to_grid_config_rec, model_config_rec, grid_config_rec_type<a name='37'>
   USE <A href='../../html_code/frame/module_tiles.F.html#MODULE_TILES'>module_tiles</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TILES_5">, ONLY : set_tiles<a name='38'>
#ifdef DM_PARALLEL<a name='39'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_21">, ONLY : wrf_dm_min_real, wrf_dm_max_real, wrf_dm_maxval, &amp;<a name='40'>
        ntasks_x, ntasks_y, &amp;<a name='41'>
        local_communicator_periodic, local_communicator, mytask, ntasks <a name='42'>
#else<a name='43'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_22">, ONLY : wrf_dm_min_real, wrf_dm_max_real<a name='44'>
#endif<a name='45'>
   USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_11"><a name='46'>
   USE <A href='../../html_code/share/module_llxy.F.html#MODULE_LLXY'>module_llxy</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LLXY_4">, ONLY : proj_cassini<a name='47'>
   USE <A href='../../html_code/phys/module_physics_init.F.html#MODULE_PHYSICS_INIT'>module_physics_init</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PHYSICS_INIT_1"><a name='48'>
   USE <A href='../../html_code/phys/module_lightning_driver.F.html#MODULE_LIGHTNING_DRIVER'>module_lightning_driver</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LIGHTNING_DRIVER_1">, ONLY : lightning_init<a name='49'>
   USE <A href='../../html_code/phys/module_fr_fire_driver_wrf.F.html#MODULE_FR_FIRE_DRIVER_WRF'>module_fr_fire_driver_wrf</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_FR_FIRE_DRIVER_WRF_2">, ONLY : fire_driver_em_init<a name='50'>
   USE <A href='../../html_code/dyn_em/module_stoch.F.html#MODULE_STOCH'>module_stoch</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STOCH_2">, ONLY : setup_rand_perturb, rand_seed, update_stoch, initialize_stoch<a name='51'>
   USE <A href='../../html_code/share/module_trajectory.F.html#MODULE_TRAJECTORY'>module_trajectory</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TRAJECTORY_2">, ONLY : trajectory_init<a name='52'>
#if (WRF_CHEM == 1)<a name='53'>
   USE module_aerosols_sorgam, ONLY: sum_pm_sorgam<a name='54'>
   USE module_gocart_aerosols, ONLY: sum_pm_gocart<a name='55'>
   USE module_mosaic_driver, ONLY: sum_pm_mosaic<a name='56'>
   USE module_input_tracer, ONLY: initialize_tracer<a name='57'>
   USE module_aerosols_soa_vbs, only: sum_pm_soa_vbs<a name='58'>
#endif<a name='59'>
   USE <A href='../../html_code/phys/module_diag_pld.F.html#MODULE_DIAG_PLD'>module_diag_pld</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIAG_PLD_1">, ONLY : pld<a name='60'>
   USE <A href='../../html_code/phys/module_diag_zld.F.html#MODULE_DIAG_ZLD'>module_diag_zld</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIAG_ZLD_1">, ONLY : zld<a name='61'>
<a name='62'>
<font color=#447700>!!debug<a name='63'></font>
<font color=#447700>!USE module_compute_geop<a name='64'></font>
<a name='65'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_17"><a name='66'>
   USE <A href='../../html_code/dyn_em/module_avgflx_em.F.html#MODULE_AVGFLX_EM'>module_avgflx_em</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_AVGFLX_EM_2">, ONLY : zero_avgflx<a name='67'>
<a name='68'>
   IMPLICIT NONE<a name='69'>
   <font color=#447700>!  Input data.<a name='70'></font>
   TYPE (domain)          :: grid<a name='71'>
<a name='72'>
   LOGICAL , INTENT(IN)   :: allowed_to_read<a name='73'>
<a name='74'>
   <font color=#447700>!  Definitions of dummy arguments to this routine (generated from Registry).<a name='75'></font>
# include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_2"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='76'>
<a name='77'>
   <font color=#447700>!  Structure that contains run-time configuration (namelist) data for domain<a name='78'></font>
   TYPE (grid_config_rec_type)              :: config_flags<a name='79'>
<a name='80'>
   <font color=#447700>!  Local data<a name='81'></font>
   INTEGER                             ::                       &amp;<a name='82'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='83'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='84'>
                                  ips, ipe, jps, jpe, kps, kpe, &amp;<a name='85'>
                                  its, ite, jts, jte, kts, kte, &amp;<a name='86'>
                                  ij,i,j,k,ii,jj,kk,loop,error,l<a name='87'>
<a name='88'>
   INTEGER ::              imsx, imex, jmsx, jmex, kmsx, kmex,    &amp;<a name='89'>
                           ipsx, ipex, jpsx, jpex, kpsx, kpex,    &amp;<a name='90'>
                           imsy, imey, jmsy, jmey, kmsy, kmey,    &amp;<a name='91'>
                           ipsy, ipey, jpsy, jpey, kpsy, kpey<a name='92'>
<a name='93'>
   INTEGER     :: i_m<a name='94'>
<a name='95'>
   REAL        :: p_top_test, p00, t00, a, tiso, p_surf, pd_surf, temp, tiso_tmp<a name='96'>
   REAL        :: p_strat, a_strat<a name='97'>
#if (WRF_CHEM == 1)<a name='98'>
   REAL        RGASUNIV <font color=#447700>! universal gas constant [ J/mol-K ]<a name='99'></font>
   PARAMETER ( RGASUNIV = 8.314510 )<a name='100'>
      REAL,DIMENSION(grid%sm31:grid%em31,grid%sm32:grid%em32,grid%sm33:grid%em33) :: &amp;<a name='101'>
                      z_at_w,convfac<a name='102'>
   REAL :: tempfac<a name='103'>
#endif<a name='104'>
<a name='105'>
   REAL :: qvf1, qvf2, qvf<a name='106'>
   REAL :: pfu, pfd, phm<a name='107'>
   REAL :: MPDT<a name='108'>
   REAL :: spongeweight<a name='109'>
   LOGICAL :: first_trip_for_this_domain, start_of_simulation, fill_w_flag<a name='110'>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='111'>
<a name='112'>
#if (WRF_CHEM <font color=#447700>!= 1)<a name='113'></font>
      REAL,ALLOCATABLE,DIMENSION(:,:,:) :: cldfra_old<a name='114'>
#endif<a name='115'>
<a name='116'>
   REAL :: lat1 , lat2 , lat3 , lat4<a name='117'>
   REAL :: lon1 , lon2 , lon3 , lon4<a name='118'>
   INTEGER :: num_points_lat_lon , iloc , jloc<a name='119'>
   CHARACTER (LEN=256) :: message, a_message<a name='120'>
   TYPE(WRFU_TimeInterval) :: stepTime<a name='121'>
   REAL, DIMENSION(:,:), ALLOCATABLE :: clat_glob<a name='122'>
   logical :: f_flux  <font color=#447700>! flag for computing averaged fluxes in cu_gd<a name='123'></font>
<a name='124'>
   INTEGER :: idex, jdex<a name='125'>
   INTEGER :: im1,ip1,jm1,jp1<a name='126'>
   REAL :: hx,hy,pi<a name='127'>
<a name='128'>
   REAL :: w_max, w_min<a name='129'>
   LOGICAL :: w_needs_to_be_set<a name='130'>
<font color=#447700>!  <a name='131'></font>
<font color=#447700>! Define variables local (topo_wind local vars)<a name='132'></font>
   REAL    :: alpha, vfac<a name='133'>
   INTEGER :: j_save<a name='134'>
<a name='135'>
   <font color=#447700>!  For a global domain<a name='136'></font>
<a name='137'>
   INTEGER :: alloc_status<a name='138'>
   CHARACTER (LEN=256) :: alloc_err_message<a name='139'>
<a name='140'>
<font color=#447700>!..Need to fill special height var for setting up initial condition.  G. Thompson<a name='141'></font>
   REAL, ALLOCATABLE, DIMENSION(:,:,:) :: z_at_q<a name='142'>
<a name='143'>
<font color=#447700>!  CCN for MP=18 initializatio<a name='144'></font>
   REAL :: ccn_max_val<a name='145'>
<a name='146'>
   REAL :: max_mf, max_rot_angle<a name='147'>
   CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_11"> ( grid ,                              &amp;<a name='148'>
                           ids, ide, jds, jde, kds, kde,        &amp;<a name='149'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='150'>
                           ips, ipe, jps, jpe, kps, kpe,        &amp;<a name='151'>
                           imsx, imex, jmsx, jmex, kmsx, kmex,  &amp;<a name='152'>
                           ipsx, ipex, jpsx, jpex, kpsx, kpex,  &amp;<a name='153'>
                           imsy, imey, jmsy, jmey, kmsy, kmey,  &amp;<a name='154'>
                           ipsy, ipey, jpsy, jpey, kpsy, kpey )<a name='155'>
<a name='156'>
   kts = kps ; kte = kpe     <font color=#447700>! note that tile is entire patch<a name='157'></font>
   its = ips ; ite = ipe     <font color=#447700>! note that tile is entire patch<a name='158'></font>
   jts = jps ; jte = jpe    <font color=#447700>! note that tile is entire patch<a name='159'></font>
#if (WRF_CHEM <font color=#447700>!= 1)<a name='160'></font>
         ALLOCATE(CLDFRA_OLD(IMS:IME,KMS:KME,JMS:JME),STAT=I)  ; CLDFRA_OLD = 0.<a name='161'>
#endif<a name='162'>
   ALLOCATE(z_at_q(IMS:IME,KMS:KME,JMS:JME),STAT=I)  ; z_at_q = 0.<a name='163'>
   CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_5"> ( grid%id , model_config_rec , config_flags )<a name='164'>
<a name='165'>
   <font color=#447700>!  If the rotation angle is too large, the GWD option does not do well with the assumed U and V<a name='166'></font>
   <font color=#447700>!  being close to earth relative.<a name='167'></font>
<a name='168'>
   IF ( ( grid%id .EQ. 1 ) .AND. ( config_flags%gwd_opt .EQ. 1 ) ) THEN<a name='169'>
      max_rot_angle = ASIN(ABS(grid%sina(its,jts)))/DEGRAD<a name='170'>
      DO j=jts,MIN(jde-1,jte)<a name='171'>
         DO i=its,MIN(ide-1,ite)<a name='172'>
            max_rot_angle = MAX ( max_rot_angle , ASIN(ABS(grid%sina(i,j)))/DEGRAD )<a name='173'>
         END DO<a name='174'>
      END DO<a name='175'>
#if ( defined(DM_PARALLEL)  &amp;&amp;   <font color=#447700>! defined(STUBMPI) )<a name='176'></font>
      max_rot_angle = wrf_dm_max_real ( max_rot_angle )<a name='177'>
#endif<a name='178'>
      IF ( max_rot_angle .GT. ABS(config_flags%max_rot_angle_gwd) ) THEN<a name='179'>
         WRITE ( a_message , FMT='(A,F5.2)' ) 'Max projection rotation angle for domain 1 = ',max_rot_angle<a name='180'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_46"> ( a_message ) <a name='181'>
         WRITE ( a_message , FMT='(A)'      ) 'This projection may not be appropriate for using the gravity wave drag option.'<a name='182'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_47"> ( a_message ) <a name='183'>
         WRITE ( a_message , FMT='(A)'      ) 'In namelist.input make one of the two following changes:'<a name='184'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_48"> ( a_message ) <a name='185'>
         WRITE ( a_message , FMT='(A)'      ) ' 1) gwd_opt = 0 '<a name='186'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_49"> ( a_message ) <a name='187'>
         WRITE ( a_message , FMT='(A,F5.2)' ) ' 2) max_rot_angle_gwd &gt; ',max_rot_angle<a name='188'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_50"> ( a_message ) <a name='189'>
         WRITE ( a_message , FMT='(A)'      ) '--- ERROR: gwd_opt does not work with this domain'<a name='190'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_70"> ( a_message ) <a name='191'>
      END IF<a name='192'>
   END IF<a name='193'>
<a name='194'>
<a name='195'>
   IF ( ( MOD (ide-ids,config_flags%parent_grid_ratio) .NE. 0 ) .OR. &amp;<a name='196'>
        ( MOD (jde-jds,config_flags%parent_grid_ratio) .NE. 0 ) ) THEN<a name='197'>
      WRITE(message, FMT='(A,I2,":  Both MOD(",I4,"-",I1,",",I2,") and MOD(",I4,"-",I1,",",I2,") must = 0" )') &amp;<a name='198'>
         "Nested dimensions are illegal for domain ",grid%id,ide,ids,config_flags%parent_grid_ratio,&amp;<a name='199'>
         jde,jds,config_flags%parent_grid_ratio<a name='200'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_71"> ( message )<a name='201'>
   END IF<a name='202'>
<a name='203'>
   IF ( config_flags%polar ) THEN<a name='204'>
<font color=#447700>!write(0,*)__FILE__,__LINE__,' clat ',ips,ipe,jps,jpe<a name='205'></font>
<font color=#447700>!do j = jps,jpe<a name='206'></font>
<font color=#447700>!write(0,*)__FILE__,__LINE__,' clat ',ids,j,grid%clat(ips,j)<a name='207'></font>
<font color=#447700>!enddo<a name='208'></font>
<a name='209'>
#ifdef DM_PARALLEL<a name='210'>
<font color=#447700>! WARNING:  this might present scaling issues on very large numbers of processors<a name='211'></font>
     alloc_err_message = ' '<a name='212'>
     alloc_err_message(1:12) = 'NO PROBLEMOS'<a name='213'>
#if 0<a name='214'>
     ALLOCATE( clat_glob(ids:ide,jds:jde), STAT=alloc_status, ERRMSG=alloc_err_message )<a name='215'>
#else<a name='216'>
     ALLOCATE( clat_glob(ids:ide,jds:jde), STAT=alloc_status)<a name='217'>
     alloc_err_message = 'Allocation of space for a global field failed.' <a name='218'>
#endif<a name='219'>
<a name='220'>
     IF ( alloc_status .NE. 0 ) THEN<a name='221'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_51"> ( TRIM(alloc_err_message) )<a name='222'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_72"> ( 'Error allocating entire domain size of 2d array CLAT for global domain' )<a name='223'>
     END IF<a name='224'>
<a name='225'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_3"> ( grid%clat, clat_glob, grid%domdesc, 'xy', 'xy', &amp;<a name='226'>
                                     ids, ide, jds, jde, 1, 1, &amp;<a name='227'>
                                     ims, ime, jms, jme, 1, 1, &amp;<a name='228'>
                                     its, ite, jts, jte, 1, 1 )<a name='229'>
<a name='230'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_1"> ( clat_glob , (ide-ids+1)*(jde-jds+1) )<a name='231'>
<a name='232'>
     grid%clat_xxx(ipsx:ipex,jpsx:jpex) = clat_glob(ipsx:ipex,jpsx:jpex)<a name='233'>
<a name='234'>
     find_j_index_of_fft_filter : DO j = jds , jde-1<a name='235'>
        IF ( ABS(clat_glob(ids,j)) .LE. config_flags%fft_filter_lat ) THEN<a name='236'>
           j_save = j<a name='237'>
           EXIT find_j_index_of_fft_filter<a name='238'>
        END IF<a name='239'>
     END DO find_j_index_of_fft_filter<a name='240'>
<a name='241'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_PATCH_TO_GLOBAL_REAL'>wrf_patch_to_global_real</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_PATCH_TO_GLOBAL_REAL_4"> ( grid%msft, clat_glob, grid%domdesc, 'xy', 'xy', &amp;<a name='242'>
                                     ids, ide, jds, jde, 1, 1, &amp;<a name='243'>
                                     ims, ime, jms, jme, 1, 1, &amp;<a name='244'>
                                     its, ite, jts, jte, 1, 1 )<a name='245'>
<a name='246'>
     CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_BCAST_REAL'>wrf_dm_bcast_real</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_BCAST_REAL_2"> ( clat_glob , (ide-ids+1)*(jde-jds+1) )<a name='247'>
<a name='248'>
     grid%mf_fft = clat_glob(ids,j_save)<a name='249'>
<a name='250'>
     grid%mf_xxx(ipsx:ipex,jpsx:jpex) = clat_glob(ipsx:ipex,jpsx:jpex)<a name='251'>
<a name='252'>
     DEALLOCATE( clat_glob )<a name='253'>
#endif<a name='254'>
   ENDIF<a name='255'>
<a name='256'>
<font color=#447700>! here we check to see if the boundary conditions are set properly<a name='257'></font>
<a name='258'>
   CALL <A href='../../html_code/share/module_bc.F.html#BOUNDARY_CONDITION_CHECK'>boundary_condition_check</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOUNDARY_CONDITION_CHECK_2">( config_flags, bdyzone, error, grid%id )<a name='259'>
<font color=#447700>! make sure that topo_wind option has var_sso data available<a name='260'></font>
    IF ((config_flags%topo_wind .EQ. 1) .AND. (.NOT. grid%got_var_sso)) THEN<a name='261'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_73"> ("topo_wind requires VAR_SSO data")<a name='262'>
    ENDIF<a name='263'>
<a name='264'>
<font color=#447700>!kludge - need to stop CG from resetting precip and phys tendencies to zero<a name='265'></font>
<font color=#447700>!         when we are in here due to a nest being spawned, we want to still<a name='266'></font>
<font color=#447700>!         recompute the base state, but that is about it<a name='267'></font>
   <font color=#447700>!  This is temporary and will need to be changed when grid%itimestep is removed.<a name='268'></font>
<a name='269'>
   IF ( grid%itimestep .EQ. 0 ) THEN<a name='270'>
      first_trip_for_this_domain = .TRUE.<a name='271'>
   ELSE<a name='272'>
      first_trip_for_this_domain = .FALSE.<a name='273'>
   END IF<a name='274'>
<a name='275'>
   IF ( .not. ( config_flags%restart .or. grid%moved ) ) THEN<a name='276'>
       grid%itimestep=0<a name='277'>
   ENDIF<a name='278'>
<a name='279'>
   IF ( config_flags%restart .or. grid%moved .or. config_flags%cycling) THEN<a name='280'>
       first_trip_for_this_domain = .TRUE.<a name='281'>
   ENDIF<a name='282'>
<a name='283'>
      <font color=#447700>! Print out the maximum map scale factor on the coarse domain <a name='284'></font>
<a name='285'>
      IF ( ( first_trip_for_this_domain ) .AND. ( grid%id .EQ. 1 ) .AND. &amp;<a name='286'>
           ( .NOT. config_flags%polar ) ) THEN<a name='287'>
         max_mf = grid%msft(its,jts)<a name='288'>
         DO j=jts,MIN(jde-1,jte)<a name='289'>
            DO i=its,MIN(ide-1,ite)<a name='290'>
               max_mf = MAX ( max_mf , grid%msft(i,j) )<a name='291'>
            END DO<a name='292'>
         END DO<a name='293'>
#if ( defined(DM_PARALLEL)  &amp;&amp;   <font color=#447700>! defined(STUBMPI) )<a name='294'></font>
         max_mf = wrf_dm_max_real ( max_mf )<a name='295'>
#endif<a name='296'>
         WRITE ( a_message , FMT='(A,F5.2,A)' ) 'Max map factor in domain 1 = ',max_mf, &amp;<a name='297'>
                                                '. Scale the dt in the model accordingly.'<a name='298'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_52"> ( a_message ) <a name='299'>
      END IF<a name='300'>
<a name='301'>
    if(config_flags%cycling) then<a name='302'>
<font color=#447700>! Clear the buckets for diagnostics at initial time<a name='303'></font>
       DO j = jts,min(jte,jde-1)<a name='304'>
       DO i = its, min(ite,ide-1)<a name='305'>
            grid%prec_acc_nc(i,j) = 0.<a name='306'>
            grid%snow_acc_nc(i,j)  = 0.<a name='307'>
            grid%sfcrunoff  (i,j) = 0.<a name='308'>
            grid%udrunoff   (i,j) = 0.<a name='309'>
<font color=#447700>! acsnow, and acrunoff are run-total<a name='310'></font>
            grid%acrunoff   (i,j) = 0.<a name='311'>
            grid%acsnow     (i,j) = 0.<a name='312'>
       ENDDO<a name='313'>
       ENDDO<a name='314'>
    endif<a name='315'>
<a name='316'>
<font color=#447700>!   --- SETUP AND INITIALIZE STOCHASTIC PERTURBATION SCHEMES ---<a name='317'></font>
<a name='318'>
   IF ( grid%itimestep .EQ. 0 ) THEN<a name='319'>
      first_trip_for_this_domain = .TRUE.<a name='320'>
   ELSE<a name='321'>
      first_trip_for_this_domain = .FALSE.<a name='322'>
   END IF<a name='323'>
<a name='324'>
   IF ( .not. ( config_flags%restart .or. grid%moved .or. config_flags%hrrr_cycling) ) THEN<a name='325'>
       grid%itimestep=0<a name='326'>
   ENDIF<a name='327'>
<a name='328'>
   IF ( config_flags%restart .or. grid%moved .or. config_flags%hrrr_cycling) THEN <a name='329'>
       first_trip_for_this_domain = .TRUE.<a name='330'>
   ENDIF<a name='331'>
<a name='332'>
   CALL <A href='../../html_code/dyn_em/module_stoch.F.html#INITIALIZE_STOCH'>INITIALIZE_STOCH</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIALIZE_STOCH_1">  (grid, config_flags,                  &amp;    <a name='333'>
                           first_trip_for_this_domain,          &amp;    <a name='334'>
                           ips, ipe, jps, jpe, kps, kpe,        &amp;    <a name='335'>
                           ids, ide, jds, jde, kds, kde,        &amp;    <a name='336'>
                           ims, ime, jms, jme, kms, kme,        &amp;    <a name='337'>
                           its, ite, jts, jte, kts, kte,        &amp;    <a name='338'>
                           imsx, imex, jmsx, jmex, kmsx, kmex,  &amp;<a name='339'>
                           ipsx, ipex, jpsx, jpex, kpsx, kpex,  &amp;<a name='340'>
                           imsy, imey, jmsy, jmey, kmsy, kmey,  &amp;<a name='341'>
                           ipsy, ipey, jpsy, jpey, kpsy, kpey   )<a name='342'>
<a name='343'>
<font color=#447700>!   --- END SETUP STOCHASTIC PERTURBATION SCHEMES ----------<a name='344'></font>
<a name='345'>
<a name='346'>
<a name='347'>
<font color=#447700>! wig: Add a combined exponential+linear weight on the mother boundaries<a name='348'></font>
<font color=#447700>!      following code changes by Ruby Leung. For the nested grid, there<a name='349'></font>
<font color=#447700>!      appears to be some problems when a sponge is used. The points where<a name='350'></font>
<font color=#447700>!      processors meet have problematic values.<a name='351'></font>
<a name='352'>
   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#LBC_FCX_GCX'>lbc_fcx_gcx</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LBC_FCX_GCX_2"> ( grid%fcx , grid%gcx , grid%spec_bdy_width , &amp;<a name='353'>
                      grid%spec_zone , grid%relax_zone , grid%dt , config_flags%spec_exp , &amp;<a name='354'>
                      config_flags%specified , config_flags%nested )<a name='355'>
<a name='356'>
   IF ( config_flags%nested ) THEN<a name='357'>
     grid%dtbc = 0.<a name='358'>
   ENDIF<a name='359'>
<a name='360'>
   IF ( ( grid%id .NE. 1 ) .AND. ( .NOT. config_flags%input_from_file ) ) THEN<a name='361'>
<a name='362'>
      <font color=#447700>!  Every time a domain starts or every time a domain moves, this routine is called.  We want<a name='363'></font>
      <font color=#447700>!  the center (middle) lat/lon of the grid for the metacode.  The lat/lon values are<a name='364'></font>
      <font color=#447700>!  defined at mass points.  Depending on the even/odd points in the SN and WE directions,<a name='365'></font>
      <font color=#447700>!  we end up with the middle point as either 1 point or an average of either 2 or 4 points.<a name='366'></font>
      <font color=#447700>!  Add to this, the need to make sure that we are on the correct patch to retrieve the<a name='367'></font>
      <font color=#447700>!  value of the lat/lon, AND that the lat/lons (for an average) may not all be on the same<a name='368'></font>
      <font color=#447700>!  patch.  Once we find the correct value for lat lon, we need to keep it around on all patches,<a name='369'></font>
      <font color=#447700>!  which is where the wrf_dm_min_real calls come in.<a name='370'></font>
      <font color=#447700>!  If this is the most coarse domain, we do not go in here.  Also, if there is an input file<a name='371'></font>
      <font color=#447700>!  (which has the right values for the middle lat/lon) we do not go in this IF test.<a name='372'></font>
<a name='373'>
      IF      ( ( MOD(ide,2) .EQ. 0 ) .AND. ( MOD(jde,2) .EQ. 0 ) ) THEN<a name='374'>
         num_points_lat_lon = 1<a name='375'>
         iloc = ide/2<a name='376'>
         jloc = jde/2<a name='377'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='378'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='379'>
            lat1 = grid%xlat (iloc,jloc)<a name='380'>
            lon1 = grid%xlong(iloc,jloc)<a name='381'>
         ELSE<a name='382'>
            lat1 = 99999.<a name='383'>
            lon1 = 99999.<a name='384'>
         END IF<a name='385'>
         lat1 = wrf_dm_min_real ( lat1 )<a name='386'>
         lon1 = wrf_dm_min_real ( lon1 )<a name='387'>
         CALL nl_set_cen_lat ( grid%id , lat1 )<a name='388'>
         CALL nl_set_cen_lon ( grid%id , lon1 )<a name='389'>
      ELSE IF ( ( MOD(ide,2) .NE. 0 ) .AND. ( MOD(jde,2) .EQ. 0 ) ) THEN<a name='390'>
         num_points_lat_lon = 2<a name='391'>
         iloc = (ide-1)/2<a name='392'>
         jloc =  jde   /2<a name='393'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='394'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='395'>
            lat1 = grid%xlat (iloc,jloc)<a name='396'>
            lon1 = grid%xlong(iloc,jloc)<a name='397'>
         ELSE<a name='398'>
            lat1 = 99999.<a name='399'>
            lon1 = 99999.<a name='400'>
         END IF<a name='401'>
         lat1 = wrf_dm_min_real ( lat1 )<a name='402'>
         lon1 = wrf_dm_min_real ( lon1 )<a name='403'>
<a name='404'>
         iloc = (ide+1)/2<a name='405'>
         jloc =  jde   /2<a name='406'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='407'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='408'>
            lat2 = grid%xlat (iloc,jloc)<a name='409'>
            lon2 = grid%xlong(iloc,jloc)<a name='410'>
         ELSE<a name='411'>
            lat2 = 99999.<a name='412'>
            lon2 = 99999.<a name='413'>
         END IF<a name='414'>
         lat2 = wrf_dm_min_real ( lat2 )<a name='415'>
         lon2 = wrf_dm_min_real ( lon2 )<a name='416'>
<a name='417'>
         CALL nl_set_cen_lat ( grid%id , ( lat1 + lat2 ) * 0.50 )<a name='418'>
         CALL nl_set_cen_lon ( grid%id , ( lon1 + lon2 ) * 0.50 )<a name='419'>
      ELSE IF ( ( MOD(ide,2) .EQ. 0 ) .AND. ( MOD(jde,2) .NE. 0 ) ) THEN<a name='420'>
         num_points_lat_lon = 2<a name='421'>
         iloc =  ide   /2<a name='422'>
         jloc = (jde-1)/2<a name='423'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='424'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='425'>
            lat1 = grid%xlat (iloc,jloc)<a name='426'>
            lon1 = grid%xlong(iloc,jloc)<a name='427'>
         ELSE<a name='428'>
            lat1 = 99999.<a name='429'>
            lon1 = 99999.<a name='430'>
         END IF<a name='431'>
         lat1 = wrf_dm_min_real ( lat1 )<a name='432'>
         lon1 = wrf_dm_min_real ( lon1 )<a name='433'>
<a name='434'>
         iloc =  ide   /2<a name='435'>
         jloc = (jde+1)/2<a name='436'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='437'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='438'>
            lat2 = grid%xlat (iloc,jloc)<a name='439'>
            lon2 = grid%xlong(iloc,jloc)<a name='440'>
         ELSE<a name='441'>
            lat2 = 99999.<a name='442'>
            lon2 = 99999.<a name='443'>
         END IF<a name='444'>
         lat2 = wrf_dm_min_real ( lat2 )<a name='445'>
         lon2 = wrf_dm_min_real ( lon2 )<a name='446'>
<a name='447'>
         CALL nl_set_cen_lat ( grid%id , ( lat1 + lat2 ) * 0.50 )<a name='448'>
         CALL nl_set_cen_lon ( grid%id , ( lon1 + lon2 ) * 0.50 )<a name='449'>
      ELSE IF ( ( MOD(ide,2) .NE. 0 ) .AND. ( MOD(jde,2) .NE. 0 ) ) THEN<a name='450'>
         num_points_lat_lon = 4<a name='451'>
         iloc = (ide-1)/2<a name='452'>
         jloc = (jde-1)/2<a name='453'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='454'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='455'>
            lat1 = grid%xlat (iloc,jloc)<a name='456'>
            lon1 = grid%xlong(iloc,jloc)<a name='457'>
         ELSE<a name='458'>
            lat1 = 99999.<a name='459'>
            lon1 = 99999.<a name='460'>
         END IF<a name='461'>
         lat1 = wrf_dm_min_real ( lat1 )<a name='462'>
         lon1 = wrf_dm_min_real ( lon1 )<a name='463'>
<a name='464'>
         iloc = (ide+1)/2<a name='465'>
         jloc = (jde-1)/2<a name='466'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='467'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='468'>
            lat2 = grid%xlat (iloc,jloc)<a name='469'>
            lon2 = grid%xlong(iloc,jloc)<a name='470'>
         ELSE<a name='471'>
            lat2 = 99999.<a name='472'>
            lon2 = 99999.<a name='473'>
         END IF<a name='474'>
         lat2 = wrf_dm_min_real ( lat2 )<a name='475'>
         lon2 = wrf_dm_min_real ( lon2 )<a name='476'>
<a name='477'>
         iloc = (ide-1)/2<a name='478'>
         jloc = (jde+1)/2<a name='479'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='480'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='481'>
            lat3 = grid%xlat (iloc,jloc)<a name='482'>
            lon3 = grid%xlong(iloc,jloc)<a name='483'>
         ELSE<a name='484'>
            lat3 = 99999.<a name='485'>
            lon3 = 99999.<a name='486'>
         END IF<a name='487'>
         lat3 = wrf_dm_min_real ( lat3 )<a name='488'>
         lon3 = wrf_dm_min_real ( lon3 )<a name='489'>
<a name='490'>
         iloc = (ide+1)/2<a name='491'>
         jloc = (jde+1)/2<a name='492'>
         IF ( ( ips .LE. iloc ) .AND. ( ipe .GE. iloc ) .AND. &amp;<a name='493'>
              ( jps .LE. jloc ) .AND. ( jpe .GE. jloc ) ) THEN<a name='494'>
            lat4 = grid%xlat (iloc,jloc)<a name='495'>
            lon4 = grid%xlong(iloc,jloc)<a name='496'>
         ELSE<a name='497'>
            lat4 = 99999.<a name='498'>
            lon4 = 99999.<a name='499'>
         END IF<a name='500'>
         lat4 = wrf_dm_min_real ( lat4 )<a name='501'>
         lon4 = wrf_dm_min_real ( lon4 )<a name='502'>
<a name='503'>
         CALL nl_set_cen_lat ( grid%id , ( lat1 + lat2 + lat3 + lat4 ) * 0.25 )<a name='504'>
         CALL nl_set_cen_lon ( grid%id , ( lon1 + lon2 + lon3 + lon4 ) * 0.25 )<a name='505'>
      END IF<a name='506'>
   END IF<a name='507'>
<a name='508'>
   <font color=#447700>!  Make sure that the base-state vales have not changed between what is in the input file<a name='509'></font>
   <font color=#447700>!  and the namelist file.<a name='510'></font>
<a name='511'>
   IF ( .NOT. grid%this_is_an_ideal_run ) THEN<a name='512'>
      CALL nl_get_p_top_requested  ( 1 , p_top_test )<a name='513'>
      IF ( grid%p_top .NE. p_top_test ) THEN<a name='514'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_74"> ( 'start_em: p_top from the namelist does not match p_top from the input file.' )<a name='515'>
      END IF<a name='516'>
   END IF<a name='517'>
<a name='518'>
   IF ( config_flags%use_baseparam_fr_nml ) then<a name='519'>
      CALL nl_get_base_pres        ( 1 , p00        )<a name='520'>
      CALL nl_get_base_temp        ( 1 , t00        )<a name='521'>
      CALL nl_get_base_lapse       ( 1 , a          )<a name='522'>
      CALL nl_get_iso_temp         ( 1 , tiso       )<a name='523'>
      CALL nl_get_base_lapse_strat ( 1 , a_strat    )<a name='524'>
      CALL nl_get_base_pres_strat  ( 1 , p_strat    )<a name='525'>
      IF ( ( t00 .LT. 100. .or. p00 .LT. 10000.) .AND. ( .NOT. grid%this_is_an_ideal_run ) ) THEN<a name='526'>
         WRITE(wrf_err_message,*) 'start_em: BAD BASE STATE for T00 or P00 in namelist.input file'<a name='527'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_75">(TRIM(wrf_err_message))<a name='528'>
      END IF<a name='529'>
<a name='530'>
   ELSE<a name='531'>
   <font color=#447700>! get these constants from model data<a name='532'></font>
<a name='533'>
      t00     = grid%t00<a name='534'>
      p00     = grid%p00<a name='535'>
      a       = grid%tlp<a name='536'>
      tiso    = grid%tiso<a name='537'>
      a_strat = grid%tlp_strat<a name='538'>
      p_strat = grid%p_strat<a name='539'>
      IF ( ( t00 .LT. 100. .or. p00 .LT. 10000.) .AND. ( .NOT. grid%this_is_an_ideal_run ) ) THEN<a name='540'>
         WRITE(wrf_err_message,*)&amp;<a name='541'>
         'start_em: did not find base state parameters in wrfinput. Add use_baseparam_fr_nml = .t. in &amp;dynamics and rerun'<a name='542'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_76">(TRIM(wrf_err_message))<a name='543'>
      ENDIF<a name='544'>
<a name='545'>
   ENDIF<a name='546'>
<a name='547'>
<font color=#447700>!  check if tiso in the input file agrees with namelist value<a name='548'></font>
<a name='549'>
   CALL nl_get_iso_temp   ( 1 , tiso_tmp )<a name='550'>
   IF ( ( tiso_tmp .NE. tiso ) .AND. ( .NOT. grid%this_is_an_ideal_run ) ) THEN<a name='551'>
      WRITE(wrf_err_message,*)&amp;<a name='552'>
      'start_em: namelist iso_temp is not equal to iso_temp in wrfinput. Reset nml value and rerun'<a name='553'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_77">(TRIM(wrf_err_message))<a name='554'>
   ENDIF<a name='555'>
<a name='556'>
   IF ( .NOT. config_flags%restart .AND. &amp;<a name='557'>
        (( config_flags%input_from_hires ) .OR. ( config_flags%input_from_file ))) THEN<a name='558'>
<a name='559'>
      IF ( config_flags%map_proj .EQ. 0 ) THEN<a name='560'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_78"> ( 'start_domain: Idealized case cannot have a separate nested input file' )<a name='561'>
      END IF<a name='562'>
<a name='563'>
      <font color=#447700>!  Base state potential temperature and inverse density (alpha = 1/rho) from<a name='564'></font>
      <font color=#447700>!  the half eta levels and the base-profile surface pressure.  Compute 1/rho<a name='565'></font>
      <font color=#447700>!  from equation of state.  The potential temperature is a perturbation from t0.<a name='566'></font>
<a name='567'>
      DO k = 1, kte<a name='568'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='569'></font>
         grid%c1f(k) = 1.<a name='570'>
         grid%c2f(k) = 0.<a name='571'>
         grid%c3f(k) = grid%znw(k)<a name='572'>
         grid%c4f(k) = 0.<a name='573'>
         grid%c1h(k) = 1.<a name='574'>
         grid%c2h(k) = 0.<a name='575'>
         grid%c3h(k) = grid%znu(k)<a name='576'>
         grid%c4h(k) = 0.<a name='577'>
#elif ( HYBRID_COORD==1 )<a name='578'>
         IF ( grid%c1f(1) .NE. 1. ) THEN<a name='579'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_40"> ( 0 , '---- WARNING : Maybe old non-HVC input, setting default 1d array values for TF' )<a name='580'>
            IF ( grid%hybrid_opt .NE. 0 ) THEN<a name='581'>
               CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_79"> ( '---- Error : Cannot use old input and try to use hybrid vertical coordinate option' )<a name='582'>
            END IF<a name='583'>
            grid%c1f(k) = 1.<a name='584'>
            grid%c2f(k) = 0.<a name='585'>
            grid%c3f(k) = grid%znw(k)<a name='586'>
            grid%c4f(k) = 0.<a name='587'>
            grid%c1h(k) = 1.<a name='588'>
            grid%c2h(k) = 0.<a name='589'>
            grid%c3h(k) = grid%znu(k)<a name='590'>
            grid%c4h(k) = 0.<a name='591'>
         END IF<a name='592'>
#endif<a name='593'>
      END DO<a name='594'>
<a name='595'>
      DO j = jts, MIN(jte,jde-1)<a name='596'>
         DO i = its, MIN(ite,ide-1)<a name='597'>
<a name='598'>
            <font color=#447700>!  Base state pressure is a function of eta level and terrain, only, plus<a name='599'></font>
            <font color=#447700>!  the hand full of constants: p00 (sea level pressure, Pa), t00 (sea level<a name='600'></font>
            <font color=#447700>!  temperature, K), A (temperature difference, from 1000 mb to 300 mb, K),<a name='601'></font>
            <font color=#447700>!  tiso (isothermal temperature at tropopause/lower stratosphere), <a name='602'></font>
            <font color=#447700>!  p_strat (pressure at top of isothermal layer), A_strat (lapse rate in <a name='603'></font>
            <font color=#447700>!  stratosphere above isothermal layer)<a name='604'></font>
<a name='605'>
            p_surf = p00 * EXP ( -t00/a + ( (t00/a)**2 - 2.*g*grid%ht(i,j)/a/r_d ) **0.5 )<a name='606'>
<a name='607'>
            DO k = 1, kte-1<a name='608'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='609'></font>
               grid%pb(i,k,j) = grid%znu(k)*(p_surf - grid%p_top) + grid%p_top<a name='610'>
#elif ( HYBRID_COORD==1 )<a name='611'>
               grid%pb(i,k,j) = grid%c3h(k)*(p_surf - grid%p_top) + grid%c4h(k) + grid%p_top<a name='612'>
#endif<a name='613'>
               temp = MAX ( tiso, t00 + A*LOG(grid%pb(i,k,j)/p00) )<a name='614'>
               IF ( grid%pb(i,k,j) .LT. p_strat ) THEN<a name='615'>
                  temp = tiso + A_strat * LOG ( grid%pb(i,k,j)/p_strat )<a name='616'>
               ENDIF<a name='617'>
               grid%t_init(i,k,j) = temp*(p00/grid%pb(i,k,j))**(r_d/cp) - t0<a name='618'>
               grid%alb(i,k,j) = (r_d/p1000mb)*(grid%t_init(i,k,j)+t0)*(grid%pb(i,k,j)/p1000mb)**cvpm<a name='619'>
            END DO<a name='620'>
<a name='621'>
            <font color=#447700>!  Base state mu is defined as base state surface pressure minus grid%p_top<a name='622'></font>
<a name='623'>
            grid%MUB(i,j) = p_surf - grid%p_top<a name='624'>
<a name='625'>
            <font color=#447700>!  Integrate base geopotential, starting at terrain elevation.  This assures that<a name='626'></font>
            <font color=#447700>!  the base state is in exact hydrostatic balance with respect to the model equations.<a name='627'></font>
            <font color=#447700>!  This field is on full levels.<a name='628'></font>
<a name='629'>
            grid%phb(i,1,j) = grid%ht(i,j) * g<a name='630'>
<a name='631'>
            IF ( config_flags%hypsometric_opt .EQ. 1 ) THEN<a name='632'>
               DO kk  = 2,kte<a name='633'>
                  k = kk - 1<a name='634'>
                  grid%phb(i,kk,j) = grid%phb(i,kk-1,j) - grid%dnw(kk-1)*grid%mub(i,j)*grid%alb(i,kk-1,j)<a name='635'>
               END DO<a name='636'>
            ELSE IF ( config_flags%hypsometric_opt .EQ. 2 ) THEN<a name='637'>
               DO k  = 2,kte<a name='638'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='639'></font>
                  pfu = grid%mub(i,j)*grid%znw(k)   + grid%p_top<a name='640'>
                  pfd = grid%mub(i,j)*grid%znw(k-1) + grid%p_top<a name='641'>
                  phm = grid%mub(i,j)*grid%znu(k-1) + grid%p_top<a name='642'>
#elif ( HYBRID_COORD==1 )<a name='643'>
                  pfu = grid%c3f(k  )*grid%MUB(i,j) + grid%c4f(k  ) + grid%p_top<a name='644'>
                  pfd = grid%c3f(k-1)*grid%MUB(i,j) + grid%c4f(k-1) + grid%p_top<a name='645'>
                  phm = grid%c3h(k-1)*grid%MUB(i,j) + grid%c4h(k-1) + grid%p_top<a name='646'>
#endif<a name='647'>
                  grid%phb(i,k,j) = grid%phb(i,k-1,j) + grid%alb(i,k-1,j)*phm*LOG(pfd/pfu)<a name='648'>
               END DO<a name='649'>
            END IF<a name='650'>
         END DO<a name='651'>
      END DO<a name='652'>
<a name='653'>
   ENDIF<a name='654'>
<a name='655'>
   IF(.not.config_flags%restart)THEN<a name='656'>
<a name='657'>
<font color=#447700>!  if this is for a nested domain, the defined/interpolated fields are the _2<a name='658'></font>
<a name='659'>
     IF ( first_trip_for_this_domain ) THEN<a name='660'>
<a name='661'>
<font color=#447700>! data that is expected to be zero must be explicitly initialized as such<a name='662'></font>
<font color=#447700>!    grid%h_diabatic = 0.<a name='663'></font>
<a name='664'>
       DO j = jts,min(jte,jde-1)<a name='665'>
       DO k = kts,kte-1<a name='666'>
       DO i = its, min(ite,ide-1)<a name='667'>
           IF ( grid%imask_nostag(i,j) .EQ. 1 ) THEN<a name='668'>
             grid%t_1(i,k,j)=grid%t_2(i,k,j)<a name='669'>
           ENDIF<a name='670'>
       ENDDO<a name='671'>
       ENDDO<a name='672'>
       ENDDO<a name='673'>
<a name='674'>
       DO j = jts,min(jte,jde-1)<a name='675'>
       DO k = kts,kte<a name='676'>
       DO i = its, min(ite,ide-1)<a name='677'>
          grid%ph_1(i,k,j)=grid%ph_2(i,k,j)<a name='678'>
       ENDDO<a name='679'>
       ENDDO<a name='680'>
       ENDDO<a name='681'>
<a name='682'>
       DO j = jts,min(jte,jde-1)<a name='683'>
       DO i = its, min(ite,ide-1)<a name='684'>
           IF ( grid%imask_nostag(i,j) .EQ. 1 ) THEN<a name='685'>
             grid%MU_1(i,j)=grid%MU_2(i,j)<a name='686'>
           ENDIF<a name='687'>
       ENDDO<a name='688'>
       ENDDO<a name='689'>
     END IF<a name='690'>
<a name='691'>
<font color=#447700>!  reconstitute base-state fields<a name='692'></font>
<a name='693'>
    IF(config_flags%max_dom .EQ. 1)THEN<a name='694'>
<font color=#447700>! with single domain, grid%t_init from wrfinput is OK to use<a name='695'></font>
     DO j = jts,min(jte,jde-1)<a name='696'>
     DO k = kts,kte-1<a name='697'>
     DO i = its, min(ite,ide-1)<a name='698'>
       IF ( grid%imask_nostag(i,j) .EQ. 1 ) THEN<a name='699'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='700'></font>
         grid%pb(i,k,j) = grid%znu(k)*grid%mub(i,j)+grid%p_top<a name='701'>
#elif ( HYBRID_COORD==1 )<a name='702'>
         grid%pb(i,k,j) = grid%c3h(k  )*grid%MUB(i,j) + grid%c4h(k  ) + grid%p_top<a name='703'>
#endif<a name='704'>
         grid%alb(i,k,j) = (r_d/p1000mb)*(grid%t_init(i,k,j)+t0)*(grid%pb(i,k,j)/p1000mb)**cvpm<a name='705'>
       ENDIF<a name='706'>
     ENDDO<a name='707'>
     ENDDO<a name='708'>
     ENDDO<a name='709'>
    ELSE <font color=#447700>! there is more than 1 domain<a name='710'></font>
     IF ( .NOT. grid%this_is_an_ideal_run ) THEN <font color=#447700>! this is a real run<a name='711'></font>
        DO j = jts,min(jte,jde-1)<a name='712'>
        DO k = kts,kte-1<a name='713'>
        DO i = its, min(ite,ide-1)<a name='714'>
          IF ( grid%imask_nostag(i,j) .EQ. 1 ) THEN<a name='715'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='716'></font>
            grid%pb(i,k,j) = grid%znu(k)*grid%mub(i,j)+grid%p_top<a name='717'>
#elif ( HYBRID_COORD==1 )<a name='718'>
            grid%pb(i,k,j) = grid%c3h(k  )*grid%MUB(i,j) + grid%c4h(k  ) + grid%p_top<a name='719'>
#endif<a name='720'>
            temp = MAX ( tiso, t00 + A*LOG(grid%pb(i,k,j)/p00) )<a name='721'>
            IF ( grid%pb(i,k,j) .LT. p_strat ) THEN<a name='722'>
               temp = tiso + A_strat * LOG ( grid%pb(i,k,j)/p_strat )<a name='723'>
            ENDIF<a name='724'>
            grid%t_init(i,k,j) = temp*(p00/grid%pb(i,k,j))**(r_d/cp) - t0<a name='725'>
            grid%alb(i,k,j) = (r_d/p1000mb)*(grid%t_init(i,k,j)+t0)*(grid%pb(i,k,j)/p1000mb)**cvpm<a name='726'>
       ENDIF<a name='727'>
      ENDDO<a name='728'>
      ENDDO<a name='729'>
      ENDDO<a name='730'>
<a name='731'>
      IF ( ( config_flags%rebalance .EQ. 1 ) .OR. &amp;<a name='732'>
           ( ( config_flags%rebalance .EQ. 2 ) .AND. ( config_flags%vert_refine_method .EQ. 2 ) ) ) THEN<a name='733'>
        <font color=#447700>!  Integrate base geopotential, starting at terrain elevation.  This assures that<a name='734'></font>
        <font color=#447700>!  the base state is in exact hydrostatic balance with respect to the model equations.<a name='735'></font>
        <font color=#447700>!  This field is on full levels.<a name='736'></font>
       DO j = jts,min(jte,jde-1)<a name='737'>
       DO i = its, min(ite,ide-1)               <a name='738'>
        grid%phb(i,1,j) = grid%ht(i,j) * g<a name='739'>
        IF ( config_flags%hypsometric_opt .EQ. 1 ) THEN<a name='740'>
           DO kk  = 2,kte<a name='741'>
              k = kk - 1<a name='742'>
              grid%phb(i,kk,j) = grid%phb(i,kk-1,j) - grid%dnw(kk-1)*grid%mub(i,j)*grid%alb(i,kk-1,j)<a name='743'>
           END DO<a name='744'>
        ELSE IF ( config_flags%hypsometric_opt .EQ. 2 ) THEN<a name='745'>
           DO k  = 2,kte<a name='746'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='747'></font>
              pfu = grid%mub(i,j)*grid%znw(k)   + grid%p_top<a name='748'>
              pfd = grid%mub(i,j)*grid%znw(k-1) + grid%p_top<a name='749'>
              phm = grid%mub(i,j)*grid%znu(k-1) + grid%p_top<a name='750'>
#elif ( HYBRID_COORD==1 )<a name='751'>
              pfu = grid%c3f(k  )*grid%MUB(i,j) + grid%c4f(k  ) + grid%p_top<a name='752'>
              pfd = grid%c3f(k-1)*grid%MUB(i,j) + grid%c4f(k-1) + grid%p_top<a name='753'>
              phm = grid%c3h(k-1)*grid%MUB(i,j) + grid%c4h(k-1) + grid%p_top<a name='754'>
#endif<a name='755'>
              grid%phb(i,k,j) = grid%phb(i,k-1,j) + grid%alb(i,k-1,j)*phm*LOG(pfd/pfu)<a name='756'>
            END DO<a name='757'>
          ENDIF<a name='758'>
       ENDDO<a name='759'>
       ENDDO<a name='760'>
       END IF<a name='761'>
<a name='762'>
     ELSE<a name='763'>
        IF ( config_flags%ideal_init_method .EQ. 1 ) THEN<a name='764'>
           DO j = jts,min(jte,jde-1)<a name='765'>
           DO k = kts,kte-1<a name='766'>
           DO i = its, min(ite,ide-1)<a name='767'>
             IF ( grid%imask_nostag(i,j) .EQ. 1 ) THEN<a name='768'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='769'></font>
               grid%pb(i,k,j) = grid%znu(k)*grid%mub(i,j)+grid%p_top<a name='770'>
#elif ( HYBRID_COORD==1 )<a name='771'>
               grid%pb(i,k,j) = grid%c3h(k  )*grid%MUB(i,j) + grid%c4h(k  ) + grid%p_top<a name='772'>
#endif<a name='773'>
               grid%alb(i,k,j) = -grid%rdnw(k)*(grid%phb(i,k+1,j)-grid%phb(i,k,j))/grid%mub(i,j)<a name='774'>
               grid%t_init(i,k,j) = grid%alb(i,k,j)*(p1000mb/r_d)/((grid%pb(i,k,j)/p1000mb)**cvpm) - t0<a name='775'>
             ENDIF<a name='776'>
           ENDDO<a name='777'>
           ENDDO<a name='778'>
           ENDDO<a name='779'>
        ELSE IF ( config_flags%ideal_init_method .EQ. 2 ) THEN<a name='780'>
           DO j = jts,min(jte,jde-1)<a name='781'>
           DO k = kts,kte-1<a name='782'>
           DO i = its, min(ite,ide-1)<a name='783'>
             IF ( grid%imask_nostag(i,j) .EQ. 1 ) THEN<a name='784'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='785'></font>
               grid%pb(i,k,j) = grid%znu(k)*grid%mub(i,j)+grid%p_top<a name='786'>
#elif ( HYBRID_COORD==1 )<a name='787'>
               grid%pb(i,k,j) = grid%c3h(k  )*grid%MUB(i,j) + grid%c4h(k  ) + grid%p_top<a name='788'>
#endif<a name='789'>
               grid%alb(i,k,j) = (r_d/p1000mb)*(grid%t_init(i,k,j)+t0)*(grid%pb(i,k,j)/p1000mb)**cvpm<a name='790'>
             ENDIF<a name='791'>
           ENDDO<a name='792'>
           ENDDO<a name='793'>
           ENDDO<a name='794'>
           <font color=#447700>!  Integrate base geopotential, starting at terrain elevation.  This assures that<a name='795'></font>
           <font color=#447700>!  the base state is in exact hydrostatic balance with respect to the model equations.<a name='796'></font>
           <font color=#447700>!  This field is on full levels.<a name='797'></font>
           DO j = jts,min(jte,jde-1)<a name='798'>
           DO i = its, min(ite,ide-1)<a name='799'>
            grid%phb(i,1,j) = grid%ht(i,j) * g <a name='800'>
            DO kk  = 2,kte<a name='801'>
              k = kk - 1 <a name='802'>
              grid%phb(i,kk,j) = grid%phb(i,kk-1,j) - grid%dnw(kk-1)*grid%mub(i,j)*grid%alb(i,kk-1,j)<a name='803'>
            END DO<a name='804'>
           ENDDO<a name='805'>
           ENDDO<a name='806'>
        END IF  <font color=#447700>! end if initialization for ideal, use method 1 or 2<a name='807'></font>
     END IF <font color=#447700>! end if this is a real or ideal run<a name='808'></font>
    END IF <font color=#447700>! end if there is more than 1 domain<a name='809'></font>
     <a name='810'>
<font color=#447700>!------base state is finished, perturbation values are recalculated below-----<a name='811'></font>
<a name='812'>
  <font color=#447700>! For the HRRR application, we want to go through this rebalancing.  They <a name='813'></font>
  <font color=#447700>! have a clunky way of testig on this, but it is operational, so no need to<a name='814'></font>
  <font color=#447700>! cause them troubles.<a name='815'></font>
<a name='816'>
  IF ( ( grid%dfi_opt .EQ. DFI_NODFI ) .and. ( config_flags%cycling ) ) THEN<a name='817'>
       call <A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_DRIVER_CYCL'>rebalance_driver_cycl</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REBALANCE_DRIVER_CYCL_1"> (grid )<a name='818'>
<a name='819'>
       DO j = jts,min(jte,jde-1)<a name='820'>
       DO k = kts,kte<a name='821'>
       DO i = its, min(ite,ide-1)<a name='822'>
          grid%ph_1(i,k,j)=grid%ph_2(i,k,j)<a name='823'>
       ENDDO<a name='824'>
       ENDDO<a name='825'>
       ENDDO<a name='826'>
<a name='827'>
  <font color=#447700>!  Everyone else runs thorugh here.  NOTE that we might also want to call the<a name='828'></font>
  <font color=#447700>!  rebalancing ourselves for different set ups.  It does not impact HRRR, so <a name='829'></font>
  <font color=#447700>!  it is an easy decision.<a name='830'></font>
<a name='831'>
  ELSE<a name='832'>
<a name='833'>
     <font color=#447700>! We request rebalancing for vertical grid nesting, or when the user asks for rebalancing.<a name='834'></font>
     <font color=#447700>! Rebalance recomputes 1/rho, p, ph_2, ph0, p_hyd<a name='835'></font>
<a name='836'>
     IF ( ( config_flags%rebalance .EQ. 1 ) .OR. &amp;<a name='837'>
        ( ( config_flags%rebalance .EQ. 2 ) .AND. ( config_flags%vert_refine_method .EQ. 2 ) ) ) THEN<a name='838'>
       call <A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_DRIVER_CYCL'>rebalance_driver_cycl</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REBALANCE_DRIVER_CYCL_2"> (grid )<a name='839'>
<a name='840'>
       DO j = jts,min(jte,jde-1)<a name='841'>
       DO k = kts,kte<a name='842'>
       DO i = its, min(ite,ide-1)<a name='843'>
          grid%ph_1(i,k,j)=grid%ph_2(i,k,j)<a name='844'>
       ENDDO<a name='845'>
       ENDDO<a name='846'>
       ENDDO<a name='847'>
     END IF<a name='848'>
<a name='849'>
     <font color=#447700>! Use equations from calc_p_rho_phi to derive p and al from ph: linear in log p<a name='850'></font>
<a name='851'>
    IF ( config_flags%hypsometric_opt .EQ. 1 ) THEN<a name='852'>
       DO j=jts,min(jte,jde-1)<a name='853'>
       DO k=kts,kte-1<a name='854'>
       DO i=its,min(ite,ide-1)<a name='855'>
          grid%al(i,k,j)=-1./(grid%mub(i,j)+grid%mu_1(i,j))*(grid%alb(i,k,j)*grid%mu_1(i,j)  &amp;<a name='856'>
                     +grid%rdnw(k)*(grid%ph_1(i,k+1,j)-grid%ph_1(i,k,j)))<a name='857'>
       ENDDO<a name='858'>
       ENDDO<a name='859'>
       ENDDO<a name='860'>
    ELSE IF ( config_flags%hypsometric_opt .EQ. 2 ) THEN<a name='861'>
       DO j=jts,min(jte,jde-1)<a name='862'>
       DO k=kts,kte-1<a name='863'>
       DO i=its,min(ite,ide-1)<a name='864'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='865'></font>
          pfu = (grid%mub(i,j)+grid%mu_1(i,j))*grid%znw(k+1)+grid%p_top<a name='866'>
          pfd = (grid%mub(i,j)+grid%mu_1(i,j))*grid%znw(k)  +grid%p_top<a name='867'>
          phm = (grid%mub(i,j)+grid%mu_1(i,j))*grid%znu(k)  +grid%p_top<a name='868'>
#elif ( HYBRID_COORD==1 )<a name='869'>
          pfu = grid%c3f(k+1)*(grid%MUB(i,j)+grid%MU_1(i,j)) + grid%c4f(k+1) + grid%p_top<a name='870'>
          pfd = grid%c3f(k  )*(grid%MUB(i,j)+grid%MU_1(i,j)) + grid%c4f(k  ) + grid%p_top<a name='871'>
          phm = grid%c3h(k  )*(grid%MUB(i,j)+grid%MU_1(i,j)) + grid%c4h(k  ) + grid%p_top<a name='872'>
#endif<a name='873'>
          grid%al(i,k,j) = (grid%ph_1(i,k+1,j)-grid%ph_1(i,k,j)+grid%phb(i,k+1,j)-grid%phb(i,k,j)) &amp;<a name='874'>
                            /phm/LOG(pfd/pfu)-grid%alb(i,k,j)<a name='875'>
       ENDDO<a name='876'>
       ENDDO<a name='877'>
       ENDDO<a name='878'>
    END IF <font color=#447700>! which hypsometric option<a name='879'></font>
    DO j=jts,min(jte,jde-1)<a name='880'>
    DO k=kts,kte-1<a name='881'>
    DO i=its,min(ite,ide-1)<a name='882'>
       qvf = 1.+rvovrd*moist(i,k,j,P_QV)<a name='883'>
       grid%p(i,k,j)=p1000mb*( (r_d*(t0+grid%t_1(i,k,j))*qvf)/                     &amp;<a name='884'>
                  (p1000mb*(grid%al(i,k,j)+grid%alb(i,k,j))) )**cpovcv  &amp;<a name='885'>
                  -grid%pb(i,k,j)<a name='886'>
       grid%p_hyd(i,k,j) = grid%p(i,k,j) + grid%pb(i,k,j)<a name='887'>
       grid%alt(i,k,j) = grid%al(i,k,j) + grid%alb(i,k,j)<a name='888'>
    ENDDO<a name='889'>
    ENDDO<a name='890'>
    ENDDO<a name='891'>
  ENDIF <font color=#447700>! Various rebalancing options<a name='892'></font>
<a name='893'>
    IF ( .NOT. grid%this_is_an_ideal_run ) THEN<a name='894'>
       DO j=jts,min(jte,jde-1)<a name='895'>
          DO i=its,min(ite,ide-1)<a name='896'>
             p_surf = p00 * EXP ( -t00/a + ( (t00/a)**2 - 2.*g*grid%ht(i,j)/a/r_d ) **0.5 )<a name='897'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='898'></font>
             grid%p_hyd_w(i,1,j) = grid%p(i,1,j) + grid%znw(1)*(p_surf - grid%p_top) + grid%p_top<a name='899'>
#elif ( HYBRID_COORD==1 )<a name='900'>
             grid%p_hyd_w(i,1,j) = grid%p(i,1,j) + grid%c3f(1)*(p_surf - grid%p_top) + grid%c4f(1) + grid%p_top<a name='901'>
#endif<a name='902'>
             DO k=kts+1,kte<a name='903'>
                grid%p_hyd_w(i,k,j) = ( 2.*(grid%p(i,k-1,j)+grid%pb(i,k-1,j)) - grid%p_hyd_w(i,k-1,j) )<a name='904'>
             ENDDO<a name='905'>
          ENDDO<a name='906'>
       ENDDO<a name='907'>
    ELSE<a name='908'>
       DO j=jts,min(jte,jde-1)<a name='909'>
          DO i=its,min(ite,ide-1)<a name='910'>
             p_surf = grid%MUB(i,j)+grid%p_top<a name='911'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='912'></font>
             grid%p_hyd_w(i,1,j) = grid%p(i,1,j) + grid%znw(1)*(p_surf - grid%p_top) + grid%p_top<a name='913'>
#elif ( HYBRID_COORD==1 )<a name='914'>
             grid%p_hyd_w(i,1,j) = grid%p(i,1,j) + grid%c3f(1)*(p_surf - grid%p_top) + grid%c4f(1) + grid%p_top<a name='915'>
#endif<a name='916'>
             DO k=kts+1,kte<a name='917'>
                grid%p_hyd_w(i,k,j) = ( 2.*(grid%p(i,k-1,j)+grid%pb(i,k-1,j)) - grid%p_hyd_w(i,k-1,j) )<a name='918'>
             ENDDO<a name='919'>
          ENDDO<a name='920'>
       ENDDO<a name='921'>
    END IF<a name='922'>
<a name='923'>
   ENDIF <font color=#447700>! first trip for this domain<a name='924'></font>
<a name='925'>
   DO j=jts,min(jte,jde-1)<a name='926'>
      DO k = kts,kte<a name='927'>
         DO i = its, min(ite,ide-1)<a name='928'>
            z_at_q(i,k,j)=(grid%ph_2(i,k,j)+grid%phb(i,k,j))/g<a name='929'>
         ENDDO<a name='930'>
      ENDDO<a name='931'>
   ENDDO<a name='932'>
<a name='933'>
   IF ( grid%press_adj .and. ( grid%id .NE. 1 ) .AND. .NOT. ( config_flags%restart ) .AND. &amp;<a name='934'>
       ( ( config_flags%input_from_hires ) .OR. ( config_flags%input_from_file ) ) ) THEN<a name='935'>
      DO j = jts, MIN(jte,jde-1)<a name='936'>
         DO i = its, MIN(ite,ide-1)<a name='937'>
            grid%MU_2(i,j) = grid%MU_2(i,j) + grid%al(i,1,j) / ( grid%alt(i,1,j) * grid%alb(i,1,j) ) * &amp;<a name='938'>
                                    g * ( grid%ht(i,j) - grid%ht_fine(i,j) )<a name='939'>
         END DO<a name='940'>
       END DO<a name='941'>
       DO j = jts,min(jte,jde-1)<a name='942'>
       DO i = its, min(ite,ide-1)<a name='943'>
          grid%MU_1(i,j)=grid%MU_2(i,j)<a name='944'>
       ENDDO<a name='945'>
       ENDDO<a name='946'>
<a name='947'>
   END IF<a name='948'>
<a name='949'>
<font color=#447700>! set GMT outside of phy_init because phy_init may not be called on this<a name='950'></font>
<font color=#447700>! process if, for example, it is a moving nest and if this part of the domain is not<a name='951'></font>
<font color=#447700>! being initialized (not the leading edge).<a name='952'></font>
   CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_SETGMTETC'>domain_setgmtetc</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_SETGMTETC_1">( grid, start_of_simulation )<a name='953'>
   IF ( first_trip_for_this_domain ) THEN<a name='954'>
<a name='955'>
   CALL wrf_debug ( 100 , 'start_domain_em: Before call to phy_init' )<a name='956'>
<a name='957'>
<font color=#447700>! namelist MPDT does not exist yet, so set it here<a name='958'></font>
<font color=#447700>! MPDT is the call frequency for microphysics in minutes (0 means every step)<a name='959'></font>
   MPDT = 0.<a name='960'>
<a name='961'>
   IF(config_flags%cycling) THEN<a name='962'>
       start_of_simulation = .true.<a name='963'>
<font color=#447700>!  print *,'cycling, start_of_simulation --&gt;',config_flags%cycling, start_of_simulation<a name='964'></font>
       grid%xtime=0.<a name='965'>
<font color=#447700>!   print *,'xtime=',grid%xtime<a name='966'></font>
   ENDIF<a name='967'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='968'></font>
<font color=#447700>! Adaptive time step: Added by T. Hutchinson, WSI  11/6/07<a name='969'></font>
<font color=#447700>!<a name='970'></font>
<font color=#447700>!<a name='971'></font>
<a name='972'>
   IF ( ( grid%use_adaptive_time_step ) .AND. &amp;<a name='973'>
        ( ( grid%dfi_opt .EQ. DFI_NODFI ) .OR. ( grid%dfi_stage .EQ. DFI_FST ) ) ) THEN<a name='974'>
<a name='975'>
<font color=#447700>!  Calculate any variables that were not set<a name='976'></font>
<font color=#447700>!BPR BEGIN<a name='977'></font>
<font color=#447700>!     This subroutine is called more than once at the first time step for a<a name='978'></font>
<font color=#447700>!     given domain.  The following if statement is to prevent the code in<a name='979'></font>
<font color=#447700>!     the if statement from executing more than once per domain at the<a name='980'></font>
<font color=#447700>!     beginning of the model run (since last_step_update=-1 the first time<a name='981'></font>
<font color=#447700>!     this is reached and should be =0 after this).<a name='982'></font>
<font color=#447700>!     Without this if statement, when this code was executed for the second<a name='983'></font>
<font color=#447700>!     time it can result in grid%dt being set incorrectly.<a name='984'></font>
<font color=#447700>!     -This is because grid%dt will be set equal to grid%starting_time_step<a name='985'></font>
<font color=#447700>!      which ignores a possible denominator in the starting time step.<a name='986'></font>
<font color=#447700>!     -The first time this code is reached is also does this, but then the<a name='987'></font>
<font color=#447700>!      call to adapt_timestep correct this<a name='988'></font>
<font color=#447700>!     -Subsequent times this code is reached adapt_timestep will not correct<a name='989'></font>
<font color=#447700>!      this because it will recognize that it has already been executed for<a name='990'></font>
<font color=#447700>!      this timestep and exit out before doing the calculation.<a name='991'></font>
<a name='992'>
      if (grid%last_step_updated .NE. grid%itimestep) then<a name='993'>
<a name='994'>
      if (grid%starting_time_step == -1) then<a name='995'>
         grid%starting_time_step = NINT(4 * MIN(grid%dx,grid%dy) / 1000)<a name='996'>
      endif<a name='997'>
<a name='998'>
      grid%time_step = grid%starting_time_step<a name='999'>
      config_flags%time_step = grid%starting_time_step<a name='1000'>
      model_config_rec%time_step = grid%starting_time_step<a name='1001'>
<a name='1002'>
      if (grid%max_time_step == -1) then<a name='1003'>
         grid%max_time_step = NINT(8 * MIN(grid%dx,grid%dy) / 1000)<a name='1004'>
      endif<a name='1005'>
<a name='1006'>
      if (grid%min_time_step == -1) then<a name='1007'>
         grid%min_time_step = NINT(3 * MIN(grid%dx,grid%dy) / 1000)<a name='1008'>
      endif<a name='1009'>
<a name='1010'>
<font color=#447700>!     Set a starting timestep.<a name='1011'></font>
<a name='1012'>
      grid%dt = grid%starting_time_step<a name='1013'>
<a name='1014'>
<font color=#447700>!     Initialize max cfl values<a name='1015'></font>
      <a name='1016'>
      grid%last_max_vert_cfl = 0<a name='1017'>
      grid%last_max_horiz_cfl = 0<a name='1018'>
<a name='1019'>
<font color=#447700>!     Check to assure that time_step_sound is to be dynamically set.<a name='1020'></font>
<a name='1021'>
      CALL nl_set_time_step_sound ( 1 , 0 )<a name='1022'>
      grid%time_step_sound = 0<a name='1023'>
<a name='1024'>
      grid%max_msftx=MAXVAL(grid%msftx)<a name='1025'>
      grid%max_msfty=MAXVAL(grid%msfty)<a name='1026'>
#ifdef DM_PARALLEL<a name='1027'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>wrf_dm_maxval</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_3">(grid%max_msftx, idex, jdex)<a name='1028'>
      CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>wrf_dm_maxval</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_4">(grid%max_msfty, idex, jdex)<a name='1029'>
#endif<a name='1030'>
      end if<a name='1031'>
<font color=#447700>!BPR END<a name='1032'></font>
<a name='1033'>
<font color=#447700>!     This first call just initializes variables.<a name='1034'></font>
<font color=#447700>!     If a restart, get initialized variables from restart file<a name='1035'></font>
<a name='1036'>
      IF ( .NOT. ( config_flags%restart ) ) then<a name='1037'>
         CALL <A href='../../html_code/dyn_em/adapt_timestep_em.F.html#ADAPT_TIMESTEP'>adapt_timestep</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADAPT_TIMESTEP_3">(grid, config_flags)<a name='1038'>
      END IF<a name='1039'>
<a name='1040'>
<a name='1041'>
   END IF  <font color=#447700>! adaptive computations<a name='1042'></font>
<a name='1043'>
<font color=#447700>! End of adaptive time step modifications<a name='1044'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1045'></font>
<a name='1046'>
<a name='1047'>
   CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>set_tiles</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_3"> ( grid , grid%imask_nostag, ims, ime, jms, jme, ips, ipe, jps, jpe )<a name='1048'>
<font color=#447700>!<a name='1049'></font>
<font color=#447700>! Phy init can do reads and broadcasts when initializing physics -- landuse for example. However, if<a name='1050'></font>
<font color=#447700>! we're running on a reduced mesh (that is, some tasks don't have any work) we have to at least let them<a name='1051'></font>
<font color=#447700>! pass through this code so the broadcasts don't hang on the other, active tasks.  Set the number of<a name='1052'></font>
<font color=#447700>! tiles to a minimum of 1 and assume that the backwards patch ranges (ips=0, ipe=-1) will prevent<a name='1053'></font>
<font color=#447700>! anything else from happening on the blank tasks.  JM 20080605<a name='1054'></font>
<font color=#447700>!<a name='1055'></font>
   if ( allowed_to_read ) grid%num_tiles = max(1,grid%num_tiles)<a name='1056'>
<font color=#447700>!<a name='1057'></font>
<font color=#447700>! Phy_init is not necessarily thread-safe; do not multi-thread this loop.<a name='1058'></font>
<font color=#447700>! The tiling is to handle the fact that we may be masking off part of the computation.<a name='1059'></font>
<font color=#447700>!<a name='1060'></font>
<a name='1061'>
#ifdef DM_PARALLEL<a name='1062'>
if(config_flags%sf_surface_physics.eq.NOAHMPSCHEME.and.config_flags%opt_run.eq.5)then<a name='1063'>
#  include "<A href='../../html_code/include/HALO_EM_HYDRO_NOAHMP_INIT.inc.html'>HALO_EM_HYDRO_NOAHMP_INIT.inc</A>"<A NAME="HALO_EM_HYDRO_NOAHMP_INIT.inc_3"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1064'>
endif<a name='1065'>
#endif<a name='1066'>
<a name='1067'>
    IF ( ( grid%dfi_opt .EQ. DFI_NODFI ) .or. &amp;<a name='1068'>
          ( ( grid%dfi_stage .NE. DFI_BCK ) .and. &amp;<a name='1069'>
          ( grid%dfi_stage .NE. DFI_STARTBCK ) ) ) THEN<a name='1070'>
<a name='1071'>
   DO ij = 1, grid%num_tiles<a name='1072'>
<a name='1073'>
     CALL <A href='../../html_code/phys/module_physics_init.F.html#PHY_INIT'>phy_init</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHY_INIT_1"> (  grid%id , config_flags, grid%DT, grid%RESTART, grid%znw, grid%znu,   &amp;<a name='1074'>
                      grid%p_top, grid%tsk, grid%RADT,grid%BLDT,grid%CUDT, MPDT, &amp;<a name='1075'>
                      grid%rucuten, grid%rvcuten, grid%rthcuten,             &amp;<a name='1076'>
                      grid%rqvcuten, grid%rqrcuten, grid%rqccuten,           &amp;<a name='1077'>
                      grid%rqscuten, grid%rqicuten,                          &amp;<a name='1078'>
                      grid%rushten, grid%rvshten, grid%rthshten,             &amp;<a name='1079'>
                      grid%rqvshten, grid%rqrshten, grid%rqcshten,           &amp;<a name='1080'>
                      grid%rqsshten, grid%rqishten, grid%rqgshten,           &amp;<a name='1081'>
                      grid%rublten,grid%rvblten,grid%rthblten,               &amp;<a name='1082'>
                      grid%rqvblten,grid%rqcblten,grid%rqiblten,             &amp;<a name='1083'>
                      grid%rthraten,grid%rthratenlw,grid%rthratensw,         &amp;<a name='1084'>
                      <font color=#447700>!BSINGH - For WRFCuP scheme(11/12/2013)<a name='1085'></font>
                      grid%cupflag,grid%cldfra_cup,grid%cldfratend_cup,      &amp; <font color=#447700>!wig, 18-Sep-2006<a name='1086'></font>
                      grid%shall,                                            &amp; <font color=#447700>!wig, 18-Sep-2006<a name='1087'></font>
                      grid%tcloud_cup,                                       &amp; <font color=#447700>!rce, 18-apr-2012<a name='1088'></font>
                      <font color=#447700>!BSINGH - ENDS<a name='1089'></font>
                      grid%stepbl,grid%stepra,grid%stepcu,                   &amp;<a name='1090'>
                      grid%w0avg, grid%rainnc, grid%rainc, grid%raincv, grid%rainncv,  &amp;<a name='1091'>
                      grid%snownc, grid%snowncv, grid%graupelnc, grid%graupelncv,  &amp;<a name='1092'>
                      z_at_q, grid%qnwfa2d, scalar(ims,kms,jms,1), num_scalar,         &amp; <font color=#447700>! G. Thompson<a name='1093'></font>
                      grid%re_cloud, grid%re_ice, grid%re_snow,         &amp; <font color=#447700>! G. Thompson<a name='1094'></font>
                      grid%has_reqc, grid%has_reqi, grid%has_reqs,      &amp; <font color=#447700>! G. Thompson<a name='1095'></font>
                      grid%nca,grid%swrad_scat,                    &amp;<a name='1096'>
                      grid%cldefi,grid%lowlyr,                          &amp;<a name='1097'>
                      grid%mass_flux,                              &amp;<a name='1098'>
                      grid%rthften, grid%rqvften,                       &amp;<a name='1099'>
                      grid%cldfra,                                      &amp;<a name='1100'>
#if (WRF_CHEM == 1)<a name='1101'>
                      grid%cldfra_old,                                  &amp;<a name='1102'>
#else<a name='1103'>
                      cldfra_old,                                  &amp;<a name='1104'>
#endif<a name='1105'>
                      grid%glw,grid%gsw,grid%emiss,grid%embck,            &amp;<a name='1106'>
                      grid%lu_index,                                      &amp;<a name='1107'>
                      grid%landuse_ISICE, grid%landuse_LUCATS,            &amp;<a name='1108'>
                      grid%landuse_LUSEAS, grid%landuse_ISN,              &amp;<a name='1109'>
                      grid%lu_state,                                      &amp;<a name='1110'>
                      grid%xlat,grid%xlong,grid%xlong_u,grid%xlat_v,grid%albedo,grid%albbck,grid%GMT,grid%JULYR,grid%JULDAY,     &amp;<a name='1111'>
                      grid%levsiz, num_ozmixm, num_aerosolc, grid%paerlev,  &amp;<a name='1112'>
                      grid%alevsiz, grid%no_src_types,                      &amp;<a name='1113'>
                      grid%tmn,grid%xland,grid%znt,grid%z0,grid%ust,grid%mol,grid%pblh,grid%tke_pbl,    &amp;<a name='1114'>
                      grid%exch_h,grid%thc,grid%snowc,grid%mavail,grid%hfx,grid%qfx,grid%rainbl, &amp;<a name='1115'>
                      grid%tslb,grid%zs,grid%dzs,config_flags%num_soil_layers,grid%warm_rain,  &amp;<a name='1116'>
                      grid%adv_moist_cond, grid%is_CAMMGMP_used,                               &amp;<a name='1117'>
                      grid%apr_gr,grid%apr_w,grid%apr_mc,grid%apr_st,grid%apr_as,      &amp;<a name='1118'>
                      grid%apr_capma,grid%apr_capme,grid%apr_capmi,          &amp;<a name='1119'>
                      grid%xice,grid%xicem,grid%vegfra,grid%snow,grid%canwat,grid%smstav,         &amp;<a name='1120'>
                      grid%smstot, grid%sfcrunoff,grid%udrunoff,grid%grdflx,grid%acsnow,      &amp;<a name='1121'>
                      grid%acsnom,grid%ivgtyp,grid%isltyp, grid%sfcevp,grid%smois,     &amp;<a name='1122'>
                      grid%sh2o, grid%snowh, grid%smfr3d,                    &amp;<a name='1123'>
                      grid%snoalb,                 &amp;<a name='1124'>
                      grid%DX,grid%DY,grid%f_ice_phy,grid%f_rain_phy,grid%f_rimef_phy, &amp;<a name='1125'>
                      grid%mp_restart_state,grid%tbpvs_state,grid%tbpvs0_state,&amp;<a name='1126'>
                      allowed_to_read, grid%moved, start_of_simulation,               &amp;<a name='1127'>
                      grid%LAGDAY, &amp;<a name='1128'>
                      ids, ide, jds, jde, kds, kde,           &amp;<a name='1129'>
                      ims, ime, jms, jme, kms, kme,           &amp;<a name='1130'>
                      grid%i_start(ij), grid%i_end(ij), grid%j_start(ij), grid%j_end(ij), kts, kte, &amp;<a name='1131'>
                      config_flags%num_urban_layers,                        &amp; <font color=#447700>!multi-layer urban<a name='1132'></font>
                      config_flags%num_urban_hi,                            &amp; <font color=#447700>!multi-layer urban<a name='1133'></font>
                      grid%raincv_a,grid%raincv_b,                                    &amp;<a name='1134'>
                      grid%gd_cloud, grid%gd_cloud2,                                  &amp; <font color=#447700>! Optional<a name='1135'></font>
                      grid%gd_cloud_a, grid%gd_cloud2_a,                              &amp; <font color=#447700>! Optional<a name='1136'></font>
                      grid%QC_CU, grid%QI_CU,                                         &amp; <font color=#447700>! Optional<a name='1137'></font>
                      ozmixm,grid%pin,                             &amp;     <font color=#447700>! Optional<a name='1138'></font>
                      grid%aerodm,grid%pina,                       &amp;     <font color=#447700>! Optional<a name='1139'></font>
                      grid%m_ps_1,grid%m_ps_2,grid%m_hybi,aerosolc_1,aerosolc_2,&amp;  <font color=#447700>! Optional<a name='1140'></font>
                      grid%rundgdten,grid%rvndgdten,grid%rthndgdten,         &amp;     <font color=#447700>! Optional<a name='1141'></font>
                      grid%rphndgdten,grid%rqvndgdten,grid%rmundgdten,       &amp;     <font color=#447700>! Optional<a name='1142'></font>
                      grid%SDA_HFX, grid%SDA_QFX, grid%QNORM, grid%HFX_BOTH,grid%QFX_BOTH,      &amp;   <font color=#447700>! fasdas<a name='1143'></font>
                      grid%HFX_FDDA,                                                            &amp;   <font color=#447700>! fasdas<a name='1144'></font>
                      grid%FGDT,grid%stepfg,                        &amp;     <font color=#447700>! Optional<a name='1145'></font>
                      grid%cugd_tten,grid%cugd_ttens,grid%cugd_qvten,        &amp;   <font color=#447700>! Optional<a name='1146'></font>
                      grid%cugd_qvtens,grid%cugd_qcten,                 &amp;   <font color=#447700>! Optional<a name='1147'></font>
                      grid%ISNOWXY, grid%ZSNSOXY, grid%TSNOXY,                                  &amp;   <font color=#447700>! Optional Noah-MP<a name='1148'></font>
                      grid%SNICEXY, grid%SNLIQXY, grid%TVXY, grid%TGXY, grid%CANICEXY,          &amp;   <font color=#447700>! Optional Noah-MP<a name='1149'></font>
                      grid%CANLIQXY, grid%EAHXY, grid%TAHXY, grid%CMXY,                         &amp;   <font color=#447700>! Optional Noah-MP<a name='1150'></font>
                      grid%CHXY, grid%FWETXY, grid%SNEQVOXY, grid%ALBOLDXY, grid%QSNOWXY,       &amp;   <font color=#447700>! Optional Noah-MP<a name='1151'></font>
                      grid%WSLAKEXY, grid%ZWTXY, grid%WAXY, grid%WTXY, grid%LFMASSXY, grid%RTMASSXY, &amp; <font color=#447700>! Optional Noah-MP<a name='1152'></font>
                      grid%STMASSXY, grid%WOODXY, grid%STBLCPXY, grid%FASTCPXY,                 &amp;   <font color=#447700>! Optional Noah-MP<a name='1153'></font>
                      grid%GRAINXY, grid%GDDXY,                                                 &amp;   <font color=#447700>! Optional Noah-MP<a name='1154'></font>
                      grid%CROPTYPE, grid%CROPCAT,                                                 &amp;   <font color=#447700>! Optional Noah-MP<a name='1155'></font>
                      grid%XSAIXY,grid%LAI,                                                     &amp;   <font color=#447700>! Optional Noah-MP<a name='1156'></font>
                      grid%T2MVXY, grid%T2MBXY, grid%CHSTARXY,                                  &amp;   <font color=#447700>! Optional Noah-MP<a name='1157'></font>
                      grid%SMOISEQ  ,grid%SMCWTDXY ,grid%RECHXY, grid%DEEPRECHXY, grid%AREAXY,  &amp; <font color=#447700>! Optional Noah-MP<a name='1158'></font>
                      config_flags%wtddt ,grid%stepwtd ,grid%QRFSXY ,grid%QSPRINGSXY ,grid%QSLATXY, &amp; <font color=#447700>! Optional Noah-MP<a name='1159'></font>
                      grid%FDEPTHXY, grid%RIVERBEDXY, grid%EQZWT, grid%RIVERCONDXY, grid%PEXPXY, &amp; <font color=#447700>! Optional Noah-MP<a name='1160'></font>
                      grid%rechclim  ,                                                           &amp; <font color=#447700>! Optional Noah-MP<a name='1161'></font>
                      grid%msftx, grid%msfty,                              &amp;<a name='1162'>
                      grid%DZR, grid%DZB, grid%DZG,                          &amp; <font color=#447700>!Optional urban<a name='1163'></font>
                      grid%TR_URB2D,grid%TB_URB2D,grid%TG_URB2D,grid%TC_URB2D,    &amp; <font color=#447700>!Optional urban<a name='1164'></font>
                      grid%QC_URB2D, grid%XXXR_URB2D,grid%XXXB_URB2D,        &amp; <font color=#447700>!Optional urban<a name='1165'></font>
                      grid%XXXG_URB2D, grid%XXXC_URB2D,                 &amp; <font color=#447700>!Optional urban<a name='1166'></font>
                      grid%TRL_URB3D, grid%TBL_URB3D, grid%TGL_URB3D,        &amp; <font color=#447700>!Optional urban<a name='1167'></font>
                      grid%SH_URB2D, grid%LH_URB2D, grid%G_URB2D, grid%RN_URB2D,  &amp; <font color=#447700>!Optional urban<a name='1168'></font>
                      grid%TS_URB2D, grid%FRC_URB2D, grid%UTYPE_URB2D,      &amp; <font color=#447700>!Optional urban<a name='1169'></font>
                      grid%CMCR_URB2D,grid%TGR_URB2D,grid%TGRL_URB3D,grid%SMR_URB3D, &amp; <font color=#447700>!Optional urban   <a name='1170'></font>
                      grid%DRELR_URB2D,grid%DRELB_URB2D,grid%DRELG_URB2D,    &amp; <font color=#447700>!Optional urban<a name='1171'></font>
                      grid%FLXHUMR_URB2D,grid%FLXHUMB_URB2D,grid%FLXHUMG_URB2D,   &amp; <font color=#447700>!Optional urban<a name='1172'></font>
                      grid%TRB_URB4D,grid%TW1_URB4D,grid%TW2_URB4D,grid%TGB_URB4D,grid%TLEV_URB3D,  &amp; <font color=#447700>!multi-layer urban<a name='1173'></font>
                      grid%QLEV_URB3D,grid%TW1LEV_URB3D,grid%TW2LEV_URB3D,        &amp; <font color=#447700>!multi-layer urban<a name='1174'></font>
                      grid%TGLEV_URB3D,grid%TFLEV_URB3D,grid%SF_AC_URB3D,         &amp; <font color=#447700>!multi-layer urban <a name='1175'></font>
                      grid%LF_AC_URB3D,grid%CM_AC_URB3D,grid%SFVENT_URB3D,grid%LFVENT_URB3D,   &amp; <font color=#447700>!multi-layer urban<a name='1176'></font>
                      grid%SFWIN1_URB3D,grid%SFWIN2_URB3D, &amp; <font color=#447700>!multi-layer urban<a name='1177'></font>
                      grid%SFW1_URB3D,grid%SFW2_URB3D,grid%SFR_URB3D,grid%SFG_URB3D,     &amp; <font color=#447700>!multi-layer urban<a name='1178'></font>
                      grid%LP_URB2D,grid%HI_URB2D,grid%LB_URB2D,grid%HGT_URB2D,        &amp; <font color=#447700>!multi-layer urban<a name='1179'></font>
                      grid%MH_URB2D,grid%STDH_URB2D,grid%LF_URB2D,                     &amp; <font color=#447700>!SLUCM<a name='1180'></font>
                      grid%A_U_BEP,grid%A_V_BEP,grid%A_T_BEP,grid%A_Q_BEP,             &amp; <font color=#447700>!multi-layer urban<a name='1181'></font>
                      grid%A_E_BEP,grid%B_U_BEP,grid%B_V_BEP,grid%B_T_BEP,             &amp; <font color=#447700>!multi-layer urban<a name='1182'></font>
                      grid%B_Q_BEP,grid%B_E_BEP,grid%DLG_BEP,                          &amp; <font color=#447700>!multi-layer urban<a name='1183'></font>
                      grid%DL_U_BEP,grid%SF_BEP,grid%VL_BEP,                           &amp; <font color=#447700>!multi-layer urban<a name='1184'></font>
                      grid%TML,grid%T0ML,grid%HML,grid%H0ML,grid%HUML,grid%HVML,grid%TMOML,     &amp; <font color=#447700>!Optional oml<a name='1185'></font>
                      grid%lakedepth2d,  grid%savedtke12d,  grid%snowdp2d,   grid%h2osno2d,       &amp; <font color=#447700>!lake<a name='1186'></font>
                      grid%snl2d,        grid%t_grnd2d,     grid%t_lake3d,   grid%lake_icefrac3d, &amp; <font color=#447700>!lake<a name='1187'></font>
                      grid%z_lake3d,     grid%dz_lake3d,    grid%t_soisno3d, grid%h2osoi_ice3d,   &amp; <font color=#447700>!lake<a name='1188'></font>
                      grid%h2osoi_liq3d, grid%h2osoi_vol3d, grid%z3d,        grid%dz3d,           &amp; <font color=#447700>!lake<a name='1189'></font>
                      grid%zi3d,         grid%watsat3d,     grid%csol3d,     grid%tkmg3d,         &amp; <font color=#447700>!lake<a name='1190'></font>
                      grid%tkdry3d,      grid%tksatu3d,     grid%lake2d,                            &amp; <font color=#447700>!lake<a name='1191'></font>
                      config_flags%lakedepth_default,        config_flags%lake_min_elev, grid%lake_depth,     &amp; <font color=#447700>!lake<a name='1192'></font>
                      grid%lakemask,        grid%lakeflag,  grid%LAKE_DEPTH_FLAG, grid%use_lakedepth,     &amp; <font color=#447700>!lake<a name='1193'></font>
                      config_flags%sf_surface_mosaic, config_flags%mosaic_cat, config_flags%num_land_cat, &amp; <font color=#447700>! Noah tiling<a name='1194'></font>
                      config_flags%maxpatch,           &amp;   <font color=#447700>! start of CLM variables<a name='1195'></font>
              grid%numc,grid%nump,grid%snl,grid%snowdp,&amp;   <font color=#447700>!<a name='1196'></font>
              grid%wtc,grid%wtp,&amp;<a name='1197'>
              grid%h2osno,grid%t_grnd,grid%t_veg,grid%h2ocan, &amp;<a name='1198'>
              grid%h2ocan_col,grid%t2m_max,grid%t2m_min,&amp;<a name='1199'>
              grid%t_ref2m,&amp;<a name='1200'>
              grid%h2osoi_liq_s1,&amp;<a name='1201'>
              grid%h2osoi_liq_s2,grid%h2osoi_liq_s3,&amp;<a name='1202'>
              grid%h2osoi_liq_s4, &amp;<a name='1203'>
              grid%h2osoi_liq_s5, &amp;<a name='1204'>
              grid%h2osoi_liq1,grid%h2osoi_liq2,&amp;<a name='1205'>
              grid%h2osoi_liq3,grid%h2osoi_liq4,&amp;<a name='1206'>
              grid%h2osoi_liq5,grid%h2osoi_liq6, &amp;<a name='1207'>
              grid%h2osoi_liq7,grid%h2osoi_liq8,&amp;<a name='1208'>
              grid%h2osoi_liq9,   &amp;<a name='1209'>
              grid%h2osoi_liq10, &amp;<a name='1210'>
              grid%h2osoi_ice_s1,grid%h2osoi_ice_s2,&amp;<a name='1211'>
              grid%h2osoi_ice_s3, &amp;<a name='1212'>
              grid%h2osoi_ice_s4, &amp;<a name='1213'>
              grid%h2osoi_ice_s5, &amp;<a name='1214'>
              grid%h2osoi_ice1,&amp;<a name='1215'>
              grid%h2osoi_ice2,&amp;<a name='1216'>
              grid%h2osoi_ice3,grid%h2osoi_ice4,&amp;<a name='1217'>
              grid%h2osoi_ice5, &amp;<a name='1218'>
              grid%h2osoi_ice6, &amp;<a name='1219'>
              grid%h2osoi_ice7,grid%h2osoi_ice8,&amp;<a name='1220'>
              grid%h2osoi_ice9,grid%h2osoi_ice10,&amp;<a name='1221'>
              grid%t_soisno_s1,grid%t_soisno_s2, &amp;<a name='1222'>
              grid%t_soisno_s3,grid%t_soisno_s4, &amp;<a name='1223'>
              grid%t_soisno_s5,grid%t_soisno1,&amp;<a name='1224'>
              grid%t_soisno2,grid%t_soisno3,&amp;<a name='1225'>
              grid%t_soisno4,grid%t_soisno5, &amp;<a name='1226'>
              grid%t_soisno6,grid%t_soisno7,&amp;<a name='1227'>
              grid%t_soisno8,grid%t_soisno9,&amp;<a name='1228'>
              grid%t_soisno10,grid%dzsnow1,grid%dzsnow2,grid%dzsnow3,grid%dzsnow4,&amp;<a name='1229'>
              grid%dzsnow5,grid%snowrds1,grid%snowrds2,grid%snowrds3,grid%snowrds4,grid%snowrds5, &amp;<a name='1230'>
              grid%t_lake1,grid%t_lake2,&amp;<a name='1231'>
              grid%t_lake3,grid%t_lake4, &amp;<a name='1232'>
              grid%t_lake5,grid%t_lake6, &amp;<a name='1233'>
              grid%t_lake7,grid%t_lake8, &amp;<a name='1234'>
              grid%t_lake9,grid%t_lake10,&amp;<a name='1235'>
              grid%h2osoi_vol1,grid%h2osoi_vol2, &amp;<a name='1236'>
              grid%h2osoi_vol3,grid%h2osoi_vol4, &amp;<a name='1237'>
              grid%h2osoi_vol5,&amp;<a name='1238'>
              grid%h2osoi_vol6,&amp;<a name='1239'>
              grid%h2osoi_vol7,grid%h2osoi_vol8,&amp;<a name='1240'>
              grid%h2osoi_vol9,grid%h2osoi_vol10,&amp;<a name='1241'>
              grid%ht,                          &amp;<a name='1242'>
              grid%ALBEDOsubgrid,grid%LHsubgrid,&amp;<a name='1243'>
              grid%HFXsubgrid,grid%LWUPsubgrid,&amp;<a name='1244'>
              grid%Q2subgrid,grid%SABVsubgrid,  &amp;<a name='1245'>
              grid%SABGsubgrid,grid%NRAsubgrid,&amp;<a name='1246'>
              grid%SWUPsubgrid,grid%lhsoi, &amp;<a name='1247'>
              grid%lhveg, grid%lhtran, &amp; <font color=#447700>!end of CLM variables<a name='1248'></font>
                      grid%TSK_SAVE,                        &amp; <font color=#447700>!Optional fractional seaice<a name='1249'></font>
                      grid%itimestep, grid%fdob,            &amp;<a name='1250'>
                      t00, p00, a,                      &amp; <font color=#447700>! for obs_nudge base state<a name='1251'></font>
                      grid%TYR, grid%TYRA, grid%TDLY, grid%TLAG, grid%NYEAR, grid%NDAY,grid%tmn_update, &amp;<a name='1252'>
                      grid%achfx, grid%aclhf, grid%acgrdflx,                  &amp;<a name='1253'>
                      config_flags%nssl_cccn,                                 &amp;<a name='1254'>
                      config_flags%nssl_alphah, config_flags%nssl_alphahl,    &amp;<a name='1255'>
                      config_flags%nssl_cnoh, config_flags%nssl_cnohl,        &amp;<a name='1256'>
                      config_flags%nssl_cnor, config_flags%nssl_cnos,         &amp;<a name='1257'>
                      config_flags%nssl_rho_qh, config_flags%nssl_rho_qhl,    &amp;<a name='1258'>
                      config_flags%nssl_rho_qs,                               &amp;<a name='1259'>
                      config_flags%nssl_ipelec,                               &amp;<a name='1260'>
                      config_flags%nssl_isaund                               &amp; <a name='1261'>
                      ,grid%RQCNCUTEN, grid%RQINCUTEN,grid%rliq             &amp;      <font color=#447700>!mchen add for cammpmg<a name='1262'></font>
                      ,grid%cldfra_dp,grid%cldfra_sh                        &amp; <font color=#447700>! ckay for subgrid cloud<a name='1263'></font>
                      ,grid%te_temf,grid%cf3d_temf,grid%wm_temf        &amp; <font color=#447700>! WA<a name='1264'></font>
                      ,grid%massflux_EDKF, grid%entr_EDKF, grid%detr_EDKF                &amp; <a name='1265'>
                      ,grid%thl_up,grid%thv_up,grid%rt_up                                &amp;<a name='1266'>
                      ,grid%rv_up,grid%rc_up,grid%u_up,grid%v_up,grid%frac_up            &amp;<a name='1267'>
                      ,grid%ccn_conc                                          &amp; <font color=#447700>! RAS<a name='1268'></font>
                      ,grid%QKE                                               &amp;<font color=#447700>!JOE-for mynn<a name='1269'></font>
                      ,grid%landusef,grid%landusef2,grid%mosaic_cat_index                            &amp; <font color=#447700>! danli mosaic <a name='1270'></font>
                      ,grid%TSK_mosaic,grid%TSLB_mosaic,grid%SMOIS_mosaic,grid%SH2O_mosaic           &amp; <font color=#447700>! danli mosaic<a name='1271'></font>
                      ,grid%CANWAT_mosaic,grid%SNOW_mosaic,grid%SNOWH_mosaic,grid%SNOWC_mosaic       &amp; <font color=#447700>! danli mosaic<a name='1272'></font>
                      ,grid%ALBEDO_mosaic,grid%ALBBCK_mosaic, grid%EMISS_mosaic                      &amp; <font color=#447700>! danli mosaic<a name='1273'></font>
                      ,grid%EMBCK_mosaic, grid%ZNT_mosaic, grid%Z0_mosaic                            &amp; <font color=#447700>! danli mosaic<a name='1274'></font>
                      ,grid%TR_URB2D_mosaic,grid%TB_URB2D_mosaic                                     &amp; <font color=#447700>! danli mosaic <a name='1275'></font>
                      ,grid%TG_URB2D_mosaic,grid%TC_URB2D_mosaic                                     &amp; <font color=#447700>! danli mosaic <a name='1276'></font>
                      ,grid%QC_URB2D_mosaic                                                          &amp; <font color=#447700>! danli mosaic<a name='1277'></font>
                      ,grid%TRL_URB3D_mosaic,grid%TBL_URB3D_mosaic                                   &amp; <font color=#447700>! danli mosaic <a name='1278'></font>
                      ,grid%TGL_URB3D_mosaic                                                         &amp; <font color=#447700>! danli mosaic <a name='1279'></font>
                      ,grid%SH_URB2D_mosaic,grid%LH_URB2D_mosaic                                     &amp; <font color=#447700>! danli mosaic <a name='1280'></font>
                      ,grid%G_URB2D_mosaic,grid%RN_URB2D_mosaic                                      &amp; <font color=#447700>! danli mosaic <a name='1281'></font>
                      ,grid%TS_URB2D_mosaic                                                          &amp; <font color=#447700>! danli mosaic <a name='1282'></font>
                      ,grid%TS_RUL2D_mosaic                                                          &amp; <font color=#447700>! danli mosaic<a name='1283'></font>
                      )<a name='1284'>
       ENDDO <font color=#447700>! loop of tiles for phy_init<a name='1285'></font>
    ENDIF   <font color=#447700>! no phy_init for the backwards part of the DFI<a name='1286'></font>
<a name='1287'>
   CALL wrf_debug ( 100 , 'start_domain_em: After call to phy_init' )<a name='1288'>
<a name='1289'>
   IF (config_flags%do_avgflx_em .EQ. 1) THEN<a name='1290'>
      WRITE ( message , FMT = '("start_em: initializing avgflx on domain ",I3)' ) &amp;<a name='1291'>
           &amp; grid%id<a name='1292'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_53">(trim(message)) <a name='1293'>
      grid%avgflx_count = 0<a name='1294'>
      f_flux = config_flags%do_avgflx_cugd .EQ. 1  <font color=#447700>! WA 9/24/10<a name='1295'></font>
      DO ij = 1, grid%num_tiles<a name='1296'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_41">(200,'In start_em, before zero_avgflx call')<a name='1297'>
         if (.not. grid%restart) call <A href='../../html_code/dyn_em/module_avgflx_em.F.html#ZERO_AVGFLX'>zero_avgflx</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_AVGFLX_2">(grid%avgflx_rum,grid%avgflx_rvm,grid%avgflx_wwm, &amp;<a name='1298'>
              &amp;   ids, ide, jds, jde, kds, kde,           &amp;<a name='1299'>
              &amp;   ims, ime, jms, jme, kms, kme,           &amp;<a name='1300'>
              &amp;   grid%i_start(ij), grid%i_end(ij), grid%j_start(ij), grid%j_end(ij), kts, kte, f_flux, &amp;<a name='1301'>
              &amp;   grid%avgflx_cfu1,grid%avgflx_cfd1,grid%avgflx_dfu1, &amp;<a name='1302'>
              &amp;   grid%avgflx_efu1,grid%avgflx_dfd1,grid%avgflx_efd1 )<a name='1303'>
         call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_42">(200,'In start_em, after zero_avgflx call')<a name='1304'>
      ENDDO<a name='1305'>
   ENDIF<a name='1306'>
<a name='1307'>
#ifdef MCELIO<a name='1308'>
   grid%LU_MASK = 0.<a name='1309'>
   WHERE ( grid%lu_index .EQ. 16 ) grid%LU_MASK = 1.<a name='1310'>
#endif<a name='1311'>
<a name='1312'>
   call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_43">(100,'start_em: calling lightning_init')<a name='1313'>
   CALL <A href='../../html_code/phys/module_lightning_driver.F.html#LIGHTNING_INIT'>lightning_init</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LIGHTNING_INIT_1"> ( itimestep=grid%itimestep, restart=grid%restart, dt=grid%dt, dx=grid%dx   &amp;<a name='1314'>
                    <font color=#447700>! Namelist control options<a name='1315'></font>
                        ,cu_physics=config_flags%cu_physics,mp_physics=config_flags%mp_physics    &amp;<a name='1316'>
                        ,do_radar_ref=config_flags%do_radar_ref                                   &amp;<a name='1317'>
                        ,lightning_option=config_flags%lightning_option                           &amp;<a name='1318'>
                        ,lightning_dt=config_flags%lightning_dt                                   &amp;<a name='1319'>
                        ,lightning_start_seconds=config_flags%lightning_start_seconds             &amp;<a name='1320'>
                        ,iccg_prescribed_num=config_flags%iccg_prescribed_num                     &amp;<a name='1321'>
                        ,iccg_prescribed_den=config_flags%iccg_prescribed_den                     &amp;<a name='1322'>
                        ,cellcount_method=config_flags%cellcount_method                           &amp;<a name='1323'>
                    <font color=#447700>! Order dependent args for domain, mem, and tile dims<a name='1324'></font>
                        ,ids=ids, ide=ide, jds=jds, jde=jde, kds=kds, kde=kde             &amp;<a name='1325'>
                        ,ims=ims, ime=ime, jms=jms, jme=jme, kms=kms, kme=kme             &amp;<a name='1326'>
                        ,its=its, ite=ite, jts=jts, jte=jte, kts=kts, kte=kte             &amp;<a name='1327'>
                    <font color=#447700>! IC and CG flash rates and accumulated flash count<a name='1328'></font>
                        ,ic_flashcount=grid%ic_flashcount, ic_flashrate=grid%ic_flashrate        &amp;<a name='1329'>
                        ,cg_flashcount=grid%cg_flashcount, cg_flashrate=grid%cg_flashrate        &amp;<a name='1330'>
#if (WRF_CHEM == 1)<a name='1331'>
                        ,lnox_opt=config_flags%lnox_opt           &amp;<a name='1332'>
                        ,lnox_passive=config_flags%lnox_passive   &amp;<a name='1333'>
                        ,lnox_total=tracer(:,:,:,p_lnox_total)    &amp;<a name='1334'>
                        ,lnox_ic=tracer(:,:,:,p_lnox_ic)          &amp;<a name='1335'>
                        ,lnox_cg=tracer(:,:,:,p_lnox_cg)          &amp;<a name='1336'>
#endif<a name='1337'>
                    )<a name='1338'>
<a name='1339'>
    call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_44">(100,'start_em: after calling lightning_init')<a name='1340'>
<a name='1341'>
   END IF <font color=#447700>! restart<a name='1342'></font>
<a name='1343'>
#if 0<a name='1344'>
#include "<A href='../../html_code/include/CYCLE_TEST.inc.html'>CYCLE_TEST.inc</A>"<A NAME="CYCLE_TEST.inc_4"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1345'>
#endif<a name='1346'>
<a name='1347'>
<font color=#447700>!<a name='1348'></font>
<font color=#447700>!<a name='1349'></font>
<a name='1350'>
 <font color=#447700>!  set physical boundary conditions for all initialized variables<a name='1351'></font>
<a name='1352'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1353'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1354'></font>
<font color=#447700>!  Note:  the size of this halo exchange reflects the<a name='1355'></font>
<font color=#447700>!         fact that we are carrying the uncoupled variables<a name='1356'></font>
<font color=#447700>!         as state variables in the mass coordinate model, as<a name='1357'></font>
<font color=#447700>!         opposed to the coupled variables as in the height<a name='1358'></font>
<font color=#447700>!         coordinate model.<a name='1359'></font>
<font color=#447700>!<a name='1360'></font>
<font color=#447700>!                           * * * * *<a name='1361'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='1362'></font>
<font color=#447700>!       * + *      * + *    * * + * *<a name='1363'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='1364'></font>
<font color=#447700>!                           * * * * *<a name='1365'></font>
<font color=#447700>!<a name='1366'></font>
<font color=#447700>!j  grid%u_1                          x<a name='1367'></font>
<font color=#447700>!j  grid%u_2                          x<a name='1368'></font>
<font color=#447700>!j  grid%v_1                          x<a name='1369'></font>
<font color=#447700>!j  grid%v_2                          x<a name='1370'></font>
<font color=#447700>!j  grid%w_1                          x<a name='1371'></font>
<font color=#447700>!j  grid%w_2                          x<a name='1372'></font>
<font color=#447700>!j  grid%t_1                          x<a name='1373'></font>
<font color=#447700>!j  grid%t_2                          x<a name='1374'></font>
<font color=#447700>!j grid%ph_1                          x<a name='1375'></font>
<font color=#447700>!j grid%ph_2                          x<a name='1376'></font>
<font color=#447700>!<a name='1377'></font>
<font color=#447700>!j  grid%t_init                       x<a name='1378'></font>
<font color=#447700>!<a name='1379'></font>
<font color=#447700>!j  grid%phb   x<a name='1380'></font>
<font color=#447700>!j  grid%ph0   x<a name='1381'></font>
<font color=#447700>!j  grid%php   x<a name='1382'></font>
<font color=#447700>!j   grid%pb   x<a name='1383'></font>
<font color=#447700>!j   grid%al   x<a name='1384'></font>
<font color=#447700>!j  grid%alt   x<a name='1385'></font>
<font color=#447700>!j  grid%alb   x<a name='1386'></font>
<font color=#447700>!<a name='1387'></font>
<font color=#447700>!  the following are 2D (xy) variables<a name='1388'></font>
<font color=#447700>!<a name='1389'></font>
<font color=#447700>!j grid%mu_1                          x<a name='1390'></font>
<font color=#447700>!j grid%mu_2                          x<a name='1391'></font>
<font color=#447700>!j grid%mub   x<a name='1392'></font>
<font color=#447700>!j grid%mu0   x<a name='1393'></font>
<font color=#447700>!j grid%ht    x<a name='1394'></font>
<font color=#447700>!j grid%msftx x<a name='1395'></font>
<font color=#447700>!j grid%msfty x<a name='1396'></font>
<font color=#447700>!j grid%msfux x<a name='1397'></font>
<font color=#447700>!j grid%msfuy x<a name='1398'></font>
<font color=#447700>!j grid%msfvx x<a name='1399'></font>
<font color=#447700>!j grid%msfvy x<a name='1400'></font>
<font color=#447700>!j grid%sina  x<a name='1401'></font>
<font color=#447700>!j grid%cosa  x<a name='1402'></font>
<font color=#447700>!j grid%e     x<a name='1403'></font>
<font color=#447700>!j grid%f     x<a name='1404'></font>
<font color=#447700>!<a name='1405'></font>
<font color=#447700>!  4D variables<a name='1406'></font>
<font color=#447700>!<a name='1407'></font>
<font color=#447700>! moist                        x<a name='1408'></font>
<font color=#447700>!  chem                        x<a name='1409'></font>
<font color=#447700>!scalar                        x<a name='1410'></font>
<a name='1411'>
<font color=#447700>!--------------------------------------------------------------<a name='1412'></font>
<a name='1413'>
#ifdef DM_PARALLEL<a name='1414'>
#  include "<A href='../../html_code/include/HALO_EM_INIT_1.inc.html'>HALO_EM_INIT_1.inc</A>"<A NAME="HALO_EM_INIT_1.inc_5"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1415'>
#  include "<A href='../../html_code/include/HALO_EM_INIT_2.inc.html'>HALO_EM_INIT_2.inc</A>"<A NAME="HALO_EM_INIT_2.inc_6"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1416'>
#  include "<A href='../../html_code/include/HALO_EM_INIT_3.inc.html'>HALO_EM_INIT_3.inc</A>"<A NAME="HALO_EM_INIT_3.inc_7"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1417'>
#  include "<A href='../../html_code/include/HALO_EM_INIT_4.inc.html'>HALO_EM_INIT_4.inc</A>"<A NAME="HALO_EM_INIT_4.inc_8"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1418'>
#  include "<A href='../../html_code/include/HALO_EM_INIT_5.inc.html'>HALO_EM_INIT_5.inc</A>"<A NAME="HALO_EM_INIT_5.inc_9"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1419'>
      IF ( config_flags%sf_ocean_physics .EQ. PWP3DSCHEME ) THEN<a name='1420'>
#  include "<A href='../../html_code/include/HALO_EM_INIT_6.inc.html'>HALO_EM_INIT_6.inc</A>"<A NAME="HALO_EM_INIT_6.inc_10"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1421'>
      END IF<a name='1422'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_INIT.inc.html'>PERIOD_BDY_EM_INIT.inc</A>"<A NAME="PERIOD_BDY_EM_INIT.inc_11"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1423'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST.inc.html'>PERIOD_BDY_EM_MOIST.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST.inc_12"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1424'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_TKE.inc.html'>PERIOD_BDY_EM_TKE.inc</A>"<A NAME="PERIOD_BDY_EM_TKE.inc_13"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1425'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_SCALAR.inc.html'>PERIOD_BDY_EM_SCALAR.inc</A>"<A NAME="PERIOD_BDY_EM_SCALAR.inc_14"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1426'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM.inc.html'>PERIOD_BDY_EM_CHEM.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM.inc_15"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1427'>
if(config_flags%sf_surface_physics.eq.NOAHMPSCHEME.and.config_flags%opt_run.eq.5)then<a name='1428'>
#  include "<A href='../../html_code/include/HALO_EM_HYDRO_NOAHMP_INIT.inc.html'>HALO_EM_HYDRO_NOAHMP_INIT.inc</A>"<A NAME="HALO_EM_HYDRO_NOAHMP_INIT.inc_16"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1429'>
endif<a name='1430'>
#endif<a name='1431'>
<a name='1432'>
<a name='1433'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_125">( grid%u_1 , 'U' , config_flags ,                  &amp;<a name='1434'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1435'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1436'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1437'>
                         its , ite , jts , jte , kts , kte )<a name='1438'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_126">( grid%u_2 , 'U' , config_flags ,                  &amp;<a name='1439'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1440'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1441'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1442'>
                         its , ite , jts , jte , kts , kte )<a name='1443'>
<a name='1444'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_127">( grid%v_1 , 'V' , config_flags ,                  &amp;<a name='1445'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1446'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1447'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1448'>
                         its , ite , jts , jte , kts , kte )<a name='1449'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_128">( grid%v_2 , 'V' , config_flags ,                  &amp;<a name='1450'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1451'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1452'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1453'>
                         its , ite , jts , jte , kts , kte )<a name='1454'>
<a name='1455'>
<font color=#447700>! set kinematic condition for w<a name='1456'></font>
<a name='1457'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_20">( grid%ht , 'r' , config_flags ,                &amp;<a name='1458'>
                           ids , ide , jds , jde , &amp;<a name='1459'>
                           ims , ime , jms , jme , &amp;<a name='1460'>
                           its , ite , jts , jte , &amp;<a name='1461'>
                           its , ite , jts , jte   )<a name='1462'>
<a name='1463'>
<font color=#447700>! Set the w at the surface.  If this is the start of a forecast, or if this is a cycled run<a name='1464'></font>
<font color=#447700>! and the start of that forecast, we define the w field.  However, if this a restart, then <a name='1465'></font>
<font color=#447700>! we leave w alone.  Initial value is V dot grad(topo) at surface, then smoothly decaying<a name='1466'></font>
<font color=#447700>! above that.<a name='1467'></font>
<a name='1468'>
   IF ( ( start_of_simulation .OR. config_flags%cycling ) .AND. ( .NOT. config_flags%restart ) ) THEN<a name='1469'>
<a name='1470'>
<font color=#447700>! If W already exists (not zero), then we leave it alone.  How to do this?  We find the<a name='1471'></font>
<font color=#447700>! max/min on this node at the surface.  If parallel, we collect the max/min from all procs.<a name='1472'></font>
<font color=#447700>! If the max/min throughout the entire domain at the surface is identically 0, then we say <a name='1473'></font>
<font color=#447700>! that the W field is NOT initialized, and we run the set_w_surface routines for the <a name='1474'></font>
<font color=#447700>! two time levels of W.  If the field is already initialized, we do NOT run those two<a name='1475'></font>
<font color=#447700>! routines.<a name='1476'></font>
<a name='1477'>
      w_max = grid%w_2(its,1,jts)<a name='1478'>
      w_min = grid%w_2(its,1,jts)<a name='1479'>
      DO j = jts, MIN(jte,jde-1)<a name='1480'>
         DO i = its, MIN(ite,ide-1)<a name='1481'>
         w_max = MAX ( w_max , grid%w_2(i,1,j) )<a name='1482'>
         w_min = MIN ( w_min , grid%w_2(i,1,j) )<a name='1483'>
         END DO<a name='1484'>
      END DO<a name='1485'>
#ifdef DM_PARALLEL<a name='1486'>
      w_max = wrf_dm_max_real ( w_max )<a name='1487'>
      w_min = wrf_dm_min_real ( w_min )<a name='1488'>
#endif<a name='1489'>
<a name='1490'>
      IF ( ( ABS(w_max) .LT. 1.E-6 ) .AND. &amp;<a name='1491'>
           ( ABS(w_min) .LT. 1.E-6 ) ) THEN<a name='1492'>
         w_needs_to_be_set = .TRUE.<a name='1493'>
      ELSE<a name='1494'>
         IF ( config_flags%use_input_w ) THEN<a name='1495'>
            w_needs_to_be_set = .FALSE.<a name='1496'>
         ELSE<a name='1497'>
            w_needs_to_be_set = .TRUE.<a name='1498'>
         END IF<a name='1499'>
      END IF<a name='1500'>
<a name='1501'>
      IF ( w_needs_to_be_set ) THEN<a name='1502'>
<a name='1503'>
         <font color=#447700>! setting kinematic condition for w at the surface<a name='1504'></font>
<a name='1505'>
         fill_w_flag = .true.<a name='1506'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SET_W_SURFACE'>set_w_surface</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_W_SURFACE_2">(  config_flags, grid%znw, fill_w_flag,             &amp;<a name='1507'>
                              grid%w_1, grid%ht, grid%u_1, grid%v_1, grid%cf1, &amp;<a name='1508'>
                              grid%cf2, grid%cf3, grid%rdx, grid%rdy, grid%msftx, grid%msfty, &amp;<a name='1509'>
                              ids, ide, jds, jde, kds, kde,                    &amp;<a name='1510'>
                              ims, ime, jms, jme, kms, kme,                    &amp;<a name='1511'>
                              its, ite, jts, jte, kts, kte                     )<a name='1512'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SET_W_SURFACE'>set_w_surface</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_W_SURFACE_3">(  config_flags, grid%znw, fill_w_flag,             &amp;<a name='1513'>
                              grid%w_2, grid%ht, grid%u_2, grid%v_2, grid%cf1, &amp;<a name='1514'>
                              grid%cf2, grid%cf3, grid%rdx, grid%rdy, grid%msftx, grid%msfty, &amp;<a name='1515'>
                              ids, ide, jds, jde, kds, kde,                    &amp;<a name='1516'>
                              ims, ime, jms, jme, kms, kme,                    &amp;<a name='1517'>
                              its, ite, jts, jte, kts, kte                     ) <a name='1518'>
      END IF<a name='1519'>
   END IF<a name='1520'>
<a name='1521'>
   IF ( .NOT. config_flags%restart ) THEN<a name='1522'>
<font color=#447700>! set up slope-radiation constant arrays based on topography<a name='1523'></font>
<font color=#447700>! paj: also computes laplacian for topo_wind<a name='1524'></font>
<font color=#447700>!<a name='1525'></font>
       DO j = jts,min(jte,jde-1)<a name='1526'>
       DO i = its, min(ite,ide-1)<a name='1527'>
          im1 = max(i-1,ids)<a name='1528'>
          ip1 = min(i+1,ide-1)<a name='1529'>
          jm1 = max(j-1,jds)<a name='1530'>
          jp1 = min(j+1,jde-1)<a name='1531'>
          grid%toposlpx(i,j)=(grid%ht(ip1,j)-grid%ht(im1,j))*grid%msftx(i,j)*grid%rdx/(ip1-im1)<a name='1532'>
          grid%toposlpy(i,j)=(grid%ht(i,jp1)-grid%ht(i,jm1))*grid%msfty(i,j)*grid%rdy/(jp1-jm1)<a name='1533'>
          grid%lap_hgt(i,j)=(grid%ht(ip1,j)+grid%ht(im1,j)+grid%ht(i,jp1)+grid%ht(i,jm1)-grid%ht(i,j)*4.)/4.<a name='1534'>
             hx = grid%toposlpx(i,j)<a name='1535'>
             hy = grid%toposlpy(i,j)<a name='1536'>
             pi = 4.*atan(1.)<a name='1537'>
             grid%slope(i,j) = atan((hx**2+hy**2)**.5)<a name='1538'>
             if (grid%slope(i,j).lt.1.e-4) then<a name='1539'>
               grid%slope(i,j) = 0.<a name='1540'>
               grid%slp_azi(i,j) = 0.<a name='1541'>
             else<a name='1542'>
               grid%slp_azi(i,j) = atan2(hx,hy)+pi<a name='1543'>
<a name='1544'>
<font color=#447700>! Rotate slope azimuth to lat-lon grid<a name='1545'></font>
               if (grid%cosa(i,j).ge.0) then<a name='1546'>
                 grid%slp_azi(i,j) = grid%slp_azi(i,j) - asin(grid%sina(i,j))<a name='1547'>
               else<a name='1548'>
                 grid%slp_azi(i,j) = grid%slp_azi(i,j) - (pi - asin(grid%sina(i,j)))<a name='1549'>
               endif<a name='1550'>
             endif<a name='1551'>
       ENDDO<a name='1552'>
       ENDDO<a name='1553'>
<font color=#447700>!<a name='1554'></font>
<font color=#447700>! paj: computes ct and ct2 for topo_wind<a name='1555'></font>
<font color=#447700>!<a name='1556'></font>
       grid%ctopo=1.<a name='1557'>
       grid%ctopo2=1.<a name='1558'>
<font color=#447700>!<a name='1559'></font>
       if (config_flags%topo_wind.eq.1) then<a name='1560'>
         DO j = jts,min(jte,jde-1)<a name='1561'>
         DO i = its, min(ite,ide-1)<a name='1562'>
            if(grid%xland(i,j).lt.1.5)grid%ctopo(i,j)=sqrt(grid%var_sso(i,j))<a name='1563'>
            if (grid%ctopo(i,j).le.2.718) then<a name='1564'>
            grid%ctopo(i,j)=1.<a name='1565'>
            else<a name='1566'>
            grid%ctopo(i,j)=alog(grid%ctopo(i,j))<a name='1567'>
            endif<a name='1568'>
<font color=#447700>!<a name='1569'></font>
            if (grid%lap_hgt(i,j).gt.-10.) then<a name='1570'>
              grid%ctopo(i,j)=grid%ctopo(i,j)<a name='1571'>
            else<a name='1572'>
               if (grid%lap_hgt(i,j).ge.-20) then<a name='1573'>
                 alpha=(grid%lap_hgt(i,j)+20.)/10.<a name='1574'>
                 grid%ctopo(i,j)=alpha*grid%ctopo(i,j)+(1-alpha)<a name='1575'>
               else<a name='1576'>
                  if (grid%lap_hgt(i,j).ge.-30.) then<a name='1577'>
                  grid%ctopo(i,j)=(grid%lap_hgt(i,j)+30.)/10.<a name='1578'>
                  grid%ctopo2(i,j)=(grid%lap_hgt(i,j)+30.)/10.<a name='1579'>
                  else<a name='1580'>
                  grid%ctopo(i,j)=0.<a name='1581'>
                  grid%ctopo2(i,j)=0.<a name='1582'>
                  endif<a name='1583'>
               endif<a name='1584'>
            endif<a name='1585'>
         ENDDO<a name='1586'>
         ENDDO<a name='1587'>
<font color=#447700>!       if topo_wind==2 (D.Ovens, C.Mass)<a name='1588'></font>
       else if (config_flags%topo_wind.eq.2) then<a name='1589'>
         DO j = jts,min(jte,jde-1)<a name='1590'>
         DO i = its, min(ite,ide-1)<a name='1591'>
           if (grid%xland(i,j).lt.1.5) then<a name='1592'>
              vfac = amin1(1.575,(grid%var2d(i,j)*0.4/200.+1.175))<a name='1593'>
              vfac = vfac * vfac<a name='1594'>
           else                      <font color=#447700>! over water, leave it alone<a name='1595'></font>
              vfac = 1.<a name='1596'>
           endif<a name='1597'>
<font color=#447700>!          print *, j,i,grid%ctopo(i,j),vfac<a name='1598'></font>
           grid%ctopo(i,j)=grid%ctopo(i,j)*vfac<a name='1599'>
         ENDDO<a name='1600'>
         ENDDO<a name='1601'>
       endif<a name='1602'>
<a name='1603'>
   END IF<a name='1604'>
<a name='1605'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_129">( grid%w_1 , 'W' , config_flags ,                 &amp;<a name='1606'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1607'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1608'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1609'>
                         its , ite , jts , jte , kts , kte )<a name='1610'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_130">( grid%w_2 , 'W' , config_flags ,                 &amp;<a name='1611'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1612'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1613'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1614'>
                         its , ite , jts , jte , kts , kte )<a name='1615'>
<a name='1616'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_131">( grid%ph_1 , 'W' , config_flags ,                 &amp;<a name='1617'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1618'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1619'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1620'>
                         its , ite , jts , jte , kts , kte )<a name='1621'>
<a name='1622'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_132">( grid%ph_2 , 'W' , config_flags ,                 &amp;<a name='1623'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1624'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1625'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1626'>
                         its , ite , jts , jte , kts , kte )<a name='1627'>
<a name='1628'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_133">( grid%t_1 , 't' , config_flags ,                 &amp;<a name='1629'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1630'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1631'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1632'>
                         its , ite , jts , jte , kts , kte )<a name='1633'>
<a name='1634'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_134">( grid%t_2 , 't' , config_flags ,                 &amp;<a name='1635'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1636'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1637'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1638'>
                         its , ite , jts , jte , kts , kte )<a name='1639'>
<a name='1640'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_21">( grid%mu_1, 't' , config_flags ,   &amp;<a name='1641'>
                           ids , ide , jds , jde ,  &amp;<a name='1642'>
                           ims , ime , jms , jme ,  &amp;<a name='1643'>
                           its , ite , jts , jte ,  &amp;<a name='1644'>
                           its , ite , jts , jte   )<a name='1645'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_22">( grid%mu_2, 't' , config_flags ,   &amp;<a name='1646'>
                           ids , ide , jds , jde ,  &amp;<a name='1647'>
                           ims , ime , jms , jme ,  &amp;<a name='1648'>
                           its , ite , jts , jte ,  &amp;<a name='1649'>
                           its , ite , jts , jte   )<a name='1650'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_23">( grid%mub , 't' , config_flags ,   &amp;<a name='1651'>
                           ids , ide , jds , jde ,  &amp;<a name='1652'>
                           ims , ime , jms , jme ,  &amp;<a name='1653'>
                           its , ite , jts , jte ,  &amp;<a name='1654'>
                           its , ite , jts , jte   )<a name='1655'>
<font color=#447700>!  CALL set_physical_bc2d( grid%mu0 , 't' , config_flags ,   &amp;<a name='1656'></font>
<font color=#447700>!                          ids , ide , jds , jde ,  &amp;<a name='1657'></font>
<font color=#447700>!                          ims , ime , jms , jme ,  &amp;<a name='1658'></font>
<font color=#447700>!                          its , ite , jts , jte ,  &amp;<a name='1659'></font>
<font color=#447700>!                          its , ite , jts , jte   )<a name='1660'></font>
<a name='1661'>
<a name='1662'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_135">( grid%phb , 'W' , config_flags ,                 &amp;<a name='1663'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1664'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1665'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1666'>
                         its , ite , jts , jte , kts , kte )<a name='1667'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_136">( grid%ph0 , 'W' , config_flags ,                 &amp;<a name='1668'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1669'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1670'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1671'>
                         its , ite , jts , jte , kts , kte )<a name='1672'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_137">( grid%php , 'W' , config_flags ,                 &amp;<a name='1673'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1674'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1675'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1676'>
                         its , ite , jts , jte , kts , kte )<a name='1677'>
<a name='1678'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_138">( grid%pb , 't' , config_flags ,                 &amp;<a name='1679'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1680'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1681'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1682'>
                         its , ite , jts , jte , kts , kte )<a name='1683'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_139">( grid%al , 't' , config_flags ,                 &amp;<a name='1684'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1685'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1686'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1687'>
                         its , ite , jts , jte , kts , kte )<a name='1688'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_140">( grid%alt , 't' , config_flags ,                 &amp;<a name='1689'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1690'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1691'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1692'>
                         its , ite , jts , jte , kts , kte )<a name='1693'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_141">( grid%alb , 't' , config_flags ,                 &amp;<a name='1694'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1695'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1696'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1697'>
                         its , ite , jts , jte , kts , kte )<a name='1698'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_142">(grid%t_init, 't' , config_flags ,                 &amp;<a name='1699'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1700'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1701'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1702'>
                         its , ite , jts , jte , kts , kte )<a name='1703'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_143">(grid%tke_2, 't' , config_flags ,                 &amp;<a name='1704'>
                         ids , ide , jds , jde , kds , kde ,        &amp;<a name='1705'>
                         ims , ime , jms , jme , kms , kme ,        &amp;<a name='1706'>
                         its , ite , jts , jte , kts , kte ,        &amp;<a name='1707'>
                         its , ite , jts , jte , kts , kte )<a name='1708'>
<a name='1709'>
   IF (num_moist &gt; 0) THEN<a name='1710'>
<a name='1711'>
<font color=#447700>! use of (:,:,:,loop) not efficient on DEC, but (ims,kms,jms,loop) not portable to SGI/Cray<a name='1712'></font>
<a name='1713'>
      loop_3d_m   : DO loop = 1 , num_moist<a name='1714'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_144">( moist(:,:,:,loop) , 'r' , config_flags ,                 &amp;<a name='1715'>
                                 ids , ide , jds , jde , kds , kde ,        &amp;<a name='1716'>
                                 ims , ime , jms , jme , kms , kme ,        &amp;<a name='1717'>
                                 its , ite , jts , jte , kts , kte ,        &amp;<a name='1718'>
                                 its , ite , jts , jte , kts , kte )<a name='1719'>
      END DO loop_3d_m<a name='1720'>
<a name='1721'>
   ENDIF<a name='1722'>
<a name='1723'>
<font color=#447700>! Some initializations for the simple ccn field.<a name='1724'></font>
<a name='1725'>
   IF ( f_qnn ) THEN<a name='1726'>
      IF ( config_flags%mp_physics == wdm5scheme .or. config_flags%mp_physics == wdm6scheme ) THEN<a name='1727'>
         <font color=#447700>! NO OP<a name='1728'></font>
      ELSE IF ( config_flags%mp_physics == nssl_2momccn ) THEN<a name='1729'>
         grid%ccn_conc =  config_flags%nssl_cccn/1.225<a name='1730'>
      ELSE<a name='1731'>
         <font color=#447700>! NO OP<a name='1732'></font>
      END IF<a name='1733'>
      ccn_max_val = MAXVAL(scalar(its:MIN(ite,ide-1),kts:kte-1,jts:MIN(jte,jde-1),p_qnn))<a name='1734'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='1735'></font>
      ccn_max_val = wrf_dm_max_real ( ccn_max_val )<a name='1736'>
#endif<a name='1737'>
      IF ( ccn_max_val &lt; 1.0 ) THEN <font color=#447700>! initialization of ccn not already done<a name='1738'></font>
         DO j=jts,MIN(jte,jde-1)<a name='1739'>
            DO k=kts,kte<a name='1740'>
               DO i=its,MIN(ite,ide-1)<a name='1741'>
                  scalar(i,k,j,p_qnn) = grid%ccn_conc<a name='1742'>
               END DO<a name='1743'>
            END DO<a name='1744'>
         END DO<a name='1745'>
      END IF<a name='1746'>
   END IF<a name='1747'>
<a name='1748'>
   IF (num_scalar &gt; 0) THEN<a name='1749'>
<a name='1750'>
<font color=#447700>! use of (:,:,:,loop) not efficient on DEC, but (ims,kms,jms,loop) not portable to SGI/Cray<a name='1751'></font>
<a name='1752'>
      loop_3d_s   : DO loop = 1 , num_scalar<a name='1753'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_145">( scalar(:,:,:,loop) , 'r' , config_flags ,                 &amp;<a name='1754'>
                                 ids , ide , jds , jde , kds , kde ,        &amp;<a name='1755'>
                                 ims , ime , jms , jme , kms , kme ,        &amp;<a name='1756'>
                                 its , ite , jts , jte , kts , kte ,        &amp;<a name='1757'>
                                 its , ite , jts , jte , kts , kte )<a name='1758'>
      END DO loop_3d_s<a name='1759'>
<a name='1760'>
   ENDIF<a name='1761'>
<a name='1762'>
<a name='1763'>
#if (WRF_CHEM == 1)<a name='1764'>
        if(config_flags%tracer_opt &gt; 0 )then<a name='1765'>
           call initialize_tracer (tracer,config_flags%chem_in_opt, &amp;<a name='1766'>
                               config_flags%tracer_opt,num_tracer,  &amp;<a name='1767'>
                               ids,ide, jds,jde, kds,kde,      &amp; <font color=#447700>! domain dims<a name='1768'></font>
                               ims,ime, jms,jme, kms,kme,      &amp; <font color=#447700>! memory dims<a name='1769'></font>
                               ips,ipe, jps,jpe, kps,kpe,      &amp; <font color=#447700>! patch  dims<a name='1770'></font>
                               its,ite, jts,jte, kts,kte )<a name='1771'>
<a name='1772'>
        endif<a name='1773'>
<font color=#447700>!<a name='1774'></font>
<font color=#447700>!   we do this here, so we only have one chem_init routine for either core....<a name='1775'></font>
<font color=#447700>!<a name='1776'></font>
         do j=jts,min(jte,jde-1)<a name='1777'>
            do i=its,min(ite,ide-1)<a name='1778'>
               do k=kts,kte<a name='1779'>
                 z_at_w(i,k,j)=(grid%ph_2(i,k,j)+grid%phb(i,k,j))/g<a name='1780'>
               enddo<a name='1781'>
               do k=kts,min(kte,kde-1)<a name='1782'>
                 tempfac=(grid%t_1(i,k,j) + t0)*((grid%p(i,k,j) + grid%pb(i,k,j))/p1000mb)**rcp<a name='1783'>
                 convfac(i,k,j) = (grid%p(i,k,j)+grid%pb(i,k,j))/rgasuniv/tempfac<a name='1784'>
               enddo<a name='1785'>
            enddo<a name='1786'>
         enddo<a name='1787'>
<a name='1788'>
         CALL chem_init (grid%id,chem,emis_ant,scalar,grid%dt,grid%bioemdt,grid%photdt,     &amp;<a name='1789'>
                         grid%chemdt,                                       &amp;<a name='1790'>
                         grid%stepbioe,grid%stepphot,grid%stepchem,grid%stepfirepl,      &amp;<a name='1791'>
                         grid%plumerisefire_frq,z_at_w,grid%xlat,grid%xlong,g,           &amp;<a name='1792'>
                         grid%aerwrf,config_flags,grid,            &amp;<a name='1793'>
                         grid%alt,grid%t_1,grid%p,convfac,grid%ttday,grid%tcosz,         &amp;<a name='1794'>
                         grid%julday,grid%gmt,&amp;<a name='1795'>
                         grid%tauaer1,grid%tauaer2,grid%tauaer3,grid%tauaer4,                   &amp;<a name='1796'>
                         grid%gaer1,grid%gaer2,grid%gaer3,grid%gaer4,                           &amp;<a name='1797'>
                         grid%waer1,grid%waer2,grid%waer3,grid%waer4,                           &amp;<a name='1798'>
                         grid%l2aer,grid%l3aer,grid%l4aer,grid%l5aer,grid%l6aer,grid%l7aer,     &amp;<a name='1799'>
                         grid%extaerlw1,grid%extaerlw2,grid%extaerlw3,grid%extaerlw4,           &amp;<a name='1800'>
                         grid%extaerlw5,grid%extaerlw6,grid%extaerlw7,grid%extaerlw8,           &amp;<a name='1801'>
                         grid%extaerlw9,grid%extaerlw10,grid%extaerlw11,grid%extaerlw12,        &amp;<a name='1802'>
                         grid%extaerlw13,grid%extaerlw14,grid%extaerlw15,grid%extaerlw16,       &amp;<a name='1803'>
                         grid%tauaerlw1,grid%tauaerlw2,grid%tauaerlw3,grid%tauaerlw4,           &amp;<a name='1804'>
                         grid%tauaerlw5,grid%tauaerlw6,grid%tauaerlw7,grid%tauaerlw8,           &amp;<a name='1805'>
                         grid%tauaerlw9,grid%tauaerlw10,grid%tauaerlw11,grid%tauaerlw12,        &amp;<a name='1806'>
                         grid%tauaerlw13,grid%tauaerlw14,grid%tauaerlw15,grid%tauaerlw16,       &amp;<a name='1807'>
                         grid%dgnum4d, grid%dgnumwet4d, grid%dgnum_a1, grid%dgnum_a2,           &amp; <a name='1808'>
                         grid%dgnum_a3, grid%dgnumwet_a1, grid%dgnumwet_a2, grid%dgnumwet_a3,   &amp;<a name='1809'>
                         grid%pm2_5_dry,grid%pm2_5_water,grid%pm2_5_dry_ec,                &amp;<a name='1810'>
                         grid%tsoa,grid%asoa,grid%bsoa,                                    &amp;<a name='1811'>
                         grid%last_chem_time_year,grid%last_chem_time_month,               &amp;<a name='1812'>
                         grid%last_chem_time_day,grid%last_chem_time_hour,                 &amp;<a name='1813'>
                         grid%last_chem_time_minute,grid%last_chem_time_second,            &amp;<a name='1814'>
                         grid%chem_in_opt,grid%kemit,grid%num_vert_mix,                       &amp;<a name='1815'>
                         ids , ide , jds , jde , kds , kde ,                &amp;<a name='1816'>
                         ims , ime , jms , jme , kms , kme ,                &amp;<a name='1817'>
                         its , ite , jts , jte , kts , kte                  )<a name='1818'>
<a name='1819'>
<font color=#447700>!<a name='1820'></font>
<font color=#447700>! calculate initial pm<a name='1821'></font>
<font color=#447700>!<a name='1822'></font>
<font color=#447700>!       print *,'calculating initial pm'<a name='1823'></font>
        select case (config_flags%chem_opt)<a name='1824'>
        case (GOCART_SIMPLE,GOCARTRACM_KPP,GOCARTRADM2)<a name='1825'>
           call sum_pm_gocart (                                             &amp;<a name='1826'>
                grid%alt, chem, grid%pm2_5_dry, grid%pm2_5_dry_ec,grid%pm10,&amp;<a name='1827'>
                ids,ide, jds,jde, kds,kde,                                  &amp;<a name='1828'>
                ims,ime, jms,jme, kms,kme,                                  &amp;<a name='1829'>
                its,ite, jts,jte, kts,kte-1                                 )<a name='1830'>
        case (RADM2SORG,RADM2SORG_AQ,RADM2SORG_AQCHEM,RADM2SORG_KPP,RACMSORG_AQ,RACMSORG_AQCHEM_KPP, &amp;<a name='1831'>
              RACM_ESRLSORG_AQCHEM_KPP,RACMSORG_KPP)<a name='1832'>
           call sum_pm_sorgam (                                             &amp;<a name='1833'>
                grid%alt, chem, grid%h2oaj, grid%h2oai,                                    &amp;<a name='1834'>
                grid%pm2_5_dry, grid%pm2_5_water, grid%pm2_5_dry_ec, grid%pm10,                 &amp;<a name='1835'>
                grid%dust_opt,ids,ide, jds,jde, kds,kde,                    &amp;<a name='1836'>
                ims,ime, jms,jme, kms,kme,                                  &amp;<a name='1837'>
                its,ite, jts,jte, kts,kte-1                                 )<a name='1838'>
         case (RACM_SOA_VBS_KPP,RACM_SOA_VBS_AQCHEM_KPP)<a name='1839'>
             call sum_pm_soa_vbs (                                           &amp;<a name='1840'>
                 grid%alt, chem, grid%h2oaj, grid%h2oai,                                   &amp;<a name='1841'>
                 grid%pm2_5_dry, grid%pm2_5_water, grid%pm2_5_dry_ec, grid%pm10,                &amp;<a name='1842'>
                 config_flags%dust_opt,ids,ide, jds,jde, kds,kde,           &amp;<a name='1843'>
                 ims,ime, jms,jme, kms,kme,                                 &amp;<a name='1844'>
                 its,ite, jts,jte, kts,kte-1                                )<a name='1845'>
<a name='1846'>
        case (CBMZ_MOSAIC_4BIN,CBMZ_MOSAIC_8BIN,CBMZ_MOSAIC_4BIN_AQ,CBMZ_MOSAIC_8BIN_AQ, &amp;<a name='1847'>
              CBMZ_MOSAIC_DMS_4BIN, CBMZ_MOSAIC_DMS_8BIN, CBMZ_MOSAIC_DMS_4BIN_AQ,       &amp;<a name='1848'>
              CBMZ_MOSAIC_DMS_8BIN_AQ, CRI_MOSAIC_8BIN_AQ_KPP, CRI_MOSAIC_4BIN_AQ_KPP)<a name='1849'>
           call sum_pm_mosaic (                                             &amp;<a name='1850'>
                grid%alt, chem,                                                  &amp;<a name='1851'>
                grid%pm2_5_dry, grid%pm2_5_water, grid%pm2_5_dry_ec, grid%pm10,                 &amp;<a name='1852'>
                ids,ide, jds,jde, kds,kde,                                  &amp;<a name='1853'>
                ims,ime, jms,jme, kms,kme,                                  &amp;<a name='1854'>
                its,ite, jts,jte, kts,kte-1                                 )<a name='1855'>
<a name='1856'>
        case default<a name='1857'>
           do j=jts,min(jte,jde-1)<a name='1858'>
              do k=kts,min(kte,kde-1)<a name='1859'>
                 do i=its,min(ite,ide-1)<a name='1860'>
                    grid%pm2_5_dry(i,k,j)    = 0.<a name='1861'>
                    grid%pm2_5_water(i,k,j)  = 0.<a name='1862'>
                    grid%pm2_5_dry_ec(i,k,j) = 0.<a name='1863'>
                    grid%pm10(i,k,j)         = 0.<a name='1864'>
                    grid%tsoa(i,k,j)         = 0.<a name='1865'>
                 enddo<a name='1866'>
              enddo<a name='1867'>
           enddo<a name='1868'>
        end select<a name='1869'>
        <a name='1870'>
        <font color=#447700>! initialize advective tendency diagnostics for chem<a name='1871'></font>
        if ( grid%itimestep .eq. 0 .and. config_flags%chemdiag .eq. USECHEMDIAG ) then<a name='1872'>
          grid%advh_ct(:,:,:,:) = 0.<a name='1873'>
          grid%advz_ct(:,:,:,:) = 0.<a name='1874'>
        endif<a name='1875'>
#endif<a name='1876'>
<a name='1877'>
        <font color=#447700>! initialize advective tendency diagnostics for non-chem<a name='1878'></font>
        if ( grid%itimestep .eq. 0 .and. config_flags%tenddiag .eq. USETENDDIAG ) then<a name='1879'>
          advh_t(:,:,:,:) = 0.<a name='1880'>
          advz_t(:,:,:,:) = 0.<a name='1881'>
        endif<a name='1882'>
<a name='1883'>
   IF (num_chem &gt;= PARAM_FIRST_SCALAR ) THEN<a name='1884'>
<font color=#447700>! use of (:,:,:,loop) not efficient on DEC, but (ims,kms,jms,loop) not portable to SGI/Cray<a name='1885'></font>
<a name='1886'>
      loop_3d_c   : DO loop = PARAM_FIRST_SCALAR , num_chem<a name='1887'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_146">( chem(:,:,:,loop) , 'r' , config_flags ,                 &amp;<a name='1888'>
                                 ids , ide , jds , jde , kds , kde ,        &amp;<a name='1889'>
                                 ims , ime , jms , jme , kms , kme ,        &amp;<a name='1890'>
                                 its , ite , jts , jte , kts , kte ,        &amp;<a name='1891'>
                                 its , ite , jts , jte , kts , kte )<a name='1892'>
      END DO loop_3d_c<a name='1893'>
<a name='1894'>
   ENDIF<a name='1895'>
<a name='1896'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_24">( grid%msftx , 'r' , config_flags ,              &amp;<a name='1897'>
                         ids , ide , jds , jde , &amp;<a name='1898'>
                         ims , ime , jms , jme , &amp;<a name='1899'>
                         its , ite , jts , jte , &amp;<a name='1900'>
                         its , ite , jts , jte   )<a name='1901'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_25">( grid%msfty , 'r' , config_flags ,              &amp;<a name='1902'>
                         ids , ide , jds , jde , &amp;<a name='1903'>
                         ims , ime , jms , jme , &amp;<a name='1904'>
                         its , ite , jts , jte , &amp;<a name='1905'>
                         its , ite , jts , jte   )<a name='1906'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_26">( grid%msfux , 'x' , config_flags ,              &amp;<a name='1907'>
                         ids , ide , jds , jde , &amp;<a name='1908'>
                         ims , ime , jms , jme , &amp;<a name='1909'>
                         its , ite , jts , jte , &amp;<a name='1910'>
                         its , ite , jts , jte   )<a name='1911'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_27">( grid%msfuy , 'x' , config_flags ,              &amp;<a name='1912'>
                         ids , ide , jds , jde , &amp;<a name='1913'>
                         ims , ime , jms , jme , &amp;<a name='1914'>
                         its , ite , jts , jte , &amp;<a name='1915'>
                         its , ite , jts , jte   )<a name='1916'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_28">( grid%msfvx , 'y' , config_flags ,              &amp;<a name='1917'>
                         ids , ide , jds , jde , &amp;<a name='1918'>
                         ims , ime , jms , jme , &amp;<a name='1919'>
                         its , ite , jts , jte , &amp;<a name='1920'>
                         its , ite , jts , jte   )<a name='1921'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_29">( grid%msfvy , 'y' , config_flags ,              &amp;<a name='1922'>
                         ids , ide , jds , jde , &amp;<a name='1923'>
                         ims , ime , jms , jme , &amp;<a name='1924'>
                         its , ite , jts , jte , &amp;<a name='1925'>
                         its , ite , jts , jte   )<a name='1926'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_30">( grid%sina , 'r' , config_flags ,              &amp;<a name='1927'>
                         ids , ide , jds , jde , &amp;<a name='1928'>
                         ims , ime , jms , jme , &amp;<a name='1929'>
                         its , ite , jts , jte , &amp;<a name='1930'>
                         its , ite , jts , jte   )<a name='1931'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_31">( grid%cosa , 'r' , config_flags ,              &amp;<a name='1932'>
                         ids , ide , jds , jde , &amp;<a name='1933'>
                         ims , ime , jms , jme , &amp;<a name='1934'>
                         its , ite , jts , jte , &amp;<a name='1935'>
                         its , ite , jts , jte   )<a name='1936'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_32">( grid%e , 'r' , config_flags ,                 &amp;<a name='1937'>
                         ids , ide , jds , jde , &amp;<a name='1938'>
                         ims , ime , jms , jme , &amp;<a name='1939'>
                         its , ite , jts , jte , &amp;<a name='1940'>
                         its , ite , jts , jte   )<a name='1941'>
   CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_33">( grid%f , 'r' , config_flags ,                 &amp;<a name='1942'>
                         ids , ide , jds , jde , &amp;<a name='1943'>
                         ims , ime , jms , jme , &amp;<a name='1944'>
                         its , ite , jts , jte , &amp;<a name='1945'>
                         its , ite , jts , jte   )<a name='1946'>
<a name='1947'>
#if (WRF_CHEM <font color=#447700>!= 1)<a name='1948'></font>
      DEALLOCATE(CLDFRA_OLD)<a name='1949'>
#endif<a name='1950'>
#ifdef DM_PARALLEL<a name='1951'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_1.inc.html'>HALO_EM_INIT_1.inc</A>"<A NAME="HALO_EM_INIT_1.inc_17"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1952'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_2.inc.html'>HALO_EM_INIT_2.inc</A>"<A NAME="HALO_EM_INIT_2.inc_18"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1953'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_3.inc.html'>HALO_EM_INIT_3.inc</A>"<A NAME="HALO_EM_INIT_3.inc_19"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1954'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_4.inc.html'>HALO_EM_INIT_4.inc</A>"<A NAME="HALO_EM_INIT_4.inc_20"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1955'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_5.inc.html'>HALO_EM_INIT_5.inc</A>"<A NAME="HALO_EM_INIT_5.inc_21"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1956'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_INIT.inc.html'>PERIOD_BDY_EM_INIT.inc</A>"<A NAME="PERIOD_BDY_EM_INIT.inc_22"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1957'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST.inc.html'>PERIOD_BDY_EM_MOIST.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST.inc_23"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1958'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_TKE.inc.html'>PERIOD_BDY_EM_TKE.inc</A>"<A NAME="PERIOD_BDY_EM_TKE.inc_24"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1959'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_SCALAR.inc.html'>PERIOD_BDY_EM_SCALAR.inc</A>"<A NAME="PERIOD_BDY_EM_SCALAR.inc_25"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1960'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM.inc.html'>PERIOD_BDY_EM_CHEM.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM.inc_26"><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1961'>
#endif<a name='1962'>
<a name='1963'>
DEALLOCATE(z_at_q)<a name='1964'>
<a name='1965'>
   IF (config_flags%p_lev_diags == PRESS_DIAGS ) THEN<a name='1966'>
    CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_45"> ( 200 , ' PLD: pressure level diags' )<a name='1967'>
    CALL <A href='../../html_code/phys/module_diag_pld.F.html#PLD'>pld</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PLD_1"> (                                  &amp;<a name='1968'>
                 <font color=#447700>!  Input data for computing<a name='1969'></font>
                  U=grid%u_2                    &amp;<a name='1970'>
                 ,V=grid%v_2                    &amp;<a name='1971'>
                 ,W=grid%w_2                    &amp;<a name='1972'>
                 ,t=grid%t_2                    &amp;<a name='1973'>
                 ,qv=moist(:,:,:,P_QV)          &amp;<a name='1974'>
                 ,zp=grid%ph_2                  &amp;<a name='1975'>
                 ,zb=grid%phb                   &amp;<a name='1976'>
                 ,pp=grid%p                     &amp;<a name='1977'>
                 ,pb=grid%pb                    &amp;<a name='1978'>
                 ,p=grid%p_hyd                  &amp;<a name='1979'>
                 ,pw=grid%p_hyd_w               &amp;<a name='1980'>
                 <font color=#447700>!  Map factors, coriolis for diags<a name='1981'></font>
                 ,msfux=grid%msfux              &amp;<a name='1982'>
                 ,msfuy=grid%msfuy              &amp;<a name='1983'>
                 ,msfvx=grid%msfvx              &amp;<a name='1984'>
                 ,msfvy=grid%msfvy              &amp;<a name='1985'>
                 ,msftx=grid%msftx              &amp;<a name='1986'>
                 ,msfty=grid%msfty              &amp;<a name='1987'>
                 ,f=grid%f                      &amp;<a name='1988'>
                 ,e=grid%e                      &amp;<a name='1989'>
                 <font color=#447700>!  Namelist info<a name='1990'></font>
                 ,use_tot_or_hyd_p=config_flags%use_tot_or_hyd_p &amp;<a name='1991'>
                 ,extrap_below_grnd=config_flags%extrap_below_grnd &amp;<a name='1992'>
                 ,missing=config_flags%p_lev_missing &amp;<a name='1993'>
                 <font color=#447700>!  The diagnostics, mostly output variables<a name='1994'></font>
                 ,num_press_levels=config_flags%num_press_levels &amp;<a name='1995'>
                 ,max_press_levels=max_plevs    &amp;<a name='1996'>
                 ,press_levels=model_config_rec%press_levels &amp;<a name='1997'>
                 ,p_pl  = grid%p_pl             &amp;  <a name='1998'>
                 ,u_pl  = grid%u_pl             &amp;  <a name='1999'>
                 ,v_pl  = grid%v_pl             &amp;  <a name='2000'>
                 ,t_pl  = grid%t_pl             &amp;  <a name='2001'>
                 ,rh_pl = grid%rh_pl            &amp; <a name='2002'>
                 ,ght_pl= grid%ght_pl           &amp;<a name='2003'>
                 ,s_pl  = grid%s_pl             &amp;  <a name='2004'>
                 ,td_pl = grid%td_pl            &amp;<a name='2005'>
                 ,q_pl = grid%q_pl              &amp;<a name='2006'>
                 <font color=#447700>!  Dimension arguments<a name='2007'></font>
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde    &amp;<a name='2008'>
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme    &amp;<a name='2009'>
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte    )<a name='2010'>
   ENDIF<a name='2011'>
<a name='2012'>
   IF (config_flags%z_lev_diags == Z_DIAGS ) THEN<a name='2013'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_46"> ( 200 , ' ZLD: height level and AGL diags' )<a name='2014'>
     CALL <A href='../../html_code/phys/module_diag_zld.F.html#ZLD'>zld</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZLD_1"> (                                  &amp;<a name='2015'>
                 <font color=#447700>!  Input data for computing<a name='2016'></font>
                  U=grid%u_2                    &amp;<a name='2017'>
                 ,V=grid%v_2                    &amp;<a name='2018'>
                 ,W=grid%w_2                    &amp;<a name='2019'>
                 ,t=grid%t_2                    &amp;<a name='2020'>
                 ,qv=moist(:,:,:,P_QV)          &amp;<a name='2021'>
                 ,zp=grid%ph_2                  &amp;<a name='2022'>
                 ,zb=grid%phb                   &amp;<a name='2023'>
                 ,pp=grid%p                     &amp;<a name='2024'>
                 ,pb=grid%pb                    &amp;<a name='2025'>
                 ,p=grid%p_hyd                  &amp;<a name='2026'>
                 ,pw=grid%p_hyd_w               &amp;<a name='2027'>
                 <font color=#447700>!  Map factors, coriolis for diags<a name='2028'></font>
                 ,msfux=grid%msfux              &amp;<a name='2029'>
                 ,msfuy=grid%msfuy              &amp;<a name='2030'>
                 ,msfvx=grid%msfvx              &amp;<a name='2031'>
                 ,msfvy=grid%msfvy              &amp;<a name='2032'>
                 ,msftx=grid%msftx              &amp;<a name='2033'>
                 ,msfty=grid%msfty              &amp;<a name='2034'>
                 ,f=grid%f                      &amp;<a name='2035'>
                 ,e=grid%e                      &amp;<a name='2036'>
                 ,ht=grid%ht                    &amp;<a name='2037'>
                 <font color=#447700>!  Namelist info<a name='2038'></font>
                 ,use_tot_or_hyd_p=config_flags%use_tot_or_hyd_p &amp;<a name='2039'>
                 ,extrap_below_grnd=config_flags%extrap_below_grnd &amp;<a name='2040'>
                 ,missing=config_flags%z_lev_missing &amp;<a name='2041'>
                 <font color=#447700>!  The diagnostics, mostly output variables<a name='2042'></font>
                 ,num_z_levels=config_flags%num_z_levels &amp;<a name='2043'>
                 ,max_z_levels=max_zlevs    &amp;<a name='2044'>
                 ,z_levels=model_config_rec%z_levels &amp;<a name='2045'>
                 ,z_zl  = grid%z_zl             &amp;  <a name='2046'>
                 ,u_zl  = grid%u_zl             &amp;  <a name='2047'>
                 ,v_zl  = grid%v_zl             &amp;  <a name='2048'>
                 ,t_zl  = grid%t_zl             &amp;  <a name='2049'>
                 ,rh_zl = grid%rh_zl            &amp; <a name='2050'>
                 ,ght_zl= grid%ght_zl           &amp;<a name='2051'>
                 ,s_zl  = grid%s_zl             &amp;  <a name='2052'>
                 ,td_zl = grid%td_zl            &amp;<a name='2053'>
                 ,q_zl = grid%q_zl              &amp;<a name='2054'>
                 <font color=#447700>!  Dimension arguments<a name='2055'></font>
                 ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde    &amp;<a name='2056'>
                 ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme    &amp;<a name='2057'>
                 ,ITS=its,ITE=ite, JTS=jts,JTE=jte, KTS=kts,KTE=kte    )<a name='2058'>
   ENDIF<a name='2059'>
 <a name='2060'>
<a name='2061'>
<font color=#447700>!  FIRE<a name='2062'></font>
if(config_flags%ifire.eq.2)then<a name='2063'>
<a name='2064'>
   call <A href='../../html_code/phys/module_fr_fire_driver_wrf.F.html#FIRE_DRIVER_EM_INIT'>fire_driver_em_init</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIRE_DRIVER_EM_INIT_1"> ( grid , config_flags    &amp;<a name='2065'>
            ,ids,ide, kds,kde, jds,jde                &amp;<a name='2066'>
            ,ims,ime, kms,kme, jms,jme                &amp;<a name='2067'>
            ,ips,ipe, kps,kpe, jps,jpe ) <a name='2068'>
<a name='2069'>
   CALL wrf_debug ( 100 , 'start_domain_em: After call to fire_driver_em_init' )<a name='2070'>
endif<a name='2071'>
<a name='2072'>
if( grid%traj_opt /= no_trajectory ) then<a name='2073'>
     call <A href='../../html_code/share/module_trajectory.F.html#TRAJECTORY_INIT'>trajectory_init</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRAJECTORY_INIT_1">( grid, config_flags, &amp;<a name='2074'>
                           ims,ime, jms,jme, kms,kme )<a name='2075'>
     CALL wrf_debug ( 100 , 'start_domain_em: After call to trajectory_init' )<a name='2076'>
endif<a name='2077'>
<a name='2078'>
<a name='2079'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/start_em.F.html#START_DOMAIN_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_47"> ( 100 , 'start_domain_em: Returning' )<a name='2080'>
<a name='2081'>
     RETURN<a name='2082'>
<a name='2083'>
   END SUBROUTINE start_domain_em<a name='2084'>
<a name='2085'>
<font color=#447700>!-------------------------------------------------------------------<a name='2086'></font>
<a name='2087'>
<A NAME='REBALANCE_DRIVER_CYCL'><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_DRIVER_CYCL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2088'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rebalance_driver_cycl</font> ( grid ) <A href='../../call_to/REBALANCE_DRIVER_CYCL.html' TARGET='index'>2</A>,<A href='../../call_from/REBALANCE_DRIVER_CYCL.html' TARGET='index'>2</A><a name='2089'>
<a name='2090'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_DRIVER_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_31">, ONLY : domain<a name='2091'>
      IMPLICIT NONE<a name='2092'>
<a name='2093'>
      TYPE (domain)          :: grid<a name='2094'>
<a name='2095'>
      CALL <A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL'>rebalance_cycl</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_DRIVER_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REBALANCE_CYCL_1">( grid &amp;<a name='2096'>
<font color=#447700>!<a name='2097'></font>
#include "<A href='../../html_code/include/actual_new_args.inc.html'>actual_new_args.inc</A>"<A NAME="actual_new_args.inc_27"><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_DRIVER_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2098'>
<font color=#447700>!<a name='2099'></font>
      )<a name='2100'>
<a name='2101'>
   END SUBROUTINE rebalance_driver_cycl<a name='2102'>
<a name='2103'>
<font color=#447700>!---------------------------------------------------------------------<a name='2104'></font>
<a name='2105'>
<A NAME='REBALANCE_CYCL'><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2106'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>rebalance_cycl</font> ( grid  &amp; <A href='../../call_to/REBALANCE_CYCL.html' TARGET='index'>1</A>,<A href='../../call_from/REBALANCE_CYCL.html' TARGET='index'>7</A><a name='2107'>
<font color=#447700>!<a name='2108'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_28"><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2109'>
<font color=#447700>!<a name='2110'></font>
                        )<a name='2111'>
      USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_32">, ONLY : domain<a name='2112'>
      USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_22">, ONLY : grid_config_rec_type, model_config_rec<a name='2113'>
      USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_18"><a name='2114'>
      USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_18"><a name='2115'>
      USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_7">, ONLY: DATA_ORDER_XYZ, DATA_ORDER_YXZ, DATA_ORDER_ZXY, &amp;<a name='2116'>
                                         DATA_ORDER_ZYX, DATA_ORDER_XZY, DATA_ORDER_YZX, &amp;<a name='2117'>
                                         DATA_ORDER_XY, DATA_ORDER_YX, model_data_order<a name='2118'>
<a name='2119'>
#ifdef DM_PARALLEL<a name='2120'>
      USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_12">, ONLY : &amp;<a name='2121'>
                           HALO_EM_INIT_1_sub   &amp;<a name='2122'>
                          ,HALO_EM_INIT_2_sub   &amp;<a name='2123'>
                          ,HALO_EM_INIT_3_sub   &amp;<a name='2124'>
                          ,HALO_EM_INIT_4_sub   &amp;<a name='2125'>
                          ,HALO_EM_INIT_5_sub   &amp;<a name='2126'>
                          ,HALO_EM_VINTERP_UV_1_sub<a name='2127'>
#endif<a name='2128'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='2129'></font>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_23">, ONLY : ntasks_x, ntasks_y, ntasks, mytask, local_communicator<a name='2130'>
#endif<a name='2131'>
<a name='2132'>
      IMPLICIT NONE<a name='2133'>
<a name='2134'>
      TYPE (domain)          :: grid<a name='2135'>
<a name='2136'>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_29"><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2137'>
<a name='2138'>
      TYPE (grid_config_rec_type)              :: config_flags<a name='2139'>
<a name='2140'>
      REAL :: p_surf ,  pd_surf, p_surf_int , pb_int , ht_hold<a name='2141'>
      REAL :: qvf , qvf1 , qvf2, qtot<a name='2142'>
      REAL :: pfu, pfd, phm<a name='2143'>
      REAL :: z0, z1, z2, w1, w2<a name='2144'>
<a name='2145'>
      <font color=#447700>!  Local domain indices and counters.<a name='2146'></font>
<a name='2147'>
      INTEGER :: n_moist<a name='2148'>
<a name='2149'>
      INTEGER                             ::                       &amp;<a name='2150'>
                                     ids, ide, jds, jde, kds, kde, &amp;<a name='2151'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='2152'>
                                     its, ite, jts, jte, kts, kte, &amp;<a name='2153'>
                                     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='2154'>
                                     i, j, k, kk, ispe, ktf<a name='2155'>
<a name='2156'>
      SELECT CASE ( model_data_order )<a name='2157'>
         CASE ( DATA_ORDER_ZXY )<a name='2158'>
            kds = grid%sd31 ; kde = grid%ed31 ;<a name='2159'>
            ids = grid%sd32 ; ide = grid%ed32 ;<a name='2160'>
            jds = grid%sd33 ; jde = grid%ed33 ;<a name='2161'>
<a name='2162'>
            kms = grid%sm31 ; kme = grid%em31 ;<a name='2163'>
            ims = grid%sm32 ; ime = grid%em32 ;<a name='2164'>
            jms = grid%sm33 ; jme = grid%em33 ;<a name='2165'>
<a name='2166'>
            kts = grid%sp31 ; kte = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='2167'></font>
            its = grid%sp32 ; ite = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='2168'></font>
            jts = grid%sp33 ; jte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='2169'></font>
<a name='2170'>
         CASE ( DATA_ORDER_XYZ )<a name='2171'>
            ids = grid%sd31 ; ide = grid%ed31 ;<a name='2172'>
            jds = grid%sd32 ; jde = grid%ed32 ;<a name='2173'>
            kds = grid%sd33 ; kde = grid%ed33 ;<a name='2174'>
<a name='2175'>
            ims = grid%sm31 ; ime = grid%em31 ;<a name='2176'>
            jms = grid%sm32 ; jme = grid%em32 ;<a name='2177'>
            kms = grid%sm33 ; kme = grid%em33 ;<a name='2178'>
<a name='2179'>
            its = grid%sp31 ; ite = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='2180'></font>
            jts = grid%sp32 ; jte = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='2181'></font>
            kts = grid%sp33 ; kte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='2182'></font>
<a name='2183'>
         CASE ( DATA_ORDER_XZY )<a name='2184'>
            ids = grid%sd31 ; ide = grid%ed31 ;<a name='2185'>
            kds = grid%sd32 ; kde = grid%ed32 ;<a name='2186'>
            jds = grid%sd33 ; jde = grid%ed33 ;<a name='2187'>
<a name='2188'>
            ims = grid%sm31 ; ime = grid%em31 ;<a name='2189'>
            kms = grid%sm32 ; kme = grid%em32 ;<a name='2190'>
            jms = grid%sm33 ; jme = grid%em33 ;<a name='2191'>
<a name='2192'>
            its = grid%sp31 ; ite = grid%ep31 ;   <font color=#447700>! note that tile is entire patch<a name='2193'></font>
            kts = grid%sp32 ; kte = grid%ep32 ;   <font color=#447700>! note that tile is entire patch<a name='2194'></font>
            jts = grid%sp33 ; jte = grid%ep33 ;   <font color=#447700>! note that tile is entire patch<a name='2195'></font>
<a name='2196'>
      END SELECT<a name='2197'>
<a name='2198'>
            ktf=MIN(kte,kde-1)<a name='2199'>
<a name='2200'>
      DO j=jts,jte<a name='2201'>
         DO i=its,ite<a name='2202'>
            grid%ph_2(i,1,j) = 0.<a name='2203'>
         END DO<a name='2204'>
      END DO<a name='2205'>
<a name='2206'>
      <font color=#447700>!  Base state potential temperature and inverse density (alpha = 1/rho) from<a name='2207'></font>
      <font color=#447700>!  the half eta levels and the base-profile surface pressure.  Compute 1/rho<a name='2208'></font>
      <font color=#447700>!  from equation of state.  The potential temperature is a perturbation from t0.<a name='2209'></font>
<a name='2210'>
         n_moist = num_moist<a name='2211'>
<a name='2212'>
      print *,'n_moist,PARAM_FIRST_SCALAR',n_moist,PARAM_FIRST_SCALAR<a name='2213'>
<a name='2214'>
       DO j = jts, MIN(jte,jde-1)<a name='2215'>
         DO i = its, MIN(ite,ide-1)<a name='2216'>
<a name='2217'>
        IF (n_moist &gt;= PARAM_FIRST_SCALAR ) THEN<a name='2218'>
       <a name='2219'>
               <font color=#447700>!  Integrate the hydrostatic equation (from the RHS of the bigstep vertical momentum<a name='2220'></font>
               <font color=#447700>!  equation) down from the top to get the pressure perturbation.  First get the pressure<a name='2221'></font>
               <font color=#447700>!  perturbation, moisture, and inverse density (total and perturbation) at the top-most level.<a name='2222'></font>
<a name='2223'>
               kk = kte - 1<a name='2224'>
               k=kk+1<a name='2225'>
<a name='2226'>
               qtot = 0.<a name='2227'>
               DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='2228'>
                 qtot = qtot + 0.5*(moist(i,kk,j,ispe)+moist(i,kk,j,ispe))<a name='2229'>
               ENDDO<a name='2230'>
               qvf2 = 1./(1.+qtot)<a name='2231'>
               qvf1 = qtot*qvf2<a name='2232'>
<a name='2233'>
               grid%p(i,kk,j) = - 0.5*(grid%Mu_2(i,j)+qvf1*grid%Mub(i,j))/grid%rdnw(kk)/qvf2<a name='2234'>
               qvf = 1.+rvovrd*moist(i,kk,j,P_QV)<a name='2235'>
               grid%alt(i,kk,j) = (r_d/p1000mb)*(grid%t_2(i,kk,j)+t0)*qvf*         &amp;<a name='2236'>
                      (((grid%p(i,kk,j)+grid%pb(i,kk,j))/p1000mb)**cvpm)<a name='2237'>
               grid%al(i,kk,j) = grid%alt(i,kk,j) - grid%alb(i,kk,j)<a name='2238'>
               grid%p_hyd(i,kk,j) = grid%p(i,kk,j) + grid%pb(i,kk,j)<a name='2239'>
<a name='2240'>
<a name='2241'>
               <font color=#447700>!  Now, integrate down the column to compute the pressure perturbation, and diagnose the two<a name='2242'></font>
               <font color=#447700>!  inverse density fields (total and perturbation).<a name='2243'></font>
<a name='2244'>
        DO kk=kte-2,kts,-1<a name='2245'>
             k = kk + 1<a name='2246'>
<a name='2247'>
             qtot = 0.<a name='2248'>
             DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='2249'>
               qtot = qtot + 0.5*(  moist(i,kk  ,j,ispe) + moist(i,kk+1,j,ispe) )<a name='2250'>
             ENDDO<a name='2251'>
               qvf2 = 1./(1.+qtot)<a name='2252'>
               qvf1 = qtot*qvf2<a name='2253'>
               grid%p(i,kk,j) = grid%p(i,kk+1,j) - (grid%Mu_2(i,j) +       &amp;<a name='2254'>
                               qvf1*grid%Mub(i,j))/qvf2/grid%rdn(kk+1)<a name='2255'>
               qvf = 1. + rvovrd*moist(i,kk,j,P_QV)<a name='2256'>
               grid%alt(i,kk,j) = (r_d/p1000mb)*(grid%t_2(i,kk,j)+t0)*qvf* &amp;<a name='2257'>
                           (((grid%p(i,kk,j)+grid%pb(i,kk,j))/p1000mb)**cvpm)<a name='2258'>
               grid%al(i,kk,j) = grid%alt(i,kk,j) - grid%alb(i,kk,j)<a name='2259'>
               grid%p_hyd(i,kk,j) = grid%p(i,kk,j) + grid%pb(i,kk,j)<a name='2260'>
        ENDDO<a name='2261'>
<a name='2262'>
               <font color=#447700>!  This is the hydrostatic equation used in the model after the<a name='2263'></font>
               <font color=#447700>!  small timesteps.  In<a name='2264'></font>
               <font color=#447700>!  the model, grid%al (inverse density) is computed from the<a name='2265'></font>
               <font color=#447700>!  geopotential.<a name='2266'></font>
<a name='2267'>
            IF (grid%hypsometric_opt == 1) THEN<a name='2268'>
                  DO kk  = 2,kte<a name='2269'>
                     k = kk - 1<a name='2270'>
                     grid%ph_2(i,kk,j) = grid%ph_2(i,kk-1,j) - &amp;<a name='2271'>
                                   grid%dnw(kk-1) * ( (grid%mub(i,j)+grid%mu_2(i,j))*grid%al(i,kk-1,j) &amp;<a name='2272'>
                                 + grid%mu_2(i,j)*grid%alb(i,kk-1,j) )<a name='2273'>
                     grid%ph0(i,kk,j) = grid%ph_2(i,kk,j) + grid%phb(i,kk,j)<a name='2274'>
                  END DO<a name='2275'>
            ELSE IF (grid%hypsometric_opt == 2) THEN<a name='2276'>
                <font color=#447700>! Alternative hydrostatic eq.: dZ = -al*p*dLOG(p), where p is<a name='2277'></font>
                <font color=#447700>! dry pressure.<a name='2278'></font>
                <font color=#447700>! Note that al*p approximates Rd*T and dLOG(p) does z.<a name='2279'></font>
                <font color=#447700>! Here T varies mostly linear with z, the first-order<a name='2280'></font>
                <font color=#447700>! integration produces better result.<a name='2281'></font>
<a name='2282'>
                  grid%ph_2(i,1,j) = grid%phb(i,1,j)<a name='2283'>
                  DO k = 2,kte<a name='2284'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='2285'></font>
                     pfu = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znw(k)   + grid%p_top<a name='2286'>
                     pfd = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znw(k-1) + grid%p_top<a name='2287'>
                     phm = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znu(k-1) + grid%p_top<a name='2288'>
#elif ( HYBRID_COORD==1 )<a name='2289'>
                     pfu = grid%c3f(k  )*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4f(k  ) + grid%p_top<a name='2290'>
                     pfd = grid%c3f(k-1)*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4f(k-1) + grid%p_top<a name='2291'>
                     phm = grid%c3h(k-1)*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4h(k-1) + grid%p_top<a name='2292'>
#endif<a name='2293'>
                     grid%ph_2(i,k,j) = grid%ph_2(i,k-1,j) + grid%alt(i,k-1,j)*phm*LOG(pfd/pfu)<a name='2294'>
                  END DO<a name='2295'>
<a name='2296'>
                  DO k = 1,kte<a name='2297'>
                     grid%ph_2(i,k,j) = grid%ph_2(i,k,j) - grid%phb(i,k,j)<a name='2298'>
                  END DO<a name='2299'>
<a name='2300'>
               DO k = 1,kte<a name='2301'>
                  grid%ph0(i,k,j) = grid%ph_2(i,k,j) + grid%phb(i,k,j)<a name='2302'>
               END DO<a name='2303'>
            END IF <font color=#447700>! hypsometric option<a name='2304'></font>
<a name='2305'>
       ELSE  <font color=#447700>! n_moist<a name='2306'></font>
<a name='2307'>
         kk = kte - 1<a name='2308'>
               k = kk + 1 <a name='2309'>
<a name='2310'>
               qvf1 = 0.5*(moist(i,kk,j,P_QV)+moist(i,kk,j,P_QV))<a name='2311'>
               qvf2 = 1./(1.+qvf1)<a name='2312'>
               qvf1 = qvf1*qvf2<a name='2313'>
<a name='2314'>
               grid%p(i,kk,j) = - 0.5*(grid%Mu_2(i,j)+qvf1*grid%Mub(i,j))/grid%rdnw(kk)/qvf2<a name='2315'>
               qvf = 1. + rvovrd*moist(i,kk,j,P_QV)<a name='2316'>
               grid%alt(i,kk,j) = (r_d/p1000mb)*(grid%t_2(i,kk,j)+t0)*qvf    &amp;<a name='2317'>
                           *(((grid%p(i,kk,j)+grid%pb(i,kk,j))/p1000mb)**cvpm)<a name='2318'>
               grid%al(i,kk,j) = grid%alt(i,kk,j) - grid%alb(i,kk,j)<a name='2319'>
               grid%p_hyd(i,kk,j) = grid%p(i,kk,j) + grid%pb(i,kk,j)<a name='2320'>
<a name='2321'>
            <font color=#447700>!  Now, integrate down the column to compute the pressure perturbation, and diagnose the two<a name='2322'></font>
            <font color=#447700>!  inverse density fields (total and perturbation).<a name='2323'></font>
<a name='2324'>
           DO kk=kte-2,kts,-1<a name='2325'>
               k = kk + 1 <a name='2326'>
               qvf1 = 0.5*(moist(i,kk,j,P_QV)+moist(i,kk+1,j,P_QV))<a name='2327'>
               qvf2 = 1./(1.+qvf1)<a name='2328'>
               qvf1 = qvf1*qvf2<a name='2329'>
               grid%p(i,kk,j) = grid%p(i,kk+1,j) - (grid%Mu_2(i,j) + qvf1*grid%Mub(i,j))/qvf2/grid%rdn(kk+1)<a name='2330'>
               qvf = 1. + rvovrd*moist(i,kk,j,P_QV)<a name='2331'>
               grid%alt(i,kk,j) = (r_d/p1000mb)*(grid%t_2(i,kk,j)+t0)*qvf* &amp;<a name='2332'>
                           (((grid%p(i,kk,j)+grid%pb(i,kk,j))/p1000mb)**cvpm)<a name='2333'>
               grid%al(i,kk,j) = grid%alt(i,kk,j) - grid%alb(i,kk,j)<a name='2334'>
               grid%p_hyd(i,kk,j) = grid%p(i,kk,j) + grid%pb(i,kk,j)<a name='2335'>
           ENDDO<a name='2336'>
               <font color=#447700>!  This is the hydrostatic equation used in the model after the small timesteps.  In<a name='2337'></font>
               <font color=#447700>!  the model, grid%al (inverse density) is computed from the geopotential.<a name='2338'></font>
<a name='2339'>
            IF (grid%hypsometric_opt == 1) THEN<a name='2340'>
               DO k  = 2,kte<a name='2341'>
                  grid%ph_2(i,k,j) = grid%ph_2(i,k-1,j) - &amp;<a name='2342'>
                                grid%dnw(k-1) * ( (grid%mub(i,j)+grid%mu_2(i,j))*grid%al(i,k-1,j) &amp;<a name='2343'>
                              + grid%mu_2(i,j)*grid%alb(i,k-1,j) )<a name='2344'>
                  grid%ph0(i,k,j) = grid%ph_2(i,k,j) + grid%phb(i,k,j)<a name='2345'>
               END DO<a name='2346'>
            ELSE IF (grid%hypsometric_opt == 2) THEN<a name='2347'>
<a name='2348'>
             <font color=#447700>! Alternative hydrostatic eq.: dZ = -al*p*dLOG(p), where p is dry<a name='2349'></font>
             <font color=#447700>! pressure.<a name='2350'></font>
             <font color=#447700>! Note that al*p approximates Rd*T and dLOG(p) does z.<a name='2351'></font>
             <font color=#447700>! Here T varies mostly linear with z, the first-order integration<a name='2352'></font>
             <font color=#447700>! produces better result.<a name='2353'></font>
<a name='2354'>
               grid%ph_2(i,1,j) = grid%phb(i,1,j)<a name='2355'>
               DO k = 2,kte<a name='2356'>
#if  <font color=#447700>!( HYBRID_COORD==1 )<a name='2357'></font>
                  pfu = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znw(k)   + grid%p_top<a name='2358'>
                  pfd = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znw(k-1) + grid%p_top<a name='2359'>
                  phm = ( grid%mub(i,j)+grid%mu_2(i,j))*grid%znu(k-1) + grid%p_top<a name='2360'>
#elif ( HYBRID_COORD==1 )<a name='2361'>
                  pfu = grid%c3f(k  )*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4f(k  ) + grid%p_top<a name='2362'>
                  pfd = grid%c3f(k-1)*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4f(k-1) + grid%p_top<a name='2363'>
                  phm = grid%c3h(k-1)*(grid%MUB(i,j)+grid%MU_2(i,j)) + grid%c4h(k-1) + grid%p_top<a name='2364'>
#endif<a name='2365'>
                  grid%ph_2(i,k,j) = grid%ph_2(i,k-1,j) + grid%alt(i,k-1,j)*phm*LOG(pfd/pfu)<a name='2366'>
               END DO<a name='2367'>
<a name='2368'>
               DO k = 1,kte<a name='2369'>
                  grid%ph_2(i,k,j) = grid%ph_2(i,k,j) - grid%phb(i,k,j)<a name='2370'>
               END DO<a name='2371'>
<a name='2372'>
               DO k = 1,kte<a name='2373'>
                  grid%ph0(i,k,j) = grid%ph_2(i,k,j) + grid%phb(i,k,j)<a name='2374'>
               END DO<a name='2375'>
<a name='2376'>
            END IF <font color=#447700>! hypsometric<a name='2377'></font>
       ENDIF <font color=#447700>! nmoist<a name='2378'></font>
<a name='2379'>
<font color=#447700>! update surface pressure PSFC (needed for post-processing):<a name='2380'></font>
               z0 = grid%ph0(i,1,j)/g<a name='2381'>
               z1 = 0.5*(grid%ph0(i,1,j)+grid%ph0(i,2,j))/g<a name='2382'>
               z2 = 0.5*(grid%ph0(i,2,j)+grid%ph0(i,3,j))/g<a name='2383'>
               w1 = (z0 - z2)/(z1 - z2)<a name='2384'>
               w2 = 1. - w1<a name='2385'>
               grid%psfc(i,j) = w1*(grid%p(i,1,j)+grid%pb(i,1,j))+w2*(grid%p(i,2,j)+grid%pb(i,2,j))<a name='2386'>
<a name='2387'>
         END DO <font color=#447700>!i<a name='2388'></font>
        ENDDO <font color=#447700>!j<a name='2389'></font>
<a name='2390'>
      ips = its ; ipe = ite ; jps = jts ; jpe = jte ; kps = kts ; kpe = kte<a name='2391'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='2392'></font>
#   include "<A href='../../html_code/include/HALO_EM_INIT_1.inc.html'>HALO_EM_INIT_1.inc</A>"<A NAME="HALO_EM_INIT_1.inc_30"><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2393'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_2.inc.html'>HALO_EM_INIT_2.inc</A>"<A NAME="HALO_EM_INIT_2.inc_31"><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2394'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_3.inc.html'>HALO_EM_INIT_3.inc</A>"<A NAME="HALO_EM_INIT_3.inc_32"><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2395'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_4.inc.html'>HALO_EM_INIT_4.inc</A>"<A NAME="HALO_EM_INIT_4.inc_33"><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2396'>
#   include "<A href='../../html_code/include/HALO_EM_INIT_5.inc.html'>HALO_EM_INIT_5.inc</A>"<A NAME="HALO_EM_INIT_5.inc_34"><A href='../../html_code/dyn_em/start_em.F.html#REBALANCE_CYCL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2397'>
#endif<a name='2398'>
   END SUBROUTINE rebalance_cycl<a name='2399'>
<a name='2400'>
<font color=#447700>!---------------------------------------------------------------------<a name='2401'></font>
</pre></body></html>