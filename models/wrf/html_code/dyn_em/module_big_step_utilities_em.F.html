<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( HYBRID_COORD==1 ) <a name='2'>
#  define mut(...) (c1f(k)*XXPCTXX(__VA_ARGS__)+c2f(k))<a name='3'>
#  define XXPCTXX(...) mut(__VA_ARGS__)<a name='4'>
<a name='5'>
#  define muu(...) (c1h(k)*XXPCUXX(__VA_ARGS__)+c2h(k))<a name='6'>
#  define XXPCUXX(...) muu(__VA_ARGS__)<a name='7'>
<a name='8'>
#  define muv(...) (c1h(k)*XXPCVXX(__VA_ARGS__)+c2h(k))<a name='9'>
#  define XXPCVXX(...) muv(__VA_ARGS__)<a name='10'>
<a name='11'>
#  define mu(...) (c1(k)*XXPCXX(__VA_ARGS__))<a name='12'>
#  define XXPCXX(...) mu(__VA_ARGS__)<a name='13'>
<a name='14'>
#  define mub(...) (c1(k)*XXPCBXX(__VA_ARGS__)+c2(k))<a name='15'>
#  define XXPCBXX(...) mub(__VA_ARGS__)<a name='16'>
<a name='17'>
#  define muts(...) (c1(k)*XXPCTSXX(__VA_ARGS__)+c2(k))<a name='18'>
#  define XXPCTSXX(...) muts(__VA_ARGS__)<a name='19'>
<a name='20'>
#  define muuf(...) (c1f(k)*XXPCUFXX(__VA_ARGS__)+c2f(k))<a name='21'>
#  define XXPCUFXX(...) muuf(__VA_ARGS__)<a name='22'>
<a name='23'>
#  define muvf(...) (c1f(k)*XXPCVFXX(__VA_ARGS__)+c2f(k))<a name='24'>
#  define XXPCVFXX(...) muvf(__VA_ARGS__)<a name='25'>
<a name='26'>
#  define muf(...) (c1f(k)*XXPCFXX(__VA_ARGS__))<a name='27'>
#  define XXPCFXX(...) muf(__VA_ARGS__)<a name='28'>
<a name='29'>
#  define mubf(...) (c1f(k)*XXPCBFXX(__VA_ARGS__)+c2f(k))<a name='30'>
#  define XXPCBFXX(...) mubf(__VA_ARGS__)<a name='31'>
<a name='32'>
#  define MUT(...) (c1(k)*XXPCTHXX(__VA_ARGS__)+c2(k))<a name='33'>
#  define XXPCTHXX(...) MUT(__VA_ARGS__)<a name='34'>
#endif<a name='35'>
<a name='36'>
<font color=#447700>!wrf:MODEL_LAYER:DYNAMICS<a name='37'></font>
<font color=#447700>!<a name='38'></font>
<a name='39'>
#if (RWORDSIZE == 4)<a name='40'>
#   define VPOWX vspowx<a name='41'>
#   define VPOW  vspow<a name='42'>
#else<a name='43'>
#   define VPOWX vpowx<a name='44'>
#   define VPOW  vpow<a name='45'>
#endif<a name='46'>
<a name='47'>
<a name='48'>
<A NAME='MODULE_BIG_STEP_UTILITIES_EM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='49'>
<font color=#993300>MODULE </font><font color=#cc0000>module_big_step_utilities_em</font> <A href='../../call_to/MODULE_BIG_STEP_UTILITIES_EM.html' TARGET='index'>8</A><a name='50'>
<a name='51'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#module_big_step_utilities_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_4"><a name='52'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#module_big_step_utilities_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_4">, only: p_qg, p_qs, p_qi, gdscheme, tiedtkescheme, ntiedtkescheme, kfetascheme, mskfscheme, &amp;<a name='53'>
       g3scheme, gfscheme,p_qv, param_first_scalar, p_qr, p_qc, DFI_FWD<a name='54'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#module_big_step_utilities_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_6">, ONLY : grid_config_rec_type<a name='55'>
   USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#module_big_step_utilities_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_4"><a name='56'>
<a name='57'>
CONTAINS<a name='58'>
<a name='59'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='60'></font>
<a name='61'>
<A NAME='CALC_MU_UV'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='62'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_mu_uv</font> ( config_flags,                 &amp; <A href='../../call_to/CALC_MU_UV.html' TARGET='index'>1</A><a name='63'>
                        mu, mub, muu, muv,            &amp;<a name='64'>
                        ids, ide, jds, jde, kds, kde, &amp;<a name='65'>
                        ims, ime, jms, jme, kms, kme, &amp;<a name='66'>
                        its, ite, jts, jte, kts, kte )<a name='67'>
<a name='68'>
   IMPLICIT NONE<a name='69'>
   <a name='70'>
   <font color=#447700>! Input data<a name='71'></font>
<a name='72'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='73'>
<a name='74'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='75'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='76'>
                                       its, ite, jts, jte, kts, kte <a name='77'>
<a name='78'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(  OUT) :: muu, muv<a name='79'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu, mub<a name='80'>
<a name='81'>
   <font color=#447700>!  local stuff<a name='82'></font>
<a name='83'>
   INTEGER :: i, j, itf, jtf, im, jm<a name='84'>
<a name='85'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='86'></font>
<font color=#447700>!<a name='87'></font>
<font color=#447700>!  calc_mu_uv calculates the full column dry-air mass at the staggered<a name='88'></font>
<font color=#447700>!  horizontal velocity points (u,v) and places the results in muu and muv.<a name='89'></font>
<font color=#447700>!  This routine uses the reference state (mub) and perturbation state (mu)<a name='90'></font>
<font color=#447700>!<a name='91'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='92'></font>
<a name='93'>
<a name='94'>
      itf=ite<a name='95'>
      jtf=MIN(jte,jde-1)<a name='96'>
<a name='97'>
      IF      ( ( its .NE. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='98'>
         DO j=jts,jtf<a name='99'>
         DO i=its,itf<a name='100'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j)+MUB(i,j)+MUB(i-1,j))<a name='101'>
         ENDDO<a name='102'>
         ENDDO<a name='103'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='104'>
         DO j=jts,jtf<a name='105'>
         DO i=its+1,itf<a name='106'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j)+MUB(i,j)+MUB(i-1,j))<a name='107'>
         ENDDO<a name='108'>
         ENDDO<a name='109'>
         i=its<a name='110'>
         im = its<a name='111'>
         if(config_flags%periodic_x) im = its-1<a name='112'>
         DO j=jts,jtf<a name='113'>
<font color=#447700>!            MUU(i,j) =      MU(i,j)          +MUB(i,j)<a name='114'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='115'></font>
            MUU(i,j) = 0.5*(MU(i,j)+MU(im,j)+MUB(i,j)+MUB(im,j))<a name='116'>
         ENDDO<a name='117'>
      ELSE IF ( ( its .NE. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='118'>
         DO j=jts,jtf<a name='119'>
         DO i=its,itf-1<a name='120'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j)+MUB(i,j)+MUB(i-1,j))<a name='121'>
         ENDDO<a name='122'>
         ENDDO<a name='123'>
         i=ite<a name='124'>
         im = ite-1<a name='125'>
         if(config_flags%periodic_x) im = ite<a name='126'>
         DO j=jts,jtf<a name='127'>
<font color=#447700>!            MUU(i,j) =      MU(i-1,j)        +MUB(i-1,j)<a name='128'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='129'></font>
            MUU(i,j) = 0.5*(MU(i-1,j)+MU(im,j)+MUB(i-1,j)+MUB(im,j))<a name='130'>
         ENDDO<a name='131'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='132'>
         DO j=jts,jtf<a name='133'>
         DO i=its+1,itf-1<a name='134'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j)+MUB(i,j)+MUB(i-1,j))<a name='135'>
         ENDDO<a name='136'>
         ENDDO<a name='137'>
         i=its<a name='138'>
         im = its<a name='139'>
         if(config_flags%periodic_x) im = its-1<a name='140'>
         DO j=jts,jtf<a name='141'>
<font color=#447700>!            MUU(i,j) =      MU(i,j)          +MUB(i,j)<a name='142'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='143'></font>
            MUU(i,j) = 0.5*(MU(i,j)+MU(im,j)+MUB(i,j)+MUB(im,j))<a name='144'>
         ENDDO<a name='145'>
         i=ite<a name='146'>
         im = ite-1<a name='147'>
         if(config_flags%periodic_x) im = ite<a name='148'>
         DO j=jts,jtf<a name='149'>
<font color=#447700>!            MUU(i,j) =      MU(i-1,j)        +MUB(i-1,j)<a name='150'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='151'></font>
            MUU(i,j) = 0.5*(MU(i-1,j)+MU(im,j)+MUB(i-1,j)+MUB(im,j))<a name='152'>
         ENDDO<a name='153'>
      END IF<a name='154'>
<a name='155'>
      itf=MIN(ite,ide-1)<a name='156'>
      jtf=jte<a name='157'>
<a name='158'>
      IF      ( ( jts .NE. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='159'>
         DO j=jts,jtf<a name='160'>
         DO i=its,itf<a name='161'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1)+MUB(i,j)+MUB(i,j-1))<a name='162'>
         ENDDO<a name='163'>
         ENDDO<a name='164'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='165'>
         DO j=jts+1,jtf<a name='166'>
         DO i=its,itf<a name='167'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1)+MUB(i,j)+MUB(i,j-1))<a name='168'>
         ENDDO<a name='169'>
         ENDDO<a name='170'>
         j=jts<a name='171'>
         jm = jts<a name='172'>
         if(config_flags%periodic_y) jm = jts-1<a name='173'>
         DO i=its,itf<a name='174'>
<font color=#447700>!             MUV(i,j) =      MU(i,j)          +MUB(i,j)<a name='175'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='176'></font>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,jm)+MUB(i,j)+MUB(i,jm))<a name='177'>
         ENDDO<a name='178'>
      ELSE IF ( ( jts .NE. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='179'>
         DO j=jts,jtf-1<a name='180'>
         DO i=its,itf<a name='181'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1)+MUB(i,j)+MUB(i,j-1))<a name='182'>
         ENDDO<a name='183'>
         ENDDO<a name='184'>
         j=jte<a name='185'>
         jm = jte-1<a name='186'>
         if(config_flags%periodic_y) jm = jte<a name='187'>
         DO i=its,itf<a name='188'>
<font color=#447700>!            MUV(i,j) =      MU(i,j-1)        +MUB(i,j-1)<a name='189'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='190'></font>
             MUV(i,j) = 0.5*(MU(i,j-1)+MU(i,jm)+MUB(i,j-1)+MUB(i,jm))<a name='191'>
         ENDDO<a name='192'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='193'>
         DO j=jts+1,jtf-1<a name='194'>
         DO i=its,itf<a name='195'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1)+MUB(i,j)+MUB(i,j-1))<a name='196'>
         ENDDO<a name='197'>
         ENDDO<a name='198'>
         j=jts<a name='199'>
         jm = jts<a name='200'>
         if(config_flags%periodic_y) jm = jts-1<a name='201'>
         DO i=its,itf<a name='202'>
<font color=#447700>!             MUV(i,j) =      MU(i,j)          +MUB(i,j)<a name='203'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='204'></font>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,jm)+MUB(i,j)+MUB(i,jm))<a name='205'>
         ENDDO<a name='206'>
         j=jte<a name='207'>
         jm = jte-1<a name='208'>
         if(config_flags%periodic_y) jm = jte<a name='209'>
         DO i=its,itf<a name='210'>
<font color=#447700>!             MUV(i,j) =      MU(i,j-1)        +MUB(i,j-1)<a name='211'></font>
<font color=#447700>!  fix for periodic b.c., 13 march 2004, wcs<a name='212'></font>
             MUV(i,j) = 0.5*(MU(i,j-1)+MU(i,jm)+MUB(i,j-1)+MUB(i,jm))<a name='213'>
         ENDDO<a name='214'>
      END IF<a name='215'>
<a name='216'>
END SUBROUTINE calc_mu_uv<a name='217'>
<a name='218'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='219'></font>
<a name='220'>
<A NAME='CALC_MU_UV_1'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV_1' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='221'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_mu_uv_1</font> ( config_flags,                 &amp; <A href='../../call_to/CALC_MU_UV_1.html' TARGET='index'>1</A><a name='222'>
                          mu, muu, muv,                 &amp;<a name='223'>
                          ids, ide, jds, jde, kds, kde, &amp;<a name='224'>
                          ims, ime, jms, jme, kms, kme, &amp;<a name='225'>
                          its, ite, jts, jte, kts, kte )<a name='226'>
<a name='227'>
   IMPLICIT NONE<a name='228'>
   <a name='229'>
   <font color=#447700>! Input data<a name='230'></font>
<a name='231'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='232'>
<a name='233'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='234'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='235'>
                                       its, ite, jts, jte, kts, kte <a name='236'>
<a name='237'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(  OUT) :: muu, muv<a name='238'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu<a name='239'>
<a name='240'>
   <font color=#447700>!  local stuff<a name='241'></font>
<a name='242'>
   INTEGER :: i, j, itf, jtf, im, jm<a name='243'>
<a name='244'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='245'></font>
<font color=#447700>!<a name='246'></font>
<font color=#447700>!  calc_mu_uv calculates the full column dry-air mass at the staggered<a name='247'></font>
<font color=#447700>!  horizontal velocity points (u,v) and places the results in muu and muv.<a name='248'></font>
<font color=#447700>!  This routine uses the full state (mu)<a name='249'></font>
<font color=#447700>!<a name='250'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='251'></font>
   <a name='252'>
      itf=ite<a name='253'>
      jtf=MIN(jte,jde-1)<a name='254'>
<a name='255'>
      IF      ( ( its .NE. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='256'>
         DO j=jts,jtf<a name='257'>
         DO i=its,itf<a name='258'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j))<a name='259'>
         ENDDO<a name='260'>
         ENDDO<a name='261'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='262'>
         DO j=jts,jtf<a name='263'>
         DO i=its+1,itf<a name='264'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j))<a name='265'>
         ENDDO<a name='266'>
         ENDDO<a name='267'>
         i=its<a name='268'>
         im = its<a name='269'>
         if(config_flags%periodic_x) im = its-1<a name='270'>
         DO j=jts,jtf<a name='271'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(im,j))<a name='272'>
         ENDDO<a name='273'>
      ELSE IF ( ( its .NE. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='274'>
         DO j=jts,jtf<a name='275'>
         DO i=its,itf-1<a name='276'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j))<a name='277'>
         ENDDO<a name='278'>
         ENDDO<a name='279'>
         i=ite<a name='280'>
         im = ite-1<a name='281'>
         if(config_flags%periodic_x) im = ite<a name='282'>
         DO j=jts,jtf<a name='283'>
            MUU(i,j) = 0.5*(MU(i-1,j)+MU(im,j))<a name='284'>
         ENDDO<a name='285'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='286'>
         DO j=jts,jtf<a name='287'>
         DO i=its+1,itf-1<a name='288'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j))<a name='289'>
         ENDDO<a name='290'>
         ENDDO<a name='291'>
         i=its<a name='292'>
         im = its<a name='293'>
         if(config_flags%periodic_x) im = its-1<a name='294'>
         DO j=jts,jtf<a name='295'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(im,j))<a name='296'>
         ENDDO<a name='297'>
         i=ite<a name='298'>
         im = ite-1<a name='299'>
         if(config_flags%periodic_x) im = ite<a name='300'>
         DO j=jts,jtf<a name='301'>
            MUU(i,j) = 0.5*(MU(i-1,j)+MU(im,j))<a name='302'>
         ENDDO<a name='303'>
      END IF<a name='304'>
<a name='305'>
      itf=MIN(ite,ide-1)<a name='306'>
      jtf=jte<a name='307'>
<a name='308'>
      IF      ( ( jts .NE. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='309'>
         DO j=jts,jtf<a name='310'>
         DO i=its,itf<a name='311'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1))<a name='312'>
         ENDDO<a name='313'>
         ENDDO<a name='314'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='315'>
         DO j=jts+1,jtf<a name='316'>
         DO i=its,itf<a name='317'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1))<a name='318'>
         ENDDO<a name='319'>
         ENDDO<a name='320'>
         j=jts<a name='321'>
         jm = jts<a name='322'>
         if(config_flags%periodic_y) jm = jts-1<a name='323'>
         DO i=its,itf<a name='324'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,jm))<a name='325'>
         ENDDO<a name='326'>
      ELSE IF ( ( jts .NE. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='327'>
         DO j=jts,jtf-1<a name='328'>
         DO i=its,itf<a name='329'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1))<a name='330'>
         ENDDO<a name='331'>
         ENDDO<a name='332'>
         j=jte<a name='333'>
         jm = jte-1<a name='334'>
         if(config_flags%periodic_y) jm = jte<a name='335'>
         DO i=its,itf<a name='336'>
             MUV(i,j) = 0.5*(MU(i,j-1)+MU(i,jm))<a name='337'>
         ENDDO<a name='338'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='339'>
         DO j=jts+1,jtf-1<a name='340'>
         DO i=its,itf<a name='341'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1))<a name='342'>
         ENDDO<a name='343'>
         ENDDO<a name='344'>
         j=jts<a name='345'>
         jm = jts<a name='346'>
         if(config_flags%periodic_y) jm = jts-1<a name='347'>
         DO i=its,itf<a name='348'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,jm))<a name='349'>
         ENDDO<a name='350'>
         j=jte<a name='351'>
         jm = jte-1<a name='352'>
         if(config_flags%periodic_y) jm = jte<a name='353'>
         DO i=its,itf<a name='354'>
             MUV(i,j) = 0.5*(MU(i,j-1)+MU(i,jm))<a name='355'>
         ENDDO<a name='356'>
      END IF<a name='357'>
<a name='358'>
END SUBROUTINE calc_mu_uv_1<a name='359'>
<a name='360'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='361'></font>
<a name='362'>
<font color=#447700>! Map scale factor comments for this routine:<a name='363'></font>
<font color=#447700>! Locally not changed, but sent the correct map scale factors<a name='364'></font>
<font color=#447700>! from module_em (msfuy, msfvx, msfty)<a name='365'></font>
<a name='366'>
<A NAME='COUPLE_MOMENTUM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE_MOMENTUM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='367'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>couple_momentum</font> ( muu, ru, u, msfu,              &amp; <A href='../../call_to/COUPLE_MOMENTUM.html' TARGET='index'>1</A><a name='368'>
                             muv, rv, v, msfv, msfv_inv,    &amp;<a name='369'>
                             mut, rw, w, msft,              &amp;<a name='370'>
                             c1h, c2h, c1f, c2f,            &amp;<a name='371'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='372'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='373'>
                             its, ite, jts, jte, kts, kte  )<a name='374'>
<a name='375'>
   IMPLICIT NONE<a name='376'>
<a name='377'>
   <font color=#447700>! Input data<a name='378'></font>
<a name='379'>
   INTEGER ,             INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='380'>
                                          ims, ime, jms, jme, kms, kme, &amp;<a name='381'>
                                          its, ite, jts, jte, kts, kte<a name='382'>
<a name='383'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(  OUT) :: ru, rv, rw<a name='384'>
<a name='385'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: muu, muv, mut<a name='386'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: msfu, msfv, msft, msfv_inv<a name='387'>
   <a name='388'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: u, v, w<a name='389'>
   REAL , DIMENSION( kms:kme ) ,    INTENT(IN   ) :: c1h, c2h, c1f, c2f<a name='390'>
   <a name='391'>
   <font color=#447700>! Local data<a name='392'></font>
   <a name='393'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='394'>
   <a name='395'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='396'></font>
<font color=#447700>!<a name='397'></font>
<font color=#447700>! couple_momentum couples the velocities to the full column mass and<a name='398'></font>
<font color=#447700>! the map factors.<a name='399'></font>
<font color=#447700>!<a name='400'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='401'></font>
<a name='402'>
   ktf=MIN(kte,kde-1)<a name='403'>
   <a name='404'>
      itf=ite<a name='405'>
      jtf=MIN(jte,jde-1)<a name='406'>
<a name='407'>
      DO j=jts,jtf<a name='408'>
      DO k=kts,ktf<a name='409'>
      DO i=its,itf<a name='410'>
         ru(i,k,j)=u(i,k,j)*muu(i,j)/msfu(i,j)<a name='411'>
      ENDDO<a name='412'>
      ENDDO<a name='413'>
      ENDDO<a name='414'>
<a name='415'>
      itf=MIN(ite,ide-1)<a name='416'>
      jtf=jte<a name='417'>
<a name='418'>
      DO j=jts,jtf<a name='419'>
      DO k=kts,ktf<a name='420'>
      DO i=its,itf<a name='421'>
           rv(i,k,j)=v(i,k,j)*muv(i,j)*msfv_inv(i,j)<a name='422'>
      ENDDO<a name='423'>
      ENDDO<a name='424'>
      ENDDO<a name='425'>
<a name='426'>
      itf=MIN(ite,ide-1)<a name='427'>
      jtf=MIN(jte,jde-1)<a name='428'>
<a name='429'>
      DO j=jts,jtf<a name='430'>
      DO k=kts,kte<a name='431'>
      DO i=its,itf<a name='432'>
         rw(i,k,j)=w(i,k,j)*mut(i,j)/msft(i,j)<a name='433'>
      ENDDO<a name='434'>
      ENDDO<a name='435'>
      ENDDO<a name='436'>
<a name='437'>
END SUBROUTINE couple_momentum<a name='438'>
<a name='439'>
<font color=#447700>!-------------------------------------------------------------------<a name='440'></font>
<a name='441'>
<A NAME='CALC_MU_STAGGERED'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_STAGGERED' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='442'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_mu_staggered</font> ( mu, mub, muu, muv,            &amp; <A href='../../call_to/CALC_MU_STAGGERED.html' TARGET='index'>2</A><a name='443'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='444'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='445'>
                                  its, ite, jts, jte, kts, kte )<a name='446'>
<a name='447'>
   IMPLICIT NONE<a name='448'>
   <a name='449'>
   <font color=#447700>! Input data<a name='450'></font>
<a name='451'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='452'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='453'>
                                       its, ite, jts, jte, kts, kte <a name='454'>
<a name='455'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(  OUT) :: muu, muv<a name='456'>
   REAL, DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu, mub<a name='457'>
<a name='458'>
   <font color=#447700>!  local stuff<a name='459'></font>
<a name='460'>
   INTEGER :: i, j, itf, jtf<a name='461'>
<a name='462'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='463'></font>
<font color=#447700>!<a name='464'></font>
<font color=#447700>! calc_mu_staggered calculates the full dry air mass at the staggered<a name='465'></font>
<font color=#447700>! velocity points (u,v).<a name='466'></font>
<font color=#447700>!<a name='467'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='468'></font>
   <a name='469'>
      itf=ite<a name='470'>
      jtf=MIN(jte,jde-1)<a name='471'>
<a name='472'>
      IF      ( ( its .NE. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='473'>
         DO j=jts,jtf<a name='474'>
         DO i=its,itf<a name='475'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j)+MUB(i,j)+MUB(i-1,j))<a name='476'>
         ENDDO<a name='477'>
         ENDDO<a name='478'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .NE. ide ) ) THEN<a name='479'>
         DO j=jts,jtf<a name='480'>
         DO i=its+1,itf<a name='481'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j)+MUB(i,j)+MUB(i-1,j))<a name='482'>
         ENDDO<a name='483'>
         ENDDO<a name='484'>
         i=its<a name='485'>
         DO j=jts,jtf<a name='486'>
            MUU(i,j) =      MU(i,j)          +MUB(i,j)<a name='487'>
         ENDDO<a name='488'>
      ELSE IF ( ( its .NE. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='489'>
         DO j=jts,jtf<a name='490'>
         DO i=its,itf-1<a name='491'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j)+MUB(i,j)+MUB(i-1,j))<a name='492'>
         ENDDO<a name='493'>
         ENDDO<a name='494'>
         i=ite<a name='495'>
         DO j=jts,jtf<a name='496'>
            MUU(i,j) =      MU(i-1,j)        +MUB(i-1,j)<a name='497'>
         ENDDO<a name='498'>
      ELSE IF ( ( its .EQ. ids ) .AND. ( ite .EQ. ide ) ) THEN<a name='499'>
         DO j=jts,jtf<a name='500'>
         DO i=its+1,itf-1<a name='501'>
            MUU(i,j) = 0.5*(MU(i,j)+MU(i-1,j)+MUB(i,j)+MUB(i-1,j))<a name='502'>
         ENDDO<a name='503'>
         ENDDO<a name='504'>
         i=its<a name='505'>
         DO j=jts,jtf<a name='506'>
            MUU(i,j) =      MU(i,j)          +MUB(i,j)<a name='507'>
         ENDDO<a name='508'>
         i=ite<a name='509'>
         DO j=jts,jtf<a name='510'>
            MUU(i,j) =      MU(i-1,j)        +MUB(i-1,j)<a name='511'>
         ENDDO<a name='512'>
      END IF<a name='513'>
<a name='514'>
      itf=MIN(ite,ide-1)<a name='515'>
      jtf=jte<a name='516'>
<a name='517'>
      IF      ( ( jts .NE. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='518'>
         DO j=jts,jtf<a name='519'>
         DO i=its,itf<a name='520'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1)+MUB(i,j)+MUB(i,j-1))<a name='521'>
         ENDDO<a name='522'>
         ENDDO<a name='523'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .NE. jde ) ) THEN<a name='524'>
         DO j=jts+1,jtf<a name='525'>
         DO i=its,itf<a name='526'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1)+MUB(i,j)+MUB(i,j-1))<a name='527'>
         ENDDO<a name='528'>
         ENDDO<a name='529'>
         j=jts<a name='530'>
         DO i=its,itf<a name='531'>
             MUV(i,j) =      MU(i,j)          +MUB(i,j)<a name='532'>
         ENDDO<a name='533'>
      ELSE IF ( ( jts .NE. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='534'>
         DO j=jts,jtf-1<a name='535'>
         DO i=its,itf<a name='536'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1)+MUB(i,j)+MUB(i,j-1))<a name='537'>
         ENDDO<a name='538'>
         ENDDO<a name='539'>
         j=jte<a name='540'>
         DO i=its,itf<a name='541'>
             MUV(i,j) =      MU(i,j-1)        +MUB(i,j-1)<a name='542'>
         ENDDO<a name='543'>
      ELSE IF ( ( jts .EQ. jds ) .AND. ( jte .EQ. jde ) ) THEN<a name='544'>
         DO j=jts+1,jtf-1<a name='545'>
         DO i=its,itf<a name='546'>
             MUV(i,j) = 0.5*(MU(i,j)+MU(i,j-1)+MUB(i,j)+MUB(i,j-1))<a name='547'>
         ENDDO<a name='548'>
         ENDDO<a name='549'>
         j=jts<a name='550'>
         DO i=its,itf<a name='551'>
             MUV(i,j) =      MU(i,j)          +MUB(i,j)<a name='552'>
         ENDDO<a name='553'>
         j=jte<a name='554'>
         DO i=its,itf<a name='555'>
             MUV(i,j) =      MU(i,j-1)        +MUB(i,j-1)<a name='556'>
         ENDDO<a name='557'>
      END IF<a name='558'>
<a name='559'>
END SUBROUTINE calc_mu_staggered<a name='560'>
<a name='561'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='562'></font>
<a name='563'>
<A NAME='COUPLE'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='564'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>couple</font> ( mu, mub, rfield, field, name, &amp; <A href='../../call_to/COUPLE.html' TARGET='index'>32</A>,<A href='../../call_from/COUPLE.html' TARGET='index'>2</A><a name='565'>
                    msf, c1h, c2h, c1, c2,        &amp;<a name='566'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='567'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='568'>
                    its, ite, jts, jte, kts, kte )<a name='569'>
<a name='570'>
   IMPLICIT NONE<a name='571'>
<a name='572'>
   <font color=#447700>! Input data<a name='573'></font>
<a name='574'>
   INTEGER ,             INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='575'>
                                          ims, ime, jms, jme, kms, kme, &amp;<a name='576'>
                                          its, ite, jts, jte, kts, kte<a name='577'>
<a name='578'>
   CHARACTER(LEN=1) ,     INTENT(IN   ) :: name<a name='579'>
<a name='580'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(  OUT) :: rfield<a name='581'>
<a name='582'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mu, mub, msf<a name='583'>
   <a name='584'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field<a name='585'>
<a name='586'>
   REAL , DIMENSION( kms:kme ) ,    INTENT(IN   ) :: c1h, c2h, c1, c2<a name='587'>
   <a name='588'>
   <font color=#447700>! Local data<a name='589'></font>
   <a name='590'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='591'>
   REAL , DIMENSION(ims:ime,jms:jme) :: muu , muv<a name='592'>
<a name='593'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='594'></font>
<font color=#447700>!<a name='595'></font>
<font color=#447700>! subroutine couple couples the input variable with the dry-air <a name='596'></font>
<font color=#447700>! column mass (mu).  <a name='597'></font>
<font color=#447700>!<a name='598'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='599'></font>
<a name='600'>
   <a name='601'>
   ktf=MIN(kte,kde-1)<a name='602'>
   <a name='603'>
   IF (name .EQ. 'u')THEN<a name='604'>
<a name='605'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_STAGGERED'>calc_mu_staggered</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_STAGGERED_1"> ( mu, mub, muu, muv,            &amp;<a name='606'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='607'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='608'>
                                  its, ite, jts, jte, kts, kte )<a name='609'>
<a name='610'>
      itf=ite<a name='611'>
      jtf=MIN(jte,jde-1)<a name='612'>
<a name='613'>
      DO j=jts,jtf<a name='614'>
      DO k=kts,ktf<a name='615'>
      DO i=its,itf<a name='616'>
         rfield(i,k,j)=field(i,k,j)*muu(i,j)/msf(i,j)<a name='617'>
      ENDDO<a name='618'>
      ENDDO<a name='619'>
      ENDDO<a name='620'>
<a name='621'>
   ELSE IF (name .EQ. 'v')THEN<a name='622'>
<a name='623'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_STAGGERED'>calc_mu_staggered</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_STAGGERED_2"> ( mu, mub, muu, muv,            &amp;<a name='624'>
                               ids, ide, jds, jde, kds, kde, &amp;<a name='625'>
                               ims, ime, jms, jme, kms, kme, &amp;<a name='626'>
                               its, ite, jts, jte, kts, kte )<a name='627'>
<a name='628'>
      itf=ite<a name='629'>
      itf=MIN(ite,ide-1)<a name='630'>
      jtf=jte<a name='631'>
<a name='632'>
      DO j=jts,jtf<a name='633'>
      DO k=kts,ktf<a name='634'>
      DO i=its,itf<a name='635'>
           rfield(i,k,j)=field(i,k,j)*muv(i,j)/msf(i,j)<a name='636'>
      ENDDO<a name='637'>
      ENDDO<a name='638'>
      ENDDO<a name='639'>
<a name='640'>
   ELSE IF (name .EQ. 'w')THEN<a name='641'>
      itf=MIN(ite,ide-1)<a name='642'>
      jtf=MIN(jte,jde-1)<a name='643'>
      DO j=jts,jtf<a name='644'>
      DO k=kts,kte<a name='645'>
      DO i=its,itf<a name='646'>
         rfield(i,k,j)=field(i,k,j)*(mu(i,j)+mub(i,j))/msf(i,j)<a name='647'>
      ENDDO<a name='648'>
      ENDDO<a name='649'>
      ENDDO<a name='650'>
<a name='651'>
   ELSE IF (name .EQ. 'h')THEN<a name='652'>
      itf=MIN(ite,ide-1)<a name='653'>
      jtf=MIN(jte,jde-1)<a name='654'>
      DO j=jts,jtf<a name='655'>
      DO k=kts,kte<a name='656'>
      DO i=its,itf<a name='657'>
         rfield(i,k,j)=field(i,k,j)*(mu(i,j)+mub(i,j))<a name='658'>
      ENDDO<a name='659'>
      ENDDO<a name='660'>
      ENDDO<a name='661'>
<a name='662'>
   ELSE <a name='663'>
      itf=MIN(ite,ide-1)<a name='664'>
      jtf=MIN(jte,jde-1)<a name='665'>
      DO j=jts,jtf<a name='666'>
      DO k=kts,ktf<a name='667'>
      DO i=its,itf<a name='668'>
         rfield(i,k,j)=field(i,k,j)*(mu(i,j)+mub(i,j))<a name='669'>
      ENDDO<a name='670'>
      ENDDO<a name='671'>
      ENDDO<a name='672'>
   <a name='673'>
   ENDIF<a name='674'>
<a name='675'>
END SUBROUTINE couple<a name='676'>
<a name='677'>
<a name='678'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='679'></font>
<a name='680'>
<A NAME='CALC_WW_CP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_WW_CP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='681'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_ww_cp</font> ( u, v, mup, mub, c1h, c2h, ww,    &amp; <A href='../../call_to/CALC_WW_CP.html' TARGET='index'>1</A><a name='682'>
                        rdx, rdy, msftx, msfty,          &amp;<a name='683'>
                        msfux, msfuy, msfvx, msfvx_inv,  &amp;<a name='684'>
                        msfvy, dnw,                      &amp;<a name='685'>
                        ids, ide, jds, jde, kds, kde,    &amp;<a name='686'>
                        ims, ime, jms, jme, kms, kme,    &amp;<a name='687'>
                        its, ite, jts, jte, kts, kte    )<a name='688'>
<a name='689'>
   IMPLICIT NONE<a name='690'>
<a name='691'>
   <font color=#447700>! Input data<a name='692'></font>
<a name='693'>
<a name='694'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='695'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='696'>
                                 its, ite, jts, jte, kts, kte<a name='697'>
<a name='698'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: u, v<a name='699'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mup, mub, &amp;<a name='700'>
                                                            msftx, msfty, &amp;<a name='701'>
                                                            msfux, msfuy, &amp;<a name='702'>
                                                            msfvx, msfvy, &amp;<a name='703'>
                                                            msfvx_inv<a name='704'>
   REAL , DIMENSION( kms:kme ) , INTENT(IN   ) :: dnw<a name='705'>
   REAL , DIMENSION( kms:kme ) , INTENT(IN   ) :: c1h, c2h<a name='706'>
   <a name='707'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT  ) :: ww<a name='708'>
   REAL , INTENT(IN   )  :: rdx, rdy<a name='709'>
   <a name='710'>
   <font color=#447700>! Local data<a name='711'></font>
   <a name='712'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='713'>
   REAL , DIMENSION( its:ite ) :: dmdt<a name='714'>
   REAL , DIMENSION( its:ite, kts:kte ) :: divv<a name='715'>
   REAL , DIMENSION( its:ite+1, jts:jte+1 ) :: muu, muv<a name='716'>
<a name='717'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='718'></font>
<font color=#447700>!<a name='719'></font>
<font color=#447700>!  calc_ww calculates omega using the velocities (u,v) and the dry-air <a name='720'></font>
<font color=#447700>!  column mass (mup+mub).<a name='721'></font>
<font color=#447700>!  The algorithm integrates the continuity equation through the column<a name='722'></font>
<font color=#447700>!  followed by a diagnosis of omega.<a name='723'></font>
<font color=#447700>!<a name='724'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='725'></font>
<a name='726'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='727'></font>
<font color=#447700>!<a name='728'></font>
<font color=#447700>!  calc_ww_cp calculates omega using the velocities (u,v) and the <a name='729'></font>
<font color=#447700>!  column mass mu.<a name='730'></font>
<font color=#447700>!<a name='731'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='732'></font>
<a name='733'>
    jtf=MIN(jte,jde-1)<a name='734'>
    ktf=MIN(kte,kde-1)  <a name='735'>
    itf=MIN(ite,ide-1)<a name='736'>
<a name='737'>
<font color=#447700>!  mu coupled with the appropriate map factor<a name='738'></font>
<a name='739'>
      DO j=jts,jtf<a name='740'>
      DO i=its,min(ite+1,ide)<a name='741'>
        MUU(i,j) = 0.5*(MUP(i,j)+MUB(i,j)+MUP(i-1,j)+MUB(i-1,j))<a name='742'>
      ENDDO<a name='743'>
      ENDDO<a name='744'>
<a name='745'>
      DO j=jts,min(jte+1,jde)<a name='746'>
      DO i=its,itf<a name='747'>
        MUV(i,j) = 0.5*(MUP(i,j)+MUB(i,j)+MUP(i,j-1)+MUB(i,j-1))<a name='748'>
      ENDDO<a name='749'>
      ENDDO<a name='750'>
<a name='751'>
      DO j=jts,jtf<a name='752'>
<a name='753'>
        DO i=its,ite<a name='754'>
          dmdt(i) = 0.<a name='755'>
          ww(i,1,j) = 0.<a name='756'>
          ww(i,kte,j) = 0.<a name='757'>
        ENDDO<a name='758'>
<a name='759'>
<font color=#447700>!       Comments on the modifications for map scale factors<a name='760'></font>
<font color=#447700>!       ADT eqn 47 / my (putting rho -&gt; 'mu') is:<a name='761'></font>
<font color=#447700>!       (1/my) partial d mu/dt = -mx partial d/dx(mu u/my) <a name='762'></font>
<font color=#447700>!                                -mx partial d/dy(mu v/mx)<a name='763'></font>
<font color=#447700>!                                -partial d/dz(mu w/my)<a name='764'></font>
<font color=#447700>!<a name='765'></font>
<font color=#447700>!       Using nu instead of z the last term becomes:<a name='766'></font>
<font color=#447700>!                                -partial d/dnu(mu (dnu/dt)/my)<a name='767'></font>
<font color=#447700>!<a name='768'></font>
<font color=#447700>!       Integrating with respect to nu over ALL levels, with dnu/dt=0 at top<a name='769'></font>
<font color=#447700>!       and bottom, the last term becomes = 0<a name='770'></font>
<font color=#447700>!<a name='771'></font>
<font color=#447700>!       Integral|bot-&gt;top[(1/my) partial d mu/dt]dnu = <a name='772'></font>
<font color=#447700>!       Integral|bot-&gt;top[-mx partial d/dx(mu u/my) <a name='773'></font>
<font color=#447700>!                         -mx partial d/dy(mu v/mx)]dnu<a name='774'></font>
<font color=#447700>!<a name='775'></font>
<font color=#447700>!       muu='mu'[on u]/my, muv='mu'[on v]/mx<a name='776'></font>
<font color=#447700>!       (1/my) partial d mu/dt is independent of nu<a name='777'></font>
<font color=#447700>!         =&gt; LHS = Integral|bot-&gt;top[con]dnu = conservation*(-1) = -dmdt<a name='778'></font>
<font color=#447700>!<a name='779'></font>
<font color=#447700>!         =&gt; dmdt = mx*Integral|bot-&gt;top[partial d/dx(mu u/my) +<a name='780'></font>
<font color=#447700>!                                        partial d/dy(mu v/mx)]dnu<a name='781'></font>
<font color=#447700>!         =&gt; dmdt = sum_bot-&gt;top[divv]<a name='782'></font>
<font color=#447700>!       where<a name='783'></font>
<font color=#447700>!         divv=mx*[partial d/dx(mu u/my) + partial d/dy(mu v/mx)]*delta nu<a name='784'></font>
<a name='785'>
        DO k=kts,ktf<a name='786'>
        DO i=its,itf<a name='787'>
<a name='788'>
          divv(i,k) = msftx(i,j)*dnw(k)*( rdx*(muu(i+1,j)*u(i+1,k,j)/msfuy(i+1,j)-muu(i,j)*u(i,k,j)/msfuy(i,j))  &amp;<a name='789'>
                                        +rdy*(muv(i,j+1)*v(i,k,j+1)*msfvx_inv(i,j+1)-muv(i,j)*v(i,k,j)*msfvx_inv(i,j))   )<a name='790'>
<a name='791'>
<font color=#447700>!          dmdt(i) = dmdt(i) + dnw(k)* ( rdx*(ru(i+1,k,j)-ru(i,k,j))  &amp;<a name='792'></font>
<font color=#447700>!                                       +rdy*(rv(i,k,j+1)-rv(i,k,j))   )<a name='793'></font>
<a name='794'>
          dmdt(i) = dmdt(i) + divv(i,k)<a name='795'>
<a name='796'>
<a name='797'>
        ENDDO<a name='798'>
        ENDDO<a name='799'>
<a name='800'>
<font color=#447700>!       Further map scale factor notes:<a name='801'></font>
<font color=#447700>!       Now integrate from bottom to top, level by level:<a name='802'></font>
<font color=#447700>!       mu dnu/dt/my [k+1] = mu dnu/dt/my [k] + [-(1/my) partial d mu/dt <a name='803'></font>
<font color=#447700>!                           -mx partial d/dx(mu u/my)<a name='804'></font>
<font color=#447700>!                           -mx partial d/dy(mu v/mx)]*dnu[k-&gt;k+1]<a name='805'></font>
<font color=#447700>!       ww [k+1] = ww [k] -(1/my) partial d mu/dt * dnu[k-&gt;k+1] - divv[k]<a name='806'></font>
<font color=#447700>!                = ww [k] -dmdt * dnw[k] - divv[k]<a name='807'></font>
<a name='808'>
        DO k=2,ktf<a name='809'>
        DO i=its,itf<a name='810'>
<a name='811'>
<font color=#447700>!           ww(i,k,j)=ww(i,k-1,j)                                       &amp;<a name='812'></font>
<font color=#447700>!                        - dnw(k-1)* ( dmdt(i)                          &amp;<a name='813'></font>
<font color=#447700>!                                     +rdx*(ru(i+1,k-1,j)-ru(i,k-1,j))  &amp;<a name='814'></font>
<font color=#447700>!                                     +rdy*(rv(i,k-1,j+1)-rv(i,k-1,j)) )<a name='815'></font>
<a name='816'>
           ww(i,k,j)=ww(i,k-1,j) - dnw(k-1)*c1h(k-1)*dmdt(i) - divv(i,k-1)<a name='817'>
<a name='818'>
        ENDDO<a name='819'>
        ENDDO<a name='820'>
     ENDDO<a name='821'>
<a name='822'>
<a name='823'>
END SUBROUTINE calc_ww_cp<a name='824'>
<a name='825'>
<a name='826'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='827'></font>
 <a name='828'>
<A NAME='CALC_CQ'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_CQ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='829'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_cq</font> ( moist, cqu, cqv, cqw, n_moist, &amp; <A href='../../call_to/CALC_CQ.html' TARGET='index'>1</A><a name='830'>
                     ids, ide, jds, jde, kds, kde,  &amp;<a name='831'>
                     ims, ime, jms, jme, kms, kme,  &amp;<a name='832'>
                     its, ite, jts, jte, kts, kte  )<a name='833'>
<a name='834'>
   IMPLICIT NONE<a name='835'>
   <a name='836'>
   <font color=#447700>! Input data<a name='837'></font>
<a name='838'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='839'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='840'>
                                       its, ite, jts, jte, kts, kte <a name='841'>
<a name='842'>
   INTEGER ,          INTENT(IN   ) :: n_moist<a name='843'>
   <a name='844'>
<a name='845'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme , n_moist ), INTENT(IN   ) :: moist<a name='846'>
                                              <a name='847'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(  OUT) :: cqu, cqv, cqw<a name='848'>
<a name='849'>
   <font color=#447700>! Local stuff<a name='850'></font>
<a name='851'>
   <font color=#447700>! Changes from Larry Meadows, Intel Corp.  Improve vectorization of this routine<a name='852'></font>
   REAL :: qtot(its:ite)<a name='853'>
   <a name='854'>
   INTEGER :: i, j, k, itf, jtf, ktf, ispe<a name='855'>
<a name='856'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='857'></font>
<font color=#447700>!<a name='858'></font>
<font color=#447700>!  calc_cq calculates moist coefficients for the momentum equations.<a name='859'></font>
<font color=#447700>!<a name='860'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='861'></font>
<a name='862'>
      ktf=MIN(kte,kde-1)<a name='863'>
<a name='864'>
      IF(  n_moist &gt;= PARAM_FIRST_SCALAR ) THEN<a name='865'>
<a name='866'>
        itf=ite<a name='867'>
        jtf=MIN(jte,jde-1)<a name='868'>
        DO j=jts,jtf<a name='869'>
          DO k=kts,ktf<a name='870'>
            qtot = 0.<a name='871'>
            DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='872'>
              DO i=its,itf<a name='873'>
                qtot(i) = qtot(i) + moist(i,k,j,ispe) + moist(i-1,k,j,ispe)<a name='874'>
              ENDDO<a name='875'>
            ENDDO<a name='876'>
            DO i=its,itf<a name='877'>
              cqu(i,k,j) = 1./(1.+0.5*qtot(i))<a name='878'>
            ENDDO<a name='879'>
        ENDDO<a name='880'>
        ENDDO<a name='881'>
<a name='882'>
        itf=MIN(ite,ide-1)<a name='883'>
        jtf=jte<a name='884'>
        DO j=jts,jtf<a name='885'>
          DO k=kts,ktf<a name='886'>
            qtot = 0.<a name='887'>
            DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='888'>
              DO i=its,itf<a name='889'>
                qtot(i) = qtot(i) + moist(i,k,j,ispe) + moist(i,k,j-1,ispe)<a name='890'>
              ENDDO<a name='891'>
            ENDDO<a name='892'>
            DO i = its,itf<a name='893'>
               cqv(i,k,j) = 1./(1.+0.5*qtot(i))<a name='894'>
            ENDDO<a name='895'>
          ENDDO<a name='896'>
        ENDDO<a name='897'>
<a name='898'>
        itf=MIN(ite,ide-1)<a name='899'>
        jtf=MIN(jte,jde-1)<a name='900'>
        DO j=jts,jtf<a name='901'>
          DO k=kts+1,ktf<a name='902'>
            qtot = 0.<a name='903'>
            DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='904'>
              DO i=its,itf<a name='905'>
                qtot(i) = qtot(i) + moist(i,k,j,ispe) + moist(i,k-1,j,ispe)<a name='906'>
              ENDDO<a name='907'>
            ENDDO<a name='908'>
            DO i = its,itf<a name='909'>
              cqw(i,k,j) = 0.5*qtot(i)<a name='910'>
            ENDDO<a name='911'>
        ENDDO<a name='912'>
        ENDDO<a name='913'>
<a name='914'>
      ELSE<a name='915'>
<a name='916'>
        itf=ite<a name='917'>
        jtf=MIN(jte,jde-1)<a name='918'>
        DO j=jts,jtf<a name='919'>
        DO k=kts,ktf<a name='920'>
        DO i=its,itf<a name='921'>
           cqu(i,k,j) = 1.<a name='922'>
        ENDDO<a name='923'>
        ENDDO<a name='924'>
        ENDDO<a name='925'>
<a name='926'>
        itf=MIN(ite,ide-1)<a name='927'>
        jtf=jte<a name='928'>
        DO j=jts,jtf<a name='929'>
        DO k=kts,ktf<a name='930'>
        DO i=its,itf<a name='931'>
           cqv(i,k,j) = 1.<a name='932'>
        ENDDO<a name='933'>
        ENDDO<a name='934'>
        ENDDO<a name='935'>
<a name='936'>
        itf=MIN(ite,ide-1)<a name='937'>
        jtf=MIN(jte,jde-1)<a name='938'>
        DO j=jts,jtf<a name='939'>
        DO k=kts+1,ktf<a name='940'>
        DO i=its,itf<a name='941'>
           cqw(i,k,j) = 0.<a name='942'>
        ENDDO<a name='943'>
        ENDDO<a name='944'>
        ENDDO<a name='945'>
<a name='946'>
      END IF<a name='947'>
<a name='948'>
END SUBROUTINE calc_cq<a name='949'>
<a name='950'>
<font color=#447700>!----------------------------------------------------------------------<a name='951'></font>
<a name='952'>
<A NAME='CALC_ALT'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_ALT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='953'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_alt</font> ( alt, al, alb,                  &amp; <A href='../../call_to/CALC_ALT.html' TARGET='index'>1</A><a name='954'>
                      ids, ide, jds, jde, kds, kde,  &amp;<a name='955'>
                      ims, ime, jms, jme, kms, kme,  &amp;<a name='956'>
                      its, ite, jts, jte, kts, kte  )<a name='957'>
<a name='958'>
   IMPLICIT NONE<a name='959'>
   <a name='960'>
   <font color=#447700>! Input data<a name='961'></font>
<a name='962'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='963'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='964'>
                                       its, ite, jts, jte, kts, kte <a name='965'>
<a name='966'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(IN   ) :: alb, al<a name='967'>
   REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(  OUT) :: alt<a name='968'>
<a name='969'>
   <font color=#447700>! Local stuff<a name='970'></font>
<a name='971'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='972'>
<a name='973'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='974'></font>
<font color=#447700>!<a name='975'></font>
<font color=#447700>! calc_alt computes the full inverse density<a name='976'></font>
<font color=#447700>!<a name='977'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='978'></font>
<a name='979'>
      itf=MIN(ite,ide-1)<a name='980'>
      jtf=MIN(jte,jde-1)<a name='981'>
      ktf=MIN(kte,kde-1)<a name='982'>
<a name='983'>
      DO j=jts,jtf<a name='984'>
      DO k=kts,ktf<a name='985'>
      DO i=its,itf<a name='986'>
        alt(i,k,j) = al(i,k,j)+alb(i,k,j)<a name='987'>
      ENDDO<a name='988'>
      ENDDO<a name='989'>
      ENDDO<a name='990'>
<a name='991'>
<a name='992'>
END SUBROUTINE calc_alt<a name='993'>
<a name='994'>
<font color=#447700>!----------------------------------------------------------------------<a name='995'></font>
<a name='996'>
<A NAME='CALC_P_RHO_PHI'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='997'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_p_rho_phi</font> ( moist, n_moist, hypsometric_opt,      &amp; <A href='../../call_to/CALC_P_RHO_PHI.html' TARGET='index'>2</A>,<A href='../../call_from/CALC_P_RHO_PHI.html' TARGET='index'>2</A><a name='998'>
                            al, alb, mu, muts,                    &amp;<a name='999'>
                            c1, c2, c3h, c4h, c3f, c4f,           &amp;<a name='1000'>
                            ph, phb, p, pb,                       &amp;<a name='1001'>
                            t, p0, t0, ptop, znu, znw, dnw, rdnw, &amp;<a name='1002'>
                            rdn, non_hydrostatic,          &amp;<a name='1003'>
                            ids, ide, jds, jde, kds, kde,  &amp;<a name='1004'>
                            ims, ime, jms, jme, kms, kme,  &amp;<a name='1005'>
                            its, ite, jts, jte, kts, kte  )<a name='1006'>
<a name='1007'>
  IMPLICIT NONE<a name='1008'>
   <a name='1009'>
   <font color=#447700>! Input data<a name='1010'></font>
<a name='1011'>
  LOGICAL ,          INTENT(IN   ) :: non_hydrostatic<a name='1012'>
<a name='1013'>
  INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1014'>
                                      ims, ime, jms, jme, kms, kme, &amp;<a name='1015'>
                                      its, ite, jts, jte, kts, kte <a name='1016'>
<a name='1017'>
  INTEGER ,          INTENT(IN   ) :: n_moist<a name='1018'>
  INTEGER ,          INTENT(IN   ) :: hypsometric_opt<a name='1019'>
<a name='1020'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(IN   ) :: alb,  &amp;<a name='1021'>
                                                                   pb,   &amp;<a name='1022'>
                                                                   t<a name='1023'>
<a name='1024'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme, n_moist ), INTENT(IN   ) :: moist<a name='1025'>
<a name='1026'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(  OUT) :: al, p<a name='1027'>
<a name='1028'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), INTENT(INOUT) :: ph, phb<a name='1029'>
<a name='1030'>
  REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN   ) :: mu, muts<a name='1031'>
<a name='1032'>
  REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: znu, znw, dnw, rdnw, rdn<a name='1033'>
<a name='1034'>
  REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: c1, c2, c3h, c4h, c3f, c4f<a name='1035'>
<a name='1036'>
  REAL,   INTENT(IN   ) :: t0, p0, ptop<a name='1037'>
<a name='1038'>
  <font color=#447700>! Local stuff<a name='1039'></font>
<a name='1040'>
  INTEGER :: i, j, k, kk, itf, jtf, ktf, ispe<a name='1041'>
  REAL    :: qvf, qtot, qf1, qf2<a name='1042'>
  REAL, DIMENSION( its:ite) :: temp,cpovcv_v<a name='1043'>
  REAL    :: pfu, phm, pfd<a name='1044'>
<a name='1045'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1046'></font>
<font color=#447700>!<a name='1047'></font>
<font color=#447700>! For the nonhydrostatic option, calc_p_rho_phi calculates the<a name='1048'></font>
<font color=#447700>! diagnostic quantities pressure and (inverse) density from the<a name='1049'></font>
<font color=#447700>! prognostic variables using the equation of state.<a name='1050'></font>
<font color=#447700>!<a name='1051'></font>
<font color=#447700>! For the hydrostatic option, calc_p_rho_phi calculates the<a name='1052'></font>
<font color=#447700>! diagnostic quantities (inverse) density and geopotential from the<a name='1053'></font>
<font color=#447700>! prognostic variables using the equation of state and the hydrostatic <a name='1054'></font>
<font color=#447700>! equation.<a name='1055'></font>
<font color=#447700>!<a name='1056'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1057'></font>
<a name='1058'>
  itf=MIN(ite,ide-1)<a name='1059'>
  jtf=MIN(jte,jde-1)<a name='1060'>
  ktf=MIN(kte,kde-1)<a name='1061'>
<a name='1062'>
#ifndef INTELMKL<a name='1063'>
  cpovcv_v = cpovcv<a name='1064'>
#endif<a name='1065'>
<a name='1066'>
  IF (non_hydrostatic) THEN<a name='1067'>
<a name='1068'>
      IF (hypsometric_opt == 1) THEN<a name='1069'>
        DO j=jts,jtf<a name='1070'>
        DO k=kts,ktf<a name='1071'>
        DO i=its,itf<a name='1072'>
          al(i,k,j)=-1./muts(i,j)*(alb(i,k,j)*mu(i,j) + rdnw(k)*(ph(i,k+1,j)-ph(i,k,j)))<a name='1073'>
        END DO<a name='1074'>
        END DO<a name='1075'>
        END DO<a name='1076'>
      ELSE IF (hypsometric_opt == 2) THEN<a name='1077'>
<a name='1078'>
        <font color=#447700>! The relation used to get specific volume, al, is: al = -dZ/dp,<a name='1079'></font>
        <font color=#447700>! where dp = mut * d(eta). The pressure depth, dp, is replaced with<a name='1080'></font>
        <font color=#447700>! p*(dp/p) ~ p*LOG((p+0.5dp)/(p-0.5dp)). Difference between dp and p*dLOG(p)<a name='1081'></font>
        <font color=#447700>! is as follows: p*dLOG(p) - dp = 1/12*(dp/p)**3 + 1/90*(dp/p)**5 + ...<a name='1082'></font>
        <font color=#447700>! Therefore, p*dLOG(p) is always larger than dp and the difference is<a name='1083'></font>
        <font color=#447700>! in proportion to dp/p. TKW, 02/16/2010<a name='1084'></font>
<a name='1085'>
        DO j=jts,jtf<a name='1086'>
        DO k=kts,ktf<a name='1087'>
        DO i=its,itf<a name='1088'>
#if  <font color=#447700>!( HYBRID_COORD==1 ) <a name='1089'></font>
          pfu = muts(i,j)*znw(k+1)+ptop<a name='1090'>
          pfd = muts(i,j)*znw(k)  +ptop<a name='1091'>
          phm = muts(i,j)*znu(k)  +ptop<a name='1092'>
#elif ( HYBRID_COORD==1 ) <a name='1093'>
          pfu = c3f(k+1)*MUTS(i,j) + c4f(k+1) + ptop<a name='1094'>
          pfd = c3f(k  )*MUTS(i,j) + c4f(k  ) + ptop<a name='1095'>
          phm = c3h(k  )*MUTS(i,j) + c4h(k  ) + ptop<a name='1096'>
#endif<a name='1097'>
          al(i,k,j) = (ph(i,k+1,j)-ph(i,k,j)+phb(i,k+1,j)-phb(i,k,j))/phm/LOG(pfd/pfu)-alb(i,k,j)<a name='1098'>
        END DO<a name='1099'>
        END DO<a name='1100'>
        END DO<a name='1101'>
      ELSE<a name='1102'>
        CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_13"> ( 'calc_p_rho_phi: hypsometric_opt should be 1 or 2' )<a name='1103'>
      END IF<a name='1104'>
<a name='1105'>
      IF (n_moist &gt;= PARAM_FIRST_SCALAR ) THEN  <a name='1106'>
<a name='1107'>
        DO j=jts,jtf<a name='1108'>
        DO k=kts,ktf<a name='1109'>
        DO i=its,itf<a name='1110'>
          qvf = 1.+rvovrd*moist(i,k,j,P_QV)<a name='1111'>
          temp(i)=(r_d*(t0+t(i,k,j))*qvf)/(p0*(al(i,k,j)+alb(i,k,j)))<a name='1112'>
        ENDDO<a name='1113'>
#ifdef INTELMKL<a name='1114'>
        CALL VPOWX ( itf-its+1, temp(its), cpovcv, p(its,k,j) )<a name='1115'>
#else<a name='1116'>
<font color=#447700>! use vector version from libmassv or from compat lib in frame/libmassv.F<a name='1117'></font>
        CALL <A href='../../html_code/frame/libmassv.F.html#VPOW'>VPOW</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VPOW_1">  ( p(its,k,j), temp(its), cpovcv_v(its), itf-its+1 )<a name='1118'>
#endif<a name='1119'>
        DO i=its,itf<a name='1120'>
           p(i,k,j)= p(i,k,j)*p0-pb(i,k,j)<a name='1121'>
        ENDDO<a name='1122'>
        ENDDO<a name='1123'>
        ENDDO<a name='1124'>
<a name='1125'>
      ELSE<a name='1126'>
<a name='1127'>
        DO j=jts,jtf<a name='1128'>
        DO k=kts,ktf<a name='1129'>
        DO i=its,itf<a name='1130'>
          p(i,k,j)=p0*( (r_d*(t0+t(i,k,j)))/                     &amp;<a name='1131'>
                        (p0*(al(i,k,j)+alb(i,k,j))) )**cpovcv  &amp;<a name='1132'>
                           -pb(i,k,j)<a name='1133'>
        ENDDO<a name='1134'>
        ENDDO<a name='1135'>
        ENDDO<a name='1136'>
<a name='1137'>
      END IF<a name='1138'>
<a name='1139'>
   ELSE<a name='1140'>
<a name='1141'>
<font color=#447700>!  hydrostatic pressure, al, and ph1 calc; WCS, 5 sept 2001<a name='1142'></font>
<a name='1143'>
<a name='1144'>
      IF (n_moist &gt;= PARAM_FIRST_SCALAR ) THEN  <a name='1145'>
<a name='1146'>
        DO j=jts,jtf<a name='1147'>
<a name='1148'>
          k=ktf          <font color=#447700>! top layer<a name='1149'></font>
          DO i=its,itf<a name='1150'>
<a name='1151'>
            qtot = 0.<a name='1152'>
            DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='1153'>
              qtot = qtot + moist(i,k,j,ispe)<a name='1154'>
            ENDDO<a name='1155'>
            qf2 = 1.<a name='1156'>
            qf1 = qtot*qf2<a name='1157'>
<a name='1158'>
            p(i,k,j) = - 0.5*(mu(i,j)+qf1*muts(i,j))/rdnw(k)/qf2<a name='1159'>
            qvf = 1.+rvovrd*moist(i,k,j,P_QV)<a name='1160'>
            al(i,k,j) = (r_d/p1000mb)*(t(i,k,j)+t0)*qvf* &amp;<a name='1161'>
                (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm) - alb(i,k,j)<a name='1162'>
<a name='1163'>
          ENDDO<a name='1164'>
<a name='1165'>
          DO k=ktf-1,kts,-1  <font color=#447700>! remaining layers, integrate down<a name='1166'></font>
            DO i=its,itf<a name='1167'>
<a name='1168'>
            qtot = 0.<a name='1169'>
            DO ispe=PARAM_FIRST_SCALAR,n_moist<a name='1170'>
              qtot = qtot + 0.5*(  moist(i,k  ,j,ispe) + moist(i,k+1,j,ispe) )<a name='1171'>
            ENDDO<a name='1172'>
            qf2 = 1.<a name='1173'>
            qf1 = qtot*qf2<a name='1174'>
<a name='1175'>
            p(i,k,j) = p(i,k+1,j) - (mu(i,j) + qf1*muts(i,j))/qf2/rdn(k+1)<a name='1176'>
            qvf = 1.+rvovrd*moist(i,k,j,P_QV)<a name='1177'>
            al(i,k,j) = (r_d/p1000mb)*(t(i,k,j)+t0)*qvf* &amp;<a name='1178'>
                        (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm) - alb(i,k,j)<a name='1179'>
            ENDDO<a name='1180'>
          ENDDO<a name='1181'>
<a name='1182'>
        ENDDO<a name='1183'>
<a name='1184'>
      ELSE<a name='1185'>
<a name='1186'>
        DO j=jts,jtf<a name='1187'>
<a name='1188'>
          k=ktf          <font color=#447700>! top layer<a name='1189'></font>
          DO i=its,itf<a name='1190'>
<a name='1191'>
            qtot = 0.<a name='1192'>
            qf2 = 1.<a name='1193'>
            qf1 = qtot*qf2<a name='1194'>
<a name='1195'>
            p(i,k,j) = - 0.5*(mu(i,j)+qf1*muts(i,j))/rdnw(k)/qf2<a name='1196'>
            qvf = 1.<a name='1197'>
            al(i,k,j) = (r_d/p1000mb)*(t(i,k,j)+t0)*qvf* &amp;<a name='1198'>
                (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm) - alb(i,k,j)<a name='1199'>
<a name='1200'>
          ENDDO<a name='1201'>
<a name='1202'>
          DO k=ktf-1,kts,-1  <font color=#447700>! remaining layers, integrate down<a name='1203'></font>
            DO i=its,itf<a name='1204'>
<a name='1205'>
            qtot = 0.<a name='1206'>
            qf2 = 1.<a name='1207'>
            qf1 = qtot*qf2<a name='1208'>
<a name='1209'>
            p(i,k,j) = p(i,k+1,j) - (mu(i,j) + qf1*muts(i,j))/qf2/rdn(k+1)<a name='1210'>
            qvf = 1.<a name='1211'>
            al(i,k,j) = (r_d/p1000mb)*(t(i,k,j)+t0)*qvf* &amp;<a name='1212'>
                        (((p(i,k,j)+pb(i,k,j))/p1000mb)**cvpm) - alb(i,k,j)<a name='1213'>
            ENDDO<a name='1214'>
          ENDDO<a name='1215'>
<a name='1216'>
        ENDDO<a name='1217'>
<a name='1218'>
     END IF<a name='1219'>
<a name='1220'>
     IF (hypsometric_opt == 1) THEN<a name='1221'>
        DO j=jts,jtf<a name='1222'>
          DO kk=2,ktf+1  <font color=#447700>! integrate hydrostatic equation for geopotential<a name='1223'></font>
            k = kk-1<a name='1224'>
            DO i=its,itf<a name='1225'>
              ph(i,k+1,j) = ph(i,k,j) - (dnw(k))*(           &amp;<a name='1226'>
                           (muts(i,j))*al(i,k,j)+            &amp;<a name='1227'>
                            mu(i,j)*alb(i,k,j)  )<a name='1228'>
            ENDDO<a name='1229'>
          ENDDO<a name='1230'>
        ENDDO<a name='1231'>
     ELSE <a name='1232'>
<a name='1233'>
     <font color=#447700>! Revised hypsometric eq.: dZ=-al*p*dLOG(p), where p is dry pressure<a name='1234'></font>
<a name='1235'>
      DO j=jts,jtf<a name='1236'>
        DO i=its,itf<a name='1237'>
           ph(i,kts,j) = phb(i,kts,j)<a name='1238'>
        END DO<a name='1239'>
<a name='1240'>
        DO k=kts+1,ktf+1<a name='1241'>
          DO i=its,itf<a name='1242'>
#if  <font color=#447700>!( HYBRID_COORD==1 ) <a name='1243'></font>
            pfu = muts(i,j)*znw(k)  +ptop<a name='1244'>
            pfd = muts(i,j)*znw(k-1)+ptop<a name='1245'>
            phm = muts(i,j)*znu(k-1)+ptop<a name='1246'>
#elif ( HYBRID_COORD==1 ) <a name='1247'>
            pfu = c3f(k  )*MUTS(i,j) + c4f(k  ) + ptop<a name='1248'>
            pfd = c3f(k-1)*MUTS(i,j) + c4f(k-1) + ptop<a name='1249'>
            phm = c3h(k-1)*MUTS(i,j) + c4h(k-1) + ptop<a name='1250'>
#endif<a name='1251'>
            ph(i,k,j) = ph(i,k-1,j) + (al(i,k-1,j)+alb(i,k-1,j))*phm*LOG(pfd/pfu)<a name='1252'>
          ENDDO<a name='1253'>
        ENDDO<a name='1254'>
<a name='1255'>
        DO k=kts,ktf+1<a name='1256'>
          DO i=its,itf<a name='1257'>
             ph(i,k,j) = ph(i,k,j) - phb(i,k,j)<a name='1258'>
          END DO<a name='1259'>
        END DO<a name='1260'>
      END DO<a name='1261'>
<a name='1262'>
     END IF<a name='1263'>
<a name='1264'>
   END IF<a name='1265'>
<a name='1266'>
END SUBROUTINE calc_p_rho_phi<a name='1267'>
<a name='1268'>
<font color=#447700>!----------------------------------------------------------------------<a name='1269'></font>
<a name='1270'>
<A NAME='CALC_PHP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_PHP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1271'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_php</font> ( php, ph, phb,                  &amp; <A href='../../call_to/CALC_PHP.html' TARGET='index'>1</A><a name='1272'>
                      ids, ide, jds, jde, kds, kde,  &amp;<a name='1273'>
                      ims, ime, jms, jme, kms, kme,  &amp;<a name='1274'>
                      its, ite, jts, jte, kts, kte  )<a name='1275'>
<a name='1276'>
   IMPLICIT NONE<a name='1277'>
   <a name='1278'>
   <font color=#447700>! Input data<a name='1279'></font>
<a name='1280'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1281'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='1282'>
                                       its, ite, jts, jte, kts, kte <a name='1283'>
<a name='1284'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) :: phb, ph<a name='1285'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(  OUT) :: php<a name='1286'>
<a name='1287'>
   <font color=#447700>! Local stuff<a name='1288'></font>
<a name='1289'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='1290'>
<a name='1291'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1292'></font>
<font color=#447700>!<a name='1293'></font>
<font color=#447700>!  calc_php calculates the full geopotential from the reference state<a name='1294'></font>
<font color=#447700>!  geopotential and the perturbation geopotential (phb_ph).<a name='1295'></font>
<font color=#447700>!<a name='1296'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1297'></font>
<a name='1298'>
      itf=MIN(ite,ide-1)<a name='1299'>
      jtf=MIN(jte,jde-1)<a name='1300'>
      ktf=MIN(kte,kde-1)<a name='1301'>
<a name='1302'>
      DO j=jts,jtf<a name='1303'>
      DO k=kts,ktf<a name='1304'>
      DO i=its,itf<a name='1305'>
        php(i,k,j) = 0.5*(phb(i,k,j)+phb(i,k+1,j)+ph(i,k,j)+ph(i,k+1,j))<a name='1306'>
      ENDDO<a name='1307'>
      ENDDO<a name='1308'>
      ENDDO<a name='1309'>
<a name='1310'>
END SUBROUTINE calc_php<a name='1311'>
<a name='1312'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1313'></font>
<a name='1314'>
<A NAME='DIAGNOSE_W'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1315'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>diagnose_w</font>( ph_tend, ph_new, ph_old, w, mut,     &amp; <A href='../../call_to/DIAGNOSE_W.html' TARGET='index'>2</A><a name='1316'>
                       c1f, c2f, dt,                        &amp;<a name='1317'>
                       u, v, ht,                            &amp;<a name='1318'>
                       cf1, cf2, cf3, rdx, rdy,             &amp;<a name='1319'>
                       msftx, msfty,                        &amp;<a name='1320'>
                       ids, ide, jds, jde, kds, kde,        &amp;<a name='1321'>
                       ims, ime, jms, jme, kms, kme,        &amp;<a name='1322'>
                       its, ite, jts, jte, kts, kte        )<a name='1323'>
<a name='1324'>
   IMPLICIT NONE<a name='1325'>
<a name='1326'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1327'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='1328'>
                                       its, ite, jts, jte, kts, kte <a name='1329'>
<a name='1330'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::   ph_tend, &amp;<a name='1331'>
                                                                     ph_new,  &amp;<a name='1332'>
                                                                     ph_old,  &amp;<a name='1333'>
                                                                     u,       &amp;<a name='1334'>
                                                                     v<a name='1335'>
<a name='1336'>
<a name='1337'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(  OUT) :: w<a name='1338'>
<a name='1339'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: mut, ht, msftx, msfty<a name='1340'>
<a name='1341'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: c1f, c2f<a name='1342'>
<a name='1343'>
   REAL, INTENT(IN   ) :: dt, cf1, cf2, cf3, rdx, rdy<a name='1344'>
<a name='1345'>
   INTEGER :: i, j, k, itf, jtf<a name='1346'>
<a name='1347'>
   itf=MIN(ite,ide-1)<a name='1348'>
   jtf=MIN(jte,jde-1)<a name='1349'>
<a name='1350'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1351'></font>
<font color=#447700>!<a name='1352'></font>
<font color=#447700>! diagnose_w diagnoses the vertical velocity from the geopoential equation.<a name='1353'></font>
<font color=#447700>! Used with the hydrostatic option.<a name='1354'></font>
<font color=#447700>!<a name='1355'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1356'></font>
<a name='1357'>
   DO j = jts, jtf<a name='1358'>
<a name='1359'>
<font color=#447700>!  lower b.c. on w<a name='1360'></font>
<a name='1361'>
<font color=#447700>!  Notes on map scale factors:<a name='1362'></font>
<font color=#447700>!  Chain rule: if Z=Z(X,Y) [true at the surface] then<a name='1363'></font>
<font color=#447700>!  dZ/dt = dZ/dX * dX/dt + dZ/dY * dY/dt, U=dX/dt, V=dY/dt<a name='1364'></font>
<font color=#447700>!  Using capitals to denote actual values<a name='1365'></font>
<font color=#447700>!  In mapped values, u=U, v=V, z=Z, 1/dX=mx/dx, 1/dY=my/dy<a name='1366'></font>
<font color=#447700>!    =&gt; w = dz/dt = mx u dz/dx + my v dz/dy<a name='1367'></font>
<font color=#447700>!  [where dz/dx is just the surface height change between x<a name='1368'></font>
<font color=#447700>!   gridpoints, and dz/dy is the change between y gridpoints]<a name='1369'></font>
<font color=#447700>!  [NB: cf1, cf2 and cf3 do vertical weighting of u or v values<a name='1370'></font>
<font color=#447700>!   nearest the surface]<a name='1371'></font>
<a name='1372'>
<font color=#447700>!  Previously msft multiplied by rdy and rdx terms.<a name='1373'></font>
<font color=#447700>!  Now msfty multiplies rdy term, and msftx multiplies msftx term<a name='1374'></font>
     DO i = its, itf<a name='1375'>
         w(i,1,j)=  msfty(i,j)*.5*rdy*(                      &amp;<a name='1376'>
                           (ht(i,j+1)-ht(i,j  ))             &amp;<a name='1377'>
          *(cf1*v(i,1,j+1)+cf2*v(i,2,j+1)+cf3*v(i,3,j+1))    &amp;<a name='1378'>
                          +(ht(i,j  )-ht(i,j-1))             &amp;<a name='1379'>
          *(cf1*v(i,1,j  )+cf2*v(i,2,j  )+cf3*v(i,3,j  ))  ) &amp;<a name='1380'>
                 +msftx(i,j)*.5*rdx*(                        &amp;<a name='1381'>
                           (ht(i+1,j)-ht(i,j  ))             &amp;<a name='1382'>
          *(cf1*u(i+1,1,j)+cf2*u(i+1,2,j)+cf3*u(i+1,3,j))    &amp;<a name='1383'>
                          +(ht(i,j  )-ht(i-1,j))             &amp;<a name='1384'>
          *(cf1*u(i  ,1,j)+cf2*u(i  ,2,j)+cf3*u(i  ,3,j))  )<a name='1385'>
     ENDDO<a name='1386'>
<a name='1387'>
<font color=#447700>!  use geopotential equation to diagnose w<a name='1388'></font>
<a name='1389'>
<font color=#447700>!  Further notes on map scale factors<a name='1390'></font>
<font color=#447700>!  If ph_tend contains:  -mx partial d/dx(mu rho u/my) <a name='1391'></font>
<font color=#447700>!                        -mx partial d/dy(phi mu v/mx)<a name='1392'></font>
<font color=#447700>!                        -partial d/dz(phi mu w/my)<a name='1393'></font>
<font color=#447700>!  then phi eqn is: partial d/dt(mu phi/my) = ph_tend + mu g w/my<a name='1394'></font>
<font color=#447700>!    =&gt; w = [my/(mu*g)]*[partial d/dt(mu phi/my) - ph_tend]<a name='1395'></font>
<a name='1396'>
     DO k = 2, kte<a name='1397'>
     DO i = its, itf<a name='1398'>
       w(i,k,j) =  msfty(i,j)*(  (ph_new(i,k,j)-ph_old(i,k,j))/dt       &amp;<a name='1399'>
                               - ph_tend(i,k,j)/mut(i,j)        )/g <a name='1400'>
<a name='1401'>
     ENDDO<a name='1402'>
     ENDDO<a name='1403'>
<a name='1404'>
   ENDDO<a name='1405'>
<a name='1406'>
END SUBROUTINE diagnose_w<a name='1407'>
<a name='1408'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1409'></font>
<a name='1410'>
<A NAME='RHS_PH'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#RHS_PH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1411'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>rhs_ph</font>( ph_tend, u, v, ww,               &amp; <A href='../../call_to/RHS_PH.html' TARGET='index'>1</A><a name='1412'>
                   ph, ph_old, phb, w,              &amp;<a name='1413'>
                   mut, muuf, muvf,                 &amp;<a name='1414'>
                   c1f, c2f,                        &amp;<a name='1415'>
                   fnm, fnp,                        &amp;<a name='1416'>
                   rdnw, cfn, cfn1, rdx, rdy,       &amp;<a name='1417'>
                   msfux, msfuy, msfvx,             &amp;<a name='1418'>
                   msfvx_inv, msfvy,                &amp;<a name='1419'>
                   msftx, msfty,                    &amp;<a name='1420'>
                   non_hydrostatic,                 &amp;<a name='1421'>
                   config_flags,                    &amp;<a name='1422'>
                   ids, ide, jds, jde, kds, kde,    &amp;<a name='1423'>
                   ims, ime, jms, jme, kms, kme,    &amp;<a name='1424'>
                   its, ite, jts, jte, kts, kte    )<a name='1425'>
   IMPLICIT NONE<a name='1426'>
<a name='1427'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1428'>
<a name='1429'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1430'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='1431'>
                                       its, ite, jts, jte, kts, kte <a name='1432'>
<a name='1433'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::        &amp;<a name='1434'>
                                                                     u,   &amp;<a name='1435'>
                                                                     v,   &amp;<a name='1436'>
                                                                     ww,  &amp;<a name='1437'>
                                                                     ph,  &amp;<a name='1438'>
                                                                     ph_old, &amp;<a name='1439'>
                                                                     phb, &amp; <a name='1440'>
                                                                    w<a name='1441'>
<a name='1442'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) :: ph_tend<a name='1443'>
<a name='1444'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: muuf, muvf, mut,   &amp;<a name='1445'>
                                                            msfux, msfuy, &amp;<a name='1446'>
                                                            msfvx, msfvy, &amp;<a name='1447'>
                                                            msftx, msfty, &amp;<a name='1448'>
                                                            msfvx_inv<a name='1449'>
<a name='1450'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: rdnw, fnm, fnp<a name='1451'>
<a name='1452'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: c1f, c2f<a name='1453'>
   <a name='1454'>
<a name='1455'>
   REAL,  INTENT(IN   ) :: cfn, cfn1, rdx, rdy<a name='1456'>
<a name='1457'>
   LOGICAL,  INTENT(IN   )  ::  non_hydrostatic<a name='1458'>
<a name='1459'>
   <font color=#447700>! Local stuff<a name='1460'></font>
<a name='1461'>
   INTEGER :: i, j, k, itf, jtf, ktf, kz, i_start, j_start<a name='1462'>
   REAL    :: ur, ul, ub, vr, vl, vb<a name='1463'>
   REAL, DIMENSION(its:ite,kts:kte) :: wdwn<a name='1464'>
<a name='1465'>
   INTEGER :: advective_order<a name='1466'>
<a name='1467'>
   LOGICAL :: specified<a name='1468'>
<a name='1469'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1470'></font>
<font color=#447700>!<a name='1471'></font>
<font color=#447700>! rhs_ph calculates the large-timestep tendency terms for the geopotential<a name='1472'></font>
<font color=#447700>! equation.  These terms include the advection and "gw".  The geopotential<a name='1473'></font>
<font color=#447700>! equation is cast in advective form, so we don't use the flux form advection<a name='1474'></font>
<font color=#447700>! algorithms here.<a name='1475'></font>
<font color=#447700>!<a name='1476'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1477'></font>
<a name='1478'>
   specified = .false.<a name='1479'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='1480'>
<a name='1481'>
   advective_order = config_flags%h_sca_adv_order <a name='1482'>
<a name='1483'>
   itf=MIN(ite,ide-1)<a name='1484'>
   jtf=MIN(jte,jde-1)<a name='1485'>
   ktf=MIN(kte,kde-1)<a name='1486'>
<a name='1487'>
<font color=#447700>!  Notes on map scale factors (WCS, 2 march 2008)<a name='1488'></font>
<font color=#447700>!  phi equation is:   mu/my d/dt(phi) = -(1/my) mx mu u  d/dx(phi)<a name='1489'></font>
<font color=#447700>!                                       -(1/my) my mu v d/dy(phi)<a name='1490'></font>
<font color=#447700>!                                       - omega d/d_eta(phi)<a name='1491'></font>
<font color=#447700>!                                               +mu g w/my<a name='1492'></font>
<font color=#447700>!<a name='1493'></font>
<font color=#447700>!  A little further explanation...<a name='1494'></font>
<font color=#447700>!  The tendency term we are computing here is for mu/my d/dt(phi).  It is advective form <a name='1495'></font>
<font color=#447700>!  but it is multiplied be mu/my.  It will be decoupled from (mu/my) when the implicit w-phi<a name='1496'></font>
<font color=#447700>!  solution is computed in subourine advance_w.  The formulation dates from the early <a name='1497'></font>
<font color=#447700>!  days of the mass coordinate model when we were testing both a flux and an advective formulation<a name='1498'></font>
<font color=#447700>!  for the geopotential equation and different forms of the vertical momentum equation and the <a name='1499'></font>
<font color=#447700>!  vertically implicit solver.<a name='1500'></font>
<a name='1501'>
<font color=#447700>! advective form for the geopotential equation<a name='1502'></font>
<a name='1503'>
   DO j = jts, jtf<a name='1504'>
<a name='1505'>
     DO k = 2, kte<a name='1506'>
     DO i = its, itf<a name='1507'>
          wdwn(i,k) = .5*(ww(i,k,j)+ww(i,k-1,j))*rdnw(k-1)               &amp;<a name='1508'>
                        *(ph(i,k,j)-ph(i,k-1,j)+phb(i,k,j)-phb(i,k-1,j))<a name='1509'>
     ENDDO<a name='1510'>
     ENDDO<a name='1511'>
<a name='1512'>
<font color=#447700>!  RHS term 3 is: - omega partial d/dnu(phi)<a name='1513'></font>
<a name='1514'>
     DO k = 2, kte-1<a name='1515'>
     DO i = its, itf<a name='1516'>
           ph_tend(i,k,j) = ph_tend(i,k,j)                           &amp;<a name='1517'>
                             - (fnm(k)*wdwn(i,k+1)+fnp(k)*wdwn(i,k))<a name='1518'>
     ENDDO<a name='1519'>
     ENDDO<a name='1520'>
<a name='1521'>
   ENDDO<a name='1522'>
<a name='1523'>
   IF (non_hydrostatic) THEN  <font color=#447700>! add in "gw" term.<a name='1524'></font>
   DO j = jts, jtf            <font color=#447700>! in hydrostatic mode, "gw" will be diagnosed<a name='1525'></font>
                              <font color=#447700>! after the timestep to give us "w"<a name='1526'></font>
     DO i = its, itf<a name='1527'>
        ph_tend(i,kde,j) = 0.<a name='1528'>
     ENDDO<a name='1529'>
<a name='1530'>
     DO k = 2, kte<a name='1531'>
     DO i = its, itf<a name='1532'>
        <font color=#447700>! phi equation RHS term 4<a name='1533'></font>
        ph_tend(i,k,j) = ph_tend(i,k,j) + mut(i,j)*g*w(i,k,j)/msfty(i,j)<a name='1534'>
     ENDDO<a name='1535'>
     ENDDO<a name='1536'>
<a name='1537'>
   ENDDO<a name='1538'>
<a name='1539'>
   END IF<a name='1540'>
<a name='1541'>
<font color=#447700>!  Notes on map scale factors:<a name='1542'></font>
<font color=#447700>!  RHS terms 1 and 2 are: -(1/my) mx u mu partial d/dx(phi)<a name='1543'></font>
<font color=#447700>!                         -(1/my) my v mu partial d/dy(phi)<a name='1544'></font>
<a name='1545'>
   IF (advective_order &lt;= 2) THEN<a name='1546'>
<a name='1547'>
<font color=#447700>!  y (v) advection<a name='1548'></font>
<a name='1549'>
   i_start = its<a name='1550'>
   j_start = jts<a name='1551'>
   itf=MIN(ite,ide-1)<a name='1552'>
   jtf=MIN(jte,jde-1)<a name='1553'>
<a name='1554'>
   IF ( (config_flags%open_ys .or. specified) .and. jts == jds ) j_start = jts+1<a name='1555'>
   IF ( (config_flags%open_ye .or. specified) .and. jte == jde ) jtf = jtf-2<a name='1556'>
<a name='1557'>
   DO j = j_start, jtf<a name='1558'>
<a name='1559'>
     DO k = 2, kte-1<a name='1560'>
     DO i = i_start, itf<a name='1561'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))*          &amp;<a name='1562'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)*   &amp;<a name='1563'>
                  (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))   &amp;<a name='1564'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j  )*   &amp;<a name='1565'>
                  (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1)) )<a name='1566'>
     ENDDO<a name='1567'>
     ENDDO<a name='1568'>
<a name='1569'>
     k = kte<a name='1570'>
     DO i = i_start, itf<a name='1571'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))*                        &amp;<a name='1572'>
                  ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)*    &amp;<a name='1573'>
                   (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))               &amp;<a name='1574'>
                   +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j  )*    &amp;<a name='1575'>
                   (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1))              )<a name='1576'>
     ENDDO<a name='1577'>
<a name='1578'>
   ENDDO<a name='1579'>
<a name='1580'>
<font color=#447700>!  x (u) advection<a name='1581'></font>
<a name='1582'>
   i_start = its<a name='1583'>
   j_start = jts<a name='1584'>
   itf=MIN(ite,ide-1)<a name='1585'>
   jtf=MIN(jte,jde-1)<a name='1586'>
<a name='1587'>
   IF ( (config_flags%open_xs .or. specified) .and. its == ids ) i_start = its+1<a name='1588'>
   IF ( (config_flags%open_xe .or. specified) .and. ite == ide ) itf = itf-2<a name='1589'>
<a name='1590'>
   DO j = j_start, jtf<a name='1591'>
<a name='1592'>
     DO k = 2, kte-1<a name='1593'>
     DO i = i_start, itf<a name='1594'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*         &amp;<a name='1595'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)*  &amp;<a name='1596'>
                  (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))  &amp;<a name='1597'>
                  +muuf(i  ,j)*(u(i  ,k,j)+u(i  ,k-1,j))*msfux(i  ,j)*  &amp;<a name='1598'>
                  (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))  )<a name='1599'>
     ENDDO<a name='1600'>
     ENDDO<a name='1601'>
 <a name='1602'>
     k = kte<a name='1603'>
     DO i = i_start, itf<a name='1604'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*                        &amp;<a name='1605'>
                  ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)*    &amp;<a name='1606'>
                   (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))               &amp;<a name='1607'>
                   +muuf(i  ,j)*(cfn*u(i  ,k-1,j)+cfn1*u(i  ,k-2,j))*msfux(  i,j)*    &amp;<a name='1608'>
                   (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))             )<a name='1609'>
     ENDDO<a name='1610'>
<a name='1611'>
   ENDDO<a name='1612'>
<a name='1613'>
   ELSE IF (advective_order &lt;= 4) THEN<a name='1614'>
<a name='1615'>
<font color=#447700>!  y (v) advection<a name='1616'></font>
<a name='1617'>
   i_start = its<a name='1618'>
   j_start = jts<a name='1619'>
   itf=MIN(ite,ide-1)<a name='1620'>
   jtf=MIN(jte,jde-1)<a name='1621'>
<a name='1622'>
   IF ( (config_flags%open_ys .or. specified) .and. jts == jds ) j_start = jts+2<a name='1623'>
   IF ( (config_flags%open_ye .or. specified) .and. jte == jde ) jtf = jtf-3<a name='1624'>
<a name='1625'>
   DO j = j_start, jtf<a name='1626'>
<a name='1627'>
     DO k = 2, kte-1<a name='1628'>
     DO i = i_start, itf<a name='1629'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))*(                     &amp;<a name='1630'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)                &amp;<a name='1631'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j  ))* (1./12.)*(   &amp;<a name='1632'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                    &amp;<a name='1633'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                    &amp;<a name='1634'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                                  &amp;<a name='1635'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1636'>
<a name='1637'>
<a name='1638'>
     ENDDO<a name='1639'>
     ENDDO<a name='1640'>
<a name='1641'>
     k = kte<a name='1642'>
     DO i = i_start, itf<a name='1643'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))*(                                 &amp;<a name='1644'>
                 ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)                &amp;<a name='1645'>
                  +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j  ))* (1./12.)*(   &amp;<a name='1646'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                               &amp;<a name='1647'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                               &amp;<a name='1648'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                                             &amp;<a name='1649'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1650'>
<a name='1651'>
     ENDDO<a name='1652'>
<a name='1653'>
   ENDDO<a name='1654'>
<a name='1655'>
<font color=#447700>!  pick up near boundary rows using 2nd order stencil for open and specified conditions<a name='1656'></font>
<a name='1657'>
   IF ( (config_flags%open_ys .or. specified) .and. jts &lt;= jds+1 )  THEN<a name='1658'>
<a name='1659'>
     j = jds+1<a name='1660'>
     DO k = 2, kte-1<a name='1661'>
     DO i = i_start, itf<a name='1662'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))*          &amp;<a name='1663'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)*   &amp;<a name='1664'>
                  (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))   &amp;<a name='1665'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j  )*   &amp;<a name='1666'>
                  (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1)) )<a name='1667'>
     ENDDO<a name='1668'>
     ENDDO<a name='1669'>
<a name='1670'>
     k = kte<a name='1671'>
     DO i = i_start, itf<a name='1672'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))*                        &amp;<a name='1673'>
                  ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)*    &amp;<a name='1674'>
                   (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))               &amp;<a name='1675'>
                   +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j  )*    &amp;<a name='1676'>
                   (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1))              )<a name='1677'>
     ENDDO<a name='1678'>
<a name='1679'>
   END IF<a name='1680'>
<a name='1681'>
   IF ( (config_flags%open_ye .or. specified) .and. jte &gt;= jde-2 )  THEN<a name='1682'>
<a name='1683'>
     j = jde-2<a name='1684'>
     DO k = 2, kte-1<a name='1685'>
     DO i = i_start, itf<a name='1686'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))*          &amp;<a name='1687'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)*   &amp;<a name='1688'>
                  (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))   &amp;<a name='1689'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j  )*   &amp;<a name='1690'>
                  (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1)) )<a name='1691'>
     ENDDO<a name='1692'>
     ENDDO<a name='1693'>
<a name='1694'>
     k = kte<a name='1695'>
     DO i = i_start, itf<a name='1696'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))*                        &amp;<a name='1697'>
                  ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)*    &amp;<a name='1698'>
                   (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))               &amp;<a name='1699'>
                   +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j  )*    &amp;<a name='1700'>
                   (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1))              )<a name='1701'>
     ENDDO<a name='1702'>
<a name='1703'>
   END IF<a name='1704'>
<a name='1705'>
<font color=#447700>!  x (u) advection<a name='1706'></font>
<a name='1707'>
   i_start = its<a name='1708'>
   j_start = jts<a name='1709'>
   itf=MIN(ite,ide-1)<a name='1710'>
   jtf=MIN(jte,jde-1)<a name='1711'>
<a name='1712'>
   IF ( (config_flags%open_xs) .and. its == ids ) i_start = its+2<a name='1713'>
   IF ( (config_flags%open_xe) .and. ite == ide ) itf = itf-3<a name='1714'>
<a name='1715'>
   DO j = j_start, jtf<a name='1716'>
<a name='1717'>
     DO k = 2, kte-1<a name='1718'>
     DO i = i_start, itf<a name='1719'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*(                    &amp;<a name='1720'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)               &amp;<a name='1721'>
                  +muuf(i,j  )*(u(i  ,k,j)+u(i  ,k-1,j))*msfux(i  ,j) )* (1./12.)*( &amp;<a name='1722'>
                    8.*(ph(i+1,k,j)-ph(i-1,k,j))                                   &amp;<a name='1723'>
                      -(ph(i+2,k,j)-ph(i-2,k,j))                                   &amp;<a name='1724'>
                   +8.*(phb(i+1,k,j)-phb(i-1,k,j))                                 &amp;<a name='1725'>
                      -(phb(i+2,k,j)-phb(i-2,k,j))  )   )                <a name='1726'>
     ENDDO<a name='1727'>
     ENDDO<a name='1728'>
 <a name='1729'>
     k = kte<a name='1730'>
     DO i = i_start, itf<a name='1731'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*(                                 &amp;<a name='1732'>
                 ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)                &amp;<a name='1733'>
                  +muuf(i,j  )*(cfn*u(i  ,k-1,j)+cfn1*u(i  ,k-2,j))*msfux(i  ,j) )* (1./12.)*(  &amp;<a name='1734'>
                    8.*(ph(i+1,k,j)-ph(i-1,k,j))                                               &amp;<a name='1735'>
                      -(ph(i+2,k,j)-ph(i-2,k,j))                                               &amp;<a name='1736'>
                   +8.*(phb(i+1,k,j)-phb(i-1,k,j))                                             &amp;<a name='1737'>
                      -(phb(i+2,k,j)-phb(i-2,k,j))  )     )<a name='1738'>
     ENDDO<a name='1739'>
<a name='1740'>
   ENDDO<a name='1741'>
<a name='1742'>
<font color=#447700>!  pick up near boundary rows using 2nd order stencil for open and specified conditions<a name='1743'></font>
<a name='1744'>
   IF ( (config_flags%open_xs .or. specified) .and. its &lt;= ids+1 ) THEN<a name='1745'>
<a name='1746'>
     i = ids + 1<a name='1747'>
<a name='1748'>
     DO j = j_start, jtf<a name='1749'>
     DO k = 2, kte-1<a name='1750'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*         &amp;<a name='1751'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)*  &amp;<a name='1752'>
                  (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))  &amp;<a name='1753'>
                  +muuf(i  ,j)*(u(i  ,k,j)+u(i  ,k-1,j))*msfux(i  ,j)*  &amp;<a name='1754'>
                  (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))  )<a name='1755'>
     ENDDO<a name='1756'>
     ENDDO<a name='1757'>
 <a name='1758'>
     k = kte<a name='1759'>
     DO j = j_start, jtf<a name='1760'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*                        &amp;<a name='1761'>
                  ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)*    &amp;<a name='1762'>
                   (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))               &amp;<a name='1763'>
                   +muuf(i  ,j)*(cfn*u(i  ,k-1,j)+cfn1*u(i  ,k-2,j))*msfux(  i,j)*    &amp;<a name='1764'>
                   (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))             )<a name='1765'>
     ENDDO<a name='1766'>
<a name='1767'>
   END IF<a name='1768'>
<a name='1769'>
   IF ( (config_flags%open_xe .or. specified) .and. ite &gt;= ide-2 ) THEN<a name='1770'>
<a name='1771'>
     i = ide-2<a name='1772'>
     DO j = j_start, jtf<a name='1773'>
     DO k = 2, kte-1<a name='1774'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*         &amp;<a name='1775'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)*  &amp;<a name='1776'>
                  (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))  &amp;<a name='1777'>
                  +muuf(i  ,j)*(u(i  ,k,j)+u(i  ,k-1,j))*msfux(i  ,j)*  &amp;<a name='1778'>
                  (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))  )<a name='1779'>
     ENDDO<a name='1780'>
     ENDDO<a name='1781'>
 <a name='1782'>
     k = kte<a name='1783'>
     DO j = j_start, jtf<a name='1784'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*                        &amp;<a name='1785'>
                  ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)*    &amp;<a name='1786'>
                   (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))               &amp;<a name='1787'>
                   +muuf(i  ,j)*(cfn*u(i  ,k-1,j)+cfn1*u(i  ,k-2,j))*msfux(  i,j)*    &amp;<a name='1788'>
                   (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))             )<a name='1789'>
     ENDDO<a name='1790'>
<a name='1791'>
   END IF<a name='1792'>
<a name='1793'>
<font color=#447700>!--------------------------<a name='1794'></font>
<a name='1795'>
   ELSE IF (advective_order &lt;= 6) THEN<a name='1796'>
<a name='1797'>
<font color=#447700>!!! NOTE: this branch has been looked at and fixed with changes for overdecomposition<a name='1798'></font>
<font color=#447700>!!!       the branches covering the other advective_order cases have not.  20090923. JM<a name='1799'></font>
<a name='1800'>
<font color=#447700>!  y (v) advection<a name='1801'></font>
<a name='1802'>
   i_start = its<a name='1803'>
   j_start = jts<a name='1804'>
   itf=MIN(ite,ide-1)<a name='1805'>
   jtf=MIN(jte,jde-1)<a name='1806'>
<a name='1807'>
   IF (config_flags%open_ys .or. specified ) j_start = max(jts,jds+3)<a name='1808'>
   IF (config_flags%open_ye .or. specified ) jtf     = min(jtf,jde-4)<a name='1809'>
<a name='1810'>
   DO j = j_start, jtf<a name='1811'>
<a name='1812'>
     DO k = 2, kte-1<a name='1813'>
     DO i = i_start, itf<a name='1814'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))* (                    &amp;<a name='1815'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)                &amp;<a name='1816'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j  ) )* (1./60.)*(  &amp;<a name='1817'>
                   45.*(ph(i,k,j+1)-ph(i,k,j-1))                                    &amp;<a name='1818'>
                   -9.*(ph(i,k,j+2)-ph(i,k,j-2))                                    &amp;<a name='1819'>
                      +(ph(i,k,j+3)-ph(i,k,j-3))                                    &amp;<a name='1820'>
                  +45.*(phb(i,k,j+1)-phb(i,k,j-1))                                  &amp;<a name='1821'>
                   -9.*(phb(i,k,j+2)-phb(i,k,j-2))                                  &amp;<a name='1822'>
                      +(phb(i,k,j+3)-phb(i,k,j-3))  )   )                <a name='1823'>
<a name='1824'>
<a name='1825'>
     ENDDO<a name='1826'>
     ENDDO<a name='1827'>
<a name='1828'>
     k = kte<a name='1829'>
     DO i = i_start, itf<a name='1830'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))* (                                &amp;<a name='1831'>
                 ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)                &amp;<a name='1832'>
                  +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j  ) )* (1./60.)*(  &amp;<a name='1833'>
                   45.*(ph(i,k,j+1)-ph(i,k,j-1))                                               &amp;<a name='1834'>
                   -9.*(ph(i,k,j+2)-ph(i,k,j-2))                                               &amp;<a name='1835'>
                      +(ph(i,k,j+3)-ph(i,k,j-3))                                               &amp;<a name='1836'>
                  +45.*(phb(i,k,j+1)-phb(i,k,j-1))                                             &amp;<a name='1837'>
                   -9.*(phb(i,k,j+2)-phb(i,k,j-2))                                             &amp;<a name='1838'>
                      +(phb(i,k,j+3)-phb(i,k,j-3))  )   )                <a name='1839'>
<a name='1840'>
     ENDDO<a name='1841'>
<a name='1842'>
   ENDDO<a name='1843'>
<a name='1844'>
<font color=#447700>!  4th order stencil for open or specified conditions two in form the boundary<a name='1845'></font>
<a name='1846'>
   IF ( (config_flags%open_ys .or. specified) .and. jts &lt;= jds+2 .and. jds+2 &lt;= jte )  THEN<a name='1847'>
<a name='1848'>
     j = jds+2<a name='1849'>
     DO k = 2, kte-1<a name='1850'>
     DO i = i_start, itf<a name='1851'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))* (                     &amp;<a name='1852'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)                &amp;<a name='1853'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j  ) )* (1./12.)*(  &amp;<a name='1854'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                    &amp;<a name='1855'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                    &amp;<a name='1856'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                                  &amp;<a name='1857'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1858'>
<a name='1859'>
<a name='1860'>
     ENDDO<a name='1861'>
     ENDDO<a name='1862'>
<a name='1863'>
     k = kte<a name='1864'>
     DO i = i_start, itf<a name='1865'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))* (                              &amp;<a name='1866'>
                 ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)              &amp;<a name='1867'>
                  +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j) )* (1./12.)*(  &amp;<a name='1868'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                             &amp;<a name='1869'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                             &amp;<a name='1870'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                                           &amp;<a name='1871'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1872'>
<a name='1873'>
     ENDDO<a name='1874'>
<a name='1875'>
   END IF<a name='1876'>
<a name='1877'>
   IF ( (config_flags%open_ye .or. specified) .and. jts &lt;= jde-3 .and. jde-3 &lt;= jte )  THEN<a name='1878'>
     j = jde-3<a name='1879'>
     DO k = 2, kte-1<a name='1880'>
     DO i = i_start, itf<a name='1881'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))* (                  &amp;<a name='1882'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)              &amp;<a name='1883'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j) )* (1./12.)*(  &amp;<a name='1884'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                  &amp;<a name='1885'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                  &amp;<a name='1886'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                                &amp;<a name='1887'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1888'>
<a name='1889'>
<a name='1890'>
     ENDDO<a name='1891'>
     ENDDO<a name='1892'>
<a name='1893'>
     k = kte<a name='1894'>
     DO i = i_start, itf<a name='1895'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))* (                              &amp;<a name='1896'>
                 ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)              &amp;<a name='1897'>
                  +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j) )* (1./12.)*(  &amp;<a name='1898'>
                    8.*(ph(i,k,j+1)-ph(i,k,j-1))                                             &amp;<a name='1899'>
                      -(ph(i,k,j+2)-ph(i,k,j-2))                                             &amp;<a name='1900'>
                   +8.*(phb(i,k,j+1)-phb(i,k,j-1))                                           &amp;<a name='1901'>
                      -(phb(i,k,j+2)-phb(i,k,j-2))  )   )                <a name='1902'>
<a name='1903'>
     ENDDO<a name='1904'>
<a name='1905'>
   END IF<a name='1906'>
<a name='1907'>
<font color=#447700>!  2nd order stencil for open and specified conditions one row in from boundary<a name='1908'></font>
<a name='1909'>
   IF ( (config_flags%open_ys .or. specified) .and. jts &lt;= jds+1 .and. jds+1 &lt;= jte )  THEN<a name='1910'>
<a name='1911'>
     j = jds+1<a name='1912'>
     DO k = 2, kte-1<a name='1913'>
     DO i = i_start, itf<a name='1914'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))*          &amp;<a name='1915'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)*   &amp;<a name='1916'>
                  (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))   &amp;<a name='1917'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j  )*   &amp;<a name='1918'>
                  (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1)) )<a name='1919'>
     ENDDO<a name='1920'>
     ENDDO<a name='1921'>
<a name='1922'>
     k = kte<a name='1923'>
     DO i = i_start, itf<a name='1924'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))*                        &amp;<a name='1925'>
                  ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)*    &amp;<a name='1926'>
                   (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))               &amp;<a name='1927'>
                   +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j  )*    &amp;<a name='1928'>
                   (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1))              )<a name='1929'>
     ENDDO<a name='1930'>
<a name='1931'>
   END IF<a name='1932'>
<a name='1933'>
   IF ( (config_flags%open_ye .or. specified) .and. jts &lt;= jde-2 .and. jde-2 &lt;= jte )  THEN<a name='1934'>
<a name='1935'>
     j = jde-2<a name='1936'>
     DO k = 2, kte-1<a name='1937'>
     DO i = i_start, itf<a name='1938'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdy/msfty(i,j))*          &amp;<a name='1939'>
                 ( muvf(i,j+1)*(v(i,k,j+1)+v(i,k-1,j+1))*msfvy(i,j+1)*   &amp;<a name='1940'>
                  (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))   &amp;<a name='1941'>
                  +muvf(i,j  )*(v(i,k,j  )+v(i,k-1,j  ))*msfvy(i,j  )*   &amp;<a name='1942'>
                  (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1)) )<a name='1943'>
     ENDDO<a name='1944'>
     ENDDO<a name='1945'>
<a name='1946'>
     k = kte<a name='1947'>
     DO i = i_start, itf<a name='1948'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdy/msfty(i,j))*                        &amp;<a name='1949'>
                  ( muvf(i,j+1)*(cfn*v(i,k-1,j+1)+cfn1*v(i,k-2,j+1))*msfvy(i,j+1)*    &amp;<a name='1950'>
                   (phb(i,k,j+1)-phb(i,k,j  )+ph(i,k,j+1)-ph(i,k,j  ))               &amp;<a name='1951'>
                   +muvf(i,j  )*(cfn*v(i,k-1,j  )+cfn1*v(i,k-2,j  ))*msfvy(i,j  )*    &amp;<a name='1952'>
                   (phb(i,k,j  )-phb(i,k,j-1)+ph(i,k,j  )-ph(i,k,j-1))              )<a name='1953'>
     ENDDO<a name='1954'>
<a name='1955'>
   END IF<a name='1956'>
<a name='1957'>
<font color=#447700>!  x (u) advection<a name='1958'></font>
<a name='1959'>
   i_start = its<a name='1960'>
   j_start = jts<a name='1961'>
   itf=MIN(ite,ide-1)<a name='1962'>
   jtf=MIN(jte,jde-1)<a name='1963'>
<a name='1964'>
   IF (config_flags%open_xs .or. specified ) i_start = max(its,ids+3)<a name='1965'>
   IF (config_flags%open_xe .or. specified ) itf     = min(itf,ide-4)<a name='1966'>
<a name='1967'>
   DO j = j_start, jtf<a name='1968'>
<a name='1969'>
     DO k = 2, kte-1<a name='1970'>
     DO i = i_start, itf<a name='1971'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*(                   &amp;<a name='1972'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)              &amp;<a name='1973'>
                  +muuf(i,j  )*(u(i,k,j  )+u(i,k-1,j  ))*msfux(i,j) )* (1./60.)*(  &amp;<a name='1974'>
                   45.*(ph(i+1,k,j)-ph(i-1,k,j))                                  &amp;<a name='1975'>
                   -9.*(ph(i+2,k,j)-ph(i-2,k,j))                                  &amp;<a name='1976'>
                      +(ph(i+3,k,j)-ph(i-3,k,j))                                  &amp;<a name='1977'>
                  +45.*(phb(i+1,k,j)-phb(i-1,k,j))                                &amp;<a name='1978'>
                   -9.*(phb(i+2,k,j)-phb(i-2,k,j))                                &amp;<a name='1979'>
                      +(phb(i+3,k,j)-phb(i-3,k,j))  )   )                <a name='1980'>
     ENDDO<a name='1981'>
     ENDDO<a name='1982'>
 <a name='1983'>
     k = kte<a name='1984'>
     DO i = i_start, itf<a name='1985'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*(                             &amp;<a name='1986'>
                 ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)            &amp;<a name='1987'>
                  +muuf(i,j  )*(cfn*u(i  ,k-1,j)+cfn1*u(i,k-2,j))*msfux(i,j) )* (1./60.)*(  &amp;<a name='1988'>
                   45.*(ph(i+1,k,j)-ph(i-1,k,j))                                           &amp;<a name='1989'>
                   -9.*(ph(i+2,k,j)-ph(i-2,k,j))                                           &amp;<a name='1990'>
                      +(ph(i+3,k,j)-ph(i-3,k,j))                                           &amp;<a name='1991'>
                  +45.*(phb(i+1,k,j)-phb(i-1,k,j))                                         &amp;<a name='1992'>
                   -9.*(phb(i+2,k,j)-phb(i-2,k,j))                                         &amp;<a name='1993'>
                      +(phb(i+3,k,j)-phb(i-3,k,j))  )     )<a name='1994'>
     ENDDO<a name='1995'>
<a name='1996'>
   ENDDO<a name='1997'>
<a name='1998'>
<font color=#447700>!  4th order stencil two in from the boundary for open and specified conditions<a name='1999'></font>
<a name='2000'>
   IF ( (config_flags%open_xs) .and. its &lt;= ids+2 .and. ids+2 &lt;= ite ) THEN<a name='2001'>
     i = ids + 2<a name='2002'>
     DO j = j_start, jtf<a name='2003'>
       DO k = 2, kte-1<a name='2004'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*(                   &amp;<a name='2005'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)              &amp;<a name='2006'>
                  +muuf(i,j  )*(u(i,k,j  )+u(i,k-1,j  ))*msfux(i,j) )* (1./12.)*(  &amp;<a name='2007'>
                    8.*(ph(i+1,k,j)-ph(i-1,k,j))                                  &amp;<a name='2008'>
                      -(ph(i+2,k,j)-ph(i-2,k,j))                                  &amp;<a name='2009'>
                   +8.*(phb(i+1,k,j)-phb(i-1,k,j))                                &amp;<a name='2010'>
                      -(phb(i+2,k,j)-phb(i-2,k,j))  )   )                <a name='2011'>
       ENDDO<a name='2012'>
       k = kte<a name='2013'>
       ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*(                             &amp;<a name='2014'>
                ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)            &amp;<a name='2015'>
                 +muuf(i,j  )*(cfn*u(i  ,k-1,j)+cfn1*u(i,k-2,j))*msfux(i,j) )* (1./12.)*(  &amp;<a name='2016'>
                   8.*(ph(i+1,k,j)-ph(i-1,k,j))                                           &amp;<a name='2017'>
                     -(ph(i+2,k,j)-ph(i-2,k,j))                                           &amp;<a name='2018'>
                  +8.*(phb(i+1,k,j)-phb(i-1,k,j))                                         &amp;<a name='2019'>
                     -(phb(i+2,k,j)-phb(i-2,k,j))  )     )<a name='2020'>
<a name='2021'>
     ENDDO<a name='2022'>
   END IF<a name='2023'>
<a name='2024'>
   IF ( (config_flags%open_xe) .and. its &lt;= ide-3 .and. ide-3 &lt;= ite ) THEN<a name='2025'>
     i = ide-3<a name='2026'>
     DO j = j_start, jtf<a name='2027'>
       DO k = 2, kte-1<a name='2028'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*(                   &amp;<a name='2029'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)              &amp;<a name='2030'>
                  +muuf(i,j  )*(u(i,k,j  )+u(i,k-1,j  ))*msfux(i,j) )* (1./12.)*(  &amp;<a name='2031'>
                    8.*(ph(i+1,k,j)-ph(i-1,k,j))                                  &amp;<a name='2032'>
                      -(ph(i+2,k,j)-ph(i-2,k,j))                                  &amp;<a name='2033'>
                   +8.*(phb(i+1,k,j)-phb(i-1,k,j))                                &amp;<a name='2034'>
                      -(phb(i+2,k,j)-phb(i-2,k,j))  )   )                <a name='2035'>
       ENDDO<a name='2036'>
       k = kte<a name='2037'>
       ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*(                             &amp;<a name='2038'>
                ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)            &amp;<a name='2039'>
                 +muuf(i,j  )*(cfn*u(i  ,k-1,j)+cfn1*u(i,k-2,j))*msfux(i,j) )* (1./12.)*(  &amp;<a name='2040'>
                   8.*(ph(i+1,k,j)-ph(i-1,k,j))                                           &amp;<a name='2041'>
                     -(ph(i+2,k,j)-ph(i-2,k,j))                                           &amp;<a name='2042'>
                  +8.*(phb(i+1,k,j)-phb(i-1,k,j))                                         &amp;<a name='2043'>
                     -(phb(i+2,k,j)-phb(i-2,k,j))  )     )<a name='2044'>
<a name='2045'>
     ENDDO<a name='2046'>
   END IF<a name='2047'>
<a name='2048'>
<font color=#447700>!  2nd order stencil for open and specified conditions one in from the boundary<a name='2049'></font>
<a name='2050'>
   IF ( (config_flags%open_xs .or. specified) .and. its &lt;= ids+1 .and. ids+1 &lt;= ite ) THEN<a name='2051'>
<a name='2052'>
     i = ids + 1<a name='2053'>
<a name='2054'>
     DO j = j_start, jtf<a name='2055'>
     DO k = 2, kte-1<a name='2056'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*         &amp;<a name='2057'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)*  &amp;<a name='2058'>
                  (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))  &amp;<a name='2059'>
                  +muuf(i  ,j)*(u(i  ,k,j)+u(i  ,k-1,j))*msfux(i  ,j)*  &amp;<a name='2060'>
                  (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))  )<a name='2061'>
     ENDDO<a name='2062'>
     ENDDO<a name='2063'>
 <a name='2064'>
     k = kte<a name='2065'>
     DO j = j_start, jtf<a name='2066'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*                        &amp;<a name='2067'>
                  ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)*    &amp;<a name='2068'>
                   (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))               &amp;<a name='2069'>
                   +muuf(i  ,j)*(cfn*u(i  ,k-1,j)+cfn1*u(i  ,k-2,j))*msfux(  i,j)*    &amp;<a name='2070'>
                   (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))             )<a name='2071'>
     ENDDO<a name='2072'>
<a name='2073'>
   END IF<a name='2074'>
<a name='2075'>
   IF ( (config_flags%open_xe .or. specified) .and. its &lt;= ide-2 .and. ide-2 &lt;= ite ) THEN<a name='2076'>
<a name='2077'>
     i = ide-2<a name='2078'>
     DO j = j_start, jtf<a name='2079'>
     DO k = 2, kte-1<a name='2080'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.25*rdx/msfty(i,j))*         &amp;<a name='2081'>
                 ( muuf(i+1,j)*(u(i+1,k,j)+u(i+1,k-1,j))*msfux(i+1,j)*  &amp;<a name='2082'>
                  (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))  &amp;<a name='2083'>
                  +muuf(i  ,j)*(u(i  ,k,j)+u(i  ,k-1,j))*msfux(i  ,j)*  &amp;<a name='2084'>
                  (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))  )<a name='2085'>
     ENDDO<a name='2086'>
     ENDDO<a name='2087'>
 <a name='2088'>
     k = kte<a name='2089'>
     DO j = j_start, jtf<a name='2090'>
        ph_tend(i,k,j)=ph_tend(i,k,j) - (0.5*rdx/msfty(i,j))*                        &amp;<a name='2091'>
                  ( muuf(i+1,j)*(cfn*u(i+1,k-1,j)+cfn1*u(i+1,k-2,j))*msfux(i+1,j)*    &amp;<a name='2092'>
                   (phb(i+1,k,j)-phb(i  ,k,j)+ph(i+1,k,j)-ph(i  ,k,j))               &amp;<a name='2093'>
                   +muuf(i  ,j)*(cfn*u(i  ,k-1,j)+cfn1*u(i  ,k-2,j))*msfux(  i,j)*    &amp;<a name='2094'>
                   (phb(i  ,k,j)-phb(i-1,k,j)+ph(i  ,k,j)-ph(i-1,k,j))             )<a name='2095'>
     ENDDO<a name='2096'>
<a name='2097'>
   END IF<a name='2098'>
<a name='2099'>
   END IF  <font color=#447700>! 6th order advection<a name='2100'></font>
<a name='2101'>
<font color=#447700>!  lateral open boundary conditions,<a name='2102'></font>
<font color=#447700>!  start with north and south (y) boundaries<a name='2103'></font>
<a name='2104'>
   i_start = its<a name='2105'>
   itf=MIN(ite,ide-1)<a name='2106'>
<a name='2107'>
   <font color=#447700>!  south<a name='2108'></font>
<a name='2109'>
   IF ( (config_flags%open_ys) .and. jts == jds ) THEN<a name='2110'>
<a name='2111'>
     j=jts<a name='2112'>
<a name='2113'>
     DO k=2,kde<a name='2114'>
       kz = min(k,kde-1)<a name='2115'>
       DO i = its,itf<a name='2116'>
         vb =.5*( fnm(kz)*(v(i,kz  ,j+1)+v(i,kz  ,j  ))    &amp;<a name='2117'>
                 +fnp(kz)*(v(i,kz-1,j+1)+v(i,kz-1,j  )) )<a name='2118'>
         vl=amin1(vb,0.)<a name='2119'>
         ph_tend(i,k,j)=ph_tend(i,k,j)-rdy*mut(i,j)*(      &amp;<a name='2120'>
                              +vl*(ph_old(i,k,j+1)-ph_old(i,k,j)))<a name='2121'>
       ENDDO<a name='2122'>
     ENDDO<a name='2123'>
<a name='2124'>
   END IF<a name='2125'>
<a name='2126'>
   <font color=#447700>! north<a name='2127'></font>
<a name='2128'>
   IF ( (config_flags%open_ye) .and. jte == jde ) THEN<a name='2129'>
<a name='2130'>
     j=jte-1<a name='2131'>
<a name='2132'>
     DO k=2,kde<a name='2133'>
       kz = min(k,kde-1)<a name='2134'>
       DO i = its,itf<a name='2135'>
        vb=.5*( fnm(kz)*(v(i,kz  ,j+1)+v(i,kz  ,j))   &amp;<a name='2136'>
               +fnp(kz)*(v(i,kz-1,j+1)+v(i,kz-1,j)) )<a name='2137'>
        vr=amax1(vb,0.)<a name='2138'>
        ph_tend(i,k,j)=ph_tend(i,k,j)-rdy*mut(i,j)*(      &amp;<a name='2139'>
                   +vr*(ph_old(i,k,j)-ph_old(i,k,j-1)))<a name='2140'>
       ENDDO<a name='2141'>
     ENDDO<a name='2142'>
<a name='2143'>
   END IF<a name='2144'>
<a name='2145'>
   <font color=#447700>!  now the east and west (y) boundaries<a name='2146'></font>
<a name='2147'>
   j_start = its<a name='2148'>
   jtf=MIN(jte,jde-1)<a name='2149'>
<a name='2150'>
   <font color=#447700>!  west<a name='2151'></font>
<a name='2152'>
   IF ( (config_flags%open_xs) .and. its == ids ) THEN<a name='2153'>
<a name='2154'>
     i=its<a name='2155'>
<a name='2156'>
     DO j = jts,jtf<a name='2157'>
       DO k=2,kde-1<a name='2158'>
         kz = k<a name='2159'>
         ub =.5*( fnm(kz)*(u(i+1,kz  ,j)+u(i  ,kz  ,j))     &amp;<a name='2160'>
                 +fnp(kz)*(u(i+1,kz-1,j)+u(i  ,kz-1,j)) )<a name='2161'>
         ul=amin1(ub,0.)<a name='2162'>
         ph_tend(i,k,j)=ph_tend(i,k,j)-(msftx(i,j)/msfty(i,j))*rdx*mut(i,j)*(       &amp;<a name='2163'>
                              +ul*(ph_old(i+1,k,j)-ph_old(i,k,j)))<a name='2164'>
       ENDDO<a name='2165'>
<a name='2166'>
         k = kde<a name='2167'>
         kz = k<a name='2168'>
         ub =.5*( fnm(kz)*(u(i+1,kz  ,j)+u(i  ,kz  ,j))     &amp;<a name='2169'>
                 +fnp(kz)*(u(i+1,kz-1,j)+u(i  ,kz-1,j)) )<a name='2170'>
         ul=amin1(ub,0.)<a name='2171'>
         ph_tend(i,k,j)=ph_tend(i,k,j)-(msftx(i,j)/msfty(i,j))*rdx*mut(i,j)*(       &amp;<a name='2172'>
                              +ul*(ph_old(i+1,k,j)-ph_old(i,k,j)))<a name='2173'>
     ENDDO<a name='2174'>
<a name='2175'>
   END IF<a name='2176'>
<a name='2177'>
   <font color=#447700>! east<a name='2178'></font>
<a name='2179'>
   IF ( (config_flags%open_xe) .and. ite == ide ) THEN<a name='2180'>
<a name='2181'>
     i = ite-1<a name='2182'>
<a name='2183'>
     DO j = jts,jtf<a name='2184'>
       DO k=2,kde-1<a name='2185'>
        kz = k<a name='2186'>
        ub=.5*( fnm(kz)*(u(i+1,kz  ,j)+u(i,kz  ,j))  &amp;<a name='2187'>
               +fnp(kz)*(u(i+1,kz-1,j)+u(i,kz-1,j)) )<a name='2188'>
        ur=amax1(ub,0.)<a name='2189'>
        ph_tend(i,k,j)=ph_tend(i,k,j)-(msftx(i,j)/msfty(i,j))*rdx*mut(i,j)*( &amp;<a name='2190'>
                   +ur*(ph_old(i,k,j)-ph_old(i-1,k,j)))<a name='2191'>
       ENDDO<a name='2192'>
<a name='2193'>
        k = kde    <a name='2194'>
        kz = k-1<a name='2195'>
        ub=.5*( fnm(kz)*(u(i+1,kz  ,j)+u(i,kz  ,j))   &amp;<a name='2196'>
               +fnp(kz)*(u(i+1,kz-1,j)+u(i,kz-1,j)) )<a name='2197'>
        ur=amax1(ub,0.)<a name='2198'>
        ph_tend(i,k,j)=ph_tend(i,k,j)-(msftx(i,j)/msfty(i,j))*rdx*mut(i,j)*(  &amp;<a name='2199'>
                   +ur*(ph_old(i,k,j)-ph_old(i-1,k,j)))<a name='2200'>
<a name='2201'>
     ENDDO<a name='2202'>
<a name='2203'>
   END IF<a name='2204'>
<a name='2205'>
  END SUBROUTINE rhs_ph<a name='2206'>
<a name='2207'>
<a name='2208'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2209'></font>
<a name='2210'>
<A NAME='HORIZONTAL_PRESSURE_GRADIENT'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_PRESSURE_GRADIENT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2211'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_pressure_gradient</font>( ru_tend,rv_tend,                &amp; <A href='../../call_to/HORIZONTAL_PRESSURE_GRADIENT.html' TARGET='index'>1</A><a name='2212'>
                                         ph,alt,p,pb,al,php,cqu,cqv,     &amp;<a name='2213'>
                                         muu,muv,mu,c1h,c2h,fnm,fnp,rdnw,&amp;<a name='2214'>
                                         cf1,cf2,cf3,cfn,cfn1,           &amp;<a name='2215'>
                                         rdx,rdy,msfux,msfuy,&amp;<a name='2216'>
                                         msfvx,msfvy,msftx,msfty,        &amp;<a name='2217'>
                                         config_flags, non_hydrostatic,  &amp;<a name='2218'>
                                         top_lid,                        &amp;<a name='2219'>
                                         ids, ide, jds, jde, kds, kde,   &amp;<a name='2220'>
                                         ims, ime, jms, jme, kms, kme,   &amp;<a name='2221'>
                                         its, ite, jts, jte, kts, kte   )<a name='2222'>
<a name='2223'>
   IMPLICIT NONE<a name='2224'>
   <a name='2225'>
   <font color=#447700>! Input data<a name='2226'></font>
<a name='2227'>
<a name='2228'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2229'>
<a name='2230'>
   LOGICAL, INTENT (IN   ) :: non_hydrostatic, top_lid<a name='2231'>
<a name='2232'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2233'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='2234'>
                                       its, ite, jts, jte, kts, kte <a name='2235'>
<a name='2236'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::        &amp;<a name='2237'>
                                                                     ph,  &amp;<a name='2238'>
                                                                     alt, &amp;<a name='2239'>
                                                                     al,  &amp;<a name='2240'>
                                                                     p,   &amp;<a name='2241'>
                                                                     pb,  &amp;<a name='2242'>
                                                                     php, &amp;<a name='2243'>
                                                                     cqu, &amp;<a name='2244'>
                                                                     cqv<a name='2245'>
<a name='2246'>
<a name='2247'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) ::           &amp;<a name='2248'>
                                                                    ru_tend, &amp;<a name='2249'>
                                                                    rv_tend<a name='2250'>
<a name='2251'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: muu, muv, mu,    &amp;<a name='2252'>
                                                            msfux, msfuy, &amp;<a name='2253'>
                                                            msfvx, msfvy, &amp;<a name='2254'>
                                                            msftx, msfty<a name='2255'>
<a name='2256'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: rdnw, fnm, fnp<a name='2257'>
<a name='2258'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: c1h, c2h<a name='2259'>
<a name='2260'>
   REAL,  INTENT(IN   ) :: rdx, rdy, cf1, cf2, cf3, cfn, cfn1<a name='2261'>
<a name='2262'>
   INTEGER :: i,j,k, itf, jtf, ktf, i_start, j_start<a name='2263'>
   REAL, DIMENSION( ims:ime, kms:kme ) :: dpn<a name='2264'>
   REAL :: dpx, dpy<a name='2265'>
   REAL, DIMENSION( kms:kme ) :: c1<a name='2266'>
<a name='2267'>
   LOGICAL :: specified<a name='2268'>
<a name='2269'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2270'></font>
<font color=#447700>!<a name='2271'></font>
<font color=#447700>!  horizontal_pressure_gradient calculates the <a name='2272'></font>
<font color=#447700>!  horizontal pressure gradient terms for the large-timestep tendency <a name='2273'></font>
<font color=#447700>!  in the horizontal momentum equations (u,v).<a name='2274'></font>
<font color=#447700>!<a name='2275'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2276'></font>
<a name='2277'>
   c1 = c1h<a name='2278'>
   specified = .false.<a name='2279'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2280'>
<a name='2281'>
<font color=#447700>!  Notes on map scale factors:<a name='2282'></font>
<font color=#447700>!  Calculates the pressure gradient terms in ADT eqns 44 and 45<a name='2283'></font>
<font color=#447700>!  With upper rho -&gt; 'mu', these are:<a name='2284'></font>
<font color=#447700>!  Eqn 30: -mu*(mx/my)*(1/rho)*partial dp/dx<a name='2285'></font>
<font color=#447700>!  Eqn 31: -mu*(my/mx)*(1/rho)*partial dp/dy<a name='2286'></font>
<font color=#447700>!<a name='2287'></font>
<font color=#447700>!  As we are on nu, rather than height, surfaces:<a name='2288'></font>
<font color=#447700>!<a name='2289'></font>
<font color=#447700>!  mu dp/dx = mu alpha partial dp'/dx + (nu mu partial dmubar/dx) alpha'<a name='2290'></font>
<font color=#447700>!           + mu partial dphi'/dx + (partial dphi/dx)*(partial dp'/dnu - mu')<a name='2291'></font>
<font color=#447700>!<a name='2292'></font>
<font color=#447700>!  mu dp/dy = mu alpha partial dp'/dy + (nu mu partial dmubar/dy) alpha'<a name='2293'></font>
<font color=#447700>!           + mu partial dphi'/dy + (partial dphi/dy)*(partial dp'/dnu - mu')<a name='2294'></font>
<a name='2295'>
<font color=#447700>! start with the north-south (y) pressure gradient<a name='2296'></font>
<a name='2297'>
   itf=MIN(ite,ide-1)<a name='2298'>
   jtf=jte<a name='2299'>
   ktf=MIN(kte,kde-1)<a name='2300'>
   i_start = its<a name='2301'>
   j_start = jts<a name='2302'>
   IF ( (config_flags%open_ys .or. specified .or. &amp;<a name='2303'>
         config_flags%nested .or. config_flags%polar ) .and. jts == jds ) j_start = jts+1<a name='2304'>
   IF ( (config_flags%open_ye .or. specified .or. &amp;<a name='2305'>
         config_flags%nested .or. config_flags%polar ) .and. jte == jde ) jtf = jtf-1<a name='2306'>
<a name='2307'>
   DO j = j_start, jtf<a name='2308'>
<a name='2309'>
     IF ( non_hydrostatic )  THEN<a name='2310'>
<a name='2311'>
        k=1<a name='2312'>
<a name='2313'>
        DO i = i_start, itf<a name='2314'>
          dpn(i,k) = .5*( cf1*(p(i,k  ,j-1)+p(i,k  ,j))   &amp;<a name='2315'>
                         +cf2*(p(i,k+1,j-1)+p(i,k+1,j))   &amp;<a name='2316'>
                         +cf3*(p(i,k+2,j-1)+p(i,k+2,j))  )<a name='2317'>
          dpn(i,kde) = 0.<a name='2318'>
        ENDDO<a name='2319'>
        IF (top_lid) THEN<a name='2320'>
          DO i = i_start, itf<a name='2321'>
            dpn(i,kde) = .5*( cfn *(p(i,kde-1,j-1)+p(i,kde-1,j))   &amp;<a name='2322'>
                             +cfn1*(p(i,kde-2,j-1)+p(i,kde-2,j)) )<a name='2323'>
          ENDDO<a name='2324'>
        ENDIF<a name='2325'>
               <a name='2326'>
        DO k=2,ktf<a name='2327'>
          DO i = i_start, itf<a name='2328'>
            dpn(i,k) = .5*( fnm(k)*(p(i,k  ,j-1)+p(i,k  ,j))  &amp;<a name='2329'>
                           +fnp(k)*(p(i,k-1,j-1)+p(i,k-1,j)) )<a name='2330'>
          END DO<a name='2331'>
        END DO<a name='2332'>
<a name='2333'>
<font color=#447700>!       ADT eqn 45: -mu*(my/mx)*(1/rho)*partial dp/dy<a name='2334'></font>
<font color=#447700>!       [alt, al are 1/rho terms; muv, mu are NOT coupled]<a name='2335'></font>
        DO K=1,ktf<a name='2336'>
          DO i = i_start, itf<a name='2337'>
            <font color=#447700>! Here are mu dp/dy terms 1-3 <a name='2338'></font>
            dpy = (msfvy(i,j)/msfvx(i,j))*.5*rdy*muv(i,j)*(                 &amp;<a name='2339'>
                     (ph (i,k+1,j)-ph (i,k+1,j-1) + ph(i,k,j)-ph(i,k,j-1))  &amp;<a name='2340'>
                    +(alt(i,k  ,j)+alt(i,k  ,j-1))*(p (i,k,j)-p (i,k,j-1))  &amp;<a name='2341'>
                    +(al (i,k  ,j)+al (i,k  ,j-1))*(pb(i,k,j)-pb(i,k,j-1)) )<a name='2342'>
            <font color=#447700>! Here is mu dp/dy term 4 <a name='2343'></font>
            dpy = dpy + (msfvy(i,j)/msfvx(i,j))*rdy*(php(i,k,j)-php(i,k,j-1))* &amp;<a name='2344'>
                (rdnw(k)*(dpn(i,k+1)-dpn(i,k))-.5*(mu(i,j-1)+mu(i,j)))<a name='2345'>
            rv_tend(i,k,j) = rv_tend(i,k,j)-cqv(i,k,j)*dpy<a name='2346'>
          END DO<a name='2347'>
        END DO<a name='2348'>
<a name='2349'>
     ELSE<a name='2350'>
<a name='2351'>
<font color=#447700>!       ADT eqn 45: -mu*(my/mx)*(1/rho)*partial dp/dy<a name='2352'></font>
<font color=#447700>!       [alt, al are 1/rho terms; muv, mu are NOT coupled]<a name='2353'></font>
        DO K=1,ktf<a name='2354'>
          DO i = i_start, itf<a name='2355'>
            <font color=#447700>! Here are mu dp/dy terms 1-3; term 4 not needed if hydrostatic<a name='2356'></font>
            dpy = (msfvy(i,j)/msfvx(i,j))*.5*rdy*muv(i,j)*(                 &amp;<a name='2357'>
                     (ph (i,k+1,j)-ph (i,k+1,j-1) + ph(i,k,j)-ph(i,k,j-1))  &amp;<a name='2358'>
                    +(alt(i,k  ,j)+alt(i,k  ,j-1))*(p (i,k,j)-p (i,k,j-1))  &amp;<a name='2359'>
                    +(al (i,k  ,j)+al (i,k  ,j-1))*(pb(i,k,j)-pb(i,k,j-1)) )<a name='2360'>
            rv_tend(i,k,j) = rv_tend(i,k,j)-dpy<a name='2361'>
          END DO<a name='2362'>
        END DO<a name='2363'>
<a name='2364'>
     END IF<a name='2365'>
<a name='2366'>
   ENDDO<a name='2367'>
<a name='2368'>
<font color=#447700>!  now the east-west (x) pressure gradient<a name='2369'></font>
<a name='2370'>
   itf=ite<a name='2371'>
   jtf=MIN(jte,jde-1)<a name='2372'>
   ktf=MIN(kte,kde-1)<a name='2373'>
   i_start = its<a name='2374'>
   j_start = jts<a name='2375'>
   IF ( (config_flags%open_xs .or. specified .or. &amp;<a name='2376'>
           config_flags%nested ) .and. its == ids ) i_start = its+1<a name='2377'>
   IF ( (config_flags%open_xe .or. specified .or. &amp;<a name='2378'>
           config_flags%nested ) .and. ite == ide ) itf = itf-1<a name='2379'>
   IF ( config_flags%periodic_x ) i_start = its<a name='2380'>
   IF ( config_flags%periodic_x ) itf=ite<a name='2381'>
<a name='2382'>
   DO j = j_start, jtf<a name='2383'>
<a name='2384'>
     IF ( non_hydrostatic )  THEN<a name='2385'>
<a name='2386'>
        k=1<a name='2387'>
<a name='2388'>
        DO i = i_start, itf<a name='2389'>
          dpn(i,k) = .5*( cf1*(p(i-1,k  ,j)+p(i,k  ,j))   &amp;<a name='2390'>
                         +cf2*(p(i-1,k+1,j)+p(i,k+1,j))   &amp;<a name='2391'>
                         +cf3*(p(i-1,k+2,j)+p(i,k+2,j))  )<a name='2392'>
          dpn(i,kde) = 0.<a name='2393'>
        ENDDO<a name='2394'>
        IF (top_lid) THEN<a name='2395'>
          DO i = i_start, itf<a name='2396'>
            dpn(i,kde) = .5*( cfn *(p(i-1,kde-1,j)+p(i,kde-1,j))   &amp;<a name='2397'>
                             +cfn1*(p(i-1,kde-2,j)+p(i,kde-2,j)) )<a name='2398'>
          ENDDO<a name='2399'>
        ENDIF<a name='2400'>
               <a name='2401'>
        DO k=2,ktf<a name='2402'>
          DO i = i_start, itf<a name='2403'>
            dpn(i,k) = .5*( fnm(k)*(p(i-1,k  ,j)+p(i,k  ,j))  &amp;<a name='2404'>
                           +fnp(k)*(p(i-1,k-1,j)+p(i,k-1,j)) )<a name='2405'>
          END DO<a name='2406'>
        END DO<a name='2407'>
<a name='2408'>
<font color=#447700>! ADT eqn 44: -mu*(mx/my)*(1/rho)*partial dp/dx<a name='2409'></font>
<font color=#447700>! [alt, al are 1/rho terms; muu, mu are NOT coupled]<a name='2410'></font>
        DO K=1,ktf<a name='2411'>
          DO i = i_start, itf<a name='2412'>
            <font color=#447700>! Here are mu dp/dy terms 1-3<a name='2413'></font>
            dpx = (msfux(i,j)/msfuy(i,j))*.5*rdx*muu(i,j)*(                    &amp;<a name='2414'>
                        (ph (i,k+1,j)-ph (i-1,k+1,j) + ph(i,k,j)-ph(i-1,k,j))  &amp;<a name='2415'>
                       +(alt(i,k  ,j)+alt(i-1,k  ,j))*(p (i,k,j)-p (i-1,k,j))  &amp;<a name='2416'>
                       +(al (i,k  ,j)+al (i-1,k  ,j))*(pb(i,k,j)-pb(i-1,k,j)) )<a name='2417'>
            <font color=#447700>! Here is mu dp/dy term 4<a name='2418'></font>
            dpx = dpx + (msfux(i,j)/msfuy(i,j))*rdx*(php(i,k,j)-php(i-1,k,j))* &amp;<a name='2419'>
                (rdnw(k)*(dpn(i,k+1)-dpn(i,k))-.5*(mu(i-1,j)+mu(i,j)))<a name='2420'>
            ru_tend(i,k,j) = ru_tend(i,k,j)-cqu(i,k,j)*dpx<a name='2421'>
          END DO<a name='2422'>
        END DO<a name='2423'>
<a name='2424'>
     ELSE<a name='2425'>
<a name='2426'>
<font color=#447700>!       ADT eqn 44: -mu*(mx/my)*(1/rho)*partial dp/dx<a name='2427'></font>
<font color=#447700>!       [alt, al are 1/rho terms; muu, mu are NOT coupled]<a name='2428'></font>
        DO K=1,ktf<a name='2429'>
          DO i = i_start, itf<a name='2430'>
            <font color=#447700>! Here are mu dp/dy terms 1-3; term 4 not needed if hydrostatic<a name='2431'></font>
            dpx = (msfux(i,j)/msfuy(i,j))*.5*rdx*muu(i,j)*(                    &amp;<a name='2432'>
                        (ph (i,k+1,j)-ph (i-1,k+1,j) + ph(i,k,j)-ph(i-1,k,j))  &amp;<a name='2433'>
                       +(alt(i,k  ,j)+alt(i-1,k  ,j))*(p (i,k,j)-p (i-1,k,j))  &amp;<a name='2434'>
                       +(al (i,k  ,j)+al (i-1,k  ,j))*(pb(i,k,j)-pb(i-1,k,j)) )<a name='2435'>
            ru_tend(i,k,j) = ru_tend(i,k,j)-dpx<a name='2436'>
          END DO<a name='2437'>
        END DO<a name='2438'>
<a name='2439'>
     END IF<a name='2440'>
<a name='2441'>
   ENDDO<a name='2442'>
<a name='2443'>
END SUBROUTINE horizontal_pressure_gradient<a name='2444'>
<a name='2445'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2446'></font>
<a name='2447'>
<A NAME='PG_BUOY_W'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PG_BUOY_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2448'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>pg_buoy_w</font>( rw_tend, p, cqw, muf, mubf,     &amp; <A href='../../call_to/PG_BUOY_W.html' TARGET='index'>1</A><a name='2449'>
                      c1f, c2f,                       &amp;<a name='2450'>
                      rdnw, rdn, g, msftx, msfty,     &amp;<a name='2451'>
                      ids, ide, jds, jde, kds, kde,   &amp;<a name='2452'>
                      ims, ime, jms, jme, kms, kme,   &amp;<a name='2453'>
                      its, ite, jts, jte, kts, kte   )<a name='2454'>
<a name='2455'>
   IMPLICIT NONE<a name='2456'>
   <a name='2457'>
   <font color=#447700>! Input data<a name='2458'></font>
<a name='2459'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2460'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='2461'>
                                       its, ite, jts, jte, kts, kte <a name='2462'>
<a name='2463'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::   p<a name='2464'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) ::   cqw<a name='2465'>
<a name='2466'>
<a name='2467'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) ::  rw_tend<a name='2468'>
<a name='2469'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: mubf, muf, msftx, msfty<a name='2470'>
<a name='2471'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: rdnw, rdn<a name='2472'>
<a name='2473'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: c1f, c2f<a name='2474'>
<a name='2475'>
   REAL,  INTENT(IN   ) :: g<a name='2476'>
<a name='2477'>
   INTEGER :: itf, jtf, i, j, k<a name='2478'>
   REAL    :: cq1, cq2<a name='2479'>
<a name='2480'>
<a name='2481'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2482'></font>
<font color=#447700>!<a name='2483'></font>
<font color=#447700>!  pg_buoy_w calculates the <a name='2484'></font>
<font color=#447700>!  vertical pressure gradient and buoyancy terms for the large-timestep <a name='2485'></font>
<font color=#447700>!  tendency in the vertical momentum equation.<a name='2486'></font>
<font color=#447700>!<a name='2487'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2488'></font>
<a name='2489'>
<font color=#447700>!  BUOYANCY AND PRESSURE GRADIENT TERM IN W EQUATION AT TIME T<a name='2490'></font>
<a name='2491'>
<font color=#447700>!  Map scale factor notes<a name='2492'></font>
<font color=#447700>!  ADT eqn 46 RHS terms 6 and 7 (where 7 is "-rho g")<a name='2493'></font>
<font color=#447700>!  Dividing by my, and using mu and nu (see Klemp et al. eqns 32, 40)<a name='2494'></font>
<font color=#447700>!  term 6: +(g/my) partial dp'/dnu<a name='2495'></font>
<font color=#447700>!  term 7: -(g/my) mu'<a name='2496'></font>
<font color=#447700>!<a name='2497'></font>
<font color=#447700>!  For moisture-free atmosphere, cq1=1, cq2=0<a name='2498'></font>
<font color=#447700>!  =&gt; (1./msft(i,j)) * g * [rdn(k)*{p(i,k,j)-p(i,k-1,j)}-mu(i,j)]<a name='2499'></font>
<a name='2500'>
   itf=MIN(ite,ide-1)<a name='2501'>
   jtf=MIN(jte,jde-1)<a name='2502'>
<a name='2503'>
   DO j = jts,jtf<a name='2504'>
<a name='2505'>
     k=kde<a name='2506'>
     DO i=its,itf<a name='2507'>
       cq1 = 1./(1.+cqw(i,k-1,j))<a name='2508'>
       cq2 = cqw(i,k-1,j)*cq1<a name='2509'>
       rw_tend(i,k,j) = rw_tend(i,k,j)+(1./msfty(i,j))*g*(      &amp;<a name='2510'>
                        cq1*2.*rdnw(k-1)*(  -p(i,k-1,j))  &amp;<a name='2511'>
                        -muf(i,j)-cq2*mubf(i,j)            )<a name='2512'>
     END DO<a name='2513'>
<a name='2514'>
     DO k = 2, kde-1<a name='2515'>
     DO i = its,itf<a name='2516'>
      cq1 = 1./(1.+cqw(i,k,j))<a name='2517'>
      cq2 = cqw(i,k,j)*cq1<a name='2518'>
      cqw(i,k,j) = cq1<a name='2519'>
      rw_tend(i,k,j) = rw_tend(i,k,j)+(1./msfty(i,j))*g*(      &amp;<a name='2520'>
                       cq1*rdn(k)*(p(i,k,j)-p(i,k-1,j))  &amp;<a name='2521'>
                       -muf(i,j)-cq2*mubf(i,j)            )<a name='2522'>
     END DO<a name='2523'>
     ENDDO           <a name='2524'>
<a name='2525'>
<a name='2526'>
   ENDDO<a name='2527'>
<a name='2528'>
END SUBROUTINE pg_buoy_w<a name='2529'>
<a name='2530'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2531'></font>
<a name='2532'>
<A NAME='W_DAMP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2533'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>w_damp</font>( rw_tend, max_vert_cfl,max_horiz_cfl, &amp; <A href='../../call_to/W_DAMP.html' TARGET='index'>1</A>,<A href='../../call_from/W_DAMP.html' TARGET='index'>8</A><a name='2534'>
                      u, v, ww, w, mut, c1f, c2f, rdnw, &amp;<a name='2535'>
                      rdx, rdy, msfux, msfuy,           &amp;<a name='2536'>
                      msfvx, msfvy, dt,                 &amp;<a name='2537'>
                      config_flags,                     &amp;<a name='2538'>
                      ids, ide, jds, jde, kds, kde,     &amp;<a name='2539'>
                      ims, ime, jms, jme, kms, kme,     &amp;<a name='2540'>
                      its, ite, jts, jte, kts, kte     )<a name='2541'>
<a name='2542'>
   USE <A href='../../html_code/share/module_llxy.F.html#MODULE_LLXY'>module_llxy</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LLXY_1"><a name='2543'>
   IMPLICIT NONE<a name='2544'>
<a name='2545'>
   <font color=#447700>! Input data<a name='2546'></font>
<a name='2547'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='2548'>
<a name='2549'>
   INTEGER ,          INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2550'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='2551'>
                                       its, ite, jts, jte, kts, kte<a name='2552'>
<a name='2553'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(IN   ) ::   u, v, ww, w<a name='2554'>
<a name='2555'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme ), INTENT(INOUT) ::  rw_tend<a name='2556'>
<a name='2557'>
   REAL, INTENT(OUT) ::  max_vert_cfl<a name='2558'>
   REAL, INTENT(OUT) ::  max_horiz_cfl<a name='2559'>
   REAL              ::  horiz_cfl<a name='2560'>
<a name='2561'>
   REAL, DIMENSION( ims:ime, jms:jme ), INTENT(IN   ) :: mut<a name='2562'>
<a name='2563'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: rdnw<a name='2564'>
<a name='2565'>
   REAL, DIMENSION( kms:kme ), INTENT(IN   ) :: c1f, c2f<a name='2566'>
<a name='2567'>
   REAL, INTENT(IN)    :: dt<a name='2568'>
   REAL, INTENT(IN)    :: rdx, rdy<a name='2569'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux, msfuy<a name='2570'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfvx, msfvy<a name='2571'>
<a name='2572'>
   REAL                :: vert_cfl, cf_n, cf_d, maxdub, maxdeta<a name='2573'>
<a name='2574'>
   INTEGER :: itf, jtf, i, j, k, maxi, maxj, maxk<a name='2575'>
   INTEGER :: some<a name='2576'>
   CHARACTER*512 :: temp<a name='2577'>
<a name='2578'>
   CHARACTER (LEN=256) :: time_str<a name='2579'>
   CHARACTER (LEN=256) :: grid_str<a name='2580'>
<a name='2581'>
   integer :: total<a name='2582'>
   REAL :: msfuxt , msfxffl<a name='2583'>
   <a name='2584'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2585'></font>
<font color=#447700>!<a name='2586'></font>
<font color=#447700>!  w_damp computes a damping term for the vertical velocity when the<a name='2587'></font>
<font color=#447700>!  vertical Courant number is too large.  This was found to be preferable to <a name='2588'></font>
<font color=#447700>!  decreasing the timestep or increasing the diffusion in real-data applications<a name='2589'></font>
<font color=#447700>!  that produced potentially-unstable large vertical velocities because of<a name='2590'></font>
<font color=#447700>!  unphysically large heating rates coming from the cumulus parameterization <a name='2591'></font>
<font color=#447700>!  schemes run at moderately high resolutions (dx ~ O(10) km).<a name='2592'></font>
<font color=#447700>!<a name='2593'></font>
<font color=#447700>!  Additionally, w_damp returns the maximum cfl values due to vertical motion and<a name='2594'></font>
<font color=#447700>!  horizontal motion.  These values are returned via the max_vert_cfl and <a name='2595'></font>
<font color=#447700>!  max_horiz_cfl variables.  (Added by T. Hutchinson, WSI, 3/5/2007)<a name='2596'></font>
<font color=#447700>!<a name='2597'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2598'></font>
<a name='2599'>
   itf=MIN(ite,ide-1)<a name='2600'>
   jtf=MIN(jte,jde-1)<a name='2601'>
<a name='2602'>
   some = 0<a name='2603'>
   max_vert_cfl = 0.<a name='2604'>
   max_horiz_cfl = 0.<a name='2605'>
   total = 0<a name='2606'>
<a name='2607'>
   IF(config_flags%polar ) then<a name='2608'>
     msfxffl = 1.0/COS(config_flags%fft_filter_lat*degrad) <a name='2609'>
   END IF<a name='2610'>
<a name='2611'>
   IF ( config_flags%w_damping == 1 ) THEN<a name='2612'>
#ifdef OPTIMIZE_CFL_TEST<a name='2613'>
<font color=#447700>! 20121025, L. Meadows vector optimization does not include special case for Cassini<a name='2614'></font>
     IF(config_flags%polar ) then<a name='2615'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_14">('module_big_step_utilities_em.F: -DOPTIMIZE_CFL_TEST option does not support global domains')<a name='2616'>
     END IF<a name='2617'>
#endif<a name='2618'>
<a name='2619'>
     DO j = jts,jtf<a name='2620'>
<a name='2621'>
     DO k = 2, kde-1<a name='2622'>
     DO i = its,itf<a name='2623'>
#if 1<a name='2624'>
#  ifdef OPTIMIZE_CFL_TEST<a name='2625'>
<font color=#447700>! L. Meadows, Intel, MIC optimization, 20121025<a name='2626'></font>
        msfuxt = msfux(i,j)<a name='2627'>
        vert_cfl = abs(ww(i,k,j)/mut(i,j)*rdnw(k)*dt)<a name='2628'>
        IF ( vert_cfl &gt; max_vert_cfl ) THEN<a name='2629'>
           max_vert_cfl = vert_cfl<a name='2630'>
        ENDIF<a name='2631'>
#  else<a name='2632'>
        IF(config_flags%polar ) then<a name='2633'>
           msfuxt = MIN(msfux(i,j), msfxffl)<a name='2634'>
        ELSE<a name='2635'>
           msfuxt = msfux(i,j)<a name='2636'>
        END IF<a name='2637'>
        vert_cfl = abs(ww(i,k,j)/mut(i,j)*rdnw(k)*dt)<a name='2638'>
<a name='2639'>
        IF ( vert_cfl &gt; max_vert_cfl ) THEN<a name='2640'>
           max_vert_cfl = vert_cfl ; maxi = i ; maxj = j ; maxk = k <a name='2641'>
           maxdub = w(i,k,j) ; maxdeta = -1./rdnw(k)<a name='2642'>
        ENDIF<a name='2643'>
#  endif<a name='2644'>
        <a name='2645'>
        horiz_cfl = max( abs(u(i,k,j) * rdx * msfuxt * dt),                          &amp;<a name='2646'>
             abs(v(i,k,j) * rdy * msfvy(i,j) * dt) )<a name='2647'>
        if (horiz_cfl &gt; max_horiz_cfl) then<a name='2648'>
           max_horiz_cfl = horiz_cfl<a name='2649'>
        endif<a name='2650'>
        <a name='2651'>
        if(vert_cfl .gt. w_beta)then<a name='2652'>
#else<a name='2653'>
<font color=#447700>! restructure to get rid of divide<a name='2654'></font>
<font color=#447700>!<a name='2655'></font>
<font color=#447700>! This had been used for efficiency, but with the addition of returning the cfl values, <a name='2656'></font>
<font color=#447700>!   the old version (above) was reinstated.  (T. Hutchinson, 3/5/2007)<a name='2657'></font>
<font color=#447700>!<a name='2658'></font>
        cf_n = abs(ww(i,k,j)*rdnw(k)*dt)<a name='2659'>
        cf_d = abs(mut(i,j))<a name='2660'>
        if(cf_n .gt. cf_d*w_beta )then<a name='2661'>
#endif<a name='2662'>
#ifndef OPTIMIZE_CFL_TEST<a name='2663'>
<font color=#447700>! This internal write is costly on newer Xeon processors because it breaks <a name='2664'></font>
<font color=#447700>! vectorization.  (J. Michalakes for L. Meadows at Intel, 12/13/2012)<a name='2665'></font>
           WRITE(temp,*)i,j,k,' vert_cfl,w,d(eta)=',vert_cfl,w(i,k,j),-1./rdnw(k)<a name='2666'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_3"> ( 100 , TRIM(temp) )<a name='2667'>
#endif<a name='2668'>
           if ( vert_cfl &gt; 2. ) some = some + 1<a name='2669'>
           rw_tend(i,k,j) = rw_tend(i,k,j)-sign(1.,w(i,k,j))*w_alpha*(vert_cfl-w_beta)*mut(i,j)<a name='2670'>
        endif<a name='2671'>
     END DO<a name='2672'>
     ENDDO<a name='2673'>
     ENDDO<a name='2674'>
   ELSE<a name='2675'>
<font color=#447700>! just print<a name='2676'></font>
     DO j = jts,jtf<a name='2677'>
<a name='2678'>
     DO k = 2, kde-1<a name='2679'>
     DO i = its,itf<a name='2680'>
<a name='2681'>
#if 1<a name='2682'>
#  ifdef OPTIMIZE_CFL_TEST<a name='2683'>
        msfuxt = msfux(i,j)<a name='2684'>
        vert_cfl = abs(ww(i,k,j)/mut(i,j)*rdnw(k)*dt)<a name='2685'>
        IF ( vert_cfl &gt; max_vert_cfl ) THEN<a name='2686'>
           max_vert_cfl = vert_cfl<a name='2687'>
        ENDIF<a name='2688'>
#  else<a name='2689'>
<font color=#447700>! L. Meadows MIC optimization, 20121025<a name='2690'></font>
        IF(config_flags%polar ) then<a name='2691'>
           msfuxt = MIN(msfux(i,j), msfxffl)<a name='2692'>
        ELSE<a name='2693'>
           msfuxt = msfux(i,j)<a name='2694'>
        END IF<a name='2695'>
        vert_cfl = abs(ww(i,k,j)/mut(i,j)*rdnw(k)*dt)<a name='2696'>
        <a name='2697'>
        IF ( vert_cfl &gt; max_vert_cfl ) THEN<a name='2698'>
           max_vert_cfl = vert_cfl ; maxi = i ; maxj = j ; maxk = k <a name='2699'>
           maxdub = w(i,k,j) ; maxdeta = -1./rdnw(k)<a name='2700'>
        ENDIF<a name='2701'>
#  endif<a name='2702'>
        <a name='2703'>
        horiz_cfl = max( abs(u(i,k,j) * rdx * msfuxt * dt),                          &amp;<a name='2704'>
             abs(v(i,k,j) * rdy * msfvy(i,j) * dt) )<a name='2705'>
<a name='2706'>
        if (horiz_cfl &gt; max_horiz_cfl) then<a name='2707'>
           max_horiz_cfl = horiz_cfl<a name='2708'>
        endif<a name='2709'>
        <a name='2710'>
        if(vert_cfl .gt. w_beta)then<a name='2711'>
#else<a name='2712'>
<font color=#447700>! restructure to get rid of divide<a name='2713'></font>
<font color=#447700>!<a name='2714'></font>
<font color=#447700>! This had been used for efficiency, but with the addition of returning the cfl values, <a name='2715'></font>
<font color=#447700>!   the old version (above) was reinstated.  (T. Hutchinson, 3/5/2007)<a name='2716'></font>
<font color=#447700>!<a name='2717'></font>
        cf_n = abs(ww(i,k,j)*rdnw(k)*dt)<a name='2718'>
        cf_d = abs(mut(i,j))<a name='2719'>
        if(cf_n .gt. cf_d*w_beta )then<a name='2720'>
#endif<a name='2721'>
#ifndef OPTIMIZE_CFL_TEST<a name='2722'>
           WRITE(temp,*)i,j,k,' vert_cfl,w,d(eta)=',vert_cfl,w(i,k,j),-1./rdnw(k)<a name='2723'>
           CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_4"> ( 100 , TRIM(temp) )<a name='2724'>
#endif<a name='2725'>
           if ( vert_cfl &gt; 2. ) some = some + 1<a name='2726'>
        endif<a name='2727'>
     END DO<a name='2728'>
     ENDDO<a name='2729'>
     ENDDO<a name='2730'>
   ENDIF<a name='2731'>
   IF ( some .GT. 0 ) THEN<a name='2732'>
     CALL <A href='../../html_code/io_netcdf/diffwrf.F90.html#GET_CURRENT_TIME_STRING'>get_current_time_string</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CURRENT_TIME_STRING_1">( time_str )<a name='2733'>
     CALL <A href='../../html_code/io_netcdf/diffwrf.F90.html#GET_CURRENT_GRID_NAME'>get_current_grid_name</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_CURRENT_GRID_NAME_1">( grid_str )<a name='2734'>
     WRITE(temp,*)some,                                            &amp;<a name='2735'>
            ' points exceeded cfl=2 in domain '//TRIM(grid_str)//' at time '//TRIM(time_str)//' hours'<a name='2736'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_5"> ( 0 , TRIM(temp) )<a name='2737'>
#ifndef OPTIMIZE_CFL_TEST<a name='2738'>
     WRITE(temp,*)'MAX AT i,j,k: ',maxi,maxj,maxk,' vert_cfl,w,d(eta)=',max_vert_cfl, &amp;<a name='2739'>
                             maxdub,maxdeta<a name='2740'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_6"> ( 0 , TRIM(temp) )<a name='2741'>
#endif<a name='2742'>
   ENDIF<a name='2743'>
<a name='2744'>
END SUBROUTINE w_damp<a name='2745'>
<a name='2746'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='2747'></font>
<a name='2748'>
<A NAME='HORIZONTAL_DIFFUSION'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2749'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion</font> ( name, field, tendency, MUT, c1, c2,  &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION.html' TARGET='index'>4</A><a name='2750'>
                                  config_flags,                        &amp;<a name='2751'>
                                  msfux, msfuy, msfvx, msfvx_inv,      &amp;<a name='2752'>
                                  msfvy, msftx, msfty,                 &amp;<a name='2753'>
                                  khdif, xkmhd, rdx, rdy,              &amp;<a name='2754'>
                                  ids, ide, jds, jde, kds, kde,        &amp;<a name='2755'>
                                  ims, ime, jms, jme, kms, kme,        &amp;<a name='2756'>
                                  its, ite, jts, jte, kts, kte        )<a name='2757'>
<a name='2758'>
   IMPLICIT NONE<a name='2759'>
   <a name='2760'>
   <font color=#447700>! Input data<a name='2761'></font>
<a name='2762'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='2763'>
<a name='2764'>
   INTEGER ,        INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2765'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='2766'>
                                     its, ite, jts, jte, kts, kte<a name='2767'>
<a name='2768'>
   CHARACTER(LEN=1) ,                          INTENT(IN   ) :: name<a name='2769'>
<a name='2770'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field, xkmhd<a name='2771'>
<a name='2772'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='2773'>
<a name='2774'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: MUT<a name='2775'>
<a name='2776'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,      &amp;<a name='2777'>
                                                                    msfuy,      &amp;<a name='2778'>
                                                                    msfvx,      &amp;<a name='2779'>
                                                                    msfvx_inv,  &amp;<a name='2780'>
                                                                    msfvy,      &amp;<a name='2781'>
                                                                    msftx,      &amp;<a name='2782'>
                                                                    msfty<a name='2783'>
<a name='2784'>
   REAL , DIMENSION( kms:kme )           , INTENT(IN   ) :: c1, c2<a name='2785'>
<a name='2786'>
   REAL ,                                      INTENT(IN   ) :: rdx,       &amp;<a name='2787'>
                                                                rdy,       &amp;<a name='2788'>
                                                                khdif<a name='2789'>
<a name='2790'>
   <font color=#447700>! Local data<a name='2791'></font>
   <a name='2792'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='2793'>
<a name='2794'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='2795'>
<a name='2796'>
   REAL :: mrdx, mkrdxm, mkrdxp, &amp;<a name='2797'>
           mrdy, mkrdym, mkrdyp<a name='2798'>
<a name='2799'>
   LOGICAL :: specified<a name='2800'>
<a name='2801'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2802'></font>
<font color=#447700>!<a name='2803'></font>
<font color=#447700>!  horizontal_diffusion computes the horizontal diffusion tendency<a name='2804'></font>
<font color=#447700>!  on model horizontal coordinate surfaces.<a name='2805'></font>
<font color=#447700>!<a name='2806'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2807'></font>
<a name='2808'>
   specified = .false.<a name='2809'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='2810'>
<a name='2811'>
   ktf=MIN(kte,kde-1)<a name='2812'>
   <a name='2813'>
   IF (name .EQ. 'u') THEN<a name='2814'>
<a name='2815'>
      i_start = its<a name='2816'>
      i_end   = ite<a name='2817'>
      j_start = jts<a name='2818'>
      j_end   = MIN(jte,jde-1)<a name='2819'>
<a name='2820'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2821'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='2822'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2823'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='2824'>
      IF ( config_flags%periodic_x ) i_start = its<a name='2825'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='2826'>
<a name='2827'>
<a name='2828'>
      DO j = j_start, j_end<a name='2829'>
      DO k=kts,ktf<a name='2830'>
      DO i = i_start, i_end<a name='2831'>
<a name='2832'>
         <font color=#447700>! The interior is grad: (m_x*d/dx), the exterior is div: (m_x*m_y*d/dx(/m_y))<a name='2833'></font>
         <font color=#447700>! setting up different averagings of m^2 partial d/dX and m^2 partial d/dY<a name='2834'></font>
<a name='2835'>
         mkrdxm=(msftx(i-1,j)/msfty(i-1,j))*MUT(i-1,j)*xkmhd(i-1,k,j)*rdx<a name='2836'>
         mkrdxp=(msftx(i,j)/msfty(i,j))*MUT(i,j)*xkmhd(i,k,j)*rdx<a name='2837'>
         mrdx=msfux(i,j)*msfuy(i,j)*rdx <a name='2838'>
         mkrdym=( (msfuy(i,j)+msfuy(i,j-1))/(msfux(i,j)+msfux(i,j-1)) )* &amp;<a name='2839'>
                0.25*(MUT(i,j)+MUT(i,j-1)+MUT(i-1,j-1)+MUT(i-1,j))* &amp;<a name='2840'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j-1)+xkmhd(i-1,k,j-1)+xkmhd(i-1,k,j))*rdy<a name='2841'>
         mkrdyp=( (msfuy(i,j)+msfuy(i,j+1))/(msfux(i,j)+msfux(i,j+1)) )* &amp;<a name='2842'>
                0.25*(MUT(i,j)+MUT(i,j+1)+MUT(i-1,j+1)+MUT(i-1,j))* &amp;<a name='2843'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j+1)+xkmhd(i-1,k,j+1)+xkmhd(i-1,k,j))*rdy<a name='2844'>
         <font color=#447700>! need to do four-corners (t) for diffusion coefficient as there are<a name='2845'></font>
         <font color=#447700>! no values at u,v points<a name='2846'></font>
         <font color=#447700>! msfuy - has to be y as part of d/dY<a name='2847'></font>
         <font color=#447700>!         has to be u as we're at a u point<a name='2848'></font>
         mrdy=msfux(i,j)*msfuy(i,j)*rdy <a name='2849'>
<a name='2850'>
         <font color=#447700>! correctly averaged version of rho~ * m^2 * <a name='2851'></font>
         <font color=#447700>!    [partial d/dX(partial du^/dX) + partial d/dY(partial du^/dY)]<a name='2852'></font>
            tendency(i,k,j)=tendency(i,k,j)+( &amp;<a name='2853'>
                            mrdx*(mkrdxp*(field(i+1,k,j)-field(i  ,k,j))  &amp;<a name='2854'>
                                 -mkrdxm*(field(i  ,k,j)-field(i-1,k,j))) &amp;<a name='2855'>
                           +mrdy*(mkrdyp*(field(i,k,j+1)-field(i,k,j  ))  &amp;<a name='2856'>
                                 -mkrdym*(field(i,k,j  )-field(i,k,j-1))))<a name='2857'>
      ENDDO<a name='2858'>
      ENDDO<a name='2859'>
      ENDDO<a name='2860'>
   <a name='2861'>
   ELSE IF (name .EQ. 'v')THEN<a name='2862'>
<a name='2863'>
      i_start = its<a name='2864'>
      i_end   = MIN(ite,ide-1)<a name='2865'>
      j_start = jts<a name='2866'>
      j_end   = jte<a name='2867'>
<a name='2868'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2869'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2870'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2871'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='2872'>
      IF ( config_flags%periodic_x ) i_start = its<a name='2873'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='2874'>
      IF ( config_flags%polar ) j_start = MAX(jds+1,jts)<a name='2875'>
      IF ( config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='2876'>
<a name='2877'>
      DO j = j_start, j_end<a name='2878'>
      DO k=kts,ktf<a name='2879'>
      DO i = i_start, i_end<a name='2880'>
<a name='2881'>
         mkrdxm=( (msfvx(i,j)+msfvx(i-1,j))/(msfvy(i,j)+msfvy(i-1,j)) )*    &amp;<a name='2882'>
                0.25*(MUT(i,j)+MUT(i,j-1)+MUT(i-1,j-1)+MUT(i-1,j))* &amp;<a name='2883'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j-1)+xkmhd(i-1,k,j-1)+xkmhd(i-1,k,j))*rdx<a name='2884'>
         mkrdxp=( (msfvx(i,j)+msfvx(i+1,j))/(msfvy(i,j)+msfvy(i+1,j)) )*    &amp;<a name='2885'>
                0.25*(MUT(i,j)+MUT(i,j-1)+MUT(i+1,j-1)+MUT(i+1,j))* &amp;<a name='2886'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j-1)+xkmhd(i+1,k,j-1)+xkmhd(i+1,k,j))*rdx<a name='2887'>
         mrdx=msfvx(i,j)*msfvy(i,j)*rdx<a name='2888'>
         mkrdym=(msfty(i,j-1)/msftx(i,j-1))*xkmhd(i,k,j-1)*rdy<a name='2889'>
         mkrdyp=(msfty(i,j)/msftx(i,j))*xkmhd(i,k,j)*rdy<a name='2890'>
         mrdy=msfvx(i,j)*msfvy(i,j)*rdy<a name='2891'>
<a name='2892'>
            tendency(i,k,j)=tendency(i,k,j)+( &amp;<a name='2893'>
                            mrdx*(mkrdxp*(field(i+1,k,j)-field(i  ,k,j))  &amp;<a name='2894'>
                                 -mkrdxm*(field(i  ,k,j)-field(i-1,k,j))) &amp;<a name='2895'>
                           +mrdy*(mkrdyp*(field(i,k,j+1)-field(i,k,j  ))  &amp;<a name='2896'>
                                 -mkrdym*(field(i,k,j  )-field(i,k,j-1))))<a name='2897'>
      ENDDO<a name='2898'>
      ENDDO<a name='2899'>
      ENDDO<a name='2900'>
   <a name='2901'>
   ELSE IF (name .EQ. 'w')THEN<a name='2902'>
<a name='2903'>
      i_start = its<a name='2904'>
      i_end   = MIN(ite,ide-1)<a name='2905'>
      j_start = jts<a name='2906'>
      j_end   = MIN(jte,jde-1)<a name='2907'>
<a name='2908'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2909'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2910'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2911'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='2912'>
      IF ( config_flags%periodic_x ) i_start = its<a name='2913'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='2914'>
<a name='2915'>
      DO j = j_start, j_end<a name='2916'>
      DO k=kts+1,ktf<a name='2917'>
      DO i = i_start, i_end<a name='2918'>
<a name='2919'>
         mkrdxm=(msfux(i,j)/msfuy(i,j))*   &amp;<a name='2920'>
                0.25*(MUT(i,j)+MUT(i-1,j)+MUT(i,j)+MUT(i-1,j))* &amp;<a name='2921'>
                0.25*(xkmhd(i,k,j)+xkmhd(i-1,k,j)+xkmhd(i,k-1,j)+xkmhd(i-1,k-1,j))*rdx<a name='2922'>
         mkrdxp=(msfux(i+1,j)/msfuy(i+1,j))*   &amp;<a name='2923'>
                0.25*(MUT(i+1,j)+MUT(i,j)+MUT(i+1,j)+MUT(i,j))* &amp;<a name='2924'>
                0.25*(xkmhd(i+1,k,j)+xkmhd(i,k,j)+xkmhd(i+1,k-1,j)+xkmhd(i,k-1,j))*rdx<a name='2925'>
         mrdx=msftx(i,j)*msfty(i,j)*rdx<a name='2926'>
<font color=#447700>!         mkrdym=(msfvy(i,j)/msfvx(i,j))*   &amp;<a name='2927'></font>
         mkrdym=(msfvy(i,j)*msfvx_inv(i,j))*   &amp;<a name='2928'>
                0.25*(MUT(i,j)+MUT(i,j-1)+MUT(i,j)+MUT(i,j-1))* &amp;<a name='2929'>
                0.25*(xkmhd(i,k,j)+xkmhd(i,k,j-1)+xkmhd(i,k-1,j)+xkmhd(i,k-1,j-1))*rdy<a name='2930'>
<font color=#447700>!         mkrdyp=(msfvy(i,j+1)/msfvx(i,j+1))*   &amp;<a name='2931'></font>
         mkrdyp=(msfvy(i,j+1)*msfvx_inv(i,j+1))*   &amp;<a name='2932'>
                0.25*(MUT(i,j+1)+MUT(i,j)+MUT(i,j+1)+MUT(i,j))* &amp;<a name='2933'>
                0.25*(xkmhd(i,k,j+1)+xkmhd(i,k,j)+xkmhd(i,k-1,j+1)+xkmhd(i,k-1,j))*rdy<a name='2934'>
         mrdy=msftx(i,j)*msfty(i,j)*rdy<a name='2935'>
<a name='2936'>
            tendency(i,k,j)=tendency(i,k,j)+( &amp;<a name='2937'>
                            mrdx*(mkrdxp*(field(i+1,k,j)-field(i  ,k,j)) &amp;<a name='2938'>
                                 -mkrdxm*(field(i  ,k,j)-field(i-1,k,j))) &amp;<a name='2939'>
                           +mrdy*(mkrdyp*(field(i,k,j+1)-field(i,k,j  )) &amp;<a name='2940'>
                                 -mkrdym*(field(i,k,j  )-field(i,k,j-1))))<a name='2941'>
      ENDDO<a name='2942'>
      ENDDO<a name='2943'>
      ENDDO<a name='2944'>
   <a name='2945'>
   ELSE<a name='2946'>
<a name='2947'>
<a name='2948'>
      i_start = its<a name='2949'>
      i_end   = MIN(ite,ide-1)<a name='2950'>
      j_start = jts<a name='2951'>
      j_end   = MIN(jte,jde-1)<a name='2952'>
<a name='2953'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2954'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2955'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='2956'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='2957'>
      IF ( config_flags%periodic_x ) i_start = its<a name='2958'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='2959'>
<a name='2960'>
      DO j = j_start, j_end<a name='2961'>
      DO k=kts,ktf<a name='2962'>
      DO i = i_start, i_end<a name='2963'>
<a name='2964'>
         mkrdxm=(msfux(i,j)/msfuy(i,j))*0.5*(xkmhd(i,k,j)+xkmhd(i-1,k,j))*0.5*(MUT(i,j)+MUT(i-1,j))*rdx<a name='2965'>
         mkrdxp=(msfux(i+1,j)/msfuy(i+1,j))*0.5*(xkmhd(i+1,k,j)+xkmhd(i,k,j))*0.5*(MUT(i+1,j)+MUT(i,j))*rdx<a name='2966'>
         mrdx=msftx(i,j)*msfty(i,j)*rdx<a name='2967'>
<font color=#447700>!         mkrdym=(msfvy(i,j)/msfvx(i,j))*0.5*(xkmhd(i,k,j)+xkmhd(i,k,j-1))*0.5*(MUT(i,j)+MUT(i,j-1))*rdy<a name='2968'></font>
         mkrdym=(msfvy(i,j)*msfvx_inv(i,j))*0.5*(xkmhd(i,k,j)+xkmhd(i,k,j-1))*0.5*(MUT(i,j)+MUT(i,j-1))*rdy<a name='2969'>
<font color=#447700>!         mkrdyp=(msfvy(i,j+1)/msfvx(i,j+1))*0.5*(xkmhd(i,k,j+1)+xkmhd(i,k,j))*0.5*(MUT(i,j+1)+MUT(i,j))*rdy<a name='2970'></font>
         mkrdyp=(msfvy(i,j+1)*msfvx_inv(i,j+1))*0.5*(xkmhd(i,k,j+1)+xkmhd(i,k,j))*0.5*(MUT(i,j+1)+MUT(i,j))*rdy<a name='2971'>
         mrdy=msftx(i,j)*msfty(i,j)*rdy<a name='2972'>
<a name='2973'>
            tendency(i,k,j)=tendency(i,k,j)+( &amp;<a name='2974'>
                            mrdx*(mkrdxp*(field(i+1,k,j)-field(i  ,k,j))  &amp;<a name='2975'>
                                 -mkrdxm*(field(i  ,k,j)-field(i-1,k,j))) &amp;<a name='2976'>
                           +mrdy*(mkrdyp*(field(i,k,j+1)-field(i,k,j  ))  &amp;<a name='2977'>
                                 -mkrdym*(field(i,k,j  )-field(i,k,j-1))))<a name='2978'>
      ENDDO<a name='2979'>
      ENDDO<a name='2980'>
      ENDDO<a name='2981'>
           <a name='2982'>
   ENDIF<a name='2983'>
<a name='2984'>
END SUBROUTINE horizontal_diffusion<a name='2985'>
<a name='2986'>
<font color=#447700>!-----------------------------------------------------------------------------------------<a name='2987'></font>
<a name='2988'>
<A NAME='HORIZONTAL_DIFFUSION_3DMP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION_3DMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2989'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>horizontal_diffusion_3dmp</font> ( name, field, tendency, MUT, c1, c2,  &amp; <A href='../../call_to/HORIZONTAL_DIFFUSION_3DMP.html' TARGET='index'>1</A><a name='2990'>
                                       config_flags, base_3d,               &amp;<a name='2991'>
                                       msfux, msfuy, msfvx, msfvx_inv,      &amp;<a name='2992'>
                                       msfvy, msftx, msfty,                 &amp;<a name='2993'>
                                       khdif, xkmhd, rdx, rdy,              &amp;<a name='2994'>
                                       ids, ide, jds, jde, kds, kde,        &amp;<a name='2995'>
                                       ims, ime, jms, jme, kms, kme,        &amp;<a name='2996'>
                                       its, ite, jts, jte, kts, kte        )<a name='2997'>
<a name='2998'>
   IMPLICIT NONE<a name='2999'>
   <a name='3000'>
   <font color=#447700>! Input data<a name='3001'></font>
   <a name='3002'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3003'>
<a name='3004'>
   INTEGER ,        INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3005'>
                                     ims, ime, jms, jme, kms, kme, &amp;<a name='3006'>
                                     its, ite, jts, jte, kts, kte<a name='3007'>
<a name='3008'>
   CHARACTER(LEN=1) ,                          INTENT(IN   ) :: name<a name='3009'>
<a name='3010'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field, &amp;<a name='3011'>
                                                                      xkmhd, &amp;<a name='3012'>
                                                                      base_3d<a name='3013'>
<a name='3014'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3015'>
<a name='3016'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: MUT<a name='3017'>
<a name='3018'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,      &amp;<a name='3019'>
                                                                    msfuy,      &amp;<a name='3020'>
                                                                    msfvx,      &amp;<a name='3021'>
                                                                    msfvx_inv,  &amp;<a name='3022'>
                                                                    msfvy,      &amp;<a name='3023'>
                                                                    msftx,      &amp;<a name='3024'>
                                                                    msfty<a name='3025'>
<a name='3026'>
   REAL , DIMENSION( kms:kme )           , INTENT(IN   ) :: c1, c2<a name='3027'>
<a name='3028'>
   REAL ,                                      INTENT(IN   ) :: rdx,       &amp;<a name='3029'>
                                                                rdy,       &amp;<a name='3030'>
                                                                khdif<a name='3031'>
<a name='3032'>
   <font color=#447700>! Local data<a name='3033'></font>
   <a name='3034'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3035'>
<a name='3036'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3037'>
<a name='3038'>
   REAL :: mrdx, mkrdxm, mkrdxp, &amp;<a name='3039'>
           mrdy, mkrdym, mkrdyp<a name='3040'>
<a name='3041'>
   LOGICAL :: specified<a name='3042'>
<a name='3043'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3044'></font>
<font color=#447700>!<a name='3045'></font>
<font color=#447700>!  horizontal_diffusion_3dmp computes the horizontal diffusion tendency<a name='3046'></font>
<font color=#447700>!  on model horizontal coordinate surfaces.  This routine computes diffusion<a name='3047'></font>
<font color=#447700>!  a perturbation scalar (field-base_3d).<a name='3048'></font>
<font color=#447700>!<a name='3049'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3050'></font>
<a name='3051'>
   specified = .false.<a name='3052'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3053'>
<a name='3054'>
   ktf=MIN(kte,kde-1)<a name='3055'>
   <a name='3056'>
      i_start = its<a name='3057'>
      i_end   = MIN(ite,ide-1)<a name='3058'>
      j_start = jts<a name='3059'>
      j_end   = MIN(jte,jde-1)<a name='3060'>
<a name='3061'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='3062'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='3063'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='3064'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='3065'>
      IF ( config_flags%periodic_x ) i_start = its<a name='3066'>
      IF ( config_flags%periodic_x ) i_end = MIN(ite,ide-1)<a name='3067'>
<a name='3068'>
      DO j = j_start, j_end<a name='3069'>
      DO k=kts,ktf<a name='3070'>
      DO i = i_start, i_end<a name='3071'>
<a name='3072'>
         mkrdxm=(msfux(i,j)/msfuy(i,j))*0.5*(xkmhd(i,k,j)+xkmhd(i-1,k,j))*0.5*(MUT(i,j)+MUT(i-1,j))*rdx<a name='3073'>
         mkrdxp=(msfux(i+1,j)/msfuy(i+1,j))*0.5*(xkmhd(i+1,k,j)+xkmhd(i,k,j))*0.5*(MUT(i+1,j)+MUT(i,j))*rdx<a name='3074'>
         mrdx=msftx(i,j)*msfty(i,j)*rdx<a name='3075'>
<font color=#447700>!         mkrdym=(msfvy(i,j)/msfvx(i,j))*0.5*(xkmhd(i,k,j)+xkmhd(i,k,j-1))*0.5*(MUT(i,j)+MUT(i,j-1))*rdy<a name='3076'></font>
<font color=#447700>!         mkrdyp=(msfvy(i,j+1)/msfvx(i,j+1))*0.5*(xkmhd(i,k,j+1)+xkmhd(i,k,j))*0.5*(MUT(i,j+1)+MUT(i,j))*rdy<a name='3077'></font>
         mkrdym=(msfvy(i,j)*msfvx_inv(i,j))*0.5*(xkmhd(i,k,j)+xkmhd(i,k,j-1))*0.5*(MUT(i,j)+MUT(i,j-1))*rdy<a name='3078'>
         mkrdyp=(msfvy(i,j+1)*msfvx_inv(i,j+1))*0.5*(xkmhd(i,k,j+1)+xkmhd(i,k,j))*0.5*(MUT(i,j+1)+MUT(i,j))*rdy<a name='3079'>
         mrdy=msftx(i,j)*msfty(i,j)*rdy<a name='3080'>
<a name='3081'>
            tendency(i,k,j)=tendency(i,k,j)+(                        &amp;<a name='3082'>
                    mrdx*( mkrdxp*(   field(i+1,k,j)  -field(i  ,k,j)      &amp;<a name='3083'>
                                   -base_3d(i+1,k,j)+base_3d(i  ,k,j) )    &amp;<a name='3084'>
                          -mkrdxm*(   field(i  ,k,j)  -field(i-1,k,j)      &amp;<a name='3085'>
                                   -base_3d(i  ,k,j)+base_3d(i-1,k,j) )  ) &amp;<a name='3086'>
                   +mrdy*( mkrdyp*(   field(i,k,j+1)  -field(i,k,j  )      &amp;<a name='3087'>
                                   -base_3d(i,k,j+1)+base_3d(i,k,j  ) )    &amp;<a name='3088'>
                          -mkrdym*(   field(i,k,j  )  -field(i,k,j-1)      &amp;<a name='3089'>
                                   -base_3d(i,k,j  )+base_3d(i,k,j-1) )  ) &amp;<a name='3090'>
                                                                         ) <a name='3091'>
      ENDDO<a name='3092'>
      ENDDO<a name='3093'>
      ENDDO<a name='3094'>
<a name='3095'>
END SUBROUTINE horizontal_diffusion_3dmp<a name='3096'>
<a name='3097'>
<font color=#447700>!-----------------------------------------------------------------------------------------<a name='3098'></font>
<a name='3099'>
<A NAME='VERTICAL_DIFFUSION'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3100'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion</font> ( name, field, tendency,        &amp; <A href='../../call_to/VERTICAL_DIFFUSION.html' TARGET='index'>2</A><a name='3101'>
                                config_flags, c1, c2,         &amp;<a name='3102'>
                                alt, MUT, rdn, rdnw, kvdif,   &amp;<a name='3103'>
                                ids, ide, jds, jde, kds, kde, &amp;<a name='3104'>
                                ims, ime, jms, jme, kms, kme, &amp;<a name='3105'>
                                its, ite, jts, jte, kts, kte )<a name='3106'>
<a name='3107'>
<a name='3108'>
   IMPLICIT NONE<a name='3109'>
   <a name='3110'>
   <font color=#447700>! Input data<a name='3111'></font>
   <a name='3112'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3113'>
<a name='3114'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3115'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='3116'>
                                 its, ite, jts, jte, kts, kte<a name='3117'>
<a name='3118'>
   CHARACTER(LEN=1) ,                          INTENT(IN   ) :: name<a name='3119'>
<a name='3120'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='3121'>
                                               INTENT(IN   ) :: field,    &amp;<a name='3122'>
                                                                alt<a name='3123'>
<a name='3124'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3125'>
<a name='3126'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: MUT<a name='3127'>
<a name='3128'>
   REAL , DIMENSION( kms:kme ) ,                   INTENT(IN   ) :: rdn, rdnw<a name='3129'>
<a name='3130'>
   REAL , DIMENSION( kms:kme )   ,                 INTENT(IN   ) :: c1, c2<a name='3131'>
<a name='3132'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='3133'>
   <a name='3134'>
   <font color=#447700>! Local data<a name='3135'></font>
   <a name='3136'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3137'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3138'>
<a name='3139'>
   REAL , DIMENSION(its:ite, jts:jte) :: vfluxm, vfluxp, zz<a name='3140'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='3141'>
<a name='3142'>
   REAL :: rdz<a name='3143'>
<a name='3144'>
   LOGICAL :: specified<a name='3145'>
<a name='3146'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3147'></font>
<font color=#447700>!<a name='3148'></font>
<font color=#447700>!  vertical_diffusion<a name='3149'></font>
<font color=#447700>!  computes vertical diffusion tendency.<a name='3150'></font>
<font color=#447700>!<a name='3151'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3152'></font>
<a name='3153'>
   specified = .false.<a name='3154'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3155'>
<a name='3156'>
   ktf=MIN(kte,kde-1)<a name='3157'>
   <a name='3158'>
   IF (name .EQ. 'w')THEN<a name='3159'>
<a name='3160'>
   <a name='3161'>
   i_start = its<a name='3162'>
   i_end   = MIN(ite,ide-1)<a name='3163'>
   j_start = jts<a name='3164'>
   j_end   = MIN(jte,jde-1)<a name='3165'>
<a name='3166'>
j_loop_w : DO j = j_start, j_end<a name='3167'>
<a name='3168'>
     DO k=kts,ktf-1<a name='3169'>
       DO i = i_start, i_end<a name='3170'>
          vflux(i,k)= (kvdif/alt(i,k,j))*rdnw(k)*(field(i,k+1,j)-field(i,k,j))<a name='3171'>
       ENDDO<a name='3172'>
     ENDDO<a name='3173'>
<a name='3174'>
     DO i = i_start, i_end<a name='3175'>
       vflux(i,ktf)=0.<a name='3176'>
     ENDDO<a name='3177'>
<a name='3178'>
     DO k=kts+1,ktf<a name='3179'>
       DO i = i_start, i_end<a name='3180'>
            tendency(i,k,j)=tendency(i,k,j)                                         &amp;<a name='3181'>
                              +rdn(k)*g*g/MUT(i,j)/(0.5*(alt(i,k,j)+alt(i,k-1,j)))  &amp;<a name='3182'>
                                         *(vflux(i,k)-vflux(i,k-1))<a name='3183'>
       ENDDO<a name='3184'>
     ENDDO<a name='3185'>
<a name='3186'>
    ENDDO j_loop_w<a name='3187'>
<a name='3188'>
   ELSE IF(name .EQ. 'm')THEN<a name='3189'>
<a name='3190'>
     i_start = its<a name='3191'>
     i_end   = MIN(ite,ide-1)<a name='3192'>
     j_start = jts<a name='3193'>
     j_end   = MIN(jte,jde-1)<a name='3194'>
<a name='3195'>
j_loop_s : DO j = j_start, j_end<a name='3196'>
<a name='3197'>
     DO k=kts,ktf-1<a name='3198'>
       DO i = i_start, i_end<a name='3199'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.5*(alt(i,k,j)+alt(i,k+1,j)))   &amp;<a name='3200'>
                  *(field(i,k+1,j)-field(i,k,j))<a name='3201'>
       ENDDO<a name='3202'>
     ENDDO<a name='3203'>
<a name='3204'>
     DO i = i_start, i_end<a name='3205'>
       vflux(i,0)=vflux(i,1)<a name='3206'>
     ENDDO<a name='3207'>
<a name='3208'>
     DO i = i_start, i_end<a name='3209'>
       vflux(i,ktf)=0.<a name='3210'>
     ENDDO<a name='3211'>
<a name='3212'>
     DO k=kts,ktf<a name='3213'>
       DO i = i_start, i_end<a name='3214'>
         tendency(i,k,j)=tendency(i,k,j)+g*g/MUT(i,j)/alt(i,k,j)  &amp;<a name='3215'>
                *rdnw(k)*(vflux(i,k)-vflux(i,k-1))<a name='3216'>
       ENDDO<a name='3217'>
     ENDDO<a name='3218'>
<a name='3219'>
 ENDDO j_loop_s<a name='3220'>
<a name='3221'>
   ENDIF<a name='3222'>
<a name='3223'>
END SUBROUTINE vertical_diffusion<a name='3224'>
<a name='3225'>
<a name='3226'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3227'></font>
<a name='3228'>
<A NAME='VERTICAL_DIFFUSION_MP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_MP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3229'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_mp</font> ( field, tendency, config_flags, &amp; <A href='../../call_to/VERTICAL_DIFFUSION_MP.html' TARGET='index'>1</A><a name='3230'>
                                   base, c1, c2,                  &amp;<a name='3231'>
                                   alt, MUT, rdn, rdnw, kvdif,    &amp;<a name='3232'>
                                   ids, ide, jds, jde, kds, kde,  &amp;<a name='3233'>
                                   ims, ime, jms, jme, kms, kme,  &amp;<a name='3234'>
                                   its, ite, jts, jte, kts, kte  )<a name='3235'>
<a name='3236'>
<a name='3237'>
   IMPLICIT NONE<a name='3238'>
   <a name='3239'>
   <font color=#447700>! Input data<a name='3240'></font>
   <a name='3241'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3242'>
<a name='3243'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3244'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='3245'>
                                 its, ite, jts, jte, kts, kte<a name='3246'>
<a name='3247'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='3248'>
                                               INTENT(IN   ) :: field,    &amp;<a name='3249'>
                                                                alt<a name='3250'>
<a name='3251'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3252'>
<a name='3253'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: MUT<a name='3254'>
<a name='3255'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: rdn,  &amp;<a name='3256'>
                                                                  rdnw, &amp;<a name='3257'>
                                                                  base<a name='3258'>
<a name='3259'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: c1, c2<a name='3260'>
<a name='3261'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='3262'>
   <a name='3263'>
   <font color=#447700>! Local data<a name='3264'></font>
   <a name='3265'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3266'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3267'>
<a name='3268'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='3269'>
<a name='3270'>
   REAL :: rdz<a name='3271'>
<a name='3272'>
   LOGICAL :: specified<a name='3273'>
<a name='3274'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3275'></font>
<font color=#447700>!<a name='3276'></font>
<font color=#447700>!  vertical_diffusion_mp<a name='3277'></font>
<font color=#447700>!  computes vertical diffusion tendency of a perturbation variable<a name='3278'></font>
<font color=#447700>!  (field-base).  Note that base as a 1D (k) field.<a name='3279'></font>
<font color=#447700>!<a name='3280'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3281'></font>
<a name='3282'>
   specified = .false.<a name='3283'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3284'>
<a name='3285'>
   ktf=MIN(kte,kde-1)<a name='3286'>
   <a name='3287'>
     i_start = its<a name='3288'>
     i_end   = MIN(ite,ide-1)<a name='3289'>
     j_start = jts<a name='3290'>
     j_end   = MIN(jte,jde-1)<a name='3291'>
<a name='3292'>
j_loop_s : DO j = j_start, j_end<a name='3293'>
<a name='3294'>
     DO k=kts,ktf-1<a name='3295'>
       DO i = i_start, i_end<a name='3296'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.5*(alt(i,k,j)+alt(i,k+1,j)))   &amp;<a name='3297'>
                    *(field(i,k+1,j)-field(i,k,j)-base(k+1)+base(k))<a name='3298'>
       ENDDO<a name='3299'>
     ENDDO<a name='3300'>
<a name='3301'>
     DO i = i_start, i_end<a name='3302'>
       vflux(i,0)=vflux(i,1)<a name='3303'>
     ENDDO<a name='3304'>
<a name='3305'>
     DO i = i_start, i_end<a name='3306'>
       vflux(i,ktf)=0.<a name='3307'>
     ENDDO<a name='3308'>
<a name='3309'>
     DO k=kts,ktf<a name='3310'>
       DO i = i_start, i_end<a name='3311'>
         tendency(i,k,j)=tendency(i,k,j)+g*g/MUT(i,j)/alt(i,k,j)  &amp;<a name='3312'>
                *rdnw(k)*(vflux(i,k)-vflux(i,k-1))<a name='3313'>
       ENDDO<a name='3314'>
     ENDDO<a name='3315'>
<a name='3316'>
 ENDDO j_loop_s<a name='3317'>
<a name='3318'>
END SUBROUTINE vertical_diffusion_mp<a name='3319'>
<a name='3320'>
<a name='3321'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3322'></font>
<a name='3323'>
<A NAME='VERTICAL_DIFFUSION_3DMP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_3DMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3324'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_3dmp</font> ( field, tendency, config_flags, &amp; <A href='../../call_to/VERTICAL_DIFFUSION_3DMP.html' TARGET='index'>1</A><a name='3325'>
                                     base_3d, c1, c2,               &amp;<a name='3326'>
                                     alt, MUT, rdn, rdnw, kvdif,    &amp;<a name='3327'>
                                     ids, ide, jds, jde, kds, kde,  &amp;<a name='3328'>
                                     ims, ime, jms, jme, kms, kme,  &amp;<a name='3329'>
                                     its, ite, jts, jte, kts, kte  )<a name='3330'>
<a name='3331'>
<a name='3332'>
   IMPLICIT NONE<a name='3333'>
   <a name='3334'>
   <font color=#447700>! Input data<a name='3335'></font>
   <a name='3336'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3337'>
<a name='3338'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3339'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='3340'>
                                 its, ite, jts, jte, kts, kte<a name='3341'>
<a name='3342'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='3343'>
                                               INTENT(IN   ) :: field,    &amp;<a name='3344'>
                                                                alt,      &amp;<a name='3345'>
                                                                base_3d<a name='3346'>
<a name='3347'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3348'>
<a name='3349'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: MUT<a name='3350'>
<a name='3351'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: rdn,  &amp;<a name='3352'>
                                                                  rdnw<a name='3353'>
<a name='3354'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: c1, c2<a name='3355'>
<a name='3356'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='3357'>
   <a name='3358'>
   <font color=#447700>! Local data<a name='3359'></font>
   <a name='3360'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3361'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3362'>
<a name='3363'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='3364'>
<a name='3365'>
   REAL :: rdz<a name='3366'>
<a name='3367'>
   LOGICAL :: specified<a name='3368'>
<a name='3369'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3370'></font>
<font color=#447700>!<a name='3371'></font>
<font color=#447700>!  vertical_diffusion_3dmp<a name='3372'></font>
<font color=#447700>!  computes vertical diffusion tendency of a perturbation variable<a name='3373'></font>
<font color=#447700>!  (field-base_3d).  <a name='3374'></font>
<font color=#447700>!<a name='3375'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3376'></font>
<a name='3377'>
   specified = .false.<a name='3378'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3379'>
<a name='3380'>
   ktf=MIN(kte,kde-1)<a name='3381'>
   <a name='3382'>
     i_start = its<a name='3383'>
     i_end   = MIN(ite,ide-1)<a name='3384'>
     j_start = jts<a name='3385'>
     j_end   = MIN(jte,jde-1)<a name='3386'>
<a name='3387'>
j_loop_s : DO j = j_start, j_end<a name='3388'>
<a name='3389'>
     DO k=kts,ktf-1<a name='3390'>
       DO i = i_start, i_end<a name='3391'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.5*(alt(i,k,j)+alt(i,k+1,j)))   &amp;<a name='3392'>
                    *(   field(i,k+1,j)  -field(i,k,j)               &amp;<a name='3393'>
                      -base_3d(i,k+1,j)+base_3d(i,k,j) )<a name='3394'>
       ENDDO<a name='3395'>
     ENDDO<a name='3396'>
<a name='3397'>
     DO i = i_start, i_end<a name='3398'>
       vflux(i,0)=vflux(i,1)<a name='3399'>
     ENDDO<a name='3400'>
<a name='3401'>
     DO i = i_start, i_end<a name='3402'>
       vflux(i,ktf)=0.<a name='3403'>
     ENDDO<a name='3404'>
<a name='3405'>
     DO k=kts,ktf<a name='3406'>
       DO i = i_start, i_end<a name='3407'>
         tendency(i,k,j)=tendency(i,k,j)+g*g/MUT(i,j)/alt(i,k,j)  &amp;<a name='3408'>
                *rdnw(k)*(vflux(i,k)-vflux(i,k-1))<a name='3409'>
       ENDDO<a name='3410'>
     ENDDO<a name='3411'>
<a name='3412'>
 ENDDO j_loop_s<a name='3413'>
<a name='3414'>
END SUBROUTINE vertical_diffusion_3dmp<a name='3415'>
<a name='3416'>
<a name='3417'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3418'></font>
<a name='3419'>
<a name='3420'>
<A NAME='VERTICAL_DIFFUSION_U'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_U' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3421'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_u</font> ( field, tendency,              &amp; <A href='../../call_to/VERTICAL_DIFFUSION_U.html' TARGET='index'>1</A><a name='3422'>
                                  config_flags, u_base, c1h,c2h,&amp;<a name='3423'>
                                  alt, muu, rdn, rdnw, kvdif,   &amp;<a name='3424'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='3425'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='3426'>
                                  its, ite, jts, jte, kts, kte )<a name='3427'>
<a name='3428'>
<a name='3429'>
   IMPLICIT NONE<a name='3430'>
   <a name='3431'>
   <font color=#447700>! Input data<a name='3432'></font>
   <a name='3433'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3434'>
<a name='3435'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3436'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='3437'>
                                 its, ite, jts, jte, kts, kte<a name='3438'>
<a name='3439'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='3440'>
                                               INTENT(IN   ) :: field,    &amp;<a name='3441'>
                                                                alt<a name='3442'>
<a name='3443'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3444'>
<a name='3445'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: muu<a name='3446'>
<a name='3447'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: rdn, rdnw, u_base<a name='3448'>
<a name='3449'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: c1h, c2h<a name='3450'>
<a name='3451'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='3452'>
   <a name='3453'>
   <font color=#447700>! Local data<a name='3454'></font>
   <a name='3455'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3456'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3457'>
<a name='3458'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='3459'>
<a name='3460'>
   REAL :: rdz, zz<a name='3461'>
<a name='3462'>
   LOGICAL :: specified<a name='3463'>
<a name='3464'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3465'></font>
<font color=#447700>!<a name='3466'></font>
<font color=#447700>!  vertical_diffusion_u computes vertical diffusion tendency for <a name='3467'></font>
<font color=#447700>!  the u momentum equation.  This routine assumes a constant eddy<a name='3468'></font>
<font color=#447700>!  viscosity kvdif.<a name='3469'></font>
<font color=#447700>!<a name='3470'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3471'></font>
<a name='3472'>
   specified = .false.<a name='3473'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3474'>
<a name='3475'>
   ktf=MIN(kte,kde-1)<a name='3476'>
<a name='3477'>
      i_start = its<a name='3478'>
      i_end   = ite<a name='3479'>
      j_start = jts<a name='3480'>
      j_end   = MIN(jte,jde-1)<a name='3481'>
<a name='3482'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='3483'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='3484'>
      IF ( config_flags%periodic_x ) i_start = its<a name='3485'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='3486'>
<a name='3487'>
<a name='3488'>
j_loop_u : DO j = j_start, j_end<a name='3489'>
<a name='3490'>
     DO k=kts,ktf-1<a name='3491'>
       DO i = i_start, i_end<a name='3492'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.25*( alt(i  ,k  ,j)      &amp;<a name='3493'>
                                        +alt(i-1,k  ,j)      &amp;<a name='3494'>
                                        +alt(i  ,k+1,j)      &amp;<a name='3495'>
                                        +alt(i-1,k+1,j) ) )  &amp;<a name='3496'>
                             *(field(i,k+1,j)-field(i,k,j)   &amp;<a name='3497'>
                               -u_base(k+1)   +u_base(k)  )<a name='3498'>
       ENDDO<a name='3499'>
     ENDDO<a name='3500'>
<a name='3501'>
     DO i = i_start, i_end<a name='3502'>
       vflux(i,0)=vflux(i,1)<a name='3503'>
     ENDDO<a name='3504'>
<a name='3505'>
     DO i = i_start, i_end<a name='3506'>
       vflux(i,ktf)=0.<a name='3507'>
     ENDDO<a name='3508'>
<a name='3509'>
     DO k=kts,ktf-1<a name='3510'>
       DO i = i_start, i_end<a name='3511'>
         tendency(i,k,j)=tendency(i,k,j)+                             &amp;<a name='3512'>
                g*g*rdnw(k)/muu(i,j)/(0.5*(alt(i-1,k,j)+alt(i,k,j)))* &amp;<a name='3513'>
                              (vflux(i,k)-vflux(i,k-1))<a name='3514'>
       ENDDO<a name='3515'>
     ENDDO<a name='3516'>
<a name='3517'>
 ENDDO j_loop_u<a name='3518'>
   <a name='3519'>
END SUBROUTINE vertical_diffusion_u<a name='3520'>
<a name='3521'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3522'></font>
<a name='3523'>
<a name='3524'>
<A NAME='VERTICAL_DIFFUSION_V'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3525'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>vertical_diffusion_v</font> ( field, tendency,              &amp; <A href='../../call_to/VERTICAL_DIFFUSION_V.html' TARGET='index'>1</A><a name='3526'>
                                  config_flags, v_base, c1h,c2h,&amp;<a name='3527'>
                                  alt, muv, rdn, rdnw, kvdif,   &amp;<a name='3528'>
                                  ids, ide, jds, jde, kds, kde, &amp;<a name='3529'>
                                  ims, ime, jms, jme, kms, kme, &amp;<a name='3530'>
                                  its, ite, jts, jte, kts, kte )<a name='3531'>
<a name='3532'>
<a name='3533'>
   IMPLICIT NONE<a name='3534'>
   <a name='3535'>
   <font color=#447700>! Input data<a name='3536'></font>
   <a name='3537'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3538'>
<a name='3539'>
   INTEGER ,    INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3540'>
                                 ims, ime, jms, jme, kms, kme, &amp;<a name='3541'>
                                 its, ite, jts, jte, kts, kte<a name='3542'>
<a name='3543'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                      &amp;<a name='3544'>
                                               INTENT(IN   ) :: field,    &amp;<a name='3545'>
                                                                alt<a name='3546'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: rdn, rdnw, v_base<a name='3547'>
<a name='3548'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: c1h, c2h<a name='3549'>
<a name='3550'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3551'>
<a name='3552'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: muv<a name='3553'>
<a name='3554'>
   REAL ,                                      INTENT(IN   ) :: kvdif<a name='3555'>
   <a name='3556'>
   <font color=#447700>! Local data<a name='3557'></font>
   <a name='3558'>
   INTEGER :: i, j, k, itf, jtf, ktf, jm1<a name='3559'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3560'>
<a name='3561'>
   REAL , DIMENSION(its:ite, 0:kte+1) :: vflux<a name='3562'>
<a name='3563'>
   REAL :: rdz, zz<a name='3564'>
<a name='3565'>
   LOGICAL :: specified<a name='3566'>
<a name='3567'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3568'></font>
<font color=#447700>!<a name='3569'></font>
<font color=#447700>!  vertical_diffusion_v computes vertical diffusion tendency for <a name='3570'></font>
<font color=#447700>!  the v momentum equation.  This routine assumes a constant eddy<a name='3571'></font>
<font color=#447700>!  viscosity kvdif.<a name='3572'></font>
<font color=#447700>!<a name='3573'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3574'></font>
<a name='3575'>
   specified = .false.<a name='3576'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3577'>
<a name='3578'>
   ktf=MIN(kte,kde-1)<a name='3579'>
   <a name='3580'>
      i_start = its<a name='3581'>
      i_end   = MIN(ite,ide-1)<a name='3582'>
      j_start = jts<a name='3583'>
      j_end   = MIN(jte,jde-1)<a name='3584'>
<a name='3585'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='3586'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-1,jte)<a name='3587'>
<a name='3588'>
j_loop_v : DO j = j_start, j_end<a name='3589'>
<font color=#447700>!     jm1 = max(j-1,1)<a name='3590'></font>
     jm1 = j-1<a name='3591'>
<a name='3592'>
     DO k=kts,ktf-1<a name='3593'>
       DO i = i_start, i_end<a name='3594'>
         vflux(i,k)=kvdif*rdn(k+1)/(0.25*( alt(i,k  ,j  )      &amp;<a name='3595'>
                                        +alt(i,k  ,jm1)      &amp;<a name='3596'>
                                        +alt(i,k+1,j  )      &amp;<a name='3597'>
                                        +alt(i,k+1,jm1) ) )  &amp;<a name='3598'>
                             *(field(i,k+1,j)-field(i,k,j)   &amp;<a name='3599'>
                               -v_base(k+1)   +v_base(k)  )<a name='3600'>
       ENDDO<a name='3601'>
     ENDDO<a name='3602'>
<a name='3603'>
     DO i = i_start, i_end<a name='3604'>
       vflux(i,0)=vflux(i,1)<a name='3605'>
     ENDDO<a name='3606'>
<a name='3607'>
     DO i = i_start, i_end<a name='3608'>
       vflux(i,ktf)=0.<a name='3609'>
     ENDDO<a name='3610'>
<a name='3611'>
     DO k=kts,ktf-1<a name='3612'>
       DO i = i_start, i_end <a name='3613'>
         tendency(i,k,j)=tendency(i,k,j)+                              &amp;<a name='3614'>
                g*g*rdnw(k)/muv(i,j)/(0.5*(alt(i,k,jm1)+alt(i,k,j)))*  &amp;<a name='3615'>
                              (vflux(i,k)-vflux(i,k-1))<a name='3616'>
       ENDDO<a name='3617'>
     ENDDO<a name='3618'>
<a name='3619'>
 ENDDO j_loop_v<a name='3620'>
   <a name='3621'>
END SUBROUTINE vertical_diffusion_v<a name='3622'>
<a name='3623'>
<font color=#447700>!***************  end new mass coordinate routines<a name='3624'></font>
<a name='3625'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='3626'></font>
<a name='3627'>
<A NAME='CALCULATE_FULL'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALCULATE_FULL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3628'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calculate_full</font> ( rfield, rfieldb, rfieldp,     &amp; <A href='../../call_to/CALCULATE_FULL.html' TARGET='index'>1</A><a name='3629'>
                            ids, ide, jds, jde, kds, kde, &amp;<a name='3630'>
                            ims, ime, jms, jme, kms, kme, &amp;<a name='3631'>
                            its, ite, jts, jte, kts, kte )<a name='3632'>
<a name='3633'>
   IMPLICIT NONE<a name='3634'>
   <a name='3635'>
   <font color=#447700>! Input data<a name='3636'></font>
   <a name='3637'>
   INTEGER ,      INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3638'>
                                   ims, ime, jms, jme, kms, kme, &amp;<a name='3639'>
                                   its, ite, jts, jte, kts, kte <a name='3640'>
   <a name='3641'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: rfieldb, &amp;<a name='3642'>
                                                                      rfieldp<a name='3643'>
<a name='3644'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT  ) :: rfield<a name='3645'>
   <a name='3646'>
   <font color=#447700>! Local indices.<a name='3647'></font>
   <a name='3648'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3649'>
   <a name='3650'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3651'></font>
<font color=#447700>!<a name='3652'></font>
<font color=#447700>!  calculate_full<a name='3653'></font>
<font color=#447700>!  calculates full 3D field from pertubation and base field.<a name='3654'></font>
<font color=#447700>!<a name='3655'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3656'></font>
<a name='3657'>
   itf=MIN(ite,ide-1)<a name='3658'>
   jtf=MIN(jte,jde-1)<a name='3659'>
   ktf=MIN(kte,kde-1)<a name='3660'>
<a name='3661'>
   DO j=jts,jtf<a name='3662'>
   DO k=kts,ktf<a name='3663'>
   DO i=its,itf<a name='3664'>
      rfield(i,k,j)=rfieldb(i,k,j)+rfieldp(i,k,j)<a name='3665'>
   ENDDO<a name='3666'>
   ENDDO<a name='3667'>
   ENDDO<a name='3668'>
<a name='3669'>
END SUBROUTINE calculate_full<a name='3670'>
<a name='3671'>
<font color=#447700>!------------------------------------------------------------------------------<a name='3672'></font>
<a name='3673'>
<A NAME='CORIOLIS'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CORIOLIS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3674'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>coriolis</font> ( ru, rv, rw, ru_tend, rv_tend, rw_tend, &amp; <A href='../../call_to/CORIOLIS.html' TARGET='index'>1</A><a name='3675'>
                      config_flags,                          &amp;<a name='3676'>
                      msftx, msfty, msfux, msfuy,            &amp;<a name='3677'>
                      msfvx, msfvy,                          &amp;<a name='3678'>
                      f, e, sina, cosa, fzm, fzp,            &amp;<a name='3679'>
                      ids, ide, jds, jde, kds, kde,          &amp;<a name='3680'>
                      ims, ime, jms, jme, kms, kme,          &amp;<a name='3681'>
                      its, ite, jts, jte, kts, kte          )<a name='3682'>
<a name='3683'>
   IMPLICIT NONE<a name='3684'>
   <a name='3685'>
   <font color=#447700>! Input data<a name='3686'></font>
   <a name='3687'>
   TYPE(grid_config_rec_type) ,           INTENT(IN   ) :: config_flags   <a name='3688'>
<a name='3689'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3690'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='3691'>
                                              its, ite, jts, jte, kts, kte<a name='3692'>
<a name='3693'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: ru_tend, &amp;<a name='3694'>
                                                                rv_tend, &amp;<a name='3695'>
                                                                rw_tend<a name='3696'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: ru, &amp;<a name='3697'>
                                                                rv, &amp;<a name='3698'>
                                                                rw<a name='3699'>
<a name='3700'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,      &amp;<a name='3701'>
                                                                msfuy,      &amp;<a name='3702'>
                                                                msfvx,      &amp;<a name='3703'>
                                                                msfvy,      &amp;<a name='3704'>
                                                                msftx,      &amp;<a name='3705'>
                                                                msfty<a name='3706'>
<a name='3707'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: f,    &amp;<a name='3708'>
                                                                    e,    &amp;<a name='3709'>
                                                                    sina, &amp;<a name='3710'>
                                                                    cosa<a name='3711'>
<a name='3712'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm, &amp;<a name='3713'>
                                                                  fzp<a name='3714'>
   <a name='3715'>
   <font color=#447700>! Local indices.<a name='3716'></font>
   <a name='3717'>
   INTEGER :: i, j , k, ktf<a name='3718'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3719'>
   <a name='3720'>
   LOGICAL :: specified<a name='3721'>
<a name='3722'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3723'></font>
<font color=#447700>!<a name='3724'></font>
<font color=#447700>!  coriolis calculates the large timestep tendency terms in the <a name='3725'></font>
<font color=#447700>!  u, v, and w momentum equations arise from the coriolis force.<a name='3726'></font>
<font color=#447700>!<a name='3727'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3728'></font>
<a name='3729'>
   specified = .false.<a name='3730'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3731'>
<a name='3732'>
   ktf=MIN(kte,kde-1)<a name='3733'>
<a name='3734'>
<font color=#447700>! coriolis for u-momentum equation<a name='3735'></font>
<a name='3736'>
<font color=#447700>!  Notes on map scale factor<a name='3737'></font>
<font color=#447700>!  cosa, sina are related to rotating the coordinate frame if desired<a name='3738'></font>
<font color=#447700>!  generally sina=0, cosa=1<a name='3739'></font>
<font color=#447700>!  ADT eqn 44, RHS terms 6 and 7: -2 mu w omega cos(lat)/my<a name='3740'></font>
<font color=#447700>!                                + 2 mu v omega sin(lat)/my<a name='3741'></font>
<font color=#447700>!  Define f=2 omega sin(lat), e=2 omega cos(lat)<a name='3742'></font>
<font color=#447700>!   =&gt; terms are: -e mu w / my + f mu v / my<a name='3743'></font>
<font color=#447700>!  rv = mu v / mx ; rw = mu w / my<a name='3744'></font>
<font color=#447700>!   =&gt; terms are: -e rw + f rv *mx / my<a name='3745'></font>
<a name='3746'>
   i_start = its<a name='3747'>
   i_end   = ite<a name='3748'>
   IF ( config_flags%open_xs .or. specified .or. &amp;<a name='3749'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3750'>
   IF ( config_flags%open_xe .or. specified .or. &amp;<a name='3751'>
        config_flags%nested) i_end   = MIN(ide-1,ite)<a name='3752'>
      IF ( config_flags%periodic_x ) i_start = its<a name='3753'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='3754'>
<a name='3755'>
   DO j = jts, MIN(jte,jde-1)<a name='3756'>
<a name='3757'>
   DO k=kts,ktf<a name='3758'>
   DO i = i_start, i_end<a name='3759'>
   <a name='3760'>
     ru_tend(i,k,j)=ru_tend(i,k,j) + (msfux(i,j)/msfuy(i,j))*0.5*(f(i,j)+f(i-1,j)) &amp;<a name='3761'>
       *0.25*(rv(i-1,k,j+1)+rv(i,k,j+1)+rv(i-1,k,j)+rv(i,k,j)) &amp;<a name='3762'>
           - 0.5*(e(i,j)+e(i-1,j))*0.5*(cosa(i,j)+cosa(i-1,j)) &amp;<a name='3763'>
       *0.25*(rw(i-1,k+1,j)+rw(i-1,k,j)+rw(i,k+1,j)+rw(i,k,j))<a name='3764'>
<a name='3765'>
   ENDDO<a name='3766'>
   ENDDO<a name='3767'>
<a name='3768'>
<font color=#447700>! boundary loops for coriolis not needed for open bdy  (commented out 20100611 JD)<a name='3769'></font>
<font color=#447700>!  IF ( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='3770'></font>
<a name='3771'>
<font color=#447700>!    DO k=kts,ktf<a name='3772'></font>
<font color=#447700>!  <a name='3773'></font>
<font color=#447700>!      ru_tend(its,k,j)=ru_tend(its,k,j) + (msfux(its,j)/msfuy(its,j))*0.5*(f(its,j)+f(its,j))   &amp;<a name='3774'></font>
<font color=#447700>!        *0.25*(rv(its,k,j+1)+rv(its,k,j+1)+rv(its,k,j)+rv(its,k,j)) &amp;<a name='3775'></font>
<font color=#447700>!            - 0.5*(e(its,j)+e(its,j))*0.5*(cosa(its,j)+cosa(its,j)) &amp;<a name='3776'></font>
<font color=#447700>!        *0.25*(rw(its,k+1,j)+rw(its,k,j)+rw(its,k+1,j)+rw(its,k,j))<a name='3777'></font>
<a name='3778'>
<font color=#447700>!    ENDDO<a name='3779'></font>
<a name='3780'>
<font color=#447700>!  ENDIF<a name='3781'></font>
<a name='3782'>
<font color=#447700>!  IF ( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='3783'></font>
<a name='3784'>
<font color=#447700>!    DO k=kts,ktf<a name='3785'></font>
<font color=#447700>!  <a name='3786'></font>
<font color=#447700>!      ru_tend(ite,k,j)=ru_tend(ite,k,j) + (msfux(ite,j)/msfuy(ite,j))*0.5*(f(ite-1,j)+f(ite-1,j)) &amp;<a name='3787'></font>
<font color=#447700>!        *0.25*(rv(ite-1,k,j+1)+rv(ite-1,k,j+1)+rv(ite-1,k,j)+rv(ite-1,k,j)) &amp;<a name='3788'></font>
<font color=#447700>!            - 0.5*(e(ite-1,j)+e(ite-1,j))*0.5*(cosa(ite-1,j)+cosa(ite-1,j)) &amp;<a name='3789'></font>
<font color=#447700>!        *0.25*(rw(ite-1,k+1,j)+rw(ite-1,k,j)+rw(ite-1,k+1,j)+rw(ite-1,k,j))<a name='3790'></font>
<a name='3791'>
<font color=#447700>!    ENDDO<a name='3792'></font>
<a name='3793'>
<font color=#447700>!  ENDIF<a name='3794'></font>
<a name='3795'>
   ENDDO<a name='3796'>
<a name='3797'>
<font color=#447700>!  coriolis term for v-momentum equation<a name='3798'></font>
<a name='3799'>
<font color=#447700>!  Notes on map scale factors<a name='3800'></font>
<font color=#447700>!  ADT eqn 45, RHS terms 6 and 6b [0 for sina=0]: -2 mu u omega sin(lat)/mx + ?<a name='3801'></font>
<font color=#447700>!  Define f=2 omega sin(lat), e=2 omega cos(lat)<a name='3802'></font>
<font color=#447700>!   =&gt; terms are: -f mu u / mx<a name='3803'></font>
<font color=#447700>!  ru = mu u / my ; rw = mu w / my<a name='3804'></font>
<font color=#447700>!   =&gt; terms are: -f ru *my / mx + ?<a name='3805'></font>
<a name='3806'>
   j_start = jts<a name='3807'>
   j_end   = jte<a name='3808'>
<a name='3809'>
   IF ( config_flags%open_ys .or. specified .or. &amp;<a name='3810'>
        config_flags%nested .or. config_flags%polar) j_start = MAX(jds+1,jts)<a name='3811'>
   IF ( config_flags%open_ye .or. specified .or. &amp;<a name='3812'>
        config_flags%nested .or. config_flags%polar) j_end   = MIN(jde-1,jte)<a name='3813'>
<a name='3814'>
<font color=#447700>! boundary loops for coriolis not needed for open bdy  (commented out 20100611 JD)<a name='3815'></font>
<font color=#447700>!  IF ( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='3816'></font>
<a name='3817'>
<font color=#447700>!    DO k=kts,ktf<a name='3818'></font>
<font color=#447700>!    DO i=its,MIN(ide-1,ite)<a name='3819'></font>
<font color=#447700>!  <a name='3820'></font>
<font color=#447700>!       rv_tend(i,k,jts)=rv_tend(i,k,jts) - (msfvy(i,jts)/msfvx(i,jts))*0.5*(f(i,jts)+f(i,jts))    &amp;<a name='3821'></font>
<font color=#447700>!        *0.25*(ru(i,k,jts)+ru(i+1,k,jts)+ru(i,k,jts)+ru(i+1,k,jts))   &amp;<a name='3822'></font>
<font color=#447700>!            + (msfvy(i,jts)/msfvx(i,jts))*0.5*(e(i,jts)+e(i,jts))*0.5*(sina(i,jts)+sina(i,jts))   &amp;<a name='3823'></font>
<font color=#447700>!            *0.25*(rw(i,k+1,jts)+rw(i,k,jts)+rw(i,k+1,jts)+rw(i,k,jts)) <a name='3824'></font>
<a name='3825'>
<font color=#447700>!    ENDDO<a name='3826'></font>
<font color=#447700>!    ENDDO<a name='3827'></font>
<a name='3828'>
<font color=#447700>!  ENDIF<a name='3829'></font>
<a name='3830'>
   DO j=j_start, j_end<a name='3831'>
   DO k=kts,ktf<a name='3832'>
   DO i=its,MIN(ide-1,ite)<a name='3833'>
   <a name='3834'>
      rv_tend(i,k,j)=rv_tend(i,k,j) - (msfvy(i,j)/msfvx(i,j))*0.5*(f(i,j)+f(i,j-1))    &amp;<a name='3835'>
       *0.25*(ru(i,k,j)+ru(i+1,k,j)+ru(i,k,j-1)+ru(i+1,k,j-1)) &amp;<a name='3836'>
           + (msfvy(i,j)/msfvx(i,j))*0.5*(e(i,j)+e(i,j-1))*0.5*(sina(i,j)+sina(i,j-1)) &amp;<a name='3837'>
           *0.25*(rw(i,k+1,j-1)+rw(i,k,j-1)+rw(i,k+1,j)+rw(i,k,j)) <a name='3838'>
<a name='3839'>
   ENDDO<a name='3840'>
   ENDDO<a name='3841'>
   ENDDO<a name='3842'>
<a name='3843'>
<a name='3844'>
<font color=#447700>! boundary loops for coriolis not needed for open bdy  (commented out 20100611 JD)<a name='3845'></font>
<font color=#447700>!  IF ( (config_flags%open_ye) .and. (jte == jde) ) THEN<a name='3846'></font>
<a name='3847'>
<font color=#447700>!    DO k=kts,ktf<a name='3848'></font>
<font color=#447700>!    DO i=its,MIN(ide-1,ite)<a name='3849'></font>
<font color=#447700>!  <a name='3850'></font>
<font color=#447700>!       rv_tend(i,k,jte)=rv_tend(i,k,jte) - (msfvy(i,jte)/msfvx(i,jte))*0.5*(f(i,jte-1)+f(i,jte-1))        &amp;<a name='3851'></font>
<font color=#447700>!        *0.25*(ru(i,k,jte-1)+ru(i+1,k,jte-1)+ru(i,k,jte-1)+ru(i+1,k,jte-1))   &amp;<a name='3852'></font>
<font color=#447700>!            + (msfvy(i,jte)/msfvx(i,jte))*0.5*(e(i,jte-1)+e(i,jte-1))*0.5*(sina(i,jte-1)+sina(i,jte-1))   &amp;<a name='3853'></font>
<font color=#447700>!            *0.25*(rw(i,k+1,jte-1)+rw(i,k,jte-1)+rw(i,k+1,jte-1)+rw(i,k,jte-1)) <a name='3854'></font>
<a name='3855'>
<font color=#447700>!    ENDDO<a name='3856'></font>
<font color=#447700>!    ENDDO<a name='3857'></font>
<a name='3858'>
<font color=#447700>!  ENDIF<a name='3859'></font>
<a name='3860'>
<font color=#447700>! coriolis term for w-mometum <a name='3861'></font>
<a name='3862'>
<font color=#447700>! Notes on map scale factors<a name='3863'></font>
<font color=#447700>! ADT eqn 46/my, RHS terms 5 and 5b [0 for sina=0]: 2 mu u omega cos(lat)/my +?<a name='3864'></font>
<font color=#447700>! Define e=2 omega cos(lat)<a name='3865'></font>
<font color=#447700>!  =&gt; terms are: e mu u / my + ???<a name='3866'></font>
<font color=#447700>! ru = mu u / my ; ru = mu v / mx<a name='3867'></font>
<font color=#447700>!  =&gt; terms are: e ru + ???<a name='3868'></font>
<a name='3869'>
   DO j=jts,MIN(jte, jde-1)<a name='3870'>
   DO k=kts+1,ktf<a name='3871'>
   DO i=its,MIN(ite, ide-1)<a name='3872'>
<a name='3873'>
       rw_tend(i,k,j)=rw_tend(i,k,j) + e(i,j)*           &amp;<a name='3874'>
          (cosa(i,j)*0.5*(fzm(k)*(ru(i,k,j)+ru(i+1,k,j)) &amp;<a name='3875'>
          +fzp(k)*(ru(i,k-1,j)+ru(i+1,k-1,j)))           &amp;<a name='3876'>
          -(msftx(i,j)/msfty(i,j))*                      &amp;<a name='3877'>
           sina(i,j)*0.5*(fzm(k)*(rv(i,k,j)+rv(i,k,j+1)) &amp;<a name='3878'>
          +fzp(k)*(rv(i,k-1,j)+rv(i,k-1,j+1))))<a name='3879'>
<a name='3880'>
   ENDDO<a name='3881'>
   ENDDO<a name='3882'>
   ENDDO<a name='3883'>
<a name='3884'>
END SUBROUTINE coriolis<a name='3885'>
<a name='3886'>
<font color=#447700>!------------------------------------------------------------------------------<a name='3887'></font>
<a name='3888'>
<A NAME='PERTURBATION_CORIOLIS'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PERTURBATION_CORIOLIS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3889'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>perturbation_coriolis</font> ( ru_in, rv_in, rw, ru_tend, rv_tend, rw_tend, &amp; <A href='../../call_to/PERTURBATION_CORIOLIS.html' TARGET='index'>1</A><a name='3890'>
                                   config_flags,                                &amp;<a name='3891'>
                                   u_base, v_base, z_base,                      &amp;<a name='3892'>
                                   muu, muv, c1h, c2h, phb, ph,                 &amp;<a name='3893'>
                                   msftx, msfty, msfux, msfuy, msfvx, msfvy,    &amp;<a name='3894'>
                                   f, e, sina, cosa, fzm, fzp,                  &amp;<a name='3895'>
                                   ids, ide, jds, jde, kds, kde,                &amp;<a name='3896'>
                                   ims, ime, jms, jme, kms, kme,                &amp;<a name='3897'>
                                   its, ite, jts, jte, kts, kte                )<a name='3898'>
<a name='3899'>
   IMPLICIT NONE<a name='3900'>
   <a name='3901'>
   <font color=#447700>! Input data<a name='3902'></font>
   <a name='3903'>
   TYPE(grid_config_rec_type) ,           INTENT(IN   ) :: config_flags   <a name='3904'>
<a name='3905'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3906'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='3907'>
                                              its, ite, jts, jte, kts, kte<a name='3908'>
<a name='3909'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: ru_tend, &amp;<a name='3910'>
                                                                rv_tend, &amp;<a name='3911'>
                                                                rw_tend<a name='3912'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: ru_in, &amp;<a name='3913'>
                                                                      rv_in, &amp;<a name='3914'>
                                                                      rw,    &amp;<a name='3915'>
                                                                      ph,    &amp;<a name='3916'>
                                                                      phb<a name='3917'>
<a name='3918'>
<a name='3919'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,      &amp;<a name='3920'>
                                                                msfuy,      &amp;<a name='3921'>
                                                                msfvx,      &amp;<a name='3922'>
                                                                msfvy,      &amp;<a name='3923'>
                                                                msftx,      &amp;<a name='3924'>
                                                                msfty<a name='3925'>
<a name='3926'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: f,    &amp;<a name='3927'>
                                                                    e,    &amp;<a name='3928'>
                                                                    sina, &amp;<a name='3929'>
                                                                    cosa<a name='3930'>
<a name='3931'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: muu, &amp;<a name='3932'>
                                                                    muv<a name='3933'>
                                                                    <a name='3934'>
<a name='3935'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm, &amp;<a name='3936'>
                                                                  fzp<a name='3937'>
<a name='3938'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: u_base,  &amp;<a name='3939'>
                                                                  v_base,  &amp;<a name='3940'>
                                                                  z_base<a name='3941'>
<a name='3942'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: c1h, c2h<a name='3943'>
   <a name='3944'>
   <font color=#447700>! Local storage<a name='3945'></font>
<a name='3946'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) :: ru, &amp;<a name='3947'>
                                                      rv<a name='3948'>
<a name='3949'>
   REAL  :: z_at_u, z_at_v, wkp1, wk, wkm1<a name='3950'>
<a name='3951'>
   <font color=#447700>! Local indices.<a name='3952'></font>
   <a name='3953'>
   INTEGER :: i, j , k, ktf<a name='3954'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3955'>
   <a name='3956'>
   LOGICAL :: specified<a name='3957'>
<a name='3958'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3959'></font>
<font color=#447700>!<a name='3960'></font>
<font color=#447700>!  perturbation_coriolis calculates the large timestep tendency terms in the <a name='3961'></font>
<font color=#447700>!  u, v, and w momentum equations arise from the coriolis force.  This version<a name='3962'></font>
<font color=#447700>!  subtracts off the horizontal velocities from the initial sounding when<a name='3963'></font>
<font color=#447700>!  computing the forcing terms, hence "perturbation" coriolis.<a name='3964'></font>
<font color=#447700>!<a name='3965'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3966'></font>
<a name='3967'>
   specified = .false.<a name='3968'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3969'>
<a name='3970'>
   ktf=MIN(kte,kde-1)<a name='3971'>
<a name='3972'>
<font color=#447700>! coriolis for u-momentum equation<a name='3973'></font>
<a name='3974'>
   i_start = its<a name='3975'>
   i_end   = ite<a name='3976'>
   IF ( config_flags%open_xs .or. specified .or. &amp;<a name='3977'>
        config_flags%nested) i_start = MAX(ids+1,its)<a name='3978'>
   IF ( config_flags%open_xe .or. specified .or. &amp;<a name='3979'>
        config_flags%nested) i_end   = MIN(ide-1,ite)<a name='3980'>
      IF ( config_flags%periodic_x ) i_start = its<a name='3981'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='3982'>
<a name='3983'>
<font color=#447700>!  compute perturbation mu*v for use in u momentum equation<a name='3984'></font>
<a name='3985'>
   DO j = jts, MIN(jte,jde-1)+1<a name='3986'>
   DO k=kts+1,ktf-1<a name='3987'>
   DO i = i_start-1, i_end<a name='3988'>
     z_at_v = 0.25*( phb(i,k,j  )+phb(i,k+1,j  )  &amp;<a name='3989'>
                    +phb(i,k,j-1)+phb(i,k+1,j-1)  &amp;<a name='3990'>
                    +ph(i,k,j  )+ph(i,k+1,j  )    &amp;<a name='3991'>
                    +ph(i,k,j-1)+ph(i,k+1,j-1))/g<a name='3992'>
     wkp1 = min(1.,max(0.,z_at_v-z_base(k))/(z_base(k+1)-z_base(k)))<a name='3993'>
     wkm1 = min(1.,max(0.,z_base(k)-z_at_v)/(z_base(k)-z_base(k-1)))<a name='3994'>
     wk   = 1.-wkp1-wkm1<a name='3995'>
     rv(i,k,j) = rv_in(i,k,j) - muv(i,j)*(            &amp;<a name='3996'>
                                  wkm1*v_base(k-1)    &amp;<a name='3997'>
                                 +wk  *v_base(k  )    &amp;<a name='3998'>
                                 +wkp1*v_base(k+1)   )<a name='3999'>
   ENDDO<a name='4000'>
   ENDDO<a name='4001'>
   ENDDO<a name='4002'>
<a name='4003'>
<a name='4004'>
<font color=#447700>!  pick up top and bottom v <a name='4005'></font>
<a name='4006'>
   DO j = jts, MIN(jte,jde-1)+1<a name='4007'>
   DO i = i_start-1, i_end<a name='4008'>
<a name='4009'>
     k = kts<a name='4010'>
     z_at_v = 0.25*( phb(i,k,j  )+phb(i,k+1,j  )  &amp;<a name='4011'>
                    +phb(i,k,j-1)+phb(i,k+1,j-1)  &amp;<a name='4012'>
                    +ph(i,k,j  )+ph(i,k+1,j  )    &amp;<a name='4013'>
                    +ph(i,k,j-1)+ph(i,k+1,j-1))/g<a name='4014'>
     wkp1 = min(1.,max(0.,z_at_v-z_base(k))/(z_base(k+1)-z_base(k)))<a name='4015'>
     wk   = 1.-wkp1<a name='4016'>
     rv(i,k,j) = rv_in(i,k,j) - muv(i,j)*(            &amp;<a name='4017'>
                                 +wk  *v_base(k  )    &amp;<a name='4018'>
                                 +wkp1*v_base(k+1)   )<a name='4019'>
<a name='4020'>
     k = ktf<a name='4021'>
     z_at_v = 0.25*( phb(i,k,j  )+phb(i,k+1,j  )  &amp;<a name='4022'>
                    +phb(i,k,j-1)+phb(i,k+1,j-1)  &amp;<a name='4023'>
                    +ph(i,k,j  )+ph(i,k+1,j  )    &amp;<a name='4024'>
                    +ph(i,k,j-1)+ph(i,k+1,j-1))/g<a name='4025'>
     wkm1 = min(1.,max(0.,z_base(k)-z_at_v)/(z_base(k)-z_base(k-1)))<a name='4026'>
     wk   = 1.-wkm1<a name='4027'>
     rv(i,k,j) = rv_in(i,k,j) - muv(i,j)*(            &amp;<a name='4028'>
                                  wkm1*v_base(k-1)    &amp;<a name='4029'>
                                 +wk  *v_base(k  )   )<a name='4030'>
<a name='4031'>
   ENDDO<a name='4032'>
   ENDDO<a name='4033'>
<a name='4034'>
<font color=#447700>!  compute coriolis forcing for u<a name='4035'></font>
<a name='4036'>
<font color=#447700>!  Map scale factors: see comments above for Coriolis<a name='4037'></font>
<a name='4038'>
   DO j = jts, MIN(jte,jde-1)<a name='4039'>
<a name='4040'>
   DO k=kts,ktf<a name='4041'>
     DO i = i_start, i_end<a name='4042'>
       ru_tend(i,k,j)=ru_tend(i,k,j) + (msfux(i,j)/msfuy(i,j))*0.5*(f(i,j)+f(i-1,j)) &amp;<a name='4043'>
         *0.25*(rv(i-1,k,j+1)+rv(i,k,j+1)+rv(i-1,k,j)+rv(i,k,j)) &amp;<a name='4044'>
             - 0.5*(e(i,j)+e(i-1,j))*0.5*(cosa(i,j)+cosa(i-1,j)) &amp;<a name='4045'>
         *0.25*(rw(i-1,k+1,j)+rw(i-1,k,j)+rw(i,k+1,j)+rw(i,k,j))<a name='4046'>
     ENDDO<a name='4047'>
   ENDDO<a name='4048'>
<a name='4049'>
<font color=#447700>! boundary loops for perturbation coriolis is needed for open bdy  (20110225 JD)<a name='4050'></font>
   IF ( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='4051'>
<a name='4052'>
     DO k=kts,ktf<a name='4053'>
   <a name='4054'>
       ru_tend(its,k,j)=ru_tend(its,k,j) + (msfux(its,j)/msfuy(its,j))*0.5*(f(its,j)+f(its,j))   &amp;<a name='4055'>
         *0.25*(rv(its,k,j+1)+rv(its,k,j+1)+rv(its,k,j)+rv(its,k,j)) &amp;<a name='4056'>
             - 0.5*(e(its,j)+e(its,j))*0.5*(cosa(its,j)+cosa(its,j)) &amp;<a name='4057'>
         *0.25*(rw(its,k+1,j)+rw(its,k,j)+rw(its,k+1,j)+rw(its,k,j))<a name='4058'>
<a name='4059'>
     ENDDO<a name='4060'>
<a name='4061'>
   ENDIF<a name='4062'>
<a name='4063'>
   IF ( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='4064'>
<a name='4065'>
     DO k=kts,ktf<a name='4066'>
   <a name='4067'>
       ru_tend(ite,k,j)=ru_tend(ite,k,j) + (msfux(ite,j)/msfuy(ite,j))*0.5*(f(ite-1,j)+f(ite-1,j)) &amp;<a name='4068'>
         *0.25*(rv(ite-1,k,j+1)+rv(ite-1,k,j+1)+rv(ite-1,k,j)+rv(ite-1,k,j)) &amp;<a name='4069'>
             - 0.5*(e(ite-1,j)+e(ite-1,j))*0.5*(cosa(ite-1,j)+cosa(ite-1,j)) &amp;<a name='4070'>
         *0.25*(rw(ite-1,k+1,j)+rw(ite-1,k,j)+rw(ite-1,k+1,j)+rw(ite-1,k,j))<a name='4071'>
<a name='4072'>
     ENDDO<a name='4073'>
<a name='4074'>
   ENDIF<a name='4075'>
<a name='4076'>
   ENDDO<a name='4077'>
<a name='4078'>
<font color=#447700>!  coriolis term for v-momentum equation<a name='4079'></font>
<font color=#447700>!  Map scale factors: see comments above for Coriolis<a name='4080'></font>
<a name='4081'>
   j_start = jts<a name='4082'>
   j_end   = jte<a name='4083'>
<a name='4084'>
   IF ( config_flags%open_ys .or. specified .or. &amp;<a name='4085'>
        config_flags%nested .or. config_flags%polar) j_start = MAX(jds+1,jts)<a name='4086'>
   IF ( config_flags%open_ye .or. specified .or. &amp;<a name='4087'>
        config_flags%nested .or. config_flags%polar) j_end   = MIN(jde-1,jte)<a name='4088'>
<a name='4089'>
<font color=#447700>!  compute perturbation mu*u for use in v momentum equation<a name='4090'></font>
<a name='4091'>
   DO j = j_start-1,j_end<a name='4092'>
   DO k=kts+1,ktf-1<a name='4093'>
   DO i = its, MIN(ite,ide-1)+1<a name='4094'>
     z_at_u = 0.25*( phb(i  ,k,j)+phb(i  ,k+1,j)  &amp;<a name='4095'>
                    +phb(i-1,k,j)+phb(i-1,k+1,j)  &amp;<a name='4096'>
                    +ph(i  ,k,j)+ph(i  ,k+1,j)    &amp;<a name='4097'>
                    +ph(i-1,k,j)+ph(i-1,k+1,j))/g<a name='4098'>
     wkp1 = min(1.,max(0.,z_at_u-z_base(k))/(z_base(k+1)-z_base(k)))<a name='4099'>
     wkm1 = min(1.,max(0.,z_base(k)-z_at_u)/(z_base(k)-z_base(k-1)))<a name='4100'>
     wk   = 1.-wkp1-wkm1<a name='4101'>
     ru(i,k,j) = ru_in(i,k,j) - muu(i,j)*(            &amp;<a name='4102'>
                                  wkm1*u_base(k-1)    &amp;<a name='4103'>
                                 +wk  *u_base(k  )    &amp;<a name='4104'>
                                 +wkp1*u_base(k+1)   )<a name='4105'>
   ENDDO<a name='4106'>
   ENDDO<a name='4107'>
   ENDDO<a name='4108'>
<a name='4109'>
<font color=#447700>!  pick up top and bottom u<a name='4110'></font>
<a name='4111'>
   DO j = j_start-1,j_end<a name='4112'>
   DO i = its, MIN(ite,ide-1)+1<a name='4113'>
<a name='4114'>
     k = kts<a name='4115'>
     z_at_u = 0.25*( phb(i  ,k,j)+phb(i  ,k+1,j)  &amp;<a name='4116'>
                    +phb(i-1,k,j)+phb(i-1,k+1,j)  &amp;<a name='4117'>
                    +ph(i  ,k,j)+ph(i  ,k+1,j)    &amp;<a name='4118'>
                    +ph(i-1,k,j)+ph(i-1,k+1,j))/g<a name='4119'>
     wkp1 = min(1.,max(0.,z_at_u-z_base(k))/(z_base(k+1)-z_base(k)))<a name='4120'>
     wk   = 1.-wkp1<a name='4121'>
     ru(i,k,j) = ru_in(i,k,j) - muu(i,j)*(            &amp;<a name='4122'>
                                 +wk  *u_base(k  )    &amp;<a name='4123'>
                                 +wkp1*u_base(k+1)   )<a name='4124'>
<a name='4125'>
<a name='4126'>
     k = ktf<a name='4127'>
     z_at_u = 0.25*( phb(i  ,k,j)+phb(i  ,k+1,j)  &amp;<a name='4128'>
                    +phb(i-1,k,j)+phb(i-1,k+1,j)  &amp;<a name='4129'>
                    +ph(i  ,k,j)+ph(i  ,k+1,j)    &amp;<a name='4130'>
                    +ph(i-1,k,j)+ph(i-1,k+1,j))/g<a name='4131'>
     wkm1 = min(1.,max(0.,z_base(k)-z_at_u)/(z_base(k)-z_base(k-1)))<a name='4132'>
     wk   = 1.-wkm1<a name='4133'>
     ru(i,k,j) = ru_in(i,k,j) - muu(i,j)*(            &amp;<a name='4134'>
                                  wkm1*u_base(k-1)    &amp;<a name='4135'>
                                 +wk  *u_base(k  )   )<a name='4136'>
<a name='4137'>
   ENDDO<a name='4138'>
   ENDDO<a name='4139'>
<a name='4140'>
<font color=#447700>!  compute coriolis forcing for v momentum equation<a name='4141'></font>
<font color=#447700>!  Map scale factors: see comments above for Coriolis<a name='4142'></font>
<a name='4143'>
<font color=#447700>! boundary loops for perturbation coriolis is needed for open bdy  (20110225 JD)<a name='4144'></font>
   IF ( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='4145'>
<a name='4146'>
     DO k=kts,ktf<a name='4147'>
     DO i=its,MIN(ide-1,ite)<a name='4148'>
   <a name='4149'>
        rv_tend(i,k,jts)=rv_tend(i,k,jts) - (msfvy(i,jts)/msfvx(i,jts))*0.5*(f(i,jts)+f(i,jts))    &amp;<a name='4150'>
         *0.25*(ru(i,k,jts)+ru(i+1,k,jts)+ru(i,k,jts)+ru(i+1,k,jts))   &amp;<a name='4151'>
             + (msfvy(i,jts)/msfvx(i,jts))*0.5*(e(i,jts)+e(i,jts))*0.5*(sina(i,jts)+sina(i,jts))   &amp;<a name='4152'>
             *0.25*(rw(i,k+1,jts)+rw(i,k,jts)+rw(i,k+1,jts)+rw(i,k,jts)) <a name='4153'>
<a name='4154'>
     ENDDO<a name='4155'>
     ENDDO<a name='4156'>
<a name='4157'>
   ENDIF<a name='4158'>
<a name='4159'>
   DO j=j_start, j_end<a name='4160'>
   DO k=kts,ktf<a name='4161'>
   DO i=its,MIN(ide-1,ite)<a name='4162'>
   <a name='4163'>
      rv_tend(i,k,j)=rv_tend(i,k,j) - (msfvy(i,j)/msfvx(i,j))*0.5*(f(i,j)+f(i,j-1))    &amp;<a name='4164'>
       *0.25*(ru(i,k,j)+ru(i+1,k,j)+ru(i,k,j-1)+ru(i+1,k,j-1)) &amp;<a name='4165'>
           + (msfvy(i,j)/msfvx(i,j))*0.5*(e(i,j)+e(i,j-1))*0.5*(sina(i,j)+sina(i,j-1)) &amp;<a name='4166'>
           *0.25*(rw(i,k+1,j-1)+rw(i,k,j-1)+rw(i,k+1,j)+rw(i,k,j)) <a name='4167'>
<a name='4168'>
   ENDDO<a name='4169'>
   ENDDO<a name='4170'>
   ENDDO<a name='4171'>
<a name='4172'>
<a name='4173'>
<font color=#447700>! boundary loops for perturbation coriolis is needed for open bdy  (20110225 JD)<a name='4174'></font>
   IF ( (config_flags%open_ye) .and. (jte == jde) ) THEN<a name='4175'>
<a name='4176'>
     DO k=kts,ktf<a name='4177'>
     DO i=its,MIN(ide-1,ite)<a name='4178'>
   <a name='4179'>
        rv_tend(i,k,jte)=rv_tend(i,k,jte) - (msfvy(i,jte)/msfvx(i,jte))*0.5*(f(i,jte-1)+f(i,jte-1))        &amp;<a name='4180'>
         *0.25*(ru(i,k,jte-1)+ru(i+1,k,jte-1)+ru(i,k,jte-1)+ru(i+1,k,jte-1))   &amp;<a name='4181'>
             + (msfvy(i,jte)/msfvx(i,jte))*0.5*(e(i,jte-1)+e(i,jte-1))*0.5*(sina(i,jte-1)+sina(i,jte-1))   &amp;<a name='4182'>
             *0.25*(rw(i,k+1,jte-1)+rw(i,k,jte-1)+rw(i,k+1,jte-1)+rw(i,k,jte-1)) <a name='4183'>
<a name='4184'>
     ENDDO<a name='4185'>
     ENDDO<a name='4186'>
<a name='4187'>
   ENDIF<a name='4188'>
<a name='4189'>
<font color=#447700>! coriolis term for w-mometum <a name='4190'></font>
<font color=#447700>!  Map scale factors: see comments above for Coriolis<a name='4191'></font>
<a name='4192'>
   DO j=jts,MIN(jte, jde-1)<a name='4193'>
   DO k=kts+1,ktf<a name='4194'>
   DO i=its,MIN(ite, ide-1)<a name='4195'>
<a name='4196'>
       rw_tend(i,k,j)=rw_tend(i,k,j) + e(i,j)*           &amp;<a name='4197'>
          (cosa(i,j)*0.5*(fzm(k)*(ru(i,k,j)+ru(i+1,k,j)) &amp;<a name='4198'>
          +fzp(k)*(ru(i,k-1,j)+ru(i+1,k-1,j)))           &amp;<a name='4199'>
          -(msftx(i,j)/msfty(i,j))*sina(i,j)*0.5*(fzm(k)*(rv(i,k,j)+rv(i,k,j+1)) &amp;<a name='4200'>
          +fzp(k)*(rv(i,k-1,j)+rv(i,k-1,j+1))))<a name='4201'>
<a name='4202'>
   ENDDO<a name='4203'>
   ENDDO<a name='4204'>
   ENDDO<a name='4205'>
<a name='4206'>
END SUBROUTINE perturbation_coriolis<a name='4207'>
<a name='4208'>
<font color=#447700>!------------------------------------------------------------------------------<a name='4209'></font>
<a name='4210'>
<A NAME='CURVATURE'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CURVATURE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4211'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>curvature</font> ( ru, rv, rw, u, v, w, ru_tend, rv_tend, rw_tend, &amp; <A href='../../call_to/CURVATURE.html' TARGET='index'>1</A><a name='4212'>
                        config_flags,                                       &amp;<a name='4213'>
                        msfux, msfuy, msfvx, msfvy, msftx, msfty,       &amp;<a name='4214'>
                        xlat, fzm, fzp, rdx, rdy,                       &amp;<a name='4215'>
                        ids, ide, jds, jde, kds, kde,                   &amp;<a name='4216'>
                        ims, ime, jms, jme, kms, kme,                   &amp;<a name='4217'>
                        its, ite, jts, jte, kts, kte                   )<a name='4218'>
<a name='4219'>
<a name='4220'>
   IMPLICIT NONE<a name='4221'>
   <a name='4222'>
   <font color=#447700>! Input data<a name='4223'></font>
<a name='4224'>
   TYPE(grid_config_rec_type) ,           INTENT(IN   ) :: config_flags   <a name='4225'>
<a name='4226'>
   INTEGER ,                  INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4227'>
                                               ims, ime, jms, jme, kms, kme, &amp;<a name='4228'>
                                               its, ite, jts, jte, kts, kte<a name='4229'>
   <a name='4230'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                     &amp;<a name='4231'>
                                               INTENT(INOUT) :: ru_tend, &amp;<a name='4232'>
                                                                rv_tend, &amp;<a name='4233'>
                                                                rw_tend<a name='4234'>
<a name='4235'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                     &amp;<a name='4236'>
                                               INTENT(IN   ) :: ru,      &amp;<a name='4237'>
                                                                rv,      &amp;<a name='4238'>
                                                                rw,      &amp;<a name='4239'>
                                                                u,       &amp;<a name='4240'>
                                                                v,       &amp;<a name='4241'>
                                                                w<a name='4242'>
<a name='4243'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,    &amp;<a name='4244'>
                                                                msfuy,    &amp;<a name='4245'>
                                                                msfvx,    &amp;<a name='4246'>
                                                                msfvy,    &amp;<a name='4247'>
                                                                msftx,    &amp;<a name='4248'>
                                                                msfty,    &amp;<a name='4249'>
                                                                xlat<a name='4250'>
<a name='4251'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,     &amp;<a name='4252'>
                                                                fzp<a name='4253'>
<a name='4254'>
   REAL ,                                      INTENT(IN   ) :: rdx,     &amp;<a name='4255'>
                                                                rdy<a name='4256'>
   <a name='4257'>
   <font color=#447700>! Local data<a name='4258'></font>
   <a name='4259'>
<font color=#447700>!   INTEGER :: i, j, k, itf, jtf, ktf, kp1, im, ip, jm, jp<a name='4260'></font>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4261'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='4262'>
<font color=#447700>!   INTEGER :: irmin, irmax, jrmin, jrmax<a name='4263'></font>
<a name='4264'>
   REAL , DIMENSION( its-1:ite , kts:kte, jts-1:jte ) :: vxgm<a name='4265'>
<a name='4266'>
   LOGICAL :: specified<a name='4267'>
<a name='4268'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4269'></font>
<font color=#447700>!<a name='4270'></font>
<font color=#447700>!  curvature calculates the large timestep tendency terms in the <a name='4271'></font>
<font color=#447700>!  u, v, and w momentum equations arise from the curvature terms.  <a name='4272'></font>
<font color=#447700>!<a name='4273'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4274'></font>
<a name='4275'>
   specified = .false.<a name='4276'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='4277'>
<a name='4278'>
      itf=MIN(ite,ide-1)<a name='4279'>
      jtf=MIN(jte,jde-1)<a name='4280'>
      ktf=MIN(kte,kde-1)<a name='4281'>
<a name='4282'>
<font color=#447700>!   irmin = ims<a name='4283'></font>
<font color=#447700>!   irmax = ime<a name='4284'></font>
<font color=#447700>!   jrmin = jms<a name='4285'></font>
<font color=#447700>!   jrmax = jme<a name='4286'></font>
<font color=#447700>!   IF ( config_flags%open_xs ) irmin = ids<a name='4287'></font>
<font color=#447700>!   IF ( config_flags%open_xe ) irmax = ide-1<a name='4288'></font>
<font color=#447700>!   IF ( config_flags%open_ys ) jrmin = jds<a name='4289'></font>
<font color=#447700>!   IF ( config_flags%open_ye ) jrmax = jde-1<a name='4290'></font>
   <a name='4291'>
<font color=#447700>! Define v cross grad m at scalar points - vxgm(i,j)<a name='4292'></font>
<a name='4293'>
   i_start = its-1<a name='4294'>
   i_end   = ite<a name='4295'>
   j_start = jts-1<a name='4296'>
   j_end   = jte<a name='4297'>
<a name='4298'>
   IF ( ( config_flags%open_xs .or. specified .or. &amp;<a name='4299'>
        config_flags%nested) .and. (its == ids) ) i_start = its<a name='4300'>
   IF ( ( config_flags%open_xe .or. specified .or. &amp;<a name='4301'>
        config_flags%nested) .and. (ite == ide) ) i_end   = ite-1<a name='4302'>
   IF ( ( config_flags%open_ys .or. specified .or. &amp;<a name='4303'>
        config_flags%nested .or. config_flags%polar) .and. (jts == jds) ) j_start = jts<a name='4304'>
   IF ( ( config_flags%open_ye .or. specified .or. &amp;<a name='4305'>
        config_flags%nested .or. config_flags%polar) .and. (jte == jde) ) j_end   = jte-1<a name='4306'>
      IF ( config_flags%periodic_x ) i_start = its-1<a name='4307'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='4308'>
<a name='4309'>
   DO j=j_start, j_end<a name='4310'>
   DO k=kts,ktf<a name='4311'>
   DO i=i_start, i_end<a name='4312'>
<font color=#447700>!     Map scale factor notes:<a name='4313'></font>
<font color=#447700>!     msf...y is constant everywhere for cylindrical map projection<a name='4314'></font>
<font color=#447700>!     msf...x varies with y only<a name='4315'></font>
<font color=#447700>!     But we know that this is not = 0 for cylindrical,<a name='4316'></font>
<font color=#447700>!     therefore use msfvX in 1st line<a name='4317'></font>
<font color=#447700>!     which =&gt; by symmetry use msfuY in 2nd line - ???  <a name='4318'></font>
      vxgm(i,k,j)=0.5*(u(i,k,j)+u(i+1,k,j))*(msfvx(i,j+1)-msfvx(i,j))*rdy - &amp;<a name='4319'>
                  0.5*(v(i,k,j)+v(i,k,j+1))*(msfuy(i+1,j)-msfuy(i,j))*rdx<a name='4320'>
   ENDDO<a name='4321'>
   ENDDO<a name='4322'>
   ENDDO<a name='4323'>
<a name='4324'>
<font color=#447700>!  Pick up the boundary rows for open (radiation) lateral b.c.<a name='4325'></font>
<font color=#447700>!  Rather crude at present, we are assuming there is no<a name='4326'></font>
<font color=#447700>!    variation in this term at the boundary.<a name='4327'></font>
<a name='4328'>
   IF ( ( config_flags%open_xs .or. (specified .AND. .NOT. config_flags%periodic_x) .or. &amp;<a name='4329'>
        config_flags%nested) .and. (its == ids) ) THEN<a name='4330'>
<a name='4331'>
     DO j = jts, jte-1<a name='4332'>
     DO k = kts, ktf<a name='4333'>
       vxgm(its-1,k,j) =  vxgm(its,k,j)<a name='4334'>
     ENDDO<a name='4335'>
     ENDDO<a name='4336'>
<a name='4337'>
   ENDIF<a name='4338'>
<a name='4339'>
   IF ( ( config_flags%open_xe .or. (specified .AND. .NOT. config_flags%periodic_x) .or. &amp;<a name='4340'>
        config_flags%nested) .and. (ite == ide) ) THEN<a name='4341'>
<a name='4342'>
     DO j = jts, jte-1<a name='4343'>
     DO k = kts, ktf<a name='4344'>
       vxgm(ite,k,j) =  vxgm(ite-1,k,j)<a name='4345'>
     ENDDO<a name='4346'>
     ENDDO<a name='4347'>
<a name='4348'>
   ENDIF<a name='4349'>
<a name='4350'>
<font color=#447700>!  Polar boundary condition:<a name='4351'></font>
<font color=#447700>!  The following change is needed in case one tries using the vxgm route with<a name='4352'></font>
<font color=#447700>!  polar B.C.'s in the future, but not needed if 'tan' used<a name='4353'></font>
   IF ( ( config_flags%open_ys .or. specified .or. &amp;<a name='4354'>
        config_flags%nested .or. config_flags%polar) .and. (jts == jds) ) THEN<a name='4355'>
<a name='4356'>
     DO k = kts, ktf<a name='4357'>
     DO i = its-1, ite<a name='4358'>
       vxgm(i,k,jts-1) =  vxgm(i,k,jts)<a name='4359'>
     ENDDO<a name='4360'>
     ENDDO<a name='4361'>
<a name='4362'>
   ENDIF<a name='4363'>
<a name='4364'>
<font color=#447700>!  Polar boundary condition:<a name='4365'></font>
<font color=#447700>!  The following change is needed in case one tries using the vxgm route with<a name='4366'></font>
<font color=#447700>!  polar B.C.'s in the future, but not needed if 'tan' used<a name='4367'></font>
   IF ( ( config_flags%open_ye .or. specified .or. &amp;<a name='4368'>
        config_flags%nested .or. config_flags%polar) .and. (jte == jde) ) THEN<a name='4369'>
<a name='4370'>
     DO k = kts, ktf<a name='4371'>
     DO i = its-1, ite<a name='4372'>
       vxgm(i,k,jte) =  vxgm(i,k,jte-1)<a name='4373'>
     ENDDO<a name='4374'>
     ENDDO<a name='4375'>
<a name='4376'>
   ENDIF<a name='4377'>
<a name='4378'>
<font color=#447700>!  curvature term for u momentum eqn.<a name='4379'></font>
<a name='4380'>
<font color=#447700>!  Map scale factor notes:<a name='4381'></font>
<font color=#447700>!  ADT eqn 44, RHS terms 4 and 5, in cylindrical: mu u v tan(lat)/(a my)<a name='4382'></font>
<font color=#447700>!                                               - mu u w /(a my)<a name='4383'></font>
<font color=#447700>!  ru = mu u / my ; rw = mu w / my ; rv = mu v / mx<a name='4384'></font>
<font color=#447700>!   =&gt; terms are:<a name='4385'></font>
<font color=#447700>!  (mx/my)*u rv tan(lat) / a - u rw / a = (u/a)*[(mx/my) rv tan(lat) - rw]<a name='4386'></font>
<font color=#447700>!  ru v tan(lat) / a - u rw / a<a name='4387'></font>
<font color=#447700>!  xlat defined with end points half grid space from pole,<a name='4388'></font>
<font color=#447700>!  hence are on u latitude points<a name='4389'></font>
<a name='4390'>
   i_start = its<a name='4391'>
   IF ( config_flags%open_xs .or. specified .or. &amp;<a name='4392'>
        config_flags%nested) i_start = MAX ( ids+1 , its )<a name='4393'>
   IF ( config_flags%open_xe .or. specified .or. &amp;<a name='4394'>
        config_flags%nested) i_end   = MIN ( ide-1 , ite )<a name='4395'>
      IF ( config_flags%periodic_x ) i_start = its<a name='4396'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='4397'>
<a name='4398'>
<font color=#447700>!  Polar boundary condition<a name='4399'></font>
   IF ((config_flags%map_proj == 6) .OR. (config_flags%polar)) THEN<a name='4400'>
<a name='4401'>
      DO j=jts,MIN(jde-1,jte)<a name='4402'>
      DO k=kts,ktf<a name='4403'>
      DO i=i_start,i_end<a name='4404'>
<a name='4405'>
            ru_tend(i,k,j)=ru_tend(i,k,j) + u(i,k,j)*reradius*                 ( &amp;<a name='4406'>
                        (msfux(i,j)/msfuy(i,j))*0.25*(rv(i-1,k,j+1)+rv(i,k,j+1)+ &amp;<a name='4407'>
                                    rv(i-1,k,j)+rv(i,k,j))*tan(xlat(i,j)*degrad) &amp;<a name='4408'>
                        - 0.25*(rw(i-1,k+1,j)+rw(i-1,k,j)+rw(i,k+1,j)+rw(i,k,j)) )<a name='4409'>
      ENDDO<a name='4410'>
      ENDDO<a name='4411'>
      ENDDO<a name='4412'>
<a name='4413'>
   ELSE  <font color=#447700>! normal code<a name='4414'></font>
<a name='4415'>
<a name='4416'>
      DO j=jts,MIN(jde-1,jte)<a name='4417'>
      DO k=kts,ktf<a name='4418'>
      DO i=i_start,i_end<a name='4419'>
<a name='4420'>
         ru_tend(i,k,j)=ru_tend(i,k,j) + 0.5*(vxgm(i,k,j)+vxgm(i-1,k,j)) &amp;<a name='4421'>
                 *0.25*(rv(i-1,k,j+1)+rv(i,k,j+1)+rv(i-1,k,j)+rv(i,k,j)) &amp;<a name='4422'>
                  - u(i,k,j)*reradius &amp;<a name='4423'>
                 *0.25*(rw(i-1,k+1,j)+rw(i-1,k,j)+rw(i,k+1,j)+rw(i,k,j))<a name='4424'>
<a name='4425'>
      ENDDO<a name='4426'>
      ENDDO<a name='4427'>
      ENDDO<a name='4428'>
<a name='4429'>
   END IF<a name='4430'>
<a name='4431'>
<font color=#447700>!  curvature term for v momentum eqn.<a name='4432'></font>
<a name='4433'>
<font color=#447700>!  Map scale factor notes<a name='4434'></font>
<font color=#447700>!  ADT eqn 45, RHS terms 4 and 5, in cylindrical:  - mu u*u tan(lat)/(a mx)<a name='4435'></font>
<font color=#447700>!                                               - mu v w /(a mx)<a name='4436'></font>
<font color=#447700>!  ru = mu u / my ; rw = mu w / my ; rv = mu v / mx<a name='4437'></font>
<font color=#447700>!  terms are:<a name='4438'></font>
<font color=#447700>!  - (my/mx)*u ru tan(lat) / a - (my/mx)*v rw / a <a name='4439'></font>
<font color=#447700>!  = - [my/(mx*a)]*[u ru tan(lat) + v rw]<a name='4440'></font>
<font color=#447700>!  - (1/a)*[(my/mx)*u ru tan(lat) + w rv]<a name='4441'></font>
<font color=#447700>!  xlat defined with end points half grid space from pole, hence are on<a name='4442'></font>
<font color=#447700>!  u latitude points =&gt; av here<a name='4443'></font>
<font color=#447700>!<a name='4444'></font>
<font color=#447700>!  in original wrf, there was a sign error for the rw contribution<a name='4445'></font>
<a name='4446'>
   j_start = jts<a name='4447'>
   IF ( config_flags%open_ys .or. specified .or. &amp;<a name='4448'>
        config_flags%nested .or. config_flags%polar) j_start = MAX ( jds+1 , jts )<a name='4449'>
   IF ( config_flags%open_ye .or. specified .or. &amp;<a name='4450'>
        config_flags%nested .or. config_flags%polar) j_end   = MIN ( jde-1 , jte )<a name='4451'>
<a name='4452'>
   IF ((config_flags%map_proj == 6) .OR. (config_flags%polar)) THEN<a name='4453'>
<a name='4454'>
      DO j=j_start,j_end<a name='4455'>
      DO k=kts,ktf<a name='4456'>
      DO i=its,MIN(ite,ide-1)<a name='4457'>
            rv_tend(i,k,j)=rv_tend(i,k,j) - (msfvy(i,j)/msfvx(i,j))*reradius*   (  &amp;<a name='4458'>
                        0.25*(u(i,k,j)+u(i+1,k,j)+u(i,k,j-1)+u(i+1,k,j-1))*     &amp;<a name='4459'>
                        tan((xlat(i,j)+xlat(i,j-1))*0.5*degrad)*                &amp;<a name='4460'>
                        0.25*(ru(i,k,j)+ru(i+1,k,j)+ru(i,k,j-1)+ru(i+1,k,j-1))  &amp;<a name='4461'>
                       + v(i,k,j)*0.25*(rw(i,k+1,j-1)+rw(i,k,j-1)+              &amp;<a name='4462'>
                                                      rw(i,k+1,j)+rw(i,k,j))    )<a name='4463'>
      ENDDO<a name='4464'>
      ENDDO<a name='4465'>
      ENDDO<a name='4466'>
<a name='4467'>
   ELSE  <font color=#447700>! normal code<a name='4468'></font>
<a name='4469'>
      DO j=j_start,j_end<a name='4470'>
      DO k=kts,ktf<a name='4471'>
      DO i=its,MIN(ite,ide-1)<a name='4472'>
<a name='4473'>
         rv_tend(i,k,j)=rv_tend(i,k,j) - 0.5*(vxgm(i,k,j)+vxgm(i,k,j-1)) &amp;<a name='4474'>
                 *0.25*(ru(i,k,j)+ru(i+1,k,j)+ru(i,k,j-1)+ru(i+1,k,j-1)) &amp;<a name='4475'>
                       - (msfvy(i,j)/msfvx(i,j))*v(i,k,j)*reradius       &amp;<a name='4476'>
                 *0.25*(rw(i,k+1,j-1)+rw(i,k,j-1)+rw(i,k+1,j)+rw(i,k,j))<a name='4477'>
<a name='4478'>
      ENDDO<a name='4479'>
      ENDDO<a name='4480'>
      ENDDO<a name='4481'>
<a name='4482'>
   END IF<a name='4483'>
<a name='4484'>
<font color=#447700>!  curvature term for vertical momentum eqn.<a name='4485'></font>
<a name='4486'>
<font color=#447700>!  Notes on map scale factors:<a name='4487'></font>
<font color=#447700>!  ADT eqn 46, RHS term 4: [mu/(a my)]*[u*u + v*v]<a name='4488'></font>
<font color=#447700>!  ru = mu u / my ; rw = mu w / my ; rv = mu v / mx<a name='4489'></font>
<font color=#447700>!  terms are: u ru / a + (mx/my)v rv / a<a name='4490'></font>
<a name='4491'>
   DO j=jts,MIN(jte,jde-1)<a name='4492'>
   DO k=MAX(2,kts),ktf<a name='4493'>
   DO i=its,MIN(ite,ide-1)<a name='4494'>
<a name='4495'>
      rw_tend(i,k,j)=rw_tend(i,k,j) + reradius*                              &amp;<a name='4496'>
    (0.5*(fzm(k)*(ru(i,k,j)+ru(i+1,k,j))+fzp(k)*(ru(i,k-1,j)+ru(i+1,k-1,j))) &amp;<a name='4497'>
    *0.5*(fzm(k)*( u(i,k,j) +u(i+1,k,j))+fzp(k)*( u(i,k-1,j) +u(i+1,k-1,j)))     &amp;<a name='4498'>
    +(msftx(i,j)/msfty(i,j))*0.5*(fzm(k)*(rv(i,k,j)+rv(i,k,j+1))+fzp(k)*(rv(i,k-1,j)+rv(i,k-1,j+1))) &amp;<a name='4499'>
    *0.5*(fzm(k)*( v(i,k,j) +v(i,k,j+1))+fzp(k)*( v(i,k-1,j) +v(i,k-1,j+1))))<a name='4500'>
<a name='4501'>
   ENDDO<a name='4502'>
   ENDDO<a name='4503'>
   ENDDO<a name='4504'>
<a name='4505'>
END SUBROUTINE curvature<a name='4506'>
<a name='4507'>
#if 0<a name='4508'>
DANGER - this is a bad routine to have laying around - someone could use it<a name='4509'>
<font color=#447700>!------------------------------------------------------------------------------<a name='4510'></font>
<a name='4511'>
<A NAME='DECOUPLE'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DECOUPLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4512'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>decouple</font> ( rr, rfield, field, name, config_flags, &amp;<a name='4513'>
                      fzm, fzp,                          &amp;<a name='4514'>
                      ids, ide, jds, jde, kds, kde,      &amp;<a name='4515'>
                      ims, ime, jms, jme, kms, kme,      &amp;<a name='4516'>
                      its, ite, jts, jte, kts, kte      )<a name='4517'>
<a name='4518'>
   IMPLICIT NONE<a name='4519'>
<a name='4520'>
   <font color=#447700>! Input data<a name='4521'></font>
<a name='4522'>
   TYPE(grid_config_rec_type) ,           INTENT(IN   ) :: config_flags   <a name='4523'>
<a name='4524'>
   INTEGER ,                                   INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4525'>
                                                                ims, ime, jms, jme, kms, kme, &amp;<a name='4526'>
                                                                its, ite, jts, jte, kts, kte<a name='4527'>
<a name='4528'>
   CHARACTER(LEN=1) ,                          INTENT(IN   ) :: name<a name='4529'>
<a name='4530'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: rfield<a name='4531'>
<a name='4532'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: rr<a name='4533'>
   <a name='4534'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT  ) :: field<a name='4535'>
   <a name='4536'>
   REAL , DIMENSION( kms:kme ) , INTENT(IN   ) :: fzm, fzp<a name='4537'>
   <a name='4538'>
   <font color=#447700>! Local data<a name='4539'></font>
   <a name='4540'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4541'>
   <a name='4542'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4543'></font>
<font color=#447700>!<a name='4544'></font>
<font color=#447700>!  decouple decouples a variable from the column dry-air mass.<a name='4545'></font>
<font color=#447700>!<a name='4546'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4547'></font>
<a name='4548'>
   ktf=MIN(kte,kde-1)<a name='4549'>
   <a name='4550'>
   IF (name .EQ. 'u')THEN<a name='4551'>
      itf=ite<a name='4552'>
      jtf=MIN(jte,jde-1)<a name='4553'>
<a name='4554'>
      DO j=jts,jtf<a name='4555'>
      DO k=kts,ktf<a name='4556'>
      DO i=its,itf<a name='4557'>
         field(i,k,j)=rfield(i,k,j)/(0.5*(rr(i,k,j)+rr(i-1,k,j)))<a name='4558'>
      ENDDO<a name='4559'>
      ENDDO<a name='4560'>
      ENDDO<a name='4561'>
<a name='4562'>
   ELSE IF (name .EQ. 'v')THEN<a name='4563'>
      itf=MIN(ite,ide-1)<a name='4564'>
      jtf=jte<a name='4565'>
<a name='4566'>
      DO j=jts,jtf<a name='4567'>
      DO k=kts,ktf<a name='4568'>
        DO i=its,itf<a name='4569'>
             field(i,k,j)=rfield(i,k,j)/(0.5*(rr(i,k,j)+rr(i,k,j-1)))<a name='4570'>
        ENDDO<a name='4571'>
      ENDDO<a name='4572'>
      ENDDO<a name='4573'>
<a name='4574'>
   ELSE IF (name .EQ. 'w')THEN<a name='4575'>
      itf=MIN(ite,ide-1)<a name='4576'>
      jtf=MIN(jte,jde-1)<a name='4577'>
      DO j=jts,jtf<a name='4578'>
      DO k=kts+1,ktf<a name='4579'>
      DO i=its,itf<a name='4580'>
         field(i,k,j)=rfield(i,k,j)/(fzm(k)*rr(i,k,j)+fzp(k)*rr(i,k-1,j))<a name='4581'>
      ENDDO<a name='4582'>
      ENDDO<a name='4583'>
      ENDDO<a name='4584'>
<a name='4585'>
      DO j=jts,jtf<a name='4586'>
      DO i=its,itf<a name='4587'>
        field(i,kte,j) = 0.<a name='4588'>
      ENDDO<a name='4589'>
      ENDDO<a name='4590'>
<a name='4591'>
   ELSE <a name='4592'>
      itf=MIN(ite,ide-1)<a name='4593'>
      jtf=MIN(jte,jde-1)<a name='4594'>
   <font color=#447700>! For theta we will decouple tb and tp and add them to give t afterwards<a name='4595'></font>
      DO j=jts,jtf<a name='4596'>
      DO k=kts,ktf<a name='4597'>
      DO i=its,itf<a name='4598'>
         field(i,k,j)=rfield(i,k,j)/rr(i,k,j)<a name='4599'>
      ENDDO<a name='4600'>
      ENDDO<a name='4601'>
      ENDDO<a name='4602'>
   <a name='4603'>
   ENDIF<a name='4604'>
<a name='4605'>
END SUBROUTINE decouple<a name='4606'>
#endif<a name='4607'>
<a name='4608'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='4609'></font>
<a name='4610'>
<A NAME='ZERO_TEND'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4611'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>zero_tend</font> ( tendency,                     &amp; <A href='../../call_to/ZERO_TEND.html' TARGET='index'>23</A><a name='4612'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='4613'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='4614'>
                       its, ite, jts, jte, kts, kte )<a name='4615'>
<a name='4616'>
<a name='4617'>
   IMPLICIT NONE<a name='4618'>
   <a name='4619'>
   <font color=#447700>! Input data<a name='4620'></font>
   <a name='4621'>
   INTEGER ,                                   INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4622'>
                                                                ims, ime, jms, jme, kms, kme, &amp;<a name='4623'>
                                                                its, ite, jts, jte, kts, kte<a name='4624'>
<a name='4625'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='4626'>
<a name='4627'>
   <font color=#447700>! Local data<a name='4628'></font>
   <a name='4629'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4630'>
<a name='4631'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4632'></font>
<font color=#447700>!<a name='4633'></font>
<font color=#447700>!  zero_tend sets the input tendency array to zero.<a name='4634'></font>
<font color=#447700>!<a name='4635'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4636'></font>
<a name='4637'>
      DO j = jts, jte<a name='4638'>
      DO k = kts, kte<a name='4639'>
      DO i = its, ite<a name='4640'>
        tendency(i,k,j) = 0.<a name='4641'>
      ENDDO<a name='4642'>
      ENDDO<a name='4643'>
      ENDDO<a name='4644'>
<a name='4645'>
      END SUBROUTINE zero_tend<a name='4646'>
<a name='4647'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='4648'></font>
<a name='4649'>
<A NAME='ZERO_TEND2D'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND2D' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4650'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>zero_tend2d</font>( tendency,                     &amp; <A href='../../call_to/ZERO_TEND2D.html' TARGET='index'>3</A><a name='4651'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='4652'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='4653'>
                       its, ite, jts, jte, kts, kte )<a name='4654'>
<a name='4655'>
<a name='4656'>
   IMPLICIT NONE<a name='4657'>
   <a name='4658'>
   <font color=#447700>! Input data<a name='4659'></font>
   <a name='4660'>
   INTEGER ,                                   INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4661'>
                                                                ims, ime, jms, jme, kms, kme, &amp;<a name='4662'>
                                                                its, ite, jts, jte, kts, kte<a name='4663'>
<a name='4664'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(INOUT) :: tendency<a name='4665'>
<a name='4666'>
   <font color=#447700>! Local data<a name='4667'></font>
   <a name='4668'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4669'>
<a name='4670'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4671'></font>
<font color=#447700>!<a name='4672'></font>
<font color=#447700>!  zero_tend sets the input tendency array to zero.<a name='4673'></font>
<font color=#447700>!<a name='4674'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4675'></font>
<a name='4676'>
      DO j = jts, jte<a name='4677'>
      DO i = its, ite<a name='4678'>
        tendency(i,j) = 0.<a name='4679'>
      ENDDO<a name='4680'>
      ENDDO<a name='4681'>
<a name='4682'>
      END SUBROUTINE zero_tend2d<a name='4683'>
<a name='4684'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='4685'></font>
<a name='4686'>
<font color=#447700>! Sets the an array on the polar v point(s) to zero<a name='4687'></font>
<A NAME='ZERO_POLE'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_POLE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4688'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>zero_pole</font> ( field,                        &amp; <A href='../../call_to/ZERO_POLE.html' TARGET='index'>2</A><a name='4689'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='4690'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='4691'>
                       its, ite, jts, jte, kts, kte )<a name='4692'>
<a name='4693'>
<a name='4694'>
  IMPLICIT NONE<a name='4695'>
<a name='4696'>
  <font color=#447700>! Input data<a name='4697'></font>
   <a name='4698'>
  INTEGER , INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4699'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='4700'>
                             its, ite, jts, jte, kts, kte<a name='4701'>
<a name='4702'>
  REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: field<a name='4703'>
<a name='4704'>
  <font color=#447700>! Local data<a name='4705'></font>
<a name='4706'>
  INTEGER :: i, k<a name='4707'>
<a name='4708'>
  IF (jts == jds) THEN<a name='4709'>
     DO k = kts, kte<a name='4710'>
     DO i = its-1, ite+1<a name='4711'>
        field(i,k,jts) = 0.<a name='4712'>
     END DO<a name='4713'>
     END DO<a name='4714'>
  END IF<a name='4715'>
  IF (jte == jde) THEN<a name='4716'>
     DO k = kts, kte<a name='4717'>
     DO i = its-1, ite+1<a name='4718'>
        field(i,k,jte) = 0.<a name='4719'>
     END DO<a name='4720'>
     END DO<a name='4721'>
  END IF<a name='4722'>
<a name='4723'>
END SUBROUTINE zero_pole<a name='4724'>
<a name='4725'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='4726'></font>
<font color=#447700>! Sets the an array on the polar v point(s)<a name='4727'></font>
<A NAME='POLE_POINT_BC'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#POLE_POINT_BC' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4728'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>pole_point_bc</font> ( field,                        &amp; <A href='../../call_to/POLE_POINT_BC.html' TARGET='index'>2</A><a name='4729'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='4730'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='4731'>
                       its, ite, jts, jte, kts, kte )<a name='4732'>
<a name='4733'>
<a name='4734'>
  IMPLICIT NONE<a name='4735'>
<a name='4736'>
  <font color=#447700>! Input data<a name='4737'></font>
   <a name='4738'>
  INTEGER , INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4739'>
                             ims, ime, jms, jme, kms, kme, &amp;<a name='4740'>
                             its, ite, jts, jte, kts, kte<a name='4741'>
<a name='4742'>
  REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: field<a name='4743'>
<a name='4744'>
  <font color=#447700>! Local data<a name='4745'></font>
<a name='4746'>
  INTEGER :: i, k<a name='4747'>
<a name='4748'>
  IF (jts == jds) THEN<a name='4749'>
     DO k = kts, kte<a name='4750'>
     DO i = its, ite<a name='4751'>
<font color=#447700>!        field(i,k,jts) = 2*field(i,k,jts+1) - field(i,k,jts+2)<a name='4752'></font>
        field(i,k,jts) = field(i,k,jts+1)<a name='4753'>
     END DO<a name='4754'>
     END DO<a name='4755'>
  END IF<a name='4756'>
  IF (jte == jde) THEN<a name='4757'>
     DO k = kts, kte<a name='4758'>
     DO i = its, ite<a name='4759'>
<font color=#447700>!        field(i,k,jte) = 2*field(i,k,jte-1) - field(i,k,jte-2)<a name='4760'></font>
        field(i,k,jte) = field(i,k,jte-1)<a name='4761'>
     END DO<a name='4762'>
     END DO<a name='4763'>
  END IF<a name='4764'>
<a name='4765'>
END SUBROUTINE pole_point_bc<a name='4766'>
<a name='4767'>
<font color=#447700>!======================================================================<a name='4768'></font>
<font color=#447700>!   physics prep routines<a name='4769'></font>
<font color=#447700>!======================================================================<a name='4770'></font>
<a name='4771'>
<A NAME='PHY_PREP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PHY_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4772'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>phy_prep</font> ( config_flags,                                &amp;  <font color=#447700>! input <A href='../../call_to/PHY_PREP.html' TARGET='index'>1</A><a name='4773'></font>
                         mut, muu, muv,                               &amp;<a name='4774'>
                         c1h, c2h, c1f, c2f,                          &amp;<a name='4775'>
                         u, v, p, pb, alt, ph,                        &amp;  <font color=#447700>! input<a name='4776'></font>
                         phb, t, moist, n_moist,                      &amp;  <font color=#447700>! input<a name='4777'></font>
                         rho, th_phy, p_phy , pi_phy ,                &amp;  <font color=#447700>! output<a name='4778'></font>
                         u_phy, v_phy, p8w, t_phy, t8w,               &amp;  <font color=#447700>! output<a name='4779'></font>
                         z, z_at_w, dz8w,                             &amp;  <font color=#447700>! output<a name='4780'></font>
                         p_hyd, p_hyd_w, dnw,                         &amp;  <font color=#447700>! output<a name='4781'></font>
                         fzm, fzp, znw, p_top,                        &amp;  <font color=#447700>! params<a name='4782'></font>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='4783'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='4784'>
                         its, ite, jts, jte, kts, kte                )<a name='4785'>
<font color=#447700>!----------------------------------------------------------------------<a name='4786'></font>
   IMPLICIT NONE<a name='4787'>
<font color=#447700>!----------------------------------------------------------------------<a name='4788'></font>
<a name='4789'>
   TYPE(grid_config_rec_type) ,     INTENT(IN   ) :: config_flags<a name='4790'>
<a name='4791'>
   INTEGER ,        INTENT(IN   ) ::   ids, ide, jds, jde, kds, kde, &amp;<a name='4792'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='4793'>
                                       its, ite, jts, jte, kts, kte<a name='4794'>
   INTEGER ,          INTENT(IN   ) :: n_moist<a name='4795'>
<a name='4796'>
   REAL, DIMENSION( ims:ime, kms:kme , jms:jme , n_moist ), INTENT(IN) :: moist<a name='4797'>
<a name='4798'>
<a name='4799'>
   REAL , DIMENSION( ims:ime, jms:jme ), INTENT(IN   )   ::     mut, muu, muv<a name='4800'>
<a name='4801'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                 &amp;<a name='4802'>
          INTENT(  OUT)                                  ::   u_phy, &amp;<a name='4803'>
                                                              v_phy, &amp;<a name='4804'>
                                                             pi_phy, &amp;<a name='4805'>
                                                              p_phy, &amp;<a name='4806'>
                                                                p8w, &amp;<a name='4807'>
                                                              t_phy, &amp;<a name='4808'>
                                                             th_phy, &amp;<a name='4809'>
                                                                t8w, &amp;<a name='4810'>
                                                                rho, &amp;<a name='4811'>
                                                                  z, &amp;<a name='4812'>
                                                               dz8w, &amp;<a name='4813'>
                                                              z_at_w <a name='4814'>
<a name='4815'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                 &amp;<a name='4816'>
          INTENT(  OUT)                                  ::   p_hyd, &amp;<a name='4817'>
                                                              p_hyd_w<a name='4818'>
<a name='4819'>
   REAL , INTENT(IN   )                                  ::   p_top<a name='4820'>
<a name='4821'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) ,                 &amp;<a name='4822'>
          INTENT(IN   )                                  ::      pb, &amp;<a name='4823'>
                                                                  p, &amp;<a name='4824'>
                                                                  u, &amp;<a name='4825'>
                                                                  v, &amp;<a name='4826'>
                                                                alt, &amp;<a name='4827'>
                                                                 ph, &amp;<a name='4828'>
                                                                phb, &amp;<a name='4829'>
                                                                  t<a name='4830'>
<a name='4831'>
<a name='4832'>
   REAL , DIMENSION( kms:kme ) ,           INTENT(IN   ) ::     fzm,   &amp;<a name='4833'>
                                                                fzp<a name='4834'>
<a name='4835'>
   REAL , DIMENSION( kms:kme ) ,           INTENT(IN   ) ::     znw, &amp;<a name='4836'>
                                                                dnw<a name='4837'>
<a name='4838'>
   REAL, DIMENSION( kms:kme ) ,            INTENT(IN   ) ::     c1h, c2h, c1f, c2f<a name='4839'>
<a name='4840'>
   REAL, DIMENSION( kms:kme ) :: c1, c2<a name='4841'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end, i_startu, j_startv<a name='4842'>
   INTEGER :: i, j, k<a name='4843'>
   REAL    :: w1, w2, z0, z1, z2<a name='4844'>
   REAL    :: qtot<a name='4845'>
   INTEGER :: n<a name='4846'>
<a name='4847'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4848'></font>
<a name='4849'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='4850'></font>
<font color=#447700>!<a name='4851'></font>
<font color=#447700>!  phys_prep calculates a number of diagnostic quantities needed by<a name='4852'></font>
<font color=#447700>!  the physics routines.  <a name='4853'></font>
<font color=#447700>!<a name='4854'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='4855'></font>
<a name='4856'>
    c1 = c1h<a name='4857'>
    c2 = c2h<a name='4858'>
<font color=#447700>!  set up loop bounds for this grid's boundary conditions<a name='4859'></font>
<a name='4860'>
    i_start = its<a name='4861'>
    i_end   = min( ite,ide-1 )<a name='4862'>
    j_start = jts<a name='4863'>
    j_end   = min( jte,jde-1 )<a name='4864'>
<a name='4865'>
    k_start = kts<a name='4866'>
    k_end = min( kte, kde-1 )<a name='4867'>
<a name='4868'>
<font color=#447700>!  compute thermodynamics and velocities at pressure points (or half levels)<a name='4869'></font>
<a name='4870'>
    do j = j_start,j_end<a name='4871'>
    do k = k_start, k_end<a name='4872'>
    do i = i_start, i_end<a name='4873'>
<a name='4874'>
      th_phy(i,k,j) = t(i,k,j) + t0<a name='4875'>
      p_phy(i,k,j) = p(i,k,j) + pb(i,k,j)<a name='4876'>
      pi_phy(i,k,j) = (p_phy(i,k,j)/p1000mb)**rcp<a name='4877'>
      t_phy(i,k,j) = th_phy(i,k,j)*pi_phy(i,k,j)<a name='4878'>
      rho(i,k,j) = 1./alt(i,k,j)*(1.+moist(i,k,j,P_QV))<a name='4879'>
      u_phy(i,k,j) = 0.5*(u(i,k,j)+u(i+1,k,j))<a name='4880'>
      v_phy(i,k,j) = 0.5*(v(i,k,j)+v(i,k,j+1))<a name='4881'>
<a name='4882'>
    enddo<a name='4883'>
    enddo<a name='4884'>
    enddo<a name='4885'>
<a name='4886'>
<font color=#447700>!  compute z at w points<a name='4887'></font>
<a name='4888'>
    do j = j_start,j_end<a name='4889'>
    do k = k_start, kte<a name='4890'>
    do i = i_start, i_end<a name='4891'>
      z_at_w(i,k,j) = (phb(i,k,j)+ph(i,k,j))/g<a name='4892'>
    enddo<a name='4893'>
    enddo<a name='4894'>
    enddo<a name='4895'>
<a name='4896'>
    do j = j_start,j_end<a name='4897'>
    do k = k_start, kte-1<a name='4898'>
    do i = i_start, i_end<a name='4899'>
      dz8w(i,k,j) = z_at_w(i,k+1,j)-z_at_w(i,k,j)<a name='4900'>
    enddo<a name='4901'>
    enddo<a name='4902'>
    enddo<a name='4903'>
<a name='4904'>
    do j = j_start,j_end<a name='4905'>
    do i = i_start, i_end<a name='4906'>
      dz8w(i,kte,j) = 0.<a name='4907'>
    enddo<a name='4908'>
    enddo<a name='4909'>
<a name='4910'>
<font color=#447700>!  compute z at p points or half levels (average of z at full levels)<a name='4911'></font>
<a name='4912'>
    do j = j_start,j_end<a name='4913'>
    do k = k_start, k_end<a name='4914'>
    do i = i_start, i_end<a name='4915'>
      z(i,k,j) = 0.5*(z_at_w(i,k,j) +z_at_w(i,k+1,j) )<a name='4916'>
    enddo<a name='4917'>
    enddo<a name='4918'>
    enddo<a name='4919'>
<a name='4920'>
<font color=#447700>!  interp t and p to full levels<a name='4921'></font>
<a name='4922'>
    do j = j_start,j_end<a name='4923'>
    do k = 2, k_end<a name='4924'>
    do i = i_start, i_end<a name='4925'>
      p8w(i,k,j) = fzm(k)*p_phy(i,k,j)+fzp(k)*p_phy(i,k-1,j)<a name='4926'>
      t8w(i,k,j) = fzm(k)*t_phy(i,k,j)+fzp(k)*t_phy(i,k-1,j)<a name='4927'>
    enddo<a name='4928'>
    enddo<a name='4929'>
    enddo<a name='4930'>
<a name='4931'>
<font color=#447700>!  extrapolate p and t to surface and top.<a name='4932'></font>
<font color=#447700>!  we'll use an extrapolation in z for now<a name='4933'></font>
<a name='4934'>
    do j = j_start,j_end<a name='4935'>
    do i = i_start, i_end<a name='4936'>
<a name='4937'>
<font color=#447700>! bottom<a name='4938'></font>
<a name='4939'>
      z0 = z_at_w(i,1,j)<a name='4940'>
      z1 = z(i,1,j)<a name='4941'>
      z2 = z(i,2,j)<a name='4942'>
      w1 = (z0 - z2)/(z1 - z2)<a name='4943'>
      w2 = 1. - w1<a name='4944'>
      p8w(i,1,j) = w1*p_phy(i,1,j)+w2*p_phy(i,2,j)<a name='4945'>
      t8w(i,1,j) = w1*t_phy(i,1,j)+w2*t_phy(i,2,j)<a name='4946'>
<a name='4947'>
<font color=#447700>! top<a name='4948'></font>
<a name='4949'>
      z0 = z_at_w(i,kte,j)<a name='4950'>
      z1 = z(i,k_end,j)<a name='4951'>
      z2 = z(i,k_end-1,j)<a name='4952'>
      w1 = (z0 - z2)/(z1 - z2)<a name='4953'>
      w2 = 1. - w1<a name='4954'>
<a name='4955'>
<font color=#447700>!      p8w(i,kde,j) = w1*p_phy(i,kde-1,j)+w2*p_phy(i,kde-2,j)<a name='4956'></font>
<font color=#447700>!!!  bug fix      extrapolate ln(p) so p is positive definite<a name='4957'></font>
      p8w(i,kde,j) = exp(w1*log(p_phy(i,kde-1,j))+w2*log(p_phy(i,kde-2,j)))<a name='4958'>
      t8w(i,kde,j) = w1*t_phy(i,kde-1,j)+w2*t_phy(i,kde-2,j)<a name='4959'>
<a name='4960'>
    enddo<a name='4961'>
    enddo<a name='4962'>
<a name='4963'>
<font color=#447700>! calculate hydrostatic pressure at both full and half levels<a name='4964'></font>
<font color=#447700>! first, full level p: assuming dry over model top<a name='4965'></font>
<a name='4966'>
    do j = j_start,j_end<a name='4967'>
    do i = i_start, i_end<a name='4968'>
       p_hyd_w(i,kte,j) = p_top<a name='4969'>
    enddo<a name='4970'>
    enddo<a name='4971'>
<a name='4972'>
    do j = j_start,j_end<a name='4973'>
    do k = kte-1, k_start, -1<a name='4974'>
    do i = i_start, i_end<a name='4975'>
       qtot = 0.<a name='4976'>
       do n = PARAM_FIRST_SCALAR,n_moist<a name='4977'>
              qtot = qtot + moist(i,k,j,n)<a name='4978'>
       enddo<a name='4979'>
       p_hyd_w(i,k,j) = p_hyd_w(i,k+1,j) - (1.+qtot)*MUT(i,j)*dnw(k)<a name='4980'>
<font color=#447700>!      p_hyd_w(i,k,j) = p_hyd_w(i,k+1,j)+1./alt(i,k,j)*(1.+moist(i,k,j,P_QV))*g*dz8w(i,k,j)<a name='4981'></font>
    enddo<a name='4982'>
    enddo<a name='4983'>
    enddo<a name='4984'>
<a name='4985'>
<font color=#447700>! now calculate hydrostatic pressure at half levels<a name='4986'></font>
<a name='4987'>
    do j = j_start,j_end<a name='4988'>
    do k = k_start, k_end<a name='4989'>
    do i = i_start, i_end<a name='4990'>
       p_hyd(i,k,j) = 0.5*(p_hyd_w(i,k,j)+p_hyd_w(i,k+1,j))<a name='4991'>
    enddo<a name='4992'>
    enddo<a name='4993'>
    enddo<a name='4994'>
<a name='4995'>
END SUBROUTINE phy_prep<a name='4996'>
<a name='4997'>
<a name='4998'>
<font color=#447700>!======================================================================<a name='4999'></font>
<font color=#447700>!   routine to decouple physics tendencies<a name='5000'></font>
<font color=#447700>!======================================================================<a name='5001'></font>
<a name='5002'>
<A NAME='PHY_PREP_PART2'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PHY_PREP_PART2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5003'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>phy_prep_part2</font> ( config_flags,                          &amp; <A href='../../call_to/PHY_PREP_PART2.html' TARGET='index'>1</A><a name='5004'>
                         mut,muu,muv,                                 &amp;<a name='5005'>
                         c1h, c2h, c1f, c2f,                          &amp;<a name='5006'>
                         RTHRATEN,                                    &amp;<a name='5007'>
                         RTHBLTEN, RUBLTEN, RVBLTEN,                  &amp;<a name='5008'>
                         RQVBLTEN, RQCBLTEN, RQIBLTEN,                &amp;<a name='5009'>
                         RUCUTEN,  RVCUTEN,  RTHCUTEN,                &amp;<a name='5010'>
                         RQVCUTEN, RQCCUTEN, RQRCUTEN,                &amp;<a name='5011'>
                         RQICUTEN, RQSCUTEN,                          &amp;<a name='5012'>
                         RUSHTEN,  RVSHTEN,  RTHSHTEN,                &amp;<a name='5013'>
                         RQVSHTEN, RQCSHTEN, RQRSHTEN,                &amp;<a name='5014'>
                         RQISHTEN, RQSSHTEN, RQGSHTEN,                &amp;<a name='5015'>
                         RTHFTEN,  RQVFTEN,                           &amp;<a name='5016'>
                         RUNDGDTEN, RVNDGDTEN, RTHNDGDTEN,            &amp;<a name='5017'>
                         RPHNDGDTEN,RQVNDGDTEN, RMUNDGDTEN,           &amp;<a name='5018'>
                         ids, ide, jds, jde, kds, kde,                &amp;<a name='5019'>
                         ims, ime, jms, jme, kms, kme,                &amp;<a name='5020'>
                         its, ite, jts, jte, kts, kte                )<a name='5021'>
<font color=#447700>!----------------------------------------------------------------------<a name='5022'></font>
   IMPLICIT NONE<a name='5023'>
<font color=#447700>!----------------------------------------------------------------------<a name='5024'></font>
<a name='5025'>
   TYPE(grid_config_rec_type) ,     INTENT(IN   ) :: config_flags<a name='5026'>
<a name='5027'>
   INTEGER ,        INTENT(IN   ) ::   ids, ide, jds, jde, kds, kde, &amp;<a name='5028'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='5029'>
                                       its, ite, jts, jte, kts, kte<a name='5030'>
<a name='5031'>
   REAL , DIMENSION( ims:ime, jms:jme ), INTENT(IN   )   ::     mut, muu, muv<a name='5032'>
<a name='5033'>
   REAL,  DIMENSION( ims:ime , kms:kme, jms:jme ),                   &amp;<a name='5034'>
          INTENT(INOUT)   ::                               RTHRATEN  <a name='5035'>
<a name='5036'>
   REAL,  DIMENSION( ims:ime , kms:kme, jms:jme ),                   &amp;<a name='5037'>
          INTENT(INOUT)   ::                                RUCUTEN, &amp;<a name='5038'>
                                                            RVCUTEN, &amp;<a name='5039'>
                                                           RTHCUTEN, &amp;<a name='5040'>
                                                           RQVCUTEN, &amp;<a name='5041'>
                                                           RQCCUTEN, &amp;<a name='5042'>
                                                           RQRCUTEN, &amp;<a name='5043'>
                                                           RQICUTEN, &amp;<a name='5044'>
                                                           RQSCUTEN, &amp;<a name='5045'>
                                                            RUSHTEN, &amp;<a name='5046'>
                                                            RVSHTEN, &amp;<a name='5047'>
                                                           RTHSHTEN, &amp;<a name='5048'>
                                                           RQVSHTEN, &amp;<a name='5049'>
                                                           RQCSHTEN, &amp;<a name='5050'>
                                                           RQRSHTEN, &amp;<a name='5051'>
                                                           RQISHTEN, &amp;<a name='5052'>
                                                           RQSSHTEN, &amp;<a name='5053'>
                                                           RQGSHTEN<a name='5054'>
<a name='5055'>
   REAL,  DIMENSION( ims:ime, kms:kme, jms:jme )                   , &amp;<a name='5056'>
          INTENT(INOUT)   ::                                RUBLTEN, &amp;<a name='5057'>
                                                            RVBLTEN, &amp;<a name='5058'>
                                                           RTHBLTEN, &amp;<a name='5059'>
                                                           RQVBLTEN, &amp;<a name='5060'>
                                                           RQCBLTEN, &amp;<a name='5061'>
                                                           RQIBLTEN<a name='5062'>
<a name='5063'>
   REAL,  DIMENSION( ims:ime, kms:kme, jms:jme )                   , &amp;<a name='5064'>
          INTENT(INOUT)   ::                                RTHFTEN, &amp;<a name='5065'>
                                                            RQVFTEN<a name='5066'>
<a name='5067'>
   REAL,  DIMENSION( ims:ime, kms:kme, jms:jme )                   , &amp;<a name='5068'>
          INTENT(INOUT)   ::                                RUNDGDTEN, &amp;<a name='5069'>
                                                            RVNDGDTEN, &amp;<a name='5070'>
                                                           RTHNDGDTEN, &amp;<a name='5071'>
                                                           RPHNDGDTEN, &amp;<a name='5072'>
                                                           RQVNDGDTEN<a name='5073'>
<a name='5074'>
   REAL,  DIMENSION( ims:ime, jms:jme )                            , &amp;<a name='5075'>
          INTENT(INOUT)   ::                               RMUNDGDTEN<a name='5076'>
<a name='5077'>
   REAL, DIMENSION( kms:kme ) ,            INTENT(IN   ) ::     c1h, c2h, c1f, c2f<a name='5078'>
<a name='5079'>
   REAL, DIMENSION( kms:kme ) :: c1, c2<a name='5080'>
<a name='5081'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end, i_startu, j_startv<a name='5082'>
   INTEGER :: i, j, k<a name='5083'>
<a name='5084'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5085'></font>
<a name='5086'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5087'></font>
<font color=#447700>!<a name='5088'></font>
<font color=#447700>!  It decouples the physics tendencies from<a name='5089'></font>
<font color=#447700>!  the column dry-air mass (the physics routines expect to see/update the<a name='5090'></font>
<font color=#447700>!  uncoupled tendencies).<a name='5091'></font>
<font color=#447700>!<a name='5092'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5093'></font>
<a name='5094'>
<font color=#447700>!  set up loop bounds for this grid's boundary conditions<a name='5095'></font>
<a name='5096'>
    i_start = its<a name='5097'>
    i_end   = min( ite,ide-1 )<a name='5098'>
    j_start = jts<a name='5099'>
    j_end   = min( jte,jde-1 )<a name='5100'>
<a name='5101'>
    k_start = kts<a name='5102'>
    k_end = min( kte, kde-1 )<a name='5103'>
<a name='5104'>
    c1 = c1h<a name='5105'>
    c2 = c2h<a name='5106'>
<a name='5107'>
<font color=#447700>! decouple all physics tendencies<a name='5108'></font>
<a name='5109'>
   IF (config_flags%ra_lw_physics .gt. 0 .or. config_flags%ra_sw_physics .gt. 0) THEN<a name='5110'>
<a name='5111'>
      DO J=j_start,j_end<a name='5112'>
      DO K=k_start,k_end<a name='5113'>
      DO I=i_start,i_end<a name='5114'>
         RTHRATEN(I,K,J)=RTHRATEN(I,K,J)/MUT(I,J)<a name='5115'>
      ENDDO<a name='5116'>
      ENDDO<a name='5117'>
      ENDDO<a name='5118'>
<a name='5119'>
   ENDIF<a name='5120'>
<a name='5121'>
   IF (config_flags%cu_physics .gt. 0) THEN<a name='5122'>
<a name='5123'>
      DO J=j_start,j_end<a name='5124'>
      DO I=i_start,i_end<a name='5125'>
      DO K=k_start,k_end<a name='5126'>
         RUCUTEN(I,K,J) =RUCUTEN(I,K,J)/MUT(I,J)<a name='5127'>
         RVCUTEN(I,K,J) =RVCUTEN(I,K,J)/MUT(I,J)<a name='5128'>
         RTHCUTEN(I,K,J)=RTHCUTEN(I,K,J)/MUT(I,J)<a name='5129'>
      ENDDO<a name='5130'>
      ENDDO<a name='5131'>
      ENDDO<a name='5132'>
<a name='5133'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR)THEN<a name='5134'>
         DO J=j_start,j_end<a name='5135'>
         DO I=i_start,i_end<a name='5136'>
         DO K=k_start,k_end<a name='5137'>
            RQVCUTEN(I,K,J)=RQVCUTEN(I,K,J)/MUT(I,J)<a name='5138'>
         ENDDO<a name='5139'>
         ENDDO<a name='5140'>
         ENDDO<a name='5141'>
      ENDIF<a name='5142'>
<a name='5143'>
      IF (P_QC .ge. PARAM_FIRST_SCALAR)THEN<a name='5144'>
         DO J=j_start,j_end<a name='5145'>
         DO I=i_start,i_end<a name='5146'>
         DO K=k_start,k_end<a name='5147'>
            RQCCUTEN(I,K,J)=RQCCUTEN(I,K,J)/MUT(I,J)<a name='5148'>
         ENDDO<a name='5149'>
         ENDDO<a name='5150'>
         ENDDO<a name='5151'>
      ENDIF<a name='5152'>
<a name='5153'>
      IF (P_QR .ge. PARAM_FIRST_SCALAR)THEN<a name='5154'>
         DO J=j_start,j_end<a name='5155'>
         DO I=i_start,i_end<a name='5156'>
         DO K=k_start,k_end<a name='5157'>
            RQRCUTEN(I,K,J)=RQRCUTEN(I,K,J)/MUT(I,J)<a name='5158'>
         ENDDO<a name='5159'>
         ENDDO<a name='5160'>
         ENDDO<a name='5161'>
      ENDIF<a name='5162'>
<a name='5163'>
      IF (P_QI .ge. PARAM_FIRST_SCALAR)THEN<a name='5164'>
         DO J=j_start,j_end<a name='5165'>
         DO I=i_start,i_end<a name='5166'>
         DO K=k_start,k_end<a name='5167'>
            RQICUTEN(I,K,J)=RQICUTEN(I,K,J)/MUT(I,J)<a name='5168'>
         ENDDO<a name='5169'>
         ENDDO<a name='5170'>
         ENDDO<a name='5171'>
      ENDIF<a name='5172'>
<a name='5173'>
      IF(P_QS .ge. PARAM_FIRST_SCALAR)THEN<a name='5174'>
         DO J=j_start,j_end<a name='5175'>
         DO I=i_start,i_end<a name='5176'>
         DO K=k_start,k_end<a name='5177'>
            RQSCUTEN(I,K,J)=RQSCUTEN(I,K,J)/MUT(I,J)<a name='5178'>
         ENDDO<a name='5179'>
         ENDDO<a name='5180'>
         ENDDO<a name='5181'>
      ENDIF<a name='5182'>
<a name='5183'>
   ENDIF<a name='5184'>
<a name='5185'>
   IF (config_flags%shcu_physics .gt. 0) THEN<a name='5186'>
<a name='5187'>
      DO J=j_start,j_end<a name='5188'>
      DO I=i_start,i_end<a name='5189'>
      DO K=k_start,k_end<a name='5190'>
         RUSHTEN(I,K,J) =RUSHTEN(I,K,J)/MUT(I,J)<a name='5191'>
         RVSHTEN(I,K,J) =RVSHTEN(I,K,J)/MUT(I,J)<a name='5192'>
         RTHSHTEN(I,K,J)=RTHSHTEN(I,K,J)/MUT(I,J)<a name='5193'>
      ENDDO<a name='5194'>
      ENDDO<a name='5195'>
      ENDDO<a name='5196'>
<a name='5197'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR)THEN<a name='5198'>
         DO J=j_start,j_end<a name='5199'>
         DO I=i_start,i_end<a name='5200'>
         DO K=k_start,k_end<a name='5201'>
            RQVSHTEN(I,K,J)=RQVSHTEN(I,K,J)/MUT(I,J)<a name='5202'>
         ENDDO<a name='5203'>
         ENDDO<a name='5204'>
         ENDDO<a name='5205'>
      ENDIF<a name='5206'>
<a name='5207'>
      IF (P_QC .ge. PARAM_FIRST_SCALAR)THEN<a name='5208'>
         DO J=j_start,j_end<a name='5209'>
         DO I=i_start,i_end<a name='5210'>
         DO K=k_start,k_end<a name='5211'>
            RQCSHTEN(I,K,J)=RQCSHTEN(I,K,J)/MUT(I,J)<a name='5212'>
         ENDDO<a name='5213'>
         ENDDO<a name='5214'>
         ENDDO<a name='5215'>
      ENDIF<a name='5216'>
<a name='5217'>
      IF (P_QR .ge. PARAM_FIRST_SCALAR)THEN<a name='5218'>
         DO J=j_start,j_end<a name='5219'>
         DO I=i_start,i_end<a name='5220'>
         DO K=k_start,k_end<a name='5221'>
            RQRSHTEN(I,K,J)=RQRSHTEN(I,K,J)/MUT(I,J)<a name='5222'>
         ENDDO<a name='5223'>
         ENDDO<a name='5224'>
         ENDDO<a name='5225'>
      ENDIF<a name='5226'>
<a name='5227'>
      IF (P_QI .ge. PARAM_FIRST_SCALAR)THEN<a name='5228'>
         DO J=j_start,j_end<a name='5229'>
         DO I=i_start,i_end<a name='5230'>
         DO K=k_start,k_end<a name='5231'>
            RQISHTEN(I,K,J)=RQISHTEN(I,K,J)/MUT(I,J)<a name='5232'>
         ENDDO<a name='5233'>
         ENDDO<a name='5234'>
         ENDDO<a name='5235'>
      ENDIF<a name='5236'>
<a name='5237'>
      IF(P_QS .ge. PARAM_FIRST_SCALAR)THEN<a name='5238'>
         DO J=j_start,j_end<a name='5239'>
         DO I=i_start,i_end<a name='5240'>
         DO K=k_start,k_end<a name='5241'>
            RQSSHTEN(I,K,J)=RQSSHTEN(I,K,J)/MUT(I,J)<a name='5242'>
         ENDDO<a name='5243'>
         ENDDO<a name='5244'>
         ENDDO<a name='5245'>
      ENDIF<a name='5246'>
<a name='5247'>
      IF(P_QG .ge. PARAM_FIRST_SCALAR)THEN<a name='5248'>
         DO J=j_start,j_end<a name='5249'>
         DO I=i_start,i_end<a name='5250'>
         DO K=k_start,k_end<a name='5251'>
            RQGSHTEN(I,K,J)=RQGSHTEN(I,K,J)/MUT(I,J)<a name='5252'>
         ENDDO<a name='5253'>
         ENDDO<a name='5254'>
         ENDDO<a name='5255'>
      ENDIF<a name='5256'>
<a name='5257'>
   ENDIF<a name='5258'>
<a name='5259'>
   IF (config_flags%bl_pbl_physics .gt. 0) THEN<a name='5260'>
<a name='5261'>
      DO J=j_start,j_end<a name='5262'>
      DO K=k_start,k_end<a name='5263'>
      DO I=i_start,i_end<a name='5264'>
         RUBLTEN(I,K,J) =RUBLTEN(I,K,J)/MUT(I,J)<a name='5265'>
         RVBLTEN(I,K,J) =RVBLTEN(I,K,J)/MUT(I,J)<a name='5266'>
         RTHBLTEN(I,K,J)=RTHBLTEN(I,K,J)/MUT(I,J)<a name='5267'>
      ENDDO<a name='5268'>
      ENDDO<a name='5269'>
      ENDDO<a name='5270'>
<a name='5271'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR) THEN<a name='5272'>
         DO J=j_start,j_end<a name='5273'>
         DO K=k_start,k_end<a name='5274'>
         DO I=i_start,i_end<a name='5275'>
            RQVBLTEN(I,K,J)=RQVBLTEN(I,K,J)/MUT(I,J)<a name='5276'>
         ENDDO<a name='5277'>
         ENDDO<a name='5278'>
         ENDDO<a name='5279'>
      ENDIF<a name='5280'>
<a name='5281'>
      IF (P_QC .ge. PARAM_FIRST_SCALAR) THEN<a name='5282'>
         DO J=j_start,j_end<a name='5283'>
         DO K=k_start,k_end<a name='5284'>
         DO I=i_start,i_end<a name='5285'>
           RQCBLTEN(I,K,J)=RQCBLTEN(I,K,J)/MUT(I,J)<a name='5286'>
         ENDDO<a name='5287'>
         ENDDO<a name='5288'>
         ENDDO<a name='5289'>
      ENDIF<a name='5290'>
<a name='5291'>
      IF (P_QI .ge. PARAM_FIRST_SCALAR) THEN<a name='5292'>
         DO J=j_start,j_end<a name='5293'>
         DO K=k_start,k_end<a name='5294'>
         DO I=i_start,i_end<a name='5295'>
            RQIBLTEN(I,K,J)=RQIBLTEN(I,K,J)/MUT(I,J)<a name='5296'>
         ENDDO<a name='5297'>
         ENDDO<a name='5298'>
         ENDDO<a name='5299'>
      ENDIF<a name='5300'>
<a name='5301'>
    ENDIF<a name='5302'>
<a name='5303'>
<font color=#447700>!  decouple advective forcing required by Grell-Devenyi scheme<a name='5304'></font>
<a name='5305'>
   if(( config_flags%cu_physics == GDSCHEME ) .OR.    &amp;<a name='5306'>
      ( config_flags%cu_physics == GFSCHEME ) .OR.    &amp;<a name='5307'>
      ( config_flags%cu_physics == G3SCHEME ) .OR.    &amp;<a name='5308'>
      ( config_flags%cu_physics == KFETASCHEME ) .OR. &amp;<a name='5309'>
      ( config_flags%cu_physics == MSKFSCHEME ) .OR. &amp;<a name='5310'>
      ( config_flags%cu_physics == TIEDTKESCHEME ) .OR. &amp;<a name='5311'>
      ( config_flags%cu_physics == NTIEDTKESCHEME )) then  <font color=#447700>! Tiedtke ZCX&amp;YQW<a name='5312'></font>
<a name='5313'>
      DO J=j_start,j_end<a name='5314'>
      DO I=i_start,i_end<a name='5315'>
         DO K=k_start,k_end<a name='5316'>
            RTHFTEN(I,K,J)=RTHFTEN(I,K,J)/MUT(I,J)<a name='5317'>
         ENDDO<a name='5318'>
      ENDDO<a name='5319'>
      ENDDO<a name='5320'>
<a name='5321'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR)THEN<a name='5322'>
         DO J=j_start,j_end<a name='5323'>
         DO I=i_start,i_end<a name='5324'>
            DO K=k_start,k_end<a name='5325'>
               RQVFTEN(I,K,J)=RQVFTEN(I,K,J)/MUT(I,J)<a name='5326'>
            ENDDO<a name='5327'>
         ENDDO<a name='5328'>
         ENDDO<a name='5329'>
      ENDIF<a name='5330'>
<a name='5331'>
   END IF<a name='5332'>
<a name='5333'>
<font color=#447700>! fdda<a name='5334'></font>
<font color=#447700>! note fdda u and v tendencies are staggered, also only interior points have muu/muv,<a name='5335'></font>
<font color=#447700>!   so only decouple those<a name='5336'></font>
<a name='5337'>
   IF (config_flags%grid_fdda .gt. 0) THEN<a name='5338'>
<a name='5339'>
      i_startu=MAX(its,ids+1)<a name='5340'>
      j_startv=MAX(jts,jds+1)<a name='5341'>
<a name='5342'>
      DO J=j_start,j_end<a name='5343'>
      DO K=k_start,k_end<a name='5344'>
      DO I=i_startu,i_end<a name='5345'>
         RUNDGDTEN(I,K,J) =RUNDGDTEN(I,K,J)/muu(I,J)<a name='5346'>
      ENDDO<a name='5347'>
      ENDDO<a name='5348'>
      ENDDO<a name='5349'>
      DO J=j_startv,j_end<a name='5350'>
      DO K=k_start,k_end<a name='5351'>
      DO I=i_start,i_end<a name='5352'>
         RVNDGDTEN(I,K,J) =RVNDGDTEN(I,K,J)/muv(I,J)<a name='5353'>
      ENDDO<a name='5354'>
      ENDDO<a name='5355'>
      ENDDO<a name='5356'>
      DO J=j_start,j_end<a name='5357'>
      DO K=k_start,k_end<a name='5358'>
      DO I=i_start,i_end<a name='5359'>
         RTHNDGDTEN(I,K,J)=RTHNDGDTEN(I,K,J)/MUT(I,J)<a name='5360'>
<font color=#447700>!        RMUNDGDTEN(I,J) - no coupling<a name='5361'></font>
      ENDDO<a name='5362'>
      ENDDO<a name='5363'>
      ENDDO<a name='5364'>
<a name='5365'>
      IF (config_flags%grid_fdda .EQ. 2) THEN<a name='5366'>
      DO J=j_start,j_end<a name='5367'>
      DO K=k_start,kte<a name='5368'>
      DO I=i_start,i_end<a name='5369'>
         RPHNDGDTEN(I,K,J)=RPHNDGDTEN(I,K,J)/mut(I,J)<a name='5370'>
      ENDDO<a name='5371'>
      ENDDO<a name='5372'>
      ENDDO<a name='5373'>
<a name='5374'>
      ELSE IF (config_flags%grid_fdda .EQ. 1) THEN<a name='5375'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR) THEN<a name='5376'>
         DO J=j_start,j_end<a name='5377'>
         DO K=k_start,k_end<a name='5378'>
         DO I=i_start,i_end<a name='5379'>
            RQVNDGDTEN(I,K,J)=RQVNDGDTEN(I,K,J)/MUT(I,J)<a name='5380'>
         ENDDO<a name='5381'>
         ENDDO<a name='5382'>
         ENDDO<a name='5383'>
      ENDIF<a name='5384'>
      ENDIF<a name='5385'>
<a name='5386'>
    ENDIF<a name='5387'>
<a name='5388'>
END SUBROUTINE phy_prep_part2<a name='5389'>
<font color=#447700>!------------------------------------------------------------<a name='5390'></font>
<a name='5391'>
<A NAME='MOIST_PHYSICS_PREP_EM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_PREP_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5392'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>moist_physics_prep_em</font>( t_new, t_old, t0, rho, al, alb, &amp; <A href='../../call_to/MOIST_PHYSICS_PREP_EM.html' TARGET='index'>1</A><a name='5393'>
                                     p, p8w, p0, pb, ph, phb,        &amp;<a name='5394'>
                                     th_phy, pii, pf,                &amp;<a name='5395'>
                                     z, z_at_w, dz8w,                &amp;<a name='5396'>
                                     dt,h_diabatic,                  &amp;<a name='5397'>
                                     qv,qv_diabatic,                 &amp;<a name='5398'>
                                     qc,qc_diabatic,                 &amp;<a name='5399'>
                                     config_flags,fzm, fzp,          &amp;<a name='5400'>
                                     ids,ide, jds,jde, kds,kde,      &amp;<a name='5401'>
                                     ims,ime, jms,jme, kms,kme,      &amp;<a name='5402'>
                                     its,ite, jts,jte, kts,kte      )<a name='5403'>
<a name='5404'>
   IMPLICIT NONE<a name='5405'>
<a name='5406'>
<font color=#447700>! Here we construct full fields<a name='5407'></font>
<font color=#447700>! needed by the microphysics<a name='5408'></font>
<a name='5409'>
   TYPE(grid_config_rec_type),    INTENT(IN   )    :: config_flags<a name='5410'>
<a name='5411'>
   INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='5412'>
   INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='5413'>
   INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='5414'>
<a name='5415'>
   REAL, INTENT(IN   )  ::  dt<a name='5416'>
<a name='5417'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='5418'>
         INTENT(IN   ) ::                           al,  &amp;<a name='5419'>
                                                    alb, &amp;<a name='5420'>
                                                    p,   &amp;<a name='5421'>
                                                    pb,  &amp;<a name='5422'>
                                                    ph,  &amp;<a name='5423'>
                                                    phb, &amp;<a name='5424'>
                                                    qv,  &amp;<a name='5425'>
                                                    qc<a name='5426'>
<a name='5427'>
<a name='5428'>
   REAL , DIMENSION( kms:kme ) ,           INTENT(IN   ) ::   fzm, &amp;<a name='5429'>
                                                              fzp<a name='5430'>
<a name='5431'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),       &amp;<a name='5432'>
         INTENT(  OUT) ::                         rho,  &amp;<a name='5433'>
                                               th_phy,  &amp;<a name='5434'>
                                                  pii,  &amp;<a name='5435'>
                                                  pf,   &amp;<a name='5436'>
                                                    z,  &amp;<a name='5437'>
                                               z_at_w,  &amp;<a name='5438'>
                                                 dz8w,  &amp;<a name='5439'>
                                                  p8w<a name='5440'>
<a name='5441'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),             &amp;<a name='5442'>
         INTENT(INOUT) ::                         h_diabatic, &amp;<a name='5443'>
                                                 qv_diabatic, &amp;<a name='5444'>
                                                 qc_diabatic<a name='5445'>
<a name='5446'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='5447'>
         INTENT(INOUT) ::                         t_new, &amp;<a name='5448'>
                                                  t_old<a name='5449'>
<a name='5450'>
   REAL, INTENT(IN   ) :: t0, p0<a name='5451'>
   REAL                :: z0,z1,z2,w1,w2<a name='5452'>
<a name='5453'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='5454'>
   INTEGER :: i, j, k<a name='5455'>
<a name='5456'>
<font color=#447700>!--------------------------------------------------------------------<a name='5457'></font>
<a name='5458'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5459'></font>
<font color=#447700>!<a name='5460'></font>
<font color=#447700>!  moist_phys_prep_em calculates a number of diagnostic quantities needed by<a name='5461'></font>
<font color=#447700>!  the microphysics routines.<a name='5462'></font>
<font color=#447700>!<a name='5463'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5464'></font>
<a name='5465'>
<font color=#447700>!  set up loop bounds for this grid's boundary conditions<a name='5466'></font>
<a name='5467'>
    i_start = its    <a name='5468'>
    i_end   = min( ite,ide-1 )<a name='5469'>
    j_start = jts    <a name='5470'>
    j_end   = min( jte,jde-1 )<a name='5471'>
<a name='5472'>
    k_start = kts<a name='5473'>
    k_end = min( kte, kde-1 )<a name='5474'>
<a name='5475'>
     DO j = j_start, j_end<a name='5476'>
     DO k = k_start, kte<a name='5477'>
     DO i = i_start, i_end<a name='5478'>
       z_at_w(i,k,j) = (ph(i,k,j)+phb(i,k,j))/g<a name='5479'>
     ENDDO<a name='5480'>
     ENDDO<a name='5481'>
     ENDDO<a name='5482'>
<a name='5483'>
    do j = j_start,j_end<a name='5484'>
    do k = k_start, kte-1<a name='5485'>
    do i = i_start, i_end<a name='5486'>
      dz8w(i,k,j) = z_at_w(i,k+1,j)-z_at_w(i,k,j)<a name='5487'>
    enddo<a name='5488'>
    enddo<a name='5489'>
    enddo<a name='5490'>
<a name='5491'>
    do j = j_start,j_end<a name='5492'>
    do i = i_start, i_end<a name='5493'>
      dz8w(i,kte,j) = 0.<a name='5494'>
    enddo<a name='5495'>
    enddo<a name='5496'>
<a name='5497'>
<a name='5498'>
           <font color=#447700>!  compute full pii, rho, and z at the new time-level<a name='5499'></font>
           <font color=#447700>!  (needed for physics).<a name='5500'></font>
           <font color=#447700>!  convert perturbation theta to full theta (th_phy)<a name='5501'></font>
           <font color=#447700>!  use h_diabatic to temporarily save pre-microphysics full theta<a name='5502'></font>
<a name='5503'>
     DO j = j_start, j_end<a name='5504'>
     DO k = k_start, k_end<a name='5505'>
     DO i = i_start, i_end<a name='5506'>
<a name='5507'>
#ifdef REVERT<a name='5508'>
       t_new(i,k,j) = t_new(i,k,j)-h_diabatic(i,k,j)*dt<a name='5509'>
#endif<a name='5510'>
       th_phy(i,k,j) = t_new(i,k,j) + t0<a name='5511'>
       h_diabatic(i,k,j) = th_phy(i,k,j)<a name='5512'>
       qv_diabatic(i,k,j) = qv(i,k,j)<a name='5513'>
       qc_diabatic(i,k,j) = qc(i,k,j)<a name='5514'>
       rho(i,k,j)  = 1./(al(i,k,j)+alb(i,k,j))<a name='5515'>
       pii(i,k,j) = ((p(i,k,j)+pb(i,k,j))/p0)**rcp<a name='5516'>
       z(i,k,j) = 0.5*(z_at_w(i,k,j) +z_at_w(i,k+1,j) )<a name='5517'>
       pf(i,k,j) = p(i,k,j)+pb(i,k,j)<a name='5518'>
<a name='5519'>
     ENDDO<a name='5520'>
     ENDDO<a name='5521'>
     ENDDO<a name='5522'>
<a name='5523'>
<font color=#447700>!  interp t and p at w points<a name='5524'></font>
<a name='5525'>
    do j = j_start,j_end<a name='5526'>
    do k = 2, k_end<a name='5527'>
    do i = i_start, i_end<a name='5528'>
      p8w(i,k,j) = fzm(k)*pf(i,k,j)+fzp(k)*pf(i,k-1,j)<a name='5529'>
    enddo<a name='5530'>
    enddo<a name='5531'>
    enddo<a name='5532'>
<a name='5533'>
<font color=#447700>!  extrapolate p and t to surface and top.<a name='5534'></font>
<font color=#447700>!  we'll use an extrapolation in z for now<a name='5535'></font>
<a name='5536'>
    do j = j_start,j_end<a name='5537'>
    do i = i_start, i_end<a name='5538'>
<a name='5539'>
<font color=#447700>! bottom<a name='5540'></font>
<a name='5541'>
      z0 = z_at_w(i,1,j)<a name='5542'>
      z1 = z(i,1,j)<a name='5543'>
      z2 = z(i,2,j)<a name='5544'>
      w1 = (z0 - z2)/(z1 - z2)<a name='5545'>
      w2 = 1. - w1<a name='5546'>
      p8w(i,1,j) = w1*pf(i,1,j)+w2*pf(i,2,j)<a name='5547'>
<a name='5548'>
<font color=#447700>! top<a name='5549'></font>
<a name='5550'>
      z0 = z_at_w(i,kte,j)<a name='5551'>
      z1 = z(i,k_end,j)<a name='5552'>
      z2 = z(i,k_end-1,j)<a name='5553'>
      w1 = (z0 - z2)/(z1 - z2)<a name='5554'>
      w2 = 1. - w1<a name='5555'>
<font color=#447700>!      p8w(i,kde,j) = w1*pf(i,kde-1,j)+w2*pf(i,kde-2,j)<a name='5556'></font>
      p8w(i,kde,j) = exp(w1*log(pf(i,kde-1,j))+w2*log(pf(i,kde-2,j)))<a name='5557'>
<a name='5558'>
    enddo<a name='5559'>
    enddo<a name='5560'>
<a name='5561'>
   END SUBROUTINE moist_physics_prep_em<a name='5562'>
<a name='5563'>
<font color=#447700>!------------------------------------------------------------------------------<a name='5564'></font>
<a name='5565'>
<A NAME='MOIST_PHYSICS_FINISH_EM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_FINISH_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5566'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>moist_physics_finish_em</font>( t_new, t_old, t0, mut,     &amp; <A href='../../call_to/MOIST_PHYSICS_FINISH_EM.html' TARGET='index'>1</A>,<A href='../../call_from/MOIST_PHYSICS_FINISH_EM.html' TARGET='index'>1</A><a name='5567'>
                                       th_phy, h_diabatic, dt,    &amp;<a name='5568'>
                                       qv,qv_diabatic,            &amp;<a name='5569'>
                                       qc,qc_diabatic,            &amp;<a name='5570'>
                                       config_flags,              &amp;<a name='5571'>
#if ( WRF_DFI_RADAR == 1 )<a name='5572'>
                                       dfi_tten_rad,dfi_stage,    &amp;<a name='5573'>
#endif<a name='5574'>
                                       ids,ide, jds,jde, kds,kde, &amp;<a name='5575'>
                                       ims,ime, jms,jme, kms,kme, &amp;<a name='5576'>
                                       its,ite, jts,jte, kts,kte )<a name='5577'>
<a name='5578'>
   IMPLICIT NONE<a name='5579'>
<a name='5580'>
<font color=#447700>! Here we construct full fields<a name='5581'></font>
<font color=#447700>! needed by the microphysics<a name='5582'></font>
<a name='5583'>
   TYPE(grid_config_rec_type),    INTENT(IN   )    :: config_flags<a name='5584'>
<a name='5585'>
   INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='5586'>
   INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='5587'>
   INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='5588'>
<a name='5589'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='5590'>
         INTENT(INOUT) ::                         t_new, &amp;<a name='5591'>
                                                  t_old, &amp;<a name='5592'>
                                                 th_phy, &amp;<a name='5593'>
                                                  h_diabatic, &amp;<a name='5594'>
                                                 qv_diabatic, &amp;<a name='5595'>
                                                 qc_diabatic<a name='5596'>
<a name='5597'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='5598'>
         INTENT(IN   ) ::                           qv,  &amp;<a name='5599'>
                                                    qc<a name='5600'>
<a name='5601'>
#if ( WRF_DFI_RADAR == 1 )<a name='5602'>
   REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),        &amp;<a name='5603'>
         INTENT(IN), OPTIONAL ::               dfi_tten_rad<a name='5604'>
   INTEGER,      INTENT(IN   ) ,OPTIONAL   :: dfi_stage<a name='5605'>
   REAL :: dfi_tten_max, old_max<a name='5606'>
#endif<a name='5607'>
<a name='5608'>
   REAL mpten, mptenmax, mptenmin<a name='5609'>
   REAL :: qvten,qcten<a name='5610'>
<a name='5611'>
   REAL, DIMENSION( ims:ime , jms:jme ),  INTENT(INOUT) ::  mut<a name='5612'>
<a name='5613'>
<a name='5614'>
   REAL, INTENT(IN   ) :: t0, dt<a name='5615'>
<a name='5616'>
   INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='5617'>
   INTEGER :: i, j, k, imax, jmax, imin, jmin<a name='5618'>
<a name='5619'>
<font color=#447700>!--------------------------------------------------------------------<a name='5620'></font>
<a name='5621'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5622'></font>
<font color=#447700>!<a name='5623'></font>
<font color=#447700>!  moist_phys_finish_em resets theta to its perturbation value and<a name='5624'></font>
<font color=#447700>!  computes and stores the microphysics diabatic heating term.<a name='5625'></font>
<font color=#447700>!<a name='5626'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5627'></font>
<a name='5628'>
<font color=#447700>!  set up loop bounds for this grid's boundary conditions<a name='5629'></font>
<a name='5630'>
<a name='5631'>
    i_start = its    <a name='5632'>
    i_end   = min( ite,ide-1 )<a name='5633'>
    j_start = jts    <a name='5634'>
    j_end   = min( jte,jde-1 )<a name='5635'>
<font color=#447700>!      i_start=max(its,ids+4)<a name='5636'></font>
<font color=#447700>!      i_end=min(ite,ide-5)<a name='5637'></font>
<font color=#447700>!      j_start=max(jts,jds+4)<a name='5638'></font>
<font color=#447700>!      j_end=min(jte,jde-5)<a name='5639'></font>
<a name='5640'>
    k_start = kts<a name='5641'>
    k_end = min( kte, kde-1 )<a name='5642'>
<a name='5643'>
#if ( WRF_DFI_RADAR == 1 )<a name='5644'>
         IF ( PRESENT(dfi_stage) .and.  PRESENT(dfi_tten_rad) ) THEN<a name='5645'>
            IF ( dfi_stage ==DFI_FWD ) THEN<a name='5646'>
               WRITE(wrf_err_message,*)'Add radar tendency: i_start,j_start: ', i_start, j_start<a name='5647'>
               CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_FINISH_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_7"> ( 100 , TRIM(wrf_err_message) )<a name='5648'>
            ENDIF<a name='5649'>
         ENDIF<a name='5650'>
     dfi_tten_max=-999<a name='5651'>
     old_max=-999<a name='5652'>
#endif<a name='5653'>
<a name='5654'>
<font color=#447700>!  add microphysics theta diff to perturbation theta, set h_diabatic<a name='5655'></font>
<a name='5656'>
     IF ( config_flags%no_mp_heating .eq. 0 ) THEN<a name='5657'>
       mptenmax = 0.<a name='5658'>
       mptenmin = 999.<a name='5659'>
     DO j = j_start, j_end<a name='5660'>
     DO k = k_start, k_end<a name='5661'>
     DO i = i_start, i_end<a name='5662'>
          mpten = th_phy(i,k,j)-h_diabatic(i,k,j)<a name='5663'>
          qvten = qv(i,k,j)-qv_diabatic(i,k,j)<a name='5664'>
          qcten = qc(i,k,j)-qc_diabatic(i,k,j)<a name='5665'>
       if(mpten.gt.mptenmax) then<a name='5666'>
          mptenmax=mpten<a name='5667'>
          imax=i<a name='5668'>
          jmax=j<a name='5669'>
       endif<a name='5670'>
       if(mpten.lt.mptenmin) then<a name='5671'>
          mptenmin=mpten<a name='5672'>
          imin=i<a name='5673'>
          jmin=j<a name='5674'>
       endif<a name='5675'>
          mpten=min(config_flags%mp_tend_lim*dt, mpten)<a name='5676'>
          mpten=max(-config_flags%mp_tend_lim*dt, mpten)<a name='5677'>
<a name='5678'>
#if ( WRF_DFI_RADAR == 1 )<a name='5679'>
       if(k &lt; k_end ) then<a name='5680'>
         if(dfi_tten_max &lt; dfi_tten_rad(i,k,j) ) dfi_tten_max = dfi_tten_rad(i,k,j)<a name='5681'>
         if(old_max &lt; (th_phy(i,k,j)-h_diabatic(i,k,j)) ) old_max=th_phy(i,k,j)-h_diabatic(i,k,j)<a name='5682'>
       endif<a name='5683'>
<a name='5684'>
       IF ( PRESENT(dfi_stage) .and. PRESENT(dfi_tten_rad) ) THEN<a name='5685'>
          IF ( dfi_stage == DFI_FWD .and. dfi_tten_rad(i,k,j) &gt;= -0.1 .and. &amp;<a name='5686'>
               dfi_tten_rad(i,k,j) &lt;= 0.1 .and. k &lt; k_end ) THEN<a name='5687'>
<font color=#447700>! add radar temp tendency<a name='5688'></font>
<font color=#447700>! there is radar coverage<a name='5689'></font>
               t_new(i,k,j) = t_new(i,k,j) + (dfi_tten_rad(i,k,j))*dt<a name='5690'>
          ELSE<a name='5691'>
<font color=#447700>! no radar coverage<a name='5692'></font>
               t_new(i,k,j) = t_new(i,k,j) + mpten<a name='5693'>
          ENDIF<a name='5694'>
       ENDIF<a name='5695'>
#else<a name='5696'>
         t_new(i,k,j) = t_new(i,k,j) + mpten<a name='5697'>
#endif<a name='5698'>
         h_diabatic(i,k,j) =  mpten/dt<a name='5699'>
<font color=#447700>!!!         ! KLUDGE:<a name='5700'></font>
<font color=#447700>!!!         qvten = 0.0<a name='5701'></font>
<font color=#447700>!!!         qcten = 0.0<a name='5702'></font>
         qv_diabatic(i,k,j) =  qvten/dt<a name='5703'>
         qc_diabatic(i,k,j) =  qcten/dt<a name='5704'>
     ENDDO<a name='5705'>
     ENDDO<a name='5706'>
     ENDDO<a name='5707'>
<a name='5708'>
     ELSE<a name='5709'>
<a name='5710'>
     DO j = j_start, j_end<a name='5711'>
     DO k = k_start, k_end<a name='5712'>
     DO i = i_start, i_end<a name='5713'>
<font color=#447700>!        t_new(i,k,j) = t_new(i,k,j)<a name='5714'></font>
         h_diabatic(i,k,j) = 0.<a name='5715'>
         qv_diabatic(i,k,j) = 0.<a name='5716'>
         qc_diabatic(i,k,j) = 0.<a name='5717'>
     ENDDO<a name='5718'>
     ENDDO<a name='5719'>
     ENDDO<a name='5720'>
     ENDIF<a name='5721'>
<a name='5722'>
   END SUBROUTINE moist_physics_finish_em<a name='5723'>
<a name='5724'>
<font color=#447700>!----------------------------------------------------------------<a name='5725'></font>
<a name='5726'>
<a name='5727'>
<A NAME='INIT_MODULE_BIG_STEP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#INIT_MODULE_BIG_STEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5728'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_big_step</font><a name='5729'>
   END SUBROUTINE init_module_big_step<a name='5730'>
<a name='5731'>
<A NAME='SET_TEND'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SET_TEND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5732'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>set_tend</font> ( field, field_adv_tend, msf,       &amp; <A href='../../call_to/SET_TEND.html' TARGET='index'>2</A><a name='5733'>
                      ids, ide, jds, jde, kds, kde,     &amp;<a name='5734'>
                      ims, ime, jms, jme, kms, kme,     &amp;<a name='5735'>
                      its, ite, jts, jte, kts, kte       )<a name='5736'>
<a name='5737'>
   IMPLICIT NONE<a name='5738'>
<a name='5739'>
   <font color=#447700>! Input data<a name='5740'></font>
<a name='5741'>
   INTEGER ,  INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='5742'>
                               ims, ime, jms, jme, kms, kme, &amp;<a name='5743'>
                               its, ite, jts, jte, kts, kte<a name='5744'>
<a name='5745'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(OUT) :: field<a name='5746'>
<a name='5747'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN)  :: field_adv_tend<a name='5748'>
<a name='5749'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN)  :: msf<a name='5750'>
<a name='5751'>
   <font color=#447700>! Local data<a name='5752'></font>
<a name='5753'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='5754'>
<a name='5755'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='5756'></font>
<font color=#447700>!<a name='5757'></font>
<font color=#447700>!  set_tend copies the advective tendency array into the tendency array.<a name='5758'></font>
<font color=#447700>!<a name='5759'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='5760'></font>
<a name='5761'>
      jtf = MIN(jte,jde-1)<a name='5762'>
      ktf = MIN(kte,kde-1)<a name='5763'>
      itf = MIN(ite,ide-1)<a name='5764'>
      DO j = jts, jtf<a name='5765'>
      DO k = kts, ktf<a name='5766'>
      DO i = its, itf<a name='5767'>
         field(i,k,j) = field_adv_tend(i,k,j)*msf(i,j)<a name='5768'>
      ENDDO<a name='5769'>
      ENDDO<a name='5770'>
      ENDDO<a name='5771'>
<a name='5772'>
END SUBROUTINE set_tend<a name='5773'>
<a name='5774'>
<font color=#447700>!------------------------------------------------------------------------------<a name='5775'></font>
<a name='5776'>
<A NAME='RK_RAYLEIGH_DAMP'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#RK_RAYLEIGH_DAMP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='5777'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>rk_rayleigh_damp</font>( ru_tendf, rv_tendf,              &amp; <A href='../../call_to/RK_RAYLEIGH_DAMP.html' TARGET='index'>1</A><a name='5778'>
                                 rw_tendf, t_tendf,               &amp;<a name='5779'>
                                 u, v, w, t, t_init,              &amp;<a name='5780'>
                                 c1h, c2h, c1f, c2f,              &amp;<a name='5781'>
                                 mut, muu, muv, ph, phb,          &amp;<a name='5782'>
                                 u_base, v_base, t_base, z_base,  &amp;<a name='5783'>
                                 dampcoef, zdamp,                 &amp;<a name='5784'>
                                 ids, ide, jds, jde, kds, kde,    &amp;<a name='5785'>
                                 ims, ime, jms, jme, kms, kme,    &amp;<a name='5786'>
                                 its, ite, jts, jte, kts, kte   )<a name='5787'>
<a name='5788'>
<font color=#447700>! History:     Apr 2005  Modifications by George Bryan, NCAR:<a name='5789'></font>
<font color=#447700>!                  - Generalized the code in a way that allows for<a name='5790'></font>
<font color=#447700>!                    simulations with steep terrain.<a name='5791'></font>
<font color=#447700>!<a name='5792'></font>
<font color=#447700>!              Jul 2004  Modifications by George Bryan, NCAR:<a name='5793'></font>
<font color=#447700>!                  - Modified the code to use u_base, v_base, and t_base<a name='5794'></font>
<font color=#447700>!                    arrays for the background state.  Removed the hard-wired<a name='5795'></font>
<font color=#447700>!                    base-state values.<a name='5796'></font>
<font color=#447700>!                  - Modified the code to use dampcoef, zdamp, and damp_opt,<a name='5797'></font>
<font color=#447700>!                    i.e., the upper-level damper variables in namelist.input.<a name='5798'></font>
<font color=#447700>!                    Removed the hard-wired variables in the older version.<a name='5799'></font>
<font color=#447700>!                    This damper is used when damp_opt = 2.<a name='5800'></font>
<font color=#447700>!                  - Modified the code to account for the movement of the<a name='5801'></font>
<font color=#447700>!                    model surfaces with time.  The code now obtains a base-<a name='5802'></font>
<font color=#447700>!                    state value by interpolation using the "_base" arrays.<a name='5803'></font>
<a name='5804'>
<font color=#447700>!              Nov 2003  Bug fix by Jason Knievel, NCAR<a name='5805'></font>
<a name='5806'>
<font color=#447700>!              Aug 2003  Meridional dimension, some comments, and<a name='5807'></font>
<font color=#447700>!                        changes in layout of the code added by<a name='5808'></font>
<font color=#447700>!                        Jason Knievel, NCAR<a name='5809'></font>
<a name='5810'>
<font color=#447700>!              Jul 2003  Original code by Bill Skamarock, NCAR<a name='5811'></font>
<a name='5812'>
<font color=#447700>! Purpose:     This routine applies Rayleigh damping to a layer at top<a name='5813'></font>
<font color=#447700>!              of the model domain.<a name='5814'></font>
<a name='5815'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5816'></font>
<font color=#447700>! Begin declarations.<a name='5817'></font>
<a name='5818'>
    IMPLICIT NONE<a name='5819'>
<a name='5820'>
    INTEGER, INTENT( IN )  &amp;<a name='5821'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='5822'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='5823'>
       its, ite, jts, jte, kts, kte<a name='5824'>
<a name='5825'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='5826'>
    :: ru_tendf, rv_tendf, rw_tendf, t_tendf<a name='5827'>
<a name='5828'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='5829'>
    :: u, v, w, t, t_init, ph, phb<a name='5830'>
<a name='5831'>
    REAL, DIMENSION( ims:ime, jms:jme ),  INTENT( IN )  &amp;<a name='5832'>
    :: mut, muu, muv<a name='5833'>
<a name='5834'>
    REAL, DIMENSION( kms:kme ) ,  INTENT(IN   )  &amp;<a name='5835'>
    :: u_base, v_base, t_base, z_base<a name='5836'>
<a name='5837'>
    REAL, DIMENSION( kms:kme ) ,  INTENT(IN   )  &amp;<a name='5838'>
    :: c1h, c2h, c1f, c2f<a name='5839'>
<a name='5840'>
    REAL, INTENT(IN   )   &amp;<a name='5841'>
    :: dampcoef, zdamp<a name='5842'>
<a name='5843'>
<font color=#447700>! Local variables.<a name='5844'></font>
<a name='5845'>
    INTEGER  &amp;<a name='5846'>
    :: i_start, i_end, j_start, j_end, k_start, k_end, i, j, k, ktf, k1, k2<a name='5847'>
<a name='5848'>
    REAL, DIMENSION( kms:kme ) &amp;<a name='5849'>
    :: c1, c2<a name='5850'>
<a name='5851'>
    REAL  &amp;<a name='5852'>
    :: pii, dcoef, z, ztop<a name='5853'>
<a name='5854'>
    REAL :: wkp1, wk, wkm1<a name='5855'>
<a name='5856'>
    REAL, DIMENSION( kms:kme ) :: z00, u00, v00, t00<a name='5857'>
<a name='5858'>
<font color=#447700>! End declarations.<a name='5859'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5860'></font>
<a name='5861'>
    c1 = c1h<a name='5862'>
    c2 = c2h<a name='5863'>
<a name='5864'>
    pii = 2.0 * asin(1.0)<a name='5865'>
<a name='5866'>
    ktf = MIN( kte,   kde-1 )<a name='5867'>
<a name='5868'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5869'></font>
<font color=#447700>! Adjust u to base state.<a name='5870'></font>
<a name='5871'>
    DO j = jts, MIN( jte, jde-1 )<a name='5872'>
    DO i = its, MIN( ite, ide   )<a name='5873'>
<a name='5874'>
      <font color=#447700>! Get height at top of model<a name='5875'></font>
      ztop = 0.5*( phb(i  ,kde,j)+phb(i-1,kde,j)   &amp;<a name='5876'>
                  +ph(i  ,kde,j)+ph(i-1,kde,j) )/g<a name='5877'>
<a name='5878'>
      <font color=#447700>! Find bottom of damping layer<a name='5879'></font>
      k1 = ktf<a name='5880'>
      z = ztop<a name='5881'>
      DO WHILE( z &gt;= (ztop-zdamp) )<a name='5882'>
        z = 0.25*( phb(i  ,k1,j)+phb(i  ,k1+1,j)  &amp;<a name='5883'>
                  +phb(i-1,k1,j)+phb(i-1,k1+1,j)  &amp;<a name='5884'>
                  +ph(i  ,k1,j)+ph(i  ,k1+1,j)    &amp;<a name='5885'>
                  +ph(i-1,k1,j)+ph(i-1,k1+1,j))/g<a name='5886'>
        z00(k1) = z<a name='5887'>
        k1 = k1 - 1<a name='5888'>
      ENDDO<a name='5889'>
      k1 = k1 + 2<a name='5890'>
<a name='5891'>
      <font color=#447700>! Get reference state at model levels<a name='5892'></font>
      DO k = k1, ktf<a name='5893'>
        k2 = ktf<a name='5894'>
        DO WHILE( z_base(k2) .gt. z00(k) )<a name='5895'>
          k2 = k2 - 1<a name='5896'>
        ENDDO<a name='5897'>
        if(k2+1.gt.ktf)then<a name='5898'>
          u00(k) = u_base(k2) + ( u_base(k2) - u_base(k2-1) )   &amp;<a name='5899'>
                              * (     z00(k) - z_base(k2)   )   &amp;<a name='5900'>
                              / ( z_base(k2) - z_base(k2-1) )<a name='5901'>
        else<a name='5902'>
          u00(k) = u_base(k2) + ( u_base(k2+1) - u_base(k2) )   &amp;<a name='5903'>
                              * (       z00(k) - z_base(k2) )   &amp;<a name='5904'>
                              / ( z_base(k2+1) - z_base(k2) )<a name='5905'>
        endif<a name='5906'>
      ENDDO<a name='5907'>
<a name='5908'>
      <font color=#447700>! Apply the Rayleigh damper<a name='5909'></font>
      DO k = k1, ktf<a name='5910'>
        dcoef = 1.0 - MIN( 1.0, ( ztop - z00(k) ) / zdamp )<a name='5911'>
        dcoef = (SIN( 0.5 * pii * dcoef ) )**2<a name='5912'>
        ru_tendf(i,k,j) = ru_tendf(i,k,j) -                    &amp;<a name='5913'>
                          muu(i,j) * ( dcoef * dampcoef ) *    &amp;<a name='5914'>
                          ( u(i,k,j) - u00(k) )<a name='5915'>
      END DO<a name='5916'>
<a name='5917'>
    END DO<a name='5918'>
    END DO<a name='5919'>
<a name='5920'>
<font color=#447700>! End adjustment of u.<a name='5921'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5922'></font>
<a name='5923'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5924'></font>
<font color=#447700>! Adjust v to base state.<a name='5925'></font>
<a name='5926'>
    DO j = jts, MIN( jte, jde   )<a name='5927'>
    DO i = its, MIN( ite, ide-1 )<a name='5928'>
<a name='5929'>
      <font color=#447700>! Get height at top of model<a name='5930'></font>
      ztop = 0.5*( phb(i,kde,j  )+phb(i,kde,j-1)   &amp;<a name='5931'>
                  +ph(i,kde,j  )+ph(i,kde,j-1) )/g<a name='5932'>
<a name='5933'>
      <font color=#447700>! Find bottom of damping layer<a name='5934'></font>
      k1 = ktf<a name='5935'>
      z = ztop<a name='5936'>
      DO WHILE( z &gt;= (ztop-zdamp) )<a name='5937'>
        z = 0.25*( phb(i,k1,j  )+phb(i,k1+1,j  )  &amp;<a name='5938'>
                  +phb(i,k1,j-1)+phb(i,k1+1,j-1)  &amp;<a name='5939'>
                  +ph(i,k1,j  )+ph(i,k1+1,j  )    &amp;<a name='5940'>
                  +ph(i,k1,j-1)+ph(i,k1+1,j-1))/g<a name='5941'>
        z00(k1) = z<a name='5942'>
        k1 = k1 - 1<a name='5943'>
      ENDDO<a name='5944'>
      k1 = k1 + 2<a name='5945'>
<a name='5946'>
      <font color=#447700>! Get reference state at model levels<a name='5947'></font>
      DO k = k1, ktf<a name='5948'>
        k2 = ktf<a name='5949'>
        DO WHILE( z_base(k2) .gt. z00(k) )<a name='5950'>
          k2 = k2 - 1<a name='5951'>
        ENDDO<a name='5952'>
        if(k2+1.gt.ktf)then<a name='5953'>
          v00(k) = v_base(k2) + ( v_base(k2) - v_base(k2-1) )   &amp;<a name='5954'>
                              * (     z00(k) - z_base(k2)   )   &amp;<a name='5955'>
                              / ( z_base(k2) - z_base(k2-1) )<a name='5956'>
        else<a name='5957'>
          v00(k) = v_base(k2) + ( v_base(k2+1) - v_base(k2) )   &amp;<a name='5958'>
                              * (       z00(k) - z_base(k2) )   &amp;<a name='5959'>
                              / ( z_base(k2+1) - z_base(k2) )<a name='5960'>
        endif<a name='5961'>
      ENDDO<a name='5962'>
<a name='5963'>
      <font color=#447700>! Apply the Rayleigh damper<a name='5964'></font>
      DO k = k1, ktf<a name='5965'>
        dcoef = 1.0 - MIN( 1.0, ( ztop - z00(k) ) / zdamp )<a name='5966'>
        dcoef = (SIN( 0.5 * pii * dcoef ) )**2<a name='5967'>
        rv_tendf(i,k,j) = rv_tendf(i,k,j) -                    &amp;<a name='5968'>
                          muv(i,j) * ( dcoef * dampcoef ) *    &amp;<a name='5969'>
                          ( v(i,k,j) - v00(k) )<a name='5970'>
      END DO<a name='5971'>
<a name='5972'>
    END DO<a name='5973'>
    END DO<a name='5974'>
<a name='5975'>
<font color=#447700>! End adjustment of v.<a name='5976'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5977'></font>
<a name='5978'>
<font color=#447700>!-----------------------------------------------------------------------<a name='5979'></font>
<font color=#447700>! Adjust w to base state.<a name='5980'></font>
<a name='5981'>
    DO j = jts, MIN( jte,   jde-1 )<a name='5982'>
    DO i = its, MIN( ite,   ide-1 )<a name='5983'>
      ztop = ( phb(i,kde,j) + ph(i,kde,j) ) / g<a name='5984'>
      DO k = kts, MIN( kte,   kde   )<a name='5985'>
        z = ( phb(i,k,j) + ph(i,k,j) ) / g<a name='5986'>
        IF ( z &gt;= (ztop-zdamp) ) THEN<a name='5987'>
          dcoef = 1.0 - MIN( 1.0, ( ztop - z ) / zdamp )<a name='5988'>
          dcoef = ( SIN( 0.5 * pii * dcoef ) )**2<a name='5989'>
          rw_tendf(i,k,j) = rw_tendf(i,k,j) -  &amp;<a name='5990'>
                            mut(i,j) * ( dcoef * dampcoef ) * w(i,k,j)<a name='5991'>
        END IF<a name='5992'>
      END DO<a name='5993'>
    END DO<a name='5994'>
    END DO<a name='5995'>
<a name='5996'>
<font color=#447700>! End adjustment of w.<a name='5997'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='5998'></font>
<a name='5999'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6000'></font>
<font color=#447700>! Adjust potential temperature to base state.<a name='6001'></font>
<a name='6002'>
    DO j = jts, MIN( jte,   jde-1 )<a name='6003'>
    DO i = its, MIN( ite,   ide-1 )<a name='6004'>
<a name='6005'>
      <font color=#447700>! Get height at top of model<a name='6006'></font>
      ztop = ( phb(i,kde,j) + ph(i,kde,j) ) / g<a name='6007'>
<a name='6008'>
      <font color=#447700>! Find bottom of damping layer<a name='6009'></font>
      k1 = ktf<a name='6010'>
      z = ztop<a name='6011'>
      DO WHILE( z &gt;= (ztop-zdamp) )<a name='6012'>
        z = 0.5 * ( phb(i,k1,j) + phb(i,k1+1,j) +  &amp;<a name='6013'>
                     ph(i,k1,j) +  ph(i,k1+1,j) ) / g<a name='6014'>
        z00(k1) = z<a name='6015'>
        k1 = k1 - 1<a name='6016'>
      ENDDO<a name='6017'>
      k1 = k1 + 2<a name='6018'>
<a name='6019'>
      <font color=#447700>! Get reference state at model levels<a name='6020'></font>
      DO k = k1, ktf<a name='6021'>
        k2 = ktf<a name='6022'>
        DO WHILE( z_base(k2) .gt. z00(k) )<a name='6023'>
          k2 = k2 - 1<a name='6024'>
        ENDDO<a name='6025'>
        if(k2+1.gt.ktf)then<a name='6026'>
          t00(k) = t_base(k2) + ( t_base(k2) - t_base(k2-1) )   &amp;<a name='6027'>
                              * (     z00(k) - z_base(k2)   )   &amp;<a name='6028'>
                              / ( z_base(k2) - z_base(k2-1) )<a name='6029'>
        else<a name='6030'>
          t00(k) = t_base(k2) + ( t_base(k2+1) - t_base(k2) )   &amp;<a name='6031'>
                              * (       z00(k) - z_base(k2) )   &amp;<a name='6032'>
                              / ( z_base(k2+1) - z_base(k2) )<a name='6033'>
        endif<a name='6034'>
      ENDDO<a name='6035'>
<a name='6036'>
      <font color=#447700>! Apply the Rayleigh damper<a name='6037'></font>
      DO k = k1, ktf<a name='6038'>
        dcoef = 1.0 - MIN( 1.0, ( ztop - z00(k) ) / zdamp )<a name='6039'>
        dcoef = (SIN( 0.5 * pii * dcoef ) )**2<a name='6040'>
        t_tendf(i,k,j) = t_tendf(i,k,j) -                      &amp;<a name='6041'>
                         MUT(i,j) * ( dcoef * dampcoef )  *    &amp;<a name='6042'>
                         ( t(i,k,j) - t00(k) )<a name='6043'>
      END DO<a name='6044'>
<a name='6045'>
    END DO<a name='6046'>
    END DO<a name='6047'>
<a name='6048'>
<font color=#447700>! End adjustment of potential temperature.<a name='6049'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6050'></font>
<a name='6051'>
    END SUBROUTINE rk_rayleigh_damp<a name='6052'>
<a name='6053'>
<font color=#447700>!==============================================================================<a name='6054'></font>
<font color=#447700>!==============================================================================<a name='6055'></font>
<a name='6056'>
<A NAME='THETA_RELAXATION'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#THETA_RELAXATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6057'>
 <font color=#993300>SUBROUTINE </font><font color=#cc0000>theta_relaxation</font>( t_tendf, t, t_init,              &amp; <A href='../../call_to/THETA_RELAXATION.html' TARGET='index'>1</A><a name='6058'>
                              MUT, c1, c2, ph, phb,            &amp;<a name='6059'>
                              t_base, z_base,                  &amp;<a name='6060'>
                              ids, ide, jds, jde, kds, kde,    &amp;<a name='6061'>
                              ims, ime, jms, jme, kms, kme,    &amp;<a name='6062'>
                              its, ite, jts, jte, kts, kte   )<a name='6063'>
<a name='6064'>
<font color=#447700>! Purpose:  Newtonian relaxation on potential temperature.  Serves two <a name='6065'></font>
<font color=#447700>!           purposes:  1) to mimic atmospheric radiation in a simple <a name='6066'></font>
<font color=#447700>!           manner, and 2) to keep the vertical profile of temperature <a name='6067'></font>
<font color=#447700>!           close to the initial (base-state) profile, which is useful <a name='6068'></font>
<font color=#447700>!           for certain idealized applications. <a name='6069'></font>
<a name='6070'>
<font color=#447700>! Reference:  Rotunno and Emanuel, 1987, JAS, p. 546<a name='6071'></font>
<a name='6072'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6073'></font>
<font color=#447700>! Begin declarations.<a name='6074'></font>
<a name='6075'>
    IMPLICIT NONE<a name='6076'>
<a name='6077'>
    INTEGER, INTENT( IN )  &amp;<a name='6078'>
    :: ids, ide, jds, jde, kds, kde,  &amp;<a name='6079'>
       ims, ime, jms, jme, kms, kme,  &amp;<a name='6080'>
       its, ite, jts, jte, kts, kte<a name='6081'>
<a name='6082'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( INOUT )  &amp;<a name='6083'>
    :: t_tendf<a name='6084'>
<a name='6085'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT( IN )  &amp;<a name='6086'>
    :: t, t_init, ph, phb<a name='6087'>
<a name='6088'>
    REAL, DIMENSION( ims:ime, jms:jme ),  INTENT( IN )  &amp;<a name='6089'>
    :: MUT<a name='6090'>
<a name='6091'>
    REAL, DIMENSION( kms:kme),  INTENT( IN )  &amp;<a name='6092'>
    :: c1, c2<a name='6093'>
<a name='6094'>
    REAL, DIMENSION( kms:kme ) ,  INTENT(IN   )  &amp;<a name='6095'>
    :: t_base, z_base<a name='6096'>
<a name='6097'>
<font color=#447700>! Local variables.<a name='6098'></font>
<a name='6099'>
    INTEGER :: i, j, k, ktf, k2<a name='6100'>
    REAL :: tau_r , rmax , rmin , inv_tau_r , inv_g , rterm<a name='6101'>
    REAL, DIMENSION( kms:kme ) :: z00,t00<a name='6102'>
<a name='6103'>
<font color=#447700>! End declarations.<a name='6104'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='6105'></font>
<a name='6106'>
    <font color=#447700>! set tau_r to 12 h, following RE87<a name='6107'></font>
    tau_r = 12.0*3600.0<a name='6108'>
<a name='6109'>
    <font color=#447700>! limit rterm to +/- 2 K/day<a name='6110'></font>
    rmax =  2.0/86400.0<a name='6111'>
    rmin = -rmax<a name='6112'>
<a name='6113'>
    ktf = MIN( kte,   kde-1 )<a name='6114'>
    inv_tau_r = 1.0/tau_r<a name='6115'>
    inv_g = 1.0/g<a name='6116'>
<a name='6117'>
<font color=#447700>!-----------------------------------------------------------------------<a name='6118'></font>
<font color=#447700>! Adjust potential temperature to base state.<a name='6119'></font>
<a name='6120'>
    DO j = jts, MIN( jte,   jde-1 )<a name='6121'>
    DO i = its, MIN( ite,   ide-1 )<a name='6122'>
<a name='6123'>
      <font color=#447700>! Get height of model levels:<a name='6124'></font>
      DO k = kts, ktf<a name='6125'>
        z00(k) = 0.5 * ( phb(i,k,j) + phb(i,k+1,j) +  &amp;<a name='6126'>
                          ph(i,k,j) +  ph(i,k+1,j) ) * inv_g<a name='6127'>
      ENDDO<a name='6128'>
<a name='6129'>
      <font color=#447700>! Get reference state:<a name='6130'></font>
      DO k = kts, ktf<a name='6131'>
        k2 = ktf<a name='6132'>
        DO WHILE( z_base(k2) .gt. z00(k)  .and.  k2 .gt. 1 )<a name='6133'>
          k2 = k2 - 1<a name='6134'>
        ENDDO<a name='6135'>
        if(k2+1.gt.ktf)then<a name='6136'>
          t00(k) = t_base(k2) + ( t_base(k2) - t_base(k2-1) )   &amp;<a name='6137'>
                              * (     z00(k) - z_base(k2)   )   &amp;<a name='6138'>
                              / ( z_base(k2) - z_base(k2-1) )<a name='6139'>
        else<a name='6140'>
          t00(k) = t_base(k2) + ( t_base(k2+1) - t_base(k2) )   &amp;<a name='6141'>
                              * (       z00(k) - z_base(k2) )   &amp;<a name='6142'>
                              / ( z_base(k2+1) - z_base(k2) )<a name='6143'>
        endif<a name='6144'>
      ENDDO<a name='6145'>
<a name='6146'>
      <font color=#447700>! Apply the RE87 R term:<a name='6147'></font>
      DO k = kts, ktf<a name='6148'>
        rterm = -( t(i,k,j) - t00(k) )*inv_tau_r<a name='6149'>
        <font color=#447700>! limit rterm:<a name='6150'></font>
        rterm = min( rterm , rmax )<a name='6151'>
        rterm = max( rterm , rmin )<a name='6152'>
        t_tendf(i,k,j) = t_tendf(i,k,j) + MUT(i,j)*rterm<a name='6153'>
      END DO<a name='6154'>
<a name='6155'>
    END DO<a name='6156'>
    END DO<a name='6157'>
<a name='6158'>
 END SUBROUTINE theta_relaxation<a name='6159'>
<a name='6160'>
<font color=#447700>!==============================================================================<a name='6161'></font>
<font color=#447700>!==============================================================================<a name='6162'></font>
                                                                                <a name='6163'>
<A NAME='SIXTH_ORDER_DIFFUSION'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SIXTH_ORDER_DIFFUSION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6164'>
      <font color=#993300>SUBROUTINE </font><font color=#cc0000>sixth_order_diffusion</font>( name, field, tendency, MUT, dt,  &amp; <A href='../../call_to/SIXTH_ORDER_DIFFUSION.html' TARGET='index'>5</A><a name='6165'>
                                        config_flags, c1, c2,           &amp;<a name='6166'>
                                        diff_6th_opt, diff_6th_factor,  &amp;<a name='6167'>
                                        ids, ide, jds, jde, kds, kde,   &amp;<a name='6168'>
                                        ims, ime, jms, jme, kms, kme,   &amp;<a name='6169'>
                                        its, ite, jts, jte, kts, kte )<a name='6170'>
                                                                                <a name='6171'>
<font color=#447700>! History:       14 Nov 2006   Name of variable changed by Jason Knievel<a name='6172'></font>
<font color=#447700>!                07 Jun 2006   Revised and generalized by Jason Knievel  <a name='6173'></font>
<font color=#447700>!                25 Apr 2005   Original code by Jason Knievel, NCAR<a name='6174'></font>
                                                                                <a name='6175'>
<font color=#447700>! Purpose:       Apply 6th-order, monotonic (flux-limited), numerical<a name='6176'></font>
<font color=#447700>!                diffusion to 3-d velocity and to scalars.<a name='6177'></font>
                                                                                <a name='6178'>
<font color=#447700>! References:    Ming Xue (MWR Aug 2000)<a name='6179'></font>
<font color=#447700>!                Durran ("Numerical Methods for Wave Equations..." 1999)<a name='6180'></font>
<font color=#447700>!                George Bryan (personal communication)<a name='6181'></font>
 <a name='6182'>
<font color=#447700>!------------------------------------------------------------------------------<a name='6183'></font>
<font color=#447700>! Begin: Declarations.<a name='6184'></font>
<a name='6185'>
    IMPLICIT NONE<a name='6186'>
<a name='6187'>
    INTEGER, INTENT(IN)  &amp;<a name='6188'>
    :: ids, ide, jds, jde, kds, kde,   &amp;<a name='6189'>
       ims, ime, jms, jme, kms, kme,   &amp;<a name='6190'>
       its, ite, jts, jte, kts, kte<a name='6191'>
 <a name='6192'>
    TYPE(grid_config_rec_type), INTENT(IN)  &amp;<a name='6193'>
    :: config_flags<a name='6194'>
 <a name='6195'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(INOUT)  &amp;<a name='6196'>
    :: tendency<a name='6197'>
 <a name='6198'>
    REAL, DIMENSION( ims:ime, kms:kme, jms:jme ), INTENT(IN)  &amp;<a name='6199'>
    :: field<a name='6200'>
 <a name='6201'>
    REAL, DIMENSION( ims:ime , jms:jme ), INTENT(IN)  &amp;<a name='6202'>
    :: MUT<a name='6203'>
 <a name='6204'>
    REAL, DIMENSION( kms:kme ), INTENT(IN)  &amp;<a name='6205'>
    :: c1, c2<a name='6206'>
 <a name='6207'>
    REAL, INTENT(IN)  &amp;<a name='6208'>
    :: dt<a name='6209'>
<a name='6210'>
    REAL, INTENT(IN)  &amp;<a name='6211'>
    :: diff_6th_factor<a name='6212'>
<a name='6213'>
    INTEGER, INTENT(IN)  &amp;<a name='6214'>
    :: diff_6th_opt<a name='6215'>
<a name='6216'>
    CHARACTER(LEN=1) , INTENT(IN)  &amp;<a name='6217'>
    :: name<a name='6218'>
<a name='6219'>
    INTEGER  &amp;<a name='6220'>
    :: i, j, k,         &amp;<a name='6221'>
       i_start, i_end,  &amp;<a name='6222'>
       j_start, j_end,  &amp;<a name='6223'>
       k_start, k_end,  &amp;<a name='6224'>
       ktf<a name='6225'>
 <a name='6226'>
    REAL  &amp;<a name='6227'>
    :: dflux_x_p0, dflux_y_p0,  &amp;<a name='6228'>
       dflux_x_p1, dflux_y_p1,  &amp;<a name='6229'>
       tendency_x, tendency_y,  &amp;<a name='6230'>
       mu_avg_p0, mu_avg_p1,    &amp;<a name='6231'>
       diff_6th_coef<a name='6232'>
<a name='6233'>
    LOGICAL  &amp;<a name='6234'>
    :: specified<a name='6235'>
 <a name='6236'>
<font color=#447700>! End: Declarations.<a name='6237'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='6238'></font>
<a name='6239'>
<font color=#447700>!------------------------------------------------------------------------------<a name='6240'></font>
<font color=#447700>! Begin: Translate the diffusion factor into a diffusion coefficient.  See<a name='6241'></font>
<font color=#447700>! Durran's text, section 2.4.3, then adjust for sixth-order diffusion (not<a name='6242'></font>
<font color=#447700>! fourth) and for diffusion in two dimensions (not one).  For reference, a<a name='6243'></font>
<font color=#447700>! factor of 1.0 would mean complete diffusion of a 2dx wave in one time step,<a name='6244'></font>
<font color=#447700>! although application of the flux limiter reduces somewhat the effects of<a name='6245'></font>
<font color=#447700>! diffusion for a given coefficient.<a name='6246'></font>
<a name='6247'>
    diff_6th_coef = diff_6th_factor * 0.015625 / ( 2.0 * dt )  <a name='6248'>
<a name='6249'>
<font color=#447700>! End: Translate diffusion factor.<a name='6250'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='6251'></font>
<a name='6252'>
<font color=#447700>!------------------------------------------------------------------------------<a name='6253'></font>
<font color=#447700>! Begin: Assign limits of spatial loops depending on variable to be diffused.<a name='6254'></font>
<font color=#447700>! The halo regions are already filled with values by the time this subroutine<a name='6255'></font>
<font color=#447700>! is called, which allows the stencil to extend beyond the domains' edges.<a name='6256'></font>
<a name='6257'>
    ktf = MIN( kte, kde-1 )<a name='6258'>
<a name='6259'>
    IF ( name .EQ. 'u' ) THEN<a name='6260'>
<a name='6261'>
      i_start = its<a name='6262'>
      i_end   = ite<a name='6263'>
      j_start = jts<a name='6264'>
      j_end   = MIN(jde-1,jte)<a name='6265'>
      k_start = kts<a name='6266'>
      k_end   = ktf<a name='6267'>
<a name='6268'>
    ELSE IF ( name .EQ. 'v' ) THEN<a name='6269'>
 <a name='6270'>
      i_start = its<a name='6271'>
      i_end   = MIN(ide-1,ite)<a name='6272'>
      j_start = jts<a name='6273'>
      j_end   = jte<a name='6274'>
      k_start = kts<a name='6275'>
      k_end   = ktf<a name='6276'>
 <a name='6277'>
    ELSE IF ( name .EQ. 'w' ) THEN<a name='6278'>
<a name='6279'>
      i_start = its<a name='6280'>
      i_end   = MIN(ide-1,ite)<a name='6281'>
      j_start = jts<a name='6282'>
      j_end   = MIN(jde-1,jte)<a name='6283'>
      k_start = kts+1<a name='6284'>
      k_end   = ktf<a name='6285'>
<a name='6286'>
    ELSE<a name='6287'>
<a name='6288'>
      i_start = its<a name='6289'>
      i_end   = MIN(ide-1,ite)<a name='6290'>
      j_start = jts<a name='6291'>
      j_end   = MIN(jde-1,jte)<a name='6292'>
      k_start = kts<a name='6293'>
      k_end   = ktf<a name='6294'>
 <a name='6295'>
    ENDIF<a name='6296'>
<a name='6297'>
<font color=#447700>! End: Assignment of limits of spatial loops.<a name='6298'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='6299'></font>
<a name='6300'>
<font color=#447700>!------------------------------------------------------------------------------<a name='6301'></font>
<font color=#447700>! Begin: Loop across spatial dimensions.<a name='6302'></font>
<a name='6303'>
    DO j = j_start, j_end<a name='6304'>
    DO k = k_start, k_end<a name='6305'>
    DO i = i_start, i_end<a name='6306'>
<a name='6307'>
<font color=#447700>!------------------------------------------------------------------------------<a name='6308'></font>
<font color=#447700>! Begin: Diffusion in x (i index).<a name='6309'></font>
 <a name='6310'>
<font color=#447700>! Calculate the diffusive flux in x direction (from Xue's eq. 3).<a name='6311'></font>
 <a name='6312'>
      dflux_x_p0 = (  10.0 * ( field(i,  k,j) - field(i-1,k,j) )    &amp;<a name='6313'>
                     - 5.0 * ( field(i+1,k,j) - field(i-2,k,j) )    &amp;<a name='6314'>
                     +       ( field(i+2,k,j) - field(i-3,k,j) ) )<a name='6315'>
 <a name='6316'>
      dflux_x_p1 = (  10.0 * ( field(i+1,k,j) - field(i  ,k,j) )    &amp;<a name='6317'>
                     - 5.0 * ( field(i+2,k,j) - field(i-1,k,j) )    &amp;<a name='6318'>
                     +       ( field(i+3,k,j) - field(i-2,k,j) ) )<a name='6319'>
 <a name='6320'>
<font color=#447700>! If requested in the namelist (diff_6th_opt=2), prohibit up-gradient diffusion<a name='6321'></font>
<font color=#447700>! (variation on Xue's eq. 10).<a name='6322'></font>
<a name='6323'>
      IF ( diff_6th_opt .EQ. 2 ) THEN<a name='6324'>
 <a name='6325'>
        IF ( dflux_x_p0 * ( field(i  ,k,j)-field(i-1,k,j) ) .LE. 0.0 ) THEN<a name='6326'>
          dflux_x_p0 = 0.0<a name='6327'>
        END IF<a name='6328'>
 <a name='6329'>
        IF ( dflux_x_p1 * ( field(i+1,k,j)-field(i  ,k,j) ) .LE. 0.0 ) THEN<a name='6330'>
          dflux_x_p1 = 0.0<a name='6331'>
        END IF<a name='6332'>
<a name='6333'>
      END IF<a name='6334'>
<a name='6335'>
<font color=#447700>! Apply 6th-order diffusion in x direction.<a name='6336'></font>
 <a name='6337'>
      IF      ( name .EQ. 'u' ) THEN<a name='6338'>
        mu_avg_p0 = MUT(i-1,j)<a name='6339'>
        mu_avg_p1 = MUT(i  ,j)<a name='6340'>
      ELSE IF ( name .EQ. 'v' ) THEN<a name='6341'>
        mu_avg_p0 = 0.25 * (       &amp;<a name='6342'>
                    MUT(i-1,j-1) +  &amp;<a name='6343'>
                    MUT(i  ,j-1) +  &amp;<a name='6344'>
                    MUT(i-1,j  ) +  &amp;<a name='6345'>
                    MUT(i  ,j  ) )<a name='6346'>
        mu_avg_p1 = 0.25 * (       &amp;<a name='6347'>
                    MUT(i  ,j-1) +  &amp;<a name='6348'>
                    MUT(i+1,j-1) +  &amp;<a name='6349'>
                    MUT(i  ,j  ) +  &amp;<a name='6350'>
                    MUT(i+1,j  ) )<a name='6351'>
      ELSE<a name='6352'>
        mu_avg_p0 = 0.5 * (        &amp;<a name='6353'>
                    MUT(i-1,j) +    &amp;<a name='6354'>
                    MUT(i  ,j) )<a name='6355'>
        mu_avg_p1 = 0.5 * (        &amp;<a name='6356'>
                    MUT(i  ,j) +    &amp;<a name='6357'>
                    MUT(i+1,j) )<a name='6358'>
      END IF<a name='6359'>
 <a name='6360'>
      tendency_x = diff_6th_coef *  &amp;<a name='6361'>
                 ( ( mu_avg_p1 * dflux_x_p1 ) - ( mu_avg_p0 * dflux_x_p0 ) )<a name='6362'>
 <a name='6363'>
<font color=#447700>! End: Diffusion in x.<a name='6364'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='6365'></font>
 <a name='6366'>
<font color=#447700>!------------------------------------------------------------------------------<a name='6367'></font>
<font color=#447700>! Begin: Diffusion in y (j index).<a name='6368'></font>
 <a name='6369'>
<font color=#447700>! Calculate the diffusive flux in y direction (from Xue's eq. 3).<a name='6370'></font>
 <a name='6371'>
      dflux_y_p0 = (  10.0 * ( field(i,k,j  ) - field(i,k,j-1) )    &amp;<a name='6372'>
                     - 5.0 * ( field(i,k,j+1) - field(i,k,j-2) )    &amp;<a name='6373'>
                     +       ( field(i,k,j+2) - field(i,k,j-3) ) )<a name='6374'>
 <a name='6375'>
      dflux_y_p1 = (  10.0 * ( field(i,k,j+1) - field(i,k,j  ) )    &amp;<a name='6376'>
                     - 5.0 * ( field(i,k,j+2) - field(i,k,j-1) )    &amp;<a name='6377'>
                     +       ( field(i,k,j+3) - field(i,k,j-2) ) )<a name='6378'>
 <a name='6379'>
<font color=#447700>! If requested in the namelist (diff_6th_opt=2), prohibit up-gradient diffusion<a name='6380'></font>
<font color=#447700>! (variation on Xue's eq. 10).<a name='6381'></font>
<a name='6382'>
      IF ( diff_6th_opt .EQ. 2 ) THEN<a name='6383'>
 <a name='6384'>
        IF ( dflux_y_p0 * ( field(i,k,j  )-field(i,k,j-1) ) .LE. 0.0 ) THEN<a name='6385'>
          dflux_y_p0 = 0.0<a name='6386'>
        END IF<a name='6387'>
 <a name='6388'>
        IF ( dflux_y_p1 * ( field(i,k,j+1)-field(i,k,j  ) ) .LE. 0.0 ) THEN<a name='6389'>
          dflux_y_p1 = 0.0<a name='6390'>
        END IF<a name='6391'>
<a name='6392'>
      END IF<a name='6393'>
 <a name='6394'>
<font color=#447700>! Apply 6th-order diffusion in y direction.<a name='6395'></font>
 <a name='6396'>
      IF      ( name .EQ. 'u' ) THEN<a name='6397'>
        mu_avg_p0 = 0.25 * (       &amp;<a name='6398'>
                    MUT(i-1,j-1) +  &amp;<a name='6399'>
                    MUT(i  ,j-1) +  &amp;<a name='6400'>
                    MUT(i-1,j  ) +  &amp;<a name='6401'>
                    MUT(i  ,j  ) )<a name='6402'>
        mu_avg_p1 = 0.25 * (       &amp;<a name='6403'>
                    MUT(i-1,j  ) +  &amp;<a name='6404'>
                    MUT(i  ,j  ) +  &amp;<a name='6405'>
                    MUT(i-1,j+1) +  &amp;<a name='6406'>
                    MUT(i  ,j+1) )<a name='6407'>
      ELSE IF ( name .EQ. 'v' ) THEN<a name='6408'>
        mu_avg_p0 = MUT(i,j-1)<a name='6409'>
        mu_avg_p1 = MUT(i,j  )<a name='6410'>
      ELSE<a name='6411'>
        mu_avg_p0 = 0.5 * (      &amp;<a name='6412'>
                    MUT(i,j-1) +  &amp;<a name='6413'>
                    MUT(i,j  ) )<a name='6414'>
        mu_avg_p1 = 0.5 * (      &amp;<a name='6415'>
                    MUT(i,j  ) +  &amp;<a name='6416'>
                    MUT(i,j+1) )<a name='6417'>
      END IF<a name='6418'>
 <a name='6419'>
      tendency_y = diff_6th_coef *  &amp;<a name='6420'>
                 ( ( mu_avg_p1 * dflux_y_p1 ) - ( mu_avg_p0 * dflux_y_p0 ) )<a name='6421'>
 <a name='6422'>
<font color=#447700>! End: Diffusion in y.<a name='6423'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='6424'></font>
 <a name='6425'>
<font color=#447700>!------------------------------------------------------------------------------<a name='6426'></font>
<font color=#447700>! Begin: Combine diffusion in x and y.<a name='6427'></font>
     <a name='6428'>
      tendency(i,k,j) = tendency(i,k,j) + tendency_x + tendency_y<a name='6429'>
 <a name='6430'>
<font color=#447700>! End: Combine diffusion in x and y.<a name='6431'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='6432'></font>
<a name='6433'>
    ENDDO<a name='6434'>
    ENDDO<a name='6435'>
    ENDDO<a name='6436'>
<a name='6437'>
<font color=#447700>! End: Loop across spatial dimensions.<a name='6438'></font>
<font color=#447700>!------------------------------------------------------------------------------<a name='6439'></font>
 <a name='6440'>
    END SUBROUTINE sixth_order_diffusion<a name='6441'>
<a name='6442'>
<font color=#447700>!==============================================================================<a name='6443'></font>
<a name='6444'>
<A NAME='INITIALIZE_MOIST_OLD'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#INITIALIZE_MOIST_OLD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6445'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>initialize_moist_old</font> ( moist_old , moist , &amp; <A href='../../call_to/INITIALIZE_MOIST_OLD.html' TARGET='index'>1</A><a name='6446'>
                                  ids, ide, jds, jde, kds, kde ,   &amp;<a name='6447'>
                                  ims, ime, jms, jme, kms, kme ,   &amp;<a name='6448'>
                                  its, ite, jts, jte, kts, kte     )<a name='6449'>
<a name='6450'>
   <font color=#447700>!  For the theta_m option, the moist_old variable is uninitialized<a name='6451'></font>
   <font color=#447700>!  at the beginning of EACH of the RK steps.  So, just set the <a name='6452'></font>
   <font color=#447700>!  starting value of moist_old as the final value of moist from the<a name='6453'></font>
   <font color=#447700>!  previous time step.  Here "moist" is only the P_Qv index.<a name='6454'></font>
<a name='6455'>
   IMPLICIT NONE<a name='6456'>
<a name='6457'>
   INTEGER , INTENT(IN) ::   ids, ide, jds, jde, kds, kde ,   &amp;<a name='6458'>
                             ims, ime, jms, jme, kms, kme ,   &amp;<a name='6459'>
                             its, ite, jts, jte, kts, kte     <a name='6460'>
   REAL    , INTENT(IN   ) , DIMENSION(ims:ime,kms:kme,jms:jme) :: moist<a name='6461'>
   REAL    , INTENT(  OUT) , DIMENSION(ims:ime,kms:kme,jms:jme) :: moist_old<a name='6462'>
<a name='6463'>
   <font color=#447700>!  Local variables<a name='6464'></font>
<a name='6465'>
   INTEGER :: i , j , k<a name='6466'>
<a name='6467'>
   DO j = jts , MIN(jte,jde-1)<a name='6468'>
      DO k = kts , kte-1<a name='6469'>
         DO i = its , MIN(ite,ide-1)<a name='6470'>
            moist_old(i,k,j) = moist(i,k,j)<a name='6471'>
         END DO<a name='6472'>
      END DO<a name='6473'>
   END DO<a name='6474'>
<a name='6475'>
END SUBROUTINE initialize_moist_old<a name='6476'>
<a name='6477'>
<font color=#447700>!==============================================================================<a name='6478'></font>
<a name='6479'>
<A NAME='THETA_TO_THETAM'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#THETA_TO_THETAM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6480'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>theta_to_thetam</font> ( t_1 , moist_old ,                &amp; <A href='../../call_to/THETA_TO_THETAM.html' TARGET='index'>1</A><a name='6481'>
                             t_tendf  , moist_tend ,          &amp;<a name='6482'>
                             t_2 , moist ,                    &amp;<a name='6483'>
                             h_diabatic ,                     &amp;<a name='6484'>
                             itimestep ,                      &amp;<a name='6485'>
                             rk_step ,                        &amp; <a name='6486'>
                             ids, ide, jds, jde, kds, kde ,   &amp;<a name='6487'>
                             ims, ime, jms, jme, kms, kme ,   &amp;<a name='6488'>
                             its, ite, jts, jte, kts, kte     )<a name='6489'>
<a name='6490'>
   <font color=#447700>!  Convert dry potential temperature to "moist" theta:<a name='6491'></font>
   <font color=#447700>!  theta_m = theta ( 1 + Rv/Rd Qv )<a name='6492'></font>
<a name='6493'>
   IMPLICIT NONE<a name='6494'>
<a name='6495'>
   INTEGER , INTENT(IN) ::   ids, ide, jds, jde, kds, kde ,   &amp;<a name='6496'>
                             ims, ime, jms, jme, kms, kme ,   &amp;<a name='6497'>
                             its, ite, jts, jte, kts, kte     <a name='6498'>
   INTEGER , INTENT(IN) ::   rk_step, itimestep<a name='6499'>
   REAL    , INTENT(IN   ) , DIMENSION(ims:ime,kms:kme,jms:jme) :: moist, moist_tend<a name='6500'>
   REAL    , INTENT(INOUT) , DIMENSION(ims:ime,kms:kme,jms:jme) :: moist_old<a name='6501'>
   REAL    , INTENT(INOUT) , DIMENSION(ims:ime,kms:kme,jms:jme) :: t_1, t_tendf, t_2, h_diabatic<a name='6502'>
<a name='6503'>
   <font color=#447700>!  Local variables<a name='6504'></font>
<a name='6505'>
   INTEGER :: i , j , k<a name='6506'>
<a name='6507'>
   <font color=#447700>!  First RK loop, this info is from the physics packages.  It is modified immediately after the<a name='6508'></font>
   <font color=#447700>!  call to the physics schemes, and the remains constant for the remainder of the RK loops.<a name='6509'></font>
<a name='6510'>
   IF ( rk_step .EQ. 1 ) THEN<a name='6511'>
      DO j = jts , MIN(jte,jde-1)<a name='6512'>
         DO k = kts , kte-1<a name='6513'>
            DO i = its , MIN(ite,ide-1)<a name='6514'>
               t_tendf(i,k,j) = (1. + (R_v/R_d) * moist_old(i,k,j))*t_tendf(i,k,j) + (R_v/R_d)*(t_1(i,k,j)+T0)*moist_tend(i,k,j)<a name='6515'>
               h_diabatic(i,k,j) =  (1. + (R_v/R_d) * moist_old(i,k,j))*h_diabatic(i,k,j)<a name='6516'>
            END DO<a name='6517'>
         END DO<a name='6518'>
      END DO<a name='6519'>
   END IF<a name='6520'>
<a name='6521'>
   <font color=#447700>!  T at time period 1 and 2 are modified in the small steps, so they are each converted from dry to moist.<a name='6522'></font>
<a name='6523'>
   DO j = jts , MIN(jte,jde-1)<a name='6524'>
      DO k = kts , kte-1<a name='6525'>
         DO i = its , MIN(ite,ide-1)<a name='6526'>
            t_1(i,k,j) = ( t_1(i,k,j) + T0 ) * (1. + (R_v/R_d) * moist_old(i,k,j)) - T0<a name='6527'>
            t_2(i,k,j) = ( t_2(i,k,j) + T0 ) * (1. + (R_v/R_d) * moist(i,k,j))     - T0<a name='6528'>
         END DO<a name='6529'>
      END DO<a name='6530'>
   END DO<a name='6531'>
<a name='6532'>
END SUBROUTINE theta_to_thetam<a name='6533'>
<a name='6534'>
<font color=#447700>!==============================================================================<a name='6535'></font>
<a name='6536'>
<A NAME='THETAM_TO_THETA'><A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#THETAM_TO_THETA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6537'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>thetam_to_theta</font> ( t_1 , moist_old ,                &amp; <A href='../../call_to/THETAM_TO_THETA.html' TARGET='index'>1</A><a name='6538'>
                             t_2 , moist ,                    &amp;<a name='6539'>
                             ids, ide, jds, jde, kds, kde ,   &amp;<a name='6540'>
                             ims, ime, jms, jme, kms, kme ,   &amp;<a name='6541'>
                             its, ite, jts, jte, kts, kte     )<a name='6542'>
<a name='6543'>
   <font color=#447700>!  Convert moist potential temperature to dry theta:<a name='6544'></font>
   <font color=#447700>!  theta = theta_m / ( 1 + Rv/Rd Qv )<a name='6545'></font>
<a name='6546'>
   IMPLICIT NONE<a name='6547'>
<a name='6548'>
   INTEGER , INTENT(IN) ::   ids, ide, jds, jde, kds, kde ,   &amp;<a name='6549'>
                             ims, ime, jms, jme, kms, kme ,   &amp;<a name='6550'>
                             its, ite, jts, jte, kts, kte     <a name='6551'>
   REAL    , INTENT(IN   ) , DIMENSION(ims:ime,kms:kme,jms:jme) :: moist, moist_old<a name='6552'>
   REAL    , INTENT(INOUT) , DIMENSION(ims:ime,kms:kme,jms:jme) :: t_1, t_2<a name='6553'>
<a name='6554'>
   <font color=#447700>!  Local variables<a name='6555'></font>
<a name='6556'>
   INTEGER :: i , j , k<a name='6557'>
<a name='6558'>
   DO j = jts , MIN(jte,jde-1)<a name='6559'>
      DO k = kts , kte-1<a name='6560'>
         DO i = its , MIN(ite,ide-1)<a name='6561'>
            t_1(i,k,j) = -T0 + (t_1(i,k,j)+T0)/(1. + (R_v/R_d) * moist_old(i,k,j))<a name='6562'>
            t_2(i,k,j) = -T0 + (t_2(i,k,j)+T0)/(1. + (R_v/R_d) * moist(i,k,j))<a name='6563'>
         END DO<a name='6564'>
      END DO<a name='6565'>
   END DO<a name='6566'>
<a name='6567'>
END SUBROUTINE thetam_to_theta<a name='6568'>
<a name='6569'>
<font color=#447700>!==============================================================================<a name='6570'></font>
<a name='6571'>
END MODULE module_big_step_utilities_em<a name='6572'>
</pre></body></html>