<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( HYBRID_COORD==1 ) <a name='2'>
#  define mu(...) (c1h(k)*XXPCXX(__VA_ARGS__))<a name='3'>
#  define XXPCXX(...) mu(__VA_ARGS__)<a name='4'>
<a name='5'>
#  define mut(...) (c1f(k)*XXPCTFXX(__VA_ARGS__)+c2f(k))<a name='6'>
#  define XXPCTFXX(...) mut(__VA_ARGS__)<a name='7'>
<a name='8'>
#  define Mut(...) (c1h(k)*XXPCTHXX(__VA_ARGS__)+c2h(k))<a name='9'>
#  define XXPCTHXX(...) Mut(__VA_ARGS__)<a name='10'>
<a name='11'>
#  define muu(...) (c1h(k)*XXPCUXX(__VA_ARGS__)+c2h(k))<a name='12'>
#  define XXPCUXX(...) muu(__VA_ARGS__)<a name='13'>
<a name='14'>
#  define muv(...) (c1h(k)*XXPCVXX(__VA_ARGS__)+c2h(k))<a name='15'>
#  define XXPCVXX(...) muv(__VA_ARGS__)<a name='16'>
<a name='17'>
#  define muave(...) (c1f(k)*XXPCAVEFXX(__VA_ARGS__))<a name='18'>
#  define XXPCAVEFXX(...) muave(__VA_ARGS__)<a name='19'>
<a name='20'>
#  define Muave(...) (c1h(k)*XXPCAVEHXX(__VA_ARGS__))<a name='21'>
#  define XXPCAVEHXX(...) Muave(__VA_ARGS__)<a name='22'>
<a name='23'>
#  define muus(...) (c1h(k)*XXPCUSXX(__VA_ARGS__)+c2h(k))<a name='24'>
#  define XXPCUSXX(...) muus(__VA_ARGS__)<a name='25'>
<a name='26'>
#  define muvs(...) (c1h(k)*XXPCVSXX(__VA_ARGS__)+c2h(k))<a name='27'>
#  define XXPCVSXX(...) muvs(__VA_ARGS__)<a name='28'>
<a name='29'>
#  define mu_tend(...) (c1h(k)*XXPCTENDXX(__VA_ARGS__))<a name='30'>
#  define XXPCTENDXX(...) mu_tend(__VA_ARGS__)<a name='31'>
<a name='32'>
#  define dmdt(...) (c1h(k)*XXDMDTXX(__VA_ARGS__))<a name='33'>
#  define XXDMDTXX(...) dmdt(__VA_ARGS__)<a name='34'>
<a name='35'>
#  define muts(...) (c1f(k)*XXPCTFSXX(__VA_ARGS__)+c2f(k))<a name='36'>
#  define XXPCTFSXX(...) muts(__VA_ARGS__)<a name='37'>
<a name='38'>
#  define Muts(...) (c1h(k)*XXPCTHSXX(__VA_ARGS__)+c2h(k))<a name='39'>
#  define XXPCTHSXX(...) Muts(__VA_ARGS__)<a name='40'>
<a name='41'>
#  define mudf_xy(...) (c1h(k)*XXMUDFXYXX(__VA_ARGS__))<a name='42'>
#  define XXMUDFXYXX(...) mudf_xy(__VA_ARGS__)<a name='43'>
<a name='44'>
#  define MUTHK         (c1h(k)*MUT(i,j)+c2h(k))<a name='45'>
<a name='46'>
#  define MUTHKM1       (c1h(k-1)*MUT(i,j)+c2h(k-1))<a name='47'>
<a name='48'>
#  define MUTHMUTF_KK   ((c1h(k)*MUT(i,j)+c2h(k))*(c1f(k)*MUT(i,j)+c2f(k)))<a name='49'>
<a name='50'>
#  define MUTHMUTF_KM1K ((c1h(k-1)*MUT(i,j)+c2h(k-1))*(c1f(k)*MUT(i,j)+c2f(k)))<a name='51'>
<a name='52'>
#  define MUTHMUTF_KKP1 ((c1h(k)*MUT(i,j)+c2h(k))*(c1f(k+1)*MUT(i,j)+c2f(k+1)))<a name='53'>
#endif<a name='54'>
<a name='55'>
<font color=#447700>!WRF:MODEL_LAYER:DYNAMICS<a name='56'></font>
<font color=#447700>!<a name='57'></font>
<a name='58'>
<font color=#447700>!  SMALL_STEP code for the geometric height coordinate model<a name='59'></font>
<font color=#447700>!<a name='60'></font>
<font color=#447700>!---------------------------------------------------------------------------<a name='61'></font>
<a name='62'>
<A NAME='MODULE_SMALL_STEP_EM'><A href='../../html_code/dyn_em/module_small_step_em.F.html#MODULE_SMALL_STEP_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='63'>
<font color=#993300>MODULE </font><font color=#cc0000>module_small_step_em</font> <A href='../../call_to/MODULE_SMALL_STEP_EM.html' TARGET='index'>1</A><a name='64'>
<a name='65'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_small_step_em.F.html#module_small_step_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_13"><a name='66'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_small_step_em.F.html#module_small_step_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_12"><a name='67'>
<a name='68'>
CONTAINS<a name='69'>
<a name='70'>
<font color=#447700>!----------------------------------------------------------------------<a name='71'></font>
<a name='72'>
<A NAME='SMALL_STEP_PREP'><A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='73'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>small_step_prep</font>( u_1, u_2, v_1, v_2, w_1, w_2, &amp; <A href='../../call_to/SMALL_STEP_PREP.html' TARGET='index'>1</A><a name='74'>
                            t_1, t_2, ph_1, ph_2,         &amp;<a name='75'>
                            mub, mu_1, mu_2,              &amp;<a name='76'>
                            muu, muus, muv, muvs,         &amp;<a name='77'>
                            mut, muts, mudf,              &amp;<a name='78'>
                            c1h, c2h, c1f, c2f,           &amp;<a name='79'>
                            c3h, c4h, c3f, c4f,           &amp;<a name='80'>
                            u_save, v_save, w_save,       &amp;<a name='81'>
                            t_save, ph_save, mu_save,     &amp;<a name='82'>
                            ww, ww_save,                  &amp;<a name='83'>
                            c2a, pb, p, alt,              &amp;<a name='84'>
                            msfux, msfuy, msfvx,          &amp;<a name='85'>
                            msfvx_inv,                    &amp;<a name='86'>
                            msfvy, msftx, msfty,          &amp;<a name='87'>
                            rdx, rdy,                     &amp;<a name='88'>
                            rk_step,                      &amp;<a name='89'>
                            ids,ide, jds,jde, kds,kde,    &amp; <a name='90'>
                            ims,ime, jms,jme, kms,kme,    &amp;<a name='91'>
                            its,ite, jts,jte, kts,kte    )<a name='92'>
<a name='93'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='94'></font>
<a name='95'>
<font color=#447700>! declarations for the stuff coming in<a name='96'></font>
<a name='97'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='98'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='99'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='100'>
<a name='101'>
  INTEGER,      INTENT(IN   )    :: rk_step<a name='102'>
<a name='103'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: u_1,   &amp;<a name='104'>
                                                              v_1,   &amp;<a name='105'>
                                                              w_1,   &amp;<a name='106'>
                                                              t_1,   &amp;<a name='107'>
                                                              ph_1<a name='108'>
<a name='109'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(  OUT) :: u_save,   &amp;<a name='110'>
                                                              v_save,   &amp;<a name='111'>
                                                              w_save,   &amp;<a name='112'>
                                                              t_save,   &amp;<a name='113'>
                                                              ph_save<a name='114'>
<a name='115'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: u_2,   &amp;<a name='116'>
                                                              v_2,   &amp;<a name='117'>
                                                              w_2,   &amp;<a name='118'>
                                                              t_2,   &amp;<a name='119'>
                                                              ph_2<a name='120'>
<a name='121'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(  OUT) :: c2a, &amp;<a name='122'>
                                                               ww_save<a name='123'>
<a name='124'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN   ) ::  pb,  &amp;<a name='125'>
                                                                p,   &amp;<a name='126'>
                                                                alt, &amp;<a name='127'>
                                                                ww<a name='128'>
<a name='129'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(INOUT) :: mu_1,mu_2<a name='130'>
<a name='131'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(IN   ) :: mub,  &amp;<a name='132'>
                                                               muu,  &amp;<a name='133'>
                                                               muv,  &amp;<a name='134'>
                                                               mut,  &amp;<a name='135'>
                                                               msfux,&amp;<a name='136'>
                                                               msfuy,&amp;<a name='137'>
                                                               msfvx,&amp;<a name='138'>
                                                               msfvx_inv,&amp;<a name='139'>
                                                               msfvy,&amp;<a name='140'>
                                                               msftx,&amp;<a name='141'>
                                                               msfty<a name='142'>
<a name='143'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(  OUT) :: muus, &amp;<a name='144'>
                                                               muvs, &amp;<a name='145'>
                                                               muts, &amp;<a name='146'>
                                                               mudf<a name='147'>
<a name='148'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(  OUT) :: mu_save<a name='149'>
<a name='150'>
  REAL, INTENT(IN) :: rdx,rdy<a name='151'>
<a name='152'>
  REAL, DIMENSION( kms:kme ),INTENT(IN   ) :: c1h, c2h, c1f, c2f, &amp;<a name='153'>
                                              c3h, c4h, c3f, c4f<a name='154'>
<a name='155'>
<font color=#447700>! local variables<a name='156'></font>
<a name='157'>
  INTEGER :: i, j, k<a name='158'>
  INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='159'>
  INTEGER :: i_endu, j_endv<a name='160'>
<a name='161'>
<a name='162'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='163'></font>
<font color=#447700>!<a name='164'></font>
<font color=#447700>!  small_step_prep prepares the prognostic variables for the small timestep.<a name='165'></font>
<font color=#447700>!  This includes switching time-levels in the arrays and computing coupled <a name='166'></font>
<font color=#447700>!  perturbation variables for the small timestep <a name='167'></font>
<font color=#447700>!  (i.e. mu*u" = mu(t)*u(t)-mu(*)*u(*); mu*u" is advanced during the small <a name='168'></font>
<font color=#447700>!  timesteps<a name='169'></font>
<font color=#447700>!<a name='170'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='171'></font>
<a name='172'>
    i_start = its<a name='173'>
    i_end   = min(ite,ide-1)<a name='174'>
    j_start = jts<a name='175'>
    j_end   = min(jte,jde-1)<a name='176'>
    k_start = kts<a name='177'>
    k_end = min(kte,kde-1)<a name='178'>
<a name='179'>
    i_endu = ite<a name='180'>
    j_endv = jte<a name='181'>
<a name='182'>
    <font color=#447700>!  if this is the first RK step, reset *_1 to *_2<a name='183'></font>
    <font color=#447700>!  (we are replacing the t-dt fields with the time t fields)<a name='184'></font>
<a name='185'>
    IF ((rk_step == 1) ) THEN<a name='186'>
<a name='187'>
      DO j=j_start, j_end<a name='188'>
      DO i=i_start, i_end<a name='189'>
        MU_1(i,j)=MU_2(i,j)<a name='190'>
        ww_save(i,kde,j) = 0.<a name='191'>
        ww_save(i,1,j) = 0.<a name='192'>
        MUDF(i,j) = 0.  <font color=#447700>!  initialize external mode div damp to zero<a name='193'></font>
      ENDDO<a name='194'>
      ENDDO<a name='195'>
<a name='196'>
      DO j=j_start, j_end<a name='197'>
      DO k=k_start, k_end<a name='198'>
      DO i=i_start, i_endu<a name='199'>
        u_1(i,k,j) = u_2(i,k,j)<a name='200'>
      ENDDO<a name='201'>
      ENDDO<a name='202'>
      ENDDO<a name='203'>
<a name='204'>
      DO j=j_start, j_endv<a name='205'>
      DO k=k_start, k_end<a name='206'>
      DO i=i_start, i_end<a name='207'>
        v_1(i,k,j) = v_2(i,k,j)<a name='208'>
      ENDDO<a name='209'>
      ENDDO<a name='210'>
      ENDDO<a name='211'>
<a name='212'>
      DO j=j_start, j_end<a name='213'>
      DO k=k_start, k_end<a name='214'>
      DO i=i_start, i_end<a name='215'>
        t_1(i,k,j) = t_2(i,k,j)<a name='216'>
      ENDDO<a name='217'>
      ENDDO<a name='218'>
      ENDDO<a name='219'>
<a name='220'>
      DO j=j_start, j_end<a name='221'>
      DO k=k_start, min(kde,kte)<a name='222'>
      DO i=i_start, i_end<a name='223'>
        w_1(i,k,j)  = w_2(i,k,j)<a name='224'>
        ph_1(i,k,j) = ph_2(i,k,j)<a name='225'>
      ENDDO<a name='226'>
      ENDDO<a name='227'>
      ENDDO<a name='228'>
<a name='229'>
    DO j=j_start, j_end<a name='230'>
      DO i=i_start, i_end<a name='231'>
        MUTS(i,j)=MUB(i,j)+MU_2(i,j)<a name='232'>
      ENDDO<a name='233'>
      DO i=i_start, i_endu<a name='234'>
        MUUS(i,j) = MUU(i,j)<a name='235'>
      ENDDO<a name='236'>
    ENDDO<a name='237'>
<a name='238'>
    DO j=j_start, j_endv<a name='239'>
    DO i=i_start, i_end<a name='240'>
        MUVS(i,j) = MUV(i,j)<a name='241'>
    ENDDO<a name='242'>
    ENDDO<a name='243'>
<a name='244'>
    DO j=j_start, j_end<a name='245'>
      DO i=i_start, i_end<a name='246'>
        MU_SAVE(i,j)=MU_2(i,j)<a name='247'>
        MU_2(i,j)=0.<a name='248'>
      ENDDO<a name='249'>
    ENDDO<a name='250'>
<a name='251'>
    ELSE<a name='252'>
<a name='253'>
    DO j=j_start, j_end<a name='254'>
      DO i=i_start, i_end<a name='255'>
        MUTS(i,j)=MUB(i,j)+MU_1(i,j)<a name='256'>
      ENDDO<a name='257'>
      DO i=i_start, i_endu<a name='258'>
        MUUS(i,j)=0.5*(MUB(i,j)+MU_1(i,j)+MUB(i-1,j)+MU_1(i-1,j))<a name='259'>
      ENDDO<a name='260'>
    ENDDO<a name='261'>
<a name='262'>
    DO j=j_start, j_endv<a name='263'>
    DO i=i_start, i_end<a name='264'>
      MUVS(i,j)=0.5*(MUB(i,j)+MU_1(i,j)+MUB(i,j-1)+MU_1(i,j-1))<a name='265'>
    ENDDO<a name='266'>
    ENDDO<a name='267'>
<a name='268'>
    DO j=j_start, j_end<a name='269'>
      DO i=i_start, i_end<a name='270'>
        MU_SAVE(i,j)=MU_2(i,j)<a name='271'>
        MU_2(i,j)=MU_1(i,j)-MU_2(i,j)<a name='272'>
      ENDDO<a name='273'>
    ENDDO<a name='274'>
<a name='275'>
<a name='276'>
    END IF<a name='277'>
<a name='278'>
    <font color=#447700>! set up the small timestep variables<a name='279'></font>
<a name='280'>
      DO j=j_start, j_end<a name='281'>
      DO i=i_start, i_end<a name='282'>
        ww_save(i,kde,j) = 0.<a name='283'>
        ww_save(i,1,j) = 0.<a name='284'>
      ENDDO<a name='285'>
      ENDDO<a name='286'>
<a name='287'>
    DO j=j_start, j_end<a name='288'>
    DO k=k_start, k_end<a name='289'>
    DO i=i_start, i_end<a name='290'>
      c2a(i,k,j) = cpovcv*(pb(i,k,j)+p(i,k,j))/alt(i,k,j)<a name='291'>
    ENDDO<a name='292'>
    ENDDO<a name='293'>
    ENDDO<a name='294'>
<a name='295'>
    DO j=j_start, j_end<a name='296'>
    DO k=k_start, k_end<a name='297'>
    DO i=i_start, i_endu<a name='298'>
      u_save(i,k,j) = u_2(i,k,j)<a name='299'>
      <font color=#447700>! u coupled with my<a name='300'></font>
      u_2(i,k,j) = (muus(i,j)*u_1(i,k,j)-muu(i,j)*u_2(i,k,j))/msfuy(i,j)<a name='301'>
    ENDDO<a name='302'>
    ENDDO<a name='303'>
    ENDDO<a name='304'>
<a name='305'>
    DO j=j_start, j_endv<a name='306'>
    DO k=k_start, k_end<a name='307'>
    DO i=i_start, i_end<a name='308'>
      v_save(i,k,j) = v_2(i,k,j)<a name='309'>
      <font color=#447700>! v coupled with mx<a name='310'></font>
<font color=#447700>!      v_2(i,k,j) = (muvs(i,j)*v_1(i,k,j)-muv(i,j)*v_2(i,k,j))/msfvx(i,j)<a name='311'></font>
      v_2(i,k,j) = (muvs(i,j)*v_1(i,k,j)-muv(i,j)*v_2(i,k,j))*msfvx_inv(i,j)<a name='312'>
    ENDDO<a name='313'>
    ENDDO<a name='314'>
    ENDDO<a name='315'>
<a name='316'>
    DO j=j_start, j_end<a name='317'>
    DO k=k_start, k_end<a name='318'>
    DO i=i_start, i_end<a name='319'>
      t_save(i,k,j) = t_2(i,k,j)<a name='320'>
      t_2(i,k,j) = muts(i,j)*t_1(i,k,j)-mut(i,j)*t_2(i,k,j)<a name='321'>
    ENDDO<a name='322'>
    ENDDO<a name='323'>
    ENDDO<a name='324'>
<a name='325'>
    DO j=j_start, j_end<a name='326'>
<font color=#447700>!    DO k=k_start, min(kde,kte)<a name='327'></font>
    DO k=k_start, kde<a name='328'>
    DO i=i_start, i_end<a name='329'>
      w_save(i,k,j) = w_2(i,k,j)<a name='330'>
      <font color=#447700>! w coupled with my<a name='331'></font>
      w_2(i,k,j)  = (muts(i,j)* w_1(i,k,j)-mut(i,j)* w_2(i,k,j))/msfty(i,j)<a name='332'>
      ph_save(i,k,j) = ph_2(i,k,j)<a name='333'>
      ph_2(i,k,j) = ph_1(i,k,j)-ph_2(i,k,j)<a name='334'>
    ENDDO<a name='335'>
    ENDDO<a name='336'>
    ENDDO<a name='337'>
<a name='338'>
      DO j=j_start, j_end<a name='339'>
<font color=#447700>!      DO k=k_start, min(kde,kte)<a name='340'></font>
      DO k=k_start, kde<a name='341'>
      DO i=i_start, i_end<a name='342'>
        ww_save(i,k,j) = ww(i,k,j)<a name='343'>
      ENDDO<a name='344'>
      ENDDO<a name='345'>
      ENDDO<a name='346'>
<a name='347'>
END SUBROUTINE small_step_prep<a name='348'>
<a name='349'>
<font color=#447700>!-------------------------------------------------------------------------<a name='350'></font>
<a name='351'>
<a name='352'>
<A NAME='SMALL_STEP_FINISH'><A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_FINISH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='353'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>small_step_finish</font>( u_2, u_1, v_2, v_1, w_2, w_1,    &amp; <A href='../../call_to/SMALL_STEP_FINISH.html' TARGET='index'>1</A><a name='354'>
                              t_2, t_1, ph_2, ph_1, ww, ww1,   &amp;<a name='355'>
                              mu_2, mu_1,                      &amp;<a name='356'>
                              mut, muts, muu, muus, muv, muvs, &amp;<a name='357'>
                              c1h, c2h, c1f, c2f,              &amp;<a name='358'>
                              c3h, c4h, c3f, c4f,              &amp;<a name='359'>
                              u_save, v_save, w_save,          &amp;<a name='360'>
                              t_save, ph_save, mu_save,        &amp;<a name='361'>
                              msfux, msfuy, msfvx, msfvy,      &amp;<a name='362'>
                              msftx, msfty,                    &amp;<a name='363'>
                              h_diabatic,                      &amp;<a name='364'>
                              number_of_small_timesteps,dts,   &amp;<a name='365'>
                              rk_step, rk_order,               &amp;<a name='366'>
                              ids,ide, jds,jde, kds,kde,       &amp;<a name='367'>
                              ims,ime, jms,jme, kms,kme,       &amp;<a name='368'>
                              its,ite, jts,jte, kts,kte       )<a name='369'>
<a name='370'>
<a name='371'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='372'></font>
<a name='373'>
<font color=#447700>!  stuff passed in<a name='374'></font>
<a name='375'>
  INTEGER,                  INTENT(IN   ) :: ids,ide, jds,jde, kds,kde<a name='376'>
  INTEGER,                  INTENT(IN   ) :: ims,ime, jms,jme, kms,kme<a name='377'>
  INTEGER,                  INTENT(IN   ) :: its,ite, jts,jte, kts,kte<a name='378'>
  INTEGER,                  INTENT(IN   ) :: number_of_small_timesteps<a name='379'>
  INTEGER,                  INTENT(IN   ) :: rk_step, rk_order<a name='380'>
  REAL,                     INTENT(IN   ) :: dts<a name='381'>
<a name='382'>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN   ) :: u_1, &amp;<a name='383'>
                                                                 v_1, &amp;<a name='384'>
                                                                 w_1, &amp;<a name='385'>
                                                                 t_1, &amp;<a name='386'>
                                                                 ww1, &amp;<a name='387'>
                                                                 ph_1<a name='388'>
<a name='389'>
  REAL,   DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: u_2, &amp;<a name='390'>
                                                                 v_2, &amp;<a name='391'>
                                                                 w_2, &amp;<a name='392'>
                                                                 t_2, &amp;<a name='393'>
                                                                 ww,  &amp;<a name='394'>
                                                                 ph_2<a name='395'>
<a name='396'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(IN   ) :: u_save,   &amp;<a name='397'>
                                                              v_save,   &amp;<a name='398'>
                                                              w_save,   &amp;<a name='399'>
                                                              t_save,   &amp;<a name='400'>
                                                              ph_save,  &amp;<a name='401'>
                                                             h_diabatic<a name='402'>
<a name='403'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: muus, muvs<a name='404'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: mu_2, mu_1<a name='405'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(INOUT) :: mut, muts, &amp;<a name='406'>
                                                        muu, muv, mu_save<a name='407'>
  REAL,   DIMENSION(ims:ime, jms:jme), INTENT(IN   ) :: msfux, msfuy, &amp;<a name='408'>
                                                        msfvx, msfvy, &amp;<a name='409'>
                                                        msftx, msfty<a name='410'>
<a name='411'>
  REAL, DIMENSION( kms:kme ),INTENT(IN   ) :: c1h, c2h, c1f, c2f, &amp;<a name='412'>
                                              c3h, c4h, c3f, c4f<a name='413'>
<a name='414'>
<a name='415'>
<font color=#447700>! local stuff<a name='416'></font>
<a name='417'>
  INTEGER         :: i,j,k<a name='418'>
  INTEGER :: i_start, i_end, j_start, j_end, i_endu, j_endv<a name='419'>
<a name='420'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='421'></font>
<font color=#447700>!<a name='422'></font>
<font color=#447700>!  small_step_finish reconstructs the full uncoupled prognostic variables<a name='423'></font>
<font color=#447700>!  from the coupled perturbation variables used in the small timesteps.<a name='424'></font>
<font color=#447700>!<a name='425'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='426'></font>
<a name='427'>
  i_start = its<a name='428'>
  i_end   = min(ite,ide-1)<a name='429'>
  j_start = jts<a name='430'>
  j_end   = min(jte,jde-1)<a name='431'>
<a name='432'>
  i_endu = ite<a name='433'>
  j_endv = jte<a name='434'>
<a name='435'>
<font color=#447700>!    addition of time level t back into variables<a name='436'></font>
<a name='437'>
  DO j = j_start, j_endv<a name='438'>
  DO k = kds, kde-1<a name='439'>
  DO i = i_start, i_end<a name='440'>
    <font color=#447700>! v coupled with mx<a name='441'></font>
    v_2(i,k,j) = (msfvx(i,j)*v_2(i,k,j) + v_save(i,k,j)*muv(i,j))/muvs(i,j)<a name='442'>
  ENDDO<a name='443'>
  ENDDO<a name='444'>
  ENDDO<a name='445'>
<a name='446'>
  DO j = j_start, j_end<a name='447'>
  DO k = kds, kde-1<a name='448'>
  DO i = i_start, i_endu<a name='449'>
    <font color=#447700>! u coupled with my<a name='450'></font>
    u_2(i,k,j) = (msfuy(i,j)*u_2(i,k,j) + u_save(i,k,j)*muu(i,j))/muus(i,j)<a name='451'>
  ENDDO<a name='452'>
  ENDDO<a name='453'>
  ENDDO<a name='454'>
<a name='455'>
  DO j = j_start, j_end<a name='456'>
  DO k = kds, kde<a name='457'>
  DO i = i_start, i_end<a name='458'>
    <font color=#447700>! w coupled with my<a name='459'></font>
    w_2(i,k,j) = (msfty(i,j)*w_2(i,k,j) + w_save(i,k,j)*mut(i,j))/muts(i,j)<a name='460'>
    ph_2(i,k,j) = ph_2(i,k,j) + ph_save(i,k,j)<a name='461'>
    ww(i,k,j) = ww(i,k,j) + ww1(i,k,j)<a name='462'>
  ENDDO<a name='463'>
  ENDDO<a name='464'>
  ENDDO<a name='465'>
<a name='466'>
#ifdef REVERT<a name='467'>
  DO j = j_start, j_end<a name='468'>
  DO k = kds, kde-1<a name='469'>
  DO i = i_start, i_end<a name='470'>
    t_2(i,k,j) = (t_2(i,k,j) + t_save(i,k,j)*mut(i,j))/muts(i,j)<a name='471'>
  ENDDO<a name='472'>
  ENDDO<a name='473'>
  ENDDO<a name='474'>
#else<a name='475'>
  IF ( rk_step &lt; rk_order ) THEN<a name='476'>
    DO j = j_start, j_end<a name='477'>
    DO k = kds, kde-1<a name='478'>
    DO i = i_start, i_end<a name='479'>
      t_2(i,k,j) = (t_2(i,k,j) + t_save(i,k,j)*mut(i,j))/muts(i,j)<a name='480'>
    ENDDO<a name='481'>
    ENDDO<a name='482'>
    ENDDO<a name='483'>
  ELSE<a name='484'>
<a name='485'>
    DO j = j_start, j_end<a name='486'>
    DO k = kds, kde-1<a name='487'>
    DO i = i_start, i_end<a name='488'>
      t_2(i,k,j) = (t_2(i,k,j) - dts*number_of_small_timesteps*mut(i,j)*h_diabatic(i,k,j) &amp;<a name='489'>
                    + t_save(i,k,j)*mut(i,j))/muts(i,j)<a name='490'>
    ENDDO<a name='491'>
    ENDDO<a name='492'>
    ENDDO<a name='493'>
  ENDIF<a name='494'>
#endif<a name='495'>
<a name='496'>
  DO j = j_start, j_end<a name='497'>
  DO i = i_start, i_end<a name='498'>
    mu_2(i,j) = mu_2(i,j) + mu_save(i,j)<a name='499'>
  ENDDO<a name='500'>
  ENDDO<a name='501'>
<a name='502'>
END SUBROUTINE small_step_finish<a name='503'>
<a name='504'>
<font color=#447700>!-----------------------------------------------------------------------<a name='505'></font>
<a name='506'>
<A NAME='CALC_P_RHO'><A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='507'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_p_rho</font>( al, p, ph,                    &amp; <A href='../../call_to/CALC_P_RHO.html' TARGET='index'>2</A><a name='508'>
                       alt, t_2, t_1, c2a, pm1,      &amp;<a name='509'>
                       mu, mut,                      &amp;<a name='510'>
                       c1h, c2h, c1f, c2f,           &amp;<a name='511'>
                       c3h, c4h, c3f, c4f,           &amp;<a name='512'>
                       znu, t0,                      &amp;<a name='513'>
                       rdnw, dnw, smdiv,             &amp;<a name='514'>
                       non_hydrostatic, step,        &amp;<a name='515'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='516'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='517'>
                       its,ite, jts,jte, kts,kte    )<a name='518'>
<a name='519'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='520'></font>
<a name='521'>
<font color=#447700>! declarations for the stuff coming in<a name='522'></font>
<a name='523'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='524'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='525'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='526'>
<a name='527'>
  INTEGER,      INTENT(IN   )    :: step<a name='528'>
<a name='529'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(  OUT) :: al,   &amp;<a name='530'>
                                                               p<a name='531'>
<a name='532'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(IN   ) :: alt,   &amp;<a name='533'>
                                                              t_2,   &amp;<a name='534'>
                                                              t_1,   &amp;<a name='535'>
                                                              c2a<a name='536'>
<a name='537'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),INTENT(INOUT) :: ph, pm1<a name='538'>
<a name='539'>
  REAL, DIMENSION(ims:ime, jms:jme)         , INTENT(IN   ) :: mu,   &amp;<a name='540'>
                                                               mut<a name='541'>
<a name='542'>
  REAL, DIMENSION(kms:kme)         , INTENT(IN   ) :: dnw,  &amp;<a name='543'>
                                                      rdnw, &amp;<a name='544'>
                                                      znu<a name='545'>
<a name='546'>
  REAL,                                       INTENT(IN   ) :: t0, smdiv<a name='547'>
<a name='548'>
  REAL, DIMENSION( kms:kme ),INTENT(IN   ) :: c1h, c2h, c1f, c2f, &amp;<a name='549'>
                                              c3h, c4h, c3f, c4f<a name='550'>
<a name='551'>
  LOGICAL, INTENT(IN   )  :: non_hydrostatic<a name='552'>
<a name='553'>
<font color=#447700>! local variables<a name='554'></font>
<a name='555'>
  INTEGER :: i, j, k<a name='556'>
  INTEGER :: i_start, i_end, j_start, j_end, k_start, k_end<a name='557'>
  REAL    :: ptmp<a name='558'>
<a name='559'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='560'></font>
<font color=#447700>!<a name='561'></font>
<font color=#447700>!  For the nonhydrostatic option,<a name='562'></font>
<font color=#447700>!  calc_p_rho computes the perturbation inverse density and <a name='563'></font>
<font color=#447700>!  perturbation pressure from the hydrostatic relation and the <a name='564'></font>
<font color=#447700>!  linearized equation of state, respectively.<a name='565'></font>
<font color=#447700>!<a name='566'></font>
<font color=#447700>!  For the hydrostatic option,<a name='567'></font>
<font color=#447700>!  calc_p_rho computes the perturbation pressure, perturbation density,<a name='568'></font>
<font color=#447700>!  and perturbation geopotential<a name='569'></font>
<font color=#447700>!  from the vertical coordinate definition, linearized equation of state <a name='570'></font>
<font color=#447700>!  and the hydrostatic relation, respectively.<a name='571'></font>
<font color=#447700>!<a name='572'></font>
<font color=#447700>!  forward weighting of the pressure (divergence damping) is also<a name='573'></font>
<font color=#447700>!  computed here.<a name='574'></font>
<font color=#447700>!<a name='575'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='576'></font>
<a name='577'>
   i_start = its<a name='578'>
   i_end   = min(ite,ide-1)<a name='579'>
   j_start = jts<a name='580'>
   j_end   = min(jte,jde-1)<a name='581'>
   k_start = kts<a name='582'>
   k_end = min(kte,kde-1)<a name='583'>
<a name='584'>
   IF (non_hydrostatic) THEN<a name='585'>
     DO j=j_start, j_end<a name='586'>
     DO k=k_start, k_end<a name='587'>
     DO i=i_start, i_end<a name='588'>
<a name='589'>
<font color=#447700>!  al computation is all dry, so ok with moisture<a name='590'></font>
<a name='591'>
      al(i,k,j)=-1./Mut(i,j)*(alt(i,k,j)*mu(i,j)  &amp;<a name='592'>
             +rdnw(k)*(ph(i,k+1,j)-ph(i,k,j)))<a name='593'>
<a name='594'>
<font color=#447700>!  this is temporally linearized p, no moisture correction needed<a name='595'></font>
<a name='596'>
      p(i,k,j)=c2a(i,k,j)*(alt(i,k,j)*(t_2(i,k,j)-mu(i,j)*t_1(i,k,j))  &amp;<a name='597'>
                       /(Mut(i,j)*(t0+t_1(i,k,j)))-al (i,k,j))<a name='598'>
<a name='599'>
     ENDDO<a name='600'>
     ENDDO<a name='601'>
     ENDDO<a name='602'>
<a name='603'>
   ELSE  <font color=#447700>! hydrostatic calculation<a name='604'></font>
<a name='605'>
       DO j=j_start, j_end<a name='606'>
       DO k=k_start, k_end<a name='607'>
       DO i=i_start, i_end<a name='608'>
#if <font color=#447700>! ( HYBRID_COORD==1 ) <a name='609'></font>
         p(i,k,j)=mu(i,j)*znu(k)<a name='610'>
#else<a name='611'>
         p(i,k,j)=MU(i,j)*c3h(k)<a name='612'>
#endif<a name='613'>
         al(i,k,j)=alt(i,k,j)*(t_2(i,k,j)-mu(i,j)*t_1(i,k,j))           &amp;<a name='614'>
                      /(Mut(i,j)*(t0+t_1(i,k,j)))-p(i,k,j)/c2a(i,k,j)<a name='615'>
         ph(i,k+1,j)=ph(i,k,j)-dnw(k)*(Mut(i,j)*al (i,k,j)              &amp;<a name='616'>
                          +mu(i,j)*alt(i,k,j))<a name='617'>
       ENDDO<a name='618'>
       ENDDO<a name='619'>
       ENDDO<a name='620'>
<a name='621'>
   END IF<a name='622'>
<a name='623'>
<font color=#447700>!  divergence damping setup<a name='624'></font>
 <a name='625'>
     IF (step == 0) then   <font color=#447700>! we're initializing small timesteps<a name='626'></font>
       DO j=j_start, j_end<a name='627'>
       DO k=k_start, k_end<a name='628'>
       DO i=i_start, i_end<a name='629'>
         pm1(i,k,j)=p(i,k,j)<a name='630'>
       ENDDO<a name='631'>
       ENDDO<a name='632'>
       ENDDO <a name='633'>
     ELSE                     <font color=#447700>! we're in the small timesteps <a name='634'></font>
       DO j=j_start, j_end    <font color=#447700>! and adding div damping component<a name='635'></font>
       DO k=k_start, k_end<a name='636'>
       DO i=i_start, i_end<a name='637'>
         ptmp = p(i,k,j)<a name='638'>
         p(i,k,j) = p(i,k,j) + smdiv*(p(i,k,j)-pm1(i,k,j))<a name='639'>
         pm1(i,k,j) = ptmp<a name='640'>
       ENDDO<a name='641'>
       ENDDO<a name='642'>
       ENDDO<a name='643'>
     END IF<a name='644'>
<a name='645'>
END SUBROUTINE calc_p_rho<a name='646'>
<a name='647'>
<font color=#447700>!----------------------------------------------------------------------<a name='648'></font>
<a name='649'>
<A NAME='CALC_COEF_W'><A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_COEF_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='650'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_coef_w</font>( a,alpha,gamma,              &amp; <A href='../../call_to/CALC_COEF_W.html' TARGET='index'>1</A><a name='651'>
                        mut,                        &amp;<a name='652'>
                        c1h, c2h, c1f, c2f,         &amp;<a name='653'>
                        c3h, c4h, c3f, c4f,         &amp;<a name='654'>
                        cqw,                        &amp;<a name='655'>
                        rdn, rdnw, c2a,             &amp;<a name='656'>
                        dts, g, epssm, top_lid,     &amp;<a name='657'>
                        ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='658'></font>
                        ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='659'></font>
                        its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='660'></font>
                                                   <a name='661'>
      IMPLICIT NONE  <font color=#447700>! religion first<a name='662'></font>
<a name='663'>
<font color=#447700>!  passed in through the call<a name='664'></font>
<a name='665'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='666'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='667'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='668'>
<a name='669'>
  LOGICAL,      INTENT(IN   )    :: top_lid<a name='670'>
<a name='671'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(IN   ) :: c2a,  &amp;<a name='672'>
                                                               cqw<a name='673'>
<a name='674'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme), INTENT(INOUT) :: alpha, &amp;<a name='675'>
                                                               gamma, &amp;<a name='676'>
                                                               a<a name='677'>
<a name='678'>
  REAL, DIMENSION(ims:ime, jms:jme),          INTENT(IN   ) :: mut<a name='679'>
<a name='680'>
  REAL, DIMENSION(kms:kme),                   INTENT(IN   ) :: rdn,   &amp;<a name='681'>
                                                               rdnw<a name='682'>
<a name='683'>
  REAL,                                       INTENT(IN   ) :: epssm, &amp;<a name='684'>
                                                               dts,   &amp;<a name='685'>
                                                               g<a name='686'>
<a name='687'>
  REAL, DIMENSION( kms:kme ),INTENT(IN   ) :: c1h, c2h, c1f, c2f, &amp;<a name='688'>
                                              c3h, c4h, c3f, c4f<a name='689'>
<a name='690'>
<font color=#447700>!  Local stack data.<a name='691'></font>
<a name='692'>
  REAL, DIMENSION(ims:ime)                         :: cof<a name='693'>
  REAL  :: b, c<a name='694'>
  REAL  :: muthmutf_kk, muthmutf_km1k, muthmutf_kkp1<a name='695'>
<a name='696'>
  INTEGER :: i, j, k, kk, i_start, i_end, j_start, j_end, k_start, k_end<a name='697'>
  INTEGER :: ij, ijp, ijm, lid_flag<a name='698'>
<a name='699'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='700'></font>
<font color=#447700>!<a name='701'></font>
<font color=#447700>!  calc_coef_w calculates the coefficients needed for the <a name='702'></font>
<font color=#447700>!  implicit solution of the vertical momentum and geopotential equations.<a name='703'></font>
<font color=#447700>!  This requires solution of a tri-diagonal equation.<a name='704'></font>
<font color=#447700>!<a name='705'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='706'></font>
<a name='707'>
      i_start = its<a name='708'>
      i_end   = min(ite,ide-1)<a name='709'>
      j_start = jts<a name='710'>
      j_end   = min(jte,jde-1)<a name='711'>
      k_start = kts<a name='712'>
      k_end   = kte-1<a name='713'>
<a name='714'>
      lid_flag=1<a name='715'>
      IF(top_lid)lid_flag=0<a name='716'>
<a name='717'>
     outer_j_loop:  DO j = j_start, j_end<a name='718'>
<a name='719'>
        k = kde-1<a name='720'>
        DO i = i_start, i_end<a name='721'>
          cof(i)  = (.5*dts*g*(1.+epssm))**2<a name='722'>
          a(i, 2 ,j) = 0.<a name='723'>
#if <font color=#447700>! ( HYBRID_COORD )<a name='724'></font>
          MUTHMUTF_KK = mut(i,j)*mut(i,j)<a name='725'>
#endif<a name='726'>
          a(i,kde,j) =-2.*cof(i)*rdnw(kde-1)**2*c2a(i,kde-1,j)*lid_flag/MUTHMUTF_KK<a name='727'>
          gamma(i,1 ,j) = 0.<a name='728'>
        ENDDO<a name='729'>
<a name='730'>
        DO kk=3,kde-1<a name='731'>
        k=kk-1<a name='732'>
        DO i=i_start, i_end<a name='733'>
#if <font color=#447700>! ( HYBRID_COORD )<a name='734'></font>
          MUTHMUTF_KK = mut(i,j)*mut(i,j)<a name='735'>
#endif<a name='736'>
          a(i,kk,j) =   -cqw(i,kk,j)*cof(i)*rdn(kk)* rdnw(kk-1)*c2a(i,kk-1,j)/MUTHMUTF_KK<a name='737'>
        ENDDO<a name='738'>
        ENDDO<a name='739'>
<a name='740'>
<a name='741'>
        DO k=2,kde-1<a name='742'>
        DO i=i_start, i_end<a name='743'>
#if <font color=#447700>! ( HYBRID_COORD )<a name='744'></font>
          MUTHMUTF_KK = mut(i,j)*mut(i,j)<a name='745'>
          MUTHMUTF_KM1K = mut(i,j)*mut(i,j)<a name='746'>
          MUTHMUTF_KKP1 = mut(i,j)*mut(i,j)<a name='747'>
#endif<a name='748'>
          b = 1.+cqw(i,k,j)*cof(i)*rdn(k)*(rdnw(k  )*c2a(i,k,  j)/MUTHMUTF_KK  &amp;<a name='749'>
                                          +rdnw(k-1)*c2a(i,k-1,j)/MUTHMUTF_KM1K )<a name='750'>
          c =   -cqw(i,k,j)*cof(i)*rdn(k)*rdnw(k  )*c2a(i,k,j  )/MUTHMUTF_KKP1<a name='751'>
          alpha(i,k,j) = 1./(b-a(i,k,j)*gamma(i,k-1,j))<a name='752'>
          gamma(i,k,j) = c*alpha(i,k,j)<a name='753'>
        ENDDO<a name='754'>
        ENDDO<a name='755'>
<a name='756'>
        k=kde<a name='757'>
        DO i=i_start, i_end<a name='758'>
#if <font color=#447700>! ( HYBRID_COORD )<a name='759'></font>
          MUTHMUTF_KM1K = mut(i,j)*mut(i,j)<a name='760'>
#endif<a name='761'>
          b = 1.+2.*cof(i)*rdnw(kde-1)**2*c2a(i,kde-1,j)/MUTHMUTF_KM1K<a name='762'>
          c = 0.<a name='763'>
          alpha(i,kde,j) = 1./(b-a(i,kde,j)*gamma(i,kde-1,j))<a name='764'>
          gamma(i,kde,j) = c*alpha(i,kde,j)<a name='765'>
        ENDDO<a name='766'>
<a name='767'>
      ENDDO outer_j_loop<a name='768'>
<a name='769'>
END SUBROUTINE calc_coef_w<a name='770'>
<a name='771'>
<font color=#447700>!----------------------------------------------------------------------<a name='772'></font>
<a name='773'>
<A NAME='ADVANCE_UV'><A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_UV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='774'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advance_uv</font> ( u, ru_tend, v, rv_tend,        &amp; <A href='../../call_to/ADVANCE_UV.html' TARGET='index'>1</A><a name='775'>
                        p, pb,                         &amp;<a name='776'>
                        ph, php, alt, al, mu,          &amp;<a name='777'>
                        muu, cqu, muv, cqv, mudf,      &amp;<a name='778'>
                        c1h, c2h, c1f, c2f,            &amp;<a name='779'>
                        c3h, c4h, c3f, c4f,            &amp;<a name='780'>
                        msfux, msfuy, msfvx,           &amp;<a name='781'>
                        msfvx_inv, msfvy,              &amp;<a name='782'>
                        rdx, rdy, dts,                 &amp;<a name='783'>
                        cf1, cf2, cf3, fnm, fnp,       &amp;<a name='784'>
                        emdiv,                         &amp;<a name='785'>
                        rdnw, config_flags, spec_zone, &amp;<a name='786'>
                        non_hydrostatic, top_lid,      &amp;<a name='787'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='788'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='789'>
                        its, ite, jts, jte, kts, kte  )<a name='790'>
<a name='791'>
<a name='792'>
<a name='793'>
      IMPLICIT NONE  <font color=#447700>! religion first<a name='794'></font>
<a name='795'>
<font color=#447700>! stuff coming in<a name='796'></font>
<a name='797'>
      TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='798'>
<a name='799'>
      LOGICAL, INTENT(IN   ) :: non_hydrostatic, top_lid<a name='800'>
<a name='801'>
      INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='802'>
      INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='803'>
      INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='804'>
      INTEGER,      INTENT(IN   )    :: spec_zone<a name='805'>
<a name='806'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),  &amp;<a name='807'>
            INTENT(INOUT) ::                          &amp;<a name='808'>
                                                  u,  &amp;<a name='809'>
                                                  v<a name='810'>
<a name='811'>
      REAL, DIMENSION( ims:ime , kms:kme, jms:jme ), &amp;<a name='812'>
            INTENT(IN   ) ::                          &amp;<a name='813'>
                                             ru_tend, &amp;<a name='814'>
                                             rv_tend, &amp;<a name='815'>
                                             ph,      &amp;<a name='816'>
                                             php,     &amp;<a name='817'>
                                             p,       &amp;<a name='818'>
                                             pb,      &amp;<a name='819'>
                                             alt,     &amp;<a name='820'>
                                             al,      &amp;<a name='821'>
                                             cqu,     &amp;<a name='822'>
                                             cqv<a name='823'>
<a name='824'>
<a name='825'>
      REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(IN   ) :: muu,  &amp;<a name='826'>
                                                                muv,  &amp;<a name='827'>
                                                                mu,   &amp;<a name='828'>
                                                                mudf<a name='829'>
<a name='830'>
<a name='831'>
      REAL, DIMENSION( kms:kme ),              INTENT(IN   ) :: fnm,    &amp;<a name='832'>
                                                                fnp ,   &amp;<a name='833'>
                                                                rdnw<a name='834'>
<a name='835'>
      REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(IN   ) :: msfux,  &amp;<a name='836'>
                                                                msfuy,  &amp;<a name='837'>
                                                                msfvx,  &amp;<a name='838'>
                                                                msfvy,  &amp;<a name='839'>
                                                                msfvx_inv<a name='840'>
<a name='841'>
      REAL,                                    INTENT(IN   ) :: rdx,    &amp;<a name='842'>
                                                                rdy,    &amp;<a name='843'>
                                                                dts,    &amp;<a name='844'>
                                                                cf1,    &amp;<a name='845'>
                                                                cf2,    &amp;<a name='846'>
                                                                cf3,    &amp;<a name='847'>
                                                                emdiv<a name='848'>
<a name='849'>
      REAL, DIMENSION( kms:kme ),INTENT(IN   ) :: c1h, c2h, c1f, c2f, &amp;<a name='850'>
                                                  c3h, c4h, c3f, c4f<a name='851'>
    <a name='852'>
<a name='853'>
<font color=#447700>!  Local 3d array from the stack (note tile size)<a name='854'></font>
<a name='855'>
      REAL, DIMENSION (its:ite, kts:kte) :: dpn, dpxy<a name='856'>
      REAL, DIMENSION (its:ite) :: mudf_xy<a name='857'>
      REAL                      :: dx, dy<a name='858'>
<a name='859'>
      INTEGER :: i,j,k, i_start, i_end, j_start, j_end, k_start, k_end<a name='860'>
      INTEGER :: i_endu, j_endv, k_endw<a name='861'>
      INTEGER :: i_start_up, i_end_up, j_start_up, j_end_up<a name='862'>
      INTEGER :: i_start_vp, i_end_vp, j_start_vp, j_end_vp<a name='863'>
<a name='864'>
      INTEGER :: i_start_u_tend, i_end_u_tend, j_start_v_tend, j_end_v_tend<a name='865'>
<a name='866'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='867'></font>
<font color=#447700>!<a name='868'></font>
<font color=#447700>!  advance_uv advances the explicit perturbation horizontal momentum <a name='869'></font>
<font color=#447700>!  equations (u,v) by adding in the large-timestep tendency along with <a name='870'></font>
<font color=#447700>!  the small timestep pressure gradient tendency.<a name='871'></font>
<font color=#447700>!<a name='872'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='873'></font>
<a name='874'>
<font color=#447700>!  now, the real work.<a name='875'></font>
<font color=#447700>!  set the loop bounds taking into account boundary conditions.<a name='876'></font>
<a name='877'>
    IF( config_flags%nested .or. config_flags%specified ) THEN<a name='878'>
      i_start = max( its,ids+spec_zone )<a name='879'>
      i_end   = min( ite,ide-spec_zone-1 )<a name='880'>
      j_start = max( jts,jds+spec_zone )<a name='881'>
      j_end   = min( jte,jde-spec_zone-1 )<a name='882'>
      k_start = kts<a name='883'>
      k_end   = min( kte, kde-1 )<a name='884'>
<a name='885'>
      i_endu = min( ite,ide-spec_zone )<a name='886'>
      j_endv = min( jte,jde-spec_zone )<a name='887'>
      k_endw = k_end<a name='888'>
<a name='889'>
      IF( config_flags%periodic_x) THEN<a name='890'>
        i_start = its<a name='891'>
        i_end   = min(ite,ide-1)<a name='892'>
        i_endu = ite<a name='893'>
      ENDIF<a name='894'>
    ELSE<a name='895'>
      i_start = its<a name='896'>
      i_end   = min(ite,ide-1)<a name='897'>
      j_start = jts<a name='898'>
      j_end   = min(jte,jde-1)<a name='899'>
      k_start = kts<a name='900'>
      k_end   = kte-1<a name='901'>
<a name='902'>
      i_endu = ite<a name='903'>
      j_endv = jte<a name='904'>
      k_endw = k_end<a name='905'>
    ENDIF<a name='906'>
<a name='907'>
      i_start_up = i_start<a name='908'>
      i_end_up   = i_endu<a name='909'>
      j_start_up = j_start<a name='910'>
      j_end_up   = j_end<a name='911'>
<a name='912'>
      i_start_vp = i_start<a name='913'>
      i_end_vp   = i_end<a name='914'>
      j_start_vp = j_start<a name='915'>
      j_end_vp   = j_endv<a name='916'>
<a name='917'>
      IF ( (config_flags%open_xs   .or.     &amp;<a name='918'>
            config_flags%symmetric_xs   )   &amp;<a name='919'>
            .and. (its == ids) )            &amp;<a name='920'>
                 i_start_up = i_start_up + 1<a name='921'>
<a name='922'>
      IF ( (config_flags%open_xe    .or.  &amp;<a name='923'>
            config_flags%symmetric_xe   ) &amp;<a name='924'>
             .and. (ite == ide) )         &amp;<a name='925'>
                 i_end_up   = i_end_up - 1<a name='926'>
<a name='927'>
      IF ( (config_flags%open_ys    .or.   &amp;<a name='928'>
            config_flags%symmetric_ys  .or.   &amp;<a name='929'>
            config_flags%polar   )  &amp;<a name='930'>
                     .and. (jts == jds) )  &amp;<a name='931'>
                 j_start_vp = j_start_vp + 1<a name='932'>
<a name='933'>
      IF ( (config_flags%open_ye     .or. &amp;<a name='934'>
            config_flags%symmetric_ye  .or.   &amp;<a name='935'>
            config_flags%polar   )  &amp;<a name='936'>
            .and. (jte == jde) )          &amp;<a name='937'>
                 j_end_vp   = j_end_vp - 1<a name='938'>
<a name='939'>
      i_start_u_tend = i_start<a name='940'>
      i_end_u_tend   = i_endu<a name='941'>
      j_start_v_tend = j_start<a name='942'>
      j_end_v_tend   = j_endv<a name='943'>
<a name='944'>
      IF ( config_flags%symmetric_xs .and. (its == ids) ) &amp;<a name='945'>
                     i_start_u_tend = i_start_u_tend+1<a name='946'>
      IF ( config_flags%symmetric_xe .and. (ite == ide) ) &amp;<a name='947'>
                     i_end_u_tend = i_end_u_tend-1<a name='948'>
      IF ( config_flags%symmetric_ys .and. (jts == jds) ) &amp;<a name='949'>
                     j_start_v_tend = j_start_v_tend+1<a name='950'>
      IF ( config_flags%symmetric_ye .and. (jte == jde) ) &amp;<a name='951'>
                     j_end_v_tend = j_end_v_tend-1<a name='952'>
<a name='953'>
   dx = 1./rdx<a name='954'>
   dy = 1./rdy<a name='955'>
<a name='956'>
<font color=#447700>!  start real calculations.<a name='957'></font>
<font color=#447700>!  first, u<a name='958'></font>
<a name='959'>
  u_outer_j_loop: DO j = j_start, j_end<a name='960'>
<a name='961'>
   DO k = k_start, k_end<a name='962'>
   DO i = i_start_u_tend, i_end_u_tend<a name='963'>
     u(i,k,j) = u(i,k,j) + dts*ru_tend(i,k,j)<a name='964'>
   ENDDO<a name='965'>
   ENDDO<a name='966'>
<a name='967'>
   DO i = i_start_up, i_end_up<a name='968'>
     MUDF_XY(i)= -emdiv*dx*(MUDF(i,j)-MUDF(i-1,j))/msfuy(i,j)<a name='969'>
   ENDDO<a name='970'>
<a name='971'>
   DO k = k_start, k_end<a name='972'>
   DO i = i_start_up, i_end_up<a name='973'>
<a name='974'>
<font color=#447700>!     Comments on map scale factors:   <a name='975'></font>
<font color=#447700>!     x pressure gradient: ADT eqn 44, penultimate term on RHS<a name='976'></font>
<font color=#447700>!        = -(mx/my)*(mu/rho)*partial dp/dx<a name='977'></font>
<font color=#447700>!     [i.e., first rho-&gt;mu; 2nd still rho; alpha=1/rho]<a name='978'></font>
<font color=#447700>!     Klemp et al. splits into 2 terms:<a name='979'></font>
<font color=#447700>!        mu alpha partial dp/dx + partial dp/dnu * partial dphi/dx <a name='980'></font>
<font color=#447700>!     then into 4 terms:<a name='981'></font>
<font color=#447700>!        mu alpha partial dp'/dx + nu mu alpha' partial dmubar/dx +<a name='982'></font>
<font color=#447700>!      + mu partial dphi/dx + partial dphi'/dx * (partial dp'/dnu - mu')<a name='983'></font>
<font color=#447700>!<a name='984'></font>
<font color=#447700>!     first 3 terms:<a name='985'></font>
<font color=#447700>!     ph, alt, p, al, pb not coupled<a name='986'></font>
<font color=#447700>!     since we want tendency to fit ADT eqn 44 (coupled) we need to<a name='987'></font>
<font color=#447700>!     multiply by (mx/my):<a name='988'></font>
<font color=#447700>!<a name='989'></font>
     dpxy(i,k)= (msfux(i,j)/msfuy(i,j))*.5*rdx*muu(i,j)*(         &amp;<a name='990'>
       ((ph (i,k+1,j)-ph (i-1,k+1,j))+(ph (i,k,j)-ph (i-1,k,j)))  &amp;<a name='991'>
      +(alt(i,k  ,j)+alt(i-1,k  ,j))*(p  (i,k,j)-p  (i-1,k,j))  &amp;<a name='992'>
      +(al (i,k  ,j)+al (i-1,k  ,j))*(pb (i,k,j)-pb (i-1,k,j)) ) <a name='993'>
<a name='994'>
   ENDDO<a name='995'>
   ENDDO<a name='996'>
<a name='997'>
   IF (non_hydrostatic) THEN<a name='998'>
<a name='999'>
     DO i = i_start_up, i_end_up<a name='1000'>
       dpn(i,1) = .5*( cf1*(p(i,1,j)+p(i-1,1,j))  &amp;<a name='1001'>
                      +cf2*(p(i,2,j)+p(i-1,2,j))  &amp;<a name='1002'>
                      +cf3*(p(i,3,j)+p(i-1,3,j)) )<a name='1003'>
       dpn(i,kde) = 0.<a name='1004'>
     ENDDO<a name='1005'>
     IF (top_lid) THEN<a name='1006'>
       DO i = i_start_up, i_end_up<a name='1007'>
         dpn(i,kde) =.5*( cf1*(p(i-1,kde-1,j)+p(i,kde-1,j))   &amp;<a name='1008'>
                         +cf2*(p(i-1,kde-2,j)+p(i,kde-2,j))   &amp;<a name='1009'>
                         +cf3*(p(i-1,kde-3,j)+p(i,kde-3,j))  )<a name='1010'>
       ENDDO<a name='1011'>
     ENDIF<a name='1012'>
<a name='1013'>
     DO k = k_start+1, k_end<a name='1014'>
       DO i = i_start_up, i_end_up<a name='1015'>
         dpn(i,k) = .5*( fnm(k)*(p(i,k  ,j)+p(i-1,k  ,j))   &amp;<a name='1016'>
                        +fnp(k)*(p(i,k-1,j)+p(i-1,k-1,j)) )<a name='1017'>
       ENDDO<a name='1018'>
     ENDDO<a name='1019'>
<a name='1020'>
<font color=#447700>!    Comments on map scale factors:<a name='1021'></font>
<font color=#447700>!    4th term:<a name='1022'></font>
<font color=#447700>!    php, dpn, mu not coupled<a name='1023'></font>
<font color=#447700>!    since we want tendency to fit ADT eqn 44 (coupled) we need to<a name='1024'></font>
<font color=#447700>!    multiply by (mx/my):<a name='1025'></font>
<a name='1026'>
     DO k = k_start, k_end<a name='1027'>
       DO i = i_start_up, i_end_up<a name='1028'>
         dpxy(i,k)=dpxy(i,k) + (msfux(i,j)/msfuy(i,j))*rdx*(php(i,k,j)-php(i-1,k,j))*        &amp;<a name='1029'>
           (rdnw(k)*(dpn(i,k+1)-dpn(i,k))-.5*(mu(i-1,j)+mu(i,j)))<a name='1030'>
       ENDDO<a name='1031'>
     ENDDO<a name='1032'>
<a name='1033'>
 <a name='1034'>
   END IF<a name='1035'>
<a name='1036'>
<a name='1037'>
   DO k = k_start, k_end<a name='1038'>
     DO i = i_start_up, i_end_up<a name='1039'>
       u(i,k,j)=u(i,k,j)-dts*cqu(i,k,j)*dpxy(i,k)+mudf_xy(i) <a name='1040'>
     ENDDO<a name='1041'>
   ENDDO<a name='1042'>
<a name='1043'>
   ENDDO u_outer_j_loop<a name='1044'>
<a name='1045'>
<font color=#447700>! now v<a name='1046'></font>
<a name='1047'>
  v_outer_j_loop: DO j = j_start_v_tend, j_end_v_tend<a name='1048'>
<a name='1049'>
<a name='1050'>
   DO k = k_start, k_end<a name='1051'>
   DO i = i_start, i_end<a name='1052'>
     v(i,k,j) = v(i,k,j) + dts*rv_tend(i,k,j)<a name='1053'>
   ENDDO<a name='1054'>
   ENDDO<a name='1055'>
<a name='1056'>
   DO i = i_start, i_end<a name='1057'>
     MUDF_XY(i)= -emdiv*dy*(MUDF(i,j)-MUDF(i,j-1))*msfvx_inv(i,j)<a name='1058'>
   ENDDO<a name='1059'>
<a name='1060'>
     IF (     ( j &gt;= j_start_vp)  &amp;<a name='1061'>
       .and.( j &lt;= j_end_vp  ) )  THEN<a name='1062'>
<a name='1063'>
         DO k = k_start, k_end<a name='1064'>
	 DO i = i_start, i_end<a name='1065'>
<a name='1066'>
<font color=#447700>!      Comments on map scale factors:<a name='1067'></font>
<font color=#447700>!      y pressure gradient: ADT eqn 45, penultimate term on RHS<a name='1068'></font>
<font color=#447700>!         = -(my/mx)*(mu/rho)*partial dp/dy<a name='1069'></font>
<font color=#447700>!      [i.e., first rho-&gt;mu; 2nd still rho; alpha=1/rho]<a name='1070'></font>
<font color=#447700>!      Klemp et al. splits into 2 terms:<a name='1071'></font>
<font color=#447700>!         mu alpha partial dp/dy + partial dp/dnu * partial dphi/dy <a name='1072'></font>
<font color=#447700>!      then into 4 terms:<a name='1073'></font>
<font color=#447700>!         mu alpha partial dp'/dy + nu mu alpha' partial dmubar/dy +<a name='1074'></font>
<font color=#447700>!       + mu partial dphi/dy + partial dphi'/dy * (partial dp'/dnu - mu')<a name='1075'></font>
<font color=#447700>!<a name='1076'></font>
<font color=#447700>!      first 3 terms:<a name='1077'></font>
<font color=#447700>!      ph, alt, p, al, pb not coupled<a name='1078'></font>
<font color=#447700>!      since we want tendency to fit ADT eqn 45 (coupled) we need to<a name='1079'></font>
<font color=#447700>!      multiply by (my/mx):<a name='1080'></font>
<font color=#447700>!      mudf_xy is NOT a map scale factor coupling<a name='1081'></font>
<font color=#447700>!      it is some sort of divergence damping<a name='1082'></font>
<a name='1083'>
       dpxy(i,k)= (msfvy(i,j)/msfvx(i,j))*.5*rdy*muv(i,j)*(       &amp;<a name='1084'>
        ((ph(i,k+1,j)-ph(i,k+1,j-1))+(ph (i,k,j)-ph (i,k,j-1)))   &amp;<a name='1085'>
        +(alt(i,k  ,j)+alt(i,k  ,j-1))*(p  (i,k,j)-p  (i,k,j-1))  &amp;<a name='1086'>
        +(al (i,k  ,j)+al (i,k  ,j-1))*(pb (i,k,j)-pb (i,k,j-1)) ) <a name='1087'>
	    ENDDO<a name='1088'>
	    ENDDO<a name='1089'>
<a name='1090'>
<a name='1091'>
     IF (non_hydrostatic) THEN<a name='1092'>
<a name='1093'>
       DO i = i_start, i_end     <a name='1094'>
         dpn(i,1) = .5*( cf1*(p(i,1,j)+p(i,1,j-1))  &amp;<a name='1095'>
                        +cf2*(p(i,2,j)+p(i,2,j-1))  &amp;<a name='1096'>
                        +cf3*(p(i,3,j)+p(i,3,j-1)) )<a name='1097'>
         dpn(i,kde) = 0.<a name='1098'>
       ENDDO<a name='1099'>
     IF (top_lid) THEN<a name='1100'>
       DO i = i_start, i_end<a name='1101'>
         dpn(i,kde) =.5*( cf1*(p(i,kde-1,j-1)+p(i,kde-1,j))   &amp;<a name='1102'>
                         +cf2*(p(i,kde-2,j-1)+p(i,kde-2,j))   &amp;<a name='1103'>
                         +cf3*(p(i,kde-3,j-1)+p(i,kde-3,j))  )<a name='1104'>
       ENDDO<a name='1105'>
     ENDIF<a name='1106'>
<a name='1107'>
       DO k = k_start+1, k_end<a name='1108'>
         DO i = i_start, i_end<a name='1109'>
           dpn(i,k) = .5*( fnm(k)*(p(i,k  ,j)+p(i,k  ,j-1))  &amp;<a name='1110'>
                          +fnp(k)*(p(i,k-1,j)+p(i,k-1,j-1)) )<a name='1111'>
         ENDDO<a name='1112'>
       ENDDO<a name='1113'>
<a name='1114'>
<font color=#447700>!      Comments on map scale factors:<a name='1115'></font>
<font color=#447700>!      4th term:<a name='1116'></font>
<font color=#447700>!      php, dpn, mu not coupled<a name='1117'></font>
<font color=#447700>!      since we want tendency to fit ADT eqn 45 (coupled) we need to<a name='1118'></font>
<font color=#447700>!      multiply by (my/mx):<a name='1119'></font>
<a name='1120'>
       DO k = k_start, k_end<a name='1121'>
         DO i = i_start, i_end<a name='1122'>
           dpxy(i,k)=dpxy(i,k) + (msfvy(i,j)/msfvx(i,j))*rdy*(php(i,k,j)-php(i,k,j-1))*    &amp;<a name='1123'>
             (rdnw(k)*(dpn(i,k+1)-dpn(i,k))-.5*(mu(i,j-1)+mu(i,j)))<a name='1124'>
         ENDDO<a name='1125'>
       ENDDO<a name='1126'>
<a name='1127'>
<a name='1128'>
     END IF<a name='1129'>
<a name='1130'>
<a name='1131'>
     DO k = k_start, k_end<a name='1132'>
       DO i = i_start, i_end<a name='1133'>
         v(i,k,j)=v(i,k,j)-dts*cqv(i,k,j)*dpxy(i,k)+mudf_xy(i) <a name='1134'>
       ENDDO<a name='1135'>
     ENDDO<a name='1136'>
   END IF<a name='1137'>
<a name='1138'>
  ENDDO  v_outer_j_loop<a name='1139'>
<a name='1140'>
  <font color=#447700>! The check for j_start_vp and j_end_vp makes sure that the edges in v<a name='1141'></font>
  <font color=#447700>! are not updated.  Let's add a polar boundary condition check here for<a name='1142'></font>
  <font color=#447700>! safety to ensure that v at the poles never gets to be non-zero in the<a name='1143'></font>
  <font color=#447700>! small time steps.<a name='1144'></font>
  IF (config_flags%polar) THEN<a name='1145'>
     IF (jts == jds) THEN<a name='1146'>
        DO k = k_start, k_end<a name='1147'>
        DO i = i_start, i_end<a name='1148'>
           v(i,k,jds) = 0.<a name='1149'>
        ENDDO<a name='1150'>
        ENDDO<a name='1151'>
     END IF<a name='1152'>
     IF (jte == jde) THEN<a name='1153'>
        DO k = k_start, k_end<a name='1154'>
        DO i = i_start, i_end<a name='1155'>
           v(i,k,jde) = 0.<a name='1156'>
        ENDDO<a name='1157'>
        ENDDO<a name='1158'>
     END IF<a name='1159'>
  END IF<a name='1160'>
<a name='1161'>
<a name='1162'>
END SUBROUTINE advance_uv<a name='1163'>
<a name='1164'>
<font color=#447700>!---------------------------------------------------------------------<a name='1165'></font>
<a name='1166'>
<A NAME='ADVANCE_MU_T'><A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_MU_T' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1167'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advance_mu_t</font>( ww, ww_1, u, u_1, v, v_1,            &amp; <A href='../../call_to/ADVANCE_MU_T.html' TARGET='index'>1</A><a name='1168'>
                         mu, mut, muave, muts, muu, muv, mudf,&amp;<a name='1169'>
                         c1h, c2h, c1f, c2f,                  &amp;<a name='1170'>
                         c3h, c4h, c3f, c4f,                  &amp;<a name='1171'>
                         uam, vam, wwam, t, t_1,              &amp;<a name='1172'>
                         t_ave, ft, mu_tend,                  &amp;<a name='1173'>
                         rdx, rdy, dts, epssm,                &amp;<a name='1174'>
                         dnw, fnm, fnp, rdnw,                 &amp;<a name='1175'>
                         msfux, msfuy, msfvx, msfvx_inv,      &amp;<a name='1176'>
                         msfvy, msftx, msfty,                 &amp;<a name='1177'>
                         step, config_flags,                  &amp;<a name='1178'>
                         ids, ide, jds, jde, kds, kde,        &amp;<a name='1179'>
                         ims, ime, jms, jme, kms, kme,        &amp;<a name='1180'>
                         its, ite, jts, jte, kts, kte        )<a name='1181'>
<a name='1182'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='1183'></font>
<a name='1184'>
<font color=#447700>! stuff coming in<a name='1185'></font>
<a name='1186'>
  TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1187'>
<a name='1188'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='1189'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='1190'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='1191'>
<a name='1192'>
  INTEGER,      INTENT(IN   )    :: step<a name='1193'>
<a name='1194'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),   &amp;<a name='1195'>
            INTENT(IN   ) ::                       &amp;<a name='1196'>
                                              u,   &amp;<a name='1197'>
                                              v,   &amp;<a name='1198'>
                                              u_1, &amp;<a name='1199'>
                                              v_1, &amp;<a name='1200'>
                                              t_1, &amp;<a name='1201'>
                                              ft<a name='1202'>
<a name='1203'>
  REAL, DIMENSION( ims:ime , kms:kme, jms:jme ),      &amp;<a name='1204'>
            INTENT(INOUT) ::                          &amp;<a name='1205'>
                                              ww,     &amp;<a name='1206'>
                                              ww_1,   &amp;<a name='1207'>
                                              t,      &amp;<a name='1208'>
                                              t_ave,  &amp;<a name='1209'>
                                              uam,    &amp;<a name='1210'>
                                              vam,    &amp;<a name='1211'>
                                              wwam<a name='1212'>
                                              <a name='1213'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(IN   ) :: muu,  &amp;<a name='1214'>
                                                            muv,  &amp;<a name='1215'>
                                                            mut,  &amp;<a name='1216'>
                                                            msfux,&amp;<a name='1217'>
                                                            msfuy,&amp;<a name='1218'>
                                                            msfvx,&amp;<a name='1219'>
                                                            msfvx_inv,&amp;<a name='1220'>
                                                            msfvy,&amp;<a name='1221'>
                                                            msftx,&amp;<a name='1222'>
                                                            msfty,&amp;<a name='1223'>
                                                            mu_tend<a name='1224'>
<a name='1225'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(  OUT) :: muave, &amp;<a name='1226'>
                                                            muts,  &amp;<a name='1227'>
                                                            mudf<a name='1228'>
<a name='1229'>
  REAL, DIMENSION( ims:ime , jms:jme ),    INTENT(INOUT) :: mu<a name='1230'>
<a name='1231'>
  REAL, DIMENSION( kms:kme ),              INTENT(IN   ) :: fnm,    &amp;<a name='1232'>
                                                            fnp,    &amp;<a name='1233'>
                                                            dnw,    &amp;<a name='1234'>
                                                            rdnw<a name='1235'>
<a name='1236'>
<a name='1237'>
  REAL,                                    INTENT(IN   ) :: rdx,    &amp;<a name='1238'>
                                                            rdy,    &amp;<a name='1239'>
                                                            dts,    &amp;<a name='1240'>
                                                            epssm<a name='1241'>
<a name='1242'>
  REAL, DIMENSION( kms:kme ),INTENT(IN   ) :: c1h, c2h, c1f, c2f, &amp;<a name='1243'>
                                              c3h, c4h, c3f, c4f<a name='1244'>
<a name='1245'>
<font color=#447700>!  Local arrays from the stack (note tile size)<a name='1246'></font>
<a name='1247'>
  REAL, DIMENSION (its:ite, kts:kte) :: wdtn, dvdxi<a name='1248'>
  REAL, DIMENSION (its:ite) :: dmdt<a name='1249'>
<a name='1250'>
  INTEGER :: i, j, k, kk, i_start, i_end, j_start, j_end, k_start, k_end<a name='1251'>
  INTEGER :: i_endu, j_endv<a name='1252'>
  REAL    :: acc<a name='1253'>
<a name='1254'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1255'></font>
<font color=#447700>!<a name='1256'></font>
<font color=#447700>!  advance_mu_t advances the explicit perturbation theta equation and the mass<a name='1257'></font>
<font color=#447700>!  conservation equation.  In addition, the small timestep omega is updated,<a name='1258'></font>
<font color=#447700>!  and some quantities needed in other places are squirrelled away.<a name='1259'></font>
<font color=#447700>!<a name='1260'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1261'></font>
<a name='1262'>
<font color=#447700>!  now, the real work.<a name='1263'></font>
<font color=#447700>!  set the loop bounds taking into account boundary conditions.<a name='1264'></font>
<a name='1265'>
  i_start = its<a name='1266'>
  i_end   = min(ite,ide-1)<a name='1267'>
  j_start = jts<a name='1268'>
  j_end   = min(jte,jde-1)<a name='1269'>
  k_start = kts<a name='1270'>
  k_end   = kte-1<a name='1271'>
  IF ( .NOT. config_flags%periodic_x )THEN<a name='1272'>
     IF ( config_flags%specified .or. config_flags%nested ) then<a name='1273'>
       i_start = max(its,ids+1)<a name='1274'>
       i_end   = min(ite,ide-2)<a name='1275'>
     ENDIF<a name='1276'>
  ENDIF<a name='1277'>
  IF ( config_flags%specified .or. config_flags%nested ) then<a name='1278'>
     j_start = max(jts,jds+1)<a name='1279'>
     j_end   = min(jte,jde-2)<a name='1280'>
  ENDIF<a name='1281'>
<a name='1282'>
  i_endu = ite<a name='1283'>
  j_endv = jte<a name='1284'>
<a name='1285'>
<font color=#447700>!        CALCULATION OF WW (dETA/dt)<a name='1286'></font>
   DO j = j_start, j_end<a name='1287'>
<a name='1288'>
     DO i=i_start, i_end<a name='1289'>
            DMDT(i) = 0.<a name='1290'>
     ENDDO<a name='1291'>
<font color=#447700>!  NOTE:  mu is not coupled with the map scale factor.<a name='1292'></font>
<font color=#447700>!         ww (omega) IS coupled with the map scale factor.<a name='1293'></font>
<font color=#447700>!         Being coupled with the map scale factor means <a name='1294'></font>
<font color=#447700>!           multiplication by (1/msft) in this case.<a name='1295'></font>
<a name='1296'>
<font color=#447700>!  Comments on map scale factors<a name='1297'></font>
<font color=#447700>!  ADT eqn 47: <a name='1298'></font>
<font color=#447700>!  partial drho/dt = -mx*my[partial d/dx(rho u/my) + partial d/dy(rho v/mx)]<a name='1299'></font>
<font color=#447700>!                    -partial d/dz(rho w)<a name='1300'></font>
<font color=#447700>!  with rho -&gt; mu, dividing by my, and with partial d/dnu(rho nu/my [=ww])<a name='1301'></font>
<font color=#447700>!  as the final term (because we're looking for d_nu_/dt)<a name='1302'></font>
<font color=#447700>!<a name='1303'></font>
<font color=#447700>!  begin by integrating with respect to nu from bottom to top<a name='1304'></font>
<font color=#447700>!  BCs are ww=0 at both<a name='1305'></font>
<font color=#447700>!  final term gives 0<a name='1306'></font>
<font color=#447700>!  first term gives Integral([1/my]partial d mu/dt) over total column = dm/dt<a name='1307'></font>
<font color=#447700>!  RHS remaining is Integral(-mx[partial d/dx(mu u/my) + <a name='1308'></font>
<font color=#447700>!                                partial d/dy(mu v/mx)]) over column<a name='1309'></font>
<font color=#447700>!  lines below find RHS terms at each level then set dmdt = sum over all levels<a name='1310'></font>
<font color=#447700>!<a name='1311'></font>
<font color=#447700>!  [don't divide the below by msfty until find ww, since dmdt is used in<a name='1312'></font>
<font color=#447700>!   the meantime]<a name='1313'></font>
<a name='1314'>
     DO k=k_start, k_end<a name='1315'>
     DO i=i_start, i_end<a name='1316'>
         dvdxi(i,k) = msftx(i,j)*msfty(i,j)*(                                      &amp;<a name='1317'>
                     rdy*( (v(i,k,j+1)+muv(i,j+1)*v_1(i,k,j+1)*msfvx_inv(i,j+1))   &amp;<a name='1318'>
                          -(v(i,k,j  )+muv(i,j  )*v_1(i,k,j  )*msfvx_inv(i,j  )) ) &amp;<a name='1319'>
                    +rdx*( (u(i+1,k,j)+muu(i+1,j)*u_1(i+1,k,j)/msfuy(i+1,j))       &amp;<a name='1320'>
                          -(u(i,k,j  )+muu(i  ,j)*u_1(i,k,j  )/msfuy(i  ,j)) ))<a name='1321'>
        DMDT(i)    = DMDT(i) + dnw(k)*dvdxi(i,k)<a name='1322'>
     ENDDO<a name='1323'>
     ENDDO<a name='1324'>
     DO i=i_start, i_end<a name='1325'>
       MUAVE(i,j) = MU(i,j)<a name='1326'>
       MU(i,j) = MU(i,j)+dts*(DMDT(i)+MU_TEND(i,j))<a name='1327'>
       MUDF(i,j) = (DMDT(i)+MU_TEND(i,j)) <font color=#447700>! save tendency for div damp filter<a name='1328'></font>
       MUTS(i,j) = MUT(i,j)+MU(i,j)<a name='1329'>
       MUAVE(i,j) =.5*((1.+epssm)*MU(i,j)+(1.-epssm)*MUAVE(i,j))<a name='1330'>
     ENDDO<a name='1331'>
<a name='1332'>
     DO kk=2,k_end<a name='1333'>
     k=kk-1<a name='1334'>
     DO i=i_start, i_end<a name='1335'>
       ww(i,kk,j)=ww(i,kk-1,j)-dnw(kk-1)*(dmdt(i)+dvdxi(i,kk-1)+mu_tend(i,j))/msfty(i,j)<a name='1336'>
     ENDDO<a name='1337'>
     END DO<a name='1338'>
<a name='1339'>
<font color=#447700>!  NOTE:  ww_1 (large timestep ww) is already coupled with the <a name='1340'></font>
<font color=#447700>!         map scale factor<a name='1341'></font>
<a name='1342'>
     DO k=1,k_end<a name='1343'>
     DO i=i_start, i_end<a name='1344'>
       ww(i,k,j)=ww(i,k,j)-ww_1(i,k,j)<a name='1345'>
     END DO<a name='1346'>
     END DO<a name='1347'>
<a name='1348'>
   ENDDO<a name='1349'>
<a name='1350'>
<font color=#447700>! CALCULATION OF THETA<a name='1351'></font>
<a name='1352'>
<font color=#447700>! NOTE: theta'' is not coupled with the map-scale factor, <a name='1353'></font>
<font color=#447700>!       while the theta'' tendency is coupled (i.e., mult by 1/msft)<a name='1354'></font>
<a name='1355'>
<font color=#447700>! Comments on map scale factors<a name='1356'></font>
<font color=#447700>! BUT NOTE THAT both are mass coupled<a name='1357'></font>
<font color=#447700>! in flux form equations (Klemp et al.) Theta = mu*theta<a name='1358'></font>
<font color=#447700>!<a name='1359'></font>
<font color=#447700>! scalar eqn: partial d/dt(rho q/my) = -mx[partial d/dx(q rho u/my) + <a name='1360'></font>
<font color=#447700>!                                          partial d/dy(q rho v/mx)]<a name='1361'></font>
<font color=#447700>!                                      - partial d/dz(q rho w/my)<a name='1362'></font>
<font color=#447700>! with rho -&gt; mu, and with partial d/dnu(q rho nu/my) as the final term<a name='1363'></font>
<font color=#447700>!<a name='1364'></font>
<font color=#447700>! adding previous tendency contribution which was map scale factor coupled<a name='1365'></font>
<font color=#447700>! (had been divided by msfty)<a name='1366'></font>
<font color=#447700>! need to uncouple before updating uncoupled Theta (by adding)<a name='1367'></font>
<a name='1368'>
   DO j=j_start, j_end<a name='1369'>
     DO k=1,k_end<a name='1370'>
     DO i=i_start, i_end<a name='1371'>
       t_ave(i,k,j) = t(i,k,j)<a name='1372'>
       t   (i,k,j) = t(i,k,j) + msfty(i,j)*dts*ft(i,k,j)<a name='1373'>
     END DO<a name='1374'>
     END DO<a name='1375'>
   ENDDO   <a name='1376'>
<a name='1377'>
   DO j=j_start, j_end<a name='1378'>
<a name='1379'>
     DO i=i_start, i_end<a name='1380'>
       wdtn(i,1  )=0.<a name='1381'>
       wdtn(i,kde)=0.<a name='1382'>
     ENDDO<a name='1383'>
<a name='1384'>
     DO k=2,k_end<a name='1385'>
     DO i=i_start, i_end<a name='1386'>
        <font color=#447700>! for scalar eqn RHS term 3<a name='1387'></font>
        wdtn(i,k)= ww(i,k,j)*(fnm(k)*t_1(i,k  ,j)+fnp(k)*t_1(i,k-1,j))<a name='1388'>
     ENDDO<a name='1389'>
     ENDDO<a name='1390'>
<a name='1391'>
<font color=#447700>! scalar eqn, RHS terms 1, 2 and 3<a name='1392'></font>
<font color=#447700>! multiply by msfty to uncouple result for Theta from map scale factor<a name='1393'></font>
<a name='1394'>
     DO k=1,k_end<a name='1395'>
     DO i=i_start, i_end<a name='1396'>
       <font color=#447700>! multiplication by msfty uncouples result for Theta<a name='1397'></font>
       t(i,k,j) = t(i,k,j) - dts*msfty(i,j)*(              &amp;<a name='1398'>
                          <font color=#447700>! multiplication by mx needed for RHS terms 1 &amp; 2<a name='1399'></font>
                          msftx(i,j)*(                     &amp;<a name='1400'>
               .5*rdy*                                     &amp;<a name='1401'>
              ( v(i,k,j+1)*(t_1(i,k,j+1)+t_1(i,k, j ))     &amp;<a name='1402'>
               -v(i,k,j  )*(t_1(i,k, j )+t_1(i,k,j-1)) )   &amp;<a name='1403'>
             + .5*rdx*                                     &amp;<a name='1404'>
              ( u(i+1,k,j)*(t_1(i+1,k,j)+t_1(i  ,k,j))     &amp;<a name='1405'>
               -u(i  ,k,j)*(t_1(i  ,k,j)+t_1(i-1,k,j)) ) ) &amp;<a name='1406'>
             + rdnw(k)*( wdtn(i,k+1)-wdtn(i,k) ) )       <a name='1407'>
     ENDDO<a name='1408'>
     ENDDO<a name='1409'>
<a name='1410'>
   ENDDO<a name='1411'>
<a name='1412'>
END SUBROUTINE advance_mu_t<a name='1413'>
          <a name='1414'>
<a name='1415'>
<a name='1416'>
<font color=#447700>!------------------------------------------------------------<a name='1417'></font>
<a name='1418'>
<A NAME='ADVANCE_W'><A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1419'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advance_w</font>( w, rw_tend, ww, w_save, u, v,  &amp; <A href='../../call_to/ADVANCE_W.html' TARGET='index'>1</A><a name='1420'>
                      mu1, mut, muave, muts,      &amp;<a name='1421'>
                      c1h, c2h, c1f, c2f,         &amp;<a name='1422'>
                      c3h, c4h, c3f, c4f,         &amp;<a name='1423'>
                      t_2ave, t_2, t_1,           &amp;<a name='1424'>
                      ph, ph_1, phb, ph_tend,     &amp;<a name='1425'>
                      ht, c2a, cqw, alt, alb,     &amp;<a name='1426'>
                      a, alpha, gamma,            &amp;<a name='1427'>
                      rdx, rdy, dts, t0, epssm,   &amp;<a name='1428'>
                      dnw, fnm, fnp, rdnw, rdn,   &amp;<a name='1429'>
                      cf1, cf2, cf3, msftx, msfty,&amp;<a name='1430'>
                      config_flags, top_lid,      &amp;<a name='1431'>
                      ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1432'></font>
                      ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1433'></font>
                      its,ite, jts,jte, kts,kte  )  <font color=#447700>! tile   dims<a name='1434'></font>
<a name='1435'>
<font color=#447700>! We have used msfty for msft_inv but have not thought through w equation<a name='1436'></font>
<font color=#447700>! pieces properly yet, so we will have to hope that it is okay<a name='1437'></font>
<font color=#447700>! We think we have found a slight error in surface w calculation<a name='1438'></font>
<a name='1439'>
  IMPLICIT NONE <font color=#447700>! religion first<a name='1440'></font>
      <a name='1441'>
<font color=#447700>! stuff coming in<a name='1442'></font>
<a name='1443'>
<a name='1444'>
  TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1445'>
<a name='1446'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='1447'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='1448'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='1449'>
<a name='1450'>
  LOGICAL,      INTENT(IN   )    :: top_lid<a name='1451'>
<a name='1452'>
      REAL, DIMENSION( ims:ime , kms:kme , jms:jme ), &amp;<a name='1453'>
            INTENT(INOUT) ::                          &amp;<a name='1454'>
                                             t_2ave,  &amp;<a name='1455'>
                                             w,       &amp;<a name='1456'>
                                             ph<a name='1457'>
<a name='1458'>
      REAL, DIMENSION(  ims:ime , kms:kme, jms:jme ), &amp;<a name='1459'>
            INTENT(IN   ) ::                          &amp;<a name='1460'>
                                             rw_tend, &amp;<a name='1461'>
                                             ww,      &amp;<a name='1462'>
                                             w_save,  &amp;<a name='1463'>
                                             u,       &amp;<a name='1464'>
                                             v,       &amp;<a name='1465'>
                                             t_2,     &amp;<a name='1466'>
                                             t_1,     &amp;<a name='1467'>
                                             ph_1,    &amp;<a name='1468'>
                                             phb,     &amp;<a name='1469'>
                                             ph_tend, &amp;<a name='1470'>
                                             alpha,   &amp;<a name='1471'>
                                             gamma,   &amp;<a name='1472'>
                                             a,       &amp;<a name='1473'>
                                             c2a,     &amp;<a name='1474'>
                                             cqw,     &amp;<a name='1475'>
                                             alb,     &amp;<a name='1476'>
                                             alt<a name='1477'>
<a name='1478'>
      REAL, DIMENSION( ims:ime , jms:jme ), &amp;<a name='1479'>
            INTENT(IN   )  ::               &amp;<a name='1480'>
                                   mu1,     &amp;<a name='1481'>
                                   mut,     &amp;<a name='1482'>
                                   muave,   &amp;<a name='1483'>
                                   muts,    &amp;<a name='1484'>
                                   ht,      &amp;<a name='1485'>
                                   msftx,   &amp;<a name='1486'>
                                   msfty<a name='1487'>
<a name='1488'>
      REAL, DIMENSION( kms:kme ),  INTENT(IN   )  :: fnp,     &amp;<a name='1489'>
                                                     fnm,     &amp;<a name='1490'>
                                                     rdnw,    &amp;<a name='1491'>
                                                     rdn,     &amp;<a name='1492'>
                                                     dnw<a name='1493'>
<a name='1494'>
      REAL,   INTENT(IN   )  :: rdx,     &amp;<a name='1495'>
                                rdy,     &amp;<a name='1496'>
                                dts,     &amp;<a name='1497'>
                                cf1,     &amp;<a name='1498'>
                                cf2,     &amp;<a name='1499'>
                                cf3,     &amp;<a name='1500'>
                                t0,      &amp;<a name='1501'>
                                epssm<a name='1502'>
<a name='1503'>
      REAL, DIMENSION( kms:kme ),INTENT(IN   ) :: c1h, c2h, c1f, c2f, &amp;<a name='1504'>
                                                  c3h, c4h, c3f, c4f<a name='1505'>
<a name='1506'>
<font color=#447700>!  Stack based 3d data, tile size.<a name='1507'></font>
<a name='1508'>
      REAL, DIMENSION( its:ite ) :: mut_inv, msft_inv<a name='1509'>
      REAL, DIMENSION( its:ite, kts:kte ) :: rhs, wdwn<a name='1510'>
      INTEGER :: i,j,k, i_start, i_end, j_start, j_end, k_start, k_end<a name='1511'>
      REAL, DIMENSION (kts:kte) :: dampwt<a name='1512'>
      real :: htop,hbot,hdepth,hk<a name='1513'>
      real    :: pi,dampmag<a name='1514'>
      REAL :: muthk, muthkm1<a name='1515'>
<a name='1516'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1517'></font>
<font color=#447700>!<a name='1518'></font>
<font color=#447700>!  advance_w advances the implicit w and geopotential equations.<a name='1519'></font>
<font color=#447700>!<a name='1520'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1521'></font>
<a name='1522'>
<font color=#447700>!  set loop limits.<a name='1523'></font>
<font color=#447700>!  Currently set for periodic boundary conditions<a name='1524'></font>
<a name='1525'>
      i_start = its<a name='1526'>
      i_end   = min(ite,ide-1)<a name='1527'>
      j_start = jts<a name='1528'>
      j_end   = min(jte,jde-1)<a name='1529'>
      k_start = kts<a name='1530'>
      k_end   = kte-1<a name='1531'>
      IF ( .NOT. config_flags%periodic_x )THEN<a name='1532'>
         IF ( config_flags%specified .or. config_flags%nested ) then<a name='1533'>
           i_start = max(its,ids+1)<a name='1534'>
           i_end   = min(ite,ide-2)<a name='1535'>
         ENDIF<a name='1536'>
      ENDIF<a name='1537'>
      IF ( config_flags%specified .or. config_flags%nested ) then<a name='1538'>
         j_start = max(jts,jds+1)<a name='1539'>
         j_end   = min(jte,jde-2)<a name='1540'>
      ENDIF<a name='1541'>
<a name='1542'>
   pi = 4.*atan(1.)<a name='1543'>
   dampmag = dts*config_flags%dampcoef<a name='1544'>
   hdepth=config_flags%zdamp<a name='1545'>
<a name='1546'>
<font color=#447700>! calculation of phi and w equations<a name='1547'></font>
<a name='1548'>
<font color=#447700>!   Comments on map scale factors:<a name='1549'></font>
<font color=#447700>!   phi equation is:<a name='1550'></font>
<font color=#447700>!    partial d/dt(rho phi/my) = -mx partial d/dx(phi rho u/my) <a name='1551'></font>
<font color=#447700>!                               -mx partial d/dy(phi rho v/mx)<a name='1552'></font>
<font color=#447700>!                               - partial d/dz(phi rho w/my) + rho g w/my<a name='1553'></font>
<font color=#447700>!   as with scalar equation, use uncoupled value (here phi) to find the<a name='1554'></font>
<font color=#447700>!   coupled tendency (rho phi/my)<a name='1555'></font>
<font color=#447700>!   here as usual rho -&gt; ~'mu'<a name='1556'></font>
<font color=#447700>!<a name='1557'></font>
<font color=#447700>!   w eqn [divided by my] is:<a name='1558'></font>
<font color=#447700>!     partial d/dt(rho w/my) = -mx partial d/dx(w rho u/my)<a name='1559'></font>
<font color=#447700>!                              -mx partial d/dy(v rho v/mx)<a name='1560'></font>
<font color=#447700>!                              - partial d/dz(w rho w/my)<a name='1561'></font>
<font color=#447700>!                              +rho[(u*u+v*v)/a + 2 u omega cos(lat) -<a name='1562'></font>
<font color=#447700>!                                   (1/rho) partial dp/dz - g + Fz]/my<a name='1563'></font>
<font color=#447700>!   here as usual rho -&gt; ~'mu'<a name='1564'></font>
<font color=#447700>!<a name='1565'></font>
<font color=#447700>!  'u,v,w' sent here must be coupled variables (= rho w/my etc.) by their usage<a name='1566'></font>
<a name='1567'>
<a name='1568'>
    DO i=i_start, i_end<a name='1569'>
      rhs(i,1) = 0.<a name='1570'>
    ENDDO<a name='1571'>
<a name='1572'>
  j_loop_w:  DO j = j_start, j_end<a name='1573'>
    DO i=i_start, i_end<a name='1574'>
       msft_inv(i) = 1./msfty(i,j)<a name='1575'>
    ENDDO<a name='1576'>
<a name='1577'>
    DO k=1, k_end<a name='1578'>
    DO i=i_start, i_end<a name='1579'>
      t_2ave(i,k,j)=.5*((1.+epssm)*t_2(i,k,j)       &amp;<a name='1580'>
                    +(1.-epssm)*t_2ave(i,k,j))<a name='1581'>
      t_2ave(i,k,j)=(t_2ave(i,k,j) + Muave(i,j)*t0) &amp;<a name='1582'>
                    /(Muts(i,j)*(t0+t_1(i,k,j)))<a name='1583'>
      wdwn(i,k+1)=.5*(ww(i,k+1,j)+ww(i,k,j))*rdnw(k)    &amp;<a name='1584'>
           *(ph_1(i,k+1,j)-ph_1(i,k,j)+phb(i,k+1,j)-phb(i,k,j))<a name='1585'>
      rhs(i,k+1) = dts*(ph_tend(i,k+1,j) + .5*g*(1.-epssm)*w(i,k+1,j))<a name='1586'>
<a name='1587'>
    ENDDO<a name='1588'>
    ENDDO<a name='1589'>
<a name='1590'>
<font color=#447700>!   building up RHS of phi equation<a name='1591'></font>
<font color=#447700>!   ph_tend contains terms 1 and 2; now adding 3 and 4 in stages:<a name='1592'></font>
<font color=#447700>!   here rhs = delta t [ph_tend + ~g*w/2 - ~ww * partial d phi/dz]<a name='1593'></font>
    DO k=2,k_end<a name='1594'>
    DO i=i_start, i_end<a name='1595'>
       rhs(i,k) = rhs(i,k)-dts*( fnm(k)*wdwn(i,k+1)  &amp;<a name='1596'>
                                +fnp(k)*wdwn(i,k  ) )<a name='1597'>
    ENDDO<a name='1598'>
    ENDDO<a name='1599'>
<a name='1600'>
<font color=#447700>!  NOTE:  phi'' is not coupled with the map-scale factor  (1/m), <a name='1601'></font>
<font color=#447700>!         but it's tendency is, so must multiply by msft here<a name='1602'></font>
<a name='1603'>
<font color=#447700>!   Comments on map scale factors:<a name='1604'></font>
<font color=#447700>!   building up RHS of phi equation<a name='1605'></font>
<font color=#447700>!   ph_tend contains terms 1 and 2; now adding 3 and 4 in stages:<a name='1606'></font>
<font color=#447700>!   here rhs = ph_previous + (msft/mu)*[rhs_previous - ~ww * delta t * <a name='1607'></font>
<font color=#447700>!                                                      partial d phi/dz]<a name='1608'></font>
<font color=#447700>!            = ph_previous + (msft*delta t/mu)*[ph_tend + ~g*w/2 - ~ww *<a name='1609'></font>
<font color=#447700>!                                                         partial d phi/dz]<a name='1610'></font>
    DO k=2,k_end+1<a name='1611'>
    DO i=i_start, i_end<a name='1612'>
      rhs(i,k) = ph(i,k,j) + msfty(i,j)*rhs(i,k)/mut(i,j)<a name='1613'>
      if(top_lid .and. k.eq.k_end+1)rhs(i,k)=0.<a name='1614'>
    ENDDO<a name='1615'>
    ENDDO<a name='1616'>
<a name='1617'>
<font color=#447700>!  lower boundary condition on w<a name='1618'></font>
<a name='1619'>
<font color=#447700>!   Comments on map scale factors:<a name='1620'></font>
<font color=#447700>!   Chain rule: if Z=Z(X,Y) [true at the surface] then<a name='1621'></font>
<font color=#447700>!      dZ/dt = dZ/dX * dX/dt + dZ/dY * dY/dt, U=dX/dt, V=dY/dt<a name='1622'></font>
<font color=#447700>!   using capitals to denote actual values<a name='1623'></font>
<font color=#447700>!   In mapped values, u=U, v=V, z=Z, 1/dX=mx/dx, 1/dY=my/dy<a name='1624'></font>
<font color=#447700>!      w = dz/dt = mx u dz/dx + my v dz/dy<a name='1625'></font>
<font color=#447700>!   [where dz/dx is just the surface height change between x<a name='1626'></font>
<font color=#447700>!    gridpoints, and dz/dy is the change between y gridpoints]<a name='1627'></font>
<font color=#447700>!   [cf1, cf2 and cf3 do vertical weighting of u or v values nearest<a name='1628'></font>
<font color=#447700>!    the surface]<a name='1629'></font>
<a name='1630'>
    DO i=i_start, i_end<a name='1631'>
       w(i,1,j)=                                           &amp;<a name='1632'>
<a name='1633'>
                msfty(i,j)*.5*rdy*(                        &amp;<a name='1634'>
                         (ht(i,j+1)-ht(i,j  ))             &amp;<a name='1635'>
        *(cf1*v(i,1,j+1)+cf2*v(i,2,j+1)+cf3*v(i,3,j+1))    &amp;<a name='1636'>
                        +(ht(i,j  )-ht(i,j-1))             &amp;<a name='1637'>
        *(cf1*v(i,1,j  )+cf2*v(i,2,j  )+cf3*v(i,3,j  ))  ) &amp;<a name='1638'>
<a name='1639'>
               +msftx(i,j)*.5*rdx*(                        &amp;<a name='1640'>
                         (ht(i+1,j)-ht(i,j  ))             &amp;<a name='1641'>
        *(cf1*u(i+1,1,j)+cf2*u(i+1,2,j)+cf3*u(i+1,3,j))    &amp;<a name='1642'>
                        +(ht(i,j  )-ht(i-1,j))             &amp;<a name='1643'>
        *(cf1*u(i  ,1,j)+cf2*u(i  ,2,j)+cf3*u(i  ,3,j))  ) <a name='1644'>
<a name='1645'>
     ENDDO<a name='1646'>
<font color=#447700>!<a name='1647'></font>
<font color=#447700>! Jammed 3 doubly nested loops over k/i into 1 for slight improvement<a name='1648'></font>
<font color=#447700>! in efficiency.  No change in results (bit-for-bit). JM 20040514<a name='1649'></font>
<font color=#447700>! (left a blank line where the other two k/i-loops were)<a name='1650'></font>
<font color=#447700>!<a name='1651'></font>
<font color=#447700>!   above surface, begin by adding delta t * previous (coupled) w tendency<a name='1652'></font>
    DO k=2,k_end<a name='1653'>
      DO i=i_start, i_end<a name='1654'>
#if <font color=#447700>! ( HYBRID_COORD==1 ) <a name='1655'></font>
        MUTHK   = mut(i,j)<a name='1656'>
        MUTHKM1 = mut(i,j)<a name='1657'>
#endif<a name='1658'>
        <a name='1659'>
        w(i,k,j)=w(i,k,j)+dts*rw_tend(i,k,j)                       &amp;<a name='1660'>
                 + msft_inv(i)*cqw(i,k,j)*(                        &amp;<a name='1661'>
            +.5*dts*g*rdn(k)*                                      &amp;<a name='1662'>
             (c2a(i,k  ,j)*rdnw(k  )/MUTHK                         &amp;<a name='1663'>
        *((1.+epssm)*(rhs(i,k+1  )-rhs(i,k    ))                   &amp;<a name='1664'>
         +(1.-epssm)*(ph(i,k+1,j)-ph(i,k  ,j)))                    &amp;<a name='1665'>
             -c2a(i,k-1,j)*rdnw(k-1)/MUTHKM1                       &amp;<a name='1666'>
        *((1.+epssm)*(rhs(i,k    )-rhs(i,k-1  ))                   &amp;<a name='1667'>
         +(1.-epssm)*(ph(i,k  ,j)-ph(i,k-1,j)))))                  &amp;<a name='1668'>
<a name='1669'>
                +dts*g*msft_inv(i)*(rdn(k)*                        &amp;<a name='1670'>
             (c2a(i,k  ,j)*alt(i,k  ,j)*t_2ave(i,k  ,j)            &amp;<a name='1671'>
             -c2a(i,k-1,j)*alt(i,k-1,j)*t_2ave(i,k-1,j))           &amp;<a name='1672'>
              - muave(i,j))<a name='1673'>
      ENDDO<a name='1674'>
    ENDDO<a name='1675'>
<a name='1676'>
    K=k_end+1<a name='1677'>
<a name='1678'>
    DO i=i_start, i_end<a name='1679'>
#if <font color=#447700>! ( HYBRID_COORD==1 ) <a name='1680'></font>
       MUTHKM1 = mut(i,j)<a name='1681'>
#endif<a name='1682'>
       w(i,k,j)=w(i,k,j)+dts*rw_tend(i,k,j)                         &amp;<a name='1683'>
           +msft_inv(i)*(                                        &amp;<a name='1684'>
         -.5*dts*g/MUTHKM1*rdnw(k-1)**2*2.*c2a(i,k-1,j)            &amp;<a name='1685'>
             *((1.+epssm)*(rhs(i,k  )-rhs(i,k-1  ))                 &amp;<a name='1686'>
              +(1.-epssm)*(ph(i,k,j)-ph(i,k-1,j)))                  &amp;<a name='1687'>
         -dts*g*(2.*rdnw(k-1)*                                      &amp;<a name='1688'>
                   c2a(i,k-1,j)*alt(i,k-1,j)*t_2ave(i,k-1,j)        &amp;<a name='1689'>
              + muave(i,j)) )<a name='1690'>
       if(top_lid)w(i,k,j) = 0.<a name='1691'>
    ENDDO<a name='1692'>
<a name='1693'>
    DO k=2,k_end+1<a name='1694'>
    DO i=i_start, i_end<a name='1695'>
       w(i,k,j)=(w(i,k,j)-a(i,k,j)*w(i,k-1,j))*alpha(i,k,j)<a name='1696'>
    ENDDO<a name='1697'>
    ENDDO<a name='1698'>
<a name='1699'>
    DO k=k_end,2,-1<a name='1700'>
    DO i=i_start, i_end<a name='1701'>
       w (i,k,j)=w (i,k,j)-gamma(i,k,j)*w(i,k+1,j)<a name='1702'>
    ENDDO<a name='1703'>
    ENDDO<a name='1704'>
<a name='1705'>
    IF (config_flags%damp_opt .eq. 3) THEN<a name='1706'>
      DO k=k_end+1,2,-1<a name='1707'>
      DO i=i_start, i_end<a name='1708'>
          htop=(ph_1(i,k_end+1,j)+phb(i,k_end+1,j))/g<a name='1709'>
          hk=(ph_1(i,k,j)+phb(i,k,j))/g<a name='1710'>
          hbot=htop-hdepth<a name='1711'>
          dampwt(k) = 0.<a name='1712'>
          if(hk .ge. hbot)then<a name='1713'>
            dampwt(k) = dampmag*sin(0.5*pi*(hk-hbot)/hdepth)*sin(0.5*pi*(hk-hbot)/hdepth)<a name='1714'>
          endif<a name='1715'>
          w(i,k,j) = (w(i,k,j) - dampwt(k)*mut(i,j)*w_save(i,k,j))/(1.+dampwt(k))<a name='1716'>
      ENDDO<a name='1717'>
      ENDDO<a name='1718'>
    ENDIF<a name='1719'>
<a name='1720'>
    DO k=k_end+1,2,-1<a name='1721'>
    DO i=i_start, i_end<a name='1722'>
       ph(i,k,j) = rhs(i,k)+msfty(i,j)*.5*dts*g*(1.+epssm) &amp;<a name='1723'>
                      *w(i,k,j)/muts(i,j)<a name='1724'>
    ENDDO<a name='1725'>
    ENDDO<a name='1726'>
<a name='1727'>
  ENDDO j_loop_w<a name='1728'>
<a name='1729'>
END SUBROUTINE advance_w<a name='1730'>
<a name='1731'>
<font color=#447700>!---------------------------------------------------------------------<a name='1732'></font>
<a name='1733'>
<A NAME='SUMFLUX'><A href='../../html_code/dyn_em/module_small_step_em.F.html#SUMFLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1734'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>sumflux</font> ( ru, rv, ww,                             &amp; <A href='../../call_to/SUMFLUX.html' TARGET='index'>1</A><a name='1735'>
                     u_lin, v_lin, ww_lin,                   &amp;<a name='1736'>
                     muu, muv,                               &amp;<a name='1737'>
                     c1h, c2h, c1f, c2f,                     &amp;<a name='1738'>
                     c3h, c4h, c3f, c4f,                     &amp;<a name='1739'>
                     ru_m, rv_m, ww_m, epssm,                &amp;<a name='1740'>
                     msfux, msfuy, msfvx, msfvx_inv, msfvy,  &amp;<a name='1741'>
                     iteration , number_of_small_timesteps,  &amp;<a name='1742'>
                     ids,ide, jds,jde, kds,kde,              &amp;<a name='1743'>
                     ims,ime, jms,jme, kms,kme,              &amp;<a name='1744'>
                     its,ite, jts,jte, kts,kte              )<a name='1745'>
<a name='1746'>
<a name='1747'>
  IMPLICIT NONE  <font color=#447700>! religion first<a name='1748'></font>
<a name='1749'>
<font color=#447700>! declarations for the stuff coming in<a name='1750'></font>
<a name='1751'>
  INTEGER,      INTENT(IN   )    :: number_of_small_timesteps<a name='1752'>
  INTEGER,      INTENT(IN   )    :: iteration<a name='1753'>
  INTEGER,      INTENT(IN   )    :: ids,ide, jds,jde, kds,kde<a name='1754'>
  INTEGER,      INTENT(IN   )    :: ims,ime, jms,jme, kms,kme<a name='1755'>
  INTEGER,      INTENT(IN   )    :: its,ite, jts,jte, kts,kte<a name='1756'>
<a name='1757'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme),  INTENT(IN   ) :: ru, &amp;<a name='1758'>
                                                                rv, &amp;<a name='1759'>
                                                                ww, &amp;<a name='1760'>
                                                                u_lin,  &amp;<a name='1761'>
                                                                v_lin,  &amp;<a name='1762'>
                                                                ww_lin<a name='1763'>
<a name='1764'>
<a name='1765'>
  REAL, DIMENSION(ims:ime, kms:kme, jms:jme) , INTENT(INOUT) :: ru_m, &amp;<a name='1766'>
                                                                rv_m, &amp;<a name='1767'>
                                                                ww_m<a name='1768'>
  REAL, DIMENSION(ims:ime, jms:jme) , INTENT(IN   ) :: muu, muv,      &amp;<a name='1769'>
                                                       msfux, msfuy,  &amp;<a name='1770'>
                                                       msfvx, msfvy, msfvx_inv<a name='1771'>
<a name='1772'>
  REAL, DIMENSION( kms:kme ),INTENT(IN   ) :: c1h, c2h, c1f, c2f, &amp;<a name='1773'>
                                              c3h, c4h, c3f, c4f<a name='1774'>
<a name='1775'>
  INTEGER :: mini, minj, mink<a name='1776'>
<a name='1777'>
<a name='1778'>
  REAL, INTENT(IN   )  ::  epssm<a name='1779'>
  INTEGER   :: i,j,k<a name='1780'>
<a name='1781'>
<a name='1782'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1783'></font>
<font color=#447700>!<a name='1784'></font>
<font color=#447700>!  update the small-timestep time-averaged mass fluxes;  these<a name='1785'></font>
<font color=#447700>!  are needed for consistent mass-conserving scalar advection.<a name='1786'></font>
<font color=#447700>!<a name='1787'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1788'></font>
<a name='1789'>
    IF (iteration == 1 )THEN<a name='1790'>
      DO  j = jts, jte<a name='1791'>
      DO  k = kts, kte<a name='1792'>
      DO  i = its, ite<a name='1793'>
        ru_m(i,k,j)  = 0.<a name='1794'>
        rv_m(i,k,j)  = 0.<a name='1795'>
        ww_m(i,k,j)  = 0.<a name='1796'>
      ENDDO<a name='1797'>
      ENDDO<a name='1798'>
      ENDDO<a name='1799'>
    ENDIF<a name='1800'>
<a name='1801'>
  mini = min(ide-1,ite)<a name='1802'>
  minj = min(jde-1,jte)<a name='1803'>
  mink = min(kde-1,kte)<a name='1804'>
<a name='1805'>
<a name='1806'>
    DO  j = jts, minj<a name='1807'>
    DO  k = kts, mink<a name='1808'>
    DO  i = its, mini<a name='1809'>
      ru_m(i,k,j)  = ru_m(i,k,j) + ru(i,k,j)<a name='1810'>
      rv_m(i,k,j)  = rv_m(i,k,j) + rv(i,k,j)<a name='1811'>
      ww_m(i,k,j)  = ww_m(i,k,j) + ww(i,k,j)<a name='1812'>
    ENDDO<a name='1813'>
    ENDDO<a name='1814'>
    ENDDO<a name='1815'>
 <a name='1816'>
    IF (ite .GT. mini) THEN<a name='1817'>
      DO  j = jts, minj<a name='1818'>
      DO  k = kts, mink<a name='1819'>
      DO  i = mini+1, ite<a name='1820'>
        ru_m(i,k,j)  = ru_m(i,k,j) + ru(i,k,j)<a name='1821'>
      ENDDO<a name='1822'>
      ENDDO<a name='1823'>
      ENDDO<a name='1824'>
    END IF<a name='1825'>
    IF (jte .GT. minj) THEN<a name='1826'>
      DO  j = minj+1, jte<a name='1827'>
      DO  k = kts, mink<a name='1828'>
      DO  i = its, mini<a name='1829'>
	rv_m(i,k,j)  = rv_m(i,k,j) + rv(i,k,j)<a name='1830'>
      ENDDO<a name='1831'>
      ENDDO<a name='1832'>
      ENDDO<a name='1833'>
    END IF<a name='1834'>
    IF ( kte .GT. mink) THEN<a name='1835'>
      DO  j = jts, minj<a name='1836'>
      DO  k = mink+1, kte<a name='1837'>
      DO  i = its, mini<a name='1838'>
        ww_m(i,k,j)  = ww_m(i,k,j) + ww(i,k,j)<a name='1839'>
      ENDDO<a name='1840'>
      ENDDO<a name='1841'>
      ENDDO<a name='1842'>
    END IF<a name='1843'>
<a name='1844'>
  IF (iteration == number_of_small_timesteps) THEN<a name='1845'>
<a name='1846'>
    DO  j = jts, minj<a name='1847'>
    DO  k = kts, mink<a name='1848'>
    DO  i = its, mini<a name='1849'>
      ru_m(i,k,j)  = ru_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1850'>
                     + muu(i,j)*u_lin(i,k,j)/msfuy(i,j)<a name='1851'>
      rv_m(i,k,j)  = rv_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1852'>
                     + muv(i,j)*v_lin(i,k,j)*msfvx_inv(i,j) <a name='1853'>
      ww_m(i,k,j)  = ww_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1854'>
                     + ww_lin(i,k,j) <a name='1855'>
    ENDDO<a name='1856'>
    ENDDO<a name='1857'>
    ENDDO<a name='1858'>
<a name='1859'>
<a name='1860'>
    IF (ite .GT. mini) THEN<a name='1861'>
      DO  j = jts, minj<a name='1862'>
      DO  k = kts, mink<a name='1863'>
      DO  i = mini+1, ite<a name='1864'>
        ru_m(i,k,j)  = ru_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1865'>
                     + muu(i,j)*u_lin(i,k,j)/msfuy(i,j)<a name='1866'>
      ENDDO<a name='1867'>
      ENDDO<a name='1868'>
      ENDDO<a name='1869'>
    END IF<a name='1870'>
    IF (jte .GT. minj) THEN<a name='1871'>
      DO  j = minj+1, jte<a name='1872'>
      DO  k = kts, mink<a name='1873'>
      DO  i = its, mini<a name='1874'>
	rv_m(i,k,j)  = rv_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1875'>
                     + muv(i,j)*v_lin(i,k,j)*msfvx_inv(i,j)<a name='1876'>
      ENDDO<a name='1877'>
      ENDDO<a name='1878'>
      ENDDO<a name='1879'>
    END IF<a name='1880'>
    IF ( kte .GT. mink) THEN<a name='1881'>
      DO  j = jts, minj<a name='1882'>
      DO  k = mink+1, kte<a name='1883'>
      DO  i = its, mini<a name='1884'>
        ww_m(i,k,j)  = ww_m(i,k,j) / number_of_small_timesteps   &amp;<a name='1885'>
                     + ww_lin(i,k,j)<a name='1886'>
      ENDDO<a name='1887'>
      ENDDO<a name='1888'>
      ENDDO<a name='1889'>
    END IF<a name='1890'>
<a name='1891'>
  ENDIF<a name='1892'>
<a name='1893'>
<a name='1894'>
END SUBROUTINE sumflux <a name='1895'>
<a name='1896'>
<font color=#447700>!---------------------------------------------------------------------<a name='1897'></font>
<a name='1898'>
<A NAME='INIT_MODULE_SMALL_STEP'><A href='../../html_code/dyn_em/module_small_step_em.F.html#INIT_MODULE_SMALL_STEP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1899'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_module_small_step</font><a name='1900'>
  END SUBROUTINE init_module_small_step<a name='1901'>
<a name='1902'>
END MODULE module_small_step_em<a name='1903'>
</pre></body></html>