<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( HYBRID_COORD==1 ) <a name='2'>
#  define mub(...) (c1(k)*XXPCBXX(__VA_ARGS__)+c2(k))<a name='3'>
#  define XXPCBXX(...) mub(__VA_ARGS__)<a name='4'>
<a name='5'>
#  define mut(...) (c1(k)*XXPCTXX(__VA_ARGS__)+c2(k))<a name='6'>
#  define XXPCTXX(...) mut(__VA_ARGS__)<a name='7'>
<a name='8'>
#  define mu_old(...) (c1(k)*XXPCOLDXX(__VA_ARGS__))<a name='9'>
#  define XXPCOLDXX(...) mu_old(__VA_ARGS__)<a name='10'>
#endif<a name='11'>
<a name='12'>
<font color=#447700>!WRF:MODEL_LAYER:DYNAMICS<a name='13'></font>
<font color=#447700>!<a name='14'></font>
#if ( defined(ADVECT_KERNEL) )<a name='15'>
<font color=#447700>! cpp -traditional -C -P -DADVECT_KERNEL module_advect_em.F &gt; advection_kernel.f90<a name='16'></font>
<font color=#447700>! gfortran -ffree-form -ffree-line-length-none advection_kernel.f90<a name='17'></font>
<font color=#447700>! ./a.out<a name='18'></font>
<A NAME='ADVECTION_KERNEL'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECTION_KERNEL' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='19'>
<font color=#993300>MODULE </font><font color=#cc0000>advection_kernel</font> <A href='../../call_to/ADVECTION_KERNEL.html' TARGET='index'>1</A><a name='20'>
   TYPE grid_config_rec_type<a name='21'>
      INTEGER :: scalar_adv_opt = 0<a name='22'>
      INTEGER :: h_sca_adv_order = 5<a name='23'>
      INTEGER :: v_sca_adv_order = 3<a name='24'>
      LOGICAL :: periodic_x = .false.<a name='25'>
      LOGICAL :: periodic_y = .false.<a name='26'>
      LOGICAL :: symmetric_xs = .false.<a name='27'>
      LOGICAL :: symmetric_xe = .false.<a name='28'>
      LOGICAL :: symmetric_ys = .false.<a name='29'>
      LOGICAL :: symmetric_ye = .false.<a name='30'>
      LOGICAL :: open_xs = .false.<a name='31'>
      LOGICAL :: open_xe = .false.<a name='32'>
      LOGICAL :: open_ys = .false.<a name='33'>
      LOGICAL :: open_ye = .false.<a name='34'>
      LOGICAL :: specified = .true.<a name='35'>
      LOGICAL :: nested = .false.<a name='36'>
      LOGICAL :: polar = .false.<a name='37'>
   END TYPE grid_config_rec_type<a name='38'>
   CHARACTER (LEN=256) :: wrf_err_message<a name='39'>
CONTAINS<a name='40'>
<font color=#447700>!----------------------------------------------------------------<a name='41'></font>
<A NAME='WRF_ERROR_FATAL'><A href='../../html_code/dyn_em/module_advect_em.F.html#WRF_ERROR_FATAL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='42'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>wrf_error_fatal</font> ( message ) <A href='../../call_to/WRF_ERROR_FATAL.html' TARGET='index'>1502</A>,<A href='../../call_from/WRF_ERROR_FATAL.html' TARGET='index'>2</A><a name='43'>
   IMPLICIT NONE<a name='44'>
   CHARACTER(LEN=*) , INTENT(IN) :: message<a name='45'>
   PRINT *,'advect_scalar_pd: FATAL MESSAGE = ',TRIM(message)<a name='46'>
   STOP 12345<a name='47'>
END SUBROUTINE wrf_error_fatal<a name='48'>
<font color=#447700>!----------------------------------------------------------------<a name='49'></font>
<A NAME='INIT'><A href='../../html_code/dyn_em/module_advect_em.F.html#INIT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='50'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>init</font> ( config_flags ) <A href='../../call_to/INIT.html' TARGET='index'>1</A><a name='51'>
   IMPLICIT NONE<a name='52'>
   TYPE (grid_config_rec_type) :: config_flags<a name='53'>
   config_flags%h_sca_adv_order = 5<a name='54'>
   config_flags%v_sca_adv_order = 3<a name='55'>
   config_flags%periodic_x = .true.<a name='56'>
   config_flags%periodic_y = .true.<a name='57'>
   config_flags%symmetric_xs = .false.<a name='58'>
   config_flags%symmetric_xe = .false.<a name='59'>
   config_flags%symmetric_ys = .false.<a name='60'>
   config_flags%symmetric_ye = .false.<a name='61'>
   config_flags%open_xs = .false.<a name='62'>
   config_flags%open_xe = .false.<a name='63'>
   config_flags%open_ys = .false.<a name='64'>
   config_flags%open_ye = .false.<a name='65'>
   config_flags%specified = .false.<a name='66'>
   config_flags%nested = .false.<a name='67'>
END SUBROUTINE init<a name='68'>
<font color=#447700>!----------------------------------------------------------------<a name='69'></font>
<A NAME='TOPHAT'><A href='../../html_code/dyn_em/module_advect_em.F.html#TOPHAT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='70'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>tophat</font> ( field, num_scalars , &amp; <A href='../../call_to/TOPHAT.html' TARGET='index'>2</A><a name='71'>
                                ids, ide, jds, jde, kds, kde, &amp;<a name='72'>
                                ims, ime, jms, jme, kms, kme, &amp;<a name='73'>
                                its, ite, jts, jte, kts, kte )<a name='74'>
   IMPLICIT NONE<a name='75'>
   INTEGER , INTENT(IN ) :: num_scalars ,     ids, ide, jds, jde, kds, kde, &amp;<a name='76'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='77'>
                                              its, ite, jts, jte, kts, kte<a name='78'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme , num_scalars ) , INTENT(OUT) :: field<a name='79'>
   INTEGER :: i, j, k , n<a name='80'>
<a name='81'>
   field = 0<a name='82'>
<a name='83'>
   DO n = 1 , num_scalars<a name='84'>
   DO j = jts , jte<a name='85'>
   DO k = kts , kte<a name='86'>
   DO i = its , ite<a name='87'>
      IF ( i .gt. 35 .and. i.lt. 55 ) THEN<a name='88'>
         field (i,k,j,n) = 1.<a name='89'>
      END IF<a name='90'>
   END DO<a name='91'>
   END DO<a name='92'>
   END DO<a name='93'>
   END DO<a name='94'>
END SUBROUTINE tophat<a name='95'>
<font color=#447700>!----------------------------------------------------------------<a name='96'></font>
<A NAME='COLUMN'><A href='../../html_code/dyn_em/module_advect_em.F.html#COLUMN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='97'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>column</font> (loop , data_list, its,ite) <A href='../../call_to/COLUMN.html' TARGET='index'>5</A>,<A href='../../call_from/COLUMN.html' TARGET='index'>3</A><a name='98'>
   IMPLICIT NONE<a name='99'>
   INTEGER , INTENT(IN) :: loop, its, ite<a name='100'>
   REAL , INTENT(IN) , DIMENSION(its:ite) :: data_list<a name='101'>
   INTEGER , DIMENSION(its:ite) :: data_int<a name='102'>
   INTEGER :: i<a name='103'>
   CHARACTER (len = 10 ) :: filename<a name='104'>
<a name='105'>
   IF ( loop.EQ.0 ) THEN<a name='106'>
      OPEN (unit=7,file = "x_locations.txt" , &amp;<a name='107'>
      form = "formatted" , &amp;<a name='108'>
      access = "sequential" )<a name='109'>
      <a name='110'>
      DO i = its,ite<a name='111'>
         write (7,*) i<a name='112'>
      END DO<a name='113'>
      close (7)<a name='114'>
   END IF<a name='115'>
<a name='116'>
   WRITE(filename,fmt='(i6.6,".txt")') loop<a name='117'>
   OPEN (unit=7,file = filename , &amp;<a name='118'>
   form = "formatted" , &amp;<a name='119'>
   access = "sequential" )<a name='120'>
   <a name='121'>
   data_int = NINT(data_list * 100 )<a name='122'>
   DO i = its,ite<a name='123'>
      write (7,*) data_int(i)<a name='124'>
   END DO<a name='125'>
   close (7)<a name='126'>
   <a name='127'>
END SUBROUTINE column<a name='128'>
<font color=#447700>!----------------------------------------------------------------<a name='129'></font>
#elif ( <font color=#447700>! defined(ADVECT_KERNEL) )<a name='130'></font>
<a name='131'>
<A NAME='MODULE_ADVECT_EM'><A href='../../html_code/dyn_em/module_advect_em.F.html#MODULE_ADVECT_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='132'>
<font color=#993300>MODULE </font><font color=#cc0000>module_advect_em</font> <A href='../../call_to/MODULE_ADVECT_EM.html' TARGET='index'>1</A><a name='133'>
<a name='134'>
  USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/phys/module_ra_goddard.F.html#COLUMN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_2"><a name='135'>
  USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/phys/module_ra_goddard.F.html#COLUMN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_1"><a name='136'>
  USE <A href='../../html_code/frame/module_wrf_error.F.html#MODULE_WRF_ERROR'>module_wrf_error</A><A href='../../html_code/phys/module_ra_goddard.F.html#COLUMN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_WRF_ERROR_1"><a name='137'>
<a name='138'>
CONTAINS<a name='139'>
<a name='140'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='141'></font>
<a name='142'>
<A NAME='ADVECT_U'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_U' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='143'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_u</font>   ( u, u_old, tendency,            &amp; <A href='../../call_to/ADVECT_U.html' TARGET='index'>1</A>,<A href='../../call_from/ADVECT_U.html' TARGET='index'>2</A><a name='144'>
                        ru, rv, rom,                   &amp;<a name='145'>
                        c1, c2,                        &amp;<a name='146'>
                        mut, time_step, config_flags,  &amp;<a name='147'>
                        msfux, msfuy, msfvx, msfvy,    &amp;<a name='148'>
                        msftx, msfty,                  &amp;<a name='149'>
                        fzm, fzp,                      &amp;<a name='150'>
                        rdx, rdy, rdzw,                &amp;<a name='151'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='152'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='153'>
                        its, ite, jts, jte, kts, kte  )<a name='154'>
<a name='155'>
   IMPLICIT NONE<a name='156'>
   <a name='157'>
   <font color=#447700>! Input data<a name='158'></font>
   <a name='159'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='160'>
<a name='161'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='162'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='163'>
                                              its, ite, jts, jte, kts, kte<a name='164'>
<a name='165'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: u,     &amp;<a name='166'>
                                                                      u_old, &amp;<a name='167'>
                                                                      ru,    &amp;<a name='168'>
                                                                      rv,    &amp;<a name='169'>
                                                                      rom<a name='170'>
<a name='171'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='172'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='173'>
<a name='174'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='175'>
                                                                    msfuy,  &amp;<a name='176'>
                                                                    msfvx,  &amp;<a name='177'>
                                                                    msfvy,  &amp;<a name='178'>
                                                                    msftx,  &amp;<a name='179'>
                                                                    msfty<a name='180'>
<a name='181'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='182'>
                                                                  fzp,  &amp;<a name='183'>
                                                                  rdzw, &amp;<a name='184'>
                                                                  c1,   &amp;<a name='185'>
                                                                  c2<a name='186'>
<a name='187'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='188'>
                                                                  rdy<a name='189'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='190'>
<a name='191'>
   <font color=#447700>! Local data<a name='192'></font>
   <a name='193'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='194'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='195'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='196'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax, im, ip<a name='197'>
   INTEGER :: jp1, jp0, jtmp<a name='198'>
<a name='199'>
   INTEGER :: horz_order, vert_order<a name='200'>
<a name='201'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, dvm, dvp<a name='202'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='203'>
<a name='204'>
<a name='205'>
   REAL,  DIMENSION( its-1:ite+1, kts:kte ) :: fqx<a name='206'>
   REAL,  DIMENSION( its:ite, kts:kte, 2) :: fqy<a name='207'>
   <a name='208'>
   LOGICAL :: degrade_xs, degrade_ys<a name='209'>
   LOGICAL :: degrade_xe, degrade_ye<a name='210'>
<a name='211'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='212'></font>
<a name='213'>
   REAL    :: flux3, flux4, flux5, flux6<a name='214'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='215'>
<a name='216'>
   flux4(q_im2, q_im1, q_i, q_ip1, ua) =                         &amp;<a name='217'>
          ( 7.*(q_i + q_im1) - (q_ip1 + q_im2) )/12.0<a name='218'>
<a name='219'>
   flux3(q_im2, q_im1, q_i, q_ip1, ua) =                         &amp;<a name='220'>
            flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='221'>
            sign(1,time_step)*sign(1.,ua)*((q_ip1 - q_im2)-3.*(q_i-q_im1))/12.0<a name='222'>
<a name='223'>
   flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =           &amp;<a name='224'>
                      ( 37.*(q_i+q_im1) - 8.*(q_ip1+q_im2)       &amp;<a name='225'>
                     +(q_ip2+q_im3) )/60.0<a name='226'>
<a name='227'>
   flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =           &amp;<a name='228'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)     &amp;<a name='229'>
            -sign(1,time_step)*sign(1.,ua)*(                     &amp;<a name='230'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )/60.0<a name='231'>
<a name='232'>
<a name='233'>
   LOGICAL :: specified<a name='234'>
<a name='235'>
   specified = .false.<a name='236'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='237'>
<a name='238'>
<font color=#447700>!  set order for vertical and horzontal flux operators<a name='239'></font>
<a name='240'>
   horz_order = config_flags%h_mom_adv_order<a name='241'>
   vert_order = config_flags%v_mom_adv_order<a name='242'>
<a name='243'>
   ktf=MIN(kte,kde-1)<a name='244'>
<a name='245'>
<font color=#447700>!  begin with horizontal flux divergence<a name='246'></font>
<a name='247'>
   horizontal_order_test : IF( horz_order == 6 ) THEN<a name='248'>
<a name='249'>
<font color=#447700>!  determine boundary mods for flux operators<a name='250'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='251'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='252'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='253'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='254'></font>
<font color=#447700>!   of the higher order flux stencils<a name='255'></font>
<a name='256'>
   degrade_xs = .true.<a name='257'>
   degrade_xe = .true.<a name='258'>
   degrade_ys = .true.<a name='259'>
   degrade_ye = .true.<a name='260'>
<a name='261'>
   IF( config_flags%periodic_x   .or. &amp;<a name='262'>
       config_flags%symmetric_xs .or. &amp;<a name='263'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='264'>
   IF( config_flags%periodic_x   .or. &amp;<a name='265'>
       config_flags%symmetric_xe .or. &amp;<a name='266'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='267'>
   IF( config_flags%periodic_y   .or. &amp;<a name='268'>
       config_flags%symmetric_ys .or. &amp;<a name='269'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='270'>
   IF( config_flags%periodic_y   .or. &amp;<a name='271'>
       config_flags%symmetric_ye .or. &amp;<a name='272'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='273'>
<a name='274'>
<font color=#447700>!--------------- y - advection first<a name='275'></font>
<a name='276'>
      i_start = its<a name='277'>
      i_end   = ite<a name='278'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='279'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='280'>
      IF ( config_flags%periodic_x ) i_start = its<a name='281'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='282'>
<a name='283'>
      j_start = jts<a name='284'>
      j_end   = MIN(jte,jde-1)<a name='285'>
<a name='286'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='287'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='288'></font>
<a name='289'>
      j_start_f = j_start<a name='290'>
      j_end_f   = j_end+1<a name='291'>
<a name='292'>
      IF(degrade_ys) then<a name='293'>
        j_start = MAX(jts,jds+1)<a name='294'>
        j_start_f = jds+3<a name='295'>
      ENDIF<a name='296'>
<a name='297'>
      IF(degrade_ye) then<a name='298'>
        j_end = MIN(jte,jde-2)<a name='299'>
        j_end_f = jde-3<a name='300'>
      ENDIF<a name='301'>
<a name='302'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='303'>
<a name='304'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='305'></font>
<a name='306'>
     jp1 = 2<a name='307'>
     jp0 = 1<a name='308'>
<a name='309'>
     j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='310'>
<a name='311'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN  <font color=#447700>! use full stencil<a name='312'></font>
<a name='313'>
        DO k=kts,ktf<a name='314'>
        DO i = i_start, i_end<a name='315'>
          vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='316'>
          fqy( i, k, jp1 ) = vel*flux6(               &amp;<a name='317'>
                  u(i,k,j-3), u(i,k,j-2), u(i,k,j-1),       &amp;<a name='318'>
                  u(i,k,j  ), u(i,k,j+1), u(i,k,j+2),  vel )<a name='319'>
        ENDDO<a name='320'>
        ENDDO<a name='321'>
<a name='322'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='323'></font>
<a name='324'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='325'></font>
<a name='326'>
            DO k=kts,ktf<a name='327'>
            DO i = i_start, i_end<a name='328'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))  &amp;<a name='329'>
                                     *(u(i,k,j)+u(i,k,j-1))<a name='330'>
            ENDDO<a name='331'>
            ENDDO<a name='332'>
<a name='333'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='334'></font>
<a name='335'>
            DO k=kts,ktf<a name='336'>
            DO i = i_start, i_end<a name='337'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='338'>
              fqy( i, k, jp1 ) = vel*flux4(      &amp;<a name='339'>
                   u(i,k,j-2),u(i,k,j-1), u(i,k,j),u(i,k,j+1),vel )<a name='340'>
            ENDDO<a name='341'>
            ENDDO<a name='342'>
<a name='343'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='344'></font>
<a name='345'>
            DO k=kts,ktf<a name='346'>
            DO i = i_start, i_end<a name='347'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))    &amp;<a name='348'>
                     *(u(i,k,j)+u(i,k,j-1))<a name='349'>
            ENDDO<a name='350'>
            ENDDO<a name='351'>
<a name='352'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd order flux 2 in from north boundary<a name='353'></font>
<a name='354'>
            DO k=kts,ktf<a name='355'>
            DO i = i_start, i_end<a name='356'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='357'>
              fqy( i, k, jp1 ) = vel*flux4(     &amp;<a name='358'>
                   u(i,k,j-2),u(i,k,j-1),    &amp;<a name='359'>
                   u(i,k,j),u(i,k,j+1),vel )<a name='360'>
            ENDDO<a name='361'>
            ENDDO<a name='362'>
<a name='363'>
      END IF<a name='364'>
<a name='365'>
<font color=#447700>!  y flux-divergence into tendency<a name='366'></font>
<a name='367'>
        <font color=#447700>! (j &gt; j_start) will miss the u(,,jds) tendency<a name='368'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='369'>
          DO k=kts,ktf<a name='370'>
          DO i = i_start, i_end<a name='371'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='372'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='373'>
          END DO<a name='374'>
          END DO<a name='375'>
        <font color=#447700>! This would be seen by (j &gt; j_start) but we need to zero out the NP tendency<a name='376'></font>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='377'>
          DO k=kts,ktf<a name='378'>
          DO i = i_start, i_end<a name='379'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='380'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='381'>
          END DO<a name='382'>
          END DO<a name='383'>
        ELSE  <font color=#447700>! normal code<a name='384'></font>
<a name='385'>
        IF(j &gt; j_start) THEN<a name='386'>
<a name='387'>
          DO k=kts,ktf<a name='388'>
          DO i = i_start, i_end<a name='389'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='390'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='391'>
          ENDDO<a name='392'>
          ENDDO<a name='393'>
<a name='394'>
        ENDIF<a name='395'>
<a name='396'>
        END IF<a name='397'>
<a name='398'>
<a name='399'>
        jtmp = jp1<a name='400'>
        jp1 = jp0<a name='401'>
        jp0 = jtmp<a name='402'>
<a name='403'>
   ENDDO j_loop_y_flux_6<a name='404'>
<a name='405'>
<font color=#447700>!  next, x - flux divergence<a name='406'></font>
<a name='407'>
      i_start = its<a name='408'>
      i_end   = ite<a name='409'>
<a name='410'>
      j_start = jts<a name='411'>
      j_end   = MIN(jte,jde-1)<a name='412'>
<a name='413'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='414'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='415'></font>
<a name='416'>
      i_start_f = i_start<a name='417'>
      i_end_f   = i_end+1<a name='418'>
<a name='419'>
      IF(degrade_xs) then<a name='420'>
        i_start = MAX(ids+1,its)<a name='421'>
        i_start_f = ids+3<a name='422'>
      ENDIF<a name='423'>
<a name='424'>
      IF(degrade_xe) then<a name='425'>
        i_end = MIN(ide-1,ite)<a name='426'>
        i_end_f = ide-2<a name='427'>
      ENDIF<a name='428'>
<a name='429'>
<font color=#447700>!  compute fluxes<a name='430'></font>
<a name='431'>
      DO j = j_start, j_end<a name='432'>
<a name='433'>
<font color=#447700>!  5th or 6th order flux<a name='434'></font>
<a name='435'>
        DO k=kts,ktf<a name='436'>
        DO i = i_start_f, i_end_f<a name='437'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='438'>
          fqx( i,k ) = vel*flux6( u(i-3,k,j), u(i-2,k,j),  &amp;<a name='439'>
                                         u(i-1,k,j), u(i  ,k,j),  &amp;<a name='440'>
                                         u(i+1,k,j), u(i+2,k,j),  &amp;<a name='441'>
                                         vel                     )<a name='442'>
        ENDDO<a name='443'>
        ENDDO<a name='444'>
<a name='445'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='446'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='447'></font>
<a name='448'>
        IF( degrade_xs ) THEN<a name='449'>
<a name='450'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='451'></font>
            i = ids+1<a name='452'>
            DO k=kts,ktf<a name='453'>
              ub = u(i-1,k,j)<a name='454'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='455'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='456'>
                     *(u(i,k,j)+ub)<a name='457'>
            ENDDO<a name='458'>
          END IF<a name='459'>
<a name='460'>
          i = ids+2<a name='461'>
          DO k=kts,ktf<a name='462'>
            vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='463'>
            fqx( i, k  ) = vel*flux4( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='464'>
                                           u(i  ,k,j), u(i+1,k,j),  &amp;<a name='465'>
                                           vel                     )<a name='466'>
          ENDDO<a name='467'>
<a name='468'>
        ENDIF<a name='469'>
<a name='470'>
        IF( degrade_xe ) THEN<a name='471'>
<a name='472'>
          IF( i_end == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='473'></font>
            i = ide<a name='474'>
            DO k=kts,ktf<a name='475'>
              ub = u(i,k,j)<a name='476'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='477'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='478'>
                     *(u(i-1,k,j)+ub)<a name='479'>
            ENDDO<a name='480'>
          ENDIF<a name='481'>
<a name='482'>
          DO k=kts,ktf<a name='483'>
          i = ide-1<a name='484'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='485'>
          fqx( i,k ) = vel*flux4( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='486'>
                                         u(i  ,k,j), u(i+1,k,j),  &amp;<a name='487'>
                                         vel                     )<a name='488'>
          ENDDO<a name='489'>
<a name='490'>
        ENDIF<a name='491'>
<a name='492'>
<font color=#447700>!  x flux-divergence into tendency<a name='493'></font>
<a name='494'>
        DO k=kts,ktf<a name='495'>
          DO i = i_start, i_end<a name='496'>
            mrdx=msfux(i,j)*rdx <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='497'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='498'>
          ENDDO<a name='499'>
        ENDDO<a name='500'>
<a name='501'>
      ENDDO<a name='502'>
<a name='503'>
   ELSE IF( horz_order == 5 ) THEN<a name='504'>
<a name='505'>
<font color=#447700>!  5th order horizontal flux calculation<a name='506'></font>
<font color=#447700>!  This code is EXACTLY the same as the 6th order code<a name='507'></font>
<font color=#447700>!  EXCEPT the 5th order and 3rd operators are used in<a name='508'></font>
<font color=#447700>!  place of the 6th and 4th order operators<a name='509'></font>
<a name='510'>
<font color=#447700>!  determine boundary mods for flux operators<a name='511'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='512'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='513'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='514'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='515'></font>
<font color=#447700>!   of the higher order flux stencils<a name='516'></font>
<a name='517'>
   degrade_xs = .true.<a name='518'>
   degrade_xe = .true.<a name='519'>
   degrade_ys = .true.<a name='520'>
   degrade_ye = .true.<a name='521'>
<a name='522'>
   IF( config_flags%periodic_x   .or. &amp;<a name='523'>
       config_flags%symmetric_xs .or. &amp;<a name='524'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='525'>
   IF( config_flags%periodic_x   .or. &amp;<a name='526'>
       config_flags%symmetric_xe .or. &amp;<a name='527'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='528'>
   IF( config_flags%periodic_y   .or. &amp;<a name='529'>
       config_flags%symmetric_ys .or. &amp;<a name='530'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='531'>
   IF( config_flags%periodic_y   .or. &amp;<a name='532'>
       config_flags%symmetric_ye .or. &amp;<a name='533'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='534'>
<a name='535'>
<font color=#447700>!--------------- y - advection first<a name='536'></font>
<a name='537'>
      i_start = its<a name='538'>
      i_end   = ite<a name='539'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='540'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='541'>
      IF ( config_flags%periodic_x ) i_start = its<a name='542'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='543'>
<a name='544'>
      j_start = jts<a name='545'>
      j_end   = MIN(jte,jde-1)<a name='546'>
<a name='547'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='548'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='549'></font>
<a name='550'>
      j_start_f = j_start<a name='551'>
      j_end_f   = j_end+1<a name='552'>
<a name='553'>
      IF(degrade_ys) then<a name='554'>
        j_start = MAX(jts,jds+1)<a name='555'>
        j_start_f = jds+3<a name='556'>
      ENDIF<a name='557'>
<a name='558'>
      IF(degrade_ye) then<a name='559'>
        j_end = MIN(jte,jde-2)<a name='560'>
        j_end_f = jde-3<a name='561'>
      ENDIF<a name='562'>
<a name='563'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='564'>
<a name='565'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='566'></font>
<a name='567'>
     jp1 = 2<a name='568'>
     jp0 = 1<a name='569'>
<a name='570'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='571'>
<a name='572'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN  <font color=#447700>! use full stencil<a name='573'></font>
<a name='574'>
        DO k=kts,ktf<a name='575'>
        DO i = i_start, i_end<a name='576'>
          vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='577'>
          fqy( i, k, jp1 ) = vel*flux5(               &amp;<a name='578'>
                  u(i,k,j-3), u(i,k,j-2), u(i,k,j-1),       &amp;<a name='579'>
                  u(i,k,j  ), u(i,k,j+1), u(i,k,j+2),  vel )<a name='580'>
        ENDDO<a name='581'>
        ENDDO<a name='582'>
<a name='583'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='584'></font>
<a name='585'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='586'></font>
<a name='587'>
            DO k=kts,ktf<a name='588'>
            DO i = i_start, i_end<a name='589'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))  &amp;<a name='590'>
                                     *(u(i,k,j)+u(i,k,j-1))<a name='591'>
            ENDDO<a name='592'>
            ENDDO<a name='593'>
<a name='594'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='595'></font>
<a name='596'>
            DO k=kts,ktf<a name='597'>
            DO i = i_start, i_end<a name='598'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='599'>
              fqy( i, k, jp1 ) = vel*flux3(      &amp;<a name='600'>
                   u(i,k,j-2),u(i,k,j-1), u(i,k,j),u(i,k,j+1),vel )<a name='601'>
            ENDDO<a name='602'>
            ENDDO<a name='603'>
<a name='604'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='605'></font>
<a name='606'>
            DO k=kts,ktf<a name='607'>
            DO i = i_start, i_end<a name='608'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))    &amp;<a name='609'>
                     *(u(i,k,j)+u(i,k,j-1))<a name='610'>
            ENDDO<a name='611'>
            ENDDO<a name='612'>
<a name='613'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd order flux 2 in from north boundary<a name='614'></font>
<a name='615'>
            DO k=kts,ktf<a name='616'>
            DO i = i_start, i_end<a name='617'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='618'>
              fqy( i, k, jp1 ) = vel*flux3(     &amp;<a name='619'>
                   u(i,k,j-2),u(i,k,j-1),    &amp;<a name='620'>
                   u(i,k,j),u(i,k,j+1),vel )<a name='621'>
            ENDDO<a name='622'>
            ENDDO<a name='623'>
<a name='624'>
      END IF<a name='625'>
<a name='626'>
<font color=#447700>!  y flux-divergence into tendency<a name='627'></font>
<a name='628'>
        <font color=#447700>! (j &gt; j_start) will miss the u(,,jds) tendency<a name='629'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='630'>
          DO k=kts,ktf<a name='631'>
          DO i = i_start, i_end<a name='632'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='633'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='634'>
          END DO<a name='635'>
          END DO<a name='636'>
        <font color=#447700>! This would be seen by (j &gt; j_start) but we need to zero out the NP tendency<a name='637'></font>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='638'>
          DO k=kts,ktf<a name='639'>
          DO i = i_start, i_end<a name='640'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='641'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='642'>
          END DO<a name='643'>
          END DO<a name='644'>
        ELSE  <font color=#447700>! normal code<a name='645'></font>
<a name='646'>
        IF(j &gt; j_start) THEN<a name='647'>
<a name='648'>
          DO k=kts,ktf<a name='649'>
          DO i = i_start, i_end<a name='650'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='651'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='652'>
          ENDDO<a name='653'>
          ENDDO<a name='654'>
<a name='655'>
        ENDIF<a name='656'>
<a name='657'>
        END IF<a name='658'>
<a name='659'>
<a name='660'>
        jtmp = jp1<a name='661'>
        jp1 = jp0<a name='662'>
        jp0 = jtmp<a name='663'>
<a name='664'>
   ENDDO j_loop_y_flux_5<a name='665'>
<a name='666'>
<font color=#447700>!  next, x - flux divergence<a name='667'></font>
<a name='668'>
      i_start = its<a name='669'>
      i_end   = ite<a name='670'>
<a name='671'>
      j_start = jts<a name='672'>
      j_end   = MIN(jte,jde-1)<a name='673'>
<a name='674'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='675'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='676'></font>
<a name='677'>
      i_start_f = i_start<a name='678'>
      i_end_f   = i_end+1<a name='679'>
<a name='680'>
      IF(degrade_xs) then<a name='681'>
        i_start = MAX(ids+1,its)<a name='682'>
        i_start_f = ids+3<a name='683'>
      ENDIF<a name='684'>
<a name='685'>
      IF(degrade_xe) then<a name='686'>
        i_end = MIN(ide-1,ite)<a name='687'>
        i_end_f = ide-2<a name='688'>
      ENDIF<a name='689'>
<a name='690'>
<font color=#447700>!  compute fluxes<a name='691'></font>
<a name='692'>
      DO j = j_start, j_end<a name='693'>
<a name='694'>
<font color=#447700>!  5th or 6th order flux<a name='695'></font>
<a name='696'>
        DO k=kts,ktf<a name='697'>
        DO i = i_start_f, i_end_f<a name='698'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='699'>
          fqx( i,k ) = vel*flux5( u(i-3,k,j), u(i-2,k,j),  &amp;<a name='700'>
                                         u(i-1,k,j), u(i  ,k,j),  &amp;<a name='701'>
                                         u(i+1,k,j), u(i+2,k,j),  &amp;<a name='702'>
                                         vel                     )<a name='703'>
        ENDDO<a name='704'>
        ENDDO<a name='705'>
<a name='706'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='707'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='708'></font>
<a name='709'>
        IF( degrade_xs ) THEN<a name='710'>
<a name='711'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='712'></font>
            i = ids+1<a name='713'>
            DO k=kts,ktf<a name='714'>
              ub = u(i-1,k,j)<a name='715'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='716'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='717'>
                     *(u(i,k,j)+ub)<a name='718'>
            ENDDO<a name='719'>
          END IF<a name='720'>
<a name='721'>
          i = ids+2<a name='722'>
          DO k=kts,ktf<a name='723'>
            vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='724'>
            fqx( i, k  ) = vel*flux3( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='725'>
                                           u(i  ,k,j), u(i+1,k,j),  &amp;<a name='726'>
                                           vel                     )<a name='727'>
          ENDDO<a name='728'>
<a name='729'>
        ENDIF<a name='730'>
<a name='731'>
        IF( degrade_xe ) THEN<a name='732'>
<a name='733'>
          IF( i_end == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='734'></font>
            i = ide<a name='735'>
            DO k=kts,ktf<a name='736'>
              ub = u(i,k,j)<a name='737'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='738'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='739'>
                     *(u(i-1,k,j)+ub)<a name='740'>
            ENDDO<a name='741'>
          ENDIF<a name='742'>
<a name='743'>
          DO k=kts,ktf<a name='744'>
          i = ide-1<a name='745'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='746'>
          fqx( i,k ) = vel*flux3( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='747'>
                                         u(i  ,k,j), u(i+1,k,j),  &amp;<a name='748'>
                                         vel                     )<a name='749'>
          ENDDO<a name='750'>
<a name='751'>
        ENDIF<a name='752'>
<a name='753'>
<font color=#447700>!  x flux-divergence into tendency<a name='754'></font>
<a name='755'>
        DO k=kts,ktf<a name='756'>
          DO i = i_start, i_end<a name='757'>
            mrdx=msfux(i,j)*rdx <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='758'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='759'>
          ENDDO<a name='760'>
        ENDDO<a name='761'>
<a name='762'>
      ENDDO<a name='763'>
<a name='764'>
   ELSE IF( horz_order == 4 ) THEN<a name='765'>
<a name='766'>
<font color=#447700>!  determine boundary mods for flux operators<a name='767'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='768'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='769'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='770'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='771'></font>
<font color=#447700>!   of the higher order flux stencils<a name='772'></font>
<a name='773'>
   degrade_xs = .true.<a name='774'>
   degrade_xe = .true.<a name='775'>
   degrade_ys = .true.<a name='776'>
   degrade_ye = .true.<a name='777'>
<a name='778'>
   IF( config_flags%periodic_x   .or. &amp;<a name='779'>
       config_flags%symmetric_xs .or. &amp;<a name='780'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='781'>
   IF( config_flags%periodic_x   .or. &amp;<a name='782'>
       config_flags%symmetric_xe .or. &amp;<a name='783'>
       (ite &lt; ide-1)                ) degrade_xe = .false.<a name='784'>
   IF( config_flags%periodic_y   .or. &amp;<a name='785'>
       config_flags%symmetric_ys .or. &amp;<a name='786'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='787'>
   IF( config_flags%periodic_y   .or. &amp;<a name='788'>
       config_flags%symmetric_ye .or. &amp;<a name='789'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='790'>
<a name='791'>
<font color=#447700>!--------------- x - advection first<a name='792'></font>
<a name='793'>
      i_start = its<a name='794'>
      i_end   = ite<a name='795'>
      j_start = jts<a name='796'>
      j_end   = MIN(jte,jde-1)<a name='797'>
<a name='798'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='799'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='800'></font>
<a name='801'>
      i_start_f = i_start<a name='802'>
      i_end_f   = i_end+1<a name='803'>
<a name='804'>
      IF(degrade_xs) then<a name='805'>
        i_start = ids+1<a name='806'>
        i_start_f = i_start+1<a name='807'>
      ENDIF<a name='808'>
<a name='809'>
      IF(degrade_xe) then<a name='810'>
        i_end = ide-1<a name='811'>
        i_end_f = ide-1<a name='812'>
      ENDIF<a name='813'>
<a name='814'>
<font color=#447700>!  compute fluxes<a name='815'></font>
<a name='816'>
      DO j = j_start, j_end<a name='817'>
<a name='818'>
        DO k=kts,ktf<a name='819'>
        DO i = i_start_f, i_end_f<a name='820'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='821'>
          fqx( i, k ) = vel*flux4( u(i-2,k,j), u(i-1,k,j),      &amp;<a name='822'>
                                   u(i  ,k,j), u(i+1,k,j), vel )<a name='823'>
        ENDDO<a name='824'>
        ENDDO<a name='825'>
<a name='826'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='827'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='828'></font>
<a name='829'>
        IF( degrade_xs ) THEN<a name='830'>
          i = i_start<a name='831'>
          DO k=kts,ktf<a name='832'>
              ub = u(i-1,k,j)<a name='833'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='834'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='835'>
                     *(u(i,k,j)+ub)<a name='836'>
          ENDDO<a name='837'>
        ENDIF<a name='838'>
<a name='839'>
        IF( degrade_xe ) THEN<a name='840'>
          i = i_end+1<a name='841'>
          DO k=kts,ktf<a name='842'>
              ub = u(i,k,j)<a name='843'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='844'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='845'>
                     *(u(i-1,k,j)+ub)<a name='846'>
          ENDDO<a name='847'>
        ENDIF<a name='848'>
<a name='849'>
<font color=#447700>!  x flux-divergence into tendency<a name='850'></font>
<a name='851'>
        DO k=kts,ktf<a name='852'>
          DO i = i_start, i_end<a name='853'>
            mrdx=msfux(i,j)*rdx <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='854'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='855'>
          ENDDO<a name='856'>
        ENDDO<a name='857'>
<a name='858'>
      ENDDO<a name='859'>
<a name='860'>
<font color=#447700>!  y flux divergence<a name='861'></font>
<a name='862'>
      i_start = its<a name='863'>
      i_end   = ite<a name='864'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='865'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='866'>
      IF ( config_flags%periodic_x ) i_start = its<a name='867'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='868'>
<a name='869'>
      j_start = jts<a name='870'>
      j_end   = MIN(jte,jde-1)<a name='871'>
<a name='872'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='873'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='874'></font>
<a name='875'>
      j_start_f = j_start<a name='876'>
      j_end_f   = j_end+1<a name='877'>
<a name='878'>
<font color=#447700>!CJM these may not work with tiling because they define j_start and end in terms of domain dim<a name='879'></font>
      IF(degrade_ys) then<a name='880'>
        j_start = jds+1<a name='881'>
        j_start_f = j_start+1<a name='882'>
      ENDIF<a name='883'>
<a name='884'>
      IF(degrade_ye) then<a name='885'>
        j_end = jde-2<a name='886'>
        j_end_f = jde-2<a name='887'>
      ENDIF<a name='888'>
<a name='889'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='890'>
<a name='891'>
<font color=#447700>!  j flux loop for v flux of u momentum<a name='892'></font>
<a name='893'>
     jp1 = 2<a name='894'>
     jp0 = 1<a name='895'>
<a name='896'>
   DO j = j_start, j_end+1<a name='897'>
<a name='898'>
     IF ( (j &lt; j_start_f) .and. degrade_ys) THEN<a name='899'>
       DO k = kts, ktf<a name='900'>
       DO i = i_start, i_end<a name='901'>
         fqy(i, k, jp1) = 0.25*(rv(i,k,j_start)+rv(i-1,k,j_start))  &amp;<a name='902'>
               *(u(i,k,j_start)+u(i,k,j_start-1))<a name='903'>
       ENDDO<a name='904'>
       ENDDO<a name='905'>
     ELSE IF ((j &gt; j_end_f) .and. degrade_ye) THEN<a name='906'>
       DO k = kts, ktf<a name='907'>
       DO i = i_start, i_end<a name='908'>
         <font color=#447700>! Assumes j&gt;j_end_f is ONLY j_end+1 ...<a name='909'></font>
<font color=#447700>!         fqy(i, k, jp1) = 0.25*(rv(i,k,j_end+1)+rv(i-1,k,j_end+1))    &amp;<a name='910'></font>
<font color=#447700>!                *(u(i,k,j_end+1)+u(i,k,j_end))<a name='911'></font>
         fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))    &amp;<a name='912'>
                *(u(i,k,j)+u(i,k,j-1))<a name='913'>
       ENDDO<a name='914'>
       ENDDO<a name='915'>
     ELSE<a name='916'>
<font color=#447700>!  3rd or 4th order flux<a name='917'></font>
       DO k = kts, ktf<a name='918'>
       DO i = i_start, i_end<a name='919'>
         vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='920'>
         fqy( i, k, jp1 ) = vel*flux4( u(i,k,j-2), u(i,k,j-1),  &amp;<a name='921'>
                                       u(i,k,j  ), u(i,k,j+1),  &amp;<a name='922'>
                                            vel                )<a name='923'>
       ENDDO<a name='924'>
       ENDDO<a name='925'>
<a name='926'>
     END IF<a name='927'>
<a name='928'>
<font color=#447700>!  y flux-divergence into tendency<a name='929'></font>
<a name='930'>
     <font color=#447700>! (j &gt; j_start) will miss the u(,,jds) tendency<a name='931'></font>
     IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='932'>
       DO k=kts,ktf<a name='933'>
       DO i = i_start, i_end<a name='934'>
         mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='935'></font>
         tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='936'>
       END DO<a name='937'>
       END DO<a name='938'>
       <font color=#447700>! This would be seen by (j &gt; j_start) but we need to zero out the NP tendency<a name='939'></font>
     ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='940'>
       DO k=kts,ktf<a name='941'>
       DO i = i_start, i_end<a name='942'>
         mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='943'></font>
         tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='944'>
       END DO<a name='945'>
       END DO<a name='946'>
     ELSE  <font color=#447700>! normal code<a name='947'></font>
<a name='948'>
     IF (j &gt; j_start) THEN<a name='949'>
<a name='950'>
       DO k=kts,ktf<a name='951'>
       DO i = i_start, i_end<a name='952'>
          mrdy=msfux(i,j-1)*rdy <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='953'></font>
          tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='954'>
       ENDDO<a name='955'>
       ENDDO<a name='956'>
<a name='957'>
     END IF<a name='958'>
<a name='959'>
     END IF<a name='960'>
<a name='961'>
     jtmp = jp1<a name='962'>
     jp1 = jp0<a name='963'>
     jp0 = jtmp<a name='964'>
<a name='965'>
  ENDDO<a name='966'>
<a name='967'>
  ELSE IF ( horz_order == 3 ) THEN<a name='968'>
<a name='969'>
<font color=#447700>!  As with the 5th and 6th order flux chioces, the 3rd and 4th order<a name='970'></font>
<font color=#447700>!  code is EXACTLY the same EXCEPT for the flux operator.<a name='971'></font>
<a name='972'>
<font color=#447700>!  determine boundary mods for flux operators<a name='973'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='974'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='975'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='976'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='977'></font>
<font color=#447700>!   of the higher order flux stencils<a name='978'></font>
<a name='979'>
   degrade_xs = .true.<a name='980'>
   degrade_xe = .true.<a name='981'>
   degrade_ys = .true.<a name='982'>
   degrade_ye = .true.<a name='983'>
<a name='984'>
   IF( config_flags%periodic_x   .or. &amp;<a name='985'>
       config_flags%symmetric_xs .or. &amp;<a name='986'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='987'>
   IF( config_flags%periodic_x   .or. &amp;<a name='988'>
       config_flags%symmetric_xe .or. &amp;<a name='989'>
       (ite &lt; ide-1)                ) degrade_xe = .false.<a name='990'>
   IF( config_flags%periodic_y   .or. &amp;<a name='991'>
       config_flags%symmetric_ys .or. &amp;<a name='992'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='993'>
   IF( config_flags%periodic_y   .or. &amp;<a name='994'>
       config_flags%symmetric_ye .or. &amp;<a name='995'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='996'>
<a name='997'>
<font color=#447700>!--------------- x - advection first<a name='998'></font>
<a name='999'>
      i_start = its<a name='1000'>
      i_end   = ite<a name='1001'>
      j_start = jts<a name='1002'>
      j_end   = MIN(jte,jde-1)<a name='1003'>
<a name='1004'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='1005'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1006'></font>
<a name='1007'>
      i_start_f = i_start<a name='1008'>
      i_end_f   = i_end+1<a name='1009'>
<a name='1010'>
      IF(degrade_xs) then<a name='1011'>
        i_start = ids+1<a name='1012'>
        i_start_f = i_start+1<a name='1013'>
      ENDIF<a name='1014'>
<a name='1015'>
      IF(degrade_xe) then<a name='1016'>
        i_end = ide-1<a name='1017'>
        i_end_f = ide-1<a name='1018'>
      ENDIF<a name='1019'>
<a name='1020'>
<font color=#447700>!  compute fluxes<a name='1021'></font>
<a name='1022'>
      DO j = j_start, j_end<a name='1023'>
<a name='1024'>
        DO k=kts,ktf<a name='1025'>
        DO i = i_start_f, i_end_f<a name='1026'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='1027'>
          fqx( i, k ) = vel*flux3( u(i-2,k,j), u(i-1,k,j),      &amp;<a name='1028'>
                                   u(i  ,k,j), u(i+1,k,j), vel )<a name='1029'>
        ENDDO<a name='1030'>
        ENDDO<a name='1031'>
<a name='1032'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='1033'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='1034'></font>
<a name='1035'>
        IF( degrade_xs ) THEN<a name='1036'>
          i = i_start<a name='1037'>
          DO k=kts,ktf<a name='1038'>
              ub = u(i-1,k,j)<a name='1039'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='1040'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='1041'>
                     *(u(i,k,j)+ub)<a name='1042'>
          ENDDO<a name='1043'>
        ENDIF<a name='1044'>
<a name='1045'>
        IF( degrade_xe ) THEN<a name='1046'>
          i = i_end+1<a name='1047'>
          DO k=kts,ktf<a name='1048'>
              ub = u(i,k,j)<a name='1049'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='1050'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='1051'>
                     *(u(i-1,k,j)+ub)<a name='1052'>
          ENDDO<a name='1053'>
        ENDIF<a name='1054'>
<a name='1055'>
<font color=#447700>!  x flux-divergence into tendency<a name='1056'></font>
<a name='1057'>
        DO k=kts,ktf<a name='1058'>
          DO i = i_start, i_end<a name='1059'>
          mrdx=msfux(i,j)*rdx <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='1060'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='1061'>
          ENDDO<a name='1062'>
        ENDDO<a name='1063'>
      ENDDO<a name='1064'>
<a name='1065'>
<font color=#447700>!  y flux divergence<a name='1066'></font>
<a name='1067'>
      i_start = its<a name='1068'>
      i_end   = ite<a name='1069'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='1070'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='1071'>
      IF ( config_flags%periodic_x ) i_start = its<a name='1072'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='1073'>
<a name='1074'>
      j_start = jts<a name='1075'>
      j_end   = MIN(jte,jde-1)<a name='1076'>
<a name='1077'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='1078'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1079'></font>
<a name='1080'>
      j_start_f = j_start<a name='1081'>
      j_end_f   = j_end+1<a name='1082'>
<a name='1083'>
<font color=#447700>!CJM these may not work with tiling because they define j_start and end in terms of domain dim<a name='1084'></font>
      IF(degrade_ys) then<a name='1085'>
        j_start = jds+1<a name='1086'>
        j_start_f = j_start+1<a name='1087'>
      ENDIF<a name='1088'>
<a name='1089'>
      IF(degrade_ye) then<a name='1090'>
        j_end = jde-2<a name='1091'>
        j_end_f = jde-2<a name='1092'>
      ENDIF<a name='1093'>
<a name='1094'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='1095'>
<a name='1096'>
<font color=#447700>!  j flux loop for v flux of u momentum<a name='1097'></font>
<a name='1098'>
     jp1 = 2<a name='1099'>
     jp0 = 1<a name='1100'>
<a name='1101'>
   DO j = j_start, j_end+1<a name='1102'>
<a name='1103'>
     IF ( (j &lt; j_start_f) .and. degrade_ys) THEN<a name='1104'>
       DO k = kts, ktf<a name='1105'>
       DO i = i_start, i_end<a name='1106'>
         fqy(i, k, jp1) = 0.25*(rv(i,k,j_start)+rv(i-1,k,j_start))  &amp;<a name='1107'>
               *(u(i,k,j_start)+u(i,k,j_start-1))<a name='1108'>
       ENDDO<a name='1109'>
       ENDDO<a name='1110'>
     ELSE IF ((j &gt; j_end_f) .and. degrade_ye) THEN<a name='1111'>
       DO k = kts, ktf<a name='1112'>
       DO i = i_start, i_end<a name='1113'>
         <font color=#447700>! Assumes j&gt;j_end_f is ONLY j_end+1 ...<a name='1114'></font>
<font color=#447700>!         fqy(i, k, jp1) = 0.25*(rv(i,k,j_end+1)+rv(i-1,k,j_end+1))    &amp;<a name='1115'></font>
<font color=#447700>!                *(u(i,k,j_end+1)+u(i,k,j_end))<a name='1116'></font>
         fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))    &amp;<a name='1117'>
                *(u(i,k,j)+u(i,k,j-1))<a name='1118'>
       ENDDO<a name='1119'>
       ENDDO<a name='1120'>
     ELSE<a name='1121'>
<font color=#447700>!  3rd or 4th order flux<a name='1122'></font>
       DO k = kts, ktf<a name='1123'>
       DO i = i_start, i_end<a name='1124'>
         vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='1125'>
         fqy( i, k, jp1 ) = vel*flux3( u(i,k,j-2), u(i,k,j-1),  &amp;<a name='1126'>
                                       u(i,k,j  ), u(i,k,j+1),  &amp;<a name='1127'>
                                            vel                )<a name='1128'>
       ENDDO<a name='1129'>
       ENDDO<a name='1130'>
<a name='1131'>
     END IF<a name='1132'>
<a name='1133'>
<font color=#447700>!  y flux-divergence into tendency<a name='1134'></font>
<a name='1135'>
     <font color=#447700>! (j &gt; j_start) will miss the u(,,jds) tendency<a name='1136'></font>
     IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='1137'>
       DO k=kts,ktf<a name='1138'>
       DO i = i_start, i_end<a name='1139'>
         mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='1140'></font>
         tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='1141'>
       END DO<a name='1142'>
       END DO<a name='1143'>
       <font color=#447700>! This would be seen by (j &gt; j_start) but we need to zero out the NP tendency<a name='1144'></font>
     ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='1145'>
       DO k=kts,ktf<a name='1146'>
       DO i = i_start, i_end<a name='1147'>
         mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='1148'></font>
         tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='1149'>
       END DO<a name='1150'>
       END DO<a name='1151'>
     ELSE  <font color=#447700>! normal code<a name='1152'></font>
<a name='1153'>
     IF (j &gt; j_start) THEN<a name='1154'>
<a name='1155'>
       DO k=kts,ktf<a name='1156'>
       DO i = i_start, i_end<a name='1157'>
          mrdy=msfux(i,j-1)*rdy      <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='1158'></font>
          tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='1159'>
       ENDDO<a name='1160'>
       ENDDO<a name='1161'>
<a name='1162'>
     END IF<a name='1163'>
<a name='1164'>
     END IF<a name='1165'>
<a name='1166'>
     jtmp = jp1<a name='1167'>
     jp1 = jp0<a name='1168'>
     jp0 = jtmp<a name='1169'>
<a name='1170'>
  ENDDO<a name='1171'>
<a name='1172'>
  ELSE IF ( horz_order == 2 ) THEN<a name='1173'>
<a name='1174'>
      i_start = its<a name='1175'>
      i_end   = ite<a name='1176'>
      j_start = jts<a name='1177'>
      j_end   = MIN(jte,jde-1)<a name='1178'>
<a name='1179'>
      IF ( config_flags%open_xs ) i_start = MAX(ids+1,its)<a name='1180'>
      IF ( config_flags%open_xe ) i_end   = MIN(ide-1,ite)<a name='1181'>
      IF ( specified ) i_start = MAX(ids+2,its)<a name='1182'>
      IF ( specified ) i_end   = MIN(ide-2,ite)<a name='1183'>
      IF ( config_flags%periodic_x ) i_start = its<a name='1184'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='1185'>
<a name='1186'>
      DO j = j_start, j_end<a name='1187'>
      DO k=kts,ktf<a name='1188'>
      DO i = i_start, i_end<a name='1189'>
         mrdx=msfux(i,j)*rdx         <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='1190'></font>
         tendency(i,k,j)=tendency(i,k,j)-mrdx*0.25 &amp;<a name='1191'>
                *((ru(i+1,k,j)+ru(i,k,j))*(u(i+1,k,j)+u(i,k,j)) &amp;<a name='1192'>
                -(ru(i,k,j)+ru(i-1,k,j))*(u(i,k,j)+u(i-1,k,j)))<a name='1193'>
      ENDDO<a name='1194'>
      ENDDO<a name='1195'>
      ENDDO<a name='1196'>
<a name='1197'>
      IF ( specified .AND. its .LE. ids+1 .AND. .NOT. config_flags%periodic_x ) THEN<a name='1198'>
        DO j = j_start, j_end<a name='1199'>
        DO k=kts,ktf<a name='1200'>
           i = ids+1<a name='1201'>
           mrdx=msfux(i,j)*rdx       <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='1202'></font>
           ub = u(i-1,k,j)<a name='1203'>
           IF (u(i,k,j) .LT. 0.) ub = u(i,k,j)<a name='1204'>
           tendency(i,k,j)=tendency(i,k,j)-mrdx*0.25 &amp;<a name='1205'>
                  *((ru(i+1,k,j)+ru(i,k,j))*(u(i+1,k,j)+u(i,k,j)) &amp;<a name='1206'>
                  -(ru(i,k,j)+ru(i-1,k,j))*(u(i,k,j)+ub))<a name='1207'>
        ENDDO<a name='1208'>
        ENDDO<a name='1209'>
      ENDIF<a name='1210'>
      IF ( specified .AND. ite .GE. ide-1 .AND. .NOT. config_flags%periodic_x ) THEN<a name='1211'>
        DO j = j_start, j_end<a name='1212'>
        DO k=kts,ktf<a name='1213'>
           i = ide-1<a name='1214'>
           mrdx=msfux(i,j)*rdx       <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='1215'></font>
           ub = u(i+1,k,j)<a name='1216'>
           IF (u(i,k,j) .GT. 0.) ub = u(i,k,j)<a name='1217'>
           tendency(i,k,j)=tendency(i,k,j)-mrdx*0.25 &amp;<a name='1218'>
                  *((ru(i+1,k,j)+ru(i,k,j))*(ub+u(i,k,j)) &amp;<a name='1219'>
                  -(ru(i,k,j)+ru(i-1,k,j))*(u(i,k,j)+u(i-1,k,j)))<a name='1220'>
        ENDDO<a name='1221'>
        ENDDO<a name='1222'>
      ENDIF<a name='1223'>
<a name='1224'>
      IF ( config_flags%open_ys .or. specified ) j_start = MAX(jds+1,jts)<a name='1225'>
      IF ( config_flags%open_ye .or. specified ) j_end   = MIN(jde-2,jte)<a name='1226'>
<a name='1227'>
      DO j = j_start, j_end<a name='1228'>
      DO k=kts,ktf<a name='1229'>
      DO i = i_start, i_end<a name='1230'>
         mrdy=msfux(i,j)*rdy         <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='1231'></font>
         <font color=#447700>! Comments for polar boundary condition<a name='1232'></font>
         <font color=#447700>! Flow is only from one side for points next to poles<a name='1233'></font>
         IF ( (config_flags%polar) .AND. (j == jds) ) THEN<a name='1234'>
            tendency(i,k,j)=tendency(i,k,j)-mrdy*0.25 &amp;<a name='1235'>
                            *(rv(i,k,j+1)+rv(i-1,k,j+1))*(u(i,k,j+1)+u(i,k,j))<a name='1236'>
         ELSE IF ( (config_flags%polar) .AND. (j == jde-1) ) THEN<a name='1237'>
            tendency(i,k,j)=tendency(i,k,j)+mrdy*0.25 &amp;<a name='1238'>
                           *(rv(i,k,j)+rv(i-1,k,j))*(u(i,k,j)+u(i,k,j-1))<a name='1239'>
         ELSE  <font color=#447700>! Normal code<a name='1240'></font>
            tendency(i,k,j)=tendency(i,k,j)-mrdy*0.25 &amp;<a name='1241'>
                *((rv(i,k,j+1)+rv(i-1,k,j+1))*(u(i,k,j+1)+u(i,k,j)) &amp;<a name='1242'>
                 -(rv(i,k,j)+rv(i-1,k,j))*(u(i,k,j)+u(i,k,j-1)))<a name='1243'>
         ENDIF<a name='1244'>
      ENDDO<a name='1245'>
      ENDDO<a name='1246'>
      ENDDO<a name='1247'>
<a name='1248'>
   ELSE IF ( horz_order == 0 ) THEN<a name='1249'>
<a name='1250'>
      <font color=#447700>! Just in case we want to turn horizontal advection off, we can do it<a name='1251'></font>
<a name='1252'>
   ELSE<a name='1253'>
<a name='1254'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_u_6a:  h_order not known ',horz_order<a name='1255'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_1"> ( TRIM( wrf_err_message ) )<a name='1256'>
<a name='1257'>
   ENDIF horizontal_order_test<a name='1258'>
<a name='1259'>
<font color=#447700>!  radiative lateral boundary condition in x for normal velocity (u)<a name='1260'></font>
<a name='1261'>
      IF ( (config_flags%open_xs) .and. its == ids ) THEN<a name='1262'>
<a name='1263'>
        j_start = jts<a name='1264'>
        j_end   = MIN(jte,jde-1)<a name='1265'>
<a name='1266'>
        DO j = j_start, j_end<a name='1267'>
        DO k = kts, ktf<a name='1268'>
          ub = MIN(ru(its,k,j)-cb*mut(its,j), 0.)<a name='1269'>
          tendency(its,k,j) = tendency(its,k,j)                    &amp;<a name='1270'>
                      - rdx*ub*(u_old(its+1,k,j) - u_old(its,k,j))<a name='1271'>
        ENDDO<a name='1272'>
        ENDDO<a name='1273'>
<a name='1274'>
      ENDIF<a name='1275'>
<a name='1276'>
      IF ( (config_flags%open_xe) .and. ite == ide ) THEN<a name='1277'>
<a name='1278'>
        j_start = jts<a name='1279'>
        j_end   = MIN(jte,jde-1)<a name='1280'>
<a name='1281'>
        DO j = j_start, j_end<a name='1282'>
        DO k = kts, ktf<a name='1283'>
          ub = MAX(ru(ite,k,j)+cb*mut(ite-1,j), 0.)<a name='1284'>
          tendency(ite,k,j) = tendency(ite,k,j)                    &amp;<a name='1285'>
                      - rdx*ub*(u_old(ite,k,j) - u_old(ite-1,k,j))<a name='1286'>
        ENDDO<a name='1287'>
        ENDDO<a name='1288'>
<a name='1289'>
      ENDIF<a name='1290'>
<a name='1291'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='1292'></font>
<font color=#447700>!  (these are the computations that don't require 'cb')<a name='1293'></font>
<font color=#447700>!  first, set to index ranges<a name='1294'></font>
<a name='1295'>
      i_start = its<a name='1296'>
      i_end   = MIN(ite,ide)<a name='1297'>
      imin    = ids<a name='1298'>
      imax    = ide-1<a name='1299'>
<a name='1300'>
      IF (config_flags%open_xs) THEN<a name='1301'>
        i_start = MAX(ids+1, its)<a name='1302'>
        imin = ids<a name='1303'>
      ENDIF<a name='1304'>
      IF (config_flags%open_xe) THEN<a name='1305'>
        i_end = MIN(ite,ide-1)<a name='1306'>
        imax = ide-1<a name='1307'>
      ENDIF<a name='1308'>
<a name='1309'>
   IF( (config_flags%open_ys) .and. (jts == jds)) THEN<a name='1310'>
<a name='1311'>
      DO i = i_start, i_end<a name='1312'>
<a name='1313'>
         mrdy=msfux(i,jts)*rdy       <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='1314'></font>
         ip = MIN( imax, i   )<a name='1315'>
         im = MAX( imin, i-1 )<a name='1316'>
<a name='1317'>
         DO k=kts,ktf<a name='1318'>
<a name='1319'>
          vw = 0.5*(rv(ip,k,jts)+rv(im,k,jts))<a name='1320'>
          vb = MIN( vw, 0. )<a name='1321'>
          dvm =  rv(ip,k,jts+1)-rv(ip,k,jts)<a name='1322'>
          dvp =  rv(im,k,jts+1)-rv(im,k,jts)<a name='1323'>
          tendency(i,k,jts)=tendency(i,k,jts)-mrdy*(                &amp;<a name='1324'>
                            vb*(u_old(i,k,jts+1)-u_old(i,k,jts))    &amp;<a name='1325'>
                           +0.5*u(i,k,jts)*(dvm+dvp))<a name='1326'>
         ENDDO<a name='1327'>
      ENDDO<a name='1328'>
<a name='1329'>
   ENDIF<a name='1330'>
<a name='1331'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='1332'>
<a name='1333'>
      DO i = i_start, i_end<a name='1334'>
<a name='1335'>
         mrdy=msfux(i,jte-1)*rdy     <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='1336'></font>
         ip = MIN( imax, i   )<a name='1337'>
         im = MAX( imin, i-1 )<a name='1338'>
<a name='1339'>
         DO k=kts,ktf<a name='1340'>
<a name='1341'>
          vw = 0.5*(rv(ip,k,jte)+rv(im,k,jte))<a name='1342'>
          vb = MAX( vw, 0. )<a name='1343'>
          dvm =  rv(ip,k,jte)-rv(ip,k,jte-1)<a name='1344'>
          dvp =  rv(im,k,jte)-rv(im,k,jte-1)<a name='1345'>
          tendency(i,k,jte-1)=tendency(i,k,jte-1)-mrdy*(              &amp;<a name='1346'>
                              vb*(u_old(i,k,jte-1)-u_old(i,k,jte-2))  &amp;<a name='1347'>
                             +0.5*u(i,k,jte-1)*(dvm+dvp))<a name='1348'>
         ENDDO<a name='1349'>
      ENDDO<a name='1350'>
<a name='1351'>
   ENDIF<a name='1352'>
<a name='1353'>
<font color=#447700>!-------------------- vertical advection<a name='1354'></font>
<font color=#447700>!  ADT eqn 44 has 3rd term on RHS = -(1/my) partial d/dz (rho u w)<a name='1355'></font>
<font color=#447700>!  Here we have:  - partial d/dz (u*rom) = - partial d/dz (u rho w / my)<a name='1356'></font>
<font color=#447700>!  Since 'my' (map scale factor in y-direction) isn't a function of z,<a name='1357'></font>
<font color=#447700>!  this is what we need, so leave unchanged in advect_u<a name='1358'></font>
<a name='1359'>
   i_start = its<a name='1360'>
   i_end   = ite<a name='1361'>
   j_start = jts<a name='1362'>
   j_end   = min(jte,jde-1)<a name='1363'>
<a name='1364'>
<font color=#447700>!   IF ( config_flags%open_xs ) i_start = MAX(ids+1,its)<a name='1365'></font>
<font color=#447700>!   IF ( config_flags%open_xe ) i_end   = MIN(ide-1,ite)<a name='1366'></font>
<a name='1367'>
   IF ( config_flags%open_ys .or. specified ) i_start = MAX(ids+1,its)<a name='1368'>
   IF ( config_flags%open_ye .or. specified ) i_end   = MIN(ide-1,ite)<a name='1369'>
      IF ( config_flags%periodic_x ) i_start = its<a name='1370'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='1371'>
<a name='1372'>
   DO i = i_start, i_end<a name='1373'>
     vflux(i,kts)=0.<a name='1374'>
     vflux(i,kte)=0.<a name='1375'>
   ENDDO<a name='1376'>
<a name='1377'>
   vert_order_test : IF (vert_order == 6) THEN    <a name='1378'>
<a name='1379'>
      DO j = j_start, j_end<a name='1380'>
<a name='1381'>
         DO k=kts+3,ktf-2<a name='1382'>
         DO i = i_start, i_end<a name='1383'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='1384'>
           vflux(i,k) = vel*flux6(                     &amp;<a name='1385'>
                   u(i,k-3,j), u(i,k-2,j), u(i,k-1,j),       &amp;<a name='1386'>
                   u(i,k  ,j), u(i,k+1,j), u(i,k+2,j),  -vel )<a name='1387'>
         ENDDO<a name='1388'>
         ENDDO<a name='1389'>
<a name='1390'>
         DO i = i_start, i_end<a name='1391'>
<a name='1392'>
           k=kts+1<a name='1393'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='1394'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1395'>
           k = kts+2<a name='1396'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='1397'>
           vflux(i,k) = vel*flux4(       &amp;<a name='1398'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='1399'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='1400'>
           k = ktf-1<a name='1401'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='1402'>
           vflux(i,k) = vel*flux4(       &amp;<a name='1403'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='1404'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='1405'>
           k=ktf<a name='1406'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1407'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1408'>
<a name='1409'>
         ENDDO<a name='1410'>
         DO k=kts,ktf<a name='1411'>
         DO i = i_start, i_end<a name='1412'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1413'>
         ENDDO<a name='1414'>
         ENDDO<a name='1415'>
      ENDDO<a name='1416'>
<a name='1417'>
    ELSE IF (vert_order == 5) THEN    <a name='1418'>
<a name='1419'>
      DO j = j_start, j_end<a name='1420'>
<a name='1421'>
         DO k=kts+3,ktf-2<a name='1422'>
         DO i = i_start, i_end<a name='1423'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='1424'>
           vflux(i,k) = vel*flux5(                     &amp;<a name='1425'>
                   u(i,k-3,j), u(i,k-2,j), u(i,k-1,j),       &amp;<a name='1426'>
                   u(i,k  ,j), u(i,k+1,j), u(i,k+2,j),  -vel )<a name='1427'>
         ENDDO<a name='1428'>
         ENDDO<a name='1429'>
<a name='1430'>
         DO i = i_start, i_end<a name='1431'>
<a name='1432'>
           k=kts+1<a name='1433'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='1434'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1435'>
           k = kts+2<a name='1436'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='1437'>
           vflux(i,k) = vel*flux3(       &amp;<a name='1438'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='1439'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='1440'>
           k = ktf-1<a name='1441'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='1442'>
           vflux(i,k) = vel*flux3(       &amp;<a name='1443'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='1444'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='1445'>
           k=ktf<a name='1446'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1447'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1448'>
<a name='1449'>
         ENDDO<a name='1450'>
         DO k=kts,ktf<a name='1451'>
         DO i = i_start, i_end<a name='1452'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1453'>
         ENDDO<a name='1454'>
         ENDDO<a name='1455'>
      ENDDO<a name='1456'>
<a name='1457'>
    ELSE IF (vert_order == 4) THEN    <a name='1458'>
<a name='1459'>
      DO j = j_start, j_end<a name='1460'>
<a name='1461'>
         DO k=kts+2,ktf-1<a name='1462'>
         DO i = i_start, i_end<a name='1463'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='1464'>
           vflux(i,k) = vel*flux4(               &amp;<a name='1465'>
                   u(i,k-2,j), u(i,k-1,j),       &amp;<a name='1466'>
                   u(i,k  ,j), u(i,k+1,j),  -vel )<a name='1467'>
         ENDDO<a name='1468'>
         ENDDO<a name='1469'>
<a name='1470'>
         DO i = i_start, i_end<a name='1471'>
<a name='1472'>
           k=kts+1<a name='1473'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='1474'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1475'>
           k=ktf<a name='1476'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1477'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1478'>
<a name='1479'>
         ENDDO<a name='1480'>
         DO k=kts,ktf<a name='1481'>
         DO i = i_start, i_end<a name='1482'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1483'>
         ENDDO<a name='1484'>
         ENDDO<a name='1485'>
      ENDDO<a name='1486'>
<a name='1487'>
    ELSE IF (vert_order == 3) THEN    <a name='1488'>
<a name='1489'>
      DO j = j_start, j_end<a name='1490'>
<a name='1491'>
         DO k=kts+2,ktf-1<a name='1492'>
         DO i = i_start, i_end<a name='1493'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='1494'>
           vflux(i,k) = vel*flux3(               &amp;<a name='1495'>
                   u(i,k-2,j), u(i,k-1,j),       &amp;<a name='1496'>
                   u(i,k  ,j), u(i,k+1,j),  -vel )<a name='1497'>
         ENDDO<a name='1498'>
         ENDDO<a name='1499'>
<a name='1500'>
         DO i = i_start, i_end<a name='1501'>
<a name='1502'>
           k=kts+1<a name='1503'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='1504'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1505'>
           k=ktf<a name='1506'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1507'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1508'>
<a name='1509'>
         ENDDO<a name='1510'>
         DO k=kts,ktf<a name='1511'>
         DO i = i_start, i_end<a name='1512'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1513'>
         ENDDO<a name='1514'>
         ENDDO<a name='1515'>
      ENDDO<a name='1516'>
<a name='1517'>
    ELSE IF (vert_order == 2) THEN    <a name='1518'>
<a name='1519'>
      DO j = j_start, j_end<a name='1520'>
         DO k=kts+1,ktf<a name='1521'>
         DO i = i_start, i_end<a name='1522'>
               vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='1523'>
                                *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='1524'>
         ENDDO<a name='1525'>
         ENDDO<a name='1526'>
<a name='1527'>
<a name='1528'>
         DO k=kts,ktf<a name='1529'>
         DO i = i_start, i_end<a name='1530'>
               tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='1531'>
         ENDDO<a name='1532'>
         ENDDO<a name='1533'>
<a name='1534'>
      ENDDO<a name='1535'>
<a name='1536'>
   ELSE<a name='1537'>
<a name='1538'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_u_6a: v_order not known ',vert_order<a name='1539'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_U' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_2"> ( TRIM( wrf_err_message ) )<a name='1540'>
<a name='1541'>
   ENDIF vert_order_test<a name='1542'>
<a name='1543'>
END SUBROUTINE advect_u<a name='1544'>
<a name='1545'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1546'></font>
<a name='1547'>
<A NAME='ADVECT_V'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1548'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_v</font>   ( v, v_old, tendency,            &amp; <A href='../../call_to/ADVECT_V.html' TARGET='index'>1</A>,<A href='../../call_from/ADVECT_V.html' TARGET='index'>2</A><a name='1549'>
                        ru, rv, rom,                   &amp;<a name='1550'>
                        c1, c2,                        &amp;<a name='1551'>
                        mut, time_step, config_flags,  &amp;<a name='1552'>
                        msfux, msfuy, msfvx, msfvy,    &amp;<a name='1553'>
                        msftx, msfty,                  &amp;<a name='1554'>
                        fzm, fzp,                      &amp;<a name='1555'>
                        rdx, rdy, rdzw,                &amp;<a name='1556'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='1557'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='1558'>
                        its, ite, jts, jte, kts, kte  )<a name='1559'>
<a name='1560'>
   IMPLICIT NONE<a name='1561'>
   <a name='1562'>
   <font color=#447700>! Input data<a name='1563'></font>
   <a name='1564'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='1565'>
<a name='1566'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1567'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='1568'>
                                              its, ite, jts, jte, kts, kte<a name='1569'>
<a name='1570'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: v,     &amp;<a name='1571'>
                                                                      v_old, &amp;<a name='1572'>
                                                                      ru,    &amp;<a name='1573'>
                                                                      rv,    &amp;<a name='1574'>
                                                                      rom<a name='1575'>
<a name='1576'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='1577'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='1578'>
<a name='1579'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='1580'>
                                                                    msfuy,  &amp;<a name='1581'>
                                                                    msfvx,  &amp;<a name='1582'>
                                                                    msfvy,  &amp;<a name='1583'>
                                                                    msftx,  &amp;<a name='1584'>
                                                                    msfty<a name='1585'>
<a name='1586'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='1587'>
                                                                  fzp,  &amp;<a name='1588'>
                                                                  rdzw, &amp;<a name='1589'>
                                                                  c1,   &amp;<a name='1590'>
                                                                  c2<a name='1591'>
<a name='1592'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='1593'>
                                                                  rdy<a name='1594'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='1595'>
<a name='1596'>
<a name='1597'>
   <font color=#447700>! Local data<a name='1598'></font>
   <a name='1599'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='1600'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='1601'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='1602'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='1603'>
<a name='1604'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, dup, dum<a name='1605'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='1606'>
<a name='1607'>
<a name='1608'>
   REAL,  DIMENSION( its:ite+1, kts:kte ) :: fqx<a name='1609'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='1610'>
<a name='1611'>
   INTEGER :: horz_order<a name='1612'>
   INTEGER :: vert_order<a name='1613'>
   <a name='1614'>
   LOGICAL :: degrade_xs, degrade_ys<a name='1615'>
   LOGICAL :: degrade_xe, degrade_ye<a name='1616'>
<a name='1617'>
   INTEGER :: jp1, jp0, jtmp<a name='1618'>
<a name='1619'>
<a name='1620'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='1621'></font>
<a name='1622'>
   REAL    :: flux3, flux4, flux5, flux6<a name='1623'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='1624'>
<a name='1625'>
   flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='1626'>
          ( 7.*(q_i + q_im1) - (q_ip1 + q_im2) )/12.0<a name='1627'>
<a name='1628'>
   flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='1629'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='1630'>
           sign(1,time_step)*sign(1.,ua)*((q_ip1 - q_im2)-3.*(q_i-q_im1))/12.0<a name='1631'>
<a name='1632'>
   flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='1633'>
                      ( 37.*(q_i+q_im1) - 8.*(q_ip1+q_im2)   &amp;<a name='1634'>
                     +(q_ip2+q_im3) )/60.0<a name='1635'>
<a name='1636'>
   flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='1637'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='1638'>
            -sign(1,time_step)*sign(1.,ua)*(                    &amp;<a name='1639'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )/60.0<a name='1640'>
<a name='1641'>
<a name='1642'>
<a name='1643'>
   LOGICAL :: specified<a name='1644'>
<a name='1645'>
   specified = .false.<a name='1646'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='1647'>
<a name='1648'>
<font color=#447700>! set order for the advection schemes<a name='1649'></font>
<a name='1650'>
   ktf=MIN(kte,kde-1)<a name='1651'>
   horz_order = config_flags%h_mom_adv_order<a name='1652'>
   vert_order = config_flags%v_mom_adv_order<a name='1653'>
<a name='1654'>
<a name='1655'>
<font color=#447700>!  here is the choice of flux operators<a name='1656'></font>
<a name='1657'>
<a name='1658'>
   horizontal_order_test : IF( horz_order == 6 ) THEN<a name='1659'>
<a name='1660'>
<font color=#447700>!  determine boundary mods for flux operators<a name='1661'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='1662'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='1663'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='1664'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='1665'></font>
<font color=#447700>!   of the higher order flux stencils<a name='1666'></font>
<a name='1667'>
   degrade_xs = .true.<a name='1668'>
   degrade_xe = .true.<a name='1669'>
   degrade_ys = .true.<a name='1670'>
   degrade_ye = .true.<a name='1671'>
<a name='1672'>
   IF( config_flags%periodic_x   .or. &amp;<a name='1673'>
       config_flags%symmetric_xs .or. &amp;<a name='1674'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='1675'>
   IF( config_flags%periodic_x   .or. &amp;<a name='1676'>
       config_flags%symmetric_xe .or. &amp;<a name='1677'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='1678'>
   IF( config_flags%periodic_y   .or. &amp;<a name='1679'>
       config_flags%symmetric_ys .or. &amp;<a name='1680'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='1681'>
   IF( config_flags%periodic_y   .or. &amp;<a name='1682'>
       config_flags%symmetric_ye .or. &amp;<a name='1683'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='1684'>
<a name='1685'>
<font color=#447700>!--------------- y - advection first<a name='1686'></font>
<a name='1687'>
      i_start = its<a name='1688'>
      i_end   = MIN(ite,ide-1)<a name='1689'>
      j_start = jts<a name='1690'>
      j_end   = jte<a name='1691'>
<a name='1692'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='1693'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1694'></font>
<a name='1695'>
      j_start_f = j_start<a name='1696'>
      j_end_f   = j_end+1<a name='1697'>
<a name='1698'>
      IF(degrade_ys) then<a name='1699'>
        j_start = MAX(jts,jds+1)<a name='1700'>
        j_start_f = jds+3<a name='1701'>
      ENDIF<a name='1702'>
<a name='1703'>
      IF(degrade_ye) then<a name='1704'>
        j_end = MIN(jte,jde-1)<a name='1705'>
        j_end_f = jde-2<a name='1706'>
      ENDIF<a name='1707'>
<a name='1708'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='1709'></font>
<a name='1710'>
     jp1 = 2<a name='1711'>
     jp0 = 1<a name='1712'>
<a name='1713'>
     j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='1714'>
<a name='1715'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='1716'>
<a name='1717'>
        DO k=kts,ktf<a name='1718'>
        DO i = i_start, i_end<a name='1719'>
          vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1720'>
          fqy( i, k, jp1 ) = vel*flux6(               &amp;<a name='1721'>
                  v(i,k,j-3), v(i,k,j-2), v(i,k,j-1),       &amp;<a name='1722'>
                  v(i,k,j  ), v(i,k,j+1), v(i,k,j+2),  vel )<a name='1723'>
        ENDDO<a name='1724'>
        ENDDO<a name='1725'>
<a name='1726'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='1727'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='1728'></font>
<a name='1729'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='1730'></font>
<a name='1731'>
            DO k=kts,ktf<a name='1732'>
            DO i = i_start, i_end<a name='1733'>
                vb = v(i,k,j-1)<a name='1734'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='1735'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='1736'>
                                 *(v(i,k,j)+vb)<a name='1737'>
            ENDDO<a name='1738'>
            ENDDO<a name='1739'>
<a name='1740'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='1741'></font>
<a name='1742'>
            DO k=kts,ktf<a name='1743'>
            DO i = i_start, i_end<a name='1744'>
              vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1745'>
              fqy( i, k, jp1 ) = vel*flux4(      &amp;<a name='1746'>
                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='1747'>
            ENDDO<a name='1748'>
            ENDDO<a name='1749'>
<a name='1750'>
<a name='1751'>
     ELSE IF ( j == jde ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='1752'></font>
<a name='1753'>
            DO k=kts,ktf<a name='1754'>
            DO i = i_start, i_end<a name='1755'>
                vb = v(i,k,j)<a name='1756'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='1757'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='1758'>
                                 *(vb+v(i,k,j-1))<a name='1759'>
            ENDDO<a name='1760'>
            ENDDO<a name='1761'>
<a name='1762'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='1763'></font>
<a name='1764'>
            DO k=kts,ktf<a name='1765'>
            DO i = i_start, i_end<a name='1766'>
              vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1767'>
              fqy( i, k, jp1 ) = vel*flux4(     &amp;<a name='1768'>
                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='1769'>
            ENDDO<a name='1770'>
            ENDDO<a name='1771'>
<a name='1772'>
      END IF<a name='1773'>
<a name='1774'>
<font color=#447700>!  y flux-divergence into tendency<a name='1775'></font>
<a name='1776'>
        <font color=#447700>! Comments on polar boundary conditions<a name='1777'></font>
        <font color=#447700>! No advection over the poles means tendencies (held from jds [S. pole]<a name='1778'></font>
        <font color=#447700>! to jde [N pole], i.e., on v grid) must be zero at poles<a name='1779'></font>
        <font color=#447700>! [tendency(jds) and tendency(jde)=0]<a name='1780'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='1781'>
          DO k=kts,ktf<a name='1782'>
          DO i = i_start, i_end<a name='1783'>
            tendency(i,k,j-1) = 0.<a name='1784'>
          END DO<a name='1785'>
          END DO<a name='1786'>
        <font color=#447700>! If j_end were set to jde in a special if statement apart from<a name='1787'></font>
        <font color=#447700>! degrade_ye, then we would hit the next conditional.  But since<a name='1788'></font>
        <font color=#447700>! we want the tendency to be zero anyway, not looping to jde+1<a name='1789'></font>
        <font color=#447700>! will produce the same effect.<a name='1790'></font>
        ELSE IF( config_flags%polar .AND. (j == jde+1) ) THEN<a name='1791'>
          DO k=kts,ktf<a name='1792'>
          DO i = i_start, i_end<a name='1793'>
            tendency(i,k,j-1) = 0.<a name='1794'>
          END DO<a name='1795'>
          END DO<a name='1796'>
        ELSE  <font color=#447700>! Normal code<a name='1797'></font>
<a name='1798'>
        IF(j &gt; j_start) THEN<a name='1799'>
<a name='1800'>
          DO k=kts,ktf<a name='1801'>
          DO i = i_start, i_end<a name='1802'>
            mrdy=msfvy(i,j-1)*rdy    <font color=#447700>! ADT eqn 45, 2nd term on RHS<a name='1803'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='1804'>
          ENDDO<a name='1805'>
          ENDDO<a name='1806'>
<a name='1807'>
        ENDIF<a name='1808'>
<a name='1809'>
        END IF<a name='1810'>
<a name='1811'>
        jtmp = jp1<a name='1812'>
        jp1 = jp0<a name='1813'>
        jp0 = jtmp<a name='1814'>
<a name='1815'>
   ENDDO j_loop_y_flux_6<a name='1816'>
<a name='1817'>
<font color=#447700>!  next, x - flux divergence<a name='1818'></font>
<a name='1819'>
      i_start = its<a name='1820'>
      i_end   = MIN(ite,ide-1)<a name='1821'>
<a name='1822'>
      j_start = jts<a name='1823'>
      j_end   = jte<a name='1824'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='1825'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='1826'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='1827'>
<a name='1828'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='1829'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1830'></font>
<a name='1831'>
      i_start_f = i_start<a name='1832'>
      i_end_f   = i_end+1<a name='1833'>
<a name='1834'>
      IF(degrade_xs) then<a name='1835'>
        i_start = MAX(ids+1,its)<a name='1836'>
<font color=#447700>!        i_start_f = i_start+2<a name='1837'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='1838'>
      ENDIF<a name='1839'>
<a name='1840'>
      IF(degrade_xe) then<a name='1841'>
        i_end = MIN(ide-2,ite)<a name='1842'>
        i_end_f = ide-3<a name='1843'>
      ENDIF<a name='1844'>
<a name='1845'>
<font color=#447700>!  compute fluxes<a name='1846'></font>
<a name='1847'>
      DO j = j_start, j_end<a name='1848'>
<a name='1849'>
<font color=#447700>!  5th or 6th order flux<a name='1850'></font>
<a name='1851'>
        DO k=kts,ktf<a name='1852'>
        DO i = i_start_f, i_end_f<a name='1853'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1854'>
          fqx( i, k ) = vel*flux6( v(i-3,k,j), v(i-2,k,j),  &amp;<a name='1855'>
                                         v(i-1,k,j), v(i  ,k,j),  &amp;<a name='1856'>
                                         v(i+1,k,j), v(i+2,k,j),  &amp;<a name='1857'>
                                         vel                     )<a name='1858'>
        ENDDO<a name='1859'>
        ENDDO<a name='1860'>
<a name='1861'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='1862'></font>
<a name='1863'>
        IF( degrade_xs ) THEN<a name='1864'>
<a name='1865'>
          DO i=i_start,i_start_f-1<a name='1866'>
<a name='1867'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='1868'></font>
              DO k=kts,ktf<a name='1869'>
                fqx(i,k) = 0.25*(ru(i,k,j)+ru(i,k,j-1)) &amp;<a name='1870'>
                                *(v(i,k,j)+v(i-1,k,j))<a name='1871'>
              ENDDO<a name='1872'>
            ENDIF<a name='1873'>
<a name='1874'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='1875'></font>
              DO k=kts,ktf<a name='1876'>
                vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1877'>
                fqx( i,k ) = vel*flux4( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='1878'>
                                        v(i  ,k,j), v(i+1,k,j),  &amp;<a name='1879'>
                                        vel                     )<a name='1880'>
              ENDDO<a name='1881'>
            ENDIF<a name='1882'>
<a name='1883'>
          ENDDO<a name='1884'>
<a name='1885'>
        ENDIF<a name='1886'>
<a name='1887'>
        IF( degrade_xe ) THEN<a name='1888'>
<a name='1889'>
          DO i = i_end_f+1, i_end+1<a name='1890'>
<a name='1891'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='1892'></font>
              DO k=kts,ktf<a name='1893'>
                fqx(i,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='1894'>
                                *(v(i_end+1,k,j)+v(i_end,k,j))<a name='1895'>
              ENDDO<a name='1896'>
            ENDIF<a name='1897'>
<a name='1898'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='1899'></font>
              DO k=kts,ktf<a name='1900'>
                vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='1901'>
                fqx( i,k ) = vel*flux4( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='1902'>
                                        v(i  ,k,j), v(i+1,k,j),  &amp;<a name='1903'>
                                        vel                     )<a name='1904'>
              ENDDO<a name='1905'>
            ENDIF<a name='1906'>
<a name='1907'>
          ENDDO<a name='1908'>
<a name='1909'>
        ENDIF<a name='1910'>
<a name='1911'>
<font color=#447700>!  x flux-divergence into tendency<a name='1912'></font>
<a name='1913'>
        DO k=kts,ktf<a name='1914'>
          DO i = i_start, i_end<a name='1915'>
            mrdx=msfvy(i,j)*rdx      <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='1916'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='1917'>
          ENDDO<a name='1918'>
        ENDDO<a name='1919'>
<a name='1920'>
      ENDDO<a name='1921'>
<a name='1922'>
   ELSE IF( horz_order == 5 ) THEN<a name='1923'>
<a name='1924'>
<font color=#447700>!  5th order horizontal flux calculation<a name='1925'></font>
<font color=#447700>!  This code is EXACTLY the same as the 6th order code<a name='1926'></font>
<font color=#447700>!  EXCEPT the 5th order and 3rd operators are used in<a name='1927'></font>
<font color=#447700>!  place of the 6th and 4th order operators<a name='1928'></font>
<a name='1929'>
<font color=#447700>!  determine boundary mods for flux operators<a name='1930'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='1931'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='1932'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='1933'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='1934'></font>
<font color=#447700>!   of the higher order flux stencils<a name='1935'></font>
<a name='1936'>
   degrade_xs = .true.<a name='1937'>
   degrade_xe = .true.<a name='1938'>
   degrade_ys = .true.<a name='1939'>
   degrade_ye = .true.<a name='1940'>
<a name='1941'>
   IF( config_flags%periodic_x   .or. &amp;<a name='1942'>
       config_flags%symmetric_xs .or. &amp;<a name='1943'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='1944'>
   IF( config_flags%periodic_x   .or. &amp;<a name='1945'>
       config_flags%symmetric_xe .or. &amp;<a name='1946'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='1947'>
   IF( config_flags%periodic_y   .or. &amp;<a name='1948'>
       config_flags%symmetric_ys .or. &amp;<a name='1949'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='1950'>
   IF( config_flags%periodic_y   .or. &amp;<a name='1951'>
       config_flags%symmetric_ye .or. &amp;<a name='1952'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='1953'>
<a name='1954'>
<font color=#447700>!--------------- y - advection first<a name='1955'></font>
<a name='1956'>
      i_start = its<a name='1957'>
      i_end   = MIN(ite,ide-1)<a name='1958'>
      j_start = jts<a name='1959'>
      j_end   = jte<a name='1960'>
<a name='1961'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='1962'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='1963'></font>
<a name='1964'>
      j_start_f = j_start<a name='1965'>
      j_end_f   = j_end+1<a name='1966'>
<a name='1967'>
      IF(degrade_ys) then<a name='1968'>
        j_start = MAX(jts,jds+1)<a name='1969'>
        j_start_f = jds+3<a name='1970'>
      ENDIF<a name='1971'>
<a name='1972'>
      IF(degrade_ye) then<a name='1973'>
        j_end = MIN(jte,jde-1)<a name='1974'>
        j_end_f = jde-2<a name='1975'>
      ENDIF<a name='1976'>
<a name='1977'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='1978'></font>
<a name='1979'>
     jp1 = 2<a name='1980'>
     jp0 = 1<a name='1981'>
<a name='1982'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='1983'>
<a name='1984'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='1985'>
<a name='1986'>
        DO k=kts,ktf<a name='1987'>
        DO i = i_start, i_end<a name='1988'>
          vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='1989'>
          fqy( i, k, jp1 ) = vel*flux5(               &amp;<a name='1990'>
                  v(i,k,j-3), v(i,k,j-2), v(i,k,j-1),       &amp;<a name='1991'>
                  v(i,k,j  ), v(i,k,j+1), v(i,k,j+2),  vel )<a name='1992'>
        ENDDO<a name='1993'>
        ENDDO<a name='1994'>
<a name='1995'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='1996'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='1997'></font>
<a name='1998'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='1999'></font>
<a name='2000'>
            DO k=kts,ktf<a name='2001'>
            DO i = i_start, i_end<a name='2002'>
                vb = v(i,k,j-1)<a name='2003'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='2004'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='2005'>
                                 *(v(i,k,j)+vb)<a name='2006'>
            ENDDO<a name='2007'>
            ENDDO<a name='2008'>
<a name='2009'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='2010'></font>
<a name='2011'>
            DO k=kts,ktf<a name='2012'>
            DO i = i_start, i_end<a name='2013'>
              vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='2014'>
              fqy( i, k, jp1 ) = vel*flux3(      &amp;<a name='2015'>
                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='2016'>
            ENDDO<a name='2017'>
            ENDDO<a name='2018'>
<a name='2019'>
<a name='2020'>
     ELSE IF ( j == jde ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='2021'></font>
<a name='2022'>
            DO k=kts,ktf<a name='2023'>
            DO i = i_start, i_end<a name='2024'>
                vb = v(i,k,j)<a name='2025'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='2026'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='2027'>
                                 *(vb+v(i,k,j-1))<a name='2028'>
            ENDDO<a name='2029'>
            ENDDO<a name='2030'>
<a name='2031'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='2032'></font>
<a name='2033'>
            DO k=kts,ktf<a name='2034'>
            DO i = i_start, i_end<a name='2035'>
              vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='2036'>
              fqy( i, k, jp1 ) = vel*flux3(     &amp;<a name='2037'>
                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='2038'>
            ENDDO<a name='2039'>
            ENDDO<a name='2040'>
<a name='2041'>
      END IF<a name='2042'>
<a name='2043'>
<font color=#447700>!  y flux-divergence into tendency<a name='2044'></font>
<a name='2045'>
        <font color=#447700>! Comments on polar boundary conditions<a name='2046'></font>
        <font color=#447700>! No advection over the poles means tendencies (held from jds [S. pole]<a name='2047'></font>
        <font color=#447700>! to jde [N pole], i.e., on v grid) must be zero at poles<a name='2048'></font>
        <font color=#447700>! [tendency(jds) and tendency(jde)=0]<a name='2049'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='2050'>
          DO k=kts,ktf<a name='2051'>
          DO i = i_start, i_end<a name='2052'>
            tendency(i,k,j-1) = 0.<a name='2053'>
          END DO<a name='2054'>
          END DO<a name='2055'>
        <font color=#447700>! If j_end were set to jde in a special if statement apart from<a name='2056'></font>
        <font color=#447700>! degrade_ye, then we would hit the next conditional.  But since<a name='2057'></font>
        <font color=#447700>! we want the tendency to be zero anyway, not looping to jde+1<a name='2058'></font>
        <font color=#447700>! will produce the same effect.<a name='2059'></font>
        ELSE IF( config_flags%polar .AND. (j == jde+1) ) THEN<a name='2060'>
          DO k=kts,ktf<a name='2061'>
          DO i = i_start, i_end<a name='2062'>
            tendency(i,k,j-1) = 0.<a name='2063'>
          END DO<a name='2064'>
          END DO<a name='2065'>
        ELSE  <font color=#447700>! Normal code<a name='2066'></font>
<a name='2067'>
        IF(j &gt; j_start) THEN<a name='2068'>
<a name='2069'>
          DO k=kts,ktf<a name='2070'>
          DO i = i_start, i_end<a name='2071'>
            mrdy=msfvy(i,j-1)*rdy    <font color=#447700>! ADT eqn 45, 2nd term on RHS<a name='2072'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='2073'>
          ENDDO<a name='2074'>
          ENDDO<a name='2075'>
<a name='2076'>
        ENDIF<a name='2077'>
<a name='2078'>
        END IF<a name='2079'>
<a name='2080'>
        jtmp = jp1<a name='2081'>
        jp1 = jp0<a name='2082'>
        jp0 = jtmp<a name='2083'>
<a name='2084'>
   ENDDO j_loop_y_flux_5<a name='2085'>
<a name='2086'>
<font color=#447700>!  next, x - flux divergence<a name='2087'></font>
<a name='2088'>
      i_start = its<a name='2089'>
      i_end   = MIN(ite,ide-1)<a name='2090'>
<a name='2091'>
      j_start = jts<a name='2092'>
      j_end   = jte<a name='2093'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='2094'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='2095'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='2096'>
<a name='2097'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='2098'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2099'></font>
<a name='2100'>
      i_start_f = i_start<a name='2101'>
      i_end_f   = i_end+1<a name='2102'>
<a name='2103'>
      IF(degrade_xs) then<a name='2104'>
        i_start = MAX(ids+1,its)<a name='2105'>
<font color=#447700>!        i_start_f = i_start+2<a name='2106'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='2107'>
      ENDIF<a name='2108'>
<a name='2109'>
      IF(degrade_xe) then<a name='2110'>
        i_end = MIN(ide-2,ite)<a name='2111'>
        i_end_f = ide-3<a name='2112'>
      ENDIF<a name='2113'>
<a name='2114'>
<font color=#447700>!  compute fluxes<a name='2115'></font>
<a name='2116'>
      DO j = j_start, j_end<a name='2117'>
<a name='2118'>
<font color=#447700>!  5th or 6th order flux<a name='2119'></font>
<a name='2120'>
        DO k=kts,ktf<a name='2121'>
        DO i = i_start_f, i_end_f<a name='2122'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='2123'>
          fqx( i, k ) = vel*flux5( v(i-3,k,j), v(i-2,k,j),  &amp;<a name='2124'>
                                         v(i-1,k,j), v(i  ,k,j),  &amp;<a name='2125'>
                                         v(i+1,k,j), v(i+2,k,j),  &amp;<a name='2126'>
                                         vel                     )<a name='2127'>
        ENDDO<a name='2128'>
        ENDDO<a name='2129'>
<a name='2130'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='2131'></font>
<a name='2132'>
        IF( degrade_xs ) THEN<a name='2133'>
<a name='2134'>
          DO i=i_start,i_start_f-1<a name='2135'>
<a name='2136'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='2137'></font>
              DO k=kts,ktf<a name='2138'>
                fqx(i,k) = 0.25*(ru(i,k,j)+ru(i,k,j-1)) &amp;<a name='2139'>
                                *(v(i,k,j)+v(i-1,k,j))<a name='2140'>
              ENDDO<a name='2141'>
            ENDIF<a name='2142'>
<a name='2143'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='2144'></font>
              DO k=kts,ktf<a name='2145'>
                vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='2146'>
                fqx( i,k ) = vel*flux3( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='2147'>
                                        v(i  ,k,j), v(i+1,k,j),  &amp;<a name='2148'>
                                        vel                     )<a name='2149'>
              ENDDO<a name='2150'>
            ENDIF<a name='2151'>
<a name='2152'>
          ENDDO<a name='2153'>
<a name='2154'>
        ENDIF<a name='2155'>
<a name='2156'>
        IF( degrade_xe ) THEN<a name='2157'>
<a name='2158'>
          DO i = i_end_f+1, i_end+1<a name='2159'>
<a name='2160'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='2161'></font>
              DO k=kts,ktf<a name='2162'>
                fqx(i,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='2163'>
                                *(v(i_end+1,k,j)+v(i_end,k,j))<a name='2164'>
              ENDDO<a name='2165'>
            ENDIF<a name='2166'>
<a name='2167'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='2168'></font>
              DO k=kts,ktf<a name='2169'>
                vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='2170'>
                fqx( i,k ) = vel*flux3( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='2171'>
                                        v(i  ,k,j), v(i+1,k,j),  &amp;<a name='2172'>
                                        vel                     )<a name='2173'>
              ENDDO<a name='2174'>
            ENDIF<a name='2175'>
<a name='2176'>
          ENDDO<a name='2177'>
<a name='2178'>
        ENDIF<a name='2179'>
<a name='2180'>
<font color=#447700>!  x flux-divergence into tendency<a name='2181'></font>
<a name='2182'>
        DO k=kts,ktf<a name='2183'>
          DO i = i_start, i_end<a name='2184'>
            mrdx=msfvy(i,j)*rdx      <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='2185'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='2186'>
          ENDDO<a name='2187'>
        ENDDO<a name='2188'>
<a name='2189'>
      ENDDO<a name='2190'>
<a name='2191'>
   ELSE IF( horz_order == 4 ) THEN<a name='2192'>
<a name='2193'>
<font color=#447700>!  determine boundary mods for flux operators<a name='2194'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='2195'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='2196'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='2197'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='2198'></font>
<font color=#447700>!   of the higher order flux stencils<a name='2199'></font>
<a name='2200'>
   degrade_xs = .true.<a name='2201'>
   degrade_xe = .true.<a name='2202'>
   degrade_ys = .true.<a name='2203'>
   degrade_ye = .true.<a name='2204'>
<a name='2205'>
   IF( config_flags%periodic_x   .or. &amp;<a name='2206'>
       config_flags%symmetric_xs .or. &amp;<a name='2207'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='2208'>
   IF( config_flags%periodic_x   .or. &amp;<a name='2209'>
       config_flags%symmetric_xe .or. &amp;<a name='2210'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='2211'>
   IF( config_flags%periodic_y   .or. &amp;<a name='2212'>
       config_flags%symmetric_ys .or. &amp;<a name='2213'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='2214'>
   IF( config_flags%periodic_y   .or. &amp;<a name='2215'>
       config_flags%symmetric_ye .or. &amp;<a name='2216'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='2217'>
<a name='2218'>
<font color=#447700>!--------------- y - advection first<a name='2219'></font>
<a name='2220'>
<a name='2221'>
   ktf=MIN(kte,kde-1)<a name='2222'>
<a name='2223'>
      i_start = its<a name='2224'>
      i_end   = MIN(ite,ide-1)<a name='2225'>
      j_start = jts<a name='2226'>
      j_end   = jte<a name='2227'>
<a name='2228'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='2229'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2230'></font>
<a name='2231'>
      j_start_f = j_start<a name='2232'>
      j_end_f   = j_end+1<a name='2233'>
<a name='2234'>
<font color=#447700>!CJM May not work with tiling because defined in terms of domain dims<a name='2235'></font>
      IF(degrade_ys) then<a name='2236'>
        j_start = jds+1<a name='2237'>
        j_start_f = j_start+1<a name='2238'>
      ENDIF<a name='2239'>
<a name='2240'>
      IF(degrade_ye) then<a name='2241'>
        j_end = jde-1<a name='2242'>
        j_end_f = jde-1<a name='2243'>
      ENDIF<a name='2244'>
<a name='2245'>
<font color=#447700>!  compute fluxes<a name='2246'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='2247'></font>
<a name='2248'>
    jp0 = 1<a name='2249'>
    jp1 = 2<a name='2250'>
<a name='2251'>
    DO j = j_start, j_end+1<a name='2252'>
<a name='2253'>
      IF ((j == j_start) .and. degrade_ys) THEN<a name='2254'>
        DO k = kts,ktf<a name='2255'>
        DO i = i_start, i_end<a name='2256'>
                vb = v(i,k,j-1)<a name='2257'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='2258'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='2259'>
                                 *(v(i,k,j)+vb)<a name='2260'>
        ENDDO<a name='2261'>
        ENDDO<a name='2262'>
      ELSE IF ((j == j_end+1) .and. degrade_ye) THEN<a name='2263'>
        DO k = kts, ktf<a name='2264'>
        DO i = i_start, i_end<a name='2265'>
                vb = v(i,k,j)<a name='2266'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='2267'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='2268'>
                                 *(vb+v(i,k,j-1))<a name='2269'>
        ENDDO<a name='2270'>
        ENDDO<a name='2271'>
      ELSE<a name='2272'>
        DO k = kts, ktf<a name='2273'>
        DO i = i_start, i_end<a name='2274'>
          vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='2275'>
          fqy( i,k,jp1 ) = vel*flux4( v(i,k,j-2), v(i,k,j-1),  &amp;<a name='2276'>
                                     v(i,k,j  ), v(i,k,j+1),  &amp;<a name='2277'>
                                      vel                        )<a name='2278'>
        ENDDO<a name='2279'>
        ENDDO<a name='2280'>
      END IF<a name='2281'>
<a name='2282'>
      <font color=#447700>! Comments on polar boundary conditions<a name='2283'></font>
      <font color=#447700>! No advection over the poles means tendencies (held from jds [S. pole]<a name='2284'></font>
      <font color=#447700>! to jde [N pole], i.e., on v grid) must be zero at poles<a name='2285'></font>
      <font color=#447700>! [tendency(jds) and tendency(jde)=0]<a name='2286'></font>
      IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='2287'>
        DO k=kts,ktf<a name='2288'>
        DO i = i_start, i_end<a name='2289'>
          tendency(i,k,j-1) = 0.<a name='2290'>
        END DO<a name='2291'>
        END DO<a name='2292'>
      <font color=#447700>! If j_end were set to jde in a special if statement apart from<a name='2293'></font>
      <font color=#447700>! degrade_ye, then we would hit the next conditional.  But since<a name='2294'></font>
      <font color=#447700>! we want the tendency to be zero anyway, not looping to jde+1<a name='2295'></font>
      <font color=#447700>! will produce the same effect.<a name='2296'></font>
      ELSE IF( config_flags%polar .AND. (j == jde+1) ) THEN<a name='2297'>
        DO k=kts,ktf<a name='2298'>
        DO i = i_start, i_end<a name='2299'>
          tendency(i,k,j-1) = 0.<a name='2300'>
        END DO<a name='2301'>
        END DO<a name='2302'>
      ELSE  <font color=#447700>! Normal code<a name='2303'></font>
<a name='2304'>
      IF( j &gt; j_start) THEN<a name='2305'>
        DO k = kts, ktf<a name='2306'>
        DO i = i_start, i_end<a name='2307'>
            mrdy=msfvy(i,j-1)*rdy     <font color=#447700>! ADT eqn 45, 2nd term on RHS<a name='2308'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='2309'>
        ENDDO<a name='2310'>
        ENDDO<a name='2311'>
<a name='2312'>
      END IF<a name='2313'>
<a name='2314'>
      END IF<a name='2315'>
<a name='2316'>
      jtmp = jp1<a name='2317'>
      jp1 = jp0<a name='2318'>
      jp0 = jtmp<a name='2319'>
<a name='2320'>
   ENDDO<a name='2321'>
<a name='2322'>
<font color=#447700>!  next, x - flux divergence<a name='2323'></font>
<a name='2324'>
<a name='2325'>
      i_start = its<a name='2326'>
      i_end   = MIN(ite,ide-1)<a name='2327'>
<a name='2328'>
      j_start = jts<a name='2329'>
      j_end   = jte<a name='2330'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='2331'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='2332'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='2333'>
<a name='2334'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='2335'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2336'></font>
<a name='2337'>
      i_start_f = i_start<a name='2338'>
      i_end_f   = i_end+1<a name='2339'>
<a name='2340'>
      IF(degrade_xs) then<a name='2341'>
        i_start = ids+1<a name='2342'>
        i_start_f = i_start+1<a name='2343'>
      ENDIF<a name='2344'>
<a name='2345'>
      IF(degrade_xe) then<a name='2346'>
        i_end = ide-2<a name='2347'>
        i_end_f = ide-2<a name='2348'>
      ENDIF<a name='2349'>
<a name='2350'>
<font color=#447700>!  compute fluxes<a name='2351'></font>
<a name='2352'>
      DO j = j_start, j_end<a name='2353'>
<a name='2354'>
<font color=#447700>!  3rd or 4th order flux<a name='2355'></font>
<a name='2356'>
        DO k=kts,ktf<a name='2357'>
        DO i = i_start_f, i_end_f<a name='2358'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='2359'>
          fqx( i, k ) = vel*flux4( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='2360'>
                                  v(i  ,k,j), v(i+1,k,j),  &amp;<a name='2361'>
                                  vel                     )<a name='2362'>
        ENDDO<a name='2363'>
        ENDDO<a name='2364'>
<a name='2365'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='2366'></font>
<a name='2367'>
        IF( degrade_xs ) THEN<a name='2368'>
          DO k=kts,ktf<a name='2369'>
            fqx(i_start,k) = 0.25*(ru(i_start,k,j)+ru(i_start,k,j-1)) &amp;<a name='2370'>
                   *(v(i_start,k,j)+v(i_start-1,k,j))<a name='2371'>
          ENDDO<a name='2372'>
        ENDIF<a name='2373'>
<a name='2374'>
        IF( degrade_xe ) THEN<a name='2375'>
          DO k=kts,ktf<a name='2376'>
            fqx(i_end+1,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='2377'>
                   *(v(i_end+1,k,j)+v(i_end,k,j))<a name='2378'>
          ENDDO<a name='2379'>
        ENDIF<a name='2380'>
<a name='2381'>
<font color=#447700>!  x flux-divergence into tendency<a name='2382'></font>
<a name='2383'>
        DO k=kts,ktf<a name='2384'>
        DO i = i_start, i_end<a name='2385'>
            mrdx=msfvy(i,j)*rdx       <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='2386'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='2387'>
        ENDDO<a name='2388'>
        ENDDO<a name='2389'>
<a name='2390'>
      ENDDO<a name='2391'>
<a name='2392'>
   ELSE IF( horz_order == 3 ) THEN<a name='2393'>
<a name='2394'>
<font color=#447700>!  determine boundary mods for flux operators<a name='2395'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='2396'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='2397'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='2398'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='2399'></font>
<font color=#447700>!   of the higher order flux stencils<a name='2400'></font>
<a name='2401'>
   degrade_xs = .true.<a name='2402'>
   degrade_xe = .true.<a name='2403'>
   degrade_ys = .true.<a name='2404'>
   degrade_ye = .true.<a name='2405'>
<a name='2406'>
   IF( config_flags%periodic_x   .or. &amp;<a name='2407'>
       config_flags%symmetric_xs .or. &amp;<a name='2408'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='2409'>
   IF( config_flags%periodic_x   .or. &amp;<a name='2410'>
       config_flags%symmetric_xe .or. &amp;<a name='2411'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='2412'>
   IF( config_flags%periodic_y   .or. &amp;<a name='2413'>
       config_flags%symmetric_ys .or. &amp;<a name='2414'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='2415'>
   IF( config_flags%periodic_y   .or. &amp;<a name='2416'>
       config_flags%symmetric_ye .or. &amp;<a name='2417'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='2418'>
<a name='2419'>
<font color=#447700>!--------------- y - advection first<a name='2420'></font>
<a name='2421'>
<a name='2422'>
   ktf=MIN(kte,kde-1)<a name='2423'>
<a name='2424'>
      i_start = its<a name='2425'>
      i_end   = MIN(ite,ide-1)<a name='2426'>
      j_start = jts<a name='2427'>
      j_end   = jte<a name='2428'>
<a name='2429'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='2430'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2431'></font>
<a name='2432'>
      j_start_f = j_start<a name='2433'>
      j_end_f   = j_end+1<a name='2434'>
<a name='2435'>
<font color=#447700>!CJM May not work with tiling because defined in terms of domain dims<a name='2436'></font>
      IF(degrade_ys) then<a name='2437'>
        j_start = jds+1<a name='2438'>
        j_start_f = j_start+1<a name='2439'>
      ENDIF<a name='2440'>
<a name='2441'>
      IF(degrade_ye) then<a name='2442'>
        j_end = jde-1<a name='2443'>
        j_end_f = jde-1<a name='2444'>
      ENDIF<a name='2445'>
<a name='2446'>
<font color=#447700>!  compute fluxes<a name='2447'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='2448'></font>
<a name='2449'>
    jp0 = 1<a name='2450'>
    jp1 = 2<a name='2451'>
<a name='2452'>
    DO j = j_start, j_end+1<a name='2453'>
<a name='2454'>
      IF ((j == j_start) .and. degrade_ys) THEN<a name='2455'>
        DO k = kts,ktf<a name='2456'>
        DO i = i_start, i_end<a name='2457'>
                vb = v(i,k,j-1)<a name='2458'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='2459'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='2460'>
                                 *(v(i,k,j)+vb)<a name='2461'>
        ENDDO<a name='2462'>
        ENDDO<a name='2463'>
      ELSE IF ((j == j_end+1) .and. degrade_ye) THEN<a name='2464'>
        DO k = kts, ktf<a name='2465'>
        DO i = i_start, i_end<a name='2466'>
                vb = v(i,k,j)<a name='2467'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='2468'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='2469'>
                                 *(vb+v(i,k,j-1))<a name='2470'>
        ENDDO<a name='2471'>
        ENDDO<a name='2472'>
      ELSE<a name='2473'>
        DO k = kts, ktf<a name='2474'>
        DO i = i_start, i_end<a name='2475'>
          vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='2476'>
          fqy( i,k,jp1 ) = vel*flux3( v(i,k,j-2), v(i,k,j-1),  &amp;<a name='2477'>
                                     v(i,k,j  ), v(i,k,j+1),  &amp;<a name='2478'>
                                      vel                        )<a name='2479'>
        ENDDO<a name='2480'>
        ENDDO<a name='2481'>
      END IF<a name='2482'>
<a name='2483'>
      <font color=#447700>! Comments on polar boundary conditions<a name='2484'></font>
      <font color=#447700>! No advection over the poles means tendencies (held from jds [S. pole]<a name='2485'></font>
      <font color=#447700>! to jde [N pole], i.e., on v grid) must be zero at poles<a name='2486'></font>
      <font color=#447700>! [tendency(jds) and tendency(jde)=0]<a name='2487'></font>
      IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='2488'>
        DO k=kts,ktf<a name='2489'>
        DO i = i_start, i_end<a name='2490'>
          tendency(i,k,j-1) = 0.<a name='2491'>
        END DO<a name='2492'>
        END DO<a name='2493'>
      <font color=#447700>! If j_end were set to jde in a special if statement apart from<a name='2494'></font>
      <font color=#447700>! degrade_ye, then we would hit the next conditional.  But since<a name='2495'></font>
      <font color=#447700>! we want the tendency to be zero anyway, not looping to jde+1<a name='2496'></font>
      <font color=#447700>! will produce the same effect.<a name='2497'></font>
      ELSE IF( config_flags%polar .AND. (j == jde+1) ) THEN<a name='2498'>
        DO k=kts,ktf<a name='2499'>
        DO i = i_start, i_end<a name='2500'>
          tendency(i,k,j-1) = 0.<a name='2501'>
        END DO<a name='2502'>
        END DO<a name='2503'>
      ELSE  <font color=#447700>! Normal code<a name='2504'></font>
<a name='2505'>
      IF( j &gt; j_start) THEN<a name='2506'>
        DO k = kts, ktf<a name='2507'>
        DO i = i_start, i_end<a name='2508'>
            mrdy=msfvy(i,j-1)*rdy     <font color=#447700>! ADT eqn 45, 2nd term on RHS<a name='2509'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='2510'>
        ENDDO<a name='2511'>
        ENDDO<a name='2512'>
<a name='2513'>
      END IF<a name='2514'>
<a name='2515'>
      END IF<a name='2516'>
<a name='2517'>
      jtmp = jp1<a name='2518'>
      jp1 = jp0<a name='2519'>
      jp0 = jtmp<a name='2520'>
<a name='2521'>
   ENDDO<a name='2522'>
<a name='2523'>
<font color=#447700>!  next, x - flux divergence<a name='2524'></font>
<a name='2525'>
<a name='2526'>
      i_start = its<a name='2527'>
      i_end   = MIN(ite,ide-1)<a name='2528'>
<a name='2529'>
      j_start = jts<a name='2530'>
      j_end   = jte<a name='2531'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='2532'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='2533'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='2534'>
<a name='2535'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='2536'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='2537'></font>
<a name='2538'>
      i_start_f = i_start<a name='2539'>
      i_end_f   = i_end+1<a name='2540'>
<a name='2541'>
      IF(degrade_xs) then<a name='2542'>
        i_start = ids+1<a name='2543'>
        i_start_f = i_start+1<a name='2544'>
      ENDIF<a name='2545'>
<a name='2546'>
      IF(degrade_xe) then<a name='2547'>
        i_end = ide-2<a name='2548'>
        i_end_f = ide-2<a name='2549'>
      ENDIF<a name='2550'>
<a name='2551'>
<font color=#447700>!  compute fluxes<a name='2552'></font>
<a name='2553'>
      DO j = j_start, j_end<a name='2554'>
<a name='2555'>
<font color=#447700>!  3rd or 4th order flux<a name='2556'></font>
<a name='2557'>
        DO k=kts,ktf<a name='2558'>
        DO i = i_start_f, i_end_f<a name='2559'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='2560'>
          fqx( i, k ) = vel*flux3( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='2561'>
                                  v(i  ,k,j), v(i+1,k,j),  &amp;<a name='2562'>
                                  vel                     )<a name='2563'>
        ENDDO<a name='2564'>
        ENDDO<a name='2565'>
<a name='2566'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='2567'></font>
<a name='2568'>
        IF( degrade_xs ) THEN<a name='2569'>
          DO k=kts,ktf<a name='2570'>
            fqx(i_start,k) = 0.25*(ru(i_start,k,j)+ru(i_start,k,j-1)) &amp;<a name='2571'>
                   *(v(i_start,k,j)+v(i_start-1,k,j))<a name='2572'>
          ENDDO<a name='2573'>
        ENDIF<a name='2574'>
<a name='2575'>
        IF( degrade_xe ) THEN<a name='2576'>
          DO k=kts,ktf<a name='2577'>
            fqx(i_end+1,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='2578'>
                   *(v(i_end+1,k,j)+v(i_end,k,j))<a name='2579'>
          ENDDO<a name='2580'>
        ENDIF<a name='2581'>
<a name='2582'>
<font color=#447700>!  x flux-divergence into tendency<a name='2583'></font>
<a name='2584'>
        DO k=kts,ktf<a name='2585'>
        DO i = i_start, i_end<a name='2586'>
            mrdx=msfvy(i,j)*rdx      <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='2587'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='2588'>
        ENDDO<a name='2589'>
        ENDDO<a name='2590'>
<a name='2591'>
      ENDDO<a name='2592'>
<a name='2593'>
   ELSE IF( horz_order == 2 ) THEN<a name='2594'>
<a name='2595'>
<a name='2596'>
      i_start = its<a name='2597'>
      i_end   = MIN(ite,ide-1)<a name='2598'>
      j_start = jts<a name='2599'>
      j_end   = jte<a name='2600'>
<a name='2601'>
      IF ( config_flags%open_ys ) j_start = MAX(jds+1,jts)<a name='2602'>
      IF ( config_flags%open_ye ) j_end   = MIN(jde-1,jte)<a name='2603'>
      IF ( specified ) j_start = MAX(jds+2,jts)<a name='2604'>
      IF ( specified ) j_end   = MIN(jde-2,jte)<a name='2605'>
      IF ( config_flags%polar ) j_start = MAX(jds+1,jts)<a name='2606'>
      IF ( config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='2607'>
<a name='2608'>
      DO j = j_start, j_end<a name='2609'>
      DO k=kts,ktf<a name='2610'>
      DO i = i_start, i_end<a name='2611'>
<a name='2612'>
         mrdy=msfvy(i,j)*rdy          <font color=#447700>! ADT eqn 45, 2nd term on RHS<a name='2613'></font>
<a name='2614'>
            tendency(i,k,j)=tendency(i,k,j) -mrdy*0.25 &amp;<a name='2615'>
                            *((rv(i,k,j+1)+rv(i,k,j  ))*(v(i,k,j+1)+v(i,k,j  )) &amp;<a name='2616'>
                             -(rv(i,k,j  )+rv(i,k,j-1))*(v(i,k,j  )+v(i,k,j-1)))<a name='2617'>
<a name='2618'>
      ENDDO<a name='2619'>
      ENDDO<a name='2620'>
      ENDDO<a name='2621'>
<a name='2622'>
      <font color=#447700>! Comments on polar boundary conditions<a name='2623'></font>
      <font color=#447700>! tendencies = 0 at poles, and polar points do not contribute at points<a name='2624'></font>
      <font color=#447700>! next to poles<a name='2625'></font>
      IF (config_flags%polar) THEN<a name='2626'>
         IF (jts == jds) THEN<a name='2627'>
            DO k=kts,ktf<a name='2628'>
            DO i = i_start, i_end<a name='2629'>
               tendency(i,k,jds) = 0.<a name='2630'>
            END DO<a name='2631'>
            END DO<a name='2632'>
         END IF<a name='2633'>
         IF (jte == jde) THEN<a name='2634'>
            DO k=kts,ktf<a name='2635'>
            DO i = i_start, i_end<a name='2636'>
               tendency(i,k,jde) = 0.<a name='2637'>
            END DO<a name='2638'>
            END DO<a name='2639'>
         END IF<a name='2640'>
      END IF<a name='2641'>
<a name='2642'>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='2643'></font>
<a name='2644'>
      IF ( specified .AND. jts .LE. jds+1 ) THEN<a name='2645'>
        j = jds+1<a name='2646'>
        DO k=kts,ktf<a name='2647'>
        DO i = i_start, i_end<a name='2648'>
           mrdy=msfvy(i,j)*rdy       <font color=#447700>! ADT eqn 45, 2nd term on RHS<a name='2649'></font>
           vb = v(i,k,j-1)<a name='2650'>
           IF (v(i,k,j) .LT. 0.) vb = v(i,k,j)<a name='2651'>
<a name='2652'>
              tendency(i,k,j)=tendency(i,k,j) -mrdy*0.25 &amp;<a name='2653'>
                              *((rv(i,k,j+1)+rv(i,k,j  ))*(v(i,k,j+1)+v(i,k,j  )) &amp;<a name='2654'>
                               -(rv(i,k,j  )+rv(i,k,j-1))*(v(i,k,j  )+vb))<a name='2655'>
<a name='2656'>
        ENDDO<a name='2657'>
        ENDDO<a name='2658'>
      ENDIF<a name='2659'>
<a name='2660'>
      IF ( specified .AND. jte .GE. jde-1 ) THEN<a name='2661'>
        j = jde-1<a name='2662'>
        DO k=kts,ktf<a name='2663'>
        DO i = i_start, i_end<a name='2664'>
<a name='2665'>
           mrdy=msfvy(i,j)*rdy       <font color=#447700>! ADT eqn 45, 2nd term on RHS<a name='2666'></font>
           vb = v(i,k,j+1)<a name='2667'>
           IF (v(i,k,j) .GT. 0.) vb = v(i,k,j)<a name='2668'>
<a name='2669'>
              tendency(i,k,j)=tendency(i,k,j) -mrdy*0.25 &amp;<a name='2670'>
                              *((rv(i,k,j+1)+rv(i,k,j  ))*(vb+v(i,k,j  )) &amp;<a name='2671'>
                               -(rv(i,k,j  )+rv(i,k,j-1))*(v(i,k,j  )+v(i,k,j-1)))<a name='2672'>
<a name='2673'>
        ENDDO<a name='2674'>
        ENDDO<a name='2675'>
      ENDIF<a name='2676'>
<a name='2677'>
      IF ( .NOT. config_flags%periodic_x ) THEN<a name='2678'>
        IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='2679'>
        IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='2680'>
      ENDIF<a name='2681'>
      IF ( config_flags%polar ) j_start = MAX(jds+1,jts)<a name='2682'>
      IF ( config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='2683'>
<a name='2684'>
      DO j = j_start, j_end<a name='2685'>
      DO k=kts,ktf<a name='2686'>
      DO i = i_start, i_end<a name='2687'>
<a name='2688'>
         mrdx=msfvy(i,j)*rdx         <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='2689'></font>
<a name='2690'>
            tendency(i,k,j)=tendency(i,k,j)-mrdx*0.25 &amp;<a name='2691'>
                            *((ru(i+1,k,j)+ru(i+1,k,j-1))*(v(i+1,k,j)+v(i  ,k,j)) &amp;<a name='2692'>
                             -(ru(i  ,k,j)+ru(i  ,k,j-1))*(v(i  ,k,j)+v(i-1,k,j)))<a name='2693'>
<a name='2694'>
      ENDDO<a name='2695'>
      ENDDO<a name='2696'>
      ENDDO<a name='2697'>
<a name='2698'>
   ELSE IF ( horz_order == 0 ) THEN<a name='2699'>
<a name='2700'>
      <font color=#447700>! Just in case we want to turn horizontal advection off, we can do it<a name='2701'></font>
<a name='2702'>
  ELSE<a name='2703'>
<a name='2704'>
<a name='2705'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_v_6a: h_order not known ',horz_order<a name='2706'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_3"> ( TRIM( wrf_err_message ) )<a name='2707'>
<a name='2708'>
   ENDIF horizontal_order_test<a name='2709'>
<a name='2710'>
   <font color=#447700>!  Comments on polar boundary condition<a name='2711'></font>
   <font color=#447700>!  Force tendency=0 at NP and SP<a name='2712'></font>
   <font color=#447700>!  We keep setting this everywhere, but it can't hurt...<a name='2713'></font>
   IF ( config_flags%polar .AND. (jts == jds) ) THEN<a name='2714'>
      DO i=its,ite<a name='2715'>
      DO k=kts,ktf<a name='2716'>
         tendency(i,k,jts)=0.<a name='2717'>
      END DO<a name='2718'>
      END DO<a name='2719'>
   END IF<a name='2720'>
   IF ( config_flags%polar .AND. (jte == jde) ) THEN<a name='2721'>
      DO i=its,ite<a name='2722'>
      DO k=kts,ktf<a name='2723'>
         tendency(i,k,jte)=0.<a name='2724'>
      END DO<a name='2725'>
      END DO<a name='2726'>
   END IF<a name='2727'>
<a name='2728'>
<font color=#447700>!  radiative lateral boundary condition in y for normal velocity (v)<a name='2729'></font>
<a name='2730'>
      IF ( (config_flags%open_ys) .and. jts == jds ) THEN<a name='2731'>
<a name='2732'>
        i_start = its<a name='2733'>
        i_end   = MIN(ite,ide-1)<a name='2734'>
<a name='2735'>
        DO i = i_start, i_end<a name='2736'>
        DO k = kts, ktf<a name='2737'>
          vb = MIN(rv(i,k,jts)-cb*mut(i,jts), 0.)<a name='2738'>
          tendency(i,k,jts) = tendency(i,k,jts)                    &amp;<a name='2739'>
                      - rdy*vb*(v_old(i,k,jts+1) - v_old(i,k,jts))<a name='2740'>
        ENDDO<a name='2741'>
        ENDDO<a name='2742'>
<a name='2743'>
      ENDIF<a name='2744'>
<a name='2745'>
      IF ( (config_flags%open_ye) .and. jte == jde ) THEN<a name='2746'>
<a name='2747'>
        i_start = its<a name='2748'>
        i_end   = MIN(ite,ide-1)<a name='2749'>
<a name='2750'>
        DO i = i_start, i_end<a name='2751'>
        DO k = kts, ktf<a name='2752'>
          vb = MAX(rv(i,k,jte)+cb*mut(i,jte-1), 0.)<a name='2753'>
          tendency(i,k,jte) = tendency(i,k,jte)                    &amp;<a name='2754'>
                      - rdy*vb*(v_old(i,k,jte) - v_old(i,k,jte-1))<a name='2755'>
        ENDDO<a name='2756'>
        ENDDO<a name='2757'>
<a name='2758'>
      ENDIF<a name='2759'>
<a name='2760'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='2761'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='2762'></font>
<font color=#447700>!  first, set to index ranges<a name='2763'></font>
<a name='2764'>
      j_start = jts<a name='2765'>
      j_end   = MIN(jte,jde)<a name='2766'>
<a name='2767'>
      jmin    = jds<a name='2768'>
      jmax    = jde-1<a name='2769'>
<a name='2770'>
      IF (config_flags%open_ys) THEN<a name='2771'>
          j_start = MAX(jds+1, jts)<a name='2772'>
          jmin = jds<a name='2773'>
      ENDIF<a name='2774'>
      IF (config_flags%open_ye) THEN<a name='2775'>
          j_end = MIN(jte,jde-1)<a name='2776'>
          jmax = jde-1<a name='2777'>
      ENDIF<a name='2778'>
<a name='2779'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='2780'></font>
<a name='2781'>
   IF( (config_flags%open_xs) .and. (its == ids)) THEN<a name='2782'>
<a name='2783'>
      DO j = j_start, j_end<a name='2784'>
<a name='2785'>
         mrdx=msfvy(its,j)*rdx       <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='2786'></font>
         jp = MIN( jmax, j   )<a name='2787'>
         jm = MAX( jmin, j-1 )<a name='2788'>
<a name='2789'>
         DO k=kts,ktf<a name='2790'>
<a name='2791'>
          uw = 0.5*(ru(its,k,jp)+ru(its,k,jm))<a name='2792'>
          ub = MIN( uw, 0. )<a name='2793'>
          dup =  ru(its+1,k,jp)-ru(its,k,jp)<a name='2794'>
          dum =  ru(its+1,k,jm)-ru(its,k,jm)<a name='2795'>
          tendency(its,k,j)=tendency(its,k,j)-mrdx*(               &amp;<a name='2796'>
                            ub*(v_old(its+1,k,j)-v_old(its,k,j))   &amp;<a name='2797'>
                           +0.5*v(its,k,j)*(dup+dum))<a name='2798'>
         ENDDO<a name='2799'>
      ENDDO<a name='2800'>
<a name='2801'>
   ENDIF<a name='2802'>
<a name='2803'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='2804'>
      DO j = j_start, j_end<a name='2805'>
<a name='2806'>
         mrdx=msfvy(ite-1,j)*rdx     <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='2807'></font>
         jp = MIN( jmax, j   )<a name='2808'>
         jm = MAX( jmin, j-1 )<a name='2809'>
<a name='2810'>
         DO k=kts,ktf<a name='2811'>
<a name='2812'>
          uw = 0.5*(ru(ite,k,jp)+ru(ite,k,jm))<a name='2813'>
          ub = MAX( uw, 0. )<a name='2814'>
          dup = ru(ite,k,jp)-ru(ite-1,k,jp)<a name='2815'>
          dum = ru(ite,k,jm)-ru(ite-1,k,jm)<a name='2816'>
<a name='2817'>
<font color=#447700>!          tendency(ite-1,k,j)=tendency(ite-1,k,j)-mrdx*(              &amp;<a name='2818'></font>
<font color=#447700>!                            ub*(v_old(ite-1,k,j)-v_old(ite-2,k,j))    &amp;<a name='2819'></font>
<font color=#447700>!                           +0.5*v(ite-1,k,j)*                         &amp;<a name='2820'></font>
<font color=#447700>!                                  ( ru(ite,k,jp)-ru(ite-1,k,jp)       &amp;<a name='2821'></font>
<font color=#447700>!                                   +ru(ite,k,jm)-ru(ite-1,k,jm))     )<a name='2822'></font>
          tendency(ite-1,k,j)=tendency(ite-1,k,j)-mrdx*(              &amp;<a name='2823'>
                            ub*(v_old(ite-1,k,j)-v_old(ite-2,k,j))    &amp;<a name='2824'>
                           +0.5*v(ite-1,k,j)*(dup+dum))<a name='2825'>
<a name='2826'>
         ENDDO<a name='2827'>
      ENDDO<a name='2828'>
<a name='2829'>
   ENDIF<a name='2830'>
<a name='2831'>
<font color=#447700>!-------------------- vertical advection<a name='2832'></font>
<font color=#447700>!     ADT eqn 45 has 3rd term on RHS = -(1/mx) partial d/dz (rho v w)<a name='2833'></font>
<font color=#447700>!     Here we have: - partial d/dz (v*rom) = - partial d/dz (v rho w / my)<a name='2834'></font>
<font color=#447700>!     We therefore need to make a correction for advect_v<a name='2835'></font>
<font color=#447700>!     since 'my' (map scale factor in y direction) isn't a function of z,<a name='2836'></font>
<font color=#447700>!     we can do this using *(my/mx) (see eqn. 45 for example)<a name='2837'></font>
<a name='2838'>
<a name='2839'>
      i_start = its<a name='2840'>
      i_end   = MIN(ite,ide-1)<a name='2841'>
      j_start = jts<a name='2842'>
      j_end   = jte<a name='2843'>
<a name='2844'>
      DO i = i_start, i_end<a name='2845'>
         vflux(i,kts)=0.<a name='2846'>
         vflux(i,kte)=0.<a name='2847'>
      ENDDO<a name='2848'>
<a name='2849'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='2850'></font>
      <font color=#447700>! We don't want to calculate vertical v tendencies at the N or S pole<a name='2851'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='2852'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='2853'>
<a name='2854'>
    vert_order_test : IF (vert_order == 6) THEN    <a name='2855'>
<a name='2856'>
      DO j = j_start, j_end<a name='2857'>
<a name='2858'>
<a name='2859'>
         DO k=kts+3,ktf-2<a name='2860'>
         DO i = i_start, i_end<a name='2861'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='2862'>
           vflux(i,k) = vel*flux6(                       &amp;<a name='2863'>
                   v(i,k-3,j), v(i,k-2,j), v(i,k-1,j),       &amp;<a name='2864'>
                   v(i,k  ,j), v(i,k+1,j), v(i,k+2,j),  -vel )<a name='2865'>
         ENDDO<a name='2866'>
         ENDDO<a name='2867'>
<a name='2868'>
         DO i = i_start, i_end<a name='2869'>
           k=kts+1<a name='2870'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='2871'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2872'>
           k = kts+2<a name='2873'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='2874'>
           vflux(i,k) = vel*flux4(       &amp;<a name='2875'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='2876'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2877'>
           k = ktf-1<a name='2878'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='2879'>
           vflux(i,k) = vel*flux4(       &amp;<a name='2880'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='2881'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2882'>
           k=ktf<a name='2883'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2884'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2885'>
<a name='2886'>
         ENDDO<a name='2887'>
<a name='2888'>
<a name='2889'>
         DO k=kts,ktf<a name='2890'>
         DO i = i_start, i_end<a name='2891'>
            <font color=#447700>! We are calculating vertical fluxes on v points,<a name='2892'></font>
            <font color=#447700>! so we must mean msf_v_x/y variables<a name='2893'></font>
            tendency(i,k,j)=tendency(i,k,j)-(msfvy(i,j)/msfvx(i,j))*rdzw(k)*(vflux(i,k+1)-vflux(i,k)) <font color=#447700>! ADT eqn 45, 3rd term on RHS<a name='2894'></font>
         ENDDO<a name='2895'>
         ENDDO<a name='2896'>
<a name='2897'>
      ENDDO<a name='2898'>
<a name='2899'>
   ELSE IF (vert_order == 5) THEN    <a name='2900'>
<a name='2901'>
      DO j = j_start, j_end<a name='2902'>
<a name='2903'>
<a name='2904'>
         DO k=kts+3,ktf-2<a name='2905'>
         DO i = i_start, i_end<a name='2906'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='2907'>
           vflux(i,k) = vel*flux5(                       &amp;<a name='2908'>
                   v(i,k-3,j), v(i,k-2,j), v(i,k-1,j),       &amp;<a name='2909'>
                   v(i,k  ,j), v(i,k+1,j), v(i,k+2,j),  -vel )<a name='2910'>
         ENDDO<a name='2911'>
         ENDDO<a name='2912'>
<a name='2913'>
         DO i = i_start, i_end<a name='2914'>
           k=kts+1<a name='2915'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='2916'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2917'>
           k = kts+2<a name='2918'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='2919'>
           vflux(i,k) = vel*flux3(       &amp;<a name='2920'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='2921'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2922'>
           k = ktf-1<a name='2923'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='2924'>
           vflux(i,k) = vel*flux3(       &amp;<a name='2925'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='2926'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2927'>
           k=ktf<a name='2928'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2929'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2930'>
<a name='2931'>
         ENDDO<a name='2932'>
<a name='2933'>
<a name='2934'>
         DO k=kts,ktf<a name='2935'>
         DO i = i_start, i_end<a name='2936'>
            <font color=#447700>! We are calculating vertical fluxes on v points,<a name='2937'></font>
            <font color=#447700>! so we must mean msf_v_x/y variables<a name='2938'></font>
            tendency(i,k,j)=tendency(i,k,j)-(msfvy(i,j)/msfvx(i,j))*rdzw(k)*(vflux(i,k+1)-vflux(i,k)) <font color=#447700>! ADT eqn 45, 3rd term on RHS<a name='2939'></font>
         ENDDO<a name='2940'>
         ENDDO<a name='2941'>
<a name='2942'>
      ENDDO<a name='2943'>
<a name='2944'>
    ELSE IF (vert_order == 4) THEN    <a name='2945'>
<a name='2946'>
      DO j = j_start, j_end<a name='2947'>
<a name='2948'>
<a name='2949'>
         DO k=kts+2,ktf-1<a name='2950'>
         DO i = i_start, i_end<a name='2951'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='2952'>
           vflux(i,k) = vel*flux4(               &amp;<a name='2953'>
                   v(i,k-2,j), v(i,k-1,j),       &amp;<a name='2954'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2955'>
         ENDDO<a name='2956'>
         ENDDO<a name='2957'>
<a name='2958'>
         DO i = i_start, i_end<a name='2959'>
           k=kts+1<a name='2960'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='2961'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2962'>
           k=ktf<a name='2963'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2964'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2965'>
<a name='2966'>
         ENDDO<a name='2967'>
<a name='2968'>
<a name='2969'>
         DO k=kts,ktf<a name='2970'>
         DO i = i_start, i_end<a name='2971'>
            <font color=#447700>! We are calculating vertical fluxes on v points,<a name='2972'></font>
            <font color=#447700>! so we must mean msf_v_x/y variables<a name='2973'></font>
            tendency(i,k,j)=tendency(i,k,j)-(msfvy(i,j)/msfvx(i,j))*rdzw(k)*(vflux(i,k+1)-vflux(i,k)) <font color=#447700>! ADT eqn 45, 3rd term on RHS<a name='2974'></font>
         ENDDO<a name='2975'>
         ENDDO<a name='2976'>
<a name='2977'>
      ENDDO<a name='2978'>
<a name='2979'>
    ELSE IF (vert_order == 3) THEN    <a name='2980'>
<a name='2981'>
      DO j = j_start, j_end<a name='2982'>
<a name='2983'>
<a name='2984'>
         DO k=kts+2,ktf-1<a name='2985'>
         DO i = i_start, i_end<a name='2986'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='2987'>
           vflux(i,k) = vel*flux3(               &amp;<a name='2988'>
                   v(i,k-2,j), v(i,k-1,j),       &amp;<a name='2989'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='2990'>
         ENDDO<a name='2991'>
         ENDDO<a name='2992'>
<a name='2993'>
         DO i = i_start, i_end<a name='2994'>
           k=kts+1<a name='2995'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='2996'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='2997'>
           k=ktf<a name='2998'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='2999'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='3000'>
<a name='3001'>
         ENDDO<a name='3002'>
<a name='3003'>
<a name='3004'>
         DO k=kts,ktf<a name='3005'>
         DO i = i_start, i_end<a name='3006'>
            <font color=#447700>! We are calculating vertical fluxes on v points,<a name='3007'></font>
            <font color=#447700>! so we must mean msf_v_x/y variables<a name='3008'></font>
            tendency(i,k,j)=tendency(i,k,j)-(msfvy(i,j)/msfvx(i,j))*rdzw(k)*(vflux(i,k+1)-vflux(i,k)) <font color=#447700>! ADT eqn 45, 3rd term on RHS<a name='3009'></font>
         ENDDO<a name='3010'>
         ENDDO<a name='3011'>
<a name='3012'>
      ENDDO<a name='3013'>
<a name='3014'>
<a name='3015'>
    ELSE IF (vert_order == 2) THEN    <a name='3016'>
<a name='3017'>
   DO j = j_start, j_end<a name='3018'>
      DO k=kts+1,ktf<a name='3019'>
      DO i = i_start, i_end<a name='3020'>
<a name='3021'>
            vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='3022'>
                                    *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='3023'>
      ENDDO<a name='3024'>
      ENDDO<a name='3025'>
<a name='3026'>
      DO k=kts,ktf<a name='3027'>
      DO i = i_start, i_end<a name='3028'>
            <font color=#447700>! We are calculating vertical fluxes on v points,<a name='3029'></font>
            <font color=#447700>! so we must mean msf_v_x/y variables<a name='3030'></font>
            tendency(i,k,j)=tendency(i,k,j)-(msfvy(i,j)/msfvx(i,j))*rdzw(k)*(vflux(i,k+1)-vflux(i,k)) <font color=#447700>! ADT eqn 45, 3rd term on RHS<a name='3031'></font>
      ENDDO<a name='3032'>
      ENDDO<a name='3033'>
   ENDDO<a name='3034'>
<a name='3035'>
   ELSE<a name='3036'>
<a name='3037'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_v_6a: v_order not known ',vert_order<a name='3038'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_V' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_4"> ( TRIM( wrf_err_message ) )<a name='3039'>
<a name='3040'>
   ENDIF vert_order_test<a name='3041'>
<a name='3042'>
END SUBROUTINE advect_v<a name='3043'>
<a name='3044'>
<font color=#447700>!-------------------------------------------------------------------<a name='3045'></font>
<a name='3046'>
#endif<a name='3047'>
<A NAME='ADVECT_SCALAR'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='3048'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_scalar</font>   ( field, field_old, tendency,    &amp; <A href='../../call_to/ADVECT_SCALAR.html' TARGET='index'>5</A>,<A href='../../call_from/ADVECT_SCALAR.html' TARGET='index'>2</A><a name='3049'>
                             ru, rv, rom,                   &amp;<a name='3050'>
                             c1, c2,                        &amp;<a name='3051'>
                             mut, time_step, config_flags,  &amp;<a name='3052'>
                             msfux, msfuy, msfvx, msfvy,    &amp;<a name='3053'>
                             msftx, msfty,                  &amp;<a name='3054'>
                             fzm, fzp,                      &amp;<a name='3055'>
                             rdx, rdy, rdzw,                &amp;<a name='3056'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='3057'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='3058'>
                             its, ite, jts, jte, kts, kte  )<a name='3059'>
<a name='3060'>
   IMPLICIT NONE<a name='3061'>
   <a name='3062'>
   <font color=#447700>! Input data<a name='3063'></font>
   <a name='3064'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='3065'>
<a name='3066'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='3067'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='3068'>
                                              its, ite, jts, jte, kts, kte<a name='3069'>
<a name='3070'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field,     &amp;<a name='3071'>
                                                                      field_old, &amp;<a name='3072'>
                                                                      ru,    &amp;<a name='3073'>
                                                                      rv,    &amp;<a name='3074'>
                                                                      rom<a name='3075'>
<a name='3076'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='3077'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='3078'>
<a name='3079'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='3080'>
                                                                    msfuy,  &amp;<a name='3081'>
                                                                    msfvx,  &amp;<a name='3082'>
                                                                    msfvy,  &amp;<a name='3083'>
                                                                    msftx,  &amp;<a name='3084'>
                                                                    msfty<a name='3085'>
<a name='3086'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='3087'>
                                                                  fzp,  &amp;<a name='3088'>
                                                                  rdzw, &amp;<a name='3089'>
                                                                  c1,   &amp;<a name='3090'>
                                                                  c2<a name='3091'>
<a name='3092'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='3093'>
                                                                  rdy<a name='3094'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='3095'>
<a name='3096'>
<a name='3097'>
   <font color=#447700>! Local data<a name='3098'></font>
   <a name='3099'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='3100'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='3101'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='3102'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='3103'>
<a name='3104'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw<a name='3105'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='3106'>
<a name='3107'>
<a name='3108'>
   REAL,  DIMENSION( its:ite+1, kts:kte  ) :: fqx<a name='3109'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='3110'>
<a name='3111'>
   INTEGER :: horz_order, vert_order<a name='3112'>
   <a name='3113'>
   LOGICAL :: degrade_xs, degrade_ys<a name='3114'>
   LOGICAL :: degrade_xe, degrade_ye<a name='3115'>
<a name='3116'>
   INTEGER :: jp1, jp0, jtmp<a name='3117'>
<a name='3118'>
<a name='3119'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='3120'></font>
<a name='3121'>
   REAL    :: flux3, flux4, flux5, flux6<a name='3122'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='3123'>
<a name='3124'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='3125'>
          ( 7.*(q_i + q_im1) - (q_ip1 + q_im2) )/12.0<a name='3126'>
<a name='3127'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='3128'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='3129'>
           sign(1,time_step)*sign(1.,ua)*((q_ip1 - q_im2)-3.*(q_i-q_im1))/12.0<a name='3130'>
<a name='3131'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='3132'>
          ( 37.*(q_i+q_im1) - 8.*(q_ip1+q_im2)                  &amp;<a name='3133'>
            +(q_ip2+q_im3) )/60.0<a name='3134'>
<a name='3135'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='3136'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='3137'>
            -sign(1,time_step)*sign(1.,ua)*(                    &amp;<a name='3138'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )/60.0<a name='3139'>
<a name='3140'>
<a name='3141'>
   LOGICAL :: specified<a name='3142'>
<a name='3143'>
   specified = .false.<a name='3144'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='3145'>
<a name='3146'>
<font color=#447700>! set order for the advection schemes<a name='3147'></font>
<a name='3148'>
  ktf=MIN(kte,kde-1)<a name='3149'>
  horz_order = config_flags%h_sca_adv_order<a name='3150'>
  vert_order = config_flags%v_sca_adv_order<a name='3151'>
<a name='3152'>
<font color=#447700>!  begin with horizontal flux divergence<a name='3153'></font>
<font color=#447700>!  here is the choice of flux operators<a name='3154'></font>
<a name='3155'>
<a name='3156'>
  horizontal_order_test : IF( horz_order == 6 ) THEN<a name='3157'>
<a name='3158'>
<font color=#447700>!  determine boundary mods for flux operators<a name='3159'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='3160'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='3161'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='3162'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='3163'></font>
<font color=#447700>!   of the higher order flux stencils<a name='3164'></font>
<a name='3165'>
   degrade_xs = .true.<a name='3166'>
   degrade_xe = .true.<a name='3167'>
   degrade_ys = .true.<a name='3168'>
   degrade_ye = .true.<a name='3169'>
<a name='3170'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3171'>
       config_flags%symmetric_xs .or. &amp;<a name='3172'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='3173'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3174'>
       config_flags%symmetric_xe .or. &amp;<a name='3175'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='3176'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3177'>
       config_flags%symmetric_ys .or. &amp;<a name='3178'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='3179'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3180'>
       config_flags%symmetric_ye .or. &amp;<a name='3181'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='3182'>
<a name='3183'>
<font color=#447700>!--------------- y - advection first<a name='3184'></font>
<a name='3185'>
      ktf=MIN(kte,kde-1)<a name='3186'>
      i_start = its<a name='3187'>
      i_end   = MIN(ite,ide-1)<a name='3188'>
      j_start = jts<a name='3189'>
      j_end   = MIN(jte,jde-1)<a name='3190'>
<a name='3191'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='3192'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3193'></font>
<a name='3194'>
      j_start_f = j_start<a name='3195'>
      j_end_f   = j_end+1<a name='3196'>
<a name='3197'>
      IF(degrade_ys) then<a name='3198'>
        j_start = MAX(jts,jds+1)<a name='3199'>
        j_start_f = jds+3<a name='3200'>
      ENDIF<a name='3201'>
<a name='3202'>
      IF(degrade_ye) then<a name='3203'>
        j_end = MIN(jte,jde-2)<a name='3204'>
        j_end_f = jde-3<a name='3205'>
      ENDIF<a name='3206'>
<a name='3207'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='3208'>
<a name='3209'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='3210'></font>
<a name='3211'>
     jp1 = 2<a name='3212'>
     jp0 = 1<a name='3213'>
<a name='3214'>
     j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='3215'>
<a name='3216'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='3217'></font>
<a name='3218'>
        DO k=kts,ktf<a name='3219'>
        DO i = i_start, i_end<a name='3220'>
          vel = rv(i,k,j)<a name='3221'>
          fqy( i, k, jp1 ) = vel*flux6(                                &amp;<a name='3222'>
                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='3223'>
                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='3224'>
        ENDDO<a name='3225'>
        ENDDO<a name='3226'>
<a name='3227'>
<a name='3228'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='3229'></font>
<a name='3230'>
            DO k=kts,ktf<a name='3231'>
            DO i = i_start, i_end<a name='3232'>
              fqy(i,k, jp1) = 0.5*rv(i,k,j)*          &amp;<a name='3233'>
                     (field(i,k,j)+field(i,k,j-1))<a name='3234'>
<a name='3235'>
            ENDDO<a name='3236'>
            ENDDO<a name='3237'>
<a name='3238'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! 4th order flux 2 in from south boundary<a name='3239'></font>
<a name='3240'>
            DO k=kts,ktf<a name='3241'>
            DO i = i_start, i_end<a name='3242'>
              vel = rv(i,k,j)<a name='3243'>
              fqy( i, k, jp1 ) = vel*flux4(              &amp;<a name='3244'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='3245'>
            ENDDO<a name='3246'>
            ENDDO<a name='3247'>
<a name='3248'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='3249'></font>
<a name='3250'>
            DO k=kts,ktf<a name='3251'>
            DO i = i_start, i_end<a name='3252'>
              fqy(i, k, jp1) = 0.5*rv(i,k,j)*      &amp;<a name='3253'>
                     (field(i,k,j)+field(i,k,j-1))<a name='3254'>
            ENDDO<a name='3255'>
            ENDDO<a name='3256'>
<a name='3257'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='3258'></font>
<a name='3259'>
            DO k=kts,ktf<a name='3260'>
            DO i = i_start, i_end<a name='3261'>
              vel = rv(i,k,j)<a name='3262'>
              fqy( i, k, jp1) = vel*flux4(             &amp;<a name='3263'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='3264'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='3265'>
            ENDDO<a name='3266'>
            ENDDO<a name='3267'>
<a name='3268'>
     ENDIF<a name='3269'>
<a name='3270'>
<font color=#447700>!  y flux-divergence into tendency<a name='3271'></font>
<a name='3272'>
        <font color=#447700>! Comments on polar boundary conditions<a name='3273'></font>
        <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='3274'></font>
        <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='3275'></font>
        <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='3276'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='3277'>
          DO k=kts,ktf<a name='3278'>
          DO i = i_start, i_end<a name='3279'>
            mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3280'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='3281'>
          END DO<a name='3282'>
          END DO<a name='3283'>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='3284'>
          DO k=kts,ktf<a name='3285'>
          DO i = i_start, i_end<a name='3286'>
            mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3287'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='3288'>
          END DO<a name='3289'>
          END DO<a name='3290'>
        ELSE  <font color=#447700>! normal code<a name='3291'></font>
<a name='3292'>
        IF(j &gt; j_start) THEN<a name='3293'>
<a name='3294'>
          DO k=kts,ktf<a name='3295'>
          DO i = i_start, i_end<a name='3296'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3297'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='3298'>
          ENDDO<a name='3299'>
          ENDDO<a name='3300'>
<a name='3301'>
        ENDIF<a name='3302'>
<a name='3303'>
        END IF<a name='3304'>
<a name='3305'>
        jtmp = jp1<a name='3306'>
        jp1 = jp0<a name='3307'>
        jp0 = jtmp<a name='3308'>
<a name='3309'>
      ENDDO j_loop_y_flux_6<a name='3310'>
<a name='3311'>
<font color=#447700>!  next, x - flux divergence<a name='3312'></font>
<a name='3313'>
      i_start = its<a name='3314'>
      i_end   = MIN(ite,ide-1)<a name='3315'>
<a name='3316'>
      j_start = jts<a name='3317'>
      j_end   = MIN(jte,jde-1)<a name='3318'>
<a name='3319'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='3320'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3321'></font>
<a name='3322'>
      i_start_f = i_start<a name='3323'>
      i_end_f   = i_end+1<a name='3324'>
<a name='3325'>
      IF(degrade_xs) then<a name='3326'>
        i_start = MAX(ids+1,its)<a name='3327'>
<font color=#447700>!        i_start_f = i_start+2<a name='3328'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='3329'>
      ENDIF<a name='3330'>
<a name='3331'>
      IF(degrade_xe) then<a name='3332'>
        i_end = MIN(ide-2,ite)<a name='3333'>
        i_end_f = ide-3<a name='3334'>
      ENDIF<a name='3335'>
<a name='3336'>
<font color=#447700>!  compute fluxes<a name='3337'></font>
<a name='3338'>
      DO j = j_start, j_end<a name='3339'>
<a name='3340'>
<font color=#447700>!  5th or 6th order flux<a name='3341'></font>
<a name='3342'>
        DO k=kts,ktf<a name='3343'>
        DO i = i_start_f, i_end_f<a name='3344'>
          vel = ru(i,k,j)<a name='3345'>
          fqx( i,k ) = vel*flux6( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='3346'>
                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='3347'>
                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='3348'>
                                         vel                             )<a name='3349'>
        ENDDO<a name='3350'>
        ENDDO<a name='3351'>
<a name='3352'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='3353'></font>
<a name='3354'>
        IF( degrade_xs ) THEN<a name='3355'>
<a name='3356'>
          DO i=i_start,i_start_f-1<a name='3357'>
<a name='3358'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='3359'></font>
              DO k=kts,ktf<a name='3360'>
                fqx(i,k) = 0.5*(ru(i,k,j)) &amp;<a name='3361'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='3362'>
              ENDDO<a name='3363'>
            ENDIF<a name='3364'>
<a name='3365'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='3366'></font>
              DO k=kts,ktf<a name='3367'>
                vel = ru(i,k,j)<a name='3368'>
                fqx( i,k ) = vel*flux4( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3369'>
                                              field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3370'>
                                              vel                     )<a name='3371'>
              ENDDO<a name='3372'>
            END IF<a name='3373'>
<a name='3374'>
          ENDDO<a name='3375'>
<a name='3376'>
        ENDIF<a name='3377'>
<a name='3378'>
        IF( degrade_xe ) THEN<a name='3379'>
<a name='3380'>
          DO i = i_end_f+1, i_end+1<a name='3381'>
<a name='3382'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='3383'></font>
              DO k=kts,ktf<a name='3384'>
                fqx(i,k) = 0.5*(ru(i,k,j))      &amp;<a name='3385'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='3386'>
              ENDDO<a name='3387'>
           ENDIF<a name='3388'>
<a name='3389'>
           IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='3390'></font>
             DO k=kts,ktf<a name='3391'>
               vel = ru(i,k,j)<a name='3392'>
               fqx( i,k ) = vel*flux4( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3393'>
                                       field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3394'>
                                       vel                             )<a name='3395'>
             ENDDO<a name='3396'>
           ENDIF<a name='3397'>
<a name='3398'>
         ENDDO<a name='3399'>
<a name='3400'>
       ENDIF<a name='3401'>
<a name='3402'>
<font color=#447700>!  x flux-divergence into tendency<a name='3403'></font>
<a name='3404'>
          DO k=kts,ktf<a name='3405'>
          DO i = i_start, i_end<a name='3406'>
            mrdx=msftx(i,j)*rdx      <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 1st term RHS<a name='3407'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='3408'>
          ENDDO<a name='3409'>
          ENDDO<a name='3410'>
<a name='3411'>
      ENDDO<a name='3412'>
<a name='3413'>
  ELSE IF( horz_order == 5 ) THEN<a name='3414'>
<a name='3415'>
<font color=#447700>!  determine boundary mods for flux operators<a name='3416'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='3417'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='3418'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='3419'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='3420'></font>
<font color=#447700>!   of the higher order flux stencils<a name='3421'></font>
<a name='3422'>
   degrade_xs = .true.<a name='3423'>
   degrade_xe = .true.<a name='3424'>
   degrade_ys = .true.<a name='3425'>
   degrade_ye = .true.<a name='3426'>
<a name='3427'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3428'>
       config_flags%symmetric_xs .or. &amp;<a name='3429'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='3430'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3431'>
       config_flags%symmetric_xe .or. &amp;<a name='3432'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='3433'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3434'>
       config_flags%symmetric_ys .or. &amp;<a name='3435'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='3436'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3437'>
       config_flags%symmetric_ye .or. &amp;<a name='3438'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='3439'>
<a name='3440'>
<font color=#447700>!--------------- y - advection first<a name='3441'></font>
<a name='3442'>
      ktf=MIN(kte,kde-1)<a name='3443'>
      i_start = its<a name='3444'>
      i_end   = MIN(ite,ide-1)<a name='3445'>
      j_start = jts<a name='3446'>
      j_end   = MIN(jte,jde-1)<a name='3447'>
<a name='3448'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='3449'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3450'></font>
<a name='3451'>
      j_start_f = j_start<a name='3452'>
      j_end_f   = j_end+1<a name='3453'>
<a name='3454'>
      IF(degrade_ys) then<a name='3455'>
        j_start = MAX(jts,jds+1)<a name='3456'>
        j_start_f = jds+3<a name='3457'>
      ENDIF<a name='3458'>
<a name='3459'>
      IF(degrade_ye) then<a name='3460'>
        j_end = MIN(jte,jde-2)<a name='3461'>
        j_end_f = jde-3<a name='3462'>
      ENDIF<a name='3463'>
<a name='3464'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='3465'>
<a name='3466'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='3467'></font>
<a name='3468'>
     jp1 = 2<a name='3469'>
     jp0 = 1<a name='3470'>
<a name='3471'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='3472'>
<a name='3473'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='3474'></font>
<a name='3475'>
        DO k=kts,ktf<a name='3476'>
        DO i = i_start, i_end<a name='3477'>
          vel = rv(i,k,j)<a name='3478'>
          fqy( i, k, jp1 ) = vel*flux5(                                &amp;<a name='3479'>
                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='3480'>
                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='3481'>
        ENDDO<a name='3482'>
        ENDDO<a name='3483'>
<a name='3484'>
<a name='3485'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='3486'></font>
<a name='3487'>
            DO k=kts,ktf<a name='3488'>
            DO i = i_start, i_end<a name='3489'>
              fqy(i,k, jp1) = 0.5*rv(i,k,j)*          &amp;<a name='3490'>
                     (field(i,k,j)+field(i,k,j-1))<a name='3491'>
<a name='3492'>
            ENDDO<a name='3493'>
            ENDDO<a name='3494'>
<a name='3495'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='3496'></font>
<a name='3497'>
            DO k=kts,ktf<a name='3498'>
            DO i = i_start, i_end<a name='3499'>
              vel = rv(i,k,j)<a name='3500'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='3501'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='3502'>
            ENDDO<a name='3503'>
            ENDDO<a name='3504'>
<a name='3505'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='3506'></font>
<a name='3507'>
            DO k=kts,ktf<a name='3508'>
            DO i = i_start, i_end<a name='3509'>
              fqy(i, k, jp1) = 0.5*rv(i,k,j)*      &amp;<a name='3510'>
                     (field(i,k,j)+field(i,k,j-1))<a name='3511'>
            ENDDO<a name='3512'>
            ENDDO<a name='3513'>
<a name='3514'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='3515'></font>
<a name='3516'>
            DO k=kts,ktf<a name='3517'>
            DO i = i_start, i_end<a name='3518'>
              vel = rv(i,k,j)<a name='3519'>
              fqy( i, k, jp1) = vel*flux3(             &amp;<a name='3520'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='3521'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='3522'>
            ENDDO<a name='3523'>
            ENDDO<a name='3524'>
<a name='3525'>
     ENDIF<a name='3526'>
<a name='3527'>
<font color=#447700>!  y flux-divergence into tendency<a name='3528'></font>
<a name='3529'>
        <font color=#447700>! Comments on polar boundary conditions<a name='3530'></font>
        <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='3531'></font>
        <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='3532'></font>
        <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='3533'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='3534'>
          DO k=kts,ktf<a name='3535'>
          DO i = i_start, i_end<a name='3536'>
            mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3537'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='3538'>
          END DO<a name='3539'>
          END DO<a name='3540'>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='3541'>
          DO k=kts,ktf<a name='3542'>
          DO i = i_start, i_end<a name='3543'>
            mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3544'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='3545'>
          END DO<a name='3546'>
          END DO<a name='3547'>
        ELSE  <font color=#447700>! normal code<a name='3548'></font>
<a name='3549'>
        IF(j &gt; j_start) THEN<a name='3550'>
<a name='3551'>
          DO k=kts,ktf<a name='3552'>
          DO i = i_start, i_end<a name='3553'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3554'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='3555'>
          ENDDO<a name='3556'>
          ENDDO<a name='3557'>
<a name='3558'>
        ENDIF<a name='3559'>
<a name='3560'>
        END IF<a name='3561'>
<a name='3562'>
        jtmp = jp1<a name='3563'>
        jp1 = jp0<a name='3564'>
        jp0 = jtmp<a name='3565'>
<a name='3566'>
      ENDDO j_loop_y_flux_5<a name='3567'>
<a name='3568'>
<font color=#447700>!  next, x - flux divergence<a name='3569'></font>
<a name='3570'>
      i_start = its<a name='3571'>
      i_end   = MIN(ite,ide-1)<a name='3572'>
<a name='3573'>
      j_start = jts<a name='3574'>
      j_end   = MIN(jte,jde-1)<a name='3575'>
<a name='3576'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='3577'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3578'></font>
<a name='3579'>
      i_start_f = i_start<a name='3580'>
      i_end_f   = i_end+1<a name='3581'>
<a name='3582'>
      IF(degrade_xs) then<a name='3583'>
        i_start = MAX(ids+1,its)<a name='3584'>
<font color=#447700>!        i_start_f = i_start+2<a name='3585'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='3586'>
      ENDIF<a name='3587'>
<a name='3588'>
      IF(degrade_xe) then<a name='3589'>
        i_end = MIN(ide-2,ite)<a name='3590'>
        i_end_f = ide-3<a name='3591'>
      ENDIF<a name='3592'>
<a name='3593'>
<font color=#447700>!  compute fluxes<a name='3594'></font>
<a name='3595'>
      DO j = j_start, j_end<a name='3596'>
<a name='3597'>
<font color=#447700>!  5th or 6th order flux<a name='3598'></font>
<a name='3599'>
        DO k=kts,ktf<a name='3600'>
        DO i = i_start_f, i_end_f<a name='3601'>
          vel = ru(i,k,j)<a name='3602'>
          fqx( i,k ) = vel*flux5( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='3603'>
                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='3604'>
                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='3605'>
                                         vel                             )<a name='3606'>
        ENDDO<a name='3607'>
        ENDDO<a name='3608'>
<a name='3609'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='3610'></font>
<a name='3611'>
        IF( degrade_xs ) THEN<a name='3612'>
<a name='3613'>
          DO i=i_start,i_start_f-1<a name='3614'>
<a name='3615'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='3616'></font>
              DO k=kts,ktf<a name='3617'>
                fqx(i,k) = 0.5*(ru(i,k,j)) &amp;<a name='3618'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='3619'>
              ENDDO<a name='3620'>
            ENDIF<a name='3621'>
<a name='3622'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='3623'></font>
              DO k=kts,ktf<a name='3624'>
                vel = ru(i,k,j)<a name='3625'>
                fqx( i,k ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3626'>
                                              field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3627'>
                                              vel                     )<a name='3628'>
              ENDDO<a name='3629'>
            END IF<a name='3630'>
<a name='3631'>
          ENDDO<a name='3632'>
<a name='3633'>
        ENDIF<a name='3634'>
<a name='3635'>
        IF( degrade_xe ) THEN<a name='3636'>
<a name='3637'>
          DO i = i_end_f+1, i_end+1<a name='3638'>
<a name='3639'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='3640'></font>
              DO k=kts,ktf<a name='3641'>
                fqx(i,k) = 0.5*(ru(i,k,j))      &amp;<a name='3642'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='3643'>
              ENDDO<a name='3644'>
           ENDIF<a name='3645'>
<a name='3646'>
           IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='3647'></font>
             DO k=kts,ktf<a name='3648'>
               vel = ru(i,k,j)<a name='3649'>
               fqx( i,k ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3650'>
                                       field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3651'>
                                       vel                             )<a name='3652'>
             ENDDO<a name='3653'>
           ENDIF<a name='3654'>
<a name='3655'>
         ENDDO<a name='3656'>
<a name='3657'>
       ENDIF<a name='3658'>
<a name='3659'>
<font color=#447700>!  x flux-divergence into tendency<a name='3660'></font>
<a name='3661'>
          DO k=kts,ktf<a name='3662'>
          DO i = i_start, i_end<a name='3663'>
            mrdx=msftx(i,j)*rdx      <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 1st term RHS<a name='3664'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='3665'>
          ENDDO<a name='3666'>
          ENDDO<a name='3667'>
<a name='3668'>
      ENDDO<a name='3669'>
<a name='3670'>
<a name='3671'>
   ELSE IF( horz_order == 4 ) THEN<a name='3672'>
<a name='3673'>
   degrade_xs = .true.<a name='3674'>
   degrade_xe = .true.<a name='3675'>
   degrade_ys = .true.<a name='3676'>
   degrade_ye = .true.<a name='3677'>
<a name='3678'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3679'>
       config_flags%symmetric_xs .or. &amp;<a name='3680'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='3681'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3682'>
       config_flags%symmetric_xe .or. &amp;<a name='3683'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='3684'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3685'>
       config_flags%symmetric_ys .or. &amp;<a name='3686'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='3687'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3688'>
       config_flags%symmetric_ye .or. &amp;<a name='3689'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='3690'>
<a name='3691'>
<font color=#447700>!  begin flux computations<a name='3692'></font>
<font color=#447700>!  start with x flux divergence<a name='3693'></font>
<a name='3694'>
   ktf=MIN(kte,kde-1)<a name='3695'>
<a name='3696'>
      i_start = its<a name='3697'>
      i_end   = MIN(ite,ide-1)<a name='3698'>
      j_start = jts<a name='3699'>
      j_end   = MIN(jte,jde-1)<a name='3700'>
<a name='3701'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='3702'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3703'></font>
<a name='3704'>
      i_start_f = i_start<a name='3705'>
      i_end_f   = i_end+1<a name='3706'>
<a name='3707'>
      IF(degrade_xs) then<a name='3708'>
        i_start = ids+1<a name='3709'>
        i_start_f = i_start+1<a name='3710'>
      ENDIF<a name='3711'>
<a name='3712'>
      IF(degrade_xe) then<a name='3713'>
        i_end = ide-2<a name='3714'>
        i_end_f = ide-2<a name='3715'>
      ENDIF<a name='3716'>
<a name='3717'>
<font color=#447700>!  compute fluxes<a name='3718'></font>
<a name='3719'>
      DO j = j_start, j_end<a name='3720'>
<a name='3721'>
<font color=#447700>!  3rd or 4th order flux<a name='3722'></font>
<a name='3723'>
        DO k=kts,ktf<a name='3724'>
        DO i = i_start_f, i_end_f<a name='3725'>
<a name='3726'>
          fqx( i, k) = ru(i,k,j)*flux4( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3727'>
                                        field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3728'>
                                        ru(i,k,j)                       )<a name='3729'>
        ENDDO<a name='3730'>
        ENDDO<a name='3731'>
<a name='3732'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='3733'></font>
<a name='3734'>
        IF( degrade_xs ) THEN<a name='3735'>
          DO k=kts,ktf<a name='3736'>
            fqx(i_start, k) = 0.5*ru(i_start,k,j)             &amp;<a name='3737'>
                   *(field(i_start,k,j)+field(i_start-1,k,j))<a name='3738'>
          ENDDO<a name='3739'>
        ENDIF<a name='3740'>
<a name='3741'>
        IF( degrade_xe ) THEN<a name='3742'>
          DO k=kts,ktf<a name='3743'>
            fqx(i_end+1,k ) = 0.5*ru(i_end+1,k,j)          &amp;<a name='3744'>
                   *(field(i_end+1,k,j)+field(i_end,k,j))<a name='3745'>
          ENDDO<a name='3746'>
        ENDIF<a name='3747'>
<a name='3748'>
<font color=#447700>!  x flux-divergence into tendency<a name='3749'></font>
<a name='3750'>
        DO k=kts,ktf<a name='3751'>
        DO i = i_start, i_end<a name='3752'>
          mrdx=msftx(i,j)*rdx        <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 1st term RHS<a name='3753'></font>
          tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='3754'>
        ENDDO<a name='3755'>
        ENDDO<a name='3756'>
<a name='3757'>
      ENDDO<a name='3758'>
<a name='3759'>
<a name='3760'>
<font color=#447700>!  next -&gt; y flux divergence calculation<a name='3761'></font>
<a name='3762'>
      i_start = its<a name='3763'>
      i_end   = MIN(ite,ide-1)<a name='3764'>
      j_start = jts<a name='3765'>
      j_end   = MIN(jte,jde-1)<a name='3766'>
<a name='3767'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='3768'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3769'></font>
<a name='3770'>
      j_start_f = j_start<a name='3771'>
      j_end_f   = j_end+1<a name='3772'>
<a name='3773'>
      IF(degrade_ys) then<a name='3774'>
        j_start = jds+1<a name='3775'>
        j_start_f = j_start+1<a name='3776'>
      ENDIF<a name='3777'>
<a name='3778'>
      IF(degrade_ye) then<a name='3779'>
        j_end = jde-2<a name='3780'>
        j_end_f = jde-2<a name='3781'>
      ENDIF<a name='3782'>
<a name='3783'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='3784'>
<a name='3785'>
    jp1 = 2<a name='3786'>
    jp0 = 1<a name='3787'>
<a name='3788'>
  DO j = j_start, j_end+1<a name='3789'>
<a name='3790'>
    IF ((j &lt; j_start_f) .and. degrade_ys) THEN<a name='3791'>
      DO k = kts, ktf<a name='3792'>
      DO i = i_start, i_end<a name='3793'>
         fqy(i,k,jp1) = 0.5*rv(i,k,j_start)             &amp;<a name='3794'>
                *(field(i,k,j_start)+field(i,k,j_start-1))<a name='3795'>
      ENDDO<a name='3796'>
      ENDDO<a name='3797'>
    ELSE IF ((j &gt; j_end_f) .and. degrade_ye) THEN<a name='3798'>
      DO k = kts, ktf<a name='3799'>
      DO i = i_start, i_end<a name='3800'>
         <font color=#447700>! Assumes j&gt;j_end_f is ONLY j_end+1 ...<a name='3801'></font>
<font color=#447700>!         fqy(i,k,jp1) = 0.5*rv(i,k,j_end+1)          &amp;<a name='3802'></font>
<font color=#447700>!                *(field(i,k,j_end+1)+field(i,k,j_end))<a name='3803'></font>
         fqy(i,k,jp1) = 0.5*rv(i,k,j)          &amp;<a name='3804'>
                *(field(i,k,j)+field(i,k,j-1))<a name='3805'>
      ENDDO<a name='3806'>
      ENDDO<a name='3807'>
    ELSE<a name='3808'>
<font color=#447700>!  3rd or 4th order flux<a name='3809'></font>
      DO k = kts, ktf<a name='3810'>
      DO i = i_start, i_end<a name='3811'>
         fqy( i, k, jp1 ) = rv(i,k,j)*flux4( field(i,k,j-2), field(i,k,j-1),  &amp;<a name='3812'>
                                            field(i,k,j  ), field(i,k,j+1),  &amp;<a name='3813'>
                                            rv(i,k,j)                       )<a name='3814'>
      ENDDO<a name='3815'>
      ENDDO<a name='3816'>
    END IF<a name='3817'>
<a name='3818'>
<font color=#447700>!  y flux-divergence into tendency<a name='3819'></font>
<a name='3820'>
    <font color=#447700>! Comments on polar boundary conditions<a name='3821'></font>
    <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='3822'></font>
    <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='3823'></font>
    <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='3824'></font>
    IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='3825'>
      DO k=kts,ktf<a name='3826'>
      DO i = i_start, i_end<a name='3827'>
        mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3828'></font>
        tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='3829'>
      END DO<a name='3830'>
      END DO<a name='3831'>
    ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='3832'>
      DO k=kts,ktf<a name='3833'>
      DO i = i_start, i_end<a name='3834'>
        mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3835'></font>
        tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='3836'>
      END DO<a name='3837'>
      END DO<a name='3838'>
    ELSE  <font color=#447700>! normal code<a name='3839'></font>
<a name='3840'>
    IF ( j &gt; j_start ) THEN<a name='3841'>
<a name='3842'>
      DO k=kts,ktf<a name='3843'>
      DO i = i_start, i_end<a name='3844'>
        mrdy=msftx(i,j-1)*rdy        <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='3845'></font>
        tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='3846'>
      ENDDO<a name='3847'>
      ENDDO<a name='3848'>
<a name='3849'>
    END IF<a name='3850'>
<a name='3851'>
    END IF<a name='3852'>
<a name='3853'>
    jtmp = jp1<a name='3854'>
    jp1 = jp0<a name='3855'>
    jp0 = jtmp<a name='3856'>
<a name='3857'>
  ENDDO<a name='3858'>
<a name='3859'>
<a name='3860'>
   ELSE IF( horz_order == 3 ) THEN<a name='3861'>
<a name='3862'>
   degrade_xs = .true.<a name='3863'>
   degrade_xe = .true.<a name='3864'>
   degrade_ys = .true.<a name='3865'>
   degrade_ye = .true.<a name='3866'>
<a name='3867'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3868'>
       config_flags%symmetric_xs .or. &amp;<a name='3869'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='3870'>
   IF( config_flags%periodic_x   .or. &amp;<a name='3871'>
       config_flags%symmetric_xe .or. &amp;<a name='3872'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='3873'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3874'>
       config_flags%symmetric_ys .or. &amp;<a name='3875'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='3876'>
   IF( config_flags%periodic_y   .or. &amp;<a name='3877'>
       config_flags%symmetric_ye .or. &amp;<a name='3878'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='3879'>
<a name='3880'>
<font color=#447700>!  begin flux computations<a name='3881'></font>
<font color=#447700>!  start with x flux divergence<a name='3882'></font>
<a name='3883'>
   ktf=MIN(kte,kde-1)<a name='3884'>
<a name='3885'>
      i_start = its<a name='3886'>
      i_end   = MIN(ite,ide-1)<a name='3887'>
      j_start = jts<a name='3888'>
      j_end   = MIN(jte,jde-1)<a name='3889'>
<a name='3890'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='3891'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3892'></font>
<a name='3893'>
      i_start_f = i_start<a name='3894'>
      i_end_f   = i_end+1<a name='3895'>
<a name='3896'>
      IF(degrade_xs) then<a name='3897'>
        i_start = ids+1<a name='3898'>
        i_start_f = i_start+1<a name='3899'>
      ENDIF<a name='3900'>
<a name='3901'>
      IF(degrade_xe) then<a name='3902'>
        i_end = ide-2<a name='3903'>
        i_end_f = ide-2<a name='3904'>
      ENDIF<a name='3905'>
<a name='3906'>
<font color=#447700>!  compute fluxes<a name='3907'></font>
<a name='3908'>
      DO j = j_start, j_end<a name='3909'>
<a name='3910'>
<font color=#447700>!  3rd or 4th order flux<a name='3911'></font>
<a name='3912'>
        DO k=kts,ktf<a name='3913'>
        DO i = i_start_f, i_end_f<a name='3914'>
<a name='3915'>
          fqx( i, k) = ru(i,k,j)*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='3916'>
                                        field(i  ,k,j), field(i+1,k,j),  &amp;<a name='3917'>
                                        ru(i,k,j)                       )<a name='3918'>
        ENDDO<a name='3919'>
        ENDDO<a name='3920'>
<a name='3921'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='3922'></font>
<a name='3923'>
        IF( degrade_xs ) THEN<a name='3924'>
          DO k=kts,ktf<a name='3925'>
            fqx(i_start, k) = 0.5*ru(i_start,k,j)             &amp;<a name='3926'>
                   *(field(i_start,k,j)+field(i_start-1,k,j))<a name='3927'>
          ENDDO<a name='3928'>
        ENDIF<a name='3929'>
<a name='3930'>
        IF( degrade_xe ) THEN<a name='3931'>
          DO k=kts,ktf<a name='3932'>
            fqx(i_end+1,k ) = 0.5*ru(i_end+1,k,j)          &amp;<a name='3933'>
                   *(field(i_end+1,k,j)+field(i_end,k,j))<a name='3934'>
          ENDDO<a name='3935'>
        ENDIF<a name='3936'>
<a name='3937'>
<font color=#447700>!  x flux-divergence into tendency<a name='3938'></font>
<a name='3939'>
        DO k=kts,ktf<a name='3940'>
        DO i = i_start, i_end<a name='3941'>
          mrdx=msftx(i,j)*rdx        <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 1st term RHS<a name='3942'></font>
          tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='3943'>
        ENDDO<a name='3944'>
        ENDDO<a name='3945'>
<a name='3946'>
      ENDDO<a name='3947'>
<a name='3948'>
<a name='3949'>
<font color=#447700>!  next -&gt; y flux divergence calculation<a name='3950'></font>
<a name='3951'>
      i_start = its<a name='3952'>
      i_end   = MIN(ite,ide-1)<a name='3953'>
      j_start = jts<a name='3954'>
      j_end   = MIN(jte,jde-1)<a name='3955'>
<a name='3956'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='3957'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='3958'></font>
<a name='3959'>
      j_start_f = j_start<a name='3960'>
      j_end_f   = j_end+1<a name='3961'>
<a name='3962'>
      IF(degrade_ys) then<a name='3963'>
        j_start = jds+1<a name='3964'>
        j_start_f = j_start+1<a name='3965'>
      ENDIF<a name='3966'>
<a name='3967'>
      IF(degrade_ye) then<a name='3968'>
        j_end = jde-2<a name='3969'>
        j_end_f = jde-2<a name='3970'>
      ENDIF<a name='3971'>
<a name='3972'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='3973'>
<a name='3974'>
    jp1 = 2<a name='3975'>
    jp0 = 1<a name='3976'>
<a name='3977'>
  DO j = j_start, j_end+1<a name='3978'>
<a name='3979'>
    IF ((j &lt; j_start_f) .and. degrade_ys) THEN<a name='3980'>
      DO k = kts, ktf<a name='3981'>
      DO i = i_start, i_end<a name='3982'>
         fqy(i,k,jp1) = 0.5*rv(i,k,j_start)             &amp;<a name='3983'>
                *(field(i,k,j_start)+field(i,k,j_start-1))<a name='3984'>
      ENDDO<a name='3985'>
      ENDDO<a name='3986'>
    ELSE IF ((j &gt; j_end_f) .and. degrade_ye) THEN<a name='3987'>
      DO k = kts, ktf<a name='3988'>
      DO i = i_start, i_end<a name='3989'>
         <font color=#447700>! Assumes j&gt;j_end_f is ONLY j_end+1 ...<a name='3990'></font>
<font color=#447700>!         fqy(i,k,jp1) = 0.5*rv(i,k,j_end+1)          &amp;<a name='3991'></font>
<font color=#447700>!                *(field(i,k,j_end+1)+field(i,k,j_end))<a name='3992'></font>
         fqy(i,k,jp1) = 0.5*rv(i,k,j)          &amp;<a name='3993'>
                *(field(i,k,j)+field(i,k,j-1))<a name='3994'>
      ENDDO<a name='3995'>
      ENDDO<a name='3996'>
    ELSE<a name='3997'>
<font color=#447700>!  3rd or 4th order flux<a name='3998'></font>
      DO k = kts, ktf<a name='3999'>
      DO i = i_start, i_end<a name='4000'>
         fqy( i, k, jp1 ) = rv(i,k,j)*flux3( field(i,k,j-2), field(i,k,j-1),  &amp;<a name='4001'>
                                            field(i,k,j  ), field(i,k,j+1),  &amp;<a name='4002'>
                                            rv(i,k,j)                       )<a name='4003'>
      ENDDO<a name='4004'>
      ENDDO<a name='4005'>
    END IF<a name='4006'>
<a name='4007'>
<font color=#447700>!  y flux-divergence into tendency<a name='4008'></font>
<a name='4009'>
    <font color=#447700>! Comments on polar boundary conditions<a name='4010'></font>
    <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='4011'></font>
    <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='4012'></font>
    <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='4013'></font>
    IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='4014'>
      DO k=kts,ktf<a name='4015'>
      DO i = i_start, i_end<a name='4016'>
        mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='4017'></font>
        tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='4018'>
      END DO<a name='4019'>
      END DO<a name='4020'>
    ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='4021'>
      DO k=kts,ktf<a name='4022'>
      DO i = i_start, i_end<a name='4023'>
        mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='4024'></font>
        tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='4025'>
      END DO<a name='4026'>
      END DO<a name='4027'>
    ELSE  <font color=#447700>! normal code<a name='4028'></font>
<a name='4029'>
    IF ( j &gt; j_start ) THEN<a name='4030'>
<a name='4031'>
      DO k=kts,ktf<a name='4032'>
      DO i = i_start, i_end<a name='4033'>
        mrdy=msftx(i,j-1)*rdy        <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='4034'></font>
        tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='4035'>
      ENDDO<a name='4036'>
      ENDDO<a name='4037'>
<a name='4038'>
    END IF<a name='4039'>
<a name='4040'>
    END IF<a name='4041'>
<a name='4042'>
    jtmp = jp1<a name='4043'>
    jp1 = jp0<a name='4044'>
    jp0 = jtmp<a name='4045'>
<a name='4046'>
  ENDDO<a name='4047'>
<a name='4048'>
   ELSE IF( horz_order == 2 ) THEN<a name='4049'>
<a name='4050'>
      i_start = its<a name='4051'>
      i_end   = MIN(ite,ide-1)<a name='4052'>
      j_start = jts<a name='4053'>
      j_end   = MIN(jte,jde-1)<a name='4054'>
<a name='4055'>
      IF ( .NOT. config_flags%periodic_x ) THEN<a name='4056'>
        IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='4057'>
        IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='4058'>
      ENDIF<a name='4059'>
<a name='4060'>
      DO j = j_start, j_end<a name='4061'>
      DO k = kts, ktf<a name='4062'>
      DO i = i_start, i_end<a name='4063'>
         mrdx=msftx(i,j)*rdx         <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 1st term RHS<a name='4064'></font>
         tendency(i,k,j)=tendency(i,k,j)-mrdx*0.5 &amp;<a name='4065'>
                         *(ru(i+1,k,j)*(field(i+1,k,j)+field(i  ,k,j)) &amp;<a name='4066'>
                          -ru(i  ,k,j)*(field(i  ,k,j)+field(i-1,k,j)))<a name='4067'>
      ENDDO<a name='4068'>
      ENDDO<a name='4069'>
      ENDDO<a name='4070'>
<a name='4071'>
      i_start = its<a name='4072'>
      i_end   = MIN(ite,ide-1)<a name='4073'>
<a name='4074'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='4075'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='4076'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-2,jte)<a name='4077'>
<a name='4078'>
      DO j = j_start, j_end<a name='4079'>
      DO k = kts, ktf<a name='4080'>
      DO i = i_start, i_end<a name='4081'>
         mrdy=msftx(i,j)*rdy         <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='4082'></font>
         tendency(i,k,j)=tendency(i,k,j) -mrdy*0.5 &amp;<a name='4083'>
                         *(rv(i,k,j+1)*(field(i,k,j+1)+field(i,k,j  )) &amp;<a name='4084'>
                          -rv(i,k,j  )*(field(i,k,j  )+field(i,k,j-1))) <a name='4085'>
      ENDDO<a name='4086'>
      ENDDO<a name='4087'>
      ENDDO<a name='4088'>
   <a name='4089'>
      <font color=#447700>! Polar boundary condtions<a name='4090'></font>
      <font color=#447700>! These won't be covered in the loop above...<a name='4091'></font>
      IF (config_flags%polar) THEN<a name='4092'>
         IF (jts == jds) THEN<a name='4093'>
            DO k=kts,ktf<a name='4094'>
            DO i = i_start, i_end<a name='4095'>
               mrdy=msftx(i,jds)*rdy <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='4096'></font>
               tendency(i,k,jds)=tendency(i,k,jds) -mrdy*0.5 &amp;<a name='4097'>
                                *rv(i,k,jds+1)*(field(i,k,jds+1)+field(i,k,jds))<a name='4098'>
            END DO<a name='4099'>
            END DO<a name='4100'>
         END IF<a name='4101'>
         IF (jte == jde) THEN<a name='4102'>
            DO k=kts,ktf<a name='4103'>
            DO i = i_start, i_end<a name='4104'>
               mrdy=msftx(i,jde-1)*rdy <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='4105'></font>
               tendency(i,k,jde-1)=tendency(i,k,jde-1) +mrdy*0.5 &amp;<a name='4106'>
                                  *rv(i,k,jde-1)*(field(i,k,jde-1)+field(i,k,jde-2))<a name='4107'>
            END DO<a name='4108'>
            END DO<a name='4109'>
         END IF<a name='4110'>
      END IF<a name='4111'>
<a name='4112'>
   ELSE IF ( horz_order == 0 ) THEN<a name='4113'>
<a name='4114'>
      <font color=#447700>! Just in case we want to turn horizontal advection off, we can do it<a name='4115'></font>
<a name='4116'>
   ELSE<a name='4117'>
<a name='4118'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_scalar_6a, h_order not known ',horz_order<a name='4119'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_5"> ( TRIM( wrf_err_message ) )<a name='4120'>
<a name='4121'>
   ENDIF horizontal_order_test<a name='4122'>
<a name='4123'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='4124'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='4125'></font>
<font color=#447700>!  first, set to index ranges<a name='4126'></font>
<a name='4127'>
      i_start = its<a name='4128'>
      i_end   = MIN(ite,ide-1)<a name='4129'>
      j_start = jts<a name='4130'>
      j_end   = MIN(jte,jde-1)<a name='4131'>
<a name='4132'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='4133'></font>
<a name='4134'>
   IF( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='4135'>
<a name='4136'>
       DO j = j_start, j_end<a name='4137'>
       DO k = kts, ktf<a name='4138'>
         ub = MIN( 0.5*(ru(its,k,j)+ru(its+1,k,j)), 0. )<a name='4139'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='4140'>
               - rdx*(                                             &amp;<a name='4141'>
                       ub*(   field_old(its+1,k,j)                 &amp;<a name='4142'>
                            - field_old(its  ,k,j)   ) +           &amp;<a name='4143'>
                       field(its,k,j)*(ru(its+1,k,j)-ru(its,k,j))  &amp;<a name='4144'>
                                                                )<a name='4145'>
       ENDDO<a name='4146'>
       ENDDO<a name='4147'>
<a name='4148'>
   ENDIF<a name='4149'>
<a name='4150'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='4151'>
<a name='4152'>
       DO j = j_start, j_end<a name='4153'>
       DO k = kts, ktf<a name='4154'>
         ub = MAX( 0.5*(ru(ite-1,k,j)+ru(ite,k,j)), 0. )<a name='4155'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                   &amp;<a name='4156'>
               - rdx*(                                               &amp;<a name='4157'>
                       ub*(  field_old(i_end  ,k,j)                  &amp;<a name='4158'>
                           - field_old(i_end-1,k,j) ) +              &amp;<a name='4159'>
                       field(i_end,k,j)*(ru(ite,k,j)-ru(ite-1,k,j))  &amp;<a name='4160'>
                                                                    )<a name='4161'>
       ENDDO<a name='4162'>
       ENDDO<a name='4163'>
<a name='4164'>
   ENDIF<a name='4165'>
<a name='4166'>
   IF( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='4167'>
<a name='4168'>
       DO i = i_start, i_end<a name='4169'>
       DO k = kts, ktf<a name='4170'>
         vb = MIN( 0.5*(rv(i,k,jts)+rv(i,k,jts+1)), 0. )<a name='4171'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='4172'>
               - rdy*(                                             &amp;<a name='4173'>
                       vb*(  field_old(i,k,jts+1)                  &amp;<a name='4174'>
                           - field_old(i,k,jts  ) ) +              &amp;<a name='4175'>
                       field(i,k,jts)*(rv(i,k,jts+1)-rv(i,k,jts))  &amp;<a name='4176'>
                                                                )<a name='4177'>
       ENDDO<a name='4178'>
       ENDDO<a name='4179'>
<a name='4180'>
   ENDIF<a name='4181'>
<a name='4182'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='4183'>
<a name='4184'>
       DO i = i_start, i_end<a name='4185'>
       DO k = kts, ktf<a name='4186'>
         vb = MAX( 0.5*(rv(i,k,jte-1)+rv(i,k,jte)), 0. )<a name='4187'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                   &amp;<a name='4188'>
               - rdy*(                                               &amp;<a name='4189'>
                       vb*(   field_old(i,k,j_end  )                 &amp;<a name='4190'>
                            - field_old(i,k,j_end-1) ) +             &amp;<a name='4191'>
                       field(i,k,j_end)*(rv(i,k,jte)-rv(i,k,jte-1))  &amp;<a name='4192'>
                                                                    )<a name='4193'>
       ENDDO<a name='4194'>
       ENDDO<a name='4195'>
<a name='4196'>
   ENDIF<a name='4197'>
<a name='4198'>
<a name='4199'>
<font color=#447700>!-------------------- vertical advection<a name='4200'></font>
<font color=#447700>!     Scalar equation has 3rd term on RHS = - partial d/dz (q rho w /my)<a name='4201'></font>
<font color=#447700>!     Here we have: - partial d/dz (q*rom) = - partial d/dz (q rho w / my)<a name='4202'></font>
<font color=#447700>!     So we don't need to make a correction for advect_scalar<a name='4203'></font>
<a name='4204'>
      i_start = its<a name='4205'>
      i_end   = MIN(ite,ide-1)<a name='4206'>
      j_start = jts<a name='4207'>
      j_end   = MIN(jte,jde-1)<a name='4208'>
<a name='4209'>
      DO i = i_start, i_end<a name='4210'>
         vflux(i,kts)=0.<a name='4211'>
         vflux(i,kte)=0.<a name='4212'>
      ENDDO<a name='4213'>
<a name='4214'>
    vert_order_test : IF (vert_order == 6) THEN    <a name='4215'>
<a name='4216'>
      DO j = j_start, j_end<a name='4217'>
<a name='4218'>
         DO k=kts+3,ktf-2<a name='4219'>
         DO i = i_start, i_end<a name='4220'>
           vel=rom(i,k,j)<a name='4221'>
           vflux(i,k) = vel*flux6(                                 &amp;<a name='4222'>
                   field(i,k-3,j), field(i,k-2,j), field(i,k-1,j),       &amp;<a name='4223'>
                   field(i,k  ,j), field(i,k+1,j), field(i,k+2,j),  -vel )<a name='4224'>
         ENDDO<a name='4225'>
         ENDDO<a name='4226'>
<a name='4227'>
         DO i = i_start, i_end<a name='4228'>
<a name='4229'>
           k=kts+1<a name='4230'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4231'>
                                   <a name='4232'>
           k = kts+2<a name='4233'>
           vel=rom(i,k,j) <a name='4234'>
           vflux(i,k) = vel*flux4(               &amp;<a name='4235'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='4236'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='4237'>
           k = ktf-1<a name='4238'>
           vel=rom(i,k,j)<a name='4239'>
           vflux(i,k) = vel*flux4(               &amp;<a name='4240'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='4241'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='4242'>
<a name='4243'>
           k=ktf<a name='4244'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4245'>
         ENDDO<a name='4246'>
<a name='4247'>
         DO k=kts,ktf<a name='4248'>
         DO i = i_start, i_end<a name='4249'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='4250'>
         ENDDO<a name='4251'>
         ENDDO<a name='4252'>
<a name='4253'>
      ENDDO<a name='4254'>
<a name='4255'>
   ELSE IF (vert_order == 5) THEN    <a name='4256'>
<a name='4257'>
      DO j = j_start, j_end<a name='4258'>
<a name='4259'>
         DO k=kts+3,ktf-2<a name='4260'>
         DO i = i_start, i_end<a name='4261'>
           vel=rom(i,k,j)<a name='4262'>
           vflux(i,k) = vel*flux5(                                 &amp;<a name='4263'>
                   field(i,k-3,j), field(i,k-2,j), field(i,k-1,j),       &amp;<a name='4264'>
                   field(i,k  ,j), field(i,k+1,j), field(i,k+2,j),  -vel )<a name='4265'>
         ENDDO<a name='4266'>
         ENDDO<a name='4267'>
<a name='4268'>
         DO i = i_start, i_end<a name='4269'>
<a name='4270'>
           k=kts+1<a name='4271'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4272'>
                                   <a name='4273'>
           k = kts+2<a name='4274'>
           vel=rom(i,k,j) <a name='4275'>
           vflux(i,k) = vel*flux3(               &amp;<a name='4276'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='4277'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='4278'>
           k = ktf-1<a name='4279'>
           vel=rom(i,k,j)<a name='4280'>
           vflux(i,k) = vel*flux3(               &amp;<a name='4281'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='4282'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='4283'>
<a name='4284'>
           k=ktf<a name='4285'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4286'>
         ENDDO<a name='4287'>
<a name='4288'>
         DO k=kts,ktf<a name='4289'>
         DO i = i_start, i_end<a name='4290'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='4291'>
         ENDDO<a name='4292'>
         ENDDO<a name='4293'>
<a name='4294'>
      ENDDO<a name='4295'>
<a name='4296'>
   ELSE IF (vert_order == 4) THEN    <a name='4297'>
<a name='4298'>
      DO j = j_start, j_end<a name='4299'>
<a name='4300'>
         DO k=kts+2,ktf-1<a name='4301'>
         DO i = i_start, i_end<a name='4302'>
           vel=rom(i,k,j)<a name='4303'>
           vflux(i,k) = vel*flux4(                                 &amp;<a name='4304'>
                   field(i,k-2,j), field(i,k-1,j),       &amp;<a name='4305'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='4306'>
         ENDDO<a name='4307'>
         ENDDO<a name='4308'>
<a name='4309'>
         DO i = i_start, i_end<a name='4310'>
<a name='4311'>
           k=kts+1<a name='4312'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4313'>
           k=ktf<a name='4314'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4315'>
         ENDDO<a name='4316'>
<a name='4317'>
         DO k=kts,ktf<a name='4318'>
         DO i = i_start, i_end<a name='4319'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='4320'>
         ENDDO<a name='4321'>
         ENDDO<a name='4322'>
<a name='4323'>
      ENDDO<a name='4324'>
<a name='4325'>
   ELSE IF (vert_order == 3) THEN    <a name='4326'>
<a name='4327'>
      DO j = j_start, j_end<a name='4328'>
<a name='4329'>
         DO k=kts+2,ktf-1<a name='4330'>
         DO i = i_start, i_end<a name='4331'>
           vel=rom(i,k,j)<a name='4332'>
           vflux(i,k) = vel*flux3(                      &amp;<a name='4333'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='4334'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='4335'>
         ENDDO<a name='4336'>
         ENDDO<a name='4337'>
<a name='4338'>
         DO i = i_start, i_end<a name='4339'>
<a name='4340'>
           k=kts+1<a name='4341'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4342'>
           k=ktf<a name='4343'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4344'>
         ENDDO<a name='4345'>
<a name='4346'>
         DO k=kts,ktf<a name='4347'>
         DO i = i_start, i_end<a name='4348'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='4349'>
         ENDDO<a name='4350'>
         ENDDO<a name='4351'>
<a name='4352'>
      ENDDO<a name='4353'>
<a name='4354'>
   ELSE IF (vert_order == 2) THEN    <a name='4355'>
<a name='4356'>
  DO j = j_start, j_end<a name='4357'>
     DO k = kts+1, ktf<a name='4358'>
     DO i = i_start, i_end<a name='4359'>
            vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='4360'>
     ENDDO<a name='4361'>
     ENDDO<a name='4362'>
<a name='4363'>
     DO k = kts, ktf<a name='4364'>
     DO i = i_start, i_end<a name='4365'>
       tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='4366'>
     ENDDO<a name='4367'>
     ENDDO<a name='4368'>
<a name='4369'>
  ENDDO<a name='4370'>
<a name='4371'>
   ELSE<a name='4372'>
<a name='4373'>
      WRITE (wrf_err_message,*) ' advect_scalar_6a, v_order not known ',vert_order<a name='4374'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_6"> ( wrf_err_message )<a name='4375'>
<a name='4376'>
   ENDIF vert_order_test<a name='4377'>
<a name='4378'>
END SUBROUTINE advect_scalar<a name='4379'>
#if ( <font color=#447700>! defined(ADVECT_KERNEL) )<a name='4380'></font>
<a name='4381'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='4382'></font>
<a name='4383'>
<A NAME='ADVECT_W'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4384'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_w</font>    ( w, w_old, tendency,            &amp; <A href='../../call_to/ADVECT_W.html' TARGET='index'>1</A>,<A href='../../call_from/ADVECT_W.html' TARGET='index'>2</A><a name='4385'>
                         ru, rv, rom,                   &amp;<a name='4386'>
                         c1, c2,                        &amp;<a name='4387'>
                         mut, time_step, config_flags,  &amp;<a name='4388'>
                         msfux, msfuy, msfvx, msfvy,    &amp;<a name='4389'>
                         msftx, msfty,                  &amp;<a name='4390'>
                         fzm, fzp,                      &amp;<a name='4391'>
                         rdx, rdy, rdzu,                &amp;<a name='4392'>
                         ids, ide, jds, jde, kds, kde,  &amp;<a name='4393'>
                         ims, ime, jms, jme, kms, kme,  &amp;<a name='4394'>
                         its, ite, jts, jte, kts, kte  )<a name='4395'>
<a name='4396'>
   IMPLICIT NONE<a name='4397'>
   <a name='4398'>
   <font color=#447700>! Input data<a name='4399'></font>
   <a name='4400'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='4401'>
<a name='4402'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='4403'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='4404'>
                                              its, ite, jts, jte, kts, kte<a name='4405'>
<a name='4406'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: w,     &amp;<a name='4407'>
                                                                      w_old, &amp;<a name='4408'>
                                                                      ru,    &amp;<a name='4409'>
                                                                      rv,    &amp;<a name='4410'>
                                                                      rom<a name='4411'>
<a name='4412'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='4413'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='4414'>
<a name='4415'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='4416'>
                                                                    msfuy,  &amp;<a name='4417'>
                                                                    msfvx,  &amp;<a name='4418'>
                                                                    msfvy,  &amp;<a name='4419'>
                                                                    msftx,  &amp;<a name='4420'>
                                                                    msfty<a name='4421'>
<a name='4422'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='4423'>
                                                                  fzp,  &amp;<a name='4424'>
                                                                  rdzu, &amp;<a name='4425'>
                                                                  c1,   &amp;<a name='4426'>
                                                                  c2<a name='4427'>
<a name='4428'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='4429'>
                                                                  rdy<a name='4430'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='4431'>
<a name='4432'>
<a name='4433'>
   <font color=#447700>! Local data<a name='4434'></font>
   <a name='4435'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='4436'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='4437'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='4438'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='4439'>
<a name='4440'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw<a name='4441'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='4442'>
<a name='4443'>
   INTEGER :: horz_order, vert_order<a name='4444'>
<a name='4445'>
   REAL,  DIMENSION( its:ite+1, kts:kte ) :: fqx<a name='4446'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='4447'>
   <a name='4448'>
   LOGICAL :: degrade_xs, degrade_ys<a name='4449'>
   LOGICAL :: degrade_xe, degrade_ye<a name='4450'>
<a name='4451'>
   INTEGER :: jp1, jp0, jtmp<a name='4452'>
<a name='4453'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='4454'></font>
<a name='4455'>
   REAL    :: flux3, flux4, flux5, flux6<a name='4456'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='4457'>
<a name='4458'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='4459'>
          ( 7.*(q_i + q_im1) - (q_ip1 + q_im2) )/12.0<a name='4460'>
<a name='4461'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='4462'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='4463'>
           sign(1,time_step)*sign(1.,ua)*((q_ip1 - q_im2)-3.*(q_i-q_im1))/12.0<a name='4464'>
<a name='4465'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='4466'>
                      ( 37.*(q_i+q_im1) - 8.*(q_ip1+q_im2)      &amp;<a name='4467'>
                     +(q_ip2+q_im3) )/60.0<a name='4468'>
<a name='4469'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='4470'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='4471'>
            -sign(1,time_step)*sign(1.,ua)*(                    &amp;<a name='4472'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )/60.0<a name='4473'>
<a name='4474'>
<a name='4475'>
   LOGICAL :: specified<a name='4476'>
<a name='4477'>
   specified = .false.<a name='4478'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='4479'>
<a name='4480'>
<font color=#447700>!  set order for the advection scheme<a name='4481'></font>
<a name='4482'>
  ktf=MIN(kte,kde-1)<a name='4483'>
  horz_order = config_flags%h_sca_adv_order<a name='4484'>
  vert_order = config_flags%v_sca_adv_order<a name='4485'>
<a name='4486'>
<font color=#447700>!  here is the choice of flux operators<a name='4487'></font>
<a name='4488'>
<font color=#447700>!  begin with horizontal flux divergence<a name='4489'></font>
<a name='4490'>
  horizontal_order_test : IF( horz_order == 6 ) THEN<a name='4491'>
<a name='4492'>
<font color=#447700>!  determine boundary mods for flux operators<a name='4493'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='4494'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='4495'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='4496'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='4497'></font>
<font color=#447700>!   of the higher order flux stencils<a name='4498'></font>
<a name='4499'>
   degrade_xs = .true.<a name='4500'>
   degrade_xe = .true.<a name='4501'>
   degrade_ys = .true.<a name='4502'>
   degrade_ye = .true.<a name='4503'>
<a name='4504'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4505'>
       config_flags%symmetric_xs .or. &amp;<a name='4506'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='4507'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4508'>
       config_flags%symmetric_xe .or. &amp;<a name='4509'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='4510'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4511'>
       config_flags%symmetric_ys .or. &amp;<a name='4512'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='4513'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4514'>
       config_flags%symmetric_ye .or. &amp;<a name='4515'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='4516'>
<a name='4517'>
<font color=#447700>!--------------- y - advection first<a name='4518'></font>
<a name='4519'>
      i_start = its<a name='4520'>
      i_end   = MIN(ite,ide-1)<a name='4521'>
      j_start = jts<a name='4522'>
      j_end   = MIN(jte,jde-1)<a name='4523'>
<a name='4524'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='4525'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4526'></font>
<a name='4527'>
      j_start_f = j_start<a name='4528'>
      j_end_f   = j_end+1<a name='4529'>
<a name='4530'>
      IF(degrade_ys) then<a name='4531'>
        j_start = MAX(jts,jds+1)<a name='4532'>
        j_start_f = jds+3<a name='4533'>
      ENDIF<a name='4534'>
<a name='4535'>
      IF(degrade_ye) then<a name='4536'>
        j_end = MIN(jte,jde-2)<a name='4537'>
        j_end_f = jde-3<a name='4538'>
      ENDIF<a name='4539'>
<a name='4540'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='4541'>
<a name='4542'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='4543'></font>
<a name='4544'>
     jp1 = 2<a name='4545'>
     jp0 = 1<a name='4546'>
<a name='4547'>
     j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='4548'>
<a name='4549'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='4550'>
<a name='4551'>
        DO k=kts+1,ktf<a name='4552'>
        DO i = i_start, i_end<a name='4553'>
          vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4554'>
          fqy( i, k, jp1 ) = vel*flux6(                     &amp;<a name='4555'>
                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='4556'>
                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='4557'>
        ENDDO<a name='4558'>
        ENDDO<a name='4559'>
<a name='4560'>
        k = ktf+1<a name='4561'>
        DO i = i_start, i_end<a name='4562'>
          vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4563'>
          fqy( i, k, jp1 ) = vel*flux6(                     &amp;<a name='4564'>
                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='4565'>
                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='4566'>
        ENDDO<a name='4567'>
<a name='4568'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='4569'></font>
<a name='4570'>
            DO k=kts+1,ktf<a name='4571'>
            DO i = i_start, i_end<a name='4572'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*          &amp;<a name='4573'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4574'>
            ENDDO<a name='4575'>
            ENDDO<a name='4576'>
<a name='4577'>
            k = ktf+1<a name='4578'>
            DO i = i_start, i_end<a name='4579'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*          &amp;<a name='4580'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4581'>
            ENDDO<a name='4582'>
<a name='4583'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='4584'></font>
<a name='4585'>
            DO k=kts+1,ktf<a name='4586'>
            DO i = i_start, i_end<a name='4587'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4588'>
              fqy( i, k, jp1 ) = vel*flux4(              &amp;<a name='4589'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='4590'>
            ENDDO<a name='4591'>
            ENDDO<a name='4592'>
<a name='4593'>
            k = ktf+1<a name='4594'>
            DO i = i_start, i_end<a name='4595'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4596'>
              fqy( i, k, jp1 ) = vel*flux4(              &amp;<a name='4597'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='4598'>
            ENDDO<a name='4599'>
<a name='4600'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='4601'></font>
<a name='4602'>
            DO k=kts+1,ktf<a name='4603'>
            DO i = i_start, i_end<a name='4604'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*      &amp;<a name='4605'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4606'>
            ENDDO<a name='4607'>
            ENDDO<a name='4608'>
<a name='4609'>
            k = ktf+1<a name='4610'>
            DO i = i_start, i_end<a name='4611'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*      &amp;<a name='4612'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4613'>
            ENDDO<a name='4614'>
<a name='4615'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='4616'></font>
<a name='4617'>
            DO k=kts+1,ktf<a name='4618'>
            DO i = i_start, i_end<a name='4619'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4620'>
              fqy( i, k, jp1 ) = vel*flux4(             &amp;<a name='4621'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='4622'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='4623'>
            ENDDO<a name='4624'>
            ENDDO<a name='4625'>
<a name='4626'>
            k = ktf+1<a name='4627'>
            DO i = i_start, i_end<a name='4628'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4629'>
              fqy( i, k, jp1 ) = vel*flux4(             &amp;<a name='4630'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='4631'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='4632'>
            ENDDO<a name='4633'>
<a name='4634'>
     ENDIF<a name='4635'>
<a name='4636'>
<font color=#447700>!  y flux-divergence into tendency<a name='4637'></font>
<a name='4638'>
        <font color=#447700>! Comments for polar boundary conditions<a name='4639'></font>
        <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='4640'></font>
        <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='4641'></font>
        <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='4642'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='4643'>
          DO k=kts,ktf<a name='4644'>
          DO i = i_start, i_end<a name='4645'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='4646'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='4647'>
          END DO<a name='4648'>
          END DO<a name='4649'>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='4650'>
          DO k=kts,ktf<a name='4651'>
          DO i = i_start, i_end<a name='4652'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='4653'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='4654'>
          END DO<a name='4655'>
          END DO<a name='4656'>
        ELSE  <font color=#447700>! normal code<a name='4657'></font>
<a name='4658'>
        IF(j &gt; j_start) THEN<a name='4659'>
<a name='4660'>
          DO k=kts+1,ktf+1<a name='4661'>
          DO i = i_start, i_end<a name='4662'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='4663'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='4664'>
          ENDDO<a name='4665'>
          ENDDO<a name='4666'>
<a name='4667'>
       ENDIF<a name='4668'>
<a name='4669'>
        END IF<a name='4670'>
<a name='4671'>
        jtmp = jp1<a name='4672'>
        jp1 = jp0<a name='4673'>
        jp0 = jtmp<a name='4674'>
<a name='4675'>
      ENDDO j_loop_y_flux_6<a name='4676'>
<a name='4677'>
<font color=#447700>!  next, x - flux divergence<a name='4678'></font>
<a name='4679'>
      i_start = its<a name='4680'>
      i_end   = MIN(ite,ide-1)<a name='4681'>
<a name='4682'>
      j_start = jts<a name='4683'>
      j_end   = MIN(jte,jde-1)<a name='4684'>
<a name='4685'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='4686'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4687'></font>
<a name='4688'>
      i_start_f = i_start<a name='4689'>
      i_end_f   = i_end+1<a name='4690'>
<a name='4691'>
      IF(degrade_xs) then<a name='4692'>
        i_start = MAX(ids+1,its)<a name='4693'>
<font color=#447700>!        i_start_f = i_start+2<a name='4694'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='4695'>
      ENDIF<a name='4696'>
<a name='4697'>
      IF(degrade_xe) then<a name='4698'>
        i_end = MIN(ide-2,ite)<a name='4699'>
        i_end_f = ide-3<a name='4700'>
      ENDIF<a name='4701'>
<a name='4702'>
<font color=#447700>!  compute fluxes<a name='4703'></font>
<a name='4704'>
      DO j = j_start, j_end<a name='4705'>
<a name='4706'>
<font color=#447700>!  5th or 6th order flux<a name='4707'></font>
<a name='4708'>
        DO k=kts+1,ktf<a name='4709'>
        DO i = i_start_f, i_end_f<a name='4710'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4711'>
          fqx( i,k ) = vel*flux6( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='4712'>
                                  w(i-1,k,j), w(i  ,k,j),  &amp;<a name='4713'>
                                  w(i+1,k,j), w(i+2,k,j),  &amp;<a name='4714'>
                                  vel                     )<a name='4715'>
        ENDDO<a name='4716'>
        ENDDO<a name='4717'>
<a name='4718'>
        k = ktf+1<a name='4719'>
        DO i = i_start_f, i_end_f<a name='4720'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4721'>
          fqx( i,k ) = vel*flux6( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='4722'>
                                  w(i-1,k,j), w(i  ,k,j),  &amp;<a name='4723'>
                                  w(i+1,k,j), w(i+2,k,j),  &amp;<a name='4724'>
                                  vel                     )<a name='4725'>
        ENDDO<a name='4726'>
<a name='4727'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='4728'></font>
<a name='4729'>
        IF( degrade_xs ) THEN<a name='4730'>
<a name='4731'>
          DO i=i_start,i_start_f-1<a name='4732'>
<a name='4733'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='4734'></font>
              DO k=kts+1,ktf<a name='4735'>
                fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)) &amp;<a name='4736'>
                                *(w(i,k,j)+w(i-1,k,j))<a name='4737'>
              ENDDO<a name='4738'>
              k = ktf+1<a name='4739'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)) &amp;<a name='4740'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4741'>
            ENDIF<a name='4742'>
<a name='4743'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='4744'></font>
              DO k=kts+1,ktf<a name='4745'>
                vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4746'>
                fqx( i,k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4747'>
                                        w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4748'>
                                        vel                     )<a name='4749'>
              ENDDO<a name='4750'>
              k = ktf+1<a name='4751'>
              vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4752'>
              fqx( i,k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4753'>
                                      w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4754'>
                                      vel                     )<a name='4755'>
            END IF<a name='4756'>
<a name='4757'>
          ENDDO<a name='4758'>
<a name='4759'>
        ENDIF<a name='4760'>
<a name='4761'>
        IF( degrade_xe ) THEN<a name='4762'>
<a name='4763'>
          DO i = i_end_f+1, i_end+1<a name='4764'>
<a name='4765'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='4766'></font>
              DO k=kts+1,ktf<a name='4767'>
                fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j))      &amp;<a name='4768'>
                                  *(w(i,k,j)+w(i-1,k,j))<a name='4769'>
              ENDDO<a name='4770'>
              k = ktf+1<a name='4771'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j))      &amp;<a name='4772'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='4773'>
            ENDIF<a name='4774'>
<a name='4775'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='4776'></font>
              DO k=kts+1,ktf<a name='4777'>
                vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='4778'>
                fqx( i,k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4779'>
                                        w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4780'>
                                        vel                     )<a name='4781'>
              ENDDO<a name='4782'>
              k = ktf+1<a name='4783'>
              vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='4784'>
              fqx( i,k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='4785'>
                                      w(i  ,k,j), w(i+1,k,j),  &amp;<a name='4786'>
                                      vel                     )<a name='4787'>
            ENDIF<a name='4788'>
<a name='4789'>
          ENDDO<a name='4790'>
<a name='4791'>
        ENDIF<a name='4792'>
<a name='4793'>
<font color=#447700>!  x flux-divergence into tendency<a name='4794'></font>
<a name='4795'>
        DO k=kts+1,ktf+1<a name='4796'>
          DO i = i_start, i_end<a name='4797'>
            mrdx=msftx(i,j)*rdx      <font color=#447700>! see ADT eqn 46 dividing by my, 1st term RHS<a name='4798'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='4799'>
          ENDDO<a name='4800'>
        ENDDO<a name='4801'>
<a name='4802'>
      ENDDO<a name='4803'>
<a name='4804'>
ELSE IF (horz_order == 5 ) THEN<a name='4805'>
<a name='4806'>
<font color=#447700>!  determine boundary mods for flux operators<a name='4807'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='4808'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='4809'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='4810'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='4811'></font>
<font color=#447700>!   of the higher order flux stencils<a name='4812'></font>
<a name='4813'>
   degrade_xs = .true.<a name='4814'>
   degrade_xe = .true.<a name='4815'>
   degrade_ys = .true.<a name='4816'>
   degrade_ye = .true.<a name='4817'>
<a name='4818'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4819'>
       config_flags%symmetric_xs .or. &amp;<a name='4820'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='4821'>
   IF( config_flags%periodic_x   .or. &amp;<a name='4822'>
       config_flags%symmetric_xe .or. &amp;<a name='4823'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='4824'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4825'>
       config_flags%symmetric_ys .or. &amp;<a name='4826'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='4827'>
   IF( config_flags%periodic_y   .or. &amp;<a name='4828'>
       config_flags%symmetric_ye .or. &amp;<a name='4829'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='4830'>
<a name='4831'>
<font color=#447700>!--------------- y - advection first<a name='4832'></font>
<a name='4833'>
      i_start = its<a name='4834'>
      i_end   = MIN(ite,ide-1)<a name='4835'>
      j_start = jts<a name='4836'>
      j_end   = MIN(jte,jde-1)<a name='4837'>
<a name='4838'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='4839'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='4840'></font>
<a name='4841'>
      j_start_f = j_start<a name='4842'>
      j_end_f   = j_end+1<a name='4843'>
<a name='4844'>
      IF(degrade_ys) then<a name='4845'>
        j_start = MAX(jts,jds+1)<a name='4846'>
        j_start_f = jds+3<a name='4847'>
      ENDIF<a name='4848'>
<a name='4849'>
      IF(degrade_ye) then<a name='4850'>
        j_end = MIN(jte,jde-2)<a name='4851'>
        j_end_f = jde-3<a name='4852'>
      ENDIF<a name='4853'>
<a name='4854'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='4855'>
<a name='4856'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='4857'></font>
<a name='4858'>
     jp1 = 2<a name='4859'>
     jp0 = 1<a name='4860'>
<a name='4861'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='4862'>
<a name='4863'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='4864'>
<a name='4865'>
        DO k=kts+1,ktf<a name='4866'>
        DO i = i_start, i_end<a name='4867'>
          vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4868'>
          fqy( i, k, jp1 ) = vel*flux5(                     &amp;<a name='4869'>
                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='4870'>
                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='4871'>
        ENDDO<a name='4872'>
        ENDDO<a name='4873'>
<a name='4874'>
        k = ktf+1<a name='4875'>
        DO i = i_start, i_end<a name='4876'>
          vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4877'>
          fqy( i, k, jp1 ) = vel*flux5(                     &amp;<a name='4878'>
                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='4879'>
                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='4880'>
        ENDDO<a name='4881'>
<a name='4882'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='4883'></font>
<a name='4884'>
            DO k=kts+1,ktf<a name='4885'>
            DO i = i_start, i_end<a name='4886'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*          &amp;<a name='4887'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4888'>
            ENDDO<a name='4889'>
            ENDDO<a name='4890'>
<a name='4891'>
            k = ktf+1<a name='4892'>
            DO i = i_start, i_end<a name='4893'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*          &amp;<a name='4894'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4895'>
            ENDDO<a name='4896'>
<a name='4897'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='4898'></font>
<a name='4899'>
            DO k=kts+1,ktf<a name='4900'>
            DO i = i_start, i_end<a name='4901'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4902'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='4903'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='4904'>
            ENDDO<a name='4905'>
            ENDDO<a name='4906'>
<a name='4907'>
            k = ktf+1<a name='4908'>
            DO i = i_start, i_end<a name='4909'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4910'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='4911'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='4912'>
            ENDDO<a name='4913'>
<a name='4914'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='4915'></font>
<a name='4916'>
            DO k=kts+1,ktf<a name='4917'>
            DO i = i_start, i_end<a name='4918'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*      &amp;<a name='4919'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4920'>
            ENDDO<a name='4921'>
            ENDDO<a name='4922'>
<a name='4923'>
            k = ktf+1<a name='4924'>
            DO i = i_start, i_end<a name='4925'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*      &amp;<a name='4926'>
                     (w(i,k,j)+w(i,k,j-1))<a name='4927'>
            ENDDO<a name='4928'>
<a name='4929'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='4930'></font>
<a name='4931'>
            DO k=kts+1,ktf<a name='4932'>
            DO i = i_start, i_end<a name='4933'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='4934'>
              fqy( i, k, jp1 ) = vel*flux3(             &amp;<a name='4935'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='4936'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='4937'>
            ENDDO<a name='4938'>
            ENDDO<a name='4939'>
<a name='4940'>
            k = ktf+1<a name='4941'>
            DO i = i_start, i_end<a name='4942'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='4943'>
              fqy( i, k, jp1 ) = vel*flux3(             &amp;<a name='4944'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='4945'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='4946'>
            ENDDO<a name='4947'>
<a name='4948'>
     ENDIF<a name='4949'>
<a name='4950'>
<font color=#447700>!  y flux-divergence into tendency<a name='4951'></font>
<a name='4952'>
        <font color=#447700>! Comments for polar boundary conditions<a name='4953'></font>
        <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='4954'></font>
        <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='4955'></font>
        <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='4956'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='4957'>
          DO k=kts,ktf<a name='4958'>
          DO i = i_start, i_end<a name='4959'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='4960'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='4961'>
          END DO<a name='4962'>
          END DO<a name='4963'>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='4964'>
          DO k=kts,ktf<a name='4965'>
          DO i = i_start, i_end<a name='4966'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='4967'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='4968'>
          END DO<a name='4969'>
          END DO<a name='4970'>
        ELSE  <font color=#447700>! normal code<a name='4971'></font>
<a name='4972'>
        IF(j &gt; j_start) THEN<a name='4973'>
<a name='4974'>
          DO k=kts+1,ktf+1<a name='4975'>
          DO i = i_start, i_end<a name='4976'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='4977'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='4978'>
          ENDDO<a name='4979'>
          ENDDO<a name='4980'>
<a name='4981'>
       ENDIF<a name='4982'>
<a name='4983'>
        END IF<a name='4984'>
<a name='4985'>
        jtmp = jp1<a name='4986'>
        jp1 = jp0<a name='4987'>
        jp0 = jtmp<a name='4988'>
<a name='4989'>
      ENDDO j_loop_y_flux_5<a name='4990'>
<a name='4991'>
<font color=#447700>!  next, x - flux divergence<a name='4992'></font>
<a name='4993'>
      i_start = its<a name='4994'>
      i_end   = MIN(ite,ide-1)<a name='4995'>
<a name='4996'>
      j_start = jts<a name='4997'>
      j_end   = MIN(jte,jde-1)<a name='4998'>
<a name='4999'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='5000'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='5001'></font>
<a name='5002'>
      i_start_f = i_start<a name='5003'>
      i_end_f   = i_end+1<a name='5004'>
<a name='5005'>
      IF(degrade_xs) then<a name='5006'>
        i_start = MAX(ids+1,its)<a name='5007'>
<font color=#447700>!        i_start_f = i_start+2<a name='5008'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='5009'>
      ENDIF<a name='5010'>
<a name='5011'>
      IF(degrade_xe) then<a name='5012'>
        i_end = MIN(ide-2,ite)<a name='5013'>
        i_end_f = ide-3<a name='5014'>
      ENDIF<a name='5015'>
<a name='5016'>
<font color=#447700>!  compute fluxes<a name='5017'></font>
<a name='5018'>
      DO j = j_start, j_end<a name='5019'>
<a name='5020'>
<font color=#447700>!  5th or 6th order flux<a name='5021'></font>
<a name='5022'>
        DO k=kts+1,ktf<a name='5023'>
        DO i = i_start_f, i_end_f<a name='5024'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='5025'>
          fqx( i,k ) = vel*flux5( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='5026'>
                                  w(i-1,k,j), w(i  ,k,j),  &amp;<a name='5027'>
                                  w(i+1,k,j), w(i+2,k,j),  &amp;<a name='5028'>
                                  vel                     )<a name='5029'>
        ENDDO<a name='5030'>
        ENDDO<a name='5031'>
<a name='5032'>
        k = ktf+1<a name='5033'>
        DO i = i_start_f, i_end_f<a name='5034'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='5035'>
          fqx( i,k ) = vel*flux5( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='5036'>
                                  w(i-1,k,j), w(i  ,k,j),  &amp;<a name='5037'>
                                  w(i+1,k,j), w(i+2,k,j),  &amp;<a name='5038'>
                                  vel                     )<a name='5039'>
        ENDDO<a name='5040'>
<a name='5041'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='5042'></font>
<a name='5043'>
        IF( degrade_xs ) THEN<a name='5044'>
<a name='5045'>
          DO i=i_start,i_start_f-1<a name='5046'>
<a name='5047'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='5048'></font>
              DO k=kts+1,ktf<a name='5049'>
                fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)) &amp;<a name='5050'>
                                *(w(i,k,j)+w(i-1,k,j))<a name='5051'>
              ENDDO<a name='5052'>
              k = ktf+1<a name='5053'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)) &amp;<a name='5054'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='5055'>
            ENDIF<a name='5056'>
<a name='5057'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='5058'></font>
              DO k=kts+1,ktf<a name='5059'>
                vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='5060'>
                fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='5061'>
                                        w(i  ,k,j), w(i+1,k,j),  &amp;<a name='5062'>
                                        vel                     )<a name='5063'>
              ENDDO<a name='5064'>
              k = ktf+1<a name='5065'>
              vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='5066'>
              fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='5067'>
                                      w(i  ,k,j), w(i+1,k,j),  &amp;<a name='5068'>
                                      vel                     )<a name='5069'>
            END IF<a name='5070'>
<a name='5071'>
          ENDDO<a name='5072'>
<a name='5073'>
        ENDIF<a name='5074'>
<a name='5075'>
        IF( degrade_xe ) THEN<a name='5076'>
<a name='5077'>
          DO i = i_end_f+1, i_end+1<a name='5078'>
<a name='5079'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='5080'></font>
              DO k=kts+1,ktf<a name='5081'>
                fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j))      &amp;<a name='5082'>
                                  *(w(i,k,j)+w(i-1,k,j))<a name='5083'>
              ENDDO<a name='5084'>
              k = ktf+1<a name='5085'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j))      &amp;<a name='5086'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='5087'>
            ENDIF<a name='5088'>
<a name='5089'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='5090'></font>
              DO k=kts+1,ktf<a name='5091'>
                vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='5092'>
                fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='5093'>
                                        w(i  ,k,j), w(i+1,k,j),  &amp;<a name='5094'>
                                        vel                     )<a name='5095'>
              ENDDO<a name='5096'>
              k = ktf+1<a name='5097'>
              vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='5098'>
              fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='5099'>
                                      w(i  ,k,j), w(i+1,k,j),  &amp;<a name='5100'>
                                      vel                     )<a name='5101'>
            ENDIF<a name='5102'>
<a name='5103'>
          ENDDO<a name='5104'>
<a name='5105'>
        ENDIF<a name='5106'>
<a name='5107'>
<font color=#447700>!  x flux-divergence into tendency<a name='5108'></font>
<a name='5109'>
        DO k=kts+1,ktf+1<a name='5110'>
          DO i = i_start, i_end<a name='5111'>
            mrdx=msftx(i,j)*rdx      <font color=#447700>! see ADT eqn 46 dividing by my, 1st term RHS<a name='5112'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='5113'>
          ENDDO<a name='5114'>
        ENDDO<a name='5115'>
<a name='5116'>
      ENDDO<a name='5117'>
<a name='5118'>
ELSE IF ( horz_order == 4 ) THEN<a name='5119'>
<a name='5120'>
   degrade_xs = .true.<a name='5121'>
   degrade_xe = .true.<a name='5122'>
   degrade_ys = .true.<a name='5123'>
   degrade_ye = .true.<a name='5124'>
<a name='5125'>
   IF( config_flags%periodic_x   .or. &amp;<a name='5126'>
       config_flags%symmetric_xs .or. &amp;<a name='5127'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='5128'>
   IF( config_flags%periodic_x   .or. &amp;<a name='5129'>
       config_flags%symmetric_xe .or. &amp;<a name='5130'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='5131'>
   IF( config_flags%periodic_y   .or. &amp;<a name='5132'>
       config_flags%symmetric_ys .or. &amp;<a name='5133'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='5134'>
   IF( config_flags%periodic_y   .or. &amp;<a name='5135'>
       config_flags%symmetric_ye .or. &amp;<a name='5136'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='5137'>
<a name='5138'>
<font color=#447700>!  begin flux computations<a name='5139'></font>
<font color=#447700>!  start with x flux divergence<a name='5140'></font>
<a name='5141'>
<font color=#447700>!---------------<a name='5142'></font>
<a name='5143'>
   ktf=MIN(kte,kde-1)<a name='5144'>
<a name='5145'>
      i_start = its<a name='5146'>
      i_end   = MIN(ite,ide-1)<a name='5147'>
      j_start = jts<a name='5148'>
      j_end   = MIN(jte,jde-1)<a name='5149'>
<a name='5150'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='5151'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='5152'></font>
<a name='5153'>
      i_start_f = i_start<a name='5154'>
      i_end_f   = i_end+1<a name='5155'>
<a name='5156'>
      IF(degrade_xs) then<a name='5157'>
        i_start = ids+1<a name='5158'>
        i_start_f = i_start+1<a name='5159'>
      ENDIF<a name='5160'>
<a name='5161'>
      IF(degrade_xe) then<a name='5162'>
        i_end = ide-2<a name='5163'>
        i_end_f = ide-2<a name='5164'>
      ENDIF<a name='5165'>
<a name='5166'>
<font color=#447700>!  compute fluxes<a name='5167'></font>
<a name='5168'>
      DO j = j_start, j_end<a name='5169'>
<a name='5170'>
        DO k=kts+1,ktf<a name='5171'>
        DO i = i_start_f, i_end_f<a name='5172'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='5173'>
          fqx( i, k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='5174'>
                                  w(i  ,k,j), w(i+1,k,j),  &amp;<a name='5175'>
                                  vel                     )<a name='5176'>
        ENDDO<a name='5177'>
        ENDDO<a name='5178'>
<a name='5179'>
        k = ktf+1<a name='5180'>
        DO i = i_start_f, i_end_f<a name='5181'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='5182'>
          fqx( i, k ) = vel*flux4( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='5183'>
                                  w(i  ,k,j), w(i+1,k,j),  &amp;<a name='5184'>
                                  vel                     )<a name='5185'>
        ENDDO<a name='5186'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='5187'></font>
<a name='5188'>
        IF( degrade_xs ) THEN<a name='5189'>
          DO k=kts+1,ktf<a name='5190'>
            fqx(i_start, k) =                            &amp;<a name='5191'>
               0.5*(fzm(k)*ru(i_start,k,j)+fzp(k)*ru(i_start,k-1,j))  &amp;<a name='5192'>
                   *(w(i_start,k,j)+w(i_start-1,k,j))<a name='5193'>
          ENDDO<a name='5194'>
            k = ktf+1<a name='5195'>
            fqx(i_start, k) =                            &amp;<a name='5196'>
               0.5*((2.-fzm(k-1))*ru(i_start,k-1,j)-fzp(k-1)*ru(i_start,k-2,j))  &amp;<a name='5197'>
                   *(w(i_start,k,j)+w(i_start-1,k,j))<a name='5198'>
        ENDIF<a name='5199'>
<a name='5200'>
        IF( degrade_xe ) THEN<a name='5201'>
          DO k=kts+1,ktf<a name='5202'>
            fqx(i_end+1, k) =                            &amp;<a name='5203'>
               0.5*(fzm(k)*ru(i_end+1,k,j)+fzp(k)*ru(i_end+1,k-1,j))  &amp;<a name='5204'>
                   *(w(i_end+1,k,j)+w(i_end,k,j))<a name='5205'>
          ENDDO<a name='5206'>
            k = ktf+1<a name='5207'>
            fqx(i_end+1, k) =                            &amp;<a name='5208'>
               0.5*((2.-fzm(k-1))*ru(i_end+1,k-1,j)-fzp(k-1)*ru(i_end+1,k-2,j))  &amp;<a name='5209'>
                   *(w(i_end+1,k,j)+w(i_end,k,j))<a name='5210'>
        ENDIF<a name='5211'>
<a name='5212'>
<font color=#447700>!  x flux-divergence into tendency<a name='5213'></font>
<a name='5214'>
        DO k=kts+1,ktf+1<a name='5215'>
        DO i = i_start, i_end<a name='5216'>
          mrdx=msftx(i,j)*rdx        <font color=#447700>! see ADT eqn 46 dividing by my, 1st term RHS<a name='5217'></font>
          tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='5218'>
        ENDDO<a name='5219'>
        ENDDO<a name='5220'>
<a name='5221'>
      ENDDO<a name='5222'>
<a name='5223'>
<font color=#447700>!  next -&gt; y flux divergence calculation<a name='5224'></font>
<a name='5225'>
      i_start = its<a name='5226'>
      i_end   = MIN(ite,ide-1)<a name='5227'>
      j_start = jts<a name='5228'>
      j_end   = MIN(jte,jde-1)<a name='5229'>
<a name='5230'>
<a name='5231'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='5232'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='5233'></font>
<a name='5234'>
      j_start_f = j_start<a name='5235'>
      j_end_f   = j_end+1<a name='5236'>
<a name='5237'>
      IF(degrade_ys) then<a name='5238'>
        j_start = jds+1<a name='5239'>
        j_start_f = j_start+1<a name='5240'>
      ENDIF<a name='5241'>
<a name='5242'>
      IF(degrade_ye) then<a name='5243'>
        j_end = jde-2<a name='5244'>
        j_end_f = jde-2<a name='5245'>
      ENDIF<a name='5246'>
<a name='5247'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='5248'>
<a name='5249'>
        jp1 = 2<a name='5250'>
        jp0 = 1<a name='5251'>
<a name='5252'>
      DO j = j_start, j_end+1<a name='5253'>
<a name='5254'>
       IF ((j &lt; j_start_f) .and. degrade_ys)  THEN<a name='5255'>
          DO k = kts+1, ktf<a name='5256'>
          DO i = i_start, i_end<a name='5257'>
            fqy(i, k, jp1) =                             &amp;<a name='5258'>
               0.5*(fzm(k)*rv(i,k,j_start)+fzp(k)*rv(i,k-1,j_start))   &amp;<a name='5259'>
                   *(w(i,k,j_start)+w(i,k,j_start-1))<a name='5260'>
          ENDDO<a name='5261'>
          ENDDO<a name='5262'>
          k = ktf+1<a name='5263'>
          DO i = i_start, i_end<a name='5264'>
            fqy(i, k, jp1) =                             &amp;<a name='5265'>
               0.5*((2.-fzm(k-1))*rv(i,k-1,j_start)-fzp(k-1)*rv(i,k-2,j_start))   &amp;<a name='5266'>
                   *(w(i,k,j_start)+w(i,k,j_start-1))<a name='5267'>
          ENDDO<a name='5268'>
       ELSE IF ((j &gt; j_end_f) .and. degrade_ye)  THEN<a name='5269'>
          DO k = kts+1, ktf<a name='5270'>
          DO i = i_start, i_end<a name='5271'>
            <font color=#447700>! Assumes j&gt;j_end_f is ONLY j_end+1 ...<a name='5272'></font>
<font color=#447700>!            fqy(i, k, jp1) =                             &amp;<a name='5273'></font>
<font color=#447700>!               0.5*(fzm(k)*rv(i,k,j_end+1)+fzp(k)*rv(i,k-1,j_end+1))     &amp;<a name='5274'></font>
<font color=#447700>!                   *(w(i,k,j_end+1)+w(i,k,j_end))<a name='5275'></font>
            fqy(i, k, jp1) =                             &amp;<a name='5276'>
               0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))     &amp;<a name='5277'>
                   *(w(i,k,j)+w(i,k,j-1))<a name='5278'>
          ENDDO<a name='5279'>
          ENDDO<a name='5280'>
          k = ktf+1<a name='5281'>
          DO i = i_start, i_end<a name='5282'>
            <font color=#447700>! Assumes j&gt;j_end_f is ONLY j_end+1 ...<a name='5283'></font>
<font color=#447700>!            fqy(i, k, jp1) =                                         &amp;<a name='5284'></font>
<font color=#447700>!               0.5*((2.-fzm(k-1))*rv(i,k-1,j_end+1)-fzp(k-1)*rv(i,k-2,j_end+1))     &amp;<a name='5285'></font>
<font color=#447700>!                   *(w(i,k,j_end+1)+w(i,k,j_end))<a name='5286'></font>
            fqy(i, k, jp1) =                                         &amp;<a name='5287'>
               0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))     &amp;<a name='5288'>
                   *(w(i,k,j)+w(i,k,j-1))<a name='5289'>
          ENDDO<a name='5290'>
       ELSE<a name='5291'>
<font color=#447700>!  3rd or 4th order flux<a name='5292'></font>
          DO k = kts+1, ktf<a name='5293'>
          DO i = i_start, i_end<a name='5294'>
            vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='5295'>
            fqy( i, k, jp1 ) = vel*flux4( w(i,k,j-2), w(i,k,j-1),  &amp;<a name='5296'>
                                    w(i,k,j  ), w(i,k,j+1),  &amp;<a name='5297'>
                                    vel                     )<a name='5298'>
          ENDDO<a name='5299'>
          ENDDO<a name='5300'>
          k = ktf+1<a name='5301'>
          DO i = i_start, i_end<a name='5302'>
            vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='5303'>
            fqy( i, k, jp1 ) = vel*flux4( w(i,k,j-2), w(i,k,j-1),  &amp;<a name='5304'>
                                    w(i,k,j  ), w(i,k,j+1),  &amp;<a name='5305'>
                                    vel                     )<a name='5306'>
          ENDDO<a name='5307'>
       END IF<a name='5308'>
<a name='5309'>
<font color=#447700>!  y flux-divergence into tendency<a name='5310'></font>
<a name='5311'>
       <font color=#447700>! Comments for polar boundary conditions<a name='5312'></font>
       <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='5313'></font>
       <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='5314'></font>
       <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='5315'></font>
       IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='5316'>
         DO k=kts,ktf<a name='5317'>
         DO i = i_start, i_end<a name='5318'>
           mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5319'></font>
           tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='5320'>
         END DO<a name='5321'>
         END DO<a name='5322'>
       ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='5323'>
         DO k=kts,ktf<a name='5324'>
         DO i = i_start, i_end<a name='5325'>
           mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5326'></font>
           tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='5327'>
         END DO<a name='5328'>
         END DO<a name='5329'>
       ELSE  <font color=#447700>! normal code<a name='5330'></font>
<a name='5331'>
       IF( j &gt; j_start ) THEN<a name='5332'>
<a name='5333'>
          DO k = kts+1, ktf+1<a name='5334'>
          DO i = i_start, i_end<a name='5335'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5336'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='5337'>
          ENDDO<a name='5338'>
          ENDDO<a name='5339'>
<a name='5340'>
       END IF<a name='5341'>
<a name='5342'>
       END IF<a name='5343'>
<a name='5344'>
       jtmp = jp1<a name='5345'>
       jp1 = jp0<a name='5346'>
       jp0 = jtmp<a name='5347'>
<a name='5348'>
    ENDDO<a name='5349'>
<a name='5350'>
ELSE IF ( horz_order == 3 ) THEN<a name='5351'>
<a name='5352'>
   degrade_xs = .true.<a name='5353'>
   degrade_xe = .true.<a name='5354'>
   degrade_ys = .true.<a name='5355'>
   degrade_ye = .true.<a name='5356'>
<a name='5357'>
   IF( config_flags%periodic_x   .or. &amp;<a name='5358'>
       config_flags%symmetric_xs .or. &amp;<a name='5359'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='5360'>
   IF( config_flags%periodic_x   .or. &amp;<a name='5361'>
       config_flags%symmetric_xe .or. &amp;<a name='5362'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='5363'>
   IF( config_flags%periodic_y   .or. &amp;<a name='5364'>
       config_flags%symmetric_ys .or. &amp;<a name='5365'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='5366'>
   IF( config_flags%periodic_y   .or. &amp;<a name='5367'>
       config_flags%symmetric_ye .or. &amp;<a name='5368'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='5369'>
<a name='5370'>
<font color=#447700>!  begin flux computations<a name='5371'></font>
<font color=#447700>!  start with x flux divergence<a name='5372'></font>
<a name='5373'>
<font color=#447700>!---------------<a name='5374'></font>
<a name='5375'>
   ktf=MIN(kte,kde-1)<a name='5376'>
<a name='5377'>
      i_start = its<a name='5378'>
      i_end   = MIN(ite,ide-1)<a name='5379'>
      j_start = jts<a name='5380'>
      j_end   = MIN(jte,jde-1)<a name='5381'>
<a name='5382'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='5383'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='5384'></font>
<a name='5385'>
      i_start_f = i_start<a name='5386'>
      i_end_f   = i_end+1<a name='5387'>
<a name='5388'>
      IF(degrade_xs) then<a name='5389'>
        i_start = ids+1<a name='5390'>
        i_start_f = i_start+1<a name='5391'>
      ENDIF<a name='5392'>
<a name='5393'>
      IF(degrade_xe) then<a name='5394'>
        i_end = ide-2<a name='5395'>
        i_end_f = ide-2<a name='5396'>
      ENDIF<a name='5397'>
<a name='5398'>
<font color=#447700>!  compute fluxes<a name='5399'></font>
<a name='5400'>
      DO j = j_start, j_end<a name='5401'>
<a name='5402'>
        DO k=kts+1,ktf<a name='5403'>
        DO i = i_start_f, i_end_f<a name='5404'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='5405'>
          fqx( i, k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='5406'>
                                  w(i  ,k,j), w(i+1,k,j),  &amp;<a name='5407'>
                                  vel                     )<a name='5408'>
        ENDDO<a name='5409'>
        ENDDO<a name='5410'>
        k = ktf+1<a name='5411'>
        DO i = i_start_f, i_end_f<a name='5412'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='5413'>
          fqx( i, k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='5414'>
                                  w(i  ,k,j), w(i+1,k,j),  &amp;<a name='5415'>
                                  vel                     )<a name='5416'>
        ENDDO<a name='5417'>
<a name='5418'>
<font color=#447700>!  second order flux close to boundaries (if not periodic or symmetric)<a name='5419'></font>
<a name='5420'>
        IF( degrade_xs ) THEN<a name='5421'>
          DO k=kts+1,ktf<a name='5422'>
            fqx(i_start, k) =                            &amp;<a name='5423'>
               0.5*(fzm(k)*ru(i_start,k,j)+fzp(k)*ru(i_start,k-1,j))  &amp;<a name='5424'>
                   *(w(i_start,k,j)+w(i_start-1,k,j))<a name='5425'>
          ENDDO<a name='5426'>
            k = ktf+1<a name='5427'>
            fqx(i_start, k) =                            &amp;<a name='5428'>
               0.5*((2.-fzm(k-1))*ru(i_start,k-1,j)-fzp(k-1)*ru(i_start,k-2,j))  &amp;<a name='5429'>
                   *(w(i_start,k,j)+w(i_start-1,k,j))<a name='5430'>
        ENDIF<a name='5431'>
<a name='5432'>
        IF( degrade_xe ) THEN<a name='5433'>
          DO k=kts+1,ktf<a name='5434'>
            fqx(i_end+1, k) =                            &amp;<a name='5435'>
               0.5*(fzm(k)*ru(i_end+1,k,j)+fzp(k)*ru(i_end+1,k-1,j))  &amp;<a name='5436'>
                   *(w(i_end+1,k,j)+w(i_end,k,j))<a name='5437'>
          ENDDO<a name='5438'>
            k = ktf+1<a name='5439'>
            fqx(i_end+1, k) =                            &amp;<a name='5440'>
               0.5*((2.-fzm(k-1))*ru(i_end+1,k-1,j)-fzp(k-1)*ru(i_end+1,k-2,j))  &amp;<a name='5441'>
                   *(w(i_end+1,k,j)+w(i_end,k,j))<a name='5442'>
        ENDIF<a name='5443'>
<a name='5444'>
<font color=#447700>!  x flux-divergence into tendency<a name='5445'></font>
<a name='5446'>
        DO k=kts+1,ktf+1<a name='5447'>
        DO i = i_start, i_end<a name='5448'>
          mrdx=msftx(i,j)*rdx        <font color=#447700>! see ADT eqn 46 dividing by my, 1st term RHS<a name='5449'></font>
          tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='5450'>
        ENDDO<a name='5451'>
        ENDDO<a name='5452'>
<a name='5453'>
      ENDDO<a name='5454'>
<a name='5455'>
<font color=#447700>!  next -&gt; y flux divergence calculation<a name='5456'></font>
<a name='5457'>
      i_start = its<a name='5458'>
      i_end   = MIN(ite,ide-1)<a name='5459'>
      j_start = jts<a name='5460'>
      j_end   = MIN(jte,jde-1)<a name='5461'>
<a name='5462'>
<a name='5463'>
<font color=#447700>!  3rd or 4th order flux has a 5 point stencil, so compute<a name='5464'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='5465'></font>
<a name='5466'>
      j_start_f = j_start<a name='5467'>
      j_end_f   = j_end+1<a name='5468'>
<a name='5469'>
      IF(degrade_ys) then<a name='5470'>
        j_start = jds+1<a name='5471'>
        j_start_f = j_start+1<a name='5472'>
      ENDIF<a name='5473'>
<a name='5474'>
      IF(degrade_ye) then<a name='5475'>
        j_end = jde-2<a name='5476'>
        j_end_f = jde-2<a name='5477'>
      ENDIF<a name='5478'>
<a name='5479'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='5480'>
<a name='5481'>
        jp1 = 2<a name='5482'>
        jp0 = 1<a name='5483'>
<a name='5484'>
      DO j = j_start, j_end+1<a name='5485'>
<a name='5486'>
       IF ((j &lt; j_start_f) .and. degrade_ys)  THEN<a name='5487'>
          DO k = kts+1, ktf<a name='5488'>
          DO i = i_start, i_end<a name='5489'>
            fqy(i, k, jp1) =                             &amp;<a name='5490'>
               0.5*(fzm(k)*rv(i,k,j_start)+fzp(k)*rv(i,k-1,j_start))   &amp;<a name='5491'>
                   *(w(i,k,j_start)+w(i,k,j_start-1))<a name='5492'>
          ENDDO<a name='5493'>
          ENDDO<a name='5494'>
          k = ktf+1<a name='5495'>
          DO i = i_start, i_end<a name='5496'>
            fqy(i, k, jp1) =                             &amp;<a name='5497'>
               0.5*((2.-fzm(k-1))*rv(i,k-1,j_start)-fzp(k-1)*rv(i,k-2,j_start))   &amp;<a name='5498'>
                   *(w(i,k,j_start)+w(i,k,j_start-1))<a name='5499'>
          ENDDO<a name='5500'>
       ELSE IF ((j &gt; j_end_f) .and. degrade_ye)  THEN<a name='5501'>
          DO k = kts+1, ktf<a name='5502'>
          DO i = i_start, i_end<a name='5503'>
            <font color=#447700>! Assumes j&gt;j_end_f is ONLY j_end+1 ...<a name='5504'></font>
<font color=#447700>!            fqy(i, k, jp1) =                             &amp;<a name='5505'></font>
<font color=#447700>!               0.5*(fzm(k)*rv(i,k,j_end+1)+fzp(k)*rv(i,k-1,j_end+1))     &amp;<a name='5506'></font>
<font color=#447700>!                   *(w(i,k,j_end+1)+w(i,k,j_end))<a name='5507'></font>
            fqy(i, k, jp1) =                             &amp;<a name='5508'>
               0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))     &amp;<a name='5509'>
                   *(w(i,k,j)+w(i,k,j-1))<a name='5510'>
          ENDDO<a name='5511'>
          ENDDO<a name='5512'>
          k = ktf+1<a name='5513'>
          DO i = i_start, i_end<a name='5514'>
            <font color=#447700>! Assumes j&gt;j_end_f is ONLY j_end+1 ...<a name='5515'></font>
<font color=#447700>!            fqy(i, k, jp1) =                             &amp;<a name='5516'></font>
<font color=#447700>!               0.5*((2.-fzm(k-1))*rv(i,k-1,j_end+1)-fzp(k-1)*rv(i,k-2,j_end+1))     &amp;<a name='5517'></font>
<font color=#447700>!                   *(w(i,k,j_end+1)+w(i,k,j_end))<a name='5518'></font>
            fqy(i, k, jp1) =                             &amp;<a name='5519'>
               0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))     &amp;<a name='5520'>
                   *(w(i,k,j)+w(i,k,j-1))<a name='5521'>
          ENDDO<a name='5522'>
       ELSE<a name='5523'>
<font color=#447700>!  3rd or 4th order flux<a name='5524'></font>
          DO k = kts+1, ktf<a name='5525'>
          DO i = i_start, i_end<a name='5526'>
            vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='5527'>
            fqy( i, k, jp1 ) = vel*flux3( w(i,k,j-2), w(i,k,j-1),  &amp;<a name='5528'>
                                    w(i,k,j  ), w(i,k,j+1),  &amp;<a name='5529'>
                                    vel                     )<a name='5530'>
          ENDDO<a name='5531'>
          ENDDO<a name='5532'>
          k = ktf+1<a name='5533'>
          DO i = i_start, i_end<a name='5534'>
            vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='5535'>
            fqy( i, k, jp1 ) = vel*flux3( w(i,k,j-2), w(i,k,j-1),  &amp;<a name='5536'>
                                    w(i,k,j  ), w(i,k,j+1),  &amp;<a name='5537'>
                                    vel                     )<a name='5538'>
          ENDDO<a name='5539'>
       END IF<a name='5540'>
<a name='5541'>
<font color=#447700>!  y flux-divergence into tendency<a name='5542'></font>
<a name='5543'>
       <font color=#447700>! Comments for polar boundary conditions<a name='5544'></font>
       <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='5545'></font>
       <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='5546'></font>
       <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='5547'></font>
       IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='5548'>
         DO k=kts,ktf<a name='5549'>
         DO i = i_start, i_end<a name='5550'>
           mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5551'></font>
           tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='5552'>
         END DO<a name='5553'>
         END DO<a name='5554'>
       ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='5555'>
         DO k=kts,ktf<a name='5556'>
         DO i = i_start, i_end<a name='5557'>
           mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5558'></font>
           tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='5559'>
         END DO<a name='5560'>
         END DO<a name='5561'>
       ELSE  <font color=#447700>! normal code<a name='5562'></font>
<a name='5563'>
       IF( j &gt; j_start ) THEN<a name='5564'>
<a name='5565'>
          DO k = kts+1, ktf+1<a name='5566'>
          DO i = i_start, i_end<a name='5567'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5568'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='5569'>
          ENDDO<a name='5570'>
          ENDDO<a name='5571'>
<a name='5572'>
       END IF<a name='5573'>
<a name='5574'>
       END IF<a name='5575'>
<a name='5576'>
       jtmp = jp1<a name='5577'>
       jp1 = jp0<a name='5578'>
       jp0 = jtmp<a name='5579'>
<a name='5580'>
    ENDDO<a name='5581'>
<a name='5582'>
ELSE IF (horz_order == 2 ) THEN<a name='5583'>
<a name='5584'>
      i_start = its<a name='5585'>
      i_end   = MIN(ite,ide-1)<a name='5586'>
      j_start = jts<a name='5587'>
      j_end   = MIN(jte,jde-1)<a name='5588'>
<a name='5589'>
      IF ( .NOT. config_flags%periodic_x ) THEN<a name='5590'>
        IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='5591'>
        IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-2,ite)<a name='5592'>
      ENDIF<a name='5593'>
<a name='5594'>
      DO j = j_start, j_end<a name='5595'>
      DO k=kts+1,ktf<a name='5596'>
      DO i = i_start, i_end<a name='5597'>
<a name='5598'>
         mrdx=msftx(i,j)*rdx         <font color=#447700>! see ADT eqn 46 dividing by my, 1st term RHS<a name='5599'></font>
<a name='5600'>
            tendency(i,k,j)=tendency(i,k,j)-mrdx*0.5            &amp;<a name='5601'>
                   *((fzm(k)*ru(i+1,k,j)+fzp(k)*ru(i+1,k-1,j))  &amp;<a name='5602'>
                                *(w(i+1,k,j)+w(i,k,j))          &amp;<a name='5603'>
                    -(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j))      &amp;<a name='5604'>
                               *(w(i,k,j)+w(i-1,k,j)))<a name='5605'>
<a name='5606'>
      ENDDO<a name='5607'>
      ENDDO<a name='5608'>
<a name='5609'>
      k = ktf+1<a name='5610'>
      DO i = i_start, i_end<a name='5611'>
<a name='5612'>
         mrdx=msftx(i,j)*rdx         <font color=#447700>! see ADT eqn 46 dividing by my, 1st term RHS<a name='5613'></font>
<a name='5614'>
            tendency(i,k,j)=tendency(i,k,j)-mrdx*0.5            &amp;<a name='5615'>
                   *(((2.-fzm(k-1))*ru(i+1,k-1,j)-fzp(k-1)*ru(i+1,k-2,j))      &amp;<a name='5616'>
                                *(w(i+1,k,j)+w(i,k,j))          &amp;<a name='5617'>
                    -((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j))         &amp;<a name='5618'>
                               *(w(i,k,j)+w(i-1,k,j)))<a name='5619'>
<a name='5620'>
      ENDDO<a name='5621'>
<a name='5622'>
      ENDDO<a name='5623'>
<a name='5624'>
      i_start = its<a name='5625'>
      i_end   = MIN(ite,ide-1)<a name='5626'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='5627'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='5628'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-2,jte)<a name='5629'>
<a name='5630'>
      DO j = j_start, j_end<a name='5631'>
      DO k=kts+1,ktf<a name='5632'>
      DO i = i_start, i_end<a name='5633'>
<a name='5634'>
         mrdy=msftx(i,j)*rdy         <font color=#447700>!  see ADT eqn 46 dividing by my, 2nd term RHS<a name='5635'></font>
<a name='5636'>
            tendency(i,k,j)=tendency(i,k,j) -mrdy*0.5           &amp;<a name='5637'>
                   *((fzm(k)*rv(i,k,j+1)+fzp(k)*rv(i,k-1,j+1))* &amp;<a name='5638'>
                                 (w(i,k,j+1)+w(i,k,j))          &amp;<a name='5639'>
                    -(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))      &amp;<a name='5640'>
                                 *(w(i,k,j)+w(i,k,j-1))) <a name='5641'>
<a name='5642'>
      ENDDO<a name='5643'>
      ENDDO<a name='5644'>
<a name='5645'>
      k = ktf+1<a name='5646'>
      DO i = i_start, i_end<a name='5647'>
<a name='5648'>
         mrdy=msftx(i,j)*rdy         <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5649'></font>
<a name='5650'>
            tendency(i,k,j)=tendency(i,k,j) -mrdy*0.5       &amp;<a name='5651'>
                   *(((2.-fzm(k-1))*rv(i,k-1,j+1)-fzp(k-1)*rv(i,k-2,j+1))* &amp;<a name='5652'>
                                 (w(i,k,j+1)+w(i,k,j))      &amp;<a name='5653'>
                    -((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))      &amp;<a name='5654'>
                                 *(w(i,k,j)+w(i,k,j-1))) <a name='5655'>
<a name='5656'>
      ENDDO<a name='5657'>
<a name='5658'>
      ENDDO<a name='5659'>
<a name='5660'>
      <font color=#447700>! Polar boundary condition ... not covered in above j-loop<a name='5661'></font>
      IF (config_flags%polar) THEN<a name='5662'>
         IF (jts == jds) THEN<a name='5663'>
            DO k=kts+1,ktf<a name='5664'>
            DO i = i_start, i_end<a name='5665'>
               mrdy=msftx(i,jds)*rdy   <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5666'></font>
               tendency(i,k,jds)=tendency(i,k,jds) -mrdy*0.5 &amp;<a name='5667'>
                          *((fzm(k)*rv(i,k,jds+1)+fzp(k)*rv(i,k-1,jds+1))* &amp;<a name='5668'>
                            (w(i,k,jds+1)+w(i,k,jds)))<a name='5669'>
            END DO<a name='5670'>
            END DO<a name='5671'>
            k = ktf+1<a name='5672'>
            DO i = i_start, i_end<a name='5673'>
               mrdy=msftx(i,jds)*rdy   <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5674'></font>
               tendency(i,k,jds)=tendency(i,k,jds) -mrdy*0.5       &amp;<a name='5675'>
                   *((2.-fzm(k-1))*rv(i,k-1,jds+1)-fzp(k-1)*rv(i,k-2,jds+1))* &amp;<a name='5676'>
                                 (w(i,k,jds+1)+w(i,k,jds))<a name='5677'>
            ENDDO<a name='5678'>
         END IF<a name='5679'>
         IF (jte == jde) THEN<a name='5680'>
            DO k=kts+1,ktf<a name='5681'>
            DO i = i_start, i_end<a name='5682'>
               mrdy=msftx(i,jde-1)*rdy <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5683'></font>
               tendency(i,k,jde-1)=tendency(i,k,jde-1) +mrdy*0.5 &amp;<a name='5684'>
                          *((fzm(k)*rv(i,k,jde-1)+fzp(k)*rv(i,k-1,jde-1))* &amp;<a name='5685'>
                            (w(i,k,jde-1)+w(i,k,jde-2)))<a name='5686'>
            END DO<a name='5687'>
            END DO<a name='5688'>
            k = ktf+1<a name='5689'>
            DO i = i_start, i_end<a name='5690'>
               mrdy=msftx(i,jde-1)*rdy <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='5691'></font>
               tendency(i,k,jde-1)=tendency(i,k,jde-1) +mrdy*0.5       &amp;<a name='5692'>
                    *((2.-fzm(k-1))*rv(i,k-1,jde-1)-fzp(k-1)*rv(i,k-2,jde-1)) &amp;<a name='5693'>
                                 *(w(i,k,jde-1)+w(i,k,jde-2))<a name='5694'>
            ENDDO<a name='5695'>
         END IF<a name='5696'>
      END IF<a name='5697'>
<a name='5698'>
   ELSE IF ( horz_order == 0 ) THEN<a name='5699'>
<a name='5700'>
      <font color=#447700>! Just in case we want to turn horizontal advection off, we can do it<a name='5701'></font>
<a name='5702'>
   ELSE<a name='5703'>
<a name='5704'>
      WRITE ( wrf_err_message ,*) ' advect_w_6a, h_order not known ',horz_order<a name='5705'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_7"> ( wrf_err_message )<a name='5706'>
<a name='5707'>
   ENDIF horizontal_order_test<a name='5708'>
<a name='5709'>
<a name='5710'>
<font color=#447700>!  pick up the the horizontal radiation boundary conditions.<a name='5711'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='5712'></font>
<font color=#447700>!  first, set to index ranges<a name='5713'></font>
<a name='5714'>
<a name='5715'>
      i_start = its<a name='5716'>
      i_end   = MIN(ite,ide-1)<a name='5717'>
      j_start = jts<a name='5718'>
      j_end   = MIN(jte,jde-1)<a name='5719'>
<a name='5720'>
   IF( (config_flags%open_xs) .and. (its == ids)) THEN<a name='5721'>
<a name='5722'>
       DO j = j_start, j_end<a name='5723'>
       DO k = kts+1, ktf<a name='5724'>
<a name='5725'>
         uw = 0.5*(fzm(k)*(ru(its,k  ,j)+ru(its+1,k  ,j)) +  &amp;<a name='5726'>
                   fzp(k)*(ru(its,k-1,j)+ru(its+1,k-1,j))   )<a name='5727'>
         ub = MIN( uw, 0. )<a name='5728'>
<a name='5729'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='5730'>
               - rdx*(                                             &amp;<a name='5731'>
                       ub*(w_old(its+1,k,j) - w_old(its,k,j)) +    &amp;<a name='5732'>
                       w(its,k,j)*(                                &amp;<a name='5733'>
                       fzm(k)*(ru(its+1,k  ,j)-ru(its,k  ,j))+     &amp;<a name='5734'>
                       fzp(k)*(ru(its+1,k-1,j)-ru(its,k-1,j)))     &amp;<a name='5735'>
                                                                  )<a name='5736'>
       ENDDO<a name='5737'>
       ENDDO<a name='5738'>
<a name='5739'>
       k = ktf+1<a name='5740'>
       DO j = j_start, j_end<a name='5741'>
<a name='5742'>
         uw = 0.5*( (2.-fzm(k-1))*(ru(its,k-1,j)+ru(its+1,k-1,j))   &amp;<a name='5743'>
                   -fzp(k-1)*(ru(its,k-2,j)+ru(its+1,k-2,j))   )<a name='5744'>
         ub = MIN( uw, 0. )<a name='5745'>
<a name='5746'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='5747'>
               - rdx*(                                             &amp;<a name='5748'>
                       ub*(w_old(its+1,k,j) - w_old(its,k,j)) +    &amp;<a name='5749'>
                       w(its,k,j)*(                                &amp;<a name='5750'>
                             (2.-fzm(k-1))*(ru(its+1,k-1,j)-ru(its,k-1,j))-  &amp;<a name='5751'>
                             fzp(k-1)*(ru(its+1,k-2,j)-ru(its,k-2,j)))  &amp;<a name='5752'>
                                                                  )<a name='5753'>
       ENDDO<a name='5754'>
<a name='5755'>
   ENDIF<a name='5756'>
<a name='5757'>
   IF( (config_flags%open_xe) .and. (ite == ide)) THEN<a name='5758'>
<a name='5759'>
       DO j = j_start, j_end<a name='5760'>
       DO k = kts+1, ktf<a name='5761'>
<a name='5762'>
         uw = 0.5*(fzm(k)*(ru(ite-1,k  ,j)+ru(ite,k  ,j)) +  &amp;<a name='5763'>
                   fzp(k)*(ru(ite-1,k-1,j)+ru(ite,k-1,j))   )<a name='5764'>
         ub = MAX( uw, 0. )<a name='5765'>
<a name='5766'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                     &amp;<a name='5767'>
               - rdx*(                                                 &amp;<a name='5768'>
                       ub*(w_old(i_end,k,j) - w_old(i_end-1,k,j)) +    &amp;<a name='5769'>
                       w(i_end,k,j)*(                                  &amp;<a name='5770'>
                            fzm(k)*(ru(ite,k  ,j)-ru(ite-1,k  ,j)) +   &amp;<a name='5771'>
                            fzp(k)*(ru(ite,k-1,j)-ru(ite-1,k-1,j)))    &amp;<a name='5772'>
                                                                    )<a name='5773'>
       ENDDO<a name='5774'>
       ENDDO<a name='5775'>
<a name='5776'>
       k = ktf+1<a name='5777'>
       DO j = j_start, j_end<a name='5778'>
<a name='5779'>
         uw = 0.5*( (2.-fzm(k-1))*(ru(ite-1,k-1,j)+ru(ite,k-1,j))    &amp;<a name='5780'>
                   -fzp(k-1)*(ru(ite-1,k-2,j)+ru(ite,k-2,j))   )<a name='5781'>
         ub = MAX( uw, 0. )<a name='5782'>
<a name='5783'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                     &amp;<a name='5784'>
               - rdx*(                                                 &amp;<a name='5785'>
                       ub*(w_old(i_end,k,j) - w_old(i_end-1,k,j)) +    &amp;<a name='5786'>
                       w(i_end,k,j)*(                                  &amp;<a name='5787'>
                               (2.-fzm(k-1))*(ru(ite,k-1,j)-ru(ite-1,k-1,j)) -   &amp;<a name='5788'>
                               fzp(k-1)*(ru(ite,k-2,j)-ru(ite-1,k-2,j)))    &amp;<a name='5789'>
                                                                    )<a name='5790'>
       ENDDO<a name='5791'>
<a name='5792'>
   ENDIF<a name='5793'>
<a name='5794'>
<a name='5795'>
   IF( (config_flags%open_ys) .and. (jts == jds)) THEN<a name='5796'>
<a name='5797'>
       DO i = i_start, i_end<a name='5798'>
       DO k = kts+1, ktf<a name='5799'>
<a name='5800'>
         vw = 0.5*( fzm(k)*(rv(i,k  ,jts)+rv(i,k  ,jts+1)) +  &amp;<a name='5801'>
                    fzp(k)*(rv(i,k-1,jts)+rv(i,k-1,jts+1))   )<a name='5802'>
         vb = MIN( vw, 0. )<a name='5803'>
<a name='5804'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='5805'>
               - rdy*(                                             &amp;<a name='5806'>
                       vb*(w_old(i,k,jts+1) - w_old(i,k,jts)) +    &amp;<a name='5807'>
                       w(i,k,jts)*(                                &amp;<a name='5808'>
                       fzm(k)*(rv(i,k  ,jts+1)-rv(i,k  ,jts))+     &amp;<a name='5809'>
                       fzp(k)*(rv(i,k-1,jts+1)-rv(i,k-1,jts)))     &amp;<a name='5810'>
                                                                )<a name='5811'>
       ENDDO<a name='5812'>
       ENDDO<a name='5813'>
<a name='5814'>
       k = ktf+1<a name='5815'>
       DO i = i_start, i_end<a name='5816'>
         vw = 0.5*( (2.-fzm(k-1))*(rv(i,k-1,jts)+rv(i,k-1,jts+1))    &amp;<a name='5817'>
                   -fzp(k-1)*(rv(i,k-2,jts)+rv(i,k-2,jts+1))   )<a name='5818'>
         vb = MIN( vw, 0. )<a name='5819'>
<a name='5820'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='5821'>
               - rdy*(                                             &amp;<a name='5822'>
                       vb*(w_old(i,k,jts+1) - w_old(i,k,jts)) +    &amp;<a name='5823'>
                       w(i,k,jts)*(                                &amp;<a name='5824'>
                          (2.-fzm(k-1))*(rv(i,k-1,jts+1)-rv(i,k-1,jts))-     &amp;<a name='5825'>
                          fzp(k-1)*(rv(i,k-2,jts+1)-rv(i,k-2,jts)))     &amp;<a name='5826'>
                                                                )<a name='5827'>
       ENDDO<a name='5828'>
<a name='5829'>
   ENDIF<a name='5830'>
<a name='5831'>
   IF( (config_flags%open_ye) .and. (jte == jde) ) THEN<a name='5832'>
<a name='5833'>
       DO i = i_start, i_end<a name='5834'>
       DO k = kts+1, ktf<a name='5835'>
<a name='5836'>
         vw = 0.5*( fzm(k)*(rv(i,k  ,jte-1)+rv(i,k  ,jte)) +  &amp;<a name='5837'>
                    fzp(k)*(rv(i,k-1,jte-1)+rv(i,k-1,jte))   )<a name='5838'>
         vb = MAX( vw, 0. )<a name='5839'>
<a name='5840'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                     &amp;<a name='5841'>
               - rdy*(                                                 &amp;<a name='5842'>
                       vb*(w_old(i,k,j_end) - w_old(i,k,j_end-1)) +    &amp;<a name='5843'>
                       w(i,k,j_end)*(                                  &amp;<a name='5844'>
                            fzm(k)*(rv(i,k  ,jte)-rv(i,k  ,jte-1))+    &amp;<a name='5845'>
                            fzp(k)*(rv(i,k-1,jte)-rv(i,k-1,jte-1)))    &amp;<a name='5846'>
                                                                      )<a name='5847'>
       ENDDO<a name='5848'>
       ENDDO<a name='5849'>
<a name='5850'>
       k = ktf+1<a name='5851'>
       DO i = i_start, i_end<a name='5852'>
<a name='5853'>
         vw = 0.5*( (2.-fzm(k-1))*(rv(i,k-1,jte-1)+rv(i,k-1,jte))    &amp;<a name='5854'>
                   -fzp(k-1)*(rv(i,k-2,jte-1)+rv(i,k-2,jte))   )<a name='5855'>
         vb = MAX( vw, 0. )<a name='5856'>
<a name='5857'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                     &amp;<a name='5858'>
               - rdy*(                                                 &amp;<a name='5859'>
                       vb*(w_old(i,k,j_end) - w_old(i,k,j_end-1)) +    &amp;<a name='5860'>
                       w(i,k,j_end)*(                                  &amp;<a name='5861'>
                               (2.-fzm(k-1))*(rv(i,k-1,jte)-rv(i,k-1,jte-1))-    &amp;<a name='5862'>
                               fzp(k-1)*(rv(i,k-2,jte)-rv(i,k-2,jte-1)))    &amp;<a name='5863'>
                                                                      )<a name='5864'>
       ENDDO<a name='5865'>
<a name='5866'>
   ENDIF<a name='5867'>
<a name='5868'>
<font color=#447700>!-------------------- vertical advection<a name='5869'></font>
<font color=#447700>!     ADT eqn 46 has 3rd term on RHS (dividing through by my) = - partial d/dz (w rho w /my)<a name='5870'></font>
<font color=#447700>!     Here we have:  - partial d/dz (w*rom) = - partial d/dz (w rho w / my)<a name='5871'></font>
<font color=#447700>!     Therefore we don't need to make a correction for advect_w<a name='5872'></font>
<a name='5873'>
      i_start = its<a name='5874'>
      i_end   = MIN(ite,ide-1)<a name='5875'>
      j_start = jts<a name='5876'>
      j_end   = MIN(jte,jde-1)<a name='5877'>
<a name='5878'>
      DO i = i_start, i_end<a name='5879'>
         vflux(i,kts)=0.<a name='5880'>
         vflux(i,kte)=0.<a name='5881'>
      ENDDO<a name='5882'>
<a name='5883'>
    vert_order_test : IF (vert_order == 6) THEN    <a name='5884'>
<a name='5885'>
      DO j = j_start, j_end<a name='5886'>
<a name='5887'>
         DO k=kts+3,ktf-1<a name='5888'>
         DO i = i_start, i_end<a name='5889'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5890'>
           vflux(i,k) = vel*flux6(                                   &amp;<a name='5891'>
                   w(i,k-3,j), w(i,k-2,j), w(i,k-1,j),       &amp;<a name='5892'>
                   w(i,k  ,j), w(i,k+1,j), w(i,k+2,j),  -vel )<a name='5893'>
         ENDDO<a name='5894'>
         ENDDO<a name='5895'>
<a name='5896'>
         DO i = i_start, i_end<a name='5897'>
<a name='5898'>
           k=kts+1<a name='5899'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5900'>
<a name='5901'>
           k = kts+2<a name='5902'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5903'>
           vflux(i,k) = vel*flux4(               &amp;<a name='5904'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='5905'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5906'>
<a name='5907'>
           k = ktf<a name='5908'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5909'>
           vflux(i,k) = vel*flux4(               &amp;<a name='5910'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='5911'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5912'>
<a name='5913'>
           k=ktf+1<a name='5914'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5915'>
<a name='5916'>
         ENDDO<a name='5917'>
<a name='5918'>
         DO k=kts+1,ktf<a name='5919'>
         DO i = i_start, i_end<a name='5920'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='5921'>
         ENDDO<a name='5922'>
         ENDDO<a name='5923'>
<a name='5924'>
<font color=#447700>! pick up flux contribution for w at the lid. wcs, 13 march 2004<a name='5925'></font>
         k = ktf+1<a name='5926'>
         DO i = i_start, i_end<a name='5927'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='5928'>
         ENDDO<a name='5929'>
<a name='5930'>
      ENDDO<a name='5931'>
<a name='5932'>
 ELSE IF (vert_order == 5) THEN    <a name='5933'>
<a name='5934'>
      DO j = j_start, j_end<a name='5935'>
<a name='5936'>
         DO k=kts+3,ktf-1<a name='5937'>
         DO i = i_start, i_end<a name='5938'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5939'>
           vflux(i,k) = vel*flux5(                                   &amp;<a name='5940'>
                   w(i,k-3,j), w(i,k-2,j), w(i,k-1,j),       &amp;<a name='5941'>
                   w(i,k  ,j), w(i,k+1,j), w(i,k+2,j),  -vel )<a name='5942'>
         ENDDO<a name='5943'>
         ENDDO<a name='5944'>
<a name='5945'>
         DO i = i_start, i_end<a name='5946'>
<a name='5947'>
           k=kts+1<a name='5948'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5949'>
                                   <a name='5950'>
           k = kts+2<a name='5951'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5952'>
           vflux(i,k) = vel*flux3(               &amp;<a name='5953'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='5954'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5955'>
           k = ktf<a name='5956'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5957'>
           vflux(i,k) = vel*flux3(               &amp;<a name='5958'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='5959'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5960'>
<a name='5961'>
           k=ktf+1<a name='5962'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5963'>
<a name='5964'>
         ENDDO<a name='5965'>
<a name='5966'>
         DO k=kts+1,ktf<a name='5967'>
         DO i = i_start, i_end<a name='5968'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='5969'>
         ENDDO<a name='5970'>
         ENDDO<a name='5971'>
<a name='5972'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='5973'></font>
         k = ktf+1<a name='5974'>
         DO i = i_start, i_end<a name='5975'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='5976'>
         ENDDO<a name='5977'>
<a name='5978'>
      ENDDO<a name='5979'>
<a name='5980'>
 ELSE IF (vert_order == 4) THEN    <a name='5981'>
<a name='5982'>
      DO j = j_start, j_end<a name='5983'>
<a name='5984'>
         DO k=kts+2,ktf<a name='5985'>
         DO i = i_start, i_end<a name='5986'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='5987'>
           vflux(i,k) = vel*flux4(              &amp;<a name='5988'>
                   w(i,k-2,j), w(i,k-1,j),      &amp;<a name='5989'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='5990'>
         ENDDO<a name='5991'>
         ENDDO<a name='5992'>
<a name='5993'>
         DO i = i_start, i_end<a name='5994'>
<a name='5995'>
           k=kts+1<a name='5996'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5997'>
           k=ktf+1<a name='5998'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='5999'>
<a name='6000'>
         ENDDO<a name='6001'>
<a name='6002'>
         DO k=kts+1,ktf<a name='6003'>
         DO i = i_start, i_end<a name='6004'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='6005'>
         ENDDO<a name='6006'>
         ENDDO<a name='6007'>
<a name='6008'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='6009'></font>
         k = ktf+1<a name='6010'>
         DO i = i_start, i_end<a name='6011'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='6012'>
         ENDDO<a name='6013'>
<a name='6014'>
      ENDDO<a name='6015'>
<a name='6016'>
 ELSE IF (vert_order == 3) THEN    <a name='6017'>
<a name='6018'>
      DO j = j_start, j_end<a name='6019'>
<a name='6020'>
         DO k=kts+2,ktf<a name='6021'>
<font color=#447700>!DEC$ vector always<a name='6022'></font>
         DO i = i_start, i_end<a name='6023'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='6024'>
           vflux(i,k) = vel*flux3(              &amp;<a name='6025'>
                   w(i,k-2,j), w(i,k-1,j),      &amp;<a name='6026'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='6027'>
         ENDDO<a name='6028'>
         ENDDO<a name='6029'>
<a name='6030'>
         DO i = i_start, i_end<a name='6031'>
<a name='6032'>
           k=kts+1<a name='6033'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='6034'>
           k=ktf+1<a name='6035'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='6036'>
<a name='6037'>
         ENDDO<a name='6038'>
<a name='6039'>
         DO k=kts+1,ktf<a name='6040'>
         DO i = i_start, i_end<a name='6041'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='6042'>
         ENDDO<a name='6043'>
         ENDDO<a name='6044'>
<a name='6045'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='6046'></font>
         k = ktf+1<a name='6047'>
         DO i = i_start, i_end<a name='6048'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='6049'>
         ENDDO<a name='6050'>
<a name='6051'>
      ENDDO<a name='6052'>
<a name='6053'>
 ELSE IF (vert_order == 2) THEN    <a name='6054'>
<a name='6055'>
  DO j = j_start, j_end<a name='6056'>
     DO k=kts+1,ktf+1<a name='6057'>
     DO i = i_start, i_end<a name='6058'>
<a name='6059'>
            vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='6060'>
     ENDDO<a name='6061'>
     ENDDO<a name='6062'>
     DO k=kts+1,ktf<a name='6063'>
     DO i = i_start, i_end<a name='6064'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='6065'>
<a name='6066'>
     ENDDO<a name='6067'>
     ENDDO<a name='6068'>
<a name='6069'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='6070'></font>
     k = ktf+1<a name='6071'>
     DO i = i_start, i_end<a name='6072'>
       tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='6073'>
     ENDDO<a name='6074'>
<a name='6075'>
  ENDDO<a name='6076'>
<a name='6077'>
   ELSE<a name='6078'>
<a name='6079'>
      WRITE (wrf_err_message ,*) ' advect_w, v_order not known ',vert_order<a name='6080'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_W' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_8"> ( wrf_err_message )<a name='6081'>
<a name='6082'>
   ENDIF vert_order_test<a name='6083'>
<a name='6084'>
END SUBROUTINE advect_w<a name='6085'>
<a name='6086'>
<font color=#447700>!----------------------------------------------------------------<a name='6087'></font>
<a name='6088'>
#endif<a name='6089'>
<A NAME='ADVECT_SCALAR_PD'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_PD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='6090'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_scalar_pd</font>   ( field, field_old, tendency,    &amp; <A href='../../call_to/ADVECT_SCALAR_PD.html' TARGET='index'>2</A>,<A href='../../call_from/ADVECT_SCALAR_PD.html' TARGET='index'>2</A><a name='6091'>
                                h_tendency, z_tendency,        &amp; <a name='6092'>
                                ru, rv, rom,                   &amp;<a name='6093'>
                                c1, c2,                        &amp;<a name='6094'>
                                mut, mub, mu_old,              &amp;<a name='6095'>
                                time_step, config_flags,       &amp;<a name='6096'>
                                tenddec,                       &amp; <a name='6097'>
                                msfux, msfuy, msfvx, msfvy,    &amp;<a name='6098'>
                                msftx, msfty,                  &amp;<a name='6099'>
                                fzm, fzp,                      &amp;<a name='6100'>
                                rdx, rdy, rdzw, dt,            &amp;<a name='6101'>
                                ids, ide, jds, jde, kds, kde,  &amp;<a name='6102'>
                                ims, ime, jms, jme, kms, kme,  &amp;<a name='6103'>
                                its, ite, jts, jte, kts, kte  )<a name='6104'>
<a name='6105'>
<font color=#447700>!  this is a first cut at a positive definite advection option<a name='6106'></font>
<font color=#447700>!  for scalars in WRF.  This version is memory intensive -&gt;<a name='6107'></font>
<font color=#447700>!  we save 3d arrays of x, y and z both high and low order fluxes<a name='6108'></font>
<font color=#447700>!  (six in all).  Alternatively, we could sweep in a direction <a name='6109'></font>
<font color=#447700>!  and lower the cost considerably.<a name='6110'></font>
<a name='6111'>
<font color=#447700>!  uses the Smolarkiewicz MWR 1989 approach, with addition of first-order<a name='6112'></font>
<font color=#447700>!  fluxes initially<a name='6113'></font>
<a name='6114'>
<font color=#447700>!  WCS, 3 December 2002, 24 February 2003<a name='6115'></font>
<a name='6116'>
   IMPLICIT NONE<a name='6117'>
   <a name='6118'>
   <font color=#447700>! Input data<a name='6119'></font>
   <a name='6120'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='6121'>
<a name='6122'>
   LOGICAL ,                 INTENT(IN   ) :: tenddec  <font color=#447700>! tendency flag<a name='6123'></font>
<a name='6124'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='6125'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='6126'>
                                              its, ite, jts, jte, kts, kte<a name='6127'>
<a name='6128'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field,     &amp;<a name='6129'>
                                                                      field_old, &amp;<a name='6130'>
                                                                      ru,    &amp;<a name='6131'>
                                                                      rv,    &amp;<a name='6132'>
                                                                      rom<a name='6133'>
<a name='6134'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut, mub, mu_old<a name='6135'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='6136'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(  OUT) :: h_tendency, z_tendency <a name='6137'>
<a name='6138'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='6139'>
                                                                    msfuy,  &amp;<a name='6140'>
                                                                    msfvx,  &amp;<a name='6141'>
                                                                    msfvy,  &amp;<a name='6142'>
                                                                    msftx,  &amp;<a name='6143'>
                                                                    msfty<a name='6144'>
<a name='6145'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='6146'>
                                                                  fzp,  &amp;<a name='6147'>
                                                                  rdzw, &amp;<a name='6148'>
                                                                  c1,   &amp;<a name='6149'>
                                                                  c2<a name='6150'>
<a name='6151'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='6152'>
                                                                  rdy,  &amp;<a name='6153'>
                                                                  dt<a name='6154'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='6155'>
<a name='6156'>
   <font color=#447700>! Local data<a name='6157'></font>
   <a name='6158'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='6159'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='6160'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='6161'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='6162'>
<a name='6163'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, mu<a name='6164'>
<a name='6165'>
<font color=#447700>!  storage for high and low order fluxes<a name='6166'></font>
<a name='6167'>
   REAL,  DIMENSION( its-1:ite+2, kts:kte, jts-1:jte+2  ) :: fqx, fqy, fqz<a name='6168'>
<a name='6169'>
   REAL,  DIMENSION( its-1:ite+2, kts:kte, jts-1:jte+2  ) :: fqxl, fqyl, fqzl<a name='6170'>
<a name='6171'>
   INTEGER :: horz_order, vert_order<a name='6172'>
   <a name='6173'>
   LOGICAL :: degrade_xs, degrade_ys<a name='6174'>
   LOGICAL :: degrade_xe, degrade_ye<a name='6175'>
<a name='6176'>
   INTEGER :: jp1, jp0, jtmp<a name='6177'>
<a name='6178'>
   REAL,DIMENSION( its-1:ite+2, kts:kte, jts-1:jte+2  ) :: flux_out, ph_low<a name='6179'>
   REAL :: scale<a name='6180'>
   <font color=#447700>!REAL :: flux_out, ph_low, scale<a name='6181'></font>
   REAL, PARAMETER :: eps=1.e-20<a name='6182'>
<a name='6183'>
<a name='6184'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='6185'></font>
<a name='6186'>
   REAL    :: flux3, flux4, flux5, flux6, flux_upwind<a name='6187'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel, cr<a name='6188'>
<a name='6189'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='6190'>
            (7./12.)*(q_i + q_im1) - (1./12.)*(q_ip1 + q_im2)<a name='6191'>
<a name='6192'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='6193'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='6194'>
           sign(1,time_step)*sign(1.,ua)*(1./12.)*((q_ip1 - q_im2)-3.*(q_i-q_im1))<a name='6195'>
<a name='6196'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='6197'>
            (37./60.)*(q_i+q_im1) - (2./15.)*(q_ip1+q_im2)      &amp;<a name='6198'>
            +(1./60.)*(q_ip2+q_im3)<a name='6199'>
<a name='6200'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='6201'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='6202'>
            -sign(1,time_step)*sign(1.,ua)*(1./60.)*(           &amp;<a name='6203'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )<a name='6204'>
<a name='6205'>
      flux_upwind(q_im1, q_i, cr ) = 0.5*min( 1.0,(cr+abs(cr)))*q_im1 &amp;<a name='6206'>
                                    +0.5*max(-1.0,(cr-abs(cr)))*q_i<a name='6207'>
<a name='6208'>
<font color=#447700>!      flux_upwind(q_im1, q_i, cr ) = 0.5*(1.+sign(1.,cr))*q_im1 &amp;<a name='6209'></font>
<font color=#447700>!                                    +0.5*(1.-sign(1.,cr))*q_i<a name='6210'></font>
<font color=#447700>!      flux_upwind(q_im1, q_i, cr ) = 0.<a name='6211'></font>
<a name='6212'>
    REAL     :: dx,dy,dz<a name='6213'>
<a name='6214'>
    LOGICAL, PARAMETER :: pd_limit = .true.<a name='6215'>
<a name='6216'>
<font color=#447700>! set order for the advection schemes<a name='6217'></font>
<a name='6218'>
<font color=#447700>!  write(6,*) ' in pd advection routine '<a name='6219'></font>
<a name='6220'>
    <font color=#447700>! Empty arrays just in case:<a name='6221'></font>
    IF (config_flags%polar) THEN<a name='6222'>
       fqx(:,:,:)  = 0.<a name='6223'>
       fqy(:,:,:)  = 0.<a name='6224'>
       fqz(:,:,:)  = 0.<a name='6225'>
       fqxl(:,:,:) = 0.<a name='6226'>
       fqyl(:,:,:) = 0.<a name='6227'>
       fqzl(:,:,:) = 0.<a name='6228'>
    END IF<a name='6229'>
<a name='6230'>
  ktf=MIN(kte,kde-1)<a name='6231'>
  horz_order = config_flags%h_sca_adv_order<a name='6232'>
  vert_order = config_flags%v_sca_adv_order<a name='6233'>
<a name='6234'>
<font color=#447700>!  determine boundary mods for flux operators<a name='6235'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='6236'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='6237'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='6238'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='6239'></font>
<font color=#447700>!   of the higher order flux stencils<a name='6240'></font>
<a name='6241'>
   degrade_xs = .true.<a name='6242'>
   degrade_xe = .true.<a name='6243'>
   degrade_ys = .true.<a name='6244'>
   degrade_ye = .true.<a name='6245'>
<a name='6246'>
<font color=#447700>!  begin with horizontal flux divergence<a name='6247'></font>
<font color=#447700>!  here is the choice of flux operators<a name='6248'></font>
<a name='6249'>
<a name='6250'>
  horizontal_order_test : IF( horz_order == 6 ) THEN<a name='6251'>
<a name='6252'>
   IF( config_flags%periodic_x   .or. &amp;<a name='6253'>
       config_flags%symmetric_xs .or. &amp;<a name='6254'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='6255'>
   IF( config_flags%periodic_x   .or. &amp;<a name='6256'>
       config_flags%symmetric_xe .or. &amp;<a name='6257'>
       (ite &lt; ide-4)                ) degrade_xe = .false.<a name='6258'>
   IF( config_flags%periodic_y   .or. &amp;<a name='6259'>
       config_flags%symmetric_ys .or. &amp;<a name='6260'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='6261'>
   IF( config_flags%periodic_y   .or. &amp;<a name='6262'>
       config_flags%symmetric_ye .or. &amp;<a name='6263'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='6264'>
<a name='6265'>
<font color=#447700>!--------------- y - advection first<a name='6266'></font>
<a name='6267'>
<font color=#447700>!--  y flux compute; these bounds are for periodic and sym b.c.<a name='6268'></font>
<a name='6269'>
      ktf=MIN(kte,kde-1)<a name='6270'>
      i_start = its-1<a name='6271'>
      i_end   = MIN(ite,ide-1)+1<a name='6272'>
      j_start = jts-1<a name='6273'>
      j_end   = MIN(jte,jde-1)+1<a name='6274'>
      j_start_f = j_start<a name='6275'>
      j_end_f   = j_end+1<a name='6276'>
<a name='6277'>
<font color=#447700>!--  modify loop bounds if open or specified<a name='6278'></font>
<a name='6279'>
<font color=#447700>!      IF(degrade_xs) i_start = MAX(its-1,ids-1)<a name='6280'></font>
<font color=#447700>!      IF(degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='6281'></font>
      IF(degrade_xs) i_start = MAX(its-1,ids)<a name='6282'>
      IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='6283'>
<a name='6284'>
      IF(degrade_ys) then<a name='6285'>
        j_start = MAX(jts-1,jds+1)<a name='6286'>
        j_start_f = jds+3<a name='6287'>
      ENDIF<a name='6288'>
<a name='6289'>
      IF(degrade_ye) then<a name='6290'>
        j_end = MIN(jte+1,jde-2)<a name='6291'>
        j_end_f = jde-3<a name='6292'>
      ENDIF<a name='6293'>
<a name='6294'>
<font color=#447700>!  compute fluxes, 6th order<a name='6295'></font>
<a name='6296'>
      j_loop_y_flux_6 : DO j = j_start, j_end+1<a name='6297'>
<a name='6298'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='6299'></font>
<a name='6300'>
        DO k=kts,ktf<a name='6301'>
        DO i = i_start, i_end<a name='6302'>
<a name='6303'>
          dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6304'></font>
          mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6305'>
          vel = rv(i,k,j)<a name='6306'>
          cr = vel*dt/dy/mu<a name='6307'>
          fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6308'>
<a name='6309'>
          fqy( i, k, j  ) = vel*flux6(                                  &amp;<a name='6310'>
                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='6311'>
                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='6312'>
<a name='6313'>
          fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6314'>
<a name='6315'>
        ENDDO<a name='6316'>
        ENDDO<a name='6317'>
<a name='6318'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='6319'></font>
<a name='6320'>
            DO k=kts,ktf<a name='6321'>
            DO i = i_start, i_end<a name='6322'>
<a name='6323'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6324'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6325'>
              vel = rv(i,k,j)<a name='6326'>
              cr = vel*dt/dy/mu<a name='6327'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6328'>
<a name='6329'>
              fqy(i,k, j) = 0.5*rv(i,k,j)*          &amp;<a name='6330'>
                     (field(i,k,j)+field(i,k,j-1))<a name='6331'>
<a name='6332'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6333'>
<a name='6334'>
            ENDDO<a name='6335'>
            ENDDO<a name='6336'>
<a name='6337'>
      ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='6338'></font>
<a name='6339'>
            DO k=kts,ktf<a name='6340'>
            DO i = i_start, i_end<a name='6341'>
<a name='6342'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6343'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6344'>
              vel = rv(i,k,j)<a name='6345'>
              cr = vel*dt/dy/mu<a name='6346'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6347'>
<a name='6348'>
              fqy( i, k, j ) = vel*flux4(              &amp;<a name='6349'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='6350'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6351'>
<a name='6352'>
            ENDDO<a name='6353'>
            ENDDO<a name='6354'>
<a name='6355'>
      ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='6356'></font>
<a name='6357'>
            DO k=kts,ktf<a name='6358'>
            DO i = i_start, i_end<a name='6359'>
<a name='6360'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6361'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6362'>
              vel = rv(i,k,j)<a name='6363'>
              cr = vel*dt/dy/mu<a name='6364'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6365'>
<a name='6366'>
              fqy(i, k, j ) = 0.5*rv(i,k,j)*      &amp;<a name='6367'>
                     (field(i,k,j)+field(i,k,j-1))<a name='6368'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6369'>
<a name='6370'>
            ENDDO<a name='6371'>
            ENDDO<a name='6372'>
<a name='6373'>
      ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='6374'></font>
<a name='6375'>
            DO k=kts,ktf<a name='6376'>
            DO i = i_start, i_end<a name='6377'>
<a name='6378'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6379'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6380'>
              vel = rv(i,k,j)<a name='6381'>
              cr = vel*dt/dy/mu<a name='6382'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6383'>
<a name='6384'>
              fqy( i, k, j) = vel*flux4(             &amp;<a name='6385'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='6386'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='6387'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6388'>
<a name='6389'>
            ENDDO<a name='6390'>
            ENDDO<a name='6391'>
<a name='6392'>
      ENDIF<a name='6393'>
<a name='6394'>
   ENDDO j_loop_y_flux_6<a name='6395'>
<a name='6396'>
<font color=#447700>!  next, x flux<a name='6397'></font>
<a name='6398'>
<font color=#447700>!--  these bounds are for periodic and sym conditions<a name='6399'></font>
<a name='6400'>
      i_start = its-1<a name='6401'>
      i_end   = MIN(ite,ide-1)+1<a name='6402'>
      i_start_f = i_start<a name='6403'>
      i_end_f   = i_end+1<a name='6404'>
<a name='6405'>
      j_start = jts-1<a name='6406'>
      j_end   = MIN(jte,jde-1)+1<a name='6407'>
<a name='6408'>
<font color=#447700>!--  modify loop bounds for open and specified b.c<a name='6409'></font>
<a name='6410'>
<font color=#447700>!      IF(degrade_ys) j_start = MAX(jts-1,jds+1)<a name='6411'></font>
<font color=#447700>!      IF(degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='6412'></font>
      IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='6413'>
      IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='6414'>
<a name='6415'>
      IF(degrade_xs) then<a name='6416'>
        i_start = MAX(ids+1,its-1)<a name='6417'>
        i_start_f = ids+3<a name='6418'>
      ENDIF<a name='6419'>
<a name='6420'>
      IF(degrade_xe) then<a name='6421'>
        i_end = MIN(ide-2,ite+1)<a name='6422'>
        i_end_f = ide-3<a name='6423'>
      ENDIF<a name='6424'>
<a name='6425'>
<font color=#447700>!  compute fluxes<a name='6426'></font>
<a name='6427'>
      DO j = j_start, j_end<a name='6428'>
<a name='6429'>
<font color=#447700>!  5th order flux<a name='6430'></font>
<a name='6431'>
        DO k=kts,ktf<a name='6432'>
        DO i = i_start_f, i_end_f<a name='6433'>
<a name='6434'>
          dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6435'></font>
          mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6436'>
          vel = ru(i,k,j)<a name='6437'>
          cr = vel*dt/dx/mu<a name='6438'>
          fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6439'>
<a name='6440'>
          fqx( i,k,j ) = vel*flux6( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='6441'>
                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='6442'>
                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='6443'>
                                         vel                             )<a name='6444'>
          fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6445'>
<a name='6446'>
        ENDDO<a name='6447'>
        ENDDO<a name='6448'>
<a name='6449'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='6450'></font>
<a name='6451'>
        IF( degrade_xs ) THEN<a name='6452'>
<a name='6453'>
          DO i=i_start,i_start_f-1<a name='6454'>
<a name='6455'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='6456'></font>
              DO k=kts,ktf<a name='6457'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6458'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6459'>
                vel = ru(i,k,j)/mu<a name='6460'>
                cr = vel*dt/dx<a name='6461'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6462'>
                fqx(i,k,j) = 0.5*(ru(i,k,j)) &amp;<a name='6463'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='6464'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6465'>
              ENDDO<a name='6466'>
            ENDIF<a name='6467'>
<a name='6468'>
            IF(i == ids+2) THEN  <font color=#447700>! fourth order<a name='6469'></font>
              DO k=kts,ktf<a name='6470'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6471'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6472'>
                vel = ru(i,k,j)<a name='6473'>
                cr = vel*dt/dx/mu<a name='6474'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6475'>
                fqx( i,k,j ) = vel*flux4( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='6476'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='6477'>
                                          vel                             )<a name='6478'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6479'>
              ENDDO<a name='6480'>
            ENDIF<a name='6481'>
<a name='6482'>
          ENDDO<a name='6483'>
<a name='6484'>
        ENDIF<a name='6485'>
<a name='6486'>
        IF( degrade_xe ) THEN<a name='6487'>
<a name='6488'>
          DO i = i_end_f+1, i_end+1<a name='6489'>
<a name='6490'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='6491'></font>
              DO k=kts,ktf<a name='6492'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6493'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6494'>
                vel = ru(i,k,j)<a name='6495'>
                cr = vel*dt/dx/mu<a name='6496'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6497'>
                fqx(i,k,j) = 0.5*(ru(i,k,j))      &amp;<a name='6498'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='6499'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6500'>
              ENDDO<a name='6501'>
            ENDIF<a name='6502'>
<a name='6503'>
<a name='6504'>
            IF( i == ide-2 ) THEN <font color=#447700>! fourth order flux one in from the boundary<a name='6505'></font>
              DO k=kts,ktf<a name='6506'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6507'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6508'>
                vel = ru(i,k,j)<a name='6509'>
                cr = vel*dt/dx/mu<a name='6510'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6511'>
                fqx( i,k,j ) = vel*flux4( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='6512'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='6513'>
                                          vel                             )<a name='6514'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6515'>
              ENDDO<a name='6516'>
            ENDIF<a name='6517'>
<a name='6518'>
          ENDDO<a name='6519'>
<a name='6520'>
        ENDIF<a name='6521'>
<a name='6522'>
      ENDDO  <font color=#447700>! enddo for outer J loop<a name='6523'></font>
<a name='6524'>
<font color=#447700>!--- end of 6th order horizontal flux calculation<a name='6525'></font>
<a name='6526'>
    ELSE IF( horz_order == 5 ) THEN<a name='6527'>
<a name='6528'>
   IF( config_flags%periodic_x   .or. &amp;<a name='6529'>
       config_flags%symmetric_xs .or. &amp;<a name='6530'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='6531'>
   IF( config_flags%periodic_x   .or. &amp;<a name='6532'>
       config_flags%symmetric_xe .or. &amp;<a name='6533'>
       (ite &lt; ide-4)                ) degrade_xe = .false.<a name='6534'>
   IF( config_flags%periodic_y   .or. &amp;<a name='6535'>
       config_flags%symmetric_ys .or. &amp;<a name='6536'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='6537'>
   IF( config_flags%periodic_y   .or. &amp;<a name='6538'>
       config_flags%symmetric_ye .or. &amp;<a name='6539'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='6540'>
<a name='6541'>
<font color=#447700>!--------------- y - advection first<a name='6542'></font>
<a name='6543'>
<font color=#447700>!--  y flux compute; these bounds are for periodic and sym b.c.<a name='6544'></font>
<a name='6545'>
      ktf=MIN(kte,kde-1)<a name='6546'>
      i_start = its-1<a name='6547'>
      i_end   = MIN(ite,ide-1)+1<a name='6548'>
      j_start = jts-1<a name='6549'>
      j_end   = MIN(jte,jde-1)+1<a name='6550'>
      j_start_f = j_start<a name='6551'>
      j_end_f   = j_end+1<a name='6552'>
<a name='6553'>
<font color=#447700>!--  modify loop bounds if open or specified<a name='6554'></font>
<a name='6555'>
<font color=#447700>!      IF(degrade_xs) i_start = MAX(its-1,ids-1)<a name='6556'></font>
<font color=#447700>!      IF(degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='6557'></font>
      IF(degrade_xs) i_start = MAX(its-1,ids)<a name='6558'>
      IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='6559'>
<a name='6560'>
      IF(degrade_ys) then<a name='6561'>
        j_start = MAX(jts-1,jds+1)<a name='6562'>
        j_start_f = jds+3<a name='6563'>
      ENDIF<a name='6564'>
<a name='6565'>
      IF(degrade_ye) then<a name='6566'>
        j_end = MIN(jte+1,jde-2)<a name='6567'>
        j_end_f = jde-3<a name='6568'>
      ENDIF<a name='6569'>
<a name='6570'>
<font color=#447700>!  compute fluxes, 5th order<a name='6571'></font>
<a name='6572'>
      j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='6573'>
<a name='6574'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='6575'></font>
<a name='6576'>
        DO k=kts,ktf<a name='6577'>
        DO i = i_start, i_end<a name='6578'>
<a name='6579'>
          dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6580'></font>
          mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6581'>
          vel = rv(i,k,j)<a name='6582'>
          cr = vel*dt/dy/mu<a name='6583'>
          fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6584'>
<a name='6585'>
          fqy( i, k, j  ) = vel*flux5(                                  &amp;<a name='6586'>
                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='6587'>
                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='6588'>
<a name='6589'>
          fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6590'>
<a name='6591'>
        ENDDO<a name='6592'>
        ENDDO<a name='6593'>
<a name='6594'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='6595'></font>
<a name='6596'>
            DO k=kts,ktf<a name='6597'>
            DO i = i_start, i_end<a name='6598'>
<a name='6599'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6600'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6601'>
              vel = rv(i,k,j)<a name='6602'>
              cr = vel*dt/dy/mu<a name='6603'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6604'>
<a name='6605'>
              fqy(i,k, j) = 0.5*rv(i,k,j)*          &amp;<a name='6606'>
                     (field(i,k,j)+field(i,k,j-1))<a name='6607'>
<a name='6608'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6609'>
<a name='6610'>
            ENDDO<a name='6611'>
            ENDDO<a name='6612'>
<a name='6613'>
      ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='6614'></font>
<a name='6615'>
            DO k=kts,ktf<a name='6616'>
            DO i = i_start, i_end<a name='6617'>
<a name='6618'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6619'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6620'>
              vel = rv(i,k,j)<a name='6621'>
              cr = vel*dt/dy/mu<a name='6622'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6623'>
<a name='6624'>
              fqy( i, k, j ) = vel*flux3(              &amp;<a name='6625'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='6626'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6627'>
<a name='6628'>
            ENDDO<a name='6629'>
            ENDDO<a name='6630'>
<a name='6631'>
      ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='6632'></font>
<a name='6633'>
            DO k=kts,ktf<a name='6634'>
            DO i = i_start, i_end<a name='6635'>
<a name='6636'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6637'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6638'>
              vel = rv(i,k,j)<a name='6639'>
              cr = vel*dt/dy/mu<a name='6640'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6641'>
<a name='6642'>
              fqy(i, k, j ) = 0.5*rv(i,k,j)*      &amp;<a name='6643'>
                     (field(i,k,j)+field(i,k,j-1))<a name='6644'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6645'>
<a name='6646'>
            ENDDO<a name='6647'>
            ENDDO<a name='6648'>
<a name='6649'>
      ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='6650'></font>
<a name='6651'>
            DO k=kts,ktf<a name='6652'>
            DO i = i_start, i_end<a name='6653'>
<a name='6654'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6655'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6656'>
              vel = rv(i,k,j)<a name='6657'>
              cr = vel*dt/dy/mu<a name='6658'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6659'>
<a name='6660'>
              fqy( i, k, j) = vel*flux3(             &amp;<a name='6661'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='6662'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='6663'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6664'>
<a name='6665'>
            ENDDO<a name='6666'>
            ENDDO<a name='6667'>
<a name='6668'>
      ENDIF<a name='6669'>
<a name='6670'>
   ENDDO j_loop_y_flux_5<a name='6671'>
<a name='6672'>
<font color=#447700>!  next, x flux<a name='6673'></font>
<a name='6674'>
<font color=#447700>!--  these bounds are for periodic and sym conditions<a name='6675'></font>
<a name='6676'>
      i_start = its-1<a name='6677'>
      i_end   = MIN(ite,ide-1)+1<a name='6678'>
      i_start_f = i_start<a name='6679'>
      i_end_f   = i_end+1<a name='6680'>
<a name='6681'>
      j_start = jts-1<a name='6682'>
      j_end   = MIN(jte,jde-1)+1<a name='6683'>
<a name='6684'>
<font color=#447700>!--  modify loop bounds for open and specified b.c<a name='6685'></font>
<a name='6686'>
<font color=#447700>!      IF(degrade_ys) j_start = MAX(jts-1,jds+1)<a name='6687'></font>
<font color=#447700>!      IF(degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='6688'></font>
      IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='6689'>
      IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='6690'>
<a name='6691'>
      IF(degrade_xs) then<a name='6692'>
        i_start = MAX(ids+1,its-1)<a name='6693'>
        i_start_f = ids+3<a name='6694'>
      ENDIF<a name='6695'>
<a name='6696'>
      IF(degrade_xe) then<a name='6697'>
        i_end = MIN(ide-2,ite+1)<a name='6698'>
        i_end_f = ide-3<a name='6699'>
      ENDIF<a name='6700'>
<a name='6701'>
<font color=#447700>!  compute fluxes<a name='6702'></font>
<a name='6703'>
      DO j = j_start, j_end<a name='6704'>
<a name='6705'>
<font color=#447700>!  5th order flux<a name='6706'></font>
<a name='6707'>
        DO k=kts,ktf<a name='6708'>
        DO i = i_start_f, i_end_f<a name='6709'>
<a name='6710'>
          dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6711'></font>
          mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6712'>
          vel = ru(i,k,j)<a name='6713'>
          cr = vel*dt/dx/mu<a name='6714'>
          fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6715'>
<a name='6716'>
          fqx( i,k,j ) = vel*flux5( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='6717'>
                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='6718'>
                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='6719'>
                                         vel                             )<a name='6720'>
          fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6721'>
<a name='6722'>
        ENDDO<a name='6723'>
        ENDDO<a name='6724'>
<a name='6725'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='6726'></font>
<a name='6727'>
        IF( degrade_xs ) THEN<a name='6728'>
<a name='6729'>
          DO i=i_start,i_start_f-1<a name='6730'>
<a name='6731'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='6732'></font>
              DO k=kts,ktf<a name='6733'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6734'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6735'>
                vel = ru(i,k,j)/mu<a name='6736'>
                cr = vel*dt/dx<a name='6737'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6738'>
                fqx(i,k,j) = 0.5*(ru(i,k,j)) &amp;<a name='6739'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='6740'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6741'>
              ENDDO<a name='6742'>
            ENDIF<a name='6743'>
<a name='6744'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='6745'></font>
              DO k=kts,ktf<a name='6746'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6747'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6748'>
                vel = ru(i,k,j)<a name='6749'>
                cr = vel*dt/dx/mu<a name='6750'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6751'>
                fqx( i,k,j ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='6752'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='6753'>
                                          vel                             )<a name='6754'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6755'>
              ENDDO<a name='6756'>
            ENDIF<a name='6757'>
<a name='6758'>
          ENDDO<a name='6759'>
<a name='6760'>
        ENDIF<a name='6761'>
<a name='6762'>
        IF( degrade_xe ) THEN<a name='6763'>
<a name='6764'>
          DO i = i_end_f+1, i_end+1<a name='6765'>
<a name='6766'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='6767'></font>
              DO k=kts,ktf<a name='6768'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6769'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6770'>
                vel = ru(i,k,j)<a name='6771'>
                cr = vel*dt/dx/mu<a name='6772'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6773'>
                fqx(i,k,j) = 0.5*(ru(i,k,j))      &amp;<a name='6774'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='6775'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6776'>
              ENDDO<a name='6777'>
            ENDIF<a name='6778'>
<a name='6779'>
<a name='6780'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='6781'></font>
              DO k=kts,ktf<a name='6782'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6783'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6784'>
                vel = ru(i,k,j)<a name='6785'>
                cr = vel*dt/dx/mu<a name='6786'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6787'>
                fqx( i,k,j ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='6788'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='6789'>
                                          vel                             )<a name='6790'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6791'>
              ENDDO<a name='6792'>
            ENDIF<a name='6793'>
<a name='6794'>
          ENDDO<a name='6795'>
<a name='6796'>
        ENDIF<a name='6797'>
<a name='6798'>
      ENDDO  <font color=#447700>! enddo for outer J loop<a name='6799'></font>
<a name='6800'>
<font color=#447700>!--- end of 5th order horizontal flux calculation<a name='6801'></font>
<a name='6802'>
    ELSE IF( horz_order == 4 ) THEN<a name='6803'>
<a name='6804'>
   IF( config_flags%periodic_x   .or. &amp;<a name='6805'>
       config_flags%symmetric_xs .or. &amp;<a name='6806'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='6807'>
   IF( config_flags%periodic_x   .or. &amp;<a name='6808'>
       config_flags%symmetric_xe .or. &amp;<a name='6809'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='6810'>
   IF( config_flags%periodic_y   .or. &amp;<a name='6811'>
       config_flags%symmetric_ys .or. &amp;<a name='6812'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='6813'>
   IF( config_flags%periodic_y   .or. &amp;<a name='6814'>
       config_flags%symmetric_ye .or. &amp;<a name='6815'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='6816'>
<a name='6817'>
<font color=#447700>!--------------- y - advection first<a name='6818'></font>
<a name='6819'>
<font color=#447700>!--  y flux compute; these bounds are for periodic and sym b.c.<a name='6820'></font>
<a name='6821'>
      ktf=MIN(kte,kde-1)<a name='6822'>
      i_start = its-1<a name='6823'>
      i_end   = MIN(ite,ide-1)+1<a name='6824'>
      j_start = jts-1<a name='6825'>
      j_end   = MIN(jte,jde-1)+1<a name='6826'>
      j_start_f = j_start<a name='6827'>
      j_end_f   = j_end+1<a name='6828'>
<a name='6829'>
<font color=#447700>!--  modify loop bounds if open or specified<a name='6830'></font>
<a name='6831'>
      IF(degrade_xs) i_start = its<a name='6832'>
      IF(degrade_xe) i_end   = MIN(ite,ide-1)<a name='6833'>
<a name='6834'>
      IF(degrade_ys) then<a name='6835'>
        j_start = MAX(jts,jds+1)<a name='6836'>
        j_start_f = jds+2<a name='6837'>
      ENDIF<a name='6838'>
<a name='6839'>
      IF(degrade_ye) then<a name='6840'>
        j_end = MIN(jte,jde-2)<a name='6841'>
        j_end_f = jde-2<a name='6842'>
      ENDIF<a name='6843'>
<a name='6844'>
<font color=#447700>!  compute fluxes, 4th order<a name='6845'></font>
<a name='6846'>
      j_loop_y_flux_4 : DO j = j_start, j_end+1<a name='6847'>
<a name='6848'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='6849'></font>
<a name='6850'>
        DO k=kts,ktf<a name='6851'>
        DO i = i_start, i_end<a name='6852'>
<a name='6853'>
          dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6854'></font>
          mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6855'>
          vel = rv(i,k,j)<a name='6856'>
          cr = vel*dt/dy/mu<a name='6857'>
          fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6858'>
<a name='6859'>
          fqy( i, k, j  ) = vel*flux4(  field(i,k,j-2), field(i,k,j-1),       &amp;<a name='6860'>
                                        field(i,k,j  ), field(i,k,j+1), vel )<a name='6861'>
<a name='6862'>
          fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6863'>
<a name='6864'>
        ENDDO<a name='6865'>
        ENDDO<a name='6866'>
<a name='6867'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='6868'></font>
<a name='6869'>
            DO k=kts,ktf<a name='6870'>
            DO i = i_start, i_end<a name='6871'>
<a name='6872'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6873'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6874'>
              vel = rv(i,k,j)<a name='6875'>
              cr = vel*dt/dy/mu<a name='6876'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6877'>
<a name='6878'>
              fqy(i,k, j) = 0.5*rv(i,k,j)*          &amp;<a name='6879'>
                     (field(i,k,j)+field(i,k,j-1))<a name='6880'>
<a name='6881'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6882'>
<a name='6883'>
            ENDDO<a name='6884'>
            ENDDO<a name='6885'>
<a name='6886'>
      ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='6887'></font>
<a name='6888'>
            DO k=kts,ktf<a name='6889'>
            DO i = i_start, i_end<a name='6890'>
<a name='6891'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='6892'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='6893'>
              vel = rv(i,k,j)<a name='6894'>
              cr = vel*dt/dy/mu<a name='6895'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='6896'>
<a name='6897'>
              fqy(i, k, j ) = 0.5*rv(i,k,j)*      &amp;<a name='6898'>
                     (field(i,k,j)+field(i,k,j-1))<a name='6899'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='6900'>
<a name='6901'>
            ENDDO<a name='6902'>
            ENDDO<a name='6903'>
<a name='6904'>
      ENDIF<a name='6905'>
<a name='6906'>
   ENDDO j_loop_y_flux_4<a name='6907'>
<a name='6908'>
<font color=#447700>!  next, x flux<a name='6909'></font>
<a name='6910'>
<font color=#447700>!--  these bounds are for periodic and sym conditions<a name='6911'></font>
<a name='6912'>
      i_start = its-1<a name='6913'>
      i_end   = MIN(ite,ide-1)+1<a name='6914'>
      i_start_f = i_start<a name='6915'>
      i_end_f   = i_end+1<a name='6916'>
<a name='6917'>
      j_start = jts-1<a name='6918'>
      j_end   = MIN(jte,jde-1)+1<a name='6919'>
<a name='6920'>
<font color=#447700>!--  modify loop bounds for open and specified b.c<a name='6921'></font>
<a name='6922'>
      IF(degrade_ys) j_start = jts<a name='6923'>
      IF(degrade_ye) j_end   = MIN(jte,jde-1)<a name='6924'>
<a name='6925'>
      IF(degrade_xs) then<a name='6926'>
        i_start = MAX(ids+1,its)<a name='6927'>
        i_start_f = i_start+1<a name='6928'>
      ENDIF<a name='6929'>
<a name='6930'>
      IF(degrade_xe) then<a name='6931'>
        i_end = MIN(ide-2,ite)<a name='6932'>
        i_end_f = ide-2<a name='6933'>
      ENDIF<a name='6934'>
<a name='6935'>
<font color=#447700>!  compute fluxes<a name='6936'></font>
<a name='6937'>
      DO j = j_start, j_end<a name='6938'>
<a name='6939'>
<font color=#447700>!  4th order flux<a name='6940'></font>
<a name='6941'>
        DO k=kts,ktf<a name='6942'>
        DO i = i_start_f, i_end_f<a name='6943'>
<a name='6944'>
          dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6945'></font>
          mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6946'>
          vel = ru(i,k,j)<a name='6947'>
          cr = vel*dt/dx/mu<a name='6948'>
          fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6949'>
<a name='6950'>
          fqx( i,k,j ) = vel*flux4( field(i-2,k,j), field(i-1,k,j), &amp;<a name='6951'>
                                    field(i  ,k,j), field(i+1,k,j), vel )<a name='6952'>
          fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6953'>
<a name='6954'>
        ENDDO<a name='6955'>
        ENDDO<a name='6956'>
<a name='6957'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='6958'></font>
<a name='6959'>
        IF( degrade_xs ) THEN<a name='6960'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='6961'></font>
            i = ids+1<a name='6962'>
            DO k=kts,ktf<a name='6963'>
<a name='6964'>
              dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6965'></font>
              mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6966'>
              vel = ru(i,k,j)/mu<a name='6967'>
              cr = vel*dt/dx<a name='6968'>
              fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6969'>
<a name='6970'>
              fqx(i,k,j) = 0.5*(ru(i,k,j)) &amp;<a name='6971'>
                     *(field(i,k,j)+field(i-1,k,j))<a name='6972'>
<a name='6973'>
              fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6974'>
<a name='6975'>
            ENDDO<a name='6976'>
          ENDIF<a name='6977'>
        ENDIF<a name='6978'>
<a name='6979'>
        IF( degrade_xe ) THEN<a name='6980'>
          IF( i_end == ide-2 ) THEN <font color=#447700>! second order flux next to the boundary<a name='6981'></font>
            i = ide-1<a name='6982'>
            DO k=kts,ktf<a name='6983'>
              dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='6984'></font>
              mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='6985'>
              vel = ru(i,k,j)<a name='6986'>
              cr = vel*dt/dx/mu<a name='6987'>
              fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='6988'>
              fqx(i,k,j) = 0.5*(ru(i,k,j))      &amp;<a name='6989'>
                     *(field(i,k,j)+field(i-1,k,j))<a name='6990'>
              fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='6991'>
<a name='6992'>
            ENDDO<a name='6993'>
          ENDIF<a name='6994'>
        ENDIF<a name='6995'>
<a name='6996'>
      ENDDO  <font color=#447700>! enddo for outer J loop<a name='6997'></font>
<a name='6998'>
<font color=#447700>!--- end of 4th order horizontal flux calculation<a name='6999'></font>
<a name='7000'>
   ELSE IF( horz_order == 3 ) THEN<a name='7001'>
<a name='7002'>
   IF( config_flags%periodic_x   .or. &amp;<a name='7003'>
       config_flags%symmetric_xs .or. &amp;<a name='7004'>
       (its &gt; ids+2)                ) degrade_xs = .false.<a name='7005'>
   IF( config_flags%periodic_x   .or. &amp;<a name='7006'>
       config_flags%symmetric_xe .or. &amp;<a name='7007'>
       (ite &lt; ide-1)                ) degrade_xe = .false.<a name='7008'>
   IF( config_flags%periodic_y   .or. &amp;<a name='7009'>
       config_flags%symmetric_ys .or. &amp;<a name='7010'>
       (jts &gt; jds+2)                ) degrade_ys = .false.<a name='7011'>
   IF( config_flags%periodic_y   .or. &amp;<a name='7012'>
       config_flags%symmetric_ye .or. &amp;<a name='7013'>
       (jte &lt; jde-1)                ) degrade_ye = .false.<a name='7014'>
<a name='7015'>
<font color=#447700>!--------------- y - advection first<a name='7016'></font>
<a name='7017'>
<font color=#447700>!--  y flux compute; these bounds are for periodic and sym b.c.<a name='7018'></font>
<a name='7019'>
      ktf=MIN(kte,kde-1)<a name='7020'>
      i_start = its-1<a name='7021'>
      i_end   = MIN(ite,ide-1)+1<a name='7022'>
      j_start = jts-1<a name='7023'>
      j_end   = MIN(jte,jde-1)+1<a name='7024'>
      j_start_f = j_start<a name='7025'>
      j_end_f   = j_end+1<a name='7026'>
<a name='7027'>
<font color=#447700>!--  modify loop bounds if open or specified<a name='7028'></font>
<a name='7029'>
      IF(degrade_xs) i_start = its<a name='7030'>
      IF(degrade_xe) i_end   = MIN(ite,ide-1)<a name='7031'>
<a name='7032'>
      IF(degrade_ys) then<a name='7033'>
        j_start = MAX(jts,jds+1)<a name='7034'>
        j_start_f = jds+2<a name='7035'>
      ENDIF<a name='7036'>
<a name='7037'>
      IF(degrade_ye) then<a name='7038'>
        j_end = MIN(jte,jde-2)<a name='7039'>
        j_end_f = jde-2<a name='7040'>
      ENDIF<a name='7041'>
<a name='7042'>
<font color=#447700>!  compute fluxes, 3rd order<a name='7043'></font>
<a name='7044'>
      j_loop_y_flux_3 : DO j = j_start, j_end+1<a name='7045'>
<a name='7046'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='7047'></font>
<a name='7048'>
        DO k=kts,ktf<a name='7049'>
        DO i = i_start, i_end<a name='7050'>
<a name='7051'>
          dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='7052'></font>
          mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='7053'>
          vel = rv(i,k,j)<a name='7054'>
          cr = vel*dt/dy/mu<a name='7055'>
          fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='7056'>
<a name='7057'>
          fqy( i, k, j  ) = vel*flux3(  field(i,k,j-2), field(i,k,j-1),       &amp;<a name='7058'>
                                        field(i,k,j  ), field(i,k,j+1), vel )<a name='7059'>
<a name='7060'>
          fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='7061'>
<a name='7062'>
        ENDDO<a name='7063'>
        ENDDO<a name='7064'>
<a name='7065'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='7066'></font>
<a name='7067'>
            DO k=kts,ktf<a name='7068'>
            DO i = i_start, i_end<a name='7069'>
<a name='7070'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='7071'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='7072'>
              vel = rv(i,k,j)<a name='7073'>
              cr = vel*dt/dy/mu<a name='7074'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='7075'>
<a name='7076'>
              fqy(i,k, j) = 0.5*rv(i,k,j)*          &amp;<a name='7077'>
                     (field(i,k,j)+field(i,k,j-1))<a name='7078'>
<a name='7079'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='7080'>
<a name='7081'>
            ENDDO<a name='7082'>
            ENDDO<a name='7083'>
<a name='7084'>
      ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='7085'></font>
<a name='7086'>
            DO k=kts,ktf<a name='7087'>
            DO i = i_start, i_end<a name='7088'>
<a name='7089'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='7090'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='7091'>
              vel = rv(i,k,j)<a name='7092'>
              cr = vel*dt/dy/mu<a name='7093'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='7094'>
<a name='7095'>
              fqy(i, k, j ) = 0.5*rv(i,k,j)*      &amp;<a name='7096'>
                     (field(i,k,j)+field(i,k,j-1))<a name='7097'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='7098'>
<a name='7099'>
            ENDDO<a name='7100'>
            ENDDO<a name='7101'>
<a name='7102'>
      ENDIF<a name='7103'>
<a name='7104'>
   ENDDO j_loop_y_flux_3<a name='7105'>
<a name='7106'>
<font color=#447700>!  next, x flux<a name='7107'></font>
<a name='7108'>
<font color=#447700>!--  these bounds are for periodic and sym conditions<a name='7109'></font>
<a name='7110'>
      i_start = its-1<a name='7111'>
      i_end   = MIN(ite,ide-1)+1<a name='7112'>
      i_start_f = i_start<a name='7113'>
      i_end_f   = i_end+1<a name='7114'>
<a name='7115'>
      j_start = jts-1<a name='7116'>
      j_end   = MIN(jte,jde-1)+1<a name='7117'>
<a name='7118'>
<font color=#447700>!--  modify loop bounds for open and specified b.c<a name='7119'></font>
<a name='7120'>
      IF(degrade_ys) j_start = jts<a name='7121'>
      IF(degrade_ye) j_end   = MIN(jte,jde-1)<a name='7122'>
<a name='7123'>
      IF(degrade_xs) then<a name='7124'>
        i_start = MAX(ids+1,its)<a name='7125'>
        i_start_f = i_start+1<a name='7126'>
      ENDIF<a name='7127'>
<a name='7128'>
      IF(degrade_xe) then<a name='7129'>
        i_end = MIN(ide-2,ite)<a name='7130'>
        i_end_f = ide-2<a name='7131'>
      ENDIF<a name='7132'>
<a name='7133'>
<font color=#447700>!  compute fluxes<a name='7134'></font>
<a name='7135'>
      DO j = j_start, j_end<a name='7136'>
<a name='7137'>
<font color=#447700>!  4th order flux<a name='7138'></font>
<a name='7139'>
        DO k=kts,ktf<a name='7140'>
        DO i = i_start_f, i_end_f<a name='7141'>
<a name='7142'>
          dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='7143'></font>
          mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='7144'>
          vel = ru(i,k,j)<a name='7145'>
          cr = vel*dt/dx/mu<a name='7146'>
          fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='7147'>
<a name='7148'>
          fqx( i,k,j ) = vel*flux3( field(i-2,k,j), field(i-1,k,j), &amp;<a name='7149'>
                                    field(i  ,k,j), field(i+1,k,j), vel )<a name='7150'>
          fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='7151'>
<a name='7152'>
        ENDDO<a name='7153'>
        ENDDO<a name='7154'>
<a name='7155'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='7156'></font>
<a name='7157'>
        IF( degrade_xs ) THEN<a name='7158'>
<a name='7159'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='7160'></font>
            i = ids+1<a name='7161'>
            DO k=kts,ktf<a name='7162'>
<a name='7163'>
              dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='7164'></font>
              mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='7165'>
              vel = ru(i,k,j)/mu<a name='7166'>
              cr = vel*dt/dx<a name='7167'>
              fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='7168'>
<a name='7169'>
              fqx(i,k,j) = 0.5*(ru(i,k,j)) &amp;<a name='7170'>
                     *(field(i,k,j)+field(i-1,k,j))<a name='7171'>
<a name='7172'>
              fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='7173'>
<a name='7174'>
            ENDDO<a name='7175'>
          ENDIF<a name='7176'>
        ENDIF<a name='7177'>
<a name='7178'>
        IF( degrade_xe ) THEN<a name='7179'>
          IF( i_end == ide-2 ) THEN <font color=#447700>! second order flux next to the boundary<a name='7180'></font>
            i = ide-1<a name='7181'>
            DO k=kts,ktf<a name='7182'>
              dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='7183'></font>
              mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='7184'>
              vel = ru(i,k,j)<a name='7185'>
              cr = vel*dt/dx/mu<a name='7186'>
              fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='7187'>
              fqx(i,k,j) = 0.5*(ru(i,k,j))      &amp;<a name='7188'>
                     *(field(i,k,j)+field(i-1,k,j))<a name='7189'>
              fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='7190'>
<a name='7191'>
            ENDDO<a name='7192'>
          ENDIF<a name='7193'>
        ENDIF<a name='7194'>
<a name='7195'>
      ENDDO  <font color=#447700>! enddo for outer J loop<a name='7196'></font>
<a name='7197'>
<font color=#447700>!--- end of 3rd order horizontal flux calculation<a name='7198'></font>
<a name='7199'>
<a name='7200'>
   ELSE IF( horz_order == 2 ) THEN<a name='7201'>
<a name='7202'>
   IF( config_flags%periodic_x   .or. &amp;<a name='7203'>
       config_flags%symmetric_xs .or. &amp;<a name='7204'>
       (its &gt; ids+1)                ) degrade_xs = .false.<a name='7205'>
   IF( config_flags%periodic_x   .or. &amp;<a name='7206'>
       config_flags%symmetric_xe .or. &amp;<a name='7207'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='7208'>
   IF( config_flags%periodic_y   .or. &amp;<a name='7209'>
       config_flags%symmetric_ys .or. &amp;<a name='7210'>
       (jts &gt; jds+1)                ) degrade_ys = .false.<a name='7211'>
   IF( config_flags%periodic_y   .or. &amp;<a name='7212'>
       config_flags%symmetric_ye .or. &amp;<a name='7213'>
       (jte &lt; jde-2)                ) degrade_ye = .false.<a name='7214'>
<a name='7215'>
<font color=#447700>!--  y flux compute; these bounds are for periodic and sym b.c.<a name='7216'></font>
<a name='7217'>
      ktf=MIN(kte,kde-1)<a name='7218'>
      i_start = its-1<a name='7219'>
      i_end   = MIN(ite,ide-1)+1<a name='7220'>
      j_start = jts-1<a name='7221'>
      j_end   = MIN(jte,jde-1)+1<a name='7222'>
<a name='7223'>
<font color=#447700>!--  modify loop bounds if open or specified<a name='7224'></font>
<a name='7225'>
      IF(degrade_xs) i_start = its<a name='7226'>
      IF(degrade_xe) i_end   = MIN(ite,ide-1)<a name='7227'>
      IF(degrade_ys) j_start = MAX(jts,jds+1)<a name='7228'>
      IF(degrade_ye) j_end = MIN(jte,jde-2)<a name='7229'>
<a name='7230'>
<font color=#447700>!  compute fluxes, 2nd order, y flux<a name='7231'></font>
<a name='7232'>
      DO j = j_start, j_end+1<a name='7233'>
        DO k=kts,ktf<a name='7234'>
        DO i = i_start, i_end<a name='7235'>
           dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='7236'></font>
           mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='7237'>
           vel = rv(i,k,j)<a name='7238'>
           cr = vel*dt/dy/mu<a name='7239'>
           fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='7240'>
<a name='7241'>
           fqy(i,k, j) = 0.5*rv(i,k,j)*          &amp;<a name='7242'>
                  (field(i,k,j)+field(i,k,j-1))<a name='7243'>
<a name='7244'>
           fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='7245'>
        ENDDO<a name='7246'>
        ENDDO<a name='7247'>
      ENDDO<a name='7248'>
<a name='7249'>
<font color=#447700>!  next, x flux<a name='7250'></font>
<a name='7251'>
      DO j = j_start, j_end<a name='7252'>
        DO k=kts,ktf<a name='7253'>
        DO i = i_start, i_end+1<a name='7254'>
            dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx <font color=#447700>! ADT eqn 48 d/dx<a name='7255'></font>
            mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='7256'>
            vel = ru(i,k,j)<a name='7257'>
            cr = vel*dt/dx/mu<a name='7258'>
            fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='7259'>
            fqx( i,k,j ) = 0.5*ru(i,k,j)*          &amp;<a name='7260'>
                  (field(i,k,j)+field(i-1,k,j))<a name='7261'>
<a name='7262'>
            fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='7263'>
        ENDDO<a name='7264'>
        ENDDO<a name='7265'>
      ENDDO<a name='7266'>
<a name='7267'>
<font color=#447700>!--- end of 2nd order horizontal flux calculation<a name='7268'></font>
<a name='7269'>
   ELSE<a name='7270'>
<a name='7271'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_scalar_pd, h_order not known ',horz_order<a name='7272'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_PD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_9"> ( TRIM( wrf_err_message ) )<a name='7273'>
<a name='7274'>
   ENDIF horizontal_order_test<a name='7275'>
<a name='7276'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='7277'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='7278'></font>
<font color=#447700>!  first, set to index ranges<a name='7279'></font>
<a name='7280'>
      i_start = its<a name='7281'>
      i_end   = MIN(ite,ide-1)<a name='7282'>
      j_start = jts<a name='7283'>
      j_end   = MIN(jte,jde-1)<a name='7284'>
<a name='7285'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='7286'></font>
<a name='7287'>
   IF( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='7288'>
<a name='7289'>
       DO j = j_start, j_end<a name='7290'>
       DO k = kts, ktf<a name='7291'>
         ub = MIN( 0.5*(ru(its,k,j)+ru(its+1,k,j)), 0. )<a name='7292'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='7293'>
               - rdx*(                                             &amp;<a name='7294'>
                       ub*(   field_old(its+1,k,j)                 &amp;<a name='7295'>
                            - field_old(its  ,k,j)   ) +           &amp;<a name='7296'>
                       field(its,k,j)*(ru(its+1,k,j)-ru(its,k,j))  &amp;<a name='7297'>
                                                                )<a name='7298'>
       ENDDO<a name='7299'>
       ENDDO<a name='7300'>
<a name='7301'>
   ENDIF<a name='7302'>
<a name='7303'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='7304'>
<a name='7305'>
       DO j = j_start, j_end<a name='7306'>
       DO k = kts, ktf<a name='7307'>
         ub = MAX( 0.5*(ru(ite-1,k,j)+ru(ite,k,j)), 0. )<a name='7308'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                   &amp;<a name='7309'>
               - rdx*(                                               &amp;<a name='7310'>
                       ub*(  field_old(i_end  ,k,j)                  &amp;<a name='7311'>
                           - field_old(i_end-1,k,j) ) +              &amp;<a name='7312'>
                       field(i_end,k,j)*(ru(ite,k,j)-ru(ite-1,k,j))  &amp;<a name='7313'>
                                                                    )<a name='7314'>
       ENDDO<a name='7315'>
       ENDDO<a name='7316'>
<a name='7317'>
   ENDIF<a name='7318'>
<a name='7319'>
   IF( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='7320'>
<a name='7321'>
       DO i = i_start, i_end<a name='7322'>
       DO k = kts, ktf<a name='7323'>
         vb = MIN( 0.5*(rv(i,k,jts)+rv(i,k,jts+1)), 0. )<a name='7324'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='7325'>
               - rdy*(                                             &amp;<a name='7326'>
                       vb*(  field_old(i,k,jts+1)                  &amp;<a name='7327'>
                           - field_old(i,k,jts  ) ) +              &amp;<a name='7328'>
                       field(i,k,jts)*(rv(i,k,jts+1)-rv(i,k,jts))  &amp;<a name='7329'>
                                                                )<a name='7330'>
       ENDDO<a name='7331'>
       ENDDO<a name='7332'>
<a name='7333'>
   ENDIF<a name='7334'>
<a name='7335'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='7336'>
<a name='7337'>
       DO i = i_start, i_end<a name='7338'>
       DO k = kts, ktf<a name='7339'>
         vb = MAX( 0.5*(rv(i,k,jte-1)+rv(i,k,jte)), 0. )<a name='7340'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                   &amp;<a name='7341'>
               - rdy*(                                               &amp;<a name='7342'>
                       vb*(   field_old(i,k,j_end  )                 &amp;<a name='7343'>
                            - field_old(i,k,j_end-1) ) +             &amp;<a name='7344'>
                       field(i,k,j_end)*(rv(i,k,jte)-rv(i,k,jte-1))  &amp;<a name='7345'>
                                                                    )<a name='7346'>
       ENDDO<a name='7347'>
       ENDDO<a name='7348'>
<a name='7349'>
   ENDIF<a name='7350'>
<a name='7351'>
   IF( (config_flags%polar) .and. (jts == jds) ) THEN<a name='7352'>
<a name='7353'>
       <font color=#447700>! Assuming rv(i,k,jds) = 0.<a name='7354'></font>
       DO i = i_start, i_end<a name='7355'>
       DO k = kts, ktf<a name='7356'>
         vb = MIN( 0.5*rv(i,k,jts+1), 0. )<a name='7357'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='7358'>
               - rdy*(                                             &amp;<a name='7359'>
                       vb*(  field_old(i,k,jts+1)                  &amp;<a name='7360'>
                           - field_old(i,k,jts  ) ) +              &amp;<a name='7361'>
                       field(i,k,jts)*rv(i,k,jts+1)                &amp;<a name='7362'>
                                                                )<a name='7363'>
       ENDDO<a name='7364'>
       ENDDO<a name='7365'>
<a name='7366'>
   ENDIF<a name='7367'>
<a name='7368'>
   IF( (config_flags%polar) .and. (jte == jde)) THEN<a name='7369'>
<a name='7370'>
       <font color=#447700>! Assuming rv(i,k,jde) = 0.<a name='7371'></font>
       DO i = i_start, i_end<a name='7372'>
       DO k = kts, ktf<a name='7373'>
         vb = MAX( 0.5*rv(i,k,jte-1), 0. )<a name='7374'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                   &amp;<a name='7375'>
               - rdy*(                                               &amp;<a name='7376'>
                       vb*(   field_old(i,k,j_end  )                 &amp;<a name='7377'>
                            - field_old(i,k,j_end-1) ) +             &amp;<a name='7378'>
                       field(i,k,j_end)*(-rv(i,k,jte-1))             &amp;<a name='7379'>
                                                                    )<a name='7380'>
       ENDDO<a name='7381'>
       ENDDO<a name='7382'>
<a name='7383'>
   ENDIF<a name='7384'>
<a name='7385'>
<font color=#447700>!-------------------- vertical advection<a name='7386'></font>
<a name='7387'>
<font color=#447700>!-- loop bounds for periodic or sym conditions<a name='7388'></font>
<a name='7389'>
      i_start = its-1<a name='7390'>
      i_end   = MIN(ite,ide-1)+1<a name='7391'>
      j_start = jts-1<a name='7392'>
      j_end   = MIN(jte,jde-1)+1<a name='7393'>
<a name='7394'>
<font color=#447700>!-- loop bounds for open or specified conditions<a name='7395'></font>
<a name='7396'>
    IF(degrade_xs) i_start = MAX(its-1,ids)<a name='7397'>
    IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='7398'>
    IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='7399'>
    IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='7400'>
<a name='7401'>
    vert_order_test : IF (vert_order == 6) THEN    <a name='7402'>
<a name='7403'>
      DO j = j_start, j_end<a name='7404'>
<a name='7405'>
         DO i = i_start, i_end<a name='7406'>
           fqz(i,1,j)  = 0.<a name='7407'>
           fqzl(i,1,j) = 0.<a name='7408'>
           fqz(i,kde,j)  = 0.<a name='7409'>
           fqzl(i,kde,j) = 0.<a name='7410'>
         ENDDO<a name='7411'>
<a name='7412'>
         DO k=kts+3,ktf-2<a name='7413'>
         DO i = i_start, i_end<a name='7414'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7415'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7416'>
           vel = rom(i,k,j)<a name='7417'>
           cr = vel*dt/dz/mu<a name='7418'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7419'>
<a name='7420'>
           fqz(i,k,j) = vel*flux6( field(i,k-3,j), field(i,k-2,j), field(i,k-1,j),      &amp;<a name='7421'>
                                   field(i,k  ,j), field(i,k+1,j), field(i,k+2,j),  -vel )<a name='7422'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7423'>
         ENDDO<a name='7424'>
         ENDDO<a name='7425'>
<a name='7426'>
         DO i = i_start, i_end<a name='7427'>
<a name='7428'>
           k=kts+1<a name='7429'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7430'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7431'>
           vel = rom(i,k,j)<a name='7432'>
           cr = vel*dt/dz/mu<a name='7433'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7434'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7435'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7436'>
<a name='7437'>
           k=kts+2<a name='7438'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7439'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7440'>
           vel = rom(i,k,j)<a name='7441'>
           cr = vel*dt/dz/mu<a name='7442'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7443'>
<a name='7444'>
           fqz(i,k,j) = vel*flux4(                      &amp;<a name='7445'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='7446'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='7447'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7448'>
<a name='7449'>
           k=ktf-1<a name='7450'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7451'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7452'>
           vel = rom(i,k,j)<a name='7453'>
           cr = vel*dt/dz/mu<a name='7454'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7455'>
<a name='7456'>
           fqz(i,k,j) = vel*flux4(                      &amp;<a name='7457'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='7458'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='7459'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7460'>
<a name='7461'>
           k=ktf<a name='7462'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7463'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7464'>
           vel = rom(i,k,j)<a name='7465'>
           cr = vel*dt/dz/mu<a name='7466'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7467'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7468'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7469'>
<a name='7470'>
         ENDDO<a name='7471'>
<a name='7472'>
      ENDDO<a name='7473'>
<a name='7474'>
    ELSE IF (vert_order == 5) THEN    <a name='7475'>
<a name='7476'>
      DO j = j_start, j_end<a name='7477'>
<a name='7478'>
         DO i = i_start, i_end<a name='7479'>
           fqz(i,1,j)  = 0.<a name='7480'>
           fqzl(i,1,j) = 0.<a name='7481'>
           fqz(i,kde,j)  = 0.<a name='7482'>
           fqzl(i,kde,j) = 0.<a name='7483'>
         ENDDO<a name='7484'>
<a name='7485'>
         DO k=kts+3,ktf-2<a name='7486'>
         DO i = i_start, i_end<a name='7487'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7488'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7489'>
           vel = rom(i,k,j)<a name='7490'>
           cr = vel*dt/dz/mu<a name='7491'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7492'>
<a name='7493'>
           fqz(i,k,j) = vel*flux5( field(i,k-3,j), field(i,k-2,j), field(i,k-1,j),      &amp;<a name='7494'>
                                   field(i,k  ,j), field(i,k+1,j), field(i,k+2,j),  -vel )<a name='7495'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7496'>
         ENDDO<a name='7497'>
         ENDDO<a name='7498'>
<a name='7499'>
         DO i = i_start, i_end<a name='7500'>
<a name='7501'>
           k=kts+1<a name='7502'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7503'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7504'>
           vel = rom(i,k,j)<a name='7505'>
           cr = vel*dt/dz/mu<a name='7506'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7507'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7508'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7509'>
<a name='7510'>
           k=kts+2<a name='7511'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7512'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7513'>
           vel = rom(i,k,j)<a name='7514'>
           cr = vel*dt/dz/mu<a name='7515'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7516'>
<a name='7517'>
           fqz(i,k,j) = vel*flux3(                      &amp;<a name='7518'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='7519'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='7520'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7521'>
<a name='7522'>
           k=ktf-1<a name='7523'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7524'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7525'>
           vel = rom(i,k,j)<a name='7526'>
           cr = vel*dt/dz/mu<a name='7527'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7528'>
<a name='7529'>
           fqz(i,k,j) = vel*flux3(                      &amp;<a name='7530'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='7531'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='7532'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7533'>
<a name='7534'>
           k=ktf<a name='7535'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7536'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7537'>
           vel = rom(i,k,j)<a name='7538'>
           cr = vel*dt/dz/mu<a name='7539'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7540'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7541'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7542'>
<a name='7543'>
         ENDDO<a name='7544'>
<a name='7545'>
      ENDDO<a name='7546'>
<a name='7547'>
    ELSE IF (vert_order == 4) THEN    <a name='7548'>
<a name='7549'>
      DO j = j_start, j_end<a name='7550'>
<a name='7551'>
         DO i = i_start, i_end<a name='7552'>
           fqz(i,1,j)  = 0.<a name='7553'>
           fqzl(i,1,j) = 0.<a name='7554'>
           fqz(i,kde,j)  = 0.<a name='7555'>
           fqzl(i,kde,j) = 0.<a name='7556'>
         ENDDO<a name='7557'>
<a name='7558'>
         DO k=kts+2,ktf-1<a name='7559'>
         DO i = i_start, i_end<a name='7560'>
<a name='7561'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7562'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7563'>
           vel = rom(i,k,j)<a name='7564'>
           cr = vel*dt/dz/mu<a name='7565'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7566'>
<a name='7567'>
           fqz(i,k,j) = vel*flux4(                      &amp;<a name='7568'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='7569'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='7570'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7571'>
         ENDDO<a name='7572'>
         ENDDO<a name='7573'>
<a name='7574'>
         DO i = i_start, i_end<a name='7575'>
<a name='7576'>
           k=kts+1<a name='7577'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7578'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7579'>
           vel = rom(i,k,j)<a name='7580'>
           cr = vel*dt/dz/mu<a name='7581'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7582'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7583'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7584'>
<a name='7585'>
           k=ktf<a name='7586'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7587'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7588'>
           vel = rom(i,k,j)<a name='7589'>
           cr = vel*dt/dz/mu<a name='7590'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7591'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7592'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7593'>
<a name='7594'>
         ENDDO<a name='7595'>
<a name='7596'>
      ENDDO<a name='7597'>
<a name='7598'>
    ELSE IF (vert_order == 3) THEN    <a name='7599'>
<a name='7600'>
      DO j = j_start, j_end<a name='7601'>
<a name='7602'>
         DO i = i_start, i_end<a name='7603'>
           fqz(i,1,j)  = 0.<a name='7604'>
           fqzl(i,1,j) = 0.<a name='7605'>
           fqz(i,kde,j)  = 0.<a name='7606'>
           fqzl(i,kde,j) = 0.<a name='7607'>
         ENDDO<a name='7608'>
<a name='7609'>
         DO k=kts+2,ktf-1<a name='7610'>
<font color=#447700>!DEC$ vector always<a name='7611'></font>
         DO i = i_start, i_end<a name='7612'>
<a name='7613'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7614'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7615'>
           vel = rom(i,k,j)<a name='7616'>
           cr = vel*dt/dz/mu<a name='7617'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7618'>
<a name='7619'>
           fqz(i,k,j) = vel*flux3(                      &amp;<a name='7620'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='7621'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='7622'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7623'>
         ENDDO<a name='7624'>
         ENDDO<a name='7625'>
<a name='7626'>
         DO i = i_start, i_end<a name='7627'>
<a name='7628'>
           k=kts+1<a name='7629'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7630'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7631'>
           vel = rom(i,k,j)<a name='7632'>
           cr = vel*dt/dz/mu<a name='7633'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7634'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7635'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7636'>
<a name='7637'>
           k=ktf<a name='7638'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7639'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7640'>
           vel = rom(i,k,j)<a name='7641'>
           cr = vel*dt/dz/mu<a name='7642'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7643'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7644'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7645'>
<a name='7646'>
         ENDDO<a name='7647'>
<a name='7648'>
      ENDDO<a name='7649'>
<a name='7650'>
   ELSE IF (vert_order == 2) THEN    <a name='7651'>
<a name='7652'>
      DO j = j_start, j_end<a name='7653'>
<a name='7654'>
         DO i = i_start, i_end<a name='7655'>
           fqz(i,1,j)  = 0.<a name='7656'>
           fqzl(i,1,j) = 0.<a name='7657'>
           fqz(i,kde,j)  = 0.<a name='7658'>
           fqzl(i,kde,j) = 0.<a name='7659'>
         ENDDO<a name='7660'>
<a name='7661'>
         DO k=kts+1,ktf<a name='7662'>
         DO i = i_start, i_end<a name='7663'>
<a name='7664'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='7665'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='7666'>
           vel = rom(i,k,j)<a name='7667'>
           cr = vel*dt/dz/mu<a name='7668'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='7669'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='7670'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='7671'>
<a name='7672'>
        ENDDO<a name='7673'>
        ENDDO<a name='7674'>
<a name='7675'>
      ENDDO<a name='7676'>
<a name='7677'>
   ELSE<a name='7678'>
<a name='7679'>
      WRITE (wrf_err_message,*) ' advect_scalar_pd, v_order not known ',vert_order<a name='7680'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_PD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_10"> ( wrf_err_message )<a name='7681'>
<a name='7682'>
   ENDIF vert_order_test<a name='7683'>
<a name='7684'>
   IF (pd_limit) THEN<a name='7685'>
<a name='7686'>
<font color=#447700>! positive definite filter<a name='7687'></font>
<a name='7688'>
   i_start = its-1<a name='7689'>
   i_end   = MIN(ite,ide-1)+1<a name='7690'>
   j_start = jts-1<a name='7691'>
   j_end   = MIN(jte,jde-1)+1<a name='7692'>
<a name='7693'>
<font color=#447700>!-- loop bounds for open or specified conditions<a name='7694'></font>
<a name='7695'>
   IF(degrade_xs) i_start = MAX(its-1,ids)<a name='7696'>
   IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='7697'>
   IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='7698'>
   IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='7699'>
<a name='7700'>
   IF(config_flags%specified .or. config_flags%nested) THEN<a name='7701'>
     IF (degrade_xs) i_start = MAX(its-1,ids+1)<a name='7702'>
     IF (degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='7703'>
     IF (degrade_ys) j_start = MAX(jts-1,jds+1)<a name='7704'>
     IF (degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='7705'>
   END IF<a name='7706'>
<a name='7707'>
   IF(config_flags%open_xs) THEN<a name='7708'>
     IF (degrade_xs) i_start = MAX(its-1,ids+1)<a name='7709'>
   END IF<a name='7710'>
   IF(config_flags%open_xe) THEN<a name='7711'>
     IF (degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='7712'>
   END IF<a name='7713'>
   IF(config_flags%open_ys) THEN<a name='7714'>
     IF (degrade_ys) j_start = MAX(jts-1,jds+1)<a name='7715'>
   END IF<a name='7716'>
   IF(config_flags%open_ye) THEN<a name='7717'>
     IF (degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='7718'>
   END IF<a name='7719'>
   <font color=#447700>! ADT note:<a name='7720'></font>
   <font color=#447700>! We don't want to change j_start and j_end<a name='7721'></font>
   <font color=#447700>! for polar BC's since we want to calculate<a name='7722'></font>
   <font color=#447700>! fluxes for directions other than y at the<a name='7723'></font>
   <font color=#447700>! edge<a name='7724'></font>
<a name='7725'>
<font color=#447700>!-- here is the limiter...<a name='7726'></font>
<a name='7727'>
   DO j=j_start, j_end<a name='7728'>
   DO k=kts, ktf<a name='7729'>
#ifdef XEON_SIMD<a name='7730'>
<font color=#447700>!DIR$ simd<a name='7731'></font>
#else<a name='7732'>
<font color=#447700>!DIR$ vector always<a name='7733'></font>
#endif<a name='7734'>
   DO i=i_start, i_end<a name='7735'>
<a name='7736'>
     ph_low(i,k,j) = (mub(i,j)+mu_old(i,j))*field_old(i,k,j) &amp;<a name='7737'>
                - dt*( msftx(i,j)*msfty(i,j)*(               &amp;<a name='7738'>
                       rdx*(fqxl(i+1,k,j)-fqxl(i,k,j)) +     &amp;<a name='7739'>
                       rdy*(fqyl(i,k,j+1)-fqyl(i,k,j))  )    &amp;<a name='7740'>
                      +msfty(i,j)*rdzw(k)*(fqzl(i,k+1,j)-fqzl(i,k,j)) )<a name='7741'>
<a name='7742'>
   ENDDO<a name='7743'>
   ENDDO<a name='7744'>
   ENDDO<a name='7745'>
<a name='7746'>
   DO j=j_start, j_end<a name='7747'>
   DO k=kts, ktf<a name='7748'>
<font color=#447700>!DIR$ vector always<a name='7749'></font>
   DO i=i_start, i_end<a name='7750'>
<a name='7751'>
     flux_out(i,k,j) = dt*( (msftx(i,j)*msfty(i,j))*( &amp;<a name='7752'>
                                rdx*(  max(0.,fqx (i+1,k,j))      &amp;<a name='7753'>
                                      -min(0.,fqx (i  ,k,j)) )    &amp;<a name='7754'>
                               +rdy*(  max(0.,fqy (i,k,j+1))      &amp;<a name='7755'>
                                      -min(0.,fqy (i,k,j  )) ) )  &amp;<a name='7756'>
                +msfty(i,j)*rdzw(k)*(  min(0.,fqz (i,k+1,j))      &amp;<a name='7757'>
                                      -max(0.,fqz (i,k  ,j)) )   )<a name='7758'>
<a name='7759'>
   ENDDO<a name='7760'>
   ENDDO<a name='7761'>
   ENDDO<a name='7762'>
<a name='7763'>
   DO j=j_start, j_end<a name='7764'>
   DO k=kts, ktf<a name='7765'>
<font color=#447700>!DIR$ vector always<a name='7766'></font>
   DO i=i_start, i_end<a name='7767'>
     IF( flux_out(i,k,j) .gt. ph_low(i,k,j) ) THEN<a name='7768'>
       scale = max(0.,ph_low(i,k,j)/(flux_out(i,k,j)+eps))<a name='7769'>
       IF( fqx (i+1,k,j) .gt. 0.) fqx(i+1,k,j) = scale*fqx(i+1,k,j)<a name='7770'>
       IF( fqx (i  ,k,j) .lt. 0.) fqx(i  ,k,j) = scale*fqx(i  ,k,j)<a name='7771'>
       IF( fqy (i,k,j+1) .gt. 0.) fqy(i,k,j+1) = scale*fqy(i,k,j+1)<a name='7772'>
       IF( fqy (i,k,j  ) .lt. 0.) fqy(i,k,j  ) = scale*fqy(i,k,j  )<a name='7773'>
<font color=#447700>!  note: z flux is opposite sign in mass coordinate because <a name='7774'></font>
<font color=#447700>!  vertical coordinate decreases with increasing k<a name='7775'></font>
       IF( fqz (i,k+1,j) .lt. 0.) fqz(i,k+1,j) = scale*fqz(i,k+1,j)<a name='7776'>
       IF( fqz (i,k  ,j) .gt. 0.) fqz(i,k  ,j) = scale*fqz(i,k  ,j)<a name='7777'>
<a name='7778'>
     END IF<a name='7779'>
<a name='7780'>
   ENDDO<a name='7781'>
   ENDDO<a name='7782'>
   ENDDO<a name='7783'>
<a name='7784'>
   END IF<a name='7785'>
<a name='7786'>
<font color=#447700>! add in the pd-limited flux divergence<a name='7787'></font>
<a name='7788'>
  i_start = its<a name='7789'>
  i_end   = MIN(ite,ide-1)<a name='7790'>
  j_start = jts<a name='7791'>
  j_end   = MIN(jte,jde-1)<a name='7792'>
<a name='7793'>
  DO j = j_start, j_end<a name='7794'>
  DO k = kts, ktf<a name='7795'>
<font color=#447700>!DEC$ vector always<a name='7796'></font>
  DO i = i_start, i_end<a name='7797'>
<a name='7798'>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='7799'>
                            -rdzw(k)*( fqz (i,k+1,j)-fqz (i,k,j)  &amp;<a name='7800'>
                                      +fqzl(i,k+1,j)-fqzl(i,k,j))<a name='7801'>
<a name='7802'>
  ENDDO<a name='7803'>
  ENDDO<a name='7804'>
  ENDDO<a name='7805'>
<a name='7806'>
  IF(tenddec) THEN<a name='7807'>
  DO j = j_start, j_end<a name='7808'>
  DO k = kts, ktf<a name='7809'>
  DO i = i_start, i_end<a name='7810'>
<a name='7811'>
     z_tendency (i,k,j) = 0. -rdzw(k)*( fqz (i,k+1,j)-fqz (i,k,j)  &amp;<a name='7812'>
                                      +fqzl(i,k+1,j)-fqzl(i,k,j))<a name='7813'>
<a name='7814'>
  ENDDO<a name='7815'>
  ENDDO<a name='7816'>
  ENDDO<a name='7817'>
  END IF<a name='7818'>
<a name='7819'>
<font color=#447700>! x flux divergence<a name='7820'></font>
<font color=#447700>!<a name='7821'></font>
  IF(degrade_xs) i_start = MAX(its,ids+1)<a name='7822'>
  IF(degrade_xe) i_end   = MIN(ite,ide-2)<a name='7823'>
<a name='7824'>
  DO j = j_start, j_end<a name='7825'>
  DO k = kts, ktf<a name='7826'>
<font color=#447700>!DEC$ vector always  <a name='7827'></font>
  DO i = i_start, i_end<a name='7828'>
<a name='7829'>
     <font color=#447700>! Un-"canceled" map scale factor, ADT Eq. 48<a name='7830'></font>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='7831'>
               - msftx(i,j)*( rdx*( fqx (i+1,k,j)-fqx (i,k,j)     &amp;<a name='7832'>
                                   +fqxl(i+1,k,j)-fqxl(i,k,j))   )<a name='7833'>
<a name='7834'>
  ENDDO<a name='7835'>
  ENDDO<a name='7836'>
  ENDDO<a name='7837'>
<a name='7838'>
  IF(tenddec) THEN<a name='7839'>
  DO j = j_start, j_end<a name='7840'>
  DO k = kts, ktf<a name='7841'>
  DO i = i_start, i_end<a name='7842'>
<a name='7843'>
     h_tendency (i,k,j) = 0.                                      &amp;<a name='7844'>
               - msftx(i,j)*( rdx*( fqx (i+1,k,j)-fqx (i,k,j)     &amp;<a name='7845'>
                                   +fqxl(i+1,k,j)-fqxl(i,k,j))   )<a name='7846'>
<a name='7847'>
  ENDDO<a name='7848'>
  ENDDO<a name='7849'>
  ENDDO<a name='7850'>
  END IF<a name='7851'>
<a name='7852'>
<font color=#447700>! y flux divergence<a name='7853'></font>
<font color=#447700>!<a name='7854'></font>
  i_start = its<a name='7855'>
  i_end   = MIN(ite,ide-1)<a name='7856'>
  IF(degrade_ys) j_start = MAX(jts,jds+1)<a name='7857'>
  IF(degrade_ye) j_end   = MIN(jte,jde-2)<a name='7858'>
<a name='7859'>
  DO j = j_start, j_end<a name='7860'>
  DO k = kts, ktf<a name='7861'>
<font color=#447700>!DEC$ vector always<a name='7862'></font>
  DO i = i_start, i_end<a name='7863'>
<a name='7864'>
     <font color=#447700>! Un-"canceled" map scale factor, ADT Eq. 48<a name='7865'></font>
     <font color=#447700>! It is correct to use msftx (and not msfty), per W. Skamarock, 20080606<a name='7866'></font>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='7867'>
               - msftx(i,j)*( rdy*( fqy (i,k,j+1)-fqy (i,k,j)     &amp;<a name='7868'>
                                   +fqyl(i,k,j+1)-fqyl(i,k,j))   )<a name='7869'>
<a name='7870'>
  ENDDO<a name='7871'>
  ENDDO<a name='7872'>
  ENDDO<a name='7873'>
<a name='7874'>
  IF(tenddec) THEN<a name='7875'>
  DO j = j_start, j_end<a name='7876'>
  DO k = kts, ktf<a name='7877'>
  DO i = i_start, i_end<a name='7878'>
<a name='7879'>
     h_tendency (i,k,j) = h_tendency (i,k,j)                      &amp;<a name='7880'>
               - msftx(i,j)*( rdy*( fqy (i,k,j+1)-fqy (i,k,j)     &amp;<a name='7881'>
                                   +fqyl(i,k,j+1)-fqyl(i,k,j))   )<a name='7882'>
<a name='7883'>
  ENDDO<a name='7884'>
  ENDDO<a name='7885'>
  ENDDO<a name='7886'>
  END IF<a name='7887'>
<a name='7888'>
END SUBROUTINE advect_scalar_pd<a name='7889'>
<a name='7890'>
<font color=#447700>!----------------------------------------------------------------<a name='7891'></font>
<a name='7892'>
<A NAME='ADVECT_SCALAR_WENO'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_WENO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='7893'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_scalar_weno</font> ( field, field_old, tendency,     &amp; <A href='../../call_to/ADVECT_SCALAR_WENO.html' TARGET='index'>3</A><a name='7894'>
                             ru, rv, rom,                   &amp;<a name='7895'>
                             c1, c2,                        &amp;<a name='7896'>
                             mut, time_step, config_flags,  &amp;<a name='7897'>
                             msfux, msfuy, msfvx, msfvy,    &amp;<a name='7898'>
                             msftx, msfty,                  &amp;<a name='7899'>
                             fzm, fzp,                      &amp;<a name='7900'>
                             rdx, rdy, rdzw,                &amp;<a name='7901'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='7902'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='7903'>
                             its, ite, jts, jte, kts, kte  )<a name='7904'>
<font color=#447700>!<a name='7905'></font>
<font color=#447700>! 5th-order WENO (Weighted Essentially Non-Oscillatory) scheme adapted from COMMAS.  <a name='7906'></font>
<font color=#447700>! See Jiang and Shu, 1996, J. Comp. Phys. v. 126, 202-223; <a name='7907'></font>
<font color=#447700>! Shu 2003, Int. J. Comp. Fluid Dyn. v. 17 107-118;  Also used by Bryan 2005, Mon. Wea. Rev.<a name='7908'></font>
<font color=#447700>!<a name='7909'></font>
   IMPLICIT NONE<a name='7910'>
   <a name='7911'>
   <font color=#447700>! Input data<a name='7912'></font>
   <a name='7913'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='7914'>
<a name='7915'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='7916'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='7917'>
                                              its, ite, jts, jte, kts, kte<a name='7918'>
   <a name='7919'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field,     &amp;<a name='7920'>
                                                                      field_old, &amp;<a name='7921'>
                                                                      ru,    &amp;<a name='7922'>
                                                                      rv,    &amp;<a name='7923'>
                                                                      rom<a name='7924'>
<a name='7925'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='7926'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='7927'>
<a name='7928'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='7929'>
                                                                    msfuy,  &amp;<a name='7930'>
                                                                    msfvx,  &amp;<a name='7931'>
                                                                    msfvy,  &amp;<a name='7932'>
                                                                    msftx,  &amp;<a name='7933'>
                                                                    msfty<a name='7934'>
<a name='7935'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='7936'>
                                                                  fzp,  &amp;<a name='7937'>
                                                                  rdzw, &amp;<a name='7938'>
                                                                  c1,   &amp;<a name='7939'>
                                                                  c2<a name='7940'>
<a name='7941'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='7942'>
                                                                  rdy<a name='7943'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='7944'>
<a name='7945'>
<a name='7946'>
   <font color=#447700>! Local data<a name='7947'></font>
   <a name='7948'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='7949'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='7950'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='7951'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='7952'>
<a name='7953'>
   INTEGER , PARAMETER :: is=0, js=0, ks=0<a name='7954'>
<a name='7955'>
   REAL    :: mrdx, mrdy, ub, vb, vw<a name='7956'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='7957'>
<a name='7958'>
<a name='7959'>
   REAL,  DIMENSION( its-is:ite+1, kts:kte  ) :: fqx<a name='7960'>
<font color=#447700>!   REAL,  DIMENSION( its:ite+1, kts:kte  ) :: fqx<a name='7961'></font>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='7962'>
<a name='7963'>
   INTEGER :: horz_order, vert_order<a name='7964'>
   <a name='7965'>
   LOGICAL :: degrade_xs, degrade_ys<a name='7966'>
   LOGICAL :: degrade_xe, degrade_ye<a name='7967'>
<a name='7968'>
   INTEGER :: jp1, jp0, jtmp<a name='7969'>
<a name='7970'>
    real            :: dir, vv<a name='7971'>
    real            :: ue,uw,vs,vn,wb,wt<a name='7972'>
    real, parameter :: f30 =  7./12., f31 = 1./12.<a name='7973'>
    real, parameter :: f50 = 37./60., f51 = 2./15., f52 = 1./60.<a name='7974'>
<a name='7975'>
<a name='7976'>
   integer kt,kb<a name='7977'>
   <a name='7978'>
    <a name='7979'>
    real               :: qim2, qim1, qi, qip1, qip2<a name='7980'>
    double precision               :: beta0, beta1, beta2, f0, f1, f2, wi0, wi1, wi2, sumwk<a name='7981'>
    double precision, parameter    :: gi0 = 1.d0/10.d0, gi1 = 6.d0/10.d0, gi2 = 3.d0/10.d0, eps=1.0d-28<a name='7982'>
    integer, parameter :: pw = 2<a name='7983'>
<a name='7984'>
<a name='7985'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='7986'></font>
<a name='7987'>
   REAL    :: flux3, flux4, flux5, flux6<a name='7988'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='7989'>
<a name='7990'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='7991'>
            (7./12.)*(q_i + q_im1) - (1./12.)*(q_ip1 + q_im2)<a name='7992'>
<a name='7993'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='7994'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='7995'>
           sign(1.,ua)*(1./12.)*((q_ip1 - q_im2)-3.*(q_i-q_im1))<a name='7996'>
<a name='7997'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='7998'>
            (37./60.)*(q_i+q_im1) - (2./15.)*(q_ip1+q_im2)      &amp;<a name='7999'>
            +(1./60.)*(q_ip2+q_im3)<a name='8000'>
<a name='8001'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='8002'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='8003'>
            -sign(1,time_step)*sign(1.,ua)*(1./60.)*(           &amp;<a name='8004'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )<a name='8005'>
<a name='8006'>
   LOGICAL :: specified<a name='8007'>
<a name='8008'>
   specified = .false.<a name='8009'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='8010'>
<a name='8011'>
<font color=#447700>! set order for the advection schemes<a name='8012'></font>
<a name='8013'>
  ktf=MIN(kte,kde-1)<a name='8014'>
  horz_order = 5 <font color=#447700>! config_flags%h_sca_adv_order<a name='8015'></font>
  vert_order = 5 <font color=#447700>! config_flags%v_sca_adv_order<a name='8016'></font>
<a name='8017'>
<font color=#447700>!  begin with horizontal flux divergence<a name='8018'></font>
<font color=#447700>!  here is the choice of flux operators<a name='8019'></font>
<a name='8020'>
<a name='8021'>
<a name='8022'>
  IF( horz_order == 5 ) THEN<a name='8023'>
<a name='8024'>
<font color=#447700>!  determine boundary mods for flux operators<a name='8025'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='8026'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='8027'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='8028'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='8029'></font>
<font color=#447700>!   of the higher order flux stencils<a name='8030'></font>
<a name='8031'>
   degrade_xs = .true.<a name='8032'>
   degrade_xe = .true.<a name='8033'>
   degrade_ys = .true.<a name='8034'>
   degrade_ye = .true.<a name='8035'>
<a name='8036'>
   IF( config_flags%periodic_x   .or. &amp;<a name='8037'>
       config_flags%symmetric_xs .or. &amp;<a name='8038'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='8039'>
   IF( config_flags%periodic_x   .or. &amp;<a name='8040'>
       config_flags%symmetric_xe .or. &amp;<a name='8041'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='8042'>
   IF( config_flags%periodic_y   .or. &amp;<a name='8043'>
       config_flags%symmetric_ys .or. &amp;<a name='8044'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='8045'>
   IF( config_flags%periodic_y   .or. &amp;<a name='8046'>
       config_flags%symmetric_ye .or. &amp;<a name='8047'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='8048'>
<a name='8049'>
<font color=#447700>!--------------- y - advection first<a name='8050'></font>
<a name='8051'>
      ktf=MIN(kte,kde-1)<a name='8052'>
      i_start = its<a name='8053'>
      i_end   = MIN(ite,ide-1)<a name='8054'>
<a name='8055'>
<a name='8056'>
<font color=#447700>! check for U<a name='8057'></font>
      IF ( is == 1 ) THEN<a name='8058'>
        i_start = its<a name='8059'>
        i_end   = ite<a name='8060'>
        IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='8061'>
        IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='8062'>
        IF ( config_flags%periodic_x ) i_start = its<a name='8063'>
        IF ( config_flags%periodic_x ) i_end = ite<a name='8064'>
      ENDIF<a name='8065'>
<a name='8066'>
      j_start = jts<a name='8067'>
      j_end   = MIN(jte,jde-1)<a name='8068'>
<a name='8069'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='8070'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='8071'></font>
<a name='8072'>
      j_start_f = j_start<a name='8073'>
      j_end_f   = j_end+1<a name='8074'>
<a name='8075'>
      IF(degrade_ys) then<a name='8076'>
        j_start = MAX(jts,jds+1)<a name='8077'>
        j_start_f = jds+3<a name='8078'>
      ENDIF<a name='8079'>
<a name='8080'>
      IF(degrade_ye) then<a name='8081'>
        j_end = MIN(jte,jde-2)<a name='8082'>
        j_end_f = jde-3<a name='8083'>
      ENDIF<a name='8084'>
<a name='8085'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='8086'>
<a name='8087'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='8088'></font>
<a name='8089'>
     jp1 = 2<a name='8090'>
     jp0 = 1<a name='8091'>
<a name='8092'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='8093'>
<a name='8094'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='8095'></font>
<a name='8096'>
        DO k=kts,ktf<a name='8097'>
        DO i = i_start, i_end<a name='8098'>
<font color=#447700>!          vel = rv(i,k,j)<a name='8099'></font>
          vel = 0.5*( rv(i,k,j) + rv(i-is,k-ks,j-js) )<a name='8100'>
<a name='8101'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='8102'>
            qip2 = field(i,k,j+1)<a name='8103'>
            qip1 = field(i,k,j  )<a name='8104'>
            qi   = field(i,k,j-1)<a name='8105'>
            qim1 = field(i,k,j-2)<a name='8106'>
            qim2 = field(i,k,j-3)<a name='8107'>
          ELSE<a name='8108'>
            qip2 = field(i,k,j-2)<a name='8109'>
            qip1 = field(i,k,j-1)<a name='8110'>
            qi   = field(i,k,j  )<a name='8111'>
            qim1 = field(i,k,j+1)<a name='8112'>
            qim2 = field(i,k,j+2)<a name='8113'>
         ENDIF<a name='8114'>
    <a name='8115'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='8116'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='8117'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='8118'>
    <a name='8119'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='8120'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='8121'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='8122'>
    <a name='8123'>
         wi0 = gi0 / (eps + beta0)**pw<a name='8124'>
         wi1 = gi1 / (eps + beta1)**pw<a name='8125'>
         wi2 = gi2 / (eps + beta2)**pw<a name='8126'>
    <a name='8127'>
         sumwk = wi0 + wi1 + wi2<a name='8128'>
    <a name='8129'>
          fqy( i, k, jp1 ) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='8130'>
<a name='8131'>
<font color=#447700>!          fqy( i, k, jp1 ) = vel*flux5(                                &amp;<a name='8132'></font>
<font color=#447700>!                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='8133'></font>
<font color=#447700>!                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='8134'></font>
        ENDDO<a name='8135'>
        ENDDO<a name='8136'>
<a name='8137'>
<a name='8138'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='8139'></font>
<a name='8140'>
            DO k=kts,ktf<a name='8141'>
            DO i = i_start, i_end<a name='8142'>
              fqy(i,k, jp1) = 0.5*rv(i,k,j)*          &amp;<a name='8143'>
<font color=#447700>!              fqy(i,k, jp1) = 0.5*0.5*( rv(i,k,j) + rv(i-is,k-ks,j-js) )*          &amp;<a name='8144'></font>
                     (field(i,k,j)+field(i,k,j-1))<a name='8145'>
<a name='8146'>
            ENDDO<a name='8147'>
            ENDDO<a name='8148'>
<a name='8149'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='8150'></font>
<a name='8151'>
            DO k=kts,ktf<a name='8152'>
            DO i = i_start, i_end<a name='8153'>
<font color=#447700>!              vel = 0.5*( rv(i,k,j) + rv(i-is,k-ks,j-js) )<a name='8154'></font>
              vel = rv(i,k,j)<a name='8155'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='8156'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='8157'>
            ENDDO<a name='8158'>
            ENDDO<a name='8159'>
<a name='8160'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='8161'></font>
<a name='8162'>
            DO k=kts,ktf<a name='8163'>
            DO i = i_start, i_end<a name='8164'>
<font color=#447700>!              fqy(i, k, jp1) = 0.5*0.5*( rv(i,k,j) + rv(i-is,k-ks,j-js) )*      &amp;<a name='8165'></font>
              fqy(i, k, jp1) = 0.5*rv(i,k,j)*      &amp;<a name='8166'>
                     (field(i,k,j)+field(i,k,j-1))<a name='8167'>
            ENDDO<a name='8168'>
            ENDDO<a name='8169'>
<a name='8170'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='8171'></font>
<a name='8172'>
            DO k=kts,ktf<a name='8173'>
            DO i = i_start, i_end<a name='8174'>
              vel = rv(i,k,j)<a name='8175'>
<font color=#447700>!              vel = 0.5*( rv(i,k,j) + rv(i-is,k-ks,j-js) )<a name='8176'></font>
              fqy( i, k, jp1) = vel*flux3(             &amp;<a name='8177'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='8178'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='8179'>
            ENDDO<a name='8180'>
            ENDDO<a name='8181'>
<a name='8182'>
     ENDIF<a name='8183'>
<a name='8184'>
<font color=#447700>!  y flux-divergence into tendency<a name='8185'></font>
<a name='8186'>
      IF ( is == 0 ) THEN<a name='8187'>
        <font color=#447700>! Comments on polar boundary conditions<a name='8188'></font>
        <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='8189'></font>
        <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='8190'></font>
        <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='8191'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='8192'>
          DO k=kts,ktf<a name='8193'>
          DO i = i_start, i_end<a name='8194'>
            mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='8195'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='8196'>
          END DO<a name='8197'>
          END DO<a name='8198'>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='8199'>
          DO k=kts,ktf<a name='8200'>
          DO i = i_start, i_end<a name='8201'>
            mrdy=msftx(i,j-1)*rdy     <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='8202'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='8203'>
          END DO<a name='8204'>
          END DO<a name='8205'>
        ELSE  <font color=#447700>! normal code<a name='8206'></font>
<a name='8207'>
        IF(j &gt; j_start) THEN<a name='8208'>
<a name='8209'>
          DO k=kts,ktf<a name='8210'>
          DO i = i_start, i_end<a name='8211'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 2nd term RHS<a name='8212'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='8213'>
          ENDDO<a name='8214'>
          ENDDO<a name='8215'>
<a name='8216'>
        ENDIF<a name='8217'>
        ENDIF<a name='8218'>
       ELSEIF ( is == 1 ) THEN<a name='8219'>
<a name='8220'>
        <font color=#447700>! (j &gt; j_start) will miss the u(,,jds) tendency<a name='8221'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='8222'>
          DO k=kts,ktf<a name='8223'>
          DO i = i_start, i_end<a name='8224'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='8225'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='8226'>
          END DO<a name='8227'>
          END DO<a name='8228'>
        <font color=#447700>! This would be seen by (j &gt; j_start) but we need to zero out the NP tendency<a name='8229'></font>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='8230'>
          DO k=kts,ktf<a name='8231'>
          DO i = i_start, i_end<a name='8232'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='8233'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='8234'>
          END DO<a name='8235'>
          END DO<a name='8236'>
        ELSE  <font color=#447700>! normal code<a name='8237'></font>
<a name='8238'>
        IF(j &gt; j_start) THEN<a name='8239'>
<a name='8240'>
          DO k=kts,ktf<a name='8241'>
          DO i = i_start, i_end<a name='8242'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='8243'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='8244'>
          ENDDO<a name='8245'>
          ENDDO<a name='8246'>
<a name='8247'>
        ENDIF<a name='8248'>
<a name='8249'>
        END IF<a name='8250'>
       <a name='8251'>
       ENDIF<a name='8252'>
<a name='8253'>
        jtmp = jp1<a name='8254'>
        jp1 = jp0<a name='8255'>
        jp0 = jtmp<a name='8256'>
<a name='8257'>
      ENDDO j_loop_y_flux_5<a name='8258'>
<a name='8259'>
<font color=#447700>!  next, x - flux divergence<a name='8260'></font>
<a name='8261'>
      i_start = its<a name='8262'>
      i_end   = MIN(ite,ide-1)<a name='8263'>
<a name='8264'>
      j_start = jts<a name='8265'>
      j_end   = MIN(jte,jde-1)<a name='8266'>
<a name='8267'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='8268'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='8269'></font>
<a name='8270'>
      i_start_f = i_start<a name='8271'>
      i_end_f   = i_end+1<a name='8272'>
<a name='8273'>
      IF(degrade_xs) then<a name='8274'>
        i_start = MAX(ids+1,its)<a name='8275'>
<font color=#447700>!        i_start_f = i_start+2<a name='8276'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='8277'>
      ENDIF<a name='8278'>
<a name='8279'>
      IF(degrade_xe) then<a name='8280'>
        i_end = MIN(ide-2,ite)<a name='8281'>
        i_end_f = ide-3<a name='8282'>
      ENDIF<a name='8283'>
<a name='8284'>
<font color=#447700>!  compute fluxes<a name='8285'></font>
<a name='8286'>
      DO j = j_start, j_end<a name='8287'>
<a name='8288'>
<font color=#447700>!  5th or 6th order flux<a name='8289'></font>
<a name='8290'>
        DO k=kts,ktf<a name='8291'>
        DO i = i_start_f, i_end_f<a name='8292'>
<font color=#447700>!          vel = ru(i,k,j)<a name='8293'></font>
          vel = 0.5*( ru(i,k,j) + ru(i-is,k-ks,j-js) )<a name='8294'>
<a name='8295'>
<a name='8296'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='8297'>
            qip2 = field(i+1,k,j)<a name='8298'>
            qip1 = field(i,  k,j)<a name='8299'>
            qi   = field(i-1,k,j)<a name='8300'>
            qim1 = field(i-2,k,j)<a name='8301'>
            qim2 = field(i-3,k,j)<a name='8302'>
          ELSE<a name='8303'>
            qip2 = field(i-2,k,j)<a name='8304'>
            qip1 = field(i-1,k,j)<a name='8305'>
            qi   = field(i,  k,j)<a name='8306'>
            qim1 = field(i+1,k,j)<a name='8307'>
            qim2 = field(i+2,k,j)<a name='8308'>
         ENDIF<a name='8309'>
    <a name='8310'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='8311'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='8312'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='8313'>
    <a name='8314'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='8315'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='8316'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='8317'>
    <a name='8318'>
         wi0 = gi0 / (eps + beta0)**pw<a name='8319'>
         wi1 = gi1 / (eps + beta1)**pw<a name='8320'>
         wi2 = gi2 / (eps + beta2)**pw<a name='8321'>
    <a name='8322'>
         sumwk = wi0 + wi1 + wi2<a name='8323'>
    <a name='8324'>
         fqx(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='8325'>
<a name='8326'>
<font color=#447700>!          fqx( i,k ) = vel*flux5( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='8327'></font>
<font color=#447700>!                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='8328'></font>
<font color=#447700>!                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='8329'></font>
<font color=#447700>!                                         vel                             )<a name='8330'></font>
        ENDDO<a name='8331'>
        ENDDO<a name='8332'>
<a name='8333'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='8334'></font>
<a name='8335'>
        IF( degrade_xs ) THEN<a name='8336'>
<a name='8337'>
          DO i=i_start,i_start_f-1<a name='8338'>
<a name='8339'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='8340'></font>
              DO k=kts,ktf<a name='8341'>
                fqx(i,k) = 0.5*(ru(i,k,j)) &amp;<a name='8342'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='8343'>
              ENDDO<a name='8344'>
            ENDIF<a name='8345'>
<a name='8346'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='8347'></font>
              DO k=kts,ktf<a name='8348'>
                vel = ru(i,k,j)<a name='8349'>
                fqx( i,k ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='8350'>
                                              field(i  ,k,j), field(i+1,k,j),  &amp;<a name='8351'>
                                              vel                     )<a name='8352'>
              ENDDO<a name='8353'>
            END IF<a name='8354'>
<a name='8355'>
          ENDDO<a name='8356'>
<a name='8357'>
        ENDIF<a name='8358'>
<a name='8359'>
        IF( degrade_xe ) THEN<a name='8360'>
<a name='8361'>
          DO i = i_end_f+1, i_end+1<a name='8362'>
<a name='8363'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='8364'></font>
              DO k=kts,ktf<a name='8365'>
                fqx(i,k) = 0.5*(ru(i,k,j))      &amp;<a name='8366'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='8367'>
              ENDDO<a name='8368'>
           ENDIF<a name='8369'>
<a name='8370'>
           IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='8371'></font>
             DO k=kts,ktf<a name='8372'>
               vel = ru(i,k,j)<a name='8373'>
               fqx( i,k ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='8374'>
                                       field(i  ,k,j), field(i+1,k,j),  &amp;<a name='8375'>
                                       vel                             )<a name='8376'>
             ENDDO<a name='8377'>
           ENDIF<a name='8378'>
<a name='8379'>
         ENDDO<a name='8380'>
<a name='8381'>
       ENDIF<a name='8382'>
<a name='8383'>
<font color=#447700>!  x flux-divergence into tendency<a name='8384'></font>
<a name='8385'>
       IF ( is == 0 ) THEN<a name='8386'>
          DO k=kts,ktf<a name='8387'>
          DO i = i_start, i_end<a name='8388'>
            mrdx=msftx(i,j)*rdx      <font color=#447700>! see ADT eqn 48 [rho-&gt;rho*q] dividing by my, 1st term RHS<a name='8389'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='8390'>
          ENDDO<a name='8391'>
          ENDDO<a name='8392'>
       ELSEIF ( is == 1 ) THEN<a name='8393'>
        DO k=kts,ktf<a name='8394'>
          DO i = i_start, i_end<a name='8395'>
            mrdx=msfux(i,j)*rdx <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='8396'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='8397'>
          ENDDO<a name='8398'>
        ENDDO<a name='8399'>
       ENDIF<a name='8400'>
<a name='8401'>
      ENDDO<a name='8402'>
<a name='8403'>
<a name='8404'>
   ENDIF<a name='8405'>
   <a name='8406'>
<a name='8407'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='8408'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='8409'></font>
<font color=#447700>!  first, set to index ranges<a name='8410'></font>
<a name='8411'>
      i_start = its<a name='8412'>
      i_end   = MIN(ite,ide-1)<a name='8413'>
      j_start = jts<a name='8414'>
      j_end   = MIN(jte,jde-1)<a name='8415'>
<a name='8416'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='8417'></font>
<a name='8418'>
   IF( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='8419'>
<a name='8420'>
       DO j = j_start, j_end<a name='8421'>
       DO k = kts, ktf<a name='8422'>
         ub = MIN( 0.5*(ru(its,k,j)+ru(its+1,k,j)), 0. )<a name='8423'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='8424'>
               - rdx*(                                             &amp;<a name='8425'>
                       ub*(   field_old(its+1,k,j)                 &amp;<a name='8426'>
                            - field_old(its  ,k,j)   ) +           &amp;<a name='8427'>
                       field(its,k,j)*(ru(its+1,k,j)-ru(its,k,j))  &amp;<a name='8428'>
                                                                )<a name='8429'>
       ENDDO<a name='8430'>
       ENDDO<a name='8431'>
<a name='8432'>
   ENDIF<a name='8433'>
<a name='8434'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='8435'>
<a name='8436'>
       DO j = j_start, j_end<a name='8437'>
       DO k = kts, ktf<a name='8438'>
         ub = MAX( 0.5*(ru(ite-1,k,j)+ru(ite,k,j)), 0. )<a name='8439'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                   &amp;<a name='8440'>
               - rdx*(                                               &amp;<a name='8441'>
                       ub*(  field_old(i_end  ,k,j)                  &amp;<a name='8442'>
                           - field_old(i_end-1,k,j) ) +              &amp;<a name='8443'>
                       field(i_end,k,j)*(ru(ite,k,j)-ru(ite-1,k,j))  &amp;<a name='8444'>
                                                                    )<a name='8445'>
       ENDDO<a name='8446'>
       ENDDO<a name='8447'>
<a name='8448'>
   ENDIF<a name='8449'>
<a name='8450'>
   IF( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='8451'>
<a name='8452'>
       DO i = i_start, i_end<a name='8453'>
       DO k = kts, ktf<a name='8454'>
         vb = MIN( 0.5*(rv(i,k,jts)+rv(i,k,jts+1)), 0. )<a name='8455'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='8456'>
               - rdy*(                                             &amp;<a name='8457'>
                       vb*(  field_old(i,k,jts+1)                  &amp;<a name='8458'>
                           - field_old(i,k,jts  ) ) +              &amp;<a name='8459'>
                       field(i,k,jts)*(rv(i,k,jts+1)-rv(i,k,jts))  &amp;<a name='8460'>
                                                                )<a name='8461'>
       ENDDO<a name='8462'>
       ENDDO<a name='8463'>
<a name='8464'>
   ENDIF<a name='8465'>
<a name='8466'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='8467'>
<a name='8468'>
       DO i = i_start, i_end<a name='8469'>
       DO k = kts, ktf<a name='8470'>
         vb = MAX( 0.5*(rv(i,k,jte-1)+rv(i,k,jte)), 0. )<a name='8471'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                   &amp;<a name='8472'>
               - rdy*(                                               &amp;<a name='8473'>
                       vb*(   field_old(i,k,j_end  )                 &amp;<a name='8474'>
                            - field_old(i,k,j_end-1) ) +             &amp;<a name='8475'>
                       field(i,k,j_end)*(rv(i,k,jte)-rv(i,k,jte-1))  &amp;<a name='8476'>
                                                                    )<a name='8477'>
       ENDDO<a name='8478'>
       ENDDO<a name='8479'>
<a name='8480'>
   ENDIF<a name='8481'>
<a name='8482'>
<a name='8483'>
<font color=#447700>!-------------------- vertical advection<a name='8484'></font>
<font color=#447700>!     Scalar equation has 3rd term on RHS = - partial d/dz (q rho w /my)<a name='8485'></font>
<font color=#447700>!     Here we have: - partial d/dz (q*rom) = - partial d/dz (q rho w / my)<a name='8486'></font>
<font color=#447700>!     So we don't need to make a correction for advect_scalar<a name='8487'></font>
<a name='8488'>
      i_start = its<a name='8489'>
      i_end   = MIN(ite,ide-1)<a name='8490'>
      j_start = jts<a name='8491'>
      j_end   = MIN(jte,jde-1)<a name='8492'>
<a name='8493'>
      DO i = i_start, i_end<a name='8494'>
         vflux(i,kts)=0.<a name='8495'>
         vflux(i,kte)=0.<a name='8496'>
      ENDDO<a name='8497'>
<a name='8498'>
<a name='8499'>
<a name='8500'>
      DO j = j_start, j_end<a name='8501'>
<a name='8502'>
         DO k=kts+3,ktf-2<a name='8503'>
         DO i = i_start, i_end<a name='8504'>
<font color=#447700>!           vel = rom(i,k,j)<a name='8505'></font>
           vel = 0.5*( rom(i,k,j) + rom(i-is,k-ks,j-js) )<a name='8506'>
<a name='8507'>
         IF( -vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='8508'>
            qip2 = field(i,k+1,j)<a name='8509'>
            qip1 = field(i,k  ,j)<a name='8510'>
            qi   = field(i,k-1,j)<a name='8511'>
            qim1 = field(i,k-2,j)<a name='8512'>
            qim2 = field(i,k-3,j)<a name='8513'>
          ELSE<a name='8514'>
            qip2 = field(i,k-2,j)<a name='8515'>
            qip1 = field(i,k-1,j)<a name='8516'>
            qi   = field(i,k  ,j)<a name='8517'>
            qim1 = field(i,k+1,j)<a name='8518'>
            qim2 = field(i,k+2,j)<a name='8519'>
         ENDIF<a name='8520'>
    <a name='8521'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='8522'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='8523'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='8524'>
    <a name='8525'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='8526'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='8527'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='8528'>
    <a name='8529'>
         wi0 = gi0 / (eps + beta0)**pw<a name='8530'>
         wi1 = gi1 / (eps + beta1)**pw<a name='8531'>
         wi2 = gi2 / (eps + beta2)**pw<a name='8532'>
    <a name='8533'>
         sumwk = wi0 + wi1 + wi2<a name='8534'>
    <a name='8535'>
          vflux(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='8536'>
<a name='8537'>
<font color=#447700>!           vflux(i,k) = vel*flux5(                                 &amp;<a name='8538'></font>
<font color=#447700>!                   field(i,k-3,j), field(i,k-2,j), field(i,k-1,j),       &amp;<a name='8539'></font>
<font color=#447700>!                   field(i,k  ,j), field(i,k+1,j), field(i,k+2,j),  -vel )<a name='8540'></font>
         ENDDO<a name='8541'>
         ENDDO<a name='8542'>
<a name='8543'>
         DO i = i_start, i_end<a name='8544'>
<a name='8545'>
           k=kts+1<a name='8546'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='8547'>
                                   <a name='8548'>
           k = kts+2<a name='8549'>
           vel=rom(i,k,j) <a name='8550'>
           vflux(i,k) = vel*flux3(               &amp;<a name='8551'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='8552'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='8553'>
           k = ktf-1<a name='8554'>
           vel=rom(i,k,j)<a name='8555'>
           vflux(i,k) = vel*flux3(               &amp;<a name='8556'>
                   field(i,k-2,j), field(i,k-1,j),   &amp;<a name='8557'>
                   field(i,k  ,j), field(i,k+1,j), -vel )<a name='8558'>
<a name='8559'>
           k=ktf<a name='8560'>
           vflux(i,k)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='8561'>
         ENDDO<a name='8562'>
<a name='8563'>
         DO k=kts,ktf<a name='8564'>
         DO i = i_start, i_end<a name='8565'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='8566'>
         ENDDO<a name='8567'>
         ENDDO<a name='8568'>
<a name='8569'>
      ENDDO<a name='8570'>
<a name='8571'>
<a name='8572'>
<a name='8573'>
END SUBROUTINE advect_scalar_weno<a name='8574'>
<a name='8575'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='8576'></font>
<a name='8577'>
<A NAME='ADVECT_SCALAR_WENOPD'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_WENOPD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='8578'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_scalar_wenopd</font> ( field, field_old, tendency,    &amp; <A href='../../call_to/ADVECT_SCALAR_WENOPD.html' TARGET='index'>2</A><a name='8579'>
                                ru, rv, rom,                   &amp;<a name='8580'>
                                c1, c2,                        &amp;<a name='8581'>
                                mut, mub, mu_old,              &amp;<a name='8582'>
                                time_step, config_flags,       &amp;<a name='8583'>
                                msfux, msfuy, msfvx, msfvy,    &amp;<a name='8584'>
                                msftx, msfty,                  &amp;<a name='8585'>
                                fzm, fzp,                      &amp;<a name='8586'>
                                rdx, rdy, rdzw, dt,            &amp;<a name='8587'>
                                ids, ide, jds, jde, kds, kde,  &amp;<a name='8588'>
                                ims, ime, jms, jme, kms, kme,  &amp;<a name='8589'>
                                its, ite, jts, jte, kts, kte  )<a name='8590'>
<a name='8591'>
<font color=#447700>!  this is a first cut at a positive definite advection option<a name='8592'></font>
<font color=#447700>!  for scalars in WRF.  This version is memory intensive -&gt;<a name='8593'></font>
<font color=#447700>!  we save 3d arrays of x, y and z both high and low order fluxes<a name='8594'></font>
<font color=#447700>!  (six in all).  Alternatively, we could sweep in a direction <a name='8595'></font>
<font color=#447700>!  and lower the cost considerably.<a name='8596'></font>
<a name='8597'>
<font color=#447700>!  uses the Smolarkiewicz MWR 1989 approach, with addition of first-order<a name='8598'></font>
<font color=#447700>!  fluxes initially<a name='8599'></font>
<a name='8600'>
<font color=#447700>!  WCS, 3 December 2002, 24 February 2003<a name='8601'></font>
<a name='8602'>
<font color=#447700>!<a name='8603'></font>
<font color=#447700>! ERM Dec. 2011: replaced 5th-order fluxes with 5th-order WENO (Weighted<a name='8604'></font>
<font color=#447700>! Essentially Non-Oscillatory) scheme<a name='8605'></font>
<font color=#447700>! See Jiang and Shu, 1996, J. Comp. Phys. v. 126, 202-223; <a name='8606'></font>
<font color=#447700>! Shu 2003, Int. J. Comp. Fluid Dyn. v. 17 107-118; <a name='8607'></font>
<font color=#447700>!<a name='8608'></font>
<a name='8609'>
   IMPLICIT NONE<a name='8610'>
   <a name='8611'>
   <font color=#447700>! Input data<a name='8612'></font>
   <a name='8613'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='8614'>
<a name='8615'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='8616'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='8617'>
                                              its, ite, jts, jte, kts, kte<a name='8618'>
<a name='8619'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field,     &amp;<a name='8620'>
                                                                      field_old, &amp;<a name='8621'>
                                                                      ru,    &amp;<a name='8622'>
                                                                      rv,    &amp;<a name='8623'>
                                                                      rom<a name='8624'>
<a name='8625'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut, mub, mu_old<a name='8626'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='8627'>
<a name='8628'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='8629'>
                                                                    msfuy,  &amp;<a name='8630'>
                                                                    msfvx,  &amp;<a name='8631'>
                                                                    msfvy,  &amp;<a name='8632'>
                                                                    msftx,  &amp;<a name='8633'>
                                                                    msfty<a name='8634'>
<a name='8635'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='8636'>
                                                                  fzp,  &amp;<a name='8637'>
                                                                  rdzw, &amp;<a name='8638'>
                                                                  c1,   &amp;<a name='8639'>
                                                                  c2<a name='8640'>
<a name='8641'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='8642'>
                                                                  rdy,  &amp;<a name='8643'>
                                                                  dt<a name='8644'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='8645'>
<a name='8646'>
   <font color=#447700>! Local data<a name='8647'></font>
   <a name='8648'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='8649'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='8650'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='8651'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='8652'>
<a name='8653'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, mu<a name='8654'>
<a name='8655'>
<font color=#447700>!  storage for high and low order fluxes<a name='8656'></font>
<a name='8657'>
   REAL,  DIMENSION( its-1:ite+2, kts:kte, jts-1:jte+2  ) :: fqx, fqy, fqz<a name='8658'>
   REAL,  DIMENSION( its-1:ite+2, kts:kte, jts-1:jte+2  ) :: fqxl, fqyl, fqzl<a name='8659'>
<a name='8660'>
   INTEGER :: horz_order, vert_order<a name='8661'>
   <a name='8662'>
   LOGICAL :: degrade_xs, degrade_ys<a name='8663'>
   LOGICAL :: degrade_xe, degrade_ye<a name='8664'>
<a name='8665'>
   INTEGER :: jp1, jp0, jtmp<a name='8666'>
   <a name='8667'>
   REAL,DIMENSION( its-1:ite+2, kts:kte, jts-1:jte+2  ) :: flux_out, ph_low<a name='8668'>
   REAL :: scale<a name='8669'>
   REAL, PARAMETER :: eps=1.e-20<a name='8670'>
<a name='8671'>
    real            :: dir, vv<a name='8672'>
    real            :: ue,vs,vn,wb,wt<a name='8673'>
    real, parameter :: f30 =  7./12., f31 = 1./12.<a name='8674'>
    real, parameter :: f50 = 37./60., f51 = 2./15., f52 = 1./60.<a name='8675'>
<a name='8676'>
    real               :: qim2, qim1, qi, qip1, qip2<a name='8677'>
    double precision               :: beta0, beta1, beta2, f0, f1, f2, wi0, wi1, wi2, sumwk<a name='8678'>
    double precision, parameter    :: gi0 = 1.d0/10.d0, gi1 = 6.d0/10.d0, gi2 = 3.d0/10.d0, eps1=1.0d-28<a name='8679'>
    integer, parameter :: pw = 2<a name='8680'>
<a name='8681'>
<a name='8682'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='8683'></font>
<a name='8684'>
   REAL    :: flux3, flux4, flux5, flux6, flux_upwind<a name='8685'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel, cr<a name='8686'>
<a name='8687'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='8688'>
            (7./12.)*(q_i + q_im1) - (1./12.)*(q_ip1 + q_im2)<a name='8689'>
<a name='8690'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='8691'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='8692'>
           sign(1,time_step)*sign(1.,ua)*(1./12.)*((q_ip1 - q_im2)-3.*(q_i-q_im1))<a name='8693'>
<a name='8694'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='8695'>
            (37./60.)*(q_i+q_im1) - (2./15.)*(q_ip1+q_im2)      &amp;<a name='8696'>
            +(1./60.)*(q_ip2+q_im3)<a name='8697'>
<a name='8698'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='8699'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='8700'>
            -sign(1,time_step)*sign(1.,ua)*(1./60.)*(           &amp;<a name='8701'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )<a name='8702'>
<a name='8703'>
      flux_upwind(q_im1, q_i, cr ) = 0.5*min( 1.0,(cr+abs(cr)))*q_im1 &amp;<a name='8704'>
                                    +0.5*max(-1.0,(cr-abs(cr)))*q_i<a name='8705'>
<a name='8706'>
<font color=#447700>!      flux_upwind(q_im1, q_i, cr ) = 0.5*(1.+sign(1.,cr))*q_im1 &amp;<a name='8707'></font>
<font color=#447700>!                                    +0.5*(1.-sign(1.,cr))*q_i<a name='8708'></font>
<font color=#447700>!      flux_upwind(q_im1, q_i, cr ) = 0.<a name='8709'></font>
<a name='8710'>
    REAL     :: dx,dy,dz<a name='8711'>
<a name='8712'>
    LOGICAL, PARAMETER :: pd_limit = .true.<a name='8713'>
<a name='8714'>
<font color=#447700>! set order for the advection schemes<a name='8715'></font>
<a name='8716'>
<font color=#447700>!  write(6,*) ' in pd advection routine '<a name='8717'></font>
<a name='8718'>
    <font color=#447700>! Empty arrays just in case:<a name='8719'></font>
    IF (config_flags%polar) THEN<a name='8720'>
       fqx(:,:,:)  = 0.<a name='8721'>
       fqy(:,:,:)  = 0.<a name='8722'>
       fqz(:,:,:)  = 0.<a name='8723'>
       fqxl(:,:,:) = 0.<a name='8724'>
       fqyl(:,:,:) = 0.<a name='8725'>
       fqzl(:,:,:) = 0.<a name='8726'>
    END IF<a name='8727'>
<a name='8728'>
  ktf=MIN(kte,kde-1)<a name='8729'>
  horz_order = config_flags%h_sca_adv_order<a name='8730'>
  vert_order = config_flags%v_sca_adv_order<a name='8731'>
<a name='8732'>
<font color=#447700>!  determine boundary mods for flux operators<a name='8733'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='8734'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='8735'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='8736'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='8737'></font>
<font color=#447700>!   of the higher order flux stencils<a name='8738'></font>
<a name='8739'>
   degrade_xs = .true.<a name='8740'>
   degrade_xe = .true.<a name='8741'>
   degrade_ys = .true.<a name='8742'>
   degrade_ye = .true.<a name='8743'>
<a name='8744'>
<font color=#447700>!  begin with horizontal flux divergence<a name='8745'></font>
<font color=#447700>!  here is the choice of flux operators<a name='8746'></font>
<a name='8747'>
<a name='8748'>
<font color=#447700>!  horizontal_order_test : IF( horz_order == 6 ) THEN<a name='8749'></font>
<a name='8750'>
<font color=#447700>!    ELSE IF( horz_order == 5 ) THEN<a name='8751'></font>
<a name='8752'>
   IF( config_flags%periodic_x   .or. &amp;<a name='8753'>
       config_flags%symmetric_xs .or. &amp;<a name='8754'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='8755'>
   IF( config_flags%periodic_x   .or. &amp;<a name='8756'>
       config_flags%symmetric_xe .or. &amp;<a name='8757'>
       (ite &lt; ide-4)                ) degrade_xe = .false.<a name='8758'>
   IF( config_flags%periodic_y   .or. &amp;<a name='8759'>
       config_flags%symmetric_ys .or. &amp;<a name='8760'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='8761'>
   IF( config_flags%periodic_y   .or. &amp;<a name='8762'>
       config_flags%symmetric_ye .or. &amp;<a name='8763'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='8764'>
<a name='8765'>
<font color=#447700>!--------------- y - advection first<a name='8766'></font>
<a name='8767'>
<font color=#447700>!--  y flux compute; these bounds are for periodic and sym b.c.<a name='8768'></font>
<a name='8769'>
      ktf=MIN(kte,kde-1)<a name='8770'>
      i_start = its-1<a name='8771'>
      i_end   = MIN(ite,ide-1)+1<a name='8772'>
      j_start = jts-1<a name='8773'>
      j_end   = MIN(jte,jde-1)+1<a name='8774'>
      j_start_f = j_start<a name='8775'>
      j_end_f   = j_end+1<a name='8776'>
<a name='8777'>
<font color=#447700>!--  modify loop bounds if open or specified<a name='8778'></font>
<a name='8779'>
<font color=#447700>!      IF(degrade_xs) i_start = MAX(its-1,ids-1)<a name='8780'></font>
<font color=#447700>!      IF(degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='8781'></font>
      IF(degrade_xs) i_start = MAX(its-1,ids)<a name='8782'>
      IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='8783'>
<a name='8784'>
      IF(degrade_ys) then<a name='8785'>
        j_start = MAX(jts-1,jds+1)<a name='8786'>
        j_start_f = jds+3<a name='8787'>
      ENDIF<a name='8788'>
<a name='8789'>
      IF(degrade_ye) then<a name='8790'>
        j_end = MIN(jte+1,jde-2)<a name='8791'>
        j_end_f = jde-3<a name='8792'>
      ENDIF<a name='8793'>
<a name='8794'>
<font color=#447700>!  compute fluxes, 5th order<a name='8795'></font>
<a name='8796'>
      j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='8797'>
<a name='8798'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='8799'></font>
<a name='8800'>
        DO k=kts,ktf<a name='8801'>
        DO i = i_start, i_end<a name='8802'>
<a name='8803'>
          dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='8804'></font>
          mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='8805'>
          vel = rv(i,k,j)<a name='8806'>
          cr = vel*dt/dy/mu<a name='8807'>
          fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='8808'>
<a name='8809'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='8810'>
            qip2 = field(i,k,j+1)<a name='8811'>
            qip1 = field(i,k,j  )<a name='8812'>
            qi   = field(i,k,j-1)<a name='8813'>
            qim1 = field(i,k,j-2)<a name='8814'>
            qim2 = field(i,k,j-3)<a name='8815'>
          ELSE<a name='8816'>
            qip2 = field(i,k,j-2)<a name='8817'>
            qip1 = field(i,k,j-1)<a name='8818'>
            qi   = field(i,k,j  )<a name='8819'>
            qim1 = field(i,k,j+1)<a name='8820'>
            qim2 = field(i,k,j+2)<a name='8821'>
         ENDIF<a name='8822'>
    <a name='8823'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='8824'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='8825'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='8826'>
    <a name='8827'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='8828'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='8829'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='8830'>
    <a name='8831'>
         wi0 = gi0 / (eps1 + beta0)**pw<a name='8832'>
         wi1 = gi1 / (eps1 + beta1)**pw<a name='8833'>
         wi2 = gi2 / (eps1 + beta2)**pw<a name='8834'>
    <a name='8835'>
         sumwk = wi0 + wi1 + wi2<a name='8836'>
    <a name='8837'>
          fqy( i, k, j ) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='8838'>
<a name='8839'>
<font color=#447700>!          fqy( i, k, j  ) = vel*flux5(                                  &amp;<a name='8840'></font>
<font color=#447700>!                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='8841'></font>
<font color=#447700>!                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='8842'></font>
<a name='8843'>
          fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='8844'>
<a name='8845'>
        ENDDO<a name='8846'>
        ENDDO<a name='8847'>
<a name='8848'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='8849'></font>
<a name='8850'>
            DO k=kts,ktf<a name='8851'>
            DO i = i_start, i_end<a name='8852'>
<a name='8853'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='8854'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='8855'>
              vel = rv(i,k,j)<a name='8856'>
              cr = vel*dt/dy/mu<a name='8857'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='8858'>
<a name='8859'>
              fqy(i,k, j) = 0.5*rv(i,k,j)*          &amp;<a name='8860'>
                     (field(i,k,j)+field(i,k,j-1))<a name='8861'>
<a name='8862'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='8863'>
<a name='8864'>
            ENDDO<a name='8865'>
            ENDDO<a name='8866'>
<a name='8867'>
      ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='8868'></font>
<a name='8869'>
            DO k=kts,ktf<a name='8870'>
            DO i = i_start, i_end<a name='8871'>
<a name='8872'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='8873'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='8874'>
              vel = rv(i,k,j)<a name='8875'>
              cr = vel*dt/dy/mu<a name='8876'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='8877'>
<a name='8878'>
              fqy( i, k, j ) = vel*flux3(              &amp;<a name='8879'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='8880'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='8881'>
<a name='8882'>
            ENDDO<a name='8883'>
            ENDDO<a name='8884'>
<a name='8885'>
      ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='8886'></font>
<a name='8887'>
            DO k=kts,ktf<a name='8888'>
            DO i = i_start, i_end<a name='8889'>
<a name='8890'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='8891'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='8892'>
              vel = rv(i,k,j)<a name='8893'>
              cr = vel*dt/dy/mu<a name='8894'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='8895'>
<a name='8896'>
              fqy(i, k, j ) = 0.5*rv(i,k,j)*      &amp;<a name='8897'>
                     (field(i,k,j)+field(i,k,j-1))<a name='8898'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='8899'>
<a name='8900'>
            ENDDO<a name='8901'>
            ENDDO<a name='8902'>
<a name='8903'>
      ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='8904'></font>
<a name='8905'>
            DO k=kts,ktf<a name='8906'>
            DO i = i_start, i_end<a name='8907'>
<a name='8908'>
              dy = 2./(msftx(i,j)+msftx(i,j-1))/rdy  <font color=#447700>! ADT eqn 48 d/dy<a name='8909'></font>
              mu = 0.5*(mut(i,j)+mut(i,j-1))<a name='8910'>
              vel = rv(i,k,j)<a name='8911'>
              cr = vel*dt/dy/mu<a name='8912'>
              fqyl(i,k,j) = mu*(dy/dt)*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='8913'>
<a name='8914'>
              fqy( i, k, j) = vel*flux3(             &amp;<a name='8915'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='8916'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='8917'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='8918'>
<a name='8919'>
            ENDDO<a name='8920'>
            ENDDO<a name='8921'>
<a name='8922'>
      ENDIF<a name='8923'>
<a name='8924'>
   ENDDO j_loop_y_flux_5<a name='8925'>
<a name='8926'>
<font color=#447700>!  next, x flux<a name='8927'></font>
<a name='8928'>
<font color=#447700>!--  these bounds are for periodic and sym conditions<a name='8929'></font>
<a name='8930'>
      i_start = its-1<a name='8931'>
      i_end   = MIN(ite,ide-1)+1<a name='8932'>
      i_start_f = i_start<a name='8933'>
      i_end_f   = i_end+1<a name='8934'>
<a name='8935'>
      j_start = jts-1<a name='8936'>
      j_end   = MIN(jte,jde-1)+1<a name='8937'>
<a name='8938'>
<font color=#447700>!--  modify loop bounds for open and specified b.c<a name='8939'></font>
<a name='8940'>
<font color=#447700>!      IF(degrade_ys) j_start = MAX(jts-1,jds+1)<a name='8941'></font>
<font color=#447700>!      IF(degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='8942'></font>
      IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='8943'>
      IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='8944'>
<a name='8945'>
      IF(degrade_xs) then<a name='8946'>
        i_start = MAX(ids+1,its-1)<a name='8947'>
        i_start_f = ids+3<a name='8948'>
      ENDIF<a name='8949'>
<a name='8950'>
      IF(degrade_xe) then<a name='8951'>
        i_end = MIN(ide-2,ite+1)<a name='8952'>
        i_end_f = ide-3<a name='8953'>
      ENDIF<a name='8954'>
<a name='8955'>
<font color=#447700>!  compute fluxes<a name='8956'></font>
<a name='8957'>
      DO j = j_start, j_end<a name='8958'>
<a name='8959'>
<font color=#447700>!  5th order flux<a name='8960'></font>
<a name='8961'>
        DO k=kts,ktf<a name='8962'>
        DO i = i_start_f, i_end_f<a name='8963'>
<a name='8964'>
          dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='8965'></font>
          mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='8966'>
          vel = ru(i,k,j)<a name='8967'>
          cr = vel*dt/dx/mu<a name='8968'>
          fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='8969'>
<a name='8970'>
<a name='8971'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='8972'>
            qip2 = field(i+1,k,j)<a name='8973'>
            qip1 = field(i,  k,j)<a name='8974'>
            qi   = field(i-1,k,j)<a name='8975'>
            qim1 = field(i-2,k,j)<a name='8976'>
            qim2 = field(i-3,k,j)<a name='8977'>
          ELSE<a name='8978'>
            qip2 = field(i-2,k,j)<a name='8979'>
            qip1 = field(i-1,k,j)<a name='8980'>
            qi   = field(i,  k,j)<a name='8981'>
            qim1 = field(i+1,k,j)<a name='8982'>
            qim2 = field(i+2,k,j)<a name='8983'>
         ENDIF<a name='8984'>
    <a name='8985'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='8986'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='8987'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='8988'>
    <a name='8989'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='8990'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='8991'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='8992'>
    <a name='8993'>
         wi0 = gi0 / (eps1 + beta0)**pw<a name='8994'>
         wi1 = gi1 / (eps1 + beta1)**pw<a name='8995'>
         wi2 = gi2 / (eps1 + beta2)**pw<a name='8996'>
    <a name='8997'>
         sumwk = wi0 + wi1 + wi2<a name='8998'>
    <a name='8999'>
         fqx(i,k,j) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='9000'>
<a name='9001'>
<font color=#447700>!          fqx( i,k,j ) = vel*flux5( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='9002'></font>
<font color=#447700>!                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='9003'></font>
<font color=#447700>!                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='9004'></font>
<font color=#447700>!                                         vel                             )<a name='9005'></font>
          fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9006'>
<a name='9007'>
        ENDDO<a name='9008'>
        ENDDO<a name='9009'>
<a name='9010'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='9011'></font>
<a name='9012'>
        IF( degrade_xs ) THEN<a name='9013'>
<a name='9014'>
          DO i=i_start,i_start_f-1<a name='9015'>
<a name='9016'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='9017'></font>
              DO k=kts,ktf<a name='9018'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='9019'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='9020'>
                vel = ru(i,k,j)/mu<a name='9021'>
                cr = vel*dt/dx<a name='9022'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='9023'>
                fqx(i,k,j) = 0.5*(ru(i,k,j)) &amp;<a name='9024'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='9025'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9026'>
              ENDDO<a name='9027'>
            ENDIF<a name='9028'>
<a name='9029'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='9030'></font>
              DO k=kts,ktf<a name='9031'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='9032'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='9033'>
                vel = ru(i,k,j)<a name='9034'>
                cr = vel*dt/dx/mu<a name='9035'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='9036'>
                fqx( i,k,j ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='9037'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='9038'>
                                          vel                             )<a name='9039'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9040'>
              ENDDO<a name='9041'>
            ENDIF<a name='9042'>
<a name='9043'>
          ENDDO<a name='9044'>
<a name='9045'>
        ENDIF<a name='9046'>
<a name='9047'>
        IF( degrade_xe ) THEN<a name='9048'>
<a name='9049'>
          DO i = i_end_f+1, i_end+1<a name='9050'>
<a name='9051'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='9052'></font>
              DO k=kts,ktf<a name='9053'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='9054'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='9055'>
                vel = ru(i,k,j)<a name='9056'>
                cr = vel*dt/dx/mu<a name='9057'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='9058'>
                fqx(i,k,j) = 0.5*(ru(i,k,j))      &amp;<a name='9059'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='9060'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9061'>
              ENDDO<a name='9062'>
            ENDIF<a name='9063'>
<a name='9064'>
<a name='9065'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='9066'></font>
              DO k=kts,ktf<a name='9067'>
                dx = 2./(msfty(i,j)+msfty(i-1,j))/rdx  <font color=#447700>! ADT eqn 48 d/dx<a name='9068'></font>
                mu = 0.5*(mut(i,j)+mut(i-1,j))<a name='9069'>
                vel = ru(i,k,j)<a name='9070'>
                cr = vel*dt/dx/mu<a name='9071'>
                fqxl(i,k,j) = mu*(dx/dt)*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='9072'>
                fqx( i,k,j ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='9073'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='9074'>
                                          vel                             )<a name='9075'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9076'>
              ENDDO<a name='9077'>
            ENDIF<a name='9078'>
<a name='9079'>
          ENDDO<a name='9080'>
<a name='9081'>
        ENDIF<a name='9082'>
<a name='9083'>
      ENDDO  <font color=#447700>! enddo for outer J loop<a name='9084'></font>
<a name='9085'>
<font color=#447700>!--- end of 5th order horizontal flux calculation<a name='9086'></font>
<a name='9087'>
<font color=#447700>!   ELSE<a name='9088'></font>
<a name='9089'>
<font color=#447700>!      WRITE ( wrf_err_message , * ) 'module_advect: advect_scalar_pd, h_order not known ',horz_order<a name='9090'></font>
<font color=#447700>!      CALL wrf_error_fatal ( TRIM( wrf_err_message ) )<a name='9091'></font>
<a name='9092'>
<font color=#447700>!   ENDIF horizontal_order_test<a name='9093'></font>
<a name='9094'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='9095'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='9096'></font>
<font color=#447700>!  first, set to index ranges<a name='9097'></font>
<a name='9098'>
      i_start = its<a name='9099'>
      i_end   = MIN(ite,ide-1)<a name='9100'>
      j_start = jts<a name='9101'>
      j_end   = MIN(jte,jde-1)<a name='9102'>
<a name='9103'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='9104'></font>
<a name='9105'>
   IF( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='9106'>
<a name='9107'>
       DO j = j_start, j_end<a name='9108'>
       DO k = kts, ktf<a name='9109'>
         ub = MIN( 0.5*(ru(its,k,j)+ru(its+1,k,j)), 0. )<a name='9110'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='9111'>
               - rdx*(                                             &amp;<a name='9112'>
                       ub*(   field_old(its+1,k,j)                 &amp;<a name='9113'>
                            - field_old(its  ,k,j)   ) +           &amp;<a name='9114'>
                       field(its,k,j)*(ru(its+1,k,j)-ru(its,k,j))  &amp;<a name='9115'>
                                                                )<a name='9116'>
       ENDDO<a name='9117'>
       ENDDO<a name='9118'>
<a name='9119'>
   ENDIF<a name='9120'>
<a name='9121'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='9122'>
<a name='9123'>
       DO j = j_start, j_end<a name='9124'>
       DO k = kts, ktf<a name='9125'>
         ub = MAX( 0.5*(ru(ite-1,k,j)+ru(ite,k,j)), 0. )<a name='9126'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                   &amp;<a name='9127'>
               - rdx*(                                               &amp;<a name='9128'>
                       ub*(  field_old(i_end  ,k,j)                  &amp;<a name='9129'>
                           - field_old(i_end-1,k,j) ) +              &amp;<a name='9130'>
                       field(i_end,k,j)*(ru(ite,k,j)-ru(ite-1,k,j))  &amp;<a name='9131'>
                                                                    )<a name='9132'>
       ENDDO<a name='9133'>
       ENDDO<a name='9134'>
<a name='9135'>
   ENDIF<a name='9136'>
<a name='9137'>
   IF( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='9138'>
<a name='9139'>
       DO i = i_start, i_end<a name='9140'>
       DO k = kts, ktf<a name='9141'>
         vb = MIN( 0.5*(rv(i,k,jts)+rv(i,k,jts+1)), 0. )<a name='9142'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='9143'>
               - rdy*(                                             &amp;<a name='9144'>
                       vb*(  field_old(i,k,jts+1)                  &amp;<a name='9145'>
                           - field_old(i,k,jts  ) ) +              &amp;<a name='9146'>
                       field(i,k,jts)*(rv(i,k,jts+1)-rv(i,k,jts))  &amp;<a name='9147'>
                                                                )<a name='9148'>
       ENDDO<a name='9149'>
       ENDDO<a name='9150'>
<a name='9151'>
   ENDIF<a name='9152'>
<a name='9153'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='9154'>
<a name='9155'>
       DO i = i_start, i_end<a name='9156'>
       DO k = kts, ktf<a name='9157'>
         vb = MAX( 0.5*(rv(i,k,jte-1)+rv(i,k,jte)), 0. )<a name='9158'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                   &amp;<a name='9159'>
               - rdy*(                                               &amp;<a name='9160'>
                       vb*(   field_old(i,k,j_end  )                 &amp;<a name='9161'>
                            - field_old(i,k,j_end-1) ) +             &amp;<a name='9162'>
                       field(i,k,j_end)*(rv(i,k,jte)-rv(i,k,jte-1))  &amp;<a name='9163'>
                                                                    )<a name='9164'>
       ENDDO<a name='9165'>
       ENDDO<a name='9166'>
<a name='9167'>
   ENDIF<a name='9168'>
<a name='9169'>
   IF( (config_flags%polar) .and. (jts == jds) ) THEN<a name='9170'>
<a name='9171'>
       <font color=#447700>! Assuming rv(i,k,jds) = 0.<a name='9172'></font>
       DO i = i_start, i_end<a name='9173'>
       DO k = kts, ktf<a name='9174'>
         vb = MIN( 0.5*rv(i,k,jts+1), 0. )<a name='9175'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='9176'>
               - rdy*(                                             &amp;<a name='9177'>
                       vb*(  field_old(i,k,jts+1)                  &amp;<a name='9178'>
                           - field_old(i,k,jts  ) ) +              &amp;<a name='9179'>
                       field(i,k,jts)*rv(i,k,jts+1)                &amp;<a name='9180'>
                                                                )<a name='9181'>
       ENDDO<a name='9182'>
       ENDDO<a name='9183'>
<a name='9184'>
   ENDIF<a name='9185'>
<a name='9186'>
   IF( (config_flags%polar) .and. (jte == jde)) THEN<a name='9187'>
<a name='9188'>
       <font color=#447700>! Assuming rv(i,k,jde) = 0.<a name='9189'></font>
       DO i = i_start, i_end<a name='9190'>
       DO k = kts, ktf<a name='9191'>
         vb = MAX( 0.5*rv(i,k,jte-1), 0. )<a name='9192'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                   &amp;<a name='9193'>
               - rdy*(                                               &amp;<a name='9194'>
                       vb*(   field_old(i,k,j_end  )                 &amp;<a name='9195'>
                            - field_old(i,k,j_end-1) ) +             &amp;<a name='9196'>
                       field(i,k,j_end)*(-rv(i,k,jte-1))             &amp;<a name='9197'>
                                                                    )<a name='9198'>
       ENDDO<a name='9199'>
       ENDDO<a name='9200'>
<a name='9201'>
   ENDIF<a name='9202'>
<a name='9203'>
<font color=#447700>!-------------------- vertical advection<a name='9204'></font>
<a name='9205'>
<font color=#447700>!-- loop bounds for periodic or sym conditions<a name='9206'></font>
<a name='9207'>
      i_start = its-1<a name='9208'>
      i_end   = MIN(ite,ide-1)+1<a name='9209'>
      j_start = jts-1<a name='9210'>
      j_end   = MIN(jte,jde-1)+1<a name='9211'>
<a name='9212'>
<font color=#447700>!-- loop bounds for open or specified conditions<a name='9213'></font>
<a name='9214'>
    IF(degrade_xs) i_start = MAX(its-1,ids)<a name='9215'>
    IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='9216'>
    IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='9217'>
    IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='9218'>
<a name='9219'>
<font color=#447700>!    vert_order_test : IF (vert_order == 6) THEN    <a name='9220'></font>
<a name='9221'>
<a name='9222'>
<font color=#447700>!    ELSE IF (vert_order == 5) THEN    <a name='9223'></font>
<a name='9224'>
      DO j = j_start, j_end<a name='9225'>
<a name='9226'>
         DO i = i_start, i_end<a name='9227'>
           fqz(i,1,j)  = 0.<a name='9228'>
           fqzl(i,1,j) = 0.<a name='9229'>
           fqz(i,kde,j)  = 0.<a name='9230'>
           fqzl(i,kde,j) = 0.<a name='9231'>
         ENDDO<a name='9232'>
<a name='9233'>
         DO k=kts+3,ktf-2<a name='9234'>
         DO i = i_start, i_end<a name='9235'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='9236'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='9237'>
           vel = rom(i,k,j)<a name='9238'>
           cr = vel*dt/dz/mu<a name='9239'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='9240'>
<a name='9241'>
<a name='9242'>
         IF( -vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='9243'>
            qip2 = field(i,k+1,j)<a name='9244'>
            qip1 = field(i,k  ,j)<a name='9245'>
            qi   = field(i,k-1,j)<a name='9246'>
            qim1 = field(i,k-2,j)<a name='9247'>
            qim2 = field(i,k-3,j)<a name='9248'>
          ELSE<a name='9249'>
            qip2 = field(i,k-2,j)<a name='9250'>
            qip1 = field(i,k-1,j)<a name='9251'>
            qi   = field(i,k  ,j)<a name='9252'>
            qim1 = field(i,k+1,j)<a name='9253'>
            qim2 = field(i,k+2,j)<a name='9254'>
         ENDIF<a name='9255'>
    <a name='9256'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='9257'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='9258'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='9259'>
    <a name='9260'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='9261'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='9262'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='9263'>
    <a name='9264'>
         wi0 = gi0 / (eps1 + beta0)**pw<a name='9265'>
         wi1 = gi1 / (eps1 + beta1)**pw<a name='9266'>
         wi2 = gi2 / (eps1 + beta2)**pw<a name='9267'>
    <a name='9268'>
         sumwk = wi0 + wi1 + wi2<a name='9269'>
    <a name='9270'>
          fqz(i,k,j) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='9271'>
<a name='9272'>
<font color=#447700>!           fqz(i,k,j) = vel*flux5( field(i,k-3,j), field(i,k-2,j), field(i,k-1,j),      &amp;<a name='9273'></font>
<font color=#447700>!                                   field(i,k  ,j), field(i,k+1,j), field(i,k+2,j),  -vel )<a name='9274'></font>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='9275'>
         ENDDO<a name='9276'>
         ENDDO<a name='9277'>
<a name='9278'>
         DO i = i_start, i_end<a name='9279'>
<a name='9280'>
           k=kts+1<a name='9281'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='9282'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='9283'>
           vel = rom(i,k,j)<a name='9284'>
           cr = vel*dt/dz/mu<a name='9285'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='9286'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='9287'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='9288'>
<a name='9289'>
           k=kts+2<a name='9290'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='9291'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='9292'>
           vel = rom(i,k,j)<a name='9293'>
           cr = vel*dt/dz/mu<a name='9294'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='9295'>
<a name='9296'>
           fqz(i,k,j) = vel*flux3(                      &amp;<a name='9297'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='9298'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='9299'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='9300'>
<a name='9301'>
           k=ktf-1<a name='9302'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='9303'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='9304'>
           vel = rom(i,k,j)<a name='9305'>
           cr = vel*dt/dz/mu<a name='9306'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='9307'>
<a name='9308'>
           fqz(i,k,j) = vel*flux3(                      &amp;<a name='9309'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='9310'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='9311'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='9312'>
<a name='9313'>
           k=ktf<a name='9314'>
           dz = 2./(rdzw(k)+rdzw(k-1))<a name='9315'>
           mu = 0.5*(mut(i,j)+mut(i,j))<a name='9316'>
           vel = rom(i,k,j)<a name='9317'>
           cr = vel*dt/dz/mu<a name='9318'>
           fqzl(i,k,j) = mu*(dz/dt)*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='9319'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='9320'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='9321'>
<a name='9322'>
         ENDDO<a name='9323'>
<a name='9324'>
      ENDDO<a name='9325'>
<a name='9326'>
<a name='9327'>
<font color=#447700>!   ELSE<a name='9328'></font>
<a name='9329'>
<font color=#447700>!      WRITE (wrf_err_message,*) ' advect_scalar_pd, v_order not known ',vert_order<a name='9330'></font>
<font color=#447700>!      CALL wrf_error_fatal ( wrf_err_message )<a name='9331'></font>
<a name='9332'>
<font color=#447700>!   ENDIF vert_order_test<a name='9333'></font>
<a name='9334'>
   IF (pd_limit) THEN<a name='9335'>
<a name='9336'>
<font color=#447700>! positive definite filter<a name='9337'></font>
<a name='9338'>
   i_start = its-1<a name='9339'>
   i_end   = MIN(ite,ide-1)+1<a name='9340'>
   j_start = jts-1<a name='9341'>
   j_end   = MIN(jte,jde-1)+1<a name='9342'>
<a name='9343'>
<font color=#447700>!-- loop bounds for open or specified conditions<a name='9344'></font>
<a name='9345'>
   IF(degrade_xs) i_start = MAX(its-1,ids)<a name='9346'>
   IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='9347'>
   IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='9348'>
   IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='9349'>
<a name='9350'>
   IF(config_flags%specified .or. config_flags%nested) THEN<a name='9351'>
     IF (degrade_xs) i_start = MAX(its-1,ids+1)<a name='9352'>
     IF (degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='9353'>
     IF (degrade_ys) j_start = MAX(jts-1,jds+1)<a name='9354'>
     IF (degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='9355'>
   END IF<a name='9356'>
<a name='9357'>
   IF(config_flags%open_xs) THEN<a name='9358'>
     IF (degrade_xs) i_start = MAX(its-1,ids+1)<a name='9359'>
   END IF<a name='9360'>
   IF(config_flags%open_xe) THEN<a name='9361'>
     IF (degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='9362'>
   END IF<a name='9363'>
   IF(config_flags%open_ys) THEN<a name='9364'>
     IF (degrade_ys) j_start = MAX(jts-1,jds+1)<a name='9365'>
   END IF<a name='9366'>
   IF(config_flags%open_ye) THEN<a name='9367'>
     IF (degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='9368'>
   END IF<a name='9369'>
   <font color=#447700>! ADT note:<a name='9370'></font>
   <font color=#447700>! We don't want to change j_start and j_end<a name='9371'></font>
   <font color=#447700>! for polar BC's since we want to calculate<a name='9372'></font>
   <font color=#447700>! fluxes for directions other than y at the<a name='9373'></font>
   <font color=#447700>! edge<a name='9374'></font>
<a name='9375'>
<font color=#447700>!-- here is the limiter...<a name='9376'></font>
<a name='9377'>
   DO j=j_start, j_end<a name='9378'>
   DO k=kts, ktf<a name='9379'>
#ifdef XEON_SIMD<a name='9380'>
<font color=#447700>!DIR$ simd<a name='9381'></font>
#else<a name='9382'>
<font color=#447700>!DIR$ vector always<a name='9383'></font>
#endif<a name='9384'>
   DO i=i_start, i_end<a name='9385'>
<a name='9386'>
     ph_low(i,k,j) = (mub(i,j)+mu_old(i,j))*field_old(i,k,j)        &amp;<a name='9387'>
                - dt*( msftx(i,j)*msfty(i,j)*(               &amp;<a name='9388'>
                       rdx*(fqxl(i+1,k,j)-fqxl(i,k,j)) +     &amp;<a name='9389'>
                       rdy*(fqyl(i,k,j+1)-fqyl(i,k,j))  )    &amp;<a name='9390'>
                      +msfty(i,j)*rdzw(k)*(fqzl(i,k+1,j)-fqzl(i,k,j)) )<a name='9391'>
<a name='9392'>
   ENDDO<a name='9393'>
   ENDDO<a name='9394'>
   ENDDO<a name='9395'>
<a name='9396'>
   DO j=j_start, j_end<a name='9397'>
   DO k=kts, ktf<a name='9398'>
<font color=#447700>!DIR$ vector always<a name='9399'></font>
   DO i=i_start, i_end<a name='9400'>
<a name='9401'>
     flux_out(i,k,j) = dt*( (msftx(i,j)*msfty(i,j))*(                    &amp;<a name='9402'>
                                rdx*(  max(0.,fqx (i+1,k,j))      &amp;<a name='9403'>
                                      -min(0.,fqx (i  ,k,j)) )    &amp;<a name='9404'>
                               +rdy*(  max(0.,fqy (i,k,j+1))      &amp;<a name='9405'>
                                      -min(0.,fqy (i,k,j  )) ) )  &amp;<a name='9406'>
                +msfty(i,j)*rdzw(k)*(  min(0.,fqz (i,k+1,j))      &amp;<a name='9407'>
                                      -max(0.,fqz (i,k  ,j)) )   )<a name='9408'>
<a name='9409'>
   ENDDO<a name='9410'>
   ENDDO<a name='9411'>
   ENDDO<a name='9412'>
<a name='9413'>
   DO j=j_start, j_end<a name='9414'>
   DO k=kts, ktf<a name='9415'>
<font color=#447700>!DIR$ vector always<a name='9416'></font>
   DO i=i_start, i_end<a name='9417'>
<a name='9418'>
     IF( flux_out(i,k,j) .gt. ph_low(i,k,j) ) THEN<a name='9419'>
<a name='9420'>
       scale = max(0.,ph_low(i,k,j)/(flux_out(i,k,j)+eps))<a name='9421'>
       IF( fqx (i+1,k,j) .gt. 0.) fqx(i+1,k,j) = scale*fqx(i+1,k,j)<a name='9422'>
       IF( fqx (i  ,k,j) .lt. 0.) fqx(i  ,k,j) = scale*fqx(i  ,k,j)<a name='9423'>
       IF( fqy (i,k,j+1) .gt. 0.) fqy(i,k,j+1) = scale*fqy(i,k,j+1)<a name='9424'>
       IF( fqy (i,k,j  ) .lt. 0.) fqy(i,k,j  ) = scale*fqy(i,k,j  )<a name='9425'>
<font color=#447700>!  note: z flux is opposite sign in mass coordinate because <a name='9426'></font>
<font color=#447700>!  vertical coordinate decreases with increasing k<a name='9427'></font>
       IF( fqz (i,k+1,j) .lt. 0.) fqz(i,k+1,j) = scale*fqz(i,k+1,j)<a name='9428'>
       IF( fqz (i,k  ,j) .gt. 0.) fqz(i,k  ,j) = scale*fqz(i,k  ,j)<a name='9429'>
<a name='9430'>
     END IF<a name='9431'>
<a name='9432'>
   ENDDO<a name='9433'>
   ENDDO<a name='9434'>
   ENDDO<a name='9435'>
<a name='9436'>
   END IF<a name='9437'>
<a name='9438'>
<font color=#447700>! add in the pd-limited flux divergence<a name='9439'></font>
<a name='9440'>
  i_start = its<a name='9441'>
  i_end   = MIN(ite,ide-1)<a name='9442'>
  j_start = jts<a name='9443'>
  j_end   = MIN(jte,jde-1)<a name='9444'>
<a name='9445'>
  DO j = j_start, j_end<a name='9446'>
  DO k = kts, ktf<a name='9447'>
  DO i = i_start, i_end<a name='9448'>
<a name='9449'>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='9450'>
                            -rdzw(k)*( fqz (i,k+1,j)-fqz (i,k,j)  &amp;<a name='9451'>
                                      +fqzl(i,k+1,j)-fqzl(i,k,j))<a name='9452'>
<a name='9453'>
  ENDDO<a name='9454'>
  ENDDO<a name='9455'>
  ENDDO<a name='9456'>
<a name='9457'>
<font color=#447700>! x flux divergence<a name='9458'></font>
<font color=#447700>!<a name='9459'></font>
  IF(degrade_xs) i_start = MAX(its,ids+1)<a name='9460'>
  IF(degrade_xe) i_end   = MIN(ite,ide-2)<a name='9461'>
<a name='9462'>
  DO j = j_start, j_end<a name='9463'>
  DO k = kts, ktf<a name='9464'>
  DO i = i_start, i_end<a name='9465'>
<a name='9466'>
     <font color=#447700>! Un-"canceled" map scale factor, ADT Eq. 48<a name='9467'></font>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='9468'>
               - msftx(i,j)*( rdx*( fqx (i+1,k,j)-fqx (i,k,j)     &amp;<a name='9469'>
                                   +fqxl(i+1,k,j)-fqxl(i,k,j))   )<a name='9470'>
<a name='9471'>
  ENDDO<a name='9472'>
  ENDDO<a name='9473'>
  ENDDO<a name='9474'>
<a name='9475'>
<font color=#447700>! y flux divergence<a name='9476'></font>
<font color=#447700>!<a name='9477'></font>
  i_start = its<a name='9478'>
  i_end   = MIN(ite,ide-1)<a name='9479'>
  IF(degrade_ys) j_start = MAX(jts,jds+1)<a name='9480'>
  IF(degrade_ye) j_end   = MIN(jte,jde-2)<a name='9481'>
<a name='9482'>
  DO j = j_start, j_end<a name='9483'>
  DO k = kts, ktf<a name='9484'>
  DO i = i_start, i_end<a name='9485'>
<a name='9486'>
     <font color=#447700>! Un-"canceled" map scale factor, ADT Eq. 48<a name='9487'></font>
     <font color=#447700>! It is correct to use msftx (and not msfty), per W. Skamarock, 20080606<a name='9488'></font>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='9489'>
               - msftx(i,j)*( rdy*( fqy (i,k,j+1)-fqy (i,k,j)     &amp;<a name='9490'>
                                   +fqyl(i,k,j+1)-fqyl(i,k,j))   )<a name='9491'>
<a name='9492'>
  ENDDO<a name='9493'>
  ENDDO<a name='9494'>
  ENDDO<a name='9495'>
<a name='9496'>
END SUBROUTINE advect_scalar_wenopd<a name='9497'>
<a name='9498'>
<font color=#447700>!----------------------------------------------------------------<a name='9499'></font>
<a name='9500'>
<A NAME='ADVECT_SCALAR_MONO'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_MONO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='9501'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_scalar_mono</font>   ( field, field_old, tendency,    &amp; <A href='../../call_to/ADVECT_SCALAR_MONO.html' TARGET='index'>2</A>,<A href='../../call_from/ADVECT_SCALAR_MONO.html' TARGET='index'>2</A><a name='9502'>
                                  h_tendency, z_tendency,        &amp; <a name='9503'>
                                  ru, rv, rom,                   &amp;<a name='9504'>
                                  c1, c2,                        &amp;<a name='9505'>
                                  mut, mub, mu_old,              &amp;<a name='9506'>
                                  config_flags,                  &amp;<a name='9507'>
                                  tenddec,                       &amp; <a name='9508'>
                                  msfux, msfuy, msfvx, msfvy,    &amp;<a name='9509'>
                                  msftx, msfty,                  &amp;<a name='9510'>
                                  fzm, fzp,                      &amp;<a name='9511'>
                                  rdx, rdy, rdzw, dt,            &amp;<a name='9512'>
                                  ids, ide, jds, jde, kds, kde,  &amp;<a name='9513'>
                                  ims, ime, jms, jme, kms, kme,  &amp;<a name='9514'>
                                  its, ite, jts, jte, kts, kte  )<a name='9515'>
<a name='9516'>
<font color=#447700>!  monotonic advection option<a name='9517'></font>
<font color=#447700>!  for scalars in WRF RK3 advection.  This version is memory intensive -&gt;<a name='9518'></font>
<font color=#447700>!  we save 3d arrays of x, y and z both high and low order fluxes<a name='9519'></font>
<font color=#447700>!  (six in all).  Alternatively, we could sweep in a direction <a name='9520'></font>
<font color=#447700>!  and lower the cost considerably.<a name='9521'></font>
<a name='9522'>
<font color=#447700>!  uses the Smolarkiewicz MWR 1989 approach, with addition of first-order<a name='9523'></font>
<font color=#447700>!  fluxes initially<a name='9524'></font>
<a name='9525'>
   IMPLICIT NONE<a name='9526'>
   <a name='9527'>
   <font color=#447700>! Input data<a name='9528'></font>
   <a name='9529'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='9530'>
<a name='9531'>
   LOGICAL ,                 INTENT(IN   ) :: tenddec <font color=#447700>! tendency flag<a name='9532'></font>
<a name='9533'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='9534'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='9535'>
                                              its, ite, jts, jte, kts, kte<a name='9536'>
<a name='9537'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: field,     &amp;<a name='9538'>
                                                                      field_old, &amp;<a name='9539'>
                                                                      ru,    &amp;<a name='9540'>
                                                                      rv,    &amp;<a name='9541'>
                                                                      rom<a name='9542'>
<a name='9543'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut, mub, mu_old<a name='9544'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='9545'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(  OUT) :: h_tendency, z_tendency <a name='9546'>
<a name='9547'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='9548'>
                                                                    msfuy,  &amp;<a name='9549'>
                                                                    msfvx,  &amp;<a name='9550'>
                                                                    msfvy,  &amp;<a name='9551'>
                                                                    msftx,  &amp;<a name='9552'>
                                                                    msfty<a name='9553'>
<a name='9554'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='9555'>
                                                                  fzp,  &amp;<a name='9556'>
                                                                  rdzw, &amp;<a name='9557'>
                                                                  c1,   &amp;<a name='9558'>
                                                                  c2<a name='9559'>
<a name='9560'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='9561'>
                                                                  rdy,  &amp;<a name='9562'>
                                                                  dt<a name='9563'>
<a name='9564'>
   <font color=#447700>! Local data<a name='9565'></font>
   <a name='9566'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='9567'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='9568'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='9569'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='9570'>
<a name='9571'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, mu<a name='9572'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='9573'>
<a name='9574'>
<a name='9575'>
<font color=#447700>!  storage for high and low order fluxes<a name='9576'></font>
<a name='9577'>
   REAL,  DIMENSION( its-2:ite+2, kts:kte, jts-2:jte+2  ) :: fqx, fqy, fqz<a name='9578'>
   REAL,  DIMENSION( its-2:ite+2, kts:kte, jts-2:jte+2  ) :: fqxl, fqyl, fqzl<a name='9579'>
   REAL,  DIMENSION( its-2:ite+2, kts:kte, jts-2:jte+2  ) :: qmin, qmax<a name='9580'>
   REAL,  DIMENSION( its-2:ite+2, kts:kte, jts-2:jte+2  ) :: scale_in, scale_out<a name='9581'>
   REAL :: ph_upwind<a name='9582'>
<a name='9583'>
   INTEGER :: horz_order, vert_order<a name='9584'>
   <a name='9585'>
   LOGICAL :: degrade_xs, degrade_ys<a name='9586'>
   LOGICAL :: degrade_xe, degrade_ye<a name='9587'>
<a name='9588'>
   INTEGER :: jp1, jp0, jtmp<a name='9589'>
<a name='9590'>
   REAL :: flux_out, ph_low, flux_in, ph_hi, scale<a name='9591'>
   REAL, PARAMETER :: eps=1.e-20<a name='9592'>
<a name='9593'>
<a name='9594'>
<font color=#447700>! definition of flux operators, 3rd, 4rth, 5th or 6th order<a name='9595'></font>
<a name='9596'>
   REAL    :: flux3, flux4, flux5, flux6, flux_upwind<a name='9597'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel, cr<a name='9598'>
<a name='9599'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='9600'>
            (7./12.)*(q_i + q_im1) - (1./12.)*(q_ip1 + q_im2)<a name='9601'>
<a name='9602'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='9603'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='9604'>
           sign(1.,ua)*(1./12.)*((q_ip1 - q_im2)-3.*(q_i-q_im1))<a name='9605'>
<a name='9606'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='9607'>
            (37./60.)*(q_i+q_im1) - (2./15.)*(q_ip1+q_im2)      &amp;<a name='9608'>
            +(1./60.)*(q_ip2+q_im3)<a name='9609'>
<a name='9610'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='9611'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='9612'>
            -sign(1.,ua)*(1./60.)*(                             &amp;<a name='9613'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )<a name='9614'>
<a name='9615'>
<font color=#447700>!      flux_upwind(q_im1, q_i, cr ) = 0.<a name='9616'></font>
      flux_upwind(q_im1, q_i, cr ) = 0.5*(1.+sign(1.,cr))*q_im1 &amp;<a name='9617'>
                                    +0.5*(1.-sign(1.,cr))*q_i<a name='9618'>
<a name='9619'>
    LOGICAL, PARAMETER :: mono_limit = .true.<a name='9620'>
<a name='9621'>
<font color=#447700>! set order for the advection schemes<a name='9622'></font>
<a name='9623'>
  ktf=MIN(kte,kde-1)<a name='9624'>
  horz_order = config_flags%h_sca_adv_order<a name='9625'>
  vert_order = config_flags%v_sca_adv_order<a name='9626'>
<a name='9627'>
  do j=jts-2,jte+2<a name='9628'>
  do k=kts,kte<a name='9629'>
  do i=its-2,ite+2<a name='9630'>
    qmin(i,k,j) = field_old(i,k,j)<a name='9631'>
    qmax(i,k,j) = field_old(i,k,j)<a name='9632'>
    scale_in(i,k,j) = 1.<a name='9633'>
    scale_out(i,k,j) = 1.<a name='9634'>
    fqx(i,k,j) = 0.<a name='9635'>
    fqy(i,k,j) = 0.<a name='9636'>
    fqz(i,k,j) = 0.<a name='9637'>
    fqxl(i,k,j) = 0.<a name='9638'>
    fqyl(i,k,j) = 0.<a name='9639'>
    fqzl(i,k,j) = 0.<a name='9640'>
  enddo<a name='9641'>
  enddo<a name='9642'>
  enddo<a name='9643'>
<a name='9644'>
<font color=#447700>!  begin with horizontal flux divergence<a name='9645'></font>
<font color=#447700>!  here is the choice of flux operators<a name='9646'></font>
<a name='9647'>
<a name='9648'>
  horizontal_order_test : IF( horz_order == 5 ) THEN<a name='9649'>
<a name='9650'>
<font color=#447700>!  determine boundary mods for flux operators<a name='9651'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4rth order<a name='9652'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='9653'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='9654'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='9655'></font>
<font color=#447700>!   of the higher order flux stencils<a name='9656'></font>
<a name='9657'>
   degrade_xs = .true.<a name='9658'>
   degrade_xe = .true.<a name='9659'>
   degrade_ys = .true.<a name='9660'>
   degrade_ye = .true.<a name='9661'>
<a name='9662'>
   IF( config_flags%periodic_x   .or. &amp;<a name='9663'>
       config_flags%symmetric_xs .or. &amp;<a name='9664'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='9665'>
   IF( config_flags%periodic_x   .or. &amp;<a name='9666'>
       config_flags%symmetric_xe .or. &amp;<a name='9667'>
       (ite &lt; ide-4)                ) degrade_xe = .false.<a name='9668'>
   IF( config_flags%periodic_y   .or. &amp;<a name='9669'>
       config_flags%symmetric_ys .or. &amp;<a name='9670'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='9671'>
   IF( config_flags%periodic_y   .or. &amp;<a name='9672'>
       config_flags%symmetric_ye .or. &amp;<a name='9673'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='9674'>
<a name='9675'>
<font color=#447700>!--------------- y - advection first<a name='9676'></font>
<a name='9677'>
<font color=#447700>!--  y flux compute; these bounds are for periodic and sym b.c.<a name='9678'></font>
<a name='9679'>
      ktf=MIN(kte,kde-1)<a name='9680'>
      i_start = its-1<a name='9681'>
      i_end   = MIN(ite,ide-1)+1<a name='9682'>
      j_start = jts-1<a name='9683'>
      j_end   = MIN(jte,jde-1)+1<a name='9684'>
      j_start_f = j_start<a name='9685'>
      j_end_f   = j_end+1<a name='9686'>
<a name='9687'>
<font color=#447700>!--  modify loop bounds if open or specified<a name='9688'></font>
<a name='9689'>
<font color=#447700>!  WCS 20090218<a name='9690'></font>
<font color=#447700>!      IF(degrade_xs) i_start = its<a name='9691'></font>
<font color=#447700>!      IF(degrade_xe) i_end   = MIN(ite,ide-1)<a name='9692'></font>
      IF(degrade_xs) i_start = MAX(its-1,ids)<a name='9693'>
      IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='9694'>
<a name='9695'>
<font color=#447700>!  WCS 20090218<a name='9696'></font>
<font color=#447700>!      IF(degrade_ys) then<a name='9697'></font>
<font color=#447700>!        j_start = MAX(jts,jds+1)<a name='9698'></font>
<font color=#447700>!        j_start_f = jds+3<a name='9699'></font>
<font color=#447700>!      ENDIF<a name='9700'></font>
<font color=#447700>!<a name='9701'></font>
<font color=#447700>!      IF(degrade_ye) then<a name='9702'></font>
<font color=#447700>!        j_end = MIN(jte,jde-2)<a name='9703'></font>
<font color=#447700>!        j_end_f = jde-3<a name='9704'></font>
<font color=#447700>!      ENDIF<a name='9705'></font>
<a name='9706'>
      IF(degrade_ys) then<a name='9707'>
        j_start = MAX(jts-1,jds+1)<a name='9708'>
        j_start_f = jds+3<a name='9709'>
      ENDIF<a name='9710'>
<a name='9711'>
      IF(degrade_ye) then<a name='9712'>
        j_end = MIN(jte+1,jde-2)<a name='9713'>
        j_end_f = jde-3<a name='9714'>
      ENDIF<a name='9715'>
<a name='9716'>
<font color=#447700>!  compute fluxes, 5th order<a name='9717'></font>
<a name='9718'>
      j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='9719'>
<a name='9720'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN <font color=#447700>! use full stencil<a name='9721'></font>
<a name='9722'>
        DO k=kts,ktf<a name='9723'>
        DO i = i_start, i_end<a name='9724'>
<a name='9725'>
          vel = rv(i,k,j)<a name='9726'>
          cr = vel<a name='9727'>
          fqyl(i,k,j) = vel*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), vel)<a name='9728'>
<a name='9729'>
          fqy( i, k, j  ) = vel*flux5(                                  &amp;<a name='9730'>
                  field(i,k,j-3), field(i,k,j-2), field(i,k,j-1),       &amp;<a name='9731'>
                  field(i,k,j  ), field(i,k,j+1), field(i,k,j+2),  vel )<a name='9732'>
<a name='9733'>
          fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='9734'>
<a name='9735'>
          if(cr.gt. 0) then<a name='9736'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i,k,j-1))<a name='9737'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i,k,j-1))<a name='9738'>
          else<a name='9739'>
             qmax(i,k,j-1)  = amax1(qmax(i,k,j-1),field_old(i,k,j))<a name='9740'>
             qmin(i,k,j-1)  = amin1(qmin(i,k,j-1),field_old(i,k,j))<a name='9741'>
          end if<a name='9742'>
<a name='9743'>
        ENDDO<a name='9744'>
        ENDDO<a name='9745'>
<a name='9746'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='9747'></font>
<a name='9748'>
            DO k=kts,ktf<a name='9749'>
            DO i = i_start, i_end<a name='9750'>
<a name='9751'>
              vel = rv(i,k,j)<a name='9752'>
              cr = vel<a name='9753'>
              fqyl(i,k,j) = vel*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='9754'>
<a name='9755'>
              fqy(i,k, j) = 0.5*rv(i,k,j)*          &amp;<a name='9756'>
                     (field(i,k,j)+field(i,k,j-1))<a name='9757'>
<a name='9758'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='9759'>
<a name='9760'>
          if(cr.gt. 0) then<a name='9761'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i,k,j-1))<a name='9762'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i,k,j-1))<a name='9763'>
          else<a name='9764'>
             qmax(i,k,j-1)  = amax1(qmax(i,k,j-1),field_old(i,k,j))<a name='9765'>
             qmin(i,k,j-1)  = amin1(qmin(i,k,j-1),field_old(i,k,j))<a name='9766'>
          end if<a name='9767'>
<a name='9768'>
            ENDDO<a name='9769'>
            ENDDO<a name='9770'>
<a name='9771'>
      ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4rth order flux 2 in from south boundary<a name='9772'></font>
<a name='9773'>
            DO k=kts,ktf<a name='9774'>
            DO i = i_start, i_end<a name='9775'>
<a name='9776'>
              vel = rv(i,k,j)<a name='9777'>
              cr = vel<a name='9778'>
              fqyl(i,k,j) = vel*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='9779'>
<a name='9780'>
              fqy( i, k, j ) = vel*flux3(              &amp;<a name='9781'>
                   field(i,k,j-2),field(i,k,j-1),field(i,k,j),field(i,k,j+1),vel )<a name='9782'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='9783'>
<a name='9784'>
          if(cr.gt. 0) then<a name='9785'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i,k,j-1))<a name='9786'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i,k,j-1))<a name='9787'>
          else<a name='9788'>
             qmax(i,k,j-1)  = amax1(qmax(i,k,j-1),field_old(i,k,j))<a name='9789'>
             qmin(i,k,j-1)  = amin1(qmin(i,k,j-1),field_old(i,k,j))<a name='9790'>
          end if<a name='9791'>
<a name='9792'>
            ENDDO<a name='9793'>
            ENDDO<a name='9794'>
<a name='9795'>
      ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='9796'></font>
<a name='9797'>
            DO k=kts,ktf<a name='9798'>
            DO i = i_start, i_end<a name='9799'>
<a name='9800'>
              vel = rv(i,k,j)<a name='9801'>
              cr = vel<a name='9802'>
              fqyl(i,k,j) = vel*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='9803'>
<a name='9804'>
              fqy(i, k, j ) = 0.5*rv(i,k,j)*      &amp;<a name='9805'>
                     (field(i,k,j)+field(i,k,j-1))<a name='9806'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='9807'>
<a name='9808'>
          if(cr.gt. 0) then<a name='9809'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i,k,j-1))<a name='9810'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i,k,j-1))<a name='9811'>
          else<a name='9812'>
             qmax(i,k,j-1)  = amax1(qmax(i,k,j-1),field_old(i,k,j))<a name='9813'>
             qmin(i,k,j-1)  = amin1(qmin(i,k,j-1),field_old(i,k,j))<a name='9814'>
          end if<a name='9815'>
<a name='9816'>
            ENDDO<a name='9817'>
            ENDDO<a name='9818'>
<a name='9819'>
      ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4rth order flux 2 in from north boundary<a name='9820'></font>
<a name='9821'>
            DO k=kts,ktf<a name='9822'>
            DO i = i_start, i_end<a name='9823'>
<a name='9824'>
              vel = rv(i,k,j)<a name='9825'>
              cr = vel<a name='9826'>
              fqyl(i,k,j) = vel*flux_upwind(field_old(i,k,j-1), field_old(i,k,j  ), cr)<a name='9827'>
<a name='9828'>
              fqy( i, k, j) = vel*flux3(             &amp;<a name='9829'>
                   field(i,k,j-2),field(i,k,j-1),    &amp;<a name='9830'>
                   field(i,k,j),field(i,k,j+1),vel )<a name='9831'>
              fqy(i,k,j) = fqy(i,k,j) - fqyl(i,k,j)<a name='9832'>
<a name='9833'>
          if(cr.gt. 0) then<a name='9834'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i,k,j-1))<a name='9835'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i,k,j-1))<a name='9836'>
          else<a name='9837'>
             qmax(i,k,j-1)  = amax1(qmax(i,k,j-1),field_old(i,k,j))<a name='9838'>
             qmin(i,k,j-1)  = amin1(qmin(i,k,j-1),field_old(i,k,j))<a name='9839'>
          end if<a name='9840'>
<a name='9841'>
            ENDDO<a name='9842'>
            ENDDO<a name='9843'>
<a name='9844'>
      ENDIF<a name='9845'>
<a name='9846'>
   ENDDO j_loop_y_flux_5<a name='9847'>
<a name='9848'>
<font color=#447700>!  next, x flux<a name='9849'></font>
<a name='9850'>
<font color=#447700>!--  these bounds are for periodic and sym conditions<a name='9851'></font>
<a name='9852'>
      i_start = its-1<a name='9853'>
      i_end   = MIN(ite,ide-1)+1<a name='9854'>
      i_start_f = i_start<a name='9855'>
      i_end_f   = i_end+1<a name='9856'>
<a name='9857'>
      j_start = jts-1<a name='9858'>
      j_end   = MIN(jte,jde-1)+1<a name='9859'>
<a name='9860'>
<font color=#447700>!--  modify loop bounds for open and specified b.c<a name='9861'></font>
<a name='9862'>
<font color=#447700>!  WCS 20090218<a name='9863'></font>
<font color=#447700>!      IF(degrade_ys) j_start = jts<a name='9864'></font>
<font color=#447700>!      IF(degrade_ye) j_end   = MIN(jte,jde-1)<a name='9865'></font>
      IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='9866'>
      IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='9867'>
<a name='9868'>
<font color=#447700>!  WCS 20090218<a name='9869'></font>
<font color=#447700>!      IF(degrade_xs) then<a name='9870'></font>
<font color=#447700>!        i_start = MAX(ids+1,its)<a name='9871'></font>
<font color=#447700>!        i_start_f = i_start+2<a name='9872'></font>
<font color=#447700>!      ENDIF<a name='9873'></font>
<a name='9874'>
<font color=#447700>!      IF(degrade_xe) then<a name='9875'></font>
<font color=#447700>!        i_end = MIN(ide-2,ite)<a name='9876'></font>
<font color=#447700>!        i_end_f = ide-3<a name='9877'></font>
<font color=#447700>!      ENDIF<a name='9878'></font>
<a name='9879'>
      IF(degrade_xs) then<a name='9880'>
        i_start = MAX(ids+1,its-1)<a name='9881'>
        i_start_f = ids+3<a name='9882'>
      ENDIF<a name='9883'>
<a name='9884'>
      IF(degrade_xe) then<a name='9885'>
        i_end = MIN(ide-2,ite+1)<a name='9886'>
        i_end_f = ide-3<a name='9887'>
      ENDIF<a name='9888'>
<a name='9889'>
<font color=#447700>!  compute fluxes<a name='9890'></font>
<a name='9891'>
      DO j = j_start, j_end<a name='9892'>
<a name='9893'>
<font color=#447700>!  5th or 6th order flux<a name='9894'></font>
<a name='9895'>
        DO k=kts,ktf<a name='9896'>
        DO i = i_start_f, i_end_f<a name='9897'>
<a name='9898'>
          vel = ru(i,k,j)<a name='9899'>
          cr = vel<a name='9900'>
          fqxl(i,k,j) = vel*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='9901'>
<a name='9902'>
          fqx( i,k,j ) = vel*flux5( field(i-3,k,j), field(i-2,k,j),  &amp;<a name='9903'>
                                         field(i-1,k,j), field(i  ,k,j),  &amp;<a name='9904'>
                                         field(i+1,k,j), field(i+2,k,j),  &amp;<a name='9905'>
                                         vel                             )<a name='9906'>
          fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9907'>
<a name='9908'>
          if(cr.gt. 0) then<a name='9909'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i-1,k,j))<a name='9910'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i-1,k,j))<a name='9911'>
          else<a name='9912'>
             qmax(i-1,k,j)  = amax1(qmax(i-1,k,j),field_old(i,k,j))<a name='9913'>
             qmin(i-1,k,j)  = amin1(qmin(i-1,k,j),field_old(i,k,j))<a name='9914'>
          end if<a name='9915'>
<a name='9916'>
        ENDDO<a name='9917'>
        ENDDO<a name='9918'>
<a name='9919'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='9920'></font>
<a name='9921'>
<font color=#447700>!  WCS 20090218 degrade_xs and xe recoded<a name='9922'></font>
<a name='9923'>
        IF( degrade_xs ) THEN<a name='9924'>
<a name='9925'>
          DO i=i_start,i_start_f-1<a name='9926'>
<a name='9927'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='9928'></font>
              DO k=kts,ktf<a name='9929'>
                vel = ru(i,k,j)<a name='9930'>
                cr = vel<a name='9931'>
                fqxl(i,k,j) = vel*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='9932'>
<a name='9933'>
                fqx(i,k,j) = 0.5*(ru(i,k,j)) &amp;<a name='9934'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='9935'>
<a name='9936'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9937'>
<a name='9938'>
                if(cr.gt. 0) then<a name='9939'>
                  qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i-1,k,j))<a name='9940'>
                  qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i-1,k,j))<a name='9941'>
                else<a name='9942'>
                  qmax(i-1,k,j)  = amax1(qmax(i-1,k,j),field_old(i,k,j))<a name='9943'>
                  qmin(i-1,k,j)  = amin1(qmin(i-1,k,j),field_old(i,k,j))<a name='9944'>
                end if<a name='9945'>
              ENDDO<a name='9946'>
            ENDIF<a name='9947'>
<a name='9948'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='9949'></font>
              DO k=kts,ktf<a name='9950'>
                vel = ru(i,k,j)<a name='9951'>
                cr = vel<a name='9952'>
                fqxl(i,k,j) = vel*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='9953'>
                fqx( i,k,j ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='9954'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='9955'>
                                          vel                             )<a name='9956'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9957'>
<a name='9958'>
                if(cr.gt. 0) then<a name='9959'>
                  qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i-1,k,j))<a name='9960'>
                  qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i-1,k,j))<a name='9961'>
                else<a name='9962'>
                  qmax(i-1,k,j)  = amax1(qmax(i-1,k,j),field_old(i,k,j))<a name='9963'>
                  qmin(i-1,k,j)  = amin1(qmin(i-1,k,j),field_old(i,k,j))<a name='9964'>
                end if<a name='9965'>
              ENDDO<a name='9966'>
            ENDIF<a name='9967'>
<a name='9968'>
          ENDDO<a name='9969'>
<a name='9970'>
        ENDIF<a name='9971'>
<a name='9972'>
        IF( degrade_xe ) THEN<a name='9973'>
<a name='9974'>
          DO i = i_end_f+1, i_end+1<a name='9975'>
<a name='9976'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='9977'></font>
              DO k=kts,ktf<a name='9978'>
                vel = ru(i,k,j)<a name='9979'>
                cr = vel<a name='9980'>
                fqxl(i,k,j) = vel*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='9981'>
                fqx(i,k,j) = 0.5*(ru(i,k,j))      &amp;<a name='9982'>
                       *(field(i,k,j)+field(i-1,k,j))<a name='9983'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='9984'>
<a name='9985'>
                if(cr.gt. 0) then<a name='9986'>
                  qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i-1,k,j))<a name='9987'>
                  qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i-1,k,j))<a name='9988'>
                else<a name='9989'>
                  qmax(i-1,k,j)  = amax1(qmax(i-1,k,j),field_old(i,k,j))<a name='9990'>
                  qmin(i-1,k,j)  = amin1(qmin(i-1,k,j),field_old(i,k,j))<a name='9991'>
                end if<a name='9992'>
              ENDDO<a name='9993'>
            ENDIF<a name='9994'>
<a name='9995'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='9996'></font>
              DO k=kts,ktf<a name='9997'>
                vel = ru(i,k,j)<a name='9998'>
                cr = vel<a name='9999'>
                fqxl(i,k,j) = vel*flux_upwind(field_old(i-1,k,j), field_old(i,k,j  ), cr)<a name='10000'>
                fqx( i,k,j ) = vel*flux3( field(i-2,k,j), field(i-1,k,j),  &amp;<a name='10001'>
                                          field(i  ,k,j), field(i+1,k,j),  &amp;<a name='10002'>
                                          vel                             )<a name='10003'>
                fqx(i,k,j) = fqx(i,k,j) - fqxl(i,k,j)<a name='10004'>
<a name='10005'>
                if(cr.gt. 0) then<a name='10006'>
                  qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i-1,k,j))<a name='10007'>
                  qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i-1,k,j))<a name='10008'>
                else<a name='10009'>
                  qmax(i-1,k,j)  = amax1(qmax(i-1,k,j),field_old(i,k,j))<a name='10010'>
                  qmin(i-1,k,j)  = amin1(qmin(i-1,k,j),field_old(i,k,j))<a name='10011'>
                end if<a name='10012'>
              ENDDO<a name='10013'>
            ENDIF<a name='10014'>
          ENDDO<a name='10015'>
        ENDIF<a name='10016'>
<a name='10017'>
      ENDDO  <font color=#447700>! enddo for outer J loop<a name='10018'></font>
<a name='10019'>
   ELSE<a name='10020'>
<a name='10021'>
      WRITE ( wrf_err_message , * ) 'module_advect: advect_scalar_mono, h_order not known ',horz_order<a name='10022'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_MONO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_11"> ( TRIM( wrf_err_message ) )<a name='10023'>
<a name='10024'>
   ENDIF horizontal_order_test<a name='10025'>
<a name='10026'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='10027'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='10028'></font>
<font color=#447700>!  first, set to index ranges<a name='10029'></font>
<a name='10030'>
      i_start = its<a name='10031'>
      i_end   = MIN(ite,ide-1)<a name='10032'>
      j_start = jts<a name='10033'>
      j_end   = MIN(jte,jde-1)<a name='10034'>
<a name='10035'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='10036'></font>
<a name='10037'>
   IF( (config_flags%open_xs) .and. (its == ids) ) THEN<a name='10038'>
<a name='10039'>
       DO j = j_start, j_end<a name='10040'>
       DO k = kts, ktf<a name='10041'>
         ub = MIN( 0.5*(ru(its,k,j)+ru(its+1,k,j)), 0. )<a name='10042'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='10043'>
               - rdx*(                                             &amp;<a name='10044'>
                       ub*(   field_old(its+1,k,j)                 &amp;<a name='10045'>
                            - field_old(its  ,k,j)   ) +           &amp;<a name='10046'>
                       field(its,k,j)*(ru(its+1,k,j)-ru(its,k,j))  &amp;<a name='10047'>
                                                                )<a name='10048'>
       ENDDO<a name='10049'>
       ENDDO<a name='10050'>
<a name='10051'>
   ENDIF<a name='10052'>
<a name='10053'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='10054'>
<a name='10055'>
       DO j = j_start, j_end<a name='10056'>
       DO k = kts, ktf<a name='10057'>
         ub = MAX( 0.5*(ru(ite-1,k,j)+ru(ite,k,j)), 0. )<a name='10058'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                   &amp;<a name='10059'>
               - rdx*(                                               &amp;<a name='10060'>
                       ub*(  field_old(i_end  ,k,j)                  &amp;<a name='10061'>
                           - field_old(i_end-1,k,j) ) +              &amp;<a name='10062'>
                       field(i_end,k,j)*(ru(ite,k,j)-ru(ite-1,k,j))  &amp;<a name='10063'>
                                                                    )<a name='10064'>
       ENDDO<a name='10065'>
       ENDDO<a name='10066'>
<a name='10067'>
   ENDIF<a name='10068'>
<a name='10069'>
   IF( (config_flags%open_ys) .and. (jts == jds) ) THEN<a name='10070'>
<a name='10071'>
       DO i = i_start, i_end<a name='10072'>
       DO k = kts, ktf<a name='10073'>
         vb = MIN( 0.5*(rv(i,k,jts)+rv(i,k,jts+1)), 0. )<a name='10074'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='10075'>
               - rdy*(                                             &amp;<a name='10076'>
                       vb*(  field_old(i,k,jts+1)                  &amp;<a name='10077'>
                           - field_old(i,k,jts  ) ) +              &amp;<a name='10078'>
                       field(i,k,jts)*(rv(i,k,jts+1)-rv(i,k,jts))  &amp;<a name='10079'>
                                                                )<a name='10080'>
       ENDDO<a name='10081'>
       ENDDO<a name='10082'>
<a name='10083'>
   ENDIF<a name='10084'>
<a name='10085'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='10086'>
<a name='10087'>
       DO i = i_start, i_end<a name='10088'>
       DO k = kts, ktf<a name='10089'>
         vb = MAX( 0.5*(rv(i,k,jte-1)+rv(i,k,jte)), 0. )<a name='10090'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                   &amp;<a name='10091'>
               - rdy*(                                               &amp;<a name='10092'>
                       vb*(   field_old(i,k,j_end  )                 &amp;<a name='10093'>
                            - field_old(i,k,j_end-1) ) +             &amp;<a name='10094'>
                       field(i,k,j_end)*(rv(i,k,jte)-rv(i,k,jte-1))  &amp;<a name='10095'>
                                                                    )<a name='10096'>
       ENDDO<a name='10097'>
       ENDDO<a name='10098'>
<a name='10099'>
   ENDIF<a name='10100'>
<a name='10101'>
<font color=#447700>!-------------------- vertical advection<a name='10102'></font>
<a name='10103'>
<font color=#447700>!-- loop bounds for periodic or sym conditions<a name='10104'></font>
<a name='10105'>
      i_start = its-1<a name='10106'>
      i_end   = MIN(ite,ide-1)+1<a name='10107'>
      j_start = jts-1<a name='10108'>
      j_end   = MIN(jte,jde-1)+1<a name='10109'>
<a name='10110'>
<font color=#447700>!-- loop bounds for open or specified conditions<a name='10111'></font>
<a name='10112'>
<font color=#447700>!  WCS 20090218<a name='10113'></font>
<font color=#447700>!    IF(degrade_xs) i_start = its<a name='10114'></font>
<font color=#447700>!    IF(degrade_xe) i_end   = MIN(ite,ide-1)<a name='10115'></font>
<font color=#447700>!    IF(degrade_ys) j_start = jts<a name='10116'></font>
<font color=#447700>!    IF(degrade_ye) j_end   = MIN(jte,jde-1)<a name='10117'></font>
<a name='10118'>
    IF(degrade_xs) i_start = MAX(its-1,ids)<a name='10119'>
    IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='10120'>
    IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='10121'>
    IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='10122'>
<a name='10123'>
<a name='10124'>
    vert_order_test : IF (vert_order == 3) THEN    <a name='10125'>
<a name='10126'>
      DO j = j_start, j_end<a name='10127'>
<a name='10128'>
         DO i = i_start, i_end<a name='10129'>
           fqz(i,1,j)  = 0.<a name='10130'>
           fqzl(i,1,j) = 0.<a name='10131'>
           fqz(i,kde,j)  = 0.<a name='10132'>
           fqzl(i,kde,j) = 0.<a name='10133'>
         ENDDO<a name='10134'>
<a name='10135'>
         DO k=kts+2,ktf-1<a name='10136'>
         DO i = i_start, i_end<a name='10137'>
<a name='10138'>
           vel = rom(i,k,j)<a name='10139'>
           cr = -vel<a name='10140'>
           fqzl(i,k,j) = vel*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='10141'>
<a name='10142'>
           fqz(i,k,j) = vel*flux3(                      &amp;<a name='10143'>
                   field(i,k-2,j), field(i,k-1,j),      &amp;<a name='10144'>
                   field(i,k  ,j), field(i,k+1,j),  -vel )<a name='10145'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='10146'>
<a name='10147'>
          if(cr.gt. 0) then<a name='10148'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i,k-1,j))<a name='10149'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i,k-1,j))<a name='10150'>
          else<a name='10151'>
             qmax(i,k-1,j)  = amax1(qmax(i,k-1,j),field_old(i,k,j))<a name='10152'>
             qmin(i,k-1,j)  = amin1(qmin(i,k-1,j),field_old(i,k,j))<a name='10153'>
          end if<a name='10154'>
<a name='10155'>
         ENDDO<a name='10156'>
         ENDDO<a name='10157'>
<a name='10158'>
         DO i = i_start, i_end<a name='10159'>
<a name='10160'>
           k=kts+1<a name='10161'>
           vel = rom(i,k,j)<a name='10162'>
           cr = -vel<a name='10163'>
           fqzl(i,k,j) = vel*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='10164'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='10165'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='10166'>
<a name='10167'>
          if(cr.gt. 0) then<a name='10168'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i,k-1,j))<a name='10169'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i,k-1,j))<a name='10170'>
          else<a name='10171'>
             qmax(i,k-1,j)  = amax1(qmax(i,k-1,j),field_old(i,k,j))<a name='10172'>
             qmin(i,k-1,j)  = amin1(qmin(i,k-1,j),field_old(i,k,j))<a name='10173'>
          end if<a name='10174'>
<a name='10175'>
           k=ktf<a name='10176'>
           vel = rom(i,k,j)<a name='10177'>
           cr = -vel<a name='10178'>
           fqzl(i,k,j) = vel*flux_upwind(field_old(i,k-1,j), field_old(i,k,j  ), cr)<a name='10179'>
           fqz(i,k,j)=rom(i,k,j)*(fzm(k)*field(i,k,j)+fzp(k)*field(i,k-1,j))<a name='10180'>
           fqz(i,k,j) = fqz(i,k,j) - fqzl(i,k,j)<a name='10181'>
<a name='10182'>
          if(cr.gt. 0) then<a name='10183'>
             qmax(i,k,j)  = amax1(qmax(i,k,j),field_old(i,k-1,j))<a name='10184'>
             qmin(i,k,j)  = amin1(qmin(i,k,j),field_old(i,k-1,j))<a name='10185'>
          else<a name='10186'>
             qmax(i,k-1,j)  = amax1(qmax(i,k-1,j),field_old(i,k,j))<a name='10187'>
             qmin(i,k-1,j)  = amin1(qmin(i,k-1,j),field_old(i,k,j))<a name='10188'>
          end if<a name='10189'>
         ENDDO<a name='10190'>
<a name='10191'>
      ENDDO<a name='10192'>
<a name='10193'>
   ELSE<a name='10194'>
<a name='10195'>
      WRITE (wrf_err_message,*) ' advect_scalar_mono, v_order not known ',vert_order<a name='10196'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_MONO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_12"> ( wrf_err_message )<a name='10197'>
<a name='10198'>
   ENDIF vert_order_test<a name='10199'>
<a name='10200'>
   IF (mono_limit) THEN<a name='10201'>
<a name='10202'>
<font color=#447700>! montonic filter<a name='10203'></font>
<a name='10204'>
   i_start = its-1<a name='10205'>
   i_end   = MIN(ite,ide-1)+1<a name='10206'>
   j_start = jts-1<a name='10207'>
   j_end   = MIN(jte,jde-1)+1<a name='10208'>
<a name='10209'>
<font color=#447700>! WCS 20090218<a name='10210'></font>
<a name='10211'>
<font color=#447700>!-- loop bounds for open or specified conditions<a name='10212'></font>
<font color=#447700>!<a name='10213'></font>
<font color=#447700>!   IF(degrade_xs) i_start = its<a name='10214'></font>
<font color=#447700>!   IF(degrade_xe) i_end   = MIN(ite,ide-1)<a name='10215'></font>
<font color=#447700>!   IF(degrade_ys) j_start = jts<a name='10216'></font>
<font color=#447700>!   IF(degrade_ye) j_end   = MIN(jte,jde-1)<a name='10217'></font>
<font color=#447700>!<a name='10218'></font>
<font color=#447700>!   IF(config_flags%specified .or. config_flags%nested) THEN<a name='10219'></font>
<font color=#447700>!     IF (degrade_xs) i_start = MAX(its,ids+1)<a name='10220'></font>
<font color=#447700>!     IF (degrade_xe) i_end   = MIN(ite,ide-2)<a name='10221'></font>
<font color=#447700>!     IF (degrade_ys) j_start = MAX(jts,jds+1)<a name='10222'></font>
<font color=#447700>!     IF (degrade_ye) j_end   = MIN(jte,jde-2)<a name='10223'></font>
<font color=#447700>!   END IF<a name='10224'></font>
<font color=#447700>!<a name='10225'></font>
<font color=#447700>!   IF(config_flags%open_xs) THEN<a name='10226'></font>
<font color=#447700>!     IF (degrade_xs) i_start = MAX(its,ids+1)<a name='10227'></font>
<font color=#447700>!   END IF<a name='10228'></font>
<font color=#447700>!   IF(config_flags%open_xe) THEN<a name='10229'></font>
<font color=#447700>!     IF (degrade_xe) i_end   = MIN(ite,ide-2)<a name='10230'></font>
<font color=#447700>!   END IF<a name='10231'></font>
<font color=#447700>!   IF(config_flags%open_ys) THEN<a name='10232'></font>
<font color=#447700>!     IF (degrade_ys) j_start = MAX(jts,jds+1)<a name='10233'></font>
<font color=#447700>!   END IF<a name='10234'></font>
<font color=#447700>!   IF(config_flags%open_ye) THEN<a name='10235'></font>
<font color=#447700>!     IF (degrade_ye) j_end   = MIN(jte,jde-2)<a name='10236'></font>
<font color=#447700>!   END IF<a name='10237'></font>
<a name='10238'>
   IF(degrade_xs) i_start = MAX(its-1,ids)<a name='10239'>
   IF(degrade_xe) i_end   = MIN(ite+1,ide-1)<a name='10240'>
   IF(degrade_ys) j_start = MAX(jts-1,jds)<a name='10241'>
   IF(degrade_ye) j_end   = MIN(jte+1,jde-1)<a name='10242'>
<a name='10243'>
   IF(config_flags%specified .or. config_flags%nested) THEN<a name='10244'>
     IF (degrade_xs) i_start = MAX(its-1,ids+1)<a name='10245'>
     IF (degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='10246'>
     IF (degrade_ys) j_start = MAX(jts-1,jds+1)<a name='10247'>
     IF (degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='10248'>
   END IF<a name='10249'>
<a name='10250'>
   IF(config_flags%open_xs) THEN<a name='10251'>
     IF (degrade_xs) i_start = MAX(its-1,ids+1)<a name='10252'>
   END IF<a name='10253'>
   IF(config_flags%open_xe) THEN<a name='10254'>
     IF (degrade_xe) i_end   = MIN(ite+1,ide-2)<a name='10255'>
   END IF<a name='10256'>
   IF(config_flags%open_ys) THEN<a name='10257'>
     IF (degrade_ys) j_start = MAX(jts-1,jds+1)<a name='10258'>
   END IF<a name='10259'>
   IF(config_flags%open_ye) THEN<a name='10260'>
     IF (degrade_ye) j_end   = MIN(jte+1,jde-2)<a name='10261'>
   END IF<a name='10262'>
<a name='10263'>
<font color=#447700>!-- here is the limiter...<a name='10264'></font>
<a name='10265'>
   DO j=j_start, j_end<a name='10266'>
   DO k=kts, ktf<a name='10267'>
   DO i=i_start, i_end<a name='10268'>
<a name='10269'>
     ph_upwind = (mub(i,j)+mu_old(i,j))*field_old(i,k,j)        &amp;<a name='10270'>
                   - dt*( msftx(i,j)*msfty(i,j)*(               &amp;<a name='10271'>
                          rdx*(fqxl(i+1,k,j)-fqxl(i,k,j)) +     &amp;<a name='10272'>
                          rdy*(fqyl(i,k,j+1)-fqyl(i,k,j))  )    &amp;<a name='10273'>
                         +msfty(i,j)*rdzw(k)*(fqzl(i,k+1,j)-fqzl(i,k,j)) )<a name='10274'>
<a name='10275'>
     flux_in = -dt*( (msftx(i,j)*msfty(i,j))*(                   &amp;<a name='10276'>
                               rdx*(  min(0.,fqx (i+1,k,j))      &amp;<a name='10277'>
                                     -max(0.,fqx (i  ,k,j)) )    &amp;<a name='10278'>
                              +rdy*(  min(0.,fqy (i,k,j+1))      &amp;<a name='10279'>
                                     -max(0.,fqy (i,k,j  )) ) )  &amp;<a name='10280'>
               +msfty(i,j)*rdzw(k)*(  max(0.,fqz (i,k+1,j))      &amp;<a name='10281'>
                                     -min(0.,fqz (i,k  ,j)) )   )<a name='10282'>
<a name='10283'>
     ph_hi = mut(i,j)*qmax(i,k,j) - ph_upwind<a name='10284'>
     IF( flux_in .gt. ph_hi ) scale_in(i,k,j) = max(0.,ph_hi/(flux_in+eps))<a name='10285'>
<a name='10286'>
<a name='10287'>
     flux_out = dt*( (msftx(i,j)*msfty(i,j))*(                    &amp;<a name='10288'>
                                rdx*(  max(0.,fqx (i+1,k,j))      &amp;<a name='10289'>
                                      -min(0.,fqx (i  ,k,j)) )    &amp;<a name='10290'>
                               +rdy*(  max(0.,fqy (i,k,j+1))      &amp;<a name='10291'>
                                      -min(0.,fqy (i,k,j  )) ) )  &amp;<a name='10292'>
                +msfty(i,j)*rdzw(k)*(  min(0.,fqz (i,k+1,j))      &amp;<a name='10293'>
                                      -max(0.,fqz (i,k  ,j)) )   )<a name='10294'>
<a name='10295'>
     ph_low = ph_upwind - mut(i,j)*qmin(i,k,j)<a name='10296'>
     IF( flux_out .gt. ph_low ) scale_out(i,k,j) = max(0.,ph_low/(flux_out+eps))<a name='10297'>
<a name='10298'>
   ENDDO<a name='10299'>
   ENDDO<a name='10300'>
   ENDDO<a name='10301'>
<a name='10302'>
   DO j=j_start, j_end<a name='10303'>
   DO k=kts, ktf<a name='10304'>
   DO i=i_start, i_end+1<a name='10305'>
       IF( fqx (i,k,j) .gt. 0.) then<a name='10306'>
         fqx(i,k,j) = min(scale_in(i,k,j),scale_out(i-1,k,j))*fqx(i,k,j)<a name='10307'>
       ELSE<a name='10308'>
         fqx(i,k,j) = min(scale_out(i,k,j),scale_in(i-1,k,j))*fqx(i,k,j)<a name='10309'>
       ENDIF<a name='10310'>
   ENDDO<a name='10311'>
   ENDDO<a name='10312'>
   ENDDO<a name='10313'>
<a name='10314'>
   DO j=j_start, j_end+1<a name='10315'>
   DO k=kts, ktf<a name='10316'>
   DO i=i_start, i_end<a name='10317'>
       IF( fqy (i,k,j) .gt. 0.) then<a name='10318'>
         fqy(i,k,j) = min(scale_in(i,k,j),scale_out(i,k,j-1))*fqy(i,k,j)<a name='10319'>
       ELSE<a name='10320'>
         fqy(i,k,j) = min(scale_out(i,k,j),scale_in(i,k,j-1))*fqy(i,k,j)<a name='10321'>
       ENDIF<a name='10322'>
   ENDDO<a name='10323'>
   ENDDO<a name='10324'>
   ENDDO<a name='10325'>
<a name='10326'>
   DO j=j_start, j_end<a name='10327'>
   DO k=kts+1, ktf<a name='10328'>
   DO i=i_start, i_end<a name='10329'>
       IF( fqz (i,k,j) .lt. 0.) then<a name='10330'>
         fqz(i,k,j) = min(scale_in(i,k,j),scale_out(i,k-1,j))*fqz(i,k,j)<a name='10331'>
       ELSE<a name='10332'>
         fqz(i,k,j) = min(scale_out(i,k,j),scale_in(i,k-1,j))*fqz(i,k,j)<a name='10333'>
       ENDIF<a name='10334'>
   ENDDO<a name='10335'>
   ENDDO<a name='10336'>
   ENDDO<a name='10337'>
<a name='10338'>
   END IF<a name='10339'>
<a name='10340'>
<font color=#447700>! add in the mono-limited flux divergence<a name='10341'></font>
<font color=#447700>! we need to fix this for open b.c set ***********<a name='10342'></font>
<a name='10343'>
  i_start = its<a name='10344'>
  i_end   = MIN(ite,ide-1)<a name='10345'>
  j_start = jts<a name='10346'>
  j_end   = MIN(jte,jde-1)<a name='10347'>
<a name='10348'>
  DO j = j_start, j_end<a name='10349'>
  DO k = kts, ktf<a name='10350'>
  DO i = i_start, i_end<a name='10351'>
<a name='10352'>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='10353'>
                            -rdzw(k)*( fqz (i,k+1,j)-fqz (i,k,j)  &amp;<a name='10354'>
                                      +fqzl(i,k+1,j)-fqzl(i,k,j))<a name='10355'>
<a name='10356'>
  ENDDO<a name='10357'>
  ENDDO<a name='10358'>
  ENDDO<a name='10359'>
<a name='10360'>
  IF(tenddec) THEN<a name='10361'>
  DO j = j_start, j_end<a name='10362'>
  DO k = kts, ktf<a name='10363'>
  DO i = i_start, i_end<a name='10364'>
<a name='10365'>
     z_tendency (i,k,j) = 0. -rdzw(k)*( fqz (i,k+1,j)-fqz (i,k,j)  &amp;<a name='10366'>
                                      +fqzl(i,k+1,j)-fqzl(i,k,j))<a name='10367'>
<a name='10368'>
  ENDDO<a name='10369'>
  ENDDO<a name='10370'>
  ENDDO<a name='10371'>
  END IF<a name='10372'>
<a name='10373'>
<font color=#447700>! x flux divergence<a name='10374'></font>
<font color=#447700>!<a name='10375'></font>
<a name='10376'>
<font color=#447700>! WCS 20090218<a name='10377'></font>
<font color=#447700>!  IF(degrade_xs) i_start = i_start + 1<a name='10378'></font>
<font color=#447700>!  IF(degrade_xe) i_end   = i_end   - 1<a name='10379'></font>
<a name='10380'>
  IF(degrade_xs) i_start = MAX(its,ids+1)<a name='10381'>
  IF(degrade_xe) i_end   = MIN(ite,ide-2)<a name='10382'>
<a name='10383'>
  DO j = j_start, j_end<a name='10384'>
  DO k = kts, ktf<a name='10385'>
  DO i = i_start, i_end<a name='10386'>
<a name='10387'>
     <font color=#447700>! Un-"canceled" map scale factor, ADT Eq. 48<a name='10388'></font>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='10389'>
               - msftx(i,j)*( rdx*( fqx (i+1,k,j)-fqx (i,k,j)     &amp;<a name='10390'>
                                   +fqxl(i+1,k,j)-fqxl(i,k,j))   )<a name='10391'>
<a name='10392'>
  ENDDO<a name='10393'>
  ENDDO<a name='10394'>
  ENDDO<a name='10395'>
<a name='10396'>
  IF(tenddec) THEN<a name='10397'>
  DO j = j_start, j_end<a name='10398'>
  DO k = kts, ktf<a name='10399'>
  DO i = i_start, i_end<a name='10400'>
<a name='10401'>
     h_tendency (i,k,j) = 0.                                      &amp;<a name='10402'>
               - msftx(i,j)*( rdx*( fqx (i+1,k,j)-fqx (i,k,j)     &amp;<a name='10403'>
                                   +fqxl(i+1,k,j)-fqxl(i,k,j))   )<a name='10404'>
<a name='10405'>
  ENDDO<a name='10406'>
  ENDDO<a name='10407'>
  ENDDO<a name='10408'>
  END IF<a name='10409'>
<a name='10410'>
<font color=#447700>! y flux divergence<a name='10411'></font>
<font color=#447700>!<a name='10412'></font>
  i_start = its<a name='10413'>
  i_end   = MIN(ite,ide-1)<a name='10414'>
<a name='10415'>
<font color=#447700>! WCS 20090218<a name='10416'></font>
<font color=#447700>!  IF(degrade_ys) j_start = j_start + 1<a name='10417'></font>
<font color=#447700>!  IF(degrade_ye) j_end   = j_end   - 1<a name='10418'></font>
<a name='10419'>
  IF(degrade_ys) j_start = MAX(jts,jds+1)<a name='10420'>
  IF(degrade_ye) j_end   = MIN(jte,jde-2)<a name='10421'>
<a name='10422'>
  DO j = j_start, j_end<a name='10423'>
  DO k = kts, ktf<a name='10424'>
  DO i = i_start, i_end<a name='10425'>
<a name='10426'>
     <font color=#447700>! Un-"canceled" map scale factor, ADT Eq. 48<a name='10427'></font>
     tendency (i,k,j) = tendency(i,k,j)                           &amp;<a name='10428'>
               - msftx(i,j)*( rdy*( fqy (i,k,j+1)-fqy (i,k,j)     &amp;<a name='10429'>
                                   +fqyl(i,k,j+1)-fqyl(i,k,j))   )<a name='10430'>
<a name='10431'>
  ENDDO<a name='10432'>
  ENDDO<a name='10433'>
  ENDDO<a name='10434'>
<a name='10435'>
  IF(tenddec) THEN<a name='10436'>
  DO j = j_start, j_end<a name='10437'>
  DO k = kts, ktf<a name='10438'>
  DO i = i_start, i_end<a name='10439'>
<a name='10440'>
     h_tendency (i,k,j) = h_tendency (i,k,j)                      &amp;<a name='10441'>
               - msftx(i,j)*( rdy*( fqy (i,k,j+1)-fqy (i,k,j)     &amp;<a name='10442'>
                                   +fqyl(i,k,j+1)-fqyl(i,k,j))   )<a name='10443'>
<a name='10444'>
  ENDDO<a name='10445'>
  ENDDO<a name='10446'>
  ENDDO<a name='10447'>
  END IF<a name='10448'>
<a name='10449'>
END SUBROUTINE advect_scalar_mono<a name='10450'>
<a name='10451'>
<font color=#447700>!-----------------------------------------------------------<a name='10452'></font>
<a name='10453'>
#if ( defined(ADVECT_KERNEL) )<a name='10454'>
<a name='10455'>
END MODULE advection_kernel<a name='10456'>
<font color=#447700>!================================================================<a name='10457'></font>
<font color=#447700>!================================================================<a name='10458'></font>
<A NAME='FEEDER'><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='top_target'><IMG SRC="../../gif/bar_yellow.gif" border=0></A><a name='10459'>
<font color=#993300>PROGRAM </font><font color=#cc0000>feeder</font>,<A href='../../call_from/FEEDER.html' TARGET='index'>13</A><a name='10460'>
   USE <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECTION_KERNEL'>advection_kernel</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECTION_KERNEL_1"><a name='10461'>
   IMPLICIT NONE<a name='10462'>
   INTEGER , PARAMETER :: MAX_SCALARS = 1<a name='10463'>
   TYPE(grid_config_rec_type) :: config_flags<a name='10464'>
   LOGICAL :: tenddec = .false.<a name='10465'>
   INTEGER :: ids, ide, jds, jde, kds, kde, &amp;<a name='10466'>
              ims, ime, jms, jme, kms, kme, &amp;<a name='10467'>
              its, ite, jts, jte, kts, kte<a name='10468'>
   REAL , DIMENSION( :,:,:,: ) , ALLOCATABLE :: field, &amp;<a name='10469'>
                                               field_old<a name='10470'>
   REAL , DIMENSION( :,:,: ) , ALLOCATABLE :: ru, &amp;<a name='10471'>
                                               rv, &amp;<a name='10472'>
                                               rom<a name='10473'>
   REAL , DIMENSION( :,: ), ALLOCATABLE :: mut, mub, mu_old<a name='10474'>
   REAL , DIMENSION( :,:,: ), ALLOCATABLE :: tendency<a name='10475'>
   REAL , DIMENSION( :,:,: ), ALLOCATABLE :: h_tendency, z_tendency<a name='10476'>
   REAL , DIMENSION( :,: ), ALLOCATABLE :: msfux, &amp;<a name='10477'>
                                            msfuy, &amp;<a name='10478'>
                                            msfvx, &amp;<a name='10479'>
                                            msfvy, &amp;<a name='10480'>
                                            msftx, &amp;<a name='10481'>
                                            msfty<a name='10482'>
   REAL , DIMENSION( : ), ALLOCATABLE :: fzm, &amp;<a name='10483'>
                                  fzp, &amp;<a name='10484'>
                                  rdzw, znw,dnw, rdnw, dn, rdn<a name='10485'>
   REAL :: rdx, &amp;<a name='10486'>
           rdy, &amp;<a name='10487'>
           dt<a name='10488'>
   INTEGER :: time_step, im<a name='10489'>
   INTEGER :: i, j, k, n, loop<a name='10490'>
<a name='10491'>
   config_flags%scalar_adv_opt = 2<a name='10492'>
<a name='10493'>
   PRINT *,'Init dimensions'<a name='10494'>
   ids = 1; ide = 91; jds = 1; jde = 3; kds = 1; kde =10 <a name='10495'>
   ims = -5; ime = 96; jms = -5; jme = 8; kms = 1; kme = 10<a name='10496'>
   its = 1; ite = 91; jts = 1; jte = 3; kts = 1; kte = 10<a name='10497'>
   PRINT *,'ALLOCATE two 4d fields'<a name='10498'>
   PRINT *,(ime-ims+1)*(kme-kms+1)*(jme-jms+1)*MAX_SCALARS<a name='10499'>
   ALLOCATE ( field(ims:ime , kms:kme , jms:jme, MAX_SCALARS ) )<a name='10500'>
   ALLOCATE ( field_old(ims:ime , kms:kme , jms:jme, MAX_SCALARS ) )<a name='10501'>
   PRINT *,'ALLOCATE three 3d fields U, V, W'<a name='10502'>
   PRINT *,(ime-ims+1)*(kme-kms+1)*(jme-jms+1)<a name='10503'>
   ALLOCATE ( ru(ims:ime , kms:kme , jms:jme ) )<a name='10504'>
   ALLOCATE ( rv(ims:ime , kms:kme , jms:jme ) )<a name='10505'>
   ALLOCATE ( rom(ims:ime , kms:kme , jms:jme ) )<a name='10506'>
   PRINT *,'ALLOCATE three 2d MU fields'<a name='10507'>
   PRINT *,(ime-ims+1)*(jme-jms+1)<a name='10508'>
   ALLOCATE ( mut( ims:ime , jms:jme ) )<a name='10509'>
   ALLOCATE ( mub( ims:ime , jms:jme ) )<a name='10510'>
   ALLOCATE ( mu_old( ims:ime , jms:jme ) )<a name='10511'>
   PRINT *,'ALLOCATE three 3d tendency'<a name='10512'>
   PRINT *,(ime-ims+1)*(kme-kms+1)*(jme-jms+1)<a name='10513'>
   ALLOCATE ( tendency( ims:ime , kms:kme , jms:jme ) )<a name='10514'>
   ALLOCATE ( h_tendency( ims:ime , kms:kme , jms:jme ) )<a name='10515'>
   ALLOCATE ( z_tendency( ims:ime , kms:kme , jms:jme ) )<a name='10516'>
   PRINT *,'ALLOCATE six 2d map factors'<a name='10517'>
   PRINT *,(ime-ims+1)*(jme-jms+1)<a name='10518'>
   ALLOCATE ( msfux( ims:ime , jms:jme ) )<a name='10519'>
   ALLOCATE ( msfuy( ims:ime , jms:jme ) )<a name='10520'>
   ALLOCATE ( msfvx( ims:ime , jms:jme ) )<a name='10521'>
   ALLOCATE ( msfvy( ims:ime , jms:jme ) )<a name='10522'>
   ALLOCATE ( msftx( ims:ime , jms:jme ) )<a name='10523'>
   ALLOCATE ( msfty( ims:ime , jms:jme ) )<a name='10524'>
   PRINT *,'ALLOCATE 1d arrays'<a name='10525'>
   ALLOCATE ( fzm( kms:kme ) )<a name='10526'>
   ALLOCATE ( fzp( kms:kme ) )<a name='10527'>
   ALLOCATE ( rdzw( kms:kme ) )<a name='10528'>
   ALLOCATE ( znw( kms:kme ) )<a name='10529'>
   ALLOCATE ( dnw( kms:kme ) )<a name='10530'>
   ALLOCATE (rdnw( kms:kme ) )<a name='10531'>
   ALLOCATE ( dn ( kms:kme ) )<a name='10532'>
   ALLOCATE (rdn ( kms:kme ) )<a name='10533'>
   PRINT *,'CALL init'<a name='10534'>
   CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#INIT'>init</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_1"> ( config_flags)<a name='10535'>
   CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#TOPHAT'>tophat</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOPHAT_1"> ( field , MAX_SCALARS ,&amp;<a name='10536'>
      ids, ide, jds, jde, kds, kde, &amp;<a name='10537'>
      ims, ime, jms, jme, kms, kme, &amp;<a name='10538'>
      its, ite, jts, jte, kts, kte )<a name='10539'>
   CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#TOPHAT'>tophat</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TOPHAT_2"> ( field_old , MAX_SCALARS , &amp;<a name='10540'>
      ids, ide, jds, jde, kds, kde, &amp;<a name='10541'>
      ims, ime, jms, jme, kms, kme, &amp;<a name='10542'>
      its, ite, jts, jte, kts, kte )<a name='10543'>
   h_tendency = 0<a name='10544'>
   z_tendency = 0<a name='10545'>
   mub = 1<a name='10546'>
   mut = 1<a name='10547'>
   mu_old = 0<a name='10548'>
   ru = 90 <a name='10549'>
   rv = 0<a name='10550'>
   rom = 0<a name='10551'>
   msfux = 1<a name='10552'>
   msfuy = 1<a name='10553'>
   msfvx = 1<a name='10554'>
   msfvy = 1<a name='10555'>
   msftx = 1<a name='10556'>
   msfty = 1<a name='10557'>
   rdx = 1/1000.<a name='10558'>
   rdy = 1/1000.<a name='10559'>
   DO k = kts, kte<a name='10560'>
      znw(k) = 1 - (real(k)-kts)/(real(kte)-kts)<a name='10561'>
   END DO<a name='10562'>
   DO k = kts, kte-1<a name='10563'>
      rdzw(k) = 1./(znw(k)-znw(k+1))<a name='10564'>
   END DO<a name='10565'>
   DO k=1, kde-1<a name='10566'>
    dnw(k) = znw(k+1) - znw(k)<a name='10567'>
    rdnw(k) = 1./dnw(k)<a name='10568'>
   ENDDO<a name='10569'>
   DO k=2, kde-1<a name='10570'>
    dn(k) = 0.5*(dnw(k)+dnw(k-1))<a name='10571'>
    rdn(k) = 1./dn(k)<a name='10572'>
    fzp(k) = .5* dnw(k  )/dn(k)<a name='10573'>
    fzm(k) = .5* dnw(k-1)/dn(k)<a name='10574'>
   ENDDO<a name='10575'>
<a name='10576'>
   time_step = 5<a name='10577'>
   dt = time_step<a name='10578'>
<a name='10579'>
   field = field_old<a name='10580'>
<a name='10581'>
   <font color=#447700>! Loop over advection enough times to get some meaningful timings.<a name='10582'></font>
   CALL <A href='../../html_code/phys/module_ra_goddard.F.html#COLUMN'>column</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLUMN_1"> ( 0 , field(:,1,2,1) , its, ite )<a name='10583'>
   DO loop = 1 , 2000<a name='10584'>
      <font color=#447700>! A representative number of times to call the advection in a time period.<a name='10585'></font>
      IF ( loop .EQ. ((loop)/200)*200 )THEN<a name='10586'>
      PRINT *,'LOOP over scalars',loop<a name='10587'>
      END IF<a name='10588'>
      DO im = 1 , MAX_SCALARS<a name='10589'>
<a name='10590'>
         tendency = 0<a name='10591'>
         CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR'>advect_scalar</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_1">    ( field(ims,kms,jms,im), &amp;<a name='10592'>
                                 field_old(ims,kms,jms,im), &amp;<a name='10593'>
                                 tendency(ims,kms,jms), &amp;<a name='10594'>
                                 ru, rv, rom,                   &amp;<a name='10595'>
                                 mut, time_step/3, config_flags,  &amp;<a name='10596'>
                                 msfux, msfuy, msfvx, msfvy,    &amp;<a name='10597'>
                                 msftx, msfty,                  &amp;<a name='10598'>
                                 fzm, fzp,                      &amp;<a name='10599'>
                                 rdx, rdy, rdzw,                &amp;<a name='10600'>
                                 ids, ide, jds, jde, kds, kde,  &amp;<a name='10601'>
                                 ims, ime, jms, jme, kms, kme,  &amp;<a name='10602'>
                                 its, ite, jts, jte, kts, kte  )<a name='10603'>
         DO n = 1 , MAX_SCALARS<a name='10604'>
            field(:,:,:,n) = field_old(:,:,:,n) + dt * tendency(:,:,:) / 3.<a name='10605'>
         END DO<a name='10606'>
<a name='10607'>
         tendency = 0<a name='10608'>
         CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR'>advect_scalar</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_2">    ( field(ims,kms,jms,im), &amp;<a name='10609'>
                                 field_old(ims,kms,jms,im), &amp;<a name='10610'>
                                 tendency(ims,kms,jms), &amp;<a name='10611'>
                                 ru, rv, rom,                   &amp;<a name='10612'>
                                 mut, time_step/2, config_flags,  &amp;<a name='10613'>
                                 msfux, msfuy, msfvx, msfvy,    &amp;<a name='10614'>
                                 msftx, msfty,                  &amp;<a name='10615'>
                                 fzm, fzp,                      &amp;<a name='10616'>
                                 rdx, rdy, rdzw,                &amp;<a name='10617'>
                                 ids, ide, jds, jde, kds, kde,  &amp;<a name='10618'>
                                 ims, ime, jms, jme, kms, kme,  &amp;<a name='10619'>
                                 its, ite, jts, jte, kts, kte  )<a name='10620'>
         DO n = 1 , MAX_SCALARS<a name='10621'>
            field(:,:,:,n) = field_old(:,:,:,n) + dt * tendency(:,:,:) / 2.<a name='10622'>
         END DO<a name='10623'>
<a name='10624'>
         tendency = 0<a name='10625'>
         IF      (config_flags%scalar_adv_opt .EQ. 0 ) THEN<a name='10626'>
            CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR'>advect_scalar</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_3">    ( field(ims,kms,jms,im), &amp;<a name='10627'>
                                    field_old(ims,kms,jms,im), &amp;<a name='10628'>
                                    tendency(ims,kms,jms), &amp;<a name='10629'>
                                    ru, rv, rom,                   &amp;<a name='10630'>
                                    mut, time_step, config_flags,  &amp;<a name='10631'>
                                    msfux, msfuy, msfvx, msfvy,    &amp;<a name='10632'>
                                    msftx, msfty,                  &amp;<a name='10633'>
                                    fzm, fzp,                      &amp;<a name='10634'>
                                    rdx, rdy, rdzw,                &amp;<a name='10635'>
                                    ids, ide, jds, jde, kds, kde,  &amp;<a name='10636'>
                                    ims, ime, jms, jme, kms, kme,  &amp;<a name='10637'>
                                    its, ite, jts, jte, kts, kte  )<a name='10638'>
         ELSE IF (config_flags%scalar_adv_opt .EQ. 1 ) THEN<a name='10639'>
            CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_PD'>advect_scalar_pd</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_PD_1"> ( field(ims,kms,jms,im), &amp;<a name='10640'>
                                    field_old(ims,kms,jms,im), &amp;<a name='10641'>
                                    tendency(ims,kms,jms), &amp;<a name='10642'>
                                    h_tendency(ims,kms,jms), &amp;<a name='10643'>
                                    z_tendency(ims,kms,jms), &amp;<a name='10644'>
                                    ru, rv, rom, mut, mub, mu_old, &amp;<a name='10645'>
                                    time_step, config_flags, tenddec, &amp;<a name='10646'>
                                    msfux, msfuy, msfvx, msfvy, &amp;<a name='10647'>
                                    msftx, msfty, fzm, fzp, &amp;<a name='10648'>
                                    rdx, rdy, rdzw,dt, &amp;<a name='10649'>
                                    ids, ide, jds, jde, kds, kde, &amp;<a name='10650'>
                                    ims, ime, jms, jme, kms, kme, &amp;<a name='10651'>
                                    its, ite, jts, jte, kts, kte )<a name='10652'>
         ELSE IF (config_flags%scalar_adv_opt .EQ. 2 ) THEN<a name='10653'>
            CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_MONO'>advect_scalar_mono</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_MONO_1"> ( field(ims,kms,jms,im), &amp;<a name='10654'>
                                    field_old(ims,kms,jms,im), &amp;<a name='10655'>
                                    tendency(ims,kms,jms), &amp;<a name='10656'>
                                    h_tendency(ims,kms,jms), &amp;<a name='10657'>
                                    z_tendency(ims,kms,jms), &amp;<a name='10658'>
                                    ru, rv, rom, mut, mub, mu_old, &amp;<a name='10659'>
                                    config_flags, tenddec, &amp;<a name='10660'>
                                    msfux, msfuy, msfvx, msfvy, &amp;<a name='10661'>
                                    msftx, msfty, fzm, fzp, &amp;<a name='10662'>
                                    rdx, rdy, rdzw,dt, &amp;<a name='10663'>
                                    ids, ide, jds, jde, kds, kde, &amp;<a name='10664'>
                                    ims, ime, jms, jme, kms, kme, &amp;<a name='10665'>
                                    its, ite, jts, jte, kts, kte )<a name='10666'>
         ELSE IF (config_flags%scalar_adv_opt .EQ. 3 ) THEN<a name='10667'>
            CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_WENO'>advect_scalar_weno</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_WENO_1"> ( field(ims,kms,jms,im), &amp;<a name='10668'>
                                   field_old(ims,kms,jms,im), &amp;<a name='10669'>
                                   tendency(ims,kms,jms), &amp;<a name='10670'>
                             ru, rv, rom,                   &amp;<a name='10671'>
                             mut, time_step, config_flags,  &amp;<a name='10672'>
                             msfux, msfuy, msfvx, msfvy,    &amp;<a name='10673'>
                             msftx, msfty,                  &amp;<a name='10674'>
                             fzm, fzp,                      &amp;<a name='10675'>
                             rdx, rdy, rdzw,                &amp;<a name='10676'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='10677'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='10678'>
                             its, ite, jts, jte, kts, kte  )<a name='10679'>
         ELSE IF (config_flags%scalar_adv_opt .EQ. 4 ) THEN<a name='10680'>
            CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_WENOPD'>advect_scalar_wenopd</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_WENOPD_1"> ( field(ims,kms,jms,im), &amp;<a name='10681'>
                                        field_old(ims,kms,jms,im), &amp;<a name='10682'>
                                        tendency(ims,kms,jms), &amp;<a name='10683'>
                                ru, rv, rom,                   &amp;<a name='10684'>
                                mut, mub, mu_old,              &amp;<a name='10685'>
                                time_step, config_flags,       &amp;<a name='10686'>
                                msfux, msfuy, msfvx, msfvy,    &amp;<a name='10687'>
                                msftx, msfty,                  &amp;<a name='10688'>
                                fzm, fzp,                      &amp;<a name='10689'>
                                rdx, rdy, rdzw, dt,            &amp;<a name='10690'>
                                ids, ide, jds, jde, kds, kde,  &amp;<a name='10691'>
                                ims, ime, jms, jme, kms, kme,  &amp;<a name='10692'>
                                its, ite, jts, jte, kts, kte  )<a name='10693'>
         END IF<a name='10694'>
         DO n = 1 , MAX_SCALARS<a name='10695'>
            field(:,:,:,n) = field_old(:,:,:,n) + dt * ( tendency(:,:,:) )<a name='10696'>
         END DO<a name='10697'>
<a name='10698'>
         DO k = 1 , kde<a name='10699'>
            field    (:,k,:,:) = field    (:,2,:,:)<a name='10700'>
         END DO<a name='10701'>
<a name='10702'>
         field    (:,:,2,:) = field    (:,:,1,:)<a name='10703'>
         field    (:,:,3,:) = field    (:,:,1,:)<a name='10704'>
 <a name='10705'>
         field    (ite+0,:,:,:) = field(ids+0,:,:,:)<a name='10706'>
         field    (ite+1,:,:,:) = field(ids+1,:,:,:)<a name='10707'>
         field    (ite+2,:,:,:) = field(ids+2,:,:,:)<a name='10708'>
         field    (ite+3,:,:,:) = field(ids+3,:,:,:)<a name='10709'>
         field    (ite+4,:,:,:) = field(ids+4,:,:,:)<a name='10710'>
         field    (ids-0,:,:,:) = field(ite-0,:,:,:)<a name='10711'>
         field    (ids-1,:,:,:) = field(ite-1,:,:,:)<a name='10712'>
         field    (ids-2,:,:,:) = field(ite-2,:,:,:)<a name='10713'>
         field    (ids-3,:,:,:) = field(ite-3,:,:,:)<a name='10714'>
         field    (ids-4,:,:,:) = field(ite-4,:,:,:)<a name='10715'>
<a name='10716'>
         field_old = field<a name='10717'>
<a name='10718'>
         IF ( loop .EQ. (loop/200)*200 ) THEN<a name='10719'>
            CALL <A href='../../html_code/phys/module_ra_goddard.F.html#COLUMN'>column</A><A href='../../html_code/dyn_em/module_advect_em.F.html#FEEDER' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COLUMN_2"> ( loop , field(:,1,2,1) , its, ite )<a name='10720'>
         END IF<a name='10721'>
      END DO<a name='10722'>
   END DO<a name='10723'>
<a name='10724'>
   print *,' '<a name='10725'>
   print *,'=============================== '<a name='10726'>
   print *,' '<a name='10727'>
   print *,'Lines to input to gnuplot'<a name='10728'>
   print *,' '<a name='10729'>
   print *,"set term x11"<a name='10730'>
   IF      (config_flags%scalar_adv_opt .EQ. 0 ) THEN<a name='10731'>
      print *,'set title "Scalar Advection" font ",20"'<a name='10732'>
   ELSE IF (config_flags%scalar_adv_opt .EQ. 1 ) THEN<a name='10733'>
      print *,'set title "PD Advection" font ",20"'<a name='10734'>
   ELSE IF (config_flags%scalar_adv_opt .EQ. 2 ) THEN<a name='10735'>
      print *,'set title "Mono Advection" font ",20"'<a name='10736'>
   ELSE IF (config_flags%scalar_adv_opt .EQ. 3 ) THEN<a name='10737'>
      print *,'set title "WENO Advection" font ",20"'<a name='10738'>
   ELSE IF (config_flags%scalar_adv_opt .EQ. 3 ) THEN<a name='10739'>
      print *,'set title "WENO PD Advection" font ",20"'<a name='10740'>
   END IF<a name='10741'>
   print *,"set yrange[-20:120]"<a name='10742'>
   print *,"plot [0:90] '000000.txt' with lines , '000200.txt' with lines , '000400.txt' with lines , '000600.txt' with lines , '000800.txt' with lines , '001000.txt' with lines "<a name='10743'>
   print *,"plot [0:90] '000000.txt' with lines , '001200.txt' with lines , '001400.txt' with lines , '001600.txt' with lines , '001800.txt' with lines , '002000.txt' with lines "<a name='10744'>
<a name='10745'>
END PROGRAM feeder<a name='10746'>
#endif<a name='10747'>
#if ( <font color=#447700>!defined(ADVECT_KERNEL) )<a name='10748'></font>
<a name='10749'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='10750'></font>
<a name='10751'>
<A NAME='ADVECT_WENO_U'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_WENO_U' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10752'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_weno_u</font> ( u, u_old, tendency,            &amp; <A href='../../call_to/ADVECT_WENO_U.html' TARGET='index'>1</A><a name='10753'>
                        ru, rv, rom,                   &amp;<a name='10754'>
                        c1, c2,                        &amp;<a name='10755'>
                        mut, time_step, config_flags,  &amp;<a name='10756'>
                        msfux, msfuy, msfvx, msfvy,    &amp;<a name='10757'>
                        msftx, msfty,                  &amp;<a name='10758'>
                        fzm, fzp,                      &amp;<a name='10759'>
                        rdx, rdy, rdzw,                &amp;<a name='10760'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='10761'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='10762'>
                        its, ite, jts, jte, kts, kte  )<a name='10763'>
<a name='10764'>
<font color=#447700>!<a name='10765'></font>
<font color=#447700>! 5th-order WENO (Weighted Essentially Non-Oscillatory) scheme adapted from COMMAS.  <a name='10766'></font>
<font color=#447700>! See Jiang and Shu, 1996, J. Comp. Phys. v. 126, 202-223; <a name='10767'></font>
<font color=#447700>! Shu 2003, Int. J. Comp. Fluid Dyn. v. 17 107-118;  Also used by Bryan 2005, Mon. Wea. Rev.<a name='10768'></font>
<font color=#447700>!<a name='10769'></font>
<a name='10770'>
   IMPLICIT NONE<a name='10771'>
   <a name='10772'>
   <font color=#447700>! Input data<a name='10773'></font>
   <a name='10774'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='10775'>
<a name='10776'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='10777'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='10778'>
                                              its, ite, jts, jte, kts, kte<a name='10779'>
<a name='10780'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: u,     &amp;<a name='10781'>
                                                                      u_old, &amp;<a name='10782'>
                                                                      ru,    &amp;<a name='10783'>
                                                                      rv,    &amp;<a name='10784'>
                                                                      rom<a name='10785'>
<a name='10786'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='10787'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='10788'>
<a name='10789'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='10790'>
                                                                    msfuy,  &amp;<a name='10791'>
                                                                    msfvx,  &amp;<a name='10792'>
                                                                    msfvy,  &amp;<a name='10793'>
                                                                    msftx,  &amp;<a name='10794'>
                                                                    msfty<a name='10795'>
<a name='10796'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='10797'>
                                                                  fzp,  &amp;<a name='10798'>
                                                                  rdzw, &amp;<a name='10799'>
                                                                  c1,   &amp;<a name='10800'>
                                                                  c2<a name='10801'>
<a name='10802'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='10803'>
                                                                  rdy<a name='10804'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='10805'>
<a name='10806'>
   <font color=#447700>! Local data<a name='10807'></font>
   <a name='10808'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='10809'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='10810'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='10811'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax, im, ip<a name='10812'>
   INTEGER :: jp1, jp0, jtmp<a name='10813'>
<a name='10814'>
    real            :: dir, vv<a name='10815'>
    real            :: ue,vs,vn,wb,wt<a name='10816'>
    real, parameter :: f30 =  7./12., f31 = 1./12.<a name='10817'>
    real, parameter :: f50 = 37./60., f51 = 2./15., f52 = 1./60.<a name='10818'>
<a name='10819'>
<a name='10820'>
   integer kt,kb<a name='10821'>
   <a name='10822'>
    <a name='10823'>
    real               :: qim2, qim1, qi, qip1, qip2<a name='10824'>
    double precision               :: beta0, beta1, beta2, f0, f1, f2, wi0, wi1, wi2, sumwk<a name='10825'>
    double precision, parameter    :: gi0 = 1.d0/10.d0, gi1 = 6.d0/10.d0, gi2 = 3.d0/10.d0, eps=1.0d-18<a name='10826'>
    integer, parameter :: pw = 2<a name='10827'>
<a name='10828'>
<a name='10829'>
   INTEGER :: horz_order, vert_order<a name='10830'>
<a name='10831'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, dvm, dvp<a name='10832'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='10833'>
<a name='10834'>
<a name='10835'>
   REAL,  DIMENSION( its-1:ite+1, kts:kte ) :: fqx<a name='10836'>
   REAL,  DIMENSION( its:ite, kts:kte, 2) :: fqy<a name='10837'>
   <a name='10838'>
   LOGICAL :: degrade_xs, degrade_ys<a name='10839'>
   LOGICAL :: degrade_xe, degrade_ye<a name='10840'>
<a name='10841'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='10842'></font>
<a name='10843'>
   REAL    :: flux3, flux4, flux5, flux6<a name='10844'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='10845'>
<a name='10846'>
   flux4(q_im2, q_im1, q_i, q_ip1, ua) =                         &amp;<a name='10847'>
          ( 7.*(q_i + q_im1) - (q_ip1 + q_im2) )/12.0<a name='10848'>
<a name='10849'>
   flux3(q_im2, q_im1, q_i, q_ip1, ua) =                         &amp;<a name='10850'>
            flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='10851'>
            sign(1,time_step)*sign(1.,ua)*((q_ip1 - q_im2)-3.*(q_i-q_im1))/12.0<a name='10852'>
<a name='10853'>
   flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =           &amp;<a name='10854'>
                      ( 37.*(q_i+q_im1) - 8.*(q_ip1+q_im2)       &amp;<a name='10855'>
                     +(q_ip2+q_im3) )/60.0<a name='10856'>
<a name='10857'>
   flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =           &amp;<a name='10858'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)     &amp;<a name='10859'>
            -sign(1,time_step)*sign(1.,ua)*(                     &amp;<a name='10860'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )/60.0<a name='10861'>
<a name='10862'>
<a name='10863'>
   LOGICAL :: specified<a name='10864'>
<a name='10865'>
   specified = .false.<a name='10866'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='10867'>
<a name='10868'>
<font color=#447700>!  set order for vertical and horzontal flux operators<a name='10869'></font>
<a name='10870'>
   horz_order = config_flags%h_mom_adv_order<a name='10871'>
   vert_order = config_flags%v_mom_adv_order<a name='10872'>
<a name='10873'>
   ktf=MIN(kte,kde-1)<a name='10874'>
<a name='10875'>
<font color=#447700>!  begin with horizontal flux divergence<a name='10876'></font>
<a name='10877'>
<font color=#447700>!   horizontal_order_test : IF( horz_order == 6 ) THEN<a name='10878'></font>
<a name='10879'>
<font color=#447700>!   ELSE IF( horz_order == 5 ) THEN<a name='10880'></font>
<a name='10881'>
<font color=#447700>!  5th order horizontal flux calculation<a name='10882'></font>
<font color=#447700>!  This code is EXACTLY the same as the 6th order code<a name='10883'></font>
<font color=#447700>!  EXCEPT the 5th order and 3rd operators are used in<a name='10884'></font>
<font color=#447700>!  place of the 6th and 4th order operators<a name='10885'></font>
<a name='10886'>
<font color=#447700>!  determine boundary mods for flux operators<a name='10887'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='10888'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='10889'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='10890'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='10891'></font>
<font color=#447700>!   of the higher order flux stencils<a name='10892'></font>
<a name='10893'>
   degrade_xs = .true.<a name='10894'>
   degrade_xe = .true.<a name='10895'>
   degrade_ys = .true.<a name='10896'>
   degrade_ye = .true.<a name='10897'>
<a name='10898'>
   IF( config_flags%periodic_x   .or. &amp;<a name='10899'>
       config_flags%symmetric_xs .or. &amp;<a name='10900'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='10901'>
   IF( config_flags%periodic_x   .or. &amp;<a name='10902'>
       config_flags%symmetric_xe .or. &amp;<a name='10903'>
       (ite &lt; ide-2)                ) degrade_xe = .false.<a name='10904'>
   IF( config_flags%periodic_y   .or. &amp;<a name='10905'>
       config_flags%symmetric_ys .or. &amp;<a name='10906'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='10907'>
   IF( config_flags%periodic_y   .or. &amp;<a name='10908'>
       config_flags%symmetric_ye .or. &amp;<a name='10909'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='10910'>
<a name='10911'>
<font color=#447700>!--------------- y - advection first<a name='10912'></font>
<a name='10913'>
      i_start = its<a name='10914'>
      i_end   = ite<a name='10915'>
      IF ( config_flags%open_xs .or. specified ) i_start = MAX(ids+1,its)<a name='10916'>
      IF ( config_flags%open_xe .or. specified ) i_end   = MIN(ide-1,ite)<a name='10917'>
      IF ( config_flags%periodic_x ) i_start = its<a name='10918'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='10919'>
<a name='10920'>
      j_start = jts<a name='10921'>
      j_end   = MIN(jte,jde-1)<a name='10922'>
<a name='10923'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='10924'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='10925'></font>
<a name='10926'>
      j_start_f = j_start<a name='10927'>
      j_end_f   = j_end+1<a name='10928'>
<a name='10929'>
      IF(degrade_ys) then<a name='10930'>
        j_start = MAX(jts,jds+1)<a name='10931'>
        j_start_f = jds+3<a name='10932'>
      ENDIF<a name='10933'>
<a name='10934'>
      IF(degrade_ye) then<a name='10935'>
        j_end = MIN(jte,jde-2)<a name='10936'>
        j_end_f = jde-3<a name='10937'>
      ENDIF<a name='10938'>
<a name='10939'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='10940'>
<a name='10941'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='10942'></font>
<a name='10943'>
     jp1 = 2<a name='10944'>
     jp0 = 1<a name='10945'>
<a name='10946'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='10947'>
<a name='10948'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN  <font color=#447700>! use full stencil<a name='10949'></font>
<a name='10950'>
        DO k=kts,ktf<a name='10951'>
        DO i = i_start, i_end<a name='10952'>
          vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='10953'>
<a name='10954'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='10955'>
            qip2 = u(i,k,j+1)<a name='10956'>
            qip1 = u(i,k,j  )<a name='10957'>
            qi   = u(i,k,j-1)<a name='10958'>
            qim1 = u(i,k,j-2)<a name='10959'>
            qim2 = u(i,k,j-3)<a name='10960'>
          ELSE<a name='10961'>
            qip2 = u(i,k,j-2)<a name='10962'>
            qip1 = u(i,k,j-1)<a name='10963'>
            qi   = u(i,k,j  )<a name='10964'>
            qim1 = u(i,k,j+1)<a name='10965'>
            qim2 = u(i,k,j+2)<a name='10966'>
         ENDIF<a name='10967'>
    <a name='10968'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='10969'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='10970'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='10971'>
    <a name='10972'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='10973'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='10974'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='10975'>
    <a name='10976'>
         wi0 = gi0 / (eps + beta0)**pw<a name='10977'>
         wi1 = gi1 / (eps + beta1)**pw<a name='10978'>
         wi2 = gi2 / (eps + beta2)**pw<a name='10979'>
    <a name='10980'>
         sumwk = wi0 + wi1 + wi2<a name='10981'>
    <a name='10982'>
          fqy( i, k, jp1 ) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='10983'>
<a name='10984'>
<font color=#447700>!          fqy( i, k, jp1 ) = vel*flux5(               &amp;<a name='10985'></font>
<font color=#447700>!                  u(i,k,j-3), u(i,k,j-2), u(i,k,j-1),       &amp;<a name='10986'></font>
<font color=#447700>!                  u(i,k,j  ), u(i,k,j+1), u(i,k,j+2),  vel )<a name='10987'></font>
        ENDDO<a name='10988'>
        ENDDO<a name='10989'>
<a name='10990'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='10991'></font>
<a name='10992'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='10993'></font>
<a name='10994'>
            DO k=kts,ktf<a name='10995'>
            DO i = i_start, i_end<a name='10996'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))  &amp;<a name='10997'>
                                     *(u(i,k,j)+u(i,k,j-1))<a name='10998'>
            ENDDO<a name='10999'>
            ENDDO<a name='11000'>
<a name='11001'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='11002'></font>
<a name='11003'>
            DO k=kts,ktf<a name='11004'>
            DO i = i_start, i_end<a name='11005'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='11006'>
              fqy( i, k, jp1 ) = vel*flux3(      &amp;<a name='11007'>
                   u(i,k,j-2),u(i,k,j-1), u(i,k,j),u(i,k,j+1),vel )<a name='11008'>
            ENDDO<a name='11009'>
            ENDDO<a name='11010'>
<a name='11011'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='11012'></font>
<a name='11013'>
            DO k=kts,ktf<a name='11014'>
            DO i = i_start, i_end<a name='11015'>
              fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i-1,k,j))    &amp;<a name='11016'>
                     *(u(i,k,j)+u(i,k,j-1))<a name='11017'>
            ENDDO<a name='11018'>
            ENDDO<a name='11019'>
<a name='11020'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd order flux 2 in from north boundary<a name='11021'></font>
<a name='11022'>
            DO k=kts,ktf<a name='11023'>
            DO i = i_start, i_end<a name='11024'>
              vel = 0.5*(rv(i,k,j)+rv(i-1,k,j))<a name='11025'>
              fqy( i, k, jp1 ) = vel*flux3(     &amp;<a name='11026'>
                   u(i,k,j-2),u(i,k,j-1),    &amp;<a name='11027'>
                   u(i,k,j),u(i,k,j+1),vel )<a name='11028'>
            ENDDO<a name='11029'>
            ENDDO<a name='11030'>
<a name='11031'>
      END IF<a name='11032'>
<a name='11033'>
<font color=#447700>!  y flux-divergence into tendency<a name='11034'></font>
<a name='11035'>
        <font color=#447700>! (j &gt; j_start) will miss the u(,,jds) tendency<a name='11036'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='11037'>
          DO k=kts,ktf<a name='11038'>
          DO i = i_start, i_end<a name='11039'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='11040'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='11041'>
          END DO<a name='11042'>
          END DO<a name='11043'>
        <font color=#447700>! This would be seen by (j &gt; j_start) but we need to zero out the NP tendency<a name='11044'></font>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='11045'>
          DO k=kts,ktf<a name='11046'>
          DO i = i_start, i_end<a name='11047'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='11048'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='11049'>
          END DO<a name='11050'>
          END DO<a name='11051'>
        ELSE  <font color=#447700>! normal code<a name='11052'></font>
<a name='11053'>
        IF(j &gt; j_start) THEN<a name='11054'>
<a name='11055'>
          DO k=kts,ktf<a name='11056'>
          DO i = i_start, i_end<a name='11057'>
            mrdy=msfux(i,j-1)*rdy   <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='11058'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='11059'>
          ENDDO<a name='11060'>
          ENDDO<a name='11061'>
<a name='11062'>
        ENDIF<a name='11063'>
<a name='11064'>
        END IF<a name='11065'>
<a name='11066'>
<a name='11067'>
        jtmp = jp1<a name='11068'>
        jp1 = jp0<a name='11069'>
        jp0 = jtmp<a name='11070'>
<a name='11071'>
   ENDDO j_loop_y_flux_5<a name='11072'>
<a name='11073'>
<font color=#447700>!  next, x - flux divergence<a name='11074'></font>
<a name='11075'>
      i_start = its<a name='11076'>
      i_end   = ite<a name='11077'>
<a name='11078'>
      j_start = jts<a name='11079'>
      j_end   = MIN(jte,jde-1)<a name='11080'>
<a name='11081'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='11082'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='11083'></font>
<a name='11084'>
      i_start_f = i_start<a name='11085'>
      i_end_f   = i_end+1<a name='11086'>
<a name='11087'>
      IF(degrade_xs) then<a name='11088'>
        i_start = MAX(ids+1,its)<a name='11089'>
        i_start_f = ids+3<a name='11090'>
      ENDIF<a name='11091'>
<a name='11092'>
      IF(degrade_xe) then<a name='11093'>
        i_end = MIN(ide-1,ite)<a name='11094'>
        i_end_f = ide-2<a name='11095'>
      ENDIF<a name='11096'>
<a name='11097'>
<font color=#447700>!  compute fluxes<a name='11098'></font>
<a name='11099'>
      DO j = j_start, j_end<a name='11100'>
<a name='11101'>
<font color=#447700>!  5th or 6th order flux<a name='11102'></font>
<a name='11103'>
        DO k=kts,ktf<a name='11104'>
        DO i = i_start_f, i_end_f<a name='11105'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='11106'>
<a name='11107'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='11108'>
            qip2 = u(i+1,k,j)<a name='11109'>
            qip1 = u(i,  k,j)<a name='11110'>
            qi   = u(i-1,k,j)<a name='11111'>
            qim1 = u(i-2,k,j)<a name='11112'>
            qim2 = u(i-3,k,j)<a name='11113'>
          ELSE<a name='11114'>
            qip2 = u(i-2,k,j)<a name='11115'>
            qip1 = u(i-1,k,j)<a name='11116'>
            qi   = u(i,  k,j)<a name='11117'>
            qim1 = u(i+1,k,j)<a name='11118'>
            qim2 = u(i+2,k,j)<a name='11119'>
         ENDIF<a name='11120'>
    <a name='11121'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='11122'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='11123'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='11124'>
    <a name='11125'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='11126'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='11127'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='11128'>
    <a name='11129'>
         wi0 = gi0 / (eps + beta0)**pw<a name='11130'>
         wi1 = gi1 / (eps + beta1)**pw<a name='11131'>
         wi2 = gi2 / (eps + beta2)**pw<a name='11132'>
    <a name='11133'>
         sumwk = wi0 + wi1 + wi2<a name='11134'>
    <a name='11135'>
         fqx(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='11136'>
<a name='11137'>
<font color=#447700>!          fqx( i,k ) = vel*flux5( u(i-3,k,j), u(i-2,k,j),  &amp;<a name='11138'></font>
<font color=#447700>!                                         u(i-1,k,j), u(i  ,k,j),  &amp;<a name='11139'></font>
<font color=#447700>!                                         u(i+1,k,j), u(i+2,k,j),  &amp;<a name='11140'></font>
<font color=#447700>!                                         vel                     )<a name='11141'></font>
        ENDDO<a name='11142'>
        ENDDO<a name='11143'>
<a name='11144'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='11145'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='11146'></font>
<a name='11147'>
        IF( degrade_xs ) THEN<a name='11148'>
<a name='11149'>
          IF( i_start == ids+1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='11150'></font>
            i = ids+1<a name='11151'>
            DO k=kts,ktf<a name='11152'>
              ub = u(i-1,k,j)<a name='11153'>
              IF (specified .AND. u(i,k,j) .LT. 0.)ub = u(i,k,j)<a name='11154'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='11155'>
                     *(u(i,k,j)+ub)<a name='11156'>
            ENDDO<a name='11157'>
          END IF<a name='11158'>
<a name='11159'>
          i = ids+2<a name='11160'>
          DO k=kts,ktf<a name='11161'>
            vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='11162'>
            fqx( i, k  ) = vel*flux3( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='11163'>
                                           u(i  ,k,j), u(i+1,k,j),  &amp;<a name='11164'>
                                           vel                     )<a name='11165'>
          ENDDO<a name='11166'>
<a name='11167'>
        ENDIF<a name='11168'>
<a name='11169'>
        IF( degrade_xe ) THEN<a name='11170'>
<a name='11171'>
          IF( i_end == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='11172'></font>
            i = ide<a name='11173'>
            DO k=kts,ktf<a name='11174'>
              ub = u(i,k,j)<a name='11175'>
              IF (specified .AND. u(i-1,k,j) .GT. 0.)ub = u(i-1,k,j)<a name='11176'>
              fqx(i, k) = 0.25*(ru(i,k,j)+ru(i-1,k,j)) &amp;<a name='11177'>
                     *(u(i-1,k,j)+ub)<a name='11178'>
            ENDDO<a name='11179'>
          ENDIF<a name='11180'>
<a name='11181'>
          DO k=kts,ktf<a name='11182'>
          i = ide-1<a name='11183'>
          vel = 0.5*(ru(i,k,j)+ru(i-1,k,j))<a name='11184'>
          fqx( i,k ) = vel*flux3( u(i-2,k,j), u(i-1,k,j),  &amp;<a name='11185'>
                                         u(i  ,k,j), u(i+1,k,j),  &amp;<a name='11186'>
                                         vel                     )<a name='11187'>
          ENDDO<a name='11188'>
<a name='11189'>
        ENDIF<a name='11190'>
<a name='11191'>
<font color=#447700>!  x flux-divergence into tendency<a name='11192'></font>
<a name='11193'>
        DO k=kts,ktf<a name='11194'>
          DO i = i_start, i_end<a name='11195'>
            mrdx=msfux(i,j)*rdx <font color=#447700>! ADT eqn 44, 1st term on RHS<a name='11196'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='11197'>
          ENDDO<a name='11198'>
        ENDDO<a name='11199'>
<a name='11200'>
      ENDDO<a name='11201'>
<a name='11202'>
<a name='11203'>
<font color=#447700>!  radiative lateral boundary condition in x for normal velocity (u)<a name='11204'></font>
<a name='11205'>
      IF ( (config_flags%open_xs) .and. its == ids ) THEN<a name='11206'>
<a name='11207'>
        j_start = jts<a name='11208'>
        j_end   = MIN(jte,jde-1)<a name='11209'>
<a name='11210'>
        DO j = j_start, j_end<a name='11211'>
        DO k = kts, ktf<a name='11212'>
          ub = MIN(ru(its,k,j)-cb*mut(its,j), 0.)<a name='11213'>
          tendency(its,k,j) = tendency(its,k,j)                    &amp;<a name='11214'>
                      - rdx*ub*(u_old(its+1,k,j) - u_old(its,k,j))<a name='11215'>
        ENDDO<a name='11216'>
        ENDDO<a name='11217'>
<a name='11218'>
      ENDIF<a name='11219'>
<a name='11220'>
      IF ( (config_flags%open_xe) .and. ite == ide ) THEN<a name='11221'>
<a name='11222'>
        j_start = jts<a name='11223'>
        j_end   = MIN(jte,jde-1)<a name='11224'>
<a name='11225'>
        DO j = j_start, j_end<a name='11226'>
        DO k = kts, ktf<a name='11227'>
          ub = MAX(ru(ite,k,j)+cb*mut(ite-1,j), 0.)<a name='11228'>
          tendency(ite,k,j) = tendency(ite,k,j)                    &amp;<a name='11229'>
                      - rdx*ub*(u_old(ite,k,j) - u_old(ite-1,k,j))<a name='11230'>
        ENDDO<a name='11231'>
        ENDDO<a name='11232'>
<a name='11233'>
      ENDIF<a name='11234'>
<a name='11235'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='11236'></font>
<font color=#447700>!  (these are the computations that don't require 'cb')<a name='11237'></font>
<font color=#447700>!  first, set to index ranges<a name='11238'></font>
<a name='11239'>
      i_start = its<a name='11240'>
      i_end   = MIN(ite,ide)<a name='11241'>
      imin    = ids<a name='11242'>
      imax    = ide-1<a name='11243'>
<a name='11244'>
      IF (config_flags%open_xs) THEN<a name='11245'>
        i_start = MAX(ids+1, its)<a name='11246'>
        imin = ids<a name='11247'>
      ENDIF<a name='11248'>
      IF (config_flags%open_xe) THEN<a name='11249'>
        i_end = MIN(ite,ide-1)<a name='11250'>
        imax = ide-1<a name='11251'>
      ENDIF<a name='11252'>
<a name='11253'>
   IF( (config_flags%open_ys) .and. (jts == jds)) THEN<a name='11254'>
<a name='11255'>
      DO i = i_start, i_end<a name='11256'>
<a name='11257'>
         mrdy=msfux(i,jts)*rdy       <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='11258'></font>
         ip = MIN( imax, i   )<a name='11259'>
         im = MAX( imin, i-1 )<a name='11260'>
<a name='11261'>
         DO k=kts,ktf<a name='11262'>
<a name='11263'>
          vw = 0.5*(rv(ip,k,jts)+rv(im,k,jts))<a name='11264'>
          vb = MIN( vw, 0. )<a name='11265'>
          dvm =  rv(ip,k,jts+1)-rv(ip,k,jts)<a name='11266'>
          dvp =  rv(im,k,jts+1)-rv(im,k,jts)<a name='11267'>
          tendency(i,k,jts)=tendency(i,k,jts)-mrdy*(                &amp;<a name='11268'>
                            vb*(u_old(i,k,jts+1)-u_old(i,k,jts))    &amp;<a name='11269'>
                           +0.5*u(i,k,jts)*(dvm+dvp))<a name='11270'>
         ENDDO<a name='11271'>
      ENDDO<a name='11272'>
<a name='11273'>
   ENDIF<a name='11274'>
<a name='11275'>
   IF( (config_flags%open_ye) .and. (jte == jde)) THEN<a name='11276'>
<a name='11277'>
      DO i = i_start, i_end<a name='11278'>
<a name='11279'>
         mrdy=msfux(i,jte-1)*rdy     <font color=#447700>! ADT eqn 44, 2nd term on RHS<a name='11280'></font>
         ip = MIN( imax, i   )<a name='11281'>
         im = MAX( imin, i-1 )<a name='11282'>
<a name='11283'>
         DO k=kts,ktf<a name='11284'>
<a name='11285'>
          vw = 0.5*(rv(ip,k,jte)+rv(im,k,jte))<a name='11286'>
          vb = MAX( vw, 0. )<a name='11287'>
          dvm =  rv(ip,k,jte)-rv(ip,k,jte-1)<a name='11288'>
          dvp =  rv(im,k,jte)-rv(im,k,jte-1)<a name='11289'>
          tendency(i,k,jte-1)=tendency(i,k,jte-1)-mrdy*(              &amp;<a name='11290'>
                              vb*(u_old(i,k,jte-1)-u_old(i,k,jte-2))  &amp;<a name='11291'>
                             +0.5*u(i,k,jte-1)*(dvm+dvp))<a name='11292'>
         ENDDO<a name='11293'>
      ENDDO<a name='11294'>
<a name='11295'>
   ENDIF<a name='11296'>
<a name='11297'>
<font color=#447700>!-------------------- vertical advection<a name='11298'></font>
<font color=#447700>!  ADT eqn 44 has 3rd term on RHS = -(1/my) partial d/dz (rho u w)<a name='11299'></font>
<font color=#447700>!  Here we have:  - partial d/dz (u*rom) = - partial d/dz (u rho w / my)<a name='11300'></font>
<font color=#447700>!  Since 'my' (map scale factor in y-direction) isn't a function of z,<a name='11301'></font>
<font color=#447700>!  this is what we need, so leave unchanged in advect_u<a name='11302'></font>
<a name='11303'>
   i_start = its<a name='11304'>
   i_end   = ite<a name='11305'>
   j_start = jts<a name='11306'>
   j_end   = min(jte,jde-1)<a name='11307'>
<a name='11308'>
<font color=#447700>!   IF ( config_flags%open_xs ) i_start = MAX(ids+1,its)<a name='11309'></font>
<font color=#447700>!   IF ( config_flags%open_xe ) i_end   = MIN(ide-1,ite)<a name='11310'></font>
<a name='11311'>
   IF ( config_flags%open_ys .or. specified ) i_start = MAX(ids+1,its)<a name='11312'>
   IF ( config_flags%open_ye .or. specified ) i_end   = MIN(ide-1,ite)<a name='11313'>
      IF ( config_flags%periodic_x ) i_start = its<a name='11314'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='11315'>
<a name='11316'>
   DO i = i_start, i_end<a name='11317'>
     vflux(i,kts)=0.<a name='11318'>
     vflux(i,kte)=0.<a name='11319'>
   ENDDO<a name='11320'>
<a name='11321'>
<font color=#447700>!   vert_order_test : IF (vert_order == 6) THEN    <a name='11322'></font>
<a name='11323'>
<font color=#447700>!    ELSE IF (vert_order == 5) THEN    <a name='11324'></font>
<a name='11325'>
      DO j = j_start, j_end<a name='11326'>
<a name='11327'>
         DO k=kts+3,ktf-2<a name='11328'>
         DO i = i_start, i_end<a name='11329'>
           vel=0.5*(rom(i-1,k,j)+rom(i,k,j))<a name='11330'>
<a name='11331'>
         IF( -vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='11332'>
            qip2 = u(i,k+1,j)<a name='11333'>
            qip1 = u(i,k  ,j)<a name='11334'>
            qi   = u(i,k-1,j)<a name='11335'>
            qim1 = u(i,k-2,j)<a name='11336'>
            qim2 = u(i,k-3,j)<a name='11337'>
          ELSE<a name='11338'>
            qip2 = u(i,k-2,j)<a name='11339'>
            qip1 = u(i,k-1,j)<a name='11340'>
            qi   = u(i,k  ,j)<a name='11341'>
            qim1 = u(i,k+1,j)<a name='11342'>
            qim2 = u(i,k+2,j)<a name='11343'>
         ENDIF<a name='11344'>
    <a name='11345'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='11346'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='11347'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='11348'>
    <a name='11349'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='11350'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='11351'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='11352'>
    <a name='11353'>
         wi0 = gi0 / (eps + beta0)**pw<a name='11354'>
         wi1 = gi1 / (eps + beta1)**pw<a name='11355'>
         wi2 = gi2 / (eps + beta2)**pw<a name='11356'>
    <a name='11357'>
         sumwk = wi0 + wi1 + wi2<a name='11358'>
    <a name='11359'>
          vflux(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='11360'>
<a name='11361'>
<font color=#447700>!           vflux(i,k) = vel*flux5(                     &amp;<a name='11362'></font>
<font color=#447700>!                   u(i,k-3,j), u(i,k-2,j), u(i,k-1,j),       &amp;<a name='11363'></font>
<font color=#447700>!                   u(i,k  ,j), u(i,k+1,j), u(i,k+2,j),  -vel )<a name='11364'></font>
         ENDDO<a name='11365'>
         ENDDO<a name='11366'>
<a name='11367'>
         DO i = i_start, i_end<a name='11368'>
<a name='11369'>
           k=kts+1<a name='11370'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j))  &amp;<a name='11371'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='11372'>
           k = kts+2<a name='11373'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='11374'>
           vflux(i,k) = vel*flux3(       &amp;<a name='11375'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='11376'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='11377'>
           k = ktf-1<a name='11378'>
           vel=0.5*(rom(i,k,j)+rom(i-1,k,j)) <a name='11379'>
           vflux(i,k) = vel*flux3(       &amp;<a name='11380'>
                   u(i,k-2,j), u(i,k-1,j),   &amp;<a name='11381'>
                   u(i,k  ,j), u(i,k+1,j), -vel )<a name='11382'>
           k=ktf<a name='11383'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i-1,k,j)) &amp;<a name='11384'>
                                   *(fzm(k)*u(i,k,j)+fzp(k)*u(i,k-1,j))<a name='11385'>
<a name='11386'>
         ENDDO<a name='11387'>
         DO k=kts,ktf<a name='11388'>
         DO i = i_start, i_end<a name='11389'>
            tendency(i,k,j)=tendency(i,k,j)-rdzw(k)*(vflux(i,k+1)-vflux(i,k))<a name='11390'>
         ENDDO<a name='11391'>
         ENDDO<a name='11392'>
      ENDDO<a name='11393'>
<a name='11394'>
<a name='11395'>
END SUBROUTINE advect_weno_u<a name='11396'>
<a name='11397'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='11398'></font>
<a name='11399'>
<A NAME='ADVECT_WENO_V'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_WENO_V' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11400'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_weno_v</font>   ( v, v_old, tendency,            &amp; <A href='../../call_to/ADVECT_WENO_V.html' TARGET='index'>1</A><a name='11401'>
                        ru, rv, rom,                   &amp;<a name='11402'>
                        c1, c2,                        &amp;<a name='11403'>
                        mut, time_step, config_flags,  &amp;<a name='11404'>
                        msfux, msfuy, msfvx, msfvy,    &amp;<a name='11405'>
                        msftx, msfty,                  &amp;<a name='11406'>
                        fzm, fzp,                      &amp;<a name='11407'>
                        rdx, rdy, rdzw,                &amp;<a name='11408'>
                        ids, ide, jds, jde, kds, kde,  &amp;<a name='11409'>
                        ims, ime, jms, jme, kms, kme,  &amp;<a name='11410'>
                        its, ite, jts, jte, kts, kte  )<a name='11411'>
<a name='11412'>
<font color=#447700>!<a name='11413'></font>
<font color=#447700>! 5th-order WENO (Weighted Essentially Non-Oscillatory) scheme adapted from COMMAS.  <a name='11414'></font>
<font color=#447700>! See Jiang and Shu, 1996, J. Comp. Phys. v. 126, 202-223; <a name='11415'></font>
<font color=#447700>! Shu 2003, Int. J. Comp. Fluid Dyn. v. 17 107-118;  Also used by Bryan 2005, Mon. Wea. Rev.<a name='11416'></font>
<font color=#447700>!<a name='11417'></font>
<a name='11418'>
   IMPLICIT NONE<a name='11419'>
   <a name='11420'>
   <font color=#447700>! Input data<a name='11421'></font>
   <a name='11422'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='11423'>
<a name='11424'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='11425'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='11426'>
                                              its, ite, jts, jte, kts, kte<a name='11427'>
<a name='11428'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: v,     &amp;<a name='11429'>
                                                                      v_old, &amp;<a name='11430'>
                                                                      ru,    &amp;<a name='11431'>
                                                                      rv,    &amp;<a name='11432'>
                                                                      rom<a name='11433'>
<a name='11434'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='11435'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='11436'>
<a name='11437'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='11438'>
                                                                    msfuy,  &amp;<a name='11439'>
                                                                    msfvx,  &amp;<a name='11440'>
                                                                    msfvy,  &amp;<a name='11441'>
                                                                    msftx,  &amp;<a name='11442'>
                                                                    msfty<a name='11443'>
<a name='11444'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='11445'>
                                                                  fzp,  &amp;<a name='11446'>
                                                                  rdzw, &amp;<a name='11447'>
                                                                  c1,   &amp;<a name='11448'>
                                                                  c2<a name='11449'>
<a name='11450'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='11451'>
                                                                  rdy<a name='11452'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='11453'>
<a name='11454'>
<a name='11455'>
   <font color=#447700>! Local data<a name='11456'></font>
   <a name='11457'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='11458'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='11459'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='11460'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='11461'>
<a name='11462'>
    real            :: dir, vv<a name='11463'>
    real            :: ue,vs,vn,wb,wt<a name='11464'>
    real, parameter :: f30 =  7./12., f31 = 1./12.<a name='11465'>
    real, parameter :: f50 = 37./60., f51 = 2./15., f52 = 1./60.<a name='11466'>
<a name='11467'>
<a name='11468'>
   integer kt,kb<a name='11469'>
   <a name='11470'>
    <a name='11471'>
    real               :: qim2, qim1, qi, qip1, qip2<a name='11472'>
    double precision               :: beta0, beta1, beta2, f0, f1, f2, wi0, wi1, wi2, sumwk<a name='11473'>
    double precision, parameter    :: gi0 = 1.d0/10.d0, gi1 = 6.d0/10.d0, gi2 = 3.d0/10.d0, eps=1.0d-18<a name='11474'>
    integer, parameter :: pw = 2<a name='11475'>
<a name='11476'>
<a name='11477'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw, dup, dum<a name='11478'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='11479'>
<a name='11480'>
<a name='11481'>
   REAL,  DIMENSION( its:ite+1, kts:kte ) :: fqx<a name='11482'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='11483'>
<a name='11484'>
   INTEGER :: horz_order<a name='11485'>
   INTEGER :: vert_order<a name='11486'>
   <a name='11487'>
   LOGICAL :: degrade_xs, degrade_ys<a name='11488'>
   LOGICAL :: degrade_xe, degrade_ye<a name='11489'>
<a name='11490'>
   INTEGER :: jp1, jp0, jtmp<a name='11491'>
<a name='11492'>
<a name='11493'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='11494'></font>
<a name='11495'>
   REAL    :: flux3, flux4, flux5, flux6<a name='11496'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='11497'>
<a name='11498'>
   flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='11499'>
          ( 7.*(q_i + q_im1) - (q_ip1 + q_im2) )/12.0<a name='11500'>
<a name='11501'>
   flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='11502'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='11503'>
           sign(1,time_step)*sign(1.,ua)*((q_ip1 - q_im2)-3.*(q_i-q_im1))/12.0<a name='11504'>
<a name='11505'>
   flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='11506'>
                      ( 37.*(q_i+q_im1) - 8.*(q_ip1+q_im2)   &amp;<a name='11507'>
                     +(q_ip2+q_im3) )/60.0<a name='11508'>
<a name='11509'>
   flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='11510'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='11511'>
            -sign(1,time_step)*sign(1.,ua)*(                    &amp;<a name='11512'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )/60.0<a name='11513'>
<a name='11514'>
<a name='11515'>
<a name='11516'>
   LOGICAL :: specified<a name='11517'>
<a name='11518'>
   specified = .false.<a name='11519'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='11520'>
<a name='11521'>
<font color=#447700>! set order for the advection schemes<a name='11522'></font>
<a name='11523'>
   ktf=MIN(kte,kde-1)<a name='11524'>
   horz_order = config_flags%h_mom_adv_order<a name='11525'>
   vert_order = config_flags%v_mom_adv_order<a name='11526'>
<a name='11527'>
<a name='11528'>
<font color=#447700>!  here is the choice of flux operators<a name='11529'></font>
<a name='11530'>
<a name='11531'>
<font color=#447700>!   horizontal_order_test : IF( horz_order == 6 ) THEN<a name='11532'></font>
<font color=#447700>!   ELSE IF( horz_order == 5 ) THEN<a name='11533'></font>
<a name='11534'>
<font color=#447700>!  5th order horizontal flux calculation<a name='11535'></font>
<font color=#447700>!  This code is EXACTLY the same as the 6th order code<a name='11536'></font>
<font color=#447700>!  EXCEPT the 5th order and 3rd operators are used in<a name='11537'></font>
<font color=#447700>!  place of the 6th and 4th order operators<a name='11538'></font>
<a name='11539'>
<font color=#447700>!  determine boundary mods for flux operators<a name='11540'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='11541'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='11542'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='11543'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='11544'></font>
<font color=#447700>!   of the higher order flux stencils<a name='11545'></font>
<a name='11546'>
   degrade_xs = .true.<a name='11547'>
   degrade_xe = .true.<a name='11548'>
   degrade_ys = .true.<a name='11549'>
   degrade_ye = .true.<a name='11550'>
<a name='11551'>
   IF( config_flags%periodic_x   .or. &amp;<a name='11552'>
       config_flags%symmetric_xs .or. &amp;<a name='11553'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='11554'>
   IF( config_flags%periodic_x   .or. &amp;<a name='11555'>
       config_flags%symmetric_xe .or. &amp;<a name='11556'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='11557'>
   IF( config_flags%periodic_y   .or. &amp;<a name='11558'>
       config_flags%symmetric_ys .or. &amp;<a name='11559'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='11560'>
   IF( config_flags%periodic_y   .or. &amp;<a name='11561'>
       config_flags%symmetric_ye .or. &amp;<a name='11562'>
       (jte &lt; jde-3)                ) degrade_ye = .false.<a name='11563'>
<a name='11564'>
<font color=#447700>!--------------- y - advection first<a name='11565'></font>
<a name='11566'>
      i_start = its<a name='11567'>
      i_end   = MIN(ite,ide-1)<a name='11568'>
      j_start = jts<a name='11569'>
      j_end   = jte<a name='11570'>
<a name='11571'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='11572'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='11573'></font>
<a name='11574'>
      j_start_f = j_start<a name='11575'>
      j_end_f   = j_end+1<a name='11576'>
<a name='11577'>
      IF(degrade_ys) then<a name='11578'>
        j_start = MAX(jts,jds+1)<a name='11579'>
        j_start_f = jds+3<a name='11580'>
      ENDIF<a name='11581'>
<a name='11582'>
      IF(degrade_ye) then<a name='11583'>
        j_end = MIN(jte,jde-1)<a name='11584'>
        j_end_f = jde-2<a name='11585'>
      ENDIF<a name='11586'>
<a name='11587'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='11588'></font>
<a name='11589'>
     jp1 = 2<a name='11590'>
     jp0 = 1<a name='11591'>
<a name='11592'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='11593'>
<a name='11594'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='11595'>
<a name='11596'>
        DO k=kts,ktf<a name='11597'>
        DO i = i_start, i_end<a name='11598'>
          vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='11599'>
<a name='11600'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='11601'>
            qip2 = v(i,k,j+1)<a name='11602'>
            qip1 = v(i,k,j  )<a name='11603'>
            qi   = v(i,k,j-1)<a name='11604'>
            qim1 = v(i,k,j-2)<a name='11605'>
            qim2 = v(i,k,j-3)<a name='11606'>
          ELSE<a name='11607'>
            qip2 = v(i,k,j-2)<a name='11608'>
            qip1 = v(i,k,j-1)<a name='11609'>
            qi   = v(i,k,j  )<a name='11610'>
            qim1 = v(i,k,j+1)<a name='11611'>
            qim2 = v(i,k,j+2)<a name='11612'>
         ENDIF<a name='11613'>
    <a name='11614'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='11615'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='11616'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='11617'>
    <a name='11618'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='11619'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='11620'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='11621'>
    <a name='11622'>
         wi0 = gi0 / (eps + beta0)**pw<a name='11623'>
         wi1 = gi1 / (eps + beta1)**pw<a name='11624'>
         wi2 = gi2 / (eps + beta2)**pw<a name='11625'>
    <a name='11626'>
         sumwk = wi0 + wi1 + wi2<a name='11627'>
    <a name='11628'>
          fqy( i, k, jp1 ) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='11629'>
<a name='11630'>
<a name='11631'>
<a name='11632'>
<font color=#447700>!          fqy( i, k, jp1 ) = vel*flux5(               &amp;<a name='11633'></font>
<font color=#447700>!                  v(i,k,j-3), v(i,k,j-2), v(i,k,j-1),       &amp;<a name='11634'></font>
<font color=#447700>!                  v(i,k,j  ), v(i,k,j+1), v(i,k,j+2),  vel )<a name='11635'></font>
        ENDDO<a name='11636'>
        ENDDO<a name='11637'>
<a name='11638'>
<font color=#447700>!  we must be close to some boundary where we need to reduce the order of the stencil<a name='11639'></font>
<font color=#447700>!  specified uses upstream normal wind at boundaries<a name='11640'></font>
<a name='11641'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='11642'></font>
<a name='11643'>
            DO k=kts,ktf<a name='11644'>
            DO i = i_start, i_end<a name='11645'>
                vb = v(i,k,j-1)<a name='11646'>
                IF (specified .AND. v(i,k,j) .LT. 0.)vb = v(i,k,j)<a name='11647'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))  &amp;<a name='11648'>
                                 *(v(i,k,j)+vb)<a name='11649'>
            ENDDO<a name='11650'>
            ENDDO<a name='11651'>
<a name='11652'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='11653'></font>
<a name='11654'>
            DO k=kts,ktf<a name='11655'>
            DO i = i_start, i_end<a name='11656'>
              vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='11657'>
              fqy( i, k, jp1 ) = vel*flux3(      &amp;<a name='11658'>
                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='11659'>
            ENDDO<a name='11660'>
            ENDDO<a name='11661'>
<a name='11662'>
<a name='11663'>
     ELSE IF ( j == jde ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='11664'></font>
<a name='11665'>
            DO k=kts,ktf<a name='11666'>
            DO i = i_start, i_end<a name='11667'>
                vb = v(i,k,j)<a name='11668'>
                IF (specified .AND. v(i,k,j-1) .GT. 0.)vb = v(i,k,j-1)<a name='11669'>
                fqy(i, k, jp1) = 0.25*(rv(i,k,j)+rv(i,k,j-1))    &amp;<a name='11670'>
                                 *(vb+v(i,k,j-1))<a name='11671'>
            ENDDO<a name='11672'>
            ENDDO<a name='11673'>
<a name='11674'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='11675'></font>
<a name='11676'>
            DO k=kts,ktf<a name='11677'>
            DO i = i_start, i_end<a name='11678'>
              vel = 0.5*(rv(i,k,j)+rv(i,k,j-1))<a name='11679'>
              fqy( i, k, jp1 ) = vel*flux3(     &amp;<a name='11680'>
                   v(i,k,j-2),v(i,k,j-1),v(i,k,j),v(i,k,j+1),vel )<a name='11681'>
            ENDDO<a name='11682'>
            ENDDO<a name='11683'>
<a name='11684'>
      END IF<a name='11685'>
<a name='11686'>
<font color=#447700>!  y flux-divergence into tendency<a name='11687'></font>
<a name='11688'>
        <font color=#447700>! Comments on polar boundary conditions<a name='11689'></font>
        <font color=#447700>! No advection over the poles means tendencies (held from jds [S. pole]<a name='11690'></font>
        <font color=#447700>! to jde [N pole], i.e., on v grid) must be zero at poles<a name='11691'></font>
        <font color=#447700>! [tendency(jds) and tendency(jde)=0]<a name='11692'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='11693'>
          DO k=kts,ktf<a name='11694'>
          DO i = i_start, i_end<a name='11695'>
            tendency(i,k,j-1) = 0.<a name='11696'>
          END DO<a name='11697'>
          END DO<a name='11698'>
        <font color=#447700>! If j_end were set to jde in a special if statement apart from<a name='11699'></font>
        <font color=#447700>! degrade_ye, then we would hit the next conditional.  But since<a name='11700'></font>
        <font color=#447700>! we want the tendency to be zero anyway, not looping to jde+1<a name='11701'></font>
        <font color=#447700>! will produce the same effect.<a name='11702'></font>
        ELSE IF( config_flags%polar .AND. (j == jde+1) ) THEN<a name='11703'>
          DO k=kts,ktf<a name='11704'>
          DO i = i_start, i_end<a name='11705'>
            tendency(i,k,j-1) = 0.<a name='11706'>
          END DO<a name='11707'>
          END DO<a name='11708'>
        ELSE  <font color=#447700>! Normal code<a name='11709'></font>
<a name='11710'>
        IF(j &gt; j_start) THEN<a name='11711'>
<a name='11712'>
          DO k=kts,ktf<a name='11713'>
          DO i = i_start, i_end<a name='11714'>
            mrdy=msfvy(i,j-1)*rdy    <font color=#447700>! ADT eqn 45, 2nd term on RHS<a name='11715'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='11716'>
          ENDDO<a name='11717'>
          ENDDO<a name='11718'>
<a name='11719'>
        ENDIF<a name='11720'>
<a name='11721'>
        END IF<a name='11722'>
<a name='11723'>
        jtmp = jp1<a name='11724'>
        jp1 = jp0<a name='11725'>
        jp0 = jtmp<a name='11726'>
<a name='11727'>
   ENDDO j_loop_y_flux_5<a name='11728'>
<a name='11729'>
<font color=#447700>!  next, x - flux divergence<a name='11730'></font>
<a name='11731'>
      i_start = its<a name='11732'>
      i_end   = MIN(ite,ide-1)<a name='11733'>
<a name='11734'>
      j_start = jts<a name='11735'>
      j_end   = jte<a name='11736'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='11737'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='11738'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='11739'>
<a name='11740'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='11741'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='11742'></font>
<a name='11743'>
      i_start_f = i_start<a name='11744'>
      i_end_f   = i_end+1<a name='11745'>
<a name='11746'>
      IF(degrade_xs) then<a name='11747'>
        i_start = MAX(ids+1,its)<a name='11748'>
<font color=#447700>!        i_start_f = i_start+2<a name='11749'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='11750'>
      ENDIF<a name='11751'>
<a name='11752'>
      IF(degrade_xe) then<a name='11753'>
        i_end = MIN(ide-2,ite)<a name='11754'>
        i_end_f = ide-3<a name='11755'>
      ENDIF<a name='11756'>
<a name='11757'>
<font color=#447700>!  compute fluxes<a name='11758'></font>
<a name='11759'>
      DO j = j_start, j_end<a name='11760'>
<a name='11761'>
<font color=#447700>!  5th or 6th order flux<a name='11762'></font>
<a name='11763'>
        DO k=kts,ktf<a name='11764'>
        DO i = i_start_f, i_end_f<a name='11765'>
          vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='11766'>
<a name='11767'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='11768'>
            qip2 = v(i+1,k,j)<a name='11769'>
            qip1 = v(i,  k,j)<a name='11770'>
            qi   = v(i-1,k,j)<a name='11771'>
            qim1 = v(i-2,k,j)<a name='11772'>
            qim2 = v(i-3,k,j)<a name='11773'>
          ELSE<a name='11774'>
            qip2 = v(i-2,k,j)<a name='11775'>
            qip1 = v(i-1,k,j)<a name='11776'>
            qi   = v(i,  k,j)<a name='11777'>
            qim1 = v(i+1,k,j)<a name='11778'>
            qim2 = v(i+2,k,j)<a name='11779'>
         ENDIF<a name='11780'>
    <a name='11781'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='11782'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='11783'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='11784'>
    <a name='11785'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='11786'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='11787'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='11788'>
    <a name='11789'>
         wi0 = gi0 / (eps + beta0)**pw<a name='11790'>
         wi1 = gi1 / (eps + beta1)**pw<a name='11791'>
         wi2 = gi2 / (eps + beta2)**pw<a name='11792'>
    <a name='11793'>
         sumwk = wi0 + wi1 + wi2<a name='11794'>
    <a name='11795'>
         fqx(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='11796'>
<a name='11797'>
<font color=#447700>!          fqx( i, k ) = vel*flux5( v(i-3,k,j), v(i-2,k,j),  &amp;<a name='11798'></font>
<font color=#447700>!                                         v(i-1,k,j), v(i  ,k,j),  &amp;<a name='11799'></font>
<font color=#447700>!                                         v(i+1,k,j), v(i+2,k,j),  &amp;<a name='11800'></font>
<font color=#447700>!                                         vel                     )<a name='11801'></font>
        ENDDO<a name='11802'>
        ENDDO<a name='11803'>
<a name='11804'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='11805'></font>
<a name='11806'>
        IF( degrade_xs ) THEN<a name='11807'>
<a name='11808'>
          DO i=i_start,i_start_f-1<a name='11809'>
<a name='11810'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='11811'></font>
              DO k=kts,ktf<a name='11812'>
                fqx(i,k) = 0.25*(ru(i,k,j)+ru(i,k,j-1)) &amp;<a name='11813'>
                                *(v(i,k,j)+v(i-1,k,j))<a name='11814'>
              ENDDO<a name='11815'>
            ENDIF<a name='11816'>
<a name='11817'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='11818'></font>
              DO k=kts,ktf<a name='11819'>
                vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='11820'>
                fqx( i,k ) = vel*flux3( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='11821'>
                                        v(i  ,k,j), v(i+1,k,j),  &amp;<a name='11822'>
                                        vel                     )<a name='11823'>
              ENDDO<a name='11824'>
            ENDIF<a name='11825'>
<a name='11826'>
          ENDDO<a name='11827'>
<a name='11828'>
        ENDIF<a name='11829'>
<a name='11830'>
        IF( degrade_xe ) THEN<a name='11831'>
<a name='11832'>
          DO i = i_end_f+1, i_end+1<a name='11833'>
<a name='11834'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='11835'></font>
              DO k=kts,ktf<a name='11836'>
                fqx(i,k) = 0.25*(ru(i_end+1,k,j)+ru(i_end+1,k,j-1))      &amp;<a name='11837'>
                                *(v(i_end+1,k,j)+v(i_end,k,j))<a name='11838'>
              ENDDO<a name='11839'>
            ENDIF<a name='11840'>
<a name='11841'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='11842'></font>
              DO k=kts,ktf<a name='11843'>
                vel = 0.5*(ru(i,k,j)+ru(i,k,j-1))<a name='11844'>
                fqx( i,k ) = vel*flux3( v(i-2,k,j), v(i-1,k,j),  &amp;<a name='11845'>
                                        v(i  ,k,j), v(i+1,k,j),  &amp;<a name='11846'>
                                        vel                     )<a name='11847'>
              ENDDO<a name='11848'>
            ENDIF<a name='11849'>
<a name='11850'>
          ENDDO<a name='11851'>
<a name='11852'>
        ENDIF<a name='11853'>
<a name='11854'>
<font color=#447700>!  x flux-divergence into tendency<a name='11855'></font>
<a name='11856'>
        DO k=kts,ktf<a name='11857'>
          DO i = i_start, i_end<a name='11858'>
            mrdx=msfvy(i,j)*rdx      <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='11859'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='11860'>
          ENDDO<a name='11861'>
        ENDDO<a name='11862'>
<a name='11863'>
      ENDDO<a name='11864'>
<a name='11865'>
<a name='11866'>
   <font color=#447700>!  Comments on polar boundary condition<a name='11867'></font>
   <font color=#447700>!  Force tendency=0 at NP and SP<a name='11868'></font>
   <font color=#447700>!  We keep setting this everywhere, but it can't hurt...<a name='11869'></font>
   IF ( config_flags%polar .AND. (jts == jds) ) THEN<a name='11870'>
      DO i=its,ite<a name='11871'>
      DO k=kts,ktf<a name='11872'>
         tendency(i,k,jts)=0.<a name='11873'>
      END DO<a name='11874'>
      END DO<a name='11875'>
   END IF<a name='11876'>
   IF ( config_flags%polar .AND. (jte == jde) ) THEN<a name='11877'>
      DO i=its,ite<a name='11878'>
      DO k=kts,ktf<a name='11879'>
         tendency(i,k,jte)=0.<a name='11880'>
      END DO<a name='11881'>
      END DO<a name='11882'>
   END IF<a name='11883'>
<a name='11884'>
<font color=#447700>!  radiative lateral boundary condition in y for normal velocity (v)<a name='11885'></font>
<a name='11886'>
      IF ( (config_flags%open_ys) .and. jts == jds ) THEN<a name='11887'>
<a name='11888'>
        i_start = its<a name='11889'>
        i_end   = MIN(ite,ide-1)<a name='11890'>
<a name='11891'>
        DO i = i_start, i_end<a name='11892'>
        DO k = kts, ktf<a name='11893'>
          vb = MIN(rv(i,k,jts)-cb*mut(i,jts), 0.)<a name='11894'>
          tendency(i,k,jts) = tendency(i,k,jts)                    &amp;<a name='11895'>
                      - rdy*vb*(v_old(i,k,jts+1) - v_old(i,k,jts))<a name='11896'>
        ENDDO<a name='11897'>
        ENDDO<a name='11898'>
<a name='11899'>
      ENDIF<a name='11900'>
<a name='11901'>
      IF ( (config_flags%open_ye) .and. jte == jde ) THEN<a name='11902'>
<a name='11903'>
        i_start = its<a name='11904'>
        i_end   = MIN(ite,ide-1)<a name='11905'>
<a name='11906'>
        DO i = i_start, i_end<a name='11907'>
        DO k = kts, ktf<a name='11908'>
          vb = MAX(rv(i,k,jte)+cb*mut(i,jte-1), 0.)<a name='11909'>
          tendency(i,k,jte) = tendency(i,k,jte)                    &amp;<a name='11910'>
                      - rdy*vb*(v_old(i,k,jte) - v_old(i,k,jte-1))<a name='11911'>
        ENDDO<a name='11912'>
        ENDDO<a name='11913'>
<a name='11914'>
      ENDIF<a name='11915'>
<a name='11916'>
<font color=#447700>!  pick up the rest of the horizontal radiation boundary conditions.<a name='11917'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='11918'></font>
<font color=#447700>!  first, set to index ranges<a name='11919'></font>
<a name='11920'>
      j_start = jts<a name='11921'>
      j_end   = MIN(jte,jde)<a name='11922'>
<a name='11923'>
      jmin    = jds<a name='11924'>
      jmax    = jde-1<a name='11925'>
<a name='11926'>
      IF (config_flags%open_ys) THEN<a name='11927'>
          j_start = MAX(jds+1, jts)<a name='11928'>
          jmin = jds<a name='11929'>
      ENDIF<a name='11930'>
      IF (config_flags%open_ye) THEN<a name='11931'>
          j_end = MIN(jte,jde-1)<a name='11932'>
          jmax = jde-1<a name='11933'>
      ENDIF<a name='11934'>
<a name='11935'>
<font color=#447700>!  compute x (u) conditions for v, w, or scalar<a name='11936'></font>
<a name='11937'>
   IF( (config_flags%open_xs) .and. (its == ids)) THEN<a name='11938'>
<a name='11939'>
      DO j = j_start, j_end<a name='11940'>
<a name='11941'>
         mrdx=msfvy(its,j)*rdx       <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='11942'></font>
         jp = MIN( jmax, j   )<a name='11943'>
         jm = MAX( jmin, j-1 )<a name='11944'>
<a name='11945'>
         DO k=kts,ktf<a name='11946'>
<a name='11947'>
          uw = 0.5*(ru(its,k,jp)+ru(its,k,jm))<a name='11948'>
          ub = MIN( uw, 0. )<a name='11949'>
          dup =  ru(its+1,k,jp)-ru(its,k,jp)<a name='11950'>
          dum =  ru(its+1,k,jm)-ru(its,k,jm)<a name='11951'>
          tendency(its,k,j)=tendency(its,k,j)-mrdx*(               &amp;<a name='11952'>
                            ub*(v_old(its+1,k,j)-v_old(its,k,j))   &amp;<a name='11953'>
                           +0.5*v(its,k,j)*(dup+dum))<a name='11954'>
         ENDDO<a name='11955'>
      ENDDO<a name='11956'>
<a name='11957'>
   ENDIF<a name='11958'>
<a name='11959'>
   IF( (config_flags%open_xe) .and. (ite == ide) ) THEN<a name='11960'>
      DO j = j_start, j_end<a name='11961'>
<a name='11962'>
         mrdx=msfvy(ite-1,j)*rdx     <font color=#447700>! ADT eqn 45, 1st term on RHS<a name='11963'></font>
         jp = MIN( jmax, j   )<a name='11964'>
         jm = MAX( jmin, j-1 )<a name='11965'>
<a name='11966'>
         DO k=kts,ktf<a name='11967'>
<a name='11968'>
          uw = 0.5*(ru(ite,k,jp)+ru(ite,k,jm))<a name='11969'>
          ub = MAX( uw, 0. )<a name='11970'>
          dup = ru(ite,k,jp)-ru(ite-1,k,jp)<a name='11971'>
          dum = ru(ite,k,jm)-ru(ite-1,k,jm)<a name='11972'>
<a name='11973'>
<font color=#447700>!          tendency(ite-1,k,j)=tendency(ite-1,k,j)-mrdx*(              &amp;<a name='11974'></font>
<font color=#447700>!                            ub*(v_old(ite-1,k,j)-v_old(ite-2,k,j))    &amp;<a name='11975'></font>
<font color=#447700>!                           +0.5*v(ite-1,k,j)*                         &amp;<a name='11976'></font>
<font color=#447700>!                                  ( ru(ite,k,jp)-ru(ite-1,k,jp)       &amp;<a name='11977'></font>
<font color=#447700>!                                   +ru(ite,k,jm)-ru(ite-1,k,jm))     )<a name='11978'></font>
          tendency(ite-1,k,j)=tendency(ite-1,k,j)-mrdx*(              &amp;<a name='11979'>
                            ub*(v_old(ite-1,k,j)-v_old(ite-2,k,j))    &amp;<a name='11980'>
                           +0.5*v(ite-1,k,j)*(dup+dum))<a name='11981'>
<a name='11982'>
         ENDDO<a name='11983'>
      ENDDO<a name='11984'>
<a name='11985'>
   ENDIF<a name='11986'>
<a name='11987'>
<font color=#447700>!-------------------- vertical advection<a name='11988'></font>
<font color=#447700>!     ADT eqn 45 has 3rd term on RHS = -(1/mx) partial d/dz (rho v w)<a name='11989'></font>
<font color=#447700>!     Here we have: - partial d/dz (v*rom) = - partial d/dz (v rho w / my)<a name='11990'></font>
<font color=#447700>!     We therefore need to make a correction for advect_v<a name='11991'></font>
<font color=#447700>!     since 'my' (map scale factor in y direction) isn't a function of z,<a name='11992'></font>
<font color=#447700>!     we can do this using *(my/mx) (see eqn. 45 for example)<a name='11993'></font>
<a name='11994'>
<a name='11995'>
      i_start = its<a name='11996'>
      i_end   = MIN(ite,ide-1)<a name='11997'>
      j_start = jts<a name='11998'>
      j_end   = jte<a name='11999'>
<a name='12000'>
      DO i = i_start, i_end<a name='12001'>
         vflux(i,kts)=0.<a name='12002'>
         vflux(i,kte)=0.<a name='12003'>
      ENDDO<a name='12004'>
<a name='12005'>
      <font color=#447700>! Polar boundary conditions are like open or specified<a name='12006'></font>
      <font color=#447700>! We don't want to calculate vertical v tendencies at the N or S pole<a name='12007'></font>
      IF ( config_flags%open_ys .or. specified .or. config_flags%polar ) j_start = MAX(jds+1,jts)<a name='12008'>
      IF ( config_flags%open_ye .or. specified .or. config_flags%polar ) j_end   = MIN(jde-1,jte)<a name='12009'>
<a name='12010'>
<font color=#447700>!    vert_order_test : IF (vert_order == 6) THEN    <a name='12011'></font>
<a name='12012'>
<font color=#447700>!   ELSE IF (vert_order == 5) THEN    <a name='12013'></font>
<a name='12014'>
      DO j = j_start, j_end<a name='12015'>
<a name='12016'>
<a name='12017'>
         DO k=kts+3,ktf-2<a name='12018'>
         DO i = i_start, i_end<a name='12019'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1))<a name='12020'>
<a name='12021'>
         IF( -vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='12022'>
            qip2 = v(i,k+1,j)<a name='12023'>
            qip1 = v(i,k  ,j)<a name='12024'>
            qi   = v(i,k-1,j)<a name='12025'>
            qim1 = v(i,k-2,j)<a name='12026'>
            qim2 = v(i,k-3,j)<a name='12027'>
          ELSE<a name='12028'>
            qip2 = v(i,k-2,j)<a name='12029'>
            qip1 = v(i,k-1,j)<a name='12030'>
            qi   = v(i,k  ,j)<a name='12031'>
            qim1 = v(i,k+1,j)<a name='12032'>
            qim2 = v(i,k+2,j)<a name='12033'>
         ENDIF<a name='12034'>
    <a name='12035'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='12036'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='12037'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='12038'>
    <a name='12039'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='12040'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='12041'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='12042'>
    <a name='12043'>
         wi0 = gi0 / (eps + beta0)**pw<a name='12044'>
         wi1 = gi1 / (eps + beta1)**pw<a name='12045'>
         wi2 = gi2 / (eps + beta2)**pw<a name='12046'>
    <a name='12047'>
         sumwk = wi0 + wi1 + wi2<a name='12048'>
    <a name='12049'>
          vflux(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='12050'>
<a name='12051'>
<a name='12052'>
<font color=#447700>!           vflux(i,k) = vel*flux5(                       &amp;<a name='12053'></font>
<font color=#447700>!                   v(i,k-3,j), v(i,k-2,j), v(i,k-1,j),       &amp;<a name='12054'></font>
<font color=#447700>!                   v(i,k  ,j), v(i,k+1,j), v(i,k+2,j),  -vel )<a name='12055'></font>
         ENDDO<a name='12056'>
         ENDDO<a name='12057'>
<a name='12058'>
         DO i = i_start, i_end<a name='12059'>
           k=kts+1<a name='12060'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1))  &amp;<a name='12061'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='12062'>
           k = kts+2<a name='12063'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='12064'>
           vflux(i,k) = vel*flux3(       &amp;<a name='12065'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='12066'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='12067'>
           k = ktf-1<a name='12068'>
           vel=0.5*(rom(i,k,j)+rom(i,k,j-1)) <a name='12069'>
           vflux(i,k) = vel*flux3(       &amp;<a name='12070'>
                   v(i,k-2,j), v(i,k-1,j),   &amp;<a name='12071'>
                   v(i,k  ,j), v(i,k+1,j), -vel )<a name='12072'>
           k=ktf<a name='12073'>
           vflux(i,k)=0.5*(rom(i,k,j)+rom(i,k,j-1)) &amp;<a name='12074'>
                                   *(fzm(k)*v(i,k,j)+fzp(k)*v(i,k-1,j))<a name='12075'>
<a name='12076'>
         ENDDO<a name='12077'>
<a name='12078'>
<a name='12079'>
         DO k=kts,ktf<a name='12080'>
         DO i = i_start, i_end<a name='12081'>
            <font color=#447700>! We are calculating vertical fluxes on v points,<a name='12082'></font>
            <font color=#447700>! so we must mean msf_v_x/y variables<a name='12083'></font>
            tendency(i,k,j)=tendency(i,k,j)-(msfvy(i,j)/msfvx(i,j))*rdzw(k)*(vflux(i,k+1)-vflux(i,k)) <font color=#447700>! ADT eqn 45, 3rd term on RHS<a name='12084'></font>
         ENDDO<a name='12085'>
         ENDDO<a name='12086'>
<a name='12087'>
      ENDDO<a name='12088'>
<a name='12089'>
<a name='12090'>
END SUBROUTINE advect_weno_v<a name='12091'>
<a name='12092'>
<a name='12093'>
<font color=#447700>!---------------------------------------------------------------------------------<a name='12094'></font>
<a name='12095'>
<A NAME='ADVECT_WENO_W'><A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_WENO_W' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12096'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>advect_weno_w</font>    ( w, w_old, tendency,            &amp; <A href='../../call_to/ADVECT_WENO_W.html' TARGET='index'>1</A><a name='12097'>
                         ru, rv, rom,                   &amp;<a name='12098'>
                         c1, c2,                        &amp;<a name='12099'>
                         mut, time_step, config_flags,  &amp;<a name='12100'>
                         msfux, msfuy, msfvx, msfvy,    &amp;<a name='12101'>
                         msftx, msfty,                  &amp;<a name='12102'>
                         fzm, fzp,                      &amp;<a name='12103'>
                         rdx, rdy, rdzu,                &amp;<a name='12104'>
                         ids, ide, jds, jde, kds, kde,  &amp;<a name='12105'>
                         ims, ime, jms, jme, kms, kme,  &amp;<a name='12106'>
                         its, ite, jts, jte, kts, kte  )<a name='12107'>
<a name='12108'>
<font color=#447700>!<a name='12109'></font>
<font color=#447700>! 5th-order WENO (Weighted Essentially Non-Oscillatory) scheme adapted from COMMAS.  <a name='12110'></font>
<font color=#447700>! See Jiang and Shu, 1996, J. Comp. Phys. v. 126, 202-223; <a name='12111'></font>
<font color=#447700>! Shu 2003, Int. J. Comp. Fluid Dyn. v. 17 107-118;  Also used by Bryan 2005, Mon. Wea. Rev.<a name='12112'></font>
<font color=#447700>!<a name='12113'></font>
<a name='12114'>
   IMPLICIT NONE<a name='12115'>
   <a name='12116'>
   <font color=#447700>! Input data<a name='12117'></font>
   <a name='12118'>
   TYPE(grid_config_rec_type), INTENT(IN   ) :: config_flags<a name='12119'>
<a name='12120'>
   INTEGER ,                 INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='12121'>
                                              ims, ime, jms, jme, kms, kme, &amp;<a name='12122'>
                                              its, ite, jts, jte, kts, kte<a name='12123'>
<a name='12124'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(IN   ) :: w,     &amp;<a name='12125'>
                                                                      w_old, &amp;<a name='12126'>
                                                                      ru,    &amp;<a name='12127'>
                                                                      rv,    &amp;<a name='12128'>
                                                                      rom<a name='12129'>
<a name='12130'>
   REAL , DIMENSION( ims:ime , jms:jme ) , INTENT(IN   ) :: mut<a name='12131'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme ) , INTENT(INOUT) :: tendency<a name='12132'>
<a name='12133'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,  &amp;<a name='12134'>
                                                                    msfuy,  &amp;<a name='12135'>
                                                                    msfvx,  &amp;<a name='12136'>
                                                                    msfvy,  &amp;<a name='12137'>
                                                                    msftx,  &amp;<a name='12138'>
                                                                    msfty<a name='12139'>
<a name='12140'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fzm,  &amp;<a name='12141'>
                                                                  fzp,  &amp;<a name='12142'>
                                                                  rdzu, &amp;<a name='12143'>
                                                                  c1,   &amp;<a name='12144'>
                                                                  c2<a name='12145'>
<a name='12146'>
   REAL ,                                        INTENT(IN   ) :: rdx,  &amp;<a name='12147'>
                                                                  rdy<a name='12148'>
   INTEGER ,                                     INTENT(IN   ) :: time_step<a name='12149'>
<a name='12150'>
<a name='12151'>
   <font color=#447700>! Local data<a name='12152'></font>
   <a name='12153'>
   INTEGER :: i, j, k, itf, jtf, ktf<a name='12154'>
   INTEGER :: i_start, i_end, j_start, j_end<a name='12155'>
   INTEGER :: i_start_f, i_end_f, j_start_f, j_end_f<a name='12156'>
   INTEGER :: jmin, jmax, jp, jm, imin, imax<a name='12157'>
<a name='12158'>
   REAL    :: mrdx, mrdy, ub, vb, uw, vw<a name='12159'>
   REAL , DIMENSION(its:ite, kts:kte) :: vflux<a name='12160'>
<a name='12161'>
    real            :: dir, vv<a name='12162'>
    real            :: ue,vs,vn,wb,wt<a name='12163'>
    real, parameter :: f30 =  7./12., f31 = 1./12.<a name='12164'>
    real, parameter :: f50 = 37./60., f51 = 2./15., f52 = 1./60.<a name='12165'>
<a name='12166'>
<a name='12167'>
   integer kt,kb<a name='12168'>
   <a name='12169'>
    <a name='12170'>
    real               :: qim2, qim1, qi, qip1, qip2<a name='12171'>
    double precision               :: beta0, beta1, beta2, f0, f1, f2, wi0, wi1, wi2, sumwk<a name='12172'>
    double precision, parameter    :: gi0 = 1.d0/10.d0, gi1 = 6.d0/10.d0, gi2 = 3.d0/10.d0, eps=1.0d-18<a name='12173'>
    integer, parameter :: pw = 2<a name='12174'>
<a name='12175'>
<a name='12176'>
<a name='12177'>
   INTEGER :: horz_order, vert_order<a name='12178'>
<a name='12179'>
   REAL,  DIMENSION( its:ite+1, kts:kte ) :: fqx<a name='12180'>
   REAL,  DIMENSION( its:ite, kts:kte, 2 ) :: fqy<a name='12181'>
   <a name='12182'>
   LOGICAL :: degrade_xs, degrade_ys<a name='12183'>
   LOGICAL :: degrade_xe, degrade_ye<a name='12184'>
<a name='12185'>
   INTEGER :: jp1, jp0, jtmp<a name='12186'>
<a name='12187'>
<font color=#447700>! definition of flux operators, 3rd, 4th, 5th or 6th order<a name='12188'></font>
<a name='12189'>
   REAL    :: flux3, flux4, flux5, flux6<a name='12190'>
   REAL    :: q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua, vel<a name='12191'>
<a name='12192'>
      flux4(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='12193'>
          ( 7.*(q_i + q_im1) - (q_ip1 + q_im2) )/12.0<a name='12194'>
<a name='12195'>
      flux3(q_im2, q_im1, q_i, q_ip1, ua) =                     &amp;<a name='12196'>
           flux4(q_im2, q_im1, q_i, q_ip1, ua) +                &amp;<a name='12197'>
           sign(1,time_step)*sign(1.,ua)*((q_ip1 - q_im2)-3.*(q_i-q_im1))/12.0<a name='12198'>
<a name='12199'>
      flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='12200'>
                      ( 37.*(q_i+q_im1) - 8.*(q_ip1+q_im2)      &amp;<a name='12201'>
                     +(q_ip2+q_im3) )/60.0<a name='12202'>
<a name='12203'>
      flux5(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua) =       &amp;<a name='12204'>
           flux6(q_im3, q_im2, q_im1, q_i, q_ip1, q_ip2, ua)    &amp;<a name='12205'>
            -sign(1,time_step)*sign(1.,ua)*(                    &amp;<a name='12206'>
              (q_ip2-q_im3)-5.*(q_ip1-q_im2)+10.*(q_i-q_im1) )/60.0<a name='12207'>
<a name='12208'>
<a name='12209'>
   LOGICAL :: specified<a name='12210'>
<a name='12211'>
   specified = .false.<a name='12212'>
   if(config_flags%specified .or. config_flags%nested) specified = .true.<a name='12213'>
<a name='12214'>
<font color=#447700>!  set order for the advection scheme<a name='12215'></font>
<a name='12216'>
  ktf=MIN(kte,kde-1)<a name='12217'>
  horz_order = config_flags%h_sca_adv_order<a name='12218'>
  vert_order = config_flags%v_sca_adv_order<a name='12219'>
<a name='12220'>
<font color=#447700>!  here is the choice of flux operators<a name='12221'></font>
<a name='12222'>
<font color=#447700>!  begin with horizontal flux divergence<a name='12223'></font>
<a name='12224'>
<font color=#447700>!  horizontal_order_test : IF( horz_order == 6 ) THEN<a name='12225'></font>
<font color=#447700>! ELSE IF (horz_order == 5 ) THEN<a name='12226'></font>
<a name='12227'>
<font color=#447700>!  determine boundary mods for flux operators<a name='12228'></font>
<font color=#447700>!  We degrade the flux operators from 3rd/4th order<a name='12229'></font>
<font color=#447700>!   to second order one gridpoint in from the boundaries for<a name='12230'></font>
<font color=#447700>!   all boundary conditions except periodic and symmetry - these<a name='12231'></font>
<font color=#447700>!   conditions have boundary zone data fill for correct application<a name='12232'></font>
<font color=#447700>!   of the higher order flux stencils<a name='12233'></font>
<a name='12234'>
   degrade_xs = .true.<a name='12235'>
   degrade_xe = .true.<a name='12236'>
   degrade_ys = .true.<a name='12237'>
   degrade_ye = .true.<a name='12238'>
<a name='12239'>
   IF( config_flags%periodic_x   .or. &amp;<a name='12240'>
       config_flags%symmetric_xs .or. &amp;<a name='12241'>
       (its &gt; ids+3)                ) degrade_xs = .false.<a name='12242'>
   IF( config_flags%periodic_x   .or. &amp;<a name='12243'>
       config_flags%symmetric_xe .or. &amp;<a name='12244'>
       (ite &lt; ide-3)                ) degrade_xe = .false.<a name='12245'>
   IF( config_flags%periodic_y   .or. &amp;<a name='12246'>
       config_flags%symmetric_ys .or. &amp;<a name='12247'>
       (jts &gt; jds+3)                ) degrade_ys = .false.<a name='12248'>
   IF( config_flags%periodic_y   .or. &amp;<a name='12249'>
       config_flags%symmetric_ye .or. &amp;<a name='12250'>
       (jte &lt; jde-4)                ) degrade_ye = .false.<a name='12251'>
<a name='12252'>
<font color=#447700>!--------------- y - advection first<a name='12253'></font>
<a name='12254'>
      i_start = its<a name='12255'>
      i_end   = MIN(ite,ide-1)<a name='12256'>
      j_start = jts<a name='12257'>
      j_end   = MIN(jte,jde-1)<a name='12258'>
<a name='12259'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='12260'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='12261'></font>
<a name='12262'>
      j_start_f = j_start<a name='12263'>
      j_end_f   = j_end+1<a name='12264'>
<a name='12265'>
      IF(degrade_ys) then<a name='12266'>
        j_start = MAX(jts,jds+1)<a name='12267'>
        j_start_f = jds+3<a name='12268'>
      ENDIF<a name='12269'>
<a name='12270'>
      IF(degrade_ye) then<a name='12271'>
        j_end = MIN(jte,jde-2)<a name='12272'>
        j_end_f = jde-3<a name='12273'>
      ENDIF<a name='12274'>
<a name='12275'>
      IF(config_flags%polar) j_end = MIN(jte,jde-1)<a name='12276'>
<a name='12277'>
<font color=#447700>!  compute fluxes, 5th or 6th order<a name='12278'></font>
<a name='12279'>
     jp1 = 2<a name='12280'>
     jp0 = 1<a name='12281'>
<a name='12282'>
     j_loop_y_flux_5 : DO j = j_start, j_end+1<a name='12283'>
<a name='12284'>
      IF( (j &gt;= j_start_f ) .and. (j &lt;= j_end_f) ) THEN<a name='12285'>
<a name='12286'>
        DO k=kts+1,ktf<a name='12287'>
        DO i = i_start, i_end<a name='12288'>
          vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='12289'>
<a name='12290'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='12291'>
            qip2 = w(i,k,j+1)<a name='12292'>
            qip1 = w(i,k,j  )<a name='12293'>
            qi   = w(i,k,j-1)<a name='12294'>
            qim1 = w(i,k,j-2)<a name='12295'>
            qim2 = w(i,k,j-3)<a name='12296'>
          ELSE<a name='12297'>
            qip2 = w(i,k,j-2)<a name='12298'>
            qip1 = w(i,k,j-1)<a name='12299'>
            qi   = w(i,k,j  )<a name='12300'>
            qim1 = w(i,k,j+1)<a name='12301'>
            qim2 = w(i,k,j+2)<a name='12302'>
         ENDIF<a name='12303'>
    <a name='12304'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='12305'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='12306'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='12307'>
    <a name='12308'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='12309'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='12310'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='12311'>
    <a name='12312'>
         wi0 = gi0 / (eps + beta0)**pw<a name='12313'>
         wi1 = gi1 / (eps + beta1)**pw<a name='12314'>
         wi2 = gi2 / (eps + beta2)**pw<a name='12315'>
    <a name='12316'>
         sumwk = wi0 + wi1 + wi2<a name='12317'>
    <a name='12318'>
          fqy( i, k, jp1 ) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='12319'>
<a name='12320'>
<font color=#447700>!          fqy( i, k, jp1 ) = vel*flux5(                     &amp;<a name='12321'></font>
<font color=#447700>!                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='12322'></font>
<font color=#447700>!                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='12323'></font>
        ENDDO<a name='12324'>
        ENDDO<a name='12325'>
<a name='12326'>
        k = ktf+1<a name='12327'>
        DO i = i_start, i_end<a name='12328'>
          vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='12329'>
<a name='12330'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='12331'>
            qip2 = w(i,k,j+1)<a name='12332'>
            qip1 = w(i,k,j  )<a name='12333'>
            qi   = w(i,k,j-1)<a name='12334'>
            qim1 = w(i,k,j-2)<a name='12335'>
            qim2 = w(i,k,j-3)<a name='12336'>
          ELSE<a name='12337'>
            qip2 = w(i,k,j-2)<a name='12338'>
            qip1 = w(i,k,j-1)<a name='12339'>
            qi   = w(i,k,j  )<a name='12340'>
            qim1 = w(i,k,j+1)<a name='12341'>
            qim2 = w(i,k,j+2)<a name='12342'>
         ENDIF<a name='12343'>
    <a name='12344'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='12345'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='12346'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='12347'>
    <a name='12348'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='12349'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='12350'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='12351'>
    <a name='12352'>
         wi0 = gi0 / (eps + beta0)**pw<a name='12353'>
         wi1 = gi1 / (eps + beta1)**pw<a name='12354'>
         wi2 = gi2 / (eps + beta2)**pw<a name='12355'>
    <a name='12356'>
         sumwk = wi0 + wi1 + wi2<a name='12357'>
    <a name='12358'>
          fqy( i, k, jp1 ) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='12359'>
<a name='12360'>
<font color=#447700>!          fqy( i, k, jp1 ) = vel*flux5(                     &amp;<a name='12361'></font>
<font color=#447700>!                  w(i,k,j-3), w(i,k,j-2), w(i,k,j-1),       &amp;<a name='12362'></font>
<font color=#447700>!                  w(i,k,j  ), w(i,k,j+1), w(i,k,j+2),  vel )<a name='12363'></font>
        ENDDO<a name='12364'>
<a name='12365'>
      ELSE IF ( j == jds+1 ) THEN   <font color=#447700>! 2nd order flux next to south boundary<a name='12366'></font>
<a name='12367'>
            DO k=kts+1,ktf<a name='12368'>
            DO i = i_start, i_end<a name='12369'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*          &amp;<a name='12370'>
                     (w(i,k,j)+w(i,k,j-1))<a name='12371'>
            ENDDO<a name='12372'>
            ENDDO<a name='12373'>
<a name='12374'>
            k = ktf+1<a name='12375'>
            DO i = i_start, i_end<a name='12376'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*          &amp;<a name='12377'>
                     (w(i,k,j)+w(i,k,j-1))<a name='12378'>
            ENDDO<a name='12379'>
<a name='12380'>
     ELSE IF  ( j == jds+2 ) THEN  <font color=#447700>! third of 4th order flux 2 in from south boundary<a name='12381'></font>
<a name='12382'>
            DO k=kts+1,ktf<a name='12383'>
            DO i = i_start, i_end<a name='12384'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='12385'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='12386'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='12387'>
            ENDDO<a name='12388'>
            ENDDO<a name='12389'>
<a name='12390'>
            k = ktf+1<a name='12391'>
            DO i = i_start, i_end<a name='12392'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='12393'>
              fqy( i, k, jp1 ) = vel*flux3(              &amp;<a name='12394'>
                   w(i,k,j-2),w(i,k,j-1),w(i,k,j),w(i,k,j+1),vel )<a name='12395'>
            ENDDO<a name='12396'>
<a name='12397'>
     ELSE IF ( j == jde-1 ) THEN  <font color=#447700>! 2nd order flux next to north boundary<a name='12398'></font>
<a name='12399'>
            DO k=kts+1,ktf<a name='12400'>
            DO i = i_start, i_end<a name='12401'>
              fqy(i, k, jp1) = 0.5*(fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j))*      &amp;<a name='12402'>
                     (w(i,k,j)+w(i,k,j-1))<a name='12403'>
            ENDDO<a name='12404'>
            ENDDO<a name='12405'>
<a name='12406'>
            k = ktf+1<a name='12407'>
            DO i = i_start, i_end<a name='12408'>
              fqy(i, k, jp1) = 0.5*((2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j))*      &amp;<a name='12409'>
                     (w(i,k,j)+w(i,k,j-1))<a name='12410'>
            ENDDO<a name='12411'>
<a name='12412'>
     ELSE IF ( j == jde-2 ) THEN  <font color=#447700>! 3rd or 4th order flux 2 in from north boundary<a name='12413'></font>
<a name='12414'>
            DO k=kts+1,ktf<a name='12415'>
            DO i = i_start, i_end<a name='12416'>
              vel = fzm(k)*rv(i,k,j)+fzp(k)*rv(i,k-1,j)<a name='12417'>
              fqy( i, k, jp1 ) = vel*flux3(             &amp;<a name='12418'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='12419'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='12420'>
            ENDDO<a name='12421'>
            ENDDO<a name='12422'>
<a name='12423'>
            k = ktf+1<a name='12424'>
            DO i = i_start, i_end<a name='12425'>
              vel = (2.-fzm(k-1))*rv(i,k-1,j)-fzp(k-1)*rv(i,k-2,j)<a name='12426'>
              fqy( i, k, jp1 ) = vel*flux3(             &amp;<a name='12427'>
                   w(i,k,j-2),w(i,k,j-1),    &amp;<a name='12428'>
                   w(i,k,j),w(i,k,j+1),vel )<a name='12429'>
            ENDDO<a name='12430'>
<a name='12431'>
     ENDIF<a name='12432'>
<a name='12433'>
<font color=#447700>!  y flux-divergence into tendency<a name='12434'></font>
<a name='12435'>
        <font color=#447700>! Comments for polar boundary conditions<a name='12436'></font>
        <font color=#447700>! Same process as for advect_u - tendencies run from jds to jde-1 <a name='12437'></font>
        <font color=#447700>! (latitudes are as for u grid, longitudes are displaced)<a name='12438'></font>
        <font color=#447700>! Therefore: flow is only from one side for points next to poles<a name='12439'></font>
        IF ( config_flags%polar .AND. (j == jds+1) ) THEN<a name='12440'>
          DO k=kts,ktf<a name='12441'>
          DO i = i_start, i_end<a name='12442'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='12443'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*fqy(i,k,jp1)<a name='12444'>
          END DO<a name='12445'>
          END DO<a name='12446'>
        ELSE IF( config_flags%polar .AND. (j == jde) ) THEN<a name='12447'>
          DO k=kts,ktf<a name='12448'>
          DO i = i_start, i_end<a name='12449'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='12450'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) + mrdy*fqy(i,k,jp0)<a name='12451'>
          END DO<a name='12452'>
          END DO<a name='12453'>
        ELSE  <font color=#447700>! normal code<a name='12454'></font>
<a name='12455'>
        IF(j &gt; j_start) THEN<a name='12456'>
<a name='12457'>
          DO k=kts+1,ktf+1<a name='12458'>
          DO i = i_start, i_end<a name='12459'>
            mrdy=msftx(i,j-1)*rdy    <font color=#447700>! see ADT eqn 46 dividing by my, 2nd term RHS<a name='12460'></font>
            tendency(i,k,j-1) = tendency(i,k,j-1) - mrdy*(fqy(i,k,jp1)-fqy(i,k,jp0))<a name='12461'>
          ENDDO<a name='12462'>
          ENDDO<a name='12463'>
<a name='12464'>
       ENDIF<a name='12465'>
<a name='12466'>
        END IF<a name='12467'>
<a name='12468'>
        jtmp = jp1<a name='12469'>
        jp1 = jp0<a name='12470'>
        jp0 = jtmp<a name='12471'>
<a name='12472'>
      ENDDO j_loop_y_flux_5<a name='12473'>
<a name='12474'>
<font color=#447700>!  next, x - flux divergence<a name='12475'></font>
<a name='12476'>
      i_start = its<a name='12477'>
      i_end   = MIN(ite,ide-1)<a name='12478'>
<a name='12479'>
      j_start = jts<a name='12480'>
      j_end   = MIN(jte,jde-1)<a name='12481'>
<a name='12482'>
<font color=#447700>!  higher order flux has a 5 or 7 point stencil, so compute<a name='12483'></font>
<font color=#447700>!  bounds so we can switch to second order flux close to the boundary<a name='12484'></font>
<a name='12485'>
      i_start_f = i_start<a name='12486'>
      i_end_f   = i_end+1<a name='12487'>
<a name='12488'>
      IF(degrade_xs) then<a name='12489'>
        i_start = MAX(ids+1,its)<a name='12490'>
<font color=#447700>!        i_start_f = i_start+2<a name='12491'></font>
        i_start_f = MIN(i_start+2,ids+3)<a name='12492'>
      ENDIF<a name='12493'>
<a name='12494'>
      IF(degrade_xe) then<a name='12495'>
        i_end = MIN(ide-2,ite)<a name='12496'>
        i_end_f = ide-3<a name='12497'>
      ENDIF<a name='12498'>
<a name='12499'>
<font color=#447700>!  compute fluxes<a name='12500'></font>
<a name='12501'>
      DO j = j_start, j_end<a name='12502'>
<a name='12503'>
<font color=#447700>!  5th or 6th order flux<a name='12504'></font>
<a name='12505'>
        DO k=kts+1,ktf<a name='12506'>
        DO i = i_start_f, i_end_f<a name='12507'>
          vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='12508'>
<a name='12509'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='12510'>
            qip2 = w(i+1,k,j)<a name='12511'>
            qip1 = w(i,  k,j)<a name='12512'>
            qi   = w(i-1,k,j)<a name='12513'>
            qim1 = w(i-2,k,j)<a name='12514'>
            qim2 = w(i-3,k,j)<a name='12515'>
          ELSE<a name='12516'>
            qip2 = w(i-2,k,j)<a name='12517'>
            qip1 = w(i-1,k,j)<a name='12518'>
            qi   = w(i,  k,j)<a name='12519'>
            qim1 = w(i+1,k,j)<a name='12520'>
            qim2 = w(i+2,k,j)<a name='12521'>
         ENDIF<a name='12522'>
    <a name='12523'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='12524'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='12525'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='12526'>
    <a name='12527'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='12528'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='12529'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='12530'>
    <a name='12531'>
         wi0 = gi0 / (eps + beta0)**pw<a name='12532'>
         wi1 = gi1 / (eps + beta1)**pw<a name='12533'>
         wi2 = gi2 / (eps + beta2)**pw<a name='12534'>
    <a name='12535'>
         sumwk = wi0 + wi1 + wi2<a name='12536'>
    <a name='12537'>
         fqx(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='12538'>
<a name='12539'>
<font color=#447700>!          fqx( i,k ) = vel*flux5( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='12540'></font>
<font color=#447700>!                                  w(i-1,k,j), w(i  ,k,j),  &amp;<a name='12541'></font>
<font color=#447700>!                                  w(i+1,k,j), w(i+2,k,j),  &amp;<a name='12542'></font>
<font color=#447700>!                                  vel                     )<a name='12543'></font>
        ENDDO<a name='12544'>
        ENDDO<a name='12545'>
<a name='12546'>
        k = ktf+1<a name='12547'>
        DO i = i_start_f, i_end_f<a name='12548'>
          vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='12549'>
<a name='12550'>
         IF ( vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='12551'>
            qip2 = w(i+1,k,j)<a name='12552'>
            qip1 = w(i,  k,j)<a name='12553'>
            qi   = w(i-1,k,j)<a name='12554'>
            qim1 = w(i-2,k,j)<a name='12555'>
            qim2 = w(i-3,k,j)<a name='12556'>
          ELSE<a name='12557'>
            qip2 = w(i-2,k,j)<a name='12558'>
            qip1 = w(i-1,k,j)<a name='12559'>
            qi   = w(i,  k,j)<a name='12560'>
            qim1 = w(i+1,k,j)<a name='12561'>
            qim2 = w(i+2,k,j)<a name='12562'>
         ENDIF<a name='12563'>
    <a name='12564'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='12565'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='12566'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='12567'>
    <a name='12568'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='12569'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='12570'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='12571'>
    <a name='12572'>
         wi0 = gi0 / (eps + beta0)**pw<a name='12573'>
         wi1 = gi1 / (eps + beta1)**pw<a name='12574'>
         wi2 = gi2 / (eps + beta2)**pw<a name='12575'>
    <a name='12576'>
         sumwk = wi0 + wi1 + wi2<a name='12577'>
    <a name='12578'>
         fqx(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='12579'>
<a name='12580'>
<font color=#447700>!          fqx( i,k ) = vel*flux5( w(i-3,k,j), w(i-2,k,j),  &amp;<a name='12581'></font>
<font color=#447700>!                                  w(i-1,k,j), w(i  ,k,j),  &amp;<a name='12582'></font>
<font color=#447700>!                                  w(i+1,k,j), w(i+2,k,j),  &amp;<a name='12583'></font>
<font color=#447700>!                                  vel                     )<a name='12584'></font>
        ENDDO<a name='12585'>
<a name='12586'>
<font color=#447700>!  lower order fluxes close to boundaries (if not periodic or symmetric)<a name='12587'></font>
<a name='12588'>
        IF( degrade_xs ) THEN<a name='12589'>
<a name='12590'>
          DO i=i_start,i_start_f-1<a name='12591'>
<a name='12592'>
            IF(i == ids+1) THEN <font color=#447700>! second order<a name='12593'></font>
              DO k=kts+1,ktf<a name='12594'>
                fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)) &amp;<a name='12595'>
                                *(w(i,k,j)+w(i-1,k,j))<a name='12596'>
              ENDDO<a name='12597'>
              k = ktf+1<a name='12598'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)) &amp;<a name='12599'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='12600'>
            ENDIF<a name='12601'>
<a name='12602'>
            IF(i == ids+2) THEN  <font color=#447700>! third order<a name='12603'></font>
              DO k=kts+1,ktf<a name='12604'>
                vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='12605'>
                fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='12606'>
                                        w(i  ,k,j), w(i+1,k,j),  &amp;<a name='12607'>
                                        vel                     )<a name='12608'>
              ENDDO<a name='12609'>
              k = ktf+1<a name='12610'>
              vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='12611'>
              fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='12612'>
                                      w(i  ,k,j), w(i+1,k,j),  &amp;<a name='12613'>
                                      vel                     )<a name='12614'>
            END IF<a name='12615'>
<a name='12616'>
          ENDDO<a name='12617'>
<a name='12618'>
        ENDIF<a name='12619'>
<a name='12620'>
        IF( degrade_xe ) THEN<a name='12621'>
<a name='12622'>
          DO i = i_end_f+1, i_end+1<a name='12623'>
<a name='12624'>
            IF( i == ide-1 ) THEN <font color=#447700>! second order flux next to the boundary<a name='12625'></font>
              DO k=kts+1,ktf<a name='12626'>
                fqx(i,k) = 0.5*(fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j))      &amp;<a name='12627'>
                                  *(w(i,k,j)+w(i-1,k,j))<a name='12628'>
              ENDDO<a name='12629'>
              k = ktf+1<a name='12630'>
              fqx(i,k) = 0.5*((2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j))      &amp;<a name='12631'>
                     *(w(i,k,j)+w(i-1,k,j))<a name='12632'>
            ENDIF<a name='12633'>
<a name='12634'>
            IF( i == ide-2 ) THEN <font color=#447700>! third order flux one in from the boundary<a name='12635'></font>
              DO k=kts+1,ktf<a name='12636'>
                vel = fzm(k)*ru(i,k,j)+fzp(k)*ru(i,k-1,j)<a name='12637'>
                fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='12638'>
                                        w(i  ,k,j), w(i+1,k,j),  &amp;<a name='12639'>
                                        vel                     )<a name='12640'>
              ENDDO<a name='12641'>
              k = ktf+1<a name='12642'>
              vel = (2.-fzm(k-1))*ru(i,k-1,j)-fzp(k-1)*ru(i,k-2,j)<a name='12643'>
              fqx( i,k ) = vel*flux3( w(i-2,k,j), w(i-1,k,j),  &amp;<a name='12644'>
                                      w(i  ,k,j), w(i+1,k,j),  &amp;<a name='12645'>
                                      vel                     )<a name='12646'>
            ENDIF<a name='12647'>
<a name='12648'>
          ENDDO<a name='12649'>
<a name='12650'>
        ENDIF<a name='12651'>
<a name='12652'>
<font color=#447700>!  x flux-divergence into tendency<a name='12653'></font>
<a name='12654'>
        DO k=kts+1,ktf+1<a name='12655'>
          DO i = i_start, i_end<a name='12656'>
            mrdx=msftx(i,j)*rdx      <font color=#447700>! see ADT eqn 46 dividing by my, 1st term RHS<a name='12657'></font>
            tendency(i,k,j) = tendency(i,k,j) - mrdx*(fqx(i+1,k)-fqx(i,k))<a name='12658'>
          ENDDO<a name='12659'>
        ENDDO<a name='12660'>
<a name='12661'>
      ENDDO<a name='12662'>
<a name='12663'>
<a name='12664'>
<font color=#447700>!  pick up the the horizontal radiation boundary conditions.<a name='12665'></font>
<font color=#447700>!  (these are the computations that don't require 'cb'.<a name='12666'></font>
<font color=#447700>!  first, set to index ranges<a name='12667'></font>
<a name='12668'>
<a name='12669'>
      i_start = its<a name='12670'>
      i_end   = MIN(ite,ide-1)<a name='12671'>
      j_start = jts<a name='12672'>
      j_end   = MIN(jte,jde-1)<a name='12673'>
<a name='12674'>
   IF( (config_flags%open_xs) .and. (its == ids)) THEN<a name='12675'>
<a name='12676'>
       DO j = j_start, j_end<a name='12677'>
       DO k = kts+1, ktf<a name='12678'>
<a name='12679'>
         uw = 0.5*(fzm(k)*(ru(its,k  ,j)+ru(its+1,k  ,j)) +  &amp;<a name='12680'>
                   fzp(k)*(ru(its,k-1,j)+ru(its+1,k-1,j))   )<a name='12681'>
         ub = MIN( uw, 0. )<a name='12682'>
<a name='12683'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='12684'>
               - rdx*(                                             &amp;<a name='12685'>
                       ub*(w_old(its+1,k,j) - w_old(its,k,j)) +    &amp;<a name='12686'>
                       w(its,k,j)*(                                &amp;<a name='12687'>
                       fzm(k)*(ru(its+1,k  ,j)-ru(its,k  ,j))+     &amp;<a name='12688'>
                       fzp(k)*(ru(its+1,k-1,j)-ru(its,k-1,j)))     &amp;<a name='12689'>
                                                                  )<a name='12690'>
       ENDDO<a name='12691'>
       ENDDO<a name='12692'>
<a name='12693'>
       k = ktf+1<a name='12694'>
       DO j = j_start, j_end<a name='12695'>
<a name='12696'>
         uw = 0.5*( (2.-fzm(k-1))*(ru(its,k-1,j)+ru(its+1,k-1,j))   &amp;<a name='12697'>
                   -fzp(k-1)*(ru(its,k-2,j)+ru(its+1,k-2,j))   )<a name='12698'>
         ub = MIN( uw, 0. )<a name='12699'>
<a name='12700'>
         tendency(its,k,j) = tendency(its,k,j)                     &amp;<a name='12701'>
               - rdx*(                                             &amp;<a name='12702'>
                       ub*(w_old(its+1,k,j) - w_old(its,k,j)) +    &amp;<a name='12703'>
                       w(its,k,j)*(                                &amp;<a name='12704'>
                             (2.-fzm(k-1))*(ru(its+1,k-1,j)-ru(its,k-1,j))-  &amp;<a name='12705'>
                             fzp(k-1)*(ru(its+1,k-2,j)-ru(its,k-2,j)))  &amp;<a name='12706'>
                                                                  )<a name='12707'>
       ENDDO<a name='12708'>
<a name='12709'>
   ENDIF<a name='12710'>
<a name='12711'>
   IF( (config_flags%open_xe) .and. (ite == ide)) THEN<a name='12712'>
<a name='12713'>
       DO j = j_start, j_end<a name='12714'>
       DO k = kts+1, ktf<a name='12715'>
<a name='12716'>
         uw = 0.5*(fzm(k)*(ru(ite-1,k  ,j)+ru(ite,k  ,j)) +  &amp;<a name='12717'>
                   fzp(k)*(ru(ite-1,k-1,j)+ru(ite,k-1,j))   )<a name='12718'>
         ub = MAX( uw, 0. )<a name='12719'>
<a name='12720'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                     &amp;<a name='12721'>
               - rdx*(                                                 &amp;<a name='12722'>
                       ub*(w_old(i_end,k,j) - w_old(i_end-1,k,j)) +    &amp;<a name='12723'>
                       w(i_end,k,j)*(                                  &amp;<a name='12724'>
                            fzm(k)*(ru(ite,k  ,j)-ru(ite-1,k  ,j)) +   &amp;<a name='12725'>
                            fzp(k)*(ru(ite,k-1,j)-ru(ite-1,k-1,j)))    &amp;<a name='12726'>
                                                                    )<a name='12727'>
       ENDDO<a name='12728'>
       ENDDO<a name='12729'>
<a name='12730'>
       k = ktf+1<a name='12731'>
       DO j = j_start, j_end<a name='12732'>
<a name='12733'>
         uw = 0.5*( (2.-fzm(k-1))*(ru(ite-1,k-1,j)+ru(ite,k-1,j))    &amp;<a name='12734'>
                   -fzp(k-1)*(ru(ite-1,k-2,j)+ru(ite,k-2,j))   )<a name='12735'>
         ub = MAX( uw, 0. )<a name='12736'>
<a name='12737'>
         tendency(i_end,k,j) = tendency(i_end,k,j)                     &amp;<a name='12738'>
               - rdx*(                                                 &amp;<a name='12739'>
                       ub*(w_old(i_end,k,j) - w_old(i_end-1,k,j)) +    &amp;<a name='12740'>
                       w(i_end,k,j)*(                                  &amp;<a name='12741'>
                               (2.-fzm(k-1))*(ru(ite,k-1,j)-ru(ite-1,k-1,j)) -   &amp;<a name='12742'>
                               fzp(k-1)*(ru(ite,k-2,j)-ru(ite-1,k-2,j)))    &amp;<a name='12743'>
                                                                    )<a name='12744'>
       ENDDO<a name='12745'>
<a name='12746'>
   ENDIF<a name='12747'>
<a name='12748'>
<a name='12749'>
   IF( (config_flags%open_ys) .and. (jts == jds)) THEN<a name='12750'>
<a name='12751'>
       DO i = i_start, i_end<a name='12752'>
       DO k = kts+1, ktf<a name='12753'>
<a name='12754'>
         vw = 0.5*( fzm(k)*(rv(i,k  ,jts)+rv(i,k  ,jts+1)) +  &amp;<a name='12755'>
                    fzp(k)*(rv(i,k-1,jts)+rv(i,k-1,jts+1))   )<a name='12756'>
         vb = MIN( vw, 0. )<a name='12757'>
<a name='12758'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='12759'>
               - rdy*(                                             &amp;<a name='12760'>
                       vb*(w_old(i,k,jts+1) - w_old(i,k,jts)) +    &amp;<a name='12761'>
                       w(i,k,jts)*(                                &amp;<a name='12762'>
                       fzm(k)*(rv(i,k  ,jts+1)-rv(i,k  ,jts))+     &amp;<a name='12763'>
                       fzp(k)*(rv(i,k-1,jts+1)-rv(i,k-1,jts)))     &amp;<a name='12764'>
                                                                )<a name='12765'>
       ENDDO<a name='12766'>
       ENDDO<a name='12767'>
<a name='12768'>
       k = ktf+1<a name='12769'>
       DO i = i_start, i_end<a name='12770'>
         vw = 0.5*( (2.-fzm(k-1))*(rv(i,k-1,jts)+rv(i,k-1,jts+1))    &amp;<a name='12771'>
                   -fzp(k-1)*(rv(i,k-2,jts)+rv(i,k-2,jts+1))   )<a name='12772'>
         vb = MIN( vw, 0. )<a name='12773'>
<a name='12774'>
         tendency(i,k,jts) = tendency(i,k,jts)                     &amp;<a name='12775'>
               - rdy*(                                             &amp;<a name='12776'>
                       vb*(w_old(i,k,jts+1) - w_old(i,k,jts)) +    &amp;<a name='12777'>
                       w(i,k,jts)*(                                &amp;<a name='12778'>
                          (2.-fzm(k-1))*(rv(i,k-1,jts+1)-rv(i,k-1,jts))-     &amp;<a name='12779'>
                          fzp(k-1)*(rv(i,k-2,jts+1)-rv(i,k-2,jts)))     &amp;<a name='12780'>
                                                                )<a name='12781'>
       ENDDO<a name='12782'>
<a name='12783'>
   ENDIF<a name='12784'>
<a name='12785'>
   IF( (config_flags%open_ye) .and. (jte == jde) ) THEN<a name='12786'>
<a name='12787'>
       DO i = i_start, i_end<a name='12788'>
       DO k = kts+1, ktf<a name='12789'>
<a name='12790'>
         vw = 0.5*( fzm(k)*(rv(i,k  ,jte-1)+rv(i,k  ,jte)) +  &amp;<a name='12791'>
                    fzp(k)*(rv(i,k-1,jte-1)+rv(i,k-1,jte))   )<a name='12792'>
         vb = MAX( vw, 0. )<a name='12793'>
<a name='12794'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                     &amp;<a name='12795'>
               - rdy*(                                                 &amp;<a name='12796'>
                       vb*(w_old(i,k,j_end) - w_old(i,k,j_end-1)) +    &amp;<a name='12797'>
                       w(i,k,j_end)*(                                  &amp;<a name='12798'>
                            fzm(k)*(rv(i,k  ,jte)-rv(i,k  ,jte-1))+    &amp;<a name='12799'>
                            fzp(k)*(rv(i,k-1,jte)-rv(i,k-1,jte-1)))    &amp;<a name='12800'>
                                                                      )<a name='12801'>
       ENDDO<a name='12802'>
       ENDDO<a name='12803'>
<a name='12804'>
       k = ktf+1<a name='12805'>
       DO i = i_start, i_end<a name='12806'>
<a name='12807'>
         vw = 0.5*( (2.-fzm(k-1))*(rv(i,k-1,jte-1)+rv(i,k-1,jte))    &amp;<a name='12808'>
                   -fzp(k-1)*(rv(i,k-2,jte-1)+rv(i,k-2,jte))   )<a name='12809'>
         vb = MAX( vw, 0. )<a name='12810'>
<a name='12811'>
         tendency(i,k,j_end) = tendency(i,k,j_end)                     &amp;<a name='12812'>
               - rdy*(                                                 &amp;<a name='12813'>
                       vb*(w_old(i,k,j_end) - w_old(i,k,j_end-1)) +    &amp;<a name='12814'>
                       w(i,k,j_end)*(                                  &amp;<a name='12815'>
                               (2.-fzm(k-1))*(rv(i,k-1,jte)-rv(i,k-1,jte-1))-    &amp;<a name='12816'>
                               fzp(k-1)*(rv(i,k-2,jte)-rv(i,k-2,jte-1)))    &amp;<a name='12817'>
                                                                      )<a name='12818'>
       ENDDO<a name='12819'>
<a name='12820'>
   ENDIF<a name='12821'>
<a name='12822'>
<font color=#447700>!-------------------- vertical advection<a name='12823'></font>
<font color=#447700>!     ADT eqn 46 has 3rd term on RHS (dividing through by my) = - partial d/dz (w rho w /my)<a name='12824'></font>
<font color=#447700>!     Here we have:  - partial d/dz (w*rom) = - partial d/dz (w rho w / my)<a name='12825'></font>
<font color=#447700>!     Therefore we don't need to make a correction for advect_w<a name='12826'></font>
<a name='12827'>
      i_start = its<a name='12828'>
      i_end   = MIN(ite,ide-1)<a name='12829'>
      j_start = jts<a name='12830'>
      j_end   = MIN(jte,jde-1)<a name='12831'>
<a name='12832'>
      DO i = i_start, i_end<a name='12833'>
         vflux(i,kts)=0.<a name='12834'>
         vflux(i,kte)=0.<a name='12835'>
      ENDDO<a name='12836'>
<a name='12837'>
<font color=#447700>!    vert_order_test : IF (vert_order == 6) THEN    <a name='12838'></font>
<a name='12839'>
<font color=#447700>! ELSE IF (vert_order == 5) THEN    <a name='12840'></font>
<a name='12841'>
      DO j = j_start, j_end<a name='12842'>
<a name='12843'>
         DO k=kts+3,ktf-1<a name='12844'>
         DO i = i_start, i_end<a name='12845'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='12846'>
<a name='12847'>
         IF( -vel*sign(1,time_step) .ge. 0.0 ) THEN<a name='12848'>
            qip2 = w(i,k+1,j)<a name='12849'>
            qip1 = w(i,k  ,j)<a name='12850'>
            qi   = w(i,k-1,j)<a name='12851'>
            qim1 = w(i,k-2,j)<a name='12852'>
            qim2 = w(i,k-3,j)<a name='12853'>
          ELSE<a name='12854'>
            qip2 = w(i,k-2,j)<a name='12855'>
            qip1 = w(i,k-1,j)<a name='12856'>
            qi   = w(i,k  ,j)<a name='12857'>
            qim1 = w(i,k+1,j)<a name='12858'>
            qim2 = w(i,k+2,j)<a name='12859'>
         ENDIF<a name='12860'>
    <a name='12861'>
         f0 =  1./3.*qim2 - 7./6.*qim1 + 11./6.*qi<a name='12862'>
         f1 = -1./6.*qim1 + 5./6.*qi   + 1./3. *qip1<a name='12863'>
         f2 =  1./3.*qi   + 5./6.*qip1 - 1./6. *qip2<a name='12864'>
    <a name='12865'>
         beta0 = 13./12.*(qim2 - 2.*qim1 + qi  )**2 + 1./4.*(qim2 - 4.*qim1 + 3.*qi)**2<a name='12866'>
         beta1 = 13./12.*(qim1 - 2.*qi   + qip1)**2 + 1./4.*(qim1 - qip1)**2<a name='12867'>
         beta2 = 13./12.*(qi   - 2.*qip1 + qip2)**2 + 1./4.*(qip2 - 4.*qip1 + 3.*qi)**2<a name='12868'>
    <a name='12869'>
         wi0 = gi0 / (eps + beta0)**pw<a name='12870'>
         wi1 = gi1 / (eps + beta1)**pw<a name='12871'>
         wi2 = gi2 / (eps + beta2)**pw<a name='12872'>
    <a name='12873'>
         sumwk = wi0 + wi1 + wi2<a name='12874'>
    <a name='12875'>
          vflux(i,k) = vel * (wi0*f0 + wi1*f1 + wi2*f2) / sumwk<a name='12876'>
<a name='12877'>
<font color=#447700>!           vflux(i,k) = vel*flux5(                                   &amp;<a name='12878'></font>
<font color=#447700>!                   w(i,k-3,j), w(i,k-2,j), w(i,k-1,j),       &amp;<a name='12879'></font>
<font color=#447700>!                   w(i,k  ,j), w(i,k+1,j), w(i,k+2,j),  -vel )<a name='12880'></font>
         ENDDO<a name='12881'>
         ENDDO<a name='12882'>
<a name='12883'>
         DO i = i_start, i_end<a name='12884'>
<a name='12885'>
           k=kts+1<a name='12886'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='12887'>
                                   <a name='12888'>
           k = kts+2<a name='12889'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='12890'>
           vflux(i,k) = vel*flux3(               &amp;<a name='12891'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='12892'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='12893'>
           k = ktf<a name='12894'>
           vel=0.5*(rom(i,k,j)+rom(i,k-1,j))<a name='12895'>
           vflux(i,k) = vel*flux3(               &amp;<a name='12896'>
                   w(i,k-2,j), w(i,k-1,j),   &amp;<a name='12897'>
                   w(i,k  ,j), w(i,k+1,j), -vel )<a name='12898'>
<a name='12899'>
           k=ktf+1<a name='12900'>
           vflux(i,k)=0.25*(rom(i,k,j)+rom(i,k-1,j))*(w(i,k,j)+w(i,k-1,j))<a name='12901'>
<a name='12902'>
         ENDDO<a name='12903'>
<a name='12904'>
         DO k=kts+1,ktf<a name='12905'>
         DO i = i_start, i_end<a name='12906'>
            tendency(i,k,j)=tendency(i,k,j)-rdzu(k)*(vflux(i,k+1)-vflux(i,k))<a name='12907'>
         ENDDO<a name='12908'>
         ENDDO<a name='12909'>
<a name='12910'>
<font color=#447700>! pick up flux contribution for w at the lid, wcs. 13 march 2004<a name='12911'></font>
         k = ktf+1<a name='12912'>
         DO i = i_start, i_end<a name='12913'>
           tendency(i,k,j)=tendency(i,k,j)+2.*rdzu(k-1)*(vflux(i,k))<a name='12914'>
         ENDDO<a name='12915'>
<a name='12916'>
      ENDDO<a name='12917'>
<a name='12918'>
<a name='12919'>
END SUBROUTINE advect_weno_w<a name='12920'>
<a name='12921'>
<a name='12922'>
END MODULE module_advect_em<a name='12923'>
<a name='12924'>
#endif<a name='12925'>
</pre></body></html>