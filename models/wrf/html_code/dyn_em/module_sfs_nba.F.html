<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MODEL_LAYER:PHYSICS<a name='2'></font>
<a name='3'>
<font color=#447700>!==============================================================================<a name='4'></font>
<font color=#447700>!<a name='5'></font>
<font color=#447700>! Copyright 2009. Lawrence Livermore National Security, LLC. All rights reserved.<a name='6'></font>
<font color=#447700>! This work was produced at the Lawrence Livermore National Laboratory (LLNL) under<a name='7'></font>
<font color=#447700>! contract no. DE-AC52-07NA27344 (Contract 44) between the U.S. Department of Energy (DOE)<a name='8'></font>
<font color=#447700>! and Lawrence Livermore National Security, LLC (LLNS) for the operation of LLNL. Copyright<a name='9'></font>
<font color=#447700>! is reserved to Lawrence Livermore National Security, LLC for purposes of controlled<a name='10'></font>
<font color=#447700>! dissemination, commercialization through formal licensing, or other disposition under<a name='11'></font>
<font color=#447700>! terms of Contract 44; DOE policies, regulations and orders; and U.S. statutes. The rights<a name='12'></font>
<font color=#447700>! of the Federal Government are reserved under Contract 44.<a name='13'></font>
<font color=#447700>!<a name='14'></font>
<font color=#447700>! DISCLAIMER<a name='15'></font>
<font color=#447700>! This work was prepared as an account of work sponsored by an agency of the United States<a name='16'></font>
<font color=#447700>! Government. Neither the United States Government nor Lawrence Livermore National<a name='17'></font>
<font color=#447700>! Security, LLC nor any of their employees, makes any warranty, express or implied, or<a name='18'></font>
<font color=#447700>! assumes any liability or responsibility for the accuracy, completeness, or usefulness of<a name='19'></font>
<font color=#447700>! any information, apparatus, product, or process disclosed, or represents that its use<a name='20'></font>
<font color=#447700>! would not infringe privately-owned rights. Reference herein to any specific commercial<a name='21'></font>
<font color=#447700>! products, process, or service by trade name, trademark, manufacturer or otherwise does<a name='22'></font>
<font color=#447700>! not necessarily constitute or imply its endorsement, recommendation, or favoring by the<a name='23'></font>
<font color=#447700>! United States Government or Lawrence Livermore National Security, LLC. The views and<a name='24'></font>
<font color=#447700>! opinions of authors expressed herein do not necessarily state or reflect those of the<a name='25'></font>
<font color=#447700>! United States Government or Lawrence Livermore National Security, LLC, and shall not be<a name='26'></font>
<font color=#447700>! used for advertising or product endorsement purposes.<a name='27'></font>
<font color=#447700>!<a name='28'></font>
<font color=#447700>! LICENSING REQUIREMENTS<a name='29'></font>
<font color=#447700>! Any use, reproduction, modification, or distribution of this software or documentation<a name='30'></font>
<font color=#447700>! for commercial purposes requires a license from Lawrence Livermore National Security,<a name='31'></font>
<font color=#447700>! LLC. Contact: Lawrence Livermore National Laboratory, Industrial Partnerships Office,<a name='32'></font>
<font color=#447700>! P.O. Box 808, L-795, Livermore, CA 94551<a name='33'></font>
<font color=#447700>!<a name='34'></font>
<font color=#447700>!=============================================================================<a name='35'></font>
<font color=#447700>!<a name='36'></font>
<font color=#447700>! Modification History: <a name='37'></font>
<font color=#447700>!<a name='38'></font>
<font color=#447700>! Implemented 12/2009 by Jeff Mirocha, jmirocha@llnl.gov<a name='39'></font>
<font color=#447700>!<a name='40'></font>
<font color=#447700>!=============================================================================<a name='41'></font>
<a name='42'>
<A NAME='MODULE_SFS_NBA'><A href='../../html_code/dyn_em/module_sfs_nba.F.html#MODULE_SFS_NBA' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='43'>
<font color=#993300>MODULE </font><font color=#cc0000>module_sfs_nba</font> <A href='../../call_to/MODULE_SFS_NBA.html' TARGET='index'>1</A><a name='44'>
<a name='45'>
  USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_sfs_nba.F.html#module_sfs_nba.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_12">, ONLY : grid_config_rec_type<a name='46'>
<a name='47'>
  IMPLICIT NONE<a name='48'>
<a name='49'>
  REAL :: c1, c2, c3, ce, cb, cs <font color=#447700>! global model parameters           <a name='50'></font>
<a name='51'>
CONTAINS<a name='52'>
<a name='53'>
<font color=#447700>!=============================================================================<a name='54'></font>
<a name='55'>
<A NAME='CALC_MIJ_CONSTANTS'><A href='../../html_code/dyn_em/module_sfs_nba.F.html#CALC_MIJ_CONSTANTS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='56'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_mij_constants</font>( ) <A href='../../call_to/CALC_MIJ_CONSTANTS.html' TARGET='index'>1</A><a name='57'>
<a name='58'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='59'></font>
<font color=#447700>!<a name='60'></font>
<font color=#447700>! PURPOSE: Compute constants for Mij calculations <a name='61'></font>
<font color=#447700>!<a name='62'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='63'></font>
<a name='64'>
  IMPLICIT NONE<a name='65'>
<a name='66'>
  REAL :: sk, pi <font color=#447700>! local model parameters           <a name='67'></font>
<a name='68'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='69'></font>
<a name='70'>
  sk = 0.5<a name='71'>
  pi = 3.1415927<a name='72'>
  cb = 0.36<a name='73'>
<a name='74'>
  cs = ( ( 8.0*( 1.0+cb ) )/( 27.0*pi**2 ) )**0.5<a name='75'>
  c1 = ( ( 960.0**0.5 )*cb )/( 7.0*( 1.0+cb )*sk )<a name='76'>
  c2 = -c1<a name='77'>
  ce = ( ( 8.0*pi/27.0 )**( 1.0/3.0 ) )*cs**( 4.0/3.0 )<a name='78'>
  c3 = ( ( 27.0/( 8.0*pi ) )**( 1.0/3.0 ) )*cs**( 2.0/3.0 )<a name='79'>
<a name='80'>
  RETURN<a name='81'>
<a name='82'>
END SUBROUTINE calc_mij_constants<a name='83'>
<a name='84'>
<font color=#447700>!=============================================================================<a name='85'></font>
<a name='86'>
<A NAME='CALC_SMNSMN'><A href='../../html_code/dyn_em/module_sfs_nba.F.html#CALC_SMNSMN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='87'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_smnsmn</font>( smnsmn,                       &amp;                 <A href='../../call_to/CALC_SMNSMN.html' TARGET='index'>1</A><a name='88'>
                        s11, s22, s33,                &amp;<a name='89'>
                        s12, s13, s23,                &amp;<a name='90'>
                        config_flags,                 &amp;<a name='91'>
                        ids, ide, jds, jde, kds, kde, &amp;<a name='92'>
                        ims, ime, jms, jme, kms, kme, &amp;<a name='93'>
                        ips, ipe, jps, jpe, kps, kpe, &amp;<a name='94'>
                        its, ite, jts, jte, kts, kte  )<a name='95'>
<a name='96'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='97'></font>
<font color=#447700>!<a name='98'></font>
<font color=#447700>! PURPOSE: Compute Smn*Smn = S11^2 + S22^2 + S33^2 + 2*(S12^2 + S13^2 +S23^2) <a name='99'></font>
<font color=#447700>!<a name='100'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='101'></font>
<a name='102'>
  IMPLICIT NONE<a name='103'>
<a name='104'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( OUT ) &amp;<a name='105'>
  :: smnsmn        <font color=#447700>! Smn*Smn                             (s-2)<a name='106'></font>
 <a name='107'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( IN  ) &amp;<a name='108'>
  :: s11         &amp; <font color=#447700>! 2*deformation element 11            (s-1)<a name='109'></font>
   , s22         &amp; <font color=#447700>! 2*deformation element 22            (s-1)<a name='110'></font>
   , s33         &amp; <font color=#447700>! 2*deformation element 33            (s-1)<a name='111'></font>
   , s12         &amp; <font color=#447700>! 2*deformation element 12            (s-1)<a name='112'></font>
   , s13         &amp; <font color=#447700>! 2*deformation element 13            (s-1)<a name='113'></font>
   , s23           <font color=#447700>! 2*deformation element 23            (s-1)<a name='114'></font>
<a name='115'>
  TYPE (grid_config_rec_type),                           INTENT( IN  ) &amp;<a name='116'>
  :: config_flags<a name='117'>
<a name='118'>
  INTEGER,                                               INTENT( IN  ) &amp;<a name='119'>
  :: ids, ide, jds, jde, kds, kde, &amp;<a name='120'>
     ims, ime, jms, jme, kms, kme, &amp;<a name='121'>
     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='122'>
     its, ite, jts, jte, kts, kte<a name='123'>
<a name='124'>
<font color=#447700>! LOCAL VARIABLES ------------------------------------------------------------<a name='125'></font>
             <a name='126'>
  REAL :: tmp<a name='127'>
<a name='128'>
  INTEGER :: i, j, k, i_start, i_end, j_start, j_end, ktf<a name='129'>
<a name='130'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='131'></font>
<font color=#447700>!<a name='132'></font>
<font color=#447700>! Set loop limits,<a name='133'></font>
<font color=#447700>! taken from /dyn_em/module_diffusion_em.F SUBROUTINE smag_km   <a name='134'></font>
<font color=#447700>!<a name='135'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='136'></font>
   <a name='137'>
  ktf = min(kte,kde-1)<a name='138'>
<a name='139'>
  i_start = its<a name='140'>
  i_end   = MIN(ite,ide-1)<a name='141'>
  j_start = jts<a name='142'>
  j_end   = MIN(jte,jde-1)<a name='143'>
<a name='144'>
  IF ( config_flags%open_xs .or. config_flags%specified .or. &amp;<a name='145'>
       config_flags%nested) i_start = MAX(ids+1,its)<a name='146'>
  IF ( config_flags%open_xe .or. config_flags%specified .or. &amp;<a name='147'>
       config_flags%nested) i_end   = MIN(ide-2,ite)<a name='148'>
  IF ( config_flags%open_ys .or. config_flags%specified .or. &amp;<a name='149'>
       config_flags%nested) j_start = MAX(jds+1,jts)<a name='150'>
  IF ( config_flags%open_ye .or. config_flags%specified .or. &amp;<a name='151'>
       config_flags%nested) j_end   = MIN(jde-2,jte)<a name='152'>
  IF ( config_flags%periodic_x ) i_start = its<a name='153'>
  IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='154'>
<a name='155'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='156'></font>
<a name='157'>
<font color=#447700>! Below the 0.25 factor divides the incoming WRF deformations, <a name='158'></font>
<font color=#447700>! which are multiplied by a factor of 2, by 2<a name='159'></font>
<a name='160'>
  DO j=j_start,j_end<a name='161'>
  DO k=kts,ktf<a name='162'>
  DO i=i_start,i_end<a name='163'>
<a name='164'>
    smnsmn(i,k,j) = 0.25*( s11(i,k,j)*s11(i,k,j) + &amp;<a name='165'>
                           s22(i,k,j)*s22(i,k,j) + &amp;<a name='166'>
                           s33(i,k,j)*s33(i,k,j) )<a name='167'>
<a name='168'>
  END DO<a name='169'>
  END DO<a name='170'>
  END DO<a name='171'>
<a name='172'>
<font color=#447700>! Below the 0.125 factor accounts for the four-point averaging (0.25)<a name='173'></font>
<font color=#447700>! and divides the incoming WRF deformation elements by 2 (0.5) <a name='174'></font>
<a name='175'>
  DO j=j_start,j_end<a name='176'>
  DO k=kts,ktf<a name='177'>
  DO i=i_start,i_end<a name='178'>
<a name='179'>
    tmp = 0.125*( s12(i  ,k,j) + s12(i  ,k,j+1) + &amp;<a name='180'>
                  s12(i+1,k,j) + s12(i+1,k,j+1) )<a name='181'>
    smnsmn(i,k,j) = smnsmn(i,k,j) + 2.0*tmp*tmp<a name='182'>
<a name='183'>
  END DO<a name='184'>
  END DO<a name='185'>
  END DO<a name='186'>
<a name='187'>
  DO j=j_start,j_end<a name='188'>
  DO k=kts,ktf<a name='189'>
  DO i=i_start,i_end<a name='190'>
<a name='191'>
    tmp = 0.125*( s13(i  ,k+1,j) + s13(i  ,k,j) + &amp;<a name='192'>
                  s13(i+1,k+1,j) + s13(i+1,k,j) )<a name='193'>
    smnsmn(i,k,j) = smnsmn(i,k,j) + 2.0*tmp*tmp<a name='194'>
<a name='195'>
  END DO<a name='196'>
  END DO<a name='197'>
  END DO<a name='198'>
<a name='199'>
  DO j=j_start,j_end<a name='200'>
  DO k=kts,ktf<a name='201'>
  DO i=i_start,i_end<a name='202'>
<a name='203'>
    tmp = 0.125*( s23(i,k+1,j  ) + s23(i,k,j  ) + &amp;<a name='204'>
                  s23(i,k+1,j+1) + s23(i,k,j+1) )<a name='205'>
    smnsmn(i,k,j) = smnsmn(i,k,j) + 2.0*tmp*tmp<a name='206'>
  <a name='207'>
  END DO<a name='208'>
  END DO<a name='209'>
  END DO<a name='210'>
<a name='211'>
  RETURN<a name='212'>
<a name='213'>
END SUBROUTINE calc_smnsmn<a name='214'>
<a name='215'>
<font color=#447700>!=============================================================================<a name='216'></font>
<a name='217'>
<A NAME='CALC_MII'><A href='../../html_code/dyn_em/module_sfs_nba.F.html#CALC_MII' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='218'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_mii</font>( m11, m22, m33,                &amp; <A href='../../call_to/CALC_MII.html' TARGET='index'>1</A><a name='219'>
                     s11, s22, s33,                &amp;<a name='220'>
                     s12, s13, s23,                &amp;<a name='221'>
                     r12, r13, r23, smnsmn,        &amp;<a name='222'>
                     tke, rdzw, dx, dy,            &amp;<a name='223'>
                     config_flags,                 &amp;<a name='224'>
                     ids, ide, jds, jde, kds, kde, &amp;<a name='225'>
                     ims, ime, jms, jme, kms, kme, &amp;<a name='226'>
                     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='227'>
                     its, ite, jts, jte, kts, kte  )<a name='228'>
<a name='229'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='230'></font>
<font color=#447700>!<a name='231'></font>
<font color=#447700>! PURPOSE: Compute Mij for i = j<a name='232'></font>
<font color=#447700>!<a name='233'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='234'></font>
<a name='235'>
  IMPLICIT NONE<a name='236'>
<a name='237'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( OUT ) &amp;<a name='238'>
  :: m11         &amp; <font color=#447700>! NBA stress element 11               (m2 s-2)<a name='239'></font>
   , m22         &amp; <font color=#447700>! NBA stress element 22               (m2 s-2)<a name='240'></font>
   , m33           <font color=#447700>! NBA stress element 33               (m2 s-2)<a name='241'></font>
<a name='242'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( IN  ) &amp;<a name='243'>
  :: s11         &amp; <font color=#447700>! 2*deformation element 11            (s-1)<a name='244'></font>
   , s22         &amp; <font color=#447700>! 2*deformation element 22            (s-1)<a name='245'></font>
   , s33         &amp; <font color=#447700>! 2*deformation element 33            (s-1)<a name='246'></font>
   , s12         &amp; <font color=#447700>! 2*deformation element 12            (s-1)<a name='247'></font>
   , s13         &amp; <font color=#447700>! 2*deformation element 13            (s-1)<a name='248'></font>
   , s23         &amp; <font color=#447700>! 2*deformation element 23            (s-1)<a name='249'></font>
   , r12         &amp; <font color=#447700>! 2*rotation element 12               (s-1)<a name='250'></font>
   , r13         &amp; <font color=#447700>! 2*rotation element 13               (s-1)<a name='251'></font>
   , r23         &amp; <font color=#447700>! 2*rotation element 23               (s-1)<a name='252'></font>
   , smnsmn      &amp; <font color=#447700>! Smn*Smn                             (s-2)<a name='253'></font>
   , tke         &amp; <font color=#447700>! tke                                 (m2 s-2)<a name='254'></font>
   , rdzw          <font color=#447700>! 1/dz at w-levels                    (m-1)<a name='255'></font>
<a name='256'>
  REAL,                                                  INTENT( IN  ) &amp;<a name='257'>
  :: dx          &amp; <font color=#447700>! grid spacing in x                   (m)<a name='258'></font>
   , dy            <font color=#447700>! grid spacing in y                   (m) <a name='259'></font>
<a name='260'>
  TYPE (grid_config_rec_type),                           INTENT( IN  ) &amp;<a name='261'>
  :: config_flags<a name='262'>
<a name='263'>
  INTEGER,                                               INTENT( IN  ) &amp;<a name='264'>
  :: ids, ide, jds, jde, kds, kde, &amp;<a name='265'>
     ims, ime, jms, jme, kms, kme, &amp;<a name='266'>
     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='267'>
     its, ite, jts, jte, kts, kte<a name='268'>
<a name='269'>
<font color=#447700>! LOCAL VARIABLES ------------------------------------------------------------<a name='270'></font>
<a name='271'>
  REAL, DIMENSION( its-1:ite+1, kms:kme, jts-1:jte+1 ) &amp; <font color=#447700>! sij/2, rij/2<a name='272'></font>
  :: ss11        &amp; <a name='273'>
   , ss22        &amp; <a name='274'>
   , ss33        &amp; <a name='275'>
   , ss12        &amp; <a name='276'>
   , ss13        &amp; <a name='277'>
   , ss23        &amp;          <a name='278'>
   , rr12        &amp; <a name='279'>
   , rr13        &amp; <a name='280'>
   , rr23  <a name='281'>
<a name='282'>
  REAL, DIMENSION( its-1:ite+1, kms:kme, jts-1:jte+1 ) &amp; <font color=#447700>! projected to c<a name='283'></font>
  :: ss12c       &amp; <a name='284'>
   , rr12c       &amp; <a name='285'>
   , ss13c       &amp; <a name='286'>
   , rr13c       &amp; <a name='287'>
   , ss23c       &amp; <a name='288'>
   , rr23c    <a name='289'>
<a name='290'>
  REAL :: delta, a, b<a name='291'>
<a name='292'>
  INTEGER :: i, j, k, i_start, i_end, j_start, j_end, ktf, is_ext, js_ext<a name='293'>
<a name='294'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='295'></font>
<font color=#447700>!<a name='296'></font>
<font color=#447700>! Set loop limits,<a name='297'></font>
<font color=#447700>! taken from /dyn_em/module_diffusion_em.F SUBROUTINE cal_titau_11_22_33<a name='298'></font>
<font color=#447700>!<a name='299'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='300'></font>
<a name='301'>
  ktf = MIN( kte, kde-1 )<a name='302'>
<a name='303'>
  i_start = its<a name='304'>
  i_end   = ite<a name='305'>
  j_start = jts<a name='306'>
  j_end   = jte<a name='307'>
<a name='308'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='309'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='310'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='311'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='312'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='313'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='314'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='315'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='316'>
      IF ( config_flags%periodic_x ) i_start = its<a name='317'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='318'>
<a name='319'>
  is_ext = 1<a name='320'>
  js_ext = 1<a name='321'>
<a name='322'>
  i_start = i_start - is_ext  <a name='323'>
  j_start = j_start - js_ext   <a name='324'>
<a name='325'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='326'></font>
<font color=#447700>!<a name='327'></font>
<font color=#447700>! Divide WRF deformations, which are multiplied by 2, by 2<a name='328'></font>
<font color=#447700>!<a name='329'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='330'></font>
<a name='331'>
  DO j=j_start,j_end+1<a name='332'>
  DO k=kts,ktf<a name='333'>
  DO i=i_start,i_end+1<a name='334'>
<a name='335'>
    ss11(i,k,j)=s11(i,k,j)/2.0<a name='336'>
    ss22(i,k,j)=s22(i,k,j)/2.0<a name='337'>
    ss33(i,k,j)=s33(i,k,j)/2.0<a name='338'>
    ss12(i,k,j)=s12(i,k,j)/2.0<a name='339'>
    ss13(i,k,j)=s13(i,k,j)/2.0<a name='340'>
    ss23(i,k,j)=s23(i,k,j)/2.0<a name='341'>
    rr12(i,k,j)=r12(i,k,j)/2.0<a name='342'>
    rr13(i,k,j)=r13(i,k,j)/2.0<a name='343'>
    rr23(i,k,j)=r23(i,k,j)/2.0<a name='344'>
<a name='345'>
  END DO<a name='346'>
  END DO<a name='347'>
  END DO<a name='348'>
<a name='349'>
  DO j=j_start,j_end+1<a name='350'>
  DO i=i_start,i_end+1<a name='351'>
<a name='352'>
    ss13(i,kde,j) = 0.0<a name='353'>
    ss23(i,kde,j) = 0.0<a name='354'>
    rr13(i,kde,j) = 0.0<a name='355'>
    rr23(i,kde,j) = 0.0<a name='356'>
<a name='357'>
  END DO<a name='358'>
  END DO<a name='359'>
<a name='360'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='361'></font>
<font color=#447700>!<a name='362'></font>
<font color=#447700>! Project variables to c<a name='363'></font>
<font color=#447700>!<a name='364'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='365'></font>
<a name='366'>
  DO j = j_start, j_end<a name='367'>
  DO k = kts, ktf<a name='368'>
  DO i = i_start, i_end<a name='369'>
<a name='370'>
    ss12c(i,k,j) = 0.25*( ss12(i  ,k  ,j  ) + ss12(i  ,k  ,j+1) + &amp;<a name='371'>
                          ss12(i+1,k  ,j  ) + ss12(i+1,k  ,j+1) )<a name='372'>
<a name='373'>
    rr12c(i,k,j) = 0.25*( rr12(i  ,k  ,j  ) + rr12(i  ,k  ,j+1) + &amp;<a name='374'>
                          rr12(i+1,k  ,j  ) + rr12(i+1,k  ,j+1) )<a name='375'>
<a name='376'>
    ss13c(i,k,j) = 0.25*( ss13(i  ,k+1,j  ) + ss13(i  ,k  ,j  ) + &amp;<a name='377'>
                          ss13(i+1,k+1,j  ) + ss13(i+1,k  ,j  ) )<a name='378'>
<a name='379'>
    rr13c(i,k,j) = 0.25*( rr13(i  ,k+1,j  ) + rr13(i  ,k  ,j  ) + &amp;<a name='380'>
                          rr13(i+1,k+1,j  ) + rr13(i+1,k  ,j  ) )<a name='381'>
<a name='382'>
    ss23c(i,k,j) = 0.25*( ss23(i  ,k+1,j  ) + ss23(i  ,k  ,j  ) + &amp;<a name='383'>
                          ss23(i  ,k+1,j+1) + ss23(i  ,k  ,j+1) )<a name='384'>
<a name='385'>
    rr23c(i,k,j) = 0.25*( rr23(i  ,k+1,j  ) + rr23(i  ,k  ,j  ) + &amp;<a name='386'>
                          rr23(i  ,k+1,j+1) + rr23(i  ,k  ,j+1) )<a name='387'>
<a name='388'>
  ENDDO<a name='389'>
  ENDDO<a name='390'>
  ENDDO<a name='391'>
<a name='392'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='393'></font>
<font color=#447700>!<a name='394'></font>
<font color=#447700>! Calculate M11, M22 and M33<a name='395'></font>
<font color=#447700>!<a name='396'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='397'></font>
<a name='398'>
  IF ( config_flags%sfs_opt .EQ. 1 ) THEN <font color=#447700>!Do not use TKE<a name='399'></font>
<a name='400'>
    DO j=j_start,j_end<a name='401'>
    DO k=kts,ktf<a name='402'>
    DO i=i_start,i_end<a name='403'>
<a name='404'>
      delta = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='405'>
      a = -1.0*( cs*delta )**2<a name='406'>
<a name='407'>
      m11(i,k,j) = a*(   2.0*sqrt( 2.0*smnsmn(i,k,j) )*ss11(i,k,j) &amp;<a name='408'>
                       + c1*(   ss11(i,k,j) *ss11(i,k,j)           &amp;<a name='409'>
                              + ss12c(i,k,j)*ss12c(i,k,j)          &amp;<a name='410'>
                              + ss13c(i,k,j)*ss13c(i,k,j)          &amp;<a name='411'>
                              - smnsmn(i,k,j)/3.0                  &amp;<a name='412'>
                            )                                      &amp;<a name='413'>
                       + c2*( -2.0*(   ss12c(i,k,j)*rr12c(i,k,j)   &amp;<a name='414'>
                                     + ss13c(i,k,j)*rr13c(i,k,j)   &amp;<a name='415'>
                                   )                               &amp;<a name='416'>
                            )                                      &amp;<a name='417'>
                     )<a name='418'>
<a name='419'>
      m22(i,k,j) = a*(   2.0*sqrt( 2.0*smnsmn(i,k,j) )*ss22(i,k,j) &amp;<a name='420'>
                       + c1*(   ss22(i,k,j) *ss22(i,k,j)           &amp;<a name='421'>
                              + ss12c(i,k,j)*ss12c(i,k,j)          &amp;<a name='422'>
                              + ss23c(i,k,j)*ss23c(i,k,j)          &amp;<a name='423'>
                              - smnsmn(i,k,j)/3.0                  &amp;<a name='424'>
                            )                                      &amp;<a name='425'>
                       + c2*(  2.0*(   ss12c(i,k,j)*rr12c(i,k,j)   &amp;<a name='426'>
                                     - ss23c(i,k,j)*rr23c(i,k,j)   &amp;<a name='427'>
                                   )                               &amp;<a name='428'>
                            )                                      &amp;<a name='429'>
                     )<a name='430'>
<a name='431'>
      m33(i,k,j) = a*(   2.0*sqrt( 2.0*smnsmn(i,k,j) )*ss33(i,k,j) &amp;<a name='432'>
                       + c1*(   ss33(i,k,j) *ss33(i,k,j)            &amp;<a name='433'>
                              + ss13c(i,k,j)*ss13c(i,k,j)          &amp;<a name='434'>
                              + ss23c(i,k,j)*ss23c(i,k,j)          &amp;<a name='435'>
                              - smnsmn(i,k,j)/3.0                  &amp;<a name='436'>
                            )                                      &amp;<a name='437'>
                       + c2*(  2.0*(   ss13c(i,k,j)*rr13c(i,k,j)   &amp;<a name='438'>
                                     + ss23c(i,k,j)*rr23c(i,k,j)   &amp;<a name='439'>
                                   )                               &amp;<a name='440'>
                            )                                      &amp;<a name='441'>
                     )<a name='442'>
<a name='443'>
    ENDDO<a name='444'>
    ENDDO<a name='445'>
    ENDDO<a name='446'>
 <a name='447'>
  ELSE <font color=#447700>!(config_flags%sfs_opt .EQ. 2) Use TKE<a name='448'></font>
<a name='449'>
    DO j=j_start,j_end<a name='450'>
    DO k=kts,ktf<a name='451'>
    DO i=i_start,i_end<a name='452'>
<a name='453'>
      delta = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='454'>
      a = -1.0*ce*delta<a name='455'>
      b = c3*delta<a name='456'>
<a name='457'>
      m11(i,k,j) = a*(   2.0*sqrt( tke(i,k,j) )*ss11(i,k,j)            &amp;<a name='458'>
                       + b*(                                           &amp;<a name='459'>
                               c1*(   ss11(i,k,j) *ss11(i,k,j)         &amp;<a name='460'>
                                    + ss12c(i,k,j)*ss12c(i,k,j)        &amp;<a name='461'>
                                    + ss13c(i,k,j)*ss13c(i,k,j)        &amp;<a name='462'>
                                    - smnsmn(i,k,j)/3.0                &amp;<a name='463'>
                                          )                            &amp;<a name='464'>
                             + c2*( -2.0*(   ss12c(i,k,j)*rr12c(i,k,j) &amp;<a name='465'>
                                           + ss13c(i,k,j)*rr13c(i,k,j) &amp;<a name='466'>
                                         )                             &amp;<a name='467'>
                                  )                                    &amp;<a name='468'>
                           )                                           &amp;<a name='469'>
                     )<a name='470'>
<a name='471'>
      m22(i,k,j) = a*(   2.0*sqrt( tke(i,k,j) )*ss22(i,k,j)            &amp;<a name='472'>
                       + b*(                                           &amp;<a name='473'>
                               c1*(   ss22(i,k,j) *ss22(i,k,j)         &amp;<a name='474'>
                                    + ss12c(i,k,j)*ss12c(i,k,j)        &amp;<a name='475'>
                                    + ss23c(i,k,j)*ss23c(i,k,j)        &amp;<a name='476'>
                                    - smnsmn(i,k,j)/3.0                &amp;<a name='477'>
                                            )                          &amp;<a name='478'>
                             + c2*(  2.0*(   ss12c(i,k,j)*rr12c(i,k,j) &amp;<a name='479'>
                                           - ss23c(i,k,j)*rr23c(i,k,j) &amp;<a name='480'>
                                         )                             &amp;<a name='481'>
                                  )                                    &amp;<a name='482'>
                           )                                           &amp;<a name='483'>
                     )<a name='484'>
<a name='485'>
      m33(i,k,j) = a*(   2.0*sqrt( tke(i,k,j) )*ss33(i,k,j)            &amp;<a name='486'>
                       + b*(                                           &amp;<a name='487'>
                               c1*(   ss33(i,k,j) *ss33(i,k,j)         &amp;<a name='488'>
                                    + ss13c(i,k,j)*ss13c(i,k,j)        &amp;<a name='489'>
                                    + ss23c(i,k,j)*ss23c(i,k,j)        &amp;<a name='490'>
                                    - smnsmn(i,k,j)/3.0                &amp;<a name='491'>
                                  )                                    &amp;<a name='492'>
                             + c2*(  2.0*(   ss13c(i,k,j)*rr13c(i,k,j) &amp;<a name='493'>
                                           + ss23c(i,k,j)*rr23c(i,k,j) &amp;<a name='494'>
                                         )                             &amp;<a name='495'>
                                  )                                    &amp;<a name='496'>
                           )                                           &amp;<a name='497'>
                     )<a name='498'>
 <a name='499'>
<a name='500'>
    ENDDO<a name='501'>
    ENDDO<a name='502'>
    ENDDO<a name='503'>
<a name='504'>
  ENDIF<a name='505'>
<a name='506'>
  RETURN<a name='507'>
<a name='508'>
END SUBROUTINE calc_mii<a name='509'>
<a name='510'>
<font color=#447700>!=============================================================================<a name='511'></font>
<a name='512'>
<A NAME='CALC_M12'><A href='../../html_code/dyn_em/module_sfs_nba.F.html#CALC_M12' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='513'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_m12</font>( m12,                          &amp; <A href='../../call_to/CALC_M12.html' TARGET='index'>1</A><a name='514'>
                     s11, s22,                     &amp;<a name='515'>
                     s12, s13, s23,                &amp;<a name='516'>
                     r12, r13, r23, smnsmn,        &amp;<a name='517'>
                     tke, rdzw, dx, dy,            &amp;<a name='518'>
                     config_flags,                 &amp;<a name='519'>
                     ids, ide, jds, jde, kds, kde, &amp;<a name='520'>
                     ims, ime, jms, jme, kms, kme, &amp;<a name='521'>
                     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='522'>
                     its, ite, jts, jte, kts, kte  )<a name='523'>
<a name='524'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='525'></font>
<font color=#447700>!<a name='526'></font>
<font color=#447700>! PURPOSE: Compute M12<a name='527'></font>
<font color=#447700>!<a name='528'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='529'></font>
<a name='530'>
  IMPLICIT NONE<a name='531'>
<a name='532'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( OUT ) &amp;<a name='533'>
  :: m12           <font color=#447700>! NBA stress element 12               (m2 s-2)<a name='534'></font>
<a name='535'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( IN  ) &amp;<a name='536'>
  :: s11         &amp; <font color=#447700>! 2*deformation element 11            (s-1)<a name='537'></font>
   , s22         &amp; <font color=#447700>! 2*deformation element 22            (s-1)   <a name='538'></font>
   , s12         &amp; <font color=#447700>! 2*deformation element 12            (s-1)<a name='539'></font>
   , s13         &amp; <font color=#447700>! 2*deformation element 13            (s-1)<a name='540'></font>
   , s23         &amp; <font color=#447700>! 2*deformation element 23            (s-1)<a name='541'></font>
   , r12         &amp; <font color=#447700>! 2*rotation element 12               (s-1)<a name='542'></font>
   , r13         &amp; <font color=#447700>! 2*rotation element 13               (s-1)<a name='543'></font>
   , r23         &amp; <font color=#447700>! 2*rotation element 23               (s-1)<a name='544'></font>
   , smnsmn      &amp; <font color=#447700>! Smn*Smn                             (s-2)<a name='545'></font>
   , tke         &amp; <font color=#447700>! tke                                 (m2 s-2)<a name='546'></font>
   , rdzw          <font color=#447700>! 1/dz at w-levels                    (m-1)<a name='547'></font>
<a name='548'>
  REAL,                                                  INTENT( IN  ) &amp;<a name='549'>
  :: dx          &amp; <font color=#447700>! grid spacing in x                   (m)<a name='550'></font>
   , dy            <font color=#447700>! grid spacing in y                   (m)<a name='551'></font>
<a name='552'>
  TYPE (grid_config_rec_type),                           INTENT( IN  ) &amp;<a name='553'>
  :: config_flags<a name='554'>
<a name='555'>
  INTEGER,                                               INTENT( IN  ) &amp;<a name='556'>
  :: ids, ide, jds, jde, kds, kde, &amp;<a name='557'>
     ims, ime, jms, jme, kms, kme, &amp;<a name='558'>
     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='559'>
     its, ite, jts, jte, kts, kte<a name='560'>
<a name='561'>
<font color=#447700>! LOCAL VARIABLES ------------------------------------------------------------<a name='562'></font>
<a name='563'>
  REAL, DIMENSION( its-1:ite+1, kms:kme, jts-1:jte+1 ) &amp; <font color=#447700>! sij/2, rij/2<a name='564'></font>
  :: ss11        &amp; <a name='565'>
   , ss22        &amp;  <a name='566'>
   , ss12        &amp;  <a name='567'>
   , ss13        &amp; <a name='568'>
   , ss23        &amp; <a name='569'>
   , rr12        &amp; <a name='570'>
   , rr13        &amp; <a name='571'>
   , rr23  <a name='572'>
<a name='573'>
<a name='574'>
  REAL, DIMENSION( its-1:ite+1, kms:kme, jts-1:jte+1 ) &amp; <font color=#447700>! projected to d<a name='575'></font>
  :: tked        &amp; <a name='576'>
   , ss11d       &amp; <a name='577'>
   , ss22d       &amp; <a name='578'>
   , ss13d       &amp; <a name='579'>
   , ss23d       &amp; <a name='580'>
   , rr13d       &amp; <a name='581'>
   , rr23d       &amp;          <a name='582'>
   , smnsmnd    <a name='583'>
<a name='584'>
  REAL :: delta, a, b<a name='585'>
<a name='586'>
  INTEGER :: i, j, k, i_start, i_end, j_start, j_end, ktf, je_ext, ie_ext<a name='587'>
<a name='588'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='589'></font>
<font color=#447700>!<a name='590'></font>
<font color=#447700>! Set loop limits,<a name='591'></font>
<font color=#447700>! taken from /dyn_em/module_diffusion_em.F SUBROUTINE cal_titau_12_21<a name='592'></font>
<font color=#447700>!<a name='593'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='594'></font>
<a name='595'>
  ktf = MIN( kte, kde-1 )<a name='596'>
<a name='597'>
<font color=#447700>! Needs one more point in the x and y directions.<a name='598'></font>
<a name='599'>
  i_start = its<a name='600'>
  i_end   = ite<a name='601'>
  j_start = jts<a name='602'>
  j_end   = jte<a name='603'>
<a name='604'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='605'>
         config_flags%nested ) i_start = MAX( ids+1, its )<a name='606'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='607'>
         config_flags%nested ) i_end   = MIN( ide-1, ite )<a name='608'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='609'>
         config_flags%nested ) j_start = MAX( jds+1, jts )<a name='610'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='611'>
         config_flags%nested ) j_end   = MIN( jde-1, jte )<a name='612'>
      IF ( config_flags%periodic_x ) i_start = its<a name='613'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='614'>
<a name='615'>
  je_ext = 1<a name='616'>
  ie_ext = 1<a name='617'>
<a name='618'>
  i_end = i_end + ie_ext  <a name='619'>
  j_end = j_end + je_ext   <a name='620'>
<a name='621'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='622'></font>
<font color=#447700>!<a name='623'></font>
<font color=#447700>! Divide WRF deformations, which are multiplied by 2, by 2<a name='624'></font>
<font color=#447700>!<a name='625'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='626'></font>
<a name='627'>
  DO j=j_start-1,j_end<a name='628'>
  DO k=kts,ktf<a name='629'>
  DO i=i_start-1,i_end<a name='630'>
<a name='631'>
    ss11(i,k,j)=s11(i,k,j)/2.0<a name='632'>
    ss22(i,k,j)=s22(i,k,j)/2.0<a name='633'>
    ss12(i,k,j)=s12(i,k,j)/2.0<a name='634'>
    ss13(i,k,j)=s13(i,k,j)/2.0<a name='635'>
    ss23(i,k,j)=s23(i,k,j)/2.0<a name='636'>
    rr12(i,k,j)=r12(i,k,j)/2.0<a name='637'>
    rr13(i,k,j)=r13(i,k,j)/2.0<a name='638'>
    rr23(i,k,j)=r23(i,k,j)/2.0<a name='639'>
<a name='640'>
  END DO<a name='641'>
  END DO<a name='642'>
  END DO<a name='643'>
<a name='644'>
  DO j=j_start-1,j_end<a name='645'>
  DO i=i_start-1,i_end<a name='646'>
<a name='647'>
    ss13(i,kde,j) = 0.0<a name='648'>
    ss23(i,kde,j) = 0.0<a name='649'>
    rr13(i,kde,j) = 0.0<a name='650'>
    rr23(i,kde,j) = 0.0<a name='651'>
<a name='652'>
  END DO<a name='653'>
  END DO<a name='654'>
<a name='655'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='656'></font>
<font color=#447700>!<a name='657'></font>
<font color=#447700>! Project variables to d<a name='658'></font>
<font color=#447700>!<a name='659'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='660'></font>
<a name='661'>
  DO j = j_start, j_end<a name='662'>
  DO k = kts, ktf<a name='663'>
  DO i = i_start, i_end<a name='664'>
<a name='665'>
    tked(i,k,j) = 0.25*( tke(i-1,k  ,j  ) + tke(i  ,k  ,j  ) + &amp;<a name='666'>
                         tke(i-1,k  ,j-1) + tke(i  ,k  ,j-1) )<a name='667'>
<a name='668'>
    smnsmnd(i,k,j) = 0.25*( smnsmn(i-1,k  ,j  ) + smnsmn(i  ,k  ,j  ) + &amp;<a name='669'>
                            smnsmn(i-1,k  ,j-1) + smnsmn(i  ,k  ,j-1) )<a name='670'>
<a name='671'>
    ss11d(i,k,j) = 0.25*( ss11(i-1,k  ,j  ) + ss11(i  ,k  ,j  ) + &amp;<a name='672'>
                          ss11(i-1,k  ,j-1) + ss11(i  ,k  ,j-1) )<a name='673'>
<a name='674'>
    ss22d(i,k,j) = 0.25*( ss22(i-1,k  ,j  ) + ss22(i  ,k  ,j  ) + &amp;<a name='675'>
                          ss22(i-1,k  ,j-1) + ss22(i  ,k  ,j-1) )<a name='676'>
<a name='677'>
    ss13d(i,k,j) = 0.25*( ss13(i  ,k+1,j  ) + ss13(i  ,k+1,j-1) + &amp;<a name='678'>
                          ss13(i  ,k  ,j  ) + ss13(i  ,k  ,j-1) )<a name='679'>
<a name='680'>
    rr13d(i,k,j) = 0.25*( rr13(i  ,k+1,j  ) + rr13(i  ,k+1,j-1) + &amp;<a name='681'>
                          rr13(i  ,k  ,j  ) + rr13(i  ,k  ,j-1) )<a name='682'>
<a name='683'>
    ss23d(i,k,j) = 0.25*( ss23(i  ,k+1,j  ) + ss23(i-1,k+1,j  ) + &amp;<a name='684'>
                          ss23(i  ,k  ,j  ) + ss23(i-1,k  ,j  ) )<a name='685'>
<a name='686'>
    rr23d(i,k,j) = 0.25*( rr23(i  ,k+1,j  ) + rr23(i-1,k+1,j  ) + &amp;<a name='687'>
                          rr23(i  ,k  ,j  ) + rr23(i-1,k  ,j  ) )<a name='688'>
<a name='689'>
  END DO<a name='690'>
  END DO<a name='691'>
  END DO<a name='692'>
<a name='693'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='694'></font>
<font color=#447700>!<a name='695'></font>
<font color=#447700>! Calculate M12<a name='696'></font>
<font color=#447700>!<a name='697'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='698'></font>
<a name='699'>
  IF ( config_flags%sfs_opt .EQ. 1 ) THEN <font color=#447700>!Do not use TKE<a name='700'></font>
<a name='701'>
    DO j=j_start,j_end<a name='702'>
    DO k=kts,ktf<a name='703'>
    DO i=i_start,i_end<a name='704'>
<a name='705'>
      delta = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='706'>
      a = -1.0*( cs*delta )**2<a name='707'>
<a name='708'>
      m12(i,k,j) = a*(   2.0*sqrt( 2.0*smnsmnd(i,k,j) )*ss12(i,k,j) &amp;<a name='709'>
                       + c1*(   ss11d(i,k,j)*ss12(i,k,j)            &amp;<a name='710'>
                              + ss22d(i,k,j)*ss12(i,k,j)            &amp;<a name='711'>
                              + ss13d(i,k,j)*ss23d(i,k,j)           &amp;<a name='712'>
                            )                                       &amp;<a name='713'>
                       + c2*(   ss11d(i,k,j)*rr12(i,k,j)            &amp;<a name='714'>
                              - ss13d(i,k,j)*rr23d(i,k,j)           &amp; <a name='715'>
                              - ss22d(i,k,j)*rr12(i,k,j)            &amp;<a name='716'>
                              - ss23d(i,k,j)*rr13d(i,k,j)           &amp;<a name='717'>
                            )                                       &amp;<a name='718'>
                      )<a name='719'>
<a name='720'>
    ENDDO<a name='721'>
    ENDDO<a name='722'>
    ENDDO<a name='723'>
<a name='724'>
  ELSE <font color=#447700>!(config_flags%sfs_opt .EQ. 2) Use TKE<a name='725'></font>
<a name='726'>
    DO j=j_start,j_end<a name='727'>
    DO k=kts,ktf<a name='728'>
    DO i=i_start,i_end <a name='729'>
<a name='730'>
      delta = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='731'>
      a = -1.0*ce*delta<a name='732'>
      b = c3*delta<a name='733'>
<a name='734'>
      m12(i,k,j) = a*(   2.0*sqrt( tked(i,k,j) )*s12(i,k,j)     &amp;<a name='735'>
                       + b*(                                    &amp;<a name='736'>
                               c1*(   ss11d(i,k,j)*ss12(i,k,j)  &amp;<a name='737'>
                                    + ss22d(i,k,j)*ss12(i,k,j)  &amp;<a name='738'>
                                    + ss13d(i,k,j)*ss23d(i,k,j) &amp;<a name='739'>
                                  )                             &amp;<a name='740'>
                             + c2*(   ss11d(i,k,j)*rr12(i,k,j)  &amp;<a name='741'>
                                    - ss13d(i,k,j)*rr23d(i,k,j) &amp;<a name='742'>
                                    - ss22d(i,k,j)*rr12(i,k,j)  &amp;<a name='743'>
                                    - ss23d(i,k,j)*rr13d(i,k,j) &amp;<a name='744'>
                                  )                             &amp;<a name='745'>
                           )                                    &amp;<a name='746'>
                     )<a name='747'>
    ENDDO<a name='748'>
    ENDDO<a name='749'>
    ENDDO<a name='750'>
<a name='751'>
  ENDIF<a name='752'>
<a name='753'>
  RETURN<a name='754'>
<a name='755'>
END SUBROUTINE calc_m12<a name='756'>
<a name='757'>
<font color=#447700>!=============================================================================<a name='758'></font>
<a name='759'>
<A NAME='CALC_M13'><A href='../../html_code/dyn_em/module_sfs_nba.F.html#CALC_M13' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='760'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_m13</font>( m13,                          &amp; <A href='../../call_to/CALC_M13.html' TARGET='index'>1</A><a name='761'>
                     s11, s33,                     &amp;<a name='762'>
                     s12, s13, s23,                &amp;<a name='763'>
                     r12, r13, r23, smnsmn,        &amp;<a name='764'>
                     tke, rdzw, dx, dy,            &amp;<a name='765'>
                     fnm, fnp,                     &amp;<a name='766'>
                     config_flags,                 &amp;<a name='767'>
                     ids, ide, jds, jde, kds, kde, &amp;<a name='768'>
                     ims, ime, jms, jme, kms, kme, &amp;<a name='769'>
                     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='770'>
                     its, ite, jts, jte, kts, kte  )<a name='771'>
<a name='772'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='773'></font>
<font color=#447700>!<a name='774'></font>
<font color=#447700>! PURPOSE: Compute M13<a name='775'></font>
<font color=#447700>!<a name='776'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='777'></font>
<a name='778'>
  IMPLICIT NONE<a name='779'>
<a name='780'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( OUT ) &amp;<a name='781'>
  :: m13           <font color=#447700>!                                     (m2 s-2)<a name='782'></font>
<a name='783'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( IN  ) &amp;<a name='784'>
  :: s11         &amp; <font color=#447700>! 2*deformation element 11            (s-1)<a name='785'></font>
   , s33         &amp; <font color=#447700>! 2*deformation element 33            (s-1)<a name='786'></font>
   , s12         &amp; <font color=#447700>! 2*deformation element 12            (s-1)<a name='787'></font>
   , s13         &amp; <font color=#447700>! 2*deformation element 13            (s-1)<a name='788'></font>
   , s23         &amp; <font color=#447700>! 2*deformation element 23            (s-1)<a name='789'></font>
   , r12         &amp; <font color=#447700>! 2*rotation element 12               (s-1)<a name='790'></font>
   , r13         &amp; <font color=#447700>! 2*rotation element 13               (s-1)<a name='791'></font>
   , r23         &amp; <font color=#447700>! 2*rotation element 23               (s-1)<a name='792'></font>
   , smnsmn      &amp; <font color=#447700>! Smn*Smn                             (s-2)<a name='793'></font>
   , tke         &amp; <font color=#447700>! tke                                 (m2 s-2)<a name='794'></font>
   , rdzw          <font color=#447700>! 1/dz at w-levels                    (m-1)<a name='795'></font>
<a name='796'>
  REAL,                                                  INTENT( IN  ) &amp;<a name='797'>
  :: dx          &amp; <font color=#447700>! grid spacing in x                   (m)<a name='798'></font>
   , dy            <font color=#447700>! grid spacing in y                   (m)<a name='799'></font>
<a name='800'>
  REAL, DIMENSION( kms:kme ),                            INTENT( IN  ) &amp;<a name='801'>
  :: fnm         &amp; <font color=#447700>! vertical interpolation coefficients<a name='802'></font>
   , fnp           <font color=#447700>!<a name='803'></font>
<a name='804'>
  TYPE (grid_config_rec_type),                           INTENT( IN  ) &amp;<a name='805'>
  :: config_flags<a name='806'>
<a name='807'>
  INTEGER,                                               INTENT( IN  ) &amp;<a name='808'>
  :: ids, ide, jds, jde, kds, kde, &amp;<a name='809'>
     ims, ime, jms, jme, kms, kme, &amp;<a name='810'>
     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='811'>
     its, ite, jts, jte, kts, kte<a name='812'>
<a name='813'>
<font color=#447700>! LOCAL VARIABLES ------------------------------------------------------------<a name='814'></font>
<a name='815'>
  REAL, DIMENSION( its-1:ite+1, kms:kme, jts-1:jte+1 ) &amp; <font color=#447700>! sij/2, rij/2<a name='816'></font>
  :: ss11        &amp; <a name='817'>
   , ss33        &amp;  <a name='818'>
   , ss12        &amp;  <a name='819'>
   , ss13        &amp; <a name='820'>
   , ss23        &amp; <a name='821'>
   , rr12        &amp; <a name='822'>
   , rr13        &amp; <a name='823'>
   , rr23  <a name='824'>
<a name='825'>
  REAL, DIMENSION( its-1:ite+1, kms:kme, jts-1:jte+1 ) &amp; <font color=#447700>! projected to e<a name='826'></font>
  :: tkee        &amp; <a name='827'>
   , ss11e       &amp; <a name='828'>
   , ss33e       &amp; <a name='829'>
   , ss12e       &amp; <a name='830'>
   , ss23e       &amp; <a name='831'>
   , rr12e       &amp; <a name='832'>
   , rr23e       &amp;          <a name='833'>
   , smnsmne <a name='834'>
<a name='835'>
  REAL :: delta, a, b<a name='836'>
<a name='837'>
  INTEGER :: i, j, k, i_start, i_end, j_start, j_end, ktf, ie_ext<a name='838'>
<a name='839'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='840'></font>
<font color=#447700>!<a name='841'></font>
<font color=#447700>! Set loop limits,<a name='842'></font>
<font color=#447700>! taken from /dyn_em/module_diffusion_em.F SUBROUTINE cal_titau_13_31<a name='843'></font>
<font color=#447700>!<a name='844'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='845'></font>
<a name='846'>
  ktf = MIN( kte, kde-1 )<a name='847'>
<a name='848'>
<font color=#447700>! Find ide-1 and jde-1 for averaging to p point.<a name='849'></font>
<a name='850'>
  i_start = its<a name='851'>
  i_end   = ite<a name='852'>
  j_start = jts<a name='853'>
  j_end   = MIN( jte, jde-1 )<a name='854'>
<a name='855'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='856'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='857'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='858'>
         config_flags%nested) i_end   = MIN( ide-1, ite )<a name='859'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='860'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='861'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='862'>
         config_flags%nested) j_end   = MIN( jde-2, jte )<a name='863'>
      IF ( config_flags%periodic_x ) i_start = its<a name='864'>
      IF ( config_flags%periodic_x ) i_end = ite<a name='865'>
<a name='866'>
  ie_ext = 1<a name='867'>
  i_end = i_end + ie_ext   <a name='868'>
<a name='869'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='870'></font>
<font color=#447700>!<a name='871'></font>
<font color=#447700>! Divide WRF deformations, which are multiplied by 2, by 2<a name='872'></font>
<font color=#447700>!<a name='873'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='874'></font>
<a name='875'>
  DO j=j_start,j_end+1<a name='876'>
  DO k=kts,ktf<a name='877'>
  DO i=i_start-1,i_end<a name='878'>
<a name='879'>
    ss11(i,k,j)=s11(i,k,j)/2.0<a name='880'>
    ss33(i,k,j)=s33(i,k,j)/2.0<a name='881'>
    ss12(i,k,j)=s12(i,k,j)/2.0<a name='882'>
    ss13(i,k,j)=s13(i,k,j)/2.0<a name='883'>
    ss23(i,k,j)=s23(i,k,j)/2.0<a name='884'>
    rr12(i,k,j)=r12(i,k,j)/2.0<a name='885'>
    rr13(i,k,j)=r13(i,k,j)/2.0<a name='886'>
    rr23(i,k,j)=r23(i,k,j)/2.0<a name='887'>
<a name='888'>
  END DO<a name='889'>
  END DO<a name='890'>
  END DO<a name='891'>
<a name='892'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='893'></font>
<font color=#447700>!<a name='894'></font>
<font color=#447700>! Project variables to e<a name='895'></font>
<font color=#447700>!<a name='896'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='897'></font>
<a name='898'>
  DO j = j_start, j_end<a name='899'>
  DO k = kts+1, ktf<a name='900'>
  DO i = i_start, i_end<a name='901'>
<a name='902'>
    tkee(i,k,j) = 0.5*( fnm(k)*( tke(i,k  ,j) + tke(i-1,k  ,j) ) + &amp;<a name='903'>
                        fnp(k)*( tke(i,k-1,j) + tke(i-1,k-1,j) ) )<a name='904'>
<a name='905'>
    smnsmne(i,k,j) = 0.5*( fnm(k)*( smnsmn(i,k  ,j) + smnsmn(i-1,k  ,j) ) + &amp;<a name='906'>
                           fnp(k)*( smnsmn(i,k-1,j) + smnsmn(i-1,k-1,j) ) )<a name='907'>
<a name='908'>
    ss11e(i,k,j) = 0.5*( fnm(k)*( ss11(i  ,k  ,j  ) + ss11(i-1,k  ,j  ) ) + &amp;<a name='909'>
                         fnp(k)*( ss11(i  ,k-1,j  ) + ss11(i-1,k-1,j  ) ) )<a name='910'>
<a name='911'>
    ss33e(i,k,j) = 0.5*( fnm(k)*( ss33(i  ,k  ,j  ) + ss33(i-1,k  ,j  ) ) + &amp;<a name='912'>
                         fnp(k)*( ss33(i  ,k-1,j  ) + ss33(i-1,k-1,j  ) ) )<a name='913'>
 <a name='914'>
    ss12e(i,k,j) = 0.5*( fnm(k)*( ss12(i  ,k  ,j  ) + ss12(i  ,k  ,j+1) ) + &amp;<a name='915'>
                         fnp(k)*( ss12(i  ,k-1,j  ) + ss12(i  ,k-1,j+1) ) )<a name='916'>
<a name='917'>
    rr12e(i,k,j) = 0.5*( fnm(k)*( rr12(i  ,k  ,j  ) + rr12(i  ,k  ,j+1) ) + &amp;<a name='918'>
                         fnp(k)*( rr12(i  ,k-1,j  ) + rr12(i  ,k-1,j+1) ) )<a name='919'>
<a name='920'>
    ss23e(i,k,j) = 0.25*( ss23(i  ,k  ,j) + ss23(i  ,k  ,j+1) + &amp;<a name='921'>
                          ss23(i-1,k  ,j) + ss23(i-1,k  ,j+1) )<a name='922'>
<a name='923'>
    rr23e(i,k,j) = 0.25*( rr23(i  ,k  ,j) + rr23(i  ,k  ,j+1) + &amp;<a name='924'>
                          rr23(i-1,k  ,j) + rr23(i-1,k  ,j+1) )<a name='925'>
<a name='926'>
  END DO<a name='927'>
  END DO<a name='928'>
  END DO<a name='929'>
<a name='930'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='931'></font>
<font color=#447700>!<a name='932'></font>
<font color=#447700>! Calculate M_13<a name='933'></font>
<font color=#447700>!<a name='934'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='935'></font>
<a name='936'>
<a name='937'>
  IF ( config_flags%sfs_opt .EQ. 1 ) THEN <font color=#447700>!Do not use TKE<a name='938'></font>
<a name='939'>
    DO j=j_start,j_end<a name='940'>
    DO k=kts+1,ktf<a name='941'>
    DO i=i_start,i_end<a name='942'>
<a name='943'>
      delta = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='944'>
      a = -1.0*( cs*delta )**2<a name='945'>
<a name='946'>
      m13(i,k,j) = a*(   2.0*sqrt( 2.0*smnsmne(i,k,j) )*ss13(i,k,j) &amp;<a name='947'>
                       + c1*(   ss11e(i,k,j)*ss13(i,k,j)            &amp;<a name='948'>
                              + ss12e(i,k,j)*ss23e(i,k,j)           &amp;<a name='949'>
                              + ss13(i,k,j)*ss33e(i,k,j)            &amp;<a name='950'>
                            )                                       &amp;<a name='951'>
                       + c2*(   ss11e(i,k,j)*rr13(i,k,j)            &amp;<a name='952'>
                              + ss12e(i,k,j)*rr23e(i,k,j)           &amp;<a name='953'>
                              - ss23e(i,k,j)*rr12e(i,k,j)           &amp;<a name='954'>
                              - ss33e(i,k,j)*rr13(i,k,j)            &amp;<a name='955'>
                            )                                       &amp;<a name='956'>
                     )<a name='957'>
<a name='958'>
    ENDDO<a name='959'>
    ENDDO<a name='960'>
    ENDDO<a name='961'>
<a name='962'>
  ELSE <font color=#447700>!(config_flags%sfs_opt .EQ. 2) Use TKE<a name='963'></font>
<a name='964'>
    DO j=j_start,j_end<a name='965'>
    DO k=kts+1,ktf<a name='966'>
    DO i=i_start,i_end<a name='967'>
<a name='968'>
      delta = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='969'>
      a = -1.0*ce*delta<a name='970'>
      b = c3*delta<a name='971'>
<a name='972'>
      m13(i,k,j) = a*(   2.0*sqrt( tkee(i,k,j) )*ss13(i,k,j)    &amp;<a name='973'>
                       + b*(                                    &amp;<a name='974'>
                               c1*(   ss11e(i,k,j)*ss13(i,k,j)  &amp;<a name='975'>
                                    + ss12e(i,k,j)*ss23e(i,k,j) &amp;<a name='976'>
                                    + ss13(i,k,j)*ss33e(i,k,j)  &amp;<a name='977'>
                                  )                             &amp;<a name='978'>
                             + c2*(   ss11e(i,k,j)*rr13(i,k,j)  &amp;<a name='979'>
                                    + ss12e(i,k,j)*rr23e(i,k,j) &amp;<a name='980'>
                                    - ss23e(i,k,j)*rr12e(i,k,j) &amp;<a name='981'>
                                    - ss33e(i,k,j)*rr13(i,k,j)  &amp;<a name='982'>
                                  )                             &amp;<a name='983'>
                           )                                    &amp;<a name='984'>
                     )<a name='985'>
<a name='986'>
    ENDDO<a name='987'>
    ENDDO<a name='988'>
    ENDDO<a name='989'>
<a name='990'>
  ENDIF<a name='991'>
<a name='992'>
  RETURN<a name='993'>
<a name='994'>
END SUBROUTINE calc_m13<a name='995'>
<a name='996'>
<font color=#447700>!=============================================================================<a name='997'></font>
<a name='998'>
<A NAME='CALC_M23'><A href='../../html_code/dyn_em/module_sfs_nba.F.html#CALC_M23' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='999'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calc_m23</font>( m23,                          &amp; <A href='../../call_to/CALC_M23.html' TARGET='index'>1</A><a name='1000'>
                     s22, s33,                     &amp;<a name='1001'>
                     s12, s13, s23,                &amp;<a name='1002'>
                     r12, r13, r23, smnsmn,        &amp;<a name='1003'>
                     tke, rdzw, dx, dy,            &amp;<a name='1004'>
                     fnm, fnp,                     &amp;<a name='1005'>
                     config_flags,                 &amp;<a name='1006'>
                     ids, ide, jds, jde, kds, kde, &amp;<a name='1007'>
                     ims, ime, jms, jme, kms, kme, &amp;<a name='1008'>
                     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1009'>
                     its, ite, jts, jte, kts, kte  )<a name='1010'>
<a name='1011'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1012'></font>
<font color=#447700>!<a name='1013'></font>
<font color=#447700>! PURPOSE: Compute M23<a name='1014'></font>
<font color=#447700>!<a name='1015'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1016'></font>
<a name='1017'>
  IMPLICIT NONE<a name='1018'>
<a name='1019'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT( OUT ) &amp;<a name='1020'>
  :: m23           <font color=#447700>!                                     (m2 s-2)<a name='1021'></font>
<a name='1022'>
  REAL, DIMENSION( ims:ime, kms:kme, jms:jme ),          INTENT(  IN ) &amp;<a name='1023'>
  :: s22         &amp; <font color=#447700>! 2*deformation element 22            (s-1)<a name='1024'></font>
   , s33         &amp; <font color=#447700>! 2*deformation element 33            (s-1)<a name='1025'></font>
   , s12         &amp; <font color=#447700>! 2*deformation element 12            (s-1)<a name='1026'></font>
   , s13         &amp; <font color=#447700>! 2*deformation element 13            (s-1)<a name='1027'></font>
   , s23         &amp; <font color=#447700>! 2*deformation element 23            (s-1)<a name='1028'></font>
   , r12         &amp; <font color=#447700>! 2*rotation element 12               (s-1)<a name='1029'></font>
   , r13         &amp; <font color=#447700>! 2*rotation element 13               (s-1)<a name='1030'></font>
   , r23         &amp; <font color=#447700>! 2*rotation element 23               (s-1)<a name='1031'></font>
   , smnsmn      &amp; <font color=#447700>! Smn*Smn                             (s-2)<a name='1032'></font>
   , tke         &amp; <font color=#447700>! tke                                 (m2 s-2)<a name='1033'></font>
   , rdzw          <font color=#447700>! 1/dz at w-levels                    (m-1)<a name='1034'></font>
<a name='1035'>
  REAL,                                                  INTENT( IN  ) &amp;<a name='1036'>
  :: dx          &amp; <font color=#447700>! grid spacing in x                   (m)<a name='1037'></font>
   , dy            <font color=#447700>! grid spacing in y                   (m)<a name='1038'></font>
<a name='1039'>
  REAL, DIMENSION( kms:kme ),                            INTENT( IN  ) &amp;<a name='1040'>
  :: fnm         &amp; <font color=#447700>! vertical interpolation coefficients<a name='1041'></font>
   , fnp           <font color=#447700>!<a name='1042'></font>
<a name='1043'>
  TYPE (grid_config_rec_type),                           INTENT( IN  ) &amp;<a name='1044'>
  :: config_flags<a name='1045'>
<a name='1046'>
  INTEGER,                                               INTENT( IN  ) &amp;<a name='1047'>
  :: ids, ide, jds, jde, kds, kde, &amp;<a name='1048'>
     ims, ime, jms, jme, kms, kme, &amp;<a name='1049'>
     ips, ipe, jps, jpe, kps, kpe, &amp;<a name='1050'>
     its, ite, jts, jte, kts, kte<a name='1051'>
<a name='1052'>
<font color=#447700>! LOCAL VARIABLES ------------------------------------------------------------<a name='1053'></font>
<a name='1054'>
  REAL, DIMENSION( its-1:ite+1, kms:kme, jts-1:jte+1 ) &amp; <font color=#447700>! sij/2, rij/2<a name='1055'></font>
  :: ss22        &amp; <a name='1056'>
   , ss33        &amp;  <a name='1057'>
   , ss12        &amp;  <a name='1058'>
   , ss13        &amp; <a name='1059'>
   , ss23        &amp; <a name='1060'>
   , rr12        &amp; <a name='1061'>
   , rr13        &amp; <a name='1062'>
   , rr23  <a name='1063'>
<a name='1064'>
  REAL, DIMENSION( its-1:ite+1, kms:kme, jts-1:jte+1 ) &amp; <font color=#447700>! projected to f<a name='1065'></font>
  :: tkef        &amp; <a name='1066'>
   , ss22f       &amp; <a name='1067'>
   , ss33f       &amp; <a name='1068'>
   , ss12f       &amp; <a name='1069'>
   , ss13f       &amp; <a name='1070'>
   , rr12f       &amp; <a name='1071'>
   , rr13f       &amp;          <a name='1072'>
   , smnsmnf    <a name='1073'>
<a name='1074'>
  REAL :: delta, a, b<a name='1075'>
<a name='1076'>
  INTEGER :: i, j, k, i_start, i_end, j_start, j_end, ktf, je_ext<a name='1077'>
<a name='1078'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1079'></font>
<font color=#447700>!<a name='1080'></font>
<font color=#447700>! Set loop limits,<a name='1081'></font>
<font color=#447700>! taken from /dyn_em/module_diffusion_em.F SUBROUTINE cal_titau_23_32<a name='1082'></font>
<font color=#447700>!<a name='1083'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1084'></font>
<a name='1085'>
  ktf = MIN( kte, kde-1 )<a name='1086'>
<a name='1087'>
<font color=#447700>! Find ide-1 and jde-1 for averaging to p point.<a name='1088'></font>
<a name='1089'>
  i_start = its<a name='1090'>
  i_end   = MIN( ite, ide-1 )<a name='1091'>
  j_start = jts<a name='1092'>
  j_end   = jte<a name='1093'>
<a name='1094'>
    IF ( config_flags%open_xs .OR. config_flags%specified .OR. &amp;<a name='1095'>
         config_flags%nested) i_start = MAX( ids+1, its )<a name='1096'>
    IF ( config_flags%open_xe .OR. config_flags%specified .OR. &amp;<a name='1097'>
         config_flags%nested) i_end   = MIN( ide-2, ite )<a name='1098'>
    IF ( config_flags%open_ys .OR. config_flags%specified .OR. &amp;<a name='1099'>
         config_flags%nested) j_start = MAX( jds+1, jts )<a name='1100'>
    IF ( config_flags%open_ye .OR. config_flags%specified .OR. &amp;<a name='1101'>
         config_flags%nested) j_end   = MIN( jde-1, jte )<a name='1102'>
      IF ( config_flags%periodic_x ) i_start = its<a name='1103'>
      IF ( config_flags%periodic_x ) i_end = MIN( ite, ide-1 )<a name='1104'>
<a name='1105'>
  je_ext = 1<a name='1106'>
  j_end = j_end + je_ext   <a name='1107'>
<a name='1108'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1109'></font>
<font color=#447700>!<a name='1110'></font>
<font color=#447700>! Divide WRF deformations, which are multiplied by 2, by 2<a name='1111'></font>
<font color=#447700>!<a name='1112'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1113'></font>
<a name='1114'>
  DO j=j_start-1,j_end<a name='1115'>
  DO k=kts,ktf<a name='1116'>
  DO i=i_start,i_end+1<a name='1117'>
<a name='1118'>
    ss22(i,k,j)=s22(i,k,j)/2.0<a name='1119'>
    ss33(i,k,j)=s33(i,k,j)/2.0<a name='1120'>
    ss12(i,k,j)=s12(i,k,j)/2.0<a name='1121'>
    ss13(i,k,j)=s13(i,k,j)/2.0<a name='1122'>
    ss23(i,k,j)=s23(i,k,j)/2.0<a name='1123'>
    rr12(i,k,j)=r12(i,k,j)/2.0<a name='1124'>
    rr13(i,k,j)=r13(i,k,j)/2.0<a name='1125'>
    rr23(i,k,j)=r23(i,k,j)/2.0<a name='1126'>
<a name='1127'>
  END DO<a name='1128'>
  END DO<a name='1129'>
  END DO<a name='1130'>
<a name='1131'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1132'></font>
<font color=#447700>!<a name='1133'></font>
<font color=#447700>! Project variables to f<a name='1134'></font>
<font color=#447700>!<a name='1135'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1136'></font>
<a name='1137'>
  DO j = j_start, j_end<a name='1138'>
  DO k = kts+1, ktf<a name='1139'>
  DO i = i_start, i_end<a name='1140'>
<a name='1141'>
    tkef(i,k,j) = 0.5*( fnm(k)*( tke(i  ,k  ,j  ) + tke(i  ,k  ,j-1) ) + &amp;<a name='1142'>
                        fnp(k)*( tke(i  ,k-1,j  ) + tke(i  ,k-1,j-1) ) )<a name='1143'>
<a name='1144'>
    smnsmnf(i,k,j) = 0.5*( fnm(k)*( smnsmn(i  ,k  ,j  ) + smnsmn(i  ,k  ,j-1) ) + &amp;<a name='1145'>
                           fnp(k)*( smnsmn(i  ,k-1,j  ) + smnsmn(i  ,k-1,j-1) ) )<a name='1146'>
<a name='1147'>
    ss22f(i,k,j) = 0.5*( fnm(k)*( ss22(i  ,k  ,j  ) + ss22(i  ,k  ,j-1) ) + &amp;<a name='1148'>
                         fnp(k)*( ss22(i  ,k-1,j  ) + ss22(i  ,k-1,j-1) ) )<a name='1149'>
<a name='1150'>
    ss33f(i,k,j) = 0.5*( fnm(k)*( ss33(i  ,k  ,j  ) + ss33(i  ,k  ,j-1) ) + &amp;<a name='1151'>
                         fnp(k)*( ss33(i  ,k-1,j  ) + ss33(i  ,k-1,j-1) ) )<a name='1152'>
<a name='1153'>
    ss12f(i,k,j) = 0.5*( fnm(k)*( ss12(i  ,k  ,j  ) + ss12(i+1,k  ,j  ) ) + &amp;<a name='1154'>
                         fnp(k)*( ss12(i  ,k-1,j  ) + ss12(i+1,k-1,j  ) ) )<a name='1155'>
<a name='1156'>
    rr12f(i,k,j) = 0.5*( fnm(k)*( rr12(i  ,k  ,j  ) + rr12(i+1,k  ,j  ) ) + &amp;<a name='1157'>
                         fnp(k)*( rr12(i  ,k-1,j  ) + rr12(i+1,k-1,j  ) ) )<a name='1158'>
<a name='1159'>
    ss13f(i,k,j) = 0.25*( ss13(i  ,k  ,j  ) + ss13(i  ,k  ,j-1) + &amp;<a name='1160'>
                          ss13(i+1,k  ,j-1) + ss13(i+1,k  ,j  ) )<a name='1161'>
<a name='1162'>
    rr13f(i,k,j) = 0.25*( rr13(i  ,k  ,j  ) + rr13(i  ,k  ,j-1) + &amp;<a name='1163'>
                          rr13(i+1,k  ,j-1) + rr13(i+1,k  ,j  ) )<a name='1164'>
<a name='1165'>
  END DO<a name='1166'>
  END DO<a name='1167'>
  END DO<a name='1168'>
 <a name='1169'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1170'></font>
<font color=#447700>!<a name='1171'></font>
<font color=#447700>! Calculate M23<a name='1172'></font>
<font color=#447700>!<a name='1173'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='1174'></font>
<a name='1175'>
  IF ( config_flags%sfs_opt .EQ. 1 ) THEN <font color=#447700>!Do not use TKE<a name='1176'></font>
<a name='1177'>
    DO j=j_start,j_end<a name='1178'>
    DO k=kts+1,ktf<a name='1179'>
    DO i=i_start,i_end<a name='1180'>
<a name='1181'>
      delta = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='1182'>
      a = -1.0*( cs*delta )**2<a name='1183'>
<a name='1184'>
      m23(i,k,j) = a*(   2.0*sqrt( 2.0*smnsmnf(i,k,j) )*ss23(i,k,j) &amp;<a name='1185'>
                       + c1*(   ss12f(i,k,j)*ss13f(i,k,j)           &amp;<a name='1186'>
                              + ss22f(i,k,j)*ss23(i,k,j)            &amp;<a name='1187'>
                              + ss23(i,k,j) *ss33f(i,k,j)           &amp;<a name='1188'>
                             )                                      &amp;<a name='1189'>
                       + c2*(   ss12f(i,k,j)*rr13f(i,k,j)           &amp;<a name='1190'>
                              + ss22f(i,k,j)*rr23(i,k,j)            &amp;<a name='1191'>
                              + ss13f(i,k,j)*rr12f(i,k,j)           &amp;<a name='1192'>
                              - ss33f(i,k,j)*rr23(i,k,j)            &amp;<a name='1193'>
                            )                                       &amp;<a name='1194'>
                     )<a name='1195'>
<a name='1196'>
    ENDDO<a name='1197'>
    ENDDO<a name='1198'>
    ENDDO<a name='1199'>
<a name='1200'>
  ELSE <font color=#447700>!(config_flags%sfs_opt .EQ. 2) Use TKE<a name='1201'></font>
<a name='1202'>
    DO j=j_start,j_end<a name='1203'>
    DO k=kts+1,ktf<a name='1204'>
    DO i=i_start,i_end<a name='1205'>
<a name='1206'>
      delta = ( dx * dy / rdzw(i,k,j) )**0.33333333<a name='1207'>
      a = -1.0*ce*delta<a name='1208'>
      b = c3*delta<a name='1209'>
<a name='1210'>
      m23(i,k,j) = a*(   2.0*sqrt( tkef(i,k,j) )*ss23(i,k,j)    &amp;<a name='1211'>
                       + b*(                                    &amp;<a name='1212'>
                               c1*(   ss12f(i,k,j)*ss13f(i,k,j) &amp;<a name='1213'>
                                    + ss22f(i,k,j)*ss23(i,k,j)  &amp;<a name='1214'>
                                    + ss23(i,k,j) *ss33f(i,k,j) &amp;<a name='1215'>
                                  )                             &amp;<a name='1216'>
                             + c2*(   ss12f(i,k,j)*rr13f(i,k,j) &amp;<a name='1217'>
                                    + ss22f(i,k,j)*rr23(i,k,j)  &amp;<a name='1218'>
                                    + ss13f(i,k,j)*rr12f(i,k,j) &amp;<a name='1219'>
                                    - ss33f(i,k,j)*rr23(i,k,j)  &amp;<a name='1220'>
                                  )                             &amp;<a name='1221'>
                           )                                    &amp;<a name='1222'>
                     )<a name='1223'>
<a name='1224'>
    ENDDO<a name='1225'>
    ENDDO<a name='1226'>
    ENDDO<a name='1227'>
<a name='1228'>
  ENDIF<a name='1229'>
<a name='1230'>
  RETURN<a name='1231'>
<a name='1232'>
END SUBROUTINE calc_m23<a name='1233'>
<a name='1234'>
<font color=#447700>!=============================================================================<a name='1235'></font>
<a name='1236'>
END MODULE module_sfs_nba<a name='1237'>
</pre></body></html>