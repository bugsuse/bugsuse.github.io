<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
#if ( HYBRID_COORD==1 ) <a name='2'>
#  define mut(...) (c1(k)*XXPCTXX(__VA_ARGS__)+c2(k))<a name='3'>
#  define XXPCTXX(...) mut(__VA_ARGS__)<a name='4'>
<a name='5'>
#  define muu(...) (c1(k)*XXPCUXX(__VA_ARGS__)+c2(k))<a name='6'>
#  define XXPCUXX(...) muu(__VA_ARGS__)<a name='7'>
<a name='8'>
#  define muv(...) (c1(k)*XXPCVXX(__VA_ARGS__)+c2(k))<a name='9'>
#  define XXPCVXX(...) muv(__VA_ARGS__)<a name='10'>
<a name='11'>
#  define MUT(...) (c1f(k)*XXPCTFXX(__VA_ARGS__)+c2f(k))<a name='12'>
#  define XXPCTFXX(...) MUT(__VA_ARGS__)<a name='13'>
<a name='14'>
#  define MUU(...) (c1h(k)*XXPCUHXX(__VA_ARGS__)+c2h(k))<a name='15'>
#  define XXPCUHXX(...) MUU(__VA_ARGS__)<a name='16'>
<a name='17'>
#  define MUV(...) (c1h(k)*XXPCVHXX(__VA_ARGS__)+c2h(k))<a name='18'>
#  define XXPCVHXX(...) MUV(__VA_ARGS__)<a name='19'>
<a name='20'>
#  define muold(...) (c1(k)*XXPCTOLDXX(__VA_ARGS__)+c2(k))<a name='21'>
#  define XXPCTOLDXX(...) muold(__VA_ARGS__)<a name='22'>
<a name='23'>
#  define munew(...) (c1(k)*XXPCTNEWXX(__VA_ARGS__)+c2(k))<a name='24'>
#  define XXPCTNEWXX(...) munew(__VA_ARGS__)<a name='25'>
#endif<a name='26'>
<a name='27'>
<font color=#447700>!WRF:MODEL_LAYER:DYNAMICS<a name='28'></font>
<font color=#447700>!<a name='29'></font>
<a name='30'>
<A NAME='MODULE_EM'><A href='../../html_code/dyn_em/module_em.F.html#MODULE_EM' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='31'>
<font color=#993300>MODULE </font><font color=#cc0000>module_em</font> <A href='../../call_to/MODULE_EM.html' TARGET='index'>3</A><a name='32'>
<a name='33'>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_6"><a name='34'>
   <a name='35'>
   USE <A href='../../html_code/dyn_em/module_advect_em.F.html#MODULE_ADVECT_EM'>module_advect_em</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_ADVECT_EM_1">, only: advect_u, advect_v, advect_w, advect_scalar, advect_scalar_pd, advect_scalar_mono, &amp;<a name='36'>
        advect_weno_u, advect_weno_v, advect_weno_w, advect_scalar_weno,  advect_scalar_wenopd<a name='37'>
   <a name='38'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_2">, only: grid_config_rec_type, calculate_full, couple_momentum, calc_mu_uv, calc_ww_cp, &amp;<a name='39'>
        calc_cq, calc_alt, calc_php, set_tend, rhs_ph, &amp;<a name='40'>
   	horizontal_pressure_gradient, pg_buoy_w, w_damp, perturbation_coriolis, coriolis, curvature, horizontal_diffusion, &amp;<a name='41'>
        horizontal_diffusion_3dmp, vertical_diffusion_u, &amp;<a name='42'>
	vertical_diffusion_v, vertical_diffusion, vertical_diffusion_3dmp, sixth_order_diffusion, rk_rayleigh_damp, &amp;<a name='43'>
        theta_relaxation, vertical_diffusion_mp, zero_tend, zero_tend2d<a name='44'>
	<a name='45'>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_6">, only: param_first_scalar, p_qr, p_qv, p_qc, p_qg, p_qi, p_qs, tiedtkescheme,ntiedtkescheme, heldsuarez, &amp;<a name='46'>
        positivedef, gdscheme, g3scheme, gfscheme, kfetascheme, mskfscheme, monotonic, wenopd_scalar, weno_scalar, weno_mom<a name='47'>
	<a name='48'>
   USE <A href='../../html_code/dyn_em/module_damping_em.F.html#MODULE_DAMPING_EM'>module_damping_em</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DAMPING_EM_1">, only: held_suarez_damp<a name='49'>
<a name='50'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_5"> <a name='51'>
<a name='52'>
   USE <A href='../../html_code/share/module_llxy.F.html#MODULE_LLXY'>module_llxy</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LLXY_2"> <a name='53'>
<a name='54'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_8">, ONLY : domain, get_ijk_from_grid<a name='55'>
<a name='56'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/module_em.F.html#module_em.F' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_7">, ONLY: grid_config_rec_type, model_config_rec, model_to_grid_config_rec<a name='57'>
<a name='58'>
CONTAINS<a name='59'>
<a name='60'>
<font color=#447700>!------------------------------------------------------------------------<a name='61'></font>
<a name='62'>
<A NAME='RK_STEP_PREP'><A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='63'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>rk_step_prep</font>  ( config_flags, rk_step,           &amp; <A href='../../call_to/RK_STEP_PREP.html' TARGET='index'>1</A>,<A href='../../call_from/RK_STEP_PREP.html' TARGET='index'>7</A><a name='64'>
                           u, v, w, t, ph, mu,              &amp;<a name='65'>
                           c1h, c2h, c1f, c2f, moist,       &amp;<a name='66'>
                           ru, rv, rw, ww, php, alt,        &amp;<a name='67'>
                           muu, muv,                        &amp;<a name='68'>
                           mub, mut, phb, pb, p, al, alb,   &amp;<a name='69'>
                           cqu, cqv, cqw,                   &amp;<a name='70'>
                           msfux, msfuy,                    &amp;<a name='71'>
                           msfvx, msfvx_inv, msfvy,         &amp;<a name='72'>
                           msftx, msfty,                    &amp;<a name='73'>
                           fnm, fnp, dnw, rdx, rdy,         &amp;<a name='74'>
                           n_moist,                         &amp;<a name='75'>
                           ids, ide, jds, jde, kds, kde,    &amp;<a name='76'>
                           ims, ime, jms, jme, kms, kme,    &amp;<a name='77'>
                           its, ite, jts, jte, kts, kte    )<a name='78'>
<a name='79'>
   IMPLICIT NONE<a name='80'>
<a name='81'>
<a name='82'>
   <font color=#447700>!  Input data.<a name='83'></font>
<a name='84'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='85'>
<a name='86'>
   INTEGER ,       INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='87'>
                                    ims, ime, jms, jme, kms, kme, &amp;<a name='88'>
                                    its, ite, jts, jte, kts, kte<a name='89'>
<a name='90'>
   INTEGER ,       INTENT(IN   ) :: n_moist, rk_step<a name='91'>
<a name='92'>
   REAL ,          INTENT(IN   ) :: rdx, rdy<a name='93'>
<a name='94'>
   REAL , DIMENSION(  ims:ime , kms:kme, jms:jme ) ,                      &amp;<a name='95'>
                                               INTENT(IN   ) ::  u,       &amp;<a name='96'>
                                                                 v,       &amp;<a name='97'>
                                                                 w,       &amp;<a name='98'>
                                                                 t,       &amp;<a name='99'>
                                                                 ph,      &amp;<a name='100'>
                                                                 phb,     &amp;<a name='101'>
                                                                 pb,      &amp;<a name='102'>
                                                                 al,      &amp;<a name='103'>
                                                                 alb<a name='104'>
<a name='105'>
   REAL , DIMENSION( ims:ime , kms:kme , jms:jme  ) ,                     &amp;<a name='106'>
                                               INTENT(  OUT) ::  ru,      &amp;<a name='107'>
                                                                 rv,      &amp;<a name='108'>
                                                                 rw,      &amp;<a name='109'>
                                                                 ww,      &amp;<a name='110'>
                                                                 php,     &amp;<a name='111'>
                                                                 cqu,     &amp;<a name='112'>
                                                                 cqv,     &amp;<a name='113'>
                                                                 cqw,     &amp;<a name='114'>
                                                                 alt<a name='115'>
<a name='116'>
   REAL , DIMENSION(  ims:ime , kms:kme, jms:jme ) ,                      &amp;<a name='117'>
                                               INTENT(IN   ) ::  p<a name='118'>
                                                                 <a name='119'>
<a name='120'>
<a name='121'>
<a name='122'>
   REAL , DIMENSION( ims:ime, kms:kme, jms:jme, n_moist ), INTENT(   IN) :: &amp;<a name='123'>
                                                           moist<a name='124'>
<a name='125'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,    INTENT(IN   ) :: msftx,     &amp;<a name='126'>
                                                               msfty,     &amp;<a name='127'>
                                                               msfux,     &amp;<a name='128'>
                                                               msfuy,     &amp;<a name='129'>
                                                               msfvx,     &amp;<a name='130'>
                                                               msfvx_inv, &amp;<a name='131'>
                                                               msfvy,     &amp;<a name='132'>
                                                               mu,        &amp;<a name='133'>
                                                               mub<a name='134'>
<a name='135'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,    INTENT(  OUT) :: muu,    &amp;<a name='136'>
                                                               muv,    &amp;<a name='137'>
                                                               mut<a name='138'>
<a name='139'>
   REAL , DIMENSION( kms:kme ) ,    INTENT(IN   ) :: fnm, fnp, dnw<a name='140'>
   REAL , DIMENSION( kms:kme ) ,    INTENT(IN   ) :: c1h, c2h, c1f, c2f<a name='141'>
<a name='142'>
   integer :: k<a name='143'>
<a name='144'>
<a name='145'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='146'></font>
<font color=#447700>!<a name='147'></font>
<font color=#447700>!  rk_step_prep prepares a number of diagnostic quantities <a name='148'></font>
<font color=#447700>!  in preperation for a Runge-Kutta timestep.  subroutines called<a name='149'></font>
<font color=#447700>!  by rk_step_prep calculate<a name='150'></font>
<font color=#447700>!<a name='151'></font>
<font color=#447700>!  (1) total column dry air mass (mut, call to calculate_full)<a name='152'></font>
<font color=#447700>!<a name='153'></font>
<font color=#447700>!  (2) total column dry air mass at u and v points <a name='154'></font>
<font color=#447700>!      (muu, muv, call to calculate_mu_uv)<a name='155'></font>
<font color=#447700>!<a name='156'></font>
<font color=#447700>!  (3) mass-coupled velocities for advection<a name='157'></font>
<font color=#447700>!      (ru, rv, and rw, call to couple_momentum)<a name='158'></font>
<font color=#447700>!<a name='159'></font>
<font color=#447700>!  (4) omega (call to calc_ww_cp)<a name='160'></font>
<font color=#447700>!<a name='161'></font>
<font color=#447700>!  (5) moisture coefficients (cqu, cqv, cqw, call to calc_cq)<a name='162'></font>
<font color=#447700>!<a name='163'></font>
<font color=#447700>!  (6) inverse density (alt, call to calc_alt)<a name='164'></font>
<font color=#447700>!<a name='165'></font>
<font color=#447700>!  (7) geopotential at pressure points (php, call to calc_php)<a name='166'></font>
<font color=#447700>!<a name='167'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='168'></font>
<a name='169'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALCULATE_FULL'>calculate_full</A><A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALCULATE_FULL_1">( mut, mub, mu,             &amp;<a name='170'>
                        ids, ide, jds, jde, 1, 2, &amp;<a name='171'>
                        ims, ime, jms, jme, 1, 1, &amp;<a name='172'>
                        its, ite, jts, jte, 1, 1 )<a name='173'>
<a name='174'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV'>calc_mu_uv</A><A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_UV_1"> ( config_flags,                  &amp;<a name='175'>
                     mu, mub, muu, muv,             &amp;<a name='176'>
                     ids, ide, jds, jde, kds, kde,  &amp;<a name='177'>
                     ims, ime, jms, jme, kms, kme,  &amp;<a name='178'>
                     its, ite, jts, jte, kts, kte  )<a name='179'>
<a name='180'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#COUPLE_MOMENTUM'>couple_momentum</A><A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_MOMENTUM_1">( muu, ru, u, msfuy,             &amp;<a name='181'>
                         muv, rv, v, msfvx, msfvx_inv,  &amp;<a name='182'>
                         mut, rw, w, msfty,             &amp;<a name='183'>
                         c1h, c2h, c1f, c2f,            &amp;<a name='184'>
                         ids, ide, jds, jde, kds, kde,  &amp;<a name='185'>
                         ims, ime, jms, jme, kms, kme,  &amp;<a name='186'>
                         its, ite, jts, jte, kts, kte  )<a name='187'>
<a name='188'>
<font color=#447700>!  new call, couples V with mu, also has correct map factors.  WCS, 3 june 2001<a name='189'></font>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_WW_CP'>calc_ww_cp</A><A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_WW_CP_1"> ( u, v, mu, mub, c1h, c2h, ww,     &amp;<a name='190'>
                     rdx, rdy, msftx, msfty,          &amp;<a name='191'>
                     msfux, msfuy, msfvx, msfvx_inv,  &amp;<a name='192'>
                     msfvy, dnw,                      &amp;<a name='193'>
                     ids, ide, jds, jde, kds, kde,    &amp;<a name='194'>
                     ims, ime, jms, jme, kms, kme,    &amp;<a name='195'>
                     its, ite, jts, jte, kts, kte    )<a name='196'>
<a name='197'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_CQ'>calc_cq</A><A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_CQ_1"> ( moist, cqu, cqv, cqw, n_moist, &amp;<a name='198'>
                  ids, ide, jds, jde, kds, kde,  &amp;<a name='199'>
                  ims, ime, jms, jme, kms, kme,  &amp;<a name='200'>
                  its, ite, jts, jte, kts, kte  )<a name='201'>
<a name='202'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_ALT'>calc_alt</A><A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_ALT_1"> ( alt, al, alb,                 &amp;<a name='203'>
                   ids, ide, jds, jde, kds, kde, &amp;<a name='204'>
                   ims, ime, jms, jme, kms, kme, &amp;<a name='205'>
                   its, ite, jts, jte, kts, kte )<a name='206'>
<a name='207'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_PHP'>calc_php</A><A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_PHP_1"> ( php, ph, phb,                 &amp;<a name='208'>
                   ids, ide, jds, jde, kds, kde, &amp;<a name='209'>
                   ims, ime, jms, jme, kms, kme, &amp;<a name='210'>
                   its, ite, jts, jte, kts, kte )<a name='211'>
<a name='212'>
END SUBROUTINE rk_step_prep<a name='213'>
<a name='214'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='215'></font>
<a name='216'>
<A NAME='RK_TENDENCY'><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='217'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>rk_tendency</font> ( config_flags, rk_step,                           &amp; <A href='../../call_to/RK_TENDENCY.html' TARGET='index'>1</A>,<A href='../../call_from/RK_TENDENCY.html' TARGET='index'>43</A><a name='218'>
                         ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp;<a name='219'>
                         ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='220'>
                         mu_tend, u_save, v_save, w_save, ph_save,        &amp;<a name='221'>
                         t_save, mu_save, RTHFTEN,                        &amp;<a name='222'>
                         ru, rv, rw, ww,                                  &amp;<a name='223'>
                         u, v, w, t, ph,                                  &amp;<a name='224'>
                         u_old, v_old, w_old, t_old, ph_old,              &amp;<a name='225'>
                         h_diabatic, phb,t_init,                          &amp;<a name='226'>
                         mu, mut, muu, muv, mub, c1h, c2h, c1f, c2f,      &amp;<a name='227'>
                         al, alt, p, pb, php, cqu, cqv, cqw,              &amp;<a name='228'>
                         u_base, v_base, t_base, qv_base, z_base,         &amp;<a name='229'>
                         msfux, msfuy, msfvx, msfvx_inv,                  &amp;<a name='230'>
                         msfvy, msftx, msfty,                             &amp;<a name='231'>
                         clat, f, e, sina, cosa,                          &amp;<a name='232'>
                         fnm, fnp, rdn, rdnw,                             &amp;<a name='233'>
                         dt, rdx, rdy, khdif, kvdif, xkmhd, xkhh,         &amp;<a name='234'>
                         diff_6th_opt, diff_6th_factor,                   &amp;<a name='235'>
                         adv_opt,                                         &amp;<a name='236'>
                         dampcoef,zdamp,damp_opt,rad_nudge,               &amp;<a name='237'>
                         cf1, cf2, cf3, cfn, cfn1, n_moist,               &amp;<a name='238'>
                         non_hydrostatic, top_lid,                        &amp;<a name='239'>
                         u_frame, v_frame,                                &amp;<a name='240'>
                         ids, ide, jds, jde, kds, kde,                    &amp;<a name='241'>
                         ims, ime, jms, jme, kms, kme,                    &amp;<a name='242'>
                         its, ite, jts, jte, kts, kte,                    &amp;<a name='243'>
                         max_vert_cfl, max_horiz_cfl)<a name='244'>
<a name='245'>
   IMPLICIT NONE<a name='246'>
<a name='247'>
   <font color=#447700>!  Input data.<a name='248'></font>
<a name='249'>
   TYPE(grid_config_rec_type)    ,           INTENT(IN   ) :: config_flags<a name='250'>
<a name='251'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='252'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='253'>
                                            its, ite, jts, jte, kts, kte<a name='254'>
<a name='255'>
   LOGICAL ,               INTENT(IN   ) :: non_hydrostatic, top_lid<a name='256'>
<a name='257'>
   INTEGER ,               INTENT(IN   ) :: n_moist, rk_step<a name='258'>
<a name='259'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) ,              &amp;<a name='260'>
                                        INTENT(IN   ) :: ru,      &amp;<a name='261'>
                                                         rv,      &amp;<a name='262'>
                                                         rw,      &amp;<a name='263'>
                                                         ww,      &amp; <a name='264'>
                                                         u,       &amp;<a name='265'>
                                                         v,       &amp;<a name='266'>
                                                         w,       &amp;<a name='267'>
                                                         t,       &amp;<a name='268'>
                                                         ph,      &amp;<a name='269'>
                                                         u_old,   &amp;<a name='270'>
                                                         v_old,   &amp;<a name='271'>
                                                         w_old,   &amp;<a name='272'>
                                                         t_old,   &amp;<a name='273'>
                                                         ph_old,  &amp;<a name='274'>
                                                         phb,     &amp;<a name='275'>
                                                         al,      &amp;<a name='276'>
                                                         alt,     &amp;<a name='277'>
                                                         p,       &amp;<a name='278'>
                                                         pb,      &amp;<a name='279'>
                                                         php,     &amp;<a name='280'>
                                                         cqu,     &amp;<a name='281'>
                                                         cqv,     &amp;<a name='282'>
                                                         t_init,  &amp;<a name='283'>
                                                         xkmhd,   &amp;<a name='284'>
                                                         xkhh,    &amp;<a name='285'>
                                                         h_diabatic<a name='286'>
<a name='287'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) ,              &amp;<a name='288'>
                                        INTENT(OUT  ) :: ru_tend, &amp;<a name='289'>
                                                         rv_tend, &amp;<a name='290'>
                                                         rw_tend, &amp;<a name='291'>
                                                         t_tend,  &amp;<a name='292'>
                                                         ph_tend, &amp;<a name='293'>
                                                         RTHFTEN, &amp;<a name='294'>
                                                          u_save, &amp;<a name='295'>
                                                          v_save, &amp;<a name='296'>
                                                          w_save, &amp;<a name='297'>
                                                         ph_save, &amp;<a name='298'>
                                                          t_save<a name='299'>
<a name='300'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) ,               &amp;<a name='301'>
                                        INTENT(INOUT) :: ru_tendf, &amp;<a name='302'>
                                                         rv_tendf, &amp;<a name='303'>
                                                         rw_tendf, &amp;<a name='304'>
                                                         t_tendf,  &amp;<a name='305'>
                                                         ph_tendf, &amp;<a name='306'>
                                                         cqw<a name='307'>
<a name='308'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(  OUT) :: mu_tend, &amp;<a name='309'>
                                                                    mu_save<a name='310'>
<a name='311'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: msfux,   &amp;<a name='312'>
                                                                    msfuy,   &amp;<a name='313'>
                                                                    msfvx,   &amp;<a name='314'>
                                                                    msfvx_inv,   &amp;<a name='315'>
                                                                    msfvy,   &amp;<a name='316'>
                                                                    msftx,   &amp;<a name='317'>
                                                                    msfty,   &amp;<a name='318'>
                                                                    clat,    &amp; <a name='319'>
                                                                    f,       &amp;<a name='320'>
                                                                    e,       &amp;<a name='321'>
                                                                    sina,    &amp;<a name='322'>
                                                                    cosa,    &amp;<a name='323'>
                                                                    mu,      &amp;<a name='324'>
                                                                    mut,     &amp;<a name='325'>
                                                                    mub,     &amp;<a name='326'>
                                                                    muu,     &amp;<a name='327'>
                                                                    muv<a name='328'>
<a name='329'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fnm,     &amp;<a name='330'>
                                                                  fnp,     &amp;<a name='331'>
                                                                  rdn,     &amp;<a name='332'>
                                                                  rdnw,    &amp;<a name='333'>
                                                                  u_base,  &amp;<a name='334'>
                                                                  v_base,  &amp;<a name='335'>
                                                                  t_base,  &amp;<a name='336'>
                                                                  qv_base, &amp;<a name='337'>
                                                                  z_base,  &amp;<a name='338'>
                                                                  c1h,     &amp;<a name='339'>
                                                                  c2h,     &amp;<a name='340'>
                                                                  c1f,     &amp;<a name='341'>
                                                                  c2f<a name='342'>
<a name='343'>
   REAL ,                                      INTENT(IN   ) :: rdx,     &amp;<a name='344'>
                                                                rdy,     &amp;<a name='345'>
                                                                dt,      &amp;<a name='346'>
                                                                u_frame, &amp;<a name='347'>
                                                                v_frame, &amp;<a name='348'>
                                                                khdif,   &amp;<a name='349'>
                                                                kvdif<a name='350'>
   INTEGER, INTENT( IN ) :: diff_6th_opt<a name='351'>
   REAL,    INTENT( IN ) :: diff_6th_factor<a name='352'>
   INTEGER, INTENT( IN ) :: adv_opt<a name='353'>
<a name='354'>
   INTEGER, INTENT( IN ) :: damp_opt, rad_nudge<a name='355'>
<a name='356'>
   REAL, INTENT( IN ) :: zdamp, dampcoef<a name='357'>
<a name='358'>
   REAL, INTENT( OUT ) :: max_horiz_cfl<a name='359'>
   REAL, INTENT( OUT ) :: max_vert_cfl<a name='360'>
<a name='361'>
   REAL    :: kdift, khdq, kvdq, cfn, cfn1, cf1, cf2, cf3<a name='362'>
   INTEGER :: i,j,k<a name='363'>
   INTEGER :: time_step<a name='364'>
<a name='365'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='366'></font>
<font color=#447700>!<a name='367'></font>
<font color=#447700>!  rk_tendency computes the large-timestep tendency terms in the <a name='368'></font>
<font color=#447700>!  momentum, thermodynamic (theta), and geopotential equations.  <a name='369'></font>
<font color=#447700>!  These terms include:<a name='370'></font>
<font color=#447700>!<a name='371'></font>
<font color=#447700>!  (1) advection (for u, v, w, theta - calls to advect_u, advect_v,<a name='372'></font>
<font color=#447700>!                 advect_w, and advact_scalar).<a name='373'></font>
<font color=#447700>!<a name='374'></font>
<font color=#447700>!  (2) geopotential equation terms (advection and "gw" - call to rhs_ph).<a name='375'></font>
<font color=#447700>!<a name='376'></font>
<font color=#447700>!  (3) buoyancy term in vertical momentum equation (call to pg_buoy_w).<a name='377'></font>
<font color=#447700>!<a name='378'></font>
<font color=#447700>!  (4) Coriolis and curvature terms in u,v,w momentum equations<a name='379'></font>
<font color=#447700>!      (calls to subroutines coriolis, curvature)<a name='380'></font>
<font color=#447700>!<a name='381'></font>
<font color=#447700>!  (5) 3D diffusion on coordinate surfaces.<a name='382'></font>
<font color=#447700>!<a name='383'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='384'></font>
<a name='385'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_1"> ( ru_tend,                      &amp;<a name='386'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='387'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='388'>
                    its, ite, jts, jte, kts, kte )<a name='389'>
<a name='390'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_2"> ( rv_tend,                      &amp;<a name='391'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='392'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='393'>
                    its, ite, jts, jte, kts, kte )<a name='394'>
<a name='395'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_3"> ( rw_tend,                      &amp;<a name='396'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='397'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='398'>
                    its, ite, jts, jte, kts, kte )<a name='399'>
<a name='400'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_4"> ( t_tend,                       &amp;<a name='401'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='402'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='403'>
                    its, ite, jts, jte, kts, kte )<a name='404'>
<a name='405'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_5"> ( ph_tend,                      &amp;<a name='406'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='407'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='408'>
                    its, ite, jts, jte, kts, kte )<a name='409'>
<a name='410'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_6"> ( u_save,                       &amp;<a name='411'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='412'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='413'>
                    its, ite, jts, jte, kts, kte )<a name='414'>
<a name='415'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_7"> ( v_save,                       &amp;<a name='416'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='417'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='418'>
                    its, ite, jts, jte, kts, kte )<a name='419'>
<a name='420'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_8"> ( w_save,                       &amp;<a name='421'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='422'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='423'>
                    its, ite, jts, jte, kts, kte )<a name='424'>
<a name='425'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_9"> ( ph_save,                       &amp;<a name='426'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='427'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='428'>
                    its, ite, jts, jte, kts, kte )<a name='429'>
<a name='430'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_10"> ( t_save,                       &amp;<a name='431'>
                    ids, ide, jds, jde, kds, kde, &amp;<a name='432'>
                    ims, ime, jms, jme, kms, kme, &amp;<a name='433'>
                    its, ite, jts, jte, kts, kte )<a name='434'>
<a name='435'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND2D'>zero_tend2d</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND2D_1">( mu_tend,                  &amp;<a name='436'>
                    ids, ide, jds, jde, 1, 1, &amp;<a name='437'>
                    ims, ime, jms, jme, 1, 1, &amp;<a name='438'>
                    its, ite, jts, jte, 1, 1 )<a name='439'>
<a name='440'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND2D'>zero_tend2d</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND2D_2">( mu_save,                  &amp;<a name='441'>
                    ids, ide, jds, jde, 1, 1, &amp;<a name='442'>
                    ims, ime, jms, jme, 1, 1, &amp;<a name='443'>
                    its, ite, jts, jte, 1, 1 )<a name='444'>
<a name='445'>
   <font color=#447700>!  advection tendencies<a name='446'></font>
   CALL nl_get_time_step ( 1, time_step )<a name='447'>
<a name='448'>
<a name='449'>
    IF( (rk_step == 3) .and. ( adv_opt == WENO_MOM ) ) THEN<a name='450'>
<a name='451'>
     CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_WENO_U'>advect_weno_u</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_WENO_U_1"> ( u, u , ru_tend, ru, rv, ww, &amp;<a name='452'>
                   c1h, c2h,                     &amp;<a name='453'>
                   mut, time_step, config_flags, &amp;<a name='454'>
                   msfux, msfuy, msfvx, msfvy,   &amp;<a name='455'>
                   msftx, msfty,                 &amp;<a name='456'>
                   fnm, fnp, rdx, rdy, rdnw,     &amp;<a name='457'>
                   ids, ide, jds, jde, kds, kde, &amp;<a name='458'>
                   ims, ime, jms, jme, kms, kme, &amp;<a name='459'>
                   its, ite, jts, jte, kts, kte )<a name='460'>
<a name='461'>
     ELSE<a name='462'>
     <a name='463'>
     CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_U'>advect_u</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_U_1"> ( u, u , ru_tend, ru, rv, ww, &amp;<a name='464'>
                   c1h, c2h,                     &amp;<a name='465'>
                   mut, time_step, config_flags, &amp;<a name='466'>
                   msfux, msfuy, msfvx, msfvy,   &amp;<a name='467'>
                   msftx, msfty,                 &amp;<a name='468'>
                   fnm, fnp, rdx, rdy, rdnw,     &amp;<a name='469'>
                   ids, ide, jds, jde, kds, kde, &amp;<a name='470'>
                   ims, ime, jms, jme, kms, kme, &amp;<a name='471'>
                   its, ite, jts, jte, kts, kte )<a name='472'>
      ENDIF<a name='473'>
<a name='474'>
     IF( (rk_step == 3) .and. ( adv_opt == WENO_MOM ) ) THEN<a name='475'>
<a name='476'>
     CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_WENO_V'>advect_weno_v</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_WENO_V_1"> ( v, v , rv_tend, ru, rv, ww,  &amp;<a name='477'>
                   c1h, c2h,                     &amp;<a name='478'>
                   mut, time_step, config_flags, &amp;<a name='479'>
                   msfux, msfuy, msfvx, msfvy,   &amp;<a name='480'>
                   msftx, msfty,                 &amp;<a name='481'>
                   fnm, fnp, rdx, rdy, rdnw,     &amp;<a name='482'>
                   ids, ide, jds, jde, kds, kde, &amp;<a name='483'>
                   ims, ime, jms, jme, kms, kme, &amp;<a name='484'>
                   its, ite, jts, jte, kts, kte )<a name='485'>
<a name='486'>
    ELSE<a name='487'>
     <a name='488'>
     CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_V'>advect_v</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_V_1"> ( v, v , rv_tend, ru, rv, ww,  &amp;<a name='489'>
                   c1h, c2h,                     &amp;<a name='490'>
                   mut, time_step, config_flags, &amp;<a name='491'>
                   msfux, msfuy, msfvx, msfvy,   &amp;<a name='492'>
                   msftx, msfty,                 &amp;<a name='493'>
                   fnm, fnp, rdx, rdy, rdnw,     &amp;<a name='494'>
                   ids, ide, jds, jde, kds, kde, &amp;<a name='495'>
                   ims, ime, jms, jme, kms, kme, &amp;<a name='496'>
                   its, ite, jts, jte, kts, kte )<a name='497'>
    ENDIF<a name='498'>
<a name='499'>
<a name='500'>
   IF (non_hydrostatic) THEN<a name='501'>
     IF( (rk_step == 3) .and. ( adv_opt == WENO_MOM ) ) THEN<a name='502'>
     CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_WENO_W'>advect_weno_w</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_WENO_W_1"> ( w, w, rw_tend, ru, rv, ww,    &amp;<a name='503'>
                     c1h, c2h,                     &amp;<a name='504'>
                     mut, time_step, config_flags, &amp;<a name='505'>
                     msfux, msfuy, msfvx, msfvy,   &amp;<a name='506'>
                     msftx, msfty,                 &amp;<a name='507'>
                     fnm, fnp, rdx, rdy, rdn,      &amp;<a name='508'>
                     ids, ide, jds, jde, kds, kde, &amp;<a name='509'>
                     ims, ime, jms, jme, kms, kme, &amp;<a name='510'>
                     its, ite, jts, jte, kts, kte )<a name='511'>
<a name='512'>
     ELSE<a name='513'>
     <a name='514'>
     CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_W'>advect_w</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_W_1"> ( w, w, rw_tend, ru, rv, ww,    &amp;<a name='515'>
                     c1h, c2h,                     &amp;<a name='516'>
                     mut, time_step, config_flags, &amp;<a name='517'>
                     msfux, msfuy, msfvx, msfvy,   &amp;<a name='518'>
                     msftx, msfty,                 &amp;<a name='519'>
                     fnm, fnp, rdx, rdy, rdn,      &amp;<a name='520'>
                     ids, ide, jds, jde, kds, kde, &amp;<a name='521'>
                     ims, ime, jms, jme, kms, kme, &amp;<a name='522'>
                     its, ite, jts, jte, kts, kte )<a name='523'>
     ENDIF<a name='524'>
   ENDIF<a name='525'>
<font color=#447700>!  theta flux divergence<a name='526'></font>
<a name='527'>
<font color=#447700>! 11/2016 ERM: Use WENO for theta flux on 3rd RK step if using WENO_SCALAR or WENOPD_SCALAR<a name='528'></font>
<font color=#447700>! to be consistent with other scalar fluxes<a name='529'></font>
      IF(  ( config_flags%scalar_adv_opt == WENO_SCALAR  &amp;<a name='530'>
                 .or. config_flags%scalar_adv_opt == WENOPD_SCALAR    &amp;<a name='531'>
                 .or. config_flags%moist_adv_opt == WENO_SCALAR       &amp;<a name='532'>
                 .or. config_flags%moist_adv_opt == WENOPD_SCALAR     &amp;<a name='533'>
                       )  .and. (rk_step == 3) ) THEN<a name='534'>
<font color=#447700>! also use weno for monotonic scalar option so that the h_ and z_tendency arrays are not needed<a name='535'></font>
<a name='536'>
        CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_WENO'>advect_scalar_weno</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_WENO_2"> ( t, t, t_tend, ru, rv, ww,     &amp;<a name='537'>
                                 c1h, c2h, mut, time_step,      &amp;<a name='538'>
                                 config_flags,                  &amp;<a name='539'>
                                 msfux, msfuy, msfvx, msfvy,    &amp;<a name='540'>
                                 msftx, msfty, fnm, fnp,        &amp;<a name='541'>
                                 rdx, rdy, rdnw,                &amp;<a name='542'>
                                 ids, ide, jds, jde, kds, kde,  &amp;<a name='543'>
                                 ims, ime, jms, jme, kms, kme,  &amp;<a name='544'>
                                 its, ite, jts, jte, kts, kte  )<a name='545'>
     ELSE<a name='546'>
<a name='547'>
     CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR'>advect_scalar</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_4"> ( t, t, t_tend, ru, rv, ww,     &amp;<a name='548'>
                          c1h, c2h,                     &amp;<a name='549'>
                          mut, time_step, config_flags, &amp;<a name='550'>
                          msfux, msfuy, msfvx, msfvy,   &amp;<a name='551'>
                          msftx, msfty, fnm, fnp,       &amp;<a name='552'>
                          rdx, rdy, rdnw,               &amp;<a name='553'>
                          ids, ide, jds, jde, kds, kde, &amp;<a name='554'>
                          ims, ime, jms, jme, kms, kme, &amp;<a name='555'>
                          its, ite, jts, jte, kts, kte ) <a name='556'>
<a name='557'>
     ENDIF<a name='558'>
     <a name='559'>
     IF ( config_flags%cu_physics == GDSCHEME  .OR.     &amp;<a name='560'>
          config_flags%cu_physics == GFSCHEME  .OR.     &amp;<a name='561'>
          config_flags%cu_physics == G3SCHEME  .OR.     &amp;<a name='562'>
          config_flags%cu_physics == NTIEDTKESCHEME )  THEN     <font color=#447700>! NTiedtke<a name='563'></font>
<a name='564'>
     <font color=#447700>! theta advection only:<a name='565'></font>
<a name='566'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SET_TEND'>set_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TEND_1">( RTHFTEN, t_tend, msfty,          &amp;<a name='567'>
                        ids, ide, jds, jde, kds, kde,    &amp;<a name='568'>
                        ims, ime, jms, jme, kms, kme,    &amp;<a name='569'>
                        its, ite, jts, jte, kts, kte     )<a name='570'>
<a name='571'>
     END IF<a name='572'>
<a name='573'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#RHS_PH'>rhs_ph</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RHS_PH_1">( ph_tend, u, v, ww, ph, ph, phb, w, &amp;<a name='574'>
                  mut, muu, muv,                     &amp;<a name='575'>
                  c1f, c2f,                          &amp;<a name='576'>
                  fnm, fnp,                          &amp;<a name='577'>
                  rdnw, cfn, cfn1, rdx, rdy,         &amp;<a name='578'>
                  msfux, msfuy, msfvx,               &amp;<a name='579'>
                  msfvx_inv, msfvy,                  &amp;<a name='580'>
                  msftx, msfty,                      &amp;<a name='581'>
                  non_hydrostatic,                   &amp;<a name='582'>
                  config_flags,                      &amp;<a name='583'>
                  ids, ide, jds, jde, kds, kde,      &amp;<a name='584'>
                  ims, ime, jms, jme, kms, kme,      &amp;<a name='585'>
                  its, ite, jts, jte, kts, kte      )<a name='586'>
<a name='587'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_PRESSURE_GRADIENT'>horizontal_pressure_gradient</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_PRESSURE_GRADIENT_1">( ru_tend,rv_tend,                 &amp;<a name='588'>
                                         ph,alt,p,pb,al,php,cqu,cqv,     &amp;<a name='589'>
                                         muu,muv,mu,c1h,c2h,fnm,fnp,rdnw,&amp;<a name='590'>
                                         cf1,cf2,cf3,cfn,cfn1,           &amp;<a name='591'>
                                         rdx,rdy,msfux,msfuy,            &amp;<a name='592'>
                                         msfvx,msfvy,msftx,msfty,        &amp;<a name='593'>
                                         config_flags, non_hydrostatic,  &amp;<a name='594'>
                                         top_lid,                        &amp;<a name='595'>
                                         ids, ide, jds, jde, kds, kde,   &amp;<a name='596'>
                                         ims, ime, jms, jme, kms, kme,   &amp;<a name='597'>
                                         its, ite, jts, jte, kts, kte   )<a name='598'>
<a name='599'>
     IF (non_hydrostatic) THEN<a name='600'>
          CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PG_BUOY_W'>pg_buoy_w</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PG_BUOY_W_1">( rw_tend, p, cqw, mu, mub,       &amp;<a name='601'>
                          c1f,c2f,                        &amp;<a name='602'>
                          rdnw, rdn, g, msftx, msfty,     &amp;<a name='603'>
                          ids, ide, jds, jde, kds, kde,   &amp;<a name='604'>
                          ims, ime, jms, jme, kms, kme,   &amp;<a name='605'>
                          its, ite, jts, jte, kts, kte   )<a name='606'>
     ENDIF<a name='607'>
<a name='608'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#W_DAMP'>w_damp</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="W_DAMP_1">   ( rw_tend, max_vert_cfl,             &amp;<a name='609'>
                      max_horiz_cfl,                    &amp;<a name='610'>
                      u, v, ww, w, mut, c1f, c2f, rdnw, &amp;<a name='611'>
                      rdx, rdy, msfux, msfuy, msfvx,    &amp;<a name='612'>
                      msfvy, dt, config_flags,          &amp;<a name='613'>
                      ids, ide, jds, jde, kds, kde,     &amp;<a name='614'>
                      ims, ime, jms, jme, kms, kme,     &amp;<a name='615'>
                      its, ite, jts, jte, kts, kte     )<a name='616'>
<a name='617'>
     IF(config_flags%pert_coriolis) THEN<a name='618'>
<a name='619'>
          CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PERTURBATION_CORIOLIS'>perturbation_coriolis</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PERTURBATION_CORIOLIS_1"> ( ru, rv, rw,                   &amp;<a name='620'>
                                       ru_tend,  rv_tend,  rw_tend,  &amp;<a name='621'>
                                       config_flags,                 &amp;<a name='622'>
                                       u_base, v_base, z_base,       &amp;<a name='623'>
                                       muu, muv, c1h, c2h, phb, ph,  &amp;<a name='624'>
                                       msftx, msfty, msfux, msfuy,   &amp;<a name='625'>
                                       msfvx, msfvy,                 &amp;<a name='626'>
                                       f, e, sina, cosa, fnm, fnp,   &amp;<a name='627'>
                                       ids, ide, jds, jde, kds, kde, &amp;<a name='628'>
                                       ims, ime, jms, jme, kms, kme, &amp;<a name='629'>
                                       its, ite, jts, jte, kts, kte )<a name='630'>
     ELSE<a name='631'>
          CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CORIOLIS'>coriolis</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CORIOLIS_1"> ( ru, rv, rw,                   &amp;<a name='632'>
                          ru_tend,  rv_tend,  rw_tend,  &amp;<a name='633'>
                          config_flags,                 &amp;<a name='634'>
                          msftx, msfty, msfux, msfuy,   &amp;<a name='635'>
                          msfvx, msfvy,                 &amp;<a name='636'>
                          f, e, sina, cosa, fnm, fnp,   &amp;<a name='637'>
                          ids, ide, jds, jde, kds, kde, &amp;<a name='638'>
                          ims, ime, jms, jme, kms, kme, &amp;<a name='639'>
                          its, ite, jts, jte, kts, kte )<a name='640'>
<a name='641'>
     END IF<a name='642'>
<a name='643'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CURVATURE'>curvature</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CURVATURE_1"> ( ru, rv, rw, u, v, w,            &amp;<a name='644'>
                       ru_tend,  rv_tend,  rw_tend,    &amp;<a name='645'>
                       config_flags,                   &amp;<a name='646'>
                       msfux, msfuy, msfvx, msfvy,     &amp;<a name='647'>
                       msftx, msfty,                   &amp;<a name='648'>
                       clat, fnm, fnp, rdx, rdy,       &amp;<a name='649'>
                       ids, ide, jds, jde, kds, kde,   &amp;<a name='650'>
                       ims, ime, jms, jme, kms, kme,   &amp;<a name='651'>
                       its, ite, jts, jte, kts, kte   )<a name='652'>
<a name='653'>
<font color=#447700>! Damping option added for Held-Suarez test (also uses lw option HELDSUAREZ)<a name='654'></font>
      IF (config_flags%ra_lw_physics == HELDSUAREZ) THEN<a name='655'>
         CALL <A href='../../html_code/dyn_em/module_damping_em.F.html#HELD_SUAREZ_DAMP'>held_suarez_damp</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HELD_SUAREZ_DAMP_1"> ( ru_tend, rv_tend,               &amp;   <a name='656'>
                                 ru,rv,p,pb,                     &amp;<a name='657'>
                                 ids, ide, jds, jde, kds, kde,   &amp;<a name='658'>
                                 ims, ime, jms, jme, kms, kme,   &amp;<a name='659'>
                                 its, ite, jts, jte, kts, kte   )<a name='660'>
      END IF<a name='661'>
<a name='662'>
<font color=#447700>!**************************************************************<a name='663'></font>
<font color=#447700>!<a name='664'></font>
<font color=#447700>!  Next, the terms that we integrate only with forward-in-time<a name='665'></font>
<font color=#447700>!  (evaluate with time t variables).<a name='666'></font>
<font color=#447700>!<a name='667'></font>
<font color=#447700>!**************************************************************<a name='668'></font>
<a name='669'>
  forward_step: IF( rk_step == 1 ) THEN<a name='670'>
<a name='671'>
    diff_opt1 : IF (config_flags%diff_opt .eq. 1) THEN<a name='672'>
   <a name='673'>
        CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION'>horizontal_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_1"> ('u', u, ru_tendf, mut,               &amp;<a name='674'>
                                        c1h, c2h, config_flags,         &amp;<a name='675'>
                                        msfux, msfuy, msfvx, msfvx_inv, &amp;<a name='676'>
                                        msfvy,msftx, msfty,             &amp;<a name='677'>
                                        khdif, xkmhd, rdx, rdy,         &amp;<a name='678'>
                                        ids, ide, jds, jde, kds, kde,   &amp;<a name='679'>
                                        ims, ime, jms, jme, kms, kme,   &amp;<a name='680'>
                                        its, ite, jts, jte, kts, kte   )<a name='681'>
<a name='682'>
        CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION'>horizontal_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_2"> ('v', v, rv_tendf, mut,               &amp;<a name='683'>
                                        c1h, c2h, config_flags,         &amp;<a name='684'>
                                        msfux, msfuy, msfvx, msfvx_inv, &amp;<a name='685'>
                                        msfvy,msftx, msfty,             &amp;<a name='686'>
                                        khdif, xkmhd, rdx, rdy,         &amp;<a name='687'>
                                        ids, ide, jds, jde, kds, kde,   &amp;<a name='688'>
                                        ims, ime, jms, jme, kms, kme,   &amp;<a name='689'>
                                        its, ite, jts, jte, kts, kte   )<a name='690'>
<a name='691'>
        CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION'>horizontal_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_3"> ('w', w, rw_tendf, mut,               &amp;<a name='692'>
                                        c1f, c2f, config_flags,         &amp;<a name='693'>
                                        msfux, msfuy, msfvx, msfvx_inv, &amp;<a name='694'>
                                        msfvy,msftx, msfty,             &amp;<a name='695'>
                                        khdif, xkmhd, rdx, rdy,         &amp;<a name='696'>
                                        ids, ide, jds, jde, kds, kde,   &amp;<a name='697'>
                                        ims, ime, jms, jme, kms, kme,   &amp;<a name='698'>
                                        its, ite, jts, jte, kts, kte   )<a name='699'>
<a name='700'>
        khdq = 3.*khdif<a name='701'>
        CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION_3DMP'>horizontal_diffusion_3dmp</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_3DMP_1"> ( 'm', t, t_tendf, mut,            &amp;<a name='702'>
                                         c1h, c2h,                        &amp;<a name='703'>
                                         config_flags, t_init,            &amp;<a name='704'>
                                         msfux, msfuy, msfvx, msfvx_inv,  &amp;<a name='705'>
                                         msfvy, msftx, msfty,             &amp;<a name='706'>
                                         khdq , xkhh, rdx, rdy,           &amp;<a name='707'>
                                         ids, ide, jds, jde, kds, kde,    &amp;<a name='708'>
                                         ims, ime, jms, jme, kms, kme,    &amp;<a name='709'>
                                         its, ite, jts, jte, kts, kte    )<a name='710'>
<a name='711'>
        pbl_test : IF (config_flags%bl_pbl_physics .eq. 0) THEN<a name='712'>
<a name='713'>
          CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_U'>vertical_diffusion_u</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_U_1"> ( u, ru_tendf, config_flags,      &amp;<a name='714'>
                                      u_base, c1h, c2h,               &amp;<a name='715'>
                                      alt, muu, rdn, rdnw, kvdif,     &amp;<a name='716'>
                                      ids, ide, jds, jde, kds, kde,   &amp;<a name='717'>
                                      ims, ime, jms, jme, kms, kme,   &amp;<a name='718'>
                                      its, ite, jts, jte, kts, kte   )<a name='719'>
<a name='720'>
          CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_V'>vertical_diffusion_v</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_V_1"> ( v, rv_tendf, config_flags,      &amp;<a name='721'>
                                      v_base, c1h, c2h,               &amp;<a name='722'>
                                      alt, muv, rdn, rdnw, kvdif,     &amp;<a name='723'>
                                      ids, ide, jds, jde, kds, kde,   &amp;<a name='724'>
                                      ims, ime, jms, jme, kms, kme,   &amp;<a name='725'>
                                      its, ite, jts, jte, kts, kte   )<a name='726'>
<a name='727'>
          IF (non_hydrostatic)                                           &amp;<a name='728'>
          CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION'>vertical_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_1"> ( 'w', w, rw_tendf, config_flags,      &amp;<a name='729'>
                                    c1f, c2f,                            &amp;<a name='730'>
                                    alt, mut, rdn, rdnw, kvdif,          &amp;<a name='731'>
                                    ids, ide, jds, jde, kds, kde,        &amp;<a name='732'>
                                    ims, ime, jms, jme, kms, kme,        &amp;<a name='733'>
                                    its, ite, jts, jte, kts, kte        )<a name='734'>
<a name='735'>
          kvdq = 3.*kvdif<a name='736'>
          CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_3DMP'>vertical_diffusion_3dmp</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_3DMP_1"> ( t, t_tendf, config_flags, t_init,     &amp;<a name='737'>
                                         c1h, c2h,                             &amp;<a name='738'>
                                         alt, mut, rdn, rdnw, kvdq ,           &amp;<a name='739'>
                                         ids, ide, jds, jde, kds, kde,         &amp;<a name='740'>
                                         ims, ime, jms, jme, kms, kme,         &amp;<a name='741'>
                                         its, ite, jts, jte, kts, kte         )<a name='742'>
<a name='743'>
        ENDIF pbl_test<a name='744'>
<a name='745'>
   <font color=#447700>!  Theta tendency computations.<a name='746'></font>
<a name='747'>
    END IF diff_opt1<a name='748'>
<a name='749'>
    IF ( diff_6th_opt .NE. 0 ) THEN<a name='750'>
<a name='751'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SIXTH_ORDER_DIFFUSION'>sixth_order_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SIXTH_ORDER_DIFFUSION_1">( 'u', u, ru_tendf, mut, dt,          &amp;<a name='752'>
                                       config_flags, c1h, c2h,        &amp;<a name='753'>
                                       diff_6th_opt, diff_6th_factor, &amp;<a name='754'>
                                       ids, ide, jds, jde, kds, kde,  &amp;<a name='755'>
                                       ims, ime, jms, jme, kms, kme,  &amp;<a name='756'>
                                       its, ite, jts, jte, kts, kte )<a name='757'>
<a name='758'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SIXTH_ORDER_DIFFUSION'>sixth_order_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SIXTH_ORDER_DIFFUSION_2">( 'v', v, rv_tendf, mut, dt,          &amp;<a name='759'>
                                       config_flags, c1h, c2h,        &amp;<a name='760'>
                                       diff_6th_opt, diff_6th_factor, &amp;<a name='761'>
                                       ids, ide, jds, jde, kds, kde,  &amp;<a name='762'>
                                       ims, ime, jms, jme, kms, kme,  &amp;<a name='763'>
                                       its, ite, jts, jte, kts, kte )<a name='764'>
<a name='765'>
      IF (non_hydrostatic)                                            &amp; <a name='766'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SIXTH_ORDER_DIFFUSION'>sixth_order_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SIXTH_ORDER_DIFFUSION_3">( 'w', w, rw_tendf, mut, dt,          &amp;<a name='767'>
                                       config_flags, c1f, c2f,        &amp;<a name='768'>
                                       diff_6th_opt, diff_6th_factor, &amp;<a name='769'>
                                       ids, ide, jds, jde, kds, kde,  &amp;<a name='770'>
                                       ims, ime, jms, jme, kms, kme,  &amp;<a name='771'>
                                       its, ite, jts, jte, kts, kte )<a name='772'>
<a name='773'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SIXTH_ORDER_DIFFUSION'>sixth_order_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SIXTH_ORDER_DIFFUSION_4">( 'm', t,  t_tendf, mut, dt,          &amp;<a name='774'>
                                       config_flags, c1h, c2h,        &amp;<a name='775'>
                                       diff_6th_opt, diff_6th_factor, &amp;<a name='776'>
                                       ids, ide, jds, jde, kds, kde,  &amp;<a name='777'>
                                       ims, ime, jms, jme, kms, kme,  &amp;<a name='778'>
                                       its, ite, jts, jte, kts, kte )<a name='779'>
<a name='780'>
    ENDIF<a name='781'>
<a name='782'>
    IF( damp_opt .eq. 2 )                                      &amp;<a name='783'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#RK_RAYLEIGH_DAMP'>rk_rayleigh_damp</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_RAYLEIGH_DAMP_1">( ru_tendf, rv_tendf,              &amp;<a name='784'>
                              rw_tendf, t_tendf,               &amp;<a name='785'>
                              u, v, w, t, t_init,              &amp;<a name='786'>
                              c1h, c2h, c1f, c2f,              &amp;<a name='787'>
                              mut, muu, muv, ph, phb,          &amp;<a name='788'>
                              u_base, v_base, t_base, z_base,  &amp;<a name='789'>
                              dampcoef, zdamp,                 &amp;<a name='790'>
                              ids, ide, jds, jde, kds, kde,    &amp;<a name='791'>
                              ims, ime, jms, jme, kms, kme,    &amp;<a name='792'>
                              its, ite, jts, jte, kts, kte   )<a name='793'>
<a name='794'>
    IF( rad_nudge .eq. 1 )                                     &amp;<a name='795'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#THETA_RELAXATION'>theta_relaxation</A><A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_RELAXATION_1">( t_tendf, t, t_init,              &amp;<a name='796'>
                              mut, c1h, c2h, ph, phb,          &amp;<a name='797'>
                              t_base, z_base,                  &amp;<a name='798'>
                              ids, ide, jds, jde, kds, kde,    &amp;<a name='799'>
                              ims, ime, jms, jme, kms, kme,    &amp;<a name='800'>
                              its, ite, jts, jte, kts, kte   )<a name='801'>
<a name='802'>
  END IF forward_step<a name='803'>
<a name='804'>
END SUBROUTINE rk_tendency<a name='805'>
<a name='806'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='807'></font>
<a name='808'>
<A NAME='RK_ADDTEND_DRY'><A href='../../html_code/dyn_em/module_em.F.html#RK_ADDTEND_DRY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='809'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>rk_addtend_dry</font> ( ru_tend, rv_tend, rw_tend, ph_tend, t_tend,      &amp; <A href='../../call_to/RK_ADDTEND_DRY.html' TARGET='index'>1</A><a name='810'>
                            ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='811'>
                            u_save, v_save, w_save, ph_save, t_save,         &amp;<a name='812'>
                            mu_tend, mu_tendf, rk_step, c1, c2,              &amp;<a name='813'>
                            h_diabatic, mut, msftx, msfty, msfux, msfuy,     &amp;<a name='814'>
                            msfvx, msfvx_inv, msfvy,                         &amp;<a name='815'>
                            ids,ide, jds,jde, kds,kde,                       &amp;<a name='816'>
                            ims,ime, jms,jme, kms,kme,                       &amp;<a name='817'>
                            ips,ipe, jps,jpe, kps,kpe,                       &amp;<a name='818'>
                            its,ite, jts,jte, kts,kte                       )<a name='819'>
<a name='820'>
   IMPLICIT NONE<a name='821'>
<a name='822'>
   <font color=#447700>!  Input data.<a name='823'></font>
<a name='824'>
   INTEGER ,               INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='825'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='826'>
                                            ips, ipe, jps, jpe, kps, kpe, &amp;<a name='827'>
                                            its, ite, jts, jte, kts, kte<a name='828'>
   INTEGER ,               INTENT(IN   ) :: rk_step<a name='829'>
<a name='830'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) , INTENT(INOUT) :: ru_tend, &amp;<a name='831'>
                                                                      rv_tend, &amp;<a name='832'>
                                                                      rw_tend, &amp;<a name='833'>
                                                                      ph_tend, &amp;<a name='834'>
                                                                      t_tend,  &amp;<a name='835'>
                                                                      ru_tendf, &amp;<a name='836'>
                                                                      rv_tendf, &amp;<a name='837'>
                                                                      rw_tendf, &amp;<a name='838'>
                                                                      ph_tendf, &amp;<a name='839'>
                                                                      t_tendf<a name='840'>
<a name='841'>
   REAL , DIMENSION( ims:ime , jms:jme  ) , INTENT(INOUT) :: mu_tend, &amp;<a name='842'>
                                                             mu_tendf<a name='843'>
<a name='844'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) , INTENT(IN   ) ::  u_save,  &amp;<a name='845'>
                                                                       v_save,  &amp;<a name='846'>
                                                                       w_save,  &amp;<a name='847'>
                                                                      ph_save,  &amp;<a name='848'>
                                                                       t_save,  &amp;<a name='849'>
                                                                      h_diabatic<a name='850'>
<a name='851'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,         INTENT(IN   ) :: mut,       &amp;<a name='852'>
                                                                    msftx,     &amp;<a name='853'>
                                                                    msfty,     &amp;<a name='854'>
                                                                    msfux,     &amp;<a name='855'>
                                                                    msfuy,     &amp;<a name='856'>
                                                                    msfvx,     &amp;<a name='857'>
                                                                    msfvx_inv, &amp;<a name='858'>
                                                                    msfvy<a name='859'>
<a name='860'>
   REAL , DIMENSION( kms:kme ) ,         INTENT(IN   ) :: c1, c2<a name='861'>
<a name='862'>
<font color=#447700>! Local<a name='863'></font>
   INTEGER :: i, j, k<a name='864'>
<a name='865'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='866'></font>
<font color=#447700>!<a name='867'></font>
<font color=#447700>! rk_addtend_dry constructs the full large-timestep tendency terms for<a name='868'></font>
<font color=#447700>! momentum (u,v,w), theta and geopotential equations.   This is accomplished<a name='869'></font>
<font color=#447700>! by combining the physics tendencies (in *tendf; these are computed <a name='870'></font>
<font color=#447700>! the first RK substep, held fixed thereafter) with the RK tendencies <a name='871'></font>
<font color=#447700>! (in *tend, these include advection, pressure gradient, etc; <a name='872'></font>
<font color=#447700>! these change each rk substep).  Output is in *tend.<a name='873'></font>
<font color=#447700>!<a name='874'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='875'></font>
<a name='876'>
<font color=#447700>!  Finally, add the forward-step tendency to the rk_tendency<a name='877'></font>
<a name='878'>
<font color=#447700>! u/v/w/save contain bc tendency that needs to be multiplied by msf<a name='879'></font>
<font color=#447700>! (u by msfuy, v by msfvx)<a name='880'></font>
<font color=#447700>!  before adding it to physics tendency (*tendf)<a name='881'></font>
<font color=#447700>! For momentum we need the final tendency to include an inverse msf<a name='882'></font>
<font color=#447700>! physics/bc tendency needs to be divided, advection tendency already has it<a name='883'></font>
<a name='884'>
<font color=#447700>! For scalars we need the final tendency to include an inverse msf (msfty)<a name='885'></font>
<font color=#447700>! advection tendency is OK, physics/bc tendency needs to be divided by msf<a name='886'></font>
<a name='887'>
   DO j = jts,MIN(jte,jde-1)<a name='888'>
   DO k = kts,kte-1<a name='889'>
   DO i = its,ite<a name='890'>
     <font color=#447700>! multiply by my to uncouple u<a name='891'></font>
     IF(rk_step == 1)ru_tendf(i,k,j) = ru_tendf(i,k,j) +  u_save(i,k,j)*msfuy(i,j)<a name='892'>
     <font color=#447700>! divide by my to couple u<a name='893'></font>
     ru_tend(i,k,j) = ru_tend(i,k,j) + ru_tendf(i,k,j)/msfuy(i,j)<a name='894'>
   ENDDO<a name='895'>
   ENDDO<a name='896'>
   ENDDO<a name='897'>
<a name='898'>
   DO j = jts,jte<a name='899'>
   DO k = kts,kte-1<a name='900'>
   DO i = its,MIN(ite,ide-1)<a name='901'>
     <font color=#447700>! multiply by mx to uncouple v<a name='902'></font>
     IF(rk_step == 1)rv_tendf(i,k,j) = rv_tendf(i,k,j) +  v_save(i,k,j)*msfvx(i,j)<a name='903'>
     <font color=#447700>! divide by mx to couple v<a name='904'></font>
     rv_tend(i,k,j) = rv_tend(i,k,j) + rv_tendf(i,k,j)*msfvx_inv(i,j)<a name='905'>
   ENDDO<a name='906'>
   ENDDO<a name='907'>
   ENDDO<a name='908'>
<a name='909'>
   DO j = jts,MIN(jte,jde-1)<a name='910'>
   DO k = kts,kte<a name='911'>
   DO i = its,MIN(ite,ide-1)<a name='912'>
     <font color=#447700>! multiply by my to uncouple w<a name='913'></font>
     IF(rk_step == 1)rw_tendf(i,k,j) = rw_tendf(i,k,j) +  w_save(i,k,j)*msfty(i,j)<a name='914'>
     <font color=#447700>! divide by my to couple w<a name='915'></font>
     rw_tend(i,k,j) = rw_tend(i,k,j) + rw_tendf(i,k,j)/msfty(i,j)<a name='916'>
     IF(rk_step == 1)ph_tendf(i,k,j) = ph_tendf(i,k,j) +  ph_save(i,k,j)<a name='917'>
     <font color=#447700>! divide by my to couple scalar<a name='918'></font>
     ph_tend(i,k,j) = ph_tend(i,k,j) + ph_tendf(i,k,j)/msfty(i,j)<a name='919'>
   ENDDO<a name='920'>
   ENDDO<a name='921'>
   ENDDO<a name='922'>
<a name='923'>
   DO j = jts,MIN(jte,jde-1)<a name='924'>
   DO k = kts,kte-1<a name='925'>
   DO i = its,MIN(ite,ide-1)<a name='926'>
     IF(rk_step == 1)t_tendf(i,k,j) = t_tendf(i,k,j) +  t_save(i,k,j)<a name='927'>
     <font color=#447700>! divide by my to couple theta<a name='928'></font>
      t_tend(i,k,j) =  t_tend(i,k,j) +  t_tendf(i,k,j)/msfty(i,j)  &amp;<a name='929'>
                                     +  mut(i,j)*h_diabatic(i,k,j)/msfty(i,j)<a name='930'>
     <font color=#447700>! divide by my to couple heating<a name='931'></font>
   ENDDO<a name='932'>
   ENDDO<a name='933'>
   ENDDO<a name='934'>
<a name='935'>
   DO j = jts,MIN(jte,jde-1)<a name='936'>
   DO i = its,MIN(ite,ide-1)<a name='937'>
<font color=#447700>! mu tendencies not coupled with 1/msf<a name='938'></font>
      MU_TEND(i,j) =  MU_TEND(i,j) +  MU_TENDF(i,j)<a name='939'>
   ENDDO<a name='940'>
   ENDDO<a name='941'>
<a name='942'>
END SUBROUTINE rk_addtend_dry<a name='943'>
<a name='944'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='945'></font>
<a name='946'>
<A NAME='RK_SCALAR_TEND'><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='947'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>rk_scalar_tend</font> ( scs, sce, config_flags,          &amp; <A href='../../call_to/RK_SCALAR_TEND.html' TARGET='index'>5</A>,<A href='../../call_from/RK_SCALAR_TEND.html' TARGET='index'>13</A><a name='948'>
                            tenddec,                        &amp; <a name='949'>
                            rk_step, dt,                     &amp;<a name='950'>
                            ru, rv, ww, mut, mub, mu_old,    &amp;<a name='951'>
                            c1h, c2h, alt,                   &amp;<a name='952'>
                            scalar_old, scalar,              &amp;<a name='953'>
                            scalar_tends, advect_tend,       &amp;<a name='954'>
                            h_tendency, z_tendency,          &amp; <a name='955'>
                            RQVFTEN,                         &amp;<a name='956'>
                            base, moist_step, fnm, fnp,      &amp;<a name='957'>
                            msfux, msfuy, msfvx, msfvx_inv,  &amp;<a name='958'>
                            msfvy, msftx, msfty,             &amp;<a name='959'>
                            rdx, rdy, rdn, rdnw,             &amp;<a name='960'>
                            khdif, kvdif, xkmhd,             &amp;<a name='961'>
                            diff_6th_opt, diff_6th_factor,   &amp;<a name='962'>
                            adv_opt,                         &amp;<a name='963'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='964'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='965'>
                            its, ite, jts, jte, kts, kte    )<a name='966'>
<a name='967'>
   IMPLICIT NONE<a name='968'>
<a name='969'>
   <font color=#447700>!  Input data.<a name='970'></font>
<a name='971'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='972'>
<a name='973'>
   LOGICAL ,                INTENT(IN   ) :: tenddec <font color=#447700>! tendency term<a name='974'></font>
<a name='975'>
   INTEGER ,                INTENT(IN   ) :: rk_step, scs, sce<a name='976'>
   INTEGER ,                INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='977'>
                                             ims, ime, jms, jme, kms, kme, &amp;<a name='978'>
                                             its, ite, jts, jte, kts, kte<a name='979'>
<a name='980'>
   LOGICAL , INTENT(IN   ) :: moist_step<a name='981'>
<a name='982'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce ),                &amp;<a name='983'>
                                         INTENT(IN   )  :: scalar, scalar_old<a name='984'>
<a name='985'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce ),                      &amp;<a name='986'>
                                         INTENT(INOUT)  :: scalar_tends<a name='987'>
                                                    <a name='988'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  ), INTENT(INOUT) :: advect_tend<a name='989'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  ), INTENT(  OUT) :: h_tendency, z_tendency <a name='990'>
<a name='991'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  ), INTENT(OUT  ) :: RQVFTEN<a name='992'>
<a name='993'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme  ), INTENT(IN   ) ::     ru,  &amp;<a name='994'>
                                                                      rv,  &amp;<a name='995'>
                                                                      ww,  &amp;<a name='996'>
                                                                      xkmhd,  &amp;<a name='997'>
                                                                      alt<a name='998'>
<a name='999'>
<a name='1000'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: fnm,  &amp;<a name='1001'>
                                                                  fnp,  &amp;<a name='1002'>
                                                                  rdn,  &amp;<a name='1003'>
                                                                  rdnw, &amp;<a name='1004'>
                                                                  base<a name='1005'>
<a name='1006'>
   REAL , DIMENSION( kms:kme ) ,                 INTENT(IN   ) :: c1h, c2h<a name='1007'>
<a name='1008'>
   REAL , DIMENSION( ims:ime , jms:jme ) ,       INTENT(IN   ) :: msfux,    &amp;<a name='1009'>
                                                                  msfuy,    &amp;<a name='1010'>
                                                                  msfvx,    &amp;<a name='1011'>
                                                                  msfvx_inv,    &amp;<a name='1012'>
                                                                  msfvy,    &amp;<a name='1013'>
                                                                  msftx,    &amp;<a name='1014'>
                                                                  msfty,    &amp;<a name='1015'>
                                                                  mub,     &amp;<a name='1016'>
                                                                  mut,     &amp;<a name='1017'>
                                                                  mu_old<a name='1018'>
<a name='1019'>
   REAL ,                                        INTENT(IN   ) :: rdx,     &amp;<a name='1020'>
                                                                  rdy,     &amp;<a name='1021'>
                                                                  khdif,   &amp;<a name='1022'>
                                                                  kvdif<a name='1023'>
<a name='1024'>
   INTEGER, INTENT( IN ) :: diff_6th_opt<a name='1025'>
   REAL,    INTENT( IN ) :: diff_6th_factor<a name='1026'>
<a name='1027'>
   REAL ,                                        INTENT(IN   ) :: dt<a name='1028'>
<a name='1029'>
   INTEGER, INTENT(IN   ) :: adv_opt          <a name='1030'>
<a name='1031'>
   <font color=#447700>! Local data<a name='1032'></font>
  <a name='1033'>
   INTEGER :: im, i,j,k<a name='1034'>
   INTEGER :: time_step<a name='1035'>
<a name='1036'>
   REAL    :: khdq, kvdq, tendency<a name='1037'>
<a name='1038'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1039'></font>
<font color=#447700>!<a name='1040'></font>
<font color=#447700>! rk_scalar_tend calls routines that computes scalar tendency from advection <a name='1041'></font>
<font color=#447700>! and 3D mixing (TKE or fixed eddy viscosities).<a name='1042'></font>
<font color=#447700>!<a name='1043'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1044'></font>
<a name='1045'>
<a name='1046'>
   khdq = khdif/prandtl<a name='1047'>
   kvdq = kvdif/prandtl<a name='1048'>
<a name='1049'>
   scalar_loop : DO im = scs, sce<a name='1050'>
<a name='1051'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_11"> ( advect_tend(ims,kms,jms),     &amp;<a name='1052'>
                      ids, ide, jds, jde, kds, kde, &amp;<a name='1053'>
                      ims, ime, jms, jme, kms, kme, &amp;<a name='1054'>
                      its, ite, jts, jte, kts, kte )<a name='1055'>
<a name='1056'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_12"> ( h_tendency(ims,kms,jms),      &amp;<a name='1057'>
                      ids, ide, jds, jde, kds, kde, &amp;<a name='1058'>
                      ims, ime, jms, jme, kms, kme, &amp;<a name='1059'>
                      its, ite, jts, jte, kts, kte )<a name='1060'>
<a name='1061'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_13"> ( z_tendency(ims,kms,jms),      &amp;<a name='1062'>
                      ids, ide, jds, jde, kds, kde, &amp;<a name='1063'>
                      ims, ime, jms, jme, kms, kme, &amp;<a name='1064'>
                      its, ite, jts, jte, kts, kte )<a name='1065'>
<a name='1066'>
     CALL nl_get_time_step ( 1, time_step )<a name='1067'>
<a name='1068'>
      IF( (rk_step == 3) .and. (adv_opt == POSITIVEDEF) ) THEN<a name='1069'>
<a name='1070'>
        CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_PD'>advect_scalar_pd</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_PD_2">       ( scalar(ims,kms,jms,im),             &amp;<a name='1071'>
                                      scalar_old(ims,kms,jms,im),         &amp;<a name='1072'>
                                      advect_tend(ims,kms,jms),           &amp;<a name='1073'>
                                      h_tendency(ims,kms,jms),            &amp; <a name='1074'>
                                      z_tendency(ims,kms,jms),            &amp; <a name='1075'>
                                      ru, rv, ww, c1h, c2h,               &amp;<a name='1076'>
                                      mut, mub, mu_old,                   &amp;<a name='1077'>
                                      time_step, config_flags, tenddec,   &amp; <a name='1078'>
                                      msfux, msfuy, msfvx, msfvy,         &amp;<a name='1079'>
                                      msftx, msfty, fnm, fnp,             &amp;<a name='1080'>
                                      rdx, rdy, rdnw,dt,                  &amp;<a name='1081'>
                                      ids, ide, jds, jde, kds, kde,       &amp;<a name='1082'>
                                      ims, ime, jms, jme, kms, kme,       &amp;<a name='1083'>
                                      its, ite, jts, jte, kts, kte     )<a name='1084'>
<a name='1085'>
      ELSE IF( (rk_step == 3) .and. (adv_opt == MONOTONIC) ) THEN<a name='1086'>
<a name='1087'>
        CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_MONO'>advect_scalar_mono</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_MONO_2">       ( scalar(ims,kms,jms,im),             &amp;<a name='1088'>
                                        scalar_old(ims,kms,jms,im),         &amp;<a name='1089'>
                                        advect_tend(ims,kms,jms),           &amp;<a name='1090'>
                                        h_tendency(ims,kms,jms),            &amp; <a name='1091'>
                                        z_tendency(ims,kms,jms),            &amp; <a name='1092'>
                                        ru, rv, ww, c1h, c2h,               &amp;<a name='1093'>
                                        mut, mub, mu_old,                   &amp;<a name='1094'>
                                        config_flags, tenddec,              &amp; <a name='1095'>
                                        msfux, msfuy, msfvx, msfvy,         &amp;<a name='1096'>
                                        msftx, msfty, fnm, fnp,             &amp;<a name='1097'>
                                        rdx, rdy, rdnw,dt,                  &amp;<a name='1098'>
                                        ids, ide, jds, jde, kds, kde,       &amp;<a name='1099'>
                                        ims, ime, jms, jme, kms, kme,       &amp;<a name='1100'>
                                        its, ite, jts, jte, kts, kte     )<a name='1101'>
<a name='1102'>
      ELSE IF( (rk_step == 3) .and. (adv_opt == WENO_SCALAR) ) THEN<a name='1103'>
<a name='1104'>
        CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_WENO'>advect_scalar_weno</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_WENO_3"> ( scalar(ims,kms,jms,im),        &amp;<a name='1105'>
                                 scalar(ims,kms,jms,im),        &amp;<a name='1106'>
                                 advect_tend(ims,kms,jms),      &amp;<a name='1107'>
                                 ru, rv, ww, c1h, c2h,          &amp;<a name='1108'>
                                 mut, time_step,                &amp;<a name='1109'>
                                 config_flags,                  &amp;<a name='1110'>
                                 msfux, msfuy, msfvx, msfvy,    &amp;<a name='1111'>
                                 msftx, msfty, fnm, fnp,        &amp;<a name='1112'>
                                 rdx, rdy, rdnw,                &amp;<a name='1113'>
                                 ids, ide, jds, jde, kds, kde,  &amp;<a name='1114'>
                                 ims, ime, jms, jme, kms, kme,  &amp;<a name='1115'>
                                 its, ite, jts, jte, kts, kte  )<a name='1116'>
<a name='1117'>
      ELSEIF( (rk_step == 3) .and. (adv_opt == WENOPD_SCALAR) ) THEN<a name='1118'>
<a name='1119'>
        CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR_WENOPD'>advect_scalar_wenopd</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_WENOPD_2">   ( scalar(ims,kms,jms,im),             &amp;<a name='1120'>
                                      scalar_old(ims,kms,jms,im),         &amp;<a name='1121'>
                                      advect_tend(ims,kms,jms),           &amp;<a name='1122'>
                                      ru, rv, ww, c1h, c2h,               &amp;<a name='1123'>
                                      mut, mub, mu_old,                   &amp;<a name='1124'>
                                      time_step, config_flags,            &amp;<a name='1125'>
                                      msfux, msfuy, msfvx, msfvy,         &amp;<a name='1126'>
                                      msftx, msfty, fnm, fnp,             &amp;<a name='1127'>
                                      rdx, rdy, rdnw,dt,                  &amp;<a name='1128'>
                                      ids, ide, jds, jde, kds, kde,       &amp;<a name='1129'>
                                      ims, ime, jms, jme, kms, kme,       &amp;<a name='1130'>
                                      its, ite, jts, jte, kts, kte     )<a name='1131'>
<a name='1132'>
      ELSE<a name='1133'>
<a name='1134'>
        CALL <A href='../../html_code/dyn_em/module_advect_em.F.html#ADVECT_SCALAR'>advect_scalar</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVECT_SCALAR_5">     ( scalar(ims,kms,jms,im),        &amp;<a name='1135'>
                                 scalar(ims,kms,jms,im),        &amp;<a name='1136'>
                                 advect_tend(ims,kms,jms),      &amp;<a name='1137'>
                                 ru, rv, ww, c1h, c2h,          &amp;<a name='1138'>
                                 mut, time_step,                &amp;<a name='1139'>
                                 config_flags,                  &amp;<a name='1140'>
                                 msfux, msfuy, msfvx, msfvy,    &amp;<a name='1141'>
                                 msftx, msfty, fnm, fnp,        &amp;<a name='1142'>
                                 rdx, rdy, rdnw,                &amp;<a name='1143'>
                                 ids, ide, jds, jde, kds, kde,  &amp;<a name='1144'>
                                 ims, ime, jms, jme, kms, kme,  &amp;<a name='1145'>
                                 its, ite, jts, jte, kts, kte  )<a name='1146'>
<a name='1147'>
      END IF<a name='1148'>
<a name='1149'>
     IF((config_flags%cu_physics == GDSCHEME .OR. config_flags%cu_physics == G3SCHEME .OR. &amp;<a name='1150'>
         config_flags%cu_physics == GFSCHEME .OR.    &amp; <a name='1151'>
         config_flags%cu_physics == KFETASCHEME .OR. config_flags%cu_physics == MSKFSCHEME .OR. &amp;<a name='1152'>
         config_flags%cu_physics == TIEDTKESCHEME .OR. config_flags%cu_physics == NTIEDTKESCHEME  ) &amp;      <font color=#447700>! Tiedtke<a name='1153'></font>
                     .and. moist_step .and. ( im == P_QV) ) THEN<a name='1154'>
<a name='1155'>
        CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SET_TEND'>set_tend</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TEND_2">( RQVFTEN, advect_tend, msfty,    &amp;<a name='1156'>
                       ids, ide, jds, jde, kds, kde,   &amp;<a name='1157'>
                       ims, ime, jms, jme, kms, kme,   &amp;<a name='1158'>
                       its, ite, jts, jte, kts, kte      )<a name='1159'>
     ENDIF<a name='1160'>
<a name='1161'>
     rk_step_1: IF( rk_step == 1 ) THEN<a name='1162'>
<a name='1163'>
       diff_opt1 : IF (config_flags%diff_opt .eq. 1) THEN<a name='1164'>
<a name='1165'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#HORIZONTAL_DIFFUSION'>horizontal_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HORIZONTAL_DIFFUSION_4"> ( 'm', scalar(ims,kms,jms,im),            &amp;<a name='1166'>
                                        scalar_tends(ims,kms,jms,im), mut, &amp;<a name='1167'>
                                        c1h, c2h, config_flags,            &amp;<a name='1168'>
                                        msfux, msfuy, msfvx, msfvx_inv,    &amp;<a name='1169'>
                                        msfvy, msftx, msfty,               &amp;<a name='1170'>
                                        khdq , xkmhd, rdx, rdy,            &amp;<a name='1171'>
                                        ids, ide, jds, jde, kds, kde,      &amp;<a name='1172'>
                                        ims, ime, jms, jme, kms, kme,      &amp;<a name='1173'>
                                        its, ite, jts, jte, kts, kte      )<a name='1174'>
<a name='1175'>
       pbl_test : IF (config_flags%bl_pbl_physics .eq. 0) THEN<a name='1176'>
<a name='1177'>
         IF( (moist_step) .and. ( im == P_QV)) THEN<a name='1178'>
<a name='1179'>
            CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION_MP'>vertical_diffusion_mp</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_MP_1"> ( scalar(ims,kms,jms,im),       &amp;<a name='1180'>
                                         scalar_tends(ims,kms,jms,im), &amp;<a name='1181'>
                                         config_flags, base, c1h, c2h, &amp;<a name='1182'>
                                         alt, mut, rdn, rdnw, kvdq ,   &amp;<a name='1183'>
                                         ids, ide, jds, jde, kds, kde, &amp;<a name='1184'>
                                         ims, ime, jms, jme, kms, kme, &amp;<a name='1185'>
                                         its, ite, jts, jte, kts, kte )<a name='1186'>
<a name='1187'>
         ELSE <a name='1188'>
<a name='1189'>
            CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#VERTICAL_DIFFUSION'>vertical_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="VERTICAL_DIFFUSION_2"> (  'm', scalar(ims,kms,jms,im),       &amp;<a name='1190'>
                                            scalar_tends(ims,kms,jms,im), &amp;<a name='1191'>
                                            config_flags, c1h, c2h,       &amp;<a name='1192'>
                                            alt, mut, rdn, rdnw, kvdq,    &amp;<a name='1193'>
                                            ids, ide, jds, jde, kds, kde, &amp;<a name='1194'>
                                            ims, ime, jms, jme, kms, kme, &amp;<a name='1195'>
                                            its, ite, jts, jte, kts, kte )<a name='1196'>
<a name='1197'>
         END IF<a name='1198'>
<a name='1199'>
      ENDIF pbl_test<a name='1200'>
<a name='1201'>
    ENDIF diff_opt1<a name='1202'>
<a name='1203'>
    IF ( diff_6th_opt .NE. 0 )                                        &amp;<a name='1204'>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#SIXTH_ORDER_DIFFUSION'>sixth_order_diffusion</A><A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SIXTH_ORDER_DIFFUSION_5">( 'm', scalar(ims,kms,jms,im),        &amp;<a name='1205'>
                                       scalar_tends(ims,kms,jms,im),  &amp;<a name='1206'>
                                       mut, dt, config_flags, c1h,c2h,&amp;<a name='1207'>
                                       diff_6th_opt, diff_6th_factor, &amp;<a name='1208'>
                                       ids, ide, jds, jde, kds, kde,  &amp;<a name='1209'>
                                       ims, ime, jms, jme, kms, kme,  &amp;<a name='1210'>
                                       its, ite, jts, jte, kts, kte )<a name='1211'>
<a name='1212'>
  ENDIF rk_step_1<a name='1213'>
<a name='1214'>
 END DO scalar_loop<a name='1215'>
<a name='1216'>
END SUBROUTINE rk_scalar_tend<a name='1217'>
<a name='1218'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1219'></font>
<a name='1220'>
<A NAME='Q_DIABATIC_ADD'><A href='../../html_code/dyn_em/module_em.F.html#Q_DIABATIC_ADD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1221'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>q_diabatic_add</font> ( scs, sce,                        &amp; <A href='../../call_to/Q_DIABATIC_ADD.html' TARGET='index'>1</A><a name='1222'>
                            dt, mut, c1, c2,                 &amp;<a name='1223'>
                            qv_diabatic, qc_diabatic,        &amp;<a name='1224'>
                            scalar_tends,                    &amp;<a name='1225'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='1226'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='1227'>
                            its, ite, jts, jte, kts, kte    )<a name='1228'>
<a name='1229'>
   IMPLICIT NONE<a name='1230'>
<a name='1231'>
   <font color=#447700>!  Input data.<a name='1232'></font>
<a name='1233'>
   INTEGER ,                INTENT(IN   ) :: scs, sce<a name='1234'>
   INTEGER ,                INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1235'>
                                             ims, ime, jms, jme, kms, kme, &amp;<a name='1236'>
                                             its, ite, jts, jte, kts, kte<a name='1237'>
<a name='1238'>
   REAL,     DIMENSION( ims:ime, jms:jme )                        , &amp;<a name='1239'>
             INTENT(IN   )   ::                                 mut<a name='1240'>
<a name='1241'>
   REAL , DIMENSION( kms:kme ) , INTENT(IN   ) :: c1, c2<a name='1242'>
<a name='1243'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme ),                &amp;<a name='1244'>
                                         INTENT(IN   )  :: qv_diabatic, qc_diabatic<a name='1245'>
<a name='1246'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce ),                &amp;<a name='1247'>
                                         INTENT(INOUT)  :: scalar_tends<a name='1248'>
<a name='1249'>
   REAL ,                                        INTENT(IN   ) :: dt<a name='1250'>
<a name='1251'>
   <font color=#447700>! Local data<a name='1252'></font>
  <a name='1253'>
   INTEGER :: im, i,j,k<a name='1254'>
<a name='1255'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1256'></font>
<font color=#447700>!<a name='1257'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1258'></font>
<a name='1259'>
<font color=#447700>!!!       print *,'  q_diab add: '<a name='1260'></font>
<font color=#447700>!!!       print *,its,MIN(ite,ide-1)<a name='1261'></font>
<font color=#447700>!!!       print *,jts,MIN(jte,jde-1)<a name='1262'></font>
<font color=#447700>!!!       print *,kts,kte-1<a name='1263'></font>
<a name='1264'>
   scalar_loop : DO im = scs, sce<a name='1265'>
<a name='1266'>
     IF( im.eq.p_qv )THEN<a name='1267'>
<font color=#447700>!!!       print *,'  qv '<a name='1268'></font>
       DO j = jts,MIN(jte,jde-1)<a name='1269'>
       DO k = kts,kte-1<a name='1270'>
       DO i = its,MIN(ite,ide-1)<a name='1271'>
         scalar_tends(i,k,j,im) = scalar_tends(i,k,j,im) + qv_diabatic(i,k,j)*mut(I,J)<a name='1272'>
       ENDDO<a name='1273'>
       ENDDO<a name='1274'>
       ENDDO<a name='1275'>
     ENDIF<a name='1276'>
     IF( im.eq.p_qc )THEN<a name='1277'>
<font color=#447700>!!!       print *,'  qc '<a name='1278'></font>
       DO j = jts,MIN(jte,jde-1)<a name='1279'>
       DO k = kts,kte-1<a name='1280'>
       DO i = its,MIN(ite,ide-1)<a name='1281'>
         scalar_tends(i,k,j,im) = scalar_tends(i,k,j,im) + qc_diabatic(i,k,j)*mut(I,J)<a name='1282'>
       ENDDO<a name='1283'>
       ENDDO<a name='1284'>
       ENDDO<a name='1285'>
     ENDIF<a name='1286'>
<a name='1287'>
   END DO scalar_loop<a name='1288'>
<a name='1289'>
END SUBROUTINE q_diabatic_add<a name='1290'>
<a name='1291'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1292'></font>
<a name='1293'>
<A NAME='Q_DIABATIC_SUBTR'><A href='../../html_code/dyn_em/module_em.F.html#Q_DIABATIC_SUBTR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1294'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>q_diabatic_subtr</font>( scs, sce,                       &amp; <A href='../../call_to/Q_DIABATIC_SUBTR.html' TARGET='index'>1</A><a name='1295'>
                            dt,                     &amp;<a name='1296'>
                            qv_diabatic, qc_diabatic,        &amp;<a name='1297'>
                            scalar,              &amp;<a name='1298'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='1299'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='1300'>
                            its, ite, jts, jte, kts, kte    )<a name='1301'>
<a name='1302'>
   IMPLICIT NONE<a name='1303'>
<a name='1304'>
   <font color=#447700>!  Input data.<a name='1305'></font>
<a name='1306'>
   INTEGER ,                INTENT(IN   ) :: scs, sce<a name='1307'>
   INTEGER ,                INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1308'>
                                             ims, ime, jms, jme, kms, kme, &amp;<a name='1309'>
                                             its, ite, jts, jte, kts, kte<a name='1310'>
<a name='1311'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme ),                &amp;<a name='1312'>
                                         INTENT(IN   )  :: qv_diabatic, qc_diabatic<a name='1313'>
<a name='1314'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce ),                &amp;<a name='1315'>
                                         INTENT(INOUT)  :: scalar<a name='1316'>
<a name='1317'>
   REAL ,                                        INTENT(IN   ) :: dt<a name='1318'>
<a name='1319'>
   <font color=#447700>! Local data<a name='1320'></font>
  <a name='1321'>
   INTEGER :: im, i,j,k<a name='1322'>
<a name='1323'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1324'></font>
<font color=#447700>!<a name='1325'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1326'></font>
<a name='1327'>
<a name='1328'>
<font color=#447700>!!!       print *,'  q_diab subtr, dt = : ',dt<a name='1329'></font>
<font color=#447700>!!!       print *,its,MIN(ite,ide-1)<a name='1330'></font>
<font color=#447700>!!!       print *,jts,MIN(jte,jde-1)<a name='1331'></font>
<font color=#447700>!!!       print *,kts,kte-1<a name='1332'></font>
<a name='1333'>
   scalar_loop : DO im = scs, sce<a name='1334'>
<a name='1335'>
     IF( im.eq.p_qv )THEN<a name='1336'>
<font color=#447700>!!!       print *,'  qv '<a name='1337'></font>
       DO j = jts,MIN(jte,jde-1)<a name='1338'>
       DO k = kts,kte-1<a name='1339'>
       DO i = its,MIN(ite,ide-1)<a name='1340'>
         scalar(i,k,j,im) = scalar(i,k,j,im) - dt*qv_diabatic(i,k,j)<a name='1341'>
       ENDDO<a name='1342'>
       ENDDO<a name='1343'>
       ENDDO<a name='1344'>
     ENDIF<a name='1345'>
     IF( im.eq.p_qc )THEN<a name='1346'>
<font color=#447700>!!!       print *,'  qc '<a name='1347'></font>
       DO j = jts,MIN(jte,jde-1)<a name='1348'>
       DO k = kts,kte-1<a name='1349'>
       DO i = its,MIN(ite,ide-1)<a name='1350'>
         scalar(i,k,j,im) = scalar(i,k,j,im) - dt*qc_diabatic(i,k,j)<a name='1351'>
       ENDDO<a name='1352'>
       ENDDO<a name='1353'>
       ENDDO<a name='1354'>
     ENDIF<a name='1355'>
<a name='1356'>
   END DO scalar_loop<a name='1357'>
<a name='1358'>
END SUBROUTINE q_diabatic_subtr<a name='1359'>
<a name='1360'>
<a name='1361'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1362'></font>
<a name='1363'>
<A NAME='RK_UPDATE_SCALAR'><A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1364'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>rk_update_scalar</font>( scs, sce,                      &amp; <A href='../../call_to/RK_UPDATE_SCALAR.html' TARGET='index'>5</A><a name='1365'>
                             scalar_1, scalar_2, sc_tend,   &amp;<a name='1366'>
                             advh_t, advz_t,                &amp; <a name='1367'>
                             advect_tend,                   &amp;<a name='1368'>
                             h_tendency, z_tendency,        &amp; <a name='1369'>
                             msftx, msfty, c1, c2,          &amp;<a name='1370'>
                             mu_old, mu_new, mu_base,       &amp;<a name='1371'>
                             rk_step, dt, spec_zone,        &amp;<a name='1372'>
                             config_flags,                  &amp;<a name='1373'>
                             tenddec,                      &amp; <a name='1374'>
                             ids, ide, jds, jde, kds, kde,  &amp;<a name='1375'>
                             ims, ime, jms, jme, kms, kme,  &amp;<a name='1376'>
                             its, ite, jts, jte, kts, kte  )<a name='1377'>
<a name='1378'>
   IMPLICIT NONE<a name='1379'>
<a name='1380'>
   <font color=#447700>!  Input data.<a name='1381'></font>
<a name='1382'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='1383'>
<a name='1384'>
   LOGICAL ,                INTENT(IN   ) :: tenddec <a name='1385'>
<a name='1386'>
   INTEGER ,                INTENT(IN   ) :: scs, sce, rk_step, spec_zone<a name='1387'>
   INTEGER ,                INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1388'>
                                             ims, ime, jms, jme, kms, kme, &amp;<a name='1389'>
                                             its, ite, jts, jte, kts, kte<a name='1390'>
<a name='1391'>
   REAL,                    INTENT(IN   ) :: dt<a name='1392'>
<a name='1393'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce),                &amp;<a name='1394'>
         INTENT(INOUT)                                  :: scalar_1,    &amp;<a name='1395'>
                                                           scalar_2<a name='1396'>
<a name='1397'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce),                &amp;<a name='1398'>
         INTENT(IN)                                     :: sc_tend<a name='1399'>
<a name='1400'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme ),                &amp;<a name='1401'>
         INTENT(IN)                                  :: advect_tend<a name='1402'>
<a name='1403'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme ), INTENT(INOUT) , OPTIONAL :: advh_t,  advz_t <font color=#447700>! accumulating for output<a name='1404'></font>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme ), INTENT(IN   ) :: h_tendency, z_tendency <font color=#447700>! from rk_scalar_tend<a name='1405'></font>
<a name='1406'>
   REAL, DIMENSION(ims:ime, jms:jme  ), INTENT(IN   ) ::  mu_old,  &amp;<a name='1407'>
                                                          mu_new,  &amp;<a name='1408'>
                                                          mu_base, &amp;<a name='1409'>
                                                          msftx,   &amp;<a name='1410'>
                                                          msfty<a name='1411'>
<a name='1412'>
   REAL, DIMENSION(kms:kme ), INTENT(IN   ) ::  c1, c2<a name='1413'>
<a name='1414'>
   INTEGER :: i,j,k,im<a name='1415'>
   REAL    :: sc_middle, msfsq<a name='1416'>
   REAL, DIMENSION(its:ite) :: muold, munew<a name='1417'>
<a name='1418'>
   REAL, DIMENSION(its:ite, kts:kte, jts:jte  ) :: tendency<a name='1419'>
<a name='1420'>
   INTEGER :: i_start,i_end,j_start,j_end,k_start,k_end<a name='1421'>
   INTEGER :: i_start_spc,i_end_spc,j_start_spc,j_end_spc,k_start_spc,k_end_spc<a name='1422'>
<a name='1423'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1424'></font>
<font color=#447700>!<a name='1425'></font>
<font color=#447700>!  rk_scalar_update advances the scalar equation given the time t value<a name='1426'></font>
<font color=#447700>!  of the scalar and the scalar tendency.  <a name='1427'></font>
<font color=#447700>!<a name='1428'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1429'></font>
<a name='1430'>
<a name='1431'>
<font color=#447700>!<a name='1432'></font>
<font color=#447700>!  set loop limits.<a name='1433'></font>
<a name='1434'>
      i_start = its<a name='1435'>
      i_end   = min(ite,ide-1)<a name='1436'>
      j_start = jts<a name='1437'>
      j_end   = min(jte,jde-1)<a name='1438'>
      k_start = kts<a name='1439'>
      k_end   = kte-1<a name='1440'>
<a name='1441'>
      i_start_spc = i_start<a name='1442'>
      i_end_spc   = i_end<a name='1443'>
      j_start_spc = j_start<a name='1444'>
      j_end_spc   = j_end<a name='1445'>
      k_start_spc = k_start<a name='1446'>
      k_end_spc   = k_end<a name='1447'>
<a name='1448'>
    IF( config_flags%nested .or. config_flags%specified ) THEN<a name='1449'>
      IF( .NOT. config_flags%periodic_x)i_start = max( its,ids+spec_zone )<a name='1450'>
      IF( .NOT. config_flags%periodic_x)i_end   = min( ite,ide-spec_zone-1 )<a name='1451'>
      j_start = max( jts,jds+spec_zone )<a name='1452'>
      j_end   = min( jte,jde-spec_zone-1 )<a name='1453'>
      k_start = kts<a name='1454'>
      k_end   = min( kte, kde-1 )<a name='1455'>
    ENDIF<a name='1456'>
<a name='1457'>
    IF ( rk_step == 1 ) THEN<a name='1458'>
<a name='1459'>
      <font color=#447700>!  replace t-dt values (in scalar_1) with t values scalar_2,<a name='1460'></font>
      <font color=#447700>!  then compute new values by adding tendency to values at t<a name='1461'></font>
<a name='1462'>
      DO  im = scs,sce<a name='1463'>
<a name='1464'>
       DO  j = jts, min(jte,jde-1)<a name='1465'>
       DO  k = kts, min(kte,kde-1)<a name='1466'>
       DO  i = its, min(ite,ide-1)<a name='1467'>
           tendency(i,k,j) = 0.<a name='1468'>
       ENDDO<a name='1469'>
       ENDDO<a name='1470'>
       ENDDO<a name='1471'>
   <a name='1472'>
       DO  j = j_start,j_end<a name='1473'>
       DO  k = k_start,k_end<a name='1474'>
       DO  i = i_start,i_end<a name='1475'>
          <font color=#447700>! scalar was coupled with my<a name='1476'></font>
           tendency(i,k,j) = advect_tend(i,k,j) * msfty(i,j)<a name='1477'>
       ENDDO<a name='1478'>
       ENDDO<a name='1479'>
       ENDDO<a name='1480'>
   <a name='1481'>
       DO  j = j_start_spc,j_end_spc<a name='1482'>
       DO  k = k_start_spc,k_end_spc<a name='1483'>
       DO  i = i_start_spc,i_end_spc<a name='1484'>
           tendency(i,k,j) = tendency(i,k,j) + sc_tend(i,k,j,im)<a name='1485'>
       ENDDO<a name='1486'>
       ENDDO<a name='1487'>
       ENDDO<a name='1488'>
   <a name='1489'>
      DO  j = jts, min(jte,jde-1)<a name='1490'>
<a name='1491'>
      DO  i = its, min(ite,ide-1)<a name='1492'>
        MUOLD(i) = MU_OLD(i,j) + MU_BASE(i,j)<a name='1493'>
        MUNEW(i) = MU_NEW(i,j) + MU_BASE(i,j)<a name='1494'>
      ENDDO<a name='1495'>
<a name='1496'>
      DO  k = kts, min(kte,kde-1)<a name='1497'>
      DO  i = its, min(ite,ide-1)<a name='1498'>
<a name='1499'>
        scalar_1(i,k,j,im) = scalar_2(i,k,j,im)<a name='1500'>
        scalar_2(i,k,j,im) = (muold(i)*scalar_1(i,k,j,im)   &amp;<a name='1501'>
                             + dt*tendency(i,k,j))/munew(i)<a name='1502'>
<a name='1503'>
      ENDDO<a name='1504'>
      ENDDO<a name='1505'>
      ENDDO<a name='1506'>
<a name='1507'>
      ENDDO<a name='1508'>
<a name='1509'>
    ELSE<a name='1510'>
<a name='1511'>
      <font color=#447700>!  just compute new values, scalar_1 already at time t.<a name='1512'></font>
<a name='1513'>
      DO  im = scs, sce<a name='1514'>
<a name='1515'>
       DO  j = jts, min(jte,jde-1)<a name='1516'>
       DO  k = kts, min(kte,kde-1)<a name='1517'>
       DO  i = its, min(ite,ide-1)<a name='1518'>
           tendency(i,k,j) = 0.<a name='1519'>
       ENDDO<a name='1520'>
       ENDDO<a name='1521'>
       ENDDO<a name='1522'>
   <a name='1523'>
       DO  j = j_start,j_end<a name='1524'>
       DO  k = k_start,k_end<a name='1525'>
       DO  i = i_start,i_end<a name='1526'>
           <font color=#447700>! scalar was coupled with my<a name='1527'></font>
           tendency(i,k,j) = advect_tend(i,k,j) * msfty(i,j)<a name='1528'>
       ENDDO<a name='1529'>
       ENDDO<a name='1530'>
       ENDDO<a name='1531'>
   <a name='1532'>
       DO  j = j_start_spc,j_end_spc<a name='1533'>
       DO  k = k_start_spc,k_end_spc<a name='1534'>
       DO  i = i_start_spc,i_end_spc<a name='1535'>
           tendency(i,k,j) = tendency(i,k,j) + sc_tend(i,k,j,im)<a name='1536'>
       ENDDO<a name='1537'>
       ENDDO<a name='1538'>
       ENDDO<a name='1539'>
<a name='1540'>
      DO  j = jts, min(jte,jde-1)<a name='1541'>
<a name='1542'>
      DO  i = its, min(ite,ide-1)<a name='1543'>
        MUOLD(i) = MU_OLD(i,j) + MU_BASE(i,j)<a name='1544'>
        MUNEW(i) = MU_NEW(i,j) + MU_BASE(i,j)<a name='1545'>
      ENDDO<a name='1546'>
<a name='1547'>
      DO  k = kts, min(kte,kde-1)<a name='1548'>
      DO  i = its, min(ite,ide-1)<a name='1549'>
<a name='1550'>
        scalar_2(i,k,j,im) = (muold(i)*scalar_1(i,k,j,im)   &amp;<a name='1551'>
                             + dt*tendency(i,k,j))/munew(i)<a name='1552'>
<a name='1553'>
      ENDDO<a name='1554'>
      ENDDO<a name='1555'>
<a name='1556'>
      <font color=#447700>! This is separated from the k/i-loop above for better performance<a name='1557'></font>
      IF ( PRESENT(advh_t) .AND. PRESENT(advz_t) ) THEN<a name='1558'>
        IF(tenddec.and.rk_step.eq.config_flags%rk_ord) THEN<a name='1559'>
          DO  k = kts, min(kte,kde-1)<a name='1560'>
          DO  i = its, min(ite,ide-1)<a name='1561'>
<a name='1562'>
            advh_t(i,k,j) = advh_t(i,k,j) + (dt*h_tendency(i,k,j)* msfty(i,j))/munew(i)<a name='1563'>
            advz_t(i,k,j) = advz_t(i,k,j) + (dt*z_tendency(i,k,j)* msfty(i,j))/munew(i)<a name='1564'>
<a name='1565'>
          ENDDO<a name='1566'>
          ENDDO<a name='1567'>
        END IF<a name='1568'>
      END IF<a name='1569'>
      <a name='1570'>
      ENDDO<a name='1571'>
<a name='1572'>
      ENDDO<a name='1573'>
<a name='1574'>
    END IF<a name='1575'>
<a name='1576'>
END SUBROUTINE rk_update_scalar<a name='1577'>
<a name='1578'>
<font color=#447700>!-------------------------------------------------------------------------------<a name='1579'></font>
<a name='1580'>
<A NAME='RK_UPDATE_SCALAR_PD'><A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR_PD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1581'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>rk_update_scalar_pd</font>( scs, sce,                      &amp; <A href='../../call_to/RK_UPDATE_SCALAR_PD.html' TARGET='index'>5</A><a name='1582'>
                                scalar, sc_tend,               &amp;<a name='1583'>
                                c1, c2,                        &amp;<a name='1584'>
                                mu_old, mu_new, mu_base,       &amp;<a name='1585'>
                                rk_step, dt, spec_zone,        &amp;<a name='1586'>
                                config_flags,                  &amp;<a name='1587'>
                                ids, ide, jds, jde, kds, kde,  &amp;<a name='1588'>
                                ims, ime, jms, jme, kms, kme,  &amp;<a name='1589'>
                                its, ite, jts, jte, kts, kte  )<a name='1590'>
<a name='1591'>
   IMPLICIT NONE<a name='1592'>
<a name='1593'>
   <font color=#447700>!  Input data.<a name='1594'></font>
<a name='1595'>
   TYPE(grid_config_rec_type   ) ,   INTENT(IN   ) :: config_flags<a name='1596'>
<a name='1597'>
   INTEGER ,                INTENT(IN   ) :: scs, sce, rk_step, spec_zone<a name='1598'>
   INTEGER ,                INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1599'>
                                             ims, ime, jms, jme, kms, kme, &amp;<a name='1600'>
                                             its, ite, jts, jte, kts, kte<a name='1601'>
<a name='1602'>
   REAL,                    INTENT(IN   ) :: dt<a name='1603'>
<a name='1604'>
   REAL, DIMENSION(ims:ime, kms:kme, jms:jme , scs:sce),                &amp;<a name='1605'>
         INTENT(INOUT)                                  :: scalar,      &amp;<a name='1606'>
                                                           sc_tend<a name='1607'>
<a name='1608'>
   REAL, DIMENSION(ims:ime, jms:jme  ), INTENT(IN   ) ::  mu_old,  &amp;<a name='1609'>
                                                          mu_new,  &amp;<a name='1610'>
                                                          mu_base<a name='1611'>
<a name='1612'>
   REAL, DIMENSION(kms:kme ), INTENT(IN   ) ::  c1, c2<a name='1613'>
<a name='1614'>
   INTEGER :: i,j,k,im<a name='1615'>
   REAL    :: sc_middle, msfsq<a name='1616'>
   REAL, DIMENSION(its:ite) :: muold, munew<a name='1617'>
<a name='1618'>
   REAL, DIMENSION(its:ite, kts:kte, jts:jte  ) :: tendency<a name='1619'>
<a name='1620'>
   INTEGER :: i_start,i_end,j_start,j_end,k_start,k_end<a name='1621'>
   INTEGER :: i_start_spc,i_end_spc,j_start_spc,j_end_spc,k_start_spc,k_end_spc<a name='1622'>
<a name='1623'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1624'></font>
<font color=#447700>!<a name='1625'></font>
<font color=#447700>!  rk_scalar_update advances the scalar equation given the time t value<a name='1626'></font>
<font color=#447700>!  of the scalar and the scalar tendency.  <a name='1627'></font>
<font color=#447700>!<a name='1628'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1629'></font>
<a name='1630'>
<a name='1631'>
<font color=#447700>!<a name='1632'></font>
<font color=#447700>!  set loop limits.<a name='1633'></font>
<a name='1634'>
      i_start = its<a name='1635'>
      i_end   = min(ite,ide-1)<a name='1636'>
      j_start = jts<a name='1637'>
      j_end   = min(jte,jde-1)<a name='1638'>
      k_start = kts<a name='1639'>
      k_end   = kte-1<a name='1640'>
<a name='1641'>
      i_start_spc = i_start<a name='1642'>
      i_end_spc   = i_end<a name='1643'>
      j_start_spc = j_start<a name='1644'>
      j_end_spc   = j_end<a name='1645'>
      k_start_spc = k_start<a name='1646'>
      k_end_spc   = k_end<a name='1647'>
<a name='1648'>
    IF( config_flags%nested .or. config_flags%specified ) THEN<a name='1649'>
      IF( .NOT. config_flags%periodic_x)i_start = max( its,ids+spec_zone )<a name='1650'>
      IF( .NOT. config_flags%periodic_x)i_end   = min( ite,ide-spec_zone-1 )<a name='1651'>
      j_start = max( jts,jds+spec_zone )<a name='1652'>
      j_end   = min( jte,jde-spec_zone-1 )<a name='1653'>
      k_start = kts<a name='1654'>
      k_end   = min( kte, kde-1 )<a name='1655'>
    ENDIF<a name='1656'>
<a name='1657'>
      DO  im = scs, sce<a name='1658'>
<a name='1659'>
       DO  j = jts, min(jte,jde-1)<a name='1660'>
       DO  k = kts, min(kte,kde-1)<a name='1661'>
       DO  i = its, min(ite,ide-1)<a name='1662'>
           tendency(i,k,j) = 0.<a name='1663'>
       ENDDO<a name='1664'>
       ENDDO<a name='1665'>
       ENDDO<a name='1666'>
   <a name='1667'>
       DO  j = j_start_spc,j_end_spc<a name='1668'>
       DO  k = k_start_spc,k_end_spc<a name='1669'>
       DO  i = i_start_spc,i_end_spc<a name='1670'>
           tendency(i,k,j) = tendency(i,k,j) + sc_tend(i,k,j,im)<a name='1671'>
           sc_tend(i,k,j,im) = 0.<a name='1672'>
       ENDDO<a name='1673'>
       ENDDO<a name='1674'>
       ENDDO<a name='1675'>
<a name='1676'>
      DO  j = jts, min(jte,jde-1)<a name='1677'>
<a name='1678'>
      DO  i = its, min(ite,ide-1)<a name='1679'>
        MUOLD(i) = MU_OLD(i,j) + MU_BASE(i,j)<a name='1680'>
        MUNEW(i) = MU_NEW(i,j) + MU_BASE(i,j)<a name='1681'>
      ENDDO<a name='1682'>
<a name='1683'>
      DO  k = kts, min(kte,kde-1)<a name='1684'>
      DO  i = its, min(ite,ide-1)<a name='1685'>
<a name='1686'>
        scalar(i,k,j,im) = (muold(i)*scalar(i,k,j,im)   &amp;<a name='1687'>
                             + dt*tendency(i,k,j))/munew(i)<a name='1688'>
      ENDDO<a name='1689'>
      ENDDO<a name='1690'>
      ENDDO<a name='1691'>
<a name='1692'>
      ENDDO<a name='1693'>
<a name='1694'>
END SUBROUTINE rk_update_scalar_pd<a name='1695'>
<a name='1696'>
<font color=#447700>!------------------------------------------------------------<a name='1697'></font>
<a name='1698'>
<A NAME='INIT_ZERO_TENDENCY'><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1699'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>init_zero_tendency</font>(ru_tendf, rv_tendf, rw_tendf, ph_tendf,  &amp; <A href='../../call_to/INIT_ZERO_TENDENCY.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_ZERO_TENDENCY.html' TARGET='index'>11</A><a name='1700'>
                              t_tendf,  tke_tendf, mu_tendf,           &amp;<a name='1701'>
                              moist_tendf,chem_tendf,scalar_tendf,     &amp;<a name='1702'>
                              tracer_tendf,n_tracer,                   &amp;<a name='1703'>
                              n_moist,n_chem,n_scalar,rk_step,         &amp;<a name='1704'>
                              ids, ide, jds, jde, kds, kde,            &amp;<a name='1705'>
                              ims, ime, jms, jme, kms, kme,            &amp;<a name='1706'>
                              its, ite, jts, jte, kts, kte             )<a name='1707'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1708'></font>
   IMPLICIT NONE<a name='1709'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1710'></font>
<a name='1711'>
   INTEGER ,       INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='1712'>
                                    ims, ime, jms, jme, kms, kme, &amp;<a name='1713'>
                                    its, ite, jts, jte, kts, kte<a name='1714'>
<a name='1715'>
   INTEGER ,       INTENT(IN   ) :: n_moist,n_chem,n_scalar,n_tracer,rk_step<a name='1716'>
<a name='1717'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) , INTENT(INOUT) ::  &amp;<a name='1718'>
                                                             ru_tendf, &amp;<a name='1719'>
                                                             rv_tendf, &amp;<a name='1720'>
                                                             rw_tendf, &amp;<a name='1721'>
                                                             ph_tendf, &amp;<a name='1722'>
                                                              t_tendf, &amp;<a name='1723'>
                                                            tke_tendf<a name='1724'>
<a name='1725'>
   REAL , DIMENSION( ims:ime , jms:jme  ) , INTENT(INOUT) ::  mu_tendf<a name='1726'>
<a name='1727'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_moist),INTENT(INOUT)::&amp;<a name='1728'>
                                                          moist_tendf<a name='1729'>
<a name='1730'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_chem ),INTENT(INOUT)::&amp;<a name='1731'>
                                                          chem_tendf<a name='1732'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_tracer ),INTENT(INOUT)::&amp;<a name='1733'>
                                                          tracer_tendf<a name='1734'>
<a name='1735'>
   REAL , DIMENSION(ims:ime, kms:kme, jms:jme, n_scalar ),INTENT(INOUT)::&amp;<a name='1736'>
                                                          scalar_tendf<a name='1737'>
<a name='1738'>
<font color=#447700>! LOCAL VARS<a name='1739'></font>
<a name='1740'>
   INTEGER :: im, ic, is<a name='1741'>
<a name='1742'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1743'></font>
<font color=#447700>!<a name='1744'></font>
<font color=#447700>! init_zero_tendency <a name='1745'></font>
<font color=#447700>! sets tendency arrays to zero for all prognostic variables.<a name='1746'></font>
<font color=#447700>!<a name='1747'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1748'></font>
<a name='1749'>
<a name='1750'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_14"> ( ru_tendf,                        &amp;<a name='1751'>
                    ids, ide, jds, jde, kds, kde,    &amp;<a name='1752'>
                    ims, ime, jms, jme, kms, kme,    &amp;<a name='1753'>
                    its, ite, jts, jte, kts, kte     )<a name='1754'>
<a name='1755'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_15"> ( rv_tendf,                        &amp;<a name='1756'>
                    ids, ide, jds, jde, kds, kde,    &amp;<a name='1757'>
                    ims, ime, jms, jme, kms, kme,    &amp;<a name='1758'>
                    its, ite, jts, jte, kts, kte     )<a name='1759'>
<a name='1760'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_16"> ( rw_tendf,                        &amp;<a name='1761'>
                    ids, ide, jds, jde, kds, kde,    &amp;<a name='1762'>
                    ims, ime, jms, jme, kms, kme,    &amp;<a name='1763'>
                    its, ite, jts, jte, kts, kte     )<a name='1764'>
<a name='1765'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_17"> ( ph_tendf,                        &amp;<a name='1766'>
                    ids, ide, jds, jde, kds, kde,    &amp;<a name='1767'>
                    ims, ime, jms, jme, kms, kme,    &amp;<a name='1768'>
                    its, ite, jts, jte, kts, kte     )<a name='1769'>
<a name='1770'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_18"> ( t_tendf,                         &amp;<a name='1771'>
                    ids, ide, jds, jde, kds, kde,    &amp;<a name='1772'>
                    ims, ime, jms, jme, kms, kme,    &amp;<a name='1773'>
                    its, ite, jts, jte, kts, kte     )<a name='1774'>
<a name='1775'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_19"> ( tke_tendf,                       &amp;<a name='1776'>
                    ids, ide, jds, jde, kds, kde,    &amp;<a name='1777'>
                    ims, ime, jms, jme, kms, kme,    &amp;<a name='1778'>
                    its, ite, jts, jte, kts, kte     )<a name='1779'>
<a name='1780'>
   CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND2D'>zero_tend2d</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND2D_3">( mu_tendf,                        &amp;<a name='1781'>
                    ids, ide, jds, jde, kds, kds,    &amp;<a name='1782'>
                    ims, ime, jms, jme, kms, kms,    &amp;<a name='1783'>
                    its, ite, jts, jte, kts, kts     )<a name='1784'>
<a name='1785'>
<font color=#447700>!   DO im=PARAM_FIRST_SCALAR,n_moist<a name='1786'></font>
   DO im=1,n_moist                      <font color=#447700>! make sure first one is zero too<a name='1787'></font>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_20"> ( moist_tendf(ims,kms,jms,im),  &amp;<a name='1788'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='1789'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='1790'>
                       its, ite, jts, jte, kts, kte  )<a name='1791'>
   ENDDO<a name='1792'>
<a name='1793'>
<font color=#447700>!   DO ic=PARAM_FIRST_SCALAR,n_chem<a name='1794'></font>
   DO ic=1,n_chem                       <font color=#447700>! make sure first one is zero too<a name='1795'></font>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_21"> ( chem_tendf(ims,kms,jms,ic),   &amp;<a name='1796'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='1797'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='1798'>
                       its, ite, jts, jte, kts, kte  )<a name='1799'>
   ENDDO<a name='1800'>
<a name='1801'>
<font color=#447700>!   DO ic=PARAM_FIRST_SCALAR,n_tracer<a name='1802'></font>
   DO ic=1,n_tracer                     <font color=#447700>! make sure first one is zero too<a name='1803'></font>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_22"> ( tracer_tendf(ims,kms,jms,ic), &amp;<a name='1804'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='1805'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='1806'>
                       its, ite, jts, jte, kts, kte  )<a name='1807'>
   ENDDO<a name='1808'>
<a name='1809'>
<font color=#447700>!   DO ic=PARAM_FIRST_SCALAR,n_scalar<a name='1810'></font>
   DO ic=1,n_scalar                       <font color=#447700>! make sure first one is zero too<a name='1811'></font>
      CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_TEND'>zero_tend</A><A href='../../html_code/dyn_em/module_em.F.html#INIT_ZERO_TENDENCY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_TEND_23"> ( scalar_tendf(ims,kms,jms,ic),   &amp;<a name='1812'>
                       ids, ide, jds, jde, kds, kde, &amp;<a name='1813'>
                       ims, ime, jms, jme, kms, kme, &amp;<a name='1814'>
                       its, ite, jts, jte, kts, kte  )<a name='1815'>
   ENDDO<a name='1816'>
<a name='1817'>
END SUBROUTINE init_zero_tendency<a name='1818'>
<a name='1819'>
<font color=#447700>!===================================================================<a name='1820'></font>
<a name='1821'>
<a name='1822'>
<A NAME='DUMP_DATA'><A href='../../html_code/dyn_em/module_em.F.html#DUMP_DATA' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1823'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>dump_data</font>( a, field, io_unit,            &amp;<a name='1824'>
                      ims, ime, jms, jme, kms, kme, &amp;<a name='1825'>
                      ids, ide, jds, jde, kds, kde )<a name='1826'>
implicit none<a name='1827'>
integer ::  ims, ime, jms, jme, kms, kme, &amp;<a name='1828'>
            ids, ide, jds, jde, kds, kde <a name='1829'>
real, dimension(ims:ime, kms:kme, jds:jde) :: a<a name='1830'>
character :: field<a name='1831'>
integer :: io_unit<a name='1832'>
<a name='1833'>
integer :: is,ie,js,je,ks,ke<a name='1834'>
<a name='1835'>
<font color=#447700>!&lt;DESCRIPTION<a name='1836'></font>
<font color=#447700>!<a name='1837'></font>
<font color=#447700>! quick and dirty debug io utility<a name='1838'></font>
<font color=#447700>!<a name='1839'></font>
<font color=#447700>!&lt;/DESCRIPTION<a name='1840'></font>
<a name='1841'>
is = ids<a name='1842'>
ie = ide-1<a name='1843'>
js = jds<a name='1844'>
je = jde-1<a name='1845'>
ks = kds<a name='1846'>
ke = kde-1<a name='1847'>
<a name='1848'>
if(field == 'u') ie = ide<a name='1849'>
if(field == 'v') je = jde<a name='1850'>
if(field == 'w') ke = kde<a name='1851'>
<a name='1852'>
write(io_unit) is,ie,ks,ke,js,je<a name='1853'>
write(io_unit) a(is:ie, ks:ke, js:je)<a name='1854'>
<a name='1855'>
end subroutine dump_data<a name='1856'>
<a name='1857'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1858'></font>
<a name='1859'>
<A NAME='CALCULATE_PHY_TEND'><A href='../../html_code/dyn_em/module_em.F.html#CALCULATE_PHY_TEND' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1860'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>calculate_phy_tend</font> (config_flags,c1,c2,                     &amp; <A href='../../call_to/CALCULATE_PHY_TEND.html' TARGET='index'>1</A><a name='1861'>
                     mut,muu,muv,pi3d,                                 &amp;<a name='1862'>
                     RTHRATEN,                                         &amp;<a name='1863'>
                     RUBLTEN,RVBLTEN,RTHBLTEN,                         &amp;<a name='1864'>
                     RQVBLTEN,RQCBLTEN,RQIBLTEN,                       &amp;<a name='1865'>
                     RUCUTEN,RVCUTEN,RTHCUTEN,                         &amp;<a name='1866'>
                     RQVCUTEN,RQCCUTEN,RQRCUTEN,                       &amp;<a name='1867'>
                     RQICUTEN,RQSCUTEN,                                &amp;<a name='1868'>
                     RUSHTEN,RVSHTEN,RTHSHTEN,                         &amp;<a name='1869'>
                     RQVSHTEN,RQCSHTEN,RQRSHTEN,                       &amp;<a name='1870'>
                     RQISHTEN,RQSSHTEN,RQGSHTEN,                       &amp;<a name='1871'>
                     RUNDGDTEN,RVNDGDTEN,RTHNDGDTEN,RQVNDGDTEN,        &amp;<a name='1872'>
                     RMUNDGDTEN,                                       &amp;<a name='1873'>
                     scalar, scalar_tend, num_scalar,                  &amp;<a name='1874'>
                     tracer, tracer_tend, num_tracer,                  &amp;<a name='1875'>
                     ids,ide, jds,jde, kds,kde,                        &amp;<a name='1876'>
                     ims,ime, jms,jme, kms,kme,                        &amp;<a name='1877'>
                     its,ite, jts,jte, kts,kte                         )<a name='1878'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1879'></font>
      IMPLICIT NONE<a name='1880'>
<a name='1881'>
      TYPE(grid_config_rec_type), INTENT(IN)     ::      config_flags<a name='1882'>
<a name='1883'>
      INTEGER,  INTENT(IN   )   ::          num_scalar, num_tracer<a name='1884'>
      INTEGER,  INTENT(IN   )   ::          ids,ide, jds,jde, kds,kde, &amp;<a name='1885'>
                                            ims,ime, jms,jme, kms,kme, &amp;<a name='1886'>
                                            its,ite, jts,jte, kts,kte<a name='1887'>
<a name='1888'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )               , &amp;<a name='1889'>
                INTENT(IN   )   ::                               pi3d<a name='1890'>
<a name='1891'>
      REAL,     DIMENSION( kms:kme )                                 , &amp;<a name='1892'>
                INTENT(IN   )   ::                               c1, c2<a name='1893'>
                                                                 <a name='1894'>
      REAL,     DIMENSION( ims:ime, jms:jme )                        , &amp;<a name='1895'>
                INTENT(IN   )   ::                                mut, &amp;<a name='1896'>
                                                                  muu, &amp;<a name='1897'>
                                                                  muv<a name='1898'>
      <a name='1899'>
                                                           <a name='1900'>
<font color=#447700>! radiation<a name='1901'></font>
<a name='1902'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme ),                &amp;<a name='1903'>
                INTENT(INOUT)   ::                           RTHRATEN<a name='1904'>
<a name='1905'>
<font color=#447700>! cumulus<a name='1906'></font>
<a name='1907'>
      REAL,     DIMENSION( ims:ime , kms:kme , jms:jme ),              &amp;<a name='1908'>
                INTENT(INOUT)   ::                                     &amp;<a name='1909'>
                                                              RUCUTEN, &amp;<a name='1910'>
                                                              RVCUTEN, &amp;<a name='1911'>
                                                             RTHCUTEN, &amp;<a name='1912'>
                                                             RQVCUTEN, &amp;<a name='1913'>
                                                             RQCCUTEN, &amp;<a name='1914'>
                                                             RQRCUTEN, &amp;<a name='1915'>
                                                             RQICUTEN, &amp;<a name='1916'>
                                                             RQSCUTEN, &amp;<a name='1917'>
                                                              RUSHTEN, &amp;<a name='1918'>
                                                              RVSHTEN, &amp;<a name='1919'>
                                                             RTHSHTEN, &amp;<a name='1920'>
                                                             RQVSHTEN, &amp;<a name='1921'>
                                                             RQCSHTEN, &amp;<a name='1922'>
                                                             RQRSHTEN, &amp;<a name='1923'>
                                                             RQISHTEN, &amp;<a name='1924'>
                                                             RQSSHTEN, &amp;<a name='1925'>
                                                             RQGSHTEN<a name='1926'>
<a name='1927'>
<font color=#447700>! pbl<a name='1928'></font>
<a name='1929'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )               , &amp;<a name='1930'>
                INTENT(INOUT)   ::                            RUBLTEN, &amp;<a name='1931'>
                                                              RVBLTEN, &amp;<a name='1932'>
                                                             RTHBLTEN, &amp;<a name='1933'>
                                                             RQVBLTEN, &amp;<a name='1934'>
                                                             RQCBLTEN, &amp;<a name='1935'>
                                                             RQIBLTEN<a name='1936'>
<a name='1937'>
<font color=#447700>! fdda<a name='1938'></font>
<a name='1939'>
      REAL,     DIMENSION( ims:ime, kms:kme, jms:jme )               , &amp;<a name='1940'>
                INTENT(INOUT)   ::                            RUNDGDTEN, &amp;<a name='1941'>
                                                              RVNDGDTEN, &amp;<a name='1942'>
                                                             RTHNDGDTEN, &amp;<a name='1943'>
                                                             RQVNDGDTEN<a name='1944'>
      REAL,     DIMENSION( ims:ime, jms:jme )               , &amp;<a name='1945'>
                INTENT(INOUT)   ::                           RMUNDGDTEN<a name='1946'>
<a name='1947'>
<font color=#447700>! 4d arrays<a name='1948'></font>
<a name='1949'>
    REAL    ,DIMENSION(ims:ime,kms:kme,jms:jme,num_tracer),INTENT(INOUT)   :: tracer<a name='1950'>
    REAL    ,DIMENSION(ims:ime,kms:kme,jms:jme,num_tracer),INTENT(INOUT)   :: tracer_tend<a name='1951'>
    REAL    ,DIMENSION(ims:ime,kms:kme,jms:jme,num_scalar),INTENT(INOUT)   :: scalar<a name='1952'>
    REAL    ,DIMENSION(ims:ime,kms:kme,jms:jme,num_scalar),INTENT(INOUT)   :: scalar_tend<a name='1953'>
<a name='1954'>
      INTEGER :: i,k,j, im<a name='1955'>
      INTEGER :: itf,ktf,jtf,itsu,jtsv<a name='1956'>
<a name='1957'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1958'></font>
<a name='1959'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1960'></font>
<font color=#447700>!<a name='1961'></font>
<font color=#447700>!  calculate_phy_tend couples the physics tendencies to the column mass (mu),<a name='1962'></font>
<font color=#447700>!  because prognostic equations are in flux form, but physics tendencies are<a name='1963'></font>
<font color=#447700>!  computed for uncoupled variables.<a name='1964'></font>
<font color=#447700>!<a name='1965'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1966'></font>
<a name='1967'>
      itf=MIN(ite,ide-1)<a name='1968'>
      jtf=MIN(jte,jde-1)<a name='1969'>
      ktf=MIN(kte,kde-1)<a name='1970'>
      itsu=MAX(its,ids+1)<a name='1971'>
      jtsv=MAX(jts,jds+1)<a name='1972'>
<a name='1973'>
<font color=#447700>! radiation<a name='1974'></font>
<a name='1975'>
   IF (config_flags%ra_lw_physics .gt. 0 .or. config_flags%ra_sw_physics .gt. 0) THEN<a name='1976'>
<a name='1977'>
      DO J=jts,jtf<a name='1978'>
      DO K=kts,ktf<a name='1979'>
      DO I=its,itf<a name='1980'>
         RTHRATEN(I,K,J)=mut(I,J)*RTHRATEN(I,K,J)<a name='1981'>
      ENDDO<a name='1982'>
      ENDDO<a name='1983'>
      ENDDO<a name='1984'>
<a name='1985'>
   ENDIF<a name='1986'>
<a name='1987'>
<font color=#447700>! cumulus<a name='1988'></font>
<a name='1989'>
   IF (config_flags%cu_physics .gt. 0) THEN<a name='1990'>
<a name='1991'>
      DO J=jts,jtf<a name='1992'>
      DO I=its,itf<a name='1993'>
      DO K=kts,ktf<a name='1994'>
         RUCUTEN(I,K,J) =mut(I,J)*RUCUTEN(I,K,J)<a name='1995'>
         RVCUTEN(I,K,J) =mut(I,J)*RVCUTEN(I,K,J)<a name='1996'>
         RTHCUTEN(I,K,J)=mut(I,J)*RTHCUTEN(I,K,J)<a name='1997'>
         RQVCUTEN(I,K,J)=mut(I,J)*RQVCUTEN(I,K,J)<a name='1998'>
      ENDDO<a name='1999'>
      ENDDO<a name='2000'>
      ENDDO<a name='2001'>
<a name='2002'>
      IF (P_QC .ge. PARAM_FIRST_SCALAR)THEN<a name='2003'>
         DO J=jts,jtf<a name='2004'>
         DO I=its,itf<a name='2005'>
         DO K=kts,ktf<a name='2006'>
            RQCCUTEN(I,K,J)=mut(I,J)*RQCCUTEN(I,K,J)<a name='2007'>
         ENDDO<a name='2008'>
         ENDDO<a name='2009'>
         ENDDO<a name='2010'>
      ENDIF<a name='2011'>
<a name='2012'>
      IF (P_QR .ge. PARAM_FIRST_SCALAR)THEN<a name='2013'>
         DO J=jts,jtf<a name='2014'>
         DO I=its,itf<a name='2015'>
         DO K=kts,ktf<a name='2016'>
            RQRCUTEN(I,K,J)=mut(I,J)*RQRCUTEN(I,K,J)<a name='2017'>
         ENDDO<a name='2018'>
         ENDDO<a name='2019'>
         ENDDO<a name='2020'>
      ENDIF<a name='2021'>
<a name='2022'>
      IF (P_QI .ge. PARAM_FIRST_SCALAR)THEN<a name='2023'>
         DO J=jts,jtf<a name='2024'>
         DO I=its,itf<a name='2025'>
         DO K=kts,ktf<a name='2026'>
            RQICUTEN(I,K,J)=mut(I,J)*RQICUTEN(I,K,J)<a name='2027'>
         ENDDO<a name='2028'>
         ENDDO<a name='2029'>
         ENDDO<a name='2030'>
      ENDIF<a name='2031'>
<a name='2032'>
      IF(P_QS .ge. PARAM_FIRST_SCALAR)THEN<a name='2033'>
         DO J=jts,jtf<a name='2034'>
         DO I=its,itf<a name='2035'>
         DO K=kts,ktf<a name='2036'>
            RQSCUTEN(I,K,J)=mut(I,J)*RQSCUTEN(I,K,J)<a name='2037'>
         ENDDO<a name='2038'>
         ENDDO<a name='2039'>
         ENDDO<a name='2040'>
      ENDIF<a name='2041'>
<a name='2042'>
   ENDIF<a name='2043'>
<a name='2044'>
<font color=#447700>! shallow cumulus<a name='2045'></font>
<a name='2046'>
   IF (config_flags%shcu_physics .gt. 0) THEN<a name='2047'>
<a name='2048'>
      DO J=jts,jtf<a name='2049'>
      DO I=its,itf<a name='2050'>
      DO K=kts,ktf<a name='2051'>
         RUSHTEN(I,K,J) =mut(I,J)*RUSHTEN(I,K,J)<a name='2052'>
         RVSHTEN(I,K,J) =mut(I,J)*RVSHTEN(I,K,J)<a name='2053'>
         RTHSHTEN(I,K,J)=mut(I,J)*RTHSHTEN(I,K,J)<a name='2054'>
         RQVSHTEN(I,K,J)=mut(I,J)*RQVSHTEN(I,K,J)<a name='2055'>
      ENDDO<a name='2056'>
      ENDDO<a name='2057'>
      ENDDO<a name='2058'>
<a name='2059'>
      IF (P_QC .ge. PARAM_FIRST_SCALAR)THEN<a name='2060'>
         DO J=jts,jtf<a name='2061'>
         DO I=its,itf<a name='2062'>
         DO K=kts,ktf<a name='2063'>
            RQCSHTEN(I,K,J)=mut(I,J)*RQCSHTEN(I,K,J)<a name='2064'>
         ENDDO<a name='2065'>
         ENDDO<a name='2066'>
         ENDDO<a name='2067'>
      ENDIF<a name='2068'>
<a name='2069'>
      IF (P_QR .ge. PARAM_FIRST_SCALAR)THEN<a name='2070'>
         DO J=jts,jtf<a name='2071'>
         DO I=its,itf<a name='2072'>
         DO K=kts,ktf<a name='2073'>
            RQRSHTEN(I,K,J)=mut(I,J)*RQRSHTEN(I,K,J)<a name='2074'>
         ENDDO<a name='2075'>
         ENDDO<a name='2076'>
         ENDDO<a name='2077'>
      ENDIF<a name='2078'>
<a name='2079'>
      IF (P_QI .ge. PARAM_FIRST_SCALAR)THEN<a name='2080'>
         DO J=jts,jtf<a name='2081'>
         DO I=its,itf<a name='2082'>
         DO K=kts,ktf<a name='2083'>
            RQISHTEN(I,K,J)=mut(I,J)*RQISHTEN(I,K,J)<a name='2084'>
         ENDDO<a name='2085'>
         ENDDO<a name='2086'>
         ENDDO<a name='2087'>
      ENDIF<a name='2088'>
<a name='2089'>
      IF(P_QS .ge. PARAM_FIRST_SCALAR)THEN<a name='2090'>
         DO J=jts,jtf<a name='2091'>
         DO I=its,itf<a name='2092'>
         DO K=kts,ktf<a name='2093'>
            RQSSHTEN(I,K,J)=mut(I,J)*RQSSHTEN(I,K,J)<a name='2094'>
         ENDDO<a name='2095'>
         ENDDO<a name='2096'>
         ENDDO<a name='2097'>
      ENDIF<a name='2098'>
<a name='2099'>
      IF(P_QG .ge. PARAM_FIRST_SCALAR)THEN<a name='2100'>
         DO J=jts,jtf<a name='2101'>
         DO I=its,itf<a name='2102'>
         DO K=kts,ktf<a name='2103'>
            RQGSHTEN(I,K,J)=mut(I,J)*RQGSHTEN(I,K,J)<a name='2104'>
         ENDDO<a name='2105'>
         ENDDO<a name='2106'>
         ENDDO<a name='2107'>
      ENDIF<a name='2108'>
<a name='2109'>
   ENDIF<a name='2110'>
<a name='2111'>
<font color=#447700>! pbl<a name='2112'></font>
<a name='2113'>
   IF (config_flags%bl_pbl_physics .gt. 0) THEN<a name='2114'>
<a name='2115'>
      DO J=jts,jtf<a name='2116'>
      DO K=kts,ktf<a name='2117'>
      DO I=its,itf<a name='2118'>
         RUBLTEN(I,K,J) =mut(I,J)*RUBLTEN(I,K,J)<a name='2119'>
         RVBLTEN(I,K,J) =mut(I,J)*RVBLTEN(I,K,J)<a name='2120'>
         RTHBLTEN(I,K,J)=mut(I,J)*RTHBLTEN(I,K,J)<a name='2121'>
      ENDDO<a name='2122'>
      ENDDO<a name='2123'>
      ENDDO<a name='2124'>
<a name='2125'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR) THEN<a name='2126'>
         DO J=jts,jtf<a name='2127'>
         DO K=kts,ktf<a name='2128'>
         DO I=its,itf<a name='2129'>
            RQVBLTEN(I,K,J)=mut(I,J)*RQVBLTEN(I,K,J)<a name='2130'>
         ENDDO<a name='2131'>
         ENDDO<a name='2132'>
         ENDDO<a name='2133'>
      ENDIF<a name='2134'>
<a name='2135'>
      IF (P_QC .ge. PARAM_FIRST_SCALAR) THEN<a name='2136'>
         DO J=jts,jtf<a name='2137'>
         DO K=kts,ktf<a name='2138'>
         DO I=its,itf<a name='2139'>
           RQCBLTEN(I,K,J)=mut(I,J)*RQCBLTEN(I,K,J)<a name='2140'>
         ENDDO<a name='2141'>
         ENDDO<a name='2142'>
         ENDDO<a name='2143'>
      ENDIF<a name='2144'>
<a name='2145'>
      IF (P_QI .ge. PARAM_FIRST_SCALAR) THEN<a name='2146'>
         DO J=jts,jtf<a name='2147'>
         DO K=kts,ktf<a name='2148'>
         DO I=its,itf<a name='2149'>
            RQIBLTEN(I,K,J)=mut(I,J)*RQIBLTEN(I,K,J)<a name='2150'>
         ENDDO<a name='2151'>
         ENDDO<a name='2152'>
         ENDDO<a name='2153'>
      ENDIF<a name='2154'>
<a name='2155'>
    ENDIF<a name='2156'>
<a name='2157'>
<font color=#447700>! fdda<a name='2158'></font>
<font color=#447700>! note fdda u and v tendencies are staggered, also only interior points have muu/muv,<a name='2159'></font>
<font color=#447700>!   so only couple those<a name='2160'></font>
<a name='2161'>
   IF (config_flags%grid_fdda .gt. 0) THEN<a name='2162'>
<a name='2163'>
      DO J=jts,jtf<a name='2164'>
      DO K=kts,ktf<a name='2165'>
      DO I=itsu,itf<a name='2166'>
<font color=#447700>!     if( i == itf/2 .AND. j == jtf/2 .AND. k == ktf/2 ) &amp;<a name='2167'></font>
<font color=#447700>!     write(*,'(a,3i6,e15.5)') 'u_ten before=',i,k,j, RUNDGDTEN(i,k,j)<a name='2168'></font>
         RUNDGDTEN(I,K,J) =muu(I,J)*RUNDGDTEN(I,K,J)<a name='2169'>
<font color=#447700>!        if( i == itf/2 .AND. j == jtf/2 .AND. k==ktf/2 ) &amp;<a name='2170'></font>
<font color=#447700>!          write(*,'(a,2f15.5)') 'mu, muu=',mut(I,J), muu(i,j)<a name='2171'></font>
<font color=#447700>!     if( i == itf/2 .AND. j == jtf/2 .AND. k == ktf/2 ) &amp;<a name='2172'></font>
<font color=#447700>!     write(*,'(a,3i6,e15.5)') 'u_ten after=',i,k,j, RUNDGDTEN(i,k,j)<a name='2173'></font>
<font color=#447700>!     if( RUNDGDTEN(i,k,j) &gt; 30.0 ) write(*,*) 'IKJ=',i,k,j<a name='2174'></font>
      ENDDO<a name='2175'>
      ENDDO<a name='2176'>
      ENDDO<a name='2177'>
<font color=#447700>!     write(*,'(a,e15.5)') 'u_ten MAXIMUM after=', maxval(RUNDGDTEN)<a name='2178'></font>
      DO J=jtsv,jtf<a name='2179'>
      DO K=kts,ktf<a name='2180'>
      DO I=its,itf<a name='2181'>
         RVNDGDTEN(I,K,J) =muv(I,J)*RVNDGDTEN(I,K,J)<a name='2182'>
      ENDDO<a name='2183'>
      ENDDO<a name='2184'>
      ENDDO<a name='2185'>
      DO J=jts,jtf<a name='2186'>
      DO K=kts,ktf<a name='2187'>
      DO I=its,itf<a name='2188'>
<font color=#447700>!     if( i == itf/2 .AND. j == jtf/2 .AND. k == ktf/2 ) &amp;<a name='2189'></font>
<font color=#447700>!     write(*,'(a,3i6,e15.5)') 'th before=',i,k,j, RTHNDGDTEN(I,K,J)<a name='2190'></font>
         RTHNDGDTEN(I,K,J)=mut(I,J)*RTHNDGDTEN(I,K,J)<a name='2191'>
<font color=#447700>!        RMUNDGDTEN(I,J) - no coupling<a name='2192'></font>
<font color=#447700>!     if( i == itf/2 .AND. j == jtf/2 .AND. k == ktf/2 ) &amp;<a name='2193'></font>
<font color=#447700>!     write(*,'(a,3i6,e15.5)') 'th after=',i,k,j, RTHNDGDTEN(I,K,J)<a name='2194'></font>
      ENDDO<a name='2195'>
      ENDDO<a name='2196'>
      ENDDO<a name='2197'>
<a name='2198'>
      IF (P_QV .ge. PARAM_FIRST_SCALAR) THEN<a name='2199'>
         DO J=jts,jtf<a name='2200'>
         DO K=kts,ktf<a name='2201'>
         DO I=its,itf<a name='2202'>
            RQVNDGDTEN(I,K,J)=mut(I,J)*RQVNDGDTEN(I,K,J)<a name='2203'>
         ENDDO<a name='2204'>
         ENDDO<a name='2205'>
         ENDDO<a name='2206'>
      ENDIF<a name='2207'>
<a name='2208'>
    ENDIF<a name='2209'>
<a name='2210'>
<font color=#447700>! 4d couple scalar tendencies that have only uncoupled physics tendencies at this point<a name='2211'></font>
<a name='2212'>
   DO im = PARAM_FIRST_SCALAR,num_scalar<a name='2213'>
         DO J=jts,jtf<a name='2214'>
         DO K=kts,ktf<a name='2215'>
         DO I=its,itf<a name='2216'>
            scalar_tend(I,K,J,im)=mut(I,J)*scalar_tend(I,K,J,im)<a name='2217'>
         ENDDO<a name='2218'>
         ENDDO<a name='2219'>
         ENDDO<a name='2220'>
   ENDDO<a name='2221'>
<a name='2222'>
   DO im = PARAM_FIRST_SCALAR,num_tracer<a name='2223'>
         DO J=jts,jtf<a name='2224'>
         DO K=kts,ktf<a name='2225'>
         DO I=its,itf<a name='2226'>
            tracer_tend(I,K,J,im)=mut(I,J)*tracer_tend(I,K,J,im)<a name='2227'>
         ENDDO<a name='2228'>
         ENDDO<a name='2229'>
         ENDDO<a name='2230'>
   ENDDO<a name='2231'>
<a name='2232'>
<a name='2233'>
END SUBROUTINE calculate_phy_tend<a name='2234'>
<a name='2235'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2236'></font>
<a name='2237'>
<A NAME='POSITIVE_DEFINITE_FILTER'><A href='../../html_code/dyn_em/module_em.F.html#POSITIVE_DEFINITE_FILTER' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2238'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>positive_definite_filter</font> ( a,                          &amp;<a name='2239'>
                                      ids,ide, jds,jde, kds,kde,  &amp;<a name='2240'>
                                      ims,ime, jms,jme, kms,kme,  &amp;<a name='2241'>
                                      its,ite, jts,jte, kts,kte  )<a name='2242'>
<a name='2243'>
  IMPLICIT NONE<a name='2244'>
<a name='2245'>
  INTEGER,  INTENT(IN   )   ::          ids,ide, jds,jde, kds,kde, &amp;<a name='2246'>
                                        ims,ime, jms,jme, kms,kme, &amp;<a name='2247'>
                                        its,ite, jts,jte, kts,kte<a name='2248'>
<a name='2249'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme  ), INTENT(INOUT) :: a<a name='2250'>
<a name='2251'>
  INTEGER :: i,k,j<a name='2252'>
<a name='2253'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2254'></font>
<font color=#447700>!<a name='2255'></font>
<font color=#447700>! debug and testing code for bounding a variable<a name='2256'></font>
<font color=#447700>!<a name='2257'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2258'></font>
<a name='2259'>
  DO j=jts,min(jte,jde-1)<a name='2260'>
  DO k=kts,kte-1<a name='2261'>
  DO i=its,min(ite,ide-1)<a name='2262'>
<font color=#447700>!    a(i,k,j) = max(a(i,k,j),0.)<a name='2263'></font>
    a(i,k,j) = min(1000.,max(a(i,k,j),0.))<a name='2264'>
  ENDDO<a name='2265'>
  ENDDO<a name='2266'>
  ENDDO<a name='2267'>
<a name='2268'>
  END SUBROUTINE positive_definite_filter<a name='2269'>
<a name='2270'>
<font color=#447700>!-----------------------------------------------------------------------<a name='2271'></font>
<a name='2272'>
<A NAME='BOUND_TKE'><A href='../../html_code/dyn_em/module_em.F.html#BOUND_TKE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2273'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>bound_tke</font> ( tke, tke_upper_bound,       &amp; <A href='../../call_to/BOUND_TKE.html' TARGET='index'>1</A><a name='2274'>
                       ids,ide, jds,jde, kds,kde,  &amp;<a name='2275'>
                       ims,ime, jms,jme, kms,kme,  &amp;<a name='2276'>
                       its,ite, jts,jte, kts,kte  )<a name='2277'>
<a name='2278'>
  IMPLICIT NONE<a name='2279'>
<a name='2280'>
  INTEGER,  INTENT(IN   )   ::          ids,ide, jds,jde, kds,kde, &amp;<a name='2281'>
                                        ims,ime, jms,jme, kms,kme, &amp;<a name='2282'>
                                        its,ite, jts,jte, kts,kte<a name='2283'>
<a name='2284'>
  REAL, DIMENSION( ims:ime , kms:kme , jms:jme  ), INTENT(INOUT) :: tke<a name='2285'>
  REAL, INTENT(   IN) :: tke_upper_bound<a name='2286'>
<a name='2287'>
  INTEGER :: i,k,j<a name='2288'>
<a name='2289'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2290'></font>
<font color=#447700>!<a name='2291'></font>
<font color=#447700>! bounds tke between zero and tke_upper_bound.<a name='2292'></font>
<font color=#447700>!<a name='2293'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2294'></font>
<a name='2295'>
  DO j=jts,min(jte,jde-1)<a name='2296'>
  DO k=kts,kte-1<a name='2297'>
  DO i=its,min(ite,ide-1)<a name='2298'>
    tke(i,k,j) = min(tke_upper_bound,max(tke(i,k,j),0.))<a name='2299'>
  ENDDO<a name='2300'>
  ENDDO<a name='2301'>
  ENDDO<a name='2302'>
<a name='2303'>
  END SUBROUTINE bound_tke<a name='2304'>
<a name='2305'>
<font color=#447700>!----------------------------------------------------------------------------------<a name='2306'></font>
<font color=#447700>!cyl: Implement the forward Lagrangian trajectory calculation in WRF <a name='2307'></font>
<font color=#447700>!Chiaying Lee RSMAS/UM <a name='2308'></font>
<font color=#447700>!----------------------------------------------------------------------------------<a name='2309'></font>
<A NAME='TRAJECTORY'><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2310'>
<font color=#993300>subroutine </font><font color=#cc0000>trajectory</font> (     grid,config_flags,               &amp; <A href='../../call_to/TRAJECTORY.html' TARGET='index'>1</A>,<A href='../../call_from/TRAJECTORY.html' TARGET='index'>17</A><a name='2311'>
                            dt,itimestep,ru_m, rv_m, ww_m,   &amp;<a name='2312'>
                            mut,muu,muv,c1h,c2h,c1f,c2f,     &amp;<a name='2313'>
                            rdx, rdy, rdn, rdnw,rdzw,        &amp;<a name='2314'>
                            traj_i,traj_j,traj_k,            &amp;<a name='2315'>
                            traj_long,traj_lat,              &amp;<a name='2316'>
                            xlong,xlat,                      &amp;<a name='2317'>
                            msft,msfu,msfv,                  &amp;<a name='2318'>
                            ids, ide, jds, jde, kds, kde,    &amp;<a name='2319'>
                            ims, ime, jms, jme, kms, kme,    &amp;<a name='2320'>
                            its, ite, jts, jte, kts, kte    )<a name='2321'>
<a name='2322'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='2323'></font>
<a name='2324'>
  use <A href='../../html_code/share/module_date_time.F.html#MODULE_DATE_TIME'>module_date_time</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DATE_TIME_1"><a name='2325'>
  use module_utility<a name='2326'>
  use <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_9">, only  : domain_clock_get<a name='2327'>
  use <A href='../../html_code/share/module_trajectory.F.html#MODULE_TRAJECTORY'>module_trajectory</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TRAJECTORY_1">, only  : traject, traj_cnt<a name='2328'>
<a name='2329'>
  implicit none<a name='2330'>
<font color=#447700>!---------------------------------------------------------------------------------------------------<a name='2331'></font>
<font color=#447700>! Subroutine trajectory calculates forward Lagrangian trajectory  <a name='2332'></font>
<font color=#447700>! of the selecting points. The trajectory of each point is subjected to u, v, and w.<a name='2333'></font>
<font color=#447700>! (Lee and Chen 2013, MWR).     <a name='2334'></font>
<font color=#447700>!<a name='2335'></font>
<font color=#447700>! The trajectories is initialized with given longitude (degree), latitude (degree), and height(eta level).<a name='2336'></font>
<font color=#447700>!<a name='2337'></font>
<font color=#447700>!--traj_i 	grid number in x direction (on mass grid), float<a name='2338'></font>
<font color=#447700>!--traj_j 	grid number in y direction (on mass grid), float<a name='2339'></font>
<font color=#447700>!--traj_k	grid number in z direction (on mass grid), float<a name='2340'></font>
<font color=#447700>!--traj_long	longitude of trajectories, float<a name='2341'></font>
<font color=#447700>!--traj_lat	longitude of trajectories, float<a name='2342'></font>
<font color=#447700>!<a name='2343'></font>
<font color=#447700>!--------------------------------------------------------------------------------------------------<a name='2344'></font>
  TYPE(proj_info) :: proj<a name='2345'>
  TYPE(domain), INTENT(IN) :: grid<a name='2346'>
  TYPE (grid_config_rec_type) , INTENT(IN)          :: config_flags<a name='2347'>
  INTEGER ,                INTENT(IN   ) :: ids, ide, jds, jde, kds, kde, &amp;<a name='2348'>
                                             ims, ime, jms, jme, kms, kme, &amp;<a name='2349'>
                                             its, ite, jts, jte, kts, kte<a name='2350'>
   INTEGER ,                                      INTENT(IN   ) :: itimestep<a name='2351'>
   REAL ,                                      INTENT(IN   ) :: rdx,     &amp;<a name='2352'>
                                                                rdy,     &amp;<a name='2353'>
                                                                dt<a name='2354'>
   REAL , DIMENSION( kms:kme ) ,               INTENT(IN   ) :: rdn,     &amp;<a name='2355'>
                                                                rdnw<a name='2356'>
<a name='2357'>
   REAL , DIMENSION( kms:kme ) ,               INTENT(IN   ) :: c1h, c2h, c1f, c2f<a name='2358'>
<a name='2359'>
   REAL , DIMENSION( ims:ime , kms:kme, jms:jme  ) ,              &amp;<a name='2360'>
                                        INTENT(IN   ) :: ru_m,     &amp;<a name='2361'>
                                                         rv_m,     &amp;<a name='2362'>
                                                         ww_m<a name='2363'>
   REAL , DIMENSION( ims:ime , jms:jme  ) ,              &amp;<a name='2364'>
                                        INTENT(IN   ) ::xlong, xlat<a name='2365'>
<a name='2366'>
  real, dimension(1:config_flags%num_traj), intent(inout) :: traj_i,traj_j,traj_k<a name='2367'>
  real, dimension(1:config_flags%num_traj), intent(inout) :: traj_long,traj_lat<a name='2368'>
  real, dimension(ims:ime,kms:kme,jms:jme),intent(in) :: rdzw<a name='2369'>
  real, dimension(ims:ime,kms:kme,jms:jme)::u,v,w<a name='2370'>
  real, dimension(ims:ime,jms:jme),intent(in)::msft,msfu,msfv<a name='2371'>
  real, dimension(ims:ime,jms:jme),intent(in)::muu,muv,mut<a name='2372'>
  integer :: j,k<a name='2373'>
  integer :: i_beg,i_end<a name='2374'>
  integer :: i_traj,j_traj,k_traj,tjk<a name='2375'>
  integer :: dm<a name='2376'>
  real :: traj_u,traj_v,traj_w<a name='2377'>
  real :: rdx_grid,rdy_grid,rdz_grid<a name='2378'>
  real :: deltx, delty, deltz,ax<a name='2379'>
  real :: const1<a name='2380'>
  real :: temp_i,temp_j<a name='2381'>
  integer :: i_u,j_v,k_w<a name='2382'>
  real :: u_a,u_b,u_c,u_d,v_a,v_b,v_c,v_d,w_a,w_b,w_c,w_d<a name='2383'>
  real :: d_a,d_b,d_c,d_d<a name='2384'>
  real :: u_temp_upper,u_temp_lower<a name='2385'>
  real :: v_temp_upper,v_temp_lower<a name='2386'>
  real :: w_temp_upper,w_temp_lower<a name='2387'>
  real :: eta_old, eta_new<a name='2388'>
  integer :: keta, keta_temp<a name='2389'>
  character(len=19)  :: current_timestr, next_timestr, wrk_timestr<a name='2390'>
  character(len=256) :: dbg_mes<a name='2391'>
  logical :: has_proj_map<a name='2392'>
<font color=#447700>! varalbe for map projectory<a name='2393'></font>
  real:: known_lat, known_lon<a name='2394'>
  TYPE (grid_config_rec_type) :: config_flags_temp<a name='2395'>
  TYPE(WRFU_Time) :: current_time, next_time<a name='2396'>
  TYPE(WRFU_Time) :: start_time, stop_time<a name='2397'>
<a name='2398'>
  config_flags_temp = config_flags<a name='2399'>
  call <A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ'>trajmapproj</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRAJMAPPROJ_1">(grid, config_flags_temp,proj)<a name='2400'>
<a name='2401'>
<a name='2402'>
<font color=#447700>! convert ru_m, rv_m and ww_m in u,v,w <a name='2403'></font>
   const1=1.0/2.0/sqrt(2.0)<a name='2404'>
<a name='2405'>
   dm = grid%id<a name='2406'>
<a name='2407'>
   write(dbg_mes,'(''trajectory('',i2.2,''): Entering trajectory'')') dm<a name='2408'>
   call <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_8">(200,trim(dbg_mes) )<a name='2409'>
<a name='2410'>
   i_beg = max( 1,its-1 )<a name='2411'>
   i_end = min( ite+2,ide-1 )<a name='2412'>
   do j=max(1,jts-1),min(jte+2,jde-1)<a name='2413'>
     do k=kms,kme-1<a name='2414'>
       u(its:i_end,k,j)=ru_m(its:i_end,k,j)/MUU(its:i_end,j)*msfu(its:i_end,j)<a name='2415'>
       v(its:i_end,k,j)=rv_m(its:i_end,k,j)/MUV(its:i_end,j)*msfv(its:i_end,j)<a name='2416'>
     enddo<a name='2417'>
     do k=kms,kme<a name='2418'>
       w(its:i_end,k,j)=ww_m(its:i_end,k,j)/MUT(its:i_end,j)*msft(its:i_end,j)<a name='2419'>
     enddo<a name='2420'>
   enddo<a name='2421'>
          has_proj_map  = &amp;<a name='2422'>
           ( proj%code .EQ. PROJ_LC           ) .OR. &amp;<a name='2423'>
           ( proj%code .EQ. PROJ_PS_WGS84     ) .OR. &amp;<a name='2424'>
           ( proj%code .EQ. PROJ_ALBERS_NAD83 ) .OR. &amp;<a name='2425'>
           ( proj%code .EQ. PROJ_MERC         ) .OR. &amp;<a name='2426'>
           ( proj%code .EQ. PROJ_LATLON       ) .OR. &amp;<a name='2427'>
           ( proj%code .EQ. PROJ_CYL          ) .OR. &amp;<a name='2428'>
           ( proj%code .EQ. PROJ_CASSINI      ) .OR. &amp;<a name='2429'>
           ( proj%code .EQ. PROJ_GAUSS        ) .OR. &amp;<a name='2430'>
           ( proj%code .EQ. PROJ_ROTLL        )<a name='2431'>
<a name='2432'>
traj_loop: &amp;<a name='2433'>
do tjk = 1,traj_cnt(dm)<a name='2434'>
<font color=#447700>!do tjk = 1,config_flags%num_traj<a name='2435'></font>
traj_is_active: &amp;<a name='2436'>
    if (traj_i(tjk) .ne. -9999.0) then<a name='2437'>
      eta_old = 0.0<a name='2438'>
      eta_new = 0.0<a name='2439'>
      keta      = 0<a name='2440'>
      keta_temp = 0<a name='2441'>
      if( has_proj_map ) then<a name='2442'>
        call <A href='../../html_code/share/module_llxy.F.html#LATLON_TO_IJ'>latlon_to_ij</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LATLON_TO_IJ_1"> (proj, &amp;<a name='2443'>
traj_lat(tjk),traj_long(tjk),traj_i(tjk),traj_j(tjk))<a name='2444'>
      end if<a name='2445'>
<a name='2446'>
      i_traj = floor(traj_i(tjk)) <font color=#447700>! find the lower_left_bottom corner for<a name='2447'></font>
<font color=#447700>!trajectory <a name='2448'></font>
      j_traj = floor(traj_j(tjk)) <font color=#447700>! <a name='2449'></font>
      k_traj = floor(traj_k(tjk)) <font color=#447700>! <a name='2450'></font>
traj_in_domain: &amp;<a name='2451'>
      if ((i_traj .ge. its .and. i_traj .le. ite .and. i_traj .lt. ide) .and. &amp;<a name='2452'>
          (j_traj .ge. jts .and. j_traj .le. jte .and. j_traj .lt. jde) .and. &amp;<a name='2453'>
          (k_traj .le. kte .and. k_traj .lt. kde)) then<a name='2454'>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2455'></font>
<font color=#447700>!  is trajectory in time interval?<a name='2456'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='2457'></font>
         call <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_1">( grid, current_time=current_time, &amp;<a name='2458'>
current_timestr=current_timestr)<a name='2459'>
         call <A href='../../html_code/share/module_date_time.F.html#GETH_NEWDATE'>geth_newdate</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GETH_NEWDATE_1">( next_timestr, current_timestr, int(grid%dt) )<a name='2460'>
         call <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_1">( next_timestr, next_time )<a name='2461'>
         wrk_timestr(1:19) = traject(tjk,dm)%start_time(1:19)<a name='2462'>
<font color=#447700>!        write(*,*) ' '<a name='2463'></font>
<font color=#447700>!        write(*,*) traject(tjk,dm)<a name='2464'></font>
<font color=#447700>!        write(dbg_mes,'(''trajectory('',i2,2,''): tjk,start_time = '',i3,1x,a)') &amp;<a name='2465'></font>
<font color=#447700>!                     dm,tjk,wrk_timestr<a name='2466'></font>
<font color=#447700>!        call wrf_debug( 200,trim(dbg_mes) )<a name='2467'></font>
         call <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_2">( wrk_timestr(1:19), start_time )<a name='2468'>
         wrk_timestr(1:19) = traject(tjk,dm)%stop_time(1:19)<a name='2469'>
         call <A href='../../html_code/share/module_date_time.F.html#WRF_ATOTIME'>wrf_atotime</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ATOTIME_3">( wrk_timestr(1:19), stop_time )<a name='2470'>
is_in_time_interval: &amp;<a name='2471'>
         if( next_time .ge. start_time .and. next_time .le. stop_time &amp;<a name='2472'>
                                       .and. .not. traject(tjk,dm)%is_stationary ) then<a name='2473'>
<font color=#447700>! for u : check x stagger<a name='2474'></font>
        if (traj_i(tjk)-real(floor(traj_i(tjk))) .ge. 0.5 ) then<a name='2475'>
          i_u=floor(traj_i(tjk)) + 1<a name='2476'>
        else<a name='2477'>
          i_u=floor(traj_i(tjk))<a name='2478'>
        endif<a name='2479'>
<font color=#447700>! for layer k_traj<a name='2480'></font>
      if (k_traj .ge. 1 ) then<a name='2481'>
        u_a=u(i_u  ,k_traj,j_traj+1)<a name='2482'>
        u_b=u(i_u  ,k_traj,j_traj  )<a name='2483'>
        u_c=u(i_u+1,k_traj,j_traj  )<a name='2484'>
        u_d=u(i_u+1,k_traj,j_traj+1)<a name='2485'>
      else<a name='2486'>
        u_a=0.0<a name='2487'>
        u_b=0.0<a name='2488'>
        u_c=0.0<a name='2489'>
        u_d=0.0<a name='2490'>
      endif<a name='2491'>
        d_a=abs((real(i_u+1)-(traj_i(tjk)+0.5))*(real(j_traj  )-traj_j(tjk)))<a name='2492'>
        d_b=abs((real(i_u+1)-(traj_i(tjk)+0.5))*(real(j_traj+1)-traj_j(tjk)))<a name='2493'>
        d_c=abs((real(i_u  )-(traj_i(tjk)+0.5))*(real(j_traj+1)-traj_j(tjk)))<a name='2494'>
        d_d=abs((real(i_u  )-(traj_i(tjk)+0.5))*(real(j_traj  )-traj_j(tjk)))<a name='2495'>
        u_temp_lower=(u_a*d_a+u_b*d_b+u_c*d_c+u_d*d_d)/(d_a+d_b+d_c+d_d)<a name='2496'>
<a name='2497'>
<font color=#447700>!for layer k_traj+1<a name='2498'></font>
        u_a=u(i_u  ,k_traj+1,j_traj+1)<a name='2499'>
        u_b=u(i_u  ,k_traj+1,j_traj  )<a name='2500'>
        u_c=u(i_u+1,k_traj+1,j_traj  )<a name='2501'>
        u_d=u(i_u+1,k_traj+1,j_traj+1)<a name='2502'>
        d_a=abs((real(i_u+1)-(traj_i(tjk)+0.5))*(real(j_traj  )-traj_j(tjk)))<a name='2503'>
        d_b=abs((real(i_u+1)-(traj_i(tjk)+0.5))*(real(j_traj+1)-traj_j(tjk)))<a name='2504'>
        d_c=abs((real(i_u  )-(traj_i(tjk)+0.5))*(real(j_traj+1)-traj_j(tjk)))<a name='2505'>
        d_d=abs((real(i_u  )-(traj_i(tjk)+0.5))*(real(j_traj  )-traj_j(tjk)))<a name='2506'>
        u_temp_upper=(u_a*d_a+u_b*d_b+u_c*d_c+u_d*d_d)/(d_a+d_b+d_c+d_d)<a name='2507'>
<a name='2508'>
        traj_u=u_temp_upper*abs(real(k_traj)-traj_k(tjk))+u_temp_lower*abs(real(k_traj+1)-traj_k(tjk))<a name='2509'>
<a name='2510'>
<font color=#447700>! for v: check y-stagger<a name='2511'></font>
        if (traj_j(tjk)-real(floor(traj_j(tjk))) .ge. 0.5 ) then<a name='2512'>
          j_v=floor(traj_j(tjk)) + 1<a name='2513'>
        else<a name='2514'>
          j_v=floor(traj_j(tjk))<a name='2515'>
        endif<a name='2516'>
<font color=#447700>! for layer k_traj<a name='2517'></font>
      if (k_traj .ge. 1 ) then<a name='2518'>
        v_a=v(i_traj  ,k_traj,j_v+1)<a name='2519'>
        v_b=v(i_traj  ,k_traj,j_v  )<a name='2520'>
        v_c=v(i_traj+1,k_traj,j_v  )<a name='2521'>
        v_d=v(i_traj+1,k_traj,j_v+1)<a name='2522'>
      else<a name='2523'>
        v_a=0.0<a name='2524'>
        v_b=0.0<a name='2525'>
        v_c=0.0<a name='2526'>
        v_d=0.0<a name='2527'>
      endif<a name='2528'>
        d_a=abs((real(i_traj+1)-traj_i(tjk))*(real(j_v  )-(traj_j(tjk)+0.5)))<a name='2529'>
        d_b=abs((real(i_traj+1)-traj_i(tjk))*(real(j_v+1)-(traj_j(tjk)+0.5)))<a name='2530'>
        d_c=abs((real(i_traj  )-traj_i(tjk))*(real(j_v+1)-(traj_j(tjk)+0.5)))<a name='2531'>
        d_d=abs((real(i_traj  )-traj_i(tjk))*(real(j_v  )-(traj_j(tjk)+0.5)))<a name='2532'>
        v_temp_lower=(v_a*d_a+v_b*d_b+v_c*d_c+v_d*d_d)/(d_a+d_b+d_c+d_d)<a name='2533'>
<font color=#447700>!for layer k_traj+1<a name='2534'></font>
        v_a=v(i_traj  ,k_traj+1,j_v+1)<a name='2535'>
        v_b=v(i_traj  ,k_traj+1,j_v  )<a name='2536'>
        v_c=v(i_traj+1,k_traj+1,j_v  )<a name='2537'>
        v_d=v(i_traj+1,k_traj+1,j_v+1)<a name='2538'>
        d_a=abs((real(i_traj+1)-traj_i(tjk))*(real(j_v  )-(traj_j(tjk)+0.5)))<a name='2539'>
        d_b=abs((real(i_traj+1)-traj_i(tjk))*(real(j_v+1)-(traj_j(tjk)+0.5)))<a name='2540'>
        d_c=abs((real(i_traj  )-traj_i(tjk))*(real(j_v+1)-(traj_j(tjk)+0.5)))<a name='2541'>
        d_d=abs((real(i_traj  )-traj_i(tjk))*(real(j_v  )-(traj_j(tjk)+0.5)))<a name='2542'>
        v_temp_upper=(v_a*d_a+v_b*d_b+v_c*d_c+v_d*d_d)/(d_a+d_b+d_c+d_d)<a name='2543'>
<a name='2544'>
        traj_v=v_temp_upper*abs(real(k_traj)-traj_k(tjk))+v_temp_lower*abs(real(k_traj+1)-traj_k(tjk))<a name='2545'>
<a name='2546'>
<a name='2547'>
<font color=#447700>!for w: check for z-stagger<a name='2548'></font>
        if (traj_k(tjk)-real(floor(traj_k(tjk))) .ge. 0.5 ) then<a name='2549'>
          k_w=floor(traj_k(tjk)) + 1<a name='2550'>
        else<a name='2551'>
          k_w=floor(traj_k(tjk))<a name='2552'>
        endif<a name='2553'>
<font color=#447700>!for layer j_traj<a name='2554'></font>
        if (k_w .ge. 1) then<a name='2555'>
          w_b=w(i_traj  ,k_w  ,j_traj)<a name='2556'>
          w_c=w(i_traj+1,k_w  ,j_traj)<a name='2557'>
        else<a name='2558'>
          w_b=0.0<a name='2559'>
          w_c=0.0<a name='2560'>
        endif<a name='2561'>
        w_a=w(i_traj  ,k_w+1,j_traj)<a name='2562'>
        w_d=w(i_traj+1,k_w+1,j_traj)<a name='2563'>
        d_a=abs((real(i_traj+1)-traj_i(tjk))*(real(k_w  )-(traj_k(tjk)+0.5)))<a name='2564'>
        d_b=abs((real(i_traj+1)-traj_i(tjk))*(real(k_w+1)-(traj_k(tjk)+0.5)))<a name='2565'>
        d_c=abs((real(i_traj  )-traj_i(tjk))*(real(k_w+1)-(traj_k(tjk)+0.5)))<a name='2566'>
        d_d=abs((real(i_traj  )-traj_i(tjk))*(real(k_w  )-(traj_k(tjk)+0.5)))<a name='2567'>
        w_temp_lower=(w_a*d_a+w_b*d_b+w_c*d_c+w_d*d_d)/(d_a+d_b+d_c+d_d)<a name='2568'>
<font color=#447700>!for layer j_traj+1<a name='2569'></font>
        if (k_w .ge. 1) then<a name='2570'>
          w_b=w(i_traj  ,k_w  ,j_traj+1)<a name='2571'>
          w_c=w(i_traj+1,k_w  ,j_traj+1)<a name='2572'>
        else<a name='2573'>
          w_b=0.0<a name='2574'>
          w_c=0.0<a name='2575'>
        endif<a name='2576'>
        w_a=w(i_traj  ,k_w+1,j_traj+1)<a name='2577'>
        w_d=w(i_traj+1,k_w+1,j_traj+1)<a name='2578'>
        d_a=abs((real(i_traj+1)-traj_i(tjk))*(real(k_w  )-(traj_k(tjk)+0.5)))<a name='2579'>
        d_b=abs((real(i_traj+1)-traj_i(tjk))*(real(k_w+1)-(traj_k(tjk)+0.5)))<a name='2580'>
        d_c=abs((real(i_traj  )-traj_i(tjk))*(real(k_w+1)-(traj_k(tjk)+0.5)))<a name='2581'>
        d_d=abs((real(i_traj  )-traj_i(tjk))*(real(k_w  )-(traj_k(tjk)+0.5)))<a name='2582'>
        w_temp_upper=(w_a*d_a+w_b*d_b+w_c*d_c+w_d*d_d)/(d_a+d_b+d_c+d_d)<a name='2583'>
<a name='2584'>
        traj_w=w_temp_upper*abs(real(j_traj)-traj_j(tjk))+w_temp_lower*abs(real(j_traj+1)-traj_j(tjk))<a name='2585'>
<font color=#447700>!get old eta <a name='2586'></font>
        eta_old=grid%znw(k_w+1)*abs(traj_k(tjk)+0.5-real(k_w))+grid%znw(k_w)*abs(traj_k(tjk)+0.5-real(k_w+1))<a name='2587'>
<a name='2588'>
        rdx_grid=rdx*msft(i_traj,j_traj)<font color=#447700>! 1/(dx/msft)<a name='2589'></font>
        rdy_grid=rdy*msft(i_traj,j_traj)<a name='2590'>
        rdz_grid=rdnw(k_traj)<a name='2591'>
        deltx=traj_u*DT<a name='2592'>
        delty=traj_v*DT<a name='2593'>
        deltz=traj_w*DT<a name='2594'>
        traj_i(tjk)=traj_i(tjk)+deltx*rdx_grid<a name='2595'>
        traj_j(tjk)=traj_j(tjk)+delty*rdy_grid<a name='2596'>
        eta_new=eta_old+deltz<a name='2597'>
<font color=#447700>! get new traj_k(tjk)<a name='2598'></font>
        keta_temp = 0<a name='2599'>
        do keta=1, kme-1<a name='2600'>
          if (eta_new .le. grid%znw(keta) .and. eta_new .gt. grid%znw(keta+1)) then<a name='2601'>
           keta_temp=keta<a name='2602'>
          endif<a name='2603'>
        enddo<a name='2604'>
        if (keta_temp .eq. 0)  then<a name='2605'>
            traj_k(tjk) = traj_k(tjk)<a name='2606'>
        else<a name='2607'>
            traj_k(tjk) = (real(keta_temp)*abs(eta_new-grid%znw(keta_temp+1))+ &amp;<a name='2608'>
                           real(keta_temp+1)*abs(eta_new-grid%znw(keta_temp))) &amp;<a name='2609'>
                           /(grid%znw(keta_temp)-grid%znw(keta_temp+1))<a name='2610'>
            traj_k(tjk) = traj_k(tjk)-0.5<a name='2611'>
        endif<a name='2612'>
<font color=#447700>!! convert i,j,k into lon, lat <a name='2613'></font>
        if( has_proj_map ) then<a name='2614'>
          call <A href='../../html_code/share/module_llxy.F.html#IJ_TO_LATLON'>ij_to_latlon</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IJ_TO_LATLON_1"> (proj, traj_i(tjk), &amp;<a name='2615'>
                             traj_j(tjk),traj_lat(tjk),traj_long(tjk))<a name='2616'>
        endif<a name='2617'>
      endif is_in_time_interval<a name='2618'>
     else traj_in_domain<a name='2619'>
        traj_i(tjk) = -9999.0<a name='2620'>
        traj_j(tjk) = -9999.0<a name='2621'>
        traj_k(tjk) = -9999.0<a name='2622'>
        traj_long(tjk) = -9999.0<a name='2623'>
        traj_lat(tjk) = -9999.0<a name='2624'>
     endif traj_in_domain<a name='2625'>
 endif traj_is_active<a name='2626'>
     traj_i(tjk) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_1">(traj_i(tjk))<a name='2627'>
     traj_j(tjk) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_2">(traj_j(tjk))<a name='2628'>
     traj_k(tjk) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_3">(traj_k(tjk))<a name='2629'>
     traj_long(tjk) = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_4">(traj_long(tjk))<a name='2630'>
     traj_lat(tjk)  = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAX_REAL'>wrf_dm_max_real</A><A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAX_REAL_5">(traj_lat(tjk))<a name='2631'>
enddo traj_loop<a name='2632'>
<font color=#447700>!end trajectory<a name='2633'></font>
<a name='2634'>
END SUBROUTINE trajectory<a name='2635'>
<font color=#447700>!------------------------------------------------------------------------<a name='2636'></font>
<font color=#447700>!cyl:Implement the map prpjection code for trajectory calculation <a name='2637'></font>
<font color=#447700>!                                    Chiaying Lee  RSMAS/UM        <a name='2638'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2639'></font>
<A NAME='TRAJMAPPROJ'><A href='../../html_code/dyn_em/module_em.F.html#TRAJMAPPROJ' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2640'>
<font color=#993300>subroutine </font><font color=#cc0000>trajmapproj</font> (grid,config_flags,ts_proj) <A href='../../call_to/TRAJMAPPROJ.html' TARGET='index'>2</A>,<A href='../../call_from/TRAJMAPPROJ.html' TARGET='index'>24</A><a name='2641'>
<font color=#447700>!------------------------------------------------------------------------<a name='2642'></font>
<font color=#447700>!!! This code calculates map-projection of trajectories. It is from share/wrf_timeseries.F<a name='2643'></font>
<font color=#447700>!------------------------------------------------------------------------<a name='2644'></font>
<a name='2645'>
   IMPLICIT NONE<a name='2646'>
<a name='2647'>
<a name='2648'>
   <font color=#447700>! Arguments<a name='2649'></font>
   TYPE (domain), INTENT(IN) :: grid<a name='2650'>
   TYPE (grid_config_rec_type) , INTENT(IN)  :: config_flags<a name='2651'>
   <font color=#447700>! Externals<a name='2652'></font>
   LOGICAL, EXTERNAL :: wrf_dm_on_monitor<a name='2653'>
   INTEGER, EXTERNAL :: get_unused_unit<a name='2654'>
<a name='2655'>
<a name='2656'>
   <font color=#447700>! Local variables<a name='2657'></font>
   INTEGER :: ntsloc_temp<a name='2658'>
   INTEGER :: i, k, iunit<a name='2659'>
   REAL :: ts_rx, ts_ry, ts_xlat, ts_xlong, ts_hgt<a name='2660'>
   REAL :: known_lat, known_lon<a name='2661'>
   CHARACTER (LEN=132) :: message<a name='2662'>
   TYPE (PROJ_INFO), INTENT(out) :: ts_proj<a name='2663'>
<a name='2664'>
<a name='2665'>
   INTEGER :: ids, ide, jds, jde, kds, kde,        &amp;<a name='2666'>
              ims, ime, jms, jme, kms, kme,        &amp;<a name='2667'>
              ips, ipe, jps, jpe, kps, kpe,        &amp;<a name='2668'>
              imsx, imex, jmsx, jmex, kmsx, kmex,  &amp;<a name='2669'>
              ipsx, ipex, jpsx, jpex, kpsx, kpex,  &amp;<a name='2670'>
              imsy, imey, jmsy, jmey, kmsy, kmey,  &amp;<a name='2671'>
              ipsy, ipey, jpsy, jpey, kpsy, kpey<a name='2672'>
   TYPE (grid_config_rec_type)               :: config_flags_temp<a name='2673'>
<a name='2674'>
<a name='2675'>
   config_flags_temp = config_flags<a name='2676'>
<a name='2677'>
     CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_4"> ( grid ,                               &amp;<a name='2678'>
                               ids, ide, jds, jde, kds, kde,        &amp;<a name='2679'>
                               ims, ime, jms, jme, kms, kme,        &amp;<a name='2680'>
                               ips, ipe, jps, jpe, kps, kpe,        &amp;<a name='2681'>
                               imsx, imex, jmsx, jmex, kmsx, kmex,  &amp;<a name='2682'>
                               ipsx, ipex, jpsx, jpex, kpsx, kpex,  &amp;<a name='2683'>
                               imsy, imey, jmsy, jmey, kmsy, kmey,  &amp;<a name='2684'>
                               ipsy, ipey, jpsy, jpey, kpsy, kpey )<a name='2685'>
<a name='2686'>
     CALL <A href='../../html_code/frame/module_configure.F.html#MODEL_TO_GRID_CONFIG_REC'>model_to_grid_config_rec</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODEL_TO_GRID_CONFIG_REC_1"> ( grid%id , model_config_rec , config_flags_temp )<a name='2687'>
<a name='2688'>
<a name='2689'>
      <font color=#447700>! Set up map transformation structure<a name='2690'></font>
      CALL <A href='../../html_code/share/module_llxy.F.html#MAP_INIT'>map_init</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_INIT_1">(ts_proj)<a name='2691'>
<a name='2692'>
<a name='2693'>
      IF (ips &lt;= 1 .AND. 1 &lt;= ipe .AND. &amp;<a name='2694'>
          jps &lt;= 1 .AND. 1 &lt;= jpe) THEN<a name='2695'>
         known_lat = grid%xlat(1,1)<a name='2696'>
         known_lon = grid%xlong(1,1)<a name='2697'>
      ELSE<a name='2698'>
         known_lat = 9999.<a name='2699'>
         known_lon = 9999.<a name='2700'>
      END IF<a name='2701'>
      known_lat = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_1">(known_lat)<a name='2702'>
      known_lon = <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MIN_REAL'>wrf_dm_min_real</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MIN_REAL_2">(known_lon)<a name='2703'>
<a name='2704'>
<a name='2705'>
      <font color=#447700>! Mercator<a name='2706'></font>
      IF (config_flags%map_proj == PROJ_MERC) THEN<a name='2707'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_1">(PROJ_MERC, ts_proj,               &amp;<a name='2708'>
                      truelat1 = config_flags%truelat1, &amp;<a name='2709'>
                      lat1     = known_lat,             &amp;<a name='2710'>
                      lon1     = known_lon,             &amp;<a name='2711'>
                      knowni   = 1.,                    &amp;<a name='2712'>
                      knownj   = 1.,                    &amp;<a name='2713'>
                      dx       = config_flags%dx)<a name='2714'>
      <font color=#447700>! Lambert conformal<a name='2715'></font>
      ELSE IF (config_flags%map_proj == PROJ_LC) THEN<a name='2716'>
      CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_2">(PROJ_LC, ts_proj,                  &amp;<a name='2717'>
                      truelat1 = config_flags%truelat1,  &amp;<a name='2718'>
                      truelat2 = config_flags%truelat2,  &amp;<a name='2719'>
                      stdlon   = config_flags%stand_lon, &amp;<a name='2720'>
                      lat1     = known_lat,              &amp;<a name='2721'>
                      lon1     = known_lon,              &amp;<a name='2722'>
                      knowni   = 1.,                     &amp;<a name='2723'>
                      knownj   = 1.,                     &amp;<a name='2724'>
                      dx       = config_flags%dx)<a name='2725'>
      <font color=#447700>! Polar stereographic<a name='2726'></font>
      ELSE IF (config_flags%map_proj == PROJ_PS) THEN<a name='2727'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_3">(PROJ_PS, ts_proj,                  &amp;<a name='2728'>
                      truelat1 = config_flags%truelat1,  &amp;<a name='2729'>
                      stdlon   = config_flags%stand_lon, &amp;<a name='2730'>
                      lat1     = known_lat,              &amp;<a name='2731'>
                      lon1     = known_lon,              &amp;<a name='2732'>
                      knowni   = 1.,                     &amp;<a name='2733'>
                      knownj   = 1.,                     &amp;<a name='2734'>
                      dx       = config_flags%dx)<a name='2735'>
<a name='2736'>
<a name='2737'>
      <font color=#447700>! Cassini (global ARW)<a name='2738'></font>
      ELSE IF (config_flags%map_proj == PROJ_CASSINI) THEN<a name='2739'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_4">(PROJ_CASSINI, ts_proj,                            &amp;<a name='2740'>
                      latinc   = grid%dy*360.0/(2.0*EARTH_RADIUS_M*PI), &amp;<a name='2741'>
                      loninc   = grid%dx*360.0/(2.0*EARTH_RADIUS_M*PI), &amp;<a name='2742'>
                      lat1     = known_lat,                             &amp;<a name='2743'>
                      lon1     = known_lon,                             &amp;<a name='2744'>
<font color=#447700>! We still need to get POLE_LAT and POLE_LON metadata variables before<a name='2745'></font>
<font color=#447700>!   this will work for rotated poles.<a name='2746'></font>
                      lat0     = 90.0,                                  &amp;<a name='2747'>
                      lon0     = 0.0,                                   &amp;<a name='2748'>
                      knowni   = 1.,                                    &amp;<a name='2749'>
                      knownj   = 1.,                                    &amp;<a name='2750'>
                      stdlon   = config_flags%stand_lon)<a name='2751'>
<a name='2752'>
<a name='2753'>
      <font color=#447700>! Rotated latitude-longitude<a name='2754'></font>
      ELSE IF (config_flags%map_proj == PROJ_ROTLL) THEN<a name='2755'>
         CALL <A href='../../html_code/share/module_llxy.F.html#MAP_SET'>map_set</A><A href='../../html_code/share/module_trajectory.F.html#TRAJMAPPROJ' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MAP_SET_5">(PROJ_ROTLL, ts_proj,                      &amp;<a name='2756'>
<font color=#447700>! I have no idea how this should work for NMM nested domains<a name='2757'></font>
                      ixdim    = grid%e_we-1,                   &amp;<a name='2758'>
                      jydim    = grid%e_sn-1,                   &amp;<a name='2759'>
                      phi      = real(grid%e_sn-2)*grid%dy/2.0, &amp;<a name='2760'>
                      lambda   = real(grid%e_we-2)*grid%dx,     &amp;<a name='2761'>
                      lat1     = config_flags%cen_lat,          &amp;<a name='2762'>
                      lon1     = config_flags%cen_lon,          &amp;<a name='2763'>
                      latinc   = grid%dy,                       &amp;<a name='2764'>
                      loninc   = grid%dx,                       &amp;<a name='2765'>
                      stagger  = HH)<a name='2766'>
<a name='2767'>
<a name='2768'>
      END IF<a name='2769'>
<a name='2770'>
<a name='2771'>
end subroutine trajmapproj<a name='2772'>
<a name='2773'>
END MODULE module_em<a name='2774'>
</pre></body></html>