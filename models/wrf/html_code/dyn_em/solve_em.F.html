<HTML> <BODY BGCOLOR=#ddeeee LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!WRF:MEDIATION_LAYER:SOLVER<a name='2'></font>
<a name='3'>
<A NAME='SOLVE_EM'><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='4'>
<font color=#993300>SUBROUTINE </font><font color=#cc0000>solve_em</font> ( grid , config_flags  &amp; <A href='../../call_to/SOLVE_EM.html' TARGET='index'>1</A>,<A href='../../call_from/SOLVE_EM.html' TARGET='index'>252</A><a name='5'>
<font color=#447700>! Arguments generated from Registry<a name='6'></font>
#include "<A href='../../html_code/include/dummy_new_args.inc.html'>dummy_new_args.inc</A>"<A NAME="dummy_new_args.inc_1"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='7'>
<font color=#447700>!<a name='8'></font>
                    )<a name='9'>
<font color=#447700>! Driver layer modules<a name='10'></font>
   USE <A href='../../html_code/frame/module_state_description.F.html#MODULE_STATE_DESCRIPTION'>module_state_description</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_STATE_DESCRIPTION_16"><a name='11'>
   USE <A href='../../html_code/frame/module_domain.F.html#MODULE_DOMAIN'>module_domain</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_29">, ONLY : &amp;<a name='12'>
                  domain, get_ijk_from_grid, get_ijk_from_subgrid                          &amp;<a name='13'>
                 ,domain_get_current_time, domain_get_start_time                           &amp;<a name='14'>
                 ,domain_get_sim_start_time, domain_clock_get,is_alarm_tstep<a name='15'>
   USE <A href='../../html_code/frame/module_domain_type.F.html#MODULE_DOMAIN_TYPE'>module_domain_type</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DOMAIN_TYPE_3">, ONLY : history_alarm, restart_alarm, auxinput4_alarm            &amp;<a name='16'>
                 ,boundary_alarm<a name='17'>
   USE <A href='../../html_code/frame/module_configure.F.html#MODULE_CONFIGURE'>module_configure</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CONFIGURE_20">, ONLY : grid_config_rec_type<a name='18'>
   USE <A href='../../html_code/frame/module_driver_constants.F.html#MODULE_DRIVER_CONSTANTS'>module_driver_constants</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DRIVER_CONSTANTS_5"><a name='19'>
   USE <A href='../../html_code/frame/module_machine.F.html#MODULE_MACHINE'>module_machine</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MACHINE_4"><a name='20'>
   USE <A href='../../html_code/frame/module_tiles.F.html#MODULE_TILES'>module_tiles</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_TILES_4">, ONLY : set_tiles<a name='21'>
#ifdef DM_PARALLEL<a name='22'>
   USE <A href='../../html_code/frame/module_dm_stubs.F.html#MODULE_DM'>module_dm</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DM_20">, ONLY : &amp;<a name='23'>
                  local_communicator, mytask, ntasks, ntasks_x, ntasks_y                   &amp;<a name='24'>
                 ,local_communicator_periodic, wrf_dm_maxval<a name='25'>
   USE <A href='../../html_code/frame/module_comm_dm.F.html#MODULE_COMM_DM'>module_comm_dm</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_COMM_DM_10">, ONLY : &amp;<a name='26'>
                  halo_em_a_sub,halo_em_b_sub,halo_em_c2_sub,halo_em_chem_e_3_sub          &amp;<a name='27'>
                 ,halo_em_chem_e_5_sub,halo_em_chem_e_7_sub,halo_em_chem_old_e_5_sub       &amp;<a name='28'>
                 ,halo_em_chem_old_e_7_sub,halo_em_c_sub,halo_em_d2_3_sub                  &amp;<a name='29'>
                 ,halo_em_d2_5_sub,halo_em_d3_3_sub,halo_em_d3_5_sub,halo_em_d_sub         &amp;<a name='30'>
                 ,halo_em_e_3_sub,halo_em_e_5_sub,halo_em_hydro_uv_sub                     &amp;<a name='31'>
                 ,halo_em_moist_e_3_sub,halo_em_moist_e_5_sub,halo_em_moist_e_7_sub        &amp;<a name='32'>
                 ,halo_em_moist_old_e_5_sub,halo_em_moist_old_e_7_sub                      &amp;<a name='33'>
                 ,halo_em_scalar_e_3_sub,halo_em_scalar_e_5_sub,halo_em_scalar_e_7_sub     &amp;<a name='34'>
                 ,halo_em_scalar_old_e_5_sub,halo_em_scalar_old_e_7_sub,halo_em_tke_3_sub  &amp;<a name='35'>
                 ,halo_em_tke_5_sub,halo_em_tke_7_sub,halo_em_tke_advect_3_sub             &amp;<a name='36'>
                 ,halo_em_tke_advect_5_sub,halo_em_tke_old_e_5_sub                         &amp;<a name='37'>
                 ,halo_em_tke_old_e_7_sub,halo_em_tracer_e_3_sub,halo_em_tracer_e_5_sub    &amp;<a name='38'>
                 ,halo_em_tracer_e_7_sub,halo_em_tracer_old_e_5_sub                        &amp;<a name='39'>
                 ,halo_em_tracer_old_e_7_sub,halo_em_sbm_sub,period_bdy_em_a_sub                           &amp;<a name='40'>
                 ,period_bdy_em_b3_sub,period_bdy_em_b_sub,period_bdy_em_chem2_sub         &amp;<a name='41'>
                 ,period_bdy_em_chem_old_sub,period_bdy_em_chem_sub,period_bdy_em_d3_sub   &amp;<a name='42'>
                 ,period_bdy_em_d_sub,period_bdy_em_e_sub,period_bdy_em_moist2_sub         &amp;<a name='43'>
                 ,period_bdy_em_moist_old_sub,period_bdy_em_moist_sub                      &amp;<a name='44'>
                 ,period_bdy_em_scalar2_sub,period_bdy_em_scalar_old_sub                   &amp;<a name='45'>
                 ,period_bdy_em_scalar_sub,period_bdy_em_tke_old_sub, period_bdy_em_tke_sub  &amp;<a name='46'>
                 ,period_bdy_em_tracer2_sub,period_bdy_em_tracer_old_sub                   &amp;<a name='47'>
                 ,period_bdy_em_tracer_sub,period_em_da_sub,period_em_hydro_uv_sub         &amp;<a name='48'>
                 ,period_em_f_sub,period_em_g_sub                                          &amp;<a name='49'>
                 ,halo_em_f_1_sub,halo_em_init_4_sub,halo_em_thetam_sub,period_em_thetam_sub<a name='50'>
#endif<a name='51'>
   USE module_utility<a name='52'>
<font color=#447700>! Mediation layer modules<a name='53'></font>
<font color=#447700>! Model layer modules<a name='54'></font>
   USE <A href='../../html_code/share/module_model_constants.F.html#MODULE_MODEL_CONSTANTS'>module_model_constants</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MODEL_CONSTANTS_15"><a name='55'>
   USE <A href='../../html_code/dyn_em/module_small_step_em.F.html#MODULE_SMALL_STEP_EM'>module_small_step_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SMALL_STEP_EM_1"><a name='56'>
   USE <A href='../../html_code/dyn_em/module_em.F.html#MODULE_EM'>module_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_EM_3"><a name='57'>
   USE <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MODULE_BIG_STEP_UTILITIES_EM'>module_big_step_utilities_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BIG_STEP_UTILITIES_EM_4"><a name='58'>
   USE <A href='../../html_code/share/module_bc.F.html#MODULE_BC'>module_bc</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_10"><a name='59'>
   USE <A href='../../html_code/dyn_em/module_bc_em.F.html#MODULE_BC_EM'>module_bc_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_BC_EM_2"><a name='60'>
   USE <A href='../../html_code/dyn_em/module_solvedebug_em.F.html#MODULE_SOLVEDEBUG_EM'>module_solvedebug_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_SOLVEDEBUG_EM_1"><a name='61'>
   USE <A href='../../html_code/phys/module_physics_addtendc.F.html#MODULE_PHYSICS_ADDTENDC'>module_physics_addtendc</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_PHYSICS_ADDTENDC_2"><a name='62'>
   USE <A href='../../html_code/dyn_em/module_diffusion_em.F.html#MODULE_DIFFUSION_EM'>module_diffusion_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_DIFFUSION_EM_2"><a name='63'>
   USE <A href='../../html_code/dyn_em/module_polarfft.F.html#MODULE_POLARFFT'>module_polarfft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_POLARFFT_1"><a name='64'>
   USE <A href='../../html_code/phys/module_microphysics_driver.F.html#MODULE_MICROPHYSICS_DRIVER'>module_microphysics_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MICROPHYSICS_DRIVER_1"><a name='65'>
   USE <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MODULE_MICROPHYSICS_ZERO_OUT'>module_microphysics_zero_out</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_MICROPHYSICS_ZERO_OUT_1"><a name='66'>
<font color=#447700>!   USE module_lightning_driver, ONLY : lightning_driver<a name='67'></font>
   USE <A href='../../html_code/phys/module_fddaobs_driver.F.html#MODULE_FDDAOBS_DRIVER'>module_fddaobs_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_FDDAOBS_DRIVER_2"><a name='68'>
<font color=#447700>!   USE module_diagnostics<a name='69'></font>
#if (WRF_CHEM == 1)<a name='70'>
   USE module_input_chem_data<a name='71'>
   USE module_input_tracer<a name='72'>
   USE module_chem_utilities<a name='73'>
#endif<a name='74'>
   USE <A href='../../html_code/dyn_em/module_first_rk_step_part1.F.html#MODULE_FIRST_RK_STEP_PART1'>module_first_rk_step_part1</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_FIRST_RK_STEP_PART1_1"><a name='75'>
   USE <A href='../../html_code/dyn_em/module_first_rk_step_part2.F.html#MODULE_FIRST_RK_STEP_PART2'>module_first_rk_step_part2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_FIRST_RK_STEP_PART2_1"><a name='76'>
   USE <A href='../../html_code/dyn_em/module_after_all_rk_steps.F.html#MODULE_AFTER_ALL_RK_STEPS'>module_after_all_rk_steps</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_AFTER_ALL_RK_STEPS_1"><a name='77'>
   USE <A href='../../html_code/share/module_llxy.F.html#MODULE_LLXY'>module_llxy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_LLXY_3">, ONLY : proj_cassini<a name='78'>
   USE <A href='../../html_code/dyn_em/module_avgflx_em.F.html#MODULE_AVGFLX_EM'>module_avgflx_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_AVGFLX_EM_1">, ONLY : zero_avgflx, upd_avgflx<a name='79'>
   USE <A href='../../html_code/frame/module_cpl.F.html#MODULE_CPL'>module_cpl</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MODULE_CPL_1">, ONLY : coupler_on, cpl_settime, cpl_store_input<a name='80'>
<a name='81'>
   IMPLICIT NONE<a name='82'>
<a name='83'>
   <font color=#447700>!  Input data.<a name='84'></font>
<a name='85'>
   TYPE(domain) , TARGET          :: grid<a name='86'>
<a name='87'>
   <font color=#447700>!  Definitions of dummy arguments to this routine (generated from Registry).<a name='88'></font>
#include "<A href='../../html_code/include/dummy_new_decl.inc.html'>dummy_new_decl.inc</A>"<A NAME="dummy_new_decl.inc_2"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='89'>
<a name='90'>
   <font color=#447700>!  Structure that contains run-time configuration (namelist) data for domain<a name='91'></font>
   TYPE (grid_config_rec_type) , INTENT(IN)          :: config_flags<a name='92'>
<a name='93'>
   <font color=#447700>! Local data<a name='94'></font>
<a name='95'>
   INTEGER                         :: k_start , k_end, its, ite, jts, jte<a name='96'>
   INTEGER                         :: ids , ide , jds , jde , kds , kde , &amp;<a name='97'>
                                      ims , ime , jms , jme , kms , kme , &amp;<a name='98'>
                                      ips , ipe , jps , jpe , kps , kpe<a name='99'>
<a name='100'>
   INTEGER                         :: sids , side , sjds , sjde , skds , skde , &amp;<a name='101'>
                                      sims , sime , sjms , sjme , skms , skme , &amp;<a name='102'>
                                      sips , sipe , sjps , sjpe , skps , skpe<a name='103'>
<a name='104'>
<a name='105'>
   INTEGER ::              imsx, imex, jmsx, jmex, kmsx, kmex,    &amp;<a name='106'>
                           ipsx, ipex, jpsx, jpex, kpsx, kpex,    &amp;<a name='107'>
                           imsy, imey, jmsy, jmey, kmsy, kmey,    &amp;<a name='108'>
                           ipsy, ipey, jpsy, jpey, kpsy, kpey<a name='109'>
<a name='110'>
   INTEGER                         :: ij , iteration<a name='111'>
   INTEGER                         :: im , num_3d_m , ic , num_3d_c , is , num_3d_s<a name='112'>
   INTEGER                         :: loop<a name='113'>
   INTEGER                         :: sz<a name='114'>
   INTEGER                         :: iswater<a name='115'>
<a name='116'>
   LOGICAL                         :: specified_bdy, channel_bdy<a name='117'>
<a name='118'>
   REAL                            :: t_new, time_duration_of_lbcs<a name='119'>
   <a name='120'>
   <font color=#447700>! Changes in tendency at this timestep<a name='121'></font>
   real ,DIMENSION(grid%sm31:grid%em31,grid%sm32:grid%em32,grid%sm33:grid%em33) :: h_tendency, &amp;<a name='122'>
                                                                                   z_tendency<a name='123'>
                                                                                   <a name='124'>
   <font color=#447700>! Whether advection should produce decoupled horizontal and vertical advective tendency outputs<a name='125'></font>
   LOGICAL                        :: tenddec<a name='126'>
   <a name='127'>
   <font color=#447700>! Flag for producing diagnostic fields (e.g., radar reflectivity)<a name='128'></font>
   LOGICAL                        :: diag_flag<a name='129'>
   <a name='130'>
#if (WRF_CHEM == 1)<a name='131'>
   <font color=#447700>! Index cross-referencing array for tendency accumulation<a name='132'></font>
   INTEGER, DIMENSION( num_chem ) :: adv_ct_indices<a name='133'>
#endif<a name='134'>
<a name='135'>
<font color=#447700>! storage for tendencies and decoupled state (generated from Registry)<a name='136'></font>
<a name='137'>
#include "<A href='../../html_code/include/i1_decl.inc.html'>i1_decl.inc</A>"<A NAME="i1_decl.inc_3"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='138'>
<font color=#447700>! Previous time level of tracer arrays now defined as i1 variables;<a name='139'></font>
<font color=#447700>! the state 4d arrays now redefined as 1-time level arrays in Registry.<a name='140'></font>
<font color=#447700>! Benefit: save memory in nested runs, since only 1 domain is active at a<a name='141'></font>
<font color=#447700>! time.  Potential problem on stack-limited architectures: increases<a name='142'></font>
<font color=#447700>! amount of data on program stack by making these automatic arrays.<a name='143'></font>
<a name='144'>
   INTEGER :: rc <a name='145'>
   INTEGER :: number_of_small_timesteps, rk_step<a name='146'>
   INTEGER :: klevel,ijm,ijp,i,j,k,size1,size2    <font color=#447700>! for prints/plots only<a name='147'></font>
   INTEGER :: idum1, idum2, dynamics_option<a name='148'>
<a name='149'>
   INTEGER :: rk_order, iwmax, jwmax, kwmax<a name='150'>
   REAL :: dt_rk, dts_rk, dts, dtm, wmax<a name='151'>
   REAL , ALLOCATABLE , DIMENSION(:)  :: max_vert_cfl_tmp, max_horiz_cfl_tmp<a name='152'>
   LOGICAL :: leapfrog<a name='153'>
   INTEGER :: l,kte,kk<a name='154'>
   LOGICAL :: f_flux  <font color=#447700>! flag for computing averaged fluxes in cu_gd<a name='155'></font>
   REAL    :: curr_secs, curr_secs2<a name='156'>
   INTEGER :: num_sound_steps<a name='157'>
   INTEGER :: idex, jdex<a name='158'>
   REAL    :: max_msft<a name='159'>
   REAL    :: spacing<a name='160'>
<a name='161'>
   INTEGER :: ii, jj <font color=#447700>!kk is above after l,kte<a name='162'></font>
   REAL    :: dclat<a name='163'>
   INTEGER :: debug_level<a name='164'>
<a name='165'>
<font color=#447700>! urban related variables<a name='166'></font>
   INTEGER :: NUM_ROOF_LAYERS, NUM_WALL_LAYERS, NUM_ROAD_LAYERS   <font color=#447700>! urban<a name='167'></font>
<a name='168'>
   TYPE(WRFU_TimeInterval)                    :: tmpTimeInterval, tmpTimeInterval2<a name='169'>
   REAL                                       :: real_time<a name='170'>
   LOGICAL                                    :: adapt_step_flag<a name='171'>
   LOGICAL                                    :: fill_w_flag<a name='172'>
<a name='173'>
<font color=#447700>! variables for flux-averaging code 20091223<a name='174'></font>
   CHARACTER*256                              :: message, message2, message3<a name='175'>
   REAL                                       :: old_dt<a name='176'>
   TYPE(WRFU_Time)                            :: temp_time, CurrTime, restart_time<a name='177'>
   INTEGER, PARAMETER                         :: precision = 100<a name='178'>
   INTEGER                                    :: num, den<a name='179'>
   TYPE(WRFU_TimeInterval)                    :: dtInterval, intervaltime,restartinterval<a name='180'>
<a name='181'>
<font color=#447700>! Define benchmarking timers if -DBENCH is compiled<a name='182'></font>
#include "<A href='../../html_code/include/bench_solve_em_def.h.html'>bench_solve_em_def.h</A>"<A NAME="bench_solve_em_def.h_4"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='183'>
<a name='184'>
<font color=#447700>!----------------------<a name='185'></font>
<font color=#447700>! Executable statements<a name='186'></font>
<font color=#447700>!----------------------<a name='187'></font>
<a name='188'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='189'></font>
<font color=#447700>!&lt;pre&gt;<a name='190'></font>
<font color=#447700>! solve_em is the main driver for advancing a grid a single timestep.<a name='191'></font>
<font color=#447700>! It is a mediation-layer routine -&gt; DM and SM calls are made where <a name='192'></font>
<font color=#447700>! needed for parallel processing.  <a name='193'></font>
<font color=#447700>!<a name='194'></font>
<font color=#447700>! solve_em can integrate the equations using 3 time-integration methods<a name='195'></font>
<font color=#447700>!      <a name='196'></font>
<font color=#447700>!    - 3rd order Runge-Kutta time integration (recommended)<a name='197'></font>
<font color=#447700>!      <a name='198'></font>
<font color=#447700>!    - 2nd order Runge-Kutta time integration<a name='199'></font>
<font color=#447700>!      <a name='200'></font>
<font color=#447700>! The main sections of solve_em are<a name='201'></font>
<font color=#447700>!     <a name='202'></font>
<font color=#447700>! (1) Runge-Kutta (RK) loop<a name='203'></font>
<font color=#447700>!     <a name='204'></font>
<font color=#447700>! (2) Non-timesplit physics (i.e., tendencies computed for updating<a name='205'></font>
<font color=#447700>!     model state variables during the first RK sub-step (loop)<a name='206'></font>
<font color=#447700>!     <a name='207'></font>
<font color=#447700>! (3) Small (acoustic, sound) timestep loop - within the RK sub-steps<a name='208'></font>
<font color=#447700>!     <a name='209'></font>
<font color=#447700>! (4) scalar advance for moist and chem scalar variables (and TKE)<a name='210'></font>
<font color=#447700>!     within the RK sub-steps.<a name='211'></font>
<font color=#447700>!     <a name='212'></font>
<font color=#447700>! (5) time-split physics (after the RK step), currently this includes<a name='213'></font>
<font color=#447700>!     only microphyics<a name='214'></font>
<font color=#447700>!<a name='215'></font>
<font color=#447700>! A more detailed description of these sections follows.<a name='216'></font>
<font color=#447700>!&lt;/pre&gt;<a name='217'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='218'></font>
<a name='219'>
<font color=#447700>! Initialize timers if compiled with -DBENCH<a name='220'></font>
#include "<A href='../../html_code/include/bench_solve_em_init.h.html'>bench_solve_em_init.h</A>"<A NAME="bench_solve_em_init.h_5"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='221'>
<a name='222'>
<font color=#447700>!  set runge-kutta solver (2nd or 3rd order)<a name='223'></font>
<a name='224'>
   dynamics_option = config_flags%rk_ord<a name='225'>
<a name='226'>
<font color=#447700>!  Obtain dimension information stored in the grid data structure.<a name='227'></font>
<a name='228'>
   CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_GRID'>get_ijk_from_grid</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_GRID_10"> (  grid ,                   &amp;<a name='229'>
                             ids, ide, jds, jde, kds, kde,    &amp;<a name='230'>
                             ims, ime, jms, jme, kms, kme,    &amp;<a name='231'>
                             ips, ipe, jps, jpe, kps, kpe,    &amp;<a name='232'>
                             imsx, imex, jmsx, jmex, kmsx, kmex,    &amp;<a name='233'>
                             ipsx, ipex, jpsx, jpex, kpsx, kpex,    &amp;<a name='234'>
                             imsy, imey, jmsy, jmey, kmsy, kmey,    &amp;<a name='235'>
                             ipsy, ipey, jpsy, jpey, kpsy, kpey )<a name='236'>
 <a name='237'>
   CALL <A href='../../html_code/frame/module_domain.F.html#GET_IJK_FROM_SUBGRID'>get_ijk_from_subgrid</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_IJK_FROM_SUBGRID_2"> (  grid ,                   &amp;<a name='238'>
                             sids, side, sjds, sjde, skds, skde,    &amp;<a name='239'>
                             sims, sime, sjms, sjme, skms, skme,    &amp;<a name='240'>
                             sips, sipe, sjps, sjpe, skps, skpe    )<a name='241'>
   k_start         = kps<a name='242'>
   k_end           = kpe<a name='243'>
<a name='244'>
   num_3d_m        = num_moist<a name='245'>
   num_3d_c        = num_chem<a name='246'>
   num_3d_s        = num_scalar<a name='247'>
<a name='248'>
<font color=#447700>!  backward integration needs to advect only QV<a name='249'></font>
   if (grid%dfi_stage .EQ. DFI_BCK) then<a name='250'>
       num_3d_m    = P_QV<a name='251'>
       num_3d_s    = PARAM_FIRST_SCALAR - 1<a name='252'>
   endif<a name='253'>
<a name='254'>
   f_flux = config_flags%do_avgflx_cugd .EQ. 1<a name='255'>
<a name='256'>
<font color=#447700>!  Compute these starting and stopping locations for each tile and number of tiles.<a name='257'></font>
<font color=#447700>!  See: http://www.mmm.ucar.edu/wrf/WG2/topics/settiles<a name='258'></font>
   CALL <A href='../../html_code/frame/module_tiles.F.html#SET_TILES'>set_tiles</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_TILES_2"> ( ZONE_SOLVE_EM, grid , ids , ide , jds , jde , ips , ipe , jps , jpe )<a name='259'>
<font color=#447700>!   CALL set_tiles (  grid , ids , ide , jds , jde , ips , ipe , jps , jpe )<a name='260'></font>
<a name='261'>
<font color=#447700>!  Max values of CFL for adaptive time step scheme<a name='262'></font>
<a name='263'>
   ALLOCATE (max_vert_cfl_tmp(grid%num_tiles))<a name='264'>
   ALLOCATE (max_horiz_cfl_tmp(grid%num_tiles))<a name='265'>
<a name='266'>
  <font color=#447700>!<a name='267'></font>
  <font color=#447700>! Calculate current time in seconds since beginning of model run.<a name='268'></font>
  <font color=#447700>!   Unfortunately, ESMF does not seem to have a way to return<a name='269'></font>
  <font color=#447700>!   floating point seconds based on a TimeInterval.  So, we will<a name='270'></font>
  <font color=#447700>!   calculate it here--but, this is not clean!!<a name='271'></font>
  <font color=#447700>!<a name='272'></font>
   tmpTimeInterval  = domain_get_current_time ( grid ) - domain_get_sim_start_time ( grid )<a name='273'>
   tmpTimeInterval2 = domain_get_current_time ( grid ) - domain_get_start_time ( grid )<a name='274'>
   curr_secs  = <A href='../../html_code/dyn_em/adapt_timestep_em.F.html#REAL_TIME'>real_time</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REAL_TIME_7">(tmpTimeInterval)<a name='275'>
   curr_secs2 = <A href='../../html_code/dyn_em/adapt_timestep_em.F.html#REAL_TIME'>real_time</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REAL_TIME_8">(tmpTimeInterval2)<a name='276'>
<a name='277'>
   old_dt = grid%dt   <font color=#447700>! store old time step for flux averaging code at end of RK loop<a name='278'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='279'></font>
<font color=#447700>! Adaptive time step: Added by T. Hutchinson, WSI  3/5/07<a name='280'></font>
<font color=#447700>!   In this call, we do the time-step adaptation and set time-dependent lateral<a name='281'></font>
<font color=#447700>!   boundary condition nudging weights.<a name='282'></font>
<font color=#447700>!<a name='283'></font>
   IF ( (config_flags%use_adaptive_time_step) .and. &amp;<a name='284'>
        ( (.not. grid%nested) .or. &amp;<a name='285'>
        ( (grid%nested) .and. (abs(grid%dtbc) &lt; 0.0001) ) ) )THEN<a name='286'>
      CALL <A href='../../html_code/dyn_em/adapt_timestep_em.F.html#ADAPT_TIMESTEP'>adapt_timestep</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADAPT_TIMESTEP_2">(grid, config_flags)<a name='287'>
      adapt_step_flag = .TRUE.<a name='288'>
   ELSE<a name='289'>
      adapt_step_flag = .FALSE.<a name='290'>
   ENDIF<a name='291'>
<font color=#447700>! End of adaptive time step modifications<a name='292'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='293'></font>
<font color=#447700>!<a name='294'></font>
<font color=#447700>! Set diagnostic flag value history output time<a name='295'></font>
<font color=#447700>!-----------------------------------------------------------------------------<a name='296'></font>
<font color=#447700>!  if ( Is_alarm_tstep(grid_clock, grid_alarms(HISTORY_ALARM)) ) then<a name='297'></font>
      diag_flag = .false.<a name='298'>
   if ( Is_alarm_tstep(grid%domain_clock, grid%alarms(HISTORY_ALARM)) ) then<a name='299'>
      diag_flag = .true.<a name='300'>
   endif<a name='301'>
<a name='302'>
   grid%itimestep = grid%itimestep + 1<a name='303'>
   grid%dtbc = grid%dtbc + grid%dt<a name='304'>
<a name='305'>
   IF( coupler_on ) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_STORE_INPUT'>cpl_store_input</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_STORE_INPUT_1">( grid, config_flags )<a name='306'>
<a name='307'>
   IF (config_flags%polar) dclat = 90./REAL(jde-jds) <font color=#447700>!(0.5 * 180/ny)<a name='308'></font>
<a name='309'>
#if (WRF_CHEM == 1)<a name='310'>
<a name='311'>
   kte=min(k_end,kde-1)<a name='312'>
# ifdef DM_PARALLEL<a name='313'>
   if ( num_chem &gt;= PARAM_FIRST_SCALAR ) then<a name='314'>
<font color=#447700>!-----------------------------------------------------------------------<a name='315'></font>
<font color=#447700>! see matching halo calls below for stencils<a name='316'></font>
<font color=#447700>!--------------------------------------------------------------<a name='317'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_CHEM' )<a name='318'>
     IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='319'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_6"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='320'>
       IF( config_flags%progn &gt; 0 ) THEN<a name='321'>
#         include "<A href='../../html_code/include/HALO_EM_SCALAR_E_3.inc.html'>HALO_EM_SCALAR_E_3.inc</A>"<A NAME="HALO_EM_SCALAR_E_3.inc_7"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='322'>
       ENDIF<a name='323'>
       IF( config_flags%cu_physics == CAMZMSCHEME ) THEN<a name='324'>
#         include "<A href='../../html_code/include/HALO_EM_SCALAR_E_3.inc.html'>HALO_EM_SCALAR_E_3.inc</A>"<A NAME="HALO_EM_SCALAR_E_3.inc_8"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='325'>
       ENDIF<a name='326'>
     ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='327'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_9"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='328'>
       IF( config_flags%cu_physics == CAMZMSCHEME ) THEN<a name='329'>
#         include "<A href='../../html_code/include/HALO_EM_SCALAR_E_5.inc.html'>HALO_EM_SCALAR_E_5.inc</A>"<A NAME="HALO_EM_SCALAR_E_5.inc_10"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='330'>
       ENDIF<a name='331'>
       IF( config_flags%progn &gt; 0 ) THEN<a name='332'>
#         include "<A href='../../html_code/include/HALO_EM_SCALAR_E_5.inc.html'>HALO_EM_SCALAR_E_5.inc</A>"<A NAME="HALO_EM_SCALAR_E_5.inc_11"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='333'>
      ENDIF<a name='334'>
     ELSE<a name='335'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='336'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_47">(TRIM(wrf_err_message))<a name='337'>
     ENDIF<a name='338'>
   ENDIF<a name='339'>
   if ( num_tracer &gt;= PARAM_FIRST_SCALAR ) then<a name='340'>
<font color=#447700>!-----------------------------------------------------------------------<a name='341'></font>
<font color=#447700>! see matching halo calls below for stencils<a name='342'></font>
<font color=#447700>!--------------------------------------------------------------<a name='343'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_tracer' )<a name='344'>
     IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='345'>
#      include "<A href='../../html_code/include/HALO_EM_TRACER_E_3.inc.html'>HALO_EM_TRACER_E_3.inc</A>"<A NAME="HALO_EM_TRACER_E_3.inc_12"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='346'>
     ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='347'>
#      include "<A href='../../html_code/include/HALO_EM_TRACER_E_5.inc.html'>HALO_EM_TRACER_E_5.inc</A>"<A NAME="HALO_EM_TRACER_E_5.inc_13"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='348'>
     ELSE<a name='349'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='350'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_48">(TRIM(wrf_err_message))<a name='351'>
     ENDIF<a name='352'>
   ENDIF<a name='353'>
# endif<a name='354'>
<font color=#447700>!--------------------------------------------------------------<a name='355'></font>
   adv_ct_indices(   :  ) = 1<a name='356'>
   IF ( config_flags%chemdiag == USECHEMDIAG ) THEN<a name='357'>
   <font color=#447700>! modify tendency list here<a name='358'></font>
   <font color=#447700>! note that the referencing direction here is opposite of that in chem_driver<a name='359'></font>
       adv_ct_indices(p_co  ) = p_advh_co<a name='360'>
       adv_ct_indices(p_o3  ) = p_advh_o3<a name='361'>
       adv_ct_indices(p_no  ) = p_advh_no<a name='362'>
       adv_ct_indices(p_no2 ) = p_advh_no2<a name='363'>
       adv_ct_indices(p_hno3) = p_advh_hno3<a name='364'>
       adv_ct_indices(p_iso ) = p_advh_iso<a name='365'>
       adv_ct_indices(p_ho  ) = p_advh_ho<a name='366'>
       adv_ct_indices(p_ho2 ) = p_advh_ho2<a name='367'>
   END IF<a name='368'>
#endif<a name='369'>
<a name='370'>
   rk_order = config_flags%rk_ord<a name='371'>
<a name='372'>
   IF ( grid%time_step_sound == 0 ) THEN<a name='373'>
<font color=#447700>! This function will give 4 for 6*dx and 6 for 10*dx and returns even numbers only<a name='374'></font>
     spacing = min(grid%dx, grid%dy)<a name='375'>
     IF ( ( config_flags%use_adaptive_time_step ) .AND. ( config_flags%map_proj == PROJ_CASSINI ) ) THEN<a name='376'>
       max_msft=MIN ( MAX(grid%max_msftx, grid%max_msfty) , &amp;<a name='377'>
                      1.0/COS(config_flags%fft_filter_lat*degrad) )<a name='378'>
       num_sound_steps = max ( 2 * ( INT (300. * grid%dt / (spacing / max_msft) - 0.01 ) + 1 ), 4 )<a name='379'>
     ELSE IF  ( config_flags%use_adaptive_time_step ) THEN<a name='380'>
       max_msft= MAX(grid%max_msftx, grid%max_msfty)<a name='381'>
       num_sound_steps = max ( 2 * ( INT (300. * grid%dt / (spacing / max_msft) - 0.01 ) + 1 ), 4 )<a name='382'>
     ELSE<a name='383'>
       num_sound_steps = max ( 2 * ( INT (300. * grid%dt /  spacing             - 0.01 ) + 1 ), 4 )<a name='384'>
     END IF<a name='385'>
     WRITE(wrf_err_message,*)'grid spacing, dt, time_step_sound=',spacing,grid%dt,num_sound_steps<a name='386'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_30"> ( 50 , wrf_err_message )<a name='387'>
   ELSE<a name='388'>
     num_sound_steps = grid%time_step_sound<a name='389'>
   ENDIF<a name='390'>
<a name='391'>
   dts = grid%dt/float(num_sound_steps)<a name='392'>
<a name='393'>
   IF (config_flags%use_adaptive_time_step) THEN<a name='394'>
  <a name='395'>
     CALL <A href='../../html_code/frame/wrf_debug.F.html#GET_WRF_DEBUG_LEVEL'>get_wrf_debug_level</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="GET_WRF_DEBUG_LEVEL_1">( debug_level )<a name='396'>
     IF ((config_flags%time_step &lt; 0) .AND. (debug_level.GE.50)) THEN<a name='397'>
#ifdef DM_PARALLEL<a name='398'>
       CALL <A href='../../html_code/frame/module_dm_stubs.F.html#WRF_DM_MAXVAL'>wrf_dm_maxval</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DM_MAXVAL_2">(grid%max_vert_cfl, idex, jdex)<a name='399'>
#endif<a name='400'>
       WRITE(wrf_err_message,*)'variable dt, max horiz cfl, max vert cfl: ',&amp;<a name='401'>
            grid%dt, grid%max_horiz_cfl, grid%max_vert_cfl<a name='402'>
       CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_31"> ( 0 , wrf_err_message )<a name='403'>
     ENDIF<a name='404'>
<a name='405'>
     grid%max_cfl_val = 0<a name='406'>
     grid%max_horiz_cfl = 0<a name='407'>
     grid%max_vert_cfl = 0<a name='408'>
   ENDIF<a name='409'>
<a name='410'>
<font color=#447700>! setting bdy tendencies to zero for DFI if constant_bc = true<a name='411'></font>
<a name='412'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='413'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='414'></font>
     DO ij = 1 , grid%num_tiles<a name='415'>
<a name='416'>
<font color=#447700>!      IF( config_flags%specified .AND. grid%dfi_opt .NE. DFI_NODFI   &amp;<a name='417'></font>
<font color=#447700>!          .AND. config_flags%constant_bc .AND. (grid%dfi_stage .EQ. DFI_BCK .OR. grid%dfi_stage .EQ. DFI_FWD) ) THEN<a name='418'></font>
       IF( config_flags%specified .AND. config_flags%constant_bc ) THEN<a name='419'>
<a name='420'>
       CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#ZERO_BDYTEND'>zero_bdytend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_BDYTEND_1"> (grid%u_btxs,grid%u_btxe,grid%u_btys,grid%u_btye,     &amp;<a name='421'>
                          grid%v_btxs,grid%v_btxe,grid%v_btys,grid%v_btye,     &amp;<a name='422'>
                          grid%ph_btxs,grid%ph_btxe,grid%ph_btys,grid%ph_btye, &amp;<a name='423'>
                          grid%t_btxs,grid%t_btxe,grid%t_btys,grid%t_btye,     &amp;<a name='424'>
                          grid%w_btxs,grid%w_btxe,grid%w_btys,grid%w_btye,     &amp;<a name='425'>
                          grid%mu_btxs,grid%mu_btxe,grid%mu_btys,grid%mu_btye, &amp;<a name='426'>
                          moist_btxs,moist_btxe,                               &amp;<a name='427'>
                          moist_btys,moist_btye,                               &amp;<a name='428'>
                          scalar_btxs,scalar_btxe,                              &amp;<a name='429'>
                          scalar_btys,scalar_btye,                              &amp;<a name='430'>
                          grid%spec_bdy_width,num_3d_m,num_3d_s,                &amp;<a name='431'>
                          ids,ide, jds,jde, kds,kde,                   &amp;<a name='432'>
                          ims,ime, jms,jme, kms,kme,                   &amp;<a name='433'>
                          ips,ipe, jps,jpe, kps,kpe,                   &amp;<a name='434'>
                          grid%i_start(ij), grid%i_end(ij),            &amp;<a name='435'>
                          grid%j_start(ij), grid%j_end(ij),            &amp;<a name='436'>
                          k_start, k_end                               )<a name='437'>
<a name='438'>
       ENDIF<a name='439'>
<a name='440'>
       <font color=#447700>!  If the user has requested to optionally select the moist theta (use_theta_m==1)<a name='441'></font>
       <font color=#447700>!  switch, the first setting of the "old" value of theta_m uses the "old"<a name='442'></font>
       <font color=#447700>!  value of Qv.  The moist_old variable does not exist until after the advection<a name='443'></font>
       <font color=#447700>!  towards the end of the RK loop.  For the first time in the RK loop, we need<a name='444'></font>
       <font color=#447700>!  a reasonable value for moist_old.<a name='445'></font>
<a name='446'>
       IF ( ( config_flags%use_theta_m .EQ. 1 ) .AND. (P_Qv .GE. PARAM_FIRST_SCALAR) ) THEN<a name='447'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#INITIALIZE_MOIST_OLD'>initialize_moist_old</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INITIALIZE_MOIST_OLD_1"> ( moist_old(:,:,:,P_Qv),              &amp;<a name='448'>
                            moist(:,:,:,P_Qv) ,                          &amp;<a name='449'>
                            ids,ide, jds,jde, kds,kde,                   &amp;<a name='450'>
                            ims,ime, jms,jme, kms,kme,                   &amp;<a name='451'>
                            grid%i_start(ij), grid%i_end(ij),            &amp;<a name='452'>
                            grid%j_start(ij), grid%j_end(ij),            &amp;<a name='453'>
                            k_start, k_end                               )<a name='454'>
       END IF<a name='455'>
     ENDDO<a name='456'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='457'></font>
<a name='458'>
     <font color=#447700>!  Now that we might have initialized the moist_old values for P_Qv, fill<a name='459'></font>
     <font color=#447700>!  out some halos, etc.<a name='460'></font>
     IF ( ( config_flags%use_theta_m .EQ. 1 ) .AND. (P_Qv .GE. PARAM_FIRST_SCALAR) ) THEN<a name='461'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='462'></font>
#  include "<A href='../../html_code/include/HALO_EM_MOIST_OLD_E_7.inc.html'>HALO_EM_MOIST_OLD_E_7.inc</A>"<A NAME="HALO_EM_MOIST_OLD_E_7.inc_14"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='463'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST_OLD.inc.html'>PERIOD_BDY_EM_MOIST_OLD.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST_OLD.inc_15"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='464'>
#endif<a name='465'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='466'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='467'></font>
       DO ij = 1 , grid%num_tiles<a name='468'>
         im = P_Qv<a name='469'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_88">( moist_old(ims,kms,jms,im), 'p', config_flags,  &amp;<a name='470'>
                                 ids, ide, jds, jde, kds, kde,                  &amp;<a name='471'>
                                 ims, ime, jms, jme, kms, kme,                  &amp;<a name='472'>
                                 ips, ipe, jps, jpe, kps, kpe,                  &amp;<a name='473'>
                                 grid%i_start(ij), grid%i_end(ij),              &amp;<a name='474'>
                                 grid%j_start(ij), grid%j_end(ij),              &amp;<a name='475'>
                                 k_start    , k_end                             )<a name='476'>
       END DO<a name='477'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='478'></font>
     END IF<a name='479'>
<a name='480'>
<font color=#447700>!**********************************************************************<a name='481'></font>
<font color=#447700>!<a name='482'></font>
<font color=#447700>!  LET US BEGIN.......<a name='483'></font>
<font color=#447700>!<a name='484'></font>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='485'></font>
<font color=#447700>!&lt;pre&gt;<a name='486'></font>
<font color=#447700>! (1) RK integration loop is named the "Runge_Kutta_loop:"<a name='487'></font>
<font color=#447700>!<a name='488'></font>
<font color=#447700>!   Predictor-corrector type time integration.<a name='489'></font>
<font color=#447700>!   Advection terms are evaluated at time t for the predictor step,<a name='490'></font>
<font color=#447700>!   and advection is re-evaluated with the latest predicted value for<a name='491'></font>
<font color=#447700>!   each succeeding time corrector step<a name='492'></font>
<font color=#447700>!<a name='493'></font>
<font color=#447700>!   2nd order Runge Kutta (rk_order = 2):<a name='494'></font>
<font color=#447700>!   Step 1 is taken to the midpoint predictor, step 2 is the full step.<a name='495'></font>
<font color=#447700>!<a name='496'></font>
<font color=#447700>!   3rd order Runge Kutta (rk_order = 3):<a name='497'></font>
<font color=#447700>!   Step 1 is taken to from t to dt/3, step 2 is from t to dt/2,<a name='498'></font>
<font color=#447700>!   and step 3 is from t to dt.<a name='499'></font>
<font color=#447700>!<a name='500'></font>
<font color=#447700>!   non-timesplit physics are evaluated during first RK step and<a name='501'></font>
<font color=#447700>!   these physics tendencies are stored for use in each RK pass.<a name='502'></font>
<font color=#447700>!&lt;/pre&gt;<a name='503'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='504'></font>
<font color=#447700>!**********************************************************************<a name='505'></font>
<a name='506'>
   Runge_Kutta_loop:  DO rk_step = 1, rk_order<a name='507'>
<a name='508'>
   <font color=#447700>!  Set the step size and number of small timesteps for<a name='509'></font>
   <font color=#447700>!  each part of the timestep<a name='510'></font>
<a name='511'>
     dtm = grid%dt<a name='512'>
     IF ( rk_order == 1 ) THEN   <a name='513'>
<a name='514'>
       write(wrf_err_message,*)' leapfrog removed, error exit for dynamics_option = ',dynamics_option<a name='515'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_49">( wrf_err_message )<a name='516'>
<a name='517'>
     ELSE IF ( rk_order == 2 ) THEN   <font color=#447700>! 2nd order Runge-Kutta timestep<a name='518'></font>
<a name='519'>
       IF ( rk_step == 1) THEN<a name='520'>
         dt_rk  = 0.5*grid%dt<a name='521'>
         dts_rk = dts<a name='522'>
         number_of_small_timesteps = num_sound_steps/2<a name='523'>
       ELSE<a name='524'>
         dt_rk = grid%dt<a name='525'>
         dts_rk = dts<a name='526'>
         number_of_small_timesteps = num_sound_steps<a name='527'>
       ENDIF<a name='528'>
<a name='529'>
     ELSE IF ( rk_order == 3 ) THEN <font color=#447700>! third order Runge-Kutta<a name='530'></font>
<a name='531'>
       IF ( rk_step == 1) THEN<a name='532'>
         dt_rk = grid%dt/3.<a name='533'>
         dts_rk = dt_rk<a name='534'>
         number_of_small_timesteps = 1<a name='535'>
       ELSE IF (rk_step == 2) THEN<a name='536'>
         dt_rk  = 0.5*grid%dt<a name='537'>
         dts_rk = dts<a name='538'>
         number_of_small_timesteps = num_sound_steps/2<a name='539'>
       ELSE<a name='540'>
         dt_rk = grid%dt<a name='541'>
         dts_rk = dts<a name='542'>
         number_of_small_timesteps = num_sound_steps<a name='543'>
       ENDIF<a name='544'>
<a name='545'>
     ELSE<a name='546'>
<a name='547'>
       write(wrf_err_message,*)' unknown solver, error exit for dynamics_option = ',dynamics_option<a name='548'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_50">( wrf_err_message )<a name='549'>
<a name='550'>
     END IF<a name='551'>
<a name='552'>
<font color=#447700>!  Ensure that polar meridional velocity is zero<a name='553'></font>
     IF (config_flags%polar) THEN <a name='554'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='555'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='556'></font>
       DO ij = 1 , grid%num_tiles<a name='557'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_POLE'>zero_pole</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_POLE_1"> ( grid%v_1,                      &amp;<a name='558'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='559'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='560'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='561'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='562'>
                          k_start, k_end                   )<a name='563'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#ZERO_POLE'>zero_pole</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_POLE_2"> ( grid%v_2,                      &amp;<a name='564'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='565'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='566'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='567'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='568'>
                          k_start, k_end                   )<a name='569'>
       END DO<a name='570'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='571'></font>
     END IF<a name='572'>
<font color=#447700>!<a name='573'></font>
<font color=#447700>!  Time level t is in the *_2 variable in the first part <a name='574'></font>
<font color=#447700>!  of the step, and in the *_1 variable after the predictor.<a name='575'></font>
<font color=#447700>!  the latest predicted values are stored in the *_2 variables.<a name='576'></font>
<font color=#447700>!<a name='577'></font>
     CALL wrf_debug ( 200 , ' call rk_step_prep ' )<a name='578'>
<a name='579'>
BENCH_START(step_prep_tim)<a name='580'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='581'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='582'></font>
<a name='583'>
     DO ij = 1 , grid%num_tiles<a name='584'>
<a name='585'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_STEP_PREP'>rk_step_prep</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_STEP_PREP_1">  ( config_flags, rk_step,            &amp;<a name='586'>
                            grid%u_2, grid%v_2, grid%w_2, grid%t_2, grid%ph_2, grid%mu_2,   &amp;<a name='587'>
                            grid%c1h, grid%c2h, grid%c1f, grid%c2f, moist,   &amp;<a name='588'>
                            grid%ru, grid%rv, grid%rw, grid%ww, grid%php, grid%alt, grid%muu, grid%muv,   &amp;<a name='589'>
                            grid%mub, grid%mut, grid%phb, grid%pb, grid%p, grid%al, grid%alb,    &amp;<a name='590'>
                            cqu, cqv, cqw,                    &amp;<a name='591'>
                            grid%msfux, grid%msfuy, grid%msfvx, grid%msfvx_inv,        &amp;<a name='592'>
                            grid%msfvy, grid%msftx, grid%msfty,                        &amp;<a name='593'>
                            grid%fnm, grid%fnp, grid%dnw, grid%rdx, grid%rdy,          &amp;<a name='594'>
                            num_3d_m,                         &amp;<a name='595'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='596'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='597'>
                            grid%i_start(ij), grid%i_end(ij), &amp;<a name='598'>
                            grid%j_start(ij), grid%j_end(ij), &amp;<a name='599'>
                            k_start, k_end                   )<a name='600'>
<a name='601'>
     END DO<a name='602'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='603'></font>
BENCH_END(step_prep_tim)<a name='604'>
<a name='605'>
#ifdef DM_PARALLEL<a name='606'>
<font color=#447700>!-----------------------------------------------------------------------<a name='607'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='608'></font>
<font color=#447700>!  Note:  the small size of this halo exchange reflects the <a name='609'></font>
<font color=#447700>!         fact that we are carrying the uncoupled variables <a name='610'></font>
<font color=#447700>!         as state variables in the mass coordinate model, as<a name='611'></font>
<font color=#447700>!         opposed to the coupled variables as in the height<a name='612'></font>
<font color=#447700>!         coordinate model.<a name='613'></font>
<font color=#447700>!<a name='614'></font>
<font color=#447700>!                           * * * * *<a name='615'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='616'></font>
<font color=#447700>!       * + *      * + *    * * + * * <a name='617'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='618'></font>
<font color=#447700>!                           * * * * *<a name='619'></font>
<font color=#447700>!<a name='620'></font>
<font color=#447700>!  3D variables - note staggering!  ru(X), rv(Y), ww(Z), php(Z)<a name='621'></font>
<font color=#447700>!<a name='622'></font>
<font color=#447700>!  ru     x<a name='623'></font>
<font color=#447700>!  rv     x<a name='624'></font>
<font color=#447700>!  ww     x<a name='625'></font>
<font color=#447700>!  php    x<a name='626'></font>
<font color=#447700>!  alt    x<a name='627'></font>
<font color=#447700>!  ph_2   x<a name='628'></font>
<font color=#447700>!  phb    x<a name='629'></font>
<font color=#447700>!<a name='630'></font>
<font color=#447700>!  the following are 2D (xy) variables<a name='631'></font>
<font color=#447700>!<a name='632'></font>
<font color=#447700>!  muu    x<a name='633'></font>
<font color=#447700>!  muv    x<a name='634'></font>
<font color=#447700>!  mut    x<a name='635'></font>
<font color=#447700>!--------------------------------------------------------------<a name='636'></font>
#    include "<A href='../../html_code/include/HALO_EM_A.inc.html'>HALO_EM_A.inc</A>"<A NAME="HALO_EM_A.inc_16"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='637'>
#endif<a name='638'>
<a name='639'>
<font color=#447700>! set boundary conditions on variables <a name='640'></font>
<font color=#447700>! from big_step_prep for use in big_step_proc<a name='641'></font>
<a name='642'>
#ifdef DM_PARALLEL<a name='643'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_A.inc.html'>PERIOD_BDY_EM_A.inc</A>"<A NAME="PERIOD_BDY_EM_A.inc_17"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='644'>
#endif<a name='645'>
<a name='646'>
BENCH_START(set_phys_bc_tim)<a name='647'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='648'></font>
     <font color=#447700>!$OMP PRIVATE ( ij, ii, jj, kk )<a name='649'></font>
<a name='650'>
     DO ij = 1 , grid%num_tiles<a name='651'>
<a name='652'>
       CALL wrf_debug ( 200 , ' call rk_phys_bc_dry_1' )<a name='653'>
<a name='654'>
       CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RK_PHYS_BC_DRY_1'>rk_phys_bc_dry_1</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_PHYS_BC_DRY_1_1">( config_flags, grid%ru, grid%rv, grid%rw, grid%ww,      &amp; <a name='655'>
                              grid%muu, grid%muv, grid%mut, grid%php, grid%alt, grid%p,        &amp;<a name='656'>
                              ids, ide, jds, jde, kds, kde,      &amp;<a name='657'>
                              ims, ime, jms, jme, kms, kme,      &amp;<a name='658'>
                              ips, ipe, jps, jpe, kps, kpe,      &amp;<a name='659'>
                              grid%i_start(ij), grid%i_end(ij),  &amp;<a name='660'>
                              grid%j_start(ij), grid%j_end(ij),  &amp;<a name='661'>
                              k_start, k_end                )<a name='662'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_89">( grid%al, 'p', config_flags,            &amp;<a name='663'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='664'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='665'>
                              ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='666'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='667'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='668'>
                              k_start    , k_end               )<a name='669'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_90">( grid%ph_2, 'w', config_flags,            &amp;<a name='670'>
                              ids, ide, jds, jde, kds, kde, &amp;<a name='671'>
                              ims, ime, jms, jme, kms, kme, &amp;<a name='672'>
                              ips, ipe, jps, jpe, kps, kpe, &amp;<a name='673'>
                              grid%i_start(ij), grid%i_end(ij),        &amp;<a name='674'>
                              grid%j_start(ij), grid%j_end(ij),        &amp;<a name='675'>
                              k_start, k_end                )<a name='676'>
<a name='677'>
       IF (config_flags%polar) THEN <a name='678'>
<a name='679'>
<font color=#447700>!-------------------------------------------------------<a name='680'></font>
<font color=#447700>! lat-lon grid pole-point (v) specification (extrapolate v, rv to the pole)<a name='681'></font>
<font color=#447700>!-------------------------------------------------------<a name='682'></font>
<a name='683'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#POLE_POINT_BC'>pole_point_bc</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLE_POINT_BC_1"> ( grid%v_1,                      &amp;<a name='684'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='685'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='686'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='687'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='688'>
                              k_start, k_end                   )<a name='689'>
 <a name='690'>
         CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#POLE_POINT_BC'>pole_point_bc</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="POLE_POINT_BC_2"> ( grid%v_2,                      &amp;<a name='691'>
                              ids, ide, jds, jde, kds, kde,     &amp;<a name='692'>
                              ims, ime, jms, jme, kms, kme,     &amp;<a name='693'>
                              grid%i_start(ij), grid%i_end(ij), &amp;<a name='694'>
                              grid%j_start(ij), grid%j_end(ij), &amp;<a name='695'>
                              k_start, k_end                   )<a name='696'>
 <a name='697'>
<font color=#447700>!-------------------------------------------------------<a name='698'></font>
<font color=#447700>! end lat-lon grid pole-point (v) specification<a name='699'></font>
<font color=#447700>!-------------------------------------------------------<a name='700'></font>
<a name='701'>
       ENDIF<a name='702'>
     END DO<a name='703'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='704'></font>
BENCH_END(set_phys_bc_tim)<a name='705'>
<a name='706'>
     rk_step_is_one : IF (rk_step == 1) THEN <font color=#447700>! only need to initialize diffusion tendencies<a name='707'></font>
<a name='708'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='709'></font>
<font color=#447700>!&lt;pre&gt;<a name='710'></font>
<font color=#447700>!(2) The non-timesplit physics begins with a call to "phy_prep"<a name='711'></font>
<font color=#447700>!    (which computes some diagnostic variables such as temperature,<a name='712'></font>
<font color=#447700>!    pressure, u and v at p points, etc).  This is followed by<a name='713'></font>
<font color=#447700>!    calls to the physics drivers:<a name='714'></font>
<font color=#447700>!<a name='715'></font>
<font color=#447700>!              radiation,<a name='716'></font>
<font color=#447700>!              surface,<a name='717'></font>
<font color=#447700>!              pbl,<a name='718'></font>
<font color=#447700>!              cumulus,<a name='719'></font>
<font color=#447700>!              fddagd,<a name='720'></font>
<font color=#447700>!              3D TKE and mixing.<a name='721'></font>
<font color=#447700>!&lt;pre&gt;<a name='722'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='723'></font>
<a name='724'>
       IF (coupler_on) CALL <A href='../../html_code/frame/module_cpl.F.html#CPL_SETTIME'>cpl_settime</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CPL_SETTIME_1">( curr_secs2 )<a name='725'>
<a name='726'>
       CALL <A href='../../html_code/dyn_em/module_first_rk_step_part1.F.html#FIRST_RK_STEP_PART1'>first_rk_step_part1</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIRST_RK_STEP_PART1_1"> (    grid, config_flags         &amp;<a name='727'>
                             , moist , moist_tend               &amp;<a name='728'>
                             , chem  , chem_tend                &amp;<a name='729'>
                             , tracer, tracer_tend              &amp;<a name='730'>
                             , scalar , scalar_tend             &amp;<a name='731'>
                             , fdda3d, fdda2d                   &amp;<a name='732'>
                             , aerod                            &amp;<a name='733'>
                             , ru_tendf, rv_tendf               &amp;<a name='734'>
                             , rw_tendf, t_tendf                &amp;<a name='735'>
                             , ph_tendf, mu_tendf               &amp;<a name='736'>
                             , tke_tend                         &amp;<a name='737'>
                             , config_flags%use_adaptive_time_step &amp;<a name='738'>
                             , curr_secs                        &amp;<a name='739'>
                             , psim , psih , wspd , gz1oz0      &amp;<a name='740'>
                             , chklowq                          &amp;<a name='741'>
                             , cu_act_flag , hol , th_phy       &amp;<a name='742'>
                             , pi_phy , p_phy , grid%t_phy      &amp;<a name='743'>
                             , dz8w , p8w , t8w                 &amp;<a name='744'>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='745'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='746'>
                             , ips, ipe, jps, jpe, kps, kpe     &amp;<a name='747'>
                             , imsx, imex, jmsx, jmex, kmsx, kmex    &amp;<a name='748'>
                             , ipsx, ipex, jpsx, jpex, kpsx, kpex    &amp;<a name='749'>
                             , imsy, imey, jmsy, jmey, kmsy, kmey    &amp;<a name='750'>
                             , ipsy, ipey, jpsy, jpey, kpsy, kpey    &amp;<a name='751'>
                             , k_start , k_end                  &amp;<a name='752'>
                             , f_flux                           &amp;<a name='753'>
                            )<a name='754'>
<a name='755'>
#ifdef DM_PARALLEL<a name='756'>
       IF ( config_flags%bl_pbl_physics == MYNNPBLSCHEME2 .OR. &amp;<a name='757'>
            config_flags%bl_pbl_physics == MYNNPBLSCHEME3 ) THEN<a name='758'>
#        include "<A href='../../html_code/include/HALO_EM_SCALAR_E_5.inc.html'>HALO_EM_SCALAR_E_5.inc</A>"<A NAME="HALO_EM_SCALAR_E_5.inc_18"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='759'>
       ENDIF<a name='760'>
#endif<a name='761'>
<a name='762'>
       CALL <A href='../../html_code/dyn_em/module_first_rk_step_part2.F.html#FIRST_RK_STEP_PART2'>first_rk_step_part2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FIRST_RK_STEP_PART2_1"> (    grid, config_flags         &amp;<a name='763'>
                             , moist , moist_tend               &amp;<a name='764'>
                             , chem  , chem_tend                &amp;<a name='765'>
                             , tracer, tracer_tend              &amp;<a name='766'>
                             , scalar , scalar_tend             &amp;<a name='767'>
                             , fdda3d, fdda2d                   &amp;<a name='768'>
                             , ru_tendf, rv_tendf               &amp;<a name='769'>
                             , rw_tendf, t_tendf                &amp;<a name='770'>
                             , ph_tendf, mu_tendf               &amp;<a name='771'>
                             , tke_tend                         &amp;<a name='772'>
                             , adapt_step_flag , curr_secs      &amp;<a name='773'>
                             , psim , psih , wspd , gz1oz0      &amp;<a name='774'>
                             , chklowq                          &amp;<a name='775'>
                             , cu_act_flag , hol , th_phy       &amp;<a name='776'>
                             , pi_phy , p_phy , grid%t_phy      &amp;<a name='777'>
                             , dz8w , p8w , t8w                 &amp;<a name='778'>
                             , nba_mij, num_nba_mij             &amp; <font color=#447700>!JDM <a name='779'></font>
                             , nba_rij, num_nba_rij             &amp; <font color=#447700>!JDM  <a name='780'></font>
                             , ids, ide, jds, jde, kds, kde     &amp;<a name='781'>
                             , ims, ime, jms, jme, kms, kme     &amp;<a name='782'>
                             , ips, ipe, jps, jpe, kps, kpe     &amp;<a name='783'>
                             , imsx, imex, jmsx, jmex, kmsx, kmex    &amp;<a name='784'>
                             , ipsx, ipex, jpsx, jpex, kpsx, kpex    &amp;<a name='785'>
                             , imsy, imey, jmsy, jmey, kmsy, kmey    &amp;<a name='786'>
                             , ipsy, ipey, jpsy, jpey, kpsy, kpey    &amp;<a name='787'>
                             , k_start , k_end                  &amp;<a name='788'>
                            )<a name='789'>
<a name='790'>
     END IF rk_step_is_one<a name='791'>
<a name='792'>
<font color=#447700>!************************************************************************************************************************<a name='793'></font>
<font color=#447700>! LES_fix convert theta to theta_m: point 1  ! 28 January 2015<a name='794'></font>
<a name='795'>
     IF ( ( config_flags%use_theta_m .EQ. 1 ) .AND. (P_Qv .GE. PARAM_FIRST_SCALAR) ) THEN<a name='796'>
        CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#THETA_TO_THETAM'>theta_to_thetam</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_TO_THETAM_1"> ( grid%t_1 , moist_old(ims,kms,jms,P_qv) ,  &amp;<a name='797'>
                               t_tendf  , moist_tend(ims,kms,jms,P_qv) , &amp;<a name='798'>
                               grid%t_2 , moist(ims,kms,jms,P_qv) ,      &amp;<a name='799'>
                               grid%h_diabatic ,                         &amp;<a name='800'>
                               grid%itimestep ,                          &amp;<a name='801'>
                               rk_step ,                                 &amp; <a name='802'>
                               ids, ide, jds, jde, kds, kde ,            &amp;<a name='803'>
                               ims, ime, jms, jme, kms, kme ,            &amp;<a name='804'>
                               ips, ipe, jps, jpe, kps, kpe              )<a name='805'>
#if ( defined( DM_PARALLEL ) &amp;&amp; ( <font color=#447700>! defined( STUBMPI ) ) )<a name='806'></font>
#      include "<A href='../../html_code/include/HALO_EM_THETAM.inc.html'>HALO_EM_THETAM.inc</A>"<A NAME="HALO_EM_THETAM.inc_19"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='807'>
#      include "<A href='../../html_code/include/PERIOD_EM_THETAM.inc.html'>PERIOD_EM_THETAM.inc</A>"<A NAME="PERIOD_EM_THETAM.inc_20"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='808'>
#endif<a name='809'>
        its=ips ; ite = ipe<a name='810'>
        jts=jps ; jte = jpe<a name='811'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_91">( grid%h_diabatic, 'p', config_flags,      &amp;<a name='812'>
                                ids, ide, jds, jde, kds, kde,     &amp;<a name='813'>
                                ims, ime, jms, jme, kms, kme,     &amp;<a name='814'>
                                ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='815'>
                                its, ite, jts, jte,               &amp;<a name='816'>
                                k_start    , k_end                )<a name='817'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_92">( grid%t_1, 'p', config_flags,      &amp;<a name='818'>
                                ids, ide, jds, jde, kds, kde,     &amp;<a name='819'>
                                ims, ime, jms, jme, kms, kme,     &amp;<a name='820'>
                                ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='821'>
                                its, ite, jts, jte,               &amp;<a name='822'>
                                k_start    , k_end                )<a name='823'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_93">( grid%t_2, 'p', config_flags,      &amp;<a name='824'>
                                ids, ide, jds, jde, kds, kde,     &amp;<a name='825'>
                                ims, ime, jms, jme, kms, kme,     &amp;<a name='826'>
                                ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='827'>
                                its, ite, jts, jte,               &amp;<a name='828'>
                                k_start    , k_end                )<a name='829'>
     END IF<a name='830'>
<a name='831'>
<font color=#447700>!<a name='832'></font>
<font color=#447700>! end theta_m fix point 1<a name='833'></font>
<font color=#447700>!************************************************************************************************************************<a name='834'></font>
<a name='835'>
BENCH_START(rk_tend_tim)<a name='836'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='837'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='838'></font>
     DO ij = 1 , grid%num_tiles<a name='839'>
<a name='840'>
       CALL wrf_debug ( 200 , ' call rk_tendency' )<a name='841'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_TENDENCY'>rk_tendency</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_TENDENCY_1"> ( config_flags, rk_step                                                                &amp;<a name='842'>
                         ,grid%ru_tend, grid%rv_tend, rw_tend, ph_tend, t_tend                                 &amp;<a name='843'>
                         ,ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf                                      &amp;<a name='844'>
                         ,mu_tend, grid%u_save, grid%v_save, w_save, ph_save                                   &amp;<a name='845'>
                         ,grid%t_save, mu_save, grid%rthften                                                   &amp;<a name='846'>
                         ,grid%ru, grid%rv, grid%rw, grid%ww                                                   &amp;<a name='847'>
                         ,grid%u_2, grid%v_2, grid%w_2, grid%t_2, grid%ph_2                                    &amp;<a name='848'>
                         ,grid%u_1, grid%v_1, grid%w_1, grid%t_1, grid%ph_1                                    &amp;<a name='849'>
                         ,grid%h_diabatic, grid%phb, grid%t_init                                               &amp;<a name='850'>
                         ,grid%mu_2, grid%mut, grid%muu, grid%muv, grid%mub                                    &amp;<a name='851'>
                         ,grid%c1h, grid%c2h, grid%c1f, grid%c2f                                               &amp;<a name='852'>
                         ,grid%al, grid%alt, grid%p, grid%pb, grid%php, cqu, cqv, cqw                          &amp;<a name='853'>
                         ,grid%u_base, grid%v_base, grid%t_base, grid%qv_base, grid%z_base                     &amp;<a name='854'>
                         ,grid%msfux,grid%msfuy, grid%msfvx, grid%msfvx_inv                                    &amp;<a name='855'>
                         ,grid%msfvy, grid%msftx,grid%msfty, grid%clat, grid%f, grid%e, grid%sina, grid%cosa   &amp;<a name='856'>
                         ,grid%fnm, grid%fnp, grid%rdn, grid%rdnw                                              &amp;<a name='857'>
                         ,grid%dt, grid%rdx, grid%rdy, grid%khdif, grid%kvdif, grid%xkmh, grid%xkhh            &amp;<a name='858'>
                         ,grid%diff_6th_opt, grid%diff_6th_factor                                              &amp;<a name='859'>
                         ,config_flags%momentum_adv_opt                                                        &amp;<a name='860'>
                         ,grid%dampcoef,grid%zdamp,config_flags%damp_opt,config_flags%rad_nudge                &amp;<a name='861'>
                         ,grid%cf1, grid%cf2, grid%cf3, grid%cfn, grid%cfn1, num_3d_m                          &amp;<a name='862'>
                         ,config_flags%non_hydrostatic, config_flags%top_lid                                   &amp;<a name='863'>
                         ,grid%u_frame, grid%v_frame                                                           &amp;<a name='864'>
                         ,ids, ide, jds, jde, kds, kde                                                         &amp;<a name='865'>
                         ,ims, ime, jms, jme, kms, kme                                                         &amp;<a name='866'>
                         ,grid%i_start(ij), grid%i_end(ij)                                                     &amp;<a name='867'>
                         ,grid%j_start(ij), grid%j_end(ij)                                                     &amp;<a name='868'>
                         ,k_start, k_end                                                                       &amp;<a name='869'>
                         ,max_vert_cfl_tmp(ij), max_horiz_cfl_tmp(ij)                                         )<a name='870'>
     END DO<a name='871'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='872'></font>
BENCH_END(rk_tend_tim)<a name='873'>
<a name='874'>
     IF (config_flags%use_adaptive_time_step) THEN<a name='875'>
       DO ij = 1 , grid%num_tiles<a name='876'>
         IF (max_horiz_cfl_tmp(ij) .GT. grid%max_horiz_cfl) THEN<a name='877'>
           grid%max_horiz_cfl = max_horiz_cfl_tmp(ij)<a name='878'>
         ENDIF<a name='879'>
         IF (max_vert_cfl_tmp(ij) .GT. grid%max_vert_cfl) THEN<a name='880'>
           grid%max_vert_cfl = max_vert_cfl_tmp(ij)<a name='881'>
         ENDIF<a name='882'>
       END DO<a name='883'>
     <a name='884'>
       IF (grid%max_horiz_cfl .GT. grid%max_cfl_val) THEN<a name='885'>
         grid%max_cfl_val = grid%max_horiz_cfl<a name='886'>
       ENDIF<a name='887'>
       IF (grid%max_vert_cfl .GT. grid%max_cfl_val) THEN<a name='888'>
         grid%max_cfl_val = grid%max_vert_cfl<a name='889'>
       ENDIF<a name='890'>
     ENDIF<a name='891'>
<a name='892'>
BENCH_START(relax_bdy_dry_tim)<a name='893'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='894'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='895'></font>
     DO ij = 1 , grid%num_tiles<a name='896'>
<a name='897'>
       IF ( (config_flags%specified .or. config_flags%nested) .and. ( rk_step == 1 ) ) THEN <a name='898'>
<a name='899'>
<font color=#447700>!************************************************************************************************************************<a name='900'></font>
<font color=#447700>! LES_fix convert theta to theta_m: nested or specified LBC, only required on the first rk step<a name='901'></font>
<a name='902'>
         IF   ( ( config_flags%use_theta_m .EQ. 1 ) .AND. (P_Qv .GE. PARAM_FIRST_SCALAR) ) THEN<a name='903'>
           IF ( grid%grid_id .EQ. 1 ) THEN<a name='904'>
              time_duration_of_lbcs = grid%interval_seconds<a name='905'>
           ELSE<a name='906'>
              time_duration_of_lbcs = grid%parent_time_step_ratio * grid%dt<a name='907'>
           END IF<a name='908'>
           CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#THETA_AND_THETAM_LBC_ONLY'>theta_and_thetam_lbc_only</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_AND_THETAM_LBC_ONLY_1"> (                                                   &amp; <a name='909'>
                                .TRUE.,                                                       &amp;<a name='910'>
                                grid%mub,                                                     &amp;<a name='911'>
                                grid%mu_bxs,grid%mu_bxe,grid%mu_bys,grid%mu_bye,              &amp;<a name='912'>
                                grid%mu_btxs,grid%mu_btxe,grid%mu_btys,grid%mu_btye,          &amp;<a name='913'>
                                grid%t_bxs,grid%t_bxe,grid%t_bys,grid%t_bye,                  &amp;<a name='914'>
                                grid%t_btxs,grid%t_btxe,grid%t_btys,grid%t_btye,              &amp;<a name='915'>
                                moist_bxs(jms,kms,1,P_Qv),moist_bxe(jms,kms,1,P_Qv),          &amp;<a name='916'>
                                moist_bys(ims,kms,1,P_Qv),moist_bye(ims,kms,1,P_Qv),          &amp;<a name='917'>
                                moist_btxs(jms,kms,1,P_Qv),moist_btxe(jms,kms,1,P_Qv),        &amp;<a name='918'>
                                moist_btys(ims,kms,1,P_Qv),moist_btye(ims,kms,1,P_Qv),        &amp;<a name='919'>
                                config_flags%spec_bdy_width,                                  &amp;<a name='920'>
                                time_duration_of_lbcs,                                        &amp;<a name='921'>
                                ids,ide, jds,jde, kds,kde,                                    &amp;<a name='922'>
                                ims,ime, jms,jme, kms,kme,                                    &amp;<a name='923'>
                                ips,ipe, jps,jpe, kps,kpe,                                    &amp;<a name='924'>
                                grid%i_start(ij), grid%i_end(ij),                             &amp;<a name='925'>
                                grid%j_start(ij), grid%j_end(ij),                             &amp;<a name='926'>
                                k_start    , k_end                                            )<a name='927'>
         END IF<a name='928'>
<a name='929'>
<font color=#447700>! LES_fix convert theta to theta_m: nested or specified LBC<a name='930'></font>
<font color=#447700>!************************************************************************************************************************<a name='931'></font>
<a name='932'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_DRY'>relax_bdy_dry</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_DRY_1"> ( config_flags,                                &amp;<a name='933'>
                              grid%u_save, grid%v_save, ph_save, grid%t_save,             &amp;<a name='934'>
                              w_save, mu_tend, grid%c1h, grid%c2h, grid%c1f, grid%c2f, &amp;<a name='935'>
                              grid%ru, grid%rv, grid%ph_2, grid%t_2,                           &amp;<a name='936'>
                              grid%w_2, grid%mu_2, grid%mut,                              &amp;<a name='937'>
                              grid%u_bxs,grid%u_bxe,grid%u_bys,grid%u_bye, &amp;<a name='938'>
                              grid%v_bxs,grid%v_bxe,grid%v_bys,grid%v_bye, &amp;<a name='939'>
                              grid%ph_bxs,grid%ph_bxe,grid%ph_bys,grid%ph_bye, &amp;<a name='940'>
                              grid%t_bxs,grid%t_bxe,grid%t_bys,grid%t_bye, &amp;<a name='941'>
                              grid%w_bxs,grid%w_bxe,grid%w_bys,grid%w_bye, &amp;<a name='942'>
                              grid%mu_bxs,grid%mu_bxe,grid%mu_bys,grid%mu_bye, &amp;<a name='943'>
                              grid%u_btxs,grid%u_btxe,grid%u_btys,grid%u_btye, &amp;<a name='944'>
                              grid%v_btxs,grid%v_btxe,grid%v_btys,grid%v_btye, &amp;<a name='945'>
                              grid%ph_btxs,grid%ph_btxe,grid%ph_btys,grid%ph_btye, &amp;<a name='946'>
                              grid%t_btxs,grid%t_btxe,grid%t_btys,grid%t_btye, &amp;<a name='947'>
                              grid%w_btxs,grid%w_btxe,grid%w_btys,grid%w_btye, &amp;<a name='948'>
                              grid%mu_btxs,grid%mu_btxe,grid%mu_btys,grid%mu_btye, &amp;<a name='949'>
                              config_flags%spec_bdy_width, grid%spec_zone, grid%relax_zone,       &amp;<a name='950'>
                              grid%dtbc, grid%fcx, grid%gcx,                              &amp;<a name='951'>
                              ids,ide, jds,jde, kds,kde,                   &amp;<a name='952'>
                              ims,ime, jms,jme, kms,kme,                   &amp;<a name='953'>
                              ips,ipe, jps,jpe, kps,kpe,                   &amp;<a name='954'>
                              grid%i_start(ij), grid%i_end(ij),            &amp;<a name='955'>
                              grid%j_start(ij), grid%j_end(ij),            &amp;<a name='956'>
                              k_start, k_end                              )<a name='957'>
<a name='958'>
       ENDIF<a name='959'>
<a name='960'>
       CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_ADDTEND_DRY'>rk_addtend_dry</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_ADDTEND_DRY_1">( grid%ru_tend,  grid%rv_tend,  rw_tend,  ph_tend,  t_tend,  &amp;<a name='961'>
                            ru_tendf, rv_tendf, rw_tendf, ph_tendf, t_tendf, &amp;<a name='962'>
                            grid%u_save, grid%v_save, w_save, ph_save, grid%t_save, &amp;<a name='963'>
                            mu_tend, mu_tendf, rk_step,                      &amp;<a name='964'>
                            grid%c1h, grid%c2h,                              &amp;<a name='965'>
                            grid%h_diabatic, grid%mut, grid%msftx,           &amp;<a name='966'>
                            grid%msfty, grid%msfux,grid%msfuy,               &amp;<a name='967'>
                            grid%msfvx, grid%msfvx_inv, grid%msfvy,          &amp;<a name='968'>
                            ids,ide, jds,jde, kds,kde,                       &amp;<a name='969'>
                            ims,ime, jms,jme, kms,kme,                       &amp;<a name='970'>
                            ips,ipe, jps,jpe, kps,kpe,                       &amp;<a name='971'>
                            grid%i_start(ij), grid%i_end(ij),                &amp;<a name='972'>
                            grid%j_start(ij), grid%j_end(ij),                &amp;<a name='973'>
                            k_start, k_end                                  )<a name='974'>
<a name='975'>
       IF( config_flags%specified .or. config_flags%nested ) THEN <a name='976'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_DRY'>spec_bdy_dry</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_DRY_1"> ( config_flags,                                    &amp;<a name='977'>
                             grid%ru_tend, grid%rv_tend, ph_tend, t_tend,               &amp;<a name='978'>
                             rw_tend, mu_tend,                                &amp;<a name='979'>
                             grid%u_bxs,grid%u_bxe,grid%u_bys,grid%u_bye, &amp;<a name='980'>
                             grid%v_bxs,grid%v_bxe,grid%v_bys,grid%v_bye, &amp;<a name='981'>
                             grid%ph_bxs,grid%ph_bxe,grid%ph_bys,grid%ph_bye, &amp;<a name='982'>
                             grid%t_bxs,grid%t_bxe,grid%t_bys,grid%t_bye, &amp;<a name='983'>
                             grid%w_bxs,grid%w_bxe,grid%w_bys,grid%w_bye, &amp;<a name='984'>
                             grid%mu_bxs,grid%mu_bxe,grid%mu_bys,grid%mu_bye, &amp;<a name='985'>
                             grid%u_btxs,grid%u_btxe,grid%u_btys,grid%u_btye, &amp;<a name='986'>
                             grid%v_btxs,grid%v_btxe,grid%v_btys,grid%v_btye, &amp;<a name='987'>
                             grid%ph_btxs,grid%ph_btxe,grid%ph_btys,grid%ph_btye, &amp;<a name='988'>
                             grid%t_btxs,grid%t_btxe,grid%t_btys,grid%t_btye, &amp;<a name='989'>
                             grid%w_btxs,grid%w_btxe,grid%w_btys,grid%w_btye, &amp;<a name='990'>
                             grid%mu_btxs,grid%mu_btxe,grid%mu_btys,grid%mu_btye, &amp;<a name='991'>
                             config_flags%spec_bdy_width, grid%spec_zone,                       &amp;<a name='992'>
                             ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='993'></font>
                             ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='994'></font>
                             ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='995'></font>
                             grid%i_start(ij), grid%i_end(ij),                &amp;<a name='996'>
                             grid%j_start(ij), grid%j_end(ij),                &amp;<a name='997'>
                             k_start, k_end                                  )<a name='998'>
<a name='999'>
<font color=#447700>!************************************************************************************************************************<a name='1000'></font>
<font color=#447700>! LES_fix convert theta_m to theta: nested or specified LBC, and only in the last rk step<a name='1001'></font>
<font color=#447700>! since we do not need the theta_m lateral boundaries any more.<a name='1002'></font>
<a name='1003'>
         IF   ( ( config_flags%use_theta_m .EQ. 1 ) .AND. (P_Qv .GE. PARAM_FIRST_SCALAR) .AND. ( rk_step == rk_order ) ) THEN<a name='1004'>
           CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#THETA_AND_THETAM_LBC_ONLY'>theta_and_thetam_lbc_only</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETA_AND_THETAM_LBC_ONLY_2"> (                                                   &amp; <a name='1005'>
                                .FALSE.,                                                      &amp;           <a name='1006'>
                                grid%mub,                                                     &amp;<a name='1007'>
                                grid%mu_bxs,grid%mu_bxe,grid%mu_bys,grid%mu_bye,              &amp;<a name='1008'>
                                grid%mu_btxs,grid%mu_btxe,grid%mu_btys,grid%mu_btye,          &amp;<a name='1009'>
                                grid%t_bxs,grid%t_bxe,grid%t_bys,grid%t_bye,                  &amp;<a name='1010'>
                                grid%t_btxs,grid%t_btxe,grid%t_btys,grid%t_btye,              &amp;<a name='1011'>
                                moist_bxs(jms,kms,1,P_Qv),moist_bxe(jms,kms,1,P_Qv),          &amp;<a name='1012'>
                                moist_bys(ims,kms,1,P_Qv),moist_bye(ims,kms,1,P_Qv),          &amp;<a name='1013'>
                                moist_btxs(jms,kms,1,P_Qv),moist_btxe(jms,kms,1,P_Qv),        &amp;<a name='1014'>
                                moist_btys(ims,kms,1,P_Qv),moist_btye(ims,kms,1,P_Qv),        &amp;<a name='1015'>
                                config_flags%spec_bdy_width,                                  &amp;<a name='1016'>
                                time_duration_of_lbcs,                                        &amp;<a name='1017'>
                                ids,ide, jds,jde, kds,kde,                                    &amp;<a name='1018'>
                                ims,ime, jms,jme, kms,kme,                                    &amp;<a name='1019'>
                                ips,ipe, jps,jpe, kps,kpe,                                    &amp;<a name='1020'>
                                grid%i_start(ij), grid%i_end(ij),                             &amp;<a name='1021'>
                                grid%j_start(ij), grid%j_end(ij),                             &amp;<a name='1022'>
                                k_start    , k_end                                            )<a name='1023'>
         END IF<a name='1024'>
<a name='1025'>
<font color=#447700>! LES_fix convert theta_m to theta: nested or specified LBC, and only in the last rk step<a name='1026'></font>
<font color=#447700>! since we do not need the theta_m lateral boundaries any more.<a name='1027'></font>
<font color=#447700>!************************************************************************************************************************<a name='1028'></font>
<a name='1029'>
       ENDIF<a name='1030'>
<a name='1031'>
<font color=#447700>!---------------------------------------------------------------------------------------------<a name='1032'></font>
<font color=#447700>! KRS 9/12/2012: Inserted new IF block calls to spec_bdy_dry_perturb. If peturb_bdy=1, SKEBS <a name='1033'></font>
<font color=#447700>! pattern passed in for perturbing the specified boundry conditions.  If peturb_bdy=2, user<a name='1034'></font>
<font color=#447700>! must provide pattern.  mu_2, mub, msf* also passed in for coupling needed for tendecies.<a name='1035'></font>
<font color=#447700>!---------------------------------------------------------------------------------------------<a name='1036'></font>
       IF( config_flags%specified .and. config_flags%perturb_bdy==1 ) THEN <a name='1037'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_DRY_PERTURB'>spec_bdy_dry_perturb</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_DRY_PERTURB_1"> ( config_flags,                                 &amp;<a name='1038'>
                             grid%ru_tend, grid%rv_tend, t_tend,                   &amp;<a name='1039'>
                             grid%mu_2, grid%mub, grid%c1h, grid%c2h,              &amp;<a name='1040'>
                             grid%msfux, grid%msfvx, grid%msft,	                   &amp;<a name='1041'>
                             grid%ru_tendf_stoch, grid%rv_tendf_stoch, grid%rt_tendf_stoch, &amp;<a name='1042'>
                             config_flags%spec_bdy_width, grid%spec_zone,                   &amp;<a name='1043'>
                             grid%num_stoch_levels,      &amp; <font color=#447700>! stoch dims<a name='1044'></font>
                             ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1045'></font>
                             ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1046'></font>
                             ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1047'></font>
                             grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1048'>
                             grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1049'>
                             k_start, k_end                                  )<a name='1050'>
     <a name='1051'>
       ENDIF<a name='1052'>
<a name='1053'>
       IF( config_flags%specified .and. config_flags%perturb_bdy==2 ) THEN<a name='1054'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_DRY_PERTURB'>spec_bdy_dry_perturb</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_DRY_PERTURB_2"> ( config_flags,                                 &amp;<a name='1055'>
                             grid%ru_tend, grid%rv_tend, t_tend,                   &amp;<a name='1056'>
                             grid%mu_2, grid%mub, grid%c1h, grid%c2h,              &amp;<a name='1057'>
                             grid%msfux, grid%msfvx, grid%msft,                    &amp;<a name='1058'>
                             grid%field_u_tend_perturb, grid%field_v_tend_perturb, grid%field_t_tend_perturb, &amp;<a name='1059'>
                             config_flags%spec_bdy_width, grid%spec_zone,                   &amp;<a name='1060'>
                             grid%num_stoch_levels,      &amp; <font color=#447700>! stoch dims<a name='1061'></font>
                             ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1062'></font>
                             ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1063'></font>
                             ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1064'></font>
                             grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1065'>
                             grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1066'>
                             k_start, k_end                                  )<a name='1067'>
  <a name='1068'>
       ENDIF<a name='1069'>
<a name='1070'>
     END DO<a name='1071'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='1072'></font>
BENCH_END(relax_bdy_dry_tim)<a name='1073'>
<a name='1074'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='1075'></font>
<font color=#447700>!&lt;pre&gt;<a name='1076'></font>
<font color=#447700>! (3) Small (acoustic,sound) steps.<a name='1077'></font>
<font color=#447700>!<a name='1078'></font>
<font color=#447700>!    Several acoustic steps are taken each RK pass.  A small step <a name='1079'></font>
<font color=#447700>!    sequence begins with calculating perturbation variables <a name='1080'></font>
<font color=#447700>!    and coupling them to the column dry-air-mass mu <a name='1081'></font>
<font color=#447700>!    (call to small_step_prep).  This is followed by computing<a name='1082'></font>
<font color=#447700>!    coefficients for the vertically implicit part of the<a name='1083'></font>
<font color=#447700>!    small timestep (call to calc_coef_w).  <a name='1084'></font>
<font color=#447700>!<a name='1085'></font>
<font color=#447700>!    The small steps are taken<a name='1086'></font>
<font color=#447700>!    in the named loop "small_steps:".  In the small_steps loop, first <a name='1087'></font>
<font color=#447700>!    the horizontal momentum (u and v) are advanced (call to advance_uv),<a name='1088'></font>
<font color=#447700>!    next mu and theta are advanced (call to advance_mu_t) followed by<a name='1089'></font>
<font color=#447700>!    advancing w and the geopotential (call to advance_w).  Diagnostic<a name='1090'></font>
<font color=#447700>!    values for pressure and inverse density are updated at the end of<a name='1091'></font>
<font color=#447700>!    each small_step.<a name='1092'></font>
<font color=#447700>!<a name='1093'></font>
<font color=#447700>!    The small-step section ends with the change of the perturbation variables<a name='1094'></font>
<font color=#447700>!    back to full variables (call to small_step_finish).<a name='1095'></font>
<font color=#447700>!&lt;/pre&gt;<a name='1096'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='1097'></font>
<a name='1098'>
BENCH_START(small_step_prep_tim)<a name='1099'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1100'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='1101'></font>
     DO ij = 1 , grid%num_tiles<a name='1102'>
<a name='1103'>
    <font color=#447700>! Calculate coefficients for the vertically implicit acoustic/gravity wave<a name='1104'></font>
    <font color=#447700>! integration.  We only need calculate these for the first pass through -<a name='1105'></font>
    <font color=#447700>! the predictor step.  They are reused as is for the corrector step.<a name='1106'></font>
    <font color=#447700>! For third-order RK, we need to recompute these after the first <a name='1107'></font>
    <font color=#447700>! predictor because we may have changed the small timestep -&gt; grid%dts.<a name='1108'></font>
<a name='1109'>
       CALL wrf_debug ( 200 , ' call small_step_prep ' )<a name='1110'>
<a name='1111'>
       CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_PREP'>small_step_prep</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_PREP_1">( grid%u_1,grid%u_2,grid%v_1,grid%v_2,grid%w_1,grid%w_2,   &amp;<a name='1112'>
                             grid%t_1,grid%t_2,grid%ph_1,grid%ph_2,                   &amp;<a name='1113'>
                             grid%mub, grid%mu_1, grid%mu_2,                          &amp;<a name='1114'>
                             grid%muu, grid%muus, grid%muv, grid%muvs,                &amp;<a name='1115'>
                             grid%mut, grid%muts, grid%mudf,                          &amp;<a name='1116'>
                             grid%c1h, grid%c2h, grid%c1f, grid%c2f,                  &amp;<a name='1117'>
                             grid%c3h, grid%c4h, grid%c3f, grid%c4f,                  &amp;<a name='1118'>
                             grid%u_save, grid%v_save, w_save,                        &amp;<a name='1119'>
                             grid%t_save, ph_save, mu_save,                           &amp;<a name='1120'>
                             grid%ww, ww1,                                            &amp;<a name='1121'>
                             c2a, grid%pb, grid%p, grid%alt,                          &amp;<a name='1122'>
                             grid%msfux,grid%msfuy, grid%msfvx, grid%msfvx_inv,       &amp;<a name='1123'>
                             grid%msfvy, grid%msftx,grid%msfty,                       &amp;<a name='1124'>
                             grid%rdx, grid%rdy, rk_step,                             &amp;<a name='1125'>
                             ids, ide, jds, jde, kds, kde,                            &amp;<a name='1126'>
                             ims, ime, jms, jme, kms, kme,                            &amp;<a name='1127'>
                             grid%i_start(ij), grid%i_end(ij),                        &amp;<a name='1128'>
                             grid%j_start(ij), grid%j_end(ij),                        &amp;<a name='1129'>
                             k_start    , k_end                                       )<a name='1130'>
 <a name='1131'>
       CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO'>calc_p_rho</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_1">( grid%al, grid%p, grid%ph_2,                 &amp;<a name='1132'>
                        grid%alt, grid%t_2, grid%t_save, c2a, pm1,  &amp;<a name='1133'>
                        grid%mu_2, grid%muts,                       &amp;<a name='1134'>
                        grid%c1h, grid%c2h, grid%c1f, grid%c2f,     &amp;<a name='1135'>
                        grid%c3h, grid%c4h, grid%c3f, grid%c4f,     &amp;<a name='1136'>
                        grid%znu, t0,                               &amp;<a name='1137'>
                        grid%rdnw, grid%dnw, grid%smdiv,            &amp;<a name='1138'>
                        config_flags%non_hydrostatic, 0,            &amp;<a name='1139'>
                        ids, ide, jds, jde, kds, kde,               &amp;<a name='1140'>
                        ims, ime, jms, jme, kms, kme,               &amp;<a name='1141'>
                        grid%i_start(ij), grid%i_end(ij),           &amp;<a name='1142'>
                        grid%j_start(ij), grid%j_end(ij),           &amp;<a name='1143'>
                        k_start    , k_end                          )<a name='1144'>
<a name='1145'>
       IF (config_flags%non_hydrostatic) THEN<a name='1146'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_COEF_W'>calc_coef_w</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_COEF_W_1">( a,alpha,gamma,                    &amp;<a name='1147'>
                           grid%mut,                         &amp;<a name='1148'>
                           grid%c1h, grid%c2h, grid%c1f, grid%c2f, &amp;<a name='1149'>
                           grid%c3h, grid%c4h, grid%c3f, grid%c4f, &amp;<a name='1150'>
                           cqw, grid%rdn, grid%rdnw, c2a,    &amp;<a name='1151'>
                           dts_rk, g, grid%epssm,            &amp;<a name='1152'>
                           config_flags%top_lid,             &amp;<a name='1153'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='1154'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='1155'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='1156'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='1157'>
                           k_start    , k_end               )<a name='1158'>
       ENDIF<a name='1159'>
<a name='1160'>
     ENDDO<a name='1161'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='1162'></font>
BENCH_END(small_step_prep_tim)<a name='1163'>
<a name='1164'>
#ifdef DM_PARALLEL<a name='1165'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1166'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1167'></font>
<font color=#447700>!  Note:  the small size of this halo exchange reflects the <a name='1168'></font>
<font color=#447700>!         fact that we are carrying the uncoupled variables <a name='1169'></font>
<font color=#447700>!         as state variables in the mass coordinate model, as<a name='1170'></font>
<font color=#447700>!         opposed to the coupled variables as in the height<a name='1171'></font>
<font color=#447700>!         coordinate model.<a name='1172'></font>
<font color=#447700>!<a name='1173'></font>
<font color=#447700>!                              * * * * *<a name='1174'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='1175'></font>
<font color=#447700>!          * + *      * + *    * * + * * <a name='1176'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='1177'></font>
<font color=#447700>!                              * * * * *<a name='1178'></font>
<font color=#447700>!<a name='1179'></font>
<font color=#447700>!  3D variables - note staggering!  ph_2(Z), u_save(X), v_save(Y)<a name='1180'></font>
<font color=#447700>!<a name='1181'></font>
<font color=#447700>!  ph_2      x<a name='1182'></font>
<font color=#447700>!  al        x<a name='1183'></font>
<font color=#447700>!  p         x<a name='1184'></font>
<font color=#447700>!  t_1       x<a name='1185'></font>
<font color=#447700>!  t_save    x<a name='1186'></font>
<font color=#447700>!  u_save    x<a name='1187'></font>
<font color=#447700>!  v_save    x<a name='1188'></font>
<font color=#447700>!<a name='1189'></font>
<font color=#447700>!  the following are 2D (xy) variables<a name='1190'></font>
<font color=#447700>!<a name='1191'></font>
<font color=#447700>!  mu_1      x<a name='1192'></font>
<font color=#447700>!  mu_2      x<a name='1193'></font>
<font color=#447700>!  mudf      x<a name='1194'></font>
<font color=#447700>!  php       x<a name='1195'></font>
<font color=#447700>!  alt       x<a name='1196'></font>
<font color=#447700>!  pb        x<a name='1197'></font>
<font color=#447700>!--------------------------------------------------------------<a name='1198'></font>
#      include "<A href='../../html_code/include/HALO_EM_B.inc.html'>HALO_EM_B.inc</A>"<A NAME="HALO_EM_B.inc_21"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1199'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B.inc.html'>PERIOD_BDY_EM_B.inc</A>"<A NAME="PERIOD_BDY_EM_B.inc_22"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1200'>
#endif<a name='1201'>
<a name='1202'>
BENCH_START(set_phys_bc2_tim)<a name='1203'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1204'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='1205'></font>
<a name='1206'>
     DO ij = 1 , grid%num_tiles<a name='1207'>
<a name='1208'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_94">( grid%ru_tend, 'u', config_flags,      &amp;<a name='1209'>
                               ids, ide, jds, jde, kds, kde,         &amp;<a name='1210'>
                               ims, ime, jms, jme, kms, kme,         &amp;<a name='1211'>
                               ips, ipe, jps, jpe, kps, kpe,         &amp;<a name='1212'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1213'>
                               grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1214'>
                               k_start    , k_end                    )<a name='1215'>
<a name='1216'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_95">( grid%rv_tend, 'v', config_flags,      &amp;<a name='1217'>
                               ids, ide, jds, jde, kds, kde,         &amp;<a name='1218'>
                               ims, ime, jms, jme, kms, kme,         &amp;<a name='1219'>
                               ips, ipe, jps, jpe, kps, kpe,         &amp;<a name='1220'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1221'>
                               grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1222'>
                               k_start    , k_end                    )<a name='1223'>
<a name='1224'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_96">( grid%ph_2, 'w', config_flags,         &amp;<a name='1225'>
                               ids, ide, jds, jde, kds, kde,         &amp;<a name='1226'>
                               ims, ime, jms, jme, kms, kme,         &amp;<a name='1227'>
                               ips, ipe, jps, jpe, kps, kpe,         &amp;<a name='1228'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1229'>
                               grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1230'>
                               k_start    , k_end                    )<a name='1231'>
<a name='1232'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_97">( grid%al, 'p', config_flags,           &amp;<a name='1233'>
                               ids, ide, jds, jde, kds, kde,         &amp;<a name='1234'>
                               ims, ime, jms, jme, kms, kme,         &amp;<a name='1235'>
                               ips, ipe, jps, jpe, kps, kpe,         &amp;<a name='1236'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1237'>
                               grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1238'>
                               k_start    , k_end                    )<a name='1239'>
<a name='1240'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_98">( grid%p, 'p', config_flags,            &amp;<a name='1241'>
                               ids, ide, jds, jde, kds, kde,         &amp;<a name='1242'>
                               ims, ime, jms, jme, kms, kme,         &amp;<a name='1243'>
                               ips, ipe, jps, jpe, kps, kpe,         &amp;<a name='1244'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1245'>
                               grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1246'>
                               k_start    , k_end                    )<a name='1247'>
<a name='1248'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_99">( grid%t_1, 'p', config_flags,          &amp;<a name='1249'>
                               ids, ide, jds, jde, kds, kde,         &amp;<a name='1250'>
                               ims, ime, jms, jme, kms, kme,         &amp;<a name='1251'>
                               ips, ipe, jps, jpe, kps, kpe,         &amp;<a name='1252'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1253'>
                               grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1254'>
                               k_start    , k_end                    )<a name='1255'>
<a name='1256'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_100">( grid%t_save, 't', config_flags,       &amp;<a name='1257'>
                               ids, ide, jds, jde, kds, kde,         &amp;<a name='1258'>
                               ims, ime, jms, jme, kms, kme,         &amp;<a name='1259'>
                               ips, ipe, jps, jpe, kps, kpe,         &amp;<a name='1260'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1261'>
                               grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1262'>
                               k_start    , k_end                    )<a name='1263'>
<a name='1264'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_12">( grid%mu_1, 't', config_flags,         &amp;<a name='1265'>
                               ids, ide, jds, jde,                   &amp;<a name='1266'>
                               ims, ime, jms, jme,                   &amp;<a name='1267'>
                               ips, ipe, jps, jpe,                   &amp;<a name='1268'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1269'>
                               grid%j_start(ij), grid%j_end(ij)      )<a name='1270'>
<a name='1271'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_13">( grid%mu_2, 't', config_flags,         &amp;<a name='1272'>
                               ids, ide, jds, jde,                   &amp;<a name='1273'>
                               ims, ime, jms, jme,                   &amp;<a name='1274'>
                               ips, ipe, jps, jpe,                   &amp;<a name='1275'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1276'>
                               grid%j_start(ij), grid%j_end(ij)      )<a name='1277'>
<a name='1278'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_14">( grid%mudf, 't', config_flags,         &amp;<a name='1279'>
                               ids, ide, jds, jde,                   &amp;<a name='1280'>
                               ims, ime, jms, jme,                   &amp;<a name='1281'>
                               ips, ipe, jps, jpe,                   &amp;<a name='1282'>
                               grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1283'>
                               grid%j_start(ij), grid%j_end(ij)      )<a name='1284'>
<a name='1285'>
     END DO<a name='1286'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='1287'></font>
BENCH_END(set_phys_bc2_tim)<a name='1288'>
     small_steps : DO iteration = 1 , number_of_small_timesteps<a name='1289'>
<a name='1290'>
       <font color=#447700>! Boundary condition time (or communication time).  <a name='1291'></font>
#ifdef DM_PARALLEL<a name='1292'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B.inc.html'>PERIOD_BDY_EM_B.inc</A>"<A NAME="PERIOD_BDY_EM_B.inc_23"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1293'>
#endif<a name='1294'>
<a name='1295'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1296'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1297'></font>
<a name='1298'>
       DO ij = 1 , grid%num_tiles<a name='1299'>
<a name='1300'>
BENCH_START(advance_uv_tim)<a name='1301'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_UV'>advance_uv</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_UV_1"> ( grid%u_2, grid%ru_tend, grid%v_2, grid%rv_tend,        &amp;<a name='1302'>
                           grid%p, grid%pb,                                       &amp;<a name='1303'>
                           grid%ph_2, grid%php, grid%alt,  grid%al,               &amp;<a name='1304'>
                           grid%mu_2, grid%muu, cqu, grid%muv, cqv, grid%mudf,    &amp;<a name='1305'>
                           grid%c1h, grid%c2h, grid%c1f, grid%c2f,                &amp;<a name='1306'>
                           grid%c3h, grid%c4h, grid%c3f, grid%c4f,                &amp;<a name='1307'>
                           grid%msfux, grid%msfuy, grid%msfvx,                    &amp;<a name='1308'>
                           grid%msfvx_inv, grid%msfvy,                            &amp;<a name='1309'>
                           grid%rdx, grid%rdy, dts_rk,                            &amp;<a name='1310'>
                           grid%cf1, grid%cf2, grid%cf3, grid%fnm, grid%fnp,      &amp;<a name='1311'>
                           grid%emdiv,                                            &amp;<a name='1312'>
                           grid%rdnw, config_flags,grid%spec_zone,                &amp;<a name='1313'>
                           config_flags%non_hydrostatic, config_flags%top_lid,    &amp;<a name='1314'>
                           ids, ide, jds, jde, kds, kde,                          &amp;<a name='1315'>
                           ims, ime, jms, jme, kms, kme,                          &amp;<a name='1316'>
                           grid%i_start(ij), grid%i_end(ij),                      &amp;<a name='1317'>
                           grid%j_start(ij), grid%j_end(ij),                      &amp;<a name='1318'>
                           k_start    , k_end                                     )<a name='1319'>
BENCH_END(advance_uv_tim)<a name='1320'>
<a name='1321'>
       END DO<a name='1322'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1323'></font>
<a name='1324'>
<font color=#447700>!-----------------------------------------------------------<a name='1325'></font>
<font color=#447700>!  acoustic integration polar filter for smallstep u, v<a name='1326'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1327'></font>
<a name='1328'>
       IF (config_flags%polar) THEN<a name='1329'>
<a name='1330'>
         CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_1"> ( grid=grid                                              &amp;<a name='1331'>
               ,lineno=__LINE__                                             &amp;<a name='1332'>
               ,flag_uv            = 1                                      &amp;<a name='1333'>
               ,flag_rurv          = 0                                      &amp;<a name='1334'>
               ,flag_wph           = 0                                      &amp;<a name='1335'>
               ,flag_ww            = 0                                      &amp;<a name='1336'>
               ,flag_t             = 0                                      &amp;<a name='1337'>
               ,flag_mu            = 0                                      &amp;<a name='1338'>
               ,flag_mut           = 0                                      &amp;<a name='1339'>
               ,flag_moist         = 0                                      &amp;<a name='1340'>
               ,flag_chem          = 0                                      &amp;<a name='1341'>
               ,flag_tracer        = 0                                      &amp;<a name='1342'>
               ,flag_scalar        = 0                                      &amp;<a name='1343'>
               ,actual_distance_average  = .FALSE.                          &amp;<a name='1344'>
               ,pos_def            = .FALSE.                                &amp;<a name='1345'>
               ,swap_pole_with_next_j = .FALSE.                             &amp;<a name='1346'>
               ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='1347'>
               ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='1348'>
               ,dclat = dclat                                               &amp;<a name='1349'>
               ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='1350'>
               ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='1351'>
               ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='1352'>
               ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='1353'>
               ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='1354'>
<a name='1355'>
       END IF<a name='1356'>
<a name='1357'>
<font color=#447700>!-----------------------------------------------------------<a name='1358'></font>
<font color=#447700>!  end acoustic integration polar filter for smallstep u, v<a name='1359'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1360'></font>
<a name='1361'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1362'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1363'></font>
       DO ij = 1 , grid%num_tiles<a name='1364'>
<a name='1365'>
BENCH_START(spec_bdy_uv_tim)<a name='1366'>
         IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1367'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_1">(grid%u_2, grid%ru_tend, dts_rk,      &amp;<a name='1368'>
                               'u'         , config_flags, &amp;<a name='1369'>
                                grid%spec_zone,                  &amp;<a name='1370'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1371'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1372'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1373'></font>
                                grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1374'>
                                grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1375'>
                                k_start    , k_end             )<a name='1376'>
<a name='1377'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_2">(grid%v_2, grid%rv_tend, dts_rk,      &amp;<a name='1378'>
                                'v'         , config_flags, &amp;<a name='1379'>
                                grid%spec_zone,                  &amp;<a name='1380'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='1381'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='1382'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='1383'></font>
                                grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1384'>
                                grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1385'>
                                k_start    , k_end             )<a name='1386'>
<a name='1387'>
         ENDIF<a name='1388'>
BENCH_END(spec_bdy_uv_tim)<a name='1389'>
<a name='1390'>
       END DO<a name='1391'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1392'></font>
<a name='1393'>
#ifdef DM_PARALLEL<a name='1394'>
<font color=#447700>!<a name='1395'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1396'></font>
<font color=#447700>!<a name='1397'></font>
<font color=#447700>!         *                     *<a name='1398'></font>
<font color=#447700>!       * + *      * + *        +<a name='1399'></font>
<font color=#447700>!         *                     *<a name='1400'></font>
<font color=#447700>!<a name='1401'></font>
<font color=#447700>!  u_2               x<a name='1402'></font>
<font color=#447700>!  v_2                          x<a name='1403'></font>
<font color=#447700>!<a name='1404'></font>
#     include "<A href='../../html_code/include/HALO_EM_C.inc.html'>HALO_EM_C.inc</A>"<A NAME="HALO_EM_C.inc_24"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1405'>
#endif<a name='1406'>
<a name='1407'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1408'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1409'></font>
       DO ij = 1 , grid%num_tiles<a name='1410'>
<a name='1411'>
        <font color=#447700>!  advance the mass in the column, theta, and calculate ww<a name='1412'></font>
<a name='1413'>
BENCH_START(advance_mu_t_tim)<a name='1414'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_MU_T'>advance_mu_t</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_MU_T_1">( grid%ww, ww1, grid%u_2, grid%u_save, grid%v_2, grid%v_save, &amp;<a name='1415'>
                          grid%mu_2, grid%mut, muave, grid%muts, grid%muu, grid%muv,    &amp;<a name='1416'>
                          grid%mudf,                                                    &amp;<a name='1417'>
                          grid%c1h, grid%c2h, grid%c1f, grid%c2f,                       &amp;<a name='1418'>
                          grid%c3h, grid%c4h, grid%c3f, grid%c4f,                       &amp;<a name='1419'>
                          grid%ru_m, grid%rv_m, grid%ww_m,                              &amp;<a name='1420'>
                          grid%t_2, grid%t_save, t_2save, t_tend,                       &amp;<a name='1421'>
                          mu_tend,                                                      &amp;<a name='1422'>
                          grid%rdx, grid%rdy, dts_rk, grid%epssm,                       &amp;<a name='1423'>
                          grid%dnw, grid%fnm, grid%fnp, grid%rdnw,                      &amp;<a name='1424'>
                          grid%msfux,grid%msfuy, grid%msfvx, grid%msfvx_inv,            &amp;<a name='1425'>
                          grid%msfvy, grid%msftx,grid%msfty,                            &amp;<a name='1426'>
                          iteration, config_flags,                                      &amp;<a name='1427'>
                          ids, ide, jds, jde, kds, kde,      &amp;<a name='1428'>
                          ims, ime, jms, jme, kms, kme,      &amp;<a name='1429'>
                          grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1430'>
                          grid%j_start(ij), grid%j_end(ij),  &amp;<a name='1431'>
                          k_start    , k_end                )<a name='1432'>
BENCH_END(advance_mu_t_tim)<a name='1433'>
       ENDDO<a name='1434'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1435'></font>
<a name='1436'>
<font color=#447700>!-----------------------------------------------------------<a name='1437'></font>
<font color=#447700>!  acoustic integration polar filter for smallstep mu, t<a name='1438'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1439'></font>
<a name='1440'>
       IF ( (config_flags%polar) ) THEN<a name='1441'>
<a name='1442'>
         CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_2"> ( grid=grid                                               &amp;<a name='1443'>
                ,lineno=__LINE__                                             &amp;<a name='1444'>
                ,flag_uv            = 0                                      &amp;<a name='1445'>
                ,flag_rurv          = 0                                      &amp;<a name='1446'>
                ,flag_wph           = 0                                      &amp;<a name='1447'>
                ,flag_ww            = 0                                      &amp;<a name='1448'>
                ,flag_t             = 1                                      &amp;<a name='1449'>
                ,flag_mu            = 1                                      &amp;<a name='1450'>
                ,flag_mut           = 0                                      &amp;<a name='1451'>
                ,flag_moist         = 0                                      &amp;<a name='1452'>
                ,flag_chem          = 0                                      &amp;<a name='1453'>
                ,flag_tracer        = 0                                      &amp;<a name='1454'>
                ,flag_scalar        = 0                                      &amp;<a name='1455'>
                ,actual_distance_average  = .FALSE.                          &amp;<a name='1456'>
                ,pos_def            = .FALSE.                                &amp;<a name='1457'>
                ,swap_pole_with_next_j = .FALSE.                             &amp;<a name='1458'>
                ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='1459'>
                ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='1460'>
                ,dclat = dclat                                               &amp;<a name='1461'>
                ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='1462'>
                ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='1463'>
                ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='1464'>
                ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='1465'>
                ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='1466'>
<a name='1467'>
         grid%muts = grid%mut + grid%mu_2  <font color=#447700>! reset muts using filtered mu_2<a name='1468'></font>
 <a name='1469'>
       END IF<a name='1470'>
<a name='1471'>
<font color=#447700>!-----------------------------------------------------------<a name='1472'></font>
<font color=#447700>!  end acoustic integration polar filter for smallstep mu, t<a name='1473'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1474'></font>
<a name='1475'>
BENCH_START(spec_bdy_t_tim)<a name='1476'>
<a name='1477'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1478'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1479'></font>
       DO ij = 1 , grid%num_tiles<a name='1480'>
<a name='1481'>
         IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1482'>
<a name='1483'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_3">(grid%t_2, t_tend, dts_rk,        &amp;<a name='1484'>
                               't'         , config_flags,      &amp;<a name='1485'>
                               grid%spec_zone,                  &amp;<a name='1486'>
                               ids,ide, jds,jde, kds,kde,       &amp;<a name='1487'>
                               ims,ime, jms,jme, kms,kme,       &amp;<a name='1488'>
                               ips,ipe, jps,jpe, kps,kpe,       &amp;<a name='1489'>
                               grid%i_start(ij), grid%i_end(ij),&amp;<a name='1490'>
                               grid%j_start(ij), grid%j_end(ij),&amp;<a name='1491'>
                               k_start    , k_end              )<a name='1492'>
<a name='1493'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_4">(grid%mu_2, mu_tend, dts_rk,       &amp;<a name='1494'>
                               'm'         , config_flags,      &amp;<a name='1495'>
                               grid%spec_zone,                  &amp;<a name='1496'>
                               ids,ide, jds,jde, 1  ,1  ,       &amp;<a name='1497'>
                               ims,ime, jms,jme, 1  ,1  ,       &amp;<a name='1498'>
                               ips,ipe, jps,jpe, 1  ,1  ,       &amp;<a name='1499'>
                               grid%i_start(ij), grid%i_end(ij),&amp;<a name='1500'>
                               grid%j_start(ij), grid%j_end(ij),&amp;<a name='1501'>
                               1    , 1             )<a name='1502'>
<a name='1503'>
           CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_5">(grid%muts, mu_tend, dts_rk,      &amp;<a name='1504'>
                              'm'         , config_flags, &amp;<a name='1505'>
                              grid%spec_zone,                  &amp;<a name='1506'>
                              ids,ide, jds,jde, 1  ,1  ,  &amp; <font color=#447700>! domain dims<a name='1507'></font>
                              ims,ime, jms,jme, 1  ,1  ,  &amp; <font color=#447700>! memory dims<a name='1508'></font>
                              ips,ipe, jps,jpe, 1  ,1  ,  &amp; <font color=#447700>! patch  dims<a name='1509'></font>
                              grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1510'>
                              grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1511'>
                              1    , 1             )<a name='1512'>
         ENDIF<a name='1513'>
BENCH_END(spec_bdy_t_tim)<a name='1514'>
<a name='1515'>
         <font color=#447700>! small (acoustic) step for the vertical momentum,<a name='1516'></font>
         <font color=#447700>! density and coupled potential temperature.<a name='1517'></font>
<a name='1518'>
<a name='1519'>
BENCH_START(advance_w_tim)<a name='1520'>
         IF ( config_flags%non_hydrostatic ) THEN<a name='1521'>
           CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#ADVANCE_W'>advance_w</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_W_1">( grid%w_2, rw_tend, grid%ww, w_save,         &amp;<a name='1522'>
                           grid%u_2, grid%v_2,                         &amp;<a name='1523'>
                           grid%mu_2, grid%mut, muave, grid%muts,      &amp;<a name='1524'>
                           grid%c1h, grid%c2h, grid%c1f, grid%c2f,     &amp;<a name='1525'>
                           grid%c3h, grid%c4h, grid%c3f, grid%c4f,     &amp;<a name='1526'>
                           t_2save, grid%t_2, grid%t_save,             &amp;<a name='1527'>
                           grid%ph_2, ph_save, grid%phb, ph_tend,      &amp;<a name='1528'>
                           grid%ht, c2a, cqw, grid%alt, grid%alb,      &amp;<a name='1529'>
                           a, alpha, gamma,                            &amp;<a name='1530'>
                           grid%rdx, grid%rdy, dts_rk, t0, grid%epssm, &amp;<a name='1531'>
                           grid%dnw, grid%fnm, grid%fnp, grid%rdnw,    &amp;<a name='1532'>
                           grid%rdn, grid%cf1, grid%cf2, grid%cf3,     &amp;<a name='1533'>
                           grid%msftx, grid%msfty,                     &amp;<a name='1534'>
                           config_flags,  config_flags%top_lid,        &amp;<a name='1535'>
                           ids,ide, jds,jde, kds,kde,                  &amp;<a name='1536'>
                           ims,ime, jms,jme, kms,kme,                  &amp;<a name='1537'>
                           grid%i_start(ij), grid%i_end(ij),           &amp;<a name='1538'>
                           grid%j_start(ij), grid%j_end(ij),           &amp;<a name='1539'>
                           k_start    , k_end                          )<a name='1540'>
         ENDIF<a name='1541'>
BENCH_END(advance_w_tim)<a name='1542'>
<a name='1543'>
       ENDDO<a name='1544'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1545'></font>
<a name='1546'>
<font color=#447700>!-----------------------------------------------------------<a name='1547'></font>
<font color=#447700>!  acoustic integration polar filter for smallstep w, geopotential<a name='1548'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1549'></font>
<a name='1550'>
       IF ( (config_flags%polar) .AND. (config_flags%non_hydrostatic) ) THEN<a name='1551'>
<a name='1552'>
         CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_3"> ( grid=grid                                               &amp;<a name='1553'>
                ,lineno=__LINE__                                             &amp;<a name='1554'>
                ,flag_uv            = 0                                      &amp;<a name='1555'>
                ,flag_rurv          = 0                                      &amp;<a name='1556'>
                ,flag_wph           = 1                                      &amp;<a name='1557'>
                ,flag_ww            = 0                                      &amp;<a name='1558'>
                ,flag_t             = 0                                      &amp;<a name='1559'>
                ,flag_mu            = 0                                      &amp;<a name='1560'>
                ,flag_mut           = 0                                      &amp;<a name='1561'>
                ,flag_moist         = 0                                      &amp;<a name='1562'>
                ,flag_chem          = 0                                      &amp;<a name='1563'>
                ,flag_tracer        = 0                                      &amp;<a name='1564'>
                ,flag_scalar        = 0                                      &amp;<a name='1565'>
                ,actual_distance_average  = .FALSE.                          &amp;<a name='1566'>
                ,pos_def            = .FALSE.                                &amp;<a name='1567'>
                ,swap_pole_with_next_j = .FALSE.                             &amp;<a name='1568'>
                ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='1569'>
                ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='1570'>
                ,dclat = dclat                                               &amp;<a name='1571'>
                ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='1572'>
                ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='1573'>
                ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='1574'>
                ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='1575'>
                ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='1576'>
<a name='1577'>
       END IF<a name='1578'>
<a name='1579'>
<font color=#447700>!-----------------------------------------------------------<a name='1580'></font>
<font color=#447700>!  end acoustic integration polar filter for smallstep w, geopotential<a name='1581'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1582'></font>
<a name='1583'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1584'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1585'></font>
       DO ij = 1 , grid%num_tiles<a name='1586'>
<a name='1587'>
BENCH_START(sumflux_tim)<a name='1588'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SUMFLUX'>sumflux</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SUMFLUX_1"> ( grid%u_2, grid%v_2, grid%ww,          &amp;<a name='1589'>
                        grid%u_save, grid%v_save, ww1,        &amp;<a name='1590'>
                        grid%muu, grid%muv,                   &amp;<a name='1591'>
                        grid%c1h, grid%c2h, grid%c1f, grid%c2f, &amp;<a name='1592'>
                        grid%c3h, grid%c4h, grid%c3f, grid%c4f, &amp;<a name='1593'>
                        grid%ru_m, grid%rv_m, grid%ww_m, grid%epssm,  &amp;<a name='1594'>
                        grid%msfux, grid% msfuy, grid%msfvx,  &amp;<a name='1595'>
                        grid%msfvx_inv, grid%msfvy,           &amp;<a name='1596'>
                        iteration, number_of_small_timesteps, &amp;<a name='1597'>
                        ids, ide, jds, jde, kds, kde,         &amp;<a name='1598'>
                        ims, ime, jms, jme, kms, kme,         &amp;<a name='1599'>
                        grid%i_start(ij), grid%i_end(ij),     &amp;<a name='1600'>
                        grid%j_start(ij), grid%j_end(ij),     &amp;<a name='1601'>
                        k_start    , k_end                   )<a name='1602'>
BENCH_END(sumflux_tim)<a name='1603'>
<a name='1604'>
         IF( config_flags%specified .or. config_flags%nested ) THEN<a name='1605'>
<a name='1606'>
BENCH_START(spec_bdynhyd_tim)<a name='1607'>
           IF (config_flags%non_hydrostatic)  THEN<a name='1608'>
             CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDYUPDATE_PH'>spec_bdyupdate_ph</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_PH_1">( ph_save, grid%ph_2, ph_tend,     &amp;<a name='1609'>
                                     mu_tend, grid%muts,              &amp;<a name='1610'>
                                     grid%c1f, grid%c2f, dts_rk,      &amp;<a name='1611'>
                                     'h'         , config_flags,      &amp;<a name='1612'>
                                     grid%spec_zone,                  &amp;<a name='1613'>
                                     ids,ide, jds,jde, kds,kde,       &amp;<a name='1614'>
                                     ims,ime, jms,jme, kms,kme,       &amp;<a name='1615'>
                                     ips,ipe, jps,jpe, kps,kpe,       &amp;<a name='1616'>
                                     grid%i_start(ij), grid%i_end(ij),&amp;<a name='1617'>
                                     grid%j_start(ij), grid%j_end(ij),&amp;<a name='1618'>
                                     k_start    , k_end               )<a name='1619'>
             IF( config_flags%specified ) THEN<a name='1620'>
               CALL <A href='../../html_code/share/module_bc.F.html#ZERO_GRAD_BDY'>zero_grad_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_GRAD_BDY_1"> ( grid%w_2,                         &amp;<a name='1621'>
                                    'w'         , config_flags,       &amp;<a name='1622'>
                                    grid%spec_zone,                   &amp;<a name='1623'>
                                    ids,ide, jds,jde, kds,kde,        &amp;<a name='1624'>
                                    ims,ime, jms,jme, kms,kme,        &amp;<a name='1625'>
                                    ips,ipe, jps,jpe, kps,kpe,        &amp;<a name='1626'>
                                    grid%i_start(ij), grid%i_end(ij), &amp;<a name='1627'>
                                    grid%j_start(ij), grid%j_end(ij), &amp;<a name='1628'>
                                    k_start    , k_end                )<a name='1629'>
             ELSE<a name='1630'>
               CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDYUPDATE'>spec_bdyupdate</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDYUPDATE_6"> ( grid%w_2, rw_tend, dts_rk,       &amp;<a name='1631'>
                                     'h'         , config_flags,      &amp;<a name='1632'>
                                     grid%spec_zone,                  &amp;<a name='1633'>
                                     ids,ide, jds,jde, kds,kde,       &amp;<a name='1634'>
                                     ims,ime, jms,jme, kms,kme,       &amp;<a name='1635'>
                                     ips,ipe, jps,jpe, kps,kpe,       &amp;<a name='1636'>
                                     grid%i_start(ij), grid%i_end(ij),&amp;<a name='1637'>
                                     grid%j_start(ij), grid%j_end(ij),&amp;<a name='1638'>
                                     k_start    , k_end               )<a name='1639'>
             ENDIF<a name='1640'>
           ENDIF<a name='1641'>
BENCH_END(spec_bdynhyd_tim)<a name='1642'>
         ENDIF<a name='1643'>
<a name='1644'>
BENCH_START(cald_p_rho_tim)<a name='1645'>
         CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#CALC_P_RHO'>calc_p_rho</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_2">( grid%al, grid%p, grid%ph_2,                 &amp;<a name='1646'>
                          grid%alt, grid%t_2, grid%t_save, c2a, pm1,  &amp;<a name='1647'>
                          grid%mu_2, grid%muts,                       &amp;<a name='1648'>
                          grid%c1h, grid%c2h, grid%c1f, grid%c2f,     &amp;<a name='1649'>
                          grid%c3h, grid%c4h, grid%c3f, grid%c4f,     &amp;<a name='1650'>
                          grid%znu, t0,                               &amp;<a name='1651'>
                          grid%rdnw, grid%dnw, grid%smdiv,            &amp;<a name='1652'>
                          config_flags%non_hydrostatic, iteration,    &amp;<a name='1653'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='1654'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='1655'>
                          grid%i_start(ij), grid%i_end(ij), &amp;<a name='1656'>
                          grid%j_start(ij), grid%j_end(ij), &amp;<a name='1657'>
                          k_start    , k_end               )<a name='1658'>
BENCH_END(cald_p_rho_tim)<a name='1659'>
<a name='1660'>
       ENDDO<a name='1661'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1662'></font>
<a name='1663'>
#ifdef DM_PARALLEL<a name='1664'>
<font color=#447700>!<a name='1665'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='1666'></font>
<font color=#447700>!<a name='1667'></font>
<font color=#447700>!         *                     *<a name='1668'></font>
<font color=#447700>!       * + *      * + *        +<a name='1669'></font>
<font color=#447700>!         *                     *<a name='1670'></font>
<font color=#447700>!<a name='1671'></font>
<font color=#447700>!  ph_2   x<a name='1672'></font>
<font color=#447700>!  al     x<a name='1673'></font>
<font color=#447700>!  p      x<a name='1674'></font>
<font color=#447700>!<a name='1675'></font>
<font color=#447700>!  2D variables (x,y)<a name='1676'></font>
<font color=#447700>!<a name='1677'></font>
<font color=#447700>!  mu_2   x<a name='1678'></font>
<font color=#447700>!  muts   x<a name='1679'></font>
<font color=#447700>!  mudf   x<a name='1680'></font>
<a name='1681'>
#      include "<A href='../../html_code/include/HALO_EM_C2.inc.html'>HALO_EM_C2.inc</A>"<A NAME="HALO_EM_C2.inc_25"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1682'>
#      include "<A href='../../html_code/include/PERIOD_BDY_EM_B3.inc.html'>PERIOD_BDY_EM_B3.inc</A>"<A NAME="PERIOD_BDY_EM_B3.inc_26"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1683'>
#endif<a name='1684'>
<a name='1685'>
BENCH_START(phys_bc_tim)<a name='1686'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1687'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1688'></font>
       DO ij = 1 , grid%num_tiles<a name='1689'>
<a name='1690'>
       <font color=#447700>! boundary condition set for next small timestep<a name='1691'></font>
<a name='1692'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_101">( grid%ph_2, 'w', config_flags,          &amp;<a name='1693'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='1694'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='1695'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='1696'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1697'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='1698'>
                                 k_start    , k_end               )<a name='1699'>
<a name='1700'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_102">( grid%al, 'p', config_flags,            &amp;<a name='1701'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='1702'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='1703'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='1704'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1705'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='1706'>
                                 k_start    , k_end               )<a name='1707'>
<a name='1708'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_103">( grid%p, 'p', config_flags,             &amp;<a name='1709'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='1710'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='1711'>
                                 ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='1712'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1713'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='1714'>
                                 k_start    , k_end               )<a name='1715'>
<a name='1716'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_15">( grid%muts, 't', config_flags,          &amp;<a name='1717'>
                                 ids, ide, jds, jde,               &amp;<a name='1718'>
                                 ims, ime, jms, jme,               &amp;<a name='1719'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1720'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1721'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1722'>
<a name='1723'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_16">( grid%mu_2, 't', config_flags,          &amp;<a name='1724'>
                                 ids, ide, jds, jde,               &amp;<a name='1725'>
                                 ims, ime, jms, jme,               &amp;<a name='1726'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1727'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1728'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1729'>
<a name='1730'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_17">( grid%mudf, 't', config_flags,          &amp;<a name='1731'>
                                 ids, ide, jds, jde,               &amp;<a name='1732'>
                                 ims, ime, jms, jme,               &amp;<a name='1733'>
                                 ips, ipe, jps, jpe,               &amp;<a name='1734'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='1735'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1736'>
<a name='1737'>
       END DO<a name='1738'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1739'></font>
BENCH_END(phys_bc_tim)<a name='1740'>
<a name='1741'>
     END DO small_steps<a name='1742'>
<a name='1743'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1744'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='1745'></font>
     DO ij = 1 , grid%num_tiles<a name='1746'>
<a name='1747'>
       CALL wrf_debug ( 200 , ' call rk_small_finish' )<a name='1748'>
<a name='1749'>
      <font color=#447700>! change time-perturbation variables back to <a name='1750'></font>
      <font color=#447700>! full perturbation variables.<a name='1751'></font>
      <font color=#447700>! first get updated mu at u and v points<a name='1752'></font>
<a name='1753'>
BENCH_START(calc_mu_uv_tim)<a name='1754'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_MU_UV_1'>calc_mu_uv_1</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_MU_UV_1_1"> ( config_flags,                     &amp;<a name='1755'>
                           grid%muts, grid%muus, grid%muvs,  &amp;<a name='1756'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='1757'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='1758'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='1759'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='1760'>
                           k_start    , k_end               )<a name='1761'>
BENCH_END(calc_mu_uv_tim)<a name='1762'>
BENCH_START(small_step_finish_tim)<a name='1763'>
       CALL <A href='../../html_code/dyn_em/module_small_step_em.F.html#SMALL_STEP_FINISH'>small_step_finish</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMALL_STEP_FINISH_1">( grid%u_2, grid%u_1, grid%v_2, grid%v_1, grid%w_2, grid%w_1,     &amp;<a name='1764'>
                               grid%t_2, grid%t_1, grid%ph_2, grid%ph_1, grid%ww, ww1,    &amp;<a name='1765'>
                               grid%mu_2, grid%mu_1,                       &amp;<a name='1766'>
                               grid%mut, grid%muts, grid%muu, grid%muus, grid%muv, grid%muvs,  &amp; <a name='1767'>
                               grid%c1h, grid%c2h, grid%c1f, grid%c2f, &amp;<a name='1768'>
                               grid%c3h, grid%c4h, grid%c3f, grid%c4f, &amp;<a name='1769'>
                               grid%u_save, grid%v_save, w_save,           &amp;<a name='1770'>
                               grid%t_save, ph_save, mu_save,         &amp;<a name='1771'>
                               grid%msfux,grid%msfuy, grid%msfvx,grid%msfvy, grid%msftx,grid%msfty, &amp;<a name='1772'>
                               grid%h_diabatic,                       &amp;<a name='1773'>
                               number_of_small_timesteps,dts_rk, &amp;<a name='1774'>
                               rk_step, rk_order,                &amp;<a name='1775'>
                               ids, ide, jds, jde, kds, kde,     &amp;<a name='1776'>
                               ims, ime, jms, jme, kms, kme,     &amp;<a name='1777'>
                               grid%i_start(ij), grid%i_end(ij), &amp;<a name='1778'>
                               grid%j_start(ij), grid%j_end(ij), &amp;<a name='1779'>
                               k_start    , k_end               )<a name='1780'>
<font color=#447700>!  call  to set ru_m, rv_m and ww_m b.c's for PD advection<a name='1781'></font>
<a name='1782'>
       IF (rk_step == rk_order) THEN<a name='1783'>
<a name='1784'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_104">( grid%ru_m, 'u', config_flags,   &amp;<a name='1785'>
                                 ids, ide, jds, jde, kds, kde,      &amp;<a name='1786'>
                                 ims, ime, jms, jme, kms, kme,      &amp;<a name='1787'>
                                 ips, ipe, jps, jpe, kps, kpe,      &amp;<a name='1788'>
                                 grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1789'>
                                 grid%j_start(ij), grid%j_end(ij),  &amp;<a name='1790'>
                                 k_start    , k_end                )<a name='1791'>
<a name='1792'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_105">( grid%rv_m, 'v', config_flags,   &amp;<a name='1793'>
                                 ids, ide, jds, jde, kds, kde,      &amp;<a name='1794'>
                                 ims, ime, jms, jme, kms, kme,      &amp;<a name='1795'>
                                 ips, ipe, jps, jpe, kps, kpe,      &amp;<a name='1796'>
                                 grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1797'>
                                 grid%j_start(ij), grid%j_end(ij),  &amp;<a name='1798'>
                                 k_start    , k_end                )<a name='1799'>
<a name='1800'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_106">( grid%ww_m, 'w', config_flags,   &amp;<a name='1801'>
                                 ids, ide, jds, jde, kds, kde,      &amp;<a name='1802'>
                                 ims, ime, jms, jme, kms, kme,      &amp;<a name='1803'>
                                 ips, ipe, jps, jpe, kps, kpe,      &amp;<a name='1804'>
                                 grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1805'>
                                 grid%j_start(ij), grid%j_end(ij),  &amp;<a name='1806'>
                                 k_start    , k_end                )<a name='1807'>
<a name='1808'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_18">( grid%mut, 't', config_flags,   &amp;<a name='1809'>
                                 ids, ide, jds, jde,               &amp;<a name='1810'>
                                 ims, ime, jms, jme,                &amp;<a name='1811'>
                                 ips, ipe, jps, jpe,                &amp;<a name='1812'>
                                 grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1813'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1814'>
<a name='1815'>
         CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC2D'>set_physical_bc2d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC2D_19">( grid%muts, 't', config_flags,   &amp;<a name='1816'>
                                 ids, ide, jds, jde,               &amp;<a name='1817'>
                                 ims, ime, jms, jme,                &amp;<a name='1818'>
                                 ips, ipe, jps, jpe,                &amp;<a name='1819'>
                                 grid%i_start(ij), grid%i_end(ij),  &amp;<a name='1820'>
                                 grid%j_start(ij), grid%j_end(ij) )<a name='1821'>
 <a name='1822'>
       END IF<a name='1823'>
<a name='1824'>
BENCH_END(small_step_finish_tim)<a name='1825'>
<a name='1826'>
     END DO<a name='1827'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='1828'></font>
<a name='1829'>
<font color=#447700>!-----------------------------------------------------------<a name='1830'></font>
<font color=#447700>!  polar filter for full dynamics variables and time-averaged mass fluxes <a name='1831'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1832'></font>
<a name='1833'>
     IF (config_flags%polar) THEN<a name='1834'>
<a name='1835'>
       CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_4"> ( grid=grid                                                   &amp;<a name='1836'>
                  ,lineno=__LINE__                                             &amp;<a name='1837'>
                  ,flag_uv            = 1                                      &amp;<a name='1838'>
                  ,flag_rurv          = 1                                      &amp;<a name='1839'>
                  ,flag_wph           = 1                                      &amp;<a name='1840'>
                  ,flag_ww            = 1                                      &amp;<a name='1841'>
                  ,flag_t             = 1                                      &amp;<a name='1842'>
                  ,flag_mu            = 1                                      &amp;<a name='1843'>
                  ,flag_mut           = 1                                      &amp;<a name='1844'>
                  ,flag_moist         = 0                                      &amp;<a name='1845'>
                  ,flag_chem          = 0                                      &amp;<a name='1846'>
                  ,flag_tracer        = 0                                      &amp;<a name='1847'>
                  ,flag_scalar        = 0                                      &amp;<a name='1848'>
                  ,actual_distance_average  = .FALSE.                          &amp;<a name='1849'>
                  ,pos_def            = .FALSE.                                &amp;<a name='1850'>
                  ,swap_pole_with_next_j = .FALSE.                             &amp;<a name='1851'>
                  ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='1852'>
                  ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='1853'>
                  ,dclat = dclat                                               &amp;<a name='1854'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='1855'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='1856'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='1857'>
                  ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='1858'>
                  ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='1859'>
<a name='1860'>
     END IF<a name='1861'>
<a name='1862'>
<font color=#447700>!-----------------------------------------------------------<a name='1863'></font>
<font color=#447700>!  end polar filter for full dynamics variables and time-averaged mass fluxes <a name='1864'></font>
<font color=#447700>!-----------------------------------------------------------<a name='1865'></font>
<a name='1866'>
<font color=#447700>!-----------------------------------------------------------------------<a name='1867'></font>
<font color=#447700>!  add in physics tendency first if positive definite advection is used.<a name='1868'></font>
<font color=#447700>!  pd advection applies advective flux limiter on last runge-kutta step<a name='1869'></font>
<font color=#447700>!-----------------------------------------------------------------------<a name='1870'></font>
<font color=#447700>! first moisture<a name='1871'></font>
<a name='1872'>
     IF ((config_flags%moist_adv_opt /= ORIGINAL .and. config_flags%moist_adv_opt /= WENO_SCALAR) .and. &amp;<a name='1873'>
         (rk_step == rk_order)) THEN<a name='1874'>
<a name='1875'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1876'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1877'></font>
       DO ij = 1 , grid%num_tiles<a name='1878'>
         CALL wrf_debug ( 200 , ' call rk_update_scalar_pd' )<a name='1879'>
         DO im = PARAM_FIRST_SCALAR, num_3d_m<a name='1880'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR_PD'>rk_update_scalar_pd</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_PD_1">( im, im,                                   &amp;<a name='1881'>
                                     moist_old(ims,kms,jms,im),                &amp;<a name='1882'>
                                     moist_tend(ims,kms,jms,im),               &amp;<a name='1883'>
                                     grid%c1h, grid%c2h,                       &amp;<a name='1884'>
                                     grid%mu_1, grid%mu_1, grid%mub,  &amp;<a name='1885'>
                                     rk_step, dt_rk, grid%spec_zone,           &amp;<a name='1886'>
                                     config_flags,                             &amp;<a name='1887'>
                                     ids, ide, jds, jde, kds, kde,             &amp;<a name='1888'>
                                     ims, ime, jms, jme, kms, kme,             &amp;<a name='1889'>
                                     grid%i_start(ij), grid%i_end(ij),         &amp;<a name='1890'>
                                     grid%j_start(ij), grid%j_end(ij),         &amp;<a name='1891'>
                                     k_start    , k_end                       )<a name='1892'>
         ENDDO<a name='1893'>
       END DO<a name='1894'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1895'></font>
<a name='1896'>
<font color=#447700>!---------------------- positive definite bc call<a name='1897'></font>
#ifdef DM_PARALLEL<a name='1898'>
       IF (config_flags%moist_adv_opt /= ORIGINAL .and. config_flags%moist_adv_opt /= WENO_SCALAR) THEN<a name='1899'>
         IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='1900'>
#     include "<A href='../../html_code/include/HALO_EM_MOIST_OLD_E_5.inc.html'>HALO_EM_MOIST_OLD_E_5.inc</A>"<A NAME="HALO_EM_MOIST_OLD_E_5.inc_27"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1901'>
         ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='1902'>
#     include "<A href='../../html_code/include/HALO_EM_MOIST_OLD_E_7.inc.html'>HALO_EM_MOIST_OLD_E_7.inc</A>"<A NAME="HALO_EM_MOIST_OLD_E_7.inc_28"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1903'>
         ELSE<a name='1904'>
           WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='1905'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_51">(TRIM(wrf_err_message))<a name='1906'>
         ENDIF<a name='1907'>
       ENDIF<a name='1908'>
#endif<a name='1909'>
<a name='1910'>
#ifdef DM_PARALLEL<a name='1911'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST_OLD.inc.html'>PERIOD_BDY_EM_MOIST_OLD.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST_OLD.inc_29"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1912'>
#endif<a name='1913'>
<a name='1914'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1915'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1916'></font>
       DO ij = 1 , grid%num_tiles<a name='1917'>
         IF (num_3d_m &gt;= PARAM_FIRST_SCALAR) THEN<a name='1918'>
           DO im = PARAM_FIRST_SCALAR , num_3d_m<a name='1919'>
             CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_107">( moist_old(ims,kms,jms,im), 'p', config_flags,   &amp;<a name='1920'>
                                     ids, ide, jds, jde, kds, kde,                  &amp;<a name='1921'>
                                     ims, ime, jms, jme, kms, kme,                  &amp;<a name='1922'>
                                     ips, ipe, jps, jpe, kps, kpe,                  &amp;<a name='1923'>
                                     grid%i_start(ij), grid%i_end(ij),              &amp;<a name='1924'>
                                     grid%j_start(ij), grid%j_end(ij),              &amp;<a name='1925'>
                                     k_start    , k_end                            )<a name='1926'>
           END DO<a name='1927'>
         ENDIF<a name='1928'>
       END DO<a name='1929'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1930'></font>
<a name='1931'>
     END IF  <font color=#447700>! end if for moist_adv_opt<a name='1932'></font>
<a name='1933'>
<font color=#447700>! scalars<a name='1934'></font>
<a name='1935'>
     IF ((config_flags%scalar_adv_opt /= ORIGINAL .and. config_flags%scalar_adv_opt /= WENO_SCALAR) .and. &amp;<a name='1936'>
         (rk_step == rk_order)) THEN<a name='1937'>
<a name='1938'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1939'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='1940'></font>
       DO ij = 1 , grid%num_tiles<a name='1941'>
         CALL wrf_debug ( 200 , ' call rk_update_scalar_pd' )<a name='1942'>
         DO im = PARAM_FIRST_SCALAR, num_3d_s<a name='1943'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR_PD'>rk_update_scalar_pd</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_PD_2">( im, im,                                  &amp;<a name='1944'>
                                     scalar_old(ims,kms,jms,im),              &amp;<a name='1945'>
                                     scalar_tend(ims,kms,jms,im),             &amp;<a name='1946'>
                                     grid%c1h, grid%c2h,                      &amp;<a name='1947'>
                                     grid%mu_1, grid%mu_1, grid%mub, &amp;<a name='1948'>
                                     rk_step, dt_rk, grid%spec_zone,          &amp;<a name='1949'>
                                     config_flags,                            &amp;<a name='1950'>
                                     ids, ide, jds, jde, kds, kde,            &amp;<a name='1951'>
                                     ims, ime, jms, jme, kms, kme,            &amp;<a name='1952'>
                                     grid%i_start(ij), grid%i_end(ij),        &amp;<a name='1953'>
                                     grid%j_start(ij), grid%j_end(ij),        &amp;<a name='1954'>
                                     k_start    , k_end                      )<a name='1955'>
         ENDDO<a name='1956'>
       ENDDO<a name='1957'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='1958'></font>
<a name='1959'>
<font color=#447700>!---------------------- positive definite bc call<a name='1960'></font>
#ifdef DM_PARALLEL<a name='1961'>
       IF (config_flags%scalar_adv_opt /= ORIGINAL .and. config_flags%scalar_adv_opt /= WENO_SCALAR) THEN<a name='1962'>
#ifndef RSL<a name='1963'>
         IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='1964'>
#     include "<A href='../../html_code/include/HALO_EM_SCALAR_OLD_E_5.inc.html'>HALO_EM_SCALAR_OLD_E_5.inc</A>"<A NAME="HALO_EM_SCALAR_OLD_E_5.inc_30"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1965'>
         ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='1966'>
#     include "<A href='../../html_code/include/HALO_EM_SCALAR_OLD_E_7.inc.html'>HALO_EM_SCALAR_OLD_E_7.inc</A>"<A NAME="HALO_EM_SCALAR_OLD_E_7.inc_31"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1967'>
         ELSE<a name='1968'>
           WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='1969'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_52">(TRIM(wrf_err_message))<a name='1970'>
         ENDIF<a name='1971'>
#else<a name='1972'>
         WRITE(wrf_err_message,*)'cannot use pd scheme with RSL - use RSL-LITE'<a name='1973'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_53">(TRIM(wrf_err_message))<a name='1974'>
#endif   <a name='1975'>
  endif<a name='1976'>
#endif<a name='1977'>
<a name='1978'>
#ifdef DM_PARALLEL<a name='1979'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_SCALAR_OLD.inc.html'>PERIOD_BDY_EM_SCALAR_OLD.inc</A>"<A NAME="PERIOD_BDY_EM_SCALAR_OLD.inc_32"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='1980'>
#endif<a name='1981'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='1982'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='1983'></font>
<a name='1984'>
         DO ij = 1 , grid%num_tiles<a name='1985'>
           IF (num_3d_s &gt;= PARAM_FIRST_SCALAR) THEN<a name='1986'>
             DO im = PARAM_FIRST_SCALAR , num_3d_s<a name='1987'>
               CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_108">(  scalar_old(ims,kms,jms,im), 'p', config_flags, &amp;<a name='1988'>
                                        ids, ide, jds, jde, kds, kde,                    &amp;<a name='1989'>
                                        ims, ime, jms, jme, kms, kme,                    &amp;<a name='1990'>
                                        ips, ipe, jps, jpe, kps, kpe,                    &amp;<a name='1991'>
                                        grid%i_start(ij), grid%i_end(ij),                &amp;<a name='1992'>
                                        grid%j_start(ij), grid%j_end(ij),                &amp;<a name='1993'>
                                        k_start    , k_end                              )<a name='1994'>
             END DO<a name='1995'>
           ENDIF<a name='1996'>
         END DO<a name='1997'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='1998'></font>
<a name='1999'>
       END IF  <font color=#447700>! end if for scalar_adv_opt<a name='2000'></font>
<a name='2001'>
<font color=#447700>! chem<a name='2002'></font>
<a name='2003'>
       IF ((config_flags%chem_adv_opt /= ORIGINAL .and. config_flags%chem_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order)) THEN<a name='2004'>
<a name='2005'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2006'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='2007'></font>
         DO ij = 1 , grid%num_tiles<a name='2008'>
           CALL wrf_debug ( 200 , ' call rk_update_scalar_pd' )<a name='2009'>
           DO im = PARAM_FIRST_SCALAR, num_3d_c<a name='2010'>
             CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR_PD'>rk_update_scalar_pd</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_PD_3">( im, im,                                  &amp;<a name='2011'>
                                       chem_old(ims,kms,jms,im),                &amp;<a name='2012'>
                                       chem_tend(ims,kms,jms,im),               &amp;<a name='2013'>
                                       grid%c1h, grid%c2h,                      &amp;<a name='2014'>
                                       grid%mu_1, grid%mu_1, grid%mub, &amp;<a name='2015'>
                                       rk_step, dt_rk, grid%spec_zone,          &amp;<a name='2016'>
                                       config_flags,                            &amp;<a name='2017'>
                                       ids, ide, jds, jde, kds, kde,            &amp;<a name='2018'>
                                       ims, ime, jms, jme, kms, kme,            &amp;<a name='2019'>
                                       grid%i_start(ij), grid%i_end(ij),        &amp;<a name='2020'>
                                       grid%j_start(ij), grid%j_end(ij),        &amp;<a name='2021'>
                                       k_start    , k_end                      )<a name='2022'>
           ENDDO<a name='2023'>
         END DO<a name='2024'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2025'></font>
<a name='2026'>
<font color=#447700>!---------------------- positive definite bc call<a name='2027'></font>
#ifdef DM_PARALLEL<a name='2028'>
         IF (config_flags%chem_adv_opt /= ORIGINAL .and. config_flags%chem_adv_opt /= WENO_SCALAR) THEN<a name='2029'>
           IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='2030'>
#     include "<A href='../../html_code/include/HALO_EM_CHEM_OLD_E_5.inc.html'>HALO_EM_CHEM_OLD_E_5.inc</A>"<A NAME="HALO_EM_CHEM_OLD_E_5.inc_33"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2031'>
           ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='2032'>
#     include "<A href='../../html_code/include/HALO_EM_CHEM_OLD_E_7.inc.html'>HALO_EM_CHEM_OLD_E_7.inc</A>"<A NAME="HALO_EM_CHEM_OLD_E_7.inc_34"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2033'>
           ELSE<a name='2034'>
             WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='2035'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_54">(TRIM(wrf_err_message))<a name='2036'>
           ENDIF<a name='2037'>
         ENDIF<a name='2038'>
#endif<a name='2039'>
<a name='2040'>
#ifdef DM_PARALLEL<a name='2041'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM_OLD.inc.html'>PERIOD_BDY_EM_CHEM_OLD.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM_OLD.inc_35"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2042'>
#endif<a name='2043'>
<a name='2044'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2045'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='2046'></font>
         DO ij = 1 , grid%num_tiles<a name='2047'>
           IF (num_3d_c &gt;= PARAM_FIRST_SCALAR) THEN<a name='2048'>
             DO im = PARAM_FIRST_SCALAR , num_3d_c<a name='2049'>
               CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_109">(  chem_old(ims,kms,jms,im), 'p', config_flags,     &amp;<a name='2050'>
                                        ids, ide, jds, jde, kds, kde,                    &amp;<a name='2051'>
                                        ims, ime, jms, jme, kms, kme,                    &amp;<a name='2052'>
                                        ips, ipe, jps, jpe, kps, kpe,                    &amp;<a name='2053'>
                                        grid%i_start(ij), grid%i_end(ij),                &amp;<a name='2054'>
                                        grid%j_start(ij), grid%j_end(ij),                &amp;<a name='2055'>
                                        k_start    , k_end                              )<a name='2056'>
             END DO <a name='2057'>
           ENDIF<a name='2058'>
         END DO<a name='2059'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2060'></font>
<a name='2061'>
       ENDIF  <font color=#447700>! end if for chem_adv_opt<a name='2062'></font>
<a name='2063'>
<font color=#447700>! tracer<a name='2064'></font>
<a name='2065'>
       IF ((config_flags%tracer_adv_opt /= ORIGINAL .and. config_flags%tracer_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order)) THEN<a name='2066'>
<a name='2067'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2068'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='2069'></font>
         DO ij = 1 , grid%num_tiles<a name='2070'>
           CALL wrf_debug ( 200 , ' call rk_update_scalar_pd' )<a name='2071'>
           DO im = PARAM_FIRST_SCALAR, num_tracer<a name='2072'>
             CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR_PD'>rk_update_scalar_pd</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_PD_4">( im, im,                                  &amp;<a name='2073'>
                                       tracer_old(ims,kms,jms,im),                &amp;<a name='2074'>
                                       tracer_tend(ims,kms,jms,im),               &amp;<a name='2075'>
                                       grid%c1h, grid%c2h,                      &amp;<a name='2076'>
                                       grid%mu_1, grid%mu_1, grid%mub, &amp;<a name='2077'>
                                       rk_step, dt_rk, grid%spec_zone,          &amp;<a name='2078'>
                                       config_flags,                            &amp;<a name='2079'>
                                       ids, ide, jds, jde, kds, kde,            &amp;<a name='2080'>
                                       ims, ime, jms, jme, kms, kme,            &amp;<a name='2081'>
                                       grid%i_start(ij), grid%i_end(ij),        &amp;<a name='2082'>
                                       grid%j_start(ij), grid%j_end(ij),        &amp;<a name='2083'>
                                       k_start    , k_end                      )<a name='2084'>
           ENDDO<a name='2085'>
         END DO<a name='2086'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2087'></font>
<a name='2088'>
<font color=#447700>!---------------------- positive definite bc call<a name='2089'></font>
#ifdef DM_PARALLEL<a name='2090'>
         IF (config_flags%tracer_adv_opt /= ORIGINAL .and. config_flags%tracer_adv_opt /= WENO_SCALAR) THEN<a name='2091'>
           IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='2092'>
#     include "<A href='../../html_code/include/HALO_EM_TRACER_OLD_E_5.inc.html'>HALO_EM_TRACER_OLD_E_5.inc</A>"<A NAME="HALO_EM_TRACER_OLD_E_5.inc_36"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2093'>
           ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='2094'>
#     include "<A href='../../html_code/include/HALO_EM_TRACER_OLD_E_7.inc.html'>HALO_EM_TRACER_OLD_E_7.inc</A>"<A NAME="HALO_EM_TRACER_OLD_E_7.inc_37"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2095'>
           ELSE<a name='2096'>
             WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='2097'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_55">(TRIM(wrf_err_message))<a name='2098'>
           ENDIF<a name='2099'>
         ENDIF<a name='2100'>
#endif<a name='2101'>
<a name='2102'>
#ifdef DM_PARALLEL<a name='2103'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_TRACER_OLD.inc.html'>PERIOD_BDY_EM_TRACER_OLD.inc</A>"<A NAME="PERIOD_BDY_EM_TRACER_OLD.inc_38"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2104'>
#endif<a name='2105'>
<a name='2106'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2107'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='2108'></font>
         DO ij = 1 , grid%num_tiles<a name='2109'>
           IF (num_tracer &gt;= PARAM_FIRST_SCALAR) THEN<a name='2110'>
             DO im = PARAM_FIRST_SCALAR , num_tracer<a name='2111'>
               CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_110">(  tracer_old(ims,kms,jms,im), 'p', config_flags,   &amp;<a name='2112'>
                                        ids, ide, jds, jde, kds, kde,                    &amp;<a name='2113'>
                                        ims, ime, jms, jme, kms, kme,                    &amp;<a name='2114'>
                                        ips, ipe, jps, jpe, kps, kpe,                    &amp;<a name='2115'>
                                        grid%i_start(ij), grid%i_end(ij),                &amp;<a name='2116'>
                                        grid%j_start(ij), grid%j_end(ij),                &amp;<a name='2117'>
                                        k_start    , k_end                              )<a name='2118'>
             END DO <a name='2119'>
           ENDIF<a name='2120'>
         END DO<a name='2121'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2122'></font>
<a name='2123'>
       ENDIF  <font color=#447700>! end if for tracer_adv_opt<a name='2124'></font>
<a name='2125'>
<font color=#447700>! tke<a name='2126'></font>
<a name='2127'>
       IF ((config_flags%tke_adv_opt /= ORIGINAL .and. config_flags%tke_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order) &amp;<a name='2128'>
           .and. (config_flags%km_opt .eq. 2)                ) THEN<a name='2129'>
<a name='2130'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2131'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='2132'></font>
         DO ij = 1 , grid%num_tiles<a name='2133'>
           CALL wrf_debug ( 200 , ' call rk_update_scalar_pd' )<a name='2134'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR_PD'>rk_update_scalar_pd</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_PD_5">( 1, 1,                                    &amp;<a name='2135'>
                                     grid%tke_1,                              &amp;<a name='2136'>
                                     tke_tend(ims,kms,jms),                   &amp;<a name='2137'>
                                     grid%c1h, grid%c2h,                      &amp;<a name='2138'>
                                     grid%mu_1, grid%mu_1, grid%mub,          &amp;<a name='2139'>
                                     rk_step, dt_rk, grid%spec_zone,          &amp;<a name='2140'>
                                     config_flags,                            &amp;<a name='2141'>
                                     ids, ide, jds, jde, kds, kde,            &amp;<a name='2142'>
                                     ims, ime, jms, jme, kms, kme,            &amp;<a name='2143'>
                                     grid%i_start(ij), grid%i_end(ij),        &amp;<a name='2144'>
                                     grid%j_start(ij), grid%j_end(ij),        &amp;<a name='2145'>
                                     k_start    , k_end                       )<a name='2146'>
         ENDDO<a name='2147'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2148'></font>
<a name='2149'>
<font color=#447700>!---------------------- positive definite bc call<a name='2150'></font>
#ifdef DM_PARALLEL<a name='2151'>
         IF (config_flags%tke_adv_opt /= ORIGINAL .and. config_flags%tke_adv_opt /= WENO_SCALAR) THEN<a name='2152'>
           IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='2153'>
#     include "<A href='../../html_code/include/HALO_EM_TKE_OLD_E_5.inc.html'>HALO_EM_TKE_OLD_E_5.inc</A>"<A NAME="HALO_EM_TKE_OLD_E_5.inc_39"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2154'>
           ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='2155'>
#     include "<A href='../../html_code/include/HALO_EM_TKE_OLD_E_7.inc.html'>HALO_EM_TKE_OLD_E_7.inc</A>"<A NAME="HALO_EM_TKE_OLD_E_7.inc_40"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2156'>
           ELSE<a name='2157'>
             WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='2158'>
             CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_56">(TRIM(wrf_err_message))<a name='2159'>
           ENDIF<a name='2160'>
         ENDIF<a name='2161'>
#endif<a name='2162'>
<a name='2163'>
#ifdef DM_PARALLEL<a name='2164'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_TKE_OLD.inc.html'>PERIOD_BDY_EM_TKE_OLD.inc</A>"<A NAME="PERIOD_BDY_EM_TKE_OLD.inc_41"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2165'>
#endif<a name='2166'>
<a name='2167'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2168'></font>
         <font color=#447700>!$OMP PRIVATE ( ij )<a name='2169'></font>
         DO ij = 1 , grid%num_tiles<a name='2170'>
           CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_111">(  grid%tke_1, 'p', config_flags,  &amp;<a name='2171'>
                                    ids, ide, jds, jde, kds, kde,      &amp;<a name='2172'>
                                    ims, ime, jms, jme, kms, kme,      &amp;<a name='2173'>
                                    ips, ipe, jps, jpe, kps, kpe,      &amp;<a name='2174'>
                                    grid%i_start(ij), grid%i_end(ij),  &amp;<a name='2175'>
                                    grid%j_start(ij), grid%j_end(ij),  &amp;<a name='2176'>
                                    k_start    , k_end                )<a name='2177'>
         END DO<a name='2178'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2179'></font>
<a name='2180'>
<font color=#447700>!---  end of positive definite physics tendency update<a name='2181'></font>
<a name='2182'>
       END IF  <font color=#447700>! end if for tke_adv_opt<a name='2183'></font>
<a name='2184'>
#ifdef DM_PARALLEL<a name='2185'>
<font color=#447700>!<a name='2186'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='2187'></font>
<font color=#447700>!<a name='2188'></font>
<font color=#447700>!          * * * * *            <a name='2189'></font>
<font color=#447700>!          * * * * *            <a name='2190'></font>
<font color=#447700>!          * * + * *            <a name='2191'></font>
<font color=#447700>!          * * * * *            <a name='2192'></font>
<font color=#447700>!          * * * * *            <a name='2193'></font>
<font color=#447700>!<a name='2194'></font>
<font color=#447700>! ru_m         x<a name='2195'></font>
<font color=#447700>! rv_m         x<a name='2196'></font>
<font color=#447700>! ww_m         x<a name='2197'></font>
<font color=#447700>! mut          x<a name='2198'></font>
<font color=#447700>!<a name='2199'></font>
<font color=#447700>!--------------------------------------------------------------<a name='2200'></font>
<a name='2201'>
#  include "<A href='../../html_code/include/HALO_EM_D.inc.html'>HALO_EM_D.inc</A>"<A NAME="HALO_EM_D.inc_42"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2202'>
<font color=#447700>! WCS addition 11/19/08<a name='2203'></font>
#  include "<A href='../../html_code/include/PERIOD_EM_DA.inc.html'>PERIOD_EM_DA.inc</A>"<A NAME="PERIOD_EM_DA.inc_43"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2204'>
#endif<a name='2205'>
<a name='2206'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='2207'></font>
<font color=#447700>!&lt;pre&gt;<a name='2208'></font>
<font color=#447700>! (4) Still within the RK loop, the scalar variables are advanced.<a name='2209'></font>
<font color=#447700>!<a name='2210'></font>
<font color=#447700>!    For the moist and chem variables, each one is advanced<a name='2211'></font>
<font color=#447700>!    individually, using named loops "moist_variable_loop:"<a name='2212'></font>
<font color=#447700>!    and "chem_variable_loop:".  Each RK substep begins by<a name='2213'></font>
<font color=#447700>!    calculating the advective tendency, and, for the first RK step, <a name='2214'></font>
<font color=#447700>!    3D mixing (calling rk_scalar_tend) followed by an update<a name='2215'></font>
<font color=#447700>!    of the scalar (calling rk_update_scalar).<a name='2216'></font>
<font color=#447700>!&lt;/pre&gt;<a name='2217'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='2218'></font>
<a name='2219'>
<a name='2220'>
       moist_scalar_advance: IF (num_3d_m &gt;= PARAM_FIRST_SCALAR )  THEN<a name='2221'>
<a name='2222'>
         moist_variable_loop: DO im = PARAM_FIRST_SCALAR, num_3d_m<a name='2223'>
<a name='2224'>
<font color=#447700>! adv_moist_cond is set in module_physics_init based on mp_physics choice<a name='2225'></font>
<font color=#447700>!       true except for Ferrier scheme<a name='2226'></font>
<a name='2227'>
           IF (grid%adv_moist_cond .or. im==p_qv ) THEN<a name='2228'>
<a name='2229'>
             <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2230'></font>
             <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2231'></font>
             moist_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2232'>
<a name='2233'>
               CALL wrf_debug ( 200 , ' call rk_scalar_tend' )<a name='2234'>
               tenddec = .false.<a name='2235'>
<a name='2236'>
BENCH_START(rk_scalar_tend_tim)<a name='2237'>
               CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_1"> (  im, im, config_flags, tenddec,         &amp; <a name='2238'>
                           rk_step, dt_rk,                                   &amp;<a name='2239'>
                           grid%ru_m, grid%rv_m, grid%ww_m,                  &amp;<a name='2240'>
                           grid%muts, grid%mub, grid%mu_1,                   &amp;<a name='2241'>
                           grid%c1h, grid%c2h,                               &amp;<a name='2242'>
                           grid%alt,                                         &amp;<a name='2243'>
                           moist_old(ims,kms,jms,im),                        &amp;<a name='2244'>
                           moist(ims,kms,jms,im),                            &amp;<a name='2245'>
                           moist_tend(ims,kms,jms,im),                       &amp;<a name='2246'>
                           advect_tend,h_tendency,z_tendency,grid%rqvften,   &amp; <a name='2247'>
                           grid%qv_base, .true., grid%fnm, grid%fnp,         &amp;<a name='2248'>
                           grid%msfux,grid%msfuy, grid%msfvx, grid%msfvx_inv,&amp;<a name='2249'>
                           grid%msfvy, grid%msftx,grid%msfty,                &amp; <a name='2250'>
                           grid%rdx, grid%rdy, grid%rdn, grid%rdnw, grid%khdif, &amp;<a name='2251'>
                           grid%kvdif, grid%xkhh,                            &amp;<a name='2252'>
                           grid%diff_6th_opt, grid%diff_6th_factor,          &amp;<a name='2253'>
                           config_flags%moist_adv_opt,                       &amp;<a name='2254'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='2255'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='2256'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='2257'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='2258'>
                           k_start    , k_end               )<a name='2259'>
<a name='2260'>
               IF( rk_step == 1 .AND. config_flags%use_q_diabatic == 1 )THEN<a name='2261'>
               IF( im.eq.p_qv .or. im.eq.p_qc )THEN<a name='2262'>
                   CALL <A href='../../html_code/dyn_em/module_em.F.html#Q_DIABATIC_ADD'>q_diabatic_add</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="Q_DIABATIC_ADD_1">  ( im, im,            &amp; <a name='2263'>
                           dt_rk, grid%mut,                  &amp;<a name='2264'>
                           grid%c1h, grid%c2h,               &amp;<a name='2265'>
                           grid%qv_diabatic,                 &amp;<a name='2266'>
                           grid%qc_diabatic,                 &amp;<a name='2267'>
                           moist_tend(ims,kms,jms,im),       &amp;<a name='2268'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='2269'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='2270'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='2271'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='2272'>
                           k_start    , k_end               )<a name='2273'>
               ENDIF<a name='2274'>
               ENDIF<a name='2275'>
<a name='2276'>
BENCH_END(rk_scalar_tend_tim)<a name='2277'>
<a name='2278'>
BENCH_START(rlx_bdy_scalar_tim)<a name='2279'>
               IF( ( config_flags%specified .or. config_flags%nested ) .and. rk_step == 1 ) THEN <a name='2280'>
                 IF ( im .EQ. P_QV .OR. config_flags%nested .OR. &amp;<a name='2281'>
                    ( config_flags%specified .AND. config_flags%have_bcs_moist ) ) THEN<a name='2282'>
                   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_1"> ( moist_tend(ims,kms,jms,im),            &amp; <a name='2283'>
                                     moist(ims,kms,jms,im),  grid%mut,         &amp;<a name='2284'>
                                     grid%c1h, grid%c2h,                       &amp;<a name='2285'>
                                     moist_bxs(jms,kms,1,im),moist_bxe(jms,kms,1,im), &amp;<a name='2286'>
                                     moist_bys(ims,kms,1,im),moist_bye(ims,kms,1,im), &amp;<a name='2287'>
                                     moist_btxs(jms,kms,1,im),moist_btxe(jms,kms,1,im), &amp;<a name='2288'>
                                     moist_btys(ims,kms,1,im),moist_btye(ims,kms,1,im), &amp;<a name='2289'>
                                     config_flags%spec_bdy_width, grid%spec_zone, grid%relax_zone, &amp;<a name='2290'>
                                     grid%dtbc, grid%fcx, grid%gcx,             &amp;<a name='2291'>
                                     config_flags,               &amp;<a name='2292'>
                                     ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2293'></font>
                                     ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2294'></font>
                                     ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2295'></font>
                                     grid%i_start(ij), grid%i_end(ij),      &amp;<a name='2296'>
                                     grid%j_start(ij), grid%j_end(ij),      &amp;<a name='2297'>
                                     k_start, k_end                        )<a name='2298'>
<a name='2299'>
                   CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_1">  ( moist_tend(ims,kms,jms,im),                &amp;<a name='2300'>
                                     moist_bxs(jms,kms,1,im),moist_bxe(jms,kms,1,im), &amp;<a name='2301'>
                                     moist_bys(ims,kms,1,im),moist_bye(ims,kms,1,im), &amp;<a name='2302'>
                                     moist_btxs(jms,kms,1,im),moist_btxe(jms,kms,1,im), &amp;<a name='2303'>
                                     moist_btys(ims,kms,1,im),moist_btye(ims,kms,1,im), &amp;<a name='2304'>
                                     config_flags%spec_bdy_width, grid%spec_zone,                 &amp;<a name='2305'>
                                     config_flags,               &amp;<a name='2306'>
                                     ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2307'></font>
                                     ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2308'></font>
                                     ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2309'></font>
                                     grid%i_start(ij), grid%i_end(ij),          &amp;<a name='2310'>
                                     grid%j_start(ij), grid%j_end(ij),          &amp;<a name='2311'>
                                     k_start, k_end                               )<a name='2312'>
                 ENDIF<a name='2313'>
               ENDIF<a name='2314'>
BENCH_END(rlx_bdy_scalar_tim)<a name='2315'>
<a name='2316'>
             ENDDO moist_tile_loop_1<a name='2317'>
             <font color=#447700>!$OMP END PARALLEL DO<a name='2318'></font>
<a name='2319'>
             <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2320'></font>
             <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2321'></font>
             moist_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2322'>
<a name='2323'>
               CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2324'>
               tenddec = .false.<a name='2325'>
<a name='2326'>
BENCH_START(update_scal_tim)<a name='2327'>
               CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_1">( scs=im, sce=im,                                  &amp;<a name='2328'>
                               scalar_1=moist_old(ims,kms,jms,im),                     &amp;<a name='2329'>
                               scalar_2=moist(ims,kms,jms,im),                         &amp;<a name='2330'>
                               sc_tend=moist_tend(ims,kms,jms,im),                     &amp;<a name='2331'>
                               advect_tend=advect_tend,                                &amp;<a name='2332'>
                               h_tendency=h_tendency, z_tendency=z_tendency,           &amp; <a name='2333'>
                               msftx=grid%msftx,msfty=grid%msfty,                      &amp;<a name='2334'>
                               c1=grid%c1h, c2=grid%c2h,                               &amp;<a name='2335'>
                               mu_old=grid%mu_1, mu_new=grid%mu_2, mu_base=grid%mub,   &amp;<a name='2336'>
                               rk_step=rk_step, dt=dt_rk, spec_zone=grid%spec_zone,    &amp;<a name='2337'>
                               config_flags=config_flags, tenddec=tenddec,             &amp; <a name='2338'>
                               ids=ids, ide=ide, jds=jds, jde=jde, kds=kds, kde=kde,   &amp;<a name='2339'>
                               ims=ims, ime=ime, jms=jms, jme=jme, kms=kms, kme=kme,   &amp;<a name='2340'>
                               its=grid%i_start(ij), ite=grid%i_end(ij),               &amp;<a name='2341'>
                               jts=grid%j_start(ij), jte=grid%j_end(ij),               &amp;<a name='2342'>
                               kts=k_start    , kte=k_end                              )<a name='2343'>
               IF( rk_step == rk_order .AND. config_flags%use_q_diabatic == 1 )THEN<a name='2344'>
               IF( im.eq.p_qv .or. im.eq.p_qc )THEN<a name='2345'>
                   CALL <A href='../../html_code/dyn_em/module_em.F.html#Q_DIABATIC_SUBTR'>q_diabatic_subtr</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="Q_DIABATIC_SUBTR_1">( im, im,            &amp; <a name='2346'>
                           dt_rk,                            &amp;<a name='2347'>
                           grid%qv_diabatic,                 &amp;<a name='2348'>
                           grid%qc_diabatic,                 &amp;<a name='2349'>
                           moist(ims,kms,jms,im),            &amp;<a name='2350'>
                           ids, ide, jds, jde, kds, kde,     &amp;<a name='2351'>
                           ims, ime, jms, jme, kms, kme,     &amp;<a name='2352'>
                           grid%i_start(ij), grid%i_end(ij), &amp;<a name='2353'>
                           grid%j_start(ij), grid%j_end(ij), &amp;<a name='2354'>
                           k_start    , k_end               )<a name='2355'>
               ENDIF<a name='2356'>
               ENDIF<a name='2357'>
BENCH_END(update_scal_tim)<a name='2358'>
<a name='2359'>
BENCH_START(flow_depbdy_tim)<a name='2360'>
               IF( config_flags%specified .AND. ( .NOT. config_flags%have_bcs_moist ) ) THEN<a name='2361'>
                 IF(im .ne. P_QV)THEN<a name='2362'>
                   CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_1">  (  moist(ims,kms,jms,im),                 &amp;<a name='2363'>
                                grid%ru_m, grid%rv_m, config_flags,             &amp;<a name='2364'>
                                grid%spec_zone,                                 &amp;<a name='2365'>
                                ids,ide, jds,jde, kds,kde,                      &amp;<a name='2366'>
                                ims,ime, jms,jme, kms,kme,                      &amp;<a name='2367'>
                                ips,ipe, jps,jpe, kps,kpe,                      &amp;<a name='2368'>
                                grid%i_start(ij), grid%i_end(ij),               &amp;<a name='2369'>
                                grid%j_start(ij), grid%j_end(ij),               &amp;<a name='2370'>
                                k_start, k_end                               )<a name='2371'>
                 ENDIF<a name='2372'>
               ENDIF<a name='2373'>
BENCH_END(flow_depbdy_tim)<a name='2374'>
<a name='2375'>
             ENDDO moist_tile_loop_2<a name='2376'>
             <font color=#447700>!$OMP END PARALLEL DO<a name='2377'></font>
<a name='2378'>
           ENDIF  <font color=#447700>!-- if (grid%adv_moist_cond .or. im==p_qv ) then<a name='2379'></font>
<a name='2380'>
         ENDDO moist_variable_loop<a name='2381'>
<a name='2382'>
       ENDIF moist_scalar_advance<a name='2383'>
<a name='2384'>
BENCH_START(tke_adv_tim)<a name='2385'>
       TKE_advance: IF (config_flags%km_opt .eq. 2) then<a name='2386'>
#ifdef DM_PARALLEL<a name='2387'>
         IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='2388'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_ADVECT_3.inc.html'>HALO_EM_TKE_ADVECT_3.inc</A>"<A NAME="HALO_EM_TKE_ADVECT_3.inc_44"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2389'>
         ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='2390'>
#       include "<A href='../../html_code/include/HALO_EM_TKE_ADVECT_5.inc.html'>HALO_EM_TKE_ADVECT_5.inc</A>"<A NAME="HALO_EM_TKE_ADVECT_5.inc_45"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2391'>
         ELSE<a name='2392'>
          WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='2393'>
          CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_57">(TRIM(wrf_err_message))<a name='2394'>
         ENDIF<a name='2395'>
#endif<a name='2396'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2397'></font>
         <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2398'></font>
         tke_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2399'>
<a name='2400'>
           CALL wrf_debug ( 200 , ' call rk_scalar_tend for tke' )<a name='2401'>
           tenddec = .false.<a name='2402'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_2"> ( 1, 1, config_flags, tenddec,                      &amp; <a name='2403'>
                            rk_step, dt_rk,                                        &amp;<a name='2404'>
                            grid%ru_m, grid%rv_m, grid%ww_m,                       &amp;<a name='2405'>
                            grid%muts, grid%mub, grid%mu_1,                        &amp;<a name='2406'>
                            grid%c1h, grid%c2h,                                    &amp;<a name='2407'>
                            grid%alt,                                              &amp;<a name='2408'>
                            grid%tke_1,                                            &amp;<a name='2409'>
                            grid%tke_2,                                            &amp;<a name='2410'>
                            tke_tend(ims,kms,jms),                                 &amp;<a name='2411'>
                            advect_tend,h_tendency,z_tendency,grid%rqvften,        &amp; <a name='2412'>
                            grid%qv_base, .false., grid%fnm, grid%fnp,             &amp;<a name='2413'>
                            grid%msfux,grid%msfuy, grid%msfvx, grid%msfvx_inv,     &amp;<a name='2414'>
                            grid%msfvy, grid%msftx,grid%msfty,                     &amp;<a name='2415'>
                            grid%rdx, grid%rdy, grid%rdn, grid%rdnw, grid%khdif,   &amp;<a name='2416'>
                            grid%kvdif, grid%xkhh,                                 &amp;<a name='2417'>
                            grid%diff_6th_opt, grid%diff_6th_factor,               &amp;<a name='2418'>
                            config_flags%tke_adv_opt,                              &amp;<a name='2419'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='2420'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='2421'>
                            grid%i_start(ij), grid%i_end(ij), &amp;<a name='2422'>
                            grid%j_start(ij), grid%j_end(ij), &amp;<a name='2423'>
                            k_start    , k_end               )<a name='2424'>
<a name='2425'>
         ENDDO tke_tile_loop_1<a name='2426'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2427'></font>
<a name='2428'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2429'></font>
         <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2430'></font>
         tke_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2431'>
<a name='2432'>
           CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2433'>
           tenddec = .false.<a name='2434'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_2">( scs=1,  sce=1,                                          &amp;<a name='2435'>
                                  scalar_1=grid%tke_1,                                    &amp;<a name='2436'>
                                  scalar_2=grid%tke_2,                                    &amp;<a name='2437'>
                                  sc_tend=tke_tend(ims,kms,jms),                          &amp;<a name='2438'>
                                  advect_tend=advect_tend,                                &amp;<a name='2439'>
                                  h_tendency=h_tendency, z_tendency=z_tendency,           &amp; <a name='2440'>
                                  msftx=grid%msftx,msfty=grid%msfty,                      &amp;<a name='2441'>
                                  c1=grid%c1h, c2=grid%c2h,                               &amp;<a name='2442'>
                                  mu_old=grid%mu_1, mu_new=grid%mu_2, mu_base=grid%mub,   &amp;<a name='2443'>
                                  rk_step=rk_step, dt=dt_rk, spec_zone=grid%spec_zone,    &amp;<a name='2444'>
                                  config_flags=config_flags, tenddec=tenddec,             &amp; <a name='2445'>
                                  ids=ids, ide=ide, jds=jds, jde=jde, kds=kds, kde=kde,   &amp;<a name='2446'>
                                  ims=ims, ime=ime, jms=jms, jme=jme, kms=kms, kme=kme,   &amp;<a name='2447'>
                                  its=grid%i_start(ij), ite=grid%i_end(ij),               &amp;<a name='2448'>
                                  jts=grid%j_start(ij), jte=grid%j_end(ij),               &amp;<a name='2449'>
                                  kts=k_start    , kte=k_end                              )<a name='2450'>
<a name='2451'>
<font color=#447700>! bound the tke (greater than 0, less than tke_upper_bound)<a name='2452'></font>
<a name='2453'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#BOUND_TKE'>bound_tke</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="BOUND_TKE_1">( grid%tke_2, grid%tke_upper_bound,    &amp;<a name='2454'>
                           ids, ide, jds, jde, kds, kde,        &amp;<a name='2455'>
                           ims, ime, jms, jme, kms, kme,        &amp;<a name='2456'>
                           grid%i_start(ij), grid%i_end(ij),    &amp;<a name='2457'>
                           grid%j_start(ij), grid%j_end(ij),    &amp;<a name='2458'>
                           k_start    , k_end                  )<a name='2459'>
<a name='2460'>
           IF( config_flags%specified .or. config_flags%nested ) THEN<a name='2461'>
              CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_2"> (  grid%tke_2,                     &amp;<a name='2462'>
                                   grid%ru_m, grid%rv_m, config_flags,               &amp;<a name='2463'>
                                   grid%spec_zone,                              &amp;<a name='2464'>
                                   ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2465'></font>
                                   ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2466'></font>
                                   ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2467'></font>
                                   grid%i_start(ij), grid%i_end(ij),       &amp;<a name='2468'>
                                   grid%j_start(ij), grid%j_end(ij),       &amp;<a name='2469'>
                                   k_start, k_end                               )<a name='2470'>
           ENDIF<a name='2471'>
         ENDDO tke_tile_loop_2<a name='2472'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2473'></font>
<a name='2474'>
       ENDIF TKE_advance<a name='2475'>
BENCH_END(tke_adv_tim)<a name='2476'>
<a name='2477'>
#if (WRF_CHEM == 1)<a name='2478'>
<font color=#447700>!  next the chemical species<a name='2479'></font>
BENCH_START(chem_adv_tim)<a name='2480'>
       chem_scalar_advance: IF (num_3d_c &gt;= PARAM_FIRST_SCALAR)  THEN<a name='2481'>
<a name='2482'>
         chem_variable_loop: DO ic = PARAM_FIRST_SCALAR, num_3d_c<a name='2483'>
<a name='2484'>
           <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2485'></font>
           <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2486'></font>
           chem_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2487'>
<a name='2488'>
             CALL wrf_debug ( 200 , ' call rk_scalar_tend in chem_tile_loop_1' )<a name='2489'>
             tenddec = (( config_flags%chemdiag == USECHEMDIAG ) .and. &amp;<a name='2490'>
                        ( adv_ct_indices(ic) &gt;= PARAM_FIRST_SCALAR ))<a name='2491'>
             CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_3"> ( ic, ic, config_flags, tenddec,                &amp; <a name='2492'>
                              rk_step, dt_rk,                                    &amp;<a name='2493'>
                              grid%ru_m, grid%rv_m, grid%ww_m,                   &amp;<a name='2494'>
                              grid%muts, grid%mub, grid%mu_1,                    &amp;<a name='2495'>
                              grid%c1h, grid%c2h,                                &amp;<a name='2496'>
                              grid%alt,                                          &amp;<a name='2497'>
                              chem_old(ims,kms,jms,ic),                          &amp;<a name='2498'>
                              chem(ims,kms,jms,ic),                              &amp;<a name='2499'>
                              chem_tend(ims,kms,jms,ic),                         &amp;<a name='2500'>
                              advect_tend,h_tendency,z_tendency,grid%rqvften,    &amp; <a name='2501'>
                              grid%qv_base, .false., grid%fnm, grid%fnp,         &amp;<a name='2502'>
                              grid%msfux,grid%msfuy, grid%msfvx, grid%msfvx_inv, &amp;<a name='2503'>
                              grid%msfvy, grid%msftx,grid%msfty,                 &amp;<a name='2504'>
                              grid%rdx, grid%rdy, grid%rdn, grid%rdnw,           &amp;<a name='2505'>
                              grid%khdif, grid%kvdif, grid%xkhh,                 &amp;<a name='2506'>
                              grid%diff_6th_opt, grid%diff_6th_factor,           &amp;<a name='2507'>
                              config_flags%chem_adv_opt,                         &amp;<a name='2508'>
                              ids, ide, jds, jde, kds, kde,                      &amp;<a name='2509'>
                              ims, ime, jms, jme, kms, kme,                      &amp;<a name='2510'>
                              grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='2511'>
                              grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='2512'>
                              k_start    , k_end                                )<a name='2513'>
<font color=#447700>!<a name='2514'></font>
<font color=#447700>! Currently, chemistry species with specified boundaries (i.e. the mother<a name='2515'></font>
<font color=#447700>! domain)  are being over written by flow_dep_bdy_chem. So, relax_bdy and<a name='2516'></font>
<font color=#447700>! spec_bdy are only called for nests. For boundary conditions from global model or larger domain,<a name='2517'></font>
<font color=#447700>! chem is uncoupled, and only used for one row/column on inflow (if have_bcs_chem=.true.) <a name='2518'></font>
<font color=#447700>!<a name='2519'></font>
           IF( ( config_flags%nested ) .and. rk_step == 1 ) THEN<a name='2520'>
             IF(ic.eq.1)CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_32"> ( 10 , ' have_bcs_chem' )<a name='2521'>
             CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_2"> ( chem_tend(ims,kms,jms,ic),                                    &amp;<a name='2522'>
                                     chem(ims,kms,jms,ic),  grid%mut,                              &amp;<a name='2523'>
                                     grid%c1h, grid%c2h,                       &amp;<a name='2524'>
                                     chem_bxs(jms,kms,1,ic),chem_bxe(jms,kms,1,ic),                &amp;<a name='2525'>
                                     chem_bys(ims,kms,1,ic),chem_bye(ims,kms,1,ic),                &amp;<a name='2526'>
                                     chem_btxs(jms,kms,1,ic),chem_btxe(jms,kms,1,ic),              &amp;<a name='2527'>
                                     chem_btys(ims,kms,1,ic),chem_btye(ims,kms,1,ic),              &amp;<a name='2528'>
                                     config_flags%spec_bdy_width, grid%spec_zone, grid%relax_zone, &amp;<a name='2529'>
                                     grid%dtbc, grid%fcx, grid%gcx,                                &amp;<a name='2530'>
                                     config_flags,                                                 &amp;<a name='2531'>
                                     ids,ide, jds,jde, kds,kde,                                    &amp;<a name='2532'>
                                     ims,ime, jms,jme, kms,kme,                                    &amp;<a name='2533'>
                                     ips,ipe, jps,jpe, kps,kpe,                                    &amp;<a name='2534'>
                                     grid%i_start(ij), grid%i_end(ij),                             &amp;<a name='2535'>
                                     grid%j_start(ij), grid%j_end(ij),                             &amp;<a name='2536'>
                                     k_start, k_end                                                )<a name='2537'>
             CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_2">  ( chem_tend(ims,kms,jms,ic),                 &amp;<a name='2538'>
                                     chem_bxs(jms,kms,1,ic),chem_bxe(jms,kms,1,ic),                &amp;<a name='2539'>
                                     chem_bys(ims,kms,1,ic),chem_bye(ims,kms,1,ic),                &amp;<a name='2540'>
                                     chem_btxs(jms,kms,1,ic),chem_btxe(jms,kms,1,ic),              &amp;<a name='2541'>
                                     chem_btys(ims,kms,1,ic),chem_btye(ims,kms,1,ic),              &amp;<a name='2542'>
                                     config_flags%spec_bdy_width, grid%spec_zone,                  &amp;<a name='2543'>
                                     config_flags,                                                 &amp;<a name='2544'>
                                     ids,ide, jds,jde, kds,kde,                                    &amp;<a name='2545'>
                                     ims,ime, jms,jme, kms,kme,                                    &amp;<a name='2546'>
                                     ips,ipe, jps,jpe, kps,kpe,                                    &amp;<a name='2547'>
                                     grid%i_start(ij), grid%i_end(ij),                             &amp;<a name='2548'>
                                     grid%j_start(ij), grid%j_end(ij),                             &amp;<a name='2549'>
                                     k_start, k_end                                                )<a name='2550'>
           ENDIF<a name='2551'>
<a name='2552'>
         ENDDO chem_tile_loop_1<a name='2553'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2554'></font>
<a name='2555'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2556'></font>
         <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2557'></font>
<a name='2558'>
         chem_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2559'>
<a name='2560'>
           CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2561'>
           tenddec = (( config_flags%chemdiag == USECHEMDIAG ) .and. &amp;<a name='2562'>
                      ( adv_ct_indices(ic) &gt;= PARAM_FIRST_SCALAR ))<a name='2563'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_3">( scs=ic, sce=ic,                                         &amp;<a name='2564'>
                                  scalar_1=chem_old(ims,kms,jms,ic),                      &amp;<a name='2565'>
                                  scalar_2=chem(ims,kms,jms,ic),                          &amp;<a name='2566'>
                                  sc_tend=chem_tend(ims,kms,jms,ic),                      &amp;<a name='2567'>
                                  advh_t=advh_ct(ims,kms,jms,adv_ct_indices(ic)),         &amp;<a name='2568'>
                                  advz_t=advz_ct(ims,kms,jms,adv_ct_indices(ic)),         &amp;<a name='2569'>
                                  advect_tend=advect_tend,                                &amp;<a name='2570'>
                                  h_tendency=h_tendency, z_tendency=z_tendency,           &amp; <a name='2571'>
                                  msftx=grid%msftx,msfty=grid%msfty,                      &amp;<a name='2572'>
                                  c1=grid%c1h, c2=grid%c2h,                               &amp;<a name='2573'>
                                  mu_old=grid%mu_1, mu_new=grid%mu_2, mu_base=grid%mub,   &amp;<a name='2574'>
                                  rk_step=rk_step, dt=dt_rk, spec_zone=grid%spec_zone,    &amp;<a name='2575'>
                                  config_flags=config_flags, tenddec=tenddec,             &amp; <a name='2576'>
                                  ids=ids, ide=ide, jds=jds, jde=jde, kds=kds, kde=kde,   &amp;<a name='2577'>
                                  ims=ims, ime=ime, jms=jms, jme=jme, kms=kms, kme=kme,   &amp;<a name='2578'>
                                  its=grid%i_start(ij), ite=grid%i_end(ij),               &amp;<a name='2579'>
                                  jts=grid%j_start(ij), jte=grid%j_end(ij),               &amp;<a name='2580'>
                                  kts=k_start    , kte=k_end                              )<a name='2581'>
<a name='2582'>
           IF( config_flags%specified  ) THEN<a name='2583'>
<a name='2584'>
             IF( config_flags%perturb_chem_bdy==1 ) THEN<a name='2585'>
<a name='2586'>
                 IF(ic.eq.PARAM_FIRST_SCALAR .and. ij.eq.1) &amp;<a name='2587'>
                 CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_33"> (10 , ' spec_bdy_chem_perturb' )<a name='2588'>
<a name='2589'>
                 CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_CHEM_PERTURB'>spec_bdy_chem_perturb</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_CHEM_PERTURB_1"> ( config_flags%periodic_x,   &amp;<a name='2590'>
                      chem_btxs(jms,kms,1,ic), chem_btxe(jms,kms,1,ic),  &amp;<a name='2591'>
                      chem_btys(ims,kms,1,ic), chem_btye(ims,kms,1,ic),  &amp;<a name='2592'>
                      grid%rand_pert,                                    &amp;<a name='2593'>
                      config_flags%spec_bdy_width, grid%spec_zone,       &amp;<a name='2594'>
                      grid%num_stoch_levels,      &amp; <font color=#447700>! stoch  dims<a name='2595'></font>
                      ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2596'></font>
                      ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2597'></font>
                      ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2598'></font>
                      grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='2599'>
                      grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='2600'>
                      k_start, k_end                                  )<a name='2601'>
             ENDIF<a name='2602'>
<a name='2603'>
             CALL flow_dep_bdy_chem( chem(ims,kms,jms,ic),                          &amp;<a name='2604'>
                                     chem_bxs(jms,kms,1,ic), chem_btxs(jms,kms,1,ic),  &amp;<a name='2605'>
                                     chem_bxe(jms,kms,1,ic), chem_btxe(jms,kms,1,ic),  &amp;<a name='2606'>
                                     chem_bys(ims,kms,1,ic), chem_btys(ims,kms,1,ic),  &amp;<a name='2607'>
                                     chem_bye(ims,kms,1,ic), chem_btye(ims,kms,1,ic),  &amp;<a name='2608'>
                                     dt_rk+grid%dtbc,                                  &amp;<a name='2609'>
                                     config_flags%spec_bdy_width,grid%z,      &amp;<a name='2610'>
                                     grid%have_bcs_chem,      &amp;<a name='2611'>
                                     grid%ru_m, grid%rv_m, config_flags,grid%alt,       &amp;<a name='2612'>
                                     grid%t_1,grid%pb,grid%p,t0,p1000mb,rcp,grid%ph_2,grid%phb,g, &amp;<a name='2613'>
                                     grid%spec_zone,ic,                  &amp;<a name='2614'>
                                     ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2615'></font>
                                     ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2616'></font>
                                     ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2617'></font>
                                     grid%i_start(ij), grid%i_end(ij),   &amp;<a name='2618'>
                                     grid%j_start(ij), grid%j_end(ij),   &amp;<a name='2619'>
                                     k_start, k_end                      )<a name='2620'>
           ENDIF<a name='2621'>
         ENDDO chem_tile_loop_2<a name='2622'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2623'></font>
<a name='2624'>
       ENDDO chem_variable_loop<a name='2625'>
     ENDIF chem_scalar_advance<a name='2626'>
BENCH_END(chem_adv_tim)<a name='2627'>
#endif<a name='2628'>
<font color=#447700>!  next the chemical species<a name='2629'></font>
BENCH_START(tracer_adv_tim)<a name='2630'>
       tracer_advance: IF (num_tracer &gt;= PARAM_FIRST_SCALAR)  THEN<a name='2631'>
<a name='2632'>
         tracer_variable_loop: DO ic = PARAM_FIRST_SCALAR, num_tracer<a name='2633'>
<a name='2634'>
           <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2635'></font>
           <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2636'></font>
           tracer_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2637'>
<a name='2638'>
             CALL wrf_debug ( 15 , ' call rk_scalar_tend in tracer_tile_loop_1' )<a name='2639'>
             tenddec = .false.<a name='2640'>
             CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_4"> ( ic, ic, config_flags, tenddec,                &amp; <a name='2641'>
                              rk_step, dt_rk,                                    &amp;<a name='2642'>
                              grid%ru_m, grid%rv_m, grid%ww_m,                   &amp;<a name='2643'>
                              grid%muts, grid%mub, grid%mu_1,                    &amp;<a name='2644'>
                              grid%c1h, grid%c2h,                                &amp;<a name='2645'>
                              grid%alt,                                          &amp;<a name='2646'>
                              tracer_old(ims,kms,jms,ic),                        &amp;<a name='2647'>
                              tracer(ims,kms,jms,ic),                            &amp;<a name='2648'>
                              tracer_tend(ims,kms,jms,ic),                       &amp;<a name='2649'>
                              advect_tend,h_tendency,z_tendency,grid%rqvften,    &amp; <a name='2650'>
                              grid%qv_base, .false., grid%fnm, grid%fnp,         &amp;<a name='2651'>
                              grid%msfux,grid%msfuy, grid%msfvx, grid%msfvx_inv, &amp;<a name='2652'>
                              grid%msfvy, grid%msftx,grid%msfty,                 &amp;<a name='2653'>
                              grid%rdx, grid%rdy, grid%rdn, grid%rdnw,           &amp;<a name='2654'>
                              grid%khdif, grid%kvdif, grid%xkhh,                 &amp;<a name='2655'>
                              grid%diff_6th_opt, grid%diff_6th_factor,           &amp;<a name='2656'>
                              config_flags%tracer_adv_opt,                         &amp;<a name='2657'>
                              ids, ide, jds, jde, kds, kde,                      &amp;<a name='2658'>
                              ims, ime, jms, jme, kms, kme,                      &amp;<a name='2659'>
                              grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='2660'>
                              grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='2661'>
                              k_start    , k_end                                )<a name='2662'>
<font color=#447700>!<a name='2663'></font>
<font color=#447700>! Currently, chemistry species with specified boundaries (i.e. the mother<a name='2664'></font>
<font color=#447700>! domain)  are being over written by flow_dep_bdy_chem. So, relax_bdy and<a name='2665'></font>
<font color=#447700>! spec_bdy are only called for nests. For boundary conditions from global model or larger domain,<a name='2666'></font>
<font color=#447700>! chem is uncoupled, and only used for one row/column on inflow (if have_bcs_chem=.true.) <a name='2667'></font>
<font color=#447700>!<a name='2668'></font>
           IF( ( config_flags%nested ) .and. rk_step == 1 ) THEN<a name='2669'>
             IF(ic.eq.1)CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_34"> ( 10 , ' have_bcs_tracer' )<a name='2670'>
             CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_3"> ( tracer_tend(ims,kms,jms,ic),                                    &amp;<a name='2671'>
                                     tracer(ims,kms,jms,ic),  grid%mut,                              &amp;<a name='2672'>
                                     grid%c1h, grid%c2h,                       &amp;<a name='2673'>
                                     tracer_bxs(jms,kms,1,ic),tracer_bxe(jms,kms,1,ic),                &amp;<a name='2674'>
                                     tracer_bys(ims,kms,1,ic),tracer_bye(ims,kms,1,ic),                &amp;<a name='2675'>
                                     tracer_btxs(jms,kms,1,ic),tracer_btxe(jms,kms,1,ic),              &amp;<a name='2676'>
                                     tracer_btys(ims,kms,1,ic),tracer_btye(ims,kms,1,ic),              &amp;<a name='2677'>
                                     config_flags%spec_bdy_width, grid%spec_zone, grid%relax_zone, &amp;<a name='2678'>
                                     grid%dtbc, grid%fcx, grid%gcx,                                &amp;<a name='2679'>
                                     config_flags,                                                 &amp;<a name='2680'>
                                     ids,ide, jds,jde, kds,kde,                                    &amp;<a name='2681'>
                                     ims,ime, jms,jme, kms,kme,                                    &amp;<a name='2682'>
                                     ips,ipe, jps,jpe, kps,kpe,                                    &amp;<a name='2683'>
                                     grid%i_start(ij), grid%i_end(ij),                             &amp;<a name='2684'>
                                     grid%j_start(ij), grid%j_end(ij),                             &amp;<a name='2685'>
                                     k_start, k_end                                                )<a name='2686'>
             CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_3">  ( tracer_tend(ims,kms,jms,ic),                 &amp;<a name='2687'>
                                     tracer_bxs(jms,kms,1,ic),tracer_bxe(jms,kms,1,ic),                &amp;<a name='2688'>
                                     tracer_bys(ims,kms,1,ic),tracer_bye(ims,kms,1,ic),                &amp;<a name='2689'>
                                     tracer_btxs(jms,kms,1,ic),tracer_btxe(jms,kms,1,ic),              &amp;<a name='2690'>
                                     tracer_btys(ims,kms,1,ic),tracer_btye(ims,kms,1,ic),              &amp;<a name='2691'>
                                     config_flags%spec_bdy_width, grid%spec_zone,                  &amp;<a name='2692'>
                                     config_flags,                                                 &amp;<a name='2693'>
                                     ids,ide, jds,jde, kds,kde,                                    &amp;<a name='2694'>
                                     ims,ime, jms,jme, kms,kme,                                    &amp;<a name='2695'>
                                     ips,ipe, jps,jpe, kps,kpe,                                    &amp;<a name='2696'>
                                     grid%i_start(ij), grid%i_end(ij),                             &amp;<a name='2697'>
                                     grid%j_start(ij), grid%j_end(ij),                             &amp;<a name='2698'>
                                     k_start, k_end                                                )<a name='2699'>
           ENDIF<a name='2700'>
<a name='2701'>
         ENDDO tracer_tile_loop_1<a name='2702'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2703'></font>
<a name='2704'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2705'></font>
         <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2706'></font>
<a name='2707'>
         tracer_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2708'>
<a name='2709'>
           CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2710'>
           tenddec = .false.<a name='2711'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_4">( scs=ic, sce=ic,                                         &amp;<a name='2712'>
                                  scalar_1=tracer_old(ims,kms,jms,ic),                    &amp;<a name='2713'>
                                  scalar_2=tracer(ims,kms,jms,ic),                        &amp;<a name='2714'>
                                  sc_tend=tracer_tend(ims,kms,jms,ic),                    &amp;<a name='2715'>
<font color=#447700>!                                 advh_t=advh_t(ims,kms,jms,1),                           &amp; <a name='2716'></font>
<font color=#447700>!                                 advz_t=advz_t(ims,kms,jms,1),                           &amp; <a name='2717'></font>
                                  advect_tend=advect_tend,                                &amp;<a name='2718'>
                                  h_tendency=h_tendency, z_tendency=z_tendency,           &amp; <a name='2719'>
                                  msftx=grid%msftx,msfty=grid%msfty,                      &amp;<a name='2720'>
                                  c1=grid%c1h, c2=grid%c2h,                               &amp;<a name='2721'>
                                  mu_old=grid%mu_1, mu_new=grid%mu_2, mu_base=grid%mub,   &amp;<a name='2722'>
                                  rk_step=rk_step, dt=dt_rk, spec_zone=grid%spec_zone,    &amp;<a name='2723'>
                                  config_flags=config_flags, tenddec=tenddec,             &amp; <a name='2724'>
                                  ids=ids, ide=ide, jds=jds, jde=jde, kds=kds, kde=kde,   &amp;<a name='2725'>
                                  ims=ims, ime=ime, jms=jms, jme=jme, kms=kms, kme=kme,   &amp;<a name='2726'>
                                  its=grid%i_start(ij), ite=grid%i_end(ij),               &amp;<a name='2727'>
                                  jts=grid%j_start(ij), jte=grid%j_end(ij),               &amp;<a name='2728'>
                                  kts=k_start    , kte=k_end                              )<a name='2729'>
<a name='2730'>
           IF( config_flags%specified  ) THEN<a name='2731'>
#if (WRF_CHEM == 1)<a name='2732'>
             CALL flow_dep_bdy_tracer( tracer(ims,kms,jms,ic),                             &amp;<a name='2733'>
                                     tracer_bxs(jms,kms,1,ic), tracer_btxs(jms,kms,1,ic),  &amp;<a name='2734'>
                                     tracer_bxe(jms,kms,1,ic), tracer_btxe(jms,kms,1,ic),  &amp;<a name='2735'>
                                     tracer_bys(ims,kms,1,ic), tracer_btys(ims,kms,1,ic),  &amp;<a name='2736'>
                                     tracer_bye(ims,kms,1,ic), tracer_btye(ims,kms,1,ic),  &amp;<a name='2737'>
                                     dt_rk+grid%dtbc,                                  &amp;<a name='2738'>
                                     config_flags%spec_bdy_width,grid%z,      &amp;<a name='2739'>
                                     grid%have_bcs_tracer,      &amp;<a name='2740'>
                                     grid%ru_m, grid%rv_m, config_flags%tracer_opt,grid%alt,       &amp;<a name='2741'>
                                     grid%t_1,grid%pb,grid%p,t0,p1000mb,rcp,grid%ph_2,grid%phb,g, &amp;<a name='2742'>
                                     grid%spec_zone,ic,                  &amp;<a name='2743'>
                                     ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2744'></font>
                                     ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2745'></font>
                                     ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2746'></font>
                                     grid%i_start(ij), grid%i_end(ij),   &amp;<a name='2747'>
                                     grid%j_start(ij), grid%j_end(ij),   &amp;<a name='2748'>
                                     k_start, k_end                      )<a name='2749'>
#else<a name='2750'>
             CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_3">  ( tracer(ims,kms,jms,ic),     &amp;<a name='2751'>
                                  grid%ru_m, grid%rv_m, config_flags,   &amp;<a name='2752'>
                                  grid%spec_zone,                  &amp;<a name='2753'>
                                  ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2754'></font>
                                  ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2755'></font>
                                  ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2756'></font>
                                  grid%i_start(ij), grid%i_end(ij),  &amp;<a name='2757'>
                                  grid%j_start(ij), grid%j_end(ij),  &amp;<a name='2758'>
                                  k_start, k_end                    )<a name='2759'>
#endif<a name='2760'>
           ENDIF<a name='2761'>
         ENDDO tracer_tile_loop_2<a name='2762'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2763'></font>
<a name='2764'>
       ENDDO tracer_variable_loop<a name='2765'>
     ENDIF tracer_advance<a name='2766'>
BENCH_END(tracer_adv_tim)<a name='2767'>
<a name='2768'>
<font color=#447700>!  next the other scalar species<a name='2769'></font>
     other_scalar_advance: IF (num_3d_s &gt;= PARAM_FIRST_SCALAR)  THEN<a name='2770'>
<a name='2771'>
       scalar_variable_loop: do is = PARAM_FIRST_SCALAR, num_3d_s<a name='2772'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2773'></font>
         <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2774'></font>
         scalar_tile_loop_1: DO ij = 1 , grid%num_tiles<a name='2775'>
<a name='2776'>
           CALL wrf_debug ( 200 , ' call rk_scalar_tend' )<a name='2777'>
           tenddec = .false.<a name='2778'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_SCALAR_TEND'>rk_scalar_tend</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_SCALAR_TEND_5"> ( is, is, config_flags, tenddec,                   &amp; <a name='2779'>
                                 rk_step, dt_rk,                                  &amp;<a name='2780'>
                                 grid%ru_m, grid%rv_m, grid%ww_m,                 &amp;<a name='2781'>
                                 grid%muts, grid%mub, grid%mu_1,                  &amp;<a name='2782'>
                                 grid%c1h, grid%c2h,                              &amp;<a name='2783'>
                                 grid%alt,                                        &amp;<a name='2784'>
                                 scalar_old(ims,kms,jms,is),                      &amp;<a name='2785'>
                                 scalar(ims,kms,jms,is),                          &amp;<a name='2786'>
                                 scalar_tend(ims,kms,jms,is),                     &amp;<a name='2787'>
                                 advect_tend,h_tendency,z_tendency,grid%rqvften,  &amp; <a name='2788'>
                                 grid%qv_base, .false., grid%fnm, grid%fnp,       &amp;<a name='2789'>
                                 grid%msfux,grid%msfuy, grid%msfvx, grid%msfvx_inv, &amp;<a name='2790'>
                                 grid%msfvy, grid%msftx,grid%msfty,               &amp;<a name='2791'>
                                 grid%rdx, grid%rdy, grid%rdn, grid%rdnw,         &amp;<a name='2792'>
                                 grid%khdif, grid%kvdif, grid%xkhh,               &amp;<a name='2793'>
                                 grid%diff_6th_opt, grid%diff_6th_factor,         &amp;<a name='2794'>
                                 config_flags%scalar_adv_opt,                     &amp;<a name='2795'>
                                 ids, ide, jds, jde, kds, kde,     &amp;<a name='2796'>
                                 ims, ime, jms, jme, kms, kme,     &amp;<a name='2797'>
                                 grid%i_start(ij), grid%i_end(ij), &amp;<a name='2798'>
                                 grid%j_start(ij), grid%j_end(ij), &amp;<a name='2799'>
                                 k_start    , k_end               )<a name='2800'>
<a name='2801'>
           IF( rk_step == 1 ) THEN<a name='2802'>
             IF ( config_flags%nested .OR. &amp;<a name='2803'>
                ( config_flags%specified .AND. config_flags%have_bcs_scalar ) .OR. &amp;<a name='2804'>
                ( ( is .EQ. P_QNWFA .OR. is .EQ. P_QNIFA) .AND. config_flags%use_aero_icbc ) ) THEN<a name='2805'>
<a name='2806'>
               CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RELAX_BDY_SCALAR'>relax_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RELAX_BDY_SCALAR_4"> ( scalar_tend(ims,kms,jms,is),                            &amp;<a name='2807'>
                                       scalar(ims,kms,jms,is),  grid%mut,                      &amp;<a name='2808'>
                                       grid%c1h, grid%c2h,                       &amp;<a name='2809'>
                                       scalar_bxs(jms,kms,1,is),scalar_bxe(jms,kms,1,is),      &amp;<a name='2810'>
                                       scalar_bys(ims,kms,1,is),scalar_bye(ims,kms,1,is),      &amp;<a name='2811'>
                                       scalar_btxs(jms,kms,1,is),scalar_btxe(jms,kms,1,is),    &amp;<a name='2812'>
                                       scalar_btys(ims,kms,1,is),scalar_btye(ims,kms,1,is),    &amp;<a name='2813'>
                                       config_flags%spec_bdy_width, grid%spec_zone, grid%relax_zone, &amp;<a name='2814'>
                                       grid%dtbc, grid%fcx, grid%gcx,                          &amp;<a name='2815'>
                                       config_flags,                                           &amp;<a name='2816'>
                                       ids,ide, jds,jde, kds,kde,                              &amp;<a name='2817'>
                                       ims,ime, jms,jme, kms,kme,                              &amp;<a name='2818'>
                                       ips,ipe, jps,jpe, kps,kpe,                              &amp;<a name='2819'>
                                       grid%i_start(ij), grid%i_end(ij),                       &amp;<a name='2820'>
                                       grid%j_start(ij), grid%j_end(ij),                       &amp;<a name='2821'>
                                       k_start, k_end                                          )<a name='2822'>
<a name='2823'>
               CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SPEC_BDY_SCALAR'>spec_bdy_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_SCALAR_4">  ( scalar_tend(ims,kms,jms,is),                            &amp;<a name='2824'>
                                       scalar_bxs(jms,kms,1,is),scalar_bxe(jms,kms,1,is),      &amp;<a name='2825'>
                                       scalar_bys(ims,kms,1,is),scalar_bye(ims,kms,1,is),      &amp;<a name='2826'>
                                       scalar_btxs(jms,kms,1,is),scalar_btxe(jms,kms,1,is),    &amp;<a name='2827'>
                                       scalar_btys(ims,kms,1,is),scalar_btye(ims,kms,1,is),    &amp;<a name='2828'>
                                       config_flags%spec_bdy_width, grid%spec_zone,            &amp;<a name='2829'>
                                       config_flags,                                           &amp;<a name='2830'>
                                       ids,ide, jds,jde, kds,kde,                              &amp;<a name='2831'>
                                       ims,ime, jms,jme, kms,kme,                              &amp;<a name='2832'>
                                       ips,ipe, jps,jpe, kps,kpe,                              &amp;<a name='2833'>
                                       grid%i_start(ij), grid%i_end(ij),                       &amp;<a name='2834'>
                                       grid%j_start(ij), grid%j_end(ij),                       &amp;<a name='2835'>
                                       k_start, k_end                                          )<a name='2836'>
<a name='2837'>
             ENDIF<a name='2838'>
           ENDIF <font color=#447700>! b.c test for scalars<a name='2839'></font>
<a name='2840'>
         ENDDO scalar_tile_loop_1<a name='2841'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2842'></font>
<a name='2843'>
         <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2844'></font>
         <font color=#447700>!$OMP PRIVATE ( ij, tenddec )<a name='2845'></font>
         scalar_tile_loop_2: DO ij = 1 , grid%num_tiles<a name='2846'>
<a name='2847'>
           CALL wrf_debug ( 200 , ' call rk_update_scalar' )<a name='2848'>
           tenddec = .false.<a name='2849'>
           CALL <A href='../../html_code/dyn_em/module_em.F.html#RK_UPDATE_SCALAR'>rk_update_scalar</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_UPDATE_SCALAR_5">( scs=is, sce=is,                                         &amp;<a name='2850'>
                                  scalar_1=scalar_old(ims,kms,jms,is),                    &amp;<a name='2851'>
                                  scalar_2=scalar(ims,kms,jms,is),                        &amp;<a name='2852'>
                                  sc_tend=scalar_tend(ims,kms,jms,is),                    &amp;<a name='2853'>
<font color=#447700>!                                 advh_t=advh_t(ims,kms,jms,1),                           &amp; <a name='2854'></font>
<font color=#447700>!                                 advz_t=advz_t(ims,kms,jms,1),                           &amp; <a name='2855'></font>
                                  advect_tend=advect_tend,                                &amp;<a name='2856'>
                                  h_tendency=h_tendency, z_tendency=z_tendency,           &amp; <a name='2857'>
                                  msftx=grid%msftx,msfty=grid%msfty,                      &amp;<a name='2858'>
                                  c1=grid%c1h, c2=grid%c2h,                               &amp;<a name='2859'>
                                  mu_old=grid%mu_1, mu_new=grid%mu_2, mu_base=grid%mub,   &amp;<a name='2860'>
                                  rk_step=rk_step, dt=dt_rk, spec_zone=grid%spec_zone,    &amp;<a name='2861'>
                                  config_flags=config_flags, tenddec=tenddec,             &amp; <a name='2862'>
                                  ids=ids, ide=ide, jds=jds, jde=jde, kds=kds, kde=kde,   &amp;<a name='2863'>
                                  ims=ims, ime=ime, jms=jms, jme=jme, kms=kms, kme=kme,   &amp;<a name='2864'>
                                  its=grid%i_start(ij), ite=grid%i_end(ij),               &amp;<a name='2865'>
                                  jts=grid%j_start(ij), jte=grid%j_end(ij),               &amp;<a name='2866'>
                                  kts=k_start    , kte=k_end                              )<a name='2867'>
<a name='2868'>
           IF ( config_flags%specified ) THEN<a name='2869'>
<a name='2870'>
             IF ( is .EQ. P_QNN ) THEN<a name='2871'>
               CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY_QNN'>flow_dep_bdy_qnn</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_QNN_1">  ( scalar(ims,kms,jms,is),     &amp;<a name='2872'>
                                  grid%ru_m, grid%rv_m, config_flags,   &amp;<a name='2873'>
                                  grid%spec_zone,                  &amp;<a name='2874'>
                                  grid%ccn_conc,              &amp; <font color=#447700>! RAS<a name='2875'></font>
                                  ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2876'></font>
                                  ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2877'></font>
                                  ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2878'></font>
                                  grid%i_start(ij), grid%i_end(ij),  &amp;<a name='2879'>
                                  grid%j_start(ij), grid%j_end(ij),  &amp;<a name='2880'>
                                  k_start, k_end                    )<a name='2881'>
             ELSE IF ( ( ( ( is .EQ. P_QNWFA ) .OR. ( is .EQ. P_QNIFA ) ) .AND. &amp;<a name='2882'>
                         ( .NOT. config_flags%use_aero_icbc ) ) &amp;<a name='2883'>
                         .OR. &amp;<a name='2884'>
                       ( ( .NOT. ( ( is .EQ. P_QNWFA ) .OR. ( is .EQ. P_QNIFA ) ) ) .AND. &amp;<a name='2885'>
                         ( .NOT. config_flags%have_bcs_scalar ) ) ) THEN<a name='2886'>
<a name='2887'>
<font color=#447700>!     A = ( is .EQ. P_QNWFA ) .OR. ( is .EQ. P_QNIFA )<a name='2888'></font>
<font color=#447700>!     B = config_flags%use_aero_icbc<a name='2889'></font>
<font color=#447700>!     C = config_glags%have_bcs_scalar<a name='2890'></font>
<a name='2891'>
<font color=#447700>! Test| A  | B  | C | ( A AND NOT B ) OR ( NOT A AND NOT C ) <a name='2892'></font>
<font color=#447700>! ----+----+----+---+-----------------------------------------------<a name='2893'></font>
<font color=#447700>!  1  | T  | T  | T |                 F = DO NOT CALL flow_dep_bdy<a name='2894'></font>
<font color=#447700>!  2  | T  | T  | F |                 F = DO NOT CALL flow_dep_bdy<a name='2895'></font>
<font color=#447700>!  3  | T  | F  | T |                 T =        CALL flow_dep_bdy<a name='2896'></font>
<font color=#447700>!  4  | T  | F  | F |                 T =        CALL flow_dep_bdy<a name='2897'></font>
<font color=#447700>!  5  | F  | T  | T |                 F = DO NOT CALL flow_dep_bdy<a name='2898'></font>
<font color=#447700>!  6  | F  | T  | F |                 T =        CALL flow_dep_bdy<a name='2899'></font>
<font color=#447700>!  7  | F  | F  | T |                 F = DO NOT CALL flow_dep_bdy<a name='2900'></font>
<font color=#447700>!  8  | F  | F  | F |                 T =        CALL flow_dep_bdy<a name='2901'></font>
<font color=#447700>! ----+----+----+---+-----------------------------------------------<a name='2902'></font>
<a name='2903'>
<font color=#447700>!  If this is     the special friendly fields AND are to use the aero icbc, then NO calls to flow dep: tests 1 and 2<a name='2904'></font>
<font color=#447700>!  If this is     the special friendly fields AND do not use the aero icbc, then    call     flow dep: tests 3 and 4<a name='2905'></font>
<font color=#447700>!  If this is not the special friendly fields AND: <a name='2906'></font>
<font color=#447700>!           If we        have bcs for scalars, do not call flow dep: tests 5 and 7<a name='2907'></font>
<font color=#447700>!           If we do not have bcs for scalars,        call flow dep: tests 6 and 8<a name='2908'></font>
<a name='2909'>
               CALL <A href='../../html_code/share/module_bc.F.html#FLOW_DEP_BDY'>flow_dep_bdy</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FLOW_DEP_BDY_4">  ( scalar(ims,kms,jms,is),     &amp;<a name='2910'>
                                  grid%ru_m, grid%rv_m, config_flags,   &amp;<a name='2911'>
                                  grid%spec_zone,                  &amp;<a name='2912'>
                                  ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='2913'></font>
                                  ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='2914'></font>
                                  ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='2915'></font>
                                  grid%i_start(ij), grid%i_end(ij),  &amp;<a name='2916'>
                                  grid%j_start(ij), grid%j_end(ij),  &amp;<a name='2917'>
                                  k_start, k_end                    )<a name='2918'>
             ENDIF<a name='2919'>
<a name='2920'>
           ENDIF<a name='2921'>
<a name='2922'>
         ENDDO scalar_tile_loop_2<a name='2923'>
         <font color=#447700>!$OMP END PARALLEL DO<a name='2924'></font>
<a name='2925'>
       ENDDO scalar_variable_loop<a name='2926'>
<a name='2927'>
     ENDIF other_scalar_advance<a name='2928'>
<a name='2929'>
<font color=#447700>!************************************************************************************************************************<a name='2930'></font>
<font color=#447700>! LES_fix: convert theta_m back to theta, point 2 ! 28 January 2015<a name='2931'></font>
<a name='2932'>
<a name='2933'>
     IF ( ( config_flags%use_theta_m .EQ. 1 ) .AND. (P_Qv .GE. PARAM_FIRST_SCALAR) ) THEN<a name='2934'>
        CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#THETAM_TO_THETA'>thetam_to_theta</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="THETAM_TO_THETA_1"> ( grid%t_1 , moist_old(ims,kms,jms,P_qv) ,  &amp;<a name='2935'>
                               grid%t_2 , moist(ims,kms,jms,P_qv) ,      &amp;<a name='2936'>
                               ids, ide, jds, jde, kds, kde ,            &amp;<a name='2937'>
                               ims, ime, jms, jme, kms, kme ,            &amp;<a name='2938'>
                               ips, ipe, jps, jpe, kps, kpe              )<a name='2939'>
# ifdef DM_PARALLEL<a name='2940'>
#       include "<A href='../../html_code/include/HALO_EM_THETAM.inc.html'>HALO_EM_THETAM.inc</A>"<A NAME="HALO_EM_THETAM.inc_46"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2941'>
#       include "<A href='../../html_code/include/PERIOD_EM_THETAM.inc.html'>PERIOD_EM_THETAM.inc</A>"<A NAME="PERIOD_EM_THETAM.inc_47"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='2942'>
#endif<a name='2943'>
        its=ips ; ite = ipe<a name='2944'>
        jts=jps ; jte = jpe<a name='2945'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_112">( grid%t_1, 'p', config_flags,      &amp;<a name='2946'>
                                ids, ide, jds, jde, kds, kde,     &amp;<a name='2947'>
                                ims, ime, jms, jme, kms, kme,     &amp;<a name='2948'>
                                ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='2949'>
                                its, ite, jts, jte,               &amp;<a name='2950'>
                                k_start    , k_end                )<a name='2951'>
        CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_113">( grid%t_2, 'p', config_flags,      &amp;<a name='2952'>
                                ids, ide, jds, jde, kds, kde,     &amp;<a name='2953'>
                                ims, ime, jms, jme, kms, kme,     &amp;<a name='2954'>
                                ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='2955'>
                                its, ite, jts, jte,               &amp;<a name='2956'>
                                k_start    , k_end                )<a name='2957'>
     END IF<a name='2958'>
<a name='2959'>
<font color=#447700>! end theta_m fix point 2<a name='2960'></font>
<font color=#447700>!************************************************************************************************************************<a name='2961'></font>
<a name='2962'>
 <font color=#447700>!  update the pressure and density at the new time level<a name='2963'></font>
<a name='2964'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='2965'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='2966'></font>
     DO ij = 1 , grid%num_tiles<a name='2967'>
<a name='2968'>
BENCH_START(calc_p_rho_tim)<a name='2969'>
<a name='2970'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI'>calc_p_rho_phi</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_PHI_1">( moist, num_3d_m, config_flags%hypsometric_opt,             &amp;<a name='2971'>
                            grid%al, grid%alb, grid%mu_2, grid%muts,              &amp;<a name='2972'>
                            grid%c1h, grid%c2h, grid%c3h, grid%c4h, grid%c3f, grid%c4f, &amp;<a name='2973'>
                            grid%ph_2, grid%phb, grid%p, grid%pb, grid%t_2,                 &amp;<a name='2974'>
                            p0, t0, grid%p_top, grid%znu, grid%znw, grid%dnw, grid%rdnw,           &amp;<a name='2975'>
                            grid%rdn, config_flags%non_hydrostatic,             &amp;<a name='2976'>
                            ids, ide, jds, jde, kds, kde,     &amp;<a name='2977'>
                            ims, ime, jms, jme, kms, kme,     &amp;<a name='2978'>
                            grid%i_start(ij), grid%i_end(ij), &amp;<a name='2979'>
                            grid%j_start(ij), grid%j_end(ij), &amp;<a name='2980'>
                            k_start    , k_end               )<a name='2981'>
<a name='2982'>
BENCH_END(calc_p_rho_tim)<a name='2983'>
<a name='2984'>
     ENDDO<a name='2985'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='2986'></font>
<a name='2987'>
<font color=#447700>!  Reset the boundary conditions if there is another corrector step.<a name='2988'></font>
<font color=#447700>!  (rk_step &lt; rk_order), else we'll handle it at the end of everything<a name='2989'></font>
<font color=#447700>!  (after the split physics, before exiting the timestep).<a name='2990'></font>
<a name='2991'>
     rk_step_1_check: IF ( rk_step &lt; rk_order ) THEN<a name='2992'>
<a name='2993'>
<font color=#447700>!-----------------------------------------------------------<a name='2994'></font>
<font color=#447700>!  rk3 substep polar filter for scalars (moist,chem,scalar)<a name='2995'></font>
<font color=#447700>!-----------------------------------------------------------<a name='2996'></font>
<a name='2997'>
       IF (config_flags%polar) THEN <a name='2998'>
         IF ( num_3d_m &gt;= PARAM_FIRST_SCALAR ) THEN<a name='2999'>
           CALL wrf_debug ( 200 , ' call filter moist ' )<a name='3000'>
           DO im = PARAM_FIRST_SCALAR, num_3d_m<a name='3001'>
             IF ( config_flags%coupled_filtering ) THEN<a name='3002'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER'>couple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_SCALARS_FOR_FILTER_1"> ( FIELD=moist(ims,kms,jms,im)        &amp;<a name='3003'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3004'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3005'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3006'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3007'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='3008'>
             END IF<a name='3009'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_5"> ( grid=grid                                               &amp;<a name='3010'>
                    ,lineno=__LINE__                                             &amp;<a name='3011'>
                    ,flag_uv            = 0                                      &amp;<a name='3012'>
                    ,flag_rurv          = 0                                      &amp;<a name='3013'>
                    ,flag_wph           = 0                                      &amp;<a name='3014'>
                    ,flag_ww            = 0                                      &amp;<a name='3015'>
                    ,flag_t             = 0                                      &amp;<a name='3016'>
                    ,flag_mu            = 0                                      &amp;<a name='3017'>
                    ,flag_mut           = 0                                      &amp;<a name='3018'>
                    ,flag_moist         = im                                     &amp;<a name='3019'>
                    ,flag_chem          = 0                                      &amp;<a name='3020'>
                    ,flag_scalar        = 0                                      &amp;<a name='3021'>
                    ,flag_tracer        = 0                                      &amp;<a name='3022'>
                    ,actual_distance_average=config_flags%actual_distance_average&amp;<a name='3023'>
                    ,pos_def            = config_flags%pos_def                   &amp;<a name='3024'>
                    ,swap_pole_with_next_j = config_flags%swap_pole_with_next_j  &amp;<a name='3025'>
                    ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='3026'>
                    ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='3027'>
                    ,dclat = dclat                                               &amp;<a name='3028'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3029'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3030'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='3031'>
                    ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='3032'>
                    ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='3033'>
             IF ( config_flags%coupled_filtering ) THEN<a name='3034'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER'>uncouple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNCOUPLE_SCALARS_FOR_FILTER_1"> ( FIELD=moist(ims,kms,jms,im)      &amp;<a name='3035'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3036'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3037'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3038'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3039'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='3040'>
             END IF<a name='3041'>
           END DO<a name='3042'>
         END IF<a name='3043'>
   <a name='3044'>
         IF ( num_3d_c &gt;= PARAM_FIRST_SCALAR ) THEN<a name='3045'>
           CALL wrf_debug ( 200 , ' call filter chem ' )<a name='3046'>
           DO im = PARAM_FIRST_SCALAR, num_3d_c<a name='3047'>
             IF ( config_flags%coupled_filtering ) THEN<a name='3048'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER'>couple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_SCALARS_FOR_FILTER_2"> ( FIELD=chem(ims,kms,jms,im)               &amp;<a name='3049'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3050'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3051'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3052'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3053'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe           )<a name='3054'>
             END IF<a name='3055'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_6"> ( grid=grid                                               &amp;<a name='3056'>
                    ,lineno=__LINE__                                             &amp;<a name='3057'>
                    ,flag_uv            = 0                                      &amp;<a name='3058'>
                    ,flag_rurv          = 0                                      &amp;<a name='3059'>
                    ,flag_wph           = 0                                      &amp;<a name='3060'>
                    ,flag_ww            = 0                                      &amp;<a name='3061'>
                    ,flag_t             = 0                                      &amp;<a name='3062'>
                    ,flag_mu            = 0                                      &amp;<a name='3063'>
                    ,flag_mut           = 0                                      &amp;<a name='3064'>
                    ,flag_moist         = 0                                      &amp;<a name='3065'>
                    ,flag_chem          = im                                     &amp;<a name='3066'>
                    ,flag_tracer        = 0                                      &amp;<a name='3067'>
                    ,flag_scalar        = 0                                      &amp;<a name='3068'>
                    ,actual_distance_average=config_flags%actual_distance_average&amp;<a name='3069'>
                    ,pos_def            = config_flags%pos_def                   &amp;<a name='3070'>
                    ,swap_pole_with_next_j = config_flags%swap_pole_with_next_j  &amp;<a name='3071'>
                    ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='3072'>
                    ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='3073'>
                    ,dclat = dclat                                               &amp;<a name='3074'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3075'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3076'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='3077'>
                    ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='3078'>
                    ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='3079'>
             IF ( config_flags%coupled_filtering ) THEN<a name='3080'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER'>uncouple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNCOUPLE_SCALARS_FOR_FILTER_2"> ( FIELD=chem(ims,kms,jms,im)       &amp;<a name='3081'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3082'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3083'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3084'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3085'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='3086'>
             END IF<a name='3087'>
           END DO<a name='3088'>
         END IF<a name='3089'>
         IF ( num_tracer &gt;= PARAM_FIRST_SCALAR ) THEN<a name='3090'>
           CALL wrf_debug ( 200 , ' call filter tracer ' )<a name='3091'>
           DO im = PARAM_FIRST_SCALAR, num_tracer<a name='3092'>
             IF ( config_flags%coupled_filtering ) THEN<a name='3093'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER'>couple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_SCALARS_FOR_FILTER_3"> ( FIELD=tracer(ims,kms,jms,im)               &amp;<a name='3094'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3095'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3096'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3097'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3098'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe           )<a name='3099'>
             END IF<a name='3100'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_7"> ( grid=grid                                               &amp;<a name='3101'>
                    ,lineno=__LINE__                                             &amp;<a name='3102'>
                    ,flag_uv            = 0                                      &amp;<a name='3103'>
                    ,flag_rurv          = 0                                      &amp;<a name='3104'>
                    ,flag_wph           = 0                                      &amp;<a name='3105'>
                    ,flag_ww            = 0                                      &amp;<a name='3106'>
                    ,flag_t             = 0                                      &amp;<a name='3107'>
                    ,flag_mu            = 0                                      &amp;<a name='3108'>
                    ,flag_mut           = 0                                      &amp;<a name='3109'>
                    ,flag_moist         = 0                                      &amp;<a name='3110'>
                    ,flag_chem          = 0                                      &amp;<a name='3111'>
                    ,flag_tracer        = im                                     &amp;<a name='3112'>
                    ,flag_scalar        = 0                                      &amp;<a name='3113'>
                    ,actual_distance_average=config_flags%actual_distance_average&amp;<a name='3114'>
                    ,pos_def            = config_flags%pos_def                   &amp;<a name='3115'>
                    ,swap_pole_with_next_j = config_flags%swap_pole_with_next_j  &amp;<a name='3116'>
                    ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='3117'>
                    ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='3118'>
                    ,dclat = dclat                                               &amp;<a name='3119'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3120'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3121'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='3122'>
                    ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='3123'>
                    ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='3124'>
             IF ( config_flags%coupled_filtering ) THEN<a name='3125'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER'>uncouple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNCOUPLE_SCALARS_FOR_FILTER_3"> ( FIELD=tracer(ims,kms,jms,im)     &amp;<a name='3126'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3127'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3128'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3129'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3130'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='3131'>
             END IF<a name='3132'>
           END DO<a name='3133'>
         END IF<a name='3134'>
   <a name='3135'>
         IF ( num_3d_s &gt;= PARAM_FIRST_SCALAR ) THEN<a name='3136'>
           CALL wrf_debug ( 200 , ' call filter scalar ' )<a name='3137'>
           DO im = PARAM_FIRST_SCALAR, num_3d_s<a name='3138'>
             IF ( config_flags%coupled_filtering ) THEN<a name='3139'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER'>couple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_SCALARS_FOR_FILTER_4"> ( FIELD=scalar(ims,kms,jms,im)           &amp;<a name='3140'>
                  ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3141'>
                  ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3142'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3143'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3144'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='3145'>
             END IF<a name='3146'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_8"> ( grid=grid                                             &amp;<a name='3147'>
                  ,lineno=__LINE__                                             &amp;<a name='3148'>
                  ,flag_uv            = 0                                      &amp;<a name='3149'>
                  ,flag_rurv          = 0                                      &amp;<a name='3150'>
                  ,flag_wph           = 0                                      &amp;<a name='3151'>
                  ,flag_ww            = 0                                      &amp;<a name='3152'>
                  ,flag_t             = 0                                      &amp;<a name='3153'>
                  ,flag_mu            = 0                                      &amp;<a name='3154'>
                  ,flag_mut           = 0                                      &amp;<a name='3155'>
                  ,flag_moist         = 0                                      &amp;<a name='3156'>
                  ,flag_chem          = 0                                      &amp;<a name='3157'>
                  ,flag_tracer        = 0                                      &amp;<a name='3158'>
                  ,flag_scalar        = im                                     &amp;<a name='3159'>
                  ,actual_distance_average=config_flags%actual_distance_average&amp;<a name='3160'>
                  ,pos_def            = config_flags%pos_def                   &amp;<a name='3161'>
                  ,swap_pole_with_next_j = config_flags%swap_pole_with_next_j  &amp;<a name='3162'>
                  ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='3163'>
                  ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='3164'>
                  ,dclat = dclat                                               &amp;<a name='3165'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3166'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3167'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='3168'>
                  ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='3169'>
                  ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='3170'>
             IF ( config_flags%coupled_filtering ) THEN<a name='3171'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER'>uncouple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNCOUPLE_SCALARS_FOR_FILTER_4"> ( FIELD=scalar(ims,kms,jms,im)   &amp;<a name='3172'>
                  ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3173'>
                  ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3174'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3175'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3176'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='3177'>
             END IF<a name='3178'>
           END DO<a name='3179'>
         END IF<a name='3180'>
       END IF <font color=#447700>! polar filter test<a name='3181'></font>
<a name='3182'>
<font color=#447700>!-----------------------------------------------------------<a name='3183'></font>
<font color=#447700>!  END rk3 substep polar filter for scalars (moist,chem,scalar)<a name='3184'></font>
<font color=#447700>!-----------------------------------------------------------<a name='3185'></font>
<a name='3186'>
<font color=#447700>!-----------------------------------------------------------<a name='3187'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='3188'></font>
<font color=#447700>!<a name='3189'></font>
<font color=#447700>!  here's where we need a wide comm stencil - these are the <a name='3190'></font>
<font color=#447700>!  uncoupled variables so are used for high order calc in<a name='3191'></font>
<font color=#447700>!  advection and mixong routines.<a name='3192'></font>
<font color=#447700>!<a name='3193'></font>
<font color=#447700>!<a name='3194'></font>
<font color=#447700>!                                  * * * * * * *<a name='3195'></font>
<font color=#447700>!                     * * * * *    * * * * * * *<a name='3196'></font>
<font color=#447700>!            *        * * * * *    * * * * * * *<a name='3197'></font>
<font color=#447700>!          * + *      * * + * *    * * * + * * *<a name='3198'></font>
<font color=#447700>!            *        * * * * *    * * * * * * *<a name='3199'></font>
<font color=#447700>!                     * * * * *    * * * * * * *<a name='3200'></font>
<font color=#447700>!                                  * * * * * * *<a name='3201'></font>
<font color=#447700>!<a name='3202'></font>
<font color=#447700>! al        x<a name='3203'></font>
<font color=#447700>!<a name='3204'></font>
<font color=#447700>!  2D variable<a name='3205'></font>
<font color=#447700>! mu_2      x<a name='3206'></font>
<font color=#447700>!<a name='3207'></font>
<font color=#447700>! (adv order &lt;=4)<a name='3208'></font>
<font color=#447700>! u_2                     x<a name='3209'></font>
<font color=#447700>! v_2                     x<a name='3210'></font>
<font color=#447700>! w_2                     x<a name='3211'></font>
<font color=#447700>! t_2                     x<a name='3212'></font>
<font color=#447700>! ph_2                    x<a name='3213'></font>
<font color=#447700>!<a name='3214'></font>
<font color=#447700>! (adv order &lt;=6)<a name='3215'></font>
<font color=#447700>! u_2                                    x<a name='3216'></font>
<font color=#447700>! v_2                                    x<a name='3217'></font>
<font color=#447700>! w_2                                    x<a name='3218'></font>
<font color=#447700>! t_2                                    x<a name='3219'></font>
<font color=#447700>! ph_2                                   x<a name='3220'></font>
<font color=#447700>!<a name='3221'></font>
<font color=#447700>!  4D variable<a name='3222'></font>
<font color=#447700>! moist                   x<a name='3223'></font>
<font color=#447700>! chem                    x<a name='3224'></font>
<font color=#447700>! scalar                  x<a name='3225'></font>
<a name='3226'>
#ifdef DM_PARALLEL<a name='3227'>
       IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='3228'>
#    include "<A href='../../html_code/include/HALO_EM_D2_3.inc.html'>HALO_EM_D2_3.inc</A>"<A NAME="HALO_EM_D2_3.inc_48"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3229'>
       ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='3230'>
#    include "<A href='../../html_code/include/HALO_EM_D2_5.inc.html'>HALO_EM_D2_5.inc</A>"<A NAME="HALO_EM_D2_5.inc_49"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3231'>
       ELSE <a name='3232'>
         WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='3233'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_58">(TRIM(wrf_err_message))<a name='3234'>
       ENDIF<a name='3235'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_D.inc.html'>PERIOD_BDY_EM_D.inc</A>"<A NAME="PERIOD_BDY_EM_D.inc_50"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3236'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST2.inc.html'>PERIOD_BDY_EM_MOIST2.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST2.inc_51"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3237'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM2.inc.html'>PERIOD_BDY_EM_CHEM2.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM2.inc_52"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3238'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_TRACER2.inc.html'>PERIOD_BDY_EM_TRACER2.inc</A>"<A NAME="PERIOD_BDY_EM_TRACER2.inc_53"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3239'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_SCALAR2.inc.html'>PERIOD_BDY_EM_SCALAR2.inc</A>"<A NAME="PERIOD_BDY_EM_SCALAR2.inc_54"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3240'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_TKE.inc.html'>PERIOD_BDY_EM_TKE.inc</A>"<A NAME="PERIOD_BDY_EM_TKE.inc_55"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3241'>
#endif<a name='3242'>
<a name='3243'>
BENCH_START(bc_end_tim)<a name='3244'>
       <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3245'></font>
       <font color=#447700>!$OMP PRIVATE ( ij )<a name='3246'></font>
       tile_bc_loop_1: DO ij = 1 , grid%num_tiles<a name='3247'>
         CALL wrf_debug ( 200 , ' call rk_phys_bc_dry_2' )<a name='3248'>
<a name='3249'>
         CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#RK_PHYS_BC_DRY_2'>rk_phys_bc_dry_2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RK_PHYS_BC_DRY_2_1">( config_flags,                     &amp;<a name='3250'>
                                grid%u_2, grid%v_2, grid%w_2,     &amp;<a name='3251'>
                                grid%t_2, grid%ph_2, grid%mu_2,   &amp;<a name='3252'>
                                ids, ide, jds, jde, kds, kde,     &amp;<a name='3253'>
                                ims, ime, jms, jme, kms, kme,     &amp;<a name='3254'>
                                ips, ipe, jps, jpe, kps, kpe,     &amp;<a name='3255'>
                                grid%i_start(ij), grid%i_end(ij), &amp;<a name='3256'>
                                grid%j_start(ij), grid%j_end(ij), &amp;<a name='3257'>
                                k_start    , k_end               )<a name='3258'>
<a name='3259'>
BENCH_START(diag_w_tim)<a name='3260'>
         IF (.not. config_flags%non_hydrostatic) THEN<a name='3261'>
           CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W'>diagnose_w</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSE_W_1">( ph_tend, grid%ph_2, grid%ph_1, grid%w_2, grid%muts, &amp;<a name='3262'>
                            grid%c1f, grid%c2f, dt_rk,              &amp;<a name='3263'>
                            grid%u_2, grid%v_2, grid%ht,            &amp;<a name='3264'>
                            grid%cf1, grid%cf2, grid%cf3, grid%rdx, grid%rdy, grid%msftx, grid%msfty, &amp;<a name='3265'>
                            ids, ide, jds, jde, kds, kde,           &amp;<a name='3266'>
                            ims, ime, jms, jme, kms, kme,           &amp;<a name='3267'>
                            grid%i_start(ij), grid%i_end(ij),       &amp;<a name='3268'>
                            grid%j_start(ij), grid%j_end(ij),       &amp;<a name='3269'>
                            k_start    , k_end                     )<a name='3270'>
         ENDIF<a name='3271'>
BENCH_END(diag_w_tim)<a name='3272'>
<a name='3273'>
         IF (num_3d_m &gt;= PARAM_FIRST_SCALAR) THEN<a name='3274'>
<a name='3275'>
           moisture_loop_bdy_1 : DO im = PARAM_FIRST_SCALAR , num_3d_m<a name='3276'>
  <a name='3277'>
             CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_114">( moist(ims,kms,jms,im), 'p', config_flags,   &amp;<a name='3278'>
                                     ids, ide, jds, jde, kds, kde,             &amp;<a name='3279'>
                                     ims, ime, jms, jme, kms, kme,             &amp;<a name='3280'>
                                     ips, ipe, jps, jpe, kps, kpe,             &amp;<a name='3281'>
                                     grid%i_start(ij), grid%i_end(ij),                   &amp;<a name='3282'>
                                     grid%j_start(ij), grid%j_end(ij),                   &amp;<a name='3283'>
                                     k_start    , k_end                       )<a name='3284'>
           END DO moisture_loop_bdy_1<a name='3285'>
<a name='3286'>
         ENDIF<a name='3287'>
<a name='3288'>
         IF (num_3d_c &gt;= PARAM_FIRST_SCALAR) THEN<a name='3289'>
<a name='3290'>
           chem_species_bdy_loop_1 : DO ic = PARAM_FIRST_SCALAR , num_3d_c<a name='3291'>
<a name='3292'>
             CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_115">( chem(ims,kms,jms,ic), 'p', config_flags,   &amp;<a name='3293'>
                                     ids, ide, jds, jde, kds, kde,            &amp;<a name='3294'>
                                     ims, ime, jms, jme, kms, kme,            &amp;<a name='3295'>
                                     ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='3296'>
                                     grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='3297'>
                                     grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='3298'>
                                     k_start    , k_end-1                    )<a name='3299'>
<a name='3300'>
           END DO chem_species_bdy_loop_1<a name='3301'>
<a name='3302'>
         END IF<a name='3303'>
<a name='3304'>
         IF (num_tracer &gt;= PARAM_FIRST_SCALAR) THEN<a name='3305'>
<a name='3306'>
           tracer_species_bdy_loop_1 : DO ic = PARAM_FIRST_SCALAR , num_tracer<a name='3307'>
<a name='3308'>
             CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_116">( tracer(ims,kms,jms,ic), 'p', config_flags,   &amp;<a name='3309'>
                                     ids, ide, jds, jde, kds, kde,            &amp;<a name='3310'>
                                     ims, ime, jms, jme, kms, kme,            &amp;<a name='3311'>
                                     ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='3312'>
                                     grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='3313'>
                                     grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='3314'>
                                     k_start    , k_end-1                    )<a name='3315'>
<a name='3316'>
           END DO tracer_species_bdy_loop_1<a name='3317'>
<a name='3318'>
         END IF<a name='3319'>
<a name='3320'>
         IF (num_3d_s &gt;= PARAM_FIRST_SCALAR) THEN<a name='3321'>
<a name='3322'>
           scalar_species_bdy_loop_1 : DO is = PARAM_FIRST_SCALAR , num_3d_s<a name='3323'>
<a name='3324'>
             CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_117">( scalar(ims,kms,jms,is), 'p', config_flags,   &amp;<a name='3325'>
                                     ids, ide, jds, jde, kds, kde,            &amp;<a name='3326'>
                                     ims, ime, jms, jme, kms, kme,            &amp;<a name='3327'>
                                     ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='3328'>
                                     grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='3329'>
                                     grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='3330'>
                                     k_start    , k_end-1                    )<a name='3331'>
<a name='3332'>
           END DO scalar_species_bdy_loop_1<a name='3333'>
<a name='3334'>
         END IF<a name='3335'>
<a name='3336'>
         IF (config_flags%km_opt .eq. 2) THEN<a name='3337'>
<a name='3338'>
           CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_118">( grid%tke_2 , 'p', config_flags,  &amp;<a name='3339'>
                                   ids, ide, jds, jde, kds, kde,            &amp;<a name='3340'>
                                   ims, ime, jms, jme, kms, kme,            &amp;<a name='3341'>
                                   ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='3342'>
                                   grid%i_start(ij), grid%i_end(ij),        &amp;<a name='3343'>
                                   grid%j_start(ij), grid%j_end(ij),        &amp;<a name='3344'>
                                   k_start    , k_end                      )<a name='3345'>
         END IF<a name='3346'>
<a name='3347'>
       END DO tile_bc_loop_1<a name='3348'>
       <font color=#447700>!$OMP END PARALLEL DO<a name='3349'></font>
BENCH_END(bc_end_tim)<a name='3350'>
<a name='3351'>
<a name='3352'>
#ifdef DM_PARALLEL<a name='3353'>
<a name='3354'>
<font color=#447700>!                           * * * * *<a name='3355'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='3356'></font>
<font color=#447700>!       * + *      * + *    * * + * *<a name='3357'></font>
<font color=#447700>!         *        * * *    * * * * *<a name='3358'></font>
<font color=#447700>!                           * * * * *<a name='3359'></font>
<a name='3360'>
<font color=#447700>! moist, chem, scalar, tke      x<a name='3361'></font>
<a name='3362'>
<a name='3363'>
       IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='3364'>
         IF ( (config_flags%tke_adv_opt /= ORIGINAL .and. config_flags%tke_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3365'>
#         include "<A href='../../html_code/include/HALO_EM_TKE_5.inc.html'>HALO_EM_TKE_5.inc</A>"<A NAME="HALO_EM_TKE_5.inc_56"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3366'>
         ELSE<a name='3367'>
#         include "<A href='../../html_code/include/HALO_EM_TKE_3.inc.html'>HALO_EM_TKE_3.inc</A>"<A NAME="HALO_EM_TKE_3.inc_57"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3368'>
         ENDIF<a name='3369'>
       ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='3370'>
         IF ( (config_flags%tke_adv_opt /= ORIGINAL .and. config_flags%tke_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3371'>
#         include "<A href='../../html_code/include/HALO_EM_TKE_7.inc.html'>HALO_EM_TKE_7.inc</A>"<A NAME="HALO_EM_TKE_7.inc_58"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3372'>
         ELSE<a name='3373'>
#         include "<A href='../../html_code/include/HALO_EM_TKE_5.inc.html'>HALO_EM_TKE_5.inc</A>"<A NAME="HALO_EM_TKE_5.inc_59"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3374'>
         ENDIF<a name='3375'>
       ELSE<a name='3376'>
         WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='3377'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_59">(TRIM(wrf_err_message))<a name='3378'>
       ENDIF<a name='3379'>
<a name='3380'>
       IF ( num_moist .GE. PARAM_FIRST_SCALAR ) THEN<a name='3381'>
         IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='3382'>
           IF ( (config_flags%moist_adv_opt /= ORIGINAL .and. config_flags%moist_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3383'>
#        include "<A href='../../html_code/include/HALO_EM_MOIST_E_5.inc.html'>HALO_EM_MOIST_E_5.inc</A>"<A NAME="HALO_EM_MOIST_E_5.inc_60"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3384'>
           ELSE<a name='3385'>
#        include "<A href='../../html_code/include/HALO_EM_MOIST_E_3.inc.html'>HALO_EM_MOIST_E_3.inc</A>"<A NAME="HALO_EM_MOIST_E_3.inc_61"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3386'>
           END IF<a name='3387'>
         ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='3388'>
           IF ( (config_flags%moist_adv_opt /= ORIGINAL .and. config_flags%moist_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3389'>
#        include "<A href='../../html_code/include/HALO_EM_MOIST_E_7.inc.html'>HALO_EM_MOIST_E_7.inc</A>"<A NAME="HALO_EM_MOIST_E_7.inc_62"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3390'>
           ELSE<a name='3391'>
#        include "<A href='../../html_code/include/HALO_EM_MOIST_E_5.inc.html'>HALO_EM_MOIST_E_5.inc</A>"<A NAME="HALO_EM_MOIST_E_5.inc_63"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3392'>
           END IF<a name='3393'>
         ELSE<a name='3394'>
           WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='3395'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_60">(TRIM(wrf_err_message))<a name='3396'>
         ENDIF<a name='3397'>
       ENDIF<a name='3398'>
       IF ( num_chem &gt;= PARAM_FIRST_SCALAR ) THEN<a name='3399'>
         IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='3400'>
           IF ( (config_flags%chem_adv_opt /= ORIGINAL .and. config_flags%chem_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3401'>
#        include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_64"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3402'>
           ELSE<a name='3403'>
#        include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_65"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3404'>
           ENDIF<a name='3405'>
         ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='3406'>
           IF ( (config_flags%chem_adv_opt /= ORIGINAL .and. config_flags%chem_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3407'>
#        include "<A href='../../html_code/include/HALO_EM_CHEM_E_7.inc.html'>HALO_EM_CHEM_E_7.inc</A>"<A NAME="HALO_EM_CHEM_E_7.inc_66"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3408'>
           ELSE<a name='3409'>
#        include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_67"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3410'>
           ENDIF<a name='3411'>
         ELSE<a name='3412'>
           WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='3413'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_61">(TRIM(wrf_err_message))<a name='3414'>
         ENDIF<a name='3415'>
       ENDIF<a name='3416'>
       IF ( num_tracer &gt;= PARAM_FIRST_SCALAR ) THEN<a name='3417'>
         IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='3418'>
           IF ( (config_flags%tracer_adv_opt /= ORIGINAL .and. config_flags%tracer_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3419'>
#        include "<A href='../../html_code/include/HALO_EM_TRACER_E_5.inc.html'>HALO_EM_TRACER_E_5.inc</A>"<A NAME="HALO_EM_TRACER_E_5.inc_68"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3420'>
           ELSE<a name='3421'>
#        include "<A href='../../html_code/include/HALO_EM_TRACER_E_3.inc.html'>HALO_EM_TRACER_E_3.inc</A>"<A NAME="HALO_EM_TRACER_E_3.inc_69"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3422'>
           ENDIF<a name='3423'>
         ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='3424'>
           IF ( (config_flags%tracer_adv_opt /= ORIGINAL .and. config_flags%tracer_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3425'>
#        include "<A href='../../html_code/include/HALO_EM_TRACER_E_7.inc.html'>HALO_EM_TRACER_E_7.inc</A>"<A NAME="HALO_EM_TRACER_E_7.inc_70"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3426'>
           ELSE<a name='3427'>
#        include "<A href='../../html_code/include/HALO_EM_TRACER_E_5.inc.html'>HALO_EM_TRACER_E_5.inc</A>"<A NAME="HALO_EM_TRACER_E_5.inc_71"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3428'>
           ENDIF<a name='3429'>
         ELSE<a name='3430'>
           WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='3431'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_62">(TRIM(wrf_err_message))<a name='3432'>
         ENDIF<a name='3433'>
       ENDIF<a name='3434'>
       IF ( num_scalar &gt;= PARAM_FIRST_SCALAR ) THEN<a name='3435'>
         IF      ( config_flags%h_sca_adv_order &lt;= 4 ) THEN<a name='3436'>
           IF ( (config_flags%scalar_adv_opt /= ORIGINAL .and. config_flags%scalar_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3437'>
#        include "<A href='../../html_code/include/HALO_EM_SCALAR_E_5.inc.html'>HALO_EM_SCALAR_E_5.inc</A>"<A NAME="HALO_EM_SCALAR_E_5.inc_72"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3438'>
           ELSE<a name='3439'>
#        include "<A href='../../html_code/include/HALO_EM_SCALAR_E_3.inc.html'>HALO_EM_SCALAR_E_3.inc</A>"<A NAME="HALO_EM_SCALAR_E_3.inc_73"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3440'>
           ENDIF<a name='3441'>
         ELSE IF ( config_flags%h_sca_adv_order &lt;= 6 ) THEN<a name='3442'>
           IF ( (config_flags%scalar_adv_opt /= ORIGINAL .and. config_flags%scalar_adv_opt /= WENO_SCALAR) .and. (rk_step == rk_order-1) ) THEN<a name='3443'>
#        include "<A href='../../html_code/include/HALO_EM_SCALAR_E_7.inc.html'>HALO_EM_SCALAR_E_7.inc</A>"<A NAME="HALO_EM_SCALAR_E_7.inc_74"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3444'>
           ELSE<a name='3445'>
#        include "<A href='../../html_code/include/HALO_EM_SCALAR_E_5.inc.html'>HALO_EM_SCALAR_E_5.inc</A>"<A NAME="HALO_EM_SCALAR_E_5.inc_75"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3446'>
           ENDIF<a name='3447'>
         ELSE<a name='3448'>
           WRITE(wrf_err_message,*)'solve_em: invalid h_sca_adv_order = ',config_flags%h_sca_adv_order<a name='3449'>
           CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_63">(TRIM(wrf_err_message))<a name='3450'>
         ENDIF<a name='3451'>
       ENDIF<a name='3452'>
#endif<a name='3453'>
<a name='3454'>
     ENDIF rk_step_1_check<a name='3455'>
<a name='3456'>
<a name='3457'>
<font color=#447700>!**********************************************************<a name='3458'></font>
<font color=#447700>!<a name='3459'></font>
<font color=#447700>!  end of RK predictor-corrector loop<a name='3460'></font>
<font color=#447700>!<a name='3461'></font>
<font color=#447700>!**********************************************************<a name='3462'></font>
<a name='3463'>
   END DO Runge_Kutta_loop<a name='3464'>
<font color=#447700>!  grid%dmudt=grid%mu_2 - grid%mu_1<a name='3465'></font>
<a name='3466'>
   IF      ( config_flags%traj_opt .EQ. UM_TRAJECTORY ) THEN<a name='3467'>
#ifdef DM_PARALLEL<a name='3468'>
#    include "<A href='../../html_code/include/HALO_EM_F_1.inc.html'>HALO_EM_F_1.inc</A>"<A NAME="HALO_EM_F_1.inc_76"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3469'>
#    include "<A href='../../html_code/include/HALO_EM_D.inc.html'>HALO_EM_D.inc</A>"<A NAME="HALO_EM_D.inc_77"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3470'>
#    include "<A href='../../html_code/include/HALO_EM_INIT_4.inc.html'>HALO_EM_INIT_4.inc</A>"<A NAME="HALO_EM_INIT_4.inc_78"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3471'>
     IF( config_flags%periodic_x ) THEN<a name='3472'>
#    include "<A href='../../html_code/include/PERIOD_EM_DA.inc.html'>PERIOD_EM_DA.inc</A>"<A NAME="PERIOD_EM_DA.inc_79"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3473'>
#    include "<A href='../../html_code/include/PERIOD_EM_F.inc.html'>PERIOD_EM_F.inc</A>"<A NAME="PERIOD_EM_F.inc_80"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3474'>
#    include "<A href='../../html_code/include/PERIOD_EM_G.inc.html'>PERIOD_EM_G.inc</A>"<A NAME="PERIOD_EM_G.inc_81"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3475'>
     ENDIF<a name='3476'>
#endif<a name='3477'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3478'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='3479'></font>
       DO ij = 1 , grid%num_tiles<a name='3480'>
<a name='3481'>
           call <A href='../../html_code/dyn_em/module_em.F.html#TRAJECTORY'>trajectory</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRAJECTORY_1"> (grid,config_flags,                                     &amp;<a name='3482'>
                            grid%dt,grid%itimestep,grid%ru_m, grid%rv_m, grid%ww_m,&amp;<a name='3483'>
                            grid%muts,grid%muus,grid%muvs,                         &amp;<a name='3484'>
                            grid%c1h, grid%c2h, grid%c1f, grid%c2f,                &amp;<a name='3485'>
                            grid%rdx, grid%rdy, grid%rdn, grid%rdnw,grid%rdzw,     &amp;<a name='3486'>
                            grid%traj_i,grid%traj_j,grid%traj_k,                   &amp;<a name='3487'>
                            grid%traj_long,grid%traj_lat,                          &amp;<a name='3488'>
                            grid%xlong,grid%xlat,                                  &amp;<a name='3489'>
                            grid%msftx,grid%msfux,grid%msfvy,                      &amp;<a name='3490'>
                            ids, ide, jds, jde, kds, kde,                          &amp;<a name='3491'>
                            ims, ime, jms, jme, kms, kme,                          &amp;<a name='3492'>
                            grid%i_start(ij), grid%i_end(ij),                      &amp;<a name='3493'>
                            grid%j_start(ij), grid%j_end(ij),                      &amp;<a name='3494'>
                            k_start  , k_end                                       )<a name='3495'>
        ENDDO<a name='3496'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='3497'></font>
   ENDIF<a name='3498'>
<font color=#447700>!-----------------------------------------------------------<a name='3499'></font>
<a name='3500'>
   IF (config_flags%do_avgflx_em .EQ. 1) THEN<a name='3501'>
<font color=#447700>! Reinitialize time-averaged fluxes if history output was written after the previous time step:<a name='3502'></font>
      CALL WRFU_ALARMGET(grid%alarms( HISTORY_ALARM ),prevringtime=temp_time)<a name='3503'>
      CALL <A href='../../html_code/frame/module_domain.F.html#DOMAIN_CLOCK_GET'>domain_clock_get</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DOMAIN_CLOCK_GET_5"> ( grid, current_time=CurrTime, &amp;<a name='3504'>
           current_timestr=message2 )<a name='3505'>
<font color=#447700>! use overloaded -, .LT. operator to check whether to initialize avgflx:<a name='3506'></font>
<font color=#447700>! reinitialize after each history output (detect this here by comparing current time<a name='3507'></font>
<font color=#447700>! against last history time and time step - this code follows what's done in adapt_timestep_em):<a name='3508'></font>
      WRITE ( message , FMT = '("solve_em: old_dt =",g15.6,", dt=",g15.6," on domain ",I3)' ) &amp;<a name='3509'>
           &amp; old_dt,grid%dt,grid%id<a name='3510'>
      CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_35">(200,message)<a name='3511'>
      old_dt=min(old_dt,grid%dt)<a name='3512'>
      num = INT(old_dt * precision)<a name='3513'>
      den = precision<a name='3514'>
      CALL WRFU_TimeIntervalSet(dtInterval, Sn=num, Sd=den)<a name='3515'>
      IF (CurrTime .lt. temp_time + dtInterval) THEN<a name='3516'>
         WRITE ( message , FMT = '("solve_em: initializing avgflx at time ",A," on domain ",I3)' ) &amp;<a name='3517'>
              &amp; TRIM(message2), grid%id<a name='3518'>
         CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_MESSAGE'>wrf_message</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_MESSAGE_45">(trim(message)) <a name='3519'>
         grid%avgflx_count = 0<a name='3520'>
<font color=#447700>!tile-loop for zero_avgflx<a name='3521'></font>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3522'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='3523'></font>
<a name='3524'>
         DO ij = 1 , grid%num_tiles<a name='3525'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_36">(200,'In solve_em, before zero_avgflx call')<a name='3526'>
            CALL <A href='../../html_code/dyn_em/module_avgflx_em.F.html#ZERO_AVGFLX'>zero_avgflx</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ZERO_AVGFLX_1">(grid%avgflx_rum,grid%avgflx_rvm,grid%avgflx_wwm, &amp;<a name='3527'>
                 &amp;   ids, ide, jds, jde, kds, kde,           &amp;<a name='3528'>
                 &amp;   ims, ime, jms, jme, kms, kme,           &amp;<a name='3529'>
                 &amp;   grid%i_start(ij), grid%i_end(ij), grid%j_start(ij), grid%j_end(ij), &amp;<a name='3530'>
                 &amp;   k_start    , k_end, f_flux, &amp;<a name='3531'>
                 &amp;   grid%avgflx_cfu1,grid%avgflx_cfd1,grid%avgflx_dfu1, &amp;<a name='3532'>
                 &amp;   grid%avgflx_efu1,grid%avgflx_dfd1,grid%avgflx_efd1 )<a name='3533'>
            CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_37">(200,'In solve_em, after zero_avgflx call')<a name='3534'>
         ENDDO<a name='3535'>
      ENDIF<a name='3536'>
<a name='3537'>
<font color=#447700>! Update avgflx quantities<a name='3538'></font>
<font color=#447700>!tile-loop for upd_avgflx<a name='3539'></font>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3540'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='3541'></font>
<a name='3542'>
      DO ij = 1 , grid%num_tiles<a name='3543'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_38">(200,'In solve_em, before upd_avgflx call')<a name='3544'>
         CALL <A href='../../html_code/dyn_em/module_avgflx_em.F.html#UPD_AVGFLX'>upd_avgflx</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPD_AVGFLX_1">(grid%avgflx_count,grid%avgflx_rum,grid%avgflx_rvm,grid%avgflx_wwm, &amp;<a name='3545'>
              &amp;   grid%ru_m, grid%rv_m, grid%ww_m, &amp;<a name='3546'>
              &amp;   ids, ide, jds, jde, kds, kde,           &amp;<a name='3547'>
              &amp;   ims, ime, jms, jme, kms, kme,           &amp;<a name='3548'>
              &amp;   grid%i_start(ij), grid%i_end(ij), grid%j_start(ij), grid%j_end(ij), &amp;<a name='3549'>
              &amp;   k_start    , k_end, f_flux, &amp;<a name='3550'>
              &amp;   grid%cfu1,grid%cfd1,grid%dfu1,grid%efu1,grid%dfd1,grid%efd1,          &amp;<a name='3551'>
              &amp;   grid%avgflx_cfu1,grid%avgflx_cfd1,grid%avgflx_dfu1, &amp;<a name='3552'>
              &amp;   grid%avgflx_efu1,grid%avgflx_dfd1,grid%avgflx_efd1 )<a name='3553'>
         CALL <A href='../../html_code/frame/wrf_debug.F.html#WRF_DEBUG'>wrf_debug</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_DEBUG_39">(200,'In solve_em, after upd_avgflx call')<a name='3554'>
         <a name='3555'>
      ENDDO<a name='3556'>
      grid%avgflx_count = grid%avgflx_count + 1<a name='3557'>
   ENDIF<a name='3558'>
<font color=#447700>!<a name='3559'></font>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3560'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='3561'></font>
   DO ij = 1 , grid%num_tiles<a name='3562'>
<a name='3563'>
BENCH_START(advance_ppt_tim)<a name='3564'>
     CALL wrf_debug ( 200 , ' call advance_ppt' )<a name='3565'>
     CALL <A href='../../html_code/phys/module_physics_addtendc.F.html#ADVANCE_PPT'>advance_ppt</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ADVANCE_PPT_1">(grid%rthcuten,grid%rqvcuten,grid%rqccuten,grid%rqrcuten, &amp;<a name='3566'>
                      grid%cldfra_cup,                                         &amp; <font color=#447700>!BSINGH -  Added for CuP scheme<a name='3567'></font>
                      grid%rqicuten,grid%rqscuten,           &amp;<a name='3568'>
                      grid%rainc,grid%raincv,grid%rainsh,grid%pratec,grid%pratesh, &amp;<a name='3569'>
                      grid%nca,grid%htop,grid%hbot,grid%cutop,grid%cubot,  &amp;<a name='3570'>
                      grid%cuppt, grid%dt, config_flags,                   &amp;<a name='3571'>
                      ids,ide, jds,jde, kds,kde,             &amp;<a name='3572'>
                      ims,ime, jms,jme, kms,kme,             &amp;<a name='3573'>
                      grid%i_start(ij), grid%i_end(ij),      &amp;<a name='3574'>
                      grid%j_start(ij), grid%j_end(ij),      &amp;<a name='3575'>
                      k_start    , k_end                    )<a name='3576'>
BENCH_END(advance_ppt_tim)<a name='3577'>
<a name='3578'>
   ENDDO<a name='3579'>
  <font color=#447700>!$OMP END PARALLEL DO<a name='3580'></font>
<a name='3581'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3582'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='3583'></font>
   DO ij = 1 , grid%num_tiles<a name='3584'>
        CALL wrf_debug ( 200 , ' call phy_prep_part2' )<a name='3585'>
        CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#PHY_PREP_PART2'>phy_prep_part2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHY_PREP_PART2_1"> ( config_flags,                              &amp;<a name='3586'>
                        grid%muts, grid%muus, grid%muvs,                 &amp;<a name='3587'>
                        grid%c1h, grid%c2h, grid%c1f, grid%c2f,          &amp;<a name='3588'>
                        grid%rthraten,                                   &amp;<a name='3589'>
                        grid%rthblten, grid%rublten, grid%rvblten,       &amp;<a name='3590'>
                        grid%rqvblten, grid%rqcblten, grid%rqiblten,     &amp;<a name='3591'>
                        grid%rucuten,  grid%rvcuten,  grid%rthcuten,     &amp;<a name='3592'>
                        grid%rqvcuten, grid%rqccuten, grid%rqrcuten,     &amp;<a name='3593'>
                        grid%rqicuten, grid%rqscuten,                    &amp;<a name='3594'>
                        grid%rushten,  grid%rvshten,  grid%rthshten,     &amp;<a name='3595'>
                        grid%rqvshten, grid%rqcshten, grid%rqrshten,     &amp;<a name='3596'>
                        grid%rqishten, grid%rqsshten, grid%rqgshten,     &amp;<a name='3597'>
                        grid%rthften,  grid%rqvften,                     &amp;<a name='3598'>
                        grid%RUNDGDTEN, grid%RVNDGDTEN, grid%RTHNDGDTEN, &amp;<a name='3599'>
                        grid%RPHNDGDTEN,grid%RQVNDGDTEN, grid%RMUNDGDTEN,&amp;<a name='3600'>
                        ids, ide, jds, jde, kds, kde,                    &amp;<a name='3601'>
                        ims, ime, jms, jme, kms, kme,                    &amp;<a name='3602'>
                        grid%i_start(ij), grid%i_end(ij),                &amp;<a name='3603'>
                        grid%j_start(ij), grid%j_end(ij),                &amp;<a name='3604'>
                        k_start, k_end                                   )<a name='3605'>
   ENDDO<a name='3606'>
  <font color=#447700>!$OMP END PARALLEL DO<a name='3607'></font>
<a name='3608'>
<font color=#447700>!&lt;DESCRIPTION&gt;<a name='3609'></font>
<font color=#447700>!&lt;pre&gt;<a name='3610'></font>
<font color=#447700>! (5) time-split physics.<a name='3611'></font>
<font color=#447700>!<a name='3612'></font>
<font color=#447700>!     Microphysics are the only time  split physics in the WRF model <a name='3613'></font>
<font color=#447700>!     at this time.  Split-physics begins with the calculation of<a name='3614'></font>
<font color=#447700>!     needed diagnostic quantities (pressure, temperature, etc.)<a name='3615'></font>
<font color=#447700>!     followed by a call to the microphysics driver, <a name='3616'></font>
<font color=#447700>!     and finishes with a clean-up, storing off of a diabatic tendency<a name='3617'></font>
<font color=#447700>!     from the moist physics, and a re-calulation of the  diagnostic<a name='3618'></font>
<font color=#447700>!     quantities pressure and density.<a name='3619'></font>
<font color=#447700>!&lt;/pre&gt;<a name='3620'></font>
<font color=#447700>!&lt;/DESCRIPTION&gt;<a name='3621'></font>
<a name='3622'>
   IF( config_flags%specified .or. config_flags%nested ) THEN<a name='3623'>
     sz = grid%spec_zone<a name='3624'>
   ELSE<a name='3625'>
     sz = 0<a name='3626'>
   ENDIF<a name='3627'>
<a name='3628'>
   IF (config_flags%mp_physics /= 0)  then<a name='3629'>
<a name='3630'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3631'></font>
     <font color=#447700>!$OMP PRIVATE ( ij, its, ite, jts, jte )<a name='3632'></font>
<a name='3633'>
     scalar_tile_loop_1a: DO ij = 1 , grid%num_tiles<a name='3634'>
<a name='3635'>
       IF ( config_flags%periodic_x ) THEN<a name='3636'>
         its = max(grid%i_start(ij),ids)<a name='3637'>
         ite = min(grid%i_end(ij),ide-1)<a name='3638'>
       ELSE<a name='3639'>
         its = max(grid%i_start(ij),ids+sz)<a name='3640'>
         ite = min(grid%i_end(ij),ide-1-sz)<a name='3641'>
       ENDIF<a name='3642'>
       jts = max(grid%j_start(ij),jds+sz)<a name='3643'>
       jte = min(grid%j_end(ij),jde-1-sz)<a name='3644'>
<a name='3645'>
       CALL wrf_debug ( 200 , ' call moist_physics_prep' )<a name='3646'>
BENCH_START(moist_physics_prep_tim)<a name='3647'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_PREP_EM'>moist_physics_prep_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOIST_PHYSICS_PREP_EM_1">( grid%t_2, grid%t_1, t0, grid%rho,           &amp;<a name='3648'>
                                   grid%al, grid%alb, grid%p, p8w, p0, grid%pb,          &amp;<a name='3649'>
                                   grid%ph_2, grid%phb, th_phy, pi_phy , p_phy, &amp;<a name='3650'>
                                   grid%z, grid%z_at_w, dz8w,        &amp;<a name='3651'>
                                   dtm, grid%h_diabatic,                       &amp;<a name='3652'>
                                   moist(ims,kms,jms,P_QV),grid%qv_diabatic,   &amp;<a name='3653'>
                                   moist(ims,kms,jms,P_QC),grid%qc_diabatic,   &amp;<a name='3654'>
                                   config_flags,grid%fnm, grid%fnp,            &amp;<a name='3655'>
                                   ids, ide, jds, jde, kds, kde,     &amp;<a name='3656'>
                                   ims, ime, jms, jme, kms, kme,     &amp;<a name='3657'>
                                   its, ite, jts, jte,               &amp;<a name='3658'>
                                   k_start    , k_end               )<a name='3659'>
BENCH_END(moist_physics_prep_tim)<a name='3660'>
     END DO scalar_tile_loop_1a<a name='3661'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='3662'></font>
<a name='3663'>
     CALL wrf_debug ( 200 , ' call microphysics_driver' )<a name='3664'>
<a name='3665'>
     grid%sr = 0.<a name='3666'>
     specified_bdy = config_flags%specified .OR. config_flags%nested<a name='3667'>
     channel_bdy = config_flags%specified .AND. config_flags%periodic_x<a name='3668'>
<a name='3669'>
BENCH_START(micro_driver_tim)<a name='3670'>
<a name='3671'>
<font color=#447700>!<a name='3672'></font>
<font color=#447700>! WRFU_AlarmIsRinging always returned false, so using an alternate  method to find out if it is time <a name='3673'></font>
<font color=#447700>! to dump history/restart files so microphysics can be told to calculate things like radar reflectivity.<a name='3674'></font>
<font color=#447700>!<a name='3675'></font>
<font color=#447700>!     diagflag = .false.<a name='3676'></font>
<font color=#447700>!     CALL WRFU_ALARMGET(grid%alarms( HISTORY_ALARM ),prevringtime=temp_time,RingInterval=intervaltime)<a name='3677'></font>
<font color=#447700>!     CALL WRFU_ALARMGET(grid%alarms( RESTART_ALARM ),prevringtime=restart_time,RingInterval=restartinterval)<a name='3678'></font>
<font color=#447700>!     CALL domain_clock_get ( grid, current_time=CurrTime )<a name='3679'></font>
<font color=#447700>!     old_dt=min(old_dt,grid%dt)<a name='3680'></font>
<font color=#447700>!     num = INT(old_dt * precision)<a name='3681'></font>
<font color=#447700>!     den = precision<a name='3682'></font>
<font color=#447700>!     CALL WRFU_TimeIntervalSet(dtInterval, Sn=num, Sd=den)<a name='3683'></font>
<font color=#447700>!     IF (CurrTime .ge. temp_time + intervaltime - dtInterval .or. &amp;<a name='3684'></font>
<font color=#447700>!         CurrTime .ge. restart_time + restartinterval - dtInterval ) THEN<a name='3685'></font>
<font color=#447700>!       diagflag = .true.<a name='3686'></font>
<font color=#447700>!     ENDIF<a name='3687'></font>
<font color=#447700>!     WRITE(wrf_err_message,*)'diag_flag=',diag_flag<a name='3688'></font>
<font color=#447700>!     CALL wrf_debug ( 0 , wrf_err_message )<a name='3689'></font>
#ifdef DM_PARALLEL<a name='3690'>
#      include "<A href='../../html_code/include/HALO_EM_SBM.inc.html'>HALO_EM_SBM.inc</A>"<A NAME="HALO_EM_SBM.inc_82"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3691'>
#endif<a name='3692'>
<a name='3693'>
<a name='3694'>
     CALL <A href='../../html_code/phys/module_microphysics_driver.F.html#MICROPHYSICS_DRIVER'>microphysics_driver</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_DRIVER_1">(                                            &amp;<a name='3695'>
      &amp;         DT=dtm             ,DX=grid%dx              ,DY=grid%dy   &amp;<a name='3696'>
      &amp;        ,DZ8W=dz8w          ,F_ICE_PHY=grid%f_ice_phy              &amp;<a name='3697'>
      &amp;        ,ITIMESTEP=grid%itimestep                    ,LOWLYR=grid%lowlyr  &amp;<a name='3698'>
      &amp;        ,P8W=p8w            ,P=p_phy            ,PI_PHY=pi_phy     &amp;<a name='3699'>
      &amp;        ,RHO=grid%rho       ,SPEC_ZONE=grid%spec_zone              &amp;<a name='3700'>
      &amp;        ,SR=grid%sr              ,TH=th_phy                        &amp;<a name='3701'>
      &amp;        ,refl_10cm=grid%refl_10cm                                  &amp; <font color=#447700>! hm, 9/22/09 for refl<a name='3702'></font>
      &amp;        ,vmi3d=grid%vmi3d                                          &amp; <font color=#447700>! for P3<a name='3703'></font>
      &amp;        ,di3d=grid%di3d                                            &amp; <font color=#447700>! for P3<a name='3704'></font>
      &amp;        ,rhopo3d=grid%rhopo3d                                      &amp; <font color=#447700>! for P3<a name='3705'></font>
      &amp;        ,WARM_RAIN=grid%warm_rain                                  &amp;<a name='3706'>
      &amp;        ,T8W=t8w                                                   &amp;<a name='3707'>
      &amp;        ,CLDFRA=grid%cldfra, EXCH_H=grid%exch_h &amp;<a name='3708'>
      &amp;        ,NSOURCE=grid%qndropsource                                 &amp;<a name='3709'>
#if (WRF_CHEM == 1)<a name='3710'>
      &amp;        ,QLSINK=grid%qlsink,CLDFRA_OLD=grid%cldfra_old             &amp;<a name='3711'>
      &amp;        ,PRECR=grid%precr, PRECI=grid%preci, PRECS=grid%precs, PRECG=grid%precg &amp;<a name='3712'>
      &amp;        ,CHEM_OPT=config_flags%chem_opt, PROGN=config_flags%progn  &amp;<a name='3713'>
<font color=#447700>!======================<a name='3714'></font>
      <font color=#447700>! Variables required for CAMMGMP Scheme when run with WRF_CHEM<a name='3715'></font>
      &amp;        ,CHEM=chem                                                 &amp;<a name='3716'>
      &amp;        ,QME3D=grid%qme3d,PRAIN3D=grid%prain3d                     &amp;<a name='3717'>
      &amp;        ,NEVAPR3D=grid%nevapr3d                                    &amp;<a name='3718'>
      &amp;        ,RATE1ORD_CW2PR_ST3D=grid%rate1ord_cw2pr_st3d              &amp;<a name='3719'>
      &amp;        ,DGNUM4D=grid%dgnum4d,DGNUMWET4D=grid%dgnumwet4d           &amp;<a name='3720'>
<font color=#447700>!======================<a name='3721'></font>
#endif<a name='3722'>
      &amp;        ,XLAND=grid%xland,SNOWH=grid%SNOW                           &amp;  <font color=#447700>!PMA<a name='3723'></font>
      &amp;        ,SPECIFIED=specified_bdy, CHANNEL_SWITCH=channel_bdy       &amp;<a name='3724'>
      &amp;        ,F_RAIN_PHY=grid%f_rain_phy                                &amp;<a name='3725'>
      &amp;        ,F_RIMEF_PHY=grid%f_rimef_phy                              &amp;<a name='3726'>
      &amp;        ,MP_PHYSICS=config_flags%mp_physics                        &amp;<a name='3727'>
      &amp;        ,ID=grid%id                                                &amp;<a name='3728'>
      &amp;        ,IDS=ids,IDE=ide, JDS=jds,JDE=jde, KDS=kds,KDE=kde         &amp;<a name='3729'>
      &amp;        ,IMS=ims,IME=ime, JMS=jms,JME=jme, KMS=kms,KME=kme         &amp;<a name='3730'>
      &amp;        ,IPS=ips,IPE=ipe, JPS=jps,JPE=jpe, KPS=kps,KPE=kpe         &amp;<a name='3731'>
      &amp;        ,I_START=grid%i_start,I_END=min(grid%i_end, ide-1)         &amp;<a name='3732'>
      &amp;        ,J_START=grid%j_start,J_END=min(grid%j_end, jde-1)         &amp;<a name='3733'>
      &amp;        ,KTS=k_start, KTE=min(k_end,kde-1)                         &amp;<a name='3734'>
      &amp;        ,NUM_TILES=grid%num_tiles                                  &amp;<a name='3735'>
      &amp;        ,NAER=grid%naer                                            &amp;<a name='3736'>
<font color=#447700>!======================<a name='3737'></font>
      <font color=#447700>! Variables required for CAMMGMP Scheme<a name='3738'></font>
      &amp;        ,DLF=grid%dlf,DLF2=grid%dlf2,T_PHY=grid%t_phy,P_HYD=grid%p_hyd  &amp;<a name='3739'>
      &amp;        ,P8W_HYD=grid%p_hyd_w,TKE_PBL=grid%tke_pbl                 &amp;<a name='3740'>
      &amp;        ,Z_AT_W=grid%z_at_w,QFX=grid%qfx,RLIQ=grid%rliq            &amp;<a name='3741'>
      &amp;        ,TURBTYPE3D=grid%turbtype3d,SMAW3D=grid%smaw3d             &amp;<a name='3742'>
      &amp;        ,WSEDL3D=grid%wsedl3d,CLDFRA_OLD_MP=grid%cldfra_old_mp     &amp;<a name='3743'>
      &amp;        ,CLDFRA_MP=grid%cldfra_mp,CLDFRA_MP_ALL=grid%cldfra_mp_ALL &amp;<a name='3744'>
      &amp;        ,LRADIUS=grid%LRADIUS, IRADIUS=grid%IRADIUS                &amp; <font color=#447700>!BSINGH(01/20/2014): Added for RRTMG&lt;-&gt;CAMMGMP<a name='3745'></font>
      &amp;        ,CLDFRAI=grid%cldfrai                                      &amp;<a name='3746'>
      &amp;        ,CLDFRAL=grid%cldfral,CLDFRA_CONV=grid%CLDFRA_CONV         &amp;<a name='3747'>
      &amp;        ,ALT=grid%alt                                              &amp;<a name='3748'>
      &amp;        ,ACCUM_MODE=config_flags%accum_mode                        &amp;<a name='3749'>
      &amp;        ,AITKEN_MODE=config_flags%aitken_mode                      &amp;<a name='3750'>
      &amp;        ,COARSE_MODE=config_flags%coarse_mode                      &amp;<a name='3751'>
      &amp;        ,ICWMRSH3D=grid%icwmrsh,ICWMRDP3D=grid%icwmrdp3d           &amp;<a name='3752'>
      &amp;        ,SHFRC3D=grid%shfrc3d,CMFMC3D=grid%cmfmc                   &amp;<a name='3753'>
      &amp;        ,CMFMC2_3D=grid%cmfmc2,CONFIG_FLAGS=config_flags           &amp;<a name='3754'>
      &amp;        ,FNM=grid%fnm,FNP=grid%fnp,RH_OLD_MP=grid%rh_old_mp        &amp;<a name='3755'>
      &amp;        ,LCD_OLD_MP=grid%lcd_old_mp                                &amp;<a name='3756'>
<font color=#447700>!======================<a name='3757'></font>
                 <font color=#447700>! Optional<a name='3758'></font>
      &amp;        , RAINNC=grid%rainnc, RAINNCV=grid%rainncv                 &amp;<a name='3759'>
      &amp;        , SNOWNC=grid%snownc, SNOWNCV=grid%snowncv                 &amp;<a name='3760'>
      &amp;        , GRAUPELNC=grid%graupelnc, GRAUPELNCV=grid%graupelncv     &amp; <font color=#447700>! for milbrandt2mom<a name='3761'></font>
      &amp;        , HAILNC=grid%hailnc, HAILNCV=grid%hailncv                 &amp;<a name='3762'>
      &amp;        , W=grid%w_2, Z=grid%z, HT=grid%ht                         &amp;<a name='3763'>
      &amp;        , MP_RESTART_STATE=grid%mp_restart_state                   &amp;<a name='3764'>
      &amp;        , TBPVS_STATE=grid%tbpvs_state                             &amp; <font color=#447700>! etampnew<a name='3765'></font>
      &amp;        , TBPVS0_STATE=grid%tbpvs0_state                           &amp; <font color=#447700>! etampnew<a name='3766'></font>
      &amp;        , QV_CURR=moist(ims,kms,jms,P_QV), F_QV=F_QV               &amp;<a name='3767'>
      &amp;        , QC_CURR=moist(ims,kms,jms,P_QC), F_QC=F_QC               &amp;<a name='3768'>
      &amp;        , QR_CURR=moist(ims,kms,jms,P_QR), F_QR=F_QR               &amp;<a name='3769'>
      &amp;        , QI_CURR=moist(ims,kms,jms,P_QI), F_QI=F_QI               &amp;<a name='3770'>
      &amp;        , QS_CURR=moist(ims,kms,jms,P_QS), F_QS=F_QS               &amp;<a name='3771'>
      &amp;        , QG_CURR=moist(ims,kms,jms,P_QG), F_QG=F_QG               &amp;<a name='3772'>
      &amp;        , QH_CURR=moist(ims,kms,jms,P_QH), F_QH=F_QH               &amp; <font color=#447700>! for milbrandt2mom<a name='3773'></font>
      &amp;        , QIC_CURR=moist(ims,kms,jms,P_QIC), F_QIC=F_QIC               &amp;<a name='3774'>
      &amp;        , QIP_CURR=moist(ims,kms,jms,P_QIP), F_QIP=F_QIP               &amp;<a name='3775'>
      &amp;        , QID_CURR=moist(ims,kms,jms,P_QID), F_QID=F_QID               &amp;<a name='3776'>
      &amp;        , QNDROP_CURR=scalar(ims,kms,jms,P_QNDROP), F_QNDROP=F_QNDROP &amp;<a name='3777'>
#if (WRF_CHEM == 1)<a name='3778'>
      &amp;        , RAINPROD=grid%rainprod, EVAPPROD=grid%evapprod           &amp;<a name='3779'>
      &amp;        , QV_B4MP=grid%qv_b4mp,QC_B4MP=grid%qc_b4mp                &amp;<a name='3780'>
      &amp;        , QI_B4MP=grid%qi_b4mp, QS_B4MP=grid%qs_b4mp               &amp;<a name='3781'>
#endif<a name='3782'>
      &amp;        , QT_CURR=scalar(ims,kms,jms,P_QT), F_QT=F_QT              &amp;<a name='3783'>
      &amp;        , QNN_CURR=scalar(ims,kms,jms,P_QNN), F_QNN=F_QNN          &amp;<a name='3784'>
      &amp;        , QNI_CURR=scalar(ims,kms,jms,P_QNI), F_QNI=F_QNI          &amp;<a name='3785'>
      &amp;        , QNC_CURR=scalar(ims,kms,jms,P_QNC), F_QNC=F_QNC          &amp;<a name='3786'>
      &amp;        , QNR_CURR=scalar(ims,kms,jms,P_QNR), F_QNR=F_QNR          &amp;<a name='3787'>
      &amp;        , QNS_CURR=scalar(ims,kms,jms,P_QNS), F_QNS=F_QNS          &amp;<a name='3788'>
      &amp;        , QNG_CURR=scalar(ims,kms,jms,P_QNG), F_QNG=F_QNG          &amp;<a name='3789'>
      &amp;        , QNWFA_CURR=scalar(ims,kms,jms,P_QNWFA), F_QNWFA=F_QNWFA  &amp; <font color=#447700>! for Thompson water-friendly aerosol<a name='3790'></font>
      &amp;        , QNIFA_CURR=scalar(ims,kms,jms,P_QNIFA), F_QNIFA=F_QNIFA  &amp; <font color=#447700>! for Thompson ice-friendly aerosol<a name='3791'></font>
      &amp;        , QNH_CURR=scalar(ims,kms,jms,P_QNH), F_QNH=F_QNH          &amp; <font color=#447700>! for milbrandt2mom and nssl_2mom<a name='3792'></font>
      &amp;        , QNIC_CURR=scalar(ims,kms,jms,P_QNIC), F_QNIC=F_QNIC          &amp;<a name='3793'>
      &amp;        , QNIP_CURR=scalar(ims,kms,jms,P_QNIP), F_QNIP=F_QNIP          &amp;<a name='3794'>
      &amp;        , QNID_CURR=scalar(ims,kms,jms,P_QNID), F_QNID=F_QNID          &amp;<a name='3795'>
      &amp;        , QIR_CURR=scalar(ims,kms,jms,P_QIR), F_QIR=F_QIR          &amp; <font color=#447700>! for P3<a name='3796'></font>
      &amp;        , QIB_CURR=scalar(ims,kms,jms,P_QIB), F_QIB=F_QIB          &amp; <font color=#447700>! for P3<a name='3797'></font>
<font color=#447700>!       &amp;        , QZR_CURR=scalar(ims,kms,jms,P_QZR), F_QZR=F_QZR          &amp; ! for milbrandt3mom<a name='3798'></font>
<font color=#447700>!       &amp;        , QZI_CURR=scalar(ims,kms,jms,P_QZI), F_QZI=F_QZI          &amp; ! "<a name='3799'></font>
<font color=#447700>!       &amp;        , QZS_CURR=scalar(ims,kms,jms,P_QZS), F_QZS=F_QZS          &amp; ! "<a name='3800'></font>
<font color=#447700>!       &amp;        , QZG_CURR=scalar(ims,kms,jms,P_QZG), F_QZG=F_QZG          &amp; ! "<a name='3801'></font>
<font color=#447700>!       &amp;        , QZH_CURR=scalar(ims,kms,jms,P_QZH), F_QZH=F_QZH          &amp; ! "<a name='3802'></font>
      &amp;        , QVOLG_CURR=scalar(ims,kms,jms,P_QVOLG), F_QVOLG=F_QVOLG    &amp; <font color=#447700>! for nssl_2mom<a name='3803'></font>
      &amp;        , QVOLH_CURR=scalar(ims,kms,jms,P_QVOLH), F_QVOLH=F_QVOLH    &amp; <font color=#447700>! for nssl_2mom<a name='3804'></font>
      &amp;        , cu_used=config_flags%cu_used                             &amp;<a name='3805'>
      &amp;        , qrcuten=grid%rqrcuten, qscuten=grid%rqscuten             &amp;<a name='3806'>
      &amp;        , qicuten=grid%rqicuten, qccuten=grid%rqccuten             &amp;<a name='3807'>
      &amp;        , HAIL=config_flags%gsfcgce_hail                           &amp; <font color=#447700>! for gsfcgce<a name='3808'></font>
      &amp;        , ICE2=config_flags%gsfcgce_2ice                           &amp; <font color=#447700>! for gsfcgce<a name='3809'></font>
<font color=#447700>!     &amp;        , ccntype=config_flags%milbrandt_ccntype                   &amp; ! for milbrandt (2mom)<a name='3810'></font>
<font color=#447700>! YLIN<a name='3811'></font>
<font color=#447700>! RI_CURR INPUT<a name='3812'></font>
      &amp;        , RI_CURR=grid%rimi                                          &amp;<a name='3813'>
      &amp;        , re_cloud=grid%re_cloud, re_ice=grid%re_ice, re_snow=grid%re_snow &amp; <font color=#447700>! G. Thompson<a name='3814'></font>
      &amp;        , has_reqc=grid%has_reqc, has_reqi=grid%has_reqi, has_reqs=grid%has_reqs &amp; <font color=#447700>! G. Thompson<a name='3815'></font>
      &amp;        , qnwfa2d=grid%qnwfa2d                                                   &amp; <font color=#447700>! G. Thompson<a name='3816'></font>
      &amp;        , diagflag=diag_flag, do_radar_ref=config_flags%do_radar_ref &amp;<a name='3817'>
      &amp;        ,u=grid%u_phy,v=grid%v_phy &amp;<a name='3818'>
      &amp;        ,scalar=scalar,num_scalar=num_scalar                             &amp;<a name='3819'>
      &amp;        ,TH_OLD=grid%th_old                                        &amp;<a name='3820'>
      &amp;        ,QV_OLD=grid%qv_old                                        &amp;<a name='3821'>
      &amp;        ,xlat=grid%xlat,xlong=grid%xlong,IVGTYP=grid%ivgtyp  &amp;<a name='3822'>
      &amp;        , EFFR_CURR=scalar(ims,kms,jms,P_EFFR), F_EFFR=F_EFFR          &amp; <font color=#447700>! for SBM<a name='3823'></font>
      &amp;        , ICE_EFFR_CURR=scalar(ims,kms,jms,P_ICE_EFFR), F_ICE_EFFR=F_ICE_EFFR          &amp; <font color=#447700>! for SBM<a name='3824'></font>
      &amp;        , TOT_EFFR_CURR=scalar(ims,kms,jms,P_TOT_EFFR), F_TOT_EFFR=F_TOT_EFFR          &amp; <font color=#447700>! for SBM<a name='3825'></font>
      &amp;        , QIC_EFFR_CURR=scalar(ims,kms,jms,P_QIC_EFFR), F_QIC_EFFR=F_QIC_EFFR          &amp; <font color=#447700>! for SBM<a name='3826'></font>
      &amp;        , QIP_EFFR_CURR=scalar(ims,kms,jms,P_QIP_EFFR), F_QIP_EFFR=F_QIP_EFFR          &amp; <font color=#447700>! for SBM<a name='3827'></font>
      &amp;        , QID_EFFR_CURR=scalar(ims,kms,jms,P_QID_EFFR), F_QID_EFFR=F_QID_EFFR          &amp; <font color=#447700>! for SBM<a name='3828'></font>
      &amp;        ,kext_ql=grid%kext_ql                                       &amp;<a name='3829'>
      &amp;        ,kext_qs=grid%kext_qs                                       &amp;<a name='3830'>
      &amp;        ,kext_qg=grid%kext_qg                                       &amp;<a name='3831'>
      &amp;        ,kext_qh=grid%kext_qh                                       &amp;<a name='3832'>
      &amp;        ,kext_qa=grid%kext_qa                                       &amp;<a name='3833'>
      &amp;        ,kext_qic=grid%kext_qic                                       &amp;<a name='3834'>
      &amp;        ,kext_qip=grid%kext_qip                                       &amp;<a name='3835'>
      &amp;        ,kext_qid=grid%kext_qid                                       &amp;<a name='3836'>
      &amp;        ,kext_ft_qic=grid%kext_ft_qic                                       &amp;<a name='3837'>
      &amp;        ,kext_ft_qip=grid%kext_ft_qip                                       &amp;<a name='3838'>
      &amp;        ,kext_ft_qid=grid%kext_ft_qid                                       &amp;<a name='3839'>
      &amp;        ,kext_ft_qs=grid%kext_ft_qs                                       &amp;<a name='3840'>
      &amp;        ,kext_ft_qg=grid%kext_ft_qg         &amp;<a name='3841'>
      &amp;        ,height=grid%height                                         &amp;<a name='3842'>
      &amp;        ,tempc=grid%tempc                                         &amp;<a name='3843'>
      &amp;        ,ccn_conc=grid%ccn_conc                                   &amp; <font color=#447700>! RAS<a name='3844'></font>
<a name='3845'>
                                                                          )<a name='3846'>
BENCH_END(micro_driver_tim)<a name='3847'>
<a name='3848'>
#if 0<a name='3849'>
BENCH_START(microswap_2)<a name='3850'>
<font color=#447700>! for load balancing; communication to redistribute the points<a name='3851'></font>
      IF ( config_flags%mp_physics .EQ. ETAMPNEW .OR. &amp;<a name='3852'>
     &amp;     config_flags%mp_physics .EQ. FER_MP_HIRES) THEN<a name='3853'>
#include "<A href='../../html_code/include/SWAP_ETAMP_NEW.inc.html'>SWAP_ETAMP_NEW.inc</A>"<A NAME="SWAP_ETAMP_NEW.inc_83"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3854'>
     ELSE IF ( config_flags%mp_physics .EQ. WSM3SCHEME ) THEN<a name='3855'>
#include "<A href='../../html_code/include/SWAP_WSM3.inc.html'>SWAP_WSM3.inc</A>"<A NAME="SWAP_WSM3.inc_84"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='3856'>
     ENDIF<a name='3857'>
BENCH_END(microswap_2)<a name='3858'>
#endif<a name='3859'>
<a name='3860'>
     CALL wrf_debug ( 200 , ' call moist_physics_finish' )<a name='3861'>
BENCH_START(moist_phys_end_tim)<a name='3862'>
<a name='3863'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='3864'></font>
     <font color=#447700>!$OMP PRIVATE ( ij, its, ite, jts, jte, im, ii, jj, kk )<a name='3865'></font>
<a name='3866'>
     DO ij = 1 , grid%num_tiles<a name='3867'>
<a name='3868'>
       its = max(grid%i_start(ij),ids)<a name='3869'>
       ite = min(grid%i_end(ij),ide-1)<a name='3870'>
       jts = max(grid%j_start(ij),jds)<a name='3871'>
       jte = min(grid%j_end(ij),jde-1)<a name='3872'>
<a name='3873'>
       CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTB'>microphysics_zero_outb</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTB_1"> (                                    &amp;<a name='3874'>
                      moist , num_moist , config_flags ,                &amp;<a name='3875'>
                      ids, ide, jds, jde, kds, kde,                     &amp;<a name='3876'>
                      ims, ime, jms, jme, kms, kme,                     &amp;<a name='3877'>
                      its, ite, jts, jte,                               &amp;<a name='3878'>
                      k_start    , k_end                                )<a name='3879'>
<a name='3880'>
       CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTB'>microphysics_zero_outb</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTB_2"> (                                    &amp;<a name='3881'>
                      scalar , num_scalar , config_flags ,              &amp;<a name='3882'>
                      ids, ide, jds, jde, kds, kde,                     &amp;<a name='3883'>
                      ims, ime, jms, jme, kms, kme,                     &amp;<a name='3884'>
                      its, ite, jts, jte,                               &amp;<a name='3885'>
                      k_start    , k_end                                )<a name='3886'>
<a name='3887'>
       CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTB'>microphysics_zero_outb</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTB_3"> (                                    &amp;<a name='3888'>
                      chem , num_chem , config_flags ,              &amp;<a name='3889'>
                      ids, ide, jds, jde, kds, kde,                     &amp;<a name='3890'>
                      ims, ime, jms, jme, kms, kme,                     &amp;<a name='3891'>
                      its, ite, jts, jte,                               &amp;<a name='3892'>
                      k_start    , k_end                                )<a name='3893'>
       CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTB'>microphysics_zero_outb</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTB_4"> (                                    &amp;<a name='3894'>
                      tracer , num_tracer , config_flags ,              &amp;<a name='3895'>
                      ids, ide, jds, jde, kds, kde,                     &amp;<a name='3896'>
                      ims, ime, jms, jme, kms, kme,                     &amp;<a name='3897'>
                      its, ite, jts, jte,                               &amp;<a name='3898'>
                      k_start    , k_end                                )<a name='3899'>
<a name='3900'>
       IF ( config_flags%periodic_x ) THEN<a name='3901'>
         its = max(grid%i_start(ij),ids)<a name='3902'>
         ite = min(grid%i_end(ij),ide-1)<a name='3903'>
       ELSE<a name='3904'>
         its = max(grid%i_start(ij),ids+sz)<a name='3905'>
         ite = min(grid%i_end(ij),ide-1-sz)<a name='3906'>
       ENDIF<a name='3907'>
       jts = max(grid%j_start(ij),jds+sz)<a name='3908'>
       jte = min(grid%j_end(ij),jde-1-sz)<a name='3909'>
<a name='3910'>
       CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTA'>microphysics_zero_outa</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTA_1"> (                                    &amp;<a name='3911'>
                      moist , num_moist , config_flags ,                &amp;<a name='3912'>
                      ids, ide, jds, jde, kds, kde,                     &amp;<a name='3913'>
                      ims, ime, jms, jme, kms, kme,                     &amp;<a name='3914'>
                      its, ite, jts, jte,                               &amp;<a name='3915'>
                      k_start    , k_end                                )<a name='3916'>
<a name='3917'>
       CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTA'>microphysics_zero_outa</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTA_2"> (                                    &amp;<a name='3918'>
                      scalar , num_scalar , config_flags ,              &amp;<a name='3919'>
                      ids, ide, jds, jde, kds, kde,                     &amp;<a name='3920'>
                      ims, ime, jms, jme, kms, kme,                     &amp;<a name='3921'>
                      its, ite, jts, jte,                               &amp;<a name='3922'>
                      k_start    , k_end                                )<a name='3923'>
<a name='3924'>
       CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTA'>microphysics_zero_outa</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTA_3"> (                                    &amp;<a name='3925'>
                      chem , num_chem , config_flags ,                  &amp;<a name='3926'>
                      ids, ide, jds, jde, kds, kde,                     &amp;<a name='3927'>
                      ims, ime, jms, jme, kms, kme,                     &amp;<a name='3928'>
                      its, ite, jts, jte,                               &amp;<a name='3929'>
                      k_start    , k_end                                )<a name='3930'>
<a name='3931'>
       CALL <A href='../../html_code/phys/module_microphysics_zero_out.F.html#MICROPHYSICS_ZERO_OUTA'>microphysics_zero_outa</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MICROPHYSICS_ZERO_OUTA_4"> (                                    &amp;<a name='3932'>
                      tracer , num_tracer , config_flags ,              &amp;<a name='3933'>
                      ids, ide, jds, jde, kds, kde,                     &amp;<a name='3934'>
                      ims, ime, jms, jme, kms, kme,                     &amp;<a name='3935'>
                      its, ite, jts, jte,                               &amp;<a name='3936'>
                      k_start    , k_end                                )<a name='3937'>
<a name='3938'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#MOIST_PHYSICS_FINISH_EM'>moist_physics_finish_em</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MOIST_PHYSICS_FINISH_EM_1">( grid%t_2, grid%t_1, t0, grid%muts, th_phy,       &amp;<a name='3939'>
                                      grid%h_diabatic, dtm,                    &amp;<a name='3940'>
                                      moist(ims,kms,jms,P_QV),grid%qv_diabatic, &amp;<a name='3941'>
                                      moist(ims,kms,jms,P_QC),grid%qc_diabatic, &amp;<a name='3942'>
                                      config_flags,                            &amp;<a name='3943'>
#if ( WRF_DFI_RADAR == 1 )<a name='3944'>
                                      grid%dfi_tten_rad,grid%dfi_stage,        &amp;<a name='3945'>
#endif<a name='3946'>
                                      ids, ide, jds, jde, kds, kde,     &amp;<a name='3947'>
                                      ims, ime, jms, jme, kms, kme,     &amp;<a name='3948'>
                                      its, ite, jts, jte,               &amp;<a name='3949'>
                                      k_start    , k_end               )<a name='3950'>
<a name='3951'>
     END DO<a name='3952'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='3953'></font>
<a name='3954'>
   ENDIF  <font color=#447700>! microphysics test<a name='3955'></font>
<a name='3956'>
<font color=#447700>!-----------------------------------------------------------<a name='3957'></font>
<font color=#447700>!  filter for moist variables post-microphysics and end of timestep<a name='3958'></font>
<font color=#447700>!-----------------------------------------------------------<a name='3959'></font>
<a name='3960'>
   IF (config_flags%polar) THEN<a name='3961'>
     IF ( num_3d_m &gt;= PARAM_FIRST_SCALAR ) THEN<a name='3962'>
       CALL wrf_debug ( 200 , ' call filter moist' )<a name='3963'>
       DO im = PARAM_FIRST_SCALAR, num_3d_m<a name='3964'>
         IF ( config_flags%coupled_filtering ) THEN<a name='3965'>
           CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER'>couple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_SCALARS_FOR_FILTER_5"> ( FIELD=moist(ims,kms,jms,im)        &amp;<a name='3966'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='3967'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='3968'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3969'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3970'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='3971'>
         END IF<a name='3972'>
 <a name='3973'>
         CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_9"> ( grid=grid                                                 &amp;<a name='3974'>
                  ,lineno=__LINE__                                             &amp;<a name='3975'>
                  ,flag_uv            = 0                                      &amp;<a name='3976'>
                  ,flag_rurv          = 0                                      &amp;<a name='3977'>
                  ,flag_wph           = 0                                      &amp;<a name='3978'>
                  ,flag_ww            = 0                                      &amp;<a name='3979'>
                  ,flag_t             = 0                                      &amp;<a name='3980'>
                  ,flag_mu            = 0                                      &amp;<a name='3981'>
                  ,flag_mut           = 0                                      &amp;<a name='3982'>
                  ,flag_moist         = im                                     &amp;<a name='3983'>
                  ,flag_chem          = 0                                      &amp;<a name='3984'>
                  ,flag_tracer        = 0                                      &amp;<a name='3985'>
                  ,flag_scalar        = 0                                      &amp;<a name='3986'>
                  ,actual_distance_average=config_flags%actual_distance_average&amp;<a name='3987'>
                  ,pos_def            = config_flags%pos_def                   &amp;<a name='3988'>
                  ,swap_pole_with_next_j = config_flags%swap_pole_with_next_j  &amp;<a name='3989'>
                  ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='3990'>
                  ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='3991'>
                  ,dclat = dclat                                               &amp;<a name='3992'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='3993'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='3994'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='3995'>
                  ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='3996'>
                  ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='3997'>
 <a name='3998'>
         IF ( config_flags%coupled_filtering ) THEN<a name='3999'>
           CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER'>uncouple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNCOUPLE_SCALARS_FOR_FILTER_5"> ( FIELD=moist(ims,kms,jms,im)      &amp;<a name='4000'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='4001'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='4002'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4003'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4004'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='4005'>
         END IF<a name='4006'>
       ENDDO<a name='4007'>
     ENDIF<a name='4008'>
   ENDIF<a name='4009'>
<a name='4010'>
<font color=#447700>!-----------------------------------------------------------<a name='4011'></font>
<font color=#447700>!  end filter for moist variables post-microphysics and end of timestep<a name='4012'></font>
<font color=#447700>!-----------------------------------------------------------<a name='4013'></font>
<a name='4014'>
<a name='4015'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='4016'></font>
   <font color=#447700>!$OMP PRIVATE ( ij, its, ite, jts, jte, im, ii, jj, kk )<a name='4017'></font>
   scalar_tile_loop_1ba: DO ij = 1 , grid%num_tiles<a name='4018'>
<a name='4019'>
     IF ( config_flags%periodic_x ) THEN<a name='4020'>
       its = max(grid%i_start(ij),ids)<a name='4021'>
       ite = min(grid%i_end(ij),ide-1)<a name='4022'>
     ELSE<a name='4023'>
       its = max(grid%i_start(ij),ids+sz)<a name='4024'>
       ite = min(grid%i_end(ij),ide-1-sz)<a name='4025'>
     ENDIF<a name='4026'>
     jts = max(grid%j_start(ij),jds+sz)<a name='4027'>
     jte = min(grid%j_end(ij),jde-1-sz)<a name='4028'>
<a name='4029'>
     CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#CALC_P_RHO_PHI'>calc_p_rho_phi</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_P_RHO_PHI_2">( moist, num_3d_m, config_flags%hypsometric_opt,             &amp;<a name='4030'>
                          grid%al, grid%alb, grid%mu_2, grid%muts,              &amp;<a name='4031'>
                          grid%c1h, grid%c2h, grid%c3h, grid%c4h, grid%c3f, grid%c4f, &amp;<a name='4032'>
                          grid%ph_2, grid%phb, grid%p, grid%pb, grid%t_2,                 &amp;<a name='4033'>
                          p0, t0, grid%p_top, grid%znu, grid%znw, grid%dnw, grid%rdnw,           &amp;<a name='4034'>
                          grid%rdn, config_flags%non_hydrostatic,             &amp;<a name='4035'>
                          ids, ide, jds, jde, kds, kde,     &amp;<a name='4036'>
                          ims, ime, jms, jme, kms, kme,     &amp;<a name='4037'>
                          its, ite, jts, jte,               &amp;<a name='4038'>
                          k_start    , k_end               )<a name='4039'>
<a name='4040'>
   END DO scalar_tile_loop_1ba<a name='4041'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='4042'></font>
BENCH_END(moist_phys_end_tim)<a name='4043'>
<a name='4044'>
   IF (.not. config_flags%non_hydrostatic) THEN<a name='4045'>
#ifdef DM_PARALLEL<a name='4046'>
#    include "<A href='../../html_code/include/HALO_EM_HYDRO_UV.inc.html'>HALO_EM_HYDRO_UV.inc</A>"<A NAME="HALO_EM_HYDRO_UV.inc_85"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4047'>
#    include "<A href='../../html_code/include/PERIOD_EM_HYDRO_UV.inc.html'>PERIOD_EM_HYDRO_UV.inc</A>"<A NAME="PERIOD_EM_HYDRO_UV.inc_86"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4048'>
#endif<a name='4049'>
     <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='4050'></font>
     <font color=#447700>!$OMP PRIVATE ( ij )<a name='4051'></font>
     DO ij = 1 , grid%num_tiles<a name='4052'>
       CALL <A href='../../html_code/dyn_em/module_big_step_utilities_em.F.html#DIAGNOSE_W'>diagnose_w</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DIAGNOSE_W_2">( ph_tend, grid%ph_2, grid%ph_1, grid%w_2, grid%muts, &amp;<a name='4053'>
                       grid%c1f, grid%c2f, dt_rk,              &amp;<a name='4054'>
                       grid%u_2, grid%v_2, grid%ht,            &amp;<a name='4055'>
                       grid%cf1, grid%cf2, grid%cf3, grid%rdx, grid%rdy, grid%msftx, grid%msfty, &amp;<a name='4056'>
                       ids, ide, jds, jde, kds, kde,           &amp;<a name='4057'>
                       ims, ime, jms, jme, kms, kme,           &amp;<a name='4058'>
                       grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4059'>
                       grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4060'>
                       k_start    , k_end                     )<a name='4061'>
<a name='4062'>
     END DO<a name='4063'>
     <font color=#447700>!$OMP END PARALLEL DO<a name='4064'></font>
<a name='4065'>
   END IF<a name='4066'>
<a name='4067'>
   CALL wrf_debug ( 200 , ' call chem polar filter ' )<a name='4068'>
<a name='4069'>
<font color=#447700>!-----------------------------------------------------------<a name='4070'></font>
<font color=#447700>!  filter for chem and scalar variables at end of timestep<a name='4071'></font>
<font color=#447700>!-----------------------------------------------------------<a name='4072'></font>
<a name='4073'>
   IF (config_flags%polar) THEN<a name='4074'>
<a name='4075'>
     IF ( num_3d_c &gt;= PARAM_FIRST_SCALAR ) then<a name='4076'>
       chem_filter_loop: DO im = PARAM_FIRST_SCALAR, num_3d_c<a name='4077'>
         IF ( config_flags%coupled_filtering ) THEN<a name='4078'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER'>couple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_SCALARS_FOR_FILTER_6"> ( FIELD=chem(ims,kms,jms,im)               &amp;<a name='4079'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='4080'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='4081'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4082'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4083'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe           )<a name='4084'>
         END IF<a name='4085'>
<a name='4086'>
         CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_10"> ( grid=grid                                                 &amp;<a name='4087'>
                  ,lineno=__LINE__                                             &amp;<a name='4088'>
                  ,flag_uv            = 0                                      &amp;<a name='4089'>
                  ,flag_rurv          = 0                                      &amp;<a name='4090'>
                  ,flag_wph           = 0                                      &amp;<a name='4091'>
                  ,flag_ww            = 0                                      &amp;<a name='4092'>
                  ,flag_t             = 0                                      &amp;<a name='4093'>
                  ,flag_mu            = 0                                      &amp;<a name='4094'>
                  ,flag_mut           = 0                                      &amp;<a name='4095'>
                  ,flag_moist         = 0                                      &amp;<a name='4096'>
                  ,flag_chem          = im                                     &amp;<a name='4097'>
                  ,flag_tracer        = 0                                      &amp;<a name='4098'>
                  ,flag_scalar        = 0                                      &amp;<a name='4099'>
                  ,actual_distance_average=config_flags%actual_distance_average&amp;<a name='4100'>
                  ,pos_def            = config_flags%pos_def                   &amp;<a name='4101'>
                  ,swap_pole_with_next_j = config_flags%swap_pole_with_next_j  &amp;<a name='4102'>
                  ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='4103'>
                  ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='4104'>
                  ,dclat = dclat                                               &amp;<a name='4105'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4106'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4107'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='4108'>
                  ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='4109'>
                  ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='4110'>
<a name='4111'>
         IF ( config_flags%coupled_filtering ) THEN<a name='4112'>
             CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER'>uncouple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNCOUPLE_SCALARS_FOR_FILTER_6"> ( FIELD=chem(ims,kms,jms,im)       &amp;<a name='4113'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='4114'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='4115'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4116'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4117'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='4118'>
         END IF<a name='4119'>
       ENDDO chem_filter_loop<a name='4120'>
     ENDIF<a name='4121'>
     IF ( num_tracer &gt;= PARAM_FIRST_SCALAR ) then<a name='4122'>
       tracer_filter_loop: DO im = PARAM_FIRST_SCALAR, num_tracer<a name='4123'>
         IF ( config_flags%coupled_filtering ) THEN<a name='4124'>
           CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER'>couple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_SCALARS_FOR_FILTER_7"> ( FIELD=tracer(ims,kms,jms,im)         &amp;<a name='4125'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='4126'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='4127'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4128'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4129'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe           )<a name='4130'>
         END IF<a name='4131'>
<a name='4132'>
         CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_11"> ( grid=grid                                                 &amp;<a name='4133'>
                  ,lineno=__LINE__                                             &amp;<a name='4134'>
                  ,flag_uv            = 0                                      &amp;<a name='4135'>
                  ,flag_rurv          = 0                                      &amp;<a name='4136'>
                  ,flag_wph           = 0                                      &amp;<a name='4137'>
                  ,flag_ww            = 0                                      &amp;<a name='4138'>
                  ,flag_t             = 0                                      &amp;<a name='4139'>
                  ,flag_mu            = 0                                      &amp;<a name='4140'>
                  ,flag_mut           = 0                                      &amp;<a name='4141'>
                  ,flag_moist         = 0                                      &amp;<a name='4142'>
                  ,flag_chem          = 0                                      &amp;<a name='4143'>
                  ,flag_tracer        = im                                     &amp;<a name='4144'>
                  ,flag_scalar        = 0                                      &amp;<a name='4145'>
                  ,actual_distance_average=config_flags%actual_distance_average&amp;<a name='4146'>
                  ,pos_def            = config_flags%pos_def                   &amp;<a name='4147'>
                  ,swap_pole_with_next_j = config_flags%swap_pole_with_next_j  &amp;<a name='4148'>
                  ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='4149'>
                  ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='4150'>
                  ,dclat = dclat                                               &amp;<a name='4151'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4152'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4153'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='4154'>
                  ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='4155'>
                  ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='4156'>
<a name='4157'>
         IF ( config_flags%coupled_filtering ) THEN<a name='4158'>
           CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER'>uncouple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNCOUPLE_SCALARS_FOR_FILTER_7"> ( FIELD=tracer(ims,kms,jms,im)       &amp;<a name='4159'>
                    ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='4160'>
                    ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='4161'>
                    ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4162'>
                    ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4163'>
                    ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='4164'>
         END IF<a name='4165'>
       ENDDO tracer_filter_loop<a name='4166'>
     ENDIF<a name='4167'>
<a name='4168'>
     IF ( num_3d_s &gt;= PARAM_FIRST_SCALAR ) then<a name='4169'>
       scalar_filter_loop: DO im = PARAM_FIRST_SCALAR, num_3d_s<a name='4170'>
         IF ( config_flags%coupled_filtering ) THEN<a name='4171'>
           CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#COUPLE_SCALARS_FOR_FILTER'>couple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COUPLE_SCALARS_FOR_FILTER_8"> ( FIELD=scalar(ims,kms,jms,im)       &amp;<a name='4172'>
                  ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='4173'>
                  ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='4174'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4175'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4176'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='4177'>
         END IF<a name='4178'>
<a name='4179'>
         CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#PXFT'>pxft</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PXFT_12"> ( grid=grid                                                 &amp;<a name='4180'>
                  ,lineno=__LINE__                                             &amp;<a name='4181'>
                  ,flag_uv            = 0                                      &amp;<a name='4182'>
                  ,flag_rurv          = 0                                      &amp;<a name='4183'>
                  ,flag_wph           = 0                                      &amp;<a name='4184'>
                  ,flag_ww            = 0                                      &amp;<a name='4185'>
                  ,flag_t             = 0                                      &amp;<a name='4186'>
                  ,flag_mu            = 0                                      &amp;<a name='4187'>
                  ,flag_mut           = 0                                      &amp;<a name='4188'>
                  ,flag_moist         = 0                                      &amp;<a name='4189'>
                  ,flag_chem          = 0                                      &amp;<a name='4190'>
                  ,flag_tracer        = 0                                      &amp;<a name='4191'>
                  ,flag_scalar        = im                                     &amp;<a name='4192'>
                  ,actual_distance_average=config_flags%actual_distance_average&amp;<a name='4193'>
                  ,pos_def            = config_flags%pos_def                   &amp;<a name='4194'>
                  ,swap_pole_with_next_j = config_flags%swap_pole_with_next_j  &amp;<a name='4195'>
                  ,moist=moist,chem=chem,tracer=tracer,scalar=scalar           &amp;<a name='4196'>
                  ,fft_filter_lat = config_flags%fft_filter_lat                &amp;<a name='4197'>
                  ,dclat = dclat                                               &amp;<a name='4198'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4199'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4200'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe             &amp;<a name='4201'>
                  ,imsx=imsx,imex=imex,jmsx=jmsx,jmex=jmex,kmsx=kmsx,kmex=kmex &amp;<a name='4202'>
                  ,ipsx=ipsx,ipex=ipex,jpsx=jmsx,jpex=jpex,kpsx=kpsx,kpex=kpex )<a name='4203'>
<a name='4204'>
         IF ( config_flags%coupled_filtering ) THEN<a name='4205'>
           CALL <A href='../../html_code/dyn_em/module_polarfft.F.html#UNCOUPLE_SCALARS_FOR_FILTER'>uncouple_scalars_for_filter</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UNCOUPLE_SCALARS_FOR_FILTER_8"> ( FIELD=scalar(ims,kms,jms,im)     &amp;<a name='4206'>
                  ,MU=grid%mu_2 , MUB=grid%mub                                 &amp;<a name='4207'>
                  ,C1=grid%c1h , C2=grid%c2h                                   &amp;<a name='4208'>
                  ,ids=ids,ide=ide,jds=jds,jde=jde,kds=kds,kde=kde             &amp;<a name='4209'>
                  ,ims=ims,ime=ime,jms=jms,jme=jme,kms=kms,kme=kme             &amp;<a name='4210'>
                  ,ips=ips,ipe=ipe,jps=jps,jpe=jpe,kps=kps,kpe=kpe          )<a name='4211'>
         END IF<a name='4212'>
       ENDDO scalar_filter_loop<a name='4213'>
     ENDIF<a name='4214'>
   ENDIF<a name='4215'>
<a name='4216'>
<font color=#447700>!-----------------------------------------------------------<a name='4217'></font>
<font color=#447700>!  end filter for chem and scalar variables at end of timestep<a name='4218'></font>
<font color=#447700>!-----------------------------------------------------------<a name='4219'></font>
<a name='4220'>
   <font color=#447700>!  We're finished except for boundary condition (and patch) update<a name='4221'></font>
<a name='4222'>
   <font color=#447700>! Boundary condition time (or communication time).  At this time, we have<a name='4223'></font>
   <font color=#447700>! implemented periodic and symmetric physical boundary conditions.<a name='4224'></font>
<a name='4225'>
   <font color=#447700>! b.c. routine for data within patch.<a name='4226'></font>
<a name='4227'>
   <font color=#447700>! we need to do both time levels of <a name='4228'></font>
   <font color=#447700>! data because the time filter only works in the physical solution space.<a name='4229'></font>
<a name='4230'>
   <font color=#447700>! First, do patch communications for boundary conditions (periodicity)<a name='4231'></font>
<a name='4232'>
<font color=#447700>!-----------------------------------------------------------<a name='4233'></font>
<font color=#447700>!  Stencils for patch communications  (WCS, 29 June 2001)<a name='4234'></font>
<font color=#447700>!<a name='4235'></font>
<font color=#447700>!  here's where we need a wide comm stencil - these are the <a name='4236'></font>
<font color=#447700>!  uncoupled variables so are used for high order calc in<a name='4237'></font>
<font color=#447700>!  advection and mixong routines.<a name='4238'></font>
<font color=#447700>!<a name='4239'></font>
<font color=#447700>!                              * * * * *<a name='4240'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='4241'></font>
<font color=#447700>!          * + *      * + *    * * + * * <a name='4242'></font>
<font color=#447700>!            *        * * *    * * * * *<a name='4243'></font>
<font color=#447700>!                              * * * * *<a name='4244'></font>
<font color=#447700>!<a name='4245'></font>
<font color=#447700>!   grid%u_1                            x<a name='4246'></font>
<font color=#447700>!   grid%u_2                            x<a name='4247'></font>
<font color=#447700>!   grid%v_1                            x<a name='4248'></font>
<font color=#447700>!   grid%v_2                            x<a name='4249'></font>
<font color=#447700>!   grid%w_1                            x<a name='4250'></font>
<font color=#447700>!   grid%w_2                            x<a name='4251'></font>
<font color=#447700>!   grid%t_1                            x<a name='4252'></font>
<font color=#447700>!   grid%t_2                            x<a name='4253'></font>
<font color=#447700>!  grid%ph_1                            x<a name='4254'></font>
<font color=#447700>!  grid%ph_2                            x<a name='4255'></font>
<font color=#447700>!  grid%tke_1                           x<a name='4256'></font>
<font color=#447700>!  grid%tke_2                           x<a name='4257'></font>
<font color=#447700>!<a name='4258'></font>
<font color=#447700>!    2D variables<a name='4259'></font>
<font color=#447700>!  grid%mu_1     x<a name='4260'></font>
<font color=#447700>!  grid%mu_2     x<a name='4261'></font>
<font color=#447700>!<a name='4262'></font>
<font color=#447700>!    4D variables<a name='4263'></font>
<font color=#447700>!  moist                         x<a name='4264'></font>
<font color=#447700>!   chem                         x<a name='4265'></font>
<font color=#447700>! scalar                         x<a name='4266'></font>
<font color=#447700>!----------------------------------------------------------<a name='4267'></font>
<a name='4268'>
<a name='4269'>
#ifdef DM_PARALLEL<a name='4270'>
   IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='4271'>
#    include "<A href='../../html_code/include/HALO_EM_D3_3.inc.html'>HALO_EM_D3_3.inc</A>"<A NAME="HALO_EM_D3_3.inc_87"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4272'>
   ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='4273'>
#    include "<A href='../../html_code/include/HALO_EM_D3_5.inc.html'>HALO_EM_D3_5.inc</A>"<A NAME="HALO_EM_D3_5.inc_88"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4274'>
   ELSE <a name='4275'>
      WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='4276'>
      CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_64">(TRIM(wrf_err_message))<a name='4277'>
   ENDIF<a name='4278'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_D3.inc.html'>PERIOD_BDY_EM_D3.inc</A>"<A NAME="PERIOD_BDY_EM_D3.inc_89"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4279'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_MOIST.inc.html'>PERIOD_BDY_EM_MOIST.inc</A>"<A NAME="PERIOD_BDY_EM_MOIST.inc_90"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4280'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_CHEM.inc.html'>PERIOD_BDY_EM_CHEM.inc</A>"<A NAME="PERIOD_BDY_EM_CHEM.inc_91"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4281'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_TRACER.inc.html'>PERIOD_BDY_EM_TRACER.inc</A>"<A NAME="PERIOD_BDY_EM_TRACER.inc_92"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4282'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_SCALAR.inc.html'>PERIOD_BDY_EM_SCALAR.inc</A>"<A NAME="PERIOD_BDY_EM_SCALAR.inc_93"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4283'>
#endif<a name='4284'>
<a name='4285'>
<font color=#447700>!  now set physical b.c on a patch<a name='4286'></font>
<a name='4287'>
BENCH_START(bc_2d_tim)<a name='4288'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='4289'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='4290'></font>
   tile_bc_loop_2: DO ij = 1 , grid%num_tiles<a name='4291'>
<a name='4292'>
     CALL wrf_debug ( 200 , ' call set_phys_bc_dry_2' )<a name='4293'>
<a name='4294'>
     CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SET_PHYS_BC_DRY_2'>set_phys_bc_dry_2</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYS_BC_DRY_2_1">( config_flags,                           &amp;<a name='4295'>
                             grid%u_1, grid%u_2, grid%v_1, grid%v_2, grid%w_1, grid%w_2,           &amp;<a name='4296'>
                             grid%t_1, grid%t_2, grid%ph_1, grid%ph_2, grid%mu_1, grid%mu_2,       &amp;<a name='4297'>
                             ids, ide, jds, jde, kds, kde,           &amp;<a name='4298'>
                             ims, ime, jms, jme, kms, kme,           &amp;<a name='4299'>
                             ips, ipe, jps, jpe, kps, kpe,           &amp;<a name='4300'>
                             grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4301'>
                             grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4302'>
                             k_start    , k_end                     )<a name='4303'>
<a name='4304'>
     CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_119">( grid%tke_1, 'p', config_flags,   &amp;<a name='4305'>
                             ids, ide, jds, jde, kds, kde,            &amp;<a name='4306'>
                             ims, ime, jms, jme, kms, kme,            &amp;<a name='4307'>
                             ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='4308'>
                             grid%i_start(ij), grid%i_end(ij),        &amp;<a name='4309'>
                             grid%j_start(ij), grid%j_end(ij),        &amp;<a name='4310'>
                             k_start    , k_end-1                    )<a name='4311'>
<a name='4312'>
     CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_120">( grid%tke_2 , 'p', config_flags,  &amp;<a name='4313'>
                             ids, ide, jds, jde, kds, kde,            &amp;<a name='4314'>
                             ims, ime, jms, jme, kms, kme,            &amp;<a name='4315'>
                             ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='4316'>
                             grid%i_start(ij), grid%i_end(ij),        &amp;<a name='4317'>
                             grid%j_start(ij), grid%j_end(ij),        &amp;<a name='4318'>
                             k_start    , k_end                      )<a name='4319'>
<a name='4320'>
     moisture_loop_bdy_2 : DO im = PARAM_FIRST_SCALAR , num_3d_m<a name='4321'>
<a name='4322'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_121">( moist(ims,kms,jms,im), 'p',           &amp;<a name='4323'>
                               config_flags,                           &amp;<a name='4324'>
                               ids, ide, jds, jde, kds, kde,           &amp;<a name='4325'>
                               ims, ime, jms, jme, kms, kme,           &amp;<a name='4326'>
                               ips, ipe, jps, jpe, kps, kpe,           &amp;<a name='4327'>
                               grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4328'>
                               grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4329'>
                               k_start    , k_end                     )<a name='4330'>
<a name='4331'>
     END DO moisture_loop_bdy_2<a name='4332'>
<a name='4333'>
     chem_species_bdy_loop_2 : DO ic = PARAM_FIRST_SCALAR , num_3d_c<a name='4334'>
<a name='4335'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_122">( chem(ims,kms,jms,ic) , 'p', config_flags,  &amp;<a name='4336'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='4337'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='4338'>
                               ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='4339'>
                               grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='4340'>
                               grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='4341'>
                               k_start    , k_end                      )<a name='4342'>
<a name='4343'>
     END DO chem_species_bdy_loop_2<a name='4344'>
<a name='4345'>
     tracer_species_bdy_loop_2 : DO ic = PARAM_FIRST_SCALAR , num_tracer<a name='4346'>
<a name='4347'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_123">( tracer(ims,kms,jms,ic) , 'p', config_flags,  &amp;<a name='4348'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='4349'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='4350'>
                               ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='4351'>
                               grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='4352'>
                               grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='4353'>
                               k_start    , k_end                      )<a name='4354'>
<a name='4355'>
     END DO tracer_species_bdy_loop_2<a name='4356'>
<a name='4357'>
     scalar_species_bdy_loop_2 : DO is = PARAM_FIRST_SCALAR , num_3d_s<a name='4358'>
<a name='4359'>
       CALL <A href='../../html_code/share/module_bc.F.html#SET_PHYSICAL_BC3D'>set_physical_bc3d</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_PHYSICAL_BC3D_124">( scalar(ims,kms,jms,is) , 'p', config_flags,  &amp;<a name='4360'>
                               ids, ide, jds, jde, kds, kde,            &amp;<a name='4361'>
                               ims, ime, jms, jme, kms, kme,            &amp;<a name='4362'>
                               ips, ipe, jps, jpe, kps, kpe,            &amp;<a name='4363'>
                               grid%i_start(ij), grid%i_end(ij),                  &amp;<a name='4364'>
                               grid%j_start(ij), grid%j_end(ij),                  &amp;<a name='4365'>
                               k_start    , k_end                      )<a name='4366'>
<a name='4367'>
     END DO scalar_species_bdy_loop_2<a name='4368'>
<a name='4369'>
   END DO tile_bc_loop_2<a name='4370'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='4371'></font>
BENCH_END(bc_2d_tim)<a name='4372'>
<a name='4373'>
<font color=#447700>!  this code forces boundary values to specified values to avoid drift<a name='4374'></font>
<a name='4375'>
   IF( config_flags%specified .or. config_flags%nested ) THEN <a name='4376'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='4377'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='4378'></font>
   tile_bc_loop_3: DO ij = 1 , grid%num_tiles<a name='4379'>
<a name='4380'>
     CALL wrf_debug ( 200 , ' call spec_bdy_final' )<a name='4381'>
<a name='4382'>
     CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_1">   ( grid%u_2, grid%muus, grid%c1h, grid%c2h, grid%msfuy,     &amp;<a name='4383'>
                                grid%u_bxs, grid%u_bxe, grid%u_bys, grid%u_bye,  &amp;<a name='4384'>
                                grid%u_btxs,grid%u_btxe,grid%u_btys,grid%u_btye, &amp;<a name='4385'>
                                'u', config_flags,                               &amp;<a name='4386'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4387'>
                                grid%dtbc,                                       &amp;<a name='4388'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4389'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4390'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4391'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4392'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4393'>
                                k_start    , k_end                     )<a name='4394'>
<a name='4395'>
     CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_2">   ( grid%v_2, grid%muvs, grid%c1h, grid%c2h, grid%msfvx,     &amp;<a name='4396'>
                                grid%v_bxs, grid%v_bxe, grid%v_bys, grid%v_bye,  &amp;<a name='4397'>
                                grid%v_btxs,grid%v_btxe,grid%v_btys,grid%v_btye, &amp;<a name='4398'>
                                'v', config_flags,                               &amp;<a name='4399'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4400'>
                                grid%dtbc,                                       &amp;<a name='4401'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4402'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4403'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4404'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4405'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4406'>
                                k_start    , k_end                     )<a name='4407'>
<a name='4408'>
     IF( config_flags%nested) THEN<a name='4409'>
       CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_3">   ( grid%w_2, grid%muts, grid%c1f, grid%c2f, grid%msfty, &amp;<a name='4410'>
                                grid%w_bxs, grid%w_bxe, grid%w_bys, grid%w_bye,  &amp;<a name='4411'>
                                grid%w_btxs,grid%w_btxe,grid%w_btys,grid%w_btye, &amp;<a name='4412'>
                                'w', config_flags,                               &amp;<a name='4413'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4414'>
                                grid%dtbc,                                       &amp;<a name='4415'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4416'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4417'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4418'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4419'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4420'>
                                k_start    , k_end                     )<a name='4421'>
     ENDIF<a name='4422'>
<a name='4423'>
     CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_4">   ( grid%t_2, grid%muts, grid%c1h, grid%c2h, grid%msfty,&amp;<a name='4424'>
                                grid%t_bxs, grid%t_bxe, grid%t_bys, grid%t_bye,  &amp;<a name='4425'>
                                grid%t_btxs,grid%t_btxe,grid%t_btys,grid%t_btye, &amp;<a name='4426'>
                                't', config_flags,                               &amp;<a name='4427'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4428'>
                                grid%dtbc,                                       &amp;<a name='4429'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4430'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4431'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4432'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4433'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4434'>
                                k_start    , k_end                     )<a name='4435'>
<a name='4436'>
     CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_5">   ( grid%ph_2, grid%muts, grid%c1f, grid%c2f, grid%msfty,   &amp;<a name='4437'>
                                grid%ph_bxs, grid%ph_bxe, grid%ph_bys, grid%ph_bye,  &amp;<a name='4438'>
                                grid%ph_btxs,grid%ph_btxe,grid%ph_btys,grid%ph_btye, &amp;<a name='4439'>
                                'h', config_flags,                               &amp;<a name='4440'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4441'>
                                grid%dtbc,                                       &amp;<a name='4442'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4443'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4444'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4445'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4446'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4447'>
                                k_start    , k_end                     )<a name='4448'>
<a name='4449'>
     IF( config_flags%spec_bdy_final_mu .EQ. 1 ) THEN<a name='4450'>
     CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_6">   ( grid%mu_2, grid%muts, grid%c1h, grid%c2h, grid%msfty,   &amp;<a name='4451'>
                                grid%mu_bxs, grid%mu_bxe, grid%mu_bys, grid%mu_bye,  &amp;<a name='4452'>
                                grid%mu_btxs,grid%mu_btxe,grid%mu_btys,grid%mu_btye, &amp;<a name='4453'>
                                'm', config_flags,                               &amp;<a name='4454'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4455'>
                                grid%dtbc,                                       &amp;<a name='4456'>
                                ids,ide, jds,jde, 1,  1,    &amp; <font color=#447700>! domain dims<a name='4457'></font>
                                ims,ime, jms,jme, 1,  1,    &amp; <font color=#447700>! memory dims<a name='4458'></font>
                                ips,ipe, jps,jpe, 1,  1,    &amp; <font color=#447700>! patch  dims<a name='4459'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4460'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4461'>
                                1  , 1                    )<a name='4462'>
     ENDIF<a name='4463'>
<a name='4464'>
     moisture_loop_bdy_3 : DO im = PARAM_FIRST_SCALAR , num_3d_m<a name='4465'>
<a name='4466'>
     IF ( im .EQ. P_QV .OR. config_flags%nested .OR. &amp;<a name='4467'>
             ( config_flags%specified .AND. config_flags%have_bcs_moist ) ) THEN<a name='4468'>
        CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_7">   ( moist(ims,kms,jms,im), grid%muts,                &amp;<a name='4469'>
                                grid%c1h, grid%c2h, grid%msfty,                  &amp;<a name='4470'>
                                moist_bxs(jms,kms,1,im),moist_bxe(jms,kms,1,im), &amp;<a name='4471'>
                                moist_bys(ims,kms,1,im),moist_bye(ims,kms,1,im), &amp;<a name='4472'>
                                moist_btxs(jms,kms,1,im),moist_btxe(jms,kms,1,im), &amp;<a name='4473'>
                                moist_btys(ims,kms,1,im),moist_btye(ims,kms,1,im), &amp;<a name='4474'>
                                't', config_flags,                               &amp;<a name='4475'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4476'>
                                grid%dtbc,                                       &amp;<a name='4477'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4478'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4479'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4480'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4481'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4482'>
                                k_start    , k_end                     )<a name='4483'>
     ENDIF<a name='4484'>
<a name='4485'>
     END DO moisture_loop_bdy_3<a name='4486'>
<a name='4487'>
#if (WRF_CHEM == 1)<a name='4488'>
     IF (num_3d_c &gt;= PARAM_FIRST_SCALAR)  THEN<a name='4489'>
         chem_species_bdy_loop_3 : DO ic = PARAM_FIRST_SCALAR , num_3d_c<a name='4490'>
<a name='4491'>
     IF( ( config_flags%nested ) ) THEN<a name='4492'>
        CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_8">   ( chem(ims,kms,jms,ic), grid%muts,               &amp;<a name='4493'>
                                grid%c1h, grid%c2h, grid%msfty,                &amp;<a name='4494'>
                                chem_bxs(jms,kms,1,ic),chem_bxe(jms,kms,1,ic), &amp;<a name='4495'>
                                chem_bys(ims,kms,1,ic),chem_bye(ims,kms,1,ic), &amp;<a name='4496'>
                                chem_btxs(jms,kms,1,ic),chem_btxe(jms,kms,1,ic), &amp;<a name='4497'>
                                chem_btys(ims,kms,1,ic),chem_btye(ims,kms,1,ic), &amp;<a name='4498'>
                                't', config_flags,                               &amp;<a name='4499'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4500'>
                                grid%dtbc,                                       &amp;<a name='4501'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4502'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4503'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4504'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4505'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4506'>
                                k_start    , k_end                     )<a name='4507'>
     ENDIF<a name='4508'>
<a name='4509'>
         END DO chem_species_bdy_loop_3<a name='4510'>
     ENDIF<a name='4511'>
#endif<a name='4512'>
<a name='4513'>
     tracer_species_bdy_loop_3 : DO im = PARAM_FIRST_SCALAR , num_tracer<a name='4514'>
<a name='4515'>
     IF( ( config_flags%nested ) ) THEN<a name='4516'>
        CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_9">   ( tracer(ims,kms,jms,im), grid%muts,                 &amp;<a name='4517'>
                                grid%c1h, grid%c2h, grid%msfty,                    &amp;<a name='4518'>
                                tracer_bxs(jms,kms,1,im),tracer_bxe(jms,kms,1,im), &amp;<a name='4519'>
                                tracer_bys(ims,kms,1,im),tracer_bye(ims,kms,1,im), &amp;<a name='4520'>
                                tracer_btxs(jms,kms,1,im),tracer_btxe(jms,kms,1,im), &amp;<a name='4521'>
                                tracer_btys(ims,kms,1,im),tracer_btye(ims,kms,1,im), &amp;<a name='4522'>
                                't', config_flags,                               &amp;<a name='4523'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4524'>
                                grid%dtbc,                                       &amp;<a name='4525'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4526'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4527'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4528'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4529'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4530'>
                                k_start    , k_end                     )<a name='4531'>
     ENDIF<a name='4532'>
<a name='4533'>
     END DO tracer_species_bdy_loop_3<a name='4534'>
<a name='4535'>
     scalar_species_bdy_loop_3 : DO is = PARAM_FIRST_SCALAR , num_3d_s<a name='4536'>
<a name='4537'>
     IF( ( config_flags%nested ) ) THEN<a name='4538'>
        CALL <A href='../../html_code/share/module_bc.F.html#SPEC_BDY_FINAL'>spec_bdy_final</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPEC_BDY_FINAL_10">   ( scalar(ims,kms,jms,is), grid%muts,                 &amp;<a name='4539'>
                                grid%c1h, grid%c2h, grid%msfty,                    &amp;<a name='4540'>
                                scalar_bxs(jms,kms,1,is),scalar_bxe(jms,kms,1,is), &amp;<a name='4541'>
                                scalar_bys(ims,kms,1,is),scalar_bye(ims,kms,1,is), &amp;<a name='4542'>
                                scalar_btxs(jms,kms,1,is),scalar_btxe(jms,kms,1,is), &amp;<a name='4543'>
                                scalar_btys(ims,kms,1,is),scalar_btye(ims,kms,1,is), &amp;<a name='4544'>
                                't', config_flags,                               &amp;<a name='4545'>
                                config_flags%spec_bdy_width, grid%spec_zone,     &amp;<a name='4546'>
                                grid%dtbc,                                       &amp;<a name='4547'>
                                ids,ide, jds,jde, kds,kde,  &amp; <font color=#447700>! domain dims<a name='4548'></font>
                                ims,ime, jms,jme, kms,kme,  &amp; <font color=#447700>! memory dims<a name='4549'></font>
                                ips,ipe, jps,jpe, kps,kpe,  &amp; <font color=#447700>! patch  dims<a name='4550'></font>
                                grid%i_start(ij), grid%i_end(ij),       &amp;<a name='4551'>
                                grid%j_start(ij), grid%j_end(ij),       &amp;<a name='4552'>
                                k_start    , k_end                     )<a name='4553'>
     ENDIF<a name='4554'>
<a name='4555'>
     END DO scalar_species_bdy_loop_3<a name='4556'>
<a name='4557'>
   END DO tile_bc_loop_3<a name='4558'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='4559'></font>
<a name='4560'>
   ENDIF<a name='4561'>
<a name='4562'>
<font color=#447700>! reset surface w for consistency<a name='4563'></font>
<a name='4564'>
#ifdef DM_PARALLEL<a name='4565'>
#  include "<A href='../../html_code/include/HALO_EM_C.inc.html'>HALO_EM_C.inc</A>"<A NAME="HALO_EM_C.inc_94"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4566'>
#  include "<A href='../../html_code/include/PERIOD_BDY_EM_E.inc.html'>PERIOD_BDY_EM_E.inc</A>"<A NAME="PERIOD_BDY_EM_E.inc_95"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4567'>
#endif<a name='4568'>
<a name='4569'>
   CALL wrf_debug ( 10 , ' call set_w_surface' )<a name='4570'>
   fill_w_flag = .false.<a name='4571'>
<a name='4572'>
   <font color=#447700>!$OMP PARALLEL DO   &amp;<a name='4573'></font>
   <font color=#447700>!$OMP PRIVATE ( ij )<a name='4574'></font>
   DO ij = 1 , grid%num_tiles<a name='4575'>
      CALL <A href='../../html_code/dyn_em/module_bc_em.F.html#SET_W_SURFACE'>set_w_surface</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SET_W_SURFACE_1">( config_flags, grid%znw, fill_w_flag,              &amp;<a name='4576'>
                           grid%w_2, grid%ht,  grid%u_2, grid%v_2,          &amp;<a name='4577'>
                           grid%cf1, grid%cf2, grid%cf3, grid%rdx, grid%rdy,&amp;<a name='4578'>
                           grid%msftx, grid%msfty,                          &amp;<a name='4579'>
                           ids, ide, jds, jde, kds, kde,                    &amp;<a name='4580'>
                           ims, ime, jms, jme, kms, kme,                    &amp;<a name='4581'>
                           grid%i_start(ij), grid%i_end(ij),                &amp;<a name='4582'>
                           grid%j_start(ij), grid%j_end(ij),                &amp;<a name='4583'>
                           k_start, k_end                                   )<a name='4584'>
<font color=#447700>!                          its, ite, jts, jte, k_start, min(k_end,kde-1),   &amp;<a name='4585'></font>
<a name='4586'>
   END DO<a name='4587'>
   <font color=#447700>!$OMP END PARALLEL DO<a name='4588'></font>
<a name='4589'>
<font color=#447700>!-----------------------------------------------------------<a name='4590'></font>
<font color=#447700>!  After all of the RK steps, after the microphysics, after p-rho-phi,<a name='4591'></font>
<font color=#447700>!  after w, after filtering, we have data ready to use.<a name='4592'></font>
<font color=#447700>!-----------------------------------------------------------<a name='4593'></font>
<a name='4594'>
  CALL <A href='../../html_code/dyn_em/module_after_all_rk_steps.F.html#AFTER_ALL_RK_STEPS'>after_all_rk_steps</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AFTER_ALL_RK_STEPS_1"> ( grid, config_flags,                  &amp;<a name='4595'>
                            moist, chem, tracer, scalar,         &amp;<a name='4596'>
                            th_phy, pi_phy, p_phy, rho_phy,      &amp;   <a name='4597'>
                            p8w, t8w, dz8w,                      &amp;<a name='4598'>
                            curr_secs2,                          &amp;<a name='4599'>
                            diag_flag,                           &amp;<a name='4600'>
                            ids,  ide,  jds,  jde,  kds,  kde,   &amp;<a name='4601'>
                            ims,  ime,  jms,  jme,  kms,  kme,   &amp;<a name='4602'>
                            ips,  ipe,  jps,  jpe,  kps,  kpe,   &amp;<a name='4603'>
                            imsx, imex, jmsx, jmex, kmsx, kmex,  &amp;<a name='4604'>
                            ipsx, ipex, jpsx, jpex, kpsx, kpex,  &amp;<a name='4605'>
                            imsy, imey, jmsy, jmey, kmsy, kmey,  &amp;<a name='4606'>
                            ipsy, ipey, jpsy, jpey, kpsy, kpey   )<a name='4607'>
<a name='4608'>
<a name='4609'>
<a name='4610'>
#ifdef DM_PARALLEL<a name='4611'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4612'></font>
<font color=#447700>! see above<a name='4613'></font>
<font color=#447700>!--------------------------------------------------------------<a name='4614'></font>
   CALL wrf_debug ( 200 , ' call HALO_RK_E' )<a name='4615'>
   IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='4616'>
#    include "<A href='../../html_code/include/HALO_EM_E_3.inc.html'>HALO_EM_E_3.inc</A>"<A NAME="HALO_EM_E_3.inc_96"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4617'>
   ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='4618'>
#    include "<A href='../../html_code/include/HALO_EM_E_5.inc.html'>HALO_EM_E_5.inc</A>"<A NAME="HALO_EM_E_5.inc_97"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4619'>
   ELSE<a name='4620'>
     WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='4621'>
     CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_65">(TRIM(wrf_err_message))<a name='4622'>
   ENDIF<a name='4623'>
#endif<a name='4624'>
<a name='4625'>
#ifdef DM_PARALLEL<a name='4626'>
   IF ( num_moist &gt;= PARAM_FIRST_SCALAR  ) THEN<a name='4627'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4628'></font>
<font color=#447700>! see above<a name='4629'></font>
<font color=#447700>!--------------------------------------------------------------<a name='4630'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_MOIST' )<a name='4631'>
     IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='4632'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_3.inc.html'>HALO_EM_MOIST_E_3.inc</A>"<A NAME="HALO_EM_MOIST_E_3.inc_98"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4633'>
     ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='4634'>
#      include "<A href='../../html_code/include/HALO_EM_MOIST_E_5.inc.html'>HALO_EM_MOIST_E_5.inc</A>"<A NAME="HALO_EM_MOIST_E_5.inc_99"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4635'>
     ELSE<a name='4636'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='4637'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_66">(TRIM(wrf_err_message))<a name='4638'>
     ENDIF<a name='4639'>
   ENDIF<a name='4640'>
   IF ( num_chem &gt;= PARAM_FIRST_SCALAR ) THEN<a name='4641'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4642'></font>
<font color=#447700>! see above<a name='4643'></font>
<font color=#447700>!--------------------------------------------------------------<a name='4644'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_CHEM' )<a name='4645'>
     IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='4646'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_3.inc.html'>HALO_EM_CHEM_E_3.inc</A>"<A NAME="HALO_EM_CHEM_E_3.inc_100"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4647'>
     ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='4648'>
#      include "<A href='../../html_code/include/HALO_EM_CHEM_E_5.inc.html'>HALO_EM_CHEM_E_5.inc</A>"<A NAME="HALO_EM_CHEM_E_5.inc_101"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4649'>
     ELSE<a name='4650'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='4651'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_67">(TRIM(wrf_err_message))<a name='4652'>
     ENDIF<a name='4653'>
   ENDIF<a name='4654'>
   IF ( num_tracer &gt;= PARAM_FIRST_SCALAR ) THEN<a name='4655'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4656'></font>
<font color=#447700>! see above<a name='4657'></font>
<font color=#447700>!--------------------------------------------------------------<a name='4658'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_TRACER' )<a name='4659'>
     IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='4660'>
#      include "<A href='../../html_code/include/HALO_EM_TRACER_E_3.inc.html'>HALO_EM_TRACER_E_3.inc</A>"<A NAME="HALO_EM_TRACER_E_3.inc_102"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4661'>
     ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='4662'>
#      include "<A href='../../html_code/include/HALO_EM_TRACER_E_5.inc.html'>HALO_EM_TRACER_E_5.inc</A>"<A NAME="HALO_EM_TRACER_E_5.inc_103"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4663'>
     ELSE<a name='4664'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='4665'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_68">(TRIM(wrf_err_message))<a name='4666'>
     ENDIF<a name='4667'>
   ENDIF<a name='4668'>
   IF ( num_scalar &gt;= PARAM_FIRST_SCALAR ) THEN<a name='4669'>
<font color=#447700>!-----------------------------------------------------------------------<a name='4670'></font>
<font color=#447700>! see above<a name='4671'></font>
<font color=#447700>!--------------------------------------------------------------<a name='4672'></font>
     CALL wrf_debug ( 200 , ' call HALO_RK_SCALAR' )<a name='4673'>
     IF      ( config_flags%h_mom_adv_order &lt;= 4 ) THEN<a name='4674'>
#      include "<A href='../../html_code/include/HALO_EM_SCALAR_E_3.inc.html'>HALO_EM_SCALAR_E_3.inc</A>"<A NAME="HALO_EM_SCALAR_E_3.inc_104"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4675'>
     ELSE IF ( config_flags%h_mom_adv_order &lt;= 6 ) THEN<a name='4676'>
#      include "<A href='../../html_code/include/HALO_EM_SCALAR_E_5.inc.html'>HALO_EM_SCALAR_E_5.inc</A>"<A NAME="HALO_EM_SCALAR_E_5.inc_105"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4677'>
     ELSE<a name='4678'>
       WRITE(wrf_err_message,*)'solve_em: invalid h_mom_adv_order = ',config_flags%h_mom_adv_order<a name='4679'>
       CALL <A href='../../html_code/frame/module_wrf_error.F.html#WRF_ERROR_FATAL'>wrf_error_fatal</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WRF_ERROR_FATAL_69">(TRIM(wrf_err_message))<a name='4680'>
     ENDIF<a name='4681'>
   ENDIF<a name='4682'>
#endif<a name='4683'>
<a name='4684'>
<font color=#447700>!  Max values of CFL for adaptive time step scheme<a name='4685'></font>
<a name='4686'>
   DEALLOCATE(max_vert_cfl_tmp)<a name='4687'>
   DEALLOCATE(max_horiz_cfl_tmp)<a name='4688'>
<a name='4689'>
   CALL wrf_debug ( 200 , ' call end of solve_em' )<a name='4690'>
<a name='4691'>
<font color=#447700>!  Are we about to read SST input from the wrflowinput file?  That data is saved<a name='4692'></font>
<font color=#447700>!  for use in fractional merging of external/coupled SST and input SST. <a name='4693'></font>
   IF ( coupler_on )   grid%just_read_auxinput4 = <A href='../../html_code/frame/module_domain.F.html#IS_ALARM_TSTEP'>Is_alarm_tstep</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IS_ALARM_TSTEP_1">(grid%domain_clock, grid%alarms(AUXINPUT4_ALARM))<a name='4694'>
<a name='4695'>
<font color=#447700>!  Are we about to read the lateral boundary file?  This is a domain one action only.<a name='4696'></font>
   IF ( grid%id .EQ. 1 ) grid%just_read_boundary = <A href='../../html_code/frame/module_domain.F.html#IS_ALARM_TSTEP'>Is_alarm_tstep</A><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="IS_ALARM_TSTEP_2">(grid%domain_clock, grid%alarms(BOUNDARY_ALARM))<a name='4697'>
<a name='4698'>
<font color=#447700>! Finish timers if compiled with -DBENCH.<a name='4699'></font>
#include "<A href='../../html_code/include/bench_solve_em_end.h.html'>bench_solve_em_end.h</A>"<A NAME="bench_solve_em_end.h_106"><A href='../../html_code/dyn_em/solve_em.F.html#SOLVE_EM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><a name='4700'>
<a name='4701'>
   RETURN<a name='4702'>
<a name='4703'>
END SUBROUTINE solve_em<a name='4704'>
</pre></body></html>